=== Content from downloads.asterisk.org_c47dabad_20250125_143714.html ===
Index: res/res\_pjsip\_exten\_state.c
===================================================================
--- res/res\_pjsip\_exten\_state.c (revision 405280)
+++ res/res\_pjsip\_exten\_state.c (working copy)
@@ -117,7 +117,22 @@
ao2\_cleanup(sub->sip\_sub);
}
+#define DEFAULT\_PRESENCE\_BODY "application/pidf+xml"
+
/\*!
+ \* This serves the purpose of taking the place of an Accept header
+ \* if one cannot be found in an incoming SUBSCRIBE. This only
+ \* defines the header value and cannot be treated the same as
+ \* other run-of-the mill Accept headers.
+ \*/
+static pjsip\_accept\_hdr default\_presence\_accept = {
+ .count = 1,
+ .values = {
+ { .ptr = DEFAULT\_PRESENCE\_BODY, .slen = sizeof(DEFAULT\_PRESENCE\_BODY) - 1 },
+ },
+};
+
+/\*!
\* \internal
\* \brief Copies the body types the message wishes to subscribe to.
\*/
@@ -128,6 +143,12 @@
pjsip\_accept\_hdr \*hdr = (pjsip\_accept\_hdr\*)
pjsip\_msg\_find\_hdr(rdata->msg\_info.msg, PJSIP\_H\_ACCEPT, NULL);
+ if (!hdr) {
+ /\* No Accept header means to use the default accept header for
+ \* presence
+ \*/
+ hdr = &default\_presence\_accept;
+ }
exten\_state\_sub->body\_types\_count = hdr->count;
exten\_state\_sub->body\_types = ast\_malloc(hdr->count \* sizeof(char\*));
@@ -527,8 +548,6 @@
exten\_state\_sub->last\_exten\_state));
}
-#define DEFAULT\_PRESENCE\_BODY "application/pidf+xml"
-
/\*!
\* \internal
\* \brief Create and register a subscription handler.


=== Content from issues.asterisk.org_5985734f_20250125_143718.html ===

[[Home](/)]

| Summary: | ASTERISK-23139: Security: Remote crash in res\_pjsip\_exten\_state | | |
| --- | --- | --- | --- |
| Reporter: | Mark Michelson (mmichelson) | Labels: | Security |
| Date Opened: | 2014-01-14 13:33:29.000-0600 | Date Closed: | 2014-03-10 15:17:06 |
| Priority: | Critical | Regression? |  |
| Status: | Closed/Complete | Components: | Resources/res\_pjsip\_exten\_state |
| Versions: | 12.0.0 | Frequency ofOccurrence |  |
| RelatedIssues: |  | | |
| Environment: |  | Attachments: | ( 0) [ASTERISK-23139.patch](../attachments/23/ASTERISK-23139/00-ASTERISK-23139.patch) |
| Description: | It is possible to crash Asterisk by sending a SUBSCRIBE request to Asterisk for the presence Event that has no Accept headers.   This is because res\_pjsip\_exten\_state.c was originally written with the (correct) assumption that res\_pjsip\_pubsub.c would filter out any SUBSCRIBE requests that had no Accept headers. However, when handles\_default\_accept support was added, res\_pjsip\_exten\_state.c did not have the assumption removed.   For the person that writes the security report, this can only be exercised by configured endpoints in PJSIP, so this can't be remotely triggered by just anybody.   I have already created a patch that fixes the issue. I will upload it here. | | |
| Comments: |  | | |



=== Content from downloads.asterisk.org_5f06b677_20250125_143714.html ===


Asterisk
Project Security Advisory - AST-2014-004

| **Product** | Asterisk |
| **Summary** | Remote Crash Vulnerability in PJSIP Channel Driver Subscription Handling |
| **Nature of Advisory** | Denial of Service |
| **Susceptibility** | Remote Authenticated Sessions |
| **Severity** | Moderate |
| **Exploits Known** | No |
| **Reported On** | January 14th, 2014 |
| **Reported By** | Mark Michelson |
| **Posted On** | March 10, 2014 |
| **Last Updated On** | March 10, 2014 |
| **Advisory Contact** | Matt Jordan <mjordan AT digium DOT com> |
| **CVE Name** | CVE-2014-2289 |

| **Description** | A remotely exploitable crash vulnerability exists in the PJSIP channel driver's handling of SUBSCRIBE requests. If a SUBSCRIBE request is received for the presence Event, and that request has no Accept headers, Asterisk will attempt to access an invalid pointer to the header location.    Note that this issue was fixed during a re-architecture of the res\_pjsip\_pubsub module in Asterisk 12.1.0. As such, this issue has already been resolved in a released version of Asterisk. This notification is being released for users of Asterisk 12.0.0. |

| **Resolution** | Upgrade to Asterisk 12.1.0, or apply the patch noted below to Asterisk 12.0.0. |

| **Affected Versions** | | |
| **Product** | **Release Series** |  |
| Asterisk Open Source | 12.x | 12.0.0 |

| **Corrected In** | |
| **Product** | **Release** |
| Asterisk Open Source | 12.1.0 |

| **Patches** | |
| **SVN URL** | **Revision** |
| <http://downloads.asterisk.org/pub/security/AST-2014-004-12.diff> | Asterisk 12 |

| **Links** | https://issues.asterisk.org/jira/browse/ASTERISK-23139 |

| Asterisk Project Security Advisories are posted at <http://www.asterisk.org/security>  This document may be superseded by later versions; if so, the latest version will be posted at http://downloads.digium.com/pub/security/AST-2014-004.pdf and http://downloads.digium.com/pub/security/AST-2014-004.html |

| **Revision History** | | |
| **Date** | **Editor** | **Revisions Made** |
| 03/05/14 | Matt Jordan | Initial Revision |

Asterisk
Project Security Advisory - AST-2014-004
Copyright
Â© 2014
Digium, Inc. All Rights Reserved.
Permission is hereby granted
to distribute and publish this advisory in its original, unaltered
form.


