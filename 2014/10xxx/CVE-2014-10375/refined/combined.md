=== Content from git.savannah.nongnu.org_e4b4b25a_20250125_155008.html ===


| [cgit logo](/cgit/) | [index](/cgit/) : [exosip.git](/cgit/exosip.git/) | bugfix/multiple-authentications bugfix/nict-multi-auth bugfix/transport-errors exosip-3.X.X feature/improve-randomness master |
| --- | --- | --- |
| exosip |  |

| [summary](/cgit/exosip.git/)[refs](/cgit/exosip.git/refs/?id=2549e421c14aff886629b8482c14af800f411070)[log](/cgit/exosip.git/log/)[tree](/cgit/exosip.git/tree/?id=2549e421c14aff886629b8482c14af800f411070)[commit](/cgit/exosip.git/commit/?id=2549e421c14aff886629b8482c14af800f411070)[diff](/cgit/exosip.git/diff/?id=2549e421c14aff886629b8482c14af800f411070) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aymeric Moizard <amoizard@gmail.com> | 2014-12-03 19:25:24 +0100 |
| --- | --- | --- |
| committer | Aymeric Moizard <amoizard@gmail.com> | 2014-12-03 19:25:24 +0100 |
| commit | [2549e421c14aff886629b8482c14af800f411070](/cgit/exosip.git/commit/?id=2549e421c14aff886629b8482c14af800f411070) ([patch](/cgit/exosip.git/patch/?id=2549e421c14aff886629b8482c14af800f411070)) | |
| tree | [74f63307ba92c4d5b5ce9eebb52c2b8b8be8db33](/cgit/exosip.git/tree/?id=2549e421c14aff886629b8482c14af800f411070) | |
| parent | [754a2c8a0b90df7f2f21b57c55f816875704f5c4](/cgit/exosip.git/commit/?id=754a2c8a0b90df7f2f21b57c55f816875704f5c4) ([diff](/cgit/exosip.git/diff/?id=2549e421c14aff886629b8482c14af800f411070&id2=754a2c8a0b90df7f2f21b57c55f816875704f5c4)) | |
| download | [exosip-2549e421c14aff886629b8482c14af800f411070.tar.gz](/cgit/exosip.git/snapshot/exosip-2549e421c14aff886629b8482c14af800f411070.tar.gz) | |

add option to use/not use ephemeral port in Contact // fix to avoid handling negative content-length[Diffstat](/cgit/exosip.git/diff/?id=2549e421c14aff886629b8482c14af800f411070)

| -rw-r--r-- | [include/eXosip2/eX\_setup.h](/cgit/exosip.git/diff/include/eXosip2/eX_setup.h?id=2549e421c14aff886629b8482c14af800f411070) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [src/eXconf.c](/cgit/exosip.git/diff/src/eXconf.c?id=2549e421c14aff886629b8482c14af800f411070) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [src/eXosip2.h](/cgit/exosip.git/diff/src/eXosip2.h?id=2549e421c14aff886629b8482c14af800f411070) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [src/eXtl\_tcp.c](/cgit/exosip.git/diff/src/eXtl_tcp.c?id=2549e421c14aff886629b8482c14af800f411070) | 9 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [src/eXtl\_tls.c](/cgit/exosip.git/diff/src/eXtl_tls.c?id=2549e421c14aff886629b8482c14af800f411070) | 9 | |  |  |  | | --- | --- | --- | |

5 files changed, 20 insertions, 8 deletions

| diff --git a/include/eXosip2/eX\_setup.h b/include/eXosip2/eX\_setup.hindex d777d1d..d6bae91 100644--- a/[include/eXosip2/eX\_setup.h](/cgit/exosip.git/tree/include/eXosip2/eX_setup.h?id=754a2c8a0b90df7f2f21b57c55f816875704f5c4)+++ b/[include/eXosip2/eX\_setup.h](/cgit/exosip.git/tree/include/eXosip2/eX_setup.h?id=2549e421c14aff886629b8482c14af800f411070)@@ -126,7 +126,8 @@ extern "C" { #define EXOSIP\_OPT\_ENABLE\_AUTOANSWERBYE (EXOSIP\_OPT\_BASE\_OPTION+19) /\*\*< int \*: 0 to disable automatic answer of BYE \*/ #define EXOSIP\_OPT\_ENABLE\_IPV6 (EXOSIP\_OPT\_BASE\_OPTION+20) /\*\*< int \*: 0 to disable -this is a per-eXosip\_t parameter for using IPv6 DNS request \*/ #define EXOSIP\_OPT\_ENABLE\_REUSE\_TCP\_PORT (EXOSIP\_OPT\_BASE\_OPTION+21) /\*\*< int \*: 0 to disable, 1 to enable reusing local tcp port for outgoing tcp connection \*/- +#define EXOSIP\_OPT\_ENABLE\_USE\_EPHEMERAL\_PORT (EXOSIP\_OPT\_BASE\_OPTION+22) /\*\*< int \*: 0 to disable, 1 to enable usage of emphemeral tcp port in Contact headers instead of local listening port for TCP/TLS \*/+ #define EXOSIP\_OPT\_SET\_TLS\_VERIFY\_CERTIFICATE (EXOSIP\_OPT\_BASE\_OPTION+500) /\*\*< int \*: enable verification of certificate for TLS connection \*/ #define EXOSIP\_OPT\_SET\_TLS\_CERTIFICATES\_INFO (EXOSIP\_OPT\_BASE\_OPTION+501) /\*\*< eXosip\_tls\_ctx\_t \*: client and/or server certificate/ca-root/key info \*/ #define EXOSIP\_OPT\_SET\_TLS\_CLIENT\_CERTIFICATE\_NAME (EXOSIP\_OPT\_BASE\_OPTION+502) /\*\*< char\*: user can choose a specific certifcate present in Windows Certificate Store \*/diff --git a/src/eXconf.c b/src/eXconf.cindex dd04f6f..c12373c 100644--- a/[src/eXconf.c](/cgit/exosip.git/tree/src/eXconf.c?id=754a2c8a0b90df7f2f21b57c55f816875704f5c4)+++ b/[src/eXconf.c](/cgit/exosip.git/tree/src/eXconf.c?id=2549e421c14aff886629b8482c14af800f411070)@@ -730,6 +730,7 @@ eXosip\_init (struct eXosip\_t \*excontext) excontext->autoanswer\_bye = 1; excontext->auto\_masquerade\_contact = 1; excontext->masquerade\_via=0;+ excontext->use\_ephemeral\_port=1;  return OSIP\_SUCCESS; }@@ -1057,7 +1058,10 @@ eXosip\_set\_option (struct eXosip\_t \*excontext, int opt, const void \*value) val = \*((int \*) value); excontext->reuse\_tcp\_port = val; break;- + case EXOSIP\_OPT\_ENABLE\_USE\_EPHEMERAL\_PORT:+ val = \*((int \*) value);+ excontext->use\_ephemeral\_port = val;+ break; default: return OSIP\_BADPARAMETER; }diff --git a/src/eXosip2.h b/src/eXosip2.hindex a9510ea..906596f 100644--- a/[src/eXosip2.h](/cgit/exosip.git/tree/src/eXosip2.h?id=754a2c8a0b90df7f2f21b57c55f816875704f5c4)+++ b/[src/eXosip2.h](/cgit/exosip.git/tree/src/eXosip2.h?id=2549e421c14aff886629b8482c14af800f411070)@@ -474,6 +474,7 @@ extern "C" { int masquerade\_via; int auto\_masquerade\_contact; int reuse\_tcp\_port;+ int use\_ephemeral\_port; };  int \_eXosip\_guess\_ip\_for\_via (struct eXosip\_t \*excontext, int family, char \*address, int size);diff --git a/src/eXtl\_tcp.c b/src/eXtl\_tcp.cindex 7bf2809..cb77ed1 100644--- a/[src/eXtl\_tcp.c](/cgit/exosip.git/tree/src/eXtl_tcp.c?id=754a2c8a0b90df7f2f21b57c55f816875704f5c4)+++ b/[src/eXtl\_tcp.c](/cgit/exosip.git/tree/src/eXtl_tcp.c?id=2549e421c14aff886629b8482c14af800f411070)@@ -416,7 +416,8 @@ handle\_messages (struct eXosip\_t \*excontext, struct \_tcp\_stream \*sockinfo) OSIP\_TRACE (osip\_trace (\_\_FILE\_\_, \_\_LINE\_\_, OSIP\_INFO1, NULL, "socket %s:%i: message has no content-length: <%s>\n", sockinfo->remote\_ip, sockinfo->remote\_port, buf)); } clen = clen\_header ? atoi (clen\_header) : 0;-+ if (clen<0)+ return sockinfo->buflen; /\* discard data \*/ /\* undo our overwrite and advance end\_headers \*/ \*end\_headers = END\_HEADERS\_STR[0]; end\_headers += const\_strlen (END\_HEADERS\_STR);@@ -1324,7 +1325,8 @@ tcp\_tl\_send\_message (struct eXosip\_t \*excontext, osip\_transaction\_t \* tr, osip\_m OSIP\_TRACE (osip\_trace (\_\_FILE\_\_, \_\_LINE\_\_, OSIP\_INFO1, NULL, "reusing REQUEST connection (to dest=%s:%i)\n", reserved->socket\_tab[pos].remote\_ip, reserved->socket\_tab[pos].remote\_port)); if (MSG\_IS\_REGISTER (sip) && atoi(sip->cseq->number)!=1) { } else {- \_tcp\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port);+ if (excontext->use\_ephemeral\_port==1)+ \_tcp\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port); } if (excontext->tcp\_firewall\_ip[0] != '\0' || excontext->auto\_masquerade\_contact > 0) \_tcp\_tl\_update\_local\_target (excontext, sip, reserved->socket\_tab[pos].natted\_ip, reserved->socket\_tab[pos].natted\_port);@@ -1369,7 +1371,8 @@ tcp\_tl\_send\_message (struct eXosip\_t \*excontext, osip\_transaction\_t \* tr, osip\_m out\_socket = reserved->socket\_tab[pos].socket; if (MSG\_IS\_REGISTER (sip) && atoi(sip->cseq->number)!=1) { } else {- \_tcp\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port);+ if (excontext->use\_ephemeral\_port==1)+ \_tcp\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port); } if (excontext->tcp\_firewall\_ip[0] != '\0' || excontext->auto\_masquerade\_contact > 0) \_tcp\_tl\_update\_local\_target (excontext, sip, reserved->socket\_tab[pos].natted\_ip, reserved->socket\_tab[pos].natted\_port);diff --git a/src/eXtl\_tls.c b/src/eXtl\_tls.cindex e6467d8..9902b27 100644--- a/[src/eXtl\_tls.c](/cgit/exosip.git/tree/src/eXtl_tls.c?id=754a2c8a0b90df7f2f21b57c55f816875704f5c4)+++ b/[src/eXtl\_tls.c](/cgit/exosip.git/tree/src/eXtl_tls.c?id=2549e421c14aff886629b8482c14af800f411070)@@ -1971,7 +1971,8 @@ handle\_messages (struct eXosip\_t \*excontext, struct \_tls\_stream \*sockinfo) OSIP\_TRACE (osip\_trace (\_\_FILE\_\_, \_\_LINE\_\_, OSIP\_INFO1, NULL, "socket %s:%i: message has no content-length: <%s>\n", sockinfo->remote\_ip, sockinfo->remote\_port, buf)); } clen = clen\_header ? atoi (clen\_header) : 0;-+ if (clen<0)+ return sockinfo->buflen; /\* discard data \*/ /\* undo our overwrite and advance end\_headers \*/ \*end\_headers = END\_HEADERS\_STR[0]; end\_headers += const\_strlen (END\_HEADERS\_STR);@@ -2789,7 +2790,8 @@ tls\_tl\_send\_message (struct eXosip\_t \*excontext, osip\_transaction\_t \* tr, osip\_m OSIP\_TRACE (osip\_trace (\_\_FILE\_\_, \_\_LINE\_\_, OSIP\_INFO1, NULL, "reusing REQUEST connection (to dest=%s:%i)\n", reserved->socket\_tab[pos].remote\_ip, reserved->socket\_tab[pos].remote\_port)); if (MSG\_IS\_REGISTER (sip) && atoi(sip->cseq->number)!=1) { } else {- \_tls\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port);+ if (excontext->use\_ephemeral\_port==1)+ \_tls\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port); } if (excontext->tls\_firewall\_ip[0] != '\0' || excontext->auto\_masquerade\_contact > 0) \_tls\_tl\_update\_local\_target (excontext, sip, reserved->socket\_tab[pos].natted\_ip, reserved->socket\_tab[pos].natted\_port);@@ -2832,7 +2834,8 @@ tls\_tl\_send\_message (struct eXosip\_t \*excontext, osip\_transaction\_t \* tr, osip\_m ssl = reserved->socket\_tab[pos].ssl\_conn; if (MSG\_IS\_REGISTER (sip) && atoi(sip->cseq->number)!=1) { } else {- \_tls\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port);+ if (excontext->use\_ephemeral\_port==1)+ \_tls\_tl\_update\_local\_target\_use\_ephemeral\_port (excontext, sip, reserved->socket\_tab[pos].ephemeral\_port); } if (excontext->tls\_firewall\_ip[0] != '\0' || excontext->auto\_masquerade\_contact > 0) \_tls\_tl\_update\_local\_target (excontext, sip, reserved->socket\_tab[pos].natted\_ip, reserved->socket\_tab[pos].natted\_port); |
| --- |

generated by [cgit v1.2.3-70-g09d2](https://git.zx2c4.com/cgit/about/) ([git 2.46.0](https://git-scm.com/)) at 2025-01-25 15:50:08 +0000


