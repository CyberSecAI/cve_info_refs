=== Content from bugs.ruby-lang.org_9bec63ab_20250124_131406.html ===


Search

### Project

### General

### Profile

* [Sign in](/login)
* [Register](/account/register)

* [Home](/)
* [Projects](/projects)
* [Help](https://www.redmine.org/guide)

[Search](/projects/ruby-master/search):

 Ruby master[All Projects](/projects?jump=issues)
# [Ruby](/projects/ruby?jump=issues) » Ruby master

* [Overview](/projects/ruby-master)
* [Activity](/projects/ruby-master/activity)
* [Roadmap](/projects/ruby-master/roadmap)
* [Issues](/projects/ruby-master/issues)
* [Repository](/projects/ruby-master/repository)
* [Like](/projects/ruby-master/hearts)

### Custom queries

* [Backport 3.1](/projects/ruby-master/issues?query_id=287)
* [Backport 3.2](/projects/ruby-master/issues?query_id=293)
* [Backport 3.3](/projects/ruby-master/issues?query_id=300)
* [bugs: unassigned](/projects/ruby-master/issues?query_id=75)
* [DevMeeting](/projects/ruby-master/issues?query_id=156)
* [matz](/projects/ruby-master/issues?query_id=72)
* [Open issues with attachment](/projects/ruby-master/issues?query_id=160)
* [Windows](/projects/ruby-master/issues?query_id=335)

Actions
Copy link
## Bug #9709

closed
![](https://www.gravatar.com/avatar/2f266913a76b898878c5815c4008f0f5f1a2bd844354e61a86c3d804067796f4?rating=PG&size=50&default=mm "Author: h.shirosaki (Hiroshi Shirosaki)")

### Large string causes SEGV with x64-mingw32

Added by [h.shirosaki (Hiroshi Shirosaki)](/users/2931) [almost 11 years](/projects/ruby-master/activity?from=2014-04-07 "04/07/2014 07:00 AM") ago.
Updated [over 10 years](/projects/ruby-master/activity?from=2014-06-04 "06/04/2014 03:46 PM") ago.

Status:ClosedAssignee:-Target version:-
ruby -v:ruby 2.2.0dev (2014-04-07 trunk 45529) [x64-mingw32]Backport:[1.9.3: REQUIRED, 2.0.0: DONE, 2.1: DONE](https://github.com/ruby/ruby/wiki/How-To-Request-Backport)
[[ruby-core:61886]](https://blade.ruby-lang.org/ruby-core/61886)

---

**Description**

Creating large string causes SEGV with x64-mingw32 on Windows.

test.rb

```
A = ""
1000000.times do |i|
  A << "a" * 100000
end

```

gdb backtrace of `./miniruby test.rb`

```
Program received signal SIGSEGV, Segmentation fault.
0x000007fefe88120b in msvcrt!memmove () from C:\Windows\system32\msvcrt.dll
(gdb) bt
#0  0x000007fefe88120b in msvcrt!memmove () from C:\Windows\system32\msvcrt.dll
#1  0x000000000054e404 in str_buf_cat (str=str@entry=115691040, ptr=ptr@entry=0x7b510e0 'a' <repeats 200 times>...,
    len=len@entry=100000) at ../../../ruby/string.c:2042
#2  0x000000000054e90a in rb_enc_cr_str_buf_cat (str=str@entry=115691040, ptr=0x7b510e0 'a' <repeats 200 times>...,
    len=100000, ptr_encindex=<optimized out>, ptr_cr=ptr_cr@entry=1048576, ptr_cr_ret=0x22eb10,
    ptr_cr_ret@entry=0x22eaf0) at ../../../ruby/string.c:2164
#3  0x0000000000553c6c in rb_str_buf_append (str=115691040, str2=115660360) at ../../../ruby/string.c:2207
#4  0x0000000000553d9f in rb_str_append (str2=115660360, str=115691040) at ../../../ruby/string.c:2220
#5  rb_str_concat (str1=115691040, str2=115660360) at ../../../ruby/string.c:2256
#6  0x00000000005ac743 in vm_exec_core (th=0x768ce00, th@entry=0x0, initial=initial@entry=0)
    at ../../../ruby/insns.def:1824
#7  0x00000000005ad661 in vm_exec (th=0x0) at ../../../ruby/vm.c:1328
#8  0x0000000000000000 in ?? ()

```

`capa` setting looks wrong in the following code. Here is a patch.

```
diff --git a/string.c b/string.c
index 511374c..8abfc25 100644
--- a/string.c
+++ b/string.c
@@ -2029,7 +2029,7 @@ str_buf_cat(VALUE str, const char *ptr, long len)
     if (capa <= total) {
        while (total > capa) {
            if (capa + termlen >= LONG_MAX / 2) {
-               capa = (total + 4095) / 4096;
+               capa = LONG_MAX - termlen;
                break;
            }
            capa = (capa + termlen) * 2;

```

* [History](/issues/9709?tab=history)
* [Notes](/issues/9709?tab=notes)
* [Property changes](/issues/9709?tab=properties)
* [Associated revisions](/issues/9709?tab=changesets)

ActionsCopy link
[#1](#note-1)
[[ruby-core:61912]](https://blade.ruby-lang.org/ruby-core/61912)
#### Updated by [nobu (Nobuyoshi Nakada)](/users/4) [almost 11 years](/projects/ruby-master/activity?from=2014-04-09 "04/09/2014 03:45 AM") ago

* **Status** changed from *Open* to *Closed*
* **% Done** changed from *0* to *100*

Applied in changeset r45534.

---

string.c: fix capacity

* string.c (`str_buf_cat`): should round up the capacity by 4KiB,

  but not number of rooms. [[ruby-core:61886]](/issues/9709) [Bug [#9709](/issues/9709 "Bug: Large string causes SEGV with x64-mingw32 (Closed)")]

ActionsCopy link
[#2](#note-2)
[[ruby-core:61913]](https://blade.ruby-lang.org/ruby-core/61913)
#### Updated by [nobu (Nobuyoshi Nakada)](/users/4) [almost 11 years](/projects/ruby-master/activity?from=2014-04-09 "04/09/2014 03:47 AM") ago

* **Backport** changed from *2.0.0: UNKNOWN, 2.1: UNKNOWN* to *1.9.3: REQUIRED, 2.0.0: REQUIRED, 2.1: REQUIRED*

ActionsCopy link
[#3](#note-3)
[[ruby-core:62766]](https://blade.ruby-lang.org/ruby-core/62766)
#### Updated by [usa (Usaku NAKAMURA)](/users/9) [over 10 years](/projects/ruby-master/activity?from=2014-05-27 "05/27/2014 02:49 AM") ago

* **Backport** changed from *1.9.3: REQUIRED, 2.0.0: REQUIRED, 2.1: REQUIRED* to *1.9.3: REQUIRED, 2.0.0: DONE, 2.1: REQUIRED*

Backported into ruby\_2\_0\_0 at r46154.

ActionsCopy link
[#4](#note-4)
[[ruby-core:62800]](https://blade.ruby-lang.org/ruby-core/62800)
#### Updated by [nagachika (Tomoyuki Chikanaga)](/users/404) [over 10 years](/projects/ruby-master/activity?from=2014-05-27 "05/27/2014 03:37 PM") ago

* **Backport** changed from *1.9.3: REQUIRED, 2.0.0: DONE, 2.1: REQUIRED* to *1.9.3: REQUIRED, 2.0.0: DONE, 2.1: DONE*

r45534 was backported into `ruby_2_1` branch at r46187.

ActionsCopy link
[#5](#note-5)
[[ruby-core:62935]](https://blade.ruby-lang.org/ruby-core/62935)
#### Updated by [zeha (Christian Hofstaedtler)](/users/7963) [over 10 years](/projects/ruby-master/activity?from=2014-06-04 "06/04/2014 02:49 PM") ago

Hi,

I'm seeking explanation if this [security issue] only applies to mingw, and if so, why, as the same code appears to run on other platforms as well.

Thank you,

Christian

ActionsCopy link
[#6](#note-6)
[[ruby-core:62936]](https://blade.ruby-lang.org/ruby-core/62936)
#### Updated by [nobu (Nobuyoshi Nakada)](/users/4) [over 10 years](/projects/ruby-master/activity?from=2014-06-04 "06/04/2014 03:47 PM") ago

It's not a security issue but affects other platforms.

You need to make a 1GiB string on 32-bit platforms or on Windows, and a 4EiB string on other 64-bit platforms.

Actions
Copy link

Also available in: [Atom](/issues/9709.atom)
[PDF](/issues/9709.pdf)

Like0
Like0Like0Like0Like0Like0Like0

Powered by [Redmine](https://www.redmine.org/) © 2006-2024 Jean-Philippe Lang

Loading...



=== Content from seclists.org_e8e7c880_20250124_131405.html ===

[![](/shared/images/nst-icons.svg#menu)](#menu)
![](/shared/images/nst-icons.svg#close)
[![Home page logo](/images/sitelogo.png)](/)
[Nmap.org](https://nmap.org/)
[Npcap.com](https://npcap.com/)
[Seclists.org](https://seclists.org/)
[Sectools.org](https://sectools.org)
[Insecure.org](https://insecure.org/)

![](/shared/images/nst-icons.svg#search)

[![oss-sec logo](/images/oss-sec-logo.png)](/oss-sec/)
## [oss-sec](/oss-sec/) mailing list archives

[![Previous](/images/left-icon-16x16.png)](374)
[By Date](date.html#375)
[![Next](/images/right-icon-16x16.png)](376)

[![Previous](/images/left-icon-16x16.png)](362)
[By Thread](index.html#375)
[![Next](/images/right-icon-16x16.png)](363)

![](/shared/images/nst-icons.svg#search)

# Re: Fwd: [ruby-core:62800] [ruby-trunk - Bug #9709] Large string causes SEGV with x64-mingw32

---

*From*: cve-assign () mitre org

*Date*: Thu, 29 May 2014 02:53:24 -0400 (EDT)

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

```
> ```
> <https://bugs.ruby-lang.org/issues/9709>
> <https://bugs.ruby-lang.org/projects/ruby-trunk/repository/revisions/45534>
>
> ```

```

```
> ```
> * string.c (str_buf_cat): should round up the capacity by 4KiB,
>   but not number of rooms.   [Bug #9709]
>
> ```

```

```
> ```
> -     capa = (total + 4095) / 4096;
> +     capa = (total + 4095) / 4096 * 4096;
>
> ```

```

Use CVE-2014-3916.

- --
CVE assignment team, MITRE CVE Numbering Authority
M/S M300
202 Burlington Road, Bedford, MA 01730 USA
[ PGP key available through <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.14 (SunOS)

iQEcBAEBAgAGBQJThtdWAAoJEKllVAevmvmscQ4H/RsUSP/RBota103N7qNmMXOs
Lvt843wccI7jGQxtGXRgtqh8cIZqVPsbbZ/qkvEhbQDHkWdnE37qeHpPudhsJ/tG
SLpiYAlr7oOjX1g3jXP1eViuuUWlv6rISO0uT3FDBbPmWO//yqWA0Wg3bCsYSGIp
n4uDiMwJLO4nmx9LcJSZpT2Wsz+aqMuZKU0SN1HAcg/Br4odhhlos+6P98NHs8hk
JTyWe3kWimvKm55lRF/TI7YqPNAWayc/UOypT8WLnCZ6l5y9K2kizO6xRymfPZCI
YjWgdu/pcpRz2Oa5r7sR76jHqxuTTMJP2t6W+BSa+Ob4m63q9qRUx73rv2JU8HM=
=pWl2
-----END PGP SIGNATURE-----

```

---

[![Previous](/images/left-icon-16x16.png)](374)
[By Date](date.html#375)
[![Next](/images/right-icon-16x16.png)](376)

[![Previous](/images/left-icon-16x16.png)](362)
[By Thread](index.html#375)
[![Next](/images/right-icon-16x16.png)](363)

### Current thread:

* [Fwd: [ruby-core:62800] [ruby-trunk - Bug #9709] Large string causes SEGV with x64-mingw32](362) *Ramon de C Valle (May 27)*
  + **Re: Fwd: [ruby-core:62800] [ruby-trunk - Bug #9709] Large string causes SEGV with x64-mingw32** *cve-assign (May 28)*

![](/shared/images/nst-icons.svg#search)

## [Nmap Security Scanner](https://nmap.org/)

* [Ref Guide](https://nmap.org/book/man.html)* [Install Guide](https://nmap.org/book/install.html)* [Docs](https://nmap.org/docs.html)* [Download](https://nmap.org/download.html)* [Nmap OEM](https://nmap.org/oem/)

## [Npcap packet capture](https://npcap.com/)

* [User's Guide](https://npcap.com/guide/)* [API docs](https://npcap.com/guide/npcap-devguide.html#npcap-api)* [Download](https://npcap.com/#download)* [Npcap OEM](https://npcap.com/oem/)

## [Security Lists](https://seclists.org/)

* [Nmap Announce](https://seclists.org/nmap-announce/)* [Nmap Dev](https://seclists.org/nmap-dev/)* [Full Disclosure](https://seclists.org/fulldisclosure/)* [Open Source Security](https://seclists.org/oss-sec/)* [BreachExchange](https://seclists.org/dataloss/)

## [Security Tools](https://sectools.org)

* [Vuln scanners](https://sectools.org/tag/vuln-scanners/)* [Password audit](https://sectools.org/tag/pass-audit/)* [Web scanners](https://sectools.org/tag/web-scanners/)* [Wireless](https://sectools.org/tag/wireless/)* [Exploitation](https://sectools.org/tag/sploits/)

## [About](https://insecure.org/)

* [About/Contact](https://insecure.org/fyodor/)* [Privacy](https://insecure.org/privacy.html)* [Advertising](https://insecure.org/advertising.html)* [Nmap Public Source License](https://nmap.org/npsl/)

[![](/shared/images/nst-icons.svg#twitter)](https://twitter.com/nmap "Visit us on Twitter")
[![](/shared/images/nst-icons.svg#facebook)](https://facebook.com/nmap "Visit us on Facebook")
[![](/shared/images/nst-icons.svg#github)](https://github.com/nmap/ "Visit us on Github")
[![](/shared/images/nst-icons.svg#reddit)](https://reddit.com/r/nmap/ "Discuss Nmap on Reddit")


