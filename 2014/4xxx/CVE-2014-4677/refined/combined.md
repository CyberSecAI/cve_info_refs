=== Content from gpgtools.org_f50ffce7_20250124_211307.html ===

# GPG Suite 2015.08 August 14th, 2015

### Security Note

A bug in a Libmacgpg subcomponent could be abused by a local user to execute shell commands with root privileges ([CVE-2014-4677](http://cve.mitre.org/cgi-bin/cvename.cgi?name=2014-4677)).
This issue was fixed in GPG Suite 2015.06.
A big thank you goes out to Bruno Bierbaumer for bringing this bug to our attention.

**Note for OS X 10.6 and 10.7 users:** when installing this update, you might be asked for your admin password twice.

## GPGMail 2.5.1

### Bugfixes:

* 10.8 + 10.7: GPGMail setting to "Encrypt Drafts" could not be disabled. [#841]
* Save and display the "Update check" setting correctly. [#842]
* Properly display messages with content-type application/pgp. [#838]
* Preserve rich-text formatting when continuing drafts. When drafts where re-opened all formatting was lost. [#835]

## GPG Keychain 1.2.1

### Show key revocation date

* Key details for revoked keys now show the date of the revocation. [#345]

### Bugfixes:

* Drag & Drop of keys was not working when expert settings were enabled. [#343]

## GPGServices 1.10.1

### Supporting more applications

* Added a ton of CFBundleIdentifiers to GPGServices in order to support more applications. [#209, #144]

## MacGPG 2.0.28

### Integrate MacGPG 2.0.28 [#159]

* MacGPG is now based on gnupg 2.0.28

### Bugfixes:

* Fixes pinentry-mac to no longer be affected by the XARA attack. [#160]

## Libmacgpg 0.6

### Be more tolerant towards malformed messages

* Too many line breaks or other minor deformations of ASCII PGP data often resulted in a message that could not be decrypted. We are now much more tolerant and flexible. [#63, #145, #14, #38]

### Bugfixes:

* No more "no pinentry" errors! We've finally found a solution to fix the infamous "no pinentry" bug, caused by a socket connection to gpg-agent which was not closed under some circumstances. [#147]
* One of the most common crashes in the 2015.06 release has been fixed. GPGTaskHelperXPC no longer crashes. [#143]
* Crash in Libmacgpg GPGPacket fixed. [#146]
* Under some circumstances and empty key list was returned. [#149]
* Uses new pinentry with keychain support for new MacGPG. [#148]

[Earlier Releases](https://gpgtools.org/releases/gpgsuite/release-notes.html)



=== Content from bierbaumer.net_84a7427b_20250124_211306.html ===

# 0xbb

* [Home](/)
* [Posts](/posts/)
* [Projects](/projects/)

## GPGTools installerHelper - setuid Local Privilege Escalation

##### Tracking and CVE:

* [CVE-2014-4677](http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=2014-4677)

##### Affected version(s):

* < GPGTools 2014.12-b4

##### Fixed version:

* GPGTools 2015.06
* GPGTools 2015.08 - vulnerability disclosed ([Release Notes](https://gpgtools.org/releases/gpgsuite/2015.08/release-notes.html))

### Vulnerability:

GPGTools ships with a set-setuid installHelper binary:

```
$ ls -l /Library/Frameworks/Libmacgpg.framework/Versions/Current/Resources/

-rw-r--r--  1 root  wheel   1252 Oct 23  2013 Info.plist
-rw-r--r--  1 root  wheel    407 Oct 23  2013 Keyservers.plist
drwxr-xr-x  3 root  wheel    102 Aug 15 13:06 de.lproj
drwxr-xr-x  3 root  wheel    102 Aug 15 13:06 en.lproj
-rwsr-xr-x  1 root  wheel  68576 Oct 23  2013 installerHelper
-rw-r--r--  1 root  wheel    550 Oct 23  2013 org.gpgtools.Libmacgpg.xpc.plist
drwxr-xr-x  3 root  wheel    102 Aug 15 13:06 pinentry-mac.app

```

installHelper is used to install signed pkg-files as a normal user without root privileges:

```
$ /Library/Frameworks/Libmacgpg.framework/Versions/Current/Resources/installerHelper

Usage: installerHelper pkg-file [xml-file]
This tool checks the signature of an pkg file and installs it.
You can specify a xml-file to override the standard choices.

```

[installHelper](https://github.com/GPGTools/Libmacgpg/blob/246bbc62841847e591bc80c5926834c481bb96bb/installerHelper/main.m) installs pkg-files by passing
the pkg-file path and the xml-file path into the `installPackage` function:

```
BOOL installPackage(NSString *pkgPath, NSString *xmlPath) {
    // Run the installer command.
    NSString *commandString;
    if (xmlPath) {
        commandString = [NSString stringWithFormat:@"/usr/sbin/installer -applyChoiceChangesXML \"%@\" -pkg \"%@\" -target /", xmlPath, pkgPath];
    }
    else {
        commandString = [NSString stringWithFormat:@"/usr/sbin/installer -pkg \"%@\" -target /", pkgPath];
    }

    const char *command = [commandString UTF8String];

    uid_t uid = getuid();
    int result = setuid(0);
    if (result == 0) {
        //Run only this command with root privileges.
        result = system(command);
        setuid(uid);
    } else {
        printf("This tool needs the setuid-bit to be set and the owner must be root!\nStart a normal installation using the GUI.\n");

        commandString = [NSString stringWithFormat:@"/usr/bin/open -Wnb com.apple.installer \"%@\"", pkgPath];
        command = [commandString UTF8String];

        result = system(command);
    }

    return !!result;
}
```

`installPackage` directly passed the two paths into the `system` function and therefore is vulnerable to command injection.

### Exploitation / Proof of Concept:

The PoC makes use of the command substitution (``command``) applied by `system` to injection user-defined commands.

Before `installPackage` is called several requirements need to be fulfilled ([see here](https://github.com/GPGTools/Libmacgpg/blob/246bbc62841847e591bc80c5926834c481bb96bb/installerHelper/main.m#L13-L48)):

* the pkg-file must exist
* the pkg-file must be signed with GPGTools’s key
* if passed the xml-file must exist

A signed pkg-file (`Install.pkg`) can be obtained by downloading an [older release of GPGTools](https://raw.githubusercontent.com/0xbb/security-publications/master/GPGTools/GPG%20Suite%20-%202013.10.22.dmg).

Versions after 2014.12-b4 won’t work, because the signing key has been replaced to prevent downgrading of fixed installHelper versions to vulnerable ones.

After fulfilling the pkg-file requirements we want to inject commands via the xml-file path.

Therefore we create a file called ``dummy`` and pass it as xml-file to installHelper.

installHelper will accept it as a valid path and the command `dummy` will get executed with elevated rights.

So if we put an executable file named `dummy` into `$PATH` it will get executed.

For further details check out the full PoC: [CVE-2014-4677.sh](/CVE-2014-4677.sh)

![CVE-2014-4677-PoC](/images/CVE-2014-4677.png?dea8cb1f7f2ae653)


