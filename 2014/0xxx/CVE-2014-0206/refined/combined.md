=== Content from access.redhat.com_c04d9136_20250126_063322.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from www.kernel.org_27f912e0_20250125_060435.html ===
commit 23356555bacd63fa7c1e96a0cc928a617209d99e
Author: Greg Kroah-Hartman
Date: Mon Jun 30 20:14:09 2014 -0700
Linux 3.15.3
commit a6d4b786ebfbbb9330b6915b590547d348ec148c
Author: Andrzej Zaborowski
Date: Mon Jun 9 16:50:40 2014 +0200
efi-pstore: Fix an overflow on 32-bit builds
commit 783ee43118dc773bc8b0342c5b230e017d5a04d0 upstream.
In generic\_id the long int timestamp is multiplied by 100000 and needs
an explicit cast to u64.
Without that the id in the resulting pstore filename is wrong and
userspace may have problems parsing it, but more importantly files in
pstore can never be deleted and may fill the EFI flash (brick device?).
This happens because when generic pstore code wants to delete a file,
it passes the id to the EFI backend which reinterpretes it and a wrong
variable name is attempted to be deleted. There's no error message but
after remounting pstore, deleted files would reappear.
Signed-off-by: Andrew Zaborowski
Acked-by: David Rientjes
Signed-off-by: Matt Fleming
Signed-off-by: Greg Kroah-Hartman
commit 7f922b1920f7c38a6cf0645aea543b0ec343eb0f
Author: Fathi Boudra
Date: Sat Apr 12 13:13:24 2014 +0300
builddeb: use $OBJCOPY variable instead of objcopy
commit 6b4a144a92ab81a1f45fb9b12aebaaaee0d08120 upstream.
In cross-build environment, we expect to use the cross-compiler objcopy
instead of the host objcopy.
It fixes following build failures:
objcopy --only-keep-debug lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko /srv/build/linux/debian/dbgtmp/usr/lib/debug/lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko
objcopy: Unable to recognise the format of the input file `lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko'
Signed-off-by: Fathi Boudra
Fixes: 810e843746b7 ('deb-pkg: split debug symbols in their own package')
Reviewed-by: Ben Hutchings
Signed-off-by: Michal Marek
Signed-off-by: Greg Kroah-Hartman
commit 02bbff7274ac3f4a08536874a316e055d3be3ff5
Author: Theodore Ts'o
Date: Sun Jun 15 21:04:32 2014 -0400
random: fix nasty entropy accounting bug
commit e33ba5fa7afce1a9f159704121d4e4d110df8185 upstream.
Commit 0fb7a01af5b0 "random: simplify accounting code", introduced in
v3.15, has a very nasty accounting problem when the entropy pool has
has fewer bytes of entropy than the number of requested reserved
bytes. In that case, "have\_bytes - reserved" goes negative, and since
size\_t is unsigned, the expression:
ibytes = min\_t(size\_t, ibytes, have\_bytes - reserved);
... does not do the right thing. This is rather bad, because it
defeats the catastrophic reseeding feature in the
xfer\_secondary\_pool() path.
It also can cause the "BUG: spinlock trylock failure on UP" for some
kernel configurations when prandom\_reseed() calls get\_random\_bytes()
in the early init, since when the entropy count gets corrupted,
credit\_entropy\_bits() erroneously believes that the nonblocking pool
has been fully initialized (when in fact it is not), and so it calls
prandom\_reseed(true) recursively leading to the spinlock BUG.
The logic is \*not\* the same it was originally, but in the cases where
it matters, the behavior is the same, and the resulting code is
hopefully easier to read and understand.
Fixes: 0fb7a01af5b0 "random: simplify accounting code"
Signed-off-by: Theodore Ts'o
Cc: Greg Price
Signed-off-by: Greg Kroah-Hartman
commit faf067b39a509e17682b6276cc54012b67683dc3
Author: Konstantin Khlebnikov
Date: Tue Jun 17 06:58:05 2014 +0400
epoll: fix use-after-free in eventpoll\_release\_file
commit ebe06187bf2aec10d537ce4595e416035367d703 upstream.
This fixes use-after-free of epi->fllink.next inside list loop macro.
This loop actually releases elements in the body. The list is
rcu-protected but here we cannot hold rcu\_read\_lock because we need to
lock mutex inside.
The obvious solution is to use list\_for\_each\_entry\_safe(). RCU-ness
isn't essential because nobody can change this list under us, it's final
fput for this file.
The bug was introduced by ae10b2b4eb01 ("epoll: optimize EPOLL\_CTL\_DEL
using rcu")
Signed-off-by: Konstantin Khlebnikov
Reported-by: Cyrill Gorcunov
Cc: Sasha Levin
Cc: Jason Baron
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit a8e9e3d06557c580665d1ac5a6059cb7b9b4a01e
Author: Andy Lutomirski
Date: Mon Jun 23 14:22:15 2014 -0700
x86\_32, entry: Do syscall exit work on badsys (CVE-2014-4508)
commit 554086d85e71f30abe46fc014fea31929a7c6a8a upstream.
The bad syscall nr paths are their own incomprehensible route
through the entry control flow. Rearrange them to work just like
syscalls that return -ENOSYS.
This fixes an OOPS in the audit code when fast-path auditing is
enabled and sysenter gets a bad syscall nr (CVE-2014-4508).
This has probably been broken since Linux 2.6.27:
af0575bba0 i386 syscall audit fast-path
Cc: Roland McGrath
Reported-by: Toralf Förster
Signed-off-by: Andy Lutomirski
Link: http://lkml.kernel.org/r/e09c499eade6fc321266dd6b54da7beb28d6991c.1403558229.git.luto@amacapital.net
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 96ae603f57d56daec8f56c83d8d1a71ca2e06162
Author: Greg Kroah-Hartman
Date: Tue Jun 24 16:59:01 2014 -0400
lz4: fix another possible overrun
commit 4148c1f67abf823099b2d7db6851e4aea407f5ee upstream.
There is one other possible overrun in the lz4 code as implemented by
Linux at this point in time (which differs from the upstream lz4
codebase, but will get synced at in a future kernel release.) As
pointed out by Don, we also need to check the overflow in the data
itself.
While we are at it, replace the odd error return value with just a
"simple" -1 value as the return value is never used for anything other
than a basic "did this work or not" check.
Reported-by: "Don A. Bailey"
Reported-by: Willy Tarreau
Signed-off-by: Greg Kroah-Hartman
commit 01233a9c832037fc460e278575901a4229f3bb9e
Author: Johan Hedberg
Date: Thu May 29 19:36:53 2014 +0300
Bluetooth: Fix properly ignoring LTKs of unknown types
commit 61b433579b6ffecb1d3534fd482dcd48535277c8 upstream.
In case there are new LTK types in the future we shouldn't just blindly
assume that != MGMT\_LTK\_UNAUTHENTICATED means that the key is
authenticated. This patch adds explicit checks for each allowed key type
in the form of a switch statement and skips any key which has an unknown
value.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit 8556876847effb03ca33334464c2854bdd3f0ed8
Author: Johan Hedberg
Date: Fri May 23 13:19:53 2014 +0300
Bluetooth: Clearly distinguish mgmt LTK type from authenticated property
commit d7b2545023ecfde94d3ea9c03c5480ac18da96c9 upstream.
On the mgmt level we have a key type parameter which currently accepts
two possible values: 0x00 for unauthenticated and 0x01 for
authenticated. However, in the internal struct smp\_ltk representation we
have an explicit "authenticated" boolean value.
To make this distinction clear, add defines for the possible mgmt values
and do conversion to and from the internal authenticated value.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit 28084dbaaffc76e120736740a1e4ede158b71e9b
Author: Eric Sandeen
Date: Thu Jun 12 00:39:58 2014 -0500
btrfs: fix use of uninit "ret" in end\_extent\_writepage()
commit 3e2426bd0eb980648449e7a2f5a23e3cd3c7725c upstream.
If this condition in end\_extent\_writepage() is false:
if (tree->ops && tree->ops->writepage\_end\_io\_hook)
we will then test an uninitialized "ret" at:
ret = ret < 0 ? ret : -EIO;
The test for ret is for the case where ->writepage\_end\_io\_hook
failed, and we'd choose that ret as the error; but if
there is no ->writepage\_end\_io\_hook, nothing sets ret.
Initializing ret to 0 should be sufficient; if
writepage\_end\_io\_hook wasn't set, (!uptodate) means
non-zero err was passed in, so we choose -EIO in that case.
Signed-of-by: Eric Sandeen
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit eed31172a351856ad18081f501946e1670b6a1f6
Author: Liu Bo
Date: Mon Jun 9 10:54:07 2014 +0800
Btrfs: fix scrub\_print\_warning to handle skinny metadata extents
commit 6eda71d0c030af0fc2f68aaa676e6d445600855b upstream.
The skinny extents are intepreted incorrectly in scrub\_print\_warning(),
and end up hitting the BUG() in btrfs\_extent\_inline\_ref\_size.
Reported-by: Konstantinos Skarlatos
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 6d2a63f3d1bbdf0bcd9201e2826a727261c0becc
Author: Liu Bo
Date: Sun Jun 8 19:04:13 2014 +0800
Btrfs: use right type to get real comparison
commit cd857dd6bc2ae9ecea14e75a34e8a8fdc158e307 upstream.
We want to make sure the point is still within the extent item, not to verify
the memory it's pointing to.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit efb57277b9df5bcdf99aabd8b4bafe9c4cbd7576
Author: Josef Bacik
Date: Thu Jun 5 16:08:45 2014 -0400
Btrfs: don't check nodes for extent items
commit 8a56457f5f8fa7c2698ffae8545214c5b96a2cb5 upstream.
The backref code was looking at nodes as well as leaves when we tried to
populate extent item entries. This is not good, and although we go away with it
for the most part because we'd skip where disk\_bytenr != random\_memory,
sometimes random\_memory would match and suddenly boom. This fixes that problem.
Thanks,
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit e517155065804d25328f9f2d99a8f25e87b42749
Author: Rickard Strandqvist
Date: Thu May 22 22:43:43 2014 +0200
fs: btrfs: volumes.c: Fix for possible null pointer dereference
commit 8321cf2596d283821acc466377c2b85bcd3422b7 upstream.
There is otherwise a risk of a possible null pointer dereference.
Was largely found by using a static code analysis program called cppcheck.
Signed-off-by: Rickard Strandqvist
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 80693a87ae519cdab6b4c2a31bbadf55ec8cade9
Author: Jeff Mahoney
Date: Tue May 27 12:59:57 2014 -0400
btrfs: allocate raid type kobjects dynamically
commit c1895442be01c58449e3bf9272f22062a670e08f upstream.
We are currently allocating space\_info objects in an array when we
allocate space\_info. When a user does something like:
# btrfs balance start -mconvert=raid1 -dconvert=raid1 /mnt
# btrfs balance start -mconvert=single -dconvert=single /mnt -f
# btrfs balance start -mconvert=raid1 -dconvert=raid1 /
We can end up with memory corruption since the kobject hasn't
been reinitialized properly and the name pointer was left set.
The rationale behind allocating them statically was to avoid
creating a separate kobject container that just contained the
raid type. It used the index in the array to determine the index.
Ultimately, though, this wastes more memory than it saves in all
but the most complex scenarios and introduces kobject lifetime
questions.
This patch allocates the kobjects dynamically instead. Note that
we also remove the kobject\_get/put of the parent kobject since
kobject\_add and kobject\_del do that internally.
Signed-off-by: Jeff Mahoney
Reported-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 69a109b2cec03ef6ce93ad08e3c01665213579e3
Author: Filipe Manana
Date: Fri May 23 20:15:16 2014 +0100
Btrfs: send, use the right limits for xattr names and values
commit 7e3ae33efad1490d01040f552ef50e58ed6376ca upstream.
We were limiting the sum of the xattr name and value lengths to PATH\_MAX,
which is not correct, specially on filesystems created with btrfs-progs
v3.12 or higher, where the default leaf size is max(16384, PAGE\_SIZE), or
systems with page sizes larger than 4096 bytes.
Xattrs have their own specific maximum name and value lengths, which depend
on the leaf size, therefore use these limits to be able to send xattrs with
sizes larger than PATH\_MAX.
A test case for xfstests follows.
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 1a7fc2e61a38aeab711e7d74adab235a7cf98219
Author: Filipe Manana
Date: Sun May 25 04:49:24 2014 +0100
Btrfs: send, don't error in the presence of subvols/snapshots
commit 1af56070e3ef9477dbc7eba3b9ad7446979c7974 upstream.
If we are doing an incremental send and the base snapshot has a
directory with name X that doesn't exist anymore in the second
snapshot and a new subvolume/snapshot exists in the second snapshot
that has the same name as the directory (name X), the incremental
send would fail with -ENOENT error. This is because it attempts
to lookup for an inode with a number matching the objectid of a
root, which doesn't exist.
Steps to reproduce:
mkfs.btrfs -f /dev/sdd
mount /dev/sdd /mnt
mkdir /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap1
rmdir /mnt/testdir
btrfs subvolume create /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap2
btrfs send -p /mnt/mysnap1 /mnt/mysnap2 -f /tmp/send.data
A test case for xfstests follows.
Reported-by: Robert White
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 1b524a36f1d78a8571071c611dcdeb38e656f8a6
Author: Wang Shilong
Date: Tue May 13 17:05:06 2014 +0800
Btrfs: set right total device count for seeding support
commit 298658414a2f0bea1f05a81876a45c1cd96aa2e0 upstream.
Seeding device support allows us to create a new filesystem
based on existed filesystem.
However newly created filesystem's @total\_devices should include seed
devices. This patch fix the following problem:
# mkfs.btrfs -f /dev/sdb
# btrfstune -S 1 /dev/sdb
# mount /dev/sdb /mnt
# btrfs device add -f /dev/sdc /mnt --->fs\_devices->total\_devices = 1
# umount /mnt
# mount /dev/sdc /mnt --->fs\_devices->total\_devices = 2
This is because we record right @total\_devices in superblock, but
@fs\_devices->total\_devices is reset to be 0 in btrfs\_prepare\_sprout().
Fix this problem by not resetting @fs\_devices->total\_devices.
Signed-off-by: Wang Shilong
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 8d7293457e87c2424e90d2f893b6a28e68a2189b
Author: Liu Bo
Date: Mon May 12 12:47:36 2014 +0800
Btrfs: mark mapping with error flag to report errors to userspace
commit 5dca6eea91653e9949ce6eb9e9acab6277e2f2c4 upstream.
According to commit 865ffef3797da2cac85b3354b5b6050dc9660978
(fs: fix fsync() error reporting),
it's not stable to just check error pages because pages can be
truncated or invalidated, we should also mark mapping with error
flag so that a later fsync can catch the error.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit c6b4616c411942e2e9bba4671627f7faf0a5db6a
Author: Liu Bo
Date: Sun May 11 23:14:59 2014 +0800
Btrfs: fix NULL pointer crash of deleting a seed device
commit 29cc83f69c8338ff8fd1383c9be263d4bdf52d73 upstream.
Same as normal devices, seed devices should be initialized with
fs\_info->dev\_root as well, otherwise we'll get a NULL pointer crash.
Cc: Chris Murphy
Reported-by: Chris Murphy
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit add81375ec79d6ecfb959b321a843a608013ef32
Author: Wang Shilong
Date: Wed Apr 9 19:23:22 2014 +0800
Btrfs: make sure there are not any read requests before stopping workers
commit de348ee022175401e77d7662b7ca6e231a94e3fd upstream.
In close\_ctree(), after we have stopped all workers,there maybe still
some read requests(for example readahead) to submit and this \*maybe\* trigger
an oops that user reported before:
kernel BUG at fs/btrfs/async-thread.c:619!
By hacking codes, i can reproduce this problem with one cpu available.
We fix this potential problem by invalidating all btree inode pages before
stopping all workers.
Thanks to Miao for pointing out this problem.
Signed-off-by: Wang Shilong
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 7df26ca1d80e22cd080f7a8d9ffc307ef1661d3a
Author: Filipe Manana
Date: Sat Mar 22 17:15:24 2014 +0000
Btrfs: send, account for orphan directories when building path strings
commit c992ec94f24c3e7135d6c23860615f269f0b1d87 upstream.
If we have directories with a pending move/rename operation, we must take into
account any orphan directories that got created before executing the pending
move/rename. Those orphan directories are directories with an inode number higher
then the current send progress and that don't exist in the parent snapshot, they
are created before current progress reaches their inode number, with a generated
name of the form oN-M-I and at the root of the filesystem tree, and later when
progress matches their inode number, moved/renamed to their final location.
Reproducer:
$ mkfs.btrfs -f /dev/sdd
$ mount /dev/sdd /mnt
$ mkdir -p /mnt/a/b/c/d
$ mkdir /mnt/a/b/e
$ mv /mnt/a/b/c /mnt/a/b/e/CC
$ mkdir /mnt/a/b/e/CC/d/f
$ mkdir /mnt/a/g
$ btrfs subvolume snapshot -r /mnt /mnt/snap1
$ btrfs send /mnt/snap1 -f /tmp/base.send
$ mkdir /mnt/a/g/h
$ mv /mnt/a/b/e /mnt/a/g/h/EE
$ mv /mnt/a/g/h/EE/CC/d /mnt/a/g/h/EE/DD
$ btrfs subvolume snapshot -r /mnt /mnt/snap2
$ btrfs send -p /mnt/snap1 /mnt/snap2 -f /tmp/incremental.send
The second receive command failed with the following error:
ERROR: rename a/b/e/CC/d -> o264-7-0/EE/DD failed. No such file or directory
A test case for xfstests follows soon.
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 580b02787ebc3f9faf2f2166779f4da657de323b
Author: Miao Xie
Date: Thu Apr 24 13:31:55 2014 +0800
Btrfs: output warning instead of error when loading free space cache failed
commit 32d6b47fe6fc1714d5f1bba1b9f38e0ab0ad58a8 upstream.
If we fail to load a free space cache, we can rebuild it from the extent tree,
so it is not a serious error, we should not output a error message that
would make the users uncomfortable. This patch uses warning message instead
of it.
Signed-off-by: Miao Xie
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 2e9e31430a45cce7871c4795fea1493d08ca7061
Author: Qu Wenruo
Date: Wed Apr 16 17:02:32 2014 +0800
btrfs: Add ctime/mtime update for btrfs device add/remove.
commit 5a1972bd9fd4b2fb1bac8b7a0b636d633d8717e3 upstream.
Btrfs will send uevent to udev inform the device change,
but ctime/mtime for the block device inode is not udpated, which cause
libblkid used by btrfs-progs unable to detect device change and use old
cache, causing 'btrfs dev scan; btrfs dev rmove; btrfs dev scan' give an
error message.
Reported-by: Tsutomu Itoh
Cc: Karel Zak
Signed-off-by: Qu Wenruo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 2501c4a066e633524791e8ce8dbfe615aca071cf
Author: Filipe Manana
Date: Sat Apr 26 01:35:31 2014 +0100
Btrfs: read inode size after acquiring the mutex when punching a hole
commit a1a50f60a6bf4f861eb94793420274bc1ccd409a upstream.
In a previous change, commit 12870f1c9b2de7d475d22e73fd7db1b418599725,
I accidentally moved the roundup of inode->i\_size to outside of the
critical section delimited by the inode mutex, which is not atomic and
not correct since the size can be changed by other task before we acquire
the mutex. Therefore fix it.
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit bddf0faccf1dd39ec80059eb5266766e6bf0134c
Author: Chris Mason
Date: Wed May 21 05:49:54 2014 -0700
Btrfs: fix double free in find\_lock\_delalloc\_range
commit 7d78874273463a784759916fc3e0b4e2eb141c70 upstream.
We need to NULL the cached\_state after freeing it, otherwise
we might free it again if find\_delalloc\_range doesn't find anything.
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 938bdab6783797ff1f70cbb9cefa406889ef5c52
Author: Filipe Manana
Date: Tue Apr 29 13:18:40 2014 +0100
Btrfs: fix leaf corruption caused by ENOSPC while hole punching
commit fc19c5e73645f95d3eca12b4e91e7b56faf1e4a4 upstream.
While running a stress test with multiple threads writing to the same btrfs
file system, I ended up with a situation where a leaf was corrupted in that
it had 2 file extent item keys that had the same exact key. I was able to
detect this quickly thanks to the following patch which triggers an assertion
as soon as a leaf is marked dirty if there are duplicated keys or out of order
keys:
Btrfs: check if items are ordered when a leaf is marked dirty
(https://patchwork.kernel.org/patch/3955431/)
Basically while running the test, I got the following in dmesg:
[28877.415877] WARNING: CPU: 2 PID: 10706 at fs/btrfs/file.c:553 btrfs\_drop\_extent\_cache+0x435/0x440 [btrfs]()
(...)
[28877.415917] Call Trace:
[28877.415922] [] dump\_stack+0x4e/0x68
[28877.415926] [] warn\_slowpath\_common+0x8c/0xc0
[28877.415929] [] warn\_slowpath\_null+0x1a/0x20
[28877.415944] [] btrfs\_drop\_extent\_cache+0x435/0x440 [btrfs]
[28877.415949] [] ? kmem\_cache\_alloc+0xfe/0x1c0
[28877.415962] [] fill\_holes+0x229/0x3e0 [btrfs]
[28877.415972] [] ? block\_rsv\_add\_bytes+0x55/0x80 [btrfs]
[28877.415984] [] btrfs\_fallocate+0xb6b/0xc20 [btrfs]
(...)
[29854.132560] BTRFS critical (device sdc): corrupt leaf, bad key order: block=955232256,root=1, slot=24
[29854.132565] BTRFS info (device sdc): leaf 955232256 total ptrs 40 free space 778
(...)
[29854.132637] item 23 key (3486 108 667648) itemoff 2694 itemsize 53
[29854.132638] extent data disk bytenr 14574411776 nr 286720
[29854.132639] extent data offset 0 nr 286720 ram 286720
[29854.132640] item 24 key (3486 108 954368) itemoff 2641 itemsize 53
[29854.132641] extent data disk bytenr 0 nr 0
[29854.132643] extent data offset 0 nr 0 ram 0
[29854.132644] item 25 key (3486 108 954368) itemoff 2588 itemsize 53
[29854.132645] extent data disk bytenr 8699670528 nr 77824
[29854.132646] extent data offset 0 nr 77824 ram 77824
[29854.132647] item 26 key (3486 108 1146880) itemoff 2535 itemsize 53
[29854.132648] extent data disk bytenr 8699670528 nr 77824
[29854.132649] extent data offset 0 nr 77824 ram 77824
(...)
[29854.132707] kernel BUG at fs/btrfs/ctree.h:3901!
(...)
[29854.132771] Call Trace:
[29854.132779] [] setup\_items\_for\_insert+0x2dc/0x400 [btrfs]
[29854.132791] [] \_\_btrfs\_drop\_extents+0xba7/0xdd0 [btrfs]
[29854.132794] [] ? trace\_hardirqs\_on\_caller+0x16/0x1d0
[29854.132797] [] ? trace\_hardirqs\_on+0xd/0x10
[29854.132800] [] ? kmem\_cache\_alloc+0xfe/0x1c0
[29854.132810] [] insert\_reserved\_file\_extent.constprop.66+0xab/0x310 [btrfs]
[29854.132820] [] \_\_btrfs\_prealloc\_file\_range+0x116/0x340 [btrfs]
[29854.132830] [] btrfs\_prealloc\_file\_range+0x23/0x30 [btrfs]
(...)
So this is caused by getting an -ENOSPC error while punching a file hole, more
specifically, we get -ENOSPC error from \_\_btrfs\_drop\_extents in the while loop
of file.c:btrfs\_punch\_hole() when it's unable to modify the btree to delete one
or more file extent items due to lack of enough free space. When this happens,
in btrfs\_punch\_hole(), we attempt to reclaim free space by switching our transaction
block reservation object to root->fs\_info->trans\_block\_rsv, end our transaction and
start a new transaction basically - and, we keep increasing our current offset
(cur\_offset) as long as it's smaller than the end of the target range (lockend) -
this makes use leave the loop with cur\_offset == drop\_end which in turn makes us
call fill\_holes() for inserting a file extent item that represents a 0 bytes range
hole (and this insertion succeeds, as in the meanwhile more space became available).
This 0 bytes file hole extent item is a problem because any subsequent caller of
\_\_btrfs\_drop\_extents (regular file writes, or fallocate calls for e.g.), with a
start file offset that is equal to the offset of the hole, will not remove this
extent item due to the following conditional in the while loop of
\_\_btrfs\_drop\_extents:
if (extent\_end <= search\_start) {
path->slots[0]++;
goto next\_slot;
}
This later makes the call to setup\_items\_for\_insert() (at the very end of
\_\_btrfs\_drop\_extents), insert a new file extent item with the same offset as
the 0 bytes file hole extent item that follows it. Needless is to say that this
causes chaos, either when reading the leaf from disk (btree\_readpage\_end\_io\_hook),
where we perform leaf sanity checks or in subsequent operations that manipulate
file extent items, as in the fallocate call as shown by the dmesg trace above.
Without my other patch to perform the leaf sanity checks once a leaf is marked
as dirty (if the integrity checker is enabled), it would have been much harder
to debug this issue.
This change might fix a few similar issues reported by users in the mailing
list regarding assertion failures in btrfs\_set\_item\_key\_safe calls performed
by \_\_btrfs\_drop\_extents, such as the following report:
http://comments.gmane.org/gmane.comp.file-systems.btrfs/32938
Asking fill\_holes() to create a 0 bytes wide file hole item also produced the
first warning in the trace above, as we passed a range to btrfs\_drop\_extent\_cache
that has an end smaller (by -1) than its start.
On 3.14 kernels this issue manifests itself through leaf corruption, as we get
duplicated file extent item keys in a leaf when calling setup\_items\_for\_insert(),
but on older kernels, setup\_items\_for\_insert() isn't called by \_\_btrfs\_drop\_extents(),
instead we have callers of \_\_btrfs\_drop\_extents(), namely the functions
inode.c:insert\_inline\_extent() and inode.c:insert\_reserved\_file\_extent(), calling
btrfs\_insert\_empty\_item() to insert the new file extent item, which would fail with
error -EEXIST, instead of inserting a duplicated key - which is still a serious
issue as it would make all similar file extent item replace operations keep
failing if they target the same file range.
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 0d81fcdd1447a0d3de5e4126be10734bce3c3468
Author: Pavel Shilovsky
Date: Sat May 24 16:42:02 2014 +0400
CIFS: Fix memory leaks in SMB2\_open
commit 663a962151593c69374776e8651238d0da072459 upstream.
Signed-off-by: Pavel Shilovsky
Reviewed-by: Shirish Pargaonkar
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 0ea9bb58b2823f74ee99ad9efa63e0be5433354e
Author: Benjamin LaHaise
Date: Tue Jun 24 13:32:51 2014 -0400
aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10
commit edfbbf388f293d70bf4b7c0bc38774d05e6f711a upstream.
A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
Signed-off-by: Benjamin LaHaise
Cc: Mateusz Guzik
Cc: Petr Matousek
Cc: Kent Overstreet
Cc: Jeff Moyer
Signed-off-by: Greg Kroah-Hartman
commit b34e0e1319b31202eb142dcd9688cf7145a30bf6
Author: Benjamin LaHaise
Date: Tue Jun 24 13:12:55 2014 -0400
aio: fix aio request leak when events are reaped by userspace
commit f8567a3845ac05bb28f3c1b478ef752762bd39ef upstream.
The aio cleanups and optimizations by kmo that were merged into the 3.10
tree added a regression for userspace event reaping. Specifically, the
reference counts are not decremented if the event is reaped in userspace,
leading to the application being unable to submit further aio requests.
This patch applies to 3.12+. A separate backport is required for 3.10/3.11.
This issue was uncovered as part of CVE-2014-0206.
Signed-off-by: Benjamin LaHaise
Cc: Kent Overstreet
Cc: Mateusz Guzik
Cc: Petr Matousek
Signed-off-by: Greg Kroah-Hartman
commit a23f966716ec70c47083c06e9ddbf3d4fbc80c33
Author: Thomas Gleixner
Date: Thu Mar 7 14:53:45 2013 +0100
genirq: Sanitize spurious interrupt detection of threaded irqs
commit 1e77d0a1ed7417d2a5a52a7b8d32aea1833faa6c upstream.
Till reported that the spurious interrupt detection of threaded
interrupts is broken in two ways:
- note\_interrupt() is called for each action thread of a shared
interrupt line. That's wrong as we are only interested whether none
of the device drivers felt responsible for the interrupt, but by
calling multiple times for a single interrupt line we account
IRQ\_NONE even if one of the drivers felt responsible.
- note\_interrupt() when called from the thread handler is not
serialized. That leaves the members of irq\_desc which are used for
the spurious detection unprotected.
To solve this we need to defer the spurious detection of a threaded
interrupt to the next hardware interrupt context where we have
implicit serialization.
If note\_interrupt is called with action\_ret == IRQ\_WAKE\_THREAD, we
check whether the previous interrupt requested a deferred check. If
not, we request a deferred check for the next hardware interrupt and
return.
If set, we check whether one of the interrupt threads signaled
success. Depending on this information we feed the result into the
spurious detector.
If one primary handler of a shared interrupt returns IRQ\_HANDLED we
disable the deferred check of irq threads on the same line, as we have
found at least one device driver who cared.
Reported-by: Till Straumann
Signed-off-by: Thomas Gleixner
Tested-by: Austin Schuh
Cc: Oliver Hartkopp
Cc: Wolfgang Grandegger
Cc: Pavel Pisa
Cc: Marc Kleine-Budde
Cc: linux-can@vger.kernel.org
Link: http://lkml.kernel.org/r/alpine.LFD.2.02.1303071450130.22263@ionos
Signed-off-by: Greg Kroah-Hartman
commit 9f6900b6cf1f542bb872a180bb3b21fb2074c1a8
Author: Benjamin Herrenschmidt
Date: Mon Jun 16 19:40:20 2014 +1000
Revert "offb: Add palette hack for little endian"
commit 68986c9f0f4552c34c248501eb0c690553866d6e upstream.
This reverts commit e1edf18b20076da83dd231dbd2146cbbc31c0b14.
This patch was a misguided attempt at fixing offb for LE ppc64
kernels on BE qemu but is just wrong ... it breaks real LE/LE
setups, LE with real HW, and existing mixed endian systems
that did the fight thing with the appropriate device-tree
property. Bad reviewing on my part, sorry.
The right fix is to either make qemu change its endian when
the guest changes endian (working on that) or to use the
existing foreign endian support.
Signed-off-by: Benjamin Herrenschmidt
Signed-off-by: Greg Kroah-Hartman
commit bc862d297d12807126ec4abf780babc4f6770641
Author: Alex Deucher
Date: Sat Jun 7 11:31:25 2014 -0400
Revert "drm/radeon: use variable UVD clocks"
commit 0690a229c69f40a6c9c459ab455c85df49822525 upstream.
This caused reduced performance for some users with advanced post
processing enabled. We need a better method to pick the
UVD state based on the amount of post processing required or tune
the advanced post processing to fit within the lower power state
envelope.
This reverts commit 14a9579ddbf15dd1992a9481a4ec80b0b91656d5.
Signed-off-by: Greg Kroah-Hartman
commit 60ee64fa32a79bd6438cef27836332d58d49d1bf
Author: Mike Frysinger
Date: Sun May 4 20:43:15 2014 -0400
x86, x32: Use compat shims for io\_{setup,submit}
commit 7fd44dacdd803c0bbf38bf478d51d280902bb0f1 upstream.
The io\_setup takes a pointer to a context id of type aio\_context\_t.
This in turn is typed to a \_\_kernel\_ulong\_t. We could tweak the
exported headers to define this as a 64bit quantity for specific
ABIs, but since we already have a 32bit compat shim for the x86 ABI,
let's just re-use that logic. The libaio package is also written to
expect this as a pointer type, so a compat shim would simplify that.
The io\_submit func operates on an array of pointers to iocb structs.
Padding out the array to be 64bit aligned is a huge pain, so convert
it over to the existing compat shim too.
We don't convert io\_getevents to the compat func as its only purpose
is to handle the timespec struct, and the x32 ABI uses 64bit times.
With this change, the libaio package can now pass its testsuite when
built for the x32 ABI.
Signed-off-by: Mike Frysinger
Link: http://lkml.kernel.org/r/1399250595-5005-1-git-send-email-vapier@gentoo.org
Cc: H.J. Lu
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 0d8ab48e3cc886d9d3ba9de66a1212c151c38b11
Author: H. Peter Anvin
Date: Wed Apr 30 14:03:25 2014 -0700
x86-32, espfix: Remove filter for espfix32 due to race
commit 246f2d2ee1d715e1077fc47d61c394569c8ee692 upstream.
It is not safe to use LAR to filter when to go down the espfix path,
because the LDT is per-process (rather than per-thread) and another
thread might change the descriptors behind our back. Fortunately it
is always \*safe\* (if a bit slow) to go down the espfix path, and a
32-bit LDT stack segment is extremely rare.
Signed-off-by: H. Peter Anvin
Link: http://lkml.kernel.org/r/1398816946-3351-1-git-send-email-hpa@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 6b4e1805412053a0f7dcb7ae0a2d92c175cd16d4
Author: Will Deacon
Date: Wed Jun 18 14:06:27 2014 +0100
arm64: mm: remove broken &= operator from pmd\_mknotpresent
commit e3a920afc3482e954834a4ed95908c4bc5e4c000 upstream.
This should be a plain old '&' and could easily lead to undefined
behaviour if the target of a pmd\_mknotpresent invocation was the same
as the parameter.
Fixes: 9c7e535fcc17 (arm64: mm: Route pmd thp functions through pte equivalents)
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 92abb0be9f448c2c7e7d217ba1f8674aa323d31c
Author: Suravee Suthikulpanit
Date: Fri Jun 6 23:07:16 2014 +0100
arm64/dma: Removing ARCH\_HAS\_DMA\_GET\_REQUIRED\_MASK macro
commit f3a183cb422574014538017b5b291a416396f97e upstream.
Arm64 does not define dma\_get\_required\_mask() function.
Therefore, it should not define the ARCH\_HAS\_DMA\_GET\_REQUIRED\_MASK.
This causes build errors in some device drivers (e.g. mpt2sas)
Signed-off-by: Suravee Suthikulpanit
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 04c4b55db2b88ffd4f2fd0e30e2f0a6d1da3ff4e
Author: Will Deacon
Date: Mon Jun 2 11:47:29 2014 +0100
arm64: uid16: fix \_\_kernel\_old\_{gid,uid}\_t definitions
commit 34c65c43f1518bf85f93526ad373adc6a683b4c5 upstream.
Whilst native arm64 applications don't have the 16-bit UID/GID syscalls
wired up, compat tasks can still access them. The 16-bit wrappers for
these syscalls use \_\_kernel\_old\_uid\_t and \_\_kernel\_old\_gid\_t, which must
be 16-bit data types to maintain compatibility with the 16-bit UIDs used
by compat applications.
This patch defines 16-bit \_\_kernel\_old\_{gid,uid}\_t types for arm64
instead of using the 32-bit types provided by asm-generic.
Signed-off-by: Will Deacon
Acked-by: Arnd Bergmann
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit a198057408f45226bd970c808bf93010a6e12b32
Author: Jason Cooper
Date: Wed Jun 4 13:41:20 2014 +0000
ARM: mvebu: DT: fix OpenBlocks AX3-4 RAM size
commit e47043aea3853a74a9aa5726a1faa916d7462ab7 upstream.
The OpenBlocks AX3-4 has a non-DT bootloader. It also comes with 1GB of
soldered on RAM, and a DIMM slot for expansion.
Unfortunately, atags\_to\_fdt() doesn't work in big-endian mode, so we see
the following failure when attempting to boot a big-endian kernel:
686 slab pages
17 pages shared
0 pages swap cached
[ pid ] uid tgid total\_vm rss nr\_ptes swapents oom\_score\_adj name
Kernel panic - not syncing: Out of memory and no killable processes...
CPU: 1 PID: 351 Comm: kworker/u4:0 Not tainted 3.15.0-rc8-next-20140603 #1
[] (unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0x78/0x94)
[] (dump\_stack) from [] (panic+0x90/0x21c)
[] (panic) from [] (out\_of\_memory+0x320/0x340)
[] (out\_of\_memory) from [] (\_\_alloc\_pages\_nodemask+0x874/0x930)
[] (\_\_alloc\_pages\_nodemask) from [] (handle\_mm\_fault+0x744/0x96c)
[] (handle\_mm\_fault) from [] (\_\_get\_user\_pages+0xd0/0x4c0)
[] (\_\_get\_user\_pages) from [] (get\_arg\_page+0x54/0xbc)
[] (get\_arg\_page) from [] (copy\_strings+0x278/0x29c)
[] (copy\_strings) from [] (copy\_strings\_kernel+0x20/0x28)
[] (copy\_strings\_kernel) from [] (do\_execve+0x3a8/0x4c8)
[] (do\_execve) from [] (\_\_\_\_call\_usermodehelper+0x15c/0x194)
[] (\_\_\_\_call\_usermodehelper) from [] (ret\_from\_fork+0x14/0x3c)
CPU0: stopping
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 3.15.0-rc8-next-20140603 #1
[] (unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0x78/0x94)
[] (dump\_stack) from [] (handle\_IPI+0x138/0x174)
[] (handle\_IPI) from [] (armada\_370\_xp\_handle\_irq+0xb0/0xcc)
[] (armada\_370\_xp\_handle\_irq) from [] (\_\_irq\_svc+0x40/0x50)
Exception stack(0xc0b6bf68 to 0xc0b6bfb0)
bf60: e9fad598 00000000 00f509a3 00000000 c0b6a000 c0b724c4
bf80: c0b72458 c0b6a000 00000000 00000000 c0b66da0 c0b6a000 00000000 c0b6bfb0
bfa0: c027bb94 c027bb24 60000313 ffffffff
[] (\_\_irq\_svc) from [] (cpu\_startup\_entry+0x54/0x214)
[] (cpu\_startup\_entry) from [] (start\_kernel+0x318/0x37c)
[] (start\_kernel) from [<00208078>] (0x208078)
---[ end Kernel panic - not syncing: Out of memory and no killable processes...
A similar failure will also occur if ARM\_ATAG\_DTB\_COMPAT isn't selected.
Fix this by setting a sane default (1 GB) in the dts file.
Signed-off-by: Jason Cooper
Tested-by: Kevin Hilman
Signed-off-by: Arnd Bergmann
Signed-off-by: Greg Kroah-Hartman
commit fecb45f70819ed260fc801c27ef41bf573ee7739
Author: Jaegeuk Kim
Date: Thu Apr 24 09:49:52 2014 +0900
f2fs: submit bio at the reclaim path
commit 2aea39eca6b68d6ae7eb545332df0695f56a3d3f upstream.
If f2fs\_write\_data\_page is called through the reclaim path, we should submit
the bio right away.
This patch resolves the following issue that Marc Dietrich reported.
"It took me a while to bisect a problem which causes my ARM (tegra2) netbook to
frequently stall for 5-10 seconds when I enable EXA acceleration (opentegra
experimental ddx)."
And this patch fixes that.
Reported-by: Marc Dietrich
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 7d9710389b7c1f975e290c0f1b557245a3abe0d5
Author: Sagi Grimberg
Date: Wed Jun 11 12:09:59 2014 +0300
TARGET/sbc,loopback: Adjust command data length in case pi exists on the wire
commit e2a4f55c6498b59a17a85a1bb6db122a993ffe02 upstream.
In various areas of the code, it is assumed that
se\_cmd->data\_length describes pure data. In case
that protection information exists over the wire
(protect bits is are on) the target core re-calculates
the data length from the CDB and the backed device
block size (instead of each transport peeking in the cdb).
Modify loopback device to include protection information
in the transferred data length (like other scsi transports).
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 04423ddea30a7fb7232636eda8aed55ea5b972fe
Author: Sagi Grimberg
Date: Wed Jun 11 12:09:58 2014 +0300
libiscsi, iser: Adjust data\_length to include protection information
commit d77e65350f2d82dfa0557707d505711f5a43c8fd upstream.
In case protection information exists over the wire
iscsi header data length is required to include it.
Use protection information aware scsi helpers to set
the correct transfer length.
In order to avoid breakage, remove iser transfer length
checks for each task as they are not always true and
somewhat redundant anyway.
Signed-off-by: Sagi Grimberg
Reviewed-by: Mike Christie
Acked-by: Mike Christie
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit ff04e8f8acb5ccc792d905b58f5e3353f4e26753
Author: Sagi Grimberg
Date: Wed Jun 11 12:09:57 2014 +0300
scsi\_cmnd: Introduce scsi\_transfer\_length helper
commit 8846bab180fa2bcfe02d4ba5288fbaba12c8f4f3 upstream.
In case protection information exists on the wire
scsi transports should include it in the transfer
byte count (even if protection information does not
exist in the host memory space). This helper will
compute the total transfer length from the scsi
command data length and protection attributes.
Signed-off-by: Sagi Grimberg
Signed-off-by: Martin K. Petersen
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 7062995ffa52d527b90f2c5b6379ebd64a00231b
Author: Roland Dreier
Date: Tue Jun 10 11:07:47 2014 -0700
target: Report correct response length for some commands
commit 2426bd456a61407388b6e61fc5f98dbcbebc50e2 upstream.
When an initiator sends an allocation length bigger than what its
command consumes, the target should only return the actual response data
and set the residual length to the unused part of the allocation length.
Add a helper function that command handlers (INQUIRY, READ CAPACITY,
etc) can use to do this correctly, and use this code to get the correct
residual for commands that don't use the full initiator allocation in the
handlers for READ CAPACITY, READ CAPACITY(16), INQUIRY, MODE SENSE and
REPORT LUNS.
This addresses a handful of failures as reported by Christophe with
the Windows Certification Kit:
http://permalink.gmane.org/gmane.linux.scsi.target.devel/6515
Signed-off-by: Roland Dreier
Tested-by: Christophe Vu-Brugier
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit cc74a0efa82c7b8ae634e68f20c2b414eed99cee
Author: Sagi Grimberg
Date: Tue Jun 10 18:27:59 2014 +0300
Target/iscsi: Fix sendtargets response pdu for iser transport
commit 22c7aaa57e80853b4904a46c18f97db0036a3b97 upstream.
In case the transport is iser we should not include the
iscsi target info in the sendtargets text response pdu.
This causes sendtargets response to include the target
info twice.
Modify iscsit\_build\_sendtargets\_response to filter
transport types that don't match.
Signed-off-by: Sagi Grimberg
Reported-by: Slava Shwartsman
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 0df3f92bba2f5c07e6dfdfe72e80bf5f00a34277
Author: Sagi Grimberg
Date: Tue Jun 10 13:41:41 2014 +0300
Target/iser: Fix a wrong dereference in case discovery session is over iser
commit e0546fc1ba66c90cb38a5764357366267d3e58e4 upstream.
In case the discovery session is carried over iser, we can't
access the assumed network portal since the default portal is
used. In this case we don't really need to allocate the fastreg
pool, just prepare to the text pdu that will follow.
Signed-off-by: Sagi Grimberg
Reported-by: Alex Tabachnik
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 7b93e2d1bc8076a6d9649249397d9e703fa3e2d0
Author: Nicholas Bellinger
Date: Tue Jun 10 04:03:54 2014 +0000
iscsi-target: Fix ABORT\_TASK + connection reset iscsi\_queue\_req memory leak
commit bbc050488525e1ab1194c27355f63c66814385b8 upstream.
This patch fixes a iscsi\_queue\_req memory leak when ABORT\_TASK response
has been queued by TFO->queue\_tm\_rsp() -> lio\_queue\_tm\_rsp() after a
long standing I/O completes, but the connection has already reset and
waiting for cleanup to complete in iscsit\_release\_commands\_from\_conn()
-> transport\_generic\_free\_cmd() -> transport\_wait\_for\_tasks() code.
It moves iscsit\_free\_queue\_reqs\_for\_conn() after the per-connection command
list has been released, so that the associated se\_cmd tag can be completed +
released by target-core before freeing any remaining iscsi\_queue\_req memory
for the connection generated by lio\_queue\_tm\_rsp().
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit e6a77ef4776bd9c5ed70db30b8835b094442dbd1
Author: Nicholas Bellinger
Date: Mon Jun 9 23:36:51 2014 +0000
target: Use complete\_all for se\_cmd->t\_transport\_stop\_comp
commit a95d6511303b848da45ee27b35018bb58087bdc6 upstream.
This patch fixes a bug where multiple waiters on ->t\_transport\_stop\_comp
occurs due to a concurrent ABORT\_TASK and session reset both invoking
transport\_wait\_for\_tasks(), while waiting for the associated se\_cmd
descriptor backend processing to complete.
For this case, complete\_all() should be invoked in order to wake up
both waiters in core\_tmr\_abort\_task() + transport\_generic\_free\_cmd()
process contexts.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit fef5453a45973229e7b9545c5f88a6654271254d
Author: Nicholas Bellinger
Date: Mon Jun 9 23:13:20 2014 +0000
target: Set CMD\_T\_ACTIVE bit for Task Management Requests
commit f15e9cd910c4d9da7de43f2181f362082fc45f0f upstream.
This patch fixes a bug where se\_cmd descriptors associated with a
Task Management Request (TMR) where not setting CMD\_T\_ACTIVE before
being dispatched into target\_tmr\_work() process context.
This is required in order for transport\_generic\_free\_cmd() ->
transport\_wait\_for\_tasks() to wait on se\_cmd->t\_transport\_stop\_comp
if a session reset event occurs while an ABORT\_TASK is outstanding
waiting for another I/O to complete.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 5b50bf7e57c68316c1bda049d7b2c101ab7a8dcf
Author: Sagi Grimberg
Date: Tue May 20 13:28:11 2014 +0300
Target/iser: Gracefully reject T10-PI enabled connect request if not supported
commit 5f80ff8eccba50832dcc640ac89add4c7fced963 upstream.
In case user chose to set T10-PI enable on the target while
the IB device does not support it, gracefully reject the request.
Reported-by: Slava Shwartsman
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit d616f6745dbf0b178e8f645a7a0e662ccc4edd0d
Author: Sagi Grimberg
Date: Mon May 19 17:44:25 2014 +0300
Target/iser: Wait for proper cleanup before unloading
commit f5ebec9629cf78eeeea4b8258882a9f439ab2404 upstream.
disconnected\_handler works are scheduled on system\_wq.
When attempting to unload, first make sure all works
have cleaned up.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 60acd16827caff96a301edfcac719bc9bd7e060d
Author: Sagi Grimberg
Date: Mon May 19 17:44:24 2014 +0300
Target/iser: Improve cm events handling
commit 88c4015fda6d014392f76d3b1688347950d7a12d upstream.
There are 4 RDMA\_CM events that all basically mean that
the user should teardown the IB connection:
- DISCONNECTED
- ADDR\_CHANGE
- DEVICE\_REMOVAL
- TIMEWAIT\_EXIT
Only in DISCONNECTED/ADDR\_CHANGE it makes sense to
call rdma\_disconnect (send DREQ/DREP to our initiator).
So we keep the same teardown handler for all of them
but only indicate calling rdma\_disconnect for the relevant
events.
This patch also removes redundant debug prints for each single
event.
v2 changes:
- Call isert\_disconnected\_handler() for DEVICE\_REMOVAL (Or + Sag)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 5a1e941c438549d06038184a92cb466969bf0879
Author: Sagi Grimberg
Date: Mon May 19 17:44:23 2014 +0300
Target/iser: Fix hangs in connection teardown
commit 9d49f5e284e700576f3b65f1e28dea8539da6661 upstream.
In ungraceful teardowns isert close flows seem racy such that
isert\_wait\_conn hangs as RDMA\_CM\_EVENT\_DISCONNECTED never
gets invoked (no one called rdma\_disconnect).
Both graceful and ungraceful teardowns will have rx flush errors
(isert posts a batch once connection is established). Once all
flush errors are consumed we invoke isert\_wait\_conn and it will
be responsible for calling rdma\_disconnect. This way it can be
sure that rdma\_disconnect was called and it won't wait forever.
This patch also removes the logout\_posted indicator. either the
logout completion was consumed and no problem decrementing the
post\_send\_buf\_count, or it was consumed as a flush error. no point
of keeping it for isert\_wait\_conn as there is no danger that
isert\_conn will be accidentally removed while it is running.
(Drop unnecessary sleep\_on\_conn\_wait\_comp check in
isert\_cq\_rx\_comp\_err - nab)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit ec47f51927e9cc67d60362835b26af756a7faded
Author: Sagi Grimberg
Date: Mon May 19 17:44:22 2014 +0300
Target/iser: Bail from accept\_np if np\_thread is trying to close
commit e346ab343f4f58c12a96725c7b13df9cc2ad56f6 upstream.
In case np\_thread state is in RESET/SHUTDOWN/EXIT states,
no point for isert to stall there as we may get a hang in
case no one will wake it up later.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit dc87ca321a9c8a6d1cb59c0274ce2f251683bb8a
Author: Johan Hedberg
Date: Mon Jun 2 10:12:44 2014 +0300
Bluetooth: Fix missing check for FIPS security level
commit f3fb0b58c85666f73139963a7a04d7878f3d22c9 upstream.
When checking whether a legacy link key provides at least HIGH security
level we also need to check for FIPS level which is one step above HIGH.
This patch fixes a missing check in the hci\_link\_key\_request\_evt()
function.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit 087ad42b882be734e335a5534bb5987fda8aab1a
Author: Johan Hedberg
Date: Sun Jun 1 09:45:24 2014 +0300
Bluetooth: Fix requiring SMP MITM for outgoing connections
commit 79897d2097a629179e142014ecd3cdce6eac7f0e upstream.
Due to recent changes to the way that the MITM requirement is set for
outgoing pairing attempts we can no longer rely on the hcon->auth\_type
variable (which is actually good since it was formed from BR/EDR
concepts that don't really exist for SMP).
To match the logic that BR/EDR now uses simply rely on the local IO
capability and/or needed security level to set the MITM requirement for
outgoing pairing requests.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit c714b3b6dbe642ee9c9e3c4d4696518aa6b09cc0
Author: Johan Hedberg
Date: Fri May 30 14:45:19 2014 +0300
Bluetooth: Fix authentication check for FIPS security level
commit 7e3691e13ab51f3491e996e2edaf99b173621288 upstream.
When checking whether we need to request authentication or not we should
include HCI\_SECURITY\_FIPS to the levels that always need authentication.
This patch fixes check for it in the hci\_outgoing\_auth\_needed()
function.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit df065634d8458d1fa5113ca323e9c770295b6d95
Author: Jukka Taimisto
Date: Thu May 22 10:02:39 2014 +0000
Bluetooth: Fix L2CAP deadlock
commit 8a96f3cd22878fc0bb564a8478a6e17c0b8dca73 upstream.
-[0x01 Introduction
We have found a programming error causing a deadlock in Bluetooth subsystem
of Linux kernel. The problem is caused by missing release\_sock() call when
L2CAP connection creation fails due full accept queue.
The issue can be reproduced with 3.15-rc5 kernel and is also present in
earlier kernels.
-[0x02 Details
The problem occurs when multiple L2CAP connections are created to a PSM which
contains listening socket (like SDP) and left pending, for example,
configuration (the underlying ACL link is not disconnected between
connections).
When L2CAP connection request is received and listening socket is found the
l2cap\_sock\_new\_connection\_cb() function (net/bluetooth/l2cap\_sock.c) is called.
This function locks the 'parent' socket and then checks if the accept queue
is full.
1178 lock\_sock(parent);
1179
1180 /\* Check for backlog size \*/
1181 if (sk\_acceptq\_is\_full(parent)) {
1182 BT\_DBG("backlog full %d", parent->sk\_ack\_backlog);
1183 return NULL;
1184 }
If case the accept queue is full NULL is returned, but the 'parent' socket
is not released. Thus when next L2CAP connection request is received the code
blocks on lock\_sock() since the parent is still locked.
Also note that for connections already established and waiting for
configuration to complete a timeout will occur and l2cap\_chan\_timeout()
(net/bluetooth/l2cap\_core.c) will be called. All threads calling this
function will also be blocked waiting for the channel mutex since the thread
which is waiting on lock\_sock() alread holds the channel mutex.
We were able to reproduce this by sending continuously L2CAP connection
request followed by disconnection request containing invalid CID. This left
the created connections pending configuration.
After the deadlock occurs it is impossible to kill bluetoothd, btmon will not
get any more data etc. requiring reboot to recover.
-[0x03 Fix
Releasing the 'parent' socket when l2cap\_sock\_new\_connection\_cb() returns NULL
seems to fix the issue.
Signed-off-by: Jukka Taimisto
Reported-by: Tommi Mäkilä
Signed-off-by: Johan Hedberg
Signed-off-by: Greg Kroah-Hartman
commit e287dd769cfb223db1bd4bdf1ad3c3936f368c3d
Author: Jukka Rissanen
Date: Tue May 27 11:33:22 2014 +0300
Bluetooth: 6LoWPAN: Fix MAC address universal/local bit handling
commit 62bbd5b35994eaf30519f126765d7f6af9cd3526 upstream.
The universal/local bit handling was incorrectly done in the code.
So when setting EUI address from BD address we do this:
- If BD address type is PUBLIC, then we clear the universal bit
in EUI address. If the address type is RANDOM, then the universal
bit is set (BT 6lowpan draft chapter 3.2.2)
- After this we invert the universal/local bit according to RFC 2464
When figuring out BD address we do the reverse:
- Take EUI address from stateless IPv6 address, invert the
universal/local bit according to RFC 2464
- If universal bit is 1 in this modified EUI address, then address
type is set to RANDOM, otherwise it is PUBLIC
Note that 6lowpan\_iphc.[ch] does the final toggling of U/L bit
before sending or receiving the network packet.
Signed-off-by: Jukka Rissanen
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit b29d1fa928a410cb37afc4a7e22aba1ca231bddc
Author: Felipe Balbi
Date: Wed Apr 23 09:58:26 2014 -0500
bluetooth: hci\_ldisc: fix deadlock condition
commit da64c27d3c93ee9f89956b9de86c4127eb244494 upstream.
LDISCs shouldn't call tty->ops->write() from within
->write\_wakeup().
->write\_wakeup() is called with port lock taken and
IRQs disabled, tty->ops->write() will try to acquire
the same port lock and we will deadlock.
Acked-by: Marcel Holtmann
Reviewed-by: Peter Hurley
Reported-by: Huang Shijie
Signed-off-by: Felipe Balbi
Tested-by: Andreas Bießmann
Signed-off-by: Greg Kroah-Hartman
commit d9d4f29b1e0546096112fd9586e700db26af5379
Author: Chander Kashyap
Date: Fri May 16 16:21:17 2014 +0530
PM / OPP: fix incorrect OPP count handling in of\_init\_opp\_table
commit 086abb58590a4df73e8a6ed71fd418826937cd46 upstream.
In of\_init\_opp\_table function, if a failure to add an OPP is
detected, the count of OPPs, yet to be added is not updated.
Fix this by decrementing this count on failure as well.
Signed-off-by: Chander Kashyap
Signed-off-by: Inderpal Singh
Acked-by: Viresh Kumar
Acked-by: Nishanth Menon
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit a1e7be05dd5f0c6f8e98fcbcd5a1a2ee55355e6b
Author: Pekon Gupta
Date: Mon May 19 16:52:36 2014 +0530
ARM: OMAP2+: gpmc: enable BCH\_HW ecc-scheme for AM43xx platforms
commit 2e091d13e65d26f21159323b95b426e5bc42670c upstream.
Fixes: commit 0611c41934ab35ce84dea34ab291897ad3cbc7be
ARM: OMAP2+: gpmc: update gpmc\_hwecc\_bch\_capable() for new platforms and ECC schemes
Though the commit log of above commit mentions AM43xx platforms, but code change
missed AM43xx. This patch adds AM43xx to list of those SoC which have built-in
ELM hardware engine, so that BCH ecc-schemes with hardware error-correction can
be enabled on AM43xx devices.
Reported-by: Roger Quadros
Signed-off-by: Pekon Gupta
Signed-off-by: Tony Lindgren
Signed-off-by: Greg Kroah-Hartman
commit 00d5951b489c8de9f27f335e0c091dfca6683220
Author: Jianguo Wu
Date: Thu Apr 24 03:45:56 2014 +0100
ARM: 8037/1: mm: support big-endian page tables
commit 86f40622af7329375e38f282f6c0aab95f3e5f72 upstream.
When enable LPAE and big-endian in a hisilicon board, while specify
mem=384M mem=512M@7680M, will get bad page state:
Freeing unused kernel memory: 180K (c0466000 - c0493000)
BUG: Bad page state in process init pfn:fa442
page:c7749840 count:0 mapcount:-1 mapping: (null) index:0x0
page flags: 0x40000400(reserved)
Modules linked in:
CPU: 0 PID: 1 Comm: init Not tainted 3.10.27+ #66
[] (unwind\_backtrace+0x0/0x11c) from [] (show\_stack+0x10/0x14)
[] (show\_stack+0x10/0x14) from [] (bad\_page+0xd4/0x104)
[] (bad\_page+0xd4/0x104) from [] (free\_pages\_prepare+0xa8/0x14c)
[] (free\_pages\_prepare+0xa8/0x14c) from [] (free\_hot\_cold\_page+0x18/0xf0)
[] (free\_hot\_cold\_page+0x18/0xf0) from [] (handle\_pte\_fault+0xcf4/0xdc8)
[] (handle\_pte\_fault+0xcf4/0xdc8) from [] (handle\_mm\_fault+0xf4/0x120)
[] (handle\_mm\_fault+0xf4/0x120) from [] (do\_page\_fault+0xfc/0x354)
[] (do\_page\_fault+0xfc/0x354) from [] (do\_DataAbort+0x2c/0x90)
[] (do\_DataAbort+0x2c/0x90) from [] (\_\_dabt\_usr+0x34/0x40)
The bad pfn:fa442 is not system memory(mem=384M mem=512M@7680M), after debugging,
I find in page fault handler, will get wrong pfn from pte just after set pte,
as follow:
do\_anonymous\_page()
{
...
set\_pte\_at(mm, address, page\_table, entry);
//debug code
pfn = pte\_pfn(entry);
pr\_info("pfn:0x%lx, pte:0x%llxn", pfn, pte\_val(entry));
//read out the pte just set
new\_pte = pte\_offset\_map(pmd, address);
new\_pfn = pte\_pfn(\*new\_pte);
pr\_info("new pfn:0x%lx, new pte:0x%llxn", pfn, pte\_val(entry));
...
}
pfn: 0x1fa4f5, pte:0xc00001fa4f575f
new\_pfn:0xfa4f5, new\_pte:0xc00000fa4f5f5f //new pfn/pte is wrong.
The bug is happened in cpu\_v7\_set\_pte\_ext(ptep, pte):
An LPAE PTE is a 64bit quantity, passed to cpu\_v7\_set\_pte\_ext in the r2 and r3 registers.
On an LE kernel, r2 contains the LSB of the PTE, and r3 the MSB.
On a BE kernel, the assignment is reversed.
Unfortunately, the current code always assumes the LE case,
leading to corruption of the PTE when clearing/setting bits.
This patch fixes this issue much like it has been done already in the
cpu\_v7\_switch\_mm case.
Signed-off-by: Jianguo Wu
Acked-by: Marc Zyngier
Acked-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 31ce3db939c658722d402159af2755a356366740
Author: Russell King
Date: Sat May 3 11:03:28 2014 +0100
ARM: stacktrace: avoid listing stacktrace functions in stacktrace
commit 3683f44c42e991d313dc301504ee0fca1aeb8580 upstream.
While debugging the FEC ethernet driver using stacktrace, it was noticed
that the stacktraces always begin as follows:
[] save\_stack\_trace\_tsk+0x0/0x98
[] save\_stack\_trace+0x24/0x28
...
This is because the stack trace code includes the stack frames for itself.
This is incorrect behaviour, and also leads to "skip" doing the wrong
thing (which is the number of stack frames to avoid recording.)
Perversely, it does the right thing when passed a non-current thread. Fix
this by ensuring that we have a known constant number of frames above the
main stack trace function, and always skip these.
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit ba04d3758729d795c7ffca9f8d7dd1c4e07ac2c8
Author: Hans Verkuil
Date: Thu Apr 17 07:24:31 2014 -0300
media: saa7134: fix regression with tvtime
commit 17e7f1b515803e1a79b246688aacbddd2e34165d upstream.
This solves this bug:
https://bugzilla.kernel.org/show\_bug.cgi?id=73361
The problem is that when you quit tvtime it calls STREAMOFF, but then it queues a
bunch of buffers for no good reason before closing the file descriptor.
In the past closing the fd would free the vb queue since that was part of the file
handle struct. Since that was moved to the global struct that no longer happened.
This wouldn't be a problem, but the extra QBUF calls that tvtime does meant that
the buffer list in videobuf (q->stream) contained buffers, so REQBUFS would fail
with -EBUSY.
The solution is to init the list head explicitly when releasing the file
descriptor and to not free the video resource when calling streamoff.
The real fix will hopefully go into kernel 3.16 when the vb2 conversion is
merged. Basically the saa7134 driver with the old videobuf is so full of holes it
ain't funny anymore, so consider this a band-aid for kernels 3.14 and 15.
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 8def99cd33c20db5bc9296c1d55ed96c2e12f9ae
Author: Pali Rohár
Date: Tue Apr 22 12:02:39 2014 -0300
media: radio-bcm2048: fix wrong overflow check
commit 5d60122b7e30f275593df93b39a76d3c2663cfc2 upstream.
This patch fixes an off by one check in bcm2048\_set\_region().
Reported-by: Dan Carpenter
Signed-off-by: Pali Rohár
Signed-off-by: Pavel Machek
Signed-off-by: Dan Carpenter
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 4a579221c86dc35646e5c314804c876524a20675
Author: Olivier Langlois
Date: Fri Mar 28 02:42:38 2014 -0300
media: uvcvideo: Fix clock param realtime setting
commit 3b35fc81e7ec552147a4fd843d0da0bbbe4ef253 upstream.
timestamps in v4l2 buffers returned to userspace are updated in
uvc\_video\_clock\_update() which uses timestamps fetched from
uvc\_video\_clock\_decode() by calling unconditionally ktime\_get\_ts().
Hence setting the module clock param to realtime has no effect before
this patch.
This has been tested with ffmpeg:
ffmpeg -y -f v4l2 -input\_format yuyv422 -video\_size 640x480 -framerate 30 -i /dev/video0 \
-f alsa -acodec pcm\_s16le -ar 16000 -ac 1 -i default \
-c:v libx264 -preset ultrafast \
-c:a libfdk\_aac \
out.mkv
and inspecting the v4l2 input starting timestamp.
Signed-off-by: Olivier Langlois
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 61078ded4727ee2822a2aaa61ec71b4a1818cc90
Author: Thomas Gleixner
Date: Wed Jun 11 18:44:04 2014 +0000
rtmutex: Plug slow unlock race
commit 27e35715df54cbc4f2d044f681802ae30479e7fb upstream.
When the rtmutex fast path is enabled the slow unlock function can
create the following situation:
spin\_lock(foo->m->wait\_lock);
foo->m->owner = NULL;
rt\_mutex\_lock(foo->m); <-- fast path
free = atomic\_dec\_and\_test(foo->refcnt);
rt\_mutex\_unlock(foo->m); <-- fast path
if (free)
kfree(foo);
spin\_unlock(foo->m->wait\_lock); <--- Use after free.
Plug the race by changing the slow unlock to the following scheme:
while (!rt\_mutex\_has\_waiters(m)) {
/\* Clear the waiters bit in m->owner \*/
clear\_rt\_mutex\_waiters(m);
owner = rt\_mutex\_owner(m);
spin\_unlock(m->wait\_lock);
if (cmpxchg(m->owner, owner, 0) == owner)
return;
spin\_lock(m->wait\_lock);
}
So in case of a new waiter incoming while the owner tries the slow
path unlock we have two situations:
unlock(wait\_lock);
lock(wait\_lock);
cmpxchg(p, owner, 0) == owner
mark\_rt\_mutex\_waiters(lock);
acquire(lock);
Or:
unlock(wait\_lock);
lock(wait\_lock);
mark\_rt\_mutex\_waiters(lock);
cmpxchg(p, owner, 0) != owner
enqueue\_waiter();
unlock(wait\_lock);
lock(wait\_lock);
wakeup\_next waiter();
unlock(wait\_lock);
lock(wait\_lock);
acquire(lock);
If the fast path is disabled, then the simple
m->owner = NULL;
unlock(m->wait\_lock);
is sufficient as all access to m->owner is serialized via
m->wait\_lock;
Also document and clarify the wakeup\_next\_waiter function as suggested
by Oleg Nesterov.
Reported-by: Steven Rostedt
Signed-off-by: Thomas Gleixner
Reviewed-by: Steven Rostedt
Cc: Peter Zijlstra
Link: http://lkml.kernel.org/r/20140611183852.937945560@linutronix.de
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 2b1f3807ed9cafb59c956ce76a05d25e67103f2e
Author: Thomas Gleixner
Date: Thu Jun 5 12:34:23 2014 +0200
rtmutex: Handle deadlock detection smarter
commit 3d5c9340d1949733eb37616abd15db36aef9a57c upstream.
Even in the case when deadlock detection is not requested by the
caller, we can detect deadlocks. Right now the code stops the lock
chain walk and keeps the waiter enqueued, even on itself. Silly not to
yell when such a scenario is detected and to keep the waiter enqueued.
Return -EDEADLK unconditionally and handle it at the call sites.
The futex calls return -EDEADLK. The non futex ones dequeue the
waiter, throw a warning and put the task into a schedule loop.
Tagged for stable as it makes the code more robust.
Signed-off-by: Thomas Gleixner
Cc: Steven Rostedt
Cc: Peter Zijlstra
Cc: Brad Mouring
Link: http://lkml.kernel.org/r/20140605152801.836501969@linutronix.de
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit ecb22e03989334008e6f51ea5e3ac5d4b6101f8f
Author: Thomas Gleixner
Date: Thu Jun 5 11:16:12 2014 +0200
rtmutex: Detect changes in the pi lock chain
commit 82084984383babe728e6e3c9a8e5c46278091315 upstream.
When we walk the lock chain, we drop all locks after each step. So the
lock chain can change under us before we reacquire the locks. That's
harmless in principle as we just follow the wrong lock path. But it
can lead to a false positive in the dead lock detection logic:
T0 holds L0
T0 blocks on L1 held by T1
T1 blocks on L2 held by T2
T2 blocks on L3 held by T3
T4 blocks on L4 held by T4
Now we walk the chain
lock T1 -> lock L2 -> adjust L2 -> unlock T1 ->
lock T2 -> adjust T2 -> drop locks
T2 times out and blocks on L0
Now we continue:
lock T2 -> lock L0 -> deadlock detected, but it's not a deadlock at all.
Brad tried to work around that in the deadlock detection logic itself,
but the more I looked at it the less I liked it, because it's crystal
ball magic after the fact.
We actually can detect a chain change very simple:
lock T1 -> lock L2 -> adjust L2 -> unlock T1 -> lock T2 -> adjust T2 ->
next\_lock = T2->pi\_blocked\_on->lock;
drop locks
T2 times out and blocks on L0
Now we continue:
lock T2 ->
if (next\_lock != T2->pi\_blocked\_on->lock)
return;
So if we detect that T2 is now blocked on a different lock we stop the
chain walk. That's also correct in the following scenario:
lock T1 -> lock L2 -> adjust L2 -> unlock T1 -> lock T2 -> adjust T2 ->
next\_lock = T2->pi\_blocked\_on->lock;
drop locks
T3 times out and drops L3
T2 acquires L3 and blocks on L4 now
Now we continue:
lock T2 ->
if (next\_lock != T2->pi\_blocked\_on->lock)
return;
We don't have to follow up the chain at that point, because T2
propagated our priority up to T4 already.
[ Folded a cleanup patch from peterz ]
Signed-off-by: Thomas Gleixner
Reported-by: Brad Mouring
Cc: Steven Rostedt
Cc: Peter Zijlstra
Link: http://lkml.kernel.org/r/20140605152801.930031935@linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit da6d600b71f9f8d8bd042015557857e5e68ffc97
Author: Rafael J. Wysocki
Date: Fri Jun 13 01:17:03 2014 +0200
ACPI / ia64 / sba\_iommu: Restore the working initialization ordering
commit 12e27b115472ad0f3b142ddf59d3998305984408 upstream.
Commit 66345d5f79fc (ACPI / ia64 / sba\_iommu: Use ACPI scan handler
for device discovery) changed the ordering of SBA (System Bus Adapter)
IOMMU initialization with respect to the PCI host bridge initialization
which broke things inadvertently, because the SBA IOMMU initialization
code has to run after the PCI host bridge has been initialized.
Fix that by reworking the SBA IOMMU ACPI scan handler so that it
claims the discovered matching ACPI device objects without attempting
to initialize anything and move the entire SBA IOMMU initialization
to sba\_init() that runs after the PCI bus has been enumerated.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=76691
Fixes: 66345d5f79fc (ACPI / ia64 / sba\_iommu: Use ACPI scan handler for device discovery)
Reported-and-tested-by: Émeric Maschino
Cc: Tony Luck
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 46da9df5bee28fcb8ee645226b6420438e806500
Author: Rafael J. Wysocki
Date: Tue Jun 10 22:46:35 2014 +0200
ACPI / hotplug / PCI: Add hotplug contexts to PCI host bridges
commit 882d18a702c66404fcb62b84748f719f9b47441c upstream.
After relatively recent changes in the ACPI-based PCI hotplug
(ACPIPHP) code, the acpiphp\_check\_host\_bridge() executed for PCI
host bridges via acpi\_pci\_root\_scan\_dependent() doesn't do anything
useful, because those bridges do not have hotplug contexts. That
happens by mistake, so fix it by making acpiphp\_enumerate\_slots()
add hotplug contexts to PCI host bridges too and modify
acpiphp\_remove\_slots() to drop those contexts for host bridges
as appropriate.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=76901
Fixes: 2d8b1d566a5f (ACPI / hotplug / PCI: Get rid of check\_sub\_bridges())
Reported-and-tested-by: Gavin Guo
Acked-by: Bjorn Helgaas
Reviewed-by: Mika Westerberg
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 582639a51a66dfa233b66cf08619f78fdc2bbf24
Author: Lv Zheng
Date: Mon May 12 15:50:16 2014 +0800
ACPI: Fix conflict between customized DSDT and DSDT local copy
commit 73577d1df8e1f31f6b1a5eebcdbc334eb0330e47 upstream.
This patch fixes the following issue:
If DSDT is customized, no local DSDT copy is needed.
References: https://bugzilla.kernel.org/show\_bug.cgi?id=69711
Signed-off-by: Enrico Etxe Arte
Signed-off-by: Lv Zheng
[rjw: Subject]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 624bc5368795c20f2de37f5d1a0e6cf8a52f1fe8
Author: David Binderman
Date: Fri Apr 4 12:36:55 2014 +0800
ACPICA: utstring: Check array index bound before use.
commit 5d42b0fa25df7ef2f575107597c1aaebe2407d10 upstream.
ACPICA BZ 1077. David Binderman.
References: https://bugs.acpica.org/show\_bug.cgi?id=1077
Signed-off-by: David Binderman
Signed-off-by: Bob Moore
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit e330441067f61822851ea4f58963525a498a9bde
Author: Bjørn Mork
Date: Thu May 22 12:47:47 2014 +0200
ACPI: add dynamic\_debug support
commit 45fef5b88d1f2f47ecdefae6354372d440ca5c84 upstream.
Commit 1a699476e258 ("ACPI / hotplug / PCI: Hotplug notifications
from acpi\_bus\_notify()") added debug messages for a few common
events. These debug messages are unconditionally enabled if
CONFIG\_DYNAMIC\_DEBUG is defined, contrary to the documented
meaning, making the ACPI system spew lots of unwanted noise on
any kernel with dynamic debugging.
The bug was introduced by commit fbfddae69657 ("ACPI: Add
acpi\_handle\_() interfaces"), which added the
CONFIG\_DYNAMIC\_DEBUG dependency without respecting its meaning.
Fix by adding real support for dynamic\_debug.
Fixes: fbfddae69657 ("ACPI: Add acpi\_handle\_() interfaces")
Signed-off-by: Bjørn Mork
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 079716fe1bb5dd904ecb75b23e8846b45bb116e2
Author: Sylwester Nawrocki
Date: Tue Apr 15 14:34:29 2014 -0300
media: exynos4-is: Fix compilation for !CONFIG\_COMMON\_CLK
commit f486e7c3cb9849b6a661931fa8c51a43d477046b upstream.
CONFIG\_COMMON\_CLK is not enabled on S5PV210 platform, so include
some clk API data structures conditionally to avoid compilation
errors. These #ifdefs will be removed for next kernel release,
when the S5PV210 platform moves to DT and the common clk API.
Signed-off-by: Sylwester Nawrocki
Acked-by: Kyungmin Park
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 30520611a4f41bf1276959ad77f1faabed5c09de
Author: Sylwester Nawrocki
Date: Thu May 8 14:35:15 2014 -0300
media: exynos4-is: Free FIMC-IS CPU memory only when allocated
commit 404a90abc60f60df2757cb272660e003d326881f upstream.
Ensure dma\_free\_coherent() is not called with incorrect arguments
and only when the memory was actually allocated. This will prevent
possible crashes on error paths of the top level media device driver,
when fimc-is device gets unregistered and its driver detached.
Signed-off-by: Sylwester Nawrocki
Acked-by: Kyungmin Park
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 5a77f6628b73c6fb3d7d092a66f92f5a815dd57a
Author: Ezequiel Garcia
Date: Thu Apr 17 09:28:20 2014 -0300
media: stk1160: Avoid stack-allocated buffer for control URBs
commit 85ac1a1772bb41da895bad83a81f6a62c8f293f6 upstream.
Currently stk1160\_read\_reg() uses a stack-allocated char to get the
read control value. This is wrong because usb\_control\_msg() requires
a kmalloc-ed buffer.
This commit fixes such issue by kmalloc'ating a 1-byte buffer to receive
the read value.
While here, let's remove the urb\_buf array which was meant for a similar
purpose, but never really used.
Cc: Alan Stern
Reported-by: Sander Eikelenboom
Signed-off-by: Ezequiel Garcia
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit e84b7ee8356e2df799c6329e0a4994d4a04bcece
Author: Takashi Iwai
Date: Mon May 5 11:20:05 2014 -0300
media: ivtv: Fix Oops when no firmware is loaded
commit deb29e90221a6d4417aa67be971613c353180331 upstream.
When ivtv PCM device is accessed at the state where no firmware is
loaded, it oopses like:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000050
IP: [] try\_mailbox.isra.0+0x11/0x50 [ivtv]
Call Trace:
[] ivtv\_api\_call+0x160/0x6b0 [ivtv]
[] ivtv\_api+0x16/0x40 [ivtv]
[] ivtv\_vapi+0xac/0xc0 [ivtv]
[] ivtv\_start\_v4l2\_encode\_stream+0x19d/0x630 [ivtv]
[] snd\_ivtv\_pcm\_capture\_open+0x173/0x1c0 [ivtv\_alsa]
[] snd\_pcm\_open\_substream+0x51/0x100 [snd\_pcm]
[] snd\_pcm\_open+0xb3/0x260 [snd\_pcm]
[] snd\_pcm\_capture\_open+0x37/0x50 [snd\_pcm]
[] snd\_open+0xa7/0x1e0 [snd]
[] chrdev\_open+0x88/0x1d0
[] do\_dentry\_open+0x1de/0x270
[] do\_last+0x1c3/0xec0
[] path\_openat+0xb6/0x670
[] do\_filp\_open+0x35/0x80
[] do\_sys\_open+0x129/0x210
[] system\_call\_fastpath+0x1a/0x1f
This patch adds the check of firmware at PCM open callback like other
open callbacks of this driver.
Bugzilla: https://apibugzilla.novell.com/show\_bug.cgi?id=875440
Signed-off-by: Takashi Iwai
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 79d3d9bcacb8217faae82d501f4b64a163ebd9bb
Author: Johan Hovold
Date: Mon May 26 19:23:33 2014 +0200
USB: serial: fix potential runtime pm imbalance at device remove
commit c14829fad88dbeda57253590695b85ba51270621 upstream.
Only call usb\_autopm\_put\_interface() if the corresponding
usb\_autopm\_get\_interface() was successful.
This prevents a potential runtime PM counter imbalance should
usb\_autopm\_get\_interface() fail. Note that the USB PM usage counter is
reset when the interface is unbound, but that the runtime PM counter may
be left unbalanced.
Also add comment on why we don't need to worry about racing
resume/suspend on autopm\_get failures.
Fixes: d5fd650cfc7f ("usb: serial: prevent suspend/resume from racing
against probe/remove")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit ba0359524c5ac4d9ba609cd4434f428851cba8cf
Author: Aleksander Morgado
Date: Thu May 29 13:33:27 2014 +0200
usb: qcserial: add additional Sierra Wireless QMI devices
commit 0ce5fb58564fd85aa8fd2d24209900e2e845317b upstream.
A set of new VID/PIDs retrieved from the out-of-tree GobiNet/GobiSerial
Sierra Wireless drivers.
Signed-off-by: Aleksander Morgado
Link: http://marc.info/?l=linux-usb&m=140136310027293&w=2
Cc:  # backport in link above
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit fe9d63e56689bfe3d25fea006a84b7013c308e94
Author: Aleksander Morgado
Date: Wed May 28 21:13:51 2014 +0200
usb: qcserial: add Netgear AirCard 341U
commit ff1fcd50bc2459744e6f948310bc18eb7d6e8c72 upstream.
Signed-off-by: Aleksander Morgado
Signed-off-by: Greg Kroah-Hartman
commit f7c4c1060e81b80c52ebb9f6bae5d2b55aa34c96
Author: Johan Hovold
Date: Mon May 26 19:22:54 2014 +0200
USB: sierra: fix remote wakeup
commit 80cc0fcbdaeaf10d04ba27779a2d7ceb73d2717a upstream.
Make sure that needs\_remote\_wake up is always set when there are open
ports.
Currently close() would unconditionally set needs\_remote\_wakeup to 0
even though there might still be open ports. This could lead to blocked
input and possibly dropped data on devices that do not support remote
wakeup (and which must therefore not be runtime suspended while open).
Add an open\_ports counter (protected by the susp\_lock) and only clear
needs\_remote\_wakeup when the last port is closed.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b5079ac77983da7ad613a13fdf70c2d2a8ac3768
Author: Johan Hovold
Date: Mon May 26 19:22:53 2014 +0200
USB: sierra: fix urb and memory leak on disconnect
commit 014333f77c0b71123d6ef7d31a9724e0699c9548 upstream.
The delayed-write queue was never emptied on disconnect, something which
would lead to leaked urbs and transfer buffers if the device is
disconnected before being runtime resumed due to a write.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 79068e639c42d00be314448f88aee9241ca11310
Author: Johan Hovold
Date: Mon May 26 19:22:52 2014 +0200
USB: sierra: fix urb and memory leak in resume error path
commit 7fdd26a01eb7b6cb6855ff8f69ef4a720720dfcb upstream.
Neither the transfer buffer or the urb itself were released in the
resume error path for delayed writes. Also on errors, the remainder of
the queue was not even processed, which leads to further urb and buffer
leaks.
The same error path also failed to balance the outstanding-urb counter,
something which results in degraded throughput or completely blocked
writes.
Fix this by releasing urb and buffer and balancing counters on errors,
and by always processing the whole queue even when submission of one urb
fails.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 9a9b33f0d846ab4494279afcf6a916b50a1f760f
Author: Johan Hovold
Date: Mon May 26 19:22:51 2014 +0200
USB: sierra: fix use after free at suspend/resume
commit 8452727de70f6ad850cd6d0aaa18b5d9050aa63b upstream.
Fix use after free or NULL-pointer dereference during suspend and
resume.
The port data may never have been allocated (port probe failed)
or may already have been released by port\_remove (e.g. driver is
unloaded) when suspend and resume are called.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit ed8f24f670646134021ff6e7393cae2ef44e968b
Author: Johan Hovold
Date: Mon May 26 19:22:50 2014 +0200
USB: sierra: fix AA deadlock in open error path
commit 353fe198602e8b4d1c7bdcceb8e60955087201b1 upstream.
Fix AA deadlock in open error path that would call close() and try to
grab the already held disc\_mutex.
Fixes: b9a44bc19f48 ("sierra: driver urb handling improvements")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 8aa440e39e90463ef9792b1903eeafc27f6cdf18
Author: Johan Hovold
Date: Mon May 26 19:23:18 2014 +0200
USB: usb\_wwan: fix potential blocked I/O after resume
commit fb7ad4f93d9f0f7d49beda32f5e7becb94b29a4d upstream.
Keep trying to submit urbs rather than bail out on first read-urb
submission error, which would also prevent I/O for any further ports
from being resumed.
Instead keep an error count, for all types of failed submissions, and
let USB core know that something went wrong.
Also make sure to always clear the suspended flag. Currently a failed
read-urb submission would prevent cached writes as well as any
subsequent writes from being submitted until next suspend-resume cycle,
something which may not even necessarily happen.
Note that USB core currently only logs an error if an interface resume
failed.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b28425635436294f58b18e78e70f04c7b094c8c4
Author: Johan Hovold
Date: Mon May 26 19:23:17 2014 +0200
USB: usb\_wwan: fix potential NULL-deref at resume
commit 9096f1fbba916c2e052651e9de82fcfb98d4bea7 upstream.
The interrupt urb was submitted unconditionally at resume, something
which could lead to a NULL-pointer dereference in the urb completion
handler as resume may be called after the port and port data is gone.
Fix this by making sure the interrupt urb is only submitted and active
when the port is open.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 21286f6f66d8ede5b3424de9a33a6dca537161a5
Author: Johan Hovold
Date: Mon May 26 19:23:16 2014 +0200
USB: usb\_wwan: fix urb leak at shutdown
commit 79eed03e77d481b55d85d1cfe5a1636a0d3897fd upstream.
The delayed-write queue was never emptied at shutdown (close), something
which could lead to leaked urbs if the port is closed before being
runtime resumed due to a write.
When this happens the output buffer would not drain on close
(closing\_wait timeout), and after consecutive opens, writes could be
corrupted with previously buffered data, transfered with reduced
throughput or completely blocked.
Note that unbusy\_queued\_urb() was simply moved out of CONFIG\_PM.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 47909efe223b738d7221aeb9ab6984ddfde0433f
Author: Johan Hovold
Date: Mon May 26 19:23:15 2014 +0200
USB: usb\_wwan: fix write and suspend race
commit 170fad9e22df0063eba0701adb966786d7a4ec5a upstream.
Fix race between write() and suspend() which could lead to writes being
dropped (or I/O while suspended) if the device is runtime suspended
while a write request is being processed.
Specifically, suspend() releases the susp\_lock after determining the
device is idle but before setting the suspended flag, thus leaving a
window where a concurrent write() can submit an urb.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 442d460ee58bbdc8319c77c7b41712a9d5cd7a4e
Author: xiao jin
Date: Mon May 26 19:23:14 2014 +0200
USB: usb\_wwan: fix race between write and resume
commit d9e93c08d8d985e5ef89436ebc9f4aad7e31559f upstream.
We find a race between write and resume. usb\_wwan\_resume run play\_delayed()
and spin\_unlock, but intfdata->suspended still is not set to zero.
At this time usb\_wwan\_write is called and anchor the urb to delay
list. Then resume keep running but the delayed urb have no chance
to be commit until next resume. If the time of next resume is far
away, tty will be blocked in tty\_wait\_until\_sent during time. The
race also can lead to writes being reordered.
This patch put play\_Delayed and intfdata->suspended together in the
spinlock, it's to avoid the write race during resume.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 21b67b769ee22993a9f77a5e44fd96074fbd3b18
Author: xiao jin
Date: Mon May 26 19:23:13 2014 +0200
USB: usb\_wwan: fix urb leak in write error path
commit db0904737947d509844e171c9863ecc5b4534005 upstream.
When enable usb serial for modem data, sometimes the tty is blocked
in tty\_wait\_until\_sent because portdata->out\_busy always is set and
have no chance to be cleared.
We find a bug in write error path. usb\_wwan\_write set portdata->out\_busy
firstly, then try autopm async with error. No out urb submit and no
usb\_wwan\_outdat\_callback to this write, portdata->out\_busy can't be
cleared.
This patch clear portdata->out\_busy if usb\_wwan\_write try autopm async
with error.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit da818b18f1461ca620c2f43bc27003ce057b48c6
Author: Mikulas Patocka
Date: Thu May 15 06:58:24 2014 -0400
matroxfb: perform a dummy read of M\_STATUS
commit 972754cfaee94d6e25acf94a497bc0a864d91b7e upstream.
I had occasional screen corruption with the matrox framebuffer driver and
I found out that the reason for the corruption is that the hardware
blitter accesses the videoram while it is being written to.
The matrox driver has a macro WaitTillIdle() that should wait until the
blitter is idle, but it sometimes doesn't work. I added a dummy read
mga\_inl(M\_STATUS) to WaitTillIdle() to fix the problem. The dummy read
will flush the write buffer in the PCI chipset, and the next read of
M\_STATUS will return the hardware status.
Since applying this patch, I had no screen corruption at all.
Signed-off-by: Mikulas Patocka
Signed-off-by: Tomi Valkeinen
Signed-off-by: Greg Kroah-Hartman
commit feb62c88c9dc4f0ed3e04b1d24fd1812d78b9ddc
Author: Maurizio Lombardi
Date: Tue May 27 12:48:56 2014 -0400
ext4: fix wrong assert in ext4\_mb\_normalize\_request()
commit b5b60778558cafad17bbcbf63e0310bd3c68eb17 upstream.
The variable "size" is expressed as number of blocks and not as
number of clusters, this could trigger a kernel panic when using
ext4 with the size of a cluster different from the size of a block.
Signed-off-by: Maurizio Lombardi
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 59bc864486f20859e51b2878686fb86cfd57384c
Author: Namjae Jeon
Date: Tue May 27 12:48:55 2014 -0400
ext4: fix ZERO\_RANGE test failure in data journalling
commit e1ee60fd89670da61b0a4bda59f8ffb2b8abea63 upstream.
xfstests generic/091 is failing when mounting ext4 with data=journal.
I think that this regression is same problem that occurred prior to collapse
range issue. So ZERO RANGE also need to call ext4\_force\_commit as
collapse range.
Signed-off-by: Namjae Jeon
Signed-off-by: Ashish Sangwan
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit f70b5876eb95d2d96c0061f6f32524669f9818ec
Author: Jan Kara
Date: Tue May 27 12:48:55 2014 -0400
ext4: fix zeroing of page during writeback
commit eeece469dedadf3918bad50ad80f4616a0064e90 upstream.
Tail of a page straddling inode size must be zeroed when being written
out due to POSIX requirement that modifications of mmaped page beyond
inode size must not be written to the file. ext4\_bio\_write\_page() did
this only for blocks fully beyond inode size but didn't properly zero
blocks partially beyond inode size. Fix this.
The problem has been uncovered by mmap\_11-4 test in openposix test suite
(part of LTP).
Reported-by: Xiaoguang Wang
Fixes: 5a0dc7365c240
Fixes: bd2d0210cf22f
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit ba6eb3c3ac56bf4097820f7f54ea562b5c5e018d
Author: Namjae Jeon
Date: Mon May 12 08:12:25 2014 -0400
ext4: fix data integrity sync in ordered mode
commit 1c8349a17137b93f0a83f276c764a6df1b9a116e upstream.
When we perform a data integrity sync we tag all the dirty pages with
PAGECACHE\_TAG\_TOWRITE at start of ext4\_da\_writepages. Later we check
for this tag in write\_cache\_pages\_da and creates a struct
mpage\_da\_data containing contiguously indexed pages tagged with this
tag and sync these pages with a call to mpage\_da\_map\_and\_submit. This
process is done in while loop until all the PAGECACHE\_TAG\_TOWRITE
pages are synced. We also do journal start and stop in each iteration.
journal\_stop could initiate journal commit which would call
ext4\_writepage which in turn will call ext4\_bio\_write\_page even for
delayed OR unwritten buffers. When ext4\_bio\_write\_page is called for
such buffers, even though it does not sync them but it clears the
PAGECACHE\_TAG\_TOWRITE of the corresponding page and hence these pages
are also not synced by the currently running data integrity sync. We
will end up with dirty pages although sync is completed.
This could cause a potential data loss when the sync call is followed
by a truncate\_pagecache call, which is exactly the case in
collapse\_range. (It will cause generic/127 failure in xfstests)
To avoid this issue, we can use set\_page\_writeback\_keepwrite instead of
set\_page\_writeback, which doesn't clear TOWRITE tag.
Signed-off-by: Namjae Jeon
Signed-off-by: Ashish Sangwan
Signed-off-by: "Theodore Ts'o"
Reviewed-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 7a3e2bd72aff79dc7d7b8a7ab7dfa3fbd7880fce
Author: Krzysztof Kozlowski
Date: Tue May 6 08:37:37 2014 +0200
regulator: s2mpa01: Fix accidental enable of buck4 ramp delay
commit 51e2fc0a251ba64c68207e4c6f6ac33c891b2465 upstream.
S2MPA01 supports enabling/disabling ramp delay only for buck[1234].
Other bucks have ramp delay enabled always.
However the bit shift for enabling buck4 ramp delay in register is equal
to 0. When ramp delay was set for the bucks unsupporting enable/disable
(buck[56789] and buck10), the ramp delay for buck4 was also enabled.
Fixes: f7b1a8dc1c1c ("regulator: s2mpa01: Don't check enable\_shift before setting enable ramp rate")
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Axel Lin
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 080b4ad880bb5138a5853d71a9c29f28a8980d11
Author: Krzysztof Kozlowski
Date: Tue May 6 08:37:36 2014 +0200
regulator: s2mps11: Fix accidental enable of buck6 ramp delay
commit b203e0dfe1a2b0ae5e2681e9285056e4ae8560af upstream.
S2MPS11 supports enabling/disabling ramp delay only for buck[2346].
Other bucks have ramp delay enabled always.
However the bit shift for enabling buck6 ramp delay in register is equal
to 0. When ramp delay was set for the bucks unsupporting enable/disable
(buck[15789] and buck10), the ramp delay for buck6 was also enabled.
Fixes: b96244fad953 ("regulator: s2mps11: Don't check enable\_shift before setting enable ramp rate")
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Axel Lin
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit dc45966c6bda1a78e17aa335b90ae987f6798017
Author: Krzysztof Kozlowski
Date: Mon May 26 10:26:46 2014 +0200
regulator: s2mpa01: Use correct register for buck1 ramp delay
commit 112da5cb43427b843e49b8710f53ecdbb3471d9f upstream.
Fix the register for ramp delay of buck1 regulator. Buck1 and buck6
share the field (offset 4) in ramp delay register S2MPA01\_REG\_RAMP2.
The driver used the same register and field for ramp delay of buck3 and
buck1. This lead to updating of ramp delay of buck3 when setting buck1
and actually the ramp delay of buck1 was never set.
Fixes: f18792714608 ("regulator: Add support for S2MPA01 regulator")
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Sachin Kamat
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 6991b8dc948b1f40dd5d878ba6282ed289cfd1cc
Author: Christian Borntraeger
Date: Mon May 26 21:55:08 2014 +0200
s390/lowcore: reserve 96 bytes for IRB in lowcore
commit 993072ee67aa179c48c85eb19869804e68887d86 upstream.
The IRB might be 96 bytes if the extended-I/O-measurement facility is
used. This feature is currently not used by Linux, but struct irb
already has the emw defined. So let's make the irb in lowcore match the
size of the internal data structure to be future proof.
We also have to add a pad, to correctly align the paste.
The bigger irb field also circumvents a bug in some QEMU versions that
always write the emw field on test subchannel and therefore destroy the
paste definitions of this CPU. Running under these QEMU version broke
some timing functions in the VDSO and all users of these functions,
e.g. some JREs.
Signed-off-by: Christian Borntraeger
Signed-off-by: Martin Schwidefsky
Cc: Heiko Carstens
Cc: Sebastian Ott
Cc: Cornelia Huck
Signed-off-by: Greg Kroah-Hartman
commit 457bcc3313662f1671d8135b87981569f68bc076
Author: Martin Schwidefsky
Date: Tue May 20 17:21:35 2014 +0200
s390/time: cast tv\_nsec to u64 prior to shift in update\_vsyscall
commit b6f4296279ab3ada554d993d12844272fd86b36a upstream.
Analog to git commit 28b92e09e25bdc0ae864b22eacf195a74f861389
first cast tk->wall\_to\_monotonic.tv\_nsec to u64 before doing
the shift with tk->shift to avoid loosing relevant bits on a
32-bit kernel.
Signed-off-by: Martin Schwidefsky
Signed-off-by: Greg Kroah-Hartman
commit ef88d262bc1e086af31f252350aee708bcdf2726
Author: Lai Jiangshan
Date: Fri Jun 6 14:37:10 2014 -0700
idr: fix overflow bug during maximum ID calculation at maximum height
commit 3afb69cb5572b3c8c898c00880803cf1a49852c4 upstream.
idr\_replace() open-codes the logic to calculate the maximum valid ID
given the height of the idr tree; unfortunately, the open-coded logic
doesn't account for the fact that the top layer may have unused slots
and over-shifts the limit to zero when the tree is at its maximum
height.
The following test code shows it fails to replace the value for
id=((1<<27)+42):
static void test5(void)
{
int id;
DEFINE\_IDR(test\_idr);
#define TEST5\_START ((1<<27)+42) /\* use the highest layer \*/
printk(KERN\_INFO "Start test5\n");
id = idr\_alloc(&test\_idr, (void \*)1, TEST5\_START, 0, GFP\_KERNEL);
BUG\_ON(id != TEST5\_START);
TEST\_BUG\_ON(idr\_replace(&test\_idr, (void \*)2, TEST5\_START) != (void \*)1);
idr\_destroy(&test\_idr);
printk(KERN\_INFO "End of test5\n");
}
Fix the bug by using idr\_max() which correctly takes into account the
maximum allowed shift.
sub\_alloc() shares the same problem and may incorrectly fail with
-EAGAIN; however, this bug doesn't affect correct operation because
idr\_get\_empty\_slot(), which already uses idr\_max(), retries with the
increased @id in such cases.
[tj@kernel.org: Updated patch description.]
Signed-off-by: Lai Jiangshan
Acked-by: Tejun Heo
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ab275c83f5badf24df5fe3e377922d6fd6633ec9
Author: Victor Kamensky
Date: Tue Jun 3 19:21:30 2014 +0100
arm64: ptrace: fix empty registers set in prstatus of aarch32 process core
commit 2227901a0230d8fde81ba9c602d649839390f56b upstream.
Currently core file of aarch32 process prstatus note has empty
registers set. As result aarch32 core files create by V8 kernel are
not very useful.
It happens because compat\_gpr\_get and compat\_gpr\_set functions can
copy registers values to/from either kbuf or ubuf. ELF core file
collection function fill\_thread\_core\_info calls compat\_gpr\_get
with kbuf set and ubuf set to 0. But current compat\_gpr\_get and
compat\_gpr\_set function handle copy to/from only ubuf case.
Fix is to handle kbuf and ubuf as two separate cases in similar
way as other functions like user\_regset\_copyout, user\_regset\_copyin do.
Signed-off-by: Victor Kamensky
Acked-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 993e3e16565178b94d38c20fd1c81eb020b2fe8f
Author: Will Deacon
Date: Mon Jun 2 11:47:23 2014 +0100
arm64: ptrace: change fs when passing kernel pointer to regset code
commit c168870704bcde6bb63d05f7882b620dd3985a46 upstream.
Our compat PTRACE\_POKEUSR implementation simply passes the user data to
regset\_copy\_from\_user after some simple range checking. Unfortunately,
the data in question has already been copied to the kernel stack by this
point, so the subsequent access\_ok check fails and the ptrace request
returns -EFAULT. This causes problems tracing fork() with older versions
of strace.
This patch briefly changes the fs to KERNEL\_DS, so that the access\_ok
check passes even with a kernel address.
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 3d672e43c3dc0549fee9af8b6b6142dfba425d62
Author: Matthew Dempsky
Date: Fri Jun 6 14:36:42 2014 -0700
ptrace: fix fork event messages across pid namespaces
commit 4e52365f279564cef0ddd41db5237f0471381093 upstream.
When tracing a process in another pid namespace, it's important for fork
event messages to contain the child's pid as seen from the tracer's pid
namespace, not the parent's. Otherwise, the tracer won't be able to
correlate the fork event with later SIGTRAP signals it receives from the
child.
We still risk a race condition if a ptracer from a different pid
namespace attaches after we compute the pid\_t value. However, sending a
bogus fork event message in this unlikely scenario is still a vast
improvement over the status quo where we always send bogus fork event
messages to debuggers in a different pid namespace than the forking
process.
Signed-off-by: Matthew Dempsky
Acked-by: Oleg Nesterov
Cc: Kees Cook
Cc: Julien Tinnes
Cc: Roland McGrath
Cc: Jan Kratochvil
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0077982f8d0fa1f0f32ef5909e28bca0784c34e7
Author: Johannes Weiner
Date: Fri Jun 6 14:35:35 2014 -0700
mm: vmscan: clear kswapd's special reclaim powers before exiting
commit 71abdc15adf8c702a1dd535f8e30df50758848d2 upstream.
When kswapd exits, it can end up taking locks that were previously held
by allocating tasks while they waited for reclaim. Lockdep currently
warns about this:
On Wed, May 28, 2014 at 06:06:34PM +0800, Gu Zheng wrote:
> inconsistent {RECLAIM\_FS-ON-W} -> {IN-RECLAIM\_FS-R} usage.
> kswapd2/1151 [HC0[0]:SC0[0]:HE1:SE1] takes:
> (&sig->group\_rwsem){+++++?}, at: exit\_signals+0x24/0x130
> {RECLAIM\_FS-ON-W} state was registered at:
> mark\_held\_locks+0xb9/0x140
> lockdep\_trace\_alloc+0x7a/0xe0
> kmem\_cache\_alloc\_trace+0x37/0x240
> flex\_array\_alloc+0x99/0x1a0
> cgroup\_attach\_task+0x63/0x430
> attach\_task\_by\_pid+0x210/0x280
> cgroup\_procs\_write+0x16/0x20
> cgroup\_file\_write+0x120/0x2c0
> vfs\_write+0xc0/0x1f0
> SyS\_write+0x4c/0xa0
> tracesys+0xdd/0xe2
> irq event stamp: 49
> hardirqs last enabled at (49): \_raw\_spin\_unlock\_irqrestore+0x36/0x70
> hardirqs last disabled at (48): \_raw\_spin\_lock\_irqsave+0x2b/0xa0
> softirqs last enabled at (0): copy\_process.part.24+0x627/0x15f0
> softirqs last disabled at (0): (null)
>
> other info that might help us debug this:
> Possible unsafe locking scenario:
>
> CPU0
> ----
> lock(&sig->group\_rwsem);
>
> lock(&sig->group\_rwsem);
>
> \*\*\* DEADLOCK \*\*\*
>
> no locks held by kswapd2/1151.
>
> stack backtrace:
> CPU: 30 PID: 1151 Comm: kswapd2 Not tainted 3.10.39+ #4
> Call Trace:
> dump\_stack+0x19/0x1b
> print\_usage\_bug+0x1f7/0x208
> mark\_lock+0x21d/0x2a0
> \_\_lock\_acquire+0x52a/0xb60
> lock\_acquire+0xa2/0x140
> down\_read+0x51/0xa0
> exit\_signals+0x24/0x130
> do\_exit+0xb5/0xa50
> kthread+0xdb/0x100
> ret\_from\_fork+0x7c/0xb0
This is because the kswapd thread is still marked as a reclaimer at the
time of exit. But because it is exiting, nobody is actually waiting on
it to make reclaim progress anymore, and it's nothing but a regular
thread at this point. Be tidy and strip it of all its powers
(PF\_MEMALLOC, PF\_SWAPWRITE, PF\_KSWAPD, and the lockdep reclaim state)
before returning from the thread function.
Signed-off-by: Johannes Weiner
Reported-by: Gu Zheng
Cc: Yasuaki Ishimatsu
Cc: Tang Chen
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ed1c734130f3a7fcfd98fcc6f4e330f392ef4710
Author: Kees Cook
Date: Thu Apr 17 13:22:09 2014 -0700
HID: core: fix validation of report id 0
commit 1b15d2e5b8077670b1e6a33250a0d9577efff4a5 upstream.
Some drivers use the first HID report in the list instead of using an
index. In these cases, validation uses ID 0, which was supposed to mean
"first known report". This fixes the problem, which was causing at least
the lgff family of devices to stop working since hid\_validate\_values
was being called with ID 0, but the devices used single numbered IDs
for their reports:
0x05, 0x01, /\* Usage Page (Desktop), \*/
0x09, 0x05, /\* Usage (Gamepad), \*/
0xA1, 0x01, /\* Collection (Application), \*/
0xA1, 0x02, /\* Collection (Logical), \*/
0x85, 0x01, /\* Report ID (1), \*/
...
Reported-by: Simon Wood
Signed-off-by: Kees Cook
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 693b69e663ce0a9f0b8af7e16498092d62f1031a
Author: Hugh Dickins
Date: Wed Jun 4 16:05:33 2014 -0700
mm: fix sleeping function warning from \_\_put\_anon\_vma
commit 7f39dda9d86fb4f4f17af0de170decf125726f8c upstream.
Trinity reports BUG:
sleeping function called from invalid context at kernel/locking/rwsem.c:47
in\_atomic(): 0, irqs\_disabled(): 0, pid: 5787, name: trinity-c27
\_\_might\_sleep < down\_write < \_\_put\_anon\_vma < page\_get\_anon\_vma <
migrate\_pages < compact\_zone < compact\_zone\_order < try\_to\_compact\_pages ..
Right, since conversion to mutex then rwsem, we should not put\_anon\_vma()
from inside an rcu\_read\_lock()ed section: fix the two places that did so.
And add might\_sleep() to anon\_vma\_free(), as suggested by Peter Zijlstra.
Fixes: 88c22088bf23 ("mm: optimize page\_lock\_anon\_vma() fast-path")
Reported-by: Dave Jones
Signed-off-by: Hugh Dickins
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit e9198a0b9b519fc5e61cef1f0c5a7e1b0798658e
Author: Weijie Yang
Date: Wed Jun 4 16:11:06 2014 -0700
zram: correct offset usage in zram\_bio\_discard
commit 38515c73398a4c58059ecf1087e844561b58ee0f upstream.
We want to skip the physical block(PAGE\_SIZE) which is partially covered
by the discard bio, so we check the remaining size and subtract it if
there is a need to goto the next physical block.
The current offset usage in zram\_bio\_discard is incorrect, it will cause
its upper filesystem breakdown. Consider the following scenario:
On some architecture or config, PAGE\_SIZE is 64K for example, filesystem
is set up on zram disk without PAGE\_SIZE aligned, a discard bio leads to a
offset = 4K and size=72K, normally, it should not really discard any
physical block as it partially cover two physical blocks. However, with
the current offset usage, it will discard the second physical block and
free its memory, which will cause filesystem breakdown.
This patch corrects the offset usage in zram\_bio\_discard.
Signed-off-by: Weijie Yang
Cc: Minchan Kim
Cc: Nitin Gupta
Acked-by: Joonsoo Kim
Cc: Sergey Senozhatsky
Cc: Bob Liu
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 92797cf19e1ad0e1214838d6fdaf67fb3f46a624
Author: Naoya Horiguchi
Date: Wed Jun 4 16:11:02 2014 -0700
mm/memory-failure.c: support use of a dedicated thread to handle SIGBUS(BUS\_MCEERR\_AO)
commit 3ba08129e38437561df44c36b7ea9081185d5333 upstream.
Currently memory error handler handles action optional errors in the
deferred manner by default. And if a recovery aware application wants
to handle it immediately, it can do it by setting PF\_MCE\_EARLY flag.
However, such signal can be sent only to the main thread, so it's
problematic if the application wants to have a dedicated thread to
handler such signals.
So this patch adds dedicated thread support to memory error handler. We
have PF\_MCE\_EARLY flags for each thread separately, so with this patch
AO signal is sent to the thread with PF\_MCE\_EARLY flag set, not the main
thread. If you want to implement a dedicated thread, you call prctl()
to set PF\_MCE\_EARLY on the thread.
Memory error handler collects processes to be killed, so this patch lets
it check PF\_MCE\_EARLY flag on each thread in the collecting routines.
No behavioral change for all non-early kill cases.
Tony said:
: The old behavior was crazy - someone with a multithreaded process might
: well expect that if they call prctl(PF\_MCE\_EARLY) in just one thread, then
: that thread would see the SIGBUS with si\_code = BUS\_MCEERR\_A0 - even if
: that thread wasn't the main thread for the process.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Naoya Horiguchi
Reviewed-by: Tony Luck
Cc: Kamil Iskra
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit bb3008a2fd7c8c3ced706f46fbf7e724d40f9298
Author: Tony Luck
Date: Wed Jun 4 16:11:01 2014 -0700
mm/memory-failure.c: don't let collect\_procs() skip over processes for MF\_ACTION\_REQUIRED
commit 74614de17db6fb472370c426d4f934d8d616edf2 upstream.
When Linux sees an "action optional" machine check (where h/w has reported
an error that is not in the current execution path) we generally do not
want to signal a process, since most processes do not have a SIGBUS
handler - we'd just prematurely terminate the process for a problem that
they might never actually see.
task\_early\_kill() decides whether to consider a process - and it checks
whether this specific process has been marked for early signals with
"prctl", or if the system administrator has requested early signals for
all processes using /proc/sys/vm/memory\_failure\_early\_kill.
But for MF\_ACTION\_REQUIRED case we must not defer. The error is in the
execution path of the current thread so we must send the SIGBUS
immediatley.
Fix by passing a flag argument through collect\_procs\*() to
task\_early\_kill() so it knows whether we can defer or must take action.
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 44dc0863c436aa9c9c3c688cf7cbdcd20d768090
Author: Tony Luck
Date: Wed Jun 4 16:10:59 2014 -0700
mm/memory-failure.c-failure: send right signal code to correct thread
commit a70ffcac741d31a406c1d2b832ae43d658e7e1cf upstream.
When a thread in a multi-threaded application hits a machine check because
of an uncorrectable error in memory - we want to send the SIGBUS with
si.si\_code = BUS\_MCEERR\_AR to that thread. Currently we fail to do that
if the active thread is not the primary thread in the process.
collect\_procs() just finds primary threads and this test:
if ((flags & MF\_ACTION\_REQUIRED) && t == current) {
will see that the thread we found isn't the current thread and so send a
si.si\_code = BUS\_MCEERR\_AO to the primary (and nothing to the active
thread at this time).
We can fix this by checking whether "current" shares the same mm with the
process that collect\_procs() said owned the page. If so, we send the
SIGBUS to current (with code BUS\_MCEERR\_AR).
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Reported-by: Otto Bruggeman
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit cbc3234d2fd730d4c76749a39c23557f4f08248b
Author: Mel Gorman
Date: Wed Jun 4 16:10:16 2014 -0700
mm: page\_alloc: use word-based accesses for get/set pageblock bitmaps
commit e58469bafd0524e848c3733bc3918d854595e20f upstream.
The test\_bit operations in get/set pageblock flags are expensive. This
patch reads the bitmap on a word basis and use shifts and masks to isolate
the bits of interest. Similarly masks are used to set a local copy of the
bitmap and then use cmpxchg to update the bitmap if there have been no
other changes made in parallel.
In a test running dd onto tmpfs the overhead of the pageblock-related
functions went from 1.27% in profiles to 0.5%.
In addition to the performance benefits, this patch closes races that are
possible between:
a) get\_ and set\_pageblock\_migratetype(), where get\_pageblock\_migratetype()
reads part of the bits before and other part of the bits after
set\_pageblock\_migratetype() has updated them.
b) set\_pageblock\_migratetype() and set\_pageblock\_skip(), where the non-atomic
read-modify-update set bit operation in set\_pageblock\_skip() will cause
lost updates to some bits changed in the set\_pageblock\_migratetype().
Joonsoo Kim first reported the case a) via code inspection. Vlastimil
Babka's testing with a debug patch showed that either a) or b) occurs
roughly once per mmtests' stress-highalloc benchmark (although not
necessarily in the same pageblock). Furthermore during development of
unrelated compaction patches, it was observed that frequent calls to
{start,undo}\_isolate\_page\_range() the race occurs several thousands of
times and has resulted in NULL pointer dereferences in move\_freepages()
and free\_one\_page() in places where free\_list[migratetype] is
manipulated by e.g. list\_move(). Further debugging confirmed that
migratetype had invalid value of 6, causing out of bounds access to the
free\_list array.
That confirmed that the race exist, although it may be extremely rare,
and currently only fatal where page isolation is performed due to
memory hot remove. Races on pageblocks being updated by
set\_pageblock\_migratetype(), where both old and new migratetype are
lower MIGRATE\_RESERVE, currently cannot result in an invalid value
being observed, although theoretically they may still lead to
unexpected creation or destruction of MIGRATE\_RESERVE pageblocks.
Furthermore, things could get suddenly worse when memory isolation is
used more, or when new migratetypes are added.
After this patch, the race has no longer been observed in testing.
Signed-off-by: Mel Gorman
Acked-by: Vlastimil Babka
Reported-by: Joonsoo Kim
Reported-and-tested-by: Vlastimil Babka
Cc: Johannes Weiner
Cc: Jan Kara
Cc: Michal Hocko
Cc: Hugh Dickins
Cc: Dave Hansen
Cc: Theodore Ts'o
Cc: "Paul E. McKenney"
Cc: Oleg Nesterov
Cc: Rik van Riel
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit fc226822ce1612575a7b69b172f89e3cd9fff359
Author: Michal Hocko
Date: Wed Jun 4 16:07:36 2014 -0700
memcg: do not hang on OOM when killed by userspace OOM access to memory reserves
commit d8dc595ce3909fbc131bdf5ab8c9808fe624b18d upstream.
Eric has reported that he can see task(s) stuck in memcg OOM handler
regularly. The only way out is to
echo 0 > $GROUP/memory.oom\_control
His usecase is:
- Setup a hierarchy with memory and the freezer (disable kernel oom and
have a process watch for oom).
- In that memory cgroup add a process with one thread per cpu.
- In one thread slowly allocate once per second I think it is 16M of ram
and mlock and dirty it (just to force the pages into ram and stay
there).
- When oom is achieved loop:
\* attempt to freeze all of the tasks.
\* if frozen send every task SIGKILL, unfreeze, remove the directory in
cgroupfs.
Eric has then pinpointed the issue to be memcg specific.
All tasks are sitting on the memcg\_oom\_waitq when memcg oom is disabled.
Those that have received fatal signal will bypass the charge and should
continue on their way out. The tricky part is that the exit path might
trigger a page fault (e.g. exit\_robust\_list), thus the memcg charge,
while its memcg is still under OOM because nobody has released any charges
yet.
Unlike with the in-kernel OOM handler the exiting task doesn't get
TIF\_MEMDIE set so it doesn't shortcut further charges of the killed task
and falls to the memcg OOM again without any way out of it as there are no
fatal signals pending anymore.
This patch fixes the issue by checking PF\_EXITING early in
mem\_cgroup\_try\_charge and bypass the charge same as if it had fatal
signal pending or TIF\_MEMDIE set.
Normally exiting tasks (aka not killed) will bypass the charge now but
this should be OK as the task is leaving and will release memory and
increasing the memory pressure just to release it in a moment seems
dubious wasting of cycles. Besides that charges after exit\_signals should
be rare.
I am bringing this patch again (rebased on the current mmotm tree). I
hope we can move forward finally. If there is still an opposition then
I would really appreciate a concurrent approach so that we can discuss
alternatives.
http://comments.gmane.org/gmane.linux.kernel.stable/77650 is a reference
to the followup discussion when the patch has been dropped from the mmotm
last time.
Reported-by: Eric W. Biederman
Signed-off-by: Michal Hocko
Acked-by: David Rientjes
Acked-by: Johannes Weiner
Cc: KAMEZAWA Hiroyuki
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit f339db5214ffae24cfc66df81266ffe1fab553e7
Author: Mel Gorman
Date: Wed Jun 4 16:07:35 2014 -0700
mm: vmscan: do not throttle based on pfmemalloc reserves if node has no ZONE\_NORMAL
commit 675becce15f320337499bc1a9356260409a5ba29 upstream.
throttle\_direct\_reclaim() is meant to trigger during swap-over-network
during which the min watermark is treated as a pfmemalloc reserve. It
throttes on the first node in the zonelist but this is flawed.
The user-visible impact is that a process running on CPU whose local
memory node has no ZONE\_NORMAL will stall for prolonged periods of time,
possibly indefintely. This is due to throttle\_direct\_reclaim thinking the
pfmemalloc reserves are depleted when in fact they don't exist on that
node.
On a NUMA machine running a 32-bit kernel (I know) allocation requests
from CPUs on node 1 would detect no pfmemalloc reserves and the process
gets throttled. This patch adjusts throttling of direct reclaim to
throttle based on the first node in the zonelist that has a usable
ZONE\_NORMAL or lower zone.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Mel Gorman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit bd313c8332ddeecb4a67562b4c252dde5dd81272
Author: Tetsuo Handa
Date: Wed Jun 4 16:05:36 2014 -0700
kthread: fix return value of kthread\_create() upon SIGKILL.
commit 8fe6929cfd43c44834858a53e129ffdc7c166298 upstream.
Commit 786235eeba0e ("kthread: make kthread\_create() killable") meant
for allowing kthread\_create() to abort as soon as killed by the
OOM-killer. But returning -ENOMEM is wrong if killed by SIGKILL from
userspace. Change kthread\_create() to return -EINTR upon SIGKILL.
Signed-off-by: Tetsuo Handa
Cc: Oleg Nesterov
Acked-by: David Rientjes
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c3dc58b993c5bd5ef1b60b116d2716e3f8e90207
Author: Naoya Horiguchi
Date: Wed Jun 4 16:05:35 2014 -0700
hugetlb: restrict hugepage\_migration\_support() to x86\_64
commit c177c81e09e517bbf75b67762cdab1b83aba6976 upstream.
Currently hugepage migration is available for all archs which support
pmd-level hugepage, but testing is done only for x86\_64 and there're
bugs for other archs. So to avoid breaking such archs, this patch
limits the availability strictly to x86\_64 until developers of other
archs get interested in enabling this feature.
Simply disabling hugepage migration on non-x86\_64 archs is not enough to
fix the reported problem where sys\_move\_pages() hits the BUG\_ON() in
follow\_page(FOLL\_GET), so let's fix this by checking if hugepage
migration is supported in vma\_migratable().
Signed-off-by: Naoya Horiguchi
Reported-by: Michael Ellerman
Tested-by: Michael Ellerman
Acked-by: Hugh Dickins
Cc: Benjamin Herrenschmidt
Cc: Tony Luck
Cc: Russell King
Cc: Martin Schwidefsky
Cc: James Hogan
Cc: Ralf Baechle
Cc: David Miller
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 99a9ff3961e3b4f33e391e09772a456330e7e109
Author: Konstantin Khlebnikov
Date: Wed Jun 4 16:05:30 2014 -0700
tools/vm/page-types.c: catch sigbus if raced with truncate
commit 1d46598b7903cd5ec83c49adbd741f43bb0ffcdc upstream.
Recently added page-cache dumping is known to be a little bit racy.
But after race with truncate it just dies due to unhandled SIGBUS
when it tries to poke pages beyond the new end of file.
This patch adds handler for SIGBUS which skips the rest of the file.
Signed-off-by: Konstantin Khlebnikov
Cc: Naoya Horiguchi
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5ff2117cf81c53f2b1e3e47a38451c792da4b330
Author: Johan Hovold
Date: Mon May 26 19:23:10 2014 +0200
USB: option: fix runtime PM handling
commit acf47d4f9c39b1cba467aa9442fc2efe0b1da741 upstream.
Fix potential I/O while runtime suspended due to missing PM operations
in send\_setup.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit a5be017ea752981645c63e266daa0a7cb9e7ccb1
Author: Alan Stern
Date: Tue Jun 3 11:00:27 2014 -0400
USB: EHCI: avoid BIOS handover on the HASEE E200
commit b0a50e92bda3c4aeb8017d4e6c6e92146ebd5c9b upstream.
Leandro Liptak reports that his HASEE E200 computer hangs when we ask
the BIOS to hand over control of the EHCI host controller. This
definitely sounds like a bug in the BIOS, but at the moment there is
no way to fix it.
This patch works around the problem by avoiding the handoff whenever
the motherboard and BIOS version match those of Leandro's computer.
Signed-off-by: Alan Stern
Reported-by: Leandro Liptak
Tested-by: Leandro Liptak
Signed-off-by: Greg Kroah-Hartman
commit 180cdfa5f8ffd26845537f085fb467e80db08a2e
Author: Paul Bolle
Date: Fri May 16 12:00:57 2014 +0200
ARM: OMAP: replace checks for CONFIG\_USB\_GADGET\_OMAP
commit 77c2f02edbeda9409a7cf3fd66233015820c213a upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
apparently required that checks for CONFIG\_USB\_GADGET\_OMAP would be
replaced with checks for CONFIG\_USB\_OMAP. Do so now for the remaining
checks for CONFIG\_USB\_GADGET\_OMAP, even though these checks have
basically been broken since v3.1.
And, since we're touching this code, use the IS\_ENABLED() macro, so
things will now (hopefully) also work if USB\_OMAP is modular.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Tony Lindgren
Signed-off-by: Greg Kroah-Hartman
commit 96da12bf4f34917a535cfdc1c435470aab5001c9
Author: Felipe Balbi
Date: Wed Apr 16 10:30:33 2014 -0500
usb: dwc3: gadget: clear stall when disabling endpoint
commit 687ef9817df7ed960d14575b9033dde3d04631fe upstream.
so it seems like DWC3 IP doesn't clear stalls
automatically when we disable an endpoint, because
of that, we \_must\_ make sure stalls are cleared
before clearing the proper bit in DALEPENA register.
Reported-by: Johannes Stezenbach
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 702d5b2b469b648f60c837fd439b6f8c86fc0c22
Author: Paul Bolle
Date: Mon May 26 23:37:09 2014 +0200
usb: gadget: rename CONFIG\_USB\_GADGET\_PXA25X
commit d30f2065d6da377cc76771aca5a9850cfca8723b upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
basically renamed the Kconfig symbol USB\_GADGET\_PXA25X to USB\_PXA25X. It
did not rename the related macros in use at that time. Commit
c0a39151a405 ("ARM: pxa: fix inconsistent CONFIG\_USB\_PXA27X") did so for
all but one macro. Rename that last macro too now.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Greg Kroah-Hartman
commit c94bdf18b58b9c3aba9f1edcf8ed613bf452d971
Author: Alan Stern
Date: Tue Jun 3 11:11:34 2014 -0400
USB: usbtest: add a timeout for scatter-gather tests
commit 32b36eeae6a859670d2939a7d6136cb5e9ed64f8 upstream.
In usbtest, tests 5 - 8 use the scatter-gather library in usbcore
without any sort of timeout. If there's a problem in the gadget or
host controller being tested, the test can hang.
This patch adds a 10-second timeout to the tests, so that they will
fail gracefully with an ETIMEDOUT error instead of hanging.
Signed-off-by: Alan Stern
Reported-by: Huang Rui
Tested-by: Huang Rui
Signed-off-by: Greg Kroah-Hartman
commit c1bbe8ec4b9030036fbde02f188e2e77f80592fb
Author: Huang Rui
Date: Mon May 26 10:55:36 2014 +0800
usb: usbtest: fix unlink write error with pattern 1
commit e4d58f5dcb7d7be45df8def31881ebfae99c75da upstream.
TEST 12 and TEST 24 unlinks the URB write request for N times. When
host and gadget both initialize pattern 1 (mod 63) data series to
transfer, the gadget side will complain the wrong data which is not
expected. Because in host side, usbtest doesn't fill the data buffer
as mod 63 and this patch fixed it.
[20285.488974] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.489181] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.489423] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb50800 length 512 last
[20285.489727] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.490055] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.490281] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.490492] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Active
[20285.490713] dwc3 dwc3.0.auto: ep1out-bulk: endpoint busy
[20285.490909] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Complete
[20285.491117] dwc3 dwc3.0.auto: request ffff8800aa6cb480 from ep1out-bulk completed 512/512 ===> 0
[20285.491431] zero gadget: bad OUT byte, buf[1] = 0
[20285.491605] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Set Stall' params 00000000 00000000 00000000
[20285.491915] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.492099] dwc3 dwc3.0.auto: queing request ffff8800aa6cb480 to ep1out-bulk length 512
[20285.492387] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.492595] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.492830] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb51000 length 512 last
[20285.493135] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.493465] dwc3 dwc3.0.auto: Command Complete --> 0
Signed-off-by: Huang Rui
Signed-off-by: Greg Kroah-Hartman
commit fafb27179c287f740920e8dee3c4fc695821e590
Author: Dan Carpenter
Date: Fri May 9 14:59:16 2014 +0300
applicom: dereferencing NULL on error path
commit 8bab797c6e5724a43b7666ad70860712365cdb71 upstream.
This is a static checker fix. The "dev" variable is always NULL after
the while statement so we would be dereferencing a NULL pointer here.
Fixes: 819a3eba4233 ('[PATCH] applicom: fix error handling')
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit 1c2ee2e5fe50c64dc83d7130fb12d85d5092f3b6
Author: Stephen Boyd
Date: Fri May 23 17:16:53 2014 -0700
staging/mt29f\_spinand: Terminate of match table
commit ffd07de65ef5315053ea16356cd533b7f47c17e9 upstream.
Failure to terminate this match table can lead to boot failures
depending on where the compiler places the match table.
Cc: Kamlakant Patel
Cc: Mona Anonuevo
Cc: linux-mtd@lists.infradead.org
Signed-off-by: Stephen Boyd
Signed-off-by: Greg Kroah-Hartman
commit f10da0ea0a699fc10947a6730588704b8cffd581
Author: Dan Carpenter
Date: Mon Apr 7 09:31:21 2014 +0300
Staging: rtl8188eu: overflow in update\_sta\_support\_rate()
commit 9dbd79aeb9842144d9a114a979a12c0949ee11eb upstream.
The ->SupportedRates[] array has NDIS\_802\_11\_LENGTH\_RATES\_EX (16)
elements. Since "ie\_len" comes from then network and can go up to 255
then it means we should add a range check to prevent memory corruption.
Fixes: d6846af679e0 ('staging: r8188eu: Add files for new driver - part 7')
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit 4c69bd70a472541caeb173088d2b8a8d14352e21
Author: Paul Bolle
Date: Mon May 26 21:47:11 2014 +0200
staging: tidspbridge: check for CONFIG\_SND\_OMAP\_SOC\_MCBSP
commit d3921a03a89acb1b9ca599590c0131c89f8737d8 upstream.
Commit d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
removed the Kconfig symbol OMAP\_MCBSP. It left two checks for
CONFIG\_OMAP\_MCBSP untouched.
Convert these to checks for CONFIG\_SND\_OMAP\_SOC\_MCBSP. That must be
correct, since that re-enables calls to functions that are all found in
sound/soc/omap/mcbsp.c. And that file is built only if
CONFIG\_SND\_OMAP\_SOC\_MCBSP is defined.
Fixes: d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
Signed-off-by: Paul Bolle
Signed-off-by: Greg Kroah-Hartman
commit 451049d57a37f8a676d885a7896494a274687f4a
Author: Antoine Ténart
Date: Mon May 12 14:56:28 2014 +0200
phy: exynos-mipi-video: fix check on array index
commit 98c3b32229f2685c13436b652b8959c99dfc5a31 upstream.
The phys array is of size EXYNOS\_MIPI\_PHYS\_NUM. Trying to access the
index EXYNOS\_MIPI\_PHYS\_NUM should return an error.
Fixes: 069d2e26e9d6 "phy: Add driver for Exynos MIPI CSIS/DSIM DPHYs"
Signed-off-by: Antoine Ténart
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Greg Kroah-Hartman
commit 13611b46b1658d64b256f18f2a735bfb0d087b9f
Author: Stephen Chivers
Date: Wed May 14 08:04:39 2014 +1000
printk/of\_serial: fix serial console cessation part way through boot.
commit 7fa21dd8bd191564a195291161d6b43db5d9c350 upstream.
Commit 5f5c9ae56c38942623f69c3e6dc6ec78e4da2076
"serial\_core: Unregister console in uart\_remove\_one\_port()"
fixed a crash where a serial port was removed but
not deregistered as a console.
There is a side effect of that commit for platforms having serial consoles
and of\_serial configured (CONFIG\_SERIAL\_OF\_PLATFORM). The serial console
is disabled midway through the boot process.
This cessation of the serial console affects PowerPC computers
such as the MVME5100 and SAM440EP.
The sequence is:
bootconsole [udbg0] enabled
....
serial8250/16550 driver initialises and registers its UARTS,
one of these is the serial console.
console [ttyS0] enabled
....
of\_serial probes "platform" devices, registering them as it goes.
One of these is the serial console.
console [ttyS0] disabled.
The disabling of the serial console is due to:
a. unregister\_console in printk not clearing the
CONS\_ENABLED bit in the console flags,
even though it has announced that the console is disabled; and
b. of\_platform\_serial\_probe in of\_serial not setting the port type
before it registers with serial8250\_register\_8250\_port.
This patch ensures that the serial console is re-enabled when of\_serial
registers a serial port that corresponds to the designated console.
===
The above failure was identified in Linux-3.15-rc2.
Tested using MVME5100 and SAM440EP PowerPC computers with
kernels built from Linux-3.15-rc5 and tty-next.
The continued operation of the serial console is vital for computers
such as the MVME5100 as that Single Board Computer does not
have any grapical/display hardware.
Signed-off-by: Stephen Chivers
Tested-by: Stephen Chivers
Acked-by: Geert Uytterhoeven  [unregister\_console]
Signed-off-by: Greg Kroah-Hartman
commit 063579d4c3ed721f5c3f066fcc12b5f176815b4b
Author: Alexey Khoroshilov
Date: Wed May 7 01:26:04 2014 +0400
w1: do not unlock unheld list\_mutex in \_\_w1\_remove\_master\_device()
commit a0f104644ec27ce5bbb36e950eb426dba9a3ad44 upstream.
w1\_process\_callbacks() expects to be called with dev->list\_mutex held,
but it is the fact only in w1\_process(). \_\_w1\_remove\_master\_device()
calls w1\_process\_callbacks() after it releases list\_mutex.
The patch fixes \_\_w1\_remove\_master\_device() to acquire list\_mutex
for w1\_process\_callbacks().
Found by Linux Driver Verification project (linuxtesting.org).
Signed-off-by: Alexey Khoroshilov
Acked-by: David Fries
Acked-by: Evgeniy Polyakov
Signed-off-by: Greg Kroah-Hartman
commit eb5adaa8b70a63e549a02c45570cd255ee0025aa
Author: Krzysztof Kozlowski
Date: Fri Apr 18 16:47:30 2014 +0200
extcon: max14577: Properly handle regmap\_irq\_get\_virq error
commit 369afd4ba22f5b8de0c9229b6e62b3f9e2207034 upstream.
The regmap\_irq\_get\_virq may return 0 or -EINVAL on error. Fail the probe
in both situations.
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit cc5dbe7fcb0db79f405cc780c42f70ce003b5222
Author: Krzysztof Kozlowski
Date: Wed Apr 9 11:56:09 2014 +0200
extcon: max14577: Fix probe failure on successful work queue
commit 12adef5b49e98eb181b4163c36e2998169e1379b upstream.
In probe the driver queued delayed work for cable detection and
returned the result of queue\_delayed\_work() call. However the return
value of queue\_delayed\_work() does not indicate an error and in normal
condition it returns true which means successful work queue.
This effectively resulted in probe failure:
[ 2.088204] max14577-muic: probe of max77836-muic failed with error 1
Signed-off-by: Krzysztof Kozlowski
Fixes: 962e56bfcf0b ("extcon: max14577: Add extcon-max14577 driver...")
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit cced34726fcd53b65b4d5483dcf225414b9f4be6
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:12 2014 +0200
extcon: max77693: Fix two NULL pointer exceptions on missing pdata
commit d5653f2b7304f05eeb45d84f123cf02f840b8537 upstream.
Fix NULL pointer exceptions when platform data is not supplied.
Trace of one exception:
Unable to handle kernel NULL pointer dereference at virtual address 00000008
pgd = c0004000
[00000008] \*pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 2 PID: 1 Comm: swapper/0 Not tainted 3.14.0-12045-gead5dd4687a6-dirty #1628
task: eea80000 ti: eea88000 task.ti: eea88000
PC is at max77693\_muic\_probe+0x27c/0x528
LR is at regmap\_write+0x50/0x60
pc : [] lr : [] psr: 20000113
sp : eea89e38 ip : 00000000 fp : c098a834
r10: ee1a5a10 r9 : 00000005 r8 : c098a83c
r7 : 0000000a r6 : c098a774 r5 : 00000005 r4 : eeb006d0
r3 : c0697bd8 r2 : 00000000 r1 : 00000001 r0 : 00000000
Flags: nzCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment kernel
Control: 10c5387d Table: 4000404a DAC: 00000015
Process swapper/0 (pid: 1, stack limit = 0xeea88240)
Stack: (0xeea89e38 to 0xeea8a000)
9e20: c08499fc eeb006d0
9e40: 00000000 00000000 c0915f98 00000001 00000000 ee1a5a10 c098a730 c09a88b8
9e60: 00000000 c098a730 c0915f98 00000000 00000000 c02d6aa0 c02d6a88 ee1a5a10
9e80: c0a712c8 c02d54e4 00001204 c0628b00 ee1a5a10 c098a730 ee1a5a44 00000000
9ea0: eea88000 c02d57b4 00000000 c098a730 c02d5728 c02d3a24 ee813e5c eeb9d534
9ec0: c098a730 ee22f700 c097c720 c02d4b14 c08174ec c098a730 00000006 c098a730
9ee0: 00000006 c092fd30 c09b8500 c02d5df8 00000000 c093cbb8 00000006 c0008928
9f00: 000000c3 ef7fc785 00000000 ef7fc794 00000000 c08af968 00000072 eea89f30
9f20: ef7fc85e c065f198 000000c3 c003e87c 00000003 00000000 c092fd3c 00000000
9f40: c08af618 c0826d58 00000006 00000006 c0956f58 c093cbb8 00000006 c092fd30
9f60: c09b8500 000000c3 c092fd3c c08e8510 00000000 c08e8bb0 00000006 00000006
9f80: c08e8510 c0c0c0c0 00000000 c0628fac 00000000 00000000 00000000 00000000
9fa0: 00000000 c0628fb4 00000000 c000f038 00000000 00000000 00000000 00000000
9fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9fe0: 00000000 00000000 00000000 00000000 00000013 00000000 c0c0c0c0 c0c0c0c0
[] (max77693\_muic\_probe) from [] (platform\_drv\_probe+0x18/0x48)
[] (platform\_drv\_probe) from [] (driver\_probe\_device+0x140/0x384)
[] (driver\_probe\_device) from [] (\_\_driver\_attach+0x8c/0x90)
[] (\_\_driver\_attach) from [] (bus\_for\_each\_dev+0x54/0x88)
[] (bus\_for\_each\_dev) from [] (bus\_add\_driver+0xe8/0x204)
[] (bus\_add\_driver) from [] (driver\_register+0x78/0xf4)
[] (driver\_register) from [] (do\_one\_initcall+0xc4/0x174)
[] (do\_one\_initcall) from [] (kernel\_init\_freeable+0xfc/0x1c8)
[] (kernel\_init\_freeable) from [] (kernel\_init+0x8/0xec)
[] (kernel\_init) from [] (ret\_from\_fork+0x14/0x3c)
Code: caffffe7 e59d200c e3550001 b3a05001 (e5923008)
---[ end trace 85db969ce011bde7 ]---
Signed-off-by: Krzysztof Kozlowski
Fixes: 190d7cfc8632
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit 98841cadfdb8e4cecd25eedaaf31f42af982c758
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:14 2014 +0200
extcon: max8997: Fix NULL pointer exception on missing pdata
commit dfee4111febf3d9ef3a640b2cd6205c75f4e7e3d upstream.
Fix NULL pointer exception when platform data is not supplied. The
driver dereferenced pdata pointer where it could be NULL.
Signed-off-by: Krzysztof Kozlowski
Fixes: 810d601f07c
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit ed950366acc7694b514a43878b41a1392d89bd19
Author: Ming Lei
Date: Fri May 30 10:49:29 2014 +0800
block: virtio\_blk: don't hold spin lock during world switch
commit e8edca6f7f92234202d6dd163c118ef495244d7c upstream.
Firstly, it isn't necessary to hold lock of vblk->vq\_lock
when notifying hypervisor about queued I/O.
Secondly, virtqueue\_notify() will cause world switch and
it may take long time on some hypervisors(such as, qemu-arm),
so it isn't good to hold the lock and block other vCPUs.
On arm64 quad core VM(qemu-kvm), the patch can increase I/O
performance a lot with VIRTIO\_RING\_F\_EVENT\_IDX enabled:
- without the patch: 14K IOPS
- with the patch: 34K IOPS
fio script:
[global]
direct=1
bsrange=4k-4k
timeout=10
numjobs=4
ioengine=libaio
iodepth=64
filename=/dev/vdc
group\_reporting=1
[f1]
rw=randread
Cc: Rusty Russell
Cc: "Michael S. Tsirkin"
Cc: virtualization@lists.linux-foundation.org
Signed-off-by: Ming Lei
Acked-by: Rusty Russell
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit a5ac2ce6897f7e5366042f1d5ea7529113280472
Author: Russell King
Date: Fri Apr 18 10:46:45 2014 +0100
imx-drm: fix hdmi hotplug detection initial state
commit 98dbeadaf050335df8655d8d9be7a324b6cd896e upstream.
The initial state at boot is assumed to be disconnected, and we hope
to receive an interrupt to update the status. Let's be more explicit
about the current state - reading the PHY status register tells us
the current level of the hotplug signal, which we can report back in
the \_detect() method.
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman


=== Content from www.kernel.org_9994d39c_20250125_060432.html ===
commit bbae7add628cfe96a1facd578dd1eddcd1030de7
Author: Greg Kroah-Hartman
Date: Mon Jun 30 20:12:08 2014 -0700
Linux 3.14.10
commit 6d646b4de65b8eccad37b20be955c547fa66806c
Author: Andrzej Zaborowski
Date: Mon Jun 9 16:50:40 2014 +0200
efi-pstore: Fix an overflow on 32-bit builds
commit 783ee43118dc773bc8b0342c5b230e017d5a04d0 upstream.
In generic\_id the long int timestamp is multiplied by 100000 and needs
an explicit cast to u64.
Without that the id in the resulting pstore filename is wrong and
userspace may have problems parsing it, but more importantly files in
pstore can never be deleted and may fill the EFI flash (brick device?).
This happens because when generic pstore code wants to delete a file,
it passes the id to the EFI backend which reinterpretes it and a wrong
variable name is attempted to be deleted. There's no error message but
after remounting pstore, deleted files would reappear.
Signed-off-by: Andrew Zaborowski
Acked-by: David Rientjes
Signed-off-by: Matt Fleming
Signed-off-by: Greg Kroah-Hartman
commit bf695f730888a9f2f325245f730e6df508b112f9
Author: Fathi Boudra
Date: Sat Apr 12 13:13:24 2014 +0300
builddeb: use $OBJCOPY variable instead of objcopy
commit 6b4a144a92ab81a1f45fb9b12aebaaaee0d08120 upstream.
In cross-build environment, we expect to use the cross-compiler objcopy
instead of the host objcopy.
It fixes following build failures:
objcopy --only-keep-debug lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko /srv/build/linux/debian/dbgtmp/usr/lib/debug/lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko
objcopy: Unable to recognise the format of the input file `lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko'
Signed-off-by: Fathi Boudra
Fixes: 810e843746b7 ('deb-pkg: split debug symbols in their own package')
Reviewed-by: Ben Hutchings
Signed-off-by: Michal Marek
Signed-off-by: Greg Kroah-Hartman
commit b0d3f527adbe90799e10000a0c59e88f0174bfaf
Author: Konstantin Khlebnikov
Date: Tue Jun 17 06:58:05 2014 +0400
epoll: fix use-after-free in eventpoll\_release\_file
commit ebe06187bf2aec10d537ce4595e416035367d703 upstream.
This fixes use-after-free of epi->fllink.next inside list loop macro.
This loop actually releases elements in the body. The list is
rcu-protected but here we cannot hold rcu\_read\_lock because we need to
lock mutex inside.
The obvious solution is to use list\_for\_each\_entry\_safe(). RCU-ness
isn't essential because nobody can change this list under us, it's final
fput for this file.
The bug was introduced by ae10b2b4eb01 ("epoll: optimize EPOLL\_CTL\_DEL
using rcu")
Signed-off-by: Konstantin Khlebnikov
Reported-by: Cyrill Gorcunov
Cc: Sasha Levin
Cc: Jason Baron
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit b83627d417975fa8681344384ac55a1c4751f55f
Author: Andy Lutomirski
Date: Mon Jun 23 14:22:15 2014 -0700
x86\_32, entry: Do syscall exit work on badsys (CVE-2014-4508)
commit 554086d85e71f30abe46fc014fea31929a7c6a8a upstream.
The bad syscall nr paths are their own incomprehensible route
through the entry control flow. Rearrange them to work just like
syscalls that return -ENOSYS.
This fixes an OOPS in the audit code when fast-path auditing is
enabled and sysenter gets a bad syscall nr (CVE-2014-4508).
This has probably been broken since Linux 2.6.27:
af0575bba0 i386 syscall audit fast-path
Cc: Roland McGrath
Reported-by: Toralf Förster
Signed-off-by: Andy Lutomirski
Link: http://lkml.kernel.org/r/e09c499eade6fc321266dd6b54da7beb28d6991c.1403558229.git.luto@amacapital.net
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 08a2da50340b0f829c27800c67782566093b5543
Author: Greg Kroah-Hartman
Date: Tue Jun 24 16:59:01 2014 -0400
lz4: fix another possible overrun
commit 4148c1f67abf823099b2d7db6851e4aea407f5ee upstream.
There is one other possible overrun in the lz4 code as implemented by
Linux at this point in time (which differs from the upstream lz4
codebase, but will get synced at in a future kernel release.) As
pointed out by Don, we also need to check the overflow in the data
itself.
While we are at it, replace the odd error return value with just a
"simple" -1 value as the return value is never used for anything other
than a basic "did this work or not" check.
Reported-by: "Don A. Bailey"
Reported-by: Willy Tarreau
Signed-off-by: Greg Kroah-Hartman
commit 9e22eb8c724a00c0d51f4c0d144c48bd0d108bd2
Author: Jeff Mahoney
Date: Tue May 27 12:59:57 2014 -0400
btrfs: allocate raid type kobjects dynamically
commit c1895442be01c58449e3bf9272f22062a670e08f upstream.
We are currently allocating space\_info objects in an array when we
allocate space\_info. When a user does something like:
# btrfs balance start -mconvert=raid1 -dconvert=raid1 /mnt
# btrfs balance start -mconvert=single -dconvert=single /mnt -f
# btrfs balance start -mconvert=raid1 -dconvert=raid1 /
We can end up with memory corruption since the kobject hasn't
been reinitialized properly and the name pointer was left set.
The rationale behind allocating them statically was to avoid
creating a separate kobject container that just contained the
raid type. It used the index in the array to determine the index.
Ultimately, though, this wastes more memory than it saves in all
but the most complex scenarios and introduces kobject lifetime
questions.
This patch allocates the kobjects dynamically instead. Note that
we also remove the kobject\_get/put of the parent kobject since
kobject\_add and kobject\_del do that internally.
Signed-off-by: Jeff Mahoney
Reported-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit f59f14e214d8b3e0779fde70dabed4586e144fd8
Author: Jeff Mahoney
Date: Wed Mar 26 14:11:26 2014 -0400
btrfs: fix lockdep warning with reclaim lock inversion
commit ed55b6ac077fe7f9c6490ff55172c4b563562d7c upstream.
When encountering memory pressure, testers have run into the following
lockdep warning. It was caused by \_\_link\_block\_group calling kobject\_add
with the groups\_sem held. kobject\_add calls kvasprintf with GFP\_KERNEL,
which gets us into reclaim context. The kobject doesn't actually need
to be added under the lock -- it just needs to ensure that it's only
added for the first block group to be linked.
=========================================================
[ INFO: possible irq lock inversion dependency detected ]
3.14.0-rc8-default #1 Not tainted
---------------------------------------------------------
kswapd0/169 just changed the state of lock:
(&delayed\_node->mutex){+.+.-.}, at: [] \_\_btrfs\_release\_delayed\_node+0x3a/0x200 [btrfs]
but this lock took another, RECLAIM\_FS-unsafe lock in the past:
(&found->groups\_sem){+++++.}
and interrupts could create inverse lock ordering between them.
other info that might help us debug this:
Possible interrupt unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&found->groups\_sem);
local\_irq\_disable();
lock(&delayed\_node->mutex);
lock(&found->groups\_sem);
lock(&delayed\_node->mutex);
\*\*\* DEADLOCK \*\*\*
2 locks held by kswapd0/169:
#0: (shrinker\_rwsem){++++..}, at: [] shrink\_slab+0x3a/0x160
#1: (&type->s\_umount\_key#27){++++..}, at: [] grab\_super\_passive+0x3f/0x90
Signed-off-by: Jeff Mahoney
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit fe79ac25b6727012ca89de85b8008e1e07db4978
Author: Eric Sandeen
Date: Thu Jun 12 00:39:58 2014 -0500
btrfs: fix use of uninit "ret" in end\_extent\_writepage()
commit 3e2426bd0eb980648449e7a2f5a23e3cd3c7725c upstream.
If this condition in end\_extent\_writepage() is false:
if (tree->ops && tree->ops->writepage\_end\_io\_hook)
we will then test an uninitialized "ret" at:
ret = ret < 0 ? ret : -EIO;
The test for ret is for the case where ->writepage\_end\_io\_hook
failed, and we'd choose that ret as the error; but if
there is no ->writepage\_end\_io\_hook, nothing sets ret.
Initializing ret to 0 should be sufficient; if
writepage\_end\_io\_hook wasn't set, (!uptodate) means
non-zero err was passed in, so we choose -EIO in that case.
Signed-of-by: Eric Sandeen
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 75f93474507a99f8be8000cb0f33a60d488298d4
Author: Liu Bo
Date: Mon Jun 9 10:54:07 2014 +0800
Btrfs: fix scrub\_print\_warning to handle skinny metadata extents
commit 6eda71d0c030af0fc2f68aaa676e6d445600855b upstream.
The skinny extents are intepreted incorrectly in scrub\_print\_warning(),
and end up hitting the BUG() in btrfs\_extent\_inline\_ref\_size.
Reported-by: Konstantinos Skarlatos
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 4f850fdfbb90c57178e24e9e6c9fc32d18cc23e1
Author: Liu Bo
Date: Sun Jun 8 19:04:13 2014 +0800
Btrfs: use right type to get real comparison
commit cd857dd6bc2ae9ecea14e75a34e8a8fdc158e307 upstream.
We want to make sure the point is still within the extent item, not to verify
the memory it's pointing to.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 6858c106c6a0eaa458423b223154b0baf4450e03
Author: Josef Bacik
Date: Thu Jun 5 16:08:45 2014 -0400
Btrfs: don't check nodes for extent items
commit 8a56457f5f8fa7c2698ffae8545214c5b96a2cb5 upstream.
The backref code was looking at nodes as well as leaves when we tried to
populate extent item entries. This is not good, and although we go away with it
for the most part because we'd skip where disk\_bytenr != random\_memory,
sometimes random\_memory would match and suddenly boom. This fixes that problem.
Thanks,
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 3379d704fb52e2e989fb3c6f0bdf1d5e74387cb1
Author: Rickard Strandqvist
Date: Thu May 22 22:43:43 2014 +0200
fs: btrfs: volumes.c: Fix for possible null pointer dereference
commit 8321cf2596d283821acc466377c2b85bcd3422b7 upstream.
There is otherwise a risk of a possible null pointer dereference.
Was largely found by using a static code analysis program called cppcheck.
Signed-off-by: Rickard Strandqvist
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit a6729cd10108988ad206e826293be76047140695
Author: Filipe Manana
Date: Sun May 25 04:49:24 2014 +0100
Btrfs: send, don't error in the presence of subvols/snapshots
commit 1af56070e3ef9477dbc7eba3b9ad7446979c7974 upstream.
If we are doing an incremental send and the base snapshot has a
directory with name X that doesn't exist anymore in the second
snapshot and a new subvolume/snapshot exists in the second snapshot
that has the same name as the directory (name X), the incremental
send would fail with -ENOENT error. This is because it attempts
to lookup for an inode with a number matching the objectid of a
root, which doesn't exist.
Steps to reproduce:
mkfs.btrfs -f /dev/sdd
mount /dev/sdd /mnt
mkdir /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap1
rmdir /mnt/testdir
btrfs subvolume create /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap2
btrfs send -p /mnt/mysnap1 /mnt/mysnap2 -f /tmp/send.data
A test case for xfstests follows.
Reported-by: Robert White
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 0da608d5f9df9385c2afbb7534d39e557328f6da
Author: Wang Shilong
Date: Tue May 13 17:05:06 2014 +0800
Btrfs: set right total device count for seeding support
commit 298658414a2f0bea1f05a81876a45c1cd96aa2e0 upstream.
Seeding device support allows us to create a new filesystem
based on existed filesystem.
However newly created filesystem's @total\_devices should include seed
devices. This patch fix the following problem:
# mkfs.btrfs -f /dev/sdb
# btrfstune -S 1 /dev/sdb
# mount /dev/sdb /mnt
# btrfs device add -f /dev/sdc /mnt --->fs\_devices->total\_devices = 1
# umount /mnt
# mount /dev/sdc /mnt --->fs\_devices->total\_devices = 2
This is because we record right @total\_devices in superblock, but
@fs\_devices->total\_devices is reset to be 0 in btrfs\_prepare\_sprout().
Fix this problem by not resetting @fs\_devices->total\_devices.
Signed-off-by: Wang Shilong
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 9ec61f8c4a60efc4ffb0364da124a774a1553f4e
Author: Liu Bo
Date: Mon May 12 12:47:36 2014 +0800
Btrfs: mark mapping with error flag to report errors to userspace
commit 5dca6eea91653e9949ce6eb9e9acab6277e2f2c4 upstream.
According to commit 865ffef3797da2cac85b3354b5b6050dc9660978
(fs: fix fsync() error reporting),
it's not stable to just check error pages because pages can be
truncated or invalidated, we should also mark mapping with error
flag so that a later fsync can catch the error.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit ba9ea146601ca8d387d451089b18d12321330f4f
Author: Liu Bo
Date: Sun May 11 23:14:59 2014 +0800
Btrfs: fix NULL pointer crash of deleting a seed device
commit 29cc83f69c8338ff8fd1383c9be263d4bdf52d73 upstream.
Same as normal devices, seed devices should be initialized with
fs\_info->dev\_root as well, otherwise we'll get a NULL pointer crash.
Cc: Chris Murphy
Reported-by: Chris Murphy
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit a9142eca7be86f00db4c504d16adba29fdbbe287
Author: Wang Shilong
Date: Wed Apr 9 19:23:22 2014 +0800
Btrfs: make sure there are not any read requests before stopping workers
commit de348ee022175401e77d7662b7ca6e231a94e3fd upstream.
In close\_ctree(), after we have stopped all workers,there maybe still
some read requests(for example readahead) to submit and this \*maybe\* trigger
an oops that user reported before:
kernel BUG at fs/btrfs/async-thread.c:619!
By hacking codes, i can reproduce this problem with one cpu available.
We fix this potential problem by invalidating all btree inode pages before
stopping all workers.
Thanks to Miao for pointing out this problem.
Signed-off-by: Wang Shilong
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 0ebcffd71421584531a44643de7f363dcc139635
Author: Miao Xie
Date: Thu Apr 24 13:31:55 2014 +0800
Btrfs: output warning instead of error when loading free space cache failed
commit 32d6b47fe6fc1714d5f1bba1b9f38e0ab0ad58a8 upstream.
If we fail to load a free space cache, we can rebuild it from the extent tree,
so it is not a serious error, we should not output a error message that
would make the users uncomfortable. This patch uses warning message instead
of it.
Signed-off-by: Miao Xie
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit b36fe043d15b301bacd1530e2687398cc24720a5
Author: Qu Wenruo
Date: Wed Apr 16 17:02:32 2014 +0800
btrfs: Add ctime/mtime update for btrfs device add/remove.
commit 5a1972bd9fd4b2fb1bac8b7a0b636d633d8717e3 upstream.
Btrfs will send uevent to udev inform the device change,
but ctime/mtime for the block device inode is not udpated, which cause
libblkid used by btrfs-progs unable to detect device change and use old
cache, causing 'btrfs dev scan; btrfs dev rmove; btrfs dev scan' give an
error message.
Reported-by: Tsutomu Itoh
Cc: Karel Zak
Signed-off-by: Qu Wenruo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 9ed3912c6855efe2f68b90d76e0c91a9c525ab71
Author: Chris Mason
Date: Wed May 21 05:49:54 2014 -0700
Btrfs: fix double free in find\_lock\_delalloc\_range
commit 7d78874273463a784759916fc3e0b4e2eb141c70 upstream.
We need to NULL the cached\_state after freeing it, otherwise
we might free it again if find\_delalloc\_range doesn't find anything.
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 3899510979e555166e0b13060a54a0b449674d22
Author: Pavel Shilovsky
Date: Sat May 24 16:42:02 2014 +0400
CIFS: Fix memory leaks in SMB2\_open
commit 663a962151593c69374776e8651238d0da072459 upstream.
Signed-off-by: Pavel Shilovsky
Reviewed-by: Shirish Pargaonkar
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit aa011e29c725b391e614ee7babe6f890a00e3fc5
Author: Benjamin LaHaise
Date: Tue Jun 24 13:32:51 2014 -0400
aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10
commit edfbbf388f293d70bf4b7c0bc38774d05e6f711a upstream.
A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
Signed-off-by: Benjamin LaHaise
Cc: Mateusz Guzik
Cc: Petr Matousek
Cc: Kent Overstreet
Cc: Jeff Moyer
Signed-off-by: Greg Kroah-Hartman
commit b0c60b4efb13a8b1b37288c9acada13019739d92
Author: Benjamin LaHaise
Date: Tue Jun 24 13:12:55 2014 -0400
aio: fix aio request leak when events are reaped by userspace
commit f8567a3845ac05bb28f3c1b478ef752762bd39ef upstream.
The aio cleanups and optimizations by kmo that were merged into the 3.10
tree added a regression for userspace event reaping. Specifically, the
reference counts are not decremented if the event is reaped in userspace,
leading to the application being unable to submit further aio requests.
This patch applies to 3.12+. A separate backport is required for 3.10/3.11.
This issue was uncovered as part of CVE-2014-0206.
Signed-off-by: Benjamin LaHaise
Cc: Kent Overstreet
Cc: Mateusz Guzik
Cc: Petr Matousek
Signed-off-by: Greg Kroah-Hartman
commit cc40a2916d3f2c7495410385bae08cfd58192071
Author: Thomas Gleixner
Date: Thu Mar 7 14:53:45 2013 +0100
genirq: Sanitize spurious interrupt detection of threaded irqs
commit 1e77d0a1ed7417d2a5a52a7b8d32aea1833faa6c upstream.
Till reported that the spurious interrupt detection of threaded
interrupts is broken in two ways:
- note\_interrupt() is called for each action thread of a shared
interrupt line. That's wrong as we are only interested whether none
of the device drivers felt responsible for the interrupt, but by
calling multiple times for a single interrupt line we account
IRQ\_NONE even if one of the drivers felt responsible.
- note\_interrupt() when called from the thread handler is not
serialized. That leaves the members of irq\_desc which are used for
the spurious detection unprotected.
To solve this we need to defer the spurious detection of a threaded
interrupt to the next hardware interrupt context where we have
implicit serialization.
If note\_interrupt is called with action\_ret == IRQ\_WAKE\_THREAD, we
check whether the previous interrupt requested a deferred check. If
not, we request a deferred check for the next hardware interrupt and
return.
If set, we check whether one of the interrupt threads signaled
success. Depending on this information we feed the result into the
spurious detector.
If one primary handler of a shared interrupt returns IRQ\_HANDLED we
disable the deferred check of irq threads on the same line, as we have
found at least one device driver who cared.
Reported-by: Till Straumann
Signed-off-by: Thomas Gleixner
Tested-by: Austin Schuh
Cc: Oliver Hartkopp
Cc: Wolfgang Grandegger
Cc: Pavel Pisa
Cc: Marc Kleine-Budde
Cc: linux-can@vger.kernel.org
Link: http://lkml.kernel.org/r/alpine.LFD.2.02.1303071450130.22263@ionos
Signed-off-by: Greg Kroah-Hartman
commit 6c9f4bad982d855e86e66b895dfec4d1ee0d59be
Author: Mike Frysinger
Date: Sun May 4 20:43:15 2014 -0400
x86, x32: Use compat shims for io\_{setup,submit}
commit 7fd44dacdd803c0bbf38bf478d51d280902bb0f1 upstream.
The io\_setup takes a pointer to a context id of type aio\_context\_t.
This in turn is typed to a \_\_kernel\_ulong\_t. We could tweak the
exported headers to define this as a 64bit quantity for specific
ABIs, but since we already have a 32bit compat shim for the x86 ABI,
let's just re-use that logic. The libaio package is also written to
expect this as a pointer type, so a compat shim would simplify that.
The io\_submit func operates on an array of pointers to iocb structs.
Padding out the array to be 64bit aligned is a huge pain, so convert
it over to the existing compat shim too.
We don't convert io\_getevents to the compat func as its only purpose
is to handle the timespec struct, and the x32 ABI uses 64bit times.
With this change, the libaio package can now pass its testsuite when
built for the x32 ABI.
Signed-off-by: Mike Frysinger
Link: http://lkml.kernel.org/r/1399250595-5005-1-git-send-email-vapier@gentoo.org
Cc: H.J. Lu
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit e996baa13029c4cb76c36055f762ea16c4e47d94
Author: H. Peter Anvin
Date: Wed Apr 30 14:03:25 2014 -0700
x86-32, espfix: Remove filter for espfix32 due to race
commit 246f2d2ee1d715e1077fc47d61c394569c8ee692 upstream.
It is not safe to use LAR to filter when to go down the espfix path,
because the LDT is per-process (rather than per-thread) and another
thread might change the descriptors behind our back. Fortunately it
is always \*safe\* (if a bit slow) to go down the espfix path, and a
32-bit LDT stack segment is extremely rare.
Signed-off-by: H. Peter Anvin
Link: http://lkml.kernel.org/r/1398816946-3351-1-git-send-email-hpa@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 71d5df86e7a6b077c3085cd9912eb96e155aa8e0
Author: Suravee Suthikulpanit
Date: Fri Jun 6 23:07:16 2014 +0100
arm64/dma: Removing ARCH\_HAS\_DMA\_GET\_REQUIRED\_MASK macro
commit f3a183cb422574014538017b5b291a416396f97e upstream.
Arm64 does not define dma\_get\_required\_mask() function.
Therefore, it should not define the ARCH\_HAS\_DMA\_GET\_REQUIRED\_MASK.
This causes build errors in some device drivers (e.g. mpt2sas)
Signed-off-by: Suravee Suthikulpanit
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 736422ac58eb011b8a7e5298e5bb2400d30e6a51
Author: Jason Cooper
Date: Wed Jun 4 13:41:20 2014 +0000
ARM: mvebu: DT: fix OpenBlocks AX3-4 RAM size
commit e47043aea3853a74a9aa5726a1faa916d7462ab7 upstream.
The OpenBlocks AX3-4 has a non-DT bootloader. It also comes with 1GB of
soldered on RAM, and a DIMM slot for expansion.
Unfortunately, atags\_to\_fdt() doesn't work in big-endian mode, so we see
the following failure when attempting to boot a big-endian kernel:
686 slab pages
17 pages shared
0 pages swap cached
[ pid ] uid tgid total\_vm rss nr\_ptes swapents oom\_score\_adj name
Kernel panic - not syncing: Out of memory and no killable processes...
CPU: 1 PID: 351 Comm: kworker/u4:0 Not tainted 3.15.0-rc8-next-20140603 #1
[] (unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0x78/0x94)
[] (dump\_stack) from [] (panic+0x90/0x21c)
[] (panic) from [] (out\_of\_memory+0x320/0x340)
[] (out\_of\_memory) from [] (\_\_alloc\_pages\_nodemask+0x874/0x930)
[] (\_\_alloc\_pages\_nodemask) from [] (handle\_mm\_fault+0x744/0x96c)
[] (handle\_mm\_fault) from [] (\_\_get\_user\_pages+0xd0/0x4c0)
[] (\_\_get\_user\_pages) from [] (get\_arg\_page+0x54/0xbc)
[] (get\_arg\_page) from [] (copy\_strings+0x278/0x29c)
[] (copy\_strings) from [] (copy\_strings\_kernel+0x20/0x28)
[] (copy\_strings\_kernel) from [] (do\_execve+0x3a8/0x4c8)
[] (do\_execve) from [] (\_\_\_\_call\_usermodehelper+0x15c/0x194)
[] (\_\_\_\_call\_usermodehelper) from [] (ret\_from\_fork+0x14/0x3c)
CPU0: stopping
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 3.15.0-rc8-next-20140603 #1
[] (unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0x78/0x94)
[] (dump\_stack) from [] (handle\_IPI+0x138/0x174)
[] (handle\_IPI) from [] (armada\_370\_xp\_handle\_irq+0xb0/0xcc)
[] (armada\_370\_xp\_handle\_irq) from [] (\_\_irq\_svc+0x40/0x50)
Exception stack(0xc0b6bf68 to 0xc0b6bfb0)
bf60: e9fad598 00000000 00f509a3 00000000 c0b6a000 c0b724c4
bf80: c0b72458 c0b6a000 00000000 00000000 c0b66da0 c0b6a000 00000000 c0b6bfb0
bfa0: c027bb94 c027bb24 60000313 ffffffff
[] (\_\_irq\_svc) from [] (cpu\_startup\_entry+0x54/0x214)
[] (cpu\_startup\_entry) from [] (start\_kernel+0x318/0x37c)
[] (start\_kernel) from [<00208078>] (0x208078)
---[ end Kernel panic - not syncing: Out of memory and no killable processes...
A similar failure will also occur if ARM\_ATAG\_DTB\_COMPAT isn't selected.
Fix this by setting a sane default (1 GB) in the dts file.
Signed-off-by: Jason Cooper
Tested-by: Kevin Hilman
Signed-off-by: Arnd Bergmann
Signed-off-by: Greg Kroah-Hartman
commit 4166c8b2ef2267465ba3381cd8cdb8d4c3bc9f3b
Author: James Bottomley
Date: Fri Mar 28 10:50:17 2014 -0700
SCSI: Fix spurious request sense in error handling
commit d555a2abf3481f81303d835046a5ec2c4fb3ca8e upstream.
We unconditionally execute scsi\_eh\_get\_sense() to make sure all failed
commands that should have sense attached, do. However, the routine forgets
that some commands, because of the way they fail, will not have any sense code
... we should not bother them with a REQUEST\_SENSE command. Fix this by
testing to see if we actually got a CHECK\_CONDITION return and skip asking for
sense if we don't.
Tested-by: Alan Stern
Signed-off-by: James Bottomley
Signed-off-by: Greg Kroah-Hartman
commit 8a550bb5fc37bfc5d2bd345b3062e49b82bd0bac
Author: Nicholas A. Bellinger
Date: Mon Jun 16 20:59:52 2014 +0000
target: Explicitly clear ramdisk\_mcp backend pages
[Note that a different patch to address the same issue went in during
v3.15-rc1 (commit 4442dc8a), but includes a bunch of other changes that
don't strictly apply to fixing the bug]
This patch changes rd\_allocate\_sgl\_table() to explicitly clear
ramdisk\_mcp backend memory pages by passing \_\_GFP\_ZERO into
alloc\_pages().
This addresses a potential security issue where reading from a
ramdisk\_mcp could return sensitive information, and follows what
>= v3.15 does to explicitly clear ramdisk\_mcp memory at backend
device initialization time.
Reported-by: Jorge Daniel Sequeira Matias
Cc: Jorge Daniel Sequeira Matias
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 9a7f545e75cef29dbdc4c585f3ae27c5f7f4ea48
Author: Roland Dreier
Date: Tue Jun 10 11:07:47 2014 -0700
target: Report correct response length for some commands
commit 2426bd456a61407388b6e61fc5f98dbcbebc50e2 upstream.
When an initiator sends an allocation length bigger than what its
command consumes, the target should only return the actual response data
and set the residual length to the unused part of the allocation length.
Add a helper function that command handlers (INQUIRY, READ CAPACITY,
etc) can use to do this correctly, and use this code to get the correct
residual for commands that don't use the full initiator allocation in the
handlers for READ CAPACITY, READ CAPACITY(16), INQUIRY, MODE SENSE and
REPORT LUNS.
This addresses a handful of failures as reported by Christophe with
the Windows Certification Kit:
http://permalink.gmane.org/gmane.linux.scsi.target.devel/6515
Signed-off-by: Roland Dreier
Tested-by: Christophe Vu-Brugier
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 66b5814126946624a66258c0c2fad3b7e78d7bad
Author: Sagi Grimberg
Date: Tue Jun 10 18:27:59 2014 +0300
Target/iscsi: Fix sendtargets response pdu for iser transport
commit 22c7aaa57e80853b4904a46c18f97db0036a3b97 upstream.
In case the transport is iser we should not include the
iscsi target info in the sendtargets text response pdu.
This causes sendtargets response to include the target
info twice.
Modify iscsit\_build\_sendtargets\_response to filter
transport types that don't match.
Signed-off-by: Sagi Grimberg
Reported-by: Slava Shwartsman
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit a689f31e5332814090a07048285055971df1289f
Author: Nicholas Bellinger
Date: Tue Jun 10 04:03:54 2014 +0000
iscsi-target: Fix ABORT\_TASK + connection reset iscsi\_queue\_req memory leak
commit bbc050488525e1ab1194c27355f63c66814385b8 upstream.
This patch fixes a iscsi\_queue\_req memory leak when ABORT\_TASK response
has been queued by TFO->queue\_tm\_rsp() -> lio\_queue\_tm\_rsp() after a
long standing I/O completes, but the connection has already reset and
waiting for cleanup to complete in iscsit\_release\_commands\_from\_conn()
-> transport\_generic\_free\_cmd() -> transport\_wait\_for\_tasks() code.
It moves iscsit\_free\_queue\_reqs\_for\_conn() after the per-connection command
list has been released, so that the associated se\_cmd tag can be completed +
released by target-core before freeing any remaining iscsi\_queue\_req memory
for the connection generated by lio\_queue\_tm\_rsp().
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit e7a5dc06baf4bc53efa1496821d24953c4636cb4
Author: Nicholas Bellinger
Date: Mon Jun 9 23:36:51 2014 +0000
target: Use complete\_all for se\_cmd->t\_transport\_stop\_comp
commit a95d6511303b848da45ee27b35018bb58087bdc6 upstream.
This patch fixes a bug where multiple waiters on ->t\_transport\_stop\_comp
occurs due to a concurrent ABORT\_TASK and session reset both invoking
transport\_wait\_for\_tasks(), while waiting for the associated se\_cmd
descriptor backend processing to complete.
For this case, complete\_all() should be invoked in order to wake up
both waiters in core\_tmr\_abort\_task() + transport\_generic\_free\_cmd()
process contexts.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit bf7caca1f32d6fc1671a435345896d73aa136051
Author: Nicholas Bellinger
Date: Mon Jun 9 23:13:20 2014 +0000
target: Set CMD\_T\_ACTIVE bit for Task Management Requests
commit f15e9cd910c4d9da7de43f2181f362082fc45f0f upstream.
This patch fixes a bug where se\_cmd descriptors associated with a
Task Management Request (TMR) where not setting CMD\_T\_ACTIVE before
being dispatched into target\_tmr\_work() process context.
This is required in order for transport\_generic\_free\_cmd() ->
transport\_wait\_for\_tasks() to wait on se\_cmd->t\_transport\_stop\_comp
if a session reset event occurs while an ABORT\_TASK is outstanding
waiting for another I/O to complete.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit c75a5476ee099f5534402c6b42d34c89f7acb31c
Author: Sagi Grimberg
Date: Mon May 19 17:44:25 2014 +0300
Target/iser: Wait for proper cleanup before unloading
commit f5ebec9629cf78eeeea4b8258882a9f439ab2404 upstream.
disconnected\_handler works are scheduled on system\_wq.
When attempting to unload, first make sure all works
have cleaned up.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 555470b4c5fd168bebf2f758bc727dca9ca8af69
Author: Sagi Grimberg
Date: Mon May 19 17:44:24 2014 +0300
Target/iser: Improve cm events handling
commit 88c4015fda6d014392f76d3b1688347950d7a12d upstream.
There are 4 RDMA\_CM events that all basically mean that
the user should teardown the IB connection:
- DISCONNECTED
- ADDR\_CHANGE
- DEVICE\_REMOVAL
- TIMEWAIT\_EXIT
Only in DISCONNECTED/ADDR\_CHANGE it makes sense to
call rdma\_disconnect (send DREQ/DREP to our initiator).
So we keep the same teardown handler for all of them
but only indicate calling rdma\_disconnect for the relevant
events.
This patch also removes redundant debug prints for each single
event.
v2 changes:
- Call isert\_disconnected\_handler() for DEVICE\_REMOVAL (Or + Sag)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 35eceed62f3b9977c9dc7e9f122faef8379f873a
Author: Sagi Grimberg
Date: Mon May 19 17:44:23 2014 +0300
Target/iser: Fix hangs in connection teardown
commit 9d49f5e284e700576f3b65f1e28dea8539da6661 upstream.
In ungraceful teardowns isert close flows seem racy such that
isert\_wait\_conn hangs as RDMA\_CM\_EVENT\_DISCONNECTED never
gets invoked (no one called rdma\_disconnect).
Both graceful and ungraceful teardowns will have rx flush errors
(isert posts a batch once connection is established). Once all
flush errors are consumed we invoke isert\_wait\_conn and it will
be responsible for calling rdma\_disconnect. This way it can be
sure that rdma\_disconnect was called and it won't wait forever.
This patch also removes the logout\_posted indicator. either the
logout completion was consumed and no problem decrementing the
post\_send\_buf\_count, or it was consumed as a flush error. no point
of keeping it for isert\_wait\_conn as there is no danger that
isert\_conn will be accidentally removed while it is running.
(Drop unnecessary sleep\_on\_conn\_wait\_comp check in
isert\_cq\_rx\_comp\_err - nab)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 3e41b2b57122819ee833ae377ff125dd13d973a2
Author: Sagi Grimberg
Date: Mon May 19 17:44:22 2014 +0300
Target/iser: Bail from accept\_np if np\_thread is trying to close
commit e346ab343f4f58c12a96725c7b13df9cc2ad56f6 upstream.
In case np\_thread state is in RESET/SHUTDOWN/EXIT states,
no point for isert to stall there as we may get a hang in
case no one will wake it up later.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 951bc3714aa86d08878bd5f71b1e124d87a80c5b
Author: Jukka Taimisto
Date: Thu May 22 10:02:39 2014 +0000
Bluetooth: Fix L2CAP deadlock
commit 8a96f3cd22878fc0bb564a8478a6e17c0b8dca73 upstream.
-[0x01 Introduction
We have found a programming error causing a deadlock in Bluetooth subsystem
of Linux kernel. The problem is caused by missing release\_sock() call when
L2CAP connection creation fails due full accept queue.
The issue can be reproduced with 3.15-rc5 kernel and is also present in
earlier kernels.
-[0x02 Details
The problem occurs when multiple L2CAP connections are created to a PSM which
contains listening socket (like SDP) and left pending, for example,
configuration (the underlying ACL link is not disconnected between
connections).
When L2CAP connection request is received and listening socket is found the
l2cap\_sock\_new\_connection\_cb() function (net/bluetooth/l2cap\_sock.c) is called.
This function locks the 'parent' socket and then checks if the accept queue
is full.
1178 lock\_sock(parent);
1179
1180 /\* Check for backlog size \*/
1181 if (sk\_acceptq\_is\_full(parent)) {
1182 BT\_DBG("backlog full %d", parent->sk\_ack\_backlog);
1183 return NULL;
1184 }
If case the accept queue is full NULL is returned, but the 'parent' socket
is not released. Thus when next L2CAP connection request is received the code
blocks on lock\_sock() since the parent is still locked.
Also note that for connections already established and waiting for
configuration to complete a timeout will occur and l2cap\_chan\_timeout()
(net/bluetooth/l2cap\_core.c) will be called. All threads calling this
function will also be blocked waiting for the channel mutex since the thread
which is waiting on lock\_sock() alread holds the channel mutex.
We were able to reproduce this by sending continuously L2CAP connection
request followed by disconnection request containing invalid CID. This left
the created connections pending configuration.
After the deadlock occurs it is impossible to kill bluetoothd, btmon will not
get any more data etc. requiring reboot to recover.
-[0x03 Fix
Releasing the 'parent' socket when l2cap\_sock\_new\_connection\_cb() returns NULL
seems to fix the issue.
Signed-off-by: Jukka Taimisto
Reported-by: Tommi Mäkilä
Signed-off-by: Johan Hedberg
Signed-off-by: Greg Kroah-Hartman
commit ab4910d04cdcce17e4d9af172ba80b2b05a0cdc2
Author: Jukka Rissanen
Date: Tue May 27 11:33:22 2014 +0300
Bluetooth: 6LoWPAN: Fix MAC address universal/local bit handling
commit 62bbd5b35994eaf30519f126765d7f6af9cd3526 upstream.
The universal/local bit handling was incorrectly done in the code.
So when setting EUI address from BD address we do this:
- If BD address type is PUBLIC, then we clear the universal bit
in EUI address. If the address type is RANDOM, then the universal
bit is set (BT 6lowpan draft chapter 3.2.2)
- After this we invert the universal/local bit according to RFC 2464
When figuring out BD address we do the reverse:
- Take EUI address from stateless IPv6 address, invert the
universal/local bit according to RFC 2464
- If universal bit is 1 in this modified EUI address, then address
type is set to RANDOM, otherwise it is PUBLIC
Note that 6lowpan\_iphc.[ch] does the final toggling of U/L bit
before sending or receiving the network packet.
Signed-off-by: Jukka Rissanen
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit 79319c68a2b76ebe34fc69dd52c67d47c06b9413
Author: Felipe Balbi
Date: Wed Apr 23 09:58:26 2014 -0500
bluetooth: hci\_ldisc: fix deadlock condition
commit da64c27d3c93ee9f89956b9de86c4127eb244494 upstream.
LDISCs shouldn't call tty->ops->write() from within
->write\_wakeup().
->write\_wakeup() is called with port lock taken and
IRQs disabled, tty->ops->write() will try to acquire
the same port lock and we will deadlock.
Acked-by: Marcel Holtmann
Reviewed-by: Peter Hurley
Reported-by: Huang Shijie
Signed-off-by: Felipe Balbi
Tested-by: Andreas Bießmann
Signed-off-by: Greg Kroah-Hartman
commit 703d671298a54a293776aa88474b601fc480292a
Author: Chander Kashyap
Date: Fri May 16 16:21:17 2014 +0530
PM / OPP: fix incorrect OPP count handling in of\_init\_opp\_table
commit 086abb58590a4df73e8a6ed71fd418826937cd46 upstream.
In of\_init\_opp\_table function, if a failure to add an OPP is
detected, the count of OPPs, yet to be added is not updated.
Fix this by decrementing this count on failure as well.
Signed-off-by: Chander Kashyap
Signed-off-by: Inderpal Singh
Acked-by: Viresh Kumar
Acked-by: Nishanth Menon
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit d4a06c59dfeb4012c13a113a450de5cc07dbad36
Author: Jianguo Wu
Date: Thu Apr 24 03:45:56 2014 +0100
ARM: 8037/1: mm: support big-endian page tables
commit 86f40622af7329375e38f282f6c0aab95f3e5f72 upstream.
When enable LPAE and big-endian in a hisilicon board, while specify
mem=384M mem=512M@7680M, will get bad page state:
Freeing unused kernel memory: 180K (c0466000 - c0493000)
BUG: Bad page state in process init pfn:fa442
page:c7749840 count:0 mapcount:-1 mapping: (null) index:0x0
page flags: 0x40000400(reserved)
Modules linked in:
CPU: 0 PID: 1 Comm: init Not tainted 3.10.27+ #66
[] (unwind\_backtrace+0x0/0x11c) from [] (show\_stack+0x10/0x14)
[] (show\_stack+0x10/0x14) from [] (bad\_page+0xd4/0x104)
[] (bad\_page+0xd4/0x104) from [] (free\_pages\_prepare+0xa8/0x14c)
[] (free\_pages\_prepare+0xa8/0x14c) from [] (free\_hot\_cold\_page+0x18/0xf0)
[] (free\_hot\_cold\_page+0x18/0xf0) from [] (handle\_pte\_fault+0xcf4/0xdc8)
[] (handle\_pte\_fault+0xcf4/0xdc8) from [] (handle\_mm\_fault+0xf4/0x120)
[] (handle\_mm\_fault+0xf4/0x120) from [] (do\_page\_fault+0xfc/0x354)
[] (do\_page\_fault+0xfc/0x354) from [] (do\_DataAbort+0x2c/0x90)
[] (do\_DataAbort+0x2c/0x90) from [] (\_\_dabt\_usr+0x34/0x40)
The bad pfn:fa442 is not system memory(mem=384M mem=512M@7680M), after debugging,
I find in page fault handler, will get wrong pfn from pte just after set pte,
as follow:
do\_anonymous\_page()
{
...
set\_pte\_at(mm, address, page\_table, entry);
//debug code
pfn = pte\_pfn(entry);
pr\_info("pfn:0x%lx, pte:0x%llxn", pfn, pte\_val(entry));
//read out the pte just set
new\_pte = pte\_offset\_map(pmd, address);
new\_pfn = pte\_pfn(\*new\_pte);
pr\_info("new pfn:0x%lx, new pte:0x%llxn", pfn, pte\_val(entry));
...
}
pfn: 0x1fa4f5, pte:0xc00001fa4f575f
new\_pfn:0xfa4f5, new\_pte:0xc00000fa4f5f5f //new pfn/pte is wrong.
The bug is happened in cpu\_v7\_set\_pte\_ext(ptep, pte):
An LPAE PTE is a 64bit quantity, passed to cpu\_v7\_set\_pte\_ext in the r2 and r3 registers.
On an LE kernel, r2 contains the LSB of the PTE, and r3 the MSB.
On a BE kernel, the assignment is reversed.
Unfortunately, the current code always assumes the LE case,
leading to corruption of the PTE when clearing/setting bits.
This patch fixes this issue much like it has been done already in the
cpu\_v7\_switch\_mm case.
Signed-off-by: Jianguo Wu
Acked-by: Marc Zyngier
Acked-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 1f90722f9f6329710ecaa52d96adeba7c01b2808
Author: Russell King
Date: Sat May 3 11:03:28 2014 +0100
ARM: stacktrace: avoid listing stacktrace functions in stacktrace
commit 3683f44c42e991d313dc301504ee0fca1aeb8580 upstream.
While debugging the FEC ethernet driver using stacktrace, it was noticed
that the stacktraces always begin as follows:
[] save\_stack\_trace\_tsk+0x0/0x98
[] save\_stack\_trace+0x24/0x28
...
This is because the stack trace code includes the stack frames for itself.
This is incorrect behaviour, and also leads to "skip" doing the wrong
thing (which is the number of stack frames to avoid recording.)
Perversely, it does the right thing when passed a non-current thread. Fix
this by ensuring that we have a known constant number of frames above the
main stack trace function, and always skip these.
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 8fad854f23f319248d7533cb92896a3527c99719
Author: Hans Verkuil
Date: Thu Apr 17 07:24:31 2014 -0300
media: saa7134: fix regression with tvtime
commit 17e7f1b515803e1a79b246688aacbddd2e34165d upstream.
This solves this bug:
https://bugzilla.kernel.org/show\_bug.cgi?id=73361
The problem is that when you quit tvtime it calls STREAMOFF, but then it queues a
bunch of buffers for no good reason before closing the file descriptor.
In the past closing the fd would free the vb queue since that was part of the file
handle struct. Since that was moved to the global struct that no longer happened.
This wouldn't be a problem, but the extra QBUF calls that tvtime does meant that
the buffer list in videobuf (q->stream) contained buffers, so REQBUFS would fail
with -EBUSY.
The solution is to init the list head explicitly when releasing the file
descriptor and to not free the video resource when calling streamoff.
The real fix will hopefully go into kernel 3.16 when the vb2 conversion is
merged. Basically the saa7134 driver with the old videobuf is so full of holes it
ain't funny anymore, so consider this a band-aid for kernels 3.14 and 15.
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 6623dc0fb3e7587c9f48bdebd3e98877d69ff299
Author: Pali Rohár
Date: Tue Apr 22 12:02:39 2014 -0300
media: radio-bcm2048: fix wrong overflow check
commit 5d60122b7e30f275593df93b39a76d3c2663cfc2 upstream.
This patch fixes an off by one check in bcm2048\_set\_region().
Reported-by: Dan Carpenter
Signed-off-by: Pali Rohár
Signed-off-by: Pavel Machek
Signed-off-by: Dan Carpenter
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 66065ef0ff9ac1bde89a13346426b6c506abca59
Author: Olivier Langlois
Date: Fri Mar 28 02:42:38 2014 -0300
media: uvcvideo: Fix clock param realtime setting
commit 3b35fc81e7ec552147a4fd843d0da0bbbe4ef253 upstream.
timestamps in v4l2 buffers returned to userspace are updated in
uvc\_video\_clock\_update() which uses timestamps fetched from
uvc\_video\_clock\_decode() by calling unconditionally ktime\_get\_ts().
Hence setting the module clock param to realtime has no effect before
this patch.
This has been tested with ffmpeg:
ffmpeg -y -f v4l2 -input\_format yuyv422 -video\_size 640x480 -framerate 30 -i /dev/video0 \
-f alsa -acodec pcm\_s16le -ar 16000 -ac 1 -i default \
-c:v libx264 -preset ultrafast \
-c:a libfdk\_aac \
out.mkv
and inspecting the v4l2 input starting timestamp.
Signed-off-by: Olivier Langlois
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 01b8eab1cc72c9339974fcee698515042d05f9b3
Author: Thomas Gleixner
Date: Wed Jun 11 18:44:04 2014 +0000
rtmutex: Plug slow unlock race
commit 27e35715df54cbc4f2d044f681802ae30479e7fb upstream.
When the rtmutex fast path is enabled the slow unlock function can
create the following situation:
spin\_lock(foo->m->wait\_lock);
foo->m->owner = NULL;
rt\_mutex\_lock(foo->m); <-- fast path
free = atomic\_dec\_and\_test(foo->refcnt);
rt\_mutex\_unlock(foo->m); <-- fast path
if (free)
kfree(foo);
spin\_unlock(foo->m->wait\_lock); <--- Use after free.
Plug the race by changing the slow unlock to the following scheme:
while (!rt\_mutex\_has\_waiters(m)) {
/\* Clear the waiters bit in m->owner \*/
clear\_rt\_mutex\_waiters(m);
owner = rt\_mutex\_owner(m);
spin\_unlock(m->wait\_lock);
if (cmpxchg(m->owner, owner, 0) == owner)
return;
spin\_lock(m->wait\_lock);
}
So in case of a new waiter incoming while the owner tries the slow
path unlock we have two situations:
unlock(wait\_lock);
lock(wait\_lock);
cmpxchg(p, owner, 0) == owner
mark\_rt\_mutex\_waiters(lock);
acquire(lock);
Or:
unlock(wait\_lock);
lock(wait\_lock);
mark\_rt\_mutex\_waiters(lock);
cmpxchg(p, owner, 0) != owner
enqueue\_waiter();
unlock(wait\_lock);
lock(wait\_lock);
wakeup\_next waiter();
unlock(wait\_lock);
lock(wait\_lock);
acquire(lock);
If the fast path is disabled, then the simple
m->owner = NULL;
unlock(m->wait\_lock);
is sufficient as all access to m->owner is serialized via
m->wait\_lock;
Also document and clarify the wakeup\_next\_waiter function as suggested
by Oleg Nesterov.
Reported-by: Steven Rostedt
Signed-off-by: Thomas Gleixner
Reviewed-by: Steven Rostedt
Cc: Peter Zijlstra
Link: http://lkml.kernel.org/r/20140611183852.937945560@linutronix.de
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit fb52f40e085ef4074f1335672cd62c1f832af13b
Author: Thomas Gleixner
Date: Thu Jun 5 12:34:23 2014 +0200
rtmutex: Handle deadlock detection smarter
commit 3d5c9340d1949733eb37616abd15db36aef9a57c upstream.
Even in the case when deadlock detection is not requested by the
caller, we can detect deadlocks. Right now the code stops the lock
chain walk and keeps the waiter enqueued, even on itself. Silly not to
yell when such a scenario is detected and to keep the waiter enqueued.
Return -EDEADLK unconditionally and handle it at the call sites.
The futex calls return -EDEADLK. The non futex ones dequeue the
waiter, throw a warning and put the task into a schedule loop.
Tagged for stable as it makes the code more robust.
Signed-off-by: Thomas Gleixner
Cc: Steven Rostedt
Cc: Peter Zijlstra
Cc: Brad Mouring
Link: http://lkml.kernel.org/r/20140605152801.836501969@linutronix.de
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 2fff347cce2d1538556ab3127f7224f6b522575e
Author: Thomas Gleixner
Date: Thu Jun 5 11:16:12 2014 +0200
rtmutex: Detect changes in the pi lock chain
commit 82084984383babe728e6e3c9a8e5c46278091315 upstream.
When we walk the lock chain, we drop all locks after each step. So the
lock chain can change under us before we reacquire the locks. That's
harmless in principle as we just follow the wrong lock path. But it
can lead to a false positive in the dead lock detection logic:
T0 holds L0
T0 blocks on L1 held by T1
T1 blocks on L2 held by T2
T2 blocks on L3 held by T3
T4 blocks on L4 held by T4
Now we walk the chain
lock T1 -> lock L2 -> adjust L2 -> unlock T1 ->
lock T2 -> adjust T2 -> drop locks
T2 times out and blocks on L0
Now we continue:
lock T2 -> lock L0 -> deadlock detected, but it's not a deadlock at all.
Brad tried to work around that in the deadlock detection logic itself,
but the more I looked at it the less I liked it, because it's crystal
ball magic after the fact.
We actually can detect a chain change very simple:
lock T1 -> lock L2 -> adjust L2 -> unlock T1 -> lock T2 -> adjust T2 ->
next\_lock = T2->pi\_blocked\_on->lock;
drop locks
T2 times out and blocks on L0
Now we continue:
lock T2 ->
if (next\_lock != T2->pi\_blocked\_on->lock)
return;
So if we detect that T2 is now blocked on a different lock we stop the
chain walk. That's also correct in the following scenario:
lock T1 -> lock L2 -> adjust L2 -> unlock T1 -> lock T2 -> adjust T2 ->
next\_lock = T2->pi\_blocked\_on->lock;
drop locks
T3 times out and drops L3
T2 acquires L3 and blocks on L4 now
Now we continue:
lock T2 ->
if (next\_lock != T2->pi\_blocked\_on->lock)
return;
We don't have to follow up the chain at that point, because T2
propagated our priority up to T4 already.
[ Folded a cleanup patch from peterz ]
Signed-off-by: Thomas Gleixner
Reported-by: Brad Mouring
Cc: Steven Rostedt
Cc: Peter Zijlstra
Link: http://lkml.kernel.org/r/20140605152801.930031935@linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 3dd4627f51cd62ccb8bcfcdd069b041a102711e7
Author: Lv Zheng
Date: Mon May 12 15:50:16 2014 +0800
ACPI: Fix conflict between customized DSDT and DSDT local copy
commit 73577d1df8e1f31f6b1a5eebcdbc334eb0330e47 upstream.
This patch fixes the following issue:
If DSDT is customized, no local DSDT copy is needed.
References: https://bugzilla.kernel.org/show\_bug.cgi?id=69711
Signed-off-by: Enrico Etxe Arte
Signed-off-by: Lv Zheng
[rjw: Subject]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit f445789dcf3896215254dec320ac91cd69f7b61f
Author: David Binderman
Date: Fri Apr 4 12:36:55 2014 +0800
ACPICA: utstring: Check array index bound before use.
commit 5d42b0fa25df7ef2f575107597c1aaebe2407d10 upstream.
ACPICA BZ 1077. David Binderman.
References: https://bugs.acpica.org/show\_bug.cgi?id=1077
Signed-off-by: David Binderman
Signed-off-by: Bob Moore
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 2c9b8a2ba1b6ccc9ef52b79e0312bae276b3c705
Author: Bjørn Mork
Date: Thu May 22 12:47:47 2014 +0200
ACPI: add dynamic\_debug support
commit 45fef5b88d1f2f47ecdefae6354372d440ca5c84 upstream.
Commit 1a699476e258 ("ACPI / hotplug / PCI: Hotplug notifications
from acpi\_bus\_notify()") added debug messages for a few common
events. These debug messages are unconditionally enabled if
CONFIG\_DYNAMIC\_DEBUG is defined, contrary to the documented
meaning, making the ACPI system spew lots of unwanted noise on
any kernel with dynamic debugging.
The bug was introduced by commit fbfddae69657 ("ACPI: Add
acpi\_handle\_() interfaces"), which added the
CONFIG\_DYNAMIC\_DEBUG dependency without respecting its meaning.
Fix by adding real support for dynamic\_debug.
Fixes: fbfddae69657 ("ACPI: Add acpi\_handle\_() interfaces")
Signed-off-by: Bjørn Mork
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 1bae99bdf42d4587b5cbe2ec255975abb83f882c
Author: Ezequiel Garcia
Date: Thu Apr 17 09:28:20 2014 -0300
media: stk1160: Avoid stack-allocated buffer for control URBs
commit 85ac1a1772bb41da895bad83a81f6a62c8f293f6 upstream.
Currently stk1160\_read\_reg() uses a stack-allocated char to get the
read control value. This is wrong because usb\_control\_msg() requires
a kmalloc-ed buffer.
This commit fixes such issue by kmalloc'ating a 1-byte buffer to receive
the read value.
While here, let's remove the urb\_buf array which was meant for a similar
purpose, but never really used.
Cc: Alan Stern
Reported-by: Sander Eikelenboom
Signed-off-by: Ezequiel Garcia
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit edf9ebfc0e9cb7058d97cffadee22f5aa94cc19e
Author: Takashi Iwai
Date: Mon May 5 11:20:05 2014 -0300
media: ivtv: Fix Oops when no firmware is loaded
commit deb29e90221a6d4417aa67be971613c353180331 upstream.
When ivtv PCM device is accessed at the state where no firmware is
loaded, it oopses like:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000050
IP: [] try\_mailbox.isra.0+0x11/0x50 [ivtv]
Call Trace:
[] ivtv\_api\_call+0x160/0x6b0 [ivtv]
[] ivtv\_api+0x16/0x40 [ivtv]
[] ivtv\_vapi+0xac/0xc0 [ivtv]
[] ivtv\_start\_v4l2\_encode\_stream+0x19d/0x630 [ivtv]
[] snd\_ivtv\_pcm\_capture\_open+0x173/0x1c0 [ivtv\_alsa]
[] snd\_pcm\_open\_substream+0x51/0x100 [snd\_pcm]
[] snd\_pcm\_open+0xb3/0x260 [snd\_pcm]
[] snd\_pcm\_capture\_open+0x37/0x50 [snd\_pcm]
[] snd\_open+0xa7/0x1e0 [snd]
[] chrdev\_open+0x88/0x1d0
[] do\_dentry\_open+0x1de/0x270
[] do\_last+0x1c3/0xec0
[] path\_openat+0xb6/0x670
[] do\_filp\_open+0x35/0x80
[] do\_sys\_open+0x129/0x210
[] system\_call\_fastpath+0x1a/0x1f
This patch adds the check of firmware at PCM open callback like other
open callbacks of this driver.
Bugzilla: https://apibugzilla.novell.com/show\_bug.cgi?id=875440
Signed-off-by: Takashi Iwai
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit f95809545bc634388a3e82c2a9088fe931feccf4
Author: Johan Hovold
Date: Mon May 26 19:23:33 2014 +0200
USB: serial: fix potential runtime pm imbalance at device remove
commit c14829fad88dbeda57253590695b85ba51270621 upstream.
Only call usb\_autopm\_put\_interface() if the corresponding
usb\_autopm\_get\_interface() was successful.
This prevents a potential runtime PM counter imbalance should
usb\_autopm\_get\_interface() fail. Note that the USB PM usage counter is
reset when the interface is unbound, but that the runtime PM counter may
be left unbalanced.
Also add comment on why we don't need to worry about racing
resume/suspend on autopm\_get failures.
Fixes: d5fd650cfc7f ("usb: serial: prevent suspend/resume from racing
against probe/remove")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b9b8bcc97d19a3175e715474c770b3521764c6c9
Author: Aleksander Morgado
Date: Thu May 29 13:33:27 2014 +0200
usb: qcserial: add additional Sierra Wireless QMI devices
commit 0ce5fb58564fd85aa8fd2d24209900e2e845317b upstream.
A set of new VID/PIDs retrieved from the out-of-tree GobiNet/GobiSerial
Sierra Wireless drivers.
Signed-off-by: Aleksander Morgado
Link: http://marc.info/?l=linux-usb&m=140136310027293&w=2
Cc:  # backport in link above
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit dcc3c3c8c7fe242c7366960d7471eb33afc8afb7
Author: Aleksander Morgado
Date: Wed May 28 21:13:51 2014 +0200
usb: qcserial: add Netgear AirCard 341U
commit ff1fcd50bc2459744e6f948310bc18eb7d6e8c72 upstream.
Signed-off-by: Aleksander Morgado
Signed-off-by: Greg Kroah-Hartman
commit e7a35d5201fae8a4ffcadfd2514d3f0982a7d60f
Author: Johan Hovold
Date: Mon May 26 19:22:54 2014 +0200
USB: sierra: fix remote wakeup
commit 80cc0fcbdaeaf10d04ba27779a2d7ceb73d2717a upstream.
Make sure that needs\_remote\_wake up is always set when there are open
ports.
Currently close() would unconditionally set needs\_remote\_wakeup to 0
even though there might still be open ports. This could lead to blocked
input and possibly dropped data on devices that do not support remote
wakeup (and which must therefore not be runtime suspended while open).
Add an open\_ports counter (protected by the susp\_lock) and only clear
needs\_remote\_wakeup when the last port is closed.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 0d014638d7ce7862b68fe890e09716dfbc7e1979
Author: Johan Hovold
Date: Mon May 26 19:22:53 2014 +0200
USB: sierra: fix urb and memory leak on disconnect
commit 014333f77c0b71123d6ef7d31a9724e0699c9548 upstream.
The delayed-write queue was never emptied on disconnect, something which
would lead to leaked urbs and transfer buffers if the device is
disconnected before being runtime resumed due to a write.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit df0f29712e67be45d6d988d18ce1404d3facea1f
Author: Johan Hovold
Date: Mon May 26 19:22:52 2014 +0200
USB: sierra: fix urb and memory leak in resume error path
commit 7fdd26a01eb7b6cb6855ff8f69ef4a720720dfcb upstream.
Neither the transfer buffer or the urb itself were released in the
resume error path for delayed writes. Also on errors, the remainder of
the queue was not even processed, which leads to further urb and buffer
leaks.
The same error path also failed to balance the outstanding-urb counter,
something which results in degraded throughput or completely blocked
writes.
Fix this by releasing urb and buffer and balancing counters on errors,
and by always processing the whole queue even when submission of one urb
fails.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 10e639f76a79236801e37b62ec65684c7f69d053
Author: Johan Hovold
Date: Mon May 26 19:22:51 2014 +0200
USB: sierra: fix use after free at suspend/resume
commit 8452727de70f6ad850cd6d0aaa18b5d9050aa63b upstream.
Fix use after free or NULL-pointer dereference during suspend and
resume.
The port data may never have been allocated (port probe failed)
or may already have been released by port\_remove (e.g. driver is
unloaded) when suspend and resume are called.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 37e792dfe6ed8c002874bdd470a325dd55f12d6b
Author: Johan Hovold
Date: Mon May 26 19:22:50 2014 +0200
USB: sierra: fix AA deadlock in open error path
commit 353fe198602e8b4d1c7bdcceb8e60955087201b1 upstream.
Fix AA deadlock in open error path that would call close() and try to
grab the already held disc\_mutex.
Fixes: b9a44bc19f48 ("sierra: driver urb handling improvements")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 04d561b78d0ef52d8035778290e767a686dd8888
Author: Johan Hovold
Date: Mon May 26 19:23:18 2014 +0200
USB: usb\_wwan: fix potential blocked I/O after resume
commit fb7ad4f93d9f0f7d49beda32f5e7becb94b29a4d upstream.
Keep trying to submit urbs rather than bail out on first read-urb
submission error, which would also prevent I/O for any further ports
from being resumed.
Instead keep an error count, for all types of failed submissions, and
let USB core know that something went wrong.
Also make sure to always clear the suspended flag. Currently a failed
read-urb submission would prevent cached writes as well as any
subsequent writes from being submitted until next suspend-resume cycle,
something which may not even necessarily happen.
Note that USB core currently only logs an error if an interface resume
failed.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit dd38b5062df92e69afa4437d952c7194c6bfd6f5
Author: Johan Hovold
Date: Mon May 26 19:23:17 2014 +0200
USB: usb\_wwan: fix potential NULL-deref at resume
commit 9096f1fbba916c2e052651e9de82fcfb98d4bea7 upstream.
The interrupt urb was submitted unconditionally at resume, something
which could lead to a NULL-pointer dereference in the urb completion
handler as resume may be called after the port and port data is gone.
Fix this by making sure the interrupt urb is only submitted and active
when the port is open.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 582e7e5f9cc0d35e56bfb5e79f242d9e5dd317ba
Author: Johan Hovold
Date: Mon May 26 19:23:16 2014 +0200
USB: usb\_wwan: fix urb leak at shutdown
commit 79eed03e77d481b55d85d1cfe5a1636a0d3897fd upstream.
The delayed-write queue was never emptied at shutdown (close), something
which could lead to leaked urbs if the port is closed before being
runtime resumed due to a write.
When this happens the output buffer would not drain on close
(closing\_wait timeout), and after consecutive opens, writes could be
corrupted with previously buffered data, transfered with reduced
throughput or completely blocked.
Note that unbusy\_queued\_urb() was simply moved out of CONFIG\_PM.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 5a77e53bb1cb996391ab1feb898b6ffb0657f96f
Author: Johan Hovold
Date: Mon May 26 19:23:15 2014 +0200
USB: usb\_wwan: fix write and suspend race
commit 170fad9e22df0063eba0701adb966786d7a4ec5a upstream.
Fix race between write() and suspend() which could lead to writes being
dropped (or I/O while suspended) if the device is runtime suspended
while a write request is being processed.
Specifically, suspend() releases the susp\_lock after determining the
device is idle but before setting the suspended flag, thus leaving a
window where a concurrent write() can submit an urb.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 2f59a10cb390aaa74dda48ca73214d8ce52d3c2b
Author: xiao jin
Date: Mon May 26 19:23:14 2014 +0200
USB: usb\_wwan: fix race between write and resume
commit d9e93c08d8d985e5ef89436ebc9f4aad7e31559f upstream.
We find a race between write and resume. usb\_wwan\_resume run play\_delayed()
and spin\_unlock, but intfdata->suspended still is not set to zero.
At this time usb\_wwan\_write is called and anchor the urb to delay
list. Then resume keep running but the delayed urb have no chance
to be commit until next resume. If the time of next resume is far
away, tty will be blocked in tty\_wait\_until\_sent during time. The
race also can lead to writes being reordered.
This patch put play\_Delayed and intfdata->suspended together in the
spinlock, it's to avoid the write race during resume.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 2bcee6d0ec6d18fff28b36d230d3ecff1778ecc2
Author: xiao jin
Date: Mon May 26 19:23:13 2014 +0200
USB: usb\_wwan: fix urb leak in write error path
commit db0904737947d509844e171c9863ecc5b4534005 upstream.
When enable usb serial for modem data, sometimes the tty is blocked
in tty\_wait\_until\_sent because portdata->out\_busy always is set and
have no chance to be cleared.
We find a bug in write error path. usb\_wwan\_write set portdata->out\_busy
firstly, then try autopm async with error. No out urb submit and no
usb\_wwan\_outdat\_callback to this write, portdata->out\_busy can't be
cleared.
This patch clear portdata->out\_busy if usb\_wwan\_write try autopm async
with error.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 4d7d9fb81084361ece363d6038bde2fdf9e9d510
Author: Mikulas Patocka
Date: Thu May 15 06:58:24 2014 -0400
matroxfb: perform a dummy read of M\_STATUS
commit 972754cfaee94d6e25acf94a497bc0a864d91b7e upstream.
I had occasional screen corruption with the matrox framebuffer driver and
I found out that the reason for the corruption is that the hardware
blitter accesses the videoram while it is being written to.
The matrox driver has a macro WaitTillIdle() that should wait until the
blitter is idle, but it sometimes doesn't work. I added a dummy read
mga\_inl(M\_STATUS) to WaitTillIdle() to fix the problem. The dummy read
will flush the write buffer in the PCI chipset, and the next read of
M\_STATUS will return the hardware status.
Since applying this patch, I had no screen corruption at all.
Signed-off-by: Mikulas Patocka
Signed-off-by: Tomi Valkeinen
Signed-off-by: Greg Kroah-Hartman
commit 04e0002916df7668303e9ec855709327352fc9a2
Author: Maurizio Lombardi
Date: Tue May 27 12:48:56 2014 -0400
ext4: fix wrong assert in ext4\_mb\_normalize\_request()
commit b5b60778558cafad17bbcbf63e0310bd3c68eb17 upstream.
The variable "size" is expressed as number of blocks and not as
number of clusters, this could trigger a kernel panic when using
ext4 with the size of a cluster different from the size of a block.
Signed-off-by: Maurizio Lombardi
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 28f26f6de7c4a171ff82166a09c0dafb2f936b15
Author: Jan Kara
Date: Tue May 27 12:48:55 2014 -0400
ext4: fix zeroing of page during writeback
commit eeece469dedadf3918bad50ad80f4616a0064e90 upstream.
Tail of a page straddling inode size must be zeroed when being written
out due to POSIX requirement that modifications of mmaped page beyond
inode size must not be written to the file. ext4\_bio\_write\_page() did
this only for blocks fully beyond inode size but didn't properly zero
blocks partially beyond inode size. Fix this.
The problem has been uncovered by mmap\_11-4 test in openposix test suite
(part of LTP).
Reported-by: Xiaoguang Wang
Fixes: 5a0dc7365c240
Fixes: bd2d0210cf22f
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit dc2acd78c1488bc228ee335dee311ec6caab26e8
Author: Namjae Jeon
Date: Mon May 12 08:12:25 2014 -0400
ext4: fix data integrity sync in ordered mode
commit 1c8349a17137b93f0a83f276c764a6df1b9a116e upstream.
When we perform a data integrity sync we tag all the dirty pages with
PAGECACHE\_TAG\_TOWRITE at start of ext4\_da\_writepages. Later we check
for this tag in write\_cache\_pages\_da and creates a struct
mpage\_da\_data containing contiguously indexed pages tagged with this
tag and sync these pages with a call to mpage\_da\_map\_and\_submit. This
process is done in while loop until all the PAGECACHE\_TAG\_TOWRITE
pages are synced. We also do journal start and stop in each iteration.
journal\_stop could initiate journal commit which would call
ext4\_writepage which in turn will call ext4\_bio\_write\_page even for
delayed OR unwritten buffers. When ext4\_bio\_write\_page is called for
such buffers, even though it does not sync them but it clears the
PAGECACHE\_TAG\_TOWRITE of the corresponding page and hence these pages
are also not synced by the currently running data integrity sync. We
will end up with dirty pages although sync is completed.
This could cause a potential data loss when the sync call is followed
by a truncate\_pagecache call, which is exactly the case in
collapse\_range. (It will cause generic/127 failure in xfstests)
To avoid this issue, we can use set\_page\_writeback\_keepwrite instead of
set\_page\_writeback, which doesn't clear TOWRITE tag.
Signed-off-by: Namjae Jeon
Signed-off-by: Ashish Sangwan
Signed-off-by: "Theodore Ts'o"
Reviewed-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit aa7de1cc6e21fcc2f72e752884214e1bb6479596
Author: Christian Borntraeger
Date: Mon May 26 21:55:08 2014 +0200
s390/lowcore: reserve 96 bytes for IRB in lowcore
commit 993072ee67aa179c48c85eb19869804e68887d86 upstream.
The IRB might be 96 bytes if the extended-I/O-measurement facility is
used. This feature is currently not used by Linux, but struct irb
already has the emw defined. So let's make the irb in lowcore match the
size of the internal data structure to be future proof.
We also have to add a pad, to correctly align the paste.
The bigger irb field also circumvents a bug in some QEMU versions that
always write the emw field on test subchannel and therefore destroy the
paste definitions of this CPU. Running under these QEMU version broke
some timing functions in the VDSO and all users of these functions,
e.g. some JREs.
Signed-off-by: Christian Borntraeger
Signed-off-by: Martin Schwidefsky
Cc: Heiko Carstens
Cc: Sebastian Ott
Cc: Cornelia Huck
Signed-off-by: Greg Kroah-Hartman
commit 1187571b73e16f18fd04ccf2bcf307a04c725895
Author: Martin Schwidefsky
Date: Tue May 20 17:21:35 2014 +0200
s390/time: cast tv\_nsec to u64 prior to shift in update\_vsyscall
commit b6f4296279ab3ada554d993d12844272fd86b36a upstream.
Analog to git commit 28b92e09e25bdc0ae864b22eacf195a74f861389
first cast tk->wall\_to\_monotonic.tv\_nsec to u64 before doing
the shift with tk->shift to avoid loosing relevant bits on a
32-bit kernel.
Signed-off-by: Martin Schwidefsky
Signed-off-by: Greg Kroah-Hartman
commit 7c50a27b68f395fee0c45cb769b4c8546dcac7a4
Author: Lai Jiangshan
Date: Fri Jun 6 14:37:10 2014 -0700
idr: fix overflow bug during maximum ID calculation at maximum height
commit 3afb69cb5572b3c8c898c00880803cf1a49852c4 upstream.
idr\_replace() open-codes the logic to calculate the maximum valid ID
given the height of the idr tree; unfortunately, the open-coded logic
doesn't account for the fact that the top layer may have unused slots
and over-shifts the limit to zero when the tree is at its maximum
height.
The following test code shows it fails to replace the value for
id=((1<<27)+42):
static void test5(void)
{
int id;
DEFINE\_IDR(test\_idr);
#define TEST5\_START ((1<<27)+42) /\* use the highest layer \*/
printk(KERN\_INFO "Start test5\n");
id = idr\_alloc(&test\_idr, (void \*)1, TEST5\_START, 0, GFP\_KERNEL);
BUG\_ON(id != TEST5\_START);
TEST\_BUG\_ON(idr\_replace(&test\_idr, (void \*)2, TEST5\_START) != (void \*)1);
idr\_destroy(&test\_idr);
printk(KERN\_INFO "End of test5\n");
}
Fix the bug by using idr\_max() which correctly takes into account the
maximum allowed shift.
sub\_alloc() shares the same problem and may incorrectly fail with
-EAGAIN; however, this bug doesn't affect correct operation because
idr\_get\_empty\_slot(), which already uses idr\_max(), retries with the
increased @id in such cases.
[tj@kernel.org: Updated patch description.]
Signed-off-by: Lai Jiangshan
Acked-by: Tejun Heo
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ffd6802830d5909dee42c4d786e420288a43815d
Author: Victor Kamensky
Date: Tue Jun 3 19:21:30 2014 +0100
arm64: ptrace: fix empty registers set in prstatus of aarch32 process core
commit 2227901a0230d8fde81ba9c602d649839390f56b upstream.
Currently core file of aarch32 process prstatus note has empty
registers set. As result aarch32 core files create by V8 kernel are
not very useful.
It happens because compat\_gpr\_get and compat\_gpr\_set functions can
copy registers values to/from either kbuf or ubuf. ELF core file
collection function fill\_thread\_core\_info calls compat\_gpr\_get
with kbuf set and ubuf set to 0. But current compat\_gpr\_get and
compat\_gpr\_set function handle copy to/from only ubuf case.
Fix is to handle kbuf and ubuf as two separate cases in similar
way as other functions like user\_regset\_copyout, user\_regset\_copyin do.
Signed-off-by: Victor Kamensky
Acked-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 5a0713d8c4595bf562245c1137488de30cc4757b
Author: Will Deacon
Date: Mon Jun 2 11:47:23 2014 +0100
arm64: ptrace: change fs when passing kernel pointer to regset code
commit c168870704bcde6bb63d05f7882b620dd3985a46 upstream.
Our compat PTRACE\_POKEUSR implementation simply passes the user data to
regset\_copy\_from\_user after some simple range checking. Unfortunately,
the data in question has already been copied to the kernel stack by this
point, so the subsequent access\_ok check fails and the ptrace request
returns -EFAULT. This causes problems tracing fork() with older versions
of strace.
This patch briefly changes the fs to KERNEL\_DS, so that the access\_ok
check passes even with a kernel address.
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit c7d489fa670f9d54dd05b46d81397ec6df208e60
Author: Matthew Dempsky
Date: Fri Jun 6 14:36:42 2014 -0700
ptrace: fix fork event messages across pid namespaces
commit 4e52365f279564cef0ddd41db5237f0471381093 upstream.
When tracing a process in another pid namespace, it's important for fork
event messages to contain the child's pid as seen from the tracer's pid
namespace, not the parent's. Otherwise, the tracer won't be able to
correlate the fork event with later SIGTRAP signals it receives from the
child.
We still risk a race condition if a ptracer from a different pid
namespace attaches after we compute the pid\_t value. However, sending a
bogus fork event message in this unlikely scenario is still a vast
improvement over the status quo where we always send bogus fork event
messages to debuggers in a different pid namespace than the forking
process.
Signed-off-by: Matthew Dempsky
Acked-by: Oleg Nesterov
Cc: Kees Cook
Cc: Julien Tinnes
Cc: Roland McGrath
Cc: Jan Kratochvil
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 191743258363fd3fc6ddc4109d29a00bada9497a
Author: Johannes Weiner
Date: Fri Jun 6 14:35:35 2014 -0700
mm: vmscan: clear kswapd's special reclaim powers before exiting
commit 71abdc15adf8c702a1dd535f8e30df50758848d2 upstream.
When kswapd exits, it can end up taking locks that were previously held
by allocating tasks while they waited for reclaim. Lockdep currently
warns about this:
On Wed, May 28, 2014 at 06:06:34PM +0800, Gu Zheng wrote:
> inconsistent {RECLAIM\_FS-ON-W} -> {IN-RECLAIM\_FS-R} usage.
> kswapd2/1151 [HC0[0]:SC0[0]:HE1:SE1] takes:
> (&sig->group\_rwsem){+++++?}, at: exit\_signals+0x24/0x130
> {RECLAIM\_FS-ON-W} state was registered at:
> mark\_held\_locks+0xb9/0x140
> lockdep\_trace\_alloc+0x7a/0xe0
> kmem\_cache\_alloc\_trace+0x37/0x240
> flex\_array\_alloc+0x99/0x1a0
> cgroup\_attach\_task+0x63/0x430
> attach\_task\_by\_pid+0x210/0x280
> cgroup\_procs\_write+0x16/0x20
> cgroup\_file\_write+0x120/0x2c0
> vfs\_write+0xc0/0x1f0
> SyS\_write+0x4c/0xa0
> tracesys+0xdd/0xe2
> irq event stamp: 49
> hardirqs last enabled at (49): \_raw\_spin\_unlock\_irqrestore+0x36/0x70
> hardirqs last disabled at (48): \_raw\_spin\_lock\_irqsave+0x2b/0xa0
> softirqs last enabled at (0): copy\_process.part.24+0x627/0x15f0
> softirqs last disabled at (0): (null)
>
> other info that might help us debug this:
> Possible unsafe locking scenario:
>
> CPU0
> ----
> lock(&sig->group\_rwsem);
>
> lock(&sig->group\_rwsem);
>
> \*\*\* DEADLOCK \*\*\*
>
> no locks held by kswapd2/1151.
>
> stack backtrace:
> CPU: 30 PID: 1151 Comm: kswapd2 Not tainted 3.10.39+ #4
> Call Trace:
> dump\_stack+0x19/0x1b
> print\_usage\_bug+0x1f7/0x208
> mark\_lock+0x21d/0x2a0
> \_\_lock\_acquire+0x52a/0xb60
> lock\_acquire+0xa2/0x140
> down\_read+0x51/0xa0
> exit\_signals+0x24/0x130
> do\_exit+0xb5/0xa50
> kthread+0xdb/0x100
> ret\_from\_fork+0x7c/0xb0
This is because the kswapd thread is still marked as a reclaimer at the
time of exit. But because it is exiting, nobody is actually waiting on
it to make reclaim progress anymore, and it's nothing but a regular
thread at this point. Be tidy and strip it of all its powers
(PF\_MEMALLOC, PF\_SWAPWRITE, PF\_KSWAPD, and the lockdep reclaim state)
before returning from the thread function.
Signed-off-by: Johannes Weiner
Reported-by: Gu Zheng
Cc: Yasuaki Ishimatsu
Cc: Tang Chen
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit cd909a6dd9fdf3c333257d2bd315becf5fb92588
Author: Kees Cook
Date: Thu Apr 17 13:22:09 2014 -0700
HID: core: fix validation of report id 0
commit 1b15d2e5b8077670b1e6a33250a0d9577efff4a5 upstream.
Some drivers use the first HID report in the list instead of using an
index. In these cases, validation uses ID 0, which was supposed to mean
"first known report". This fixes the problem, which was causing at least
the lgff family of devices to stop working since hid\_validate\_values
was being called with ID 0, but the devices used single numbered IDs
for their reports:
0x05, 0x01, /\* Usage Page (Desktop), \*/
0x09, 0x05, /\* Usage (Gamepad), \*/
0xA1, 0x01, /\* Collection (Application), \*/
0xA1, 0x02, /\* Collection (Logical), \*/
0x85, 0x01, /\* Report ID (1), \*/
...
Reported-by: Simon Wood
Signed-off-by: Kees Cook
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 9164f428a751ef1d4d2c8f361943a09ae2a9c98e
Author: Hugh Dickins
Date: Wed Jun 4 16:05:33 2014 -0700
mm: fix sleeping function warning from \_\_put\_anon\_vma
commit 7f39dda9d86fb4f4f17af0de170decf125726f8c upstream.
Trinity reports BUG:
sleeping function called from invalid context at kernel/locking/rwsem.c:47
in\_atomic(): 0, irqs\_disabled(): 0, pid: 5787, name: trinity-c27
\_\_might\_sleep < down\_write < \_\_put\_anon\_vma < page\_get\_anon\_vma <
migrate\_pages < compact\_zone < compact\_zone\_order < try\_to\_compact\_pages ..
Right, since conversion to mutex then rwsem, we should not put\_anon\_vma()
from inside an rcu\_read\_lock()ed section: fix the two places that did so.
And add might\_sleep() to anon\_vma\_free(), as suggested by Peter Zijlstra.
Fixes: 88c22088bf23 ("mm: optimize page\_lock\_anon\_vma() fast-path")
Reported-by: Dave Jones
Signed-off-by: Hugh Dickins
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 981433901d8e675a8441bdc73beb70d39b9dc387
Author: Naoya Horiguchi
Date: Wed Jun 4 16:11:02 2014 -0700
mm/memory-failure.c: support use of a dedicated thread to handle SIGBUS(BUS\_MCEERR\_AO)
commit 3ba08129e38437561df44c36b7ea9081185d5333 upstream.
Currently memory error handler handles action optional errors in the
deferred manner by default. And if a recovery aware application wants
to handle it immediately, it can do it by setting PF\_MCE\_EARLY flag.
However, such signal can be sent only to the main thread, so it's
problematic if the application wants to have a dedicated thread to
handler such signals.
So this patch adds dedicated thread support to memory error handler. We
have PF\_MCE\_EARLY flags for each thread separately, so with this patch
AO signal is sent to the thread with PF\_MCE\_EARLY flag set, not the main
thread. If you want to implement a dedicated thread, you call prctl()
to set PF\_MCE\_EARLY on the thread.
Memory error handler collects processes to be killed, so this patch lets
it check PF\_MCE\_EARLY flag on each thread in the collecting routines.
No behavioral change for all non-early kill cases.
Tony said:
: The old behavior was crazy - someone with a multithreaded process might
: well expect that if they call prctl(PF\_MCE\_EARLY) in just one thread, then
: that thread would see the SIGBUS with si\_code = BUS\_MCEERR\_A0 - even if
: that thread wasn't the main thread for the process.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Naoya Horiguchi
Reviewed-by: Tony Luck
Cc: Kamil Iskra
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 965b5a20328b36f97aa1b7f9c03919b8e58f9283
Author: Tony Luck
Date: Wed Jun 4 16:11:01 2014 -0700
mm/memory-failure.c: don't let collect\_procs() skip over processes for MF\_ACTION\_REQUIRED
commit 74614de17db6fb472370c426d4f934d8d616edf2 upstream.
When Linux sees an "action optional" machine check (where h/w has reported
an error that is not in the current execution path) we generally do not
want to signal a process, since most processes do not have a SIGBUS
handler - we'd just prematurely terminate the process for a problem that
they might never actually see.
task\_early\_kill() decides whether to consider a process - and it checks
whether this specific process has been marked for early signals with
"prctl", or if the system administrator has requested early signals for
all processes using /proc/sys/vm/memory\_failure\_early\_kill.
But for MF\_ACTION\_REQUIRED case we must not defer. The error is in the
execution path of the current thread so we must send the SIGBUS
immediatley.
Fix by passing a flag argument through collect\_procs\*() to
task\_early\_kill() so it knows whether we can defer or must take action.
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 6e988c21dd3187395950e38ccaf594ae95632fcc
Author: Tony Luck
Date: Wed Jun 4 16:10:59 2014 -0700
mm/memory-failure.c-failure: send right signal code to correct thread
commit a70ffcac741d31a406c1d2b832ae43d658e7e1cf upstream.
When a thread in a multi-threaded application hits a machine check because
of an uncorrectable error in memory - we want to send the SIGBUS with
si.si\_code = BUS\_MCEERR\_AR to that thread. Currently we fail to do that
if the active thread is not the primary thread in the process.
collect\_procs() just finds primary threads and this test:
if ((flags & MF\_ACTION\_REQUIRED) && t == current) {
will see that the thread we found isn't the current thread and so send a
si.si\_code = BUS\_MCEERR\_AO to the primary (and nothing to the active
thread at this time).
We can fix this by checking whether "current" shares the same mm with the
process that collect\_procs() said owned the page. If so, we send the
SIGBUS to current (with code BUS\_MCEERR\_AR).
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Reported-by: Otto Bruggeman
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit f4f753ba00cccb170cdd60ad8d4b9ff561676688
Author: Mel Gorman
Date: Wed Jun 4 16:10:16 2014 -0700
mm: page\_alloc: use word-based accesses for get/set pageblock bitmaps
commit e58469bafd0524e848c3733bc3918d854595e20f upstream.
The test\_bit operations in get/set pageblock flags are expensive. This
patch reads the bitmap on a word basis and use shifts and masks to isolate
the bits of interest. Similarly masks are used to set a local copy of the
bitmap and then use cmpxchg to update the bitmap if there have been no
other changes made in parallel.
In a test running dd onto tmpfs the overhead of the pageblock-related
functions went from 1.27% in profiles to 0.5%.
In addition to the performance benefits, this patch closes races that are
possible between:
a) get\_ and set\_pageblock\_migratetype(), where get\_pageblock\_migratetype()
reads part of the bits before and other part of the bits after
set\_pageblock\_migratetype() has updated them.
b) set\_pageblock\_migratetype() and set\_pageblock\_skip(), where the non-atomic
read-modify-update set bit operation in set\_pageblock\_skip() will cause
lost updates to some bits changed in the set\_pageblock\_migratetype().
Joonsoo Kim first reported the case a) via code inspection. Vlastimil
Babka's testing with a debug patch showed that either a) or b) occurs
roughly once per mmtests' stress-highalloc benchmark (although not
necessarily in the same pageblock). Furthermore during development of
unrelated compaction patches, it was observed that frequent calls to
{start,undo}\_isolate\_page\_range() the race occurs several thousands of
times and has resulted in NULL pointer dereferences in move\_freepages()
and free\_one\_page() in places where free\_list[migratetype] is
manipulated by e.g. list\_move(). Further debugging confirmed that
migratetype had invalid value of 6, causing out of bounds access to the
free\_list array.
That confirmed that the race exist, although it may be extremely rare,
and currently only fatal where page isolation is performed due to
memory hot remove. Races on pageblocks being updated by
set\_pageblock\_migratetype(), where both old and new migratetype are
lower MIGRATE\_RESERVE, currently cannot result in an invalid value
being observed, although theoretically they may still lead to
unexpected creation or destruction of MIGRATE\_RESERVE pageblocks.
Furthermore, things could get suddenly worse when memory isolation is
used more, or when new migratetypes are added.
After this patch, the race has no longer been observed in testing.
Signed-off-by: Mel Gorman
Acked-by: Vlastimil Babka
Reported-by: Joonsoo Kim
Reported-and-tested-by: Vlastimil Babka
Cc: Johannes Weiner
Cc: Jan Kara
Cc: Michal Hocko
Cc: Hugh Dickins
Cc: Dave Hansen
Cc: Theodore Ts'o
Cc: "Paul E. McKenney"
Cc: Oleg Nesterov
Cc: Rik van Riel
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 39fe7460cf6c3cd4b9e53d8ee558f8fb4fde5b09
Author: Mel Gorman
Date: Wed Jun 4 16:07:35 2014 -0700
mm: vmscan: do not throttle based on pfmemalloc reserves if node has no ZONE\_NORMAL
commit 675becce15f320337499bc1a9356260409a5ba29 upstream.
throttle\_direct\_reclaim() is meant to trigger during swap-over-network
during which the min watermark is treated as a pfmemalloc reserve. It
throttes on the first node in the zonelist but this is flawed.
The user-visible impact is that a process running on CPU whose local
memory node has no ZONE\_NORMAL will stall for prolonged periods of time,
possibly indefintely. This is due to throttle\_direct\_reclaim thinking the
pfmemalloc reserves are depleted when in fact they don't exist on that
node.
On a NUMA machine running a 32-bit kernel (I know) allocation requests
from CPUs on node 1 would detect no pfmemalloc reserves and the process
gets throttled. This patch adjusts throttling of direct reclaim to
throttle based on the first node in the zonelist that has a usable
ZONE\_NORMAL or lower zone.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Mel Gorman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 19801fb4a801cec39a70ff9c0a9c9023bd42a1a1
Author: Tetsuo Handa
Date: Wed Jun 4 16:05:36 2014 -0700
kthread: fix return value of kthread\_create() upon SIGKILL.
commit 8fe6929cfd43c44834858a53e129ffdc7c166298 upstream.
Commit 786235eeba0e ("kthread: make kthread\_create() killable") meant
for allowing kthread\_create() to abort as soon as killed by the
OOM-killer. But returning -ENOMEM is wrong if killed by SIGKILL from
userspace. Change kthread\_create() to return -EINTR upon SIGKILL.
Signed-off-by: Tetsuo Handa
Cc: Oleg Nesterov
Acked-by: David Rientjes
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9dbfe4e4a6b45aa5d5e67407445cf7bd4bcffcfc
Author: Naoya Horiguchi
Date: Wed Jun 4 16:05:35 2014 -0700
hugetlb: restrict hugepage\_migration\_support() to x86\_64
commit c177c81e09e517bbf75b67762cdab1b83aba6976 upstream.
Currently hugepage migration is available for all archs which support
pmd-level hugepage, but testing is done only for x86\_64 and there're
bugs for other archs. So to avoid breaking such archs, this patch
limits the availability strictly to x86\_64 until developers of other
archs get interested in enabling this feature.
Simply disabling hugepage migration on non-x86\_64 archs is not enough to
fix the reported problem where sys\_move\_pages() hits the BUG\_ON() in
follow\_page(FOLL\_GET), so let's fix this by checking if hugepage
migration is supported in vma\_migratable().
Signed-off-by: Naoya Horiguchi
Reported-by: Michael Ellerman
Tested-by: Michael Ellerman
Acked-by: Hugh Dickins
Cc: Benjamin Herrenschmidt
Cc: Tony Luck
Cc: Russell King
Cc: Martin Schwidefsky
Cc: James Hogan
Cc: Ralf Baechle
Cc: David Miller
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 683ba9dcad6a409736b635efa740679e42210935
Author: Johan Hovold
Date: Mon May 26 19:23:10 2014 +0200
USB: option: fix runtime PM handling
commit acf47d4f9c39b1cba467aa9442fc2efe0b1da741 upstream.
Fix potential I/O while runtime suspended due to missing PM operations
in send\_setup.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 8a020be9aa9c82d1bee6fbb738ceecbd33863ce8
Author: Alan Stern
Date: Tue Jun 3 11:00:27 2014 -0400
USB: EHCI: avoid BIOS handover on the HASEE E200
commit b0a50e92bda3c4aeb8017d4e6c6e92146ebd5c9b upstream.
Leandro Liptak reports that his HASEE E200 computer hangs when we ask
the BIOS to hand over control of the EHCI host controller. This
definitely sounds like a bug in the BIOS, but at the moment there is
no way to fix it.
This patch works around the problem by avoiding the handoff whenever
the motherboard and BIOS version match those of Leandro's computer.
Signed-off-by: Alan Stern
Reported-by: Leandro Liptak
Tested-by: Leandro Liptak
Signed-off-by: Greg Kroah-Hartman
commit 6bb00f370ec2b89ff3e4f1bff6528f7bc192cc65
Author: Paul Bolle
Date: Fri May 16 12:00:57 2014 +0200
ARM: OMAP: replace checks for CONFIG\_USB\_GADGET\_OMAP
commit 77c2f02edbeda9409a7cf3fd66233015820c213a upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
apparently required that checks for CONFIG\_USB\_GADGET\_OMAP would be
replaced with checks for CONFIG\_USB\_OMAP. Do so now for the remaining
checks for CONFIG\_USB\_GADGET\_OMAP, even though these checks have
basically been broken since v3.1.
And, since we're touching this code, use the IS\_ENABLED() macro, so
things will now (hopefully) also work if USB\_OMAP is modular.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Tony Lindgren
Signed-off-by: Greg Kroah-Hartman
commit 0d8b12fce9dc5fcb05adeae1e39924b746a68685
Author: Felipe Balbi
Date: Wed Apr 16 10:30:33 2014 -0500
usb: dwc3: gadget: clear stall when disabling endpoint
commit 687ef9817df7ed960d14575b9033dde3d04631fe upstream.
so it seems like DWC3 IP doesn't clear stalls
automatically when we disable an endpoint, because
of that, we \_must\_ make sure stalls are cleared
before clearing the proper bit in DALEPENA register.
Reported-by: Johannes Stezenbach
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 2e739000204f883d8708d2855d57a051c9da66db
Author: Paul Bolle
Date: Mon May 26 23:37:09 2014 +0200
usb: gadget: rename CONFIG\_USB\_GADGET\_PXA25X
commit d30f2065d6da377cc76771aca5a9850cfca8723b upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
basically renamed the Kconfig symbol USB\_GADGET\_PXA25X to USB\_PXA25X. It
did not rename the related macros in use at that time. Commit
c0a39151a405 ("ARM: pxa: fix inconsistent CONFIG\_USB\_PXA27X") did so for
all but one macro. Rename that last macro too now.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Greg Kroah-Hartman
commit fe6fa2465e83ce6aea2fc7d146638e69b0438b90
Author: Alan Stern
Date: Tue Jun 3 11:11:34 2014 -0400
USB: usbtest: add a timeout for scatter-gather tests
commit 32b36eeae6a859670d2939a7d6136cb5e9ed64f8 upstream.
In usbtest, tests 5 - 8 use the scatter-gather library in usbcore
without any sort of timeout. If there's a problem in the gadget or
host controller being tested, the test can hang.
This patch adds a 10-second timeout to the tests, so that they will
fail gracefully with an ETIMEDOUT error instead of hanging.
Signed-off-by: Alan Stern
Reported-by: Huang Rui
Tested-by: Huang Rui
Signed-off-by: Greg Kroah-Hartman
commit 08dbc4287663f92fa69556a0074076312e64a8e5
Author: Huang Rui
Date: Mon May 26 10:55:36 2014 +0800
usb: usbtest: fix unlink write error with pattern 1
commit e4d58f5dcb7d7be45df8def31881ebfae99c75da upstream.
TEST 12 and TEST 24 unlinks the URB write request for N times. When
host and gadget both initialize pattern 1 (mod 63) data series to
transfer, the gadget side will complain the wrong data which is not
expected. Because in host side, usbtest doesn't fill the data buffer
as mod 63 and this patch fixed it.
[20285.488974] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.489181] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.489423] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb50800 length 512 last
[20285.489727] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.490055] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.490281] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.490492] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Active
[20285.490713] dwc3 dwc3.0.auto: ep1out-bulk: endpoint busy
[20285.490909] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Complete
[20285.491117] dwc3 dwc3.0.auto: request ffff8800aa6cb480 from ep1out-bulk completed 512/512 ===> 0
[20285.491431] zero gadget: bad OUT byte, buf[1] = 0
[20285.491605] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Set Stall' params 00000000 00000000 00000000
[20285.491915] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.492099] dwc3 dwc3.0.auto: queing request ffff8800aa6cb480 to ep1out-bulk length 512
[20285.492387] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.492595] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.492830] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb51000 length 512 last
[20285.493135] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.493465] dwc3 dwc3.0.auto: Command Complete --> 0
Signed-off-by: Huang Rui
Signed-off-by: Greg Kroah-Hartman
commit af671dd21da6751d7f0512e19facac4e36d74d8c
Author: Dan Carpenter
Date: Fri May 9 14:59:16 2014 +0300
applicom: dereferencing NULL on error path
commit 8bab797c6e5724a43b7666ad70860712365cdb71 upstream.
This is a static checker fix. The "dev" variable is always NULL after
the while statement so we would be dereferencing a NULL pointer here.
Fixes: 819a3eba4233 ('[PATCH] applicom: fix error handling')
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit d78c4fefa3b55f22a2670797951c4fa7e6f1119b
Author: Stephen Boyd
Date: Fri May 23 17:16:53 2014 -0700
staging/mt29f\_spinand: Terminate of match table
commit ffd07de65ef5315053ea16356cd533b7f47c17e9 upstream.
Failure to terminate this match table can lead to boot failures
depending on where the compiler places the match table.
Cc: Kamlakant Patel
Cc: Mona Anonuevo
Cc: linux-mtd@lists.infradead.org
Signed-off-by: Stephen Boyd
Signed-off-by: Greg Kroah-Hartman
commit 6f2f288f2065c3e7b5239c455c75258547f5c9ac
Author: Dan Carpenter
Date: Mon Apr 7 09:31:21 2014 +0300
Staging: rtl8188eu: overflow in update\_sta\_support\_rate()
commit 9dbd79aeb9842144d9a114a979a12c0949ee11eb upstream.
The ->SupportedRates[] array has NDIS\_802\_11\_LENGTH\_RATES\_EX (16)
elements. Since "ie\_len" comes from then network and can go up to 255
then it means we should add a range check to prevent memory corruption.
Fixes: d6846af679e0 ('staging: r8188eu: Add files for new driver - part 7')
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit a71d6ec8c874049a24d36f70dd832c73bbbc4719
Author: Paul Bolle
Date: Mon May 26 21:47:11 2014 +0200
staging: tidspbridge: check for CONFIG\_SND\_OMAP\_SOC\_MCBSP
commit d3921a03a89acb1b9ca599590c0131c89f8737d8 upstream.
Commit d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
removed the Kconfig symbol OMAP\_MCBSP. It left two checks for
CONFIG\_OMAP\_MCBSP untouched.
Convert these to checks for CONFIG\_SND\_OMAP\_SOC\_MCBSP. That must be
correct, since that re-enables calls to functions that are all found in
sound/soc/omap/mcbsp.c. And that file is built only if
CONFIG\_SND\_OMAP\_SOC\_MCBSP is defined.
Fixes: d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
Signed-off-by: Paul Bolle
Signed-off-by: Greg Kroah-Hartman
commit e248558984dc61187b315fc493ad397bbb4c15cb
Author: Antoine Ténart
Date: Mon May 12 14:56:28 2014 +0200
phy: exynos-mipi-video: fix check on array index
commit 98c3b32229f2685c13436b652b8959c99dfc5a31 upstream.
The phys array is of size EXYNOS\_MIPI\_PHYS\_NUM. Trying to access the
index EXYNOS\_MIPI\_PHYS\_NUM should return an error.
Fixes: 069d2e26e9d6 "phy: Add driver for Exynos MIPI CSIS/DSIM DPHYs"
Signed-off-by: Antoine Ténart
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Greg Kroah-Hartman
commit 57a30a41fd5191c6eef3e868e2ae2d365c74b0f2
Author: Krzysztof Kozlowski
Date: Fri Apr 18 16:47:30 2014 +0200
extcon: max14577: Properly handle regmap\_irq\_get\_virq error
commit 369afd4ba22f5b8de0c9229b6e62b3f9e2207034 upstream.
The regmap\_irq\_get\_virq may return 0 or -EINVAL on error. Fail the probe
in both situations.
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit b6687c4967b8520ef984bb63036422339266b3b9
Author: Krzysztof Kozlowski
Date: Wed Apr 9 11:56:09 2014 +0200
extcon: max14577: Fix probe failure on successful work queue
commit 12adef5b49e98eb181b4163c36e2998169e1379b upstream.
In probe the driver queued delayed work for cable detection and
returned the result of queue\_delayed\_work() call. However the return
value of queue\_delayed\_work() does not indicate an error and in normal
condition it returns true which means successful work queue.
This effectively resulted in probe failure:
[ 2.088204] max14577-muic: probe of max77836-muic failed with error 1
Signed-off-by: Krzysztof Kozlowski
Fixes: 962e56bfcf0b ("extcon: max14577: Add extcon-max14577 driver...")
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit ef06d6dbcf665f27f6fbbafcd66e8d06ddb5480e
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:12 2014 +0200
extcon: max77693: Fix two NULL pointer exceptions on missing pdata
commit d5653f2b7304f05eeb45d84f123cf02f840b8537 upstream.
Fix NULL pointer exceptions when platform data is not supplied.
Trace of one exception:
Unable to handle kernel NULL pointer dereference at virtual address 00000008
pgd = c0004000
[00000008] \*pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 2 PID: 1 Comm: swapper/0 Not tainted 3.14.0-12045-gead5dd4687a6-dirty #1628
task: eea80000 ti: eea88000 task.ti: eea88000
PC is at max77693\_muic\_probe+0x27c/0x528
LR is at regmap\_write+0x50/0x60
pc : [] lr : [] psr: 20000113
sp : eea89e38 ip : 00000000 fp : c098a834
r10: ee1a5a10 r9 : 00000005 r8 : c098a83c
r7 : 0000000a r6 : c098a774 r5 : 00000005 r4 : eeb006d0
r3 : c0697bd8 r2 : 00000000 r1 : 00000001 r0 : 00000000
Flags: nzCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment kernel
Control: 10c5387d Table: 4000404a DAC: 00000015
Process swapper/0 (pid: 1, stack limit = 0xeea88240)
Stack: (0xeea89e38 to 0xeea8a000)
9e20: c08499fc eeb006d0
9e40: 00000000 00000000 c0915f98 00000001 00000000 ee1a5a10 c098a730 c09a88b8
9e60: 00000000 c098a730 c0915f98 00000000 00000000 c02d6aa0 c02d6a88 ee1a5a10
9e80: c0a712c8 c02d54e4 00001204 c0628b00 ee1a5a10 c098a730 ee1a5a44 00000000
9ea0: eea88000 c02d57b4 00000000 c098a730 c02d5728 c02d3a24 ee813e5c eeb9d534
9ec0: c098a730 ee22f700 c097c720 c02d4b14 c08174ec c098a730 00000006 c098a730
9ee0: 00000006 c092fd30 c09b8500 c02d5df8 00000000 c093cbb8 00000006 c0008928
9f00: 000000c3 ef7fc785 00000000 ef7fc794 00000000 c08af968 00000072 eea89f30
9f20: ef7fc85e c065f198 000000c3 c003e87c 00000003 00000000 c092fd3c 00000000
9f40: c08af618 c0826d58 00000006 00000006 c0956f58 c093cbb8 00000006 c092fd30
9f60: c09b8500 000000c3 c092fd3c c08e8510 00000000 c08e8bb0 00000006 00000006
9f80: c08e8510 c0c0c0c0 00000000 c0628fac 00000000 00000000 00000000 00000000
9fa0: 00000000 c0628fb4 00000000 c000f038 00000000 00000000 00000000 00000000
9fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9fe0: 00000000 00000000 00000000 00000000 00000013 00000000 c0c0c0c0 c0c0c0c0
[] (max77693\_muic\_probe) from [] (platform\_drv\_probe+0x18/0x48)
[] (platform\_drv\_probe) from [] (driver\_probe\_device+0x140/0x384)
[] (driver\_probe\_device) from [] (\_\_driver\_attach+0x8c/0x90)
[] (\_\_driver\_attach) from [] (bus\_for\_each\_dev+0x54/0x88)
[] (bus\_for\_each\_dev) from [] (bus\_add\_driver+0xe8/0x204)
[] (bus\_add\_driver) from [] (driver\_register+0x78/0xf4)
[] (driver\_register) from [] (do\_one\_initcall+0xc4/0x174)
[] (do\_one\_initcall) from [] (kernel\_init\_freeable+0xfc/0x1c8)
[] (kernel\_init\_freeable) from [] (kernel\_init+0x8/0xec)
[] (kernel\_init) from [] (ret\_from\_fork+0x14/0x3c)
Code: caffffe7 e59d200c e3550001 b3a05001 (e5923008)
---[ end trace 85db969ce011bde7 ]---
Signed-off-by: Krzysztof Kozlowski
Fixes: 190d7cfc8632
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit 915772561648ae58c00b996187bbf7bc21717212
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:14 2014 +0200
extcon: max8997: Fix NULL pointer exception on missing pdata
commit dfee4111febf3d9ef3a640b2cd6205c75f4e7e3d upstream.
Fix NULL pointer exception when platform data is not supplied. The
driver dereferenced pdata pointer where it could be NULL.
Signed-off-by: Krzysztof Kozlowski
Fixes: 810d601f07c
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit db2382a8254e7e76c64345dc7b2d48693b1e2067
Author: Johan Hovold
Date: Thu May 8 10:09:23 2014 +0200
net: cpsw: fix null dereference at probe
commit 6954cc1f238199e971ec905c5cc87120806ac981 upstream.
Fix null-pointer dereference at probe when the mdio platform device is
missing (e.g. when it has been disabled in DT).
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f10e9cf1570759f28ab2591ca3800bc07514287a
Author: Ursula Braun
Date: Tue May 13 14:38:02 2014 +0200
af\_iucv: wrong mapping of sent and confirmed skbs
commit f5738e2ef88070ef1372e6e718124d88e9abe4ac upstream.
When sending data through IUCV a MESSAGE COMPLETE interrupt
signals that sent data memory can be freed or reused again.
With commit f9c41a62bba3f3f7ef3541b2a025e3371bcbba97
"af\_iucv: fix recvmsg by replacing skb\_pull() function" the
MESSAGE COMPLETE callback iucv\_callback\_txdone() identifies
the wrong skb as being confirmed, which leads to data corruption.
This patch fixes the skb mapping logic in iucv\_callback\_txdone().
Signed-off-by: Ursula Braun
Signed-off-by: Frank Blaschka
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8a478b1a7fd69e567e07ed4da23d3b3572fa728c
Author: Stephane Grosjean
Date: Tue May 20 11:38:56 2014 +0200
can: peak\_pci: prevent use after free at netdev removal
commit 0b5a958cf4df3a5cd578b861471e62138f55c85e upstream.
As remarked by Christopher R. Baker in his post at
http://marc.info/?l=linux-can&m=139707295706465&w=2
there's a possibility for an use after free condition at device removal.
This simplified patch introduces an additional variable to prevent the issue.
Thanks for catching this.
Reported-by: Christopher R. Baker
Signed-off-by: Stephane Grosjean
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit acdad30d78a68bce2208131523c00d341bb3d914
Author: Johan Hovold
Date: Thu May 8 10:09:22 2014 +0200
Revert "net: eth: cpsw: Correctly attach to GPIO bitbang MDIO driver"
commit 59993f48b38fd46863b23bb1bb1dc3291e7278fb upstream.
This reverts commit f8d56d8f892be43a2404356073e16401eb5a42e6 ("net:
eth: cpsw: Correctly attach to GPIO bitbang MDIO driver").
Fix potential null-pointer dereference at probe if the mdio-gpio device
has not been successfully probed yet.
The offending commit is plain wrong for a number of reasons. First of
all it accesses internal driver data of an unrelated device. Neither
does it check that the data is non-null (which it is in case the device
has not been probed yet).
Furthermore, the decision on whether to treat any driver data according
to the mdio-gpio driver's internals is made based on the node name. But
the name is not compared against "mdio" which is the normal name for the
node, but rather against "gpio" which the node does not have to be named
(and shouldn't be according to the binding documentation). [ If this
hack is to be kept out-of-tree it should at least be matching against
the compatible property. ]
Cc: Stefan Roese
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from git.kernel.org_f4f61f3c_20250126_063328.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.13.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin LaHaise <bcrl@kvack.org> | 2014-06-24 13:32:51 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2014-06-30 20:09:45 -0700 |
| commit | [d36db46c2cba973557eb6138d22210c4e0cf17d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)) | |
| tree | [6f0e481de7b3cfe7321bd129e84013a34446b026](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6) | |
| parent | [6745cb91b5ec93a1b34221279863926fba43d0d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6745cb91b5ec93a1b34221279863926fba43d0d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6&id2=6745cb91b5ec93a1b34221279863926fba43d0d7)) | |
| download | [linux-d36db46c2cba973557eb6138d22210c4e0cf17d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d36db46c2cba973557eb6138d22210c4e0cf17d6.tar.gz) | |

aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10commit edfbbf388f293d70bf4b7c0bc38774d05e6f711a upstream.
A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
[jmoyer@redhat.com: backported to 3.10]
Signed-off-by: Benjamin LaHaise <bcrl@kvack.org>
Signed-off-by: Jeff Moyer <jmoyer@redhat.com>
Cc: Mateusz Guzik <mguzik@redhat.com>
Cc: Petr Matousek <pmatouse@redhat.com>
Cc: Kent Overstreet <kmo@daterainc.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)

| -rw-r--r-- | [fs/aio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/aio.c?id=d36db46c2cba973557eb6138d22210c4e0cf17d6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/fs/aio.c b/fs/aio.cindex 8d2c997a550c82..ded94c4fa30d31 100644--- a/[fs/aio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/aio.c?id=6745cb91b5ec93a1b34221279863926fba43d0d7)+++ b/[fs/aio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/aio.c?id=d36db46c2cba973557eb6138d22210c4e0cf17d6)@@ -717,6 +717,8 @@ static long aio\_read\_events\_ring(struct kioctx \*ctx, if (head == ctx->tail) goto out; + head %= ctx->nr\_events;+ while (ret < nr) { long avail; struct io\_event \*ev; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-26 06:32:05 +0000



=== Content from git.kernel.org_ede4e6d7_20250125_060421.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=edfbbf388f29)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=edfbbf388f29)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=edfbbf388f29)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=edfbbf388f29)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin LaHaise <bcrl@kvack.org> | 2014-06-24 13:32:51 -0400 |
| --- | --- | --- |
| committer | Benjamin LaHaise <bcrl@kvack.org> | 2014-06-24 13:46:01 -0400 |
| commit | [edfbbf388f293d70bf4b7c0bc38774d05e6f711a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=edfbbf388f293d70bf4b7c0bc38774d05e6f711a) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=edfbbf388f293d70bf4b7c0bc38774d05e6f711a)) | |
| tree | [9603bc6513868d7c28052ac1e96e6bbff7121063](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=edfbbf388f29) | |
| parent | [f8567a3845ac05bb28f3c1b478ef752762bd39ef](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f8567a3845ac05bb28f3c1b478ef752762bd39ef) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=edfbbf388f29&id2=f8567a3845ac05bb28f3c1b478ef752762bd39ef)) | |
| download | [linux-edfbbf388f29.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-edfbbf388f29.tar.gz) | |

aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
Signed-off-by: Benjamin LaHaise <bcrl@kvack.org>
Cc: Mateusz Guzik <mguzik@redhat.com>
Cc: Petr Matousek <pmatouse@redhat.com>
Cc: Kent Overstreet <kmo@daterainc.com>
Cc: Jeff Moyer <jmoyer@redhat.com>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=edfbbf388f29)

| -rw-r--r-- | [fs/aio.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/aio.c?id=edfbbf388f29) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/fs/aio.c b/fs/aio.cindex 6a9c7e489adff0..955947ef3e0263 100644--- a/[fs/aio.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/aio.c?id=f8567a3845ac05bb28f3c1b478ef752762bd39ef)+++ b/[fs/aio.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/aio.c?id=edfbbf388f293d70bf4b7c0bc38774d05e6f711a)@@ -1063,6 +1063,9 @@ static long aio\_read\_events\_ring(struct kioctx \*ctx, if (head == tail) goto out; + head %= ctx->nr\_events;+ tail %= ctx->nr\_events;+ while (ret < nr) { long avail; struct io\_event \*ev; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 06:02:59 +0000



=== Content from www.kernel.org_0fc99375_20250125_060424.html ===
commit 5e9a2a3622d30c36814ea4df359c83dde1bf53a5
Author: Greg Kroah-Hartman
Date: Mon Jun 30 20:09:54 2014 -0700
Linux 3.10.46
commit 3eee84071548d0d279d8f630404a5b16d45b42f2
Author: Roland Dreier
Date: Mon Jun 30 07:02:20 2014 -0700
iscsi-target: Re-add chunk from backport of upstream 79d59d08082d to 3.10
Commit d5c55fa31a29, the backport of upstream 79d59d08082d
("iscsi-target: Fix wrong buffer / buffer overrun in
iscsi\_change\_param\_value()") left out applying one chunk of the fix in
iscsi\_login\_non\_zero\_tsih\_s2(). Add the missing chunk.
Signed-off-by: Roland Dreier
Signed-off-by: Greg Kroah-Hartman
commit 286c9b2c933a787cb43761e86d295f867d2790c0
Author: Andy Lutomirski
Date: Mon Jun 23 14:22:15 2014 -0700
x86\_32, entry: Do syscall exit work on badsys (CVE-2014-4508)
commit 554086d85e71f30abe46fc014fea31929a7c6a8a upstream.
The bad syscall nr paths are their own incomprehensible route
through the entry control flow. Rearrange them to work just like
syscalls that return -ENOSYS.
This fixes an OOPS in the audit code when fast-path auditing is
enabled and sysenter gets a bad syscall nr (CVE-2014-4508).
This has probably been broken since Linux 2.6.27:
af0575bba0 i386 syscall audit fast-path
Cc: Roland McGrath
Reported-by: Toralf Förster
Signed-off-by: Andy Lutomirski
Link: http://lkml.kernel.org/r/e09c499eade6fc321266dd6b54da7beb28d6991c.1403558229.git.luto@amacapital.net
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 029a894631d9020b77151cfca7ecd9eda3916661
Author: Sagi Grimberg
Date: Mon May 19 17:44:25 2014 +0300
Target/iser: Wait for proper cleanup before unloading
commit f5ebec9629cf78eeeea4b8258882a9f439ab2404 upstream.
disconnected\_handler works are scheduled on system\_wq.
When attempting to unload, first make sure all works
have cleaned up.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 674a2365f073ea4948b096a0db14b47090ef725c
Author: Sagi Grimberg
Date: Mon May 19 17:44:24 2014 +0300
Target/iser: Improve cm events handling
commit 88c4015fda6d014392f76d3b1688347950d7a12d upstream.
There are 4 RDMA\_CM events that all basically mean that
the user should teardown the IB connection:
- DISCONNECTED
- ADDR\_CHANGE
- DEVICE\_REMOVAL
- TIMEWAIT\_EXIT
Only in DISCONNECTED/ADDR\_CHANGE it makes sense to
call rdma\_disconnect (send DREQ/DREP to our initiator).
So we keep the same teardown handler for all of them
but only indicate calling rdma\_disconnect for the relevant
events.
This patch also removes redundant debug prints for each single
event.
v2 changes:
- Call isert\_disconnected\_handler() for DEVICE\_REMOVAL (Or + Sag)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 1b85bc83e162d760a53bf2d48d0ce3427e1c4555
Author: Roger Quadros
Date: Wed Dec 18 15:40:10 2013 +0530
usb: usbtest: Add timetout to simple\_io()
commit e5e4746510d140261918aecce2e5e3aa4456f7e9 upstream.
Without a timetout some tests e.g. test\_halt() can remain stuck forever.
Signed-off-by: Roger Quadros
Reviewed-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 26401cbceb478fe203a415612b4c8d52194a9154
Author: Eric Sandeen
Date: Thu Jun 12 00:39:58 2014 -0500
btrfs: fix use of uninit "ret" in end\_extent\_writepage()
commit 3e2426bd0eb980648449e7a2f5a23e3cd3c7725c upstream.
If this condition in end\_extent\_writepage() is false:
if (tree->ops && tree->ops->writepage\_end\_io\_hook)
we will then test an uninitialized "ret" at:
ret = ret < 0 ? ret : -EIO;
The test for ret is for the case where ->writepage\_end\_io\_hook
failed, and we'd choose that ret as the error; but if
there is no ->writepage\_end\_io\_hook, nothing sets ret.
Initializing ret to 0 should be sufficient; if
writepage\_end\_io\_hook wasn't set, (!uptodate) means
non-zero err was passed in, so we choose -EIO in that case.
Signed-of-by: Eric Sandeen
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit b2ac30236228d605fa14fbf5640ee7dc6b99b550
Author: Liu Bo
Date: Mon Jun 9 10:54:07 2014 +0800
Btrfs: fix scrub\_print\_warning to handle skinny metadata extents
commit 6eda71d0c030af0fc2f68aaa676e6d445600855b upstream.
The skinny extents are intepreted incorrectly in scrub\_print\_warning(),
and end up hitting the BUG() in btrfs\_extent\_inline\_ref\_size.
Reported-by: Konstantinos Skarlatos
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit d6f5d5fd0c1de1a443e3a9c3d439dd5d760f11cc
Author: Liu Bo
Date: Sun Jun 8 19:04:13 2014 +0800
Btrfs: use right type to get real comparison
commit cd857dd6bc2ae9ecea14e75a34e8a8fdc158e307 upstream.
We want to make sure the point is still within the extent item, not to verify
the memory it's pointing to.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 2346e1e345bbb141271d0e54d6d906118db8864d
Author: Rickard Strandqvist
Date: Thu May 22 22:43:43 2014 +0200
fs: btrfs: volumes.c: Fix for possible null pointer dereference
commit 8321cf2596d283821acc466377c2b85bcd3422b7 upstream.
There is otherwise a risk of a possible null pointer dereference.
Was largely found by using a static code analysis program called cppcheck.
Signed-off-by: Rickard Strandqvist
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 70510742ba8f199918b9f56de3cc43972102f39f
Author: Filipe Manana
Date: Sun May 25 04:49:24 2014 +0100
Btrfs: send, don't error in the presence of subvols/snapshots
commit 1af56070e3ef9477dbc7eba3b9ad7446979c7974 upstream.
If we are doing an incremental send and the base snapshot has a
directory with name X that doesn't exist anymore in the second
snapshot and a new subvolume/snapshot exists in the second snapshot
that has the same name as the directory (name X), the incremental
send would fail with -ENOENT error. This is because it attempts
to lookup for an inode with a number matching the objectid of a
root, which doesn't exist.
Steps to reproduce:
mkfs.btrfs -f /dev/sdd
mount /dev/sdd /mnt
mkdir /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap1
rmdir /mnt/testdir
btrfs subvolume create /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap2
btrfs send -p /mnt/mysnap1 /mnt/mysnap2 -f /tmp/send.data
A test case for xfstests follows.
Reported-by: Robert White
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 2d857bc05efe3654da84dec0a1199e8ec4bf6e22
Author: Wang Shilong
Date: Tue May 13 17:05:06 2014 +0800
Btrfs: set right total device count for seeding support
commit 298658414a2f0bea1f05a81876a45c1cd96aa2e0 upstream.
Seeding device support allows us to create a new filesystem
based on existed filesystem.
However newly created filesystem's @total\_devices should include seed
devices. This patch fix the following problem:
# mkfs.btrfs -f /dev/sdb
# btrfstune -S 1 /dev/sdb
# mount /dev/sdb /mnt
# btrfs device add -f /dev/sdc /mnt --->fs\_devices->total\_devices = 1
# umount /mnt
# mount /dev/sdc /mnt --->fs\_devices->total\_devices = 2
This is because we record right @total\_devices in superblock, but
@fs\_devices->total\_devices is reset to be 0 in btrfs\_prepare\_sprout().
Fix this problem by not resetting @fs\_devices->total\_devices.
Signed-off-by: Wang Shilong
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 372fad07b99cc6a9959bfe6b8f46135970c52a21
Author: Liu Bo
Date: Mon May 12 12:47:36 2014 +0800
Btrfs: mark mapping with error flag to report errors to userspace
commit 5dca6eea91653e9949ce6eb9e9acab6277e2f2c4 upstream.
According to commit 865ffef3797da2cac85b3354b5b6050dc9660978
(fs: fix fsync() error reporting),
it's not stable to just check error pages because pages can be
truncated or invalidated, we should also mark mapping with error
flag so that a later fsync can catch the error.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 791a1cc32d1ba64024db044e738661b5e119d5fa
Author: Wang Shilong
Date: Wed Apr 9 19:23:22 2014 +0800
Btrfs: make sure there are not any read requests before stopping workers
commit de348ee022175401e77d7662b7ca6e231a94e3fd upstream.
In close\_ctree(), after we have stopped all workers,there maybe still
some read requests(for example readahead) to submit and this \*maybe\* trigger
an oops that user reported before:
kernel BUG at fs/btrfs/async-thread.c:619!
By hacking codes, i can reproduce this problem with one cpu available.
We fix this potential problem by invalidating all btree inode pages before
stopping all workers.
Thanks to Miao for pointing out this problem.
Signed-off-by: Wang Shilong
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 87d7177149733a17cdcf6424b329c8f9be6d4b7c
Author: Miao Xie
Date: Thu Apr 24 13:31:55 2014 +0800
Btrfs: output warning instead of error when loading free space cache failed
commit 32d6b47fe6fc1714d5f1bba1b9f38e0ab0ad58a8 upstream.
If we fail to load a free space cache, we can rebuild it from the extent tree,
so it is not a serious error, we should not output a error message that
would make the users uncomfortable. This patch uses warning message instead
of it.
Signed-off-by: Miao Xie
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit de0914339196e139a21bfb1d82db0465afb4ed6c
Author: Qu Wenruo
Date: Wed Apr 16 17:02:32 2014 +0800
btrfs: Add ctime/mtime update for btrfs device add/remove.
commit 5a1972bd9fd4b2fb1bac8b7a0b636d633d8717e3 upstream.
Btrfs will send uevent to udev inform the device change,
but ctime/mtime for the block device inode is not udpated, which cause
libblkid used by btrfs-progs unable to detect device change and use old
cache, causing 'btrfs dev scan; btrfs dev rmove; btrfs dev scan' give an
error message.
Reported-by: Tsutomu Itoh
Cc: Karel Zak
Signed-off-by: Qu Wenruo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 8e3ddf4c9b438953922840b3d236ac04777408e6
Author: Chris Mason
Date: Wed May 21 05:49:54 2014 -0700
Btrfs: fix double free in find\_lock\_delalloc\_range
commit 7d78874273463a784759916fc3e0b4e2eb141c70 upstream.
We need to NULL the cached\_state after freeing it, otherwise
we might free it again if find\_delalloc\_range doesn't find anything.
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit b124695c12cb8c4dc0f91cc18eac640f546c6456
Author: Michael S. Tsirkin
Date: Mon Mar 10 19:28:08 2014 +0200
skbuff: skb\_segment: orphan frags before copying
commit 1fd819ecb90cc9b822cd84d3056ddba315d3340f upstream.
skb\_segment copies frags around, so we need
to copy them carefully to avoid accessing
user memory after reporting completion to userspace
through a callback.
skb\_segment doesn't normally happen on datapath:
TSO needs to be disabled - so disabling zero copy
in this case does not look like a big deal.
Signed-off-by: Michael S. Tsirkin
Acked-by: Herbert Xu
Signed-off-by: David S. Miller
[bwh: Backported to 3.2. As skb\_segment() only supports page-frags \*or\* a
frag list, there is no need for the additional frag\_skb pointer or the
preparatory renaming.]
Signed-off-by: Ben Hutchings
Cc: Eddie Chapman  # backported to 3.10
Signed-off-by: Greg Kroah-Hartman
commit d36db46c2cba973557eb6138d22210c4e0cf17d6
Author: Benjamin LaHaise
Date: Tue Jun 24 13:32:51 2014 -0400
aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10
commit edfbbf388f293d70bf4b7c0bc38774d05e6f711a upstream.
A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
[jmoyer@redhat.com: backported to 3.10]
Signed-off-by: Benjamin LaHaise
Signed-off-by: Jeff Moyer
Cc: Mateusz Guzik
Cc: Petr Matousek
Cc: Kent Overstreet
Signed-off-by: Greg Kroah-Hartman
commit 6745cb91b5ec93a1b34221279863926fba43d0d7
Author: Benjamin LaHaise
Date: Tue Jun 24 13:12:55 2014 -0400
aio: fix aio request leak when events are reaped by userspace
commit f8567a3845ac05bb28f3c1b478ef752762bd39ef upstream.
The aio cleanups and optimizations by kmo that were merged into the 3.10
tree added a regression for userspace event reaping. Specifically, the
reference counts are not decremented if the event is reaped in userspace,
leading to the application being unable to submit further aio requests.
This patch applies to 3.12+. A separate backport is required for 3.10/3.11.
This issue was uncovered as part of CVE-2014-0206.
[jmoyer@redhat.com: backported to 3.10]
Signed-off-by: Benjamin LaHaise
Signed-off-by: Jeff Moyer
Cc: Kent Overstreet
Cc: Mateusz Guzik
Cc: Petr Matousek
Signed-off-by: Greg Kroah-Hartman
commit 72aeabd74a7154d560efcd14afa0244f4393cf8b
Author: Thomas Gleixner
Date: Thu Mar 7 14:53:45 2013 +0100
genirq: Sanitize spurious interrupt detection of threaded irqs
commit 1e77d0a1ed7417d2a5a52a7b8d32aea1833faa6c upstream.
Till reported that the spurious interrupt detection of threaded
interrupts is broken in two ways:
- note\_interrupt() is called for each action thread of a shared
interrupt line. That's wrong as we are only interested whether none
of the device drivers felt responsible for the interrupt, but by
calling multiple times for a single interrupt line we account
IRQ\_NONE even if one of the drivers felt responsible.
- note\_interrupt() when called from the thread handler is not
serialized. That leaves the members of irq\_desc which are used for
the spurious detection unprotected.
To solve this we need to defer the spurious detection of a threaded
interrupt to the next hardware interrupt context where we have
implicit serialization.
If note\_interrupt is called with action\_ret == IRQ\_WAKE\_THREAD, we
check whether the previous interrupt requested a deferred check. If
not, we request a deferred check for the next hardware interrupt and
return.
If set, we check whether one of the interrupt threads signaled
success. Depending on this information we feed the result into the
spurious detector.
If one primary handler of a shared interrupt returns IRQ\_HANDLED we
disable the deferred check of irq threads on the same line, as we have
found at least one device driver who cared.
Reported-by: Till Straumann
Signed-off-by: Thomas Gleixner
Tested-by: Austin Schuh
Cc: Oliver Hartkopp
Cc: Wolfgang Grandegger
Cc: Pavel Pisa
Cc: Marc Kleine-Budde
Cc: linux-can@vger.kernel.org
Link: http://lkml.kernel.org/r/alpine.LFD.2.02.1303071450130.22263@ionos
Signed-off-by: Greg Kroah-Hartman
commit 1790b2dd037e286b2b01c6254081cf349b72a003
Author: Mike Frysinger
Date: Sun May 4 20:43:15 2014 -0400
x86, x32: Use compat shims for io\_{setup,submit}
commit 7fd44dacdd803c0bbf38bf478d51d280902bb0f1 upstream.
The io\_setup takes a pointer to a context id of type aio\_context\_t.
This in turn is typed to a \_\_kernel\_ulong\_t. We could tweak the
exported headers to define this as a 64bit quantity for specific
ABIs, but since we already have a 32bit compat shim for the x86 ABI,
let's just re-use that logic. The libaio package is also written to
expect this as a pointer type, so a compat shim would simplify that.
The io\_submit func operates on an array of pointers to iocb structs.
Padding out the array to be 64bit aligned is a huge pain, so convert
it over to the existing compat shim too.
We don't convert io\_getevents to the compat func as its only purpose
is to handle the timespec struct, and the x32 ABI uses 64bit times.
With this change, the libaio package can now pass its testsuite when
built for the x32 ABI.
Signed-off-by: Mike Frysinger
Link: http://lkml.kernel.org/r/1399250595-5005-1-git-send-email-vapier@gentoo.org
Cc: H.J. Lu
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 7a1d06c86697d727ef095f6e675e378ee9caae1a
Author: H. Peter Anvin
Date: Wed Apr 30 14:03:25 2014 -0700
x86-32, espfix: Remove filter for espfix32 due to race
commit 246f2d2ee1d715e1077fc47d61c394569c8ee692 upstream.
It is not safe to use LAR to filter when to go down the espfix path,
because the LDT is per-process (rather than per-thread) and another
thread might change the descriptors behind our back. Fortunately it
is always \*safe\* (if a bit slow) to go down the espfix path, and a
32-bit LDT stack segment is extremely rare.
Signed-off-by: H. Peter Anvin
Link: http://lkml.kernel.org/r/1398816946-3351-1-git-send-email-hpa@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 43507abd621cb72b55142e7b18a4aa77a19aa3f3
Author: Nicholas A. Bellinger
Date: Mon Jun 16 20:59:52 2014 +0000
target: Explicitly clear ramdisk\_mcp backend pages
[Note that a different patch to address the same issue went in during
v3.15-rc1 (commit 4442dc8a), but includes a bunch of other changes that
don't strictly apply to fixing the bug]
This patch changes rd\_allocate\_sgl\_table() to explicitly clear
ramdisk\_mcp backend memory pages by passing \_\_GFP\_ZERO into
alloc\_pages().
This addresses a potential security issue where reading from a
ramdisk\_mcp could return sensitive information, and follows what
>= v3.15 does to explicitly clear ramdisk\_mcp memory at backend
device initialization time.
Reported-by: Jorge Daniel Sequeira Matias
Cc: Jorge Daniel Sequeira Matias
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit be03ed7ca0bd65ced3cc033587c9034bd2eedc0b
Author: Roland Dreier
Date: Tue Jun 10 11:07:47 2014 -0700
target: Report correct response length for some commands
commit 2426bd456a61407388b6e61fc5f98dbcbebc50e2 upstream.
When an initiator sends an allocation length bigger than what its
command consumes, the target should only return the actual response data
and set the residual length to the unused part of the allocation length.
Add a helper function that command handlers (INQUIRY, READ CAPACITY,
etc) can use to do this correctly, and use this code to get the correct
residual for commands that don't use the full initiator allocation in the
handlers for READ CAPACITY, READ CAPACITY(16), INQUIRY, MODE SENSE and
REPORT LUNS.
This addresses a handful of failures as reported by Christophe with
the Windows Certification Kit:
http://permalink.gmane.org/gmane.linux.scsi.target.devel/6515
Signed-off-by: Roland Dreier
Tested-by: Christophe Vu-Brugier
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit dda585bfc60bccd8abc104569f7a07283f474ccf
Author: Nicholas Bellinger
Date: Tue Jun 10 04:03:54 2014 +0000
iscsi-target: Fix ABORT\_TASK + connection reset iscsi\_queue\_req memory leak
commit bbc050488525e1ab1194c27355f63c66814385b8 upstream.
This patch fixes a iscsi\_queue\_req memory leak when ABORT\_TASK response
has been queued by TFO->queue\_tm\_rsp() -> lio\_queue\_tm\_rsp() after a
long standing I/O completes, but the connection has already reset and
waiting for cleanup to complete in iscsit\_release\_commands\_from\_conn()
-> transport\_generic\_free\_cmd() -> transport\_wait\_for\_tasks() code.
It moves iscsit\_free\_queue\_reqs\_for\_conn() after the per-connection command
list has been released, so that the associated se\_cmd tag can be completed +
released by target-core before freeing any remaining iscsi\_queue\_req memory
for the connection generated by lio\_queue\_tm\_rsp().
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 01bdcde7f7ad3b2e6d5977e3fe4241885d76557d
Author: Nicholas Bellinger
Date: Mon Jun 9 23:36:51 2014 +0000
target: Use complete\_all for se\_cmd->t\_transport\_stop\_comp
commit a95d6511303b848da45ee27b35018bb58087bdc6 upstream.
This patch fixes a bug where multiple waiters on ->t\_transport\_stop\_comp
occurs due to a concurrent ABORT\_TASK and session reset both invoking
transport\_wait\_for\_tasks(), while waiting for the associated se\_cmd
descriptor backend processing to complete.
For this case, complete\_all() should be invoked in order to wake up
both waiters in core\_tmr\_abort\_task() + transport\_generic\_free\_cmd()
process contexts.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 7f2a9059e6f1ad09e59b098f9096068c4b2288c0
Author: Nicholas Bellinger
Date: Mon Jun 9 23:13:20 2014 +0000
target: Set CMD\_T\_ACTIVE bit for Task Management Requests
commit f15e9cd910c4d9da7de43f2181f362082fc45f0f upstream.
This patch fixes a bug where se\_cmd descriptors associated with a
Task Management Request (TMR) where not setting CMD\_T\_ACTIVE before
being dispatched into target\_tmr\_work() process context.
This is required in order for transport\_generic\_free\_cmd() ->
transport\_wait\_for\_tasks() to wait on se\_cmd->t\_transport\_stop\_comp
if a session reset event occurs while an ABORT\_TASK is outstanding
waiting for another I/O to complete.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 1813e80ef7833579ba7a802781a66361a3d8906d
Author: Sagi Grimberg
Date: Mon May 19 17:44:23 2014 +0300
Target/iser: Fix hangs in connection teardown
commit 9d49f5e284e700576f3b65f1e28dea8539da6661 upstream.
In ungraceful teardowns isert close flows seem racy such that
isert\_wait\_conn hangs as RDMA\_CM\_EVENT\_DISCONNECTED never
gets invoked (no one called rdma\_disconnect).
Both graceful and ungraceful teardowns will have rx flush errors
(isert posts a batch once connection is established). Once all
flush errors are consumed we invoke isert\_wait\_conn and it will
be responsible for calling rdma\_disconnect. This way it can be
sure that rdma\_disconnect was called and it won't wait forever.
This patch also removes the logout\_posted indicator. either the
logout completion was consumed and no problem decrementing the
post\_send\_buf\_count, or it was consumed as a flush error. no point
of keeping it for isert\_wait\_conn as there is no danger that
isert\_conn will be accidentally removed while it is running.
(Drop unnecessary sleep\_on\_conn\_wait\_comp check in
isert\_cq\_rx\_comp\_err - nab)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 3ddb875488bd3f4698199fd8ecd6ce8bb9b5c609
Author: Sagi Grimberg
Date: Mon May 19 17:44:22 2014 +0300
Target/iser: Bail from accept\_np if np\_thread is trying to close
commit e346ab343f4f58c12a96725c7b13df9cc2ad56f6 upstream.
In case np\_thread state is in RESET/SHUTDOWN/EXIT states,
no point for isert to stall there as we may get a hang in
case no one will wake it up later.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Greg Kroah-Hartman
commit 8d26d1a24bd8523902d8987a9b69462380c70fc3
Author: Jukka Taimisto
Date: Thu May 22 10:02:39 2014 +0000
Bluetooth: Fix L2CAP deadlock
commit 8a96f3cd22878fc0bb564a8478a6e17c0b8dca73 upstream.
-[0x01 Introduction
We have found a programming error causing a deadlock in Bluetooth subsystem
of Linux kernel. The problem is caused by missing release\_sock() call when
L2CAP connection creation fails due full accept queue.
The issue can be reproduced with 3.15-rc5 kernel and is also present in
earlier kernels.
-[0x02 Details
The problem occurs when multiple L2CAP connections are created to a PSM which
contains listening socket (like SDP) and left pending, for example,
configuration (the underlying ACL link is not disconnected between
connections).
When L2CAP connection request is received and listening socket is found the
l2cap\_sock\_new\_connection\_cb() function (net/bluetooth/l2cap\_sock.c) is called.
This function locks the 'parent' socket and then checks if the accept queue
is full.
1178 lock\_sock(parent);
1179
1180 /\* Check for backlog size \*/
1181 if (sk\_acceptq\_is\_full(parent)) {
1182 BT\_DBG("backlog full %d", parent->sk\_ack\_backlog);
1183 return NULL;
1184 }
If case the accept queue is full NULL is returned, but the 'parent' socket
is not released. Thus when next L2CAP connection request is received the code
blocks on lock\_sock() since the parent is still locked.
Also note that for connections already established and waiting for
configuration to complete a timeout will occur and l2cap\_chan\_timeout()
(net/bluetooth/l2cap\_core.c) will be called. All threads calling this
function will also be blocked waiting for the channel mutex since the thread
which is waiting on lock\_sock() alread holds the channel mutex.
We were able to reproduce this by sending continuously L2CAP connection
request followed by disconnection request containing invalid CID. This left
the created connections pending configuration.
After the deadlock occurs it is impossible to kill bluetoothd, btmon will not
get any more data etc. requiring reboot to recover.
-[0x03 Fix
Releasing the 'parent' socket when l2cap\_sock\_new\_connection\_cb() returns NULL
seems to fix the issue.
Signed-off-by: Jukka Taimisto
Reported-by: Tommi Mäkilä
Signed-off-by: Johan Hedberg
Signed-off-by: Greg Kroah-Hartman
commit a22d29e6e5757b1daed7d0b409a815eb33f66e4e
Author: Felipe Balbi
Date: Wed Apr 23 09:58:26 2014 -0500
bluetooth: hci\_ldisc: fix deadlock condition
commit da64c27d3c93ee9f89956b9de86c4127eb244494 upstream.
LDISCs shouldn't call tty->ops->write() from within
->write\_wakeup().
->write\_wakeup() is called with port lock taken and
IRQs disabled, tty->ops->write() will try to acquire
the same port lock and we will deadlock.
Acked-by: Marcel Holtmann
Reviewed-by: Peter Hurley
Reported-by: Huang Shijie
Signed-off-by: Felipe Balbi
Tested-by: Andreas Bießmann
Signed-off-by: Greg Kroah-Hartman
commit 1a73877050e0cc7638b42901762fa411abda2512
Author: Jianguo Wu
Date: Thu Apr 24 03:45:56 2014 +0100
ARM: 8037/1: mm: support big-endian page tables
commit 86f40622af7329375e38f282f6c0aab95f3e5f72 upstream.
When enable LPAE and big-endian in a hisilicon board, while specify
mem=384M mem=512M@7680M, will get bad page state:
Freeing unused kernel memory: 180K (c0466000 - c0493000)
BUG: Bad page state in process init pfn:fa442
page:c7749840 count:0 mapcount:-1 mapping: (null) index:0x0
page flags: 0x40000400(reserved)
Modules linked in:
CPU: 0 PID: 1 Comm: init Not tainted 3.10.27+ #66
[] (unwind\_backtrace+0x0/0x11c) from [] (show\_stack+0x10/0x14)
[] (show\_stack+0x10/0x14) from [] (bad\_page+0xd4/0x104)
[] (bad\_page+0xd4/0x104) from [] (free\_pages\_prepare+0xa8/0x14c)
[] (free\_pages\_prepare+0xa8/0x14c) from [] (free\_hot\_cold\_page+0x18/0xf0)
[] (free\_hot\_cold\_page+0x18/0xf0) from [] (handle\_pte\_fault+0xcf4/0xdc8)
[] (handle\_pte\_fault+0xcf4/0xdc8) from [] (handle\_mm\_fault+0xf4/0x120)
[] (handle\_mm\_fault+0xf4/0x120) from [] (do\_page\_fault+0xfc/0x354)
[] (do\_page\_fault+0xfc/0x354) from [] (do\_DataAbort+0x2c/0x90)
[] (do\_DataAbort+0x2c/0x90) from [] (\_\_dabt\_usr+0x34/0x40)
The bad pfn:fa442 is not system memory(mem=384M mem=512M@7680M), after debugging,
I find in page fault handler, will get wrong pfn from pte just after set pte,
as follow:
do\_anonymous\_page()
{
...
set\_pte\_at(mm, address, page\_table, entry);
//debug code
pfn = pte\_pfn(entry);
pr\_info("pfn:0x%lx, pte:0x%llxn", pfn, pte\_val(entry));
//read out the pte just set
new\_pte = pte\_offset\_map(pmd, address);
new\_pfn = pte\_pfn(\*new\_pte);
pr\_info("new pfn:0x%lx, new pte:0x%llxn", pfn, pte\_val(entry));
...
}
pfn: 0x1fa4f5, pte:0xc00001fa4f575f
new\_pfn:0xfa4f5, new\_pte:0xc00000fa4f5f5f //new pfn/pte is wrong.
The bug is happened in cpu\_v7\_set\_pte\_ext(ptep, pte):
An LPAE PTE is a 64bit quantity, passed to cpu\_v7\_set\_pte\_ext in the r2 and r3 registers.
On an LE kernel, r2 contains the LSB of the PTE, and r3 the MSB.
On a BE kernel, the assignment is reversed.
Unfortunately, the current code always assumes the LE case,
leading to corruption of the PTE when clearing/setting bits.
This patch fixes this issue much like it has been done already in the
cpu\_v7\_switch\_mm case.
Signed-off-by: Jianguo Wu
Acked-by: Marc Zyngier
Acked-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 7e80e18a8537af27b82693fe85ffbd818ef81a31
Author: Russell King
Date: Sat May 3 11:03:28 2014 +0100
ARM: stacktrace: avoid listing stacktrace functions in stacktrace
commit 3683f44c42e991d313dc301504ee0fca1aeb8580 upstream.
While debugging the FEC ethernet driver using stacktrace, it was noticed
that the stacktraces always begin as follows:
[] save\_stack\_trace\_tsk+0x0/0x98
[] save\_stack\_trace+0x24/0x28
...
This is because the stack trace code includes the stack frames for itself.
This is incorrect behaviour, and also leads to "skip" doing the wrong
thing (which is the number of stack frames to avoid recording.)
Perversely, it does the right thing when passed a non-current thread. Fix
this by ensuring that we have a known constant number of frames above the
main stack trace function, and always skip these.
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 40e1ff2db31677ab073ac091fe6b9915453b2f93
Author: Olivier Langlois
Date: Fri Mar 28 02:42:38 2014 -0300
media: uvcvideo: Fix clock param realtime setting
commit 3b35fc81e7ec552147a4fd843d0da0bbbe4ef253 upstream.
timestamps in v4l2 buffers returned to userspace are updated in
uvc\_video\_clock\_update() which uses timestamps fetched from
uvc\_video\_clock\_decode() by calling unconditionally ktime\_get\_ts().
Hence setting the module clock param to realtime has no effect before
this patch.
This has been tested with ffmpeg:
ffmpeg -y -f v4l2 -input\_format yuyv422 -video\_size 640x480 -framerate 30 -i /dev/video0 \
-f alsa -acodec pcm\_s16le -ar 16000 -ac 1 -i default \
-c:v libx264 -preset ultrafast \
-c:a libfdk\_aac \
out.mkv
and inspecting the v4l2 input starting timestamp.
Signed-off-by: Olivier Langlois
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 8df7e87020a3cc441ccb30ee0eb29f0eb4212733
Author: Lv Zheng
Date: Mon May 12 15:50:16 2014 +0800
ACPI: Fix conflict between customized DSDT and DSDT local copy
commit 73577d1df8e1f31f6b1a5eebcdbc334eb0330e47 upstream.
This patch fixes the following issue:
If DSDT is customized, no local DSDT copy is needed.
References: https://bugzilla.kernel.org/show\_bug.cgi?id=69711
Signed-off-by: Enrico Etxe Arte
Signed-off-by: Lv Zheng
[rjw: Subject]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 5e43bc687fbbd009b7dfd2c0eb73ca6e3dd6cf85
Author: David Binderman
Date: Fri Apr 4 12:36:55 2014 +0800
ACPICA: utstring: Check array index bound before use.
commit 5d42b0fa25df7ef2f575107597c1aaebe2407d10 upstream.
ACPICA BZ 1077. David Binderman.
References: https://bugs.acpica.org/show\_bug.cgi?id=1077
Signed-off-by: David Binderman
Signed-off-by: Bob Moore
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 50f865a928e13c8c5de0b8d3443387ea526b1da9
Author: Ezequiel Garcia
Date: Thu Apr 17 09:28:20 2014 -0300
media: stk1160: Avoid stack-allocated buffer for control URBs
commit 85ac1a1772bb41da895bad83a81f6a62c8f293f6 upstream.
Currently stk1160\_read\_reg() uses a stack-allocated char to get the
read control value. This is wrong because usb\_control\_msg() requires
a kmalloc-ed buffer.
This commit fixes such issue by kmalloc'ating a 1-byte buffer to receive
the read value.
While here, let's remove the urb\_buf array which was meant for a similar
purpose, but never really used.
Cc: Alan Stern
Reported-by: Sander Eikelenboom
Signed-off-by: Ezequiel Garcia
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit e48fee81d3ea8bc59d8fa8020fcd8077d3e12fe8
Author: Takashi Iwai
Date: Mon May 5 11:20:05 2014 -0300
media: ivtv: Fix Oops when no firmware is loaded
commit deb29e90221a6d4417aa67be971613c353180331 upstream.
When ivtv PCM device is accessed at the state where no firmware is
loaded, it oopses like:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000050
IP: [] try\_mailbox.isra.0+0x11/0x50 [ivtv]
Call Trace:
[] ivtv\_api\_call+0x160/0x6b0 [ivtv]
[] ivtv\_api+0x16/0x40 [ivtv]
[] ivtv\_vapi+0xac/0xc0 [ivtv]
[] ivtv\_start\_v4l2\_encode\_stream+0x19d/0x630 [ivtv]
[] snd\_ivtv\_pcm\_capture\_open+0x173/0x1c0 [ivtv\_alsa]
[] snd\_pcm\_open\_substream+0x51/0x100 [snd\_pcm]
[] snd\_pcm\_open+0xb3/0x260 [snd\_pcm]
[] snd\_pcm\_capture\_open+0x37/0x50 [snd\_pcm]
[] snd\_open+0xa7/0x1e0 [snd]
[] chrdev\_open+0x88/0x1d0
[] do\_dentry\_open+0x1de/0x270
[] do\_last+0x1c3/0xec0
[] path\_openat+0xb6/0x670
[] do\_filp\_open+0x35/0x80
[] do\_sys\_open+0x129/0x210
[] system\_call\_fastpath+0x1a/0x1f
This patch adds the check of firmware at PCM open callback like other
open callbacks of this driver.
Bugzilla: https://apibugzilla.novell.com/show\_bug.cgi?id=875440
Signed-off-by: Takashi Iwai
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit de8e4ac54c25de31540722defe639ed320b9c5fb
Author: Johan Hovold
Date: Mon May 26 19:23:33 2014 +0200
USB: serial: fix potential runtime pm imbalance at device remove
commit c14829fad88dbeda57253590695b85ba51270621 upstream.
Only call usb\_autopm\_put\_interface() if the corresponding
usb\_autopm\_get\_interface() was successful.
This prevents a potential runtime PM counter imbalance should
usb\_autopm\_get\_interface() fail. Note that the USB PM usage counter is
reset when the interface is unbound, but that the runtime PM counter may
be left unbalanced.
Also add comment on why we don't need to worry about racing
resume/suspend on autopm\_get failures.
Fixes: d5fd650cfc7f ("usb: serial: prevent suspend/resume from racing
against probe/remove")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b29a81694c1764194c67ee65678d17a5c9c325d9
Author: Aleksander Morgado
Date: Thu May 29 13:33:27 2014 +0200
usb: qcserial: add additional Sierra Wireless QMI devices
commit 0ce5fb58564fd85aa8fd2d24209900e2e845317b upstream.
A set of new VID/PIDs retrieved from the out-of-tree GobiNet/GobiSerial
Sierra Wireless drivers.
Signed-off-by: Aleksander Morgado
Link: http://marc.info/?l=linux-usb&m=140136310027293&w=2
Cc:  # backport in link above
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 7fc351de72efdea243b06476d90af687cb78817a
Author: Aleksander Morgado
Date: Wed May 28 21:13:51 2014 +0200
usb: qcserial: add Netgear AirCard 341U
commit ff1fcd50bc2459744e6f948310bc18eb7d6e8c72 upstream.
Signed-off-by: Aleksander Morgado
Signed-off-by: Greg Kroah-Hartman
commit 181eb8df48afdc364e422dbb38a64cd214abe51d
Author: Johan Hovold
Date: Mon May 26 19:22:54 2014 +0200
USB: sierra: fix remote wakeup
commit 80cc0fcbdaeaf10d04ba27779a2d7ceb73d2717a upstream.
Make sure that needs\_remote\_wake up is always set when there are open
ports.
Currently close() would unconditionally set needs\_remote\_wakeup to 0
even though there might still be open ports. This could lead to blocked
input and possibly dropped data on devices that do not support remote
wakeup (and which must therefore not be runtime suspended while open).
Add an open\_ports counter (protected by the susp\_lock) and only clear
needs\_remote\_wakeup when the last port is closed.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit ed02383a98177b99320602186eed08be351f53b3
Author: Johan Hovold
Date: Mon May 26 19:22:53 2014 +0200
USB: sierra: fix urb and memory leak on disconnect
commit 014333f77c0b71123d6ef7d31a9724e0699c9548 upstream.
The delayed-write queue was never emptied on disconnect, something which
would lead to leaked urbs and transfer buffers if the device is
disconnected before being runtime resumed due to a write.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit bdf377a2c355160eb3777f56ba5a2edce9729328
Author: Johan Hovold
Date: Mon May 26 19:22:52 2014 +0200
USB: sierra: fix urb and memory leak in resume error path
commit 7fdd26a01eb7b6cb6855ff8f69ef4a720720dfcb upstream.
Neither the transfer buffer or the urb itself were released in the
resume error path for delayed writes. Also on errors, the remainder of
the queue was not even processed, which leads to further urb and buffer
leaks.
The same error path also failed to balance the outstanding-urb counter,
something which results in degraded throughput or completely blocked
writes.
Fix this by releasing urb and buffer and balancing counters on errors,
and by always processing the whole queue even when submission of one urb
fails.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 188cccffa4a009fe9079a599e5f4604934e5f2a3
Author: Johan Hovold
Date: Mon May 26 19:22:51 2014 +0200
USB: sierra: fix use after free at suspend/resume
commit 8452727de70f6ad850cd6d0aaa18b5d9050aa63b upstream.
Fix use after free or NULL-pointer dereference during suspend and
resume.
The port data may never have been allocated (port probe failed)
or may already have been released by port\_remove (e.g. driver is
unloaded) when suspend and resume are called.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit fba1ebed450d9e1a97fb4cf7c711540ffd2a13bf
Author: Johan Hovold
Date: Mon May 26 19:22:50 2014 +0200
USB: sierra: fix AA deadlock in open error path
commit 353fe198602e8b4d1c7bdcceb8e60955087201b1 upstream.
Fix AA deadlock in open error path that would call close() and try to
grab the already held disc\_mutex.
Fixes: b9a44bc19f48 ("sierra: driver urb handling improvements")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit ead9a10ecb07019c15d9967bd094be93822ff7dd
Author: Johan Hovold
Date: Mon May 26 19:23:18 2014 +0200
USB: usb\_wwan: fix potential blocked I/O after resume
commit fb7ad4f93d9f0f7d49beda32f5e7becb94b29a4d upstream.
Keep trying to submit urbs rather than bail out on first read-urb
submission error, which would also prevent I/O for any further ports
from being resumed.
Instead keep an error count, for all types of failed submissions, and
let USB core know that something went wrong.
Also make sure to always clear the suspended flag. Currently a failed
read-urb submission would prevent cached writes as well as any
subsequent writes from being submitted until next suspend-resume cycle,
something which may not even necessarily happen.
Note that USB core currently only logs an error if an interface resume
failed.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit e3af525a11e5d4994f64d053524755ee07f12b83
Author: Johan Hovold
Date: Mon May 26 19:23:17 2014 +0200
USB: usb\_wwan: fix potential NULL-deref at resume
commit 9096f1fbba916c2e052651e9de82fcfb98d4bea7 upstream.
The interrupt urb was submitted unconditionally at resume, something
which could lead to a NULL-pointer dereference in the urb completion
handler as resume may be called after the port and port data is gone.
Fix this by making sure the interrupt urb is only submitted and active
when the port is open.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 95aa1da713373423086c8cdf0f62942439ae439a
Author: Johan Hovold
Date: Mon May 26 19:23:16 2014 +0200
USB: usb\_wwan: fix urb leak at shutdown
commit 79eed03e77d481b55d85d1cfe5a1636a0d3897fd upstream.
The delayed-write queue was never emptied at shutdown (close), something
which could lead to leaked urbs if the port is closed before being
runtime resumed due to a write.
When this happens the output buffer would not drain on close
(closing\_wait timeout), and after consecutive opens, writes could be
corrupted with previously buffered data, transfered with reduced
throughput or completely blocked.
Note that unbusy\_queued\_urb() was simply moved out of CONFIG\_PM.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 48222142bc7bd36a9214ea25a32024fe0bd0fab4
Author: Johan Hovold
Date: Mon May 26 19:23:15 2014 +0200
USB: usb\_wwan: fix write and suspend race
commit 170fad9e22df0063eba0701adb966786d7a4ec5a upstream.
Fix race between write() and suspend() which could lead to writes being
dropped (or I/O while suspended) if the device is runtime suspended
while a write request is being processed.
Specifically, suspend() releases the susp\_lock after determining the
device is idle but before setting the suspended flag, thus leaving a
window where a concurrent write() can submit an urb.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 0bc93bb2fc639ae0cb39752d14b4d13a0adbf559
Author: xiao jin
Date: Mon May 26 19:23:14 2014 +0200
USB: usb\_wwan: fix race between write and resume
commit d9e93c08d8d985e5ef89436ebc9f4aad7e31559f upstream.
We find a race between write and resume. usb\_wwan\_resume run play\_delayed()
and spin\_unlock, but intfdata->suspended still is not set to zero.
At this time usb\_wwan\_write is called and anchor the urb to delay
list. Then resume keep running but the delayed urb have no chance
to be commit until next resume. If the time of next resume is far
away, tty will be blocked in tty\_wait\_until\_sent during time. The
race also can lead to writes being reordered.
This patch put play\_Delayed and intfdata->suspended together in the
spinlock, it's to avoid the write race during resume.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 866c4e127c31e507fa851e6346a129945df05d65
Author: xiao jin
Date: Mon May 26 19:23:13 2014 +0200
USB: usb\_wwan: fix urb leak in write error path
commit db0904737947d509844e171c9863ecc5b4534005 upstream.
When enable usb serial for modem data, sometimes the tty is blocked
in tty\_wait\_until\_sent because portdata->out\_busy always is set and
have no chance to be cleared.
We find a bug in write error path. usb\_wwan\_write set portdata->out\_busy
firstly, then try autopm async with error. No out urb submit and no
usb\_wwan\_outdat\_callback to this write, portdata->out\_busy can't be
cleared.
This patch clear portdata->out\_busy if usb\_wwan\_write try autopm async
with error.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 031767d310d44ec8e1e244ad8e8d0f5564f4a49a
Author: Mikulas Patocka
Date: Thu May 15 06:58:24 2014 -0400
matroxfb: perform a dummy read of M\_STATUS
commit 972754cfaee94d6e25acf94a497bc0a864d91b7e upstream.
I had occasional screen corruption with the matrox framebuffer driver and
I found out that the reason for the corruption is that the hardware
blitter accesses the videoram while it is being written to.
The matrox driver has a macro WaitTillIdle() that should wait until the
blitter is idle, but it sometimes doesn't work. I added a dummy read
mga\_inl(M\_STATUS) to WaitTillIdle() to fix the problem. The dummy read
will flush the write buffer in the PCI chipset, and the next read of
M\_STATUS will return the hardware status.
Since applying this patch, I had no screen corruption at all.
Signed-off-by: Mikulas Patocka
Signed-off-by: Tomi Valkeinen
Signed-off-by: Greg Kroah-Hartman
commit dc10f332a7fce531cd44fc5984286369a6bb71f0
Author: Maurizio Lombardi
Date: Tue May 27 12:48:56 2014 -0400
ext4: fix wrong assert in ext4\_mb\_normalize\_request()
commit b5b60778558cafad17bbcbf63e0310bd3c68eb17 upstream.
The variable "size" is expressed as number of blocks and not as
number of clusters, this could trigger a kernel panic when using
ext4 with the size of a cluster different from the size of a block.
Signed-off-by: Maurizio Lombardi
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 327d2822e72d2f81adde6f8a8e5b9003634ae35a
Author: Jan Kara
Date: Tue May 27 12:48:55 2014 -0400
ext4: fix zeroing of page during writeback
commit eeece469dedadf3918bad50ad80f4616a0064e90 upstream.
Tail of a page straddling inode size must be zeroed when being written
out due to POSIX requirement that modifications of mmaped page beyond
inode size must not be written to the file. ext4\_bio\_write\_page() did
this only for blocks fully beyond inode size but didn't properly zero
blocks partially beyond inode size. Fix this.
The problem has been uncovered by mmap\_11-4 test in openposix test suite
(part of LTP).
Reported-by: Xiaoguang Wang
Fixes: 5a0dc7365c240
Fixes: bd2d0210cf22f
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 07e6e46256b9168213f4aa8896618367876fd9d1
Author: Christian Borntraeger
Date: Mon May 26 21:55:08 2014 +0200
s390/lowcore: reserve 96 bytes for IRB in lowcore
commit 993072ee67aa179c48c85eb19869804e68887d86 upstream.
The IRB might be 96 bytes if the extended-I/O-measurement facility is
used. This feature is currently not used by Linux, but struct irb
already has the emw defined. So let's make the irb in lowcore match the
size of the internal data structure to be future proof.
We also have to add a pad, to correctly align the paste.
The bigger irb field also circumvents a bug in some QEMU versions that
always write the emw field on test subchannel and therefore destroy the
paste definitions of this CPU. Running under these QEMU version broke
some timing functions in the VDSO and all users of these functions,
e.g. some JREs.
Signed-off-by: Christian Borntraeger
Signed-off-by: Martin Schwidefsky
Cc: Heiko Carstens
Cc: Sebastian Ott
Cc: Cornelia Huck
Signed-off-by: Greg Kroah-Hartman
commit 2ada32b01b05759c21e8ef86f97772e868075e9b
Author: Lai Jiangshan
Date: Fri Jun 6 14:37:10 2014 -0700
idr: fix overflow bug during maximum ID calculation at maximum height
commit 3afb69cb5572b3c8c898c00880803cf1a49852c4 upstream.
idr\_replace() open-codes the logic to calculate the maximum valid ID
given the height of the idr tree; unfortunately, the open-coded logic
doesn't account for the fact that the top layer may have unused slots
and over-shifts the limit to zero when the tree is at its maximum
height.
The following test code shows it fails to replace the value for
id=((1<<27)+42):
static void test5(void)
{
int id;
DEFINE\_IDR(test\_idr);
#define TEST5\_START ((1<<27)+42) /\* use the highest layer \*/
printk(KERN\_INFO "Start test5\n");
id = idr\_alloc(&test\_idr, (void \*)1, TEST5\_START, 0, GFP\_KERNEL);
BUG\_ON(id != TEST5\_START);
TEST\_BUG\_ON(idr\_replace(&test\_idr, (void \*)2, TEST5\_START) != (void \*)1);
idr\_destroy(&test\_idr);
printk(KERN\_INFO "End of test5\n");
}
Fix the bug by using idr\_max() which correctly takes into account the
maximum allowed shift.
sub\_alloc() shares the same problem and may incorrectly fail with
-EAGAIN; however, this bug doesn't affect correct operation because
idr\_get\_empty\_slot(), which already uses idr\_max(), retries with the
increased @id in such cases.
[tj@kernel.org: Updated patch description.]
Signed-off-by: Lai Jiangshan
Acked-by: Tejun Heo
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 97d4477d9ed34105490a2488ced97b16860ed4a8
Author: Will Deacon
Date: Mon Jun 2 11:47:23 2014 +0100
arm64: ptrace: change fs when passing kernel pointer to regset code
commit c168870704bcde6bb63d05f7882b620dd3985a46 upstream.
Our compat PTRACE\_POKEUSR implementation simply passes the user data to
regset\_copy\_from\_user after some simple range checking. Unfortunately,
the data in question has already been copied to the kernel stack by this
point, so the subsequent access\_ok check fails and the ptrace request
returns -EFAULT. This causes problems tracing fork() with older versions
of strace.
This patch briefly changes the fs to KERNEL\_DS, so that the access\_ok
check passes even with a kernel address.
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 1a2d973242a5ce1baec9dbef62548b7095b7f5aa
Author: Matthew Dempsky
Date: Fri Jun 6 14:36:42 2014 -0700
ptrace: fix fork event messages across pid namespaces
commit 4e52365f279564cef0ddd41db5237f0471381093 upstream.
When tracing a process in another pid namespace, it's important for fork
event messages to contain the child's pid as seen from the tracer's pid
namespace, not the parent's. Otherwise, the tracer won't be able to
correlate the fork event with later SIGTRAP signals it receives from the
child.
We still risk a race condition if a ptracer from a different pid
namespace attaches after we compute the pid\_t value. However, sending a
bogus fork event message in this unlikely scenario is still a vast
improvement over the status quo where we always send bogus fork event
messages to debuggers in a different pid namespace than the forking
process.
Signed-off-by: Matthew Dempsky
Acked-by: Oleg Nesterov
Cc: Kees Cook
Cc: Julien Tinnes
Cc: Roland McGrath
Cc: Jan Kratochvil
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit f26bff271a16480ed1e1f3d0420cb1d36acda093
Author: Johannes Weiner
Date: Fri Jun 6 14:35:35 2014 -0700
mm: vmscan: clear kswapd's special reclaim powers before exiting
commit 71abdc15adf8c702a1dd535f8e30df50758848d2 upstream.
When kswapd exits, it can end up taking locks that were previously held
by allocating tasks while they waited for reclaim. Lockdep currently
warns about this:
On Wed, May 28, 2014 at 06:06:34PM +0800, Gu Zheng wrote:
> inconsistent {RECLAIM\_FS-ON-W} -> {IN-RECLAIM\_FS-R} usage.
> kswapd2/1151 [HC0[0]:SC0[0]:HE1:SE1] takes:
> (&sig->group\_rwsem){+++++?}, at: exit\_signals+0x24/0x130
> {RECLAIM\_FS-ON-W} state was registered at:
> mark\_held\_locks+0xb9/0x140
> lockdep\_trace\_alloc+0x7a/0xe0
> kmem\_cache\_alloc\_trace+0x37/0x240
> flex\_array\_alloc+0x99/0x1a0
> cgroup\_attach\_task+0x63/0x430
> attach\_task\_by\_pid+0x210/0x280
> cgroup\_procs\_write+0x16/0x20
> cgroup\_file\_write+0x120/0x2c0
> vfs\_write+0xc0/0x1f0
> SyS\_write+0x4c/0xa0
> tracesys+0xdd/0xe2
> irq event stamp: 49
> hardirqs last enabled at (49): \_raw\_spin\_unlock\_irqrestore+0x36/0x70
> hardirqs last disabled at (48): \_raw\_spin\_lock\_irqsave+0x2b/0xa0
> softirqs last enabled at (0): copy\_process.part.24+0x627/0x15f0
> softirqs last disabled at (0): (null)
>
> other info that might help us debug this:
> Possible unsafe locking scenario:
>
> CPU0
> ----
> lock(&sig->group\_rwsem);
>
> lock(&sig->group\_rwsem);
>
> \*\*\* DEADLOCK \*\*\*
>
> no locks held by kswapd2/1151.
>
> stack backtrace:
> CPU: 30 PID: 1151 Comm: kswapd2 Not tainted 3.10.39+ #4
> Call Trace:
> dump\_stack+0x19/0x1b
> print\_usage\_bug+0x1f7/0x208
> mark\_lock+0x21d/0x2a0
> \_\_lock\_acquire+0x52a/0xb60
> lock\_acquire+0xa2/0x140
> down\_read+0x51/0xa0
> exit\_signals+0x24/0x130
> do\_exit+0xb5/0xa50
> kthread+0xdb/0x100
> ret\_from\_fork+0x7c/0xb0
This is because the kswapd thread is still marked as a reclaimer at the
time of exit. But because it is exiting, nobody is actually waiting on
it to make reclaim progress anymore, and it's nothing but a regular
thread at this point. Be tidy and strip it of all its powers
(PF\_MEMALLOC, PF\_SWAPWRITE, PF\_KSWAPD, and the lockdep reclaim state)
before returning from the thread function.
Signed-off-by: Johannes Weiner
Reported-by: Gu Zheng
Cc: Yasuaki Ishimatsu
Cc: Tang Chen
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9f125af2d4b35e36372f857b23e9087940ebcb40
Author: Kees Cook
Date: Thu Apr 17 13:22:09 2014 -0700
HID: core: fix validation of report id 0
commit 1b15d2e5b8077670b1e6a33250a0d9577efff4a5 upstream.
Some drivers use the first HID report in the list instead of using an
index. In these cases, validation uses ID 0, which was supposed to mean
"first known report". This fixes the problem, which was causing at least
the lgff family of devices to stop working since hid\_validate\_values
was being called with ID 0, but the devices used single numbered IDs
for their reports:
0x05, 0x01, /\* Usage Page (Desktop), \*/
0x09, 0x05, /\* Usage (Gamepad), \*/
0xA1, 0x01, /\* Collection (Application), \*/
0xA1, 0x02, /\* Collection (Logical), \*/
0x85, 0x01, /\* Report ID (1), \*/
...
Reported-by: Simon Wood
Signed-off-by: Kees Cook
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit ef1516486217fc24b0bd3555c593ae40d48b74eb
Author: Hugh Dickins
Date: Wed Jun 4 16:05:33 2014 -0700
mm: fix sleeping function warning from \_\_put\_anon\_vma
commit 7f39dda9d86fb4f4f17af0de170decf125726f8c upstream.
Trinity reports BUG:
sleeping function called from invalid context at kernel/locking/rwsem.c:47
in\_atomic(): 0, irqs\_disabled(): 0, pid: 5787, name: trinity-c27
\_\_might\_sleep < down\_write < \_\_put\_anon\_vma < page\_get\_anon\_vma <
migrate\_pages < compact\_zone < compact\_zone\_order < try\_to\_compact\_pages ..
Right, since conversion to mutex then rwsem, we should not put\_anon\_vma()
from inside an rcu\_read\_lock()ed section: fix the two places that did so.
And add might\_sleep() to anon\_vma\_free(), as suggested by Peter Zijlstra.
Fixes: 88c22088bf23 ("mm: optimize page\_lock\_anon\_vma() fast-path")
Reported-by: Dave Jones
Signed-off-by: Hugh Dickins
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 15e09f82416374a28bcea21315f600df344f9a6c
Author: Tony Luck
Date: Wed Jun 4 16:11:01 2014 -0700
mm/memory-failure.c: don't let collect\_procs() skip over processes for MF\_ACTION\_REQUIRED
commit 74614de17db6fb472370c426d4f934d8d616edf2 upstream.
When Linux sees an "action optional" machine check (where h/w has reported
an error that is not in the current execution path) we generally do not
want to signal a process, since most processes do not have a SIGBUS
handler - we'd just prematurely terminate the process for a problem that
they might never actually see.
task\_early\_kill() decides whether to consider a process - and it checks
whether this specific process has been marked for early signals with
"prctl", or if the system administrator has requested early signals for
all processes using /proc/sys/vm/memory\_failure\_early\_kill.
But for MF\_ACTION\_REQUIRED case we must not defer. The error is in the
execution path of the current thread so we must send the SIGBUS
immediatley.
Fix by passing a flag argument through collect\_procs\*() to
task\_early\_kill() so it knows whether we can defer or must take action.
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4451dd21497254e6f9d28a528bad70cf31a1db91
Author: Tony Luck
Date: Wed Jun 4 16:10:59 2014 -0700
mm/memory-failure.c-failure: send right signal code to correct thread
commit a70ffcac741d31a406c1d2b832ae43d658e7e1cf upstream.
When a thread in a multi-threaded application hits a machine check because
of an uncorrectable error in memory - we want to send the SIGBUS with
si.si\_code = BUS\_MCEERR\_AR to that thread. Currently we fail to do that
if the active thread is not the primary thread in the process.
collect\_procs() just finds primary threads and this test:
if ((flags & MF\_ACTION\_REQUIRED) && t == current) {
will see that the thread we found isn't the current thread and so send a
si.si\_code = BUS\_MCEERR\_AO to the primary (and nothing to the active
thread at this time).
We can fix this by checking whether "current" shares the same mm with the
process that collect\_procs() said owned the page. If so, we send the
SIGBUS to current (with code BUS\_MCEERR\_AR).
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Reported-by: Otto Bruggeman
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 16838de6ab0c2d951248b3a1c1591aa740af96b7
Author: Mel Gorman
Date: Wed Jun 4 16:07:35 2014 -0700
mm: vmscan: do not throttle based on pfmemalloc reserves if node has no ZONE\_NORMAL
commit 675becce15f320337499bc1a9356260409a5ba29 upstream.
throttle\_direct\_reclaim() is meant to trigger during swap-over-network
during which the min watermark is treated as a pfmemalloc reserve. It
throttes on the first node in the zonelist but this is flawed.
The user-visible impact is that a process running on CPU whose local
memory node has no ZONE\_NORMAL will stall for prolonged periods of time,
possibly indefintely. This is due to throttle\_direct\_reclaim thinking the
pfmemalloc reserves are depleted when in fact they don't exist on that
node.
On a NUMA machine running a 32-bit kernel (I know) allocation requests
from CPUs on node 1 would detect no pfmemalloc reserves and the process
gets throttled. This patch adjusts throttling of direct reclaim to
throttle based on the first node in the zonelist that has a usable
ZONE\_NORMAL or lower zone.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Mel Gorman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 326c178813c81b956bb74a75956ae86584928ec5
Author: Johan Hovold
Date: Mon May 26 19:23:10 2014 +0200
USB: option: fix runtime PM handling
commit acf47d4f9c39b1cba467aa9442fc2efe0b1da741 upstream.
Fix potential I/O while runtime suspended due to missing PM operations
in send\_setup.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 8df5309f802c8d414c8df81d24157467256aa3a7
Author: Alan Stern
Date: Tue Jun 3 11:00:27 2014 -0400
USB: EHCI: avoid BIOS handover on the HASEE E200
commit b0a50e92bda3c4aeb8017d4e6c6e92146ebd5c9b upstream.
Leandro Liptak reports that his HASEE E200 computer hangs when we ask
the BIOS to hand over control of the EHCI host controller. This
definitely sounds like a bug in the BIOS, but at the moment there is
no way to fix it.
This patch works around the problem by avoiding the handoff whenever
the motherboard and BIOS version match those of Leandro's computer.
Signed-off-by: Alan Stern
Reported-by: Leandro Liptak
Tested-by: Leandro Liptak
Signed-off-by: Greg Kroah-Hartman
commit d6a0d048e0e7fe71b9816f2a45b6871c79d41e8a
Author: Paul Bolle
Date: Fri May 16 12:00:57 2014 +0200
ARM: OMAP: replace checks for CONFIG\_USB\_GADGET\_OMAP
commit 77c2f02edbeda9409a7cf3fd66233015820c213a upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
apparently required that checks for CONFIG\_USB\_GADGET\_OMAP would be
replaced with checks for CONFIG\_USB\_OMAP. Do so now for the remaining
checks for CONFIG\_USB\_GADGET\_OMAP, even though these checks have
basically been broken since v3.1.
And, since we're touching this code, use the IS\_ENABLED() macro, so
things will now (hopefully) also work if USB\_OMAP is modular.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Tony Lindgren
Signed-off-by: Greg Kroah-Hartman
commit c3ea18ca97cf48e704048b225113e086c4413ede
Author: Felipe Balbi
Date: Wed Apr 16 10:30:33 2014 -0500
usb: dwc3: gadget: clear stall when disabling endpoint
commit 687ef9817df7ed960d14575b9033dde3d04631fe upstream.
so it seems like DWC3 IP doesn't clear stalls
automatically when we disable an endpoint, because
of that, we \_must\_ make sure stalls are cleared
before clearing the proper bit in DALEPENA register.
Reported-by: Johannes Stezenbach
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 0a0fac8835ff448f843cf06358d20dd0f2552992
Author: Paul Bolle
Date: Mon May 26 23:37:09 2014 +0200
usb: gadget: rename CONFIG\_USB\_GADGET\_PXA25X
commit d30f2065d6da377cc76771aca5a9850cfca8723b upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
basically renamed the Kconfig symbol USB\_GADGET\_PXA25X to USB\_PXA25X. It
did not rename the related macros in use at that time. Commit
c0a39151a405 ("ARM: pxa: fix inconsistent CONFIG\_USB\_PXA27X") did so for
all but one macro. Rename that last macro too now.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Greg Kroah-Hartman
commit 5dde7fc8137b342b67d229edcbf6bccfff732e96
Author: Alan Stern
Date: Tue Jun 3 11:11:34 2014 -0400
USB: usbtest: add a timeout for scatter-gather tests
commit 32b36eeae6a859670d2939a7d6136cb5e9ed64f8 upstream.
In usbtest, tests 5 - 8 use the scatter-gather library in usbcore
without any sort of timeout. If there's a problem in the gadget or
host controller being tested, the test can hang.
This patch adds a 10-second timeout to the tests, so that they will
fail gracefully with an ETIMEDOUT error instead of hanging.
Signed-off-by: Alan Stern
Reported-by: Huang Rui
Tested-by: Huang Rui
Signed-off-by: Greg Kroah-Hartman
commit 88d04dcd558ff714b2512540124bdff5953325ef
Author: Huang Rui
Date: Mon May 26 10:55:36 2014 +0800
usb: usbtest: fix unlink write error with pattern 1
commit e4d58f5dcb7d7be45df8def31881ebfae99c75da upstream.
TEST 12 and TEST 24 unlinks the URB write request for N times. When
host and gadget both initialize pattern 1 (mod 63) data series to
transfer, the gadget side will complain the wrong data which is not
expected. Because in host side, usbtest doesn't fill the data buffer
as mod 63 and this patch fixed it.
[20285.488974] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.489181] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.489423] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb50800 length 512 last
[20285.489727] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.490055] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.490281] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.490492] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Active
[20285.490713] dwc3 dwc3.0.auto: ep1out-bulk: endpoint busy
[20285.490909] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Complete
[20285.491117] dwc3 dwc3.0.auto: request ffff8800aa6cb480 from ep1out-bulk completed 512/512 ===> 0
[20285.491431] zero gadget: bad OUT byte, buf[1] = 0
[20285.491605] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Set Stall' params 00000000 00000000 00000000
[20285.491915] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.492099] dwc3 dwc3.0.auto: queing request ffff8800aa6cb480 to ep1out-bulk length 512
[20285.492387] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.492595] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.492830] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb51000 length 512 last
[20285.493135] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.493465] dwc3 dwc3.0.auto: Command Complete --> 0
Signed-off-by: Huang Rui
Signed-off-by: Greg Kroah-Hartman
commit fc7be702474fe5c795592047940c702783736294
Author: Dan Carpenter
Date: Fri May 9 14:59:16 2014 +0300
applicom: dereferencing NULL on error path
commit 8bab797c6e5724a43b7666ad70860712365cdb71 upstream.
This is a static checker fix. The "dev" variable is always NULL after
the while statement so we would be dereferencing a NULL pointer here.
Fixes: 819a3eba4233 ('[PATCH] applicom: fix error handling')
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit 06fc222e9d64a5af611acbcb4562d2e5ab595cad
Author: Paul Bolle
Date: Mon May 26 21:47:11 2014 +0200
staging: tidspbridge: check for CONFIG\_SND\_OMAP\_SOC\_MCBSP
commit d3921a03a89acb1b9ca599590c0131c89f8737d8 upstream.
Commit d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
removed the Kconfig symbol OMAP\_MCBSP. It left two checks for
CONFIG\_OMAP\_MCBSP untouched.
Convert these to checks for CONFIG\_SND\_OMAP\_SOC\_MCBSP. That must be
correct, since that re-enables calls to functions that are all found in
sound/soc/omap/mcbsp.c. And that file is built only if
CONFIG\_SND\_OMAP\_SOC\_MCBSP is defined.
Fixes: d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
Signed-off-by: Paul Bolle
Signed-off-by: Greg Kroah-Hartman
commit f9d3242c9b1657aa519a88549836c67236bc54c7
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:14 2014 +0200
extcon: max8997: Fix NULL pointer exception on missing pdata
commit dfee4111febf3d9ef3a640b2cd6205c75f4e7e3d upstream.
Fix NULL pointer exception when platform data is not supplied. The
driver dereferenced pdata pointer where it could be NULL.
Signed-off-by: Krzysztof Kozlowski
Fixes: 810d601f07c
Signed-off-by: Chanwoo Choi
Signed-off-by: Greg Kroah-Hartman
commit e0fc51f96172f207cf4cb276e6a31a5d438f6b06
Author: Johan Hovold
Date: Thu May 8 10:09:23 2014 +0200
net: cpsw: fix null dereference at probe
commit 6954cc1f238199e971ec905c5cc87120806ac981 upstream.
Fix null-pointer dereference at probe when the mdio platform device is
missing (e.g. when it has been disabled in DT).
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f6e39ac6156b2b46584d2dbbd4c2ead95e883552
Author: Ursula Braun
Date: Tue May 13 14:38:02 2014 +0200
af\_iucv: wrong mapping of sent and confirmed skbs
commit f5738e2ef88070ef1372e6e718124d88e9abe4ac upstream.
When sending data through IUCV a MESSAGE COMPLETE interrupt
signals that sent data memory can be freed or reused again.
With commit f9c41a62bba3f3f7ef3541b2a025e3371bcbba97
"af\_iucv: fix recvmsg by replacing skb\_pull() function" the
MESSAGE COMPLETE callback iucv\_callback\_txdone() identifies
the wrong skb as being confirmed, which leads to data corruption.
This patch fixes the skb mapping logic in iucv\_callback\_txdone().
Signed-off-by: Ursula Braun
Signed-off-by: Frank Blaschka
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 163cdc967af5001829d377017bf1e4defb2879f4
Author: Stephane Grosjean
Date: Tue May 20 11:38:56 2014 +0200
can: peak\_pci: prevent use after free at netdev removal
commit 0b5a958cf4df3a5cd578b861471e62138f55c85e upstream.
As remarked by Christopher R. Baker in his post at
http://marc.info/?l=linux-can&m=139707295706465&w=2
there's a possibility for an use after free condition at device removal.
This simplified patch introduces an additional variable to prevent the issue.
Thanks for catching this.
Reported-by: Christopher R. Baker
Signed-off-by: Stephane Grosjean
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman


=== Content from bugzilla.redhat.com_390756b5_20250125_060421.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1094602)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1094602)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1094602)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1094602

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1094602**](show_bug.cgi?id=1094602)
(CVE-2014-0206)
- [CVE-2014-0206](https://access.redhat.com/security/cve/CVE-2014-0206) kernel: aio: insufficient sanitization of head in aio\_read\_events\_ring()

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2014-0206 kernel: aio: insufficient sanitization of head in aio\_read\_even...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED ERRATA | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2014-0206 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1094604](show_bug.cgi?id=1094604) [1094605](show_bug.cgi?id=1094605) [1094606](show_bug.cgi?id=1094606) [1112975](show_bug.cgi?id=1112975 "CLOSED ERRATA - CVE-2014-0206 kernel: aio: insufficient sanitization of head in aio_read_events_ring() [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1094607](show_bug.cgi?id=1094607) | | TreeView+ | [depends on](buglist.cgi?bug_id=1094602&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1094602&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2014-05-06 06:39 UTC by Petr Matousek | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-05-12 03:32 UTC ([History](show_activity.cgi?id=1094602)) | | [CC List:](page.cgi?id=fields.html#cclist) | 24 users (show)  agordeev aquini bhu carnil dhoward esammons fhrbata iboverma jkacur jkurik jmoyer jross kernel-mgr lgoncalv lwang matt mcressma mguzik nobody npajkovs pholasek plougher security-response-team williams | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: |  | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2014-07-22 20:01:46 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | |    Links | System | ID | Private | Priority | Status | Summary | Last Updated | | Red Hat Product Errata | [RHSA-2014:0786](https://access.redhat.com/errata/RHSA-2014%3A0786) | 0 | normal | SHIPPED\_LIVE | Important: kernel security, bug fix, and enhancement update | 2014-06-24 19:58:32 UTC | | Red Hat Product Errata | [RHSA-2014:0913](https://access.redhat.com/errata/RHSA-2014%3A0913) | 0 | normal | SHIPPED\_LIVE | Important: kernel-rt security update | 2014-07-22 22:00:11 UTC | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1094602#c0)  Petr Matousek    2014-05-06 06:39:19 UTC  ``` It was found that aio_read_events_ring() function in the Linux kernel's AIO subsystem did not properly sanitize AIO ring head coming from userspace.  An unprivileged local user could use this flaw to randomly disclose parts of (physical) memory belonging to kernel and/or other processes.  Introduced by: <http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=a31ad380bed817aa25f8830ad23e1a0480fef797>  Upstream commits: <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=edfbbf388f29> <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=f8567a3845ac>  Acknowledgements:  This issue was discovered by Mateusz Guzik of Red Hat.   ```  [Comment 5](show_bug.cgi?id=1094602#c5)  Petr Matousek    2014-06-24 11:17:40 UTC  ``` Statement:  This issue does not affect the Linux kernel packages as shipped with Red Hat Enterprise Linux 5 and 6.   ```  [Comment 8](show_bug.cgi?id=1094602#c8)  errata-xmlrpc    2014-06-24 15:59:36 UTC  ``` This issue has been addressed in following products:    Red Hat Enterprise Linux 7  Via RHSA-2014:0786 <https://rhn.redhat.com/errata/RHSA-2014-0786.html>   ```  [Comment 9](show_bug.cgi?id=1094602#c9)  Petr Matousek    2014-06-25 07:33:33 UTC  ``` Proposed upstream patches:    <https://lkml.org/lkml/2014/6/24/619>   <https://lkml.org/lkml/2014/6/24/623>   ```  [Comment 10](show_bug.cgi?id=1094602#c10)  Petr Matousek    2014-06-25 07:34:37 UTC  ```  Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1112975](show_bug.cgi?id=1112975 "CLOSED ERRATA - CVE-2014-0206 kernel: aio: insufficient sanitization of head in aio_read_events_ring() [fedora-all]")]   ```  [Comment 11](show_bug.cgi?id=1094602#c11)  John Kacur    2014-06-27 12:52:40 UTC  ``` The comments on the patches claim to need a separate backport for v3.10 / v3.11, although they look like they would apply cleanly. Is this true? If so, when can we expect them?   ```  [Comment 12](show_bug.cgi?id=1094602#c12)  Jeff Moyer    2014-06-27 13:06:26 UTC  ``` (In reply to John Kacur from [comment #11](show_bug.cgi?id=1094602#c11)) > The comments on the patches claim to need a separate backport for v3.10 / > v3.11, although they look like they would apply cleanly. Is this true? If > so, when can we expect them?  They've already been posted upstream.  <http://www.spinics.net/lists/stable/msg51486.html> <http://www.spinics.net/lists/stable/msg51487.html>   ```  [Comment 13](show_bug.cgi?id=1094602#c13)  Fedora Update System    2014-06-30 10:29:07 UTC  ``` kernel-3.14.9-200.fc20 has been pushed to the Fedora 20 stable repository.  If problems still persist, please make note of it in this bug report.   ```  [Comment 14](show_bug.cgi?id=1094602#c14)  errata-xmlrpc    2014-07-22 18:01:04 UTC  ``` This issue has been addressed in following products:    MRG for RHEL-6 v.2  Via RHSA-2014:0913 <https://rhn.redhat.com/errata/RHSA-2014-0913.html>   ```  [Comment 15](show_bug.cgi?id=1094602#c15)  Fedora Update System    2014-07-25 10:08:38 UTC  ``` kernel-3.14.13-100.fc19 has been pushed to the Fedora 19 stable repository.  If problems still persist, please make note of it in this bug report.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1094602&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from source.android.com_973c70d2_20250125_060423.html ===


[![Android Open Source Project](https://www.gstatic.com/devrel-devsite/prod/v2c0608cfe9941cacf4435921a2ece588be3719df069d9fba67130a84e4743128/androidsource/images/lockup.svg)](/)

`/`

* English
* Deutsch
* Español
* Español – América Latina
* Français
* Indonesia
* Italiano
* Polski
* Português
* Português – Brasil
* Tiếng Việt
* Türkçe
* Русский
* עברית
* العربيّة
* فارسی
* हिंदी
* বাংলা
* ภาษาไทย
* 中文 – 简体
* 中文 – 繁體
* 日本語
* 한국어

[Android Code Search](https://cs.android.com/android/platform/superproject/main)
Sign in

* [Documentation](https://source.android.com/docs)

[What's New?](https://source.android.com/docs/whatsnew)

[Getting Started](https://source.android.com/docs/setup)

[Security](https://source.android.com/docs/security)

[Core Topics](https://source.android.com/docs/core)

[Compatibility](https://source.android.com/docs/compatibility)

[Android Devices](https://source.android.com/docs/devices)

[Automotive](https://source.android.com/docs/automotive)

[Reference](https://source.android.com/reference)

[![Android Open Source Project](https://www.gstatic.com/devrel-devsite/prod/v2c0608cfe9941cacf4435921a2ece588be3719df069d9fba67130a84e4743128/androidsource/images/lockup.svg)](/)

* [Docs](/docs)
  + More
  + [What's New?](/docs/whatsnew)
  + [Getting Started](/docs/setup)
  + [Security](/docs/security)
  + [Core Topics](/docs/core)
  + [Compatibility](/docs/compatibility)
  + [Android Devices](/docs/devices)
  + [Automotive](/docs/automotive)
  + [Reference](/reference)
* [Android Code Search](https://cs.android.com/android/platform/superproject/main)

* [Overview](/docs/security)
* Security overview
  + [Secure an Android device](/docs/security/overview)
  + [Kernel security](/docs/security/overview/kernel-security)
  + [App security](/docs/security/overview/app-security)
  + [Implement security](/docs/security/overview/implement)
  + [Updates and resources](/docs/security/overview/updates-resources)
  + [ASPIRE](/docs/security/overview/aspire)
  + [Reports](/docs/security/overview/reports)
  + [Enhancements](/docs/security/enhancements)
  + [Acknowledgements](/docs/security/overview/acknowledgements)
* Android Security Bulletins
  + [Bulletins home](/docs/security/bulletin)
  + [Overview](/docs/security/bulletin/asb-overview)
  + 2025 bulletins
    - [January](/docs/security/bulletin/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/2024-12-01)
    - [November](/docs/security/bulletin/2024-11-01)
    - [October](/docs/security/bulletin/2024-10-01)
    - [September](/docs/security/bulletin/2024-09-01)
    - [August](/docs/security/bulletin/2024-08-01)
    - [July](/docs/security/bulletin/2024-07-01)
    - [June](/docs/security/bulletin/2024-06-01)
    - [May](/docs/security/bulletin/2024-05-01)
    - [April](/docs/security/bulletin/2024-04-01)
    - [March](/docs/security/bulletin/2024-03-01)
    - [February](/docs/security/bulletin/2024-02-01)
    - [January](/docs/security/bulletin/2024-01-01)
    - [Android 15](/docs/security/bulletin/android-15)
  + 2023 bulletins
    - [December](/docs/security/bulletin/2023-12-01)
    - [November](/docs/security/bulletin/2023-11-01)
    - [October](/docs/security/bulletin/2023-10-01)
    - [September](/docs/security/bulletin/2023-09-01)
    - [August](/docs/security/bulletin/2023-08-01)
    - [July](/docs/security/bulletin/2023-07-01)
    - [June](/docs/security/bulletin/2023-06-01)
    - [May](/docs/security/bulletin/2023-05-01)
    - [April](/docs/security/bulletin/2023-04-01)
    - [March](/docs/security/bulletin/2023-03-01)
    - [February](/docs/security/bulletin/2023-02-01)
    - [January](/docs/security/bulletin/2023-01-01)
    - [Android 14](/docs/security/bulletin/android-14)
  + 2022 bulletins
    - [December](/docs/security/bulletin/2022-12-01)
    - [November](/docs/security/bulletin/2022-11-01)
    - [October](/docs/security/bulletin/2022-10-01)
    - [September](/docs/security/bulletin/2022-09-01)
    - [August](/docs/security/bulletin/2022-08-01)
    - [July](/docs/security/bulletin/2022-07-01)
    - [June](/docs/security/bulletin/2022-06-01)
    - [May](/docs/security/bulletin/2022-05-01)
    - [April](/docs/security/bulletin/2022-04-01)
    - [March](/docs/security/bulletin/2022-03-01)
    - [Android 12L](/docs/security/bulletin/android-12l)
    - [February](/docs/security/bulletin/2022-02-01)
    - [January](/docs/security/bulletin/2022-01-01)
    - [Android 13](/docs/security/bulletin/android-13)
    - [Index](/docs/security/bulletin/2022)
  + 2021 bulletins
    - [December](/docs/security/bulletin/2021-12-01)
    - [November](/docs/security/bulletin/2021-11-01)
    - [October](/docs/security/bulletin/2021-10-01)
    - [September](/docs/security/bulletin/2021-09-01)
    - [August](/docs/security/bulletin/2021-08-01)
    - [July](/docs/security/bulletin/2021-07-01)
    - [June](/docs/security/bulletin/2021-06-01)
    - [May](/docs/security/bulletin/2021-05-01)
    - [April](/docs/security/bulletin/2021-04-01)
    - [March](/docs/security/bulletin/2021-03-01)
    - [February](/docs/security/bulletin/2021-02-01)
    - [January](/docs/security/bulletin/2021-01-01)
    - [Android 12](/docs/security/bulletin/android-12)
    - [Index](/docs/security/bulletin/2021)
  + 2020 bulletins
    - [December](/docs/security/bulletin/2020-12-01)
    - [November](/docs/security/bulletin/2020-11-01)
    - [October](/docs/security/bulletin/2020-10-01)
    - [September](/docs/security/bulletin/2020-09-01)
    - [August](/docs/security/bulletin/2020-08-01)
    - [July](/docs/security/bulletin/2020-07-01)
    - [June](/docs/security/bulletin/2020-06-01)
    - [May](/docs/security/bulletin/2020-05-01)
    - [April](/docs/security/bulletin/2020-04-01)
    - [March](/docs/security/bulletin/2020-03-01)
    - [February](/docs/security/bulletin/2020-02-01)
    - [January](/docs/security/bulletin/2020-01-01)
    - [Android 11](/docs/security/bulletin/android-11)
    - [Index](/docs/security/bulletin/2020)
  + 2019 bulletins
    - [December](/docs/security/bulletin/2019-12-01)
    - [November](/docs/security/bulletin/2019-11-01)
    - [October](/docs/security/bulletin/2019-10-01)
    - [September](/docs/security/bulletin/2019-09-01)
    - [August](/docs/security/bulletin/2019-08-01)
    - [July](/docs/security/bulletin/2019-07-01)
    - [June](/docs/security/bulletin/2019-06-01)
    - [May](/docs/security/bulletin/2019-05-01)
    - [April](/docs/security/bulletin/2019-04-01)
    - [March](/docs/security/bulletin/2019-03-01)
    - [February](/docs/security/bulletin/2019-02-01)
    - [January](/docs/security/bulletin/2019-01-01)
    - [Android 10](/docs/security/bulletin/android-10)
    - [Index](/docs/security/bulletin/2019)
  + 2018 bulletins
    - [December](/docs/security/bulletin/2018-12-01)
    - [November](/docs/security/bulletin/2018-11-01)
    - [October](/docs/security/bulletin/2018-10-01)
    - [September](/docs/security/bulletin/2018-09-01)
    - [August](/docs/security/bulletin/2018-08-01)
    - [July](/docs/security/bulletin/2018-07-01)
    - [June](/docs/security/bulletin/2018-06-01)
    - [May](/docs/security/bulletin/2018-05-01)
    - [April](/docs/security/bulletin/2018-04-01)
    - [March](/docs/security/bulletin/2018-03-01)
    - [February](/docs/security/bulletin/2018-02-01)
    - [January](/docs/security/bulletin/2018-01-01)
    - [Index](/docs/security/bulletin/2018)
  + 2017 bulletins
    - [December](/docs/security/bulletin/2017-12-01)
    - [November](/docs/security/bulletin/2017-11-01)
    - [October](/docs/security/bulletin/2017-10-01)
    - [September](/docs/security/bulletin/2017-09-01)
    - [August](/docs/security/bulletin/2017-08-01)
    - [July](/docs/security/bulletin/2017-07-01)
    - [June](/docs/security/bulletin/2017-06-01)
    - [May](/docs/security/bulletin/2017-05-01)
    - [April](/docs/security/bulletin/2017-04-01)
    - [March](/docs/security/bulletin/2017-03-01)
    - [February](/docs/security/bulletin/2017-02-01)
    - [January](/docs/security/bulletin/2017-01-01)
    - [Index](/docs/security/bulletin/2017)
  + 2016 bulletins
    - [December](/docs/security/bulletin/2016-12-01)
    - [November](/docs/security/bulletin/2016-11-01)
    - [October](/docs/security/bulletin/2016-10-01)
    - [September](/docs/security/bulletin/2016-09-01)
    - [August](/docs/security/bulletin/2016-08-01)
    - [July](/docs/security/bulletin/2016-07-01)
    - [June](/docs/security/bulletin/2016-06-01)
    - [May](/docs/security/bulletin/2016-05-01)
    - [April](/docs/security/bulletin/2016-04-02)
    - [March](/docs/security/bulletin/2016-03-01)
    - [February](/docs/security/bulletin/2016-02-01)
    - [January](/docs/security/bulletin/2016-01-01)
    - [Index](/docs/security/bulletin/2016)
  + 2015 bulletins
    - [December](/docs/security/bulletin/2015-12-01)
    - [November](/docs/security/bulletin/2015-11-01)
    - [October](/docs/security/bulletin/2015-10-01)
    - [September](/docs/security/bulletin/2015-09-01)
    - [August](/docs/security/bulletin/2015-08-01)
    - [Index](/docs/security/bulletin/2015)
  + Pixel/Nexus bulletins
  + [Overview](/docs/security/bulletin/pixel)
  + 2025 bulletins
    - [January](/docs/security/bulletin/pixel/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/pixel/2024-12-01)
    - [November](/docs/security/bulletin/pixel/2024-11-01)
    - [October](/docs/security/bulletin/pixel/2024-10-01)
    - [September](/docs/security/bulletin/pixel/2024-09-01)
    - [August](/docs/security/bulletin/pixel/2024-08-01)
    - [July](/docs/security/bulletin/pixel/2024-07-01)
    - [June](/docs/security/bulletin/pixel/2024-06-01)
    - [May](/docs/security/bulletin/pixel/2024-05-01)
    - [April](/docs/security/bulletin/pixel/2024-04-01)
    - [March](/docs/security/bulletin/pixel/2024-03-01)
    - [February](/docs/security/bulletin/pixel/2024-02-01)
    - [January](/docs/security/bulletin/pixel/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/pixel/2023-12-01)
    - [November](/docs/security/bulletin/pixel/2023-11-01)
    - [October](/docs/security/bulletin/pixel/2023-10-01)
    - [September](/docs/security/bulletin/pixel/2023-09-01)
    - [August](/docs/security/bulletin/pixel/2023-08-01)
    - [July](/docs/security/bulletin/pixel/2023-07-01)
    - [June](/docs/security/bulletin/pixel/2023-06-01)
    - [May](/docs/security/bulletin/pixel/2023-05-01)
    - [April](/docs/security/bulletin/pixel/2023-04-01)
    - [March](/docs/security/bulletin/pixel/2023-03-01)
    - [February](/docs/security/bulletin/pixel/2023-02-01)
    - [January](/docs/security/bulletin/pixel/2023-01-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/pixel/2022-12-01)
    - [November](/docs/security/bulletin/pixel/2022-11-01)
    - [October](/docs/security/bulletin/pixel/2022-10-01)
    - [September](/docs/security/bulletin/pixel/2022-09-01)
    - [August](/docs/security/bulletin/pixel/2022-08-01)
    - [July](/docs/security/bulletin/pixel/2022-07-01)
    - [June](/docs/security/bulletin/pixel/2022-06-01)
    - [May](/docs/security/bulletin/pixel/2022-05-01)
    - [April](/docs/security/bulletin/pixel/2022-04-01)
    - [March](/docs/security/bulletin/pixel/2022-03-01)
    - [February](/docs/security/bulletin/pixel/2022-02-01)
    - [January](/docs/security/bulletin/pixel/2022-01-01)
  + 2021 bulletins
    - [December](/docs/security/bulletin/pixel/2021-12-01)
    - [November](/docs/security/bulletin/pixel/2021-11-01)
    - [October](/docs/security/bulletin/pixel/2021-10-01)
    - [September](/docs/security/bulletin/pixel/2021-09-01)
    - [August](/docs/security/bulletin/pixel/2021-08-01)
    - [July](/docs/security/bulletin/pixel/2021-07-01)
    - [June](/docs/security/bulletin/pixel/2021-06-01)
    - [May](/docs/security/bulletin/pixel/2021-05-01)
    - [April](/docs/security/bulletin/pixel/2021-04-01)
    - [March](/docs/security/bulletin/pixel/2021-03-01)
    - [February](/docs/security/bulletin/pixel/2021-02-01)
    - [January](/docs/security/bulletin/pixel/2021-01-01)
    - [Index](/docs/security/bulletin/pixel/2021)
  + 2020 bulletins
    - [December](/docs/security/bulletin/pixel/2020-12-01)
    - [November](/docs/security/bulletin/pixel/2020-11-01)
    - [October](/docs/security/bulletin/pixel/2020-10-01)
    - [September](/docs/security/bulletin/pixel/2020-09-01)
    - [August](/docs/security/bulletin/pixel/2020-08-01)
    - [July](/docs/security/bulletin/pixel/2020-07-01)
    - [June](/docs/security/bulletin/pixel/2020-06-01)
    - [May](/docs/security/bulletin/pixel/2020-05-01)
    - [April](/docs/security/bulletin/pixel/2020-04-01)
    - [March](/docs/security/bulletin/pixel/2020-03-01)
    - [February](/docs/security/bulletin/pixel/2020-02-01)
    - [January](/docs/security/bulletin/pixel/2020-01-01)
    - [Index](/docs/security/bulletin/pixel/2020)
  + 2019 bulletins
    - [December](/docs/security/bulletin/pixel/2019-12-01)
    - [November](/docs/security/bulletin/pixel/2019-11-01)
    - [October](/docs/security/bulletin/pixel/2019-10-01)
    - [September](/docs/security/bulletin/pixel/2019-09-01)
    - [August](/docs/security/bulletin/pixel/2019-08-01)
    - [July](/docs/security/bulletin/pixel/2019-07-01)
    - [June](/docs/security/bulletin/pixel/2019-06-01)
    - [May](/docs/security/bulletin/pixel/2019-05-01)
    - [April](/docs/security/bulletin/pixel/2019-04-01)
    - [March](/docs/security/bulletin/pixel/2019-03-01)
    - [February](/docs/security/bulletin/pixel/2019-02-01)
    - [January](/docs/security/bulletin/pixel/2019-01-01)
    - [Index](/docs/security/bulletin/pixel/2019)
  + 2018 bulletins
    - [December](/docs/security/bulletin/pixel/2018-12-01)
    - [November](/docs/security/bulletin/pixel/2018-11-01)
    - [October](/docs/security/bulletin/pixel/2018-10-01)
    - [September](/docs/security/bulletin/pixel/2018-09-01)
    - [August](/docs/security/bulletin/pixel/2018-08-01)
    - [July](/docs/security/bulletin/pixel/2018-07-01)
    - [June](/docs/security/bulletin/pixel/2018-06-01)
    - [May](/docs/security/bulletin/pixel/2018-05-01)
    - [April](/docs/security/bulletin/pixel/2018-04-01)
    - [March](/docs/security/bulletin/pixel/2018-03-01)
    - [February](/docs/security/bulletin/pixel/2018-02-01)
    - [January](/docs/security/bulletin/pixel/2018-01-01)
    - [Index](/docs/security/bulletin/pixel/2018)
  + 2017 bulletins
    - [December](/docs/security/bulletin/pixel/2017-12-01)
    - [November](/docs/security/bulletin/pixel/2017-11-01)
    - [October](/docs/security/bulletin/pixel/2017-10-01)
    - [Index](/docs/security/bulletin/pixel/2017)
  + Android Automotive
  + [Overview](/docs/security/bulletin/aaos)
  + 2025 bulletins
    - [January](/docs/security/bulletin/aaos/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/aaos/2024-12-01)
    - [November](/docs/security/bulletin/aaos/2024-11-01)
    - [October](/docs/security/bulletin/aaos/2024-10-01)
    - [September](/docs/security/bulletin/aaos/2024-09-01)
    - [August](/docs/security/bulletin/aaos/2024-08-01)
    - [July](/docs/security/bulletin/aaos/2024-07-01)
    - [June](/docs/security/bulletin/aaos/2024-06-01)
    - [May](/docs/security/bulletin/aaos/2024-05-01)
    - [April](/docs/security/bulletin/aaos/2024-04-01)
    - [March](/docs/security/bulletin/aaos/2024-03-01)
    - [February](/docs/security/bulletin/aaos/2024-02-01)
    - [January](/docs/security/bulletin/aaos/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/aaos/2023-12-01)
    - [November](/docs/security/bulletin/aaos/2023-11-01)
    - [October](/docs/security/bulletin/aaos/2023-10-01)
    - [September](/docs/security/bulletin/aaos/2023-09-01)
    - [August](/docs/security/bulletin/aaos/2023-08-01)
    - [July](/docs/security/bulletin/aaos/2023-07-01)
    - [June](/docs/security/bulletin/aaos/2023-06-01)
    - [May](/docs/security/bulletin/aaos/2023-05-01)
    - [April](/docs/security/bulletin/aaos/2023-04-01)
    - [March](/docs/security/bulletin/aaos/2023-03-01)
    - [February](/docs/security/bulletin/aaos/2023-02-01)
    - [January](/docs/security/bulletin/aaos/2023-01-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/aaos/2022-12-01)
    - [November](/docs/security/bulletin/aaos/2022-11-01)
    - [October](/docs/security/bulletin/aaos/2022-10-01)
    - [September](/docs/security/bulletin/aaos/2022-09-01)
    - [August](/docs/security/bulletin/aaos/2022-08-01)
    - [July](/docs/security/bulletin/aaos/2022-07-01)
    - [June](/docs/security/bulletin/aaos/2022-06-01)
    - [May](/docs/security/bulletin/aaos/2022-05-01)
    - [April](/docs/security/bulletin/aaos/2022-04-01)
    - [March](/docs/security/bulletin/aaos/2022-03-01)
    - [February](/docs/security/bulletin/aaos/2022-02-01)
    - [January](/docs/security/bulletin/aaos/2022-01-01)
  + 2021 bulletins
    - [December](/docs/security/bulletin/aaos/2021-12-01)
    - [November](/docs/security/bulletin/aaos/2021-11-01)
    - [October](/docs/security/bulletin/aaos/2021-10-01)
    - [September](/docs/security/bulletin/aaos/2021-09-01)
    - [August](/docs/security/bulletin/aaos/2021-08-01)
    - [July](/docs/security/bulletin/aaos/2021-07-01)
    - [June](/docs/security/bulletin/aaos/2021-06-01)
    - [May](/docs/security/bulletin/aaos/2021-05-01)
    - [April](/docs/security/bulletin/aaos/2021-04-01)
    - [March](/docs/security/bulletin/aaos/2021-03-01)
    - [February](/docs/security/bulletin/aaos/2021-02-01)
    - [January](/docs/security/bulletin/aaos/2021-01-01)
  + Chromecast
  + [Overview](/docs/security/bulletin/chromecast)
  + 2024 bulletins
    - [December](/docs/security/bulletin/chromecast/2024-12-01)
    - [September](/docs/security/bulletin/chromecast/2024-09-01)
    - [July](/docs/security/bulletin/chromecast/2024-07-01)
    - [March](/docs/security/bulletin/chromecast/2024-03-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/chromecast/2023-12-01)
    - [September](/docs/security/bulletin/chromecast/2023-07-01)
    - [June](/docs/security/bulletin/chromecast/2023-06-01)
    - [April](/docs/security/bulletin/chromecast/2023-04-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/chromecast/2022-12-01)
    - [October](/docs/security/bulletin/chromecast/2022-10-01)
    - [July](/docs/security/bulletin/chromecast/2022-07-01)
  + Wear
  + [Overview](/docs/security/bulletin/wear)
  + 2025 bulletins
    - [January](/docs/security/bulletin/wear/2025/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/wear/2024/2024-12-01)
    - [November](/docs/security/bulletin/wear/2024/2024-11-01)
    - [October](/docs/security/bulletin/wear/2024/2024-10-01)
    - [September](/docs/security/bulletin/wear/2024/2024-09-01)
    - [August](/docs/security/bulletin/wear/2024/2024-08-01)
    - [July](/docs/security/bulletin/wear/2024/2024-07-01)
    - [June](/docs/security/bulletin/wear/2024/2024-06-01)
    - [May](/docs/security/bulletin/wear/2024/2024-05-01)
    - [April](/docs/security/bulletin/wear/2024/2024-04-01)
    - [March](/docs/security/bulletin/wear/2024/2024-03-01)
    - [February](/docs/security/bulletin/wear/2024/2024-02-01)
    - [January](/docs/security/bulletin/wear/2024/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/wear/2023/2023-12-01)
    - [November](/docs/security/bulletin/wear/2023/2023-11-01)
    - [October](/docs/security/bulletin/wear/2023/2023-10-01)
    - [September](/docs/security/bulletin/wear/2023/2023-09-01)
    - [August](/docs/security/bulletin/wear/2023/2023-08-01)
  + Pixel Watch
  + [Overview](/docs/security/bulletin/pixel-watch)
  + 2024 bulletins
    - [December](/docs/security/bulletin/pixel-watch/2024-12-01)
    - [August](/docs/security/bulletin/pixel-watch/2024-08-01)
    - [July](/docs/security/bulletin/pixel-watch/2024-07-01)
    - [June](/docs/security/bulletin/pixel-watch/2024-06-01)
    - [May](/docs/security/bulletin/pixel-watch/2024-05-01)
    - [April](/docs/security/bulletin/pixel-watch/2024-04-01)
    - [March](/docs/security/bulletin/pixel-watch/2024-03-01)
    - [February](/docs/security/bulletin/pixel-watch/2024-02-01)
    - [January](/docs/security/bulletin/pixel-watch/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/pixel-watch/2023/2023-12-01)
    - [September](/docs/security/bulletin/pixel-watch/2023/2023-09-01)
    - [June](/docs/security/bulletin/pixel-watch/2023/2023-06-01)
  + Advisories
  + [Overview](/docs/security/bulletin/advisory)
  + [March 2016](/docs/security/bulletin/advisory/2016-03-18)
* Features
  + [Overview](/docs/security/features)
  + [Application Sandbox](/docs/security/app-sandbox)
  + [OMAPI vendor stable interface](/docs/security/features/open-mobile-api)
  + App signing
    - [Overview](/docs/security/features/apksigning)
    - [APK signature scheme v2](/docs/security/features/apksigning/v2)
    - [APK signature scheme v3](/docs/security/features/apksigning/v3)
    - [APK signature scheme v3.1](/docs/security/features/apksigning/v3-1)
    - [APK signature scheme v4](/docs/security/features/apksigning/v4)
  + Authentication
    - [Overview](/docs/security/features/authentication)
    - [Gatekeeper](/docs/security/features/authentication/gatekeeper)
    - Biometrics
      * [Overview](/docs/security/features/biometric)
      * [Measure biometric security](/docs/security/features/biometric/measure)
      * [Fingerprint HIDL](/docs/security/features/authentication/fingerprint-hal)
      * [Face authentication HIDL](/docs/security/features/biometric/face-authentication)
    - Protected confirmation
      * [Overview](/docs/security/features/protected-confirmation)
      * [Implementation](/docs/security/features/protected-confirmation/implementation)
      * [Design guidelines](/docs/security/features/protected-confirmation/design)
      * [Accessibility](/docs/security/features/protected-confirmation/accessibility)
  + DICE
    - [Overview](/docs/security/features/dice)
    - [Applications of DICE](/docs/security/features/dice/applications-of-dice)
  + Encryption
    - [Overview](/docs/security/features/encryption)
    - [File-based encryption](/docs/security/features/encryption/file-based)
    - [Full-disk encryption](/docs/security/features/encryption/full-disk)
    - [Metadata encryption](/docs/security/features/encryption/metadata)
    - [Enable Adiantum](/docs/security/features/encryption/adiantum)
    - [Hardware-wrapped keys](/docs/security/features/encryption/hw-wrapped-keys)
  + Keystore
    - [Overview](/docs/security/features/keystore)
    - [Features](/docs/security/features/keystore/features)
    - [Key and ID attestation](/docs/security/features/keystore/attestation)
    - [Version binding](/docs/security/features/keystore/version-binding)
    - [Authorization tags](/docs/security/features/keystore/tags)
    - [Functions](/docs/security/features/keystore/implementer-ref)
  + Identity credential
    - [Overview](/docs/security/features/identity-credentials)
  + SELinux
    - [Overview](/docs/security/features/selinux)
    - [Concepts](/docs/security/features/selinux/concepts)
    - [Implementation](/docs/security/features/selinux/implement)
    - [Customization](/docs/security/features/selinux/customize)
    - [Build sepolicy](/docs/security/features/selinux/build)
    - [Compatibility](/docs/security/features/selinux/compatibility)
    - [Validation](/docs/security/features/selinux/validate)
    - [Write policy](/docs/security/features/selinux/device-policy)
    - [Vendor init](/docs/security/features/selinux/vendor-init)
  + Trusty TEE
    - [Overview](/docs/security/features/trusty)
    - [Download and build](/docs/security/features/trusty/download-and-build)
    - [Trusty API reference](/docs/security/features/trusty/trusty-ref)
  + Verified Boot
    - [Overview](/docs/security/features/verifiedboot)
    - [Device state](/docs/security/features/verifiedboot/device-state)
    - [Verify Boot](/docs/security/features/verifiedboot/verified-boot)
    - [Boot flow](/docs/security/features/verifiedboot/boot-flow)
    - [Implement dm-verity](/docs/security/features/verifiedboot/dm-verity)
    - [Verify system\_other partition](/docs/security/features/verifiedboot/verify-system-other-partition)
    - [Reference implementation](/docs/security/features/verifiedboot/avb)
  + Safety Center
    - [Overview](/docs/security/safety-center/overview)
    - [Customize Safety Center](/docs/security/safety-center/customize)
    - [Customize Safety Center UI](/docs/security/safety-center/customize-ui)
    - [Interact with Safety Center](/docs/security/safety-center/interact)
    - [Testing and validation](/docs/security/safety-center/test-requirements)
  + Cellular security
    - [Overview](/docs/security/features/cellular-security/overview)
    - [Disable 2G](/docs/security/features/cellular-security/disable-2g)
  + [Private space](/docs/security/features/private-space)
* Testing
  + [Overview](/docs/security/test/fuzz-sanitize)
  + [Memory safety](/docs/security/test/memory-safety)
  + Arm Memory Tagging Extension
  + [Overview](/docs/security/test/memory-safety/arm-mte)
  + [Bootloader support](/docs/security/test/memory-safety/bootloader-support)
  + [Understand MTE reports](/docs/security/test/memory-safety/mte-reports)
  + [MTE configuration](/docs/security/test/memory-safety/mte-configuration)
  + Sanitizers
  + [Overview](/docs/security/test/sanitizers)
  + [AddressSanitizer](/docs/security/test/asan)
  + [Kernel AddressSanitizer](/docs/security/test/kasan)
  + [Hardware-assisted AddressSanitizer](/docs/security/test/hwasan)
  + [Understand HWASan reports](/docs/security/test/memory-safety/hwasan-reports)
  + [UndefinedBehaviorSanitizer](/docs/security/test/ubsan)
  + Other topics
  + [Control flow integrity](/docs/security/test/cfi)
  + [Kernel control flow integrity](/docs/security/test/kcfi)
  + [Execute-only memory](/docs/security/test/execute-only-memory)
  + [Fuzz with libFuzzer](/docs/security/test/libfuzzer)
  + [GWP-ASan and KFENCE](/docs/security/test/memory-safety/gwp-asan-kfence)
  + [Security Test Suite development kit](/docs/security/test/sts-sdk)
  + [Scudo](/docs/security/test/scudo)
  + [ShadowCallStack](/docs/security/test/shadow-call-stack)
  + [Tagged pointers](/docs/security/test/tagged-pointers)
  + [Zero initialized memory](/docs/security/test/memory-safety/zero-initialized-memory)
* Best practices
  + [Overview](/docs/security/best-practices)
  + [Operational security](/docs/security/best-practices/ops)
  + [System security](/docs/security/best-practices/system)
  + [App security](/docs/security/best-practices/app)
  + [Network security](/docs/security/best-practices/network)
  + [Hardware security](/docs/security/best-practices/hardware)
  + [Privacy security](/docs/security/best-practices/privacy)

* What's new?
* [Release notes](/docs/whatsnew/release-notes)
* [Latest security bulletins](/docs/whatsnew/latest-security-bulletins)
* [Latest Compatibility Definition Document (CDD)](/docs/whatsnew/latest-cdd)
* [Site updates](/docs/whatsnew/site-updates)
* Getting Started
* [About](/docs/setup/about)
* [Start](/docs/setup/start)
* [Download](/docs/setup/download)
* [Build](/docs/setup/build)
* [Test](/docs/setup/test)
* [Create](/docs/setup/create/coding-tasks)
* [Contribute](/docs/setup/contribute)
* [Community](/docs/setup/community/cofc)
* [Tools, build, and related reference](/docs/setup/reference)
* Security
* [Overview](/docs/security/overview)
* [Bulletins](/docs/security/bulletin)
* [Features](/docs/security/features)
* [Testing](/docs/security/test/fuzz-sanitize)
* [Best Practices](/docs/security/best-practices)
* Core Topics
* [Architecture](/docs/core/architecture)
* [Audio](/docs/core/audio)
* [Camera](/docs/core/camera)
* [Connectivity](/docs/core/connect)
* [Data](/docs/core/data)
* [Display](/docs/core/display)
* [Fonts](/docs/core/fonts/custom-font-fallback)
* [Graphics](/docs/core/graphics)
* [Interaction](/docs/core/interaction)
* [Media](/docs/core/media)
* [Performance](/docs/core/perf)
* [Permissions](/docs/core/permissions)
* [Power](/docs/core/power)
* [Runtime](/docs/core/runtime)
* [Settings](/docs/core/settings)
* [Storage](/docs/core/storage)
* [Tests](/docs/core/tests)
* [Updates](/docs/core/ota)
* [Virtualization](/docs/core/virtualization)
* Compatibility
* [Compatibility Definition Document (CDD)](/docs/compatibility/cdd)
* [Compatibility Test Suite (CTS)](/docs/compatibility/cts)
* Android Devices
* [Cuttlefish](/docs/devices/cuttlefish)
* [Enterprise](/docs/devices/admin)
* [TV](/docs/devices/tv)
* Automotive
* [Get Started](/docs/automotive/start/what_automotive)
* [Guidelines for Development](/docs/automotive/guidelines)
* [Development Tools](/docs/automotive/dev-tools)
* [Testing Tools and Infrastructure](/docs/automotive/tools)
* [Release Details](/docs/automotive/start/releases)
* Reference
* [HIDL](/reference/hidl)
* [HAL](/reference/hal)
* [Trade Federation](/reference/tradefed/classes)
* [Security Test Suite](/reference/sts/classes)

* [AOSP](https://source.android.com/)
* [Security](https://source.android.com/docs/security)

# Android Security Bulletin—April 2017

Stay organized with collections

Save and categorize content based on your preferences.

*Published April 03, 2017 | Updated August 17, 2017*

The Android Security Bulletin contains details of security vulnerabilities
affecting Android devices. Alongside the bulletin, we have released a security
update to Nexus devices through an over-the-air (OTA) update. The Google device
firmware images have also been released to the [Google Developer
site](https://developers.google.com/android/nexus/images). Security patch levels of April 05, 2017 or later address all of these
issues. Refer to the [Pixel
and Nexus update schedule](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices) to learn how to check a device's security patch
level.

Partners were notified of the issues described in the bulletin on March 06, 2017
or earlier. Source code patches for these issues have been released to the Android
Open Source Project (AOSP) repository and linked from this bulletin. This bulletin
also includes links to patches outside of AOSP.

The most severe of these issues is a Critical security vulnerability that could
enable remote code execution on an affected device through multiple methods such
as email, web browsing, and MMS when processing media files. The
[severity
assessment](/docs/security/overview/updates-resources#severity) is based on the effect that exploiting the vulnerability would
possibly have on an affected device, assuming the platform and service
mitigations are disabled for development purposes or if successfully bypassed.

We have had no reports of active customer exploitation or abuse of these newly
reported issues. Refer to the [Android and Google service
mitigations](#mitigations) section for details on the [Android
security platform protections](/docs/security/enhancements) and service protections such as [SafetyNet](https://developer.android.com/training/safetynet/index.html),
which improve the security of the Android platform.

We encourage all customers to accept these updates to their devices.

## Announcements

* This bulletin has two security patch level strings to provide Android
  partners with the flexibility to more quickly fix a subset of vulnerabilities
  that are similar across all Android devices. See [Common questions and answers](#common-questions-and-answers) for
  additional information:
  + **2017-04-01**: Partial security patch level string. This
    security patch level string indicates that all issues associated with 2017-04-01
    (and all previous security patch level strings) are addressed.
  + **2017-04-05**: Complete security patch level string. This
    security patch level string indicates that all issues associated with 2017-04-01
    and 2017-04-05 (and all previous security patch level strings) are addressed.
* Supported Google devices will receive a single OTA update with the April 05,
  2017 security patch level.

## Android and Google Service Mitigations

This is a summary of the mitigations provided by the [Android
security platform](/docs/security/enhancements) and service protections such as SafetyNet. These
capabilities reduce the likelihood that security vulnerabilities could be
successfully exploited on Android.

* Exploitation for many issues on Android is made more difficult by
  enhancements in newer versions of the Android platform. We encourage all users
  to update to the latest version of Android where possible.
* The Android Security team actively monitors for abuse with [Verify
  Apps and SafetyNet](/static/docs/security/overview/reports/Google_Android_Security_2016_Report_Final.pdf), which are designed to warn users about [Potentially
  Harmful Applications](http://static.googleusercontent.com/media/source.android.com/en//security/reports/Google_Android_Security_PHA_classifications.pdf). Verify Apps is enabled by default on devices with [Google Mobile Services](http://www.android.com/gms) and is especially
  important for users who install applications from outside of Google Play. Device
  rooting tools are prohibited within Google Play, but Verify Apps warns users
  when they attempt to install a detected rooting application—no matter where it
  comes from. Additionally, Verify Apps attempts to identify and block
  installation of known malicious applications that exploit a privilege escalation
  vulnerability. If such an application has already been installed, Verify Apps
  will notify the user and attempt to remove the detected application.
* As appropriate, Google Hangouts and Messenger applications do not
  automatically pass media to processes such as Mediaserver.

## Acknowledgements

We would like to thank these researchers for their contributions:

* Aravind Machiry (donfos) of Shellphish Grill Team: CVE-2016-5349
* Daxing Guo ([@freener0](https://twitter.com/freener0)) of Xuanwu
  Lab, Tencent: CVE-2017-0585, CVE-2017-0553
* Derrek ([@derrekr6](https://twitter.com/derrekr6)) and Scott Bauer:
  CVE-2017-0576
* Gal Beniamini of Project Zero: CVE-2017-0571, CVE-2017-0570, CVE-2017-0572,
  CVE-2017-0569, CVE-2017-0561
* Gengjia Chen ([@chengjia4574](https://twitter.com/chengjia4574))
  and [pjf](http://weibo.com/jfpan) of IceSword Lab, Qihoo 360
  Technology Co. Ltd.: CVE-2017-6426, CVE-2017-0581, CVE-2017-0329, CVE-2017-0332,
  CVE-2017-0566, CVE-2017-0573
* Guang Gong (龚广) ([@oldfresher](https://twitter.com/oldfresher))
  of Alpha Team, Qihoo 360 Technology Co. Ltd.: CVE-2017-0547
* Hao Chen and Guang Gong of Alpha Team, Qihoo 360 Technology Co. Ltd.:
  CVE-2017-6424, CVE-2017-0584, CVE-2017-0454, CVE-2017-0574, CVE-2017-0575, CVE-2017-0567
* Ian Foster ([@lanrat](https://twitter.com/lanrat)): CVE-2017-0554
* Jack Tang of Trend Micro Inc.: CVE-2017-0579
* Jianjun Dai ([@Jioun\_dai](https://twitter.com/Jioun_dai)) of [Qihoo 360 Skyeye Labs](https://skyeye.360safe.com): CVE-2017-0559,
  CVE-2017-0541
* Jianqiang Zhao ([@jianqiangzhao](https://twitter.com/jianqiangzhao)) and [pjf](http://weibo.com/jfpan) of IceSword Lab, Qihoo 360: CVE-2017-6425,
  CVE-2016-5346
* Lubo Zhang (zlbzlb815@163.com) of
  [C0RE Team](http://c0reteam.org) and Yonggang Guo
  ([@guoygang](https://twitter.com/guoygang)) of IceSword Lab, Qihoo
  360 Technology Co. Ltd.: CVE-2017-0564
* Mark Salyzyn of Google:
  CVE-2017-0558
* Mike Andereson ([@manderbot](https://twitter.com/manderbot)) and
  Nathan Crandall ([@natecray](https://twitter.com/natecray)) of
  Tesla's Product Security Team: CVE-2017-0327, CVE-2017-0328
* Peng Xiao, Chengming Yang, Ning You, Chao Yang, and Yang song of Alibaba
  Mobile Security Group: CVE-2017-0565
* Pengfei Ding (丁鹏飞), Chenfu Bao (包沉浮), and Lenx Wei (韦韬) of Baidu X-Lab
  (百度安全实验室): CVE-2016-10236
* Qidan He (何淇丹 - [@flanker\_hqd](https://twitter.com/flanker_hqd))
  of KeenLab, Tencent: CVE-2017-0544, CVE-2017-0325
* Roee Hay ([@roeehay](https://twitter.com/roeehay)) of Aleph
  Research, HCL Technologies: CVE-2017-0582, CVE-2017-0563
* Scott Bauer ([@ScottyBauer1](https://twitter.com/ScottyBauer1)): CVE-2017-0562,
  CVE-2017-0339
* Seven Shen ([@lingtongshen](https://twitter.com/lingtongshen)) of
  TrendMicro Mobile Threat Research Team: CVE-2016-10231, CVE-2017-0578, CVE-2017-0586
* Tim Becker: CVE-2017-0546
* Uma Sankar Pradhan ([@umasankar\_iitd](https://twitter.com/umasankar_iitd)): CVE-2017-0560
* V.E.O ([@VYSEa](https://twitter.com/vysea)) of [Mobile
  Threat Response Team](http://blog.trendmicro.com/trendlabs-security-intelligence/category/mobile), [Trend Micro](http://www.trendmicro.com):
  CVE-2017-0555, CVE-2017-0538, CVE-2017-0539, CVE-2017-0557,
  CVE-2017-0556
* Weichao Sun ([@sunblate](https://twitter.com/sunblate)) of
  Alibaba Inc: CVE-2017-0549
* Wenlin Yang ([@wenlin\_yang](https://twitter.com/wenlin_yang)),
  Guang Gong ([@oldfresher](https://twitter.com/oldfresher)), and Hao
  Chen of Alpha Team, Qihoo 360 Technology Co. Ltd.: CVE-2017-0580, CVE-2017-0577
* [Zinuo Han](http://weibo.com/ele7enxxh) from Chengdu Security
  Response Center of Qihoo 360 Technology Co. Ltd.: CVE-2017-0548
* Zubin Mithra of Google: CVE-2017-0462

## 2017-04-01 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities that apply to the 2017-04-01 patch level.There is a description
of the issue, a severity rationale, and a table with the CVE, associated
references, severity, updated Google devices, updated AOSP versions (where
applicable), and date reported. When available, we will link the public change
that addressed the issue to the bug ID, like the AOSP change list. When multiple
changes relate to a single bug, additional references are linked to numbers
following the bug ID.

### Remote code execution vulnerability in Mediaserver

A remote code execution vulnerability in Mediaserver could enable an attacker
using a specially crafted file to cause memory corruption during media file and
data processing. This issue is rated as Critical due to the possibility of
remote code execution within the context of the Mediaserver process.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0538 | [A-33641588](https://android.googlesource.com/platform/external/libavc/%2B/494561291a503840f385fbcd11d9bc5f4dc502b8) | Critical | All | 6.0, 6.0.1, 7.0, 7.1.1 | Dec 13, 2016 |
| CVE-2017-0539 | [A-33864300](https://android.googlesource.com/platform/external/libhevc/%2B/1ab5ce7e42feccd49e49752e6f58f9097ac5d254) | Critical | All | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Dec 23, 2016 |
| CVE-2017-0541 | [A-34031018](https://android.googlesource.com/platform/external/sonivox/%2B/56d153259cc3e16a6a0014199a2317dde333c978) | Critical | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Jan 1, 2017 |
| CVE-2017-0542 | [A-33934721](https://android.googlesource.com/platform/external/libavc/%2B/33ef7de9ddc8ea7eb9cbc440d1cf89957a0c267b) | Critical | All | 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |
| CVE-2017-0543 | [A-34097866](https://android.googlesource.com/platform/external/libavc/%2B/f634481e940421020e52f511c1fb34aac1db4b2f) | Critical | All | 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |

### Elevation of privilege vulnerability in CameraBase

An elevation of privilege vulnerability in CameraBase could enable a local
malicious application to execute arbitrary code. This issue is rated as High
because it is a local arbitrary code execution in a privileged process.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0544 | [A-31992879](https://android.googlesource.com/platform/frameworks/av/%2B/4b49489c12e6862e9a320ebcb53872e809ed20ec) | High | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Oct 6, 2016 |

### Elevation of privilege vulnerability in Audioserver

An elevation of privilege vulnerability in Audioserver could enable a local
malicious application to execute arbitrary code within the context of a
privileged process. This issue is rated as High because it could be used to
gain local access to elevated capabilities, which are not normally accessible
to a third-party application.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0545 | [A-32591350](https://android.googlesource.com/platform/frameworks/av/%2B/e5a54485e08400a976092cd5b1c6d909d0e1a4ab) | High | All | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Oct 31, 2016 |

### Elevation of privilege vulnerability in SurfaceFlinger

An elevation of privilege vulnerability in SurfaceFlinger could enable a local
malicious application to execute arbitrary code within the context of a
privileged process. This issue is rated as High because it could be used to
gain local access to elevated capabilities, which are not normally accessible
to a third-party application.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0546 | [A-32628763](https://android.googlesource.com/platform/frameworks/native/%2B/45b202513ba7440beaefbf9928f73fb6683dcfbd) | High | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Nov 2, 2016 |

### Information disclosure vulnerability in Mediaserver

An information disclosure vulnerability in Mediaserver could enable a local
malicious application to access data outside of its permission levels. This
issue is rated as High because it is a general bypass for operating system
protections that isolate application data from other applications.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0547 | [A-33861560](https://android.googlesource.com/platform/frameworks/av/%2B/9667e3eff2d34c3797c3b529370de47b2c1f1bf6) | High | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Dec 22, 2016 |

### Denial of service vulnerability in libskia

A remote denial of service vulnerability in libskia could enable an attacker to
use a specially crafted file to cause a device hang or reboot. This issue is
rated as High severity due to the possibility of remote denial of service.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0548 | [A-33251605](https://android.googlesource.com/platform/external/skia/%2B/318e3505ac2436c62ec19fd27ebe9f8e7d174544) | High | All | 7.0, 7.1.1 | Nov 29, 2016 |

### Denial of service vulnerability in Mediaserver

A remote denial of service vulnerability in Mediaserver could enable an
attacker to use a specially crafted file to cause a device hang or reboot. This
issue is rated as High severity due to the possibility of remote denial of
service.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0549 | [A-33818508](https://android.googlesource.com/platform/external/libavc/%2B/37345554fea84afd446d6d8fbb87feea5a0dde3f) | High | All | 6.0, 6.0.1, 7.0, 7.1.1 | Dec 20, 2016 |
| CVE-2017-0550 | [A-33933140](https://android.googlesource.com/platform/external/libavc/%2B/7950bf47b6944546a0aff11a7184947de9591b51) | High | All | 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |
| CVE-2017-0551 | [A-34097231](https://android.googlesource.com/platform/external/libavc/%2B/8b5fd8f24eba5dd19ab2f80ea11a9125aa882ae2) [[2](https://android.googlesource.com/platform/external/libavc/%2B/494561291a503840f385fbcd11d9bc5f4dc502b8)] | High | All | 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |
| CVE-2017-0552 | [A-34097915](https://android.googlesource.com/platform/external/libavc/%2B/9a00f562a612d56e7b2b989d168647db900ba6cf) | High | All | 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |

### Elevation of privilege vulnerability in libnl

An elevation of privilege vulnerability in libnl could enable a local malicious
application to execute arbitrary code within the context of the Wi-Fi service.
This issue is rated as Moderate because it first requires compromising a
privileged process and is mitigated by current platform configurations.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0553 | [A-32342065](https://android.googlesource.com/platform/external/libnl/%2B/f83d9c1c67b6be69a96995e384f50b572b667df0) | Moderate | All | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Oct 21, 2016 |

### Elevation of privilege vulnerability in Telephony

An elevation of privilege vulnerability in the Telephony component could enable
a local malicious application to access capabilities outside of its permission
levels. This issue is rated as Moderate because it could be used to gain access
to elevated capabilities, which are not normally accessible to a third-party
application.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0554 | [A-33815946](https://android.googlesource.com/platform/packages/services/Telephony/%2B/aeb795ef2290af1a0e4b14909363bc574e6b3ee7) [[2](https://android.googlesource.com/platform/frameworks/base/%2B/3294256ba5b9e2ba2d8619d617e3d900e5386564)] | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Dec 20, 2016 |

### Information disclosure vulnerability in Mediaserver

An information disclosure vulnerability in Mediaserver could enable a local
malicious application to access data outside of its permission levels. This
issue is rated as Moderate because it could be used to access data without
permission.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0555 | [A-33551775](https://android.googlesource.com/platform/external/libavc/%2B/0b23c81c3dd9ec38f7e6806a3955fed1925541a0) | Moderate | All | 6.0, 6.0.1, 7.0, 7.1.1 | Dec 12, 2016 |
| CVE-2017-0556 | [A-34093952](https://android.googlesource.com/platform/external/libmpeg2/%2B/f301cff2c1ddd880d9a2c77b22602a137519867b) | Moderate | All | 6.0, 6.0.1, 7.0, 7.1.1 | Jan 4, 2017 |
| CVE-2017-0557 | [A-34093073](https://android.googlesource.com/platform/external/libmpeg2/%2B/227c1f829127405e21dab1664393050c652ef71e) | Moderate | All | 6.0, 6.0.1, 7.0, 7.1.1 | Jan 4, 2017 |
| CVE-2017-0558 | [A-34056274](https://android.googlesource.com/platform/frameworks/av/%2B/50358a80b1724f6cf1bcdf003e1abf9cc141b122) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |

### Information disclosure vulnerability in libskia

An information disclosure vulnerability in libskia could enable a local
malicious application to access data outside of its permission levels. This
issue is rated as Moderate because it could be used to access data without
permission.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0559 | [A-33897722](https://android.googlesource.com/platform/external/skia/%2B/16882f721279a82a1c860ac689ce570b16fe26a0) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Dec 25, 2016 |

### Information disclosure vulnerability in Factory Reset

An information disclosure vulnerability in the factory reset process could
enable a local malicious attacker to access data from the previous owner. This
issue is rated as Moderate due to the possibility of bypassing device
protection.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2017-0560 | [A-30681079](https://android.googlesource.com/platform/frameworks/base/%2B/efdec8f5688ce6b0a287eddb6d5dad93ffa0e1ee) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1 | Google internal |

## 2017-04-05 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities that apply to the 2017-04-05 patch level. There is a description
of the issue, a severity rationale, and a table with the CVE, associated
references, severity, updated Google devices, updated AOSP versions (where
applicable), and date reported. When available, we will link the public change
that addressed the issue to the bug ID, like the AOSP change list. When multiple
changes relate to a single bug, additional references are linked to numbers
following the bug ID.

### Remote code execution vulnerability in Broadcom Wi-Fi firmware

A remote code execution vulnerability in the Broadcom Wi-Fi firmware could
enable a remote attacker to execute arbitrary code within the context of the
Wi-Fi SoC. This issue is rated as Critical due to the possibility of remote
code execution in the context of the Wi-Fi SoC.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0561 | A-34199105\* B-RB#110814 | Critical | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Jan 9, 2017 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Remote code execution vulnerability in Qualcomm crypto engine driver

A remote code execution vulnerability in the Qualcomm crypto engine driver
could enable a remote attacker to execute arbitrary code within the context of
the kernel. This issue is rated as Critical due to the possibility of remote
code execution in the context of the kernel.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10230 | A-34389927 [QC-CR#1091408](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=bd9a8fc6d7f6bd1a0b936994630006de450df657) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Pixel, Pixel XL, Android One | Jan 10, 2017 |

### Remote code execution vulnerability in kernel networking subsystem

A remote code execution vulnerability in the kernel networking subsystem could
enable a remote attacker to execute arbitrary code within the context of the
kernel. This issue is rated as Critical due to the possibility of remote code
execution in the context of the kernel.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10229 | A-32813456 [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=197c949e7798fbf28cfadc69d9ca0c2abbf93191) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Pixel, Pixel XL, Pixel C, Android One, Nexus Player | Google internal |

### Elevation of privilege vulnerability in MediaTek touchscreen driver

An elevation of privilege vulnerability in the MediaTek touchscreen driver
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Critical due to the possibility
of a local permanent device compromise, which may require reflashing the
operating system to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0562 | A-30202425\* M-ALPS02898189 | Critical\* | None\*\* | Jul 16, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in HTC touchscreen driver

An elevation of privilege vulnerability in the HTC touchscreen driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Critical due to the possibility
of a local permanent device compromise, which may require reflashing the
operating system to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0563 | A-32089409\* | Critical | Nexus 9 | Oct 9, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in kernel ION subsystem

An elevation of privilege vulnerability in the kernel ION subsystem could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Critical due to the possibility
of a local permanent device compromise, which may require reflashing the
operating system to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0564 | A-34276203\* | Critical | Nexus 5X, Nexus 6, Nexus 6P, Pixel, Pixel XL, Pixel C, Android One, Nexus Player | Jan 12, 2017 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Vulnerabilities in Qualcomm components

These vulnerabilities affect Qualcomm components and are described in further
detail in the Qualcomm AMSS October 2016 security bulletin.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10237 | A-31628601\*\* QC-CR#1046751 | Critical | None\*\* | Qualcomm internal |
| CVE-2016-10238 | A-35358527\*\* QC-CR#1042558 | Critical | None\*\*\* | Qualcomm internal |
| CVE-2016-10239 | A-31624618\*\* QC-CR#1032929 | High | Pixel, Pixel XL | Qualcomm internal |

\* The severity rating for these vulnerabilities was determined by the vendor.

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Remote code execution vulnerability in v8

A remote code execution vulnerability in v8 could enable remote attackers to
execute arbitrary code within the context of a privileged process. This issue
is rated as High due to the possibility of remote code execution in websites.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-5129 | A-29178923 | High | None\* | 6.0, 6.0.1, 7.0 | Jul 20, 2016 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Remote code execution vulnerability in Freetype

A remote code execution vulnerability in Freetype could enable a local
malicious application to load a specially crafted font to cause memory
corruption in an unprivileged process. This issue is rated as High due to the
possibility of remote code execution in an application that uses this library.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-10244 | A-31470908 | High | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Sep 13, 2016 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in kernel sound subsystem

An elevation of privilege vulnerability in the kernel sound subsystem could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-4656 | A-34464977 [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=883a1d49f0d77d30012f114b2e19fc141beb3e8e) | High | Nexus 6, Nexus Player | Jun 26, 2014 |

### Elevation of privilege vulnerability in NVIDIA crypto driver

An elevation of privilege vulnerability in the NVIDIA crypto driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0339 | A-27930566\* N-CVE-2017-0339 | High | Nexus 9 | Mar 29, 2016 |
| CVE-2017-0332 | A-33812508\* N-CVE-2017-0332 | High | Nexus 9 | Dec 21, 2016 |
| CVE-2017-0327 | A-33893669\* N-CVE-2017-0327 | High | Nexus 9 | Dec 24, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in MediaTek thermal driver

An elevation of privilege vulnerability in the MediaTek thermal driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0565 | A-28175904\* M-ALPS02696516 | High | None\*\* | Apr 11, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in MediaTek camera driver

An elevation of privilege vulnerability in the MediaTek camera driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0566 | A-28470975\* M-ALPS02696367 | High | None\*\* | Apr 29, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in Broadcom Wi-Fi driver

An elevation of privilege vulnerability in the Broadcom Wi-Fi driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0567 | A-32125310\* B-RB#112575 | High | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Oct 12, 2016 |
| CVE-2017-0568 | A-34197514\* B-RB#112600 | High | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Jan 9, 2017 |
| CVE-2017-0569 | A-34198729\* B-RB#110666 | High | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Jan 9, 2017 |
| CVE-2017-0570 | A-34199963\* B-RB#110688 | High | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Jan 9, 2017 |
| CVE-2017-0571 | A-34203305\* B-RB#111541 | High | Nexus 6, Nexus 6P, Pixel C, Nexus Player | Jan 9, 2017 |
| CVE-2017-0572 | A-34198931\* B-RB#112597 | High | None\*\* | Jan 9, 2017 |
| CVE-2017-0573 | A-34469904\* B-RB#91539 | High | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Jan 18, 2017 |
| CVE-2017-0574 | A-34624457\* B-RB#113189 | High | Nexus 6, Nexus 6P, Nexus 9, Pixel C | Jan 22, 2017 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in Qualcomm Wi-Fi driver

An elevation of privilege vulnerability in the Qualcomm Wi-Fi driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0575 | A-32658595\* QC-CR#1103099 | High | Nexus 5X, Pixel, Pixel XL | Nov 3, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in NVIDIA I2C HID driver

An elevation of privilege vulnerability in the NVIDIA I2C HID driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0325 | A-33040280\* N-CVE-2017-0325 | High | Nexus 9, Pixel C | Nov 20, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in Qualcomm audio driver

An elevation of privilege vulnerability in the Qualcomm audio driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0454 | A-33353700 [QC-CR#1104067](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=cb0701a2f99fa19f01fbd4249bda9a8eadb0241f) | High | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Dec 5, 2016 |

### Elevation of privilege vulnerability in Qualcomm crypto engine driver

An elevation of privilege vulnerability in the Qualcomm crypto engine driver
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0576 | A-33544431 [QC-CR#1103089](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=2b09507d78b25637df6879cd2ee2031b208b3532) | High | Nexus 5X, Nexus 6, Nexus 6P, Pixel, Pixel XL, Android One | Dec 9, 2016 |

### Elevation of privilege vulnerability in HTC touchscreen driver

An elevation of privilege vulnerability in the HTC touchscreen driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0577 | A-33842951\* | High | None\*\* | Dec 21, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in DTS sound driver

An elevation of privilege vulnerability in the DTS sound driver could enable a
local malicious application to execute arbitrary code within the context of the
kernel. This issue is rated as High because it first requires compromising a
privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0578 | A-33964406\* | High | None\*\* | Dec 28, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in Qualcomm sound codec driver

An elevation of privilege vulnerability in the Qualcomm sound codec driver
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10231 | A-33966912 [QC-CR#1096799](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=3bfe5a89916f7d29492e9f6d941d108b688cb804) | High | Pixel, Pixel XL | Dec 29, 2016 |

### Elevation of privilege vulnerability in Qualcomm video driver

An elevation of privilege vulnerability in the Qualcomm video driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0579 | A-34125463\* QC-CR#1115406 | High | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Jan 5, 2017 |
| CVE-2016-10232 | A-34386696 [QC-CR#1024872](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=21e0ead58e47798567d846b84f16f89cf69a57ae) [[2]](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=27f7b3b3059f6181e2786f886f4cd92f413bc30c) | High | Nexus 5X, Nexus 6P, Pixel, Pixel XL, Android One | Jan 10, 2017 |
| CVE-2016-10233 | A-34389926 [QC-CR#897452](https://source.codeaurora.org/quic/la/kernel/msm/commit/?id=d793c6d91ecba2a1fd206ad47a4fd408d290addf) | High | None\*\* | Jan 10, 2017 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in NVIDIA boot and power management processor driver

An elevation of privilege vulnerability in the NVIDIA boot and power management
processor driver could enable a local malicious application to execute
arbitrary code within the context of the boot and power management processor.
This issue is rated as High because it first requires compromising a privileged
process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0329 | A-34115304\* N-CVE-2017-0329 | High | Pixel C | Jan 5, 2017 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in Synaptics touchscreen driver

An elevation of privilege vulnerability in the Synaptics Touchscreen driver
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0580 | A-34325986\* | High | None\*\* | Jan 16, 2017 |
| CVE-2017-0581 | A-34614485\* | High | None\*\* | Jan 22, 2017 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in Qualcomm Seemp driver

An elevation of privilege vulnerability in the Qualcomm Seemp driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0462 | A-33353601 [QC-CR#1102288](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=eb7b1426279e751b1fc3e86f434dc349945c1ae7) | High | Pixel, Pixel XL | Google internal |

### Elevation of privilege vulnerability in Qualcomm Kyro L2 driver

An elevation of privilege vulnerability in the Qualcomm Kyro L2 driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-6423 | A-32831370 [QC-CR#1103158](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=0f264f812b61884390b432fdad081a3e995ba768) | High | Pixel, Pixel XL | Google internal |

### Elevation of privilege vulnerability in kernel file system

An elevation of privilege vulnerability in the kernel file system could enable
a local malicious application to execute arbitrary code within the context of
the kernel. This issue is rated as High because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-9922 | A-32761463 [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=69c433ed2ecd2d3264efd7afec4439524b319121) | High | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Pixel, Pixel XL, Pixel C, Android One, Nexus Player | Oct 24, 2014 |

### Information disclosure vulnerability in kernel memory subsystem

An information disclosure vulnerability in the kernel memory subsystem could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as High because it could be used to access
sensitive data without explicit user permission.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-0206 | A-34465735 [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=d36db46c2cba973557eb6138d22210c4e0cf17d6) | High | Nexus 6, Nexus Player | May 6, 2014 |

### Information disclosure vulnerability in kernel networking subsystem

An information disclosure vulnerability in the kernel networking subsystem
could enable a local malicious application to access data outside of its
permission levels. This issue is rated as High because it could be used to
access sensitive data without explicit user permission.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-3145 | A-34469585 [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=314760e66c35c8ffa51b4c4ca6948d207e783079) [[2]](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=05ab8f2647e4221cbdb3856dd7d32bd5407316b3) | High | Nexus 6, Nexus Player | May 9, 2014 |

### Information disclosure vulnerability in Qualcomm TrustZone

An information disclosure vulnerability in the Qualcomm TrustZone could enable
a local malicious application to access data outside of its permission levels.
This issue is rated as High because it could be used to access sensitive data
without explicit user permission.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-5349 | A-29083830 [QC-CR#1021945](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=7c3bf6557c62d904b15507eb451fda8fd7ef750c) [[2]](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=03853a58952834ac3e1e3007c9c680dd4c001a2f) [[3]](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=e3d969000fb60ecb9bc01667fa89957f67763514) [[4]](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=9bd398661cae758ffc557adc7de74ba32654e1f9) | High | Nexus 5X, Nexus 6, Nexus 6P, Pixel, Pixel XL, Android One | Jun 1, 2016 |

### Information disclosure vulnerability in Qualcomm IPA driver

An information disclosure vulnerability in the Qualcomm IPA driver could enable
a local malicious application to access data outside of its permission levels.
This issue is rated as High because it could be used to access sensitive data
without explicit user permission.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10234 | A-34390017 [QC-CR#1069060](https://source.codeaurora.org/quic/la/kernel/msm-3.10/commit/?id=c7d7492c1e329fdeb28a7901c4cd634d41a996b1) [[2]](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=d12370c7f3ecded1867fbd6b70ded35db55cab1d) | High | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Jan 10, 2017 |

### Denial of service vulnerability in kernel networking subsystem

A denial of service vulnerability in the kernel networking subsystem could
enable a remote attacker to use a specially crafted network packet to cause a
device hang or reboot. This issue is rated as High due to the possibility of
remote denial of service.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-2706 | A-34160553 [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=1d147bfa64293b2723c4fec50922168658e613ba) | High | Nexus Player | Apr 1, 2014 |

### Denial of service vulnerability in Qualcomm Wi-Fi driver

A denial of service vulnerability in the Qualcomm Wi-Fi driver could enable a
proximate attacker to cause a denial of service in the Wi-Fi subsystem. This
issue is rated as High due to the possibility of remote denial of service.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10235 | A-34390620 [QC-CR#1046409](https://source.codeaurora.org/quic/la/platform/vendor/qcom-opensource/wlan/qcacld-2.0/commit/?id=5bb0059243515ecdac138cfdb4cee7259bbd0bbc) | High | None\*\* | Jan 10, 2017 |

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in kernel file system

An elevation of privilege vulnerability in the kernel file system could enable
a local malicious application to execute arbitrary code outside of its
permission levels. This issue is rated as Moderate because it first requires
compromising a privileged process and is mitigated by current platform
configurations.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-7097 | A-32458736 [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=073931017b49d9458aa351605b43a7e34598caef) | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Pixel, Pixel XL, Pixel C, Nexus Player | Aug 28, 2016 |

### Elevation of privilege vulnerability in Qualcomm Wi-Fi driver

An elevation of privilege vulnerability in the Qualcomm Wi-Fi driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Moderate because it first
requires compromising a privileged process and because of vulnerability
specific details which limit the impact of the issue.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-6424 | A-32086742 [QC-CR#1102648](https://source.codeaurora.org/quic/la/platform/vendor/qcom-opensource/wlan/qcacld-2.0/commit/?id=5cc2ac840e36a3342c5194c20b314f0bb95ef7e1) | Moderate | Nexus 5X, Pixel, Pixel XL, Android One | Oct 9, 2016 |

### Elevation of privilege vulnerability in Broadcom Wi-Fi driver

An elevation of privilege vulnerability in the Broadcom Wi-Fi driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Moderate because it first
requires compromising a privileged process and is mitigated by current platform
configurations.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-8465 | A-32474971\* B-RB#106053 | Moderate | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Oct 27, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in HTC OEM fastboot command

An elevation of privilege vulnerability in the HTC OEM fastboot command could
enable a local malicious application to execute arbitrary code within the
context of the sensor hub. This issue is rated as Moderate because it first
requires exploitation of separate vulnerabilities.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0582 | A-33178836\* | Moderate | Nexus 9 | Nov 28, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in Qualcomm CP access driver

An elevation of privilege vulnerability in the Qualcomm CP access driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Moderate because it first
requires compromising a privileged process and because of vulnerability
specific details which limit the impact of the issue.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0583 | A-32068683 [QC-CR#1103788](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=452d2ad331d20b19e8a0768c4b6e7fe1b65abe8f) | Moderate | Nexus 5X, Nexus 6P, Pixel, Pixel XL, Android One | Google internal |

### Information disclosure vulnerability in kernel media driver

An information disclosure vulnerability in the kernel media driver could enable
a local malicious application to access data outside of its permission levels.
This issue is rated as Moderate because it first requires compromising a
privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-1739 | A-34460642 [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=e6a623460e5fc960ac3ee9f946d3106233fd28d8) | Moderate | Nexus 6, Nexus 9, Nexus Player | Jun 15, 2014 |

### Information disclosure vulnerability in Qualcomm Wi-Fi driver

An information disclosure vulnerability in the Qualcomm Wi-Fi driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0584 | A-32074353\* QC-CR#1104731 | Moderate | Nexus 5X, Pixel, Pixel XL | Oct 9, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Information disclosure vulnerability in Broadcom Wi-Fi driver

An information disclosure vulnerability in the Broadcom Wi-Fi driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0585 | A-32475556\* B-RB#112953 | Moderate | Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player | Oct 27, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

### Information disclosure vulnerability in Qualcomm Avtimer driver

An information disclosure vulnerability in the Qualcomm Avtimer driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-5346 | A-32551280 [QC-CR#1097878](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=6298a474322fb2182f795a622b2faa64abfd8474) | Moderate | Pixel, Pixel XL | Oct 29, 2016 |

### Information disclosure vulnerability in Qualcomm video driver

An information disclosure vulnerability in the Qualcomm video driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-6425 | A-32577085 [QC-CR#1103689](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=ef86560a21fe1f256f6ba772a195201ff202c657) | Moderate | Pixel, Pixel XL | Oct 29, 2016 |

### Information disclosure vulnerability in Qualcomm USB driver

An information disclosure vulnerability in the Qualcomm USB driver could enable
a local malicious application to access data outside of its permission levels.
This issue is rated as Moderate because it first requires compromising a
privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-10236 | A-33280689 [QC-CR#1102418](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=b8199c2b852f1e23c988e10b8fbb8d34c98b4a1c) | Moderate | Pixel, Pixel XL | Nov 30, 2016 |

### Information disclosure vulnerability in Qualcomm sound driver

An information disclosure vulnerability in the Qualcomm sound driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0586 | A-33649808 QC-CR#1097569 | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Pixel, Pixel XL, Android One | Dec 13, 2016 |

### Information disclosure vulnerability in Qualcomm SPMI driver

An information disclosure vulnerability in the Qualcomm SPMI driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-6426 | A-33644474 [QC-CR#1106842](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=80decd6365deec08c35ecb902a58f9210599b39a) | Moderate | Pixel, Pixel XL | Dec 14, 2016 |

### Information disclosure vulnerability in NVIDIA crypto driver

An information disclosure vulnerability in the NVIDIA crypto driver could
enable a local malicious application to access data outside of its permission
levels. This issue is rated as Moderate because it first requires compromising
a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2017-0328 | A-33898322\* N-CVE-2017-0328 | Moderate | None\*\* | Dec 24, 2016 |
| CVE-2017-0330 | A-33899858\* N-CVE-2017-0330 | Moderate | None\*\* | Dec 24, 2016 |

\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Vulnerabilities in Qualcomm components

These vulnerabilities affecting Qualcomm components were released as part of
Qualcomm AMSS security bulletins between 2014–2016. They are included in this
Android security bulletin to associate their fixes with an Android security
patch level.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2014-9931 | A-35445101\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2014-9932 | A-35434683\*\* | Critical | Pixel, Pixel XL | Qualcomm internal |
| CVE-2014-9933 | A-35442512\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2014-9934 | A-35439275\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2014-9935 | A-35444951\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2014-9936 | A-35442420\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2014-9937 | A-35445102\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-8995 | A-35445002\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-8996 | A-35444658\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-8997 | A-35432947\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-8998 | A-35441175\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-8999 | A-35445401\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-9000 | A-35441076\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-9001 | A-35445400\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-9002 | A-35442421\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2015-9003 | A-35440626\*\* | Critical | None\*\* | Qualcomm internal |
| CVE-2016-10242 | A-35434643\*\* | Critical | None\*\* | Qualcomm internal |

\* The severity rating for these vulnerabilities was determined by the vendor.

\*\* The patch for this issue is not publicly available. The update is contained
in the latest binary drivers for Nexus devices available from the
[Google Developer site](https://developers.google.com/android/nexus/drivers).

\*\*\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

## Common Questions and Answers

This section answers common questions that may occur after reading this
bulletin.

**1. How do I determine if my device is updated to address these issues?**

To learn how to check a device's security patch level, read the instructions on
the [Pixel
and Nexus update schedule](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices).

* Security patch levels of 2017-04-01 or later address all issues associated
  with the 2017-04-01 security patch level.
* Security patch levels of 2017-04-05 or later address all issues associated
  with the 2017-04-05 security patch level and all previous patch levels.

Device manufacturers that include these updates should set the patch string
level to:

* [ro.build.version.security\_patch]:[2017-04-01]
* [ro.build.version.security\_patch]:[2017-04-05]

**2. Why does this bulletin have two security patch levels?**

This bulletin has two security patch levels so that Android partners have the
flexibility to fix a subset of vulnerabilities that are similar across all
Android devices more quickly. Android partners are encouraged to fix all issues
in this bulletin and use the latest security patch level.

* Devices that use the April 01, 2017 security patch level must include all
  issues associated with that security patch level, as well as fixes for all
  issues reported in previous security bulletins.
* Devices that use the security patch level of April 05, 2017 or newer must
  include all applicable patches in this (and previous) security
  bulletins.

Partners are encouraged to bundle the fixes for all issues they are addressing
in a single update.

**3. How do I determine which Google devices are affected by each
issue?**

In the [2017-04-01](#2017-04-01-details) and
[2017-04-05](#2017-04-05-details)
security vulnerability details sections, each table has an *Updated Google
devices* column that covers the range of affected Google devices updated for
each issue. This column has a few options:

* **All Google devices**: If an issue affects All and Pixel
  devices, the table will have "All" in the *Updated Google devices*
  column. "All" encapsulates the following [supported
  devices](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices): Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One,
  Nexus Player, Pixel C, Pixel, and Pixel XL.
* **Some Google devices**: If an issue doesn't affect all Google
  devices, the affected Google devices are listed in the *Updated Google
  devices* column.
* **No Google devices**: If no Google devices running Android 7.0
  are affected by the issue, the table will have "None" in the *Updated Google
  devices* column.

**4. What do the entries in the references column map to?**

Entries under the *References* column of the vulnerability details table
may contain a prefix identifying the organization to which the reference value
belongs. These prefixes map as follows:

| Prefix | Reference |
| --- | --- |
| A- | Android bug ID |
| QC- | Qualcomm reference number |
| M- | MediaTek reference number |
| N- | NVIDIA reference number |
| B- | Broadcom reference number |

## Revisions

* April 03, 2017: Bulletin published.
* April 05, 2017: Bulletin revised to include AOSP links.
* April 21, 2017: Attribution for CVE-2016-10231 and CVE-2017-0586 corrected.
* April 27, 2017: CVE-2017-0540 removed from bulletin.
* August 17, 2017: Bulletin revised to update reference numbers.

Content and code samples on this page are subject to the licenses described in the [Content License](/license). Java and OpenJDK are trademarks or registered trademarks of Oracle and/or its affiliates.

Last updated 2024-08-26 UTC.

[[["Easy to understand","easyToUnderstand","thumb-up"],["Solved my problem","solvedMyProblem","thumb-up"],["Other","otherUp","thumb-up"]],[["Missing the information I need","missingTheInformationINeed","thumb-down"],["Too complicated / too many steps","tooComplicatedTooManySteps","thumb-down"],["Out of date","outOfDate","thumb-down"],["Samples / code issue","samplesCodeIssue","thumb-down"],["Other","otherDown","thumb-down"]],["Last updated 2024-08-26 UTC."],[],[]]

* ### Build

  + [Android repository](//android.googlesource.com)
  + [Requirements](/source/requirements)
  + [Downloading](/source/downloading)
  + [Preview binaries](//developers.google.com/android/blobs-preview/)
  + [Factory images](//developers.google.com/android/images/)
  + [Driver binaries](//developers.google.com/android/drivers/)
* ### Connect

  + [@Android on Twitter](//twitter.com/Android/)
  + [@AndroidDev on Twitter](//twitter.com/AndroidDev/)
  + [Android Blog](//blog.google/products/android/)
  + [Google Security Blog](//security.googleblog.com)
  + [Platform on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-platform/)
  + [Building on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-building/)
  + [Porting on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-porting/)
* ### Get help

  + [Android Help Center](//support.google.com/android/)
  + [Pixel Help Center](//support.google.com/pixelphone/)
  + [www.android.com](//www.android.com)
  + [Google Mobile Services](//www.android.com/gms/)
  + [Stack Overflow](//stackoverflow.com/questions/tagged/android-source/)
  + [Issue Tracker](//issuetracker.google.com/issues?q=status:open%20componentid:190923)

* [About Android](/source/)
* [Community](/source/community)
* [Legal](/legal)
* [License](/license)
* [Privacy](//policies.google.com/privacy)
* [Site feedback](//issuetracker.google.com/issues/new?component=191476)
* Manage cookies

* English
* Deutsch
* Español
* Español – América Latina
* Français
* Indonesia
* Italiano
* Polski
* Português
* Português – Brasil
* Tiếng Việt
* Türkçe
* Русский
* עברית
* العربيّة
* فارسی
* हिंदी
* বাংলা
* ภาษาไทย
* 中文 – 简体
* 中文 – 繁體
* 日本語
* 한국어



=== Content from www.kernel.org_cb984a9e_20250125_060429.html ===
commit 8097be3bc58315b14498000585299e3c06fb13ce
Author: Jiri Slaby
Date: Mon Jun 30 13:49:32 2014 +0200
Linux 3.12.24
commit 0af3f13634228f13b0298551326a51b89d95a7e4
Author: Jie Liu
Date: Wed Nov 20 16:08:53 2013 +0800
xfs: don't perform discard if the given range length is less than block size
commit f9fd0135610084abef6867d984e9951c3099950d upstream.
For discard operation, we should return EINVAL if the given range length
is less than a block size, otherwise it will go through the file system
to discard data blocks as the end range might be evaluated to -1, e.g,
/xfs7: 9811378176 bytes were trimmed
This issue can be triggered via xfstests/generic/288.
Also, it seems to get the request queue pointer via bdev\_get\_queue()
instead of the hard code pointer dereference is not a bad thing.
Signed-off-by: Jie Liu
Reviewed-by: Christoph Hellwig
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit f7009499bc593c23ec4fe9525f4e545ad0c16691
Author: Dave Chinner
Date: Tue Oct 29 22:11:44 2013 +1100
xfs: xfs\_remove deadlocks due to inverted AGF vs AGI lock ordering
commit 273203699f82667296e1f14344c5a5a6c4600470 upstream.
Removing an inode from the namespace involves removing the directory
entry and dropping the link count on the inode. Removing the
directory entry can result in locking an AGF (directory blocks were
freed) and removing a link count can result in placing the inode on
an unlinked list which results in locking an AGI.
The big problem here is that we have an ordering constraint on AGF
and AGI locking - inode allocation locks the AGI, then can allocate
a new extent for new inodes, locking the AGF after the AGI.
Similarly, freeing the inode removes the inode from the unlinked
list, requiring that we lock the AGI first, and then freeing the
inode can result in an inode chunk being freed and hence freeing
disk space requiring that we lock an AGF.
Hence the ordering that is imposed by other parts of the code is AGI
before AGF. This means we cannot remove the directory entry before
we drop the inode reference count and put it on the unlinked list as
this results in a lock order of AGF then AGI, and this can deadlock
against inode allocation and freeing. Therefore we must drop the
link counts before we remove the directory entry.
This is still safe from a transactional point of view - it is not
until we get to xfs\_bmap\_finish() that we have the possibility of
multiple transactions in this operation. Hence as long as we remove
the directory entry and drop the link count in the first transaction
of the remove operation, there are no transactional constraints on
the ordering here.
Change the ordering of the operations in the xfs\_remove() function
to align the ordering of AGI and AGF locking to match that of the
rest of the code.
Signed-off-by: Dave Chinner
Reviewed-by: Ben Myers
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit 67820ad00235119639737a7a4bcf4e526de43d54
Author: Jie Liu
Date: Fri Oct 25 14:52:44 2013 +0800
xfs: fix the extent count when allocating an new indirection array entry
commit bb86d21cba22a045b09d11b71decf5ca7c3d5def upstream.
At xfs\_iext\_add(), if extent(s) are being appended to the last page in
the indirection array and the new extent(s) don't fit in the page, the
number of extents(erp->er\_extcount) in a new allocated entry should be
the minimum value between count and XFS\_LINEAR\_EXTS, instead of count.
For now, there is no existing test case can demonstrates a problem with
the er\_extcount being set incorrectly here, but it obviously like a bug.
Signed-off-by: Jie Liu
Reviewed-by: Ben Myers
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit 9af76725ffcc8517643fd07d379f4a1232f6ae92
Author: Geyslan G. Bem
Date: Wed Oct 30 16:01:00 2013 -0500
xfs: fix possible NULL dereference in xlog\_verify\_iclog
commit 643f7c4e5656bd18c769211f933190f7bb738245 upstream.
In xlog\_verify\_iclog a debug check of the incore log buffers prints an
error if icptr is null and then goes on to dereference the pointer
regardless. Convert this to an assert so that the intention is clear.
This was reported by Coverty.
Signed-off-by: Ben Myers
Reviewed-by: Eric Sandeen
Signed-off-by: Jiri Slaby
commit 710246604e1d8b6be253d056c922bdf7f57cc243
Author: Dave Chinner
Date: Tue Oct 29 22:11:57 2013 +1100
xfs: prevent stack overflows from page cache allocation
commit ad22c7a043c2cc6792820e6c5da699935933e87d upstream.
Page cache allocation doesn't always go through ->begin\_write and
hence we don't always get the opportunity to set the allocation
context to GFP\_NOFS. Failing to do this means we open up the direct
relcaim stack to recurse into the filesystem and consume a
significant amount of stack.
On RHEL6.4 kernels we are seeing ra\_submit() and
generic\_file\_splice\_read() from an nfsd context recursing into the
filesystem via the inode cache shrinker and evicting inodes. This is
causing truncation to be run (e.g EOF block freeing) and causing
bmap btree block merges and free space btree block splits to occur.
These btree manipulations are occurring with the call chain already
30 functions deep and hence there is not enough stack space to
complete such operations.
To avoid these specific overruns, we need to prevent the page cache
allocation from recursing via direct reclaim. We can do that because
the allocation functions take the allocation context from that which
is stored in the mapping for the inode. We don't set that right now,
so the default is GFP\_HIGHUSER\_MOVABLE, which is effectively a
GFP\_KERNEL context. We need it to be the equivalent of GFP\_NOFS, so
when we initialise an inode, set the mapping gfp mask appropriately.
This makes the use of AOP\_FLAG\_NOFS redundant from other parts of
the XFS IO path, so get rid of it.
Signed-off-by: Dave Chinner
Reviewed-by: Christoph Hellwig
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit e465c9574dc68d85ec16663b062c93763a6435e4
Author: Eric Sandeen
Date: Fri Oct 11 14:14:05 2013 -0500
xfs: don't break from growfs ag update loop on error
commit 59e5a0e821d838854b3afd030d31f82cee3ecd58 upstream.
When xfs\_growfs\_data\_private() is updating backup superblocks,
it bails out on the first error encountered, whether reading or
writing:
\* If we get an error writing out the alternate superblocks,
\* just issue a warning and continue. The real work is
\* already done and committed.
This can cause a problem later during repair, because repair
looks at all superblocks, and picks the most prevalent one
as correct. If we bail out early in the backup superblock
loop, we can end up with more "bad" matching superblocks than
good, and a post-growfs repair may revert the filesystem to
the old geometry.
With the combination of superblock verifiers and old bugs,
we're more likely to encounter read errors due to verification.
And perhaps even worse, we don't even properly write any of the
newly-added superblocks in the new AGs.
Even with this change, growfs will still say:
xfs\_growfs: XFS\_IOC\_FSGROWFSDATA xfsctl failed: Structure needs cleaning
data blocks changed from 319815680 to 335216640
which might be confusing to the user, but it at least communicates
that something has gone wrong, and dmesg will probably highlight
the need for an xfs\_repair.
And this is still best-effort; if verifiers fail on more than
half the backup supers, they may still "win" - but that's probably
best left to repair to more gracefully handle by doing its own
strict verification as part of the backup super "voting."
Signed-off-by: Eric Sandeen
Acked-by: Dave Chinner
Reviewed-by: Mark Tinguely
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit 22a16208d5e73c9b84629790c28df0df4183bba4
Author: Eric Sandeen
Date: Fri Oct 11 14:12:31 2013 -0500
xfs: don't emit corruption noise on fs probes
commit 31625f28ad7be67701dc4cefcf52087addd88af4 upstream.
If we get EWRONGFS due to probing of non-xfs filesystems,
there's no need to issue the scary corruption error and backtrace.
Signed-off-by: Eric Sandeen
Reviewed-by: Mark Tinguely
Reviewed-by: Christoph Hellwig
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit 192fedc5d3840a89a2d31f0f9cb7195f52a11b9d
Author: Dave Chinner
Date: Tue Oct 15 09:17:49 2013 +1100
xfs: prevent deadlock trying to cover an active log
commit 2c6e24ce1aa6b3b147c75d488c2797ee258eb22b upstream.
Recent analysis of a deadlocked XFS filesystem from a kernel
crash dump indicated that the filesystem was stuck waiting for log
space. The short story of the hang on the RHEL6 kernel is this:
- the tail of the log is pinned by an inode
- the inode has been pushed by the xfsaild
- the inode has been flushed to it's backing buffer and is
currently flush locked and hence waiting for backing
buffer IO to complete and remove it from the AIL
- the backing buffer is marked for write - it is on the
delayed write queue
- the inode buffer has been modified directly and logged
recently due to unlinked inode list modification
- the backing buffer is pinned in memory as it is in the
active CIL context.
- the xfsbufd won't start buffer writeback because it is
pinned
- xfssyncd won't force the log because it sees the log as
needing to be covered and hence wants to issue a dummy
transaction to move the log covering state machine along.
Hence there is no trigger to force the CIL to the log and hence
unpin the inode buffer and therefore complete the inode IO, remove
it from the AIL and hence move the tail of the log along, allowing
transactions to start again.
Mainline kernels also have the same deadlock, though the signature
is slightly different - the inode buffer never reaches the delayed
write lists because xfs\_buf\_item\_push() sees that it is pinned and
hence never adds it to the delayed write list that the xfsaild
flushes.
There are two possible solutions here. The first is to simply force
the log before trying to cover the log and so ensure that the CIL is
emptied before we try to reserve space for the dummy transaction in
the xfs\_log\_worker(). While this might work most of the time, it is
still racy and is no guarantee that we don't get stuck in
xfs\_trans\_reserve waiting for log space to come free. Hence it's not
the best way to solve the problem.
The second solution is to modify xfs\_log\_need\_covered() to be aware
of the CIL. We only should be attempting to cover the log if there
is no current activity in the log - covering the log is the process
of ensuring that the head and tail in the log on disk are identical
(i.e. the log is clean and at idle). Hence, by definition, if there
are items in the CIL then the log is not at idle and so we don't
need to attempt to cover it.
When we don't need to cover the log because it is active or idle, we
issue a log force from xfs\_log\_worker() - if the log is idle, then
this does nothing. However, if the log is active due to there being
items in the CIL, it will force the items in the CIL to the log and
unpin them.
In the case of the above deadlock scenario, instead of
xfs\_log\_worker() getting stuck in xfs\_trans\_reserve() attempting to
cover the log, it will instead force the log, thereby unpinning the
inode buffer, allowing IO to be issued and complete and hence
removing the inode that was pinning the tail of the log from the
AIL. At that point, everything will start moving along again. i.e.
the xfs\_log\_worker turns back into a watchdog that can alleviate
deadlocks based around pinned items that prevent the tail of the log
from being moved...
Signed-off-by: Dave Chinner
Reviewed-by: Eric Sandeen
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit 5b09381286f17ce95e334c32629584a1cad13775
Author: Jie Liu
Date: Sun Sep 22 16:25:15 2013 +0800
xfs: fix the wrong new\_size/rnew\_size at xfs\_iext\_realloc\_direct()
commit 17ec81c15fd022842f9bc947841ba9fb9eb52591 upstream.
At xfs\_iext\_realloc\_direct(), the new\_size is changed by adding
if\_bytes if originally the extent records are stored at the inline
extent buffer, and we have to switch from it to a direct extent
list for those new allocated extents, this is wrong. e.g,
Create a file with three extents which was showing as following,
xfs\_io -f -c "truncate 100m" /xfs/testme
for i in $(seq 0 5 10); do
offset=$(($i \* $((1 << 20))))
xfs\_io -c "pwrite $offset 1m" /xfs/testme
done
Inline
------
irec: if\_bytes bytes\_diff new\_size
1st 0 16 16
2nd 16 16 32
Switching
--------- rnew\_size
3rd 32 16 48 + 32 = 80 roundup=128
In this case, the desired value of new\_size should be 48, and then
it will be roundup to 64 and be assigned to rnew\_size.
However, this issue has been covered by resetting the if\_bytes to
the new\_size which is calculated at the begnning of xfs\_iext\_add()
before leaving out this function, and in turn make the rnew\_size
correctly again. Hence, this can not be detected via xfstestes.
This patch fix above problem and revise the new\_size comments at
xfs\_iext\_realloc\_direct() to make it more readable. Also, fix the
comments while switching from the inline extent buffer to a direct
extent list to reflect this change.
Signed-off-by: Jie Liu
Reviewed-by: Dave Chinner
Signed-off-by: Ben Myers
Signed-off-by: Jiri Slaby
commit 89754d5379ab1956b98f51cd2fee0cfcadb18c00
Author: Johan Hedberg
Date: Tue Jun 10 09:54:24 2014 +0300
Bluetooth: Fix check for connection encryption
commit e694788d73efe139b24f78b036deb97fe57fa8cb upstream.
The conn->link\_key variable tracks the type of link key in use. It is
set whenever we respond to a link key request as well as when we get a
link key notification event.
These two events do not however always guarantee that encryption is
enabled: getting a link key request and responding to it may only mean
that the remote side has requested authentication but not encryption. On
the other hand, the encrypt change event is a certain guarantee that
encryption is enabled. The real encryption state is already tracked in
the conn->link\_mode variable through the HCI\_LM\_ENCRYPT bit.
This patch fixes a check for encryption in the hci\_conn\_auth function to
use the proper conn->link\_mode value and thereby eliminates the chance
of a false positive result.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Cc: stable@vger.kernel.org
Signed-off-by: Jiri Slaby
commit 849dc4c5ccc4348ed2795876b3d85a52b326aef4
Author: Johan Hedberg
Date: Fri Apr 11 12:02:32 2014 -0700
Bluetooth: Fix redundant encryption request for reauthentication
commit 09da1f3463eb81d59685df723b1c5950b7570340 upstream.
When we're performing reauthentication (in order to elevate the
security level from an unauthenticated key to an authenticated one) we
do not need to issue any encryption command once authentication
completes. Since the trigger for the encryption HCI command is the
ENCRYPT\_PEND flag this flag should not be set in this scenario.
Instead, the REAUTH\_PEND flag takes care of all necessary steps for
reauthentication.
Signed-off-by: Johan Hedberg
Signed-off-by: Marcel Holtmann
Cc: stable@vger.kernel.org
Signed-off-by: Jiri Slaby
commit 442a395f704df155cbd221ca1f201cb6eaf7e050
Author: Mathias Krause
Date: Mon Sep 30 22:05:08 2013 +0200
netfilter: ipt\_ULOG: fix info leaks
commit 278f2b3e2af5f32ea1afe34fa12a2518153e6e49 upstream.
The ulog messages leak heap bytes by the means of padding bytes and
incompletely filled string arrays. Fix those by memset(0)'ing the
whole struct before filling it.
Signed-off-by: Mathias Krause
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Jiri Slaby
commit 8c23d6e199b45b042ae76cdbcfac467c7ce4e52e
Author: Andrzej Zaborowski
Date: Mon Jun 9 16:50:40 2014 +0200
efi-pstore: Fix an overflow on 32-bit builds
commit 783ee43118dc773bc8b0342c5b230e017d5a04d0 upstream.
In generic\_id the long int timestamp is multiplied by 100000 and needs
an explicit cast to u64.
Without that the id in the resulting pstore filename is wrong and
userspace may have problems parsing it, but more importantly files in
pstore can never be deleted and may fill the EFI flash (brick device?).
This happens because when generic pstore code wants to delete a file,
it passes the id to the EFI backend which reinterpretes it and a wrong
variable name is attempted to be deleted. There's no error message but
after remounting pstore, deleted files would reappear.
Signed-off-by: Andrew Zaborowski
Acked-by: David Rientjes
Signed-off-by: Matt Fleming
Signed-off-by: Jiri Slaby
commit cc6f6d1dfee2cd1f26814a9de18e71df7a2a8674
Author: Fathi Boudra
Date: Sat Apr 12 13:13:24 2014 +0300
builddeb: use $OBJCOPY variable instead of objcopy
commit 6b4a144a92ab81a1f45fb9b12aebaaaee0d08120 upstream.
In cross-build environment, we expect to use the cross-compiler objcopy
instead of the host objcopy.
It fixes following build failures:
objcopy --only-keep-debug lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko /srv/build/linux/debian/dbgtmp/usr/lib/debug/lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko
objcopy: Unable to recognise the format of the input file `lib/modules/3.14/kernel/net/ipv6/xfrm6\_mode\_tunnel.ko'
Signed-off-by: Fathi Boudra
Fixes: 810e843746b7 ('deb-pkg: split debug symbols in their own package')
Reviewed-by: Ben Hutchings
Signed-off-by: Michal Marek
Signed-off-by: Jiri Slaby
commit b8f4d2179757e17cf16644feb44879c05b5b61ef
Author: Andy Lutomirski
Date: Mon Jun 23 14:22:15 2014 -0700
x86\_32, entry: Do syscall exit work on badsys (CVE-2014-4508)
commit 554086d85e71f30abe46fc014fea31929a7c6a8a upstream.
The bad syscall nr paths are their own incomprehensible route
through the entry control flow. Rearrange them to work just like
syscalls that return -ENOSYS.
This fixes an OOPS in the audit code when fast-path auditing is
enabled and sysenter gets a bad syscall nr (CVE-2014-4508).
This has probably been broken since Linux 2.6.27:
af0575bba0 i386 syscall audit fast-path
Cc: Roland McGrath
Reported-by: Toralf Förster
Signed-off-by: Andy Lutomirski
Link: http://lkml.kernel.org/r/e09c499eade6fc321266dd6b54da7beb28d6991c.1403558229.git.luto@amacapital.net
Signed-off-by: H. Peter Anvin
Signed-off-by: Jiri Slaby
commit 8cef3ce4dab51a09ac4ba1cefedaa89aaf02ee9a
Author: Greg Kroah-Hartman
Date: Tue Jun 24 16:59:01 2014 -0400
lz4: fix another possible overrun
commit 4148c1f67abf823099b2d7db6851e4aea407f5ee upstream.
There is one other possible overrun in the lz4 code as implemented by
Linux at this point in time (which differs from the upstream lz4
codebase, but will get synced at in a future kernel release.) As
pointed out by Don, we also need to check the overflow in the data
itself.
While we are at it, replace the odd error return value with just a
"simple" -1 value as the return value is never used for anything other
than a basic "did this work or not" check.
Reported-by: "Don A. Bailey"
Reported-by: Willy Tarreau
Signed-off-by: Jiri Slaby
commit 591cb1f862018995e04a596b9bb0c469016c1c99
Author: Eric Sandeen
Date: Thu Jun 12 00:39:58 2014 -0500
btrfs: fix use of uninit "ret" in end\_extent\_writepage()
commit 3e2426bd0eb980648449e7a2f5a23e3cd3c7725c upstream.
If this condition in end\_extent\_writepage() is false:
if (tree->ops && tree->ops->writepage\_end\_io\_hook)
we will then test an uninitialized "ret" at:
ret = ret < 0 ? ret : -EIO;
The test for ret is for the case where ->writepage\_end\_io\_hook
failed, and we'd choose that ret as the error; but if
there is no ->writepage\_end\_io\_hook, nothing sets ret.
Initializing ret to 0 should be sufficient; if
writepage\_end\_io\_hook wasn't set, (!uptodate) means
non-zero err was passed in, so we choose -EIO in that case.
Signed-of-by: Eric Sandeen
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit f383013c585b3ef91f1f19f0c9d2e60071e5fb01
Author: Liu Bo
Date: Mon Jun 9 10:54:07 2014 +0800
Btrfs: fix scrub\_print\_warning to handle skinny metadata extents
commit 6eda71d0c030af0fc2f68aaa676e6d445600855b upstream.
The skinny extents are intepreted incorrectly in scrub\_print\_warning(),
and end up hitting the BUG() in btrfs\_extent\_inline\_ref\_size.
Reported-by: Konstantinos Skarlatos
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 9cfeffa534ee24706e3269ec2aff6b8c8d278f68
Author: Liu Bo
Date: Sun Jun 8 19:04:13 2014 +0800
Btrfs: use right type to get real comparison
commit cd857dd6bc2ae9ecea14e75a34e8a8fdc158e307 upstream.
We want to make sure the point is still within the extent item, not to verify
the memory it's pointing to.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit b01e4806671d4b756fb35285b08ba140da41ffc8
Author: Rickard Strandqvist
Date: Thu May 22 22:43:43 2014 +0200
fs: btrfs: volumes.c: Fix for possible null pointer dereference
commit 8321cf2596d283821acc466377c2b85bcd3422b7 upstream.
There is otherwise a risk of a possible null pointer dereference.
Was largely found by using a static code analysis program called cppcheck.
Signed-off-by: Rickard Strandqvist
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 2f4f6fcff97f05917b75ecfaa7a5903f1ae089d8
Author: Filipe Manana
Date: Sun May 25 04:49:24 2014 +0100
Btrfs: send, don't error in the presence of subvols/snapshots
commit 1af56070e3ef9477dbc7eba3b9ad7446979c7974 upstream.
If we are doing an incremental send and the base snapshot has a
directory with name X that doesn't exist anymore in the second
snapshot and a new subvolume/snapshot exists in the second snapshot
that has the same name as the directory (name X), the incremental
send would fail with -ENOENT error. This is because it attempts
to lookup for an inode with a number matching the objectid of a
root, which doesn't exist.
Steps to reproduce:
mkfs.btrfs -f /dev/sdd
mount /dev/sdd /mnt
mkdir /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap1
rmdir /mnt/testdir
btrfs subvolume create /mnt/testdir
btrfs subvolume snapshot -r /mnt /mnt/mysnap2
btrfs send -p /mnt/mysnap1 /mnt/mysnap2 -f /tmp/send.data
A test case for xfstests follows.
Reported-by: Robert White
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 9612bd1d820c62ec1f556ae5ba99191424fc1f16
Author: Wang Shilong
Date: Tue May 13 17:05:06 2014 +0800
Btrfs: set right total device count for seeding support
commit 298658414a2f0bea1f05a81876a45c1cd96aa2e0 upstream.
Seeding device support allows us to create a new filesystem
based on existed filesystem.
However newly created filesystem's @total\_devices should include seed
devices. This patch fix the following problem:
# mkfs.btrfs -f /dev/sdb
# btrfstune -S 1 /dev/sdb
# mount /dev/sdb /mnt
# btrfs device add -f /dev/sdc /mnt --->fs\_devices->total\_devices = 1
# umount /mnt
# mount /dev/sdc /mnt --->fs\_devices->total\_devices = 2
This is because we record right @total\_devices in superblock, but
@fs\_devices->total\_devices is reset to be 0 in btrfs\_prepare\_sprout().
Fix this problem by not resetting @fs\_devices->total\_devices.
Signed-off-by: Wang Shilong
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit fbf046315fca47774f4843d74a58b4140d47bd16
Author: Liu Bo
Date: Mon May 12 12:47:36 2014 +0800
Btrfs: mark mapping with error flag to report errors to userspace
commit 5dca6eea91653e9949ce6eb9e9acab6277e2f2c4 upstream.
According to commit 865ffef3797da2cac85b3354b5b6050dc9660978
(fs: fix fsync() error reporting),
it's not stable to just check error pages because pages can be
truncated or invalidated, we should also mark mapping with error
flag so that a later fsync can catch the error.
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 05303b9142ed4b49021f26f06d22dee2fe7d7660
Author: Liu Bo
Date: Sun May 11 23:14:59 2014 +0800
Btrfs: fix NULL pointer crash of deleting a seed device
commit 29cc83f69c8338ff8fd1383c9be263d4bdf52d73 upstream.
Same as normal devices, seed devices should be initialized with
fs\_info->dev\_root as well, otherwise we'll get a NULL pointer crash.
Cc: Chris Murphy
Reported-by: Chris Murphy
Signed-off-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 7bfc76578ecf80d87d0e8641c1e7bcbbfca9d811
Author: Wang Shilong
Date: Wed Apr 9 19:23:22 2014 +0800
Btrfs: make sure there are not any read requests before stopping workers
commit de348ee022175401e77d7662b7ca6e231a94e3fd upstream.
In close\_ctree(), after we have stopped all workers,there maybe still
some read requests(for example readahead) to submit and this \*maybe\* trigger
an oops that user reported before:
kernel BUG at fs/btrfs/async-thread.c:619!
By hacking codes, i can reproduce this problem with one cpu available.
We fix this potential problem by invalidating all btree inode pages before
stopping all workers.
Thanks to Miao for pointing out this problem.
Signed-off-by: Wang Shilong
Reviewed-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit e3ffc9a32997aa626decfe04e7990ba70ee2cc2a
Author: Miao Xie
Date: Thu Apr 24 13:31:55 2014 +0800
Btrfs: output warning instead of error when loading free space cache failed
commit 32d6b47fe6fc1714d5f1bba1b9f38e0ab0ad58a8 upstream.
If we fail to load a free space cache, we can rebuild it from the extent tree,
so it is not a serious error, we should not output a error message that
would make the users uncomfortable. This patch uses warning message instead
of it.
Signed-off-by: Miao Xie
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit ed7eaa4ec0d585b9dc0d23be3e1910702191b174
Author: Qu Wenruo
Date: Wed Apr 16 17:02:32 2014 +0800
btrfs: Add ctime/mtime update for btrfs device add/remove.
commit 5a1972bd9fd4b2fb1bac8b7a0b636d633d8717e3 upstream.
Btrfs will send uevent to udev inform the device change,
but ctime/mtime for the block device inode is not udpated, which cause
libblkid used by btrfs-progs unable to detect device change and use old
cache, causing 'btrfs dev scan; btrfs dev rmove; btrfs dev scan' give an
error message.
Reported-by: Tsutomu Itoh
Cc: Karel Zak
Signed-off-by: Qu Wenruo
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 7855e3447a166f5a24d2b95dc2633f7fb9eb6cc9
Author: Chris Mason
Date: Wed May 21 05:49:54 2014 -0700
Btrfs: fix double free in find\_lock\_delalloc\_range
commit 7d78874273463a784759916fc3e0b4e2eb141c70 upstream.
We need to NULL the cached\_state after freeing it, otherwise
we might free it again if find\_delalloc\_range doesn't find anything.
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 9335d6f8b8f53fa6da1cc64b8effe2388d4254dd
Author: Pavel Shilovsky
Date: Sat May 24 16:42:02 2014 +0400
CIFS: Fix memory leaks in SMB2\_open
commit 663a962151593c69374776e8651238d0da072459 upstream.
Signed-off-by: Pavel Shilovsky
Reviewed-by: Shirish Pargaonkar
Signed-off-by: Steve French
Signed-off-by: Jiri Slaby
commit 0e2e24e5dc6eb6f0698e9dc97e652f132b885624
Author: Benjamin LaHaise
Date: Tue Jun 24 13:32:51 2014 -0400
aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10
commit edfbbf388f293d70bf4b7c0bc38774d05e6f711a upstream.
A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
Signed-off-by: Benjamin LaHaise
Cc: Mateusz Guzik
Cc: Petr Matousek
Cc: Kent Overstreet
Cc: Jeff Moyer
Signed-off-by: Jiri Slaby
commit 3f29879bfd90cb82cf8a96496499c194b6d3c9dc
Author: Thomas Gleixner
Date: Thu Mar 7 14:53:45 2013 +0100
genirq: Sanitize spurious interrupt detection of threaded irqs
commit 1e77d0a1ed7417d2a5a52a7b8d32aea1833faa6c upstream.
Till reported that the spurious interrupt detection of threaded
interrupts is broken in two ways:
- note\_interrupt() is called for each action thread of a shared
interrupt line. That's wrong as we are only interested whether none
of the device drivers felt responsible for the interrupt, but by
calling multiple times for a single interrupt line we account
IRQ\_NONE even if one of the drivers felt responsible.
- note\_interrupt() when called from the thread handler is not
serialized. That leaves the members of irq\_desc which are used for
the spurious detection unprotected.
To solve this we need to defer the spurious detection of a threaded
interrupt to the next hardware interrupt context where we have
implicit serialization.
If note\_interrupt is called with action\_ret == IRQ\_WAKE\_THREAD, we
check whether the previous interrupt requested a deferred check. If
not, we request a deferred check for the next hardware interrupt and
return.
If set, we check whether one of the interrupt threads signaled
success. Depending on this information we feed the result into the
spurious detector.
If one primary handler of a shared interrupt returns IRQ\_HANDLED we
disable the deferred check of irq threads on the same line, as we have
found at least one device driver who cared.
Reported-by: Till Straumann
Signed-off-by: Thomas Gleixner
Tested-by: Austin Schuh
Cc: Oliver Hartkopp
Cc: Wolfgang Grandegger
Cc: Pavel Pisa
Cc: Marc Kleine-Budde
Cc: linux-can@vger.kernel.org
Link: http://lkml.kernel.org/r/alpine.LFD.2.02.1303071450130.22263@ionos
Signed-off-by: Jiri Slaby
commit 672998dd78fe2092cd5cd1db64d654acb877cf9f
Author: Mike Frysinger
Date: Sun May 4 20:43:15 2014 -0400
x86, x32: Use compat shims for io\_{setup,submit}
commit 7fd44dacdd803c0bbf38bf478d51d280902bb0f1 upstream.
The io\_setup takes a pointer to a context id of type aio\_context\_t.
This in turn is typed to a \_\_kernel\_ulong\_t. We could tweak the
exported headers to define this as a 64bit quantity for specific
ABIs, but since we already have a 32bit compat shim for the x86 ABI,
let's just re-use that logic. The libaio package is also written to
expect this as a pointer type, so a compat shim would simplify that.
The io\_submit func operates on an array of pointers to iocb structs.
Padding out the array to be 64bit aligned is a huge pain, so convert
it over to the existing compat shim too.
We don't convert io\_getevents to the compat func as its only purpose
is to handle the timespec struct, and the x32 ABI uses 64bit times.
With this change, the libaio package can now pass its testsuite when
built for the x32 ABI.
Signed-off-by: Mike Frysinger
Link: http://lkml.kernel.org/r/1399250595-5005-1-git-send-email-vapier@gentoo.org
Cc: H.J. Lu
Signed-off-by: H. Peter Anvin
Signed-off-by: Jiri Slaby
commit e45e2e7ab002b90cf01eef6debbfc0c2495ae272
Author: H. Peter Anvin
Date: Wed Apr 30 14:03:25 2014 -0700
x86-32, espfix: Remove filter for espfix32 due to race
commit 246f2d2ee1d715e1077fc47d61c394569c8ee692 upstream.
It is not safe to use LAR to filter when to go down the espfix path,
because the LDT is per-process (rather than per-thread) and another
thread might change the descriptors behind our back. Fortunately it
is always \*safe\* (if a bit slow) to go down the espfix path, and a
32-bit LDT stack segment is extremely rare.
Signed-off-by: H. Peter Anvin
Link: http://lkml.kernel.org/r/1398816946-3351-1-git-send-email-hpa@linux.intel.com
Signed-off-by: Jiri Slaby
commit 186f32e2096c7d9cd9106b8dedd79c596f4c8398
Author: Nicholas A. Bellinger
Date: Mon Jun 16 20:59:52 2014 +0000
target: Explicitly clear ramdisk\_mcp backend pages
[Note that a different patch to address the same issue went in during
v3.15-rc1 (commit 4442dc8a), but includes a bunch of other changes that
don't strictly apply to fixing the bug]
This patch changes rd\_allocate\_sgl\_table() to explicitly clear
ramdisk\_mcp backend memory pages by passing \_\_GFP\_ZERO into
alloc\_pages().
This addresses a potential security issue where reading from a
ramdisk\_mcp could return sensitive information, and follows what
>= v3.15 does to explicitly clear ramdisk\_mcp memory at backend
device initialization time.
Reported-by: Jorge Daniel Sequeira Matias
Cc: Jorge Daniel Sequeira Matias
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit 3942c33e4b6b84653b04314f526907ae74984f87
Author: Roland Dreier
Date: Tue Jun 10 11:07:47 2014 -0700
target: Report correct response length for some commands
commit 2426bd456a61407388b6e61fc5f98dbcbebc50e2 upstream.
When an initiator sends an allocation length bigger than what its
command consumes, the target should only return the actual response data
and set the residual length to the unused part of the allocation length.
Add a helper function that command handlers (INQUIRY, READ CAPACITY,
etc) can use to do this correctly, and use this code to get the correct
residual for commands that don't use the full initiator allocation in the
handlers for READ CAPACITY, READ CAPACITY(16), INQUIRY, MODE SENSE and
REPORT LUNS.
This addresses a handful of failures as reported by Christophe with
the Windows Certification Kit:
http://permalink.gmane.org/gmane.linux.scsi.target.devel/6515
Signed-off-by: Roland Dreier
Tested-by: Christophe Vu-Brugier
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit 53f1d104f250540853271653f507ac09b4bfc66e
Author: Sagi Grimberg
Date: Tue Jun 10 18:27:59 2014 +0300
Target/iscsi: Fix sendtargets response pdu for iser transport
commit 22c7aaa57e80853b4904a46c18f97db0036a3b97 upstream.
In case the transport is iser we should not include the
iscsi target info in the sendtargets text response pdu.
This causes sendtargets response to include the target
info twice.
Modify iscsit\_build\_sendtargets\_response to filter
transport types that don't match.
Signed-off-by: Sagi Grimberg
Reported-by: Slava Shwartsman
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit 18b0e46ab4670436bcef4df0807ade2ffa7901ce
Author: Nicholas Bellinger
Date: Tue Jun 10 04:03:54 2014 +0000
iscsi-target: Fix ABORT\_TASK + connection reset iscsi\_queue\_req memory leak
commit bbc050488525e1ab1194c27355f63c66814385b8 upstream.
This patch fixes a iscsi\_queue\_req memory leak when ABORT\_TASK response
has been queued by TFO->queue\_tm\_rsp() -> lio\_queue\_tm\_rsp() after a
long standing I/O completes, but the connection has already reset and
waiting for cleanup to complete in iscsit\_release\_commands\_from\_conn()
-> transport\_generic\_free\_cmd() -> transport\_wait\_for\_tasks() code.
It moves iscsit\_free\_queue\_reqs\_for\_conn() after the per-connection command
list has been released, so that the associated se\_cmd tag can be completed +
released by target-core before freeing any remaining iscsi\_queue\_req memory
for the connection generated by lio\_queue\_tm\_rsp().
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit ab7f3e4697f12ad16c816fdb27e3e494809bad91
Author: Nicholas Bellinger
Date: Mon Jun 9 23:36:51 2014 +0000
target: Use complete\_all for se\_cmd->t\_transport\_stop\_comp
commit a95d6511303b848da45ee27b35018bb58087bdc6 upstream.
This patch fixes a bug where multiple waiters on ->t\_transport\_stop\_comp
occurs due to a concurrent ABORT\_TASK and session reset both invoking
transport\_wait\_for\_tasks(), while waiting for the associated se\_cmd
descriptor backend processing to complete.
For this case, complete\_all() should be invoked in order to wake up
both waiters in core\_tmr\_abort\_task() + transport\_generic\_free\_cmd()
process contexts.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit a08f9367aa469714683c41b0780c598945fa1099
Author: Nicholas Bellinger
Date: Mon Jun 9 23:13:20 2014 +0000
target: Set CMD\_T\_ACTIVE bit for Task Management Requests
commit f15e9cd910c4d9da7de43f2181f362082fc45f0f upstream.
This patch fixes a bug where se\_cmd descriptors associated with a
Task Management Request (TMR) where not setting CMD\_T\_ACTIVE before
being dispatched into target\_tmr\_work() process context.
This is required in order for transport\_generic\_free\_cmd() ->
transport\_wait\_for\_tasks() to wait on se\_cmd->t\_transport\_stop\_comp
if a session reset event occurs while an ABORT\_TASK is outstanding
waiting for another I/O to complete.
Cc: Thomas Glanzmann
Cc: Charalampos Pournaris
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit 1d88b1199369e23dae9261f2861cda9e431aee76
Author: Sagi Grimberg
Date: Mon May 19 17:44:25 2014 +0300
Target/iser: Wait for proper cleanup before unloading
commit f5ebec9629cf78eeeea4b8258882a9f439ab2404 upstream.
disconnected\_handler works are scheduled on system\_wq.
When attempting to unload, first make sure all works
have cleaned up.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit f3c158abb8cbde83e5c95431db41d8da9acd7e98
Author: Sagi Grimberg
Date: Mon May 19 17:44:24 2014 +0300
Target/iser: Improve cm events handling
commit 88c4015fda6d014392f76d3b1688347950d7a12d upstream.
There are 4 RDMA\_CM events that all basically mean that
the user should teardown the IB connection:
- DISCONNECTED
- ADDR\_CHANGE
- DEVICE\_REMOVAL
- TIMEWAIT\_EXIT
Only in DISCONNECTED/ADDR\_CHANGE it makes sense to
call rdma\_disconnect (send DREQ/DREP to our initiator).
So we keep the same teardown handler for all of them
but only indicate calling rdma\_disconnect for the relevant
events.
This patch also removes redundant debug prints for each single
event.
v2 changes:
- Call isert\_disconnected\_handler() for DEVICE\_REMOVAL (Or + Sag)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit 34992ea555198a7c1df1700444773324254a7a87
Author: Sagi Grimberg
Date: Mon May 19 17:44:23 2014 +0300
Target/iser: Fix hangs in connection teardown
commit 9d49f5e284e700576f3b65f1e28dea8539da6661 upstream.
In ungraceful teardowns isert close flows seem racy such that
isert\_wait\_conn hangs as RDMA\_CM\_EVENT\_DISCONNECTED never
gets invoked (no one called rdma\_disconnect).
Both graceful and ungraceful teardowns will have rx flush errors
(isert posts a batch once connection is established). Once all
flush errors are consumed we invoke isert\_wait\_conn and it will
be responsible for calling rdma\_disconnect. This way it can be
sure that rdma\_disconnect was called and it won't wait forever.
This patch also removes the logout\_posted indicator. either the
logout completion was consumed and no problem decrementing the
post\_send\_buf\_count, or it was consumed as a flush error. no point
of keeping it for isert\_wait\_conn as there is no danger that
isert\_conn will be accidentally removed while it is running.
(Drop unnecessary sleep\_on\_conn\_wait\_comp check in
isert\_cq\_rx\_comp\_err - nab)
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit 391416ca2aeff3a33fdd9fa343b9a622ea00523e
Author: Sagi Grimberg
Date: Mon May 19 17:44:22 2014 +0300
Target/iser: Bail from accept\_np if np\_thread is trying to close
commit e346ab343f4f58c12a96725c7b13df9cc2ad56f6 upstream.
In case np\_thread state is in RESET/SHUTDOWN/EXIT states,
no point for isert to stall there as we may get a hang in
case no one will wake it up later.
Signed-off-by: Sagi Grimberg
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jiri Slaby
commit a9fb5766418105ab7fa4eba2163441869f94be40
Author: Jukka Taimisto
Date: Thu May 22 10:02:39 2014 +0000
Bluetooth: Fix L2CAP deadlock
commit 8a96f3cd22878fc0bb564a8478a6e17c0b8dca73 upstream.
-[0x01 Introduction
We have found a programming error causing a deadlock in Bluetooth subsystem
of Linux kernel. The problem is caused by missing release\_sock() call when
L2CAP connection creation fails due full accept queue.
The issue can be reproduced with 3.15-rc5 kernel and is also present in
earlier kernels.
-[0x02 Details
The problem occurs when multiple L2CAP connections are created to a PSM which
contains listening socket (like SDP) and left pending, for example,
configuration (the underlying ACL link is not disconnected between
connections).
When L2CAP connection request is received and listening socket is found the
l2cap\_sock\_new\_connection\_cb() function (net/bluetooth/l2cap\_sock.c) is called.
This function locks the 'parent' socket and then checks if the accept queue
is full.
1178 lock\_sock(parent);
1179
1180 /\* Check for backlog size \*/
1181 if (sk\_acceptq\_is\_full(parent)) {
1182 BT\_DBG("backlog full %d", parent->sk\_ack\_backlog);
1183 return NULL;
1184 }
If case the accept queue is full NULL is returned, but the 'parent' socket
is not released. Thus when next L2CAP connection request is received the code
blocks on lock\_sock() since the parent is still locked.
Also note that for connections already established and waiting for
configuration to complete a timeout will occur and l2cap\_chan\_timeout()
(net/bluetooth/l2cap\_core.c) will be called. All threads calling this
function will also be blocked waiting for the channel mutex since the thread
which is waiting on lock\_sock() alread holds the channel mutex.
We were able to reproduce this by sending continuously L2CAP connection
request followed by disconnection request containing invalid CID. This left
the created connections pending configuration.
After the deadlock occurs it is impossible to kill bluetoothd, btmon will not
get any more data etc. requiring reboot to recover.
-[0x03 Fix
Releasing the 'parent' socket when l2cap\_sock\_new\_connection\_cb() returns NULL
seems to fix the issue.
Signed-off-by: Jukka Taimisto
Reported-by: Tommi Mäkilä
Signed-off-by: Johan Hedberg
Signed-off-by: Jiri Slaby
commit 2223d1af7def3027f997782665289d91882e0231
Author: Felipe Balbi
Date: Wed Apr 23 09:58:26 2014 -0500
bluetooth: hci\_ldisc: fix deadlock condition
commit da64c27d3c93ee9f89956b9de86c4127eb244494 upstream.
LDISCs shouldn't call tty->ops->write() from within
->write\_wakeup().
->write\_wakeup() is called with port lock taken and
IRQs disabled, tty->ops->write() will try to acquire
the same port lock and we will deadlock.
Acked-by: Marcel Holtmann
Reviewed-by: Peter Hurley
Reported-by: Huang Shijie
Signed-off-by: Felipe Balbi
Tested-by: Andreas Bießmann
Signed-off-by: Jiri Slaby
commit 8f375cf896c00bf6a66faf6f1e36699ac4f3cbda
Author: Jianguo Wu
Date: Thu Apr 24 03:45:56 2014 +0100
ARM: 8037/1: mm: support big-endian page tables
commit 86f40622af7329375e38f282f6c0aab95f3e5f72 upstream.
When enable LPAE and big-endian in a hisilicon board, while specify
mem=384M mem=512M@7680M, will get bad page state:
Freeing unused kernel memory: 180K (c0466000 - c0493000)
BUG: Bad page state in process init pfn:fa442
page:c7749840 count:0 mapcount:-1 mapping: (null) index:0x0
page flags: 0x40000400(reserved)
Modules linked in:
CPU: 0 PID: 1 Comm: init Not tainted 3.10.27+ #66
[] (unwind\_backtrace+0x0/0x11c) from [] (show\_stack+0x10/0x14)
[] (show\_stack+0x10/0x14) from [] (bad\_page+0xd4/0x104)
[] (bad\_page+0xd4/0x104) from [] (free\_pages\_prepare+0xa8/0x14c)
[] (free\_pages\_prepare+0xa8/0x14c) from [] (free\_hot\_cold\_page+0x18/0xf0)
[] (free\_hot\_cold\_page+0x18/0xf0) from [] (handle\_pte\_fault+0xcf4/0xdc8)
[] (handle\_pte\_fault+0xcf4/0xdc8) from [] (handle\_mm\_fault+0xf4/0x120)
[] (handle\_mm\_fault+0xf4/0x120) from [] (do\_page\_fault+0xfc/0x354)
[] (do\_page\_fault+0xfc/0x354) from [] (do\_DataAbort+0x2c/0x90)
[] (do\_DataAbort+0x2c/0x90) from [] (\_\_dabt\_usr+0x34/0x40)
The bad pfn:fa442 is not system memory(mem=384M mem=512M@7680M), after debugging,
I find in page fault handler, will get wrong pfn from pte just after set pte,
as follow:
do\_anonymous\_page()
{
...
set\_pte\_at(mm, address, page\_table, entry);
//debug code
pfn = pte\_pfn(entry);
pr\_info("pfn:0x%lx, pte:0x%llxn", pfn, pte\_val(entry));
//read out the pte just set
new\_pte = pte\_offset\_map(pmd, address);
new\_pfn = pte\_pfn(\*new\_pte);
pr\_info("new pfn:0x%lx, new pte:0x%llxn", pfn, pte\_val(entry));
...
}
pfn: 0x1fa4f5, pte:0xc00001fa4f575f
new\_pfn:0xfa4f5, new\_pte:0xc00000fa4f5f5f //new pfn/pte is wrong.
The bug is happened in cpu\_v7\_set\_pte\_ext(ptep, pte):
An LPAE PTE is a 64bit quantity, passed to cpu\_v7\_set\_pte\_ext in the r2 and r3 registers.
On an LE kernel, r2 contains the LSB of the PTE, and r3 the MSB.
On a BE kernel, the assignment is reversed.
Unfortunately, the current code always assumes the LE case,
leading to corruption of the PTE when clearing/setting bits.
This patch fixes this issue much like it has been done already in the
cpu\_v7\_switch\_mm case.
Signed-off-by: Jianguo Wu
Acked-by: Marc Zyngier
Acked-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Jiri Slaby
commit da2212cb0877874751262d1ea1a33c1c590da921
Author: Russell King
Date: Sat May 3 11:03:28 2014 +0100
ARM: stacktrace: avoid listing stacktrace functions in stacktrace
commit 3683f44c42e991d313dc301504ee0fca1aeb8580 upstream.
While debugging the FEC ethernet driver using stacktrace, it was noticed
that the stacktraces always begin as follows:
[] save\_stack\_trace\_tsk+0x0/0x98
[] save\_stack\_trace+0x24/0x28
...
This is because the stack trace code includes the stack frames for itself.
This is incorrect behaviour, and also leads to "skip" doing the wrong
thing (which is the number of stack frames to avoid recording.)
Perversely, it does the right thing when passed a non-current thread. Fix
this by ensuring that we have a known constant number of frames above the
main stack trace function, and always skip these.
Signed-off-by: Russell King
Signed-off-by: Jiri Slaby
commit d22659aebe32761443e9d2aa92c6ef16e82a5431
Author: Olivier Langlois
Date: Fri Mar 28 02:42:38 2014 -0300
media: uvcvideo: Fix clock param realtime setting
commit 3b35fc81e7ec552147a4fd843d0da0bbbe4ef253 upstream.
timestamps in v4l2 buffers returned to userspace are updated in
uvc\_video\_clock\_update() which uses timestamps fetched from
uvc\_video\_clock\_decode() by calling unconditionally ktime\_get\_ts().
Hence setting the module clock param to realtime has no effect before
this patch.
This has been tested with ffmpeg:
ffmpeg -y -f v4l2 -input\_format yuyv422 -video\_size 640x480 -framerate 30 -i /dev/video0 \
-f alsa -acodec pcm\_s16le -ar 16000 -ac 1 -i default \
-c:v libx264 -preset ultrafast \
-c:a libfdk\_aac \
out.mkv
and inspecting the v4l2 input starting timestamp.
Signed-off-by: Olivier Langlois
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Jiri Slaby
commit b9441d724ec9a61f8dcbaec7c2863550ba29c105
Author: Lv Zheng
Date: Mon May 12 15:50:16 2014 +0800
ACPI: Fix conflict between customized DSDT and DSDT local copy
commit 73577d1df8e1f31f6b1a5eebcdbc334eb0330e47 upstream.
This patch fixes the following issue:
If DSDT is customized, no local DSDT copy is needed.
References: https://bugzilla.kernel.org/show\_bug.cgi?id=69711
Signed-off-by: Enrico Etxe Arte
Signed-off-by: Lv Zheng
[rjw: Subject]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Jiri Slaby
commit 1da24fbdaf50f6b2e209a3e569c2071899d9ebb7
Author: David Binderman
Date: Fri Apr 4 12:36:55 2014 +0800
ACPICA: utstring: Check array index bound before use.
commit 5d42b0fa25df7ef2f575107597c1aaebe2407d10 upstream.
ACPICA BZ 1077. David Binderman.
References: https://bugs.acpica.org/show\_bug.cgi?id=1077
Signed-off-by: David Binderman
Signed-off-by: Bob Moore
Signed-off-by: Lv Zheng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Jiri Slaby
commit 956ff41ab990ddea83717e5bbad2bfb56277ab76
Author: Ezequiel Garcia
Date: Thu Apr 17 09:28:20 2014 -0300
media: stk1160: Avoid stack-allocated buffer for control URBs
commit 85ac1a1772bb41da895bad83a81f6a62c8f293f6 upstream.
Currently stk1160\_read\_reg() uses a stack-allocated char to get the
read control value. This is wrong because usb\_control\_msg() requires
a kmalloc-ed buffer.
This commit fixes such issue by kmalloc'ating a 1-byte buffer to receive
the read value.
While here, let's remove the urb\_buf array which was meant for a similar
purpose, but never really used.
Cc: Alan Stern
Reported-by: Sander Eikelenboom
Signed-off-by: Ezequiel Garcia
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Jiri Slaby
commit 30d8ffb3f0b2d340f782d464fb35323fb915b593
Author: Takashi Iwai
Date: Mon May 5 11:20:05 2014 -0300
media: ivtv: Fix Oops when no firmware is loaded
commit deb29e90221a6d4417aa67be971613c353180331 upstream.
When ivtv PCM device is accessed at the state where no firmware is
loaded, it oopses like:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000050
IP: [] try\_mailbox.isra.0+0x11/0x50 [ivtv]
Call Trace:
[] ivtv\_api\_call+0x160/0x6b0 [ivtv]
[] ivtv\_api+0x16/0x40 [ivtv]
[] ivtv\_vapi+0xac/0xc0 [ivtv]
[] ivtv\_start\_v4l2\_encode\_stream+0x19d/0x630 [ivtv]
[] snd\_ivtv\_pcm\_capture\_open+0x173/0x1c0 [ivtv\_alsa]
[] snd\_pcm\_open\_substream+0x51/0x100 [snd\_pcm]
[] snd\_pcm\_open+0xb3/0x260 [snd\_pcm]
[] snd\_pcm\_capture\_open+0x37/0x50 [snd\_pcm]
[] snd\_open+0xa7/0x1e0 [snd]
[] chrdev\_open+0x88/0x1d0
[] do\_dentry\_open+0x1de/0x270
[] do\_last+0x1c3/0xec0
[] path\_openat+0xb6/0x670
[] do\_filp\_open+0x35/0x80
[] do\_sys\_open+0x129/0x210
[] system\_call\_fastpath+0x1a/0x1f
This patch adds the check of firmware at PCM open callback like other
open callbacks of this driver.
Bugzilla: https://apibugzilla.novell.com/show\_bug.cgi?id=875440
Signed-off-by: Takashi Iwai
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Jiri Slaby
commit 957bd4c349be6d8dc9b7ae477543e5a7e1596573
Author: Johan Hovold
Date: Mon May 26 19:23:33 2014 +0200
USB: serial: fix potential runtime pm imbalance at device remove
commit c14829fad88dbeda57253590695b85ba51270621 upstream.
Only call usb\_autopm\_put\_interface() if the corresponding
usb\_autopm\_get\_interface() was successful.
This prevents a potential runtime PM counter imbalance should
usb\_autopm\_get\_interface() fail. Note that the USB PM usage counter is
reset when the interface is unbound, but that the runtime PM counter may
be left unbalanced.
Also add comment on why we don't need to worry about racing
resume/suspend on autopm\_get failures.
Fixes: d5fd650cfc7f ("usb: serial: prevent suspend/resume from racing
against probe/remove")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 59f8ef8d0f3874085db8e8ce40762997f7381a61
Author: Johan Hovold
Date: Mon May 26 19:22:54 2014 +0200
USB: sierra: fix remote wakeup
commit 80cc0fcbdaeaf10d04ba27779a2d7ceb73d2717a upstream.
Make sure that needs\_remote\_wake up is always set when there are open
ports.
Currently close() would unconditionally set needs\_remote\_wakeup to 0
even though there might still be open ports. This could lead to blocked
input and possibly dropped data on devices that do not support remote
wakeup (and which must therefore not be runtime suspended while open).
Add an open\_ports counter (protected by the susp\_lock) and only clear
needs\_remote\_wakeup when the last port is closed.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 7e7ccedc9d21441463fd5de3d365779358643541
Author: Johan Hovold
Date: Mon May 26 19:22:53 2014 +0200
USB: sierra: fix urb and memory leak on disconnect
commit 014333f77c0b71123d6ef7d31a9724e0699c9548 upstream.
The delayed-write queue was never emptied on disconnect, something which
would lead to leaked urbs and transfer buffers if the device is
disconnected before being runtime resumed due to a write.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit a2aa73192ac6f2ce57549f39b1944396be1855a6
Author: Johan Hovold
Date: Mon May 26 19:22:52 2014 +0200
USB: sierra: fix urb and memory leak in resume error path
commit 7fdd26a01eb7b6cb6855ff8f69ef4a720720dfcb upstream.
Neither the transfer buffer or the urb itself were released in the
resume error path for delayed writes. Also on errors, the remainder of
the queue was not even processed, which leads to further urb and buffer
leaks.
The same error path also failed to balance the outstanding-urb counter,
something which results in degraded throughput or completely blocked
writes.
Fix this by releasing urb and buffer and balancing counters on errors,
and by always processing the whole queue even when submission of one urb
fails.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 06974d798d13f913e2ca85cedba76df8fabb72dd
Author: Johan Hovold
Date: Mon May 26 19:22:51 2014 +0200
USB: sierra: fix use after free at suspend/resume
commit 8452727de70f6ad850cd6d0aaa18b5d9050aa63b upstream.
Fix use after free or NULL-pointer dereference during suspend and
resume.
The port data may never have been allocated (port probe failed)
or may already have been released by port\_remove (e.g. driver is
unloaded) when suspend and resume are called.
Fixes: e6929a9020ac ("USB: support for autosuspend in sierra while
online")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 8ae7a23bb2f7b01e10f99dbd9b63b9bdca82dd79
Author: Johan Hovold
Date: Mon May 26 19:22:50 2014 +0200
USB: sierra: fix AA deadlock in open error path
commit 353fe198602e8b4d1c7bdcceb8e60955087201b1 upstream.
Fix AA deadlock in open error path that would call close() and try to
grab the already held disc\_mutex.
Fixes: b9a44bc19f48 ("sierra: driver urb handling improvements")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 7a797aa04fca5d0c37cd10058770f98aa3e83c24
Author: Johan Hovold
Date: Mon May 26 19:23:18 2014 +0200
USB: usb\_wwan: fix potential blocked I/O after resume
commit fb7ad4f93d9f0f7d49beda32f5e7becb94b29a4d upstream.
Keep trying to submit urbs rather than bail out on first read-urb
submission error, which would also prevent I/O for any further ports
from being resumed.
Instead keep an error count, for all types of failed submissions, and
let USB core know that something went wrong.
Also make sure to always clear the suspended flag. Currently a failed
read-urb submission would prevent cached writes as well as any
subsequent writes from being submitted until next suspend-resume cycle,
something which may not even necessarily happen.
Note that USB core currently only logs an error if an interface resume
failed.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit bfd75a498e07ea25e891b94a82e2cb216b19c01c
Author: Johan Hovold
Date: Mon May 26 19:23:17 2014 +0200
USB: usb\_wwan: fix potential NULL-deref at resume
commit 9096f1fbba916c2e052651e9de82fcfb98d4bea7 upstream.
The interrupt urb was submitted unconditionally at resume, something
which could lead to a NULL-pointer dereference in the urb completion
handler as resume may be called after the port and port data is gone.
Fix this by making sure the interrupt urb is only submitted and active
when the port is open.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 9b71d5c368ad55b93a36846f0c4225bd7cd63edb
Author: Johan Hovold
Date: Mon May 26 19:23:16 2014 +0200
USB: usb\_wwan: fix urb leak at shutdown
commit 79eed03e77d481b55d85d1cfe5a1636a0d3897fd upstream.
The delayed-write queue was never emptied at shutdown (close), something
which could lead to leaked urbs if the port is closed before being
runtime resumed due to a write.
When this happens the output buffer would not drain on close
(closing\_wait timeout), and after consecutive opens, writes could be
corrupted with previously buffered data, transfered with reduced
throughput or completely blocked.
Note that unbusy\_queued\_urb() was simply moved out of CONFIG\_PM.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 097280999c085494a3e7c441fa1251e4c67ee927
Author: Johan Hovold
Date: Mon May 26 19:23:15 2014 +0200
USB: usb\_wwan: fix write and suspend race
commit 170fad9e22df0063eba0701adb966786d7a4ec5a upstream.
Fix race between write() and suspend() which could lead to writes being
dropped (or I/O while suspended) if the device is runtime suspended
while a write request is being processed.
Specifically, suspend() releases the susp\_lock after determining the
device is idle but before setting the suspended flag, thus leaving a
window where a concurrent write() can submit an urb.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 8cba48efceae500f796be3174ae69034d08257ef
Author: xiao jin
Date: Mon May 26 19:23:14 2014 +0200
USB: usb\_wwan: fix race between write and resume
commit d9e93c08d8d985e5ef89436ebc9f4aad7e31559f upstream.
We find a race between write and resume. usb\_wwan\_resume run play\_delayed()
and spin\_unlock, but intfdata->suspended still is not set to zero.
At this time usb\_wwan\_write is called and anchor the urb to delay
list. Then resume keep running but the delayed urb have no chance
to be commit until next resume. If the time of next resume is far
away, tty will be blocked in tty\_wait\_until\_sent during time. The
race also can lead to writes being reordered.
This patch put play\_Delayed and intfdata->suspended together in the
spinlock, it's to avoid the write race during resume.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 2d08bfbd20880f1e01ddcd6be14cdda64962e337
Author: xiao jin
Date: Mon May 26 19:23:13 2014 +0200
USB: usb\_wwan: fix urb leak in write error path
commit db0904737947d509844e171c9863ecc5b4534005 upstream.
When enable usb serial for modem data, sometimes the tty is blocked
in tty\_wait\_until\_sent because portdata->out\_busy always is set and
have no chance to be cleared.
We find a bug in write error path. usb\_wwan\_write set portdata->out\_busy
firstly, then try autopm async with error. No out urb submit and no
usb\_wwan\_outdat\_callback to this write, portdata->out\_busy can't be
cleared.
This patch clear portdata->out\_busy if usb\_wwan\_write try autopm async
with error.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: xiao jin
Signed-off-by: Zhang, Qi1
Reviewed-by: David Cohen
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit f01bea2e74a6e97ed791b90484c2e67323bda6b5
Author: Mikulas Patocka
Date: Thu May 15 06:58:24 2014 -0400
matroxfb: perform a dummy read of M\_STATUS
commit 972754cfaee94d6e25acf94a497bc0a864d91b7e upstream.
I had occasional screen corruption with the matrox framebuffer driver and
I found out that the reason for the corruption is that the hardware
blitter accesses the videoram while it is being written to.
The matrox driver has a macro WaitTillIdle() that should wait until the
blitter is idle, but it sometimes doesn't work. I added a dummy read
mga\_inl(M\_STATUS) to WaitTillIdle() to fix the problem. The dummy read
will flush the write buffer in the PCI chipset, and the next read of
M\_STATUS will return the hardware status.
Since applying this patch, I had no screen corruption at all.
Signed-off-by: Mikulas Patocka
Signed-off-by: Tomi Valkeinen
Signed-off-by: Jiri Slaby
commit 516bf04cd27425f36c30ac05dbac5f9b7edd5dae
Author: Maurizio Lombardi
Date: Tue May 27 12:48:56 2014 -0400
ext4: fix wrong assert in ext4\_mb\_normalize\_request()
commit b5b60778558cafad17bbcbf63e0310bd3c68eb17 upstream.
The variable "size" is expressed as number of blocks and not as
number of clusters, this could trigger a kernel panic when using
ext4 with the size of a cluster different from the size of a block.
Signed-off-by: Maurizio Lombardi
Signed-off-by: Theodore Ts'o
Signed-off-by: Jiri Slaby
commit 7e78f828d6bb0b356498fae02196c7047529cbfc
Author: Jan Kara
Date: Tue May 27 12:48:55 2014 -0400
ext4: fix zeroing of page during writeback
commit eeece469dedadf3918bad50ad80f4616a0064e90 upstream.
Tail of a page straddling inode size must be zeroed when being written
out due to POSIX requirement that modifications of mmaped page beyond
inode size must not be written to the file. ext4\_bio\_write\_page() did
this only for blocks fully beyond inode size but didn't properly zero
blocks partially beyond inode size. Fix this.
The problem has been uncovered by mmap\_11-4 test in openposix test suite
(part of LTP).
Reported-by: Xiaoguang Wang
Fixes: 5a0dc7365c240
Fixes: bd2d0210cf22f
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Jiri Slaby
commit 76516da417386581ce915d1be649d16be81ca949
Author: Namjae Jeon
Date: Mon May 12 08:12:25 2014 -0400
ext4: fix data integrity sync in ordered mode
commit 1c8349a17137b93f0a83f276c764a6df1b9a116e upstream.
When we perform a data integrity sync we tag all the dirty pages with
PAGECACHE\_TAG\_TOWRITE at start of ext4\_da\_writepages. Later we check
for this tag in write\_cache\_pages\_da and creates a struct
mpage\_da\_data containing contiguously indexed pages tagged with this
tag and sync these pages with a call to mpage\_da\_map\_and\_submit. This
process is done in while loop until all the PAGECACHE\_TAG\_TOWRITE
pages are synced. We also do journal start and stop in each iteration.
journal\_stop could initiate journal commit which would call
ext4\_writepage which in turn will call ext4\_bio\_write\_page even for
delayed OR unwritten buffers. When ext4\_bio\_write\_page is called for
such buffers, even though it does not sync them but it clears the
PAGECACHE\_TAG\_TOWRITE of the corresponding page and hence these pages
are also not synced by the currently running data integrity sync. We
will end up with dirty pages although sync is completed.
This could cause a potential data loss when the sync call is followed
by a truncate\_pagecache call, which is exactly the case in
collapse\_range. (It will cause generic/127 failure in xfstests)
To avoid this issue, we can use set\_page\_writeback\_keepwrite instead of
set\_page\_writeback, which doesn't clear TOWRITE tag.
Signed-off-by: Namjae Jeon
Signed-off-by: Ashish Sangwan
Signed-off-by: "Theodore Ts'o"
Reviewed-by: Jan Kara
Signed-off-by: Jiri Slaby
commit 2375be7812fe1550561502cbbacb4370eaa728ef
Author: Christian Borntraeger
Date: Mon May 26 21:55:08 2014 +0200
s390/lowcore: reserve 96 bytes for IRB in lowcore
commit 993072ee67aa179c48c85eb19869804e68887d86 upstream.
The IRB might be 96 bytes if the extended-I/O-measurement facility is
used. This feature is currently not used by Linux, but struct irb
already has the emw defined. So let's make the irb in lowcore match the
size of the internal data structure to be future proof.
We also have to add a pad, to correctly align the paste.
The bigger irb field also circumvents a bug in some QEMU versions that
always write the emw field on test subchannel and therefore destroy the
paste definitions of this CPU. Running under these QEMU version broke
some timing functions in the VDSO and all users of these functions,
e.g. some JREs.
Signed-off-by: Christian Borntraeger
Signed-off-by: Martin Schwidefsky
Cc: Heiko Carstens
Cc: Sebastian Ott
Cc: Cornelia Huck
Signed-off-by: Jiri Slaby
commit 09b6ffbba999d9640bb32f2ccf46e883f232e833
Author: Lai Jiangshan
Date: Fri Jun 6 14:37:10 2014 -0700
idr: fix overflow bug during maximum ID calculation at maximum height
commit 3afb69cb5572b3c8c898c00880803cf1a49852c4 upstream.
idr\_replace() open-codes the logic to calculate the maximum valid ID
given the height of the idr tree; unfortunately, the open-coded logic
doesn't account for the fact that the top layer may have unused slots
and over-shifts the limit to zero when the tree is at its maximum
height.
The following test code shows it fails to replace the value for
id=((1<<27)+42):
static void test5(void)
{
int id;
DEFINE\_IDR(test\_idr);
#define TEST5\_START ((1<<27)+42) /\* use the highest layer \*/
printk(KERN\_INFO "Start test5\n");
id = idr\_alloc(&test\_idr, (void \*)1, TEST5\_START, 0, GFP\_KERNEL);
BUG\_ON(id != TEST5\_START);
TEST\_BUG\_ON(idr\_replace(&test\_idr, (void \*)2, TEST5\_START) != (void \*)1);
idr\_destroy(&test\_idr);
printk(KERN\_INFO "End of test5\n");
}
Fix the bug by using idr\_max() which correctly takes into account the
maximum allowed shift.
sub\_alloc() shares the same problem and may incorrectly fail with
-EAGAIN; however, this bug doesn't affect correct operation because
idr\_get\_empty\_slot(), which already uses idr\_max(), retries with the
increased @id in such cases.
[tj@kernel.org: Updated patch description.]
Signed-off-by: Lai Jiangshan
Acked-by: Tejun Heo
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 177ee132eb7a7209e188c5d77584eedea840a01a
Author: Will Deacon
Date: Mon Jun 2 11:47:23 2014 +0100
arm64: ptrace: change fs when passing kernel pointer to regset code
commit c168870704bcde6bb63d05f7882b620dd3985a46 upstream.
Our compat PTRACE\_POKEUSR implementation simply passes the user data to
regset\_copy\_from\_user after some simple range checking. Unfortunately,
the data in question has already been copied to the kernel stack by this
point, so the subsequent access\_ok check fails and the ptrace request
returns -EFAULT. This causes problems tracing fork() with older versions
of strace.
This patch briefly changes the fs to KERNEL\_DS, so that the access\_ok
check passes even with a kernel address.
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Jiri Slaby
commit 7b41b2642dd8f6118049e2e287339cad607cb95b
Author: Matthew Dempsky
Date: Fri Jun 6 14:36:42 2014 -0700
ptrace: fix fork event messages across pid namespaces
commit 4e52365f279564cef0ddd41db5237f0471381093 upstream.
When tracing a process in another pid namespace, it's important for fork
event messages to contain the child's pid as seen from the tracer's pid
namespace, not the parent's. Otherwise, the tracer won't be able to
correlate the fork event with later SIGTRAP signals it receives from the
child.
We still risk a race condition if a ptracer from a different pid
namespace attaches after we compute the pid\_t value. However, sending a
bogus fork event message in this unlikely scenario is still a vast
improvement over the status quo where we always send bogus fork event
messages to debuggers in a different pid namespace than the forking
process.
Signed-off-by: Matthew Dempsky
Acked-by: Oleg Nesterov
Cc: Kees Cook
Cc: Julien Tinnes
Cc: Roland McGrath
Cc: Jan Kratochvil
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit c25f8a8b54b96485e621d743f2f360d326aef9cf
Author: Johannes Weiner
Date: Fri Jun 6 14:35:35 2014 -0700
mm: vmscan: clear kswapd's special reclaim powers before exiting
commit 71abdc15adf8c702a1dd535f8e30df50758848d2 upstream.
When kswapd exits, it can end up taking locks that were previously held
by allocating tasks while they waited for reclaim. Lockdep currently
warns about this:
On Wed, May 28, 2014 at 06:06:34PM +0800, Gu Zheng wrote:
> inconsistent {RECLAIM\_FS-ON-W} -> {IN-RECLAIM\_FS-R} usage.
> kswapd2/1151 [HC0[0]:SC0[0]:HE1:SE1] takes:
> (&sig->group\_rwsem){+++++?}, at: exit\_signals+0x24/0x130
> {RECLAIM\_FS-ON-W} state was registered at:
> mark\_held\_locks+0xb9/0x140
> lockdep\_trace\_alloc+0x7a/0xe0
> kmem\_cache\_alloc\_trace+0x37/0x240
> flex\_array\_alloc+0x99/0x1a0
> cgroup\_attach\_task+0x63/0x430
> attach\_task\_by\_pid+0x210/0x280
> cgroup\_procs\_write+0x16/0x20
> cgroup\_file\_write+0x120/0x2c0
> vfs\_write+0xc0/0x1f0
> SyS\_write+0x4c/0xa0
> tracesys+0xdd/0xe2
> irq event stamp: 49
> hardirqs last enabled at (49): \_raw\_spin\_unlock\_irqrestore+0x36/0x70
> hardirqs last disabled at (48): \_raw\_spin\_lock\_irqsave+0x2b/0xa0
> softirqs last enabled at (0): copy\_process.part.24+0x627/0x15f0
> softirqs last disabled at (0): (null)
>
> other info that might help us debug this:
> Possible unsafe locking scenario:
>
> CPU0
> ----
> lock(&sig->group\_rwsem);
>
> lock(&sig->group\_rwsem);
>
> \*\*\* DEADLOCK \*\*\*
>
> no locks held by kswapd2/1151.
>
> stack backtrace:
> CPU: 30 PID: 1151 Comm: kswapd2 Not tainted 3.10.39+ #4
> Call Trace:
> dump\_stack+0x19/0x1b
> print\_usage\_bug+0x1f7/0x208
> mark\_lock+0x21d/0x2a0
> \_\_lock\_acquire+0x52a/0xb60
> lock\_acquire+0xa2/0x140
> down\_read+0x51/0xa0
> exit\_signals+0x24/0x130
> do\_exit+0xb5/0xa50
> kthread+0xdb/0x100
> ret\_from\_fork+0x7c/0xb0
This is because the kswapd thread is still marked as a reclaimer at the
time of exit. But because it is exiting, nobody is actually waiting on
it to make reclaim progress anymore, and it's nothing but a regular
thread at this point. Be tidy and strip it of all its powers
(PF\_MEMALLOC, PF\_SWAPWRITE, PF\_KSWAPD, and the lockdep reclaim state)
before returning from the thread function.
Signed-off-by: Johannes Weiner
Reported-by: Gu Zheng
Cc: Yasuaki Ishimatsu
Cc: Tang Chen
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit ebbc3be9379379d54253786aac627a492de3c7f7
Author: Kees Cook
Date: Thu Apr 17 13:22:09 2014 -0700
HID: core: fix validation of report id 0
commit 1b15d2e5b8077670b1e6a33250a0d9577efff4a5 upstream.
Some drivers use the first HID report in the list instead of using an
index. In these cases, validation uses ID 0, which was supposed to mean
"first known report". This fixes the problem, which was causing at least
the lgff family of devices to stop working since hid\_validate\_values
was being called with ID 0, but the devices used single numbered IDs
for their reports:
0x05, 0x01, /\* Usage Page (Desktop), \*/
0x09, 0x05, /\* Usage (Gamepad), \*/
0xA1, 0x01, /\* Collection (Application), \*/
0xA1, 0x02, /\* Collection (Logical), \*/
0x85, 0x01, /\* Report ID (1), \*/
...
Reported-by: Simon Wood
Signed-off-by: Kees Cook
Reviewed-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Jiri Slaby
commit 6e74114b58ad6f474bb591547ab7d766488251a2
Author: Hugh Dickins
Date: Wed Jun 4 16:05:33 2014 -0700
mm: fix sleeping function warning from \_\_put\_anon\_vma
commit 7f39dda9d86fb4f4f17af0de170decf125726f8c upstream.
Trinity reports BUG:
sleeping function called from invalid context at kernel/locking/rwsem.c:47
in\_atomic(): 0, irqs\_disabled(): 0, pid: 5787, name: trinity-c27
\_\_might\_sleep < down\_write < \_\_put\_anon\_vma < page\_get\_anon\_vma <
migrate\_pages < compact\_zone < compact\_zone\_order < try\_to\_compact\_pages ..
Right, since conversion to mutex then rwsem, we should not put\_anon\_vma()
from inside an rcu\_read\_lock()ed section: fix the two places that did so.
And add might\_sleep() to anon\_vma\_free(), as suggested by Peter Zijlstra.
Fixes: 88c22088bf23 ("mm: optimize page\_lock\_anon\_vma() fast-path")
Reported-by: Dave Jones
Signed-off-by: Hugh Dickins
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 79035696ef6d567b6431e446cdaa01b7951f76b2
Author: Naoya Horiguchi
Date: Wed Jun 4 16:11:02 2014 -0700
mm/memory-failure.c: support use of a dedicated thread to handle SIGBUS(BUS\_MCEERR\_AO)
commit 3ba08129e38437561df44c36b7ea9081185d5333 upstream.
Currently memory error handler handles action optional errors in the
deferred manner by default. And if a recovery aware application wants
to handle it immediately, it can do it by setting PF\_MCE\_EARLY flag.
However, such signal can be sent only to the main thread, so it's
problematic if the application wants to have a dedicated thread to
handler such signals.
So this patch adds dedicated thread support to memory error handler. We
have PF\_MCE\_EARLY flags for each thread separately, so with this patch
AO signal is sent to the thread with PF\_MCE\_EARLY flag set, not the main
thread. If you want to implement a dedicated thread, you call prctl()
to set PF\_MCE\_EARLY on the thread.
Memory error handler collects processes to be killed, so this patch lets
it check PF\_MCE\_EARLY flag on each thread in the collecting routines.
No behavioral change for all non-early kill cases.
Tony said:
: The old behavior was crazy - someone with a multithreaded process might
: well expect that if they call prctl(PF\_MCE\_EARLY) in just one thread, then
: that thread would see the SIGBUS with si\_code = BUS\_MCEERR\_A0 - even if
: that thread wasn't the main thread for the process.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Naoya Horiguchi
Reviewed-by: Tony Luck
Cc: Kamil Iskra
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit dc06ecd40ab0c87219cbda2ea8e0574442c7fd22
Author: Tony Luck
Date: Wed Jun 4 16:11:01 2014 -0700
mm/memory-failure.c: don't let collect\_procs() skip over processes for MF\_ACTION\_REQUIRED
commit 74614de17db6fb472370c426d4f934d8d616edf2 upstream.
When Linux sees an "action optional" machine check (where h/w has reported
an error that is not in the current execution path) we generally do not
want to signal a process, since most processes do not have a SIGBUS
handler - we'd just prematurely terminate the process for a problem that
they might never actually see.
task\_early\_kill() decides whether to consider a process - and it checks
whether this specific process has been marked for early signals with
"prctl", or if the system administrator has requested early signals for
all processes using /proc/sys/vm/memory\_failure\_early\_kill.
But for MF\_ACTION\_REQUIRED case we must not defer. The error is in the
execution path of the current thread so we must send the SIGBUS
immediatley.
Fix by passing a flag argument through collect\_procs\*() to
task\_early\_kill() so it knows whether we can defer or must take action.
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit da0cf80ab3b471bc1135b28974b0c232b65e7c81
Author: Tony Luck
Date: Wed Jun 4 16:10:59 2014 -0700
mm/memory-failure.c-failure: send right signal code to correct thread
commit a70ffcac741d31a406c1d2b832ae43d658e7e1cf upstream.
When a thread in a multi-threaded application hits a machine check because
of an uncorrectable error in memory - we want to send the SIGBUS with
si.si\_code = BUS\_MCEERR\_AR to that thread. Currently we fail to do that
if the active thread is not the primary thread in the process.
collect\_procs() just finds primary threads and this test:
if ((flags & MF\_ACTION\_REQUIRED) && t == current) {
will see that the thread we found isn't the current thread and so send a
si.si\_code = BUS\_MCEERR\_AO to the primary (and nothing to the active
thread at this time).
We can fix this by checking whether "current" shares the same mm with the
process that collect\_procs() said owned the page. If so, we send the
SIGBUS to current (with code BUS\_MCEERR\_AR).
Signed-off-by: Tony Luck
Signed-off-by: Naoya Horiguchi
Reported-by: Otto Bruggeman
Cc: Andi Kleen
Cc: Borislav Petkov
Cc: Chen Gong
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 4d6dd826592bc985202d47307f5a0560412f8613
Author: Mel Gorman
Date: Wed Jun 4 16:10:16 2014 -0700
mm: page\_alloc: use word-based accesses for get/set pageblock bitmaps
commit e58469bafd0524e848c3733bc3918d854595e20f upstream.
The test\_bit operations in get/set pageblock flags are expensive. This
patch reads the bitmap on a word basis and use shifts and masks to isolate
the bits of interest. Similarly masks are used to set a local copy of the
bitmap and then use cmpxchg to update the bitmap if there have been no
other changes made in parallel.
In a test running dd onto tmpfs the overhead of the pageblock-related
functions went from 1.27% in profiles to 0.5%.
In addition to the performance benefits, this patch closes races that are
possible between:
a) get\_ and set\_pageblock\_migratetype(), where get\_pageblock\_migratetype()
reads part of the bits before and other part of the bits after
set\_pageblock\_migratetype() has updated them.
b) set\_pageblock\_migratetype() and set\_pageblock\_skip(), where the non-atomic
read-modify-update set bit operation in set\_pageblock\_skip() will cause
lost updates to some bits changed in the set\_pageblock\_migratetype().
Joonsoo Kim first reported the case a) via code inspection. Vlastimil
Babka's testing with a debug patch showed that either a) or b) occurs
roughly once per mmtests' stress-highalloc benchmark (although not
necessarily in the same pageblock). Furthermore during development of
unrelated compaction patches, it was observed that frequent calls to
{start,undo}\_isolate\_page\_range() the race occurs several thousands of
times and has resulted in NULL pointer dereferences in move\_freepages()
and free\_one\_page() in places where free\_list[migratetype] is
manipulated by e.g. list\_move(). Further debugging confirmed that
migratetype had invalid value of 6, causing out of bounds access to the
free\_list array.
That confirmed that the race exist, although it may be extremely rare,
and currently only fatal where page isolation is performed due to
memory hot remove. Races on pageblocks being updated by
set\_pageblock\_migratetype(), where both old and new migratetype are
lower MIGRATE\_RESERVE, currently cannot result in an invalid value
being observed, although theoretically they may still lead to
unexpected creation or destruction of MIGRATE\_RESERVE pageblocks.
Furthermore, things could get suddenly worse when memory isolation is
used more, or when new migratetypes are added.
After this patch, the race has no longer been observed in testing.
Signed-off-by: Mel Gorman
Acked-by: Vlastimil Babka
Reported-by: Joonsoo Kim
Reported-and-tested-by: Vlastimil Babka
Cc: Johannes Weiner
Cc: Jan Kara
Cc: Michal Hocko
Cc: Hugh Dickins
Cc: Dave Hansen
Cc: Theodore Ts'o
Cc: "Paul E. McKenney"
Cc: Oleg Nesterov
Cc: Rik van Riel
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit c4c34dd67a3588a00713407f797468c02454ca5b
Author: Mel Gorman
Date: Wed Jun 4 16:07:35 2014 -0700
mm: vmscan: do not throttle based on pfmemalloc reserves if node has no ZONE\_NORMAL
commit 675becce15f320337499bc1a9356260409a5ba29 upstream.
throttle\_direct\_reclaim() is meant to trigger during swap-over-network
during which the min watermark is treated as a pfmemalloc reserve. It
throttes on the first node in the zonelist but this is flawed.
The user-visible impact is that a process running on CPU whose local
memory node has no ZONE\_NORMAL will stall for prolonged periods of time,
possibly indefintely. This is due to throttle\_direct\_reclaim thinking the
pfmemalloc reserves are depleted when in fact they don't exist on that
node.
On a NUMA machine running a 32-bit kernel (I know) allocation requests
from CPUs on node 1 would detect no pfmemalloc reserves and the process
gets throttled. This patch adjusts throttling of direct reclaim to
throttle based on the first node in the zonelist that has a usable
ZONE\_NORMAL or lower zone.
[akpm@linux-foundation.org: coding-style fixes]
Signed-off-by: Mel Gorman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 79e24e2ea96ce5e7c3aa2865d7ff0887f6f53daf
Author: Naoya Horiguchi
Date: Wed Jun 4 16:05:35 2014 -0700
hugetlb: restrict hugepage\_migration\_support() to x86\_64
commit c177c81e09e517bbf75b67762cdab1b83aba6976 upstream.
Currently hugepage migration is available for all archs which support
pmd-level hugepage, but testing is done only for x86\_64 and there're
bugs for other archs. So to avoid breaking such archs, this patch
limits the availability strictly to x86\_64 until developers of other
archs get interested in enabling this feature.
Simply disabling hugepage migration on non-x86\_64 archs is not enough to
fix the reported problem where sys\_move\_pages() hits the BUG\_ON() in
follow\_page(FOLL\_GET), so let's fix this by checking if hugepage
migration is supported in vma\_migratable().
Signed-off-by: Naoya Horiguchi
Reported-by: Michael Ellerman
Tested-by: Michael Ellerman
Acked-by: Hugh Dickins
Cc: Benjamin Herrenschmidt
Cc: Tony Luck
Cc: Russell King
Cc: Martin Schwidefsky
Cc: James Hogan
Cc: Ralf Baechle
Cc: David Miller
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit c676dde148d99a11da12cc054374e166aaa65e52
Author: Johan Hovold
Date: Mon May 26 19:23:10 2014 +0200
USB: option: fix runtime PM handling
commit acf47d4f9c39b1cba467aa9442fc2efe0b1da741 upstream.
Fix potential I/O while runtime suspended due to missing PM operations
in send\_setup.
Fixes: 383cedc3bb43 ("USB: serial: full autosuspend support for the
option driver")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 42103716d97b290a445046e7407849c5ae8da66c
Author: Alan Stern
Date: Tue Jun 3 11:00:27 2014 -0400
USB: EHCI: avoid BIOS handover on the HASEE E200
commit b0a50e92bda3c4aeb8017d4e6c6e92146ebd5c9b upstream.
Leandro Liptak reports that his HASEE E200 computer hangs when we ask
the BIOS to hand over control of the EHCI host controller. This
definitely sounds like a bug in the BIOS, but at the moment there is
no way to fix it.
This patch works around the problem by avoiding the handoff whenever
the motherboard and BIOS version match those of Leandro's computer.
Signed-off-by: Alan Stern
Reported-by: Leandro Liptak
Tested-by: Leandro Liptak
Signed-off-by: Jiri Slaby
commit 01a0cb5e65b43abf92ba92a1fbeebe0769265c91
Author: Paul Bolle
Date: Fri May 16 12:00:57 2014 +0200
ARM: OMAP: replace checks for CONFIG\_USB\_GADGET\_OMAP
commit 77c2f02edbeda9409a7cf3fd66233015820c213a upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
apparently required that checks for CONFIG\_USB\_GADGET\_OMAP would be
replaced with checks for CONFIG\_USB\_OMAP. Do so now for the remaining
checks for CONFIG\_USB\_GADGET\_OMAP, even though these checks have
basically been broken since v3.1.
And, since we're touching this code, use the IS\_ENABLED() macro, so
things will now (hopefully) also work if USB\_OMAP is modular.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Tony Lindgren
Signed-off-by: Jiri Slaby
commit f32574c5f44b492f13adb821d174e73d16b01432
Author: Felipe Balbi
Date: Wed Apr 16 10:30:33 2014 -0500
usb: dwc3: gadget: clear stall when disabling endpoint
commit 687ef9817df7ed960d14575b9033dde3d04631fe upstream.
so it seems like DWC3 IP doesn't clear stalls
automatically when we disable an endpoint, because
of that, we \_must\_ make sure stalls are cleared
before clearing the proper bit in DALEPENA register.
Reported-by: Johannes Stezenbach
Signed-off-by: Felipe Balbi
Signed-off-by: Jiri Slaby
commit 4f63298bf686f8357176aedd2a8fd913b81ebe70
Author: Paul Bolle
Date: Mon May 26 23:37:09 2014 +0200
usb: gadget: rename CONFIG\_USB\_GADGET\_PXA25X
commit d30f2065d6da377cc76771aca5a9850cfca8723b upstream.
Commit 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
basically renamed the Kconfig symbol USB\_GADGET\_PXA25X to USB\_PXA25X. It
did not rename the related macros in use at that time. Commit
c0a39151a405 ("ARM: pxa: fix inconsistent CONFIG\_USB\_PXA27X") did so for
all but one macro. Rename that last macro too now.
Fixes: 193ab2a60700 ("usb: gadget: allow multiple gadgets to be built")
Signed-off-by: Paul Bolle
Signed-off-by: Jiri Slaby
commit c0c1bcdd4ae9d9ca0adfdeeee719f6cacb8320fc
Author: Alan Stern
Date: Tue Jun 3 11:11:34 2014 -0400
USB: usbtest: add a timeout for scatter-gather tests
commit 32b36eeae6a859670d2939a7d6136cb5e9ed64f8 upstream.
In usbtest, tests 5 - 8 use the scatter-gather library in usbcore
without any sort of timeout. If there's a problem in the gadget or
host controller being tested, the test can hang.
This patch adds a 10-second timeout to the tests, so that they will
fail gracefully with an ETIMEDOUT error instead of hanging.
Signed-off-by: Alan Stern
Reported-by: Huang Rui
Tested-by: Huang Rui
Signed-off-by: Jiri Slaby
commit cdd3452f62b54413bd4d68e44bac2bfa81adaa12
Author: Huang Rui
Date: Mon May 26 10:55:36 2014 +0800
usb: usbtest: fix unlink write error with pattern 1
commit e4d58f5dcb7d7be45df8def31881ebfae99c75da upstream.
TEST 12 and TEST 24 unlinks the URB write request for N times. When
host and gadget both initialize pattern 1 (mod 63) data series to
transfer, the gadget side will complain the wrong data which is not
expected. Because in host side, usbtest doesn't fill the data buffer
as mod 63 and this patch fixed it.
[20285.488974] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.489181] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.489423] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb50800 length 512 last
[20285.489727] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.490055] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.490281] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.490492] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Active
[20285.490713] dwc3 dwc3.0.auto: ep1out-bulk: endpoint busy
[20285.490909] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Complete
[20285.491117] dwc3 dwc3.0.auto: request ffff8800aa6cb480 from ep1out-bulk completed 512/512 ===> 0
[20285.491431] zero gadget: bad OUT byte, buf[1] = 0
[20285.491605] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Set Stall' params 00000000 00000000 00000000
[20285.491915] dwc3 dwc3.0.auto: Command Complete --> 0
[20285.492099] dwc3 dwc3.0.auto: queing request ffff8800aa6cb480 to ep1out-bulk length 512
[20285.492387] dwc3 dwc3.0.auto: ep1out-bulk: Transfer Not Ready
[20285.492595] dwc3 dwc3.0.auto: ep1out-bulk: reason Transfer Not Active
[20285.492830] dwc3 dwc3.0.auto: ep1out-bulk: req ffff8800aa6cb480 dma aeb51000 length 512 last
[20285.493135] dwc3 dwc3.0.auto: ep1out-bulk: cmd 'Start Transfer' params 00000000 a9eaf000 00000000
[20285.493465] dwc3 dwc3.0.auto: Command Complete --> 0
Signed-off-by: Huang Rui
Signed-off-by: Jiri Slaby
commit 5289d91feb0e3ffd287979abb7e5b7e02a14f752
Author: Dan Carpenter
Date: Fri May 9 14:59:16 2014 +0300
applicom: dereferencing NULL on error path
commit 8bab797c6e5724a43b7666ad70860712365cdb71 upstream.
This is a static checker fix. The "dev" variable is always NULL after
the while statement so we would be dereferencing a NULL pointer here.
Fixes: 819a3eba4233 ('[PATCH] applicom: fix error handling')
Signed-off-by: Dan Carpenter
Signed-off-by: Jiri Slaby
commit 6493b82225f7b2a92ef8b8386687ba8e78cd7407
Author: Dan Carpenter
Date: Mon Apr 7 09:31:21 2014 +0300
Staging: rtl8188eu: overflow in update\_sta\_support\_rate()
commit 9dbd79aeb9842144d9a114a979a12c0949ee11eb upstream.
The ->SupportedRates[] array has NDIS\_802\_11\_LENGTH\_RATES\_EX (16)
elements. Since "ie\_len" comes from then network and can go up to 255
then it means we should add a range check to prevent memory corruption.
Fixes: d6846af679e0 ('staging: r8188eu: Add files for new driver - part 7')
Signed-off-by: Dan Carpenter
Signed-off-by: Jiri Slaby
commit 352fb7edefaedab8045465fa8c8bfa69f7c0c273
Author: Paul Bolle
Date: Mon May 26 21:47:11 2014 +0200
staging: tidspbridge: check for CONFIG\_SND\_OMAP\_SOC\_MCBSP
commit d3921a03a89acb1b9ca599590c0131c89f8737d8 upstream.
Commit d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
removed the Kconfig symbol OMAP\_MCBSP. It left two checks for
CONFIG\_OMAP\_MCBSP untouched.
Convert these to checks for CONFIG\_SND\_OMAP\_SOC\_MCBSP. That must be
correct, since that re-enables calls to functions that are all found in
sound/soc/omap/mcbsp.c. And that file is built only if
CONFIG\_SND\_OMAP\_SOC\_MCBSP is defined.
Fixes: d0f47ff17f29 ("ASoC: OMAP: Build config cleanup for McBSP")
Signed-off-by: Paul Bolle
Signed-off-by: Jiri Slaby
commit 797dd869d16bfc1b258ab041192d0883a1747377
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:12 2014 +0200
extcon: max77693: Fix two NULL pointer exceptions on missing pdata
commit d5653f2b7304f05eeb45d84f123cf02f840b8537 upstream.
Fix NULL pointer exceptions when platform data is not supplied.
Trace of one exception:
Unable to handle kernel NULL pointer dereference at virtual address 00000008
pgd = c0004000
[00000008] \*pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
Modules linked in:
CPU: 2 PID: 1 Comm: swapper/0 Not tainted 3.14.0-12045-gead5dd4687a6-dirty #1628
task: eea80000 ti: eea88000 task.ti: eea88000
PC is at max77693\_muic\_probe+0x27c/0x528
LR is at regmap\_write+0x50/0x60
pc : [] lr : [] psr: 20000113
sp : eea89e38 ip : 00000000 fp : c098a834
r10: ee1a5a10 r9 : 00000005 r8 : c098a83c
r7 : 0000000a r6 : c098a774 r5 : 00000005 r4 : eeb006d0
r3 : c0697bd8 r2 : 00000000 r1 : 00000001 r0 : 00000000
Flags: nzCv IRQs on FIQs on Mode SVC\_32 ISA ARM Segment kernel
Control: 10c5387d Table: 4000404a DAC: 00000015
Process swapper/0 (pid: 1, stack limit = 0xeea88240)
Stack: (0xeea89e38 to 0xeea8a000)
9e20: c08499fc eeb006d0
9e40: 00000000 00000000 c0915f98 00000001 00000000 ee1a5a10 c098a730 c09a88b8
9e60: 00000000 c098a730 c0915f98 00000000 00000000 c02d6aa0 c02d6a88 ee1a5a10
9e80: c0a712c8 c02d54e4 00001204 c0628b00 ee1a5a10 c098a730 ee1a5a44 00000000
9ea0: eea88000 c02d57b4 00000000 c098a730 c02d5728 c02d3a24 ee813e5c eeb9d534
9ec0: c098a730 ee22f700 c097c720 c02d4b14 c08174ec c098a730 00000006 c098a730
9ee0: 00000006 c092fd30 c09b8500 c02d5df8 00000000 c093cbb8 00000006 c0008928
9f00: 000000c3 ef7fc785 00000000 ef7fc794 00000000 c08af968 00000072 eea89f30
9f20: ef7fc85e c065f198 000000c3 c003e87c 00000003 00000000 c092fd3c 00000000
9f40: c08af618 c0826d58 00000006 00000006 c0956f58 c093cbb8 00000006 c092fd30
9f60: c09b8500 000000c3 c092fd3c c08e8510 00000000 c08e8bb0 00000006 00000006
9f80: c08e8510 c0c0c0c0 00000000 c0628fac 00000000 00000000 00000000 00000000
9fa0: 00000000 c0628fb4 00000000 c000f038 00000000 00000000 00000000 00000000
9fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9fe0: 00000000 00000000 00000000 00000000 00000013 00000000 c0c0c0c0 c0c0c0c0
[] (max77693\_muic\_probe) from [] (platform\_drv\_probe+0x18/0x48)
[] (platform\_drv\_probe) from [] (driver\_probe\_device+0x140/0x384)
[] (driver\_probe\_device) from [] (\_\_driver\_attach+0x8c/0x90)
[] (\_\_driver\_attach) from [] (bus\_for\_each\_dev+0x54/0x88)
[] (bus\_for\_each\_dev) from [] (bus\_add\_driver+0xe8/0x204)
[] (bus\_add\_driver) from [] (driver\_register+0x78/0xf4)
[] (driver\_register) from [] (do\_one\_initcall+0xc4/0x174)
[] (do\_one\_initcall) from [] (kernel\_init\_freeable+0xfc/0x1c8)
[] (kernel\_init\_freeable) from [] (kernel\_init+0x8/0xec)
[] (kernel\_init) from [] (ret\_from\_fork+0x14/0x3c)
Code: caffffe7 e59d200c e3550001 b3a05001 (e5923008)
---[ end trace 85db969ce011bde7 ]---
Signed-off-by: Krzysztof Kozlowski
Fixes: 190d7cfc8632
Signed-off-by: Chanwoo Choi
Signed-off-by: Jiri Slaby
commit 7f75e8ac57444fa79191fbd108b82b383143e4ad
Author: Krzysztof Kozlowski
Date: Wed Apr 9 15:20:14 2014 +0200
extcon: max8997: Fix NULL pointer exception on missing pdata
commit dfee4111febf3d9ef3a640b2cd6205c75f4e7e3d upstream.
Fix NULL pointer exception when platform data is not supplied. The
driver dereferenced pdata pointer where it could be NULL.
Signed-off-by: Krzysztof Kozlowski
Fixes: 810d601f07c
Signed-off-by: Chanwoo Choi
Signed-off-by: Jiri Slaby
commit 1485b05f2a2ff688d94e5e0196133c020efa861e
Author: Johan Hovold
Date: Thu May 8 10:09:23 2014 +0200
net: cpsw: fix null dereference at probe
commit 6954cc1f238199e971ec905c5cc87120806ac981 upstream.
Fix null-pointer dereference at probe when the mdio platform device is
missing (e.g. when it has been disabled in DT).
Signed-off-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Jiri Slaby
commit 4c9b5ae9bc67a79ec13a9ea29a0e020cd6cd0855
Author: Ursula Braun
Date: Tue May 13 14:38:02 2014 +0200
af\_iucv: wrong mapping of sent and confirmed skbs
commit f5738e2ef88070ef1372e6e718124d88e9abe4ac upstream.
When sending data through IUCV a MESSAGE COMPLETE interrupt
signals that sent data memory can be freed or reused again.
With commit f9c41a62bba3f3f7ef3541b2a025e3371bcbba97
"af\_iucv: fix recvmsg by replacing skb\_pull() function" the
MESSAGE COMPLETE callback iucv\_callback\_txdone() identifies
the wrong skb as being confirmed, which leads to data corruption.
This patch fixes the skb mapping logic in iucv\_callback\_txdone().
Signed-off-by: Ursula Braun
Signed-off-by: Frank Blaschka
Signed-off-by: David S. Miller
Signed-off-by: Jiri Slaby
commit e98ee26dfbe339f4ee37add68e47ed6fa0603fd9
Author: Stephane Grosjean
Date: Tue May 20 11:38:56 2014 +0200
can: peak\_pci: prevent use after free at netdev removal
commit 0b5a958cf4df3a5cd578b861471e62138f55c85e upstream.
As remarked by Christopher R. Baker in his post at
http://marc.info/?l=linux-can&m=139707295706465&w=2
there's a possibility for an use after free condition at device removal.
This simplified patch introduces an additional variable to prevent the issue.
Thanks for catching this.
Reported-by: Christopher R. Baker
Signed-off-by: Stephane Grosjean
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Jiri Slaby
commit 22e7597be4cf5a51a710d63f62852afea8f2a5ff
Author: Roger Quadros
Date: Wed Dec 18 15:40:10 2013 +0530
usb: usbtest: Add timetout to simple\_io()
commit e5e4746510d140261918aecce2e5e3aa4456f7e9 upstream.
Without a timetout some tests e.g. test\_halt() can remain stuck forever.
Signed-off-by: Roger Quadros
Reviewed-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit 9fc3a1a2fb2f0db62c8f02cc625d3ba492b72b0a
Author: Aleksander Morgado
Date: Thu May 29 13:33:27 2014 +0200
usb: qcserial: add additional Sierra Wireless QMI devices
commit 0ce5fb58564fd85aa8fd2d24209900e2e845317b upstream.
A set of new VID/PIDs retrieved from the out-of-tree GobiNet/GobiSerial
Sierra Wireless drivers.
Signed-off-by: Aleksander Morgado
Link: http://marc.info/?l=linux-usb&m=140136310027293&w=2
Cc:  # backport in link above
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit 8ab45fc8b33aa4a54a6e4b3515b07343f7f5849f
Author: Aleksander Morgado
Date: Wed May 28 21:13:51 2014 +0200
usb: qcserial: add Netgear AirCard 341U
commit ff1fcd50bc2459744e6f948310bc18eb7d6e8c72 upstream.
Signed-off-by: Aleksander Morgado
Cc: stable
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit 040709a3059dcd5d89d5e9dc4c488ccf15c1aad7
Author: Bjørn Mork
Date: Sun Apr 27 16:47:45 2014 +0200
usb: qcserial: define and use Sierra Wireless layout
commit 8bc7a069402e1a443ded8088a8be0dc8aa1c2c9b upstream.
All the "non Gobi" Qualcomm based devices handled by this
driver share a common standard Sierra Wireless specific
layout. Adding code specifically for this layout allow
us to reduce the number of match entries per device from
three to one.
This change will result in a penalty wrt stable backports,
but simplifies new Sierra device addtitions in the long
term.
Signed-off-by: Bjørn Mork
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit 6c81d4764aa48f9105480e52296239716c7e8176
Author: Bjørn Mork
Date: Sun Apr 27 16:47:44 2014 +0200
usb: qcserial: refactor device layout selection
commit d712ca91db6d5463ca5a9b06eb6ba937c59a15fa upstream.
Preparing for more supported standard device layouts. Keeping
the matching macros unchanged to avoid breaking stable
backporting of new device additions.
Signed-off-by: Bjørn Mork
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit 6a026de6b5871c5c9c79175c4861d3075c9057d3
Author: Bjørn Mork
Date: Sun Apr 27 16:47:43 2014 +0200
usb: qcserial: fix multiline comment coding style
commit ce1b066136a30079c4e6e81e015ad9bc2180d46f upstream.
Use a consistent style for all multiline comments.
Signed-off-by: Bjørn Mork
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit bb65c27f3caff9ecf118fb3b365a5a5f927a9897
Author: Tomas Winkler
Date: Mon Jun 30 11:43:50 2014 +0300
mei: me: fix hw ready reset flow
commit b04ada92ffaabb868497a1fce8e4f6bf74e5488f upstream
We cleared H\_RST for H\_CSR on spurious interrupt generated when ME\_RDY
while cleared and not while ME\_RDY is set. The spurious interrupt
is not delivered on all platforms in this case the
driver may fail to initialize.
Cc: stable@vger.kernel.org #3.12
Signed-off-by: Tomas Winkler
Signed-off-by: Alexander Usyskin
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit cd9c8ea182f89f0f5ef3e5591a1ff28cbd6e877b
Author: Tomas Winkler
Date: Mon Jun 30 11:43:49 2014 +0300
mei: me: read H\_CSR after asserting reset
commit c40765d919d25d2d44d99c4ce39e48808f137e1e upstream.
According the spec the host should read H\_CSR again
after asserting reset H\_RST to ensure that reset was
read by the firmware
Cc: stable@vger.kernel.org #3.12
Signed-off-by: Tomas Winkler
Signed-off-by: Alexander Usyskin
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit d5e54437bcb1d82210b7fd810d933c27d1d1fe4e
Author: Quentin Casasnovas
Date: Tue Mar 18 17:16:52 2014 +0100
drm/radeon: memory leak on bo reservation failure. v2
commit 74073c9dd29905645feb6dee03c144657a9844cd upstream.
On bo reservation failure, we end up leaking fpriv.
v2 (chk): rebased and added missing free on vm failure as well
Fixes: 5e386b574cf7e1 ("drm/radeon: fix missing bo reservation")
Cc: stable@vger.kernel.org
Cc: Christian König
Cc: Alex Deucher
Signed-off-by: Quentin Casasnovas
Signed-off-by: Christian König
Signed-off-by: Jiri Slaby
Conflicts:
drivers/gpu/drm/radeon/radeon\_kms.c
commit c0994abad32816af80e7a32b37e1f2868d77a584
Author: Tom Gundersen
Date: Mon Feb 3 11:14:13 2014 +1030
module: allow multiple calls to MODULE\_DEVICE\_TABLE() per module
commit 21bdd17b21b45ea48e06e23918d681afbe0622e9 upstream.
Commit 78551277e4df5: "Input: i8042 - add PNP modaliases" had a bug, where the
second call to MODULE\_DEVICE\_TABLE() overrode the first resulting in not all
the modaliases being exposed.
This fixes the problem by including the name of the device\_id table in the
\_\_mod\_\*\_device\_table alias, allowing us to export several device\_id tables
per module.
Suggested-by: Kay Sievers
Acked-by: Greg Kroah-Hartman
Cc: Dmitry Torokhov
Signed-off-by: Tom Gundersen
Signed-off-by: Rusty Russell
Signed-off-by: Jiri Slaby
Conflicts:
include/linux/module.h
commit e93482952c7fb004c81224da37bca5a9089d85b2
Author: Aaron Lu
Date: Fri Nov 15 14:39:12 2013 +0800
ACPI / video: clean up DMI table for initial black screen problem
commit 545ef368e08fda654b6e63ce522c66339aa29156 upstream.
With commit 2c62333a408f "ACPI / video: Quirk initial backlight level 0"
we do not need to have the following systems in DMI table, so remove them.
HP Pavilion m4, HP 1000 Notebook PC, HP Pavilion g6 Notebook PC,
HP Pavilion dm4, Fujitsu E753, HP Folio 13-2000.
With this change, the use\_bios\_initial\_backlight module parameter is no
longer needed and thus removed.
Signed-off-by: Aaron Lu
Tested-by: Alex Hung  # for HP 1000 Notebook PC
Tested-by: Gustavo Maciel Dias Vieira  # for HP Pavilion dm4
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Jiri Slaby
Conflicts:
drivers/acpi/video.c
commit a6f23e021eee3de3100cd93d065393cfd1e81d98
Author: Anton Blanchard
Date: Tue Mar 25 10:47:01 2014 +1100
KVM: PPC: Book3S HV: Fix KVM hang with CONFIG\_KVM\_XICS=n
commit 7505258c5fcb0a1cc3c76a47b4cf9506d21d10e6 upstream.
I noticed KVM is broken when KVM in-kernel XICS emulation
(CONFIG\_KVM\_XICS) is disabled.
The problem was introduced in 48eaef05 (KVM: PPC: Book3S HV: use
xics\_wake\_cpu only when defined). It used CONFIG\_KVM\_XICS to wrap
xics\_wake\_cpu, where CONFIG\_PPC\_ICP\_NATIVE should have been
used.
Signed-off-by: Anton Blanchard
Cc: stable@vger.kernel.org
Signed-off-by: Paul Mackerras
Acked-by: Scott Wood
Signed-off-by: Jiri Slaby
commit f5e6162ab0f52373a61fd5376b1ca292815c5f9c
Author: Anssi Hannula
Date: Sun Nov 10 21:24:04 2013 +0200
ALSA: hda - hdmi: Use TFx channel positions instead of FxH
commit 94908a39ce971f25c3695c334d88eec4d2837428 upstream.
Channel map positions FLH, FCH, FRH duplicate positions TFL, TFC, TFR.
Both are the speakers above the front speakers (CEA uses "high" and USB
audio uses "top" nomenclature).
Since the USB audio code has used the TFx positions since v3.8
(04324ccc75f96, "ALSA: usb-audio: add channel map support") but the HDMI
code only just started using FxH in a5b7d510b2220cccb ("ALSA: hda -
hdmi: Fix channel maps with less common speakers") which is not yet in
any released kernel, standardize on TFx instead.
Signed-off-by: Anssi Hannula
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit 7ee7663da07717a1b31ce60d2ebf12d2058ee975
Author: Lars-Peter Clausen
Date: Wed Jun 18 13:32:35 2014 +0200
ALSA: control: Make sure that id->index does not overflow
commit 883a1d49f0d77d30012f114b2e19fc141beb3e8e upstream.
The ALSA control code expects that the range of assigned indices to a control is
continuous and does not overflow. Currently there are no checks to enforce this.
If a control with a overflowing index range is created that control becomes
effectively inaccessible and unremovable since snd\_ctl\_find\_id() will not be
able to find it. This patch adds a check that makes sure that controls with a
overflowing index range can not be created.
Signed-off-by: Lars-Peter Clausen
Acked-by: Jaroslav Kysela
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit 669982364299f6f22bea4324f0f7ee8f8a361b87
Author: Lars-Peter Clausen
Date: Wed Jun 18 13:32:34 2014 +0200
ALSA: control: Handle numid overflow
commit ac902c112d90a89e59916f751c2745f4dbdbb4bd upstream.
Each control gets automatically assigned its numids when the control is created.
The allocation is done by incrementing the numid by the amount of allocated
numids per allocation. This means that excessive creation and destruction of
controls (e.g. via SNDRV\_CTL\_IOCTL\_ELEM\_ADD/REMOVE) can cause the id to
eventually overflow. Currently when this happens for the control that caused the
overflow kctl->id.numid + kctl->count will also over flow causing it to be
smaller than kctl->id.numid. Most of the code assumes that this is something
that can not happen, so we need to make sure that it won't happen
Signed-off-by: Lars-Peter Clausen
Acked-by: Jaroslav Kysela
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit 0bf595fd311aa4d6e82c43879f2c0d0650e83271
Author: Lars-Peter Clausen
Date: Wed Jun 18 13:32:33 2014 +0200
ALSA: control: Don't access controls outside of protected regions
commit fd9f26e4eca5d08a27d12c0933fceef76ed9663d upstream.
A control that is visible on the card->controls list can be freed at any time.
This means we must not access any of its memory while not holding the
controls\_rw\_lock. Otherwise we risk a use after free access.
Signed-off-by: Lars-Peter Clausen
Acked-by: Jaroslav Kysela
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit d8eaff7517ee11b2e7cbc158abbdf899b8351ed3
Author: Lars-Peter Clausen
Date: Wed Jun 18 13:32:32 2014 +0200
ALSA: control: Fix replacing user controls
commit 82262a46627bebb0febcc26664746c25cef08563 upstream.
There are two issues with the current implementation for replacing user
controls. The first is that the code does not check if the control is actually a
user control and neither does it check if the control is owned by the process
that tries to remove it. That allows userspace applications to remove arbitrary
controls, which can cause a user after free if a for example a driver does not
expect a control to be removed from under its feed.
The second issue is that on one hand when a control is replaced the
user\_ctl\_count limit is not checked and on the other hand the user\_ctl\_count is
increased (even though the number of user controls does not change). This allows
userspace, once the user\_ctl\_count limit as been reached, to repeatedly replace
a control until user\_ctl\_count overflows. Once that happens new controls can be
added effectively bypassing the user\_ctl\_count limit.
Both issues can be fixed by instead of open-coding the removal of the control
that is to be replaced to use snd\_ctl\_remove\_user\_ctl(). This function does
proper permission checks as well as decrements user\_ctl\_count after the control
has been removed.
Note that by using snd\_ctl\_remove\_user\_ctl() the check which returns -EBUSY at
beginning of the function if the control already exists is removed. This is not
a problem though since the check is quite useless, because the lock that is
protecting the control list is released between the check and before adding the
new control to the list, which means that it is possible that a different
control with the same settings is added to the list after the check. Luckily
there is another check that is done while holding the lock in snd\_ctl\_add(), so
we'll rely on that to make sure that the same control is not added twice.
Signed-off-by: Lars-Peter Clausen
Acked-by: Jaroslav Kysela
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit ed81e6b21790b717cda5f5bab2bdb07d2ce17ab1
Author: Lars-Peter Clausen
Date: Wed Jun 18 13:32:31 2014 +0200
ALSA: control: Protect user controls against concurrent access
commit 07f4d9d74a04aa7c72c5dae0ef97565f28f17b92 upstream.
The user-control put and get handlers as well as the tlv do not protect against
concurrent access from multiple threads. Since the state of the control is not
updated atomically it is possible that either two write operations or a write
and a read operation race against each other. Both can lead to arbitrary memory
disclosure. This patch introduces a new lock that protects user-controls from
concurrent access. Since applications typically access controls sequentially
than in parallel a single lock per card should be fine.
Signed-off-by: Lars-Peter Clausen
Acked-by: Jaroslav Kysela
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit e30265fbd72b4cacb6c02a2b00dabe86efd37dda
Author: David Henningsson
Date: Fri Jun 13 11:15:44 2014 +0200
ALSA: hda - Add quirk for external mic on Lifebook U904
commit 2041d56464a067461d7cc21734a0f024587ed2ff upstream.
According to the bug reporter (Данило Шеган), the external mic
starts to work and has proper jack detection if only pin 0x19
is marked properly as an external headset mic.
AlsaInfo at https://bugs.launchpad.net/ubuntu/+source/pulseaudio/+bug/1328587/+attachment/4128991/+files/AlsaInfo.txt
BugLink: https://bugs.launchpad.net/bugs/1328587
Signed-off-by: David Henningsson
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit 0842fb624afa1672f73e8fd7f502debb5ad83b8f
Author: Kailang Yang
Date: Thu Jun 5 11:13:44 2014 +0800
ALSA: hda/realtek - Add support of ALC891 codec
commit b6c5fbad16aa5026f508093a8d651c25e1cb6179 upstream.
New codec support for ALC891.
Signed-off-by: Kailang Yang
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit f4f1bdfbf813db958373ea85439730cec1ce7afd
Author: Wang, Xiaoming
Date: Thu Jun 12 18:47:07 2014 -0400
ALSA: compress: Cancel the optimization of compiler and fix the size of struct for all platform.
commit 2bd0ae464a6cf7363bbf72c8545e0aa43caa57f0 upstream.
Cancel the optimization of compiler for struct snd\_compr\_avail
which size will be 0x1c in 32bit kernel while 0x20 in 64bit
kernel under the optimizer. That will make compaction between
32bit and 64bit. So add packed to fix the size of struct
snd\_compr\_avail to 0x1c for all platform.
Signed-off-by: Zhang Dongxing
Signed-off-by: xiaoming wang
Acked-by: Vinod Koul
Signed-off-by: Takashi Iwai
Signed-off-by: Jiri Slaby
commit f1bac1ba17822414d4031f840913b4ea27793ba8
Author: Greg Kroah-Hartman
Date: Fri Jun 20 22:01:41 2014 -0700
lz4: ensure length does not wrap
commit 206204a1162b995e2185275167b22468c00d6b36 upstream.
Given some pathologically compressed data, lz4 could possibly decide to
wrap a few internal variables, causing unknown things to happen. Catch
this before the wrapping happens and abort the decompression.
Reported-by: "Don A. Bailey"
Signed-off-by: Jiri Slaby
commit 83722ba4bdfa951767cb47ee8aad5fd44350066f
Author: Greg Kroah-Hartman
Date: Fri Jun 20 22:00:53 2014 -0700
lzo: properly check for overruns
commit 206a81c18401c0cde6e579164f752c4b147324ce upstream.
The lzo decompressor can, if given some really crazy data, possibly
overrun some variable types. Modify the checking logic to properly
detect overruns before they happen.
Reported-by: "Don A. Bailey"
Tested-by: "Don A. Bailey"
Signed-off-by: Jiri Slaby
commit 2618b9baad38201a3e5e3d1b9c5263e0fef1a59e
Author: Peter Meerwald
Date: Tue May 6 09:53:00 2014 +0100
iio: Fix endianness issue in ak8975\_read\_axis()
commit 8ba42fb7b17649c9ab5b5e79d4e90370a0b4645e upstream.
i2c\_smbus\_read\_word\_data() does host endian conversion already,
no need for le16\_to\_cpu()
Signed-off-by: Peter Meerwald
Signed-off-by: Jonathan Cameron
Signed-off-by: Jiri Slaby
commit f65aa47d01d229191f79e6c5df56b359386aaf8a
Author: Dan Carpenter
Date: Thu Nov 6 09:13:00 2014 +0000
iio: adc: at91: signedness bug in at91\_adc\_get\_trigger\_value\_by\_name()
commit 4f3bcd878f1d3c730fe00f619b7260c6125d49eb upstream.
at91\_adc\_get\_trigger\_value\_by\_name() was returning -ENOMEM truncated to
a positive u8 and that doesn't work. I've changed it to int and
refactored it to preserve the error code.
Signed-off-by: Dan Carpenter
Acked-by: Alexandre Belloni
Tested-by: Alexandre Belloni
Signed-off-by: Jonathan Cameron
Signed-off-by: Jiri Slaby
commit 7ea3386ddad0272c94f0bbb6d21c86aa3d2ecb60
Author: Mario Schuknecht
Date: Tue May 27 07:19:00 2014 +0100
staging: iio: tsl2x7x\_core: fix proximity treshold
commit c404618cd06dad771495fe1cf9d5a63b5664f65f upstream.
Consider high byte of proximity min and max treshold in function
'tsl2x7x\_chip\_on'. So far, the high byte was not set.
Signed-off-by: Mario Schuknecht
Signed-off-by: Jonathan Cameron
Signed-off-by: Jiri Slaby
commit ed550318f08dd793259f2e6574a22788eb47b130
Author: Peter Ujfalusi
Date: Fri May 30 16:47:41 2014 +0300
ASoC: tlv320aci3x: Fix custom snd\_soc\_dapm\_put\_volsw\_aic3x() function
commit e6c111fac4464e3f4bf7b3802b517dafc80f8e0f upstream.
For some unknown reason the parameters for snd\_soc\_test\_bits() were in wrong
order:
It was:
snd\_soc\_test\_bits(codec, val, mask, reg); /\* WRONG!!! \*/
while it should be:
snd\_soc\_test\_bits(codec, reg, mask, val);
Signed-off-by: Peter Ujfalusi
Signed-off-by: Mark Brown
Signed-off-by: Jiri Slaby
commit 0fa09d2e27889cda6b952ac03a681d8b5b24a53e
Author: Liam Girdwood
Date: Fri May 16 16:55:20 2014 +0300
ASoC: max98090: Fix reset at resume time
commit 25b4ab430f8e166c9b63f4db28e7e812d5a59396 upstream.
Reset needs to wait 20ms before other codec IO is performed. This wait
was not being performed. Fix this by making sure the reset register is not
restored with the cache, but use the manual reset method in resume with
the wait.
Signed-off-by: Liam Girdwood
Signed-off-by: Jarkko Nikula
Signed-off-by: Mark Brown
Signed-off-by: Jiri Slaby
commit 347b9fed12a93b917f18437c5749929e42049c3a
Author: K. Y. Srinivasan
Date: Wed Apr 23 13:53:39 2014 -0700
Drivers: hv: balloon: Ensure pressure reports are posted regularly
commit ae339336dc950b9b05e7ccd3565dd3e8781c06d9 upstream.
The current code posts periodic memory pressure status from a dedicated thread.
Under some conditions, especially when we are releasing a lot of memory into
the guest, we may not send timely pressure reports back to the host. Fix this
issue by reporting pressure in all contexts that can be active in this driver.
Signed-off-by: K. Y. Srinivasan
Signed-off-by: Jiri Slaby
commit 26c05be0c07c54c685cf8a25aceba4426646c8a5
Author: Johan Hovold
Date: Mon May 26 19:23:45 2014 +0200
USB: cdc-acm: fix runtime PM imbalance at shutdown
commit 5292afa657d0e790b7479ad8eef9450c1e040b3d upstream.
Make sure only to decrement the PM counters if they were actually
incremented.
Note that the USB PM counter, but not necessarily the driver core PM
counter, is reset when the interface is unbound.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit ffc415d3245ad096b318ba521f91c0fb3c724b1a
Author: Johan Hovold
Date: Mon May 26 19:23:44 2014 +0200
USB: cdc-acm: fix I/O after failed open
commit e4c36076c2a6195ec62c35b03c3fde84d0087dc8 upstream.
Make sure to kill any already submitted read urbs on read-urb submission
failures in open in order to prevent doing I/O for a closed port.
Fixes: 088c64f81284 ("USB: cdc-acm: re-write read processing")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 5d62cbeb37df5c67a8b5d42d30aa060eba6a2302
Author: Johan Hovold
Date: Mon May 26 19:23:41 2014 +0200
USB: cdc-acm: fix potential urb leak and PM imbalance in write
commit 183a45087d126d126e8dd1d9b2602fc129dff9ad upstream.
Make sure to check return value of autopm get in write() in order to
avoid urb leak and PM counter imbalance on errors.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 4ed88943c847357d10658a29c9ff2244a48df7a6
Author: Johan Hovold
Date: Mon May 26 19:23:40 2014 +0200
USB: cdc-acm: fix shutdown and suspend race
commit ed797074031a37bb9bf4a70952fffc606b77274d upstream.
We should stop I/O unconditionally at suspend rather than rely on the
tty-port initialised flag (which is set prior to stopping I/O during
shutdown) in order to prevent suspend returning with URBs still active.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 4d9aa622d7149e6dcc5d8d07f67d754b598a0931
Author: Johan Hovold
Date: Mon May 26 19:23:39 2014 +0200
USB: cdc-acm: fix runtime PM for control messages
commit bae3f4c53585e9a170da9436e0f06919874bda9a upstream.
Fix runtime PM handling of control messages by adding the required PM
counter operations.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 870306cfccf0b0034b23cc6aa188c821f85d0354
Author: Johan Hovold
Date: Mon May 26 19:23:38 2014 +0200
USB: cdc-acm: fix broken runtime suspend
commit 140cb81ac8c625942a1d695875932c615767a526 upstream.
The current ACM runtime-suspend implementation is broken in several
ways:
Firstly, it buffers only the first write request being made while
suspended -- any further writes are silently dropped.
Secondly, writes being dropped also leak write urbs, which are never
reclaimed (until the device is unbound).
Thirdly, even the single buffered write is not cleared at shutdown
(which may happen before the device is resumed), something which can
lead to another urb leak as well as a PM usage-counter leak.
Fix this by implementing a delayed-write queue using urb anchors and
making sure to discard the queue properly at shutdown.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Reported-by: Xiao Jin
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 529ce0fc0bae6fa9520f348d2d5bbc94bf1b2dec
Author: Johan Hovold
Date: Mon May 26 19:23:37 2014 +0200
USB: cdc-acm: fix write and resume race
commit e144ed28bed10684f9aaec6325ed974d53f76110 upstream.
Fix race between write() and resume() due to improper locking that could
lead to writes being reordered.
Resume must be done atomically and susp\_count be protected by the
write\_lock in order to prevent racing with write(). This could otherwise
lead to writes being reordered if write() grabs the write\_lock after
susp\_count is decremented, but before the delayed urb is submitted.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 06c2f546fe195c3a0178a2ec4f5c0ebf2167a97c
Author: Johan Hovold
Date: Mon May 26 19:23:36 2014 +0200
USB: cdc-acm: fix write and suspend race
commit 5a345c20c17d87099224a4be12e69e5bd7023dca upstream.
Fix race between write() and suspend() which could lead to writes being
dropped (or I/O while suspended) if the device is runtime suspended
while a write request is being processed.
Specifically, suspend() releases the write\_lock after determining the
device is idle but before incrementing the susp\_count, thus leaving a
window where a concurrent write() can submit an urb.
Fixes: 11ea859d64b6 ("USB: additional power savings for cdc-acm devices
that support remote wakeup")
Signed-off-by: Johan Hovold
Signed-off-by: Jiri Slaby
commit 263be4bc1c278389b4bcdccd4e192983bb275f13
Author: James Hogan
Date: Thu May 29 10:16:23 2014 +0100
MIPS: KVM: Allocate at least 16KB for exception handlers
commit 7006e2dfda9adfa40251093604db76d7e44263b3 upstream.
Each MIPS KVM guest has its own copy of the KVM exception vector. This
contains the TLB refill exception handler at offset 0x000, the general
exception handler at offset 0x180, and interrupt exception handlers at
offset 0x200 in case Cause\_IV=1. A common handler is copied to offset
0x2000 and offset 0x3000 is used for temporarily storing k1 during entry
from guest.
However the amount of memory allocated for this purpose is calculated as
0x200 rounded up to the next page boundary, which is insufficient if 4KB
pages are in use. This can lead to the common handler at offset 0x2000
being overwritten and infinitely recursive exceptions on the next exit
from the guest.
Increase the minimum size from 0x200 to 0x4000 to cover the full use of
the page.
Signed-off-by: James Hogan
Cc: Paolo Bonzini
Cc: Gleb Natapov
Cc: kvm@vger.kernel.org
Cc: Ralf Baechle
Cc: linux-mips@linux-mips.org
Cc: Sanjay Lal
Signed-off-by: Paolo Bonzini
Signed-off-by: Jiri Slaby
commit 331f2b02e8148e4a1263ca988363b5ea31875d18
Author: Paolo Bonzini
Date: Wed May 14 17:40:58 2014 +0200
KVM: lapic: sync highest ISR to hardware apic on EOI
commit fc57ac2c9ca8109ea97fcc594f4be436944230cc upstream.
When Hyper-V enlightenments are in effect, Windows prefers to issue an
Hyper-V MSR write to issue an EOI rather than an x2apic MSR write.
The Hyper-V MSR write is not handled by the processor, and besides
being slower, this also causes bugs with APIC virtualization. The
reason is that on EOI the processor will modify the highest in-service
interrupt (SVI) field of the VMCS, as explained in section 29.1.4 of
the SDM; every other step in EOI virtualization is already done by
apic\_send\_eoi or on VM entry, but this one is missing.
We need to do the same, and be careful not to muck with the isr\_count
and highest\_isr\_cache fields that are unused when virtual interrupt
delivery is enabled.
Reviewed-by: Yang Zhang
Signed-off-by: Paolo Bonzini
Signed-off-by: Jiri Slaby
commit 7228e303b34f8ee8c7dec2c5f7c0988d3ff9aee0
Author: Guenter Roeck
Date: Sun Sep 8 00:25:36 2013 -0700
mfd: sm501: dbg\_regs attribute must be read-only
commit 8a8320c2e78d1b619a8fa8eb5ae946b8691de604 upstream.
Fix:
sm501 sm501: SM501 At b3e00000: Version 050100a0, 8 Mb, IRQ 100
Attribute dbg\_regs: write permission without 'store'
------------[ cut here ]------------
WARNING: at drivers/base/core.c:620
dbg\_regs does not have a write function and must therefore be marked
as read-only.
Signed-off-by: Guenter Roeck
Signed-off-by: Lee Jones
Signed-off-by: Jiri Slaby
commit 1c55a373b6325b5daa7734e45f5b142e45405b77
Author: Benjamin LaHaise
Date: Tue Jun 24 13:12:55 2014 -0400
aio: fix aio request leak when events are reaped by userspace
commit f8567a3845ac05bb28f3c1b478ef752762bd39ef upstream.
The aio cleanups and optimizations by kmo that were merged into the 3.10
tree added a regression for userspace event reaping. Specifically, the
reference counts are not decremented if the event is reaped in userspace,
leading to the application being unable to submit further aio requests.
This patch applies to 3.12+. A separate backport is required for 3.10/3.11.
This issue was uncovered as part of CVE-2014-0206.
Signed-off-by: Benjamin LaHaise
Cc: stable@vger.kernel.org
Cc: Kent Overstreet
Cc: Mateusz Guzik
Cc: Petr Matousek
Signed-off-by: Jiri Slaby
commit bee3f7b8188d4b2a5dfaeb2eb4a68d99f67daecf
Author: Benjamin LaHaise
Date: Tue Jun 24 13:32:51 2014 -0400
aio: fix kernel memory disclosure in io\_getevents() introduced in v3.10
commit edfbbf388f293d70bf4b7c0bc38774d05e6f711a upstream.
A kernel memory disclosure was introduced in aio\_read\_events\_ring() in v3.10
by commit a31ad380bed817aa25f8830ad23e1a0480fef797. The changes made to
aio\_read\_events\_ring() failed to correctly limit the index into
ctx->ring\_pages[], allowing an attacked to cause the subsequent kmap() of
an arbitrary page with a copy\_to\_user() to copy the contents into userspace.
This vulnerability has been assigned CVE-2014-0206. Thanks to Mateusz and
Petr for disclosing this issue.
This patch applies to v3.12+. A separate backport is needed for 3.10/3.11.
Signed-off-by: Benjamin LaHaise
Cc: Mateusz Guzik
Cc: Petr Matousek
Cc: Kent Overstreet
Cc: Jeff Moyer
Cc: stable@vger.kernel.org
Signed-off-by: Jiri Slaby
commit be31bc4b3764fb9c9ca99c7cf650d762f3c51a74
Author: James Hogan
Date: Tue Dec 10 22:28:04 2013 +0000
serial: 8250\_dw: Fix LCR workaround regression
commit 6979f8d28049879e6147767d93ba6732c8bd94f4 upstream.
Commit c49436b657d0 (serial: 8250\_dw: Improve unwritable LCR workaround)
caused a regression. It added a check that the LCR was written properly
to detect and workaround the busy quirk, but the behaviour of bit 5
(UART\_LCR\_SPAR) differs between IP versions 3.00a and 3.14c per the
docs. On older versions this caused the check to fail and it would
repeatedly force idle and rewrite the LCR register, causing delays and
preventing any input from serial being received.
This is fixed by masking out UART\_LCR\_SPAR before making the comparison.
Signed-off-by: James Hogan
Cc: Greg Kroah-Hartman
Cc: Jiri Slaby
Cc: Tim Kryger
Cc: Ezequiel Garcia
Cc: Matt Porter
Cc: Markus Mayer
Tested-by: Tim Kryger
Tested-by: Ezequiel Garcia
Tested-by: Heikki Krogerus
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
commit 2401577586898b3590db80f8b97a26f81f0f6d4e
Author: Tim Kryger
Date: Tue Oct 1 10:18:08 2013 -0700
serial: 8250\_dw: Improve unwritable LCR workaround
commit c49436b657d0a56a6ad90d14a7c3041add7cf64d upstream.
When configured with UART\_16550\_COMPATIBLE=NO or in versions prior to
the introduction of this option, the Designware UART will ignore writes
to the LCR if the UART is busy. The current workaround saves a copy of
the last written LCR and re-writes it in the ISR for a special interrupt
that is raised when a write was ignored.
Unfortunately, interrupts are typically disabled prior to performing a
sequence of register writes that include the LCR so the point at which
the retry occurs is too late. An example is serial8250\_do\_set\_termios()
where an ignored LCR write results in the baud divisor not being set and
instead a garbage character is sent out the transmitter.
Furthermore, since serial\_port\_out() offers no way to indicate failure,
a serious effort must be made to ensure that the LCR is actually updated
before returning back to the caller. This is difficult, however, as a
UART that was busy during the first attempt is likely to still be busy
when a subsequent attempt is made unless some extra action is taken.
This updated workaround reads back the LCR after each write to confirm
that the new value was accepted by the hardware. Should the hardware
ignore a write, the TX/RX FIFOs are cleared and the receive buffer read
before attempting to rewrite the LCR out of the hope that doing so will
force the UART into an idle state. While this may seem unnecessarily
aggressive, writes to the LCR are used to change the baud rate, parity,
stop bit, or data length so the data that may be lost is likely not
important. Admittedly, this is far from ideal but it seems to be the
best that can be done given the hardware limitations.
Lastly, the revised workaround doesn't touch the LCR in the ISR, so it
avoids the possibility of a "serial8250: too much work for irq" lock up.
This problem is rare in real situations but can be reproduced easily by
wiring up two UARTs and running the following commands.
# stty -F /dev/ttyS1 echo
# stty -F /dev/ttyS2 echo
# cat /dev/ttyS1 &
[1] 375
# echo asdf > /dev/ttyS1
asdf
[ 27.700000] serial8250: too much work for irq96
[ 27.700000] serial8250: too much work for irq96
[ 27.710000] serial8250: too much work for irq96
[ 27.710000] serial8250: too much work for irq96
[ 27.720000] serial8250: too much work for irq96
[ 27.720000] serial8250: too much work for irq96
[ 27.730000] serial8250: too much work for irq96
[ 27.730000] serial8250: too much work for irq96
[ 27.740000] serial8250: too much work for irq96
Signed-off-by: Tim Kryger
Reviewed-by: Matt Porter
Reviewed-by: Markus Mayer
Reviewed-by: Heikki Krogerus
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Jiri Slaby
Conflicts:
drivers/tty/serial/8250/8250\_dw.c
commit 7032d5fbbf1b08586e1463684d6c8f456889c293
Author: Naoya Horiguchi
Date: Fri Jun 6 10:00:01 2014 -0400
mm: add !pte\_present() check on existing hugetlb\_entry callbacks
commit d4c54919ed86302094c0ca7d48a8cbd4ee753e92 upstream.
The age table walker doesn't check non-present hugetlb entry in common
path, so hugetlb\_entry() callbacks must check it. The reason for this
behavior is that some callers want to handle it in its own way.
[ I think that reason is bogus, btw - it should just do what the regular
code does, which is to call the "pte\_hole()" function for such hugetlb
entries - Linus]
However, some callers don't check it now, which causes unpredictable
result, for example when we have a race between migrating hugepage and
reading /proc/pid/numa\_maps. This patch fixes it by adding !pte\_present
checks on buggy callbacks.
This bug exists for years and got visible by introducing hugepage
migration.
ChangeLog v2:
- fix if condition (check !pte\_present() instead of pte\_present())
Reported-by: Sasha Levin
Signed-off-by: Naoya Horiguchi
Cc: Rik van Riel
Cc:  [3.12+]
Signed-off-by: Andrew Morton
[ Backported to 3.15. Signed-off-by: Josh Boyer  ]
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 5b96c3796cd207060738ffe225fac7b096ceb11f
Author: Jeff Layton
Date: Thu Jun 5 09:45:00 2014 -0400
nfsd: don't halt scanning the DRC LRU list when there's an RC\_INPROG entry
commit 1b19453d1c6abcfa7c312ba6c9f11a277568fc94 upstream.
Currently, the DRC cache pruner will stop scanning the list when it
hits an entry that is RC\_INPROG. It's possible however for a call to
take a \*very\* long time. In that case, we don't want it to block other
entries from being pruned if they are expired or we need to trim the
cache to get back under the limit.
Fix the DRC cache pruner to just ignore RC\_INPROG entries.
Signed-off-by: Jeff Layton
Signed-off-by: J. Bruce Fields
Signed-off-by: Jiri Slaby
commit 04242f7d3df4851b2a4b5fa9c0f5ccfb29a95695
Author: Anatol Pomozov
Date: Tue Apr 15 11:31:33 2014 -0700
aio: block io\_destroy() until all context requests are completed
commit e02ba72aabfade4c9cd6e3263e9b57bf890ad25c upstream.
deletes aio context and all resources related to. It makes sense that
no IO operations connected to the context should be running after the context
is destroyed. As we removed io\_context we have no chance to
get requests status or call io\_getevents().
man page for io\_destroy says that this function may block until
all context's requests are completed. Before kernel 3.11 io\_destroy()
blocked indeed, but since aio refactoring in 3.11 it is not true anymore.
Here is a pseudo-code that shows a testcase for a race condition discovered
in 3.11:
initialize io\_context
io\_submit(read to buffer)
io\_destroy()
// context is destroyed so we can free the resources
free(buffers);
// if the buffer is allocated by some other user he'll be surprised
// to learn that the buffer still filled by an outstanding operation
// from the destroyed io\_context
The fix is straight-forward - add a completion struct and wait on it
in io\_destroy, complete() should be called when number of in-fligh requests
reaches zero.
If two or more io\_destroy() called for the same context simultaneously then
only the first one waits for IO completion, other calls behaviour is undefined.
Tested: ran http://pastebin.com/LrPsQ4RL testcase for several hours and
do not see the race condition anymore.
Signed-off-by: Anatol Pomozov
Signed-off-by: Benjamin LaHaise
Signed-off-by: Jiri Slaby
commit 0c9a0cfbedd847c645dd0bca572169a7385c2117
Author: Jeff Layton
Date: Thu Dec 5 06:00:51 2013 -0500
nfsd: don't try to reuse an expired DRC entry off the list
commit a0ef5e19684f0447da9ff0654a12019c484f57ca upstream.
Currently when we are processing a request, we try to scrape an expired
or over-limit entry off the list in preference to allocating a new one
from the slab.
This is unnecessarily complicated. Just use the slab layer.
Signed-off-by: Jeff Layton
Signed-off-by: J. Bruce Fields
Signed-off-by: Jiri Slaby
commit 9e6f2084969b7a8d7bbf102cf0c1c69dac44af2b
Author: Zhichuang SUN
Date: Wed May 21 14:13:30 2014 +0800
drivers/video/fbdev/fb-puv3.c: Add header files for function unifb\_mmap
commit fbc6c4a13bbfb420eedfdb26a0a859f9c07e8a7b upstream.
Function unifb\_mmap calls functions which are defined in linux/mm.h
and asm/pgtable.h
The related error (for unicore32 with unicore32\_defconfig):
CC drivers/video/fbdev/fb-puv3.o
drivers/video/fbdev/fb-puv3.c: In function 'unifb\_mmap':
drivers/video/fbdev/fb-puv3.c:646: error: implicit declaration of
function 'vm\_iomap\_memory'
drivers/video/fbdev/fb-puv3.c:646: error: implicit declaration of
function 'pgprot\_noncached'
Signed-off-by: Zhichuang Sun
Cc: Jean-Christophe Plagniol-Villard
Cc: Tomi Valkeinen
Cc: Jingoo Han
Cc: Daniel Vetter
Cc: Joe Perches
Cc: Laurent Pinchart
Cc: linux-fbdev@vger.kernel.org
Acked-by: Xuetao Guan
Signed-off-by: Tomi Valkeinen
Signed-off-by: Jiri Slaby
commit 976c2ec40c7fad5d4a0eadbbfb9c04c00dc8d1fc
Author: Chen Gang
Date: Mon Mar 24 20:17:44 2014 +0800
arch/unicore32/mm/alignment.c: include "asm/pgtable.h" to avoid compiling error
commit 1ff38c56cbd095c4c0dfa581a859ba3557830f78 upstream.
Need include "asm/pgtable.h" to include "asm-generic/pgtable-nopmd.h",
so can let 'pmd\_t' defined. The related error with allmodconfig:
CC arch/unicore32/mm/alignment.o
In file included from arch/unicore32/mm/alignment.c:24:
arch/unicore32/include/asm/tlbflush.h:135: error: expected .). before .\*. token
arch/unicore32/include/asm/tlbflush.h:154: error: expected .). before .\*. token
In file included from arch/unicore32/mm/alignment.c:27:
arch/unicore32/mm/mm.h:15: error: expected .=., .,., .;., .sm. or .\_attribute\_\_. before .\*. token
arch/unicore32/mm/mm.h:20: error: expected .=., .,., .;., .sm. or .\_attribute\_\_. before .\*. token
arch/unicore32/mm/mm.h:25: error: expected .=., .,., .;., .sm. or .\_attribute\_\_. before .\*. token
make[1]: \*\*\* [arch/unicore32/mm/alignment.o] Error 1
make: \*\*\* [arch/unicore32/mm] Error 2
Signed-off-by: Chen Gang
Acked-by: Xuetao Guan
Signed-off-by: Xuetao Guan
Signed-off-by: Jiri Slaby
commit fc597a301fb2947af29ce67c12a419c39f044975
Author: Goldwyn Rodrigues
Date: Thu Apr 3 14:46:59 2014 -0700
ocfs2: revert iput deferring code in ocfs2\_drop\_dentry\_lock
commit 8ed6b23709b346f7bfc1edab47003a205a6a9f69 upstream.
The following patches are reverted in this patch because these patches
caused performance regression in the remote unlink() calls.
ea455f8ab683 - ocfs2: Push out dropping of dentry lock to ocfs2\_wq
f7b1aa69be13 - ocfs2: Fix deadlock on umount
5fd131893793 - ocfs2: Don't oops in ocfs2\_kill\_sb on a failed mount
Previous patches in this series removed the possible deadlocks from
downconvert thread so the above patches shouldn't be needed anymore.
The regression is caused because these patches delay the iput() in case
of dentry unlocks. This also delays the unlocking of the open lockres.
The open lockresource is required to test if the inode can be wiped from
disk or not. When the deleting node does not get the open lock, it
marks it as orphan (even though it is not in use by another
node/process) and causes a journal checkpoint. This delays operations
following the inode eviction. This also moves the inode to the orphaned
inode which further causes more I/O and a lot of unneccessary orphans.
The following script can be used to generate the load causing issues:
declare -a create
declare -a remove
declare -a iterations=(1 2 4 8 16 32 64 128 256 512 1024 2048 4096 8192 16384)
unique="`mktemp -u XXXXX`"
script="/tmp/idontknow-${unique}.sh"
cat < "${script}"
for n in {1..8}; do mkdir -p test/dir\${n}
eval touch test/dir\${n}/foo{1.."\$1"}
done
EOF
chmod 700 "${script}"
function fcreate ()
{
exec 2>&1 /usr/bin/time --format=%E "${script}" "$1"
}
function fremove ()
{
exec 2>&1 /usr/bin/time --format=%E ssh node2 "cd `pwd`; rm -Rf test\*"
}
function fcp ()
{
exec 2>&1 /usr/bin/time --format=%E ssh node3 "cd `pwd`; cp -R test test.new"
}
echo -------------------------------------------------
echo "| # files | create #s | copy #s | remove #s |"
echo -------------------------------------------------
for ((x=0; x < ${#iterations[\*]} ; x++)) do
create[$x]="`fcreate ${iterations[$x]}`"
copy[$x]="`fcp ${iterations[$x]}`"
remove[$x]="`fremove`"
printf "| %8d | %9s | %9s | %9s |\n" ${iterations[$x]} ${create[$x]} ${copy[$x]} ${remove[$x]}
done
rm "${script}"
echo "------------------------"
Signed-off-by: Srinivas Eeda
Signed-off-by: Goldwyn Rodrigues
Signed-off-by: Jan Kara
Reviewed-by: Mark Fasheh
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 8f265718385a7aa2d396a5d8ac614cb80ff7d9a1
Author: Jan Kara
Date: Thu Apr 3 14:46:57 2014 -0700
ocfs2: avoid blocking in ocfs2\_mark\_lockres\_freeing() in downconvert thread
commit 84d86f83f9d0e8431a3c9eae4c47e9d7ff49a411 upstream.
If we are dropping last inode reference from downconvert thread, we will
end up calling ocfs2\_mark\_lockres\_freeing() which can block if the lock
we are freeing is queued thus creating an A-A deadlock. Luckily, since
we are the downconvert thread, we can immediately dequeue the lock and
thus avoid waiting in this case.
Signed-off-by: Jan Kara
Reviewed-by: Mark Fasheh
Reviewed-by: Srinivas Eeda
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit cac99bee6f388bfd0aebd2f07d941326a0b4dd0e
Author: Jan Kara
Date: Thu Apr 3 14:46:56 2014 -0700
ocfs2: implement delayed dropping of last dquot reference
commit e3a767b60fd8a9f5e133f42f4970cff77ec43173 upstream.
We cannot drop last dquot reference from downconvert thread as that
creates the following deadlock:
NODE 1 NODE2
holds dentry lock for 'foo'
holds inode lock for GLOBAL\_BITMAP\_SYSTEM\_INODE
dquot\_initialize(bar)
ocfs2\_dquot\_acquire()
ocfs2\_inode\_lock(USER\_QUOTA\_SYSTEM\_INODE)
...
downconvert thread (triggered from another
node or a different process from NODE2)
ocfs2\_dentry\_post\_unlock()
...
iput(foo)
ocfs2\_evict\_inode(foo)
ocfs2\_clear\_inode(foo)
dquot\_drop(inode)
...
ocfs2\_dquot\_release()
ocfs2\_inode\_lock(USER\_QUOTA\_SYSTEM\_INODE)
- blocks
finds we need more space in
quota file
...
ocfs2\_extend\_no\_holes()
ocfs2\_inode\_lock(GLOBAL\_BITMAP\_SYSTEM\_INODE)
- deadlocks waiting for
downconvert thread
We solve the problem by postponing dropping of the last dquot reference to
a workqueue if it happens from the downconvert thread.
Signed-off-by: Jan Kara
Reviewed-by: Mark Fasheh
Reviewed-by: Srinivas Eeda
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit b5258061a2a8f657aa5900dd3c1ded9e868e3544
Author: Jan Kara
Date: Thu Apr 3 14:46:55 2014 -0700
quota: provide function to grab quota structure reference
commit 9f985cb6c45bc3f8b7e161c9658d409d051d576f upstream.
Provide dqgrab() function to get quota structure reference when we are
sure it already has at least one active reference. Make use of this
function inside quota code.
Signed-off-by: Jan Kara
Reviewed-by: Mark Fasheh
Reviewed-by: Srinivas Eeda
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 2eb0658fb6525f85a6386e1b7cc8bd7066ed1281
Author: Jan Kara
Date: Thu Apr 3 14:46:54 2014 -0700
ocfs2: move dquot\_initialize() in ocfs2\_delete\_inode() somewhat later
commit bd62ad7aebd8e8895bb7649ace948040332f27d3 upstream.
Move dquot\_initalize() call in ocfs2\_delete\_inode() after the moment we
verify inode is actually a sane one to delete. We certainly don't want
to initialize quota for system inodes etc. This also avoids calling
into quota code from downconvert thread.
Add more details into the comment why bailing out from
ocfs2\_delete\_inode() when we are in downconvert thread is OK.
Signed-off-by: Jan Kara
Reviewed-by: Mark Fasheh
Reviewed-by: Srinivas Eeda
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 34b6c0490bfa372876e6907eee779c5cd0e89963
Author: Lidong Zhong
Date: Thu Jun 12 10:26:14 2014 -0500
dlm: keep listening connection alive with sctp mode
commit 883854c5457a97190f7b0ee20f03bcd9664fc0c2 upstream.
The connection struct with nodeid 0 is the listening socket,
not a connection to another node. The sctp resend function
was not checking that the nodeid was valid (non-zero), so it
would mistakenly get and resend on the listening connection
when nodeid was zero.
Signed-off-by: Lidong Zhong
Signed-off-by: David Teigland
Signed-off-by: Jiri Slaby
commit 9bf37c057d11c6a483a787965bb585e9ab5fa6ab
Author: Miao Xie
Date: Wed Sep 25 21:47:45 2013 +0800
Btrfs: fix BUG\_ON() casued by the reserved space migration
commit 20dd2cbf01888a91fdd921403040a710b275a1ff upstream.
When we did space balance and snapshot creation at the same time, we might
meet the following oops:
kernel BUG at fs/btrfs/inode.c:3038!
[SNIP]
Call Trace:
[] btrfs\_orphan\_cleanup+0x293/0x407 [btrfs]
[] btrfs\_mksubvol.isra.28+0x259/0x373 [btrfs]
[] btrfs\_ioctl\_snap\_create\_transid+0x126/0x156 [btrfs]
[] btrfs\_ioctl\_snap\_create\_v2+0xd0/0x121 [btrfs]
[] btrfs\_ioctl+0x414/0x1854 [btrfs]
[] ? \_\_do\_page\_fault+0x305/0x379
[] vfs\_ioctl+0x1d/0x39
[] do\_vfs\_ioctl+0x32d/0x3e2
[] ? finish\_task\_switch+0x80/0xb8
[] SyS\_ioctl+0x57/0x83
[] ? do\_device\_not\_available+0x12/0x14
[] system\_call\_fastpath+0x16/0x1b
[SNIP]
RIP [] btrfs\_orphan\_add+0xc3/0x126 [btrfs]
The reason of the problem is that the relocation root creation stole
the reserved space, which was reserved for orphan item deletion.
There are several ways to fix this problem, one is to increasing
the reserved space size of the space balace, and then we can use
that space to create the relocation tree for each fs/file trees.
But it is hard to calculate the suitable size because we doesn't
know how many fs/file trees we need relocate.
We fixed this problem by reserving the space for relocation root creation
actively since the space it need is very small (one tree block, used for
root node copy), then we use that reserved space to create the
relocation tree. If we don't reserve space for relocation tree creation,
we will use the reserved space of the balance.
Signed-off-by: Miao Xie
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 8b16b61c2c025a54eae37a3c703ed38aa8c8940a
Author: Josef Bacik
Date: Mon Sep 30 11:36:38 2013 -0400
Btrfs: fix two use-after-free bugs with transaction cleanup
commit 724e2315db3d59a8201d4a87c7c7a873e60e1ce0 upstream.
I was noticing the slab redzone stuff going off every once and a while during
transaction aborts. This was caused by two things
1) We would walk the pending snapshots and set their error to -ECANCELED. We
don't need to do this, the snapshot stuff waits for a transaction commit and if
there is a problem we just free our pending snapshot object and exit. Doing
this was causing us to touch the pending snapshot object after the thing had
already been freed.
2) We were freeing the transaction manually with wanton disregard for it's
use\_count reference counter. To fix this I cleaned up the transaction freeing
loop to either wait for the transaction commit to finish if it was in the middle
of that (since it will be cleaned and freed up there) or to do the cleanup
oursevles.
I also moved the global "kill all things dirty everywhere" stuff outside of the
transaction cleanup loop since that only needs to be done once. With this patch
I'm no longer seeing slab corruption because of use after frees. Thanks,
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 445d1c3ae946d89d8978fee5985ad42e05e3dfb4
Author: Josef Bacik
Date: Fri Sep 27 16:36:02 2013 -0400
Btrfs: don't delete ordered roots from list during cleanup
commit 1de2cfde93c20a0357ff1dffed901598470facf3 upstream.
During transaction cleanup after an abort we are just removing roots from the
ordered roots list which is incorrect. We have a BUG\_ON() to make sure that the
root is still part of the ordered roots list when we put our ordered extent
which we were tripping in this case. So do like we do everywhere else and just
move it to the tail of the ordered roots list and allow the normal cleanup to
take care of stuff. Thanks,
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit bd32872f2d74ea81fbb80b362052037b5882d414
Author: Josef Bacik
Date: Fri Sep 27 16:32:39 2013 -0400
Btrfs: cleanup transaction on abort
commit 4e121c06adf53aae478ebce3035116595d063413 upstream.
If we abort not during a transaction commit we won't clean up anything until we
unmount. Unfortunately if we abort in the middle of writing out an ordered
extent we won't clean it up and if somebody is waiting on that ordered extent
they will wait forever. To fix this just make the transaction kthread call the
cleanup transaction stuff if it notices theres an error, and make
btrfs\_end\_transaction wake up the transaction kthread if there is an error.
Thanks,
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 4b6d66d14e0d502e3109659d9ae4a2d87bfd52e3
Author: Josef Bacik
Date: Fri Sep 27 14:57:43 2013 -0400
Btrfs: do not release metadata for space cache inodes
commit b6d08f0630d51ec09d67f16f6d7839699bbc0402 upstream.
I've been testing our error paths and I was tripping the BUG\_ON() in
drop\_outstanding\_extent because our outstanding\_extents is 0 for space cache
inodes. This is because we don't reserve metadata space for these inodes since
we depend on the global block reserve for our space. To fix this we need to
make sure the DO\_ACCOUNTING stuff doesn't actually call release\_metadata for
space cache inodes. With this patch I'm no longer panicing. Thanks,
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit 596075a2050e50aba69d903c59cbdc71ec954a50
Author: Filipe David Borba Manana
Date: Mon Sep 9 19:49:43 2013 +0100
Btrfs: don't leak block group on error
commit e84cc14213e2c81ae5a2da341a9da0d58a1dbfad upstream.
In extent-tree.c:btrfs\_write\_dirty\_block\_groups(), if the call to
write\_one\_cache\_group() failed, we would return without putting
the block group first.
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit a2ea3d786a7e8f8ca08b10795a15178b3ba90b04
Author: Filipe David Borba Manana
Date: Mon Sep 23 11:35:11 2013 +0100
Btrfs: fix sync fs to actually wait for all data to be persisted
commit 9b1998598625fb5b798e8291cafda1a8ec17c1bd upstream.
Currently the fs sync function (super.c:btrfs\_sync\_fs()) doesn't
wait for delayed work to finish before returning success to the
caller. This change fixes this, ensuring that there's no data loss
if a power failure happens right after fs sync returns success to
the caller and before the next commit happens.
Steps to reproduce the data loss issue:
$ mkfs.btrfs -f /dev/sdb3
$ mount /dev/sdb3 /mnt/btrfs
$ perl -e '$d = ("\x41" x 6001); open($f,">","/mnt/btrfs/foobar"); print $f $d; close($f);' && btrfs fi sync /mnt/btrfs
Right after the btrfs fi sync command (a second or 2 for example), power
off the machine and reboot it. The file will be empty, as it can be verified
after mounting the filesystem and through btrfs-debug-tree:
$ btrfs-debug-tree /dev/sdb3 | egrep '\(257 INODE\_ITEM 0\) itemoff' -B 3 -A 8
item 3 key (256 DIR\_INDEX 2) itemoff 3751 itemsize 36
location key (257 INODE\_ITEM 0) type FILE
namelen 6 datalen 0 name: foobar
item 4 key (257 INODE\_ITEM 0) itemoff 3591 itemsize 160
inode generation 7 transid 7 size 0 block group 0 mode 100644 links 1
item 5 key (257 INODE\_REF 256) itemoff 3575 itemsize 16
inode ref index 2 namelen 6 name: foobar
checksum tree key (CSUM\_TREE ROOT\_ITEM 0)
leaf 29429760 items 0 free space 3995 generation 7 owner 7
fs uuid 6192815c-af2a-4b75-b3db-a959ffb6166e
chunk uuid b529c44b-938c-4d3d-910a-013b4700bcae
uuid tree key (UUID\_TREE ROOT\_ITEM 0)
After this patch, the data loss no longer happens after a power failure and
btrfs-debug-tree shows:
$ btrfs-debug-tree /dev/sdb3 | egrep '\(257 INODE\_ITEM 0\) itemoff' -B 3 -A 8
item 3 key (256 DIR\_INDEX 2) itemoff 3751 itemsize 36
location key (257 INODE\_ITEM 0) type FILE
namelen 6 datalen 0 name: foobar
item 4 key (257 INODE\_ITEM 0) itemoff 3591 itemsize 160
inode generation 6 transid 6 size 6001 block group 0 mode 100644 links 1
item 5 key (257 INODE\_REF 256) itemoff 3575 itemsize 16
inode ref index 2 namelen 6 name: foobar
item 6 key (257 EXTENT\_DATA 0) itemoff 3522 itemsize 53
extent data disk byte 12845056 nr 8192
extent data offset 0 nr 8192 ram 8192
extent compression 0
checksum tree key (CSUM\_TREE ROOT\_ITEM 0)
Signed-off-by: Filipe David Borba Manana
Reviewed-by: Miao Xie
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit f19eb84ed2054bf749e702251b40cbbc954b1077
Author: Filipe David Borba Manana
Date: Sun Sep 22 21:54:55 2013 +0100
Btrfs: fix tracking of orphan inode count
commit 703c88e035242202e3ab48fcbbbe0a7bc62fb7bb upstream.
In inode.c:btrfs\_orphan\_add() if we failed to insert the orphan
item, we would return without decrementing the orphan count that
we just incremented before attempting the insertion, leaving the
orphan inode count wrong.
In inode.c:btrfs\_orphan\_del(), we were decrementing the inode
orphan count if the bit BTRFS\_INODE\_ORPHAN\_META\_RESERVED was set,
which is logically wrong because it should be decremented if the
bit BTRFS\_INODE\_HAS\_ORPHAN\_ITEM was set - after all we increment
the count when we set the bit BTRFS\_INODE\_HAS\_ORPHAN\_ITEM elsewhere.
Signed-off-by: Filipe David Borba Manana
Signed-off-by: Josef Bacik
Signed-off-by: Chris Mason
Signed-off-by: Jiri Slaby
commit c82b3dd92c24207c8c0d6b4334a53e1245cc13d6
Author: Steve French
Date: Tue May 13 13:37:45 2014 -0700
Do not send ClientGUID on SMB2.02 dialect
commit 3c5f9be108783c05cade918d29c8711b236acb1d upstream.
ClientGUID must be zero for SMB2.02 dialect. See section 2.2.3
of MS-SMB2. For SMB2.1 and later it must be non-zero.
Signed-off-by: Steve French
CC: Sachin Prabhu
Signed-off-by: Jiri Slaby
commit 8f7e86ca1df5a1766b9566540a62ff2804104bd4
Author: Sachin Prabhu
Date: Tue May 13 00:48:12 2014 +0100
cifs: Set client guid on per connection basis
commit 39552ea8120a699dbd0360848c4d949f9f0e6deb upstream.
When mounting from a Windows 2012R2 server, we hit the following
problem:
1) Mount with any of the following versions - 2.0, 2.1 or 3.0
2) unmount
3) Attempt a mount again using a different SMB version >= 2.0.
You end up with the following failure:
Status code returned 0xc0000203 STATUS\_USER\_SESSION\_DELETED
CIFS VFS: Send error in SessSetup = -5
CIFS VFS: cifs\_mount failed w/return code = -5
I cannot reproduce this issue using a Windows 2008 R2 server.
This appears to be caused because we use the same client guid for the
connection on first mount which we then disconnect and attempt to mount
again using a different protocol version. By generating a new guid each
time a new connection is Negotiated, we avoid hitting this problem.
Signed-off-by: Sachin Prabhu
Signed-off-by: Steve French
Signed-off-by: Jiri Slaby
commit 16e57e5502a55b6a844d4a3de9b5cc2f8e41d3c8
Author: Steve French
Date: Tue Nov 19 23:44:46 2013 -0600
Check SMB3 dialects against downgrade attacks
commit ff1c038addc4f205d5f1ede449426c7d316c0eed upstream.
When we are running SMB3 or SMB3.02 connections which are signed
we need to validate the protocol negotiation information,
to ensure that the negotiate protocol response was not tampered with.
Add the missing FSCTL which is sent at mount time (immediately after
the SMB3 Tree Connect) to validate that the capabilities match
what we think the server sent.
"Secure dialect negotiation is introduced in SMB3 to protect against
man-in-the-middle attempt to downgrade dialect negotiation.
The idea is to prevent an eavesdropper from downgrading the initially
negotiated dialect and capabilities between the client and the server."
For more explanation see 2.2.31.4 of MS-SMB2 or
http://blogs.msdn.com/b/openspecification/archive/2012/06/28/smb3-secure-dialect-negotiation.aspx
Reviewed-by: Pavel Shilovsky
Signed-off-by: Steve French
[ddiss@suse.de: backported atop kernel without clone\_range support]
Signed-off-by: David Disseldorp
Signed-off-by: Jiri Slaby
commit 3f8fd8ad48b66a4fc44f60cde0ea575155a45eff
Author: Michal Kubecek
Date: Tue Jun 3 10:26:06 2014 +0200
xfrm: fix race between netns cleanup and state expire notification
commit 21ee543edc0dea36ab58d24523fcd42b8a270df8 upstream.
The xfrm\_user module registers its pernet init/exit after xfrm
itself so that its net exit function xfrm\_user\_net\_exit() is
executed before xfrm\_net\_exit() which calls xfrm\_state\_fini() to
cleanup the SA's (xfrm states). This opens a window between
zeroing net->xfrm.nlsk pointer and deleting all xfrm\_state
instances which may access it (via the timer). If an xfrm state
expires in this window, xfrm\_exp\_state\_notify() will pass null
pointer as socket to nlmsg\_multicast().
As the notifications are called inside rcu\_read\_lock() block, it
is sufficient to retrieve the nlsk socket with rcu\_dereference()
and check the it for null.
Signed-off-by: Michal Kubecek
Signed-off-by: David S. Miller
Signed-off-by: Jiri Slaby
commit 306ba5b24eab33ed30f13ff2005e021881b3d2bf
Author: Michal Kubeček
Date: Tue May 20 08:29:25 2014 +0200
vlan: more careful checksum features handling
commit da08143b85203b581f4a6461b149186b0e9592df upstream.
When combining real\_dev's features and vlan\_features, simple
bitwise AND is used. This doesn't work well for checksum
offloading features as if one set has NETIF\_F\_HW\_CSUM and the
other NETIF\_F\_IP\_CSUM and/or NETIF\_F\_IPV6\_CSUM, we end up with
no checksum offloading. However, from the logical point of view
(how can\_checksum\_protocol() works), NETIF\_F\_HW\_CSUM contains
the functionality of NETIF\_F\_IP\_CSUM and NETIF\_F\_IPV6\_CSUM so
that the result should be IP/IPV6.
Add helper function netdev\_intersect\_features() implementing
this logic and use it in vlan\_dev\_fix\_features().
Signed-off-by: Michal Kubecek
Signed-off-by: David S. Miller
Signed-off-by: Jiri Slaby
commit e45145b6eb158405fe5cbbcce0a206d3b3090842
Author: Ben Hutchings
Date: Mon Nov 18 17:04:58 2013 +0000
net/compat: Fix minor information leak in siocdevprivate\_ioctl()
commit 417c3522b3202dacce4873cfb0190459fbce95c5 upstream.
We don't need to check that ifr\_data itself is a valid user pointer,
but we should check 𝔦\_data is. Thankfully the copy of ifr\_name is
checked, so this can only leak a few bytes from immediately above the
user address limit.
Signed-off-by: Ben Hutchings
Signed-off-by: Jiri Slaby
commit 9f6e089cb55bdc5a90fe6ec755a20941da9a0b3b
Author: Benjamin Poirier
Date: Tue Jan 7 10:11:10 2014 -0500
net: Do not enable tx-nocache-copy by default
commit cdb3f4a31b64c3a1c6eef40bc01ebc9594c58a8c upstream.
There are many cases where this feature does not improve performance or even
reduces it.
For example, here are the results from tests that I've run using 3.12.6 on one
Intel Xeon W3565 and one i7 920 connected by ixgbe adapters. The results are
from the Xeon, but they're similar on the i7. All numbers report the
mean±stddev over 10 runs of 10s.
1) latency tests similar to what is described in "c6e1a0d net: Allow no-cache
copy from user on transmit"
There is no statistically significant difference between tx-nocache-copy
on/off.
nic irqs spread out (one queue per cpu)
200x netperf -r 1400,1
tx-nocache-copy off
692000±1000 tps
50/90/95/99% latency (us): 275±2/643.8±0.4/799±1/2474.4±0.3
tx-nocache-copy on
693000±1000 tps
50/90/95/99% latency (us): 274±1/644.1±0.7/800±2/2474.5±0.7
200x netperf -r 14000,14000
tx-nocache-copy off
86450±80 tps
50/90/95/99% latency (us): 334.37±0.02/838±1/2100±20/3990±40
tx-nocache-copy on
86110±60 tps
50/90/95/99% latency (us): 334.28±0.01/837±2/2110±20/3990±20
2) single stream throughput tests
tx-nocache-copy leads to higher service demand
throughput cpu0 cpu1 demand
(Gb/s) (Gcycle) (Gcycle) (cycle/B)
nic irqs and netperf on cpu0 (1x netperf -T0,0 -t omni -- -d send)
tx-nocache-copy off 9402±5 9.4±0.2 0.80±0.01
tx-nocache-copy on 9403±3 9.85±0.04 0.838±0.004
nic irqs on cpu0, netperf on cpu1 (1x netperf -T1,1 -t omni -- -d send)
tx-nocache-copy off 9401±5 5.83±0.03 5.0±0.1 0.923±0.007
tx-nocache-copy on 9404±2 5.74±0.03 5.523±0.009 0.958±0.002
As a second example, here are some results from Eric Dumazet with latest
net-next.
tx-nocache-copy also leads to higher service demand
(cpu is Intel(R) Xeon(R) CPU X5660 @ 2.80GHz)
lpq83:~# ./ethtool -K eth0 tx-nocache-copy on
lpq83:~# perf stat ./netperf -H lpq84 -c
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF\_INET to lpq84.prod.google.com () port 0 AF\_INET
Recv Send Send Utilization Service Demand
Socket Socket Message Elapsed Send Recv Send Recv
Size Size Size Time Throughput local remote local remote
bytes bytes bytes secs. 10^6bits/s % S % U us/KB us/KB
87380 16384 16384 10.00 9407.44 2.50 -1.00 0.522 -1.000
Performance counter stats for './netperf -H lpq84 -c':
4282.648396 task-clock # 0.423 CPUs utilized
9,348 context-switches # 0.002 M/sec
88 CPU-migrations # 0.021 K/sec
355 page-faults # 0.083 K/sec
11,812,797,651 cycles # 2.758 GHz [82.79%]
9,020,522,817 stalled-cycles-frontend # 76.36% frontend cycles idle [82.54%]
4,579,889,681 stalled-cycles-backend # 38.77% backend cycles idle [67.33%]
6,053,172,792 instructions # 0.51 insns per cycle
# 1.49 stalled cycles per insn [83.64%]
597,275,583 branches # 139.464 M/sec [83.70%]
8,960,541 branch-misses # 1.50% of all branches [83.65%]
10.128990264 seconds time elapsed
lpq83:~# ./ethtool -K eth0 tx-nocache-copy off
lpq83:~# perf stat ./netperf -H lpq84 -c
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF\_INET to lpq84.prod.google.com () port 0 AF\_INET
Recv Send Send Utilization Service Demand
Socket Socket Message Elapsed Send Recv Send Recv
Size Size Size Time Throughput local remote local remote
bytes bytes bytes secs. 10^6bits/s % S % U us/KB us/KB
87380 16384 16384 10.00 9412.45 2.15 -1.00 0.449 -1.000
Performance counter stats for './netperf -H lpq84 -c':
2847.375441 task-clock # 0.281 CPUs utilized
11,632 context-switches # 0.004 M/sec
49 CPU-migrations # 0.017 K/sec
354 page-faults # 0.124 K/sec
7,646,889,749 cycles # 2.686 GHz [83.34%]
6,115,050,032 stalled-cycles-frontend # 79.97% frontend cycles idle [83.31%]
1,726,460,071 stalled-cycles-backend # 22.58% backend cycles idle [66.55%]
2,079,702,453 instructions # 0.27 insns per cycle
# 2.94 stalled cycles per insn [83.22%]
363,773,213 branches # 127.757 M/sec [83.29%]
4,242,732 branch-misses # 1.17% of all branches [83.51%]
10.128449949 seconds time elapsed
CC: Tom Herbert
Signed-off-by: Benjamin Poirier
Signed-off-by: David S. Miller
Signed-off-by: Jiri Slaby
commit e801ececc95d6df1256d1b7c479456f7dc7dc045
Author: Prarit Bhargava
Date: Tue Jan 14 14:21:13 2014 -0500
ACPI / memhotplug: add parameter to disable memory hotplug
commit 00159a2013269bc0a617de885e4b921349192bd0 upstream.
When booting a kexec/kdump kernel on a system that has specific memory
hotplug regions the boot will fail with warnings like:
swapper/0: page allocation failure: order:9, mode:0x84d0
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 3.10.0-65.el7.x86\_64 #1
Hardware name: QCI QSSC-S4R/QSSC-S4R, BIOS QSSC-S4R.QCI.01.00.S013.032920111005 03/29/2011
0000000000000000 ffff8800341bd8c8 ffffffff815bcc67 ffff8800341bd950
ffffffff8113b1a0 ffff880036339b00 0000000000000009 00000000000084d0
ffff8800341bd950 ffffffff815b87ee 0000000000000000 0000000000000200
Call Trace:
[] dump\_stack+0x19/0x1b
[] warn\_alloc\_failed+0xf0/0x160
[] ? \_\_alloc\_pages\_direct\_compact+0xac/0x196
[] \_\_alloc\_pages\_nodemask+0x7ff/0xa00
[] vmemmap\_alloc\_block+0x62/0xba
[] vmemmap\_alloc\_block\_buf+0x15/0x3b
[] vmemmap\_populate+0xb4/0x21b
[] sparse\_mem\_map\_populate+0x27/0x35
[] sparse\_add\_one\_section+0x7a/0x185
[] \_\_add\_pages+0xaf/0x240
[] arch\_add\_memory+0x59/0xd0
[] add\_memory+0xb9/0x1b0
[] acpi\_memory\_device\_add+0x18d/0x26d
[] acpi\_bus\_device\_attach+0x7d/0xcd
[] acpi\_ns\_walk\_namespace+0xc8/0x17f
[] ? acpi\_bus\_type\_and\_status+0x90/0x90
[] ? acpi\_bus\_type\_and\_status+0x90/0x90
[] acpi\_walk\_namespace+0x95/0xc5
[] acpi\_bus\_scan+0x8b/0x9d
[] acpi\_scan\_init+0x63/0x160
[] acpi\_init+0x25d/0x2a6
[] ? acpi\_sleep\_proc\_init+0x2a/0x2a
[] do\_one\_initcall+0xe2/0x190
[] kernel\_init\_freeable+0x17c/0x207
[] ? do\_early\_param+0x88/0x88
[] ? rest\_init+0x80/0x80
[] kernel\_init+0xe/0x180
[] ret\_from\_fork+0x7c/0xb0
[] ? rest\_init+0x80/0x80
Mem-Info:
Node 0 DMA per-cpu:
CPU 0: hi: 0, btch: 1 usd: 0
Node 0 DMA32 per-cpu:
CPU 0: hi: 42, btch: 7 usd: 0
active\_anon:0 inactive\_anon:0 isolated\_anon:0
active\_file:0 inactive\_file:0 isolated\_file:0
unevictable:0 dirty:0 writeback:0 unstable:0
free:872 slab\_reclaimable:13 slab\_unreclaimable:1880
mapped:0 shmem:0 pagetables:0 bounce:0
free\_cma:0
because the system has run out of memory at boot time. This occurs
because of the following sequence in the boot:
Main kernel boots and sets E820 map. The second kernel is booted with a
map generated by the kdump service using memmap= and memmap=exactmap.
These parameters are added to the kernel parameters of the kexec/kdump
kernel. The kexec/kdump kernel has limited memory resources so as not
to severely impact the main kernel.
The system then panics and the kdump/kexec kernel boots (which is a
completely new kernel boot). During this boot ACPI is initialized and the
kernel (as can be seen above) traverses the ACPI namespace and finds an
entry for a memory device to be hotadded.
ie)
[] \_\_add\_pages+0xaf/0x240
[] arch\_add\_memory+0x59/0xd0
[] add\_memory+0xb9/0x1b0
[] acpi\_memory\_device\_add+0x18d/0x26d
[] acpi\_bus\_device\_attach+0x7d/0xcd
[] acpi\_ns\_walk\_namespace+0xc8/0x17f
[] ? acpi\_bus\_type\_and\_status+0x90/0x90
[] ? acpi\_bus\_type\_and\_status+0x90/0x90
[] acpi\_walk\_namespace+0x95/0xc5
[] acpi\_bus\_scan+0x8b/0x9d
[] acpi\_scan\_init+0x63/0x160
[] acpi\_init+0x25d/0x2a6
At this point the kernel adds page table information and the the kexec/kdump
kernel runs out of memory.
This can also be reproduced by using the memmap=exactmap and mem=X
parameters on the main kernel and booting.
This patchset resolves the problem by adding a kernel parameter,
acpi\_no\_memhotplug, to disable ACPI memory hotplug.
Signed-off-by: Prarit Bhargava
Acked-by: Vivek Goyal
Acked-by: Toshi Kani
Acked-by: David Rientjes
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Jiri Slaby
commit 5ff029e2b396ac09fc52addd73bb0f4003c70ef2
Author: Peter Zijlstra
Date: Thu Feb 27 10:40:35 2014 +0100
sched: Make scale\_rt\_power() deal with backward clocks
commit cadefd3d6cc914d95163ba1eda766bfe7ce1e5b7 upstream.
Mike reported that, while unlikely, its entirely possible for
scale\_rt\_power() to see the time go backwards. This yields rather
'interesting' results.
So like all other sites that deal with clocks; make this one ignore
backward clock movement too.
Reported-by: Mike Galbraith
Signed-off-by: Peter Zijlstra
Link: http://lkml.kernel.org/r/20140227094035.GZ9987@twins.programming.kicks-ass.net
Cc: Linus Torvalds
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Ingo Molnar
Signed-off-by: Jiri Slaby
commit dcc23f13ff973c49651f0f020495a26baec32343
Author: Wendy Xiong
Date: Wed Mar 12 16:08:52 2014 -0500
[SCSI] ipr: Add new CCIN definition for Grand Canyon support
commit 5eeac3e99ae220aea787527d1bfd9e846adf9fac upstream.
Add the appropriate definition and table entry for new hardware support.
Signed-off-by: Wen Xiong
Acked-by: Brian King
Signed-off-by: James Bottomley
Signed-off-by: Jiri Slaby
commit 311222a922b478908f21389de1a2b95b80e393b3
Author: Mike Qiu
Date: Fri Apr 18 15:07:14 2014 -0700
powerpc/mm: fix ".\_\_node\_distance" undefined
commit 12c743eb2289bcaace32859d4919417ff5707768 upstream.
CHK include/config/kernel.release
CHK include/generated/uapi/linux/version.h
CHK include/generated/utsrelease.h
...
Building modules, stage 2.
WARNING: 1 bad relocations
c0000000013d6a30 R\_PPC64\_ADDR64 uprobes\_fetch\_type\_table
WRAP arch/powerpc/boot/zImage.pseries
WRAP arch/powerpc/boot/zImage.epapr
MODPOST 1849 modules
ERROR: ".\_\_node\_distance" [drivers/block/nvme.ko] undefined!
make[1]: \*\*\* [\_\_modpost] Error 1
make: \*\*\* [modules] Error 2
make: \*\*\* Waiting for unfinished jobs....
The reason is symbol "\_\_node\_distance" not been exported in powerpc.
Signed-off-by: Mike Qiu
Acked-by: Benjamin Herrenschmidt
Cc: Paul Mackerras
Cc: Nathan Fontenot
Cc: Stephen Rothwell
Cc: Srivatsa S. Bhat
Cc: Jesse Larrew
Cc: Robert Jennings
Cc: Alistair Popple
Cc: Mike Qiu
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit 38a572d05464baa6f1d12cd351c4e7f1ec7055aa
Author: Petr Mladek
Date: Tue Jun 3 18:23:21 2014 +0200
ftrace/x86: Call text\_ip\_addr() instead of the duplicated code
commit 964f7b6b785651a75ef1cbad43a393ca52d4b4f7 upstream.
I just went over this when looking at some Xen-related ftrace initialization
problems. They were related to Xen code that is not upstream but this clean up
would make sense here.
I think that this was already the intention when text\_ip\_addr() was introduced
in the commit 87fbb2ac6073a703930 (ftrace/x86: Use breakpoints for converting
function graph caller). Anyway, better do it now before it shots people into
their leg ;-)
Link: http://lkml.kernel.org/p/1401812601-2359-1-git-send-email-pmladek@suse.cz
Signed-off-by: Petr Mladek
Signed-off-by: Steven Rostedt
Signed-off-by: Jiri Slaby
commit 2eaaa8d28d3b2a17c02ff41ce526b16e65f9bce1
Author: J. Bruce Fields
Date: Tue May 27 11:14:26 2014 -0400
nfsd4: fix FREE\_STATEID lockowner leak
commit 48385408b45523d9a432c66292d47ef43efcbb94 upstream.
27b11428b7de ("nfsd4: remove lockowner when removing lock stateid")
introduced a memory leak.
Cc: stable@vger.kernel.org
Reported-by: Jeff Layton
Signed-off-by: J. Bruce Fields
Signed-off-by: Jiri Slaby
commit 481956841e2e0f88b519267c91d86b7625e2a3af
Author: Ying Xue
Date: Tue Apr 29 11:12:18 2014 +0800
tipc: fix memory leak of publications
commit 1621b94d2a655c8548ddbdfc8ccf907a5bbdc860 upstream.
Commit 1bb8dce57f4d15233688c68990852a10eb1cd79f ("tipc: fix memory
leak during module removal") introduced a memory leak issue: when
name table is stopped, it's forgotten that publication instances are
freed properly. Additionally the useless "continue" statement in
tipc\_nametbl\_stop() is removed as well.
Reported-by: Jason
Signed-off-by: Ying Xue
Acked-by: Erik Hugne
Signed-off-by: David S. Miller
Signed-off-by: Jiri Slaby
commit 4c65d4f6fd4ae448900a9c3a0a9a31c5a5583774
Author: Jiang Liu
Date: Thu Jan 9 15:30:27 2014 +0800
intel\_idle: close avn\_cstates array with correct marker
commit 88390996c95b879ba365888199b45ace3f5ca80b upstream.
Close avn\_cstates array with correct marker to avoid overflow
in function intel\_idle\_cpu\_init().
[rjw: The problem was introduced when commit 22e580d07f65 was merged
on top of eba682a5aeb6 (intel\_idle: shrink states tables).]
Fixes: 22e580d07f65 (intel\_idle: Fixed C6 state on Avoton/Rangeley processors)
Signed-off-by: Jiang Liu
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Jiri Slaby
commit e54e6e8ec33fa40e0f4eac6efa7ad2eddfaab05c
Author: Viresh Kumar
Date: Tue Apr 15 10:54:41 2014 +0530
tick-sched: Check tick\_nohz\_enabled in tick\_nohz\_switch\_to\_nohz()
commit 27630532ef5ead28b98cfe28d8f95222ef91c2b7 upstream.
Since commit d689fe222 (NOHZ: Check for nohz active instead of nohz
enabled) the tick\_nohz\_switch\_to\_nohz() function returns because it
checks for the tick\_nohz\_active flag. This can't be set, because the
function itself sets it.
Undo the change in tick\_nohz\_switch\_to\_nohz().
Signed-off-by: Viresh Kumar
Cc: linaro-kernel@lists.linaro.org
Cc: fweisbec@gmail.com
Cc: Arvind.Chauhan@arm.com
Cc: linaro-networking@linaro.org
Cc:  # 3.13+
Link: http://lkml.kernel.org/r/40939c05f2d65d781b92b20302b02243d0654224.1397537987.git.viresh.kumar@linaro.org
Signed-off-by: Thomas Gleixner
Signed-off-by: Jiri Slaby
commit c79460f67d0b02465904193764328ceeacfdd549
Author: Konstantin Khlebnikov
Date: Tue Jun 17 06:58:05 2014 +0400
epoll: fix use-after-free in eventpoll\_release\_file
commit ebe06187bf2aec10d537ce4595e416035367d703 upstream.
This fixes use-after-free of epi->fllink.next inside list loop macro.
This loop actually releases elements in the body. The list is
rcu-protected but here we cannot hold rcu\_read\_lock because we need to
lock mutex inside.
The obvious solution is to use list\_for\_each\_entry\_safe(). RCU-ness
isn't essential because nobody can change this list under us, it's final
fput for this file.
The bug was introduced by ae10b2b4eb01 ("epoll: optimize EPOLL\_CTL\_DEL
using rcu")
Signed-off-by: Konstantin Khlebnikov
Reported-by: Cyrill Gorcunov
Cc: Stable  # 3.13+
Cc: Sasha Levin
Cc: Jason Baron
Signed-off-by: Linus Torvalds
Signed-off-by: Jiri Slaby
commit f116dbc9d877c8436f17fd3226c6d4695bbbb928
Author: Li Zhong
Date: Mon Apr 28 08:29:51 2014 +0800
powerpc: Fix Oops in rtas\_stop\_self()
commit 4fb8d027dca0236c811272d342cf185569d91311 upstream.
commit 41dd03a9 may cause Oops in rtas\_stop\_self().
The reason is that the rtas\_args was moved into stack space. For a box
with more that 4GB RAM, the stack could easily be outside 32bit range,
but RTAS is 32bit.
So the patch moves rtas\_args away from stack by adding static before
it.
Signed-off-by: Li Zhong
Signed-off-by: Anton Blanchard
Cc: stable@vger.kernel.org # 3.14+
Signed-off-by: Benjamin Herrenschmidt
Signed-off-by: Jiri Slaby
commit 22d3112ae7f819d3965ede21a79a5b5ad6ff33ed
Author: J. Bruce Fields
Date: Thu Jan 16 13:51:07 2014 -0500
GFS2: revert "GFS2: d\_splice\_alias() can't return error"
commit d57b9c9a999a8f4475fe73fba629c964245800ca upstream.
0d0d110720d7960b77c03c9f2597faaff4b484ae asserts that "d\_splice\_alias()
can't return error unless it was given an IS\_ERR(inode)".
That was true of the implementation of d\_splice\_alias, but this is
really a problem with d\_splice\_alias: at a minimum it should be able to
return -ELOOP in the case where inserting the given dentry would cause a
directory loop.
Signed-off-by: J. Bruce Fields
Signed-off-by: Steven Whitehouse
Signed-off-by: Jiri Slaby
commit 63a97385b3919335ff2a1d502925de4dc3ef4fd4
Author: Jiri Slaby
Date: Tue Jun 24 16:04:43 2014 +0200
Revert "bio-integrity: Fix bio\_integrity\_verify segment start bug"
This reverts commit 7cbcb219e4113e10ce4b036118992abdbc4a8273,
misapplied upstream commit 5837c80e870bc3b12ac6a98cdc9ce7a9522a8fb6.
The upstream commit was applied twice to stable-3.12, the second time
to bio\_integrity\_generate. Revert this second application.
Cc: Martin K. Petersen
Cc: Jens Axboe
Cc: Christoph Hellwig
Signed-off-by: Nicholas Bellinger
Signed-off-by: Jens Axboe
Signed-off-by: Jiri Slaby
commit 61844d8e25eb8899b0836afa9796fa239db80f1f
Author: Vincent Guittot
Date: Wed Jan 22 08:45:34 2014 +0100
Revert "sched: Fix sleep time double accounting in enqueue entity"
commit 9390675af0835ae1d654d33bfcf16096028550ad upstream.
This reverts commit 282cf499f03ec1754b6c8c945c9674b02631fb0f.
With the current implementation, the load average statistics of a sched entity
change according to other activity on the CPU even if this activity is done
between the running window of the sched entity and have no influence on the
running duration of the task.
When a task wakes up on the same CPU, we currently update last\_runnable\_update
with the return of \_\_synchronize\_entity\_decay without updating the
runnable\_avg\_sum and runnable\_avg\_period accordingly. In fact, we have to sync
the load\_contrib of the se with the rq's blocked\_load\_contrib before removing
it from the latter (with \_\_synchronize\_entity\_decay) but we must keep
last\_runnable\_update unchanged for updating runnable\_avg\_sum/period during the
next update\_entity\_load\_avg.
Signed-off-by: Vincent Guittot
Signed-off-by: Peter Zijlstra
Reviewed-by: Ben Segall
Cc: pjt@google.com
Cc: alex.shi@linaro.org
Link: http://lkml.kernel.org/r/1390376734-6800-1-git-send-email-vincent.guittot@linaro.org
Signed-off-by: Ingo Molnar
Signed-off-by: Jiri Slaby


=== Content from github.com_cb24edf4_20250126_063321.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-6mj3-jgwh-v3xp)

**CVE-2014-0206**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-6mj3-jgwh-v3xp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2014-0206](/advisories/GHSA-6mj3-jgwh-v3xp)

## Array index error in the aio\_read\_events\_ring function in...

Low severity

Unreviewed

Published
May 14, 2022
to the GitHub Advisory Database
•
Updated Feb 13, 2023

## Package

No package listed—
[Suggest a package](/advisories/GHSA-6mj3-jgwh-v3xp/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

Array index error in the aio\_read\_events\_ring function in fs/aio.c in the Linux kernel through 3.15.1 allows local users to obtain sensitive information from kernel memory via a large head value.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2014-0206>
* [torvalds/linux@edfbbf3](https://github.com/torvalds/linux/commit/edfbbf388f293d70bf4b7c0bc38774d05e6f711a)
* <https://bugzilla.redhat.com/show_bug.cgi?id=1094602>
* <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=edfbbf388f29>
* <https://source.android.com/security/bulletin/2017-04-01>
* <https://www.kernel.org/pub/linux/kernel/v3.x/ChangeLog-3.10.46>
* <https://www.kernel.org/pub/linux/kernel/v3.x/ChangeLog-3.12.24>
* <https://www.kernel.org/pub/linux/kernel/v3.x/ChangeLog-3.14.10>
* <https://www.kernel.org/pub/linux/kernel/v3.x/ChangeLog-3.15.3>
* <http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=edfbbf388f293d70bf4b7c0bc38774d05e6f711a>
* <http://secunia.com/advisories/59278>
* <http://www.securityfocus.com/bid/68176>
* <http://www.securitytracker.com/id/1030479>
* <http://www.securitytracker.com/id/1038201>
* <http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git%3Ba=commit%3Bh=edfbbf388f293d70bf4b7c0bc38774d05e6f711a>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2014-0206)
Jun 25, 2014

Published to the GitHub Advisory Database
May 14, 2022

Last updated
Feb 13, 2023

### Severity

Low

### EPSS score

0.137%

# Exploit Prediction Scoring System (EPSS)

This score estimates the probability of this vulnerability being exploited within the next 30 days.
Data provided by [FIRST](https://www.first.org/epss/user-guide).

 (50th percentile)

### Weaknesses

No CWEs

### CVE ID

CVE-2014-0206

### GHSA ID

GHSA-6mj3-jgwh-v3xp

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-6mj3-jgwh-v3xp/improve).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


