=== Content from launchpad.net_9e50c715_20250126_062101.html ===

[Log in / Register](https://launchpad.net/~tristan-cacqueray/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~tristan-cacqueray)

## [Tristan Cacqueray](https://launchpad.net/~tristan-cacqueray)

* Overview
* [Code](https://code.launchpad.net/~tristan-cacqueray)
* [Bugs](https://bugs.launchpad.net/~tristan-cacqueray)
* [Blueprints](https://blueprints.launchpad.net/~tristan-cacqueray)
* [Translations](https://translations.launchpad.net/~tristan-cacqueray)
* [Answers](https://answers.launchpad.net/~tristan-cacqueray)

* [Related packages](https://launchpad.net/~tristan-cacqueray/%2Brelated-packages)
* [Related projects](https://launchpad.net/~tristan-cacqueray/%2Brelated-projects)

## User information

Launchpad Id:
tristan-cacqueray

Email:
[Log in](%2Blogin) for email information.

Member since:
2013-10-25

[![Icon of OpenStack Security SIG](https://launchpadlibrarian.net/203991792/os14.png "Member of OpenStack Security SIG")](/~openstack-ossg)

Signed Ubuntu Code of Conduct:
Yes

Languages:

English

OpenPGP keys:

EB103DE8B5E69E631C6FF17922B9A05C925CC5D8

SSH keys:

[localadmin@controller](%2Bsshkeys)

Time zone:

UTC
(UTC+0000)

Karma:
[0](https://launchpad.net/~tristan-cacqueray/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

Social accounts:
![IRC](/@@/social-irc "IRC")
**tristanC**
 on
**irc.freenode.net**

## [All memberships](https://launchpad.net/~tristan-cacqueray/%2Bparticipation) Latest memberships

| [Swiftsync dev](/~swiftsync-devteam)  Joined on 2014-02-13 | |
| --- | --- |
| [OpenStack Security SIG](/~openstack-ossg)  Joined on 2013-12-12 | |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_189f6512_20250125_053237.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# [0SSA 2014-009] Image format not enforced when using rescue (CVE-2014-0134)

Bug #1221190 reported by
[Stanislaw Pitucha](https://launchpad.net/~stanislaw-pitucha)
on 2013-09-05

[280](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [David Ripton](https://launchpad.net/~dripton) | [OpenStack Compute (nova) 2014.1 "icehouse"](https://launchpad.net/nova/%2Bmilestone/2014.1) |
|  | [Havana](https://bugs.launchpad.net/nova/havana) | Fix Released | High | [David Ripton](https://launchpad.net/~dripton) | [OpenStack Compute (nova) 2013.2.3](https://launchpad.net/nova/%2Bmilestone/2013.2.3) |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | High | [Tristan Cacqueray](https://launchpad.net/~tristan-cacqueray) |  |

### Bug Description

Rescuing an instance seems to guess the image format at some point. This allows reading files from the compute host via the qcow2 backing file.

Requirements:

- instances spawned using libvirt

- use\_cow\_images = False in the config

To reproduce:

1. Create a qcow2 file backed by the path you want to read from the compute host. (qemu-img create -f qcow2 -b /path/to/the/file $((1024\*1024)) evil.qcow2)

2. Spawn an instance, scp the file into it.

3. Overwrite the disk inside the instance (dd if=evil.qcow2 of=/dev/vda)

4. Shutdown the instance.

5. Rescue the instance

6. While in rescue mode, login and read /dev/vdb - beginning should be read from the qcow backing file

Libvirt description of the rescued instance will contain the entry for the second disk with attribute type="qcow2", even though it should be "raw" - same as the original instance.

Mitigating factors:

- files have to be readable by libvirt/kvm

- apparmor/selinux will limit the number of accessible files

- only full blocks of the file are visible in the rescued instance, so short files will not be available at all and long files are going to be truncated

Possible targets:

- private snapshots with known uuids, or instances of other tenants are a good target for this attack

Tags:

[libvirt](/nova/%2Bbugs?field.tag=libvirt)
[havana-backport-potential](/nova/%2Bbugs?field.tag=havana-backport-potential)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2013-09-05: |  |  | [#1](/nova/%2Bbug/1221190/comments/1) |
| --- | --- | --- | --- |

Added a new OSSA task, since this looks like it will probably require an advisory once addressed.

Added a new OSSA task, since this looks like it will probably require an advisory once addressed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-06: |  |  | [#2](/nova/%2Bbug/1221190/comments/2) |
| --- | --- | --- | --- |

Adding Russell and Padraig for a quick sanity-check

Adding Russell and Padraig for a quick sanity-check

| Changed in ossa: | |
| --- | --- |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-06: |  |  | [#3](/nova/%2Bbug/1221190/comments/3) |
| --- | --- | --- | --- |

> - files have to be readable by libvirt/kvm

> - apparmor/selinux will limit the number of accessible files

I don't believe those points help much, if at all.

Remember while guests are running as a KVM user, libvirtd which launches them is root. If the XML config tells libvirtd to give access to a particular file, libvirtd will do that and setup the selinux/apparmour policy to allow it too.

> - files have to be readable by libvirt/kvm
> - apparmor/selinux will limit the number of accessible files
I don't believe those points help much, if at all.
Remember while guests are running as a KVM user, libvirtd which launches them is root. If the XML config tells libvirtd to give access to a particular file, libvirtd will do that and setup the selinux/apparmour policy to allow it too.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2013-09-06: |  |  | [#4](/nova/%2Bbug/1221190/comments/4) |
| --- | --- | --- | --- |

Added Daniel Berrange as well, since this is related to the libvirt driver.

Added Daniel Berrange as well, since this is related to the libvirt driver.

[Russell Bryant (russellb)](https://launchpad.net/~russellb)
on 2013-09-09

| **tags**: | added: libvirt |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-10: |  |  | [#5](/nova/%2Bbug/1221190/comments/5) |
| --- | --- | --- | --- |

Russell, Daniel: so if I read this correctly this a a genuine flaw which can result in limited host data leakage. Likely targets would be ACL-protected files like /etc/shadow ?

Russell, Daniel: so if I read this correctly this a a genuine flaw which can result in limited host data leakage. Likely targets would be ACL-protected files like /etc/shadow ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-10: |  |  | [#6](/nova/%2Bbug/1221190/comments/6) |
| --- | --- | --- | --- |

Yes, at the very least, this is a serious information leakage flaw. This same issue has been given a CVE many times before in various virt projects. QEMU has the ability to merge a snapshot back into the base file - if there was a way to trigger this in openstack, the flaw would be even more serious - host data overwriting.

Yes, at the very least, this is a serious information leakage flaw. This same issue has been given a CVE many times before in various virt projects. QEMU has the ability to merge a snapshot back into the base file - if there was a way to trigger this in openstack, the flaw would be even more serious - host data overwriting.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-13: |  |  | [#7](/nova/%2Bbug/1221190/comments/7) |
| --- | --- | --- | --- |

Anyone working on a patch for this ? Does this also affect Grizzly/Folsom ?

Anyone working on a patch for this ? Does this also affect Grizzly/Folsom ?

| Changed in ossa: | |
| --- | --- |
| **importance**: | Undecided → Medium |
| **status**: | Incomplete → Confirmed |
| Changed in nova: | |
| **importance**: | Undecided → High |
| **milestone**: | none → havana-rc1 |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-13: |  |  | [#8](/nova/%2Bbug/1221190/comments/8) |
| --- | --- | --- | --- |

It goes all the way back to Diablo as far as I can tell. I'm not actively working on a patch, but will be happy to help with details / reproducing if needed.

It goes all the way back to Diablo as far as I can tell. I'm not actively working on a patch, but will be happy to help with details / reproducing if needed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-13: |  |  | [#9](/nova/%2Bbug/1221190/comments/9) |
| --- | --- | --- | --- |

Actually, I have not tried on the releases in between, so just to be sure, you can retest on Grizzly / Folsom. I don't have an environment to do that unfortunately.

Tested only Diablo and trunk.

Actually, I have not tried on the releases in between, so just to be sure, you can retest on Grizzly / Folsom. I don't have an environment to do that unfortunately.
Tested only Diablo and trunk.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-17: |  |  | [#10](/nova/%2Bbug/1221190/comments/10) |
| --- | --- | --- | --- |

I just tested trunk and didn't see the behaviour described in this report.

I have nova setup to use raw files

$ grep cow /etc/nova/nova.conf

use\_cow\_images = False

I then booted, stopped & rescued an instance

$ nova boot --flavor m1.small --image f16-x86\_64-openstack-sda f16demo

$ nova stop f16demo

$ nova rescue f16demo

When I look at the config libvirt generated, it is correctly setting 'raw' as the disk type

# virsh dumpxml instance-00000003

<disk type='file' device='disk'>

      <driver name='qemu' type='raw' cache='none'/>

      <source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk.rescue'/>

      <target dev='vda' bus='virtio'/>

      <alias name='virtio-disk0'/>

      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>

    </disk>

    <disk type='file' device='disk'>

      <driver name='qemu' type='raw' cache='none'/>

      <source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk'/>

      <target dev='vdb' bus='virtio'/>

      <alias name='virtio-disk1'/>

      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>

    </disk>

> Libvirt description of the rescued instance will contain the entry for the second disk with attribute type="qcow2", even though it should be "raw" - same as the original instance.

@stanislaw What version of Nova do you see this behaviour with ? Today's GIT master doesn't show it

I just tested trunk and didn't see the behaviour described in this report.
I have nova setup to use raw files
$ grep cow /etc/nova/nova.conf
use\_cow\_images = False
I then booted, stopped & rescued an instance
$ nova boot --flavor m1.small --image f16-x86\_64-openstack-sda f16demo
$ nova stop f16demo
$ nova rescue f16demo
When I look at the config libvirt generated, it is correctly setting 'raw' as the disk type
# virsh dumpxml instance-00000003
<disk type='file' device='disk'>
<driver name='qemu' type='raw' cache='none'/>
<source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk.rescue'/>
<target dev='vda' bus='virtio'/>
<alias name='virtio-disk0'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>
</disk>
<disk type='file' device='disk'>
<driver name='qemu' type='raw' cache='none'/>
<source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk'/>
<target dev='vdb' bus='virtio'/>
<alias name='virtio-disk1'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
</disk>
> Libvirt description of the rescued instance will contain the entry for the second disk with attribute type="qcow2", even though it should be "raw" - same as the original instance.
@stanislaw What version of Nova do you see this behaviour with ? Today's GIT master doesn't show it

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-18: |  |  | [#11](/nova/%2Bbug/1221190/comments/11) |
| --- | --- | --- | --- |

* ["script" capture of the hack, starting with a clean host](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3827442/%2Bfiles/image_hack_typescript)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3827442)
  (15.7 KiB,
  application/octet-stream)

I started from scratch right now and I'm still seeing the same, broken behaviour. Attached, is my whole test (well - I edited out devstack installation) captured via `script`.

Current nova's commit is 82a598318f5d045a2d422f257f9a770ae1f92dc8

I started from scratch right now and I'm still seeing the same, broken behaviour. Attached, is my whole test (well - I edited out devstack installation) captured via `script`.
Current nova's commit is 82a598318f5d045a2d422f257f9a770ae1f92dc8

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-23: |  |  | [#12](/nova/%2Bbug/1221190/comments/12) |
| --- | --- | --- | --- |

Setting to incomplete while we confirm that current trunk is affected

Setting to incomplete while we confirm that current trunk is affected

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → Incomplete |
| Changed in ossa: | |
| **status**: | Confirmed → Incomplete |
| **importance**: | Medium → Undecided |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2013-09-25: |  |  | [#13](/nova/%2Bbug/1221190/comments/13) |
| --- | --- | --- | --- |

I don't see this behavior either, although I see different things from Daniel.

I don't see the contents of the evil backing file in /dev/vdb from inside the rescuing guest, but I do see the path I set as the first string, which means the dd worked:

$ sudo strings /dev/vdb | head -1

/etc/libvirt/libvirt.conf

My libvirt config does show qcow2 as the disk format though:

<disk type='file' device='disk'>

      <driver name='qemu' type='qcow2' cache='none'/>

      <source file='/opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk'/>

      <target dev='vdb' bus='virtio'/>

      <alias name='virtio-disk1'/>

      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>

</disk>

However, if I look at the image itself:

# qemu-img info /opt/stack/data/nova/instances/77304a99-9453-4e21-8dbb-ccf61dfa5c23/disk

image: /opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk

file format: qcow2

virtual size: 1.0G (1073741824 bytes)

disk size: 12M

cluster\_size: 65536

backing file: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6)

and if I follow the backing file reference:

# qemu-img info /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07

image: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07

file format: raw

virtual size: 24M (25165824 bytes)

disk size: 24M

it backs up to a raw file. This was on a precise machine:

ii libvirt-bin 0.9.8-2ubuntu17 programs for the libvirt library

On a very recent commit from master:

commit 78810135d851a4db60a2cb2e2fbdb11d032a8b97

Merge: 5429048 2d13161

Author: Jenkins <email address hidden>

Date: Wed Sep 25 19:56:34 2013 +0000

I don't see this behavior either, although I see different things from Daniel.
I don't see the contents of the evil backing file in /dev/vdb from inside the rescuing guest, but I do see the path I set as the first string, which means the dd worked:
$ sudo strings /dev/vdb | head -1
/etc/libvirt/libvirt.conf
My libvirt config does show qcow2 as the disk format though:
<disk type='file' device='disk'>
<driver name='qemu' type='qcow2' cache='none'/>
<source file='/opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk'/>
<target dev='vdb' bus='virtio'/>
<alias name='virtio-disk1'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
</disk>
However, if I look at the image itself:
# qemu-img info /opt/stack/data/nova/instances/77304a99-9453-4e21-8dbb-ccf61dfa5c23/disk
image: /opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 12M
cluster\_size: 65536
backing file: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6)
and if I follow the backing file reference:
# qemu-img info /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07
image: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07
file format: raw
virtual size: 24M (25165824 bytes)
disk size: 24M
it backs up to a raw file. This was on a precise machine:
ii libvirt-bin 0.9.8-2ubuntu17 programs for the libvirt library
On a very recent commit from master:
commit 78810135d851a4db60a2cb2e2fbdb11d032a8b97
Merge: 5429048 2d13161
Author: Jenkins <jenkins@review.openstack.org>
Date: Wed Sep 25 19:56:34 2013 +0000

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-26: |  |  | [#14](/nova/%2Bbug/1221190/comments/14) |
| --- | --- | --- | --- |

Dan, I'll double-check on my machine, but I don't think what you see looks right for this scenario. In case of use\_cow\_images=false, I wouldn't expect the backing file to point at the \_base directory at any time. That looks like the instance was created with a qcow2 disk from the start.

Dan, I'll double-check on my machine, but I don't think what you see looks right for this scenario. In case of use\_cow\_images=false, I wouldn't expect the backing file to point at the \_base directory at any time. That looks like the instance was created with a qcow2 disk from the start.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#15](/nova/%2Bbug/1221190/comments/15) |
| --- | --- | --- | --- |

FYI, I have managed to reproduce the problem now & confirm it is flawed.

FYI, I have managed to reproduce the problem now & confirm it is flawed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#16](/nova/%2Bbug/1221190/comments/16) |
| --- | --- | --- | --- |

Looks like the flaw was introduced in this patch - it causes the libvirt imagebackend.py code to run qemu-img info to probe the disk format which is unsafe :-(

commit 494a3cb5749d52aa90daeacd980362df5f971c0d

Author: Vishvananda Ishaya <email address hidden>

Date: Mon Apr 1 14:19:49 2013 -0700

libvirt: Get driver type from base image type.

If we are using the raw backend (no cow), we should set the driver

    type based on the type of the source image instead of always

    using raw.

Calls to to\_xml were moved after \_create\_image so that the image

    type could be determined when creating the xml for libvirt.

Fixes [bug 1163009](/bugs/1163009)

Change-Id: Ic8d5f0ab83d868a42f834d39c0afb64818d7e027

Looks like the flaw was introduced in this patch - it causes the libvirt imagebackend.py code to run qemu-img info to probe the disk format which is unsafe :-(
commit 494a3cb5749d52aa90daeacd980362df5f971c0d
Author: Vishvananda Ishaya <vishvananda@gmail.com>
Date: Mon Apr 1 14:19:49 2013 -0700
libvirt: Get driver type from base image type.
If we are using the raw backend (no cow), we should set the driver
type based on the type of the source image instead of always
using raw.
Calls to to\_xml were moved after \_create\_image so that the image
type could be determined when creating the xml for libvirt.
Fixes bug 1163009
Change-Id: Ic8d5f0ab83d868a42f834d39c0afb64818d7e027

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#17](/nova/%2Bbug/1221190/comments/17) |
| --- | --- | --- | --- |

I think we need to just revert that patch entirely, as the approach it takes is not safe. It injects the probing into the imagebackend.py code, which means it is run in every single code path that uses the image backends.

To address the [bug 1163009](/bugs/1163009) safely, we would need something that only does the probing when the image is first downloaded from glance. The detected format should then be recorded (in the database?) and used for all subsequent boots of that image, whether normal start, or rescue start, or something else.

I think we need to just revert that patch entirely, as the approach it takes is not safe. It injects the probing into the imagebackend.py code, which means it is run in every single code path that uses the image backends.
To address the bug 1163009 safely, we would need something that only does the probing when the image is first downloaded from glance. The detected format should then be recorded (in the database?) and used for all subsequent boots of that image, whether normal start, or rescue start, or something else.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-26: |  |  | [#18](/nova/%2Bbug/1221190/comments/18) |
| --- | --- | --- | --- |

This was introduced in stable/grizzly, which complicates things a bit. Purely reverting (and introducing a small regression) might not be an option there. That said, changing db format is not an option there either... Is there a plan C ?

This was introduced in stable/grizzly, which complicates things a bit. Purely reverting (and introducing a small regression) might not be an option there. That said, changing db format is not an option there either... Is there a plan C ?

| Changed in nova: | |
| --- | --- |
| **status**: | Incomplete → Confirmed |
| Changed in ossa: | |
| **status**: | Incomplete → Confirmed |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2013-09-26

| Changed in ossa: | |
| --- | --- |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#19](/nova/%2Bbug/1221190/comments/19) |
| --- | --- | --- | --- |

The key issue is that we must only ever probe the image format once and persist that data in some manner. If using the database is not possible, then perhaps we can change the naming convention used for image files, eg instead of

$INSTANCE\_DIR/disk

use

$INSTANCE\_DIR/disk.qcow2

or

$INSTANCE\_DIR/disk.raw

I'd be somewhat scared about making such a change in grizzly stable though, since hunting down all the places which assume a plain name of 'disk' may be hard.

The key issue is that we must only ever probe the image format once and persist that data in some manner. If using the database is not possible, then perhaps we can change the naming convention used for image files, eg instead of
$INSTANCE\_DIR/disk
use
$INSTANCE\_DIR/disk.qcow2
or
$INSTANCE\_DIR/disk.raw
I'd be somewhat scared about making such a change in grizzly stable though, since hunting down all the places which assume a plain name of 'disk' may be hard.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#20](/nova/%2Bbug/1221190/comments/20) |
| --- | --- | --- | --- |

Another option for grizzly stable would be to have something run on VM shutdown that probed the disk image and compard it to the XML nova saved in the instance directory. If it detected that the format had changed, it could do something to prevent the VM being started again - eg renamed the image from 'disk' to 'disk.compromised'

Another option for grizzly stable would be to have something run on VM shutdown that probed the disk image and compard it to the XML nova saved in the instance directory. If it detected that the format had changed, it could do something to prevent the VM being started again - eg renamed the image from 'disk' to 'disk.compromised'

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2013-09-26: |  |  | [#21](/nova/%2Bbug/1221190/comments/21) |
| --- | --- | --- | --- |

Ah, sorry, I mis-correlated the default of use\_cow\_images with what you said it needed to be, my bad.

Ah, sorry, I mis-correlated the default of use\_cow\_images with what you said it needed to be, my bad.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-26: |  |  | [#22](/nova/%2Bbug/1221190/comments/22) |
| --- | --- | --- | --- |

I really like the file renaming, but even if we changed all of the places in openstack itself, there's bound to be a number of custom modules or supporting scripts people use that assume this name. I know we have a number of those.

To further complicate the shutdown check, you can probably find some situations where proper shutdown doesn't happen. Host reboots (crashes or forced by dos) would not run shutdown. Live migration be another edge case to check, I guess.

Just to brainstorm more ideas: what about renaming the files and leaving a symlink in place? This will require lots of renaming in libvirt driver, but hopefully it will fix the problem itself. For anything that gets accidentally left over or things that exist outside of openstack's control, the symlink from disk -> disk.{format} should be enough to keep it working.

Or maybe even better -> create disk.{format} itself as a symlink to disk and verify the format based on that file?

I really like the file renaming, but even if we changed all of the places in openstack itself, there's bound to be a number of custom modules or supporting scripts people use that assume this name. I know we have a number of those.
To further complicate the shutdown check, you can probably find some situations where proper shutdown doesn't happen. Host reboots (crashes or forced by dos) would not run shutdown. Live migration be another edge case to check, I guess.
Just to brainstorm more ideas: what about renaming the files and leaving a symlink in place? This will require lots of renaming in libvirt driver, but hopefully it will fix the problem itself. For anything that gets accidentally left over or things that exist outside of openstack's control, the symlink from disk -> disk.{format} should be enough to keep it working.
Or maybe even better -> create disk.{format} itself as a symlink to disk and verify the format based on that file?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Pádraig Brady (p-draigbrady)](https://launchpad.net/~p-draigbrady) wrote on 2013-09-26: |  |  | [#23](/nova/%2Bbug/1221190/comments/23) |
| --- | --- | --- | --- |

Is there a related case with force\_raw\_images=False, use\_cow\_images=False

where a qcow is copied directly from glance to the instance/disk ?

I.E. the disk is validly qcow2 format but not backed by an image in base\_/

Even if that case isn't susceptible to the dd if=evil.qcow attach,

it could impact on the format detection.

Is there a related case with force\_raw\_images=False, use\_cow\_images=False
where a qcow is copied directly from glance to the instance/disk ?
I.E. the disk is validly qcow2 format but not backed by an image in base\_/
Even if that case isn't susceptible to the dd if=evil.qcow attach,
it could impact on the format detection.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#24](/nova/%2Bbug/1221190/comments/24) |
| --- | --- | --- | --- |

Yet another idea for a easy hack for stable... rather than renaming disk images, we could save a little 'disks.info' file in the instance directory listing the expected formats when first booting. On subsequent boots/rescues we can consult that file instead of probing

> I.E. the disk is validly qcow2 format but not backed by an image in base\_/

Glance itself validates that users don't have a nasty backing file listed when they upload qcow2 files, so that's safe enough I believe. So the issue is only with raw files being turned into qcow2 files by a malicious guest action

Yet another idea for a easy hack for stable... rather than renaming disk images, we could save a little 'disks.info' file in the instance directory listing the expected formats when first booting. On subsequent boots/rescues we can consult that file instead of probing
> I.E. the disk is validly qcow2 format but not backed by an image in base\_/
Glance itself validates that users don't have a nasty backing file listed when they upload qcow2 files, so that's safe enough I believe. So the issue is only with raw files being turned into qcow2 files by a malicious guest action

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-27: |  |  | [#25](/nova/%2Bbug/1221190/comments/25) |
| --- | --- | --- | --- |

@Daniel: personally I like the disks.info approach, it appears to be the most foolproof (that file is only used by the verification code so all the other code paths should not be affected).

At this point in the cycle, we might apply this workaround to both grizzly and havana, and fix it "properly" in icehouse ?

@Daniel: personally I like the disks.info approach, it appears to be the most foolproof (that file is only used by the verification code so all the other code paths should not be affected).
At this point in the cycle, we might apply this workaround to both grizzly and havana, and fix it "properly" in icehouse ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2013-09-30: |  |  | [#26](/nova/%2Bbug/1221190/comments/26) |
| --- | --- | --- | --- |

Yes, I like the disk info metadata file, as well. It seems a lot less risky than renaming the files for grizzly and havana.

Yes, I like the disk info metadata file, as well. It seems a lot less risky than renaming the files for grizzly and havana.

[Russell Bryant (russellb)](https://launchpad.net/~russellb)
on 2013-10-01

| Changed in nova: | |
| --- | --- |
| **milestone**: | havana-rc1 → none |
| **tags**: | added: havana-rc-potential |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-10-02: |  |  | [#27](/nova/%2Bbug/1221190/comments/27) |
| --- | --- | --- | --- |

@Daniel: would you be up for a patch on this one ? Attach to this bug if you do.

@Daniel: would you be up for a patch on this one ? Attach to this bug if you do.

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2013-10-14

| **tags**: | added: havana-backport-potentialremoved: havana-rc-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-10-24: |  |  | [#28](/nova/%2Bbug/1221190/comments/28) |
| --- | --- | --- | --- |

Daniel should look at it next week.

Daniel should look at it next week.

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Daniel Berrange (berrange) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-11-20: |  |  | [#29](/nova/%2Bbug/1221190/comments/29) |
| --- | --- | --- | --- |

Looks like Dan doesn't have time for this in the immediate future. Anyone else wanting to work on a patch ?

Looks like Dan doesn't have time for this in the immediate future. Anyone else wanting to work on a patch ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2014-01-17: |  |  | [#30](/nova/%2Bbug/1221190/comments/30) |
| --- | --- | --- | --- |

I'm actively working on finding an assignee for this. If I'm not able to, I'll take it on.

I'm actively working on finding an assignee for this. If I'm not able to, I'll take it on.

| Changed in nova: | |
| --- | --- |
| **assignee**: | Daniel Berrange (berrange) → Russell Bryant (russellb) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2014-01-20: |  |  | [#31](/nova/%2Bbug/1221190/comments/31) |
| --- | --- | --- | --- |

David Ripton has now been assigned to work on the fix for this.

David Ripton has now been assigned to work on the fix for this.

| Changed in nova: | |
| --- | --- |
| **assignee**: | Russell Bryant (russellb) → David Ripton (dripton) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-01-22: |  |  | [#32](/nova/%2Bbug/1221190/comments/32) |
| --- | --- | --- | --- |

I agree that Dan's disks.info file seems to be the most backward-compatible way.

Here's my thinking:

In imagebackend.Raw.correct\_format(), we check for the existence of disks.info. And for an entry for 'path' in it. (like path~format, where format is 'raw' or 'qcow2'). If the disks.info does not exist, or does not have an entry for 'path', we probe for the image type and create the file (if needed) and entry. If it does have an entry, we use that entry, and let the instance fail to load if the image type is wrong.

In imagebackend.Qcow2, we add a parallel correct\_format() that does the same thing, with the format always being 'qcow2'. (If the entry already exists and is 'raw' we raise an exception.)

The purpose of keeping this code in imagebackend rather than doing it when we download the file using glance is to simplify the timing in the upgrade case. New code plus existing data keeps working. Granted, it means there's a chance of an attack, once, right after the code is upgraded, but the chance for the attack was already there before the code was upgraded, so in practice I don't think it makes a difference.

Finally, I'm leaning toward using disks.info in Icehouse as well, to have less code and simplify upgrades from stable/havana to Icehouse. Another database column would work, but then we need a database migration script (and more chance of collision with another patch in progress), and (possibly) logic to upgrade a stable/havana box with a disks.info file.

I agree that Dan's disks.info file seems to be the most backward-compatible way.
Here's my thinking:
In imagebackend.Raw.correct\_format(), we check for the existence of disks.info. And for an entry for 'path' in it. (like path~format, where format is 'raw' or 'qcow2'). If the disks.info does not exist, or does not have an entry for 'path', we probe for the image type and create the file (if needed) and entry. If it does have an entry, we use that entry, and let the instance fail to load if the image type is wrong.
In imagebackend.Qcow2, we add a parallel correct\_format() that does the same thing, with the format always being 'qcow2'. (If the entry already exists and is 'raw' we raise an exception.)
The purpose of keeping this code in imagebackend rather than doing it when we download the file using glance is to simplify the timing in the upgrade case. New code plus existing data keeps working. Granted, it means there's a chance of an attack, once, right after the code is upgraded, but the chance for the attack was already there before the code was upgraded, so in practice I don't think it makes a difference.
Finally, I'm leaning toward using disks.info in Icehouse as well, to have less code and simplify upgrades from stable/havana to Icehouse. Another database column would work, but then we need a database migration script (and more chance of collision with another patch in progress), and (possibly) logic to upgrade a stable/havana box with a disks.info file.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-01-30: |  |  | [#33](/nova/%2Bbug/1221190/comments/33) |
| --- | --- | --- | --- |

Draft impact description #1 -

Title: Host data leak to vm instance in rescue mode through image backing file.

Reporter: Stanislaw Pitucha (HP)

Products: Nova

Affects: All supported versions

Description:

Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. An instance administrator can overwrite the disk from inside the instance using a malicious qcow2 image crafted to be backed by an arbitary file path. By switching the instance to rescue mode, libvirt driver will guess the new image format to be a qcow2 resulting in the compute host backing file path (controlled by the user) to be exposed to the vm as the backing device. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Draft impact description #1 -
Title: Host data leak to vm instance in rescue mode through image backing file.
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Affects: All supported versions
Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. An instance administrator can overwrite the disk from inside the instance using a malicious qcow2 image crafted to be backed by an arbitary file path. By switching the instance to rescue mode, libvirt driver will guess the new image format to be a qcow2 resulting in the compute host backing file path (controlled by the user) to be exposed to the vm as the backing device. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

| Changed in ossa: | |
| --- | --- |
| **assignee**: | nobody → Tristan Cacqueray (tristan-cacqueray) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-01-31: |  |  | [#34](/nova/%2Bbug/1221190/comments/34) |
| --- | --- | --- | --- |

@Tristan: nice work, but the "By... a... will... resulting in... " construct should rather be used to describe the attack vector and the impact. The goal is not to use it to get into details over what technically happens in this bug.

By doing this THING, a type of attacker can trigger THAT, resulting in THIS IMPACT for the system/normal user etc.

Your description is, I think, a bit too detailed on the defect and not detailed enough on the attack vector. We don't know what type of attacker would abuse this (local user ? unauthenticated cloud user ? authenticated cloud user ?), the complexity of the attack, and most importantly the end result impact for the rest of the world.

I would say something like...

By overwiting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would..., resulting in... (data exposure ? denial of service ?)

@Tristan: nice work, but the "By... a... will... resulting in... " construct should rather be used to describe the attack vector and the impact. The goal is not to use it to get into details over what technically happens in this bug.
By doing this THING, a type of attacker can trigger THAT, resulting in THIS IMPACT for the system/normal user etc.
Your description is, I think, a bit too detailed on the defect and not detailed enough on the attack vector. We don't know what type of attacker would abuse this (local user ? unauthenticated cloud user ? authenticated cloud user ?), the complexity of the attack, and most importantly the end result impact for the rest of the world.
I would say something like...
By overwiting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would..., resulting in... (data exposure ? denial of service ?)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-02-05: |  |  | [#35](/nova/%2Bbug/1221190/comments/35) |
| --- | --- | --- | --- |

Many thanks for your review Thierry, I removed the technical details.

Draft impact description #2 -

Title: Host data leak to instance in rescue mode

Reporter: Stanislaw Pitucha (HP)

Products: Nova

Affects: All supported versions

Description:

Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Many thanks for your review Thierry, I removed the technical details.
Draft impact description #2 -
Title: Host data leak to instance in rescue mode
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Affects: All supported versions
Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-05: |  |  | [#36](/nova/%2Bbug/1221190/comments/36) |
| --- | --- | --- | --- |

* [patch vs. nova master for #1221190](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3970013/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3970013)
  (21.1 KiB,
  text/plain)

Attaching a patch for review. This is against current (icehouse) master.

Attaching a patch for review. This is against current (icehouse) master.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-05: |  |  | [#37](/nova/%2Bbug/1221190/comments/37) |
| --- | --- | --- | --- |

Impact looks good. You should add a comma between "rescue mode" and "an authenticated user" for readability though.

Impact looks good. You should add a comma between "rescue mode" and "an authenticated user" for readability though.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2014-02-05: |  |  | [#38](/nova/%2Bbug/1221190/comments/38) |
| --- | --- | --- | --- |

It looks good. Just some comments about edge cases:

Is the path always guaranteed to not contain "~"? Wouldn't it be safer to do the serialisation properly? It shouldn't be a big change between:

parts = line.strip().split('~')

and

parts = json.loads(line)

Is there any chance for race conditions here? Maybe just os.makedirs() except OSError would be enough?

+ if not os.path.exists(CONF.instances\_path):

+ os.makedirs(CONF.instances\_path, 0750)

Do we need to do the mode detection in get\_set\_driver\_format()? It looks like it could be always "a".

Since the file is created under instances\_path, should it also use an external lock? (in case of shared storage)

It looks good. Just some comments about edge cases:
Is the path always guaranteed to not contain "~"? Wouldn't it be safer to do the serialisation properly? It shouldn't be a big change between:
parts = line.strip().split('~')
and
parts = json.loads(line)
Is there any chance for race conditions here? Maybe just os.makedirs() except OSError would be enough?
+ if not os.path.exists(CONF.instances\_path):
+ os.makedirs(CONF.instances\_path, 0750)
Do we need to do the mode detection in get\_set\_driver\_format()? It looks like it could be always "a".
Since the file is created under instances\_path, should it also use an external lock? (in case of shared storage)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-05: |  |  | [#39](/nova/%2Bbug/1221190/comments/39) |
| --- | --- | --- | --- |

Thanks for the review Stanislaw.

'~' characters are extremely rare in paths, but I concede that extremely rare is not the same as impossible. I'll change the serialization to json.

I will add the try/except around makedirs in case of a directory creation race.

I believe the mode detection is needed; I saw errors in testing without it.

It's probably a good idea to use the existing lock directory to serialize accesses to get\_set\_driver\_format. I believe it's safe to read the file without the lock, but we should use the lock when we write the file.

I will make these changes (and some other improvements to the tests) and submit an updated patch.

Thanks for the review Stanislaw.
'~' characters are extremely rare in paths, but I concede that extremely rare is not the same as impossible. I'll change the serialization to json.
I will add the try/except around makedirs in case of a directory creation race.
I believe the mode detection is needed; I saw errors in testing without it.
It's probably a good idea to use the existing lock directory to serialize accesses to get\_set\_driver\_format. I believe it's safe to read the file without the lock, but we should use the lock when we write the file.
I will make these changes (and some other improvements to the tests) and submit an updated patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#40](/nova/%2Bbug/1221190/comments/40) |
| --- | --- | --- | --- |

Several more comments from my side in order of importance, and I agree with all the stuff Stanislaw said.

\* We really should not be creating the instance\_path dir like you are doing in get\_set\_driver\_format. We use libvirt\_utils.get\_instance\_path, and ensure\_tree - for inspiration, check the libvirt driver's \_create\_image method. Also - we really should not be creating the instance directory in imagebackend classes ever, this is really not it's responsibility but this is just IMHO.

\* Why not have a disks.info file per instance? The code here creates one for all the instances. Currently we can have only one image really per instance but that might change in the future (see [https://blueprints.launchpad.net/nova/+spec/libvirt-image-to-local-bdm](https://blueprints.launchpad.net/nova/%2Bspec/libvirt-image-to-local-bdm)), and this seems like a more natural place to keep it, plus we need only per instance locking. There may be something I'm missing here so feel free to let me know :)

\* get\_set\_driver\_format is not a good name IMHO.

Several more comments from my side in order of importance, and I agree with all the stuff Stanislaw said.
\* We really should not be creating the instance\_path dir like you are doing in get\_set\_driver\_format. We use libvirt\_utils.get\_instance\_path, and ensure\_tree - for inspiration, check the libvirt driver's \_create\_image method. Also - we really should not be creating the instance directory in imagebackend classes ever, this is really not it's responsibility but this is just IMHO.
\* Why not have a disks.info file per instance? The code here creates one for all the instances. Currently we can have only one image really per instance but that might change in the future (see https://blueprints.launchpad.net/nova/+spec/libvirt-image-to-local-bdm), and this seems like a more natural place to keep it, plus we need only per instance locking. There may be something I'm missing here so feel free to let me know :)
\* get\_set\_driver\_format is not a good name IMHO.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-06: |  |  | [#41](/nova/%2Bbug/1221190/comments/41) |
| --- | --- | --- | --- |

Thanks for the review Nikola.

I agree with your first point and will fix it in the next patch.

It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now, since we don't support multiple images per instance yet. And we definitely didn't support them in grizzly or havana, to which this security fix needs to be backported. I'd rather keep it simpler for now, but I'll be happy to add the multiple image support to disks.info later, after that blueprint goes in.

I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion? I thought of just calling it get\_driver\_format, but didn't because I wanted to make the side effect clear, as well as the reason to call it rather than just looking at self.driver\_format.

Thanks for the review Nikola.
I agree with your first point and will fix it in the next patch.
It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now, since we don't support multiple images per instance yet. And we definitely didn't support them in grizzly or havana, to which this security fix needs to be backported. I'd rather keep it simpler for now, but I'll be happy to add the multiple image support to disks.info later, after that blueprint goes in.
I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion? I thought of just calling it get\_driver\_format, but didn't because I wanted to make the side effect clear, as well as the reason to call it rather than just looking at self.driver\_format.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#42](/nova/%2Bbug/1221190/comments/42) |
| --- | --- | --- | --- |

Also, please consider using git format-patch next time just for the ease of applying it for review.

Also, please consider using git format-patch next time just for the ease of applying it for review.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#43](/nova/%2Bbug/1221190/comments/43) |
| --- | --- | --- | --- |

> It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now

Ok - but we do get the added benefit of not global locking needed with no real additional cost, plus if we put the file in instance dir. we get it cleaned automatically, and code wise - it's just changing how you get the path of the file all else can stay.

> I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion?

Maybe safe\_get... that way we emphasize what was the reason for introducing it and make it less confusing?

> It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now
Ok - but we do get the added benefit of not global locking needed with no real additional cost, plus if we put the file in instance dir. we get it cleaned automatically, and code wise - it's just changing how you get the path of the file all else can stay.
> I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion?
Maybe safe\_get... that way we emphasize what was the reason for introducing it and make it less confusing?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2014-02-06: |  |  | [#44](/nova/%2Bbug/1221190/comments/44) |
| --- | --- | --- | --- |

resolve\_driver\_format() - doesn't imply a simple getter, but I'd expect it to cache things if possible. Or even a more explicit -

cached\_driver\_format() - but it would require an explanation that it's security-related permament record, rather than a pure performance improving cache.

resolve\_driver\_format() - doesn't imply a simple getter, but I'd expect it to cache things if possible. Or even a more explicit -
cached\_driver\_format() - but it would require an explanation that it's security-related permament record, rather than a pure performance improving cache.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-06: |  |  | [#45](/nova/%2Bbug/1221190/comments/45) |
| --- | --- | --- | --- |

I think either safe\_get\_driver\_format or resolve\_driver\_format is reasonable. I'll use one of those.

Nikola, if we do per-instance disks.info files, is disk.info.{instance\_uuid} okay?

I think either safe\_get\_driver\_format or resolve\_driver\_format is reasonable. I'll use one of those.
Nikola, if we do per-instance disks.info files, is disk.info.{instance\_uuid} okay?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2014-02-06: |  |  | [#46](/nova/%2Bbug/1221190/comments/46) |
| --- | --- | --- | --- |

I have the same thoughts as Nikola on this - when I proposed this idea, I was certainly thinking of disks.info being a per instance file, not global to the entire host. As Nikola says it gives us saner cleanup on VM delete if we can just rm the entire file and not worry about doing string manipulation of lines inside a shared file. It also avoids having to acquire any global lock to protect the file. If an instances disk.info file gets corrupted that's fairly harmless, but if we have a single global disks.info file and that's corrupted the impact is pretty bad. So I'd rather prefer a per-instance file

I have the same thoughts as Nikola on this - when I proposed this idea, I was certainly thinking of disks.info being a per instance file, not global to the entire host. As Nikola says it gives us saner cleanup on VM delete if we can just rm the entire file and not worry about doing string manipulation of lines inside a shared file. It also avoids having to acquire any global lock to protect the file. If an instances disk.info file gets corrupted that's fairly harmless, but if we have a single global disks.info file and that's corrupted the impact is pretty bad. So I'd rather prefer a per-instance file

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2014-02-06: |  |  | [#47](/nova/%2Bbug/1221190/comments/47) |
| --- | --- | --- | --- |

Oh one final think - I'm unclear whether things like RBD have any implications on this. eg if we're using RBD for images, do we still have a local directory where we can store this info file ? I guess all RBD volumes are assumed to be raw by nova and we don't (currently) do anything stupid like storing a qcow2 file inside an RBD volume. Nice to have confirmation that this at least doesn't cause any problems for RBD and similar drivers.

Oh one final think - I'm unclear whether things like RBD have any implications on this. eg if we're using RBD for images, do we still have a local directory where we can store this info file ? I guess all RBD volumes are assumed to be raw by nova and we don't (currently) do anything stupid like storing a qcow2 file inside an RBD volume. Nice to have confirmation that this at least doesn't cause any problems for RBD and similar drivers.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#48](/nova/%2Bbug/1221190/comments/48) |
| --- | --- | --- | --- |

David, so like Dan said - just stick it in the instance directory (where we keep disk overlays and libvirt.xml file etc) and call it disk.info, since each instance has it's own directiry anyway. Are there some permission issues with that?

David, so like Dan said - just stick it in the instance directory (where we keep disk overlays and libvirt.xml file etc) and call it disk.info, since each instance has it's own directiry anyway. Are there some permission issues with that?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2014-02-06: |  |  | [#49](/nova/%2Bbug/1221190/comments/49) |
| --- | --- | --- | --- |

Just make sure that the disk.info file is owned by root:root, or nova:nova - we explicitly don't want QEMU to be able to write to that file

Just make sure that the disk.info file is owned by root:root, or nova:nova - we explicitly don't want QEMU to be able to write to that file

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-10: |  |  | [#50](/nova/%2Bbug/1221190/comments/50) |
| --- | --- | --- | --- |

@Daniel: planning to propose a new version of that patch addressing the last comments ?

@Daniel: planning to propose a new version of that patch addressing the last comments ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-10: |  |  | [#51](/nova/%2Bbug/1221190/comments/51) |
| --- | --- | --- | --- |

err... I mean @David: ^

err... I mean @David: ^

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-10: |  |  | [#52](/nova/%2Bbug/1221190/comments/52) |
| --- | --- | --- | --- |

@Thierry, yes, new patch should be ready later today.

@Thierry, yes, new patch should be ready later today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-02-11: |  |  | [#53](/nova/%2Bbug/1221190/comments/53) |
| --- | --- | --- | --- |

Added Nova in title and the new affected version field.

Draft impact description #3 -

Title: Nova host data leak to vm instance in rescue mode.

Reporter: Stanislaw Pitucha (HP)

Products: Nova

Versions: 2013.1.1 to 2013.1.4 and 2013.2 versions up to 2013.2.1

Description:

Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Added Nova in title and the new affected version field.
Draft impact description #3 -
Title: Nova host data leak to vm instance in rescue mode.
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Versions: 2013.1.1 to 2013.1.4 and 2013.2 versions up to 2013.2.1
Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-11: |  |  | [#54](/nova/%2Bbug/1221190/comments/54) |
| --- | --- | --- | --- |

+1 for version 3 of impact description

+1 for version 3 of impact description

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-25: |  |  | [#55](/nova/%2Bbug/1221190/comments/55) |
| --- | --- | --- | --- |

* [patch attempt #2](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3996415/%2Bfiles/0001-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3996415)
  (21.0 KiB,
  text/plain)

New patch attached, incorporating all the review comments so far.

New patch attached, incorporating all the review comments so far.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-26: |  |  | [#56](/nova/%2Bbug/1221190/comments/56) |
| --- | --- | --- | --- |

@nova-coresec, please review on bug

@nova-coresec, please review on bug

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-02-26: |  |  | [#57](/nova/%2Bbug/1221190/comments/57) |
| --- | --- | --- | --- |

The fix seems sound and incorporates the feedback from Nikola and Daniel. I have a minor issue with one part but overall the fix is good.

The resolve\_driver\_format method works as if there could be multiple lines within a disk.info file. Since the file is now per instance I don't see why it would need to be opened in append mode, or need to iterate over multiple lines in the file. But this is cleanup and not relevant to the security fix aspect of the patch.

The fix seems sound and incorporates the feedback from Nikola and Daniel. I have a minor issue with one part but overall the fix is good.
The resolve\_driver\_format method works as if there could be multiple lines within a disk.info file. Since the file is now per instance I don't see why it would need to be opened in append mode, or need to iterate over multiple lines in the file. But this is cleanup and not relevant to the security fix aspect of the patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-26: |  |  | [#58](/nova/%2Bbug/1221190/comments/58) |
| --- | --- | --- | --- |

Good point Andrew. I didn't change that code when we switched from a one-file multiple-lines model to a one-file-per-instance model. I will change it and submit another patch. (It's a small change.)

Good point Andrew. I didn't change that code when we switched from a one-file multiple-lines model to a one-file-per-instance model. I will change it and submit another patch. (It's a small change.)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-26: |  |  | [#59](/nova/%2Bbug/1221190/comments/59) |
| --- | --- | --- | --- |

* [third attempt at a patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3998421/%2Bfiles/0002-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3998421)
  (22.8 KiB,
  text/plain)

Here's a patch, with resolve\_driver\_format updated to only read one line (and catch the exception if json is invalid). Also some small test tweaks.

Here's a patch, with resolve\_driver\_format updated to only read one line (and catch the exception if json is invalid). Also some small test tweaks.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-27: |  |  | [#60](/nova/%2Bbug/1221190/comments/60) |
| --- | --- | --- | --- |

Looks awesome - one nit tho.

We are currently relying on umask being set properly since the permissions will be set by open() builtin, and then we are just chowning it, meaning that if umask allows for world writable files, chowning will make no difference. Not a huge deal but also really easy to fix (not realy on umask when creating see python's os.open). What do you think?

Looks awesome - one nit tho.
We are currently relying on umask being set properly since the permissions will be set by open() builtin, and then we are just chowning it, meaning that if umask allows for world writable files, chowning will make no difference. Not a huge deal but also really easy to fix (not realy on umask when creating see python's os.open). What do you think?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-27: |  |  | [#61](/nova/%2Bbug/1221190/comments/61) |
| --- | --- | --- | --- |

* [0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3999458/%2Bfiles/0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3999458)
  (23.0 KiB,
  text/plain)

Nikola, thanks for the review. Attached is a revised patch that does os.open for mode 644, when writing a disk.info file.

Nikola, thanks for the review. Attached is a revised patch that does os.open for mode 644, when writing a disk.info file.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-28: |  |  | [#62](/nova/%2Bbug/1221190/comments/62) |
| --- | --- | --- | --- |

thanks for addressing the comment David.

I am +2 on the patch. Will also try it later and report back.

thanks for addressing the comment David.
I am +2 on the patch. Will also try it later and report back.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-03: |  |  | [#63](/nova/%2Bbug/1221190/comments/63) |
| --- | --- | --- | --- |

nova-core, another +2 on that patch would be nice.

Also it will be applied as-is to havana, so let us know if the change of behavior looks acceptable to you there.

nova-core, another +2 on that patch would be nice.
Also it will be applied as-is to havana, so let us know if the change of behavior looks acceptable to you there.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-03: |  |  | [#64](/nova/%2Bbug/1221190/comments/64) |
| --- | --- | --- | --- |

Adding Alan and Adam for the stable maint check on the proposed patch

Adding Alan and Adam for the stable maint check on the proposed patch

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-03-04: |  |  | [#65](/nova/%2Bbug/1221190/comments/65) |
| --- | --- | --- | --- |

I'm +2 on the patch as well. Looks good, thanks!

I'm +2 on the patch as well. Looks good, thanks!

[David Ripton (dripton)](https://launchpad.net/~dripton)
on 2014-03-10

| Changed in nova: | |
| --- | --- |
| **milestone**: | none → icehouse-rc1 |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-03-10: |  |  | [#66](/nova/%2Bbug/1221190/comments/66) |
| --- | --- | --- | --- |

Seems this no longer cleanly applies to master :(

Would be awesome to have an updated version and the stable/havana fix (I can do the backport too). Would love to see us agree on ago public that so that this is in Icehouse rc1 if at all possible.

Seems this no longer cleanly applies to master :(
Would be awesome to have an updated version and the stable/havana fix (I can do the backport too). Would love to see us agree on ago public that so that this is in Icehouse rc1 if at all possible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-10: |  |  | [#67](/nova/%2Bbug/1221190/comments/67) |
| --- | --- | --- | --- |

* [rebased patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4017090/%2Bfiles/0004-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4017090)
  (22.8 KiB,
  text/plain)

Here's an rebased patch. (git was able to resolve the merge conflicts without manual intervention.)

I got Russell's approval before adding this to the icehouse-rc1 milestone earlier today.

Here's an rebased patch. (git was able to resolve the merge conflicts without manual intervention.)
I got Russell's approval before adding this to the icehouse-rc1 milestone earlier today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-10: |  |  | [#68](/nova/%2Bbug/1221190/comments/68) |
| --- | --- | --- | --- |

Thank you David,

Do you know if this will also be the backport for Havana ?

Thank you David,
Do you know if this will also be the backport for Havana ?

| **no longer affects**: | nova/grizzly |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-10: |  |  | [#69](/nova/%2Bbug/1221190/comments/69) |
| --- | --- | --- | --- |

Tristan, that patch does not apply cleanly to stable/havana. I'm happy to backport it though. (Preferably after it has final approval for Icehouse, so I don't have to do the backport multiple times.)

Tristan, that patch does not apply cleanly to stable/havana. I'm happy to backport it though. (Preferably after it has final approval for Icehouse, so I don't have to do the backport multiple times.)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-03-11: |  |  | [#70](/nova/%2Bbug/1221190/comments/70) |
| --- | --- | --- | --- |

The rebased patch applies cleanly to master. I'm still +2 for it.

The rebased patch applies cleanly to master. I'm still +2 for it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-03-11: |  |  | [#71](/nova/%2Bbug/1221190/comments/71) |
| --- | --- | --- | --- |

+2 as well!

+2 as well!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-12: |  |  | [#72](/nova/%2Bbug/1221190/comments/72) |
| --- | --- | --- | --- |

Thank you guys, this is an updated Affect line for impact description of comment #53:

Versions: 2013.2 versions up to 2013.2.2

Sending CVE requests now

Thank you guys, this is an updated Affect line for impact description of comment #53:
Versions: 2013.2 versions up to 2013.2.2
Sending CVE requests now

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-13

| **summary**: | - Image format not enforced when using rescue+ Image format not enforced when using rescue (CVE-2014-0134) |
| --- | --- |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-03-17

| Changed in ossa: | |
| --- | --- |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-17:  [**Re: Image format not enforced when using rescue (CVE-2014-0134)**](/nova/%2Bbug/1221190/comments/73) |  |  | [#73](/nova/%2Bbug/1221190/comments/73) |
| --- | --- | --- | --- |

@dripton Could you attach an havana backport of your patch please ? Once the backport is reviewed, we will then schedule publication.

Thanks you in advance!

@dripton Could you attach an havana backport of your patch please ? Once the backport is reviewed, we will then schedule publication.
Thanks you in advance!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-18: |  |  | [#74](/nova/%2Bbug/1221190/comments/74) |
| --- | --- | --- | --- |

* [Version of the patch against stable/havana](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4029445/%2Bfiles/0005-Persist-image-format-to-a-file-to-prevent-attacks-ba.havana.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4029445)
  (22.9 KiB,
  text/plain)

@Tristan, attached is a version of the patch against stable/havana. It required a manual conflict resolution because the snapshot\_delete method was removed in icehouse but is still there in havana. Other than that, the code is identical.

@Tristan, attached is a version of the patch against stable/havana. It required a manual conflict resolution because the snapshot\_delete method was removed in icehouse but is still there in havana. Other than that, the code is identical.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-03-18: |  |  | [#75](/nova/%2Bbug/1221190/comments/75) |
| --- | --- | --- | --- |

I confirmed that the stable/havana patch and master patch from [https://bugs.launchpad.net/nova/+bug/1221190/comments/67](https://bugs.launchpad.net/nova/%2Bbug/1221190/comments/67) both apply cleanly and look ready to go.

I confirmed that the stable/havana patch and master patch from https://bugs.launchpad.net/nova/+bug/1221190/comments/67 both apply cleanly and look ready to go.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-18: |  |  | [#76](/nova/%2Bbug/1221190/comments/76) |
| --- | --- | --- | --- |

Thank you very much guys, the pre-OSSA have been sent.

Proposed public disclosure date/time:

2014-03-25 15:00 UTC

Thank you very much guys, the pre-OSSA have been sent.
Proposed public disclosure date/time:
2014-03-25 15:00 UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-03-19: |  |  | [#77](/nova/%2Bbug/1221190/comments/77) |
| --- | --- | --- | --- |

This date seems reasonable for me - I will be sure to +A the patch once it hits the gerrit.

This date seems reasonable for me - I will be sure to +A the patch once it hits the gerrit.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-19: |  |  | [#78](/nova/%2Bbug/1221190/comments/78) |
| --- | --- | --- | --- |

@ndipanov, That is very much appreciated. Thanks!

@dripton would you be available to actually push the patch to gerrit at disclosure date ? Else I can take care of that.

@ndipanov, That is very much appreciated. Thanks!
@dripton would you be available to actually push the patch to gerrit at disclosure date ? Else I can take care of that.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-19: |  |  | [#79](/nova/%2Bbug/1221190/comments/79) |
| --- | --- | --- | --- |

Tristan, I'll be available to put to Gerrit on disclosure date.

Tristan, I'll be available to put to Gerrit on disclosure date.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-19: |  |  | [#80](/nova/%2Bbug/1221190/comments/80) |
| --- | --- | --- | --- |

Setting task to FixCommitted since we are in pre-OSSA stage

Setting task to FixCommitted since we are in pre-OSSA stage

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-03-25

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → In Progress |

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-25

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-27: |  |  | [#81](/nova/%2Bbug/1221190/comments/81) |
| --- | --- | --- | --- |

Master patch @ <https://review.openstack.org/#/c/82840>

Stable/Havana patch @ <https://review.openstack.org/#/c/82841>

Master patch @ https://review.openstack.org/#/c/82840
Stable/Havana patch @ https://review.openstack.org/#/c/82841

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-27

| **summary**: | - Image format not enforced when using rescue (CVE-2014-0134)+ [0SSA 2014-009] Image format not enforced when using rescue+ (CVE-2014-0134) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-03-27:  [**Fix merged to nova (master)**](/nova/%2Bbug/1221190/comments/82) |  |  | [#82](/nova/%2Bbug/1221190/comments/82) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/82840>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=dc8de426066969a3f0624fdc2a7b29371a2d55bf>

Submitter: Jenkins

Branch: master

commit dc8de426066969a3f0624fdc2a7b29371a2d55bf

Author: David Ripton <email address hidden>

Date: Tue Jan 28 16:38:51 2014 -0500

Persist image format to a file, to prevent attacks based on changing it

The attack is based on creating a raw image that looks like a qcow2

    image, and taking advantage of the code that used 'qemu-img info' to

    autodetect the image format.

Now we store the image format to a 'disk.info' file, for Qcow2 and Raw

    images, and only autodetect for images that have never been written to

    that file.

SecurityImpact

Co-authored-by: Nikola Dipanov <email address hidden>

    Closes-bug: #1221190

    Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a

Reviewed: https://review.openstack.org/82840
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=dc8de426066969a3f0624fdc2a7b29371a2d55bf
Submitter: Jenkins
Branch: master
commit dc8de426066969a3f0624fdc2a7b29371a2d55bf
Author: David Ripton <dripton@redhat.com>
Date: Tue Jan 28 16:38:51 2014 -0500
Persist image format to a file, to prevent attacks based on changing it
The attack is based on creating a raw image that looks like a qcow2
image, and taking advantage of the code that used 'qemu-img info' to
autodetect the image format.
Now we store the image format to a 'disk.info' file, for Qcow2 and Raw
images, and only autodetect for images that have never been written to
that file.
SecurityImpact
Co-authored-by: Nikola Dipanov <ndipanov@redhat.com>
Closes-bug: #1221190
Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-03-27:  [**Fix merged to nova (stable/havana)**](/nova/%2Bbug/1221190/comments/83) |  |  | [#83](/nova/%2Bbug/1221190/comments/83) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/82841>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=25e761acd56d4c820273fc0245ada06c500c1637>

Submitter: Jenkins

Branch: stable/havana

commit 25e761acd56d4c820273fc0245ada06c500c1637

Author: David Ripton <email address hidden>

Date: Tue Jan 28 16:38:51 2014 -0500

Persist image format to a file, to prevent attacks based on changing it

The attack is based on creating a raw image that looks like a qcow2

    image, and taking advantage of the code that used 'qemu-img info' to

    autodetect the image format.

Now we store the image format to a 'disk.info' file, for Qcow2 and Raw

    images, and only autodetect for images that have never been written to

    that file.

SecurityImpact

Conflicts:

     nova/virt/libvirt/imagebackend.py

Manual tweaks to some mocking in test\_imagebackend.py

Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a

    Co-authored-by: Nikola Dipanov <email address hidden>

    Closes-bug: #1221190

Reviewed: https://review.openstack.org/82841
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=25e761acd56d4c820273fc0245ada06c500c1637
Submitter: Jenkins
Branch: stable/havana
commit 25e761acd56d4c820273fc0245ada06c500c1637
Author: David Ripton <dripton@redhat.com>
Date: Tue Jan 28 16:38:51 2014 -0500
Persist image format to a file, to prevent attacks based on changing it
The attack is based on creating a raw image that looks like a qcow2
image, and taking advantage of the code that used 'qemu-img info' to
autodetect the image format.
Now we store the image format to a 'disk.info' file, for Qcow2 and Raw
images, and only autodetect for images that have never been written to
that file.
SecurityImpact
Conflicts:
nova/virt/libvirt/imagebackend.py
Manual tweaks to some mocking in test\_imagebackend.py
Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a
Co-authored-by: Nikola Dipanov <ndipanov@redhat.com>
Closes-bug: #1221190

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-27

| Changed in ossa: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-03-31

| Changed in nova: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-04-11:  [**Fix merged to nova (master)**](/nova/%2Bbug/1221190/comments/84) |  |  | [#84](/nova/%2Bbug/1221190/comments/84) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/86353>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=d416f4310bb946b4b127201ec3c37e530d988714>

Submitter: Jenkins

Branch: master

commit d416f4310bb946b4b127201ec3c37e530d988714

Author: Nikola Dipanov <email address hidden>

Date: Wed Apr 9 15:50:20 2014 +0200

Avoid the possibility of truncating disk info file

Commit dc8de42 makes nova persist image format to a file to avoid

    attacks based on changing it later. However the way it was implemented

    leaves a small window of opportunity for the file to be truncated before

    it gets written back to effectively making it possible for data to get

    lost leaving us with a potential problem next time it is attempted to be

    read.

This patch changes the way file is updated to be atomic, thus closing

    the race window (and also removes the chown that we did not really

    need).

It is worth noting that a better solution to this would be

    to allow the code calling the imagebackend to write the file (once!)

    and make it impossible to update after the boot process is done. This

    approach would require more refactoring of the libvirt driver code, and

    may be done in the future.

Partial-bug: #1221190

    Change-Id: Ia1b073f38e096989f34d1774a12a1b4151773fc7

Reviewed: https://review.openstack.org/86353
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=d416f4310bb946b4b127201ec3c37e530d988714
Submitter: Jenkins
Branch: master
commit d416f4310bb946b4b127201ec3c37e530d988714
Author: Nikola Dipanov <ndipanov@redhat.com>
Date: Wed Apr 9 15:50:20 2014 +0200
Avoid the possibility of truncating disk info file
Commit dc8de42 makes nova persist image format to a file to avoid
attacks based on changing it later. However the way it was implemented
leaves a small window of opportunity for the file to be truncated before
it gets written back to effectively making it possible for data to get
lost leaving us with a potential problem next time it is attempted to be
read.
This patch changes the way file is updated to be atomic, thus closing
the race window (and also removes the chown that we did not really
need).
It is worth noting that a better solution to this would be
to allow the code calling the imagebackend to write the file (once!)
and make it impossible to update after the boot process is done. This
approach would require more refactoring of the libvirt driver code, and
may be done in the future.
Partial-bug: #1221190
Change-Id: Ia1b073f38e096989f34d1774a12a1b4151773fc7

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-04-11:  [**Fix proposed to nova (stable/havana)**](/nova/%2Bbug/1221190/comments/85) |  |  | [#85](/nova/%2Bbug/1221190/comments/85) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/havana

Review: <https://review.openstack.org/86895>

Fix proposed to branch: stable/havana
Review: https://review.openstack.org/86895

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-04-17

| Changed in nova: | |
| --- | --- |
| **milestone**: | icehouse-rc1 → 2014.1 |

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/1221190/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [patch attempt #2](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3996415/%2Bfiles/0001-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3996415 "Change patch details")
* [third attempt at a patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3998421/%2Bfiles/0002-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3998421 "Change patch details")
* [0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3999458/%2Bfiles/0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3999458 "Change patch details")
* [rebased patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4017090/%2Bfiles/0004-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4017090 "Change patch details")
* [Version of the patch against stable/havana](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4029445/%2Bfiles/0005-Persist-image-format-to-a-file-to-prevent-attacks-ba.havana.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4029445 "Change patch details")

* [Add patch](/nova/%2Bbug/1221190/%2Baddcomment?field.patch=on)

## Bug attachments

* ["script" capture of the hack, starting with a clean host](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3827442/%2Bfiles/image_hack_typescript)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3827442 "Change attachment details")
* [patch vs. nova master for #1221190](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3970013/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3970013 "Change attachment details")

* [Add attachment](/nova/%2Bbug/1221190/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from answers.launchpad.net_c6f997e5_20250126_062056.html ===

[Log in / Register](https://answers.launchpad.net/nova/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* Answers

# Questions for OpenStack Compute (nova)

**Launchpad does not know where
OpenStack Compute (nova)
tracks support requests.**

OpenStack Compute (nova) questions are
tracked in:
[nova in Ubuntu](/ubuntu/%2Bsource/nova),
[python-openstack-compute in Ubuntu](/ubuntu/%2Bsource/python-openstack-compute).

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_62e960f5_20250126_062101.html ===

[Log in / Register](https://launchpad.net/~stanislaw-pitucha/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~stanislaw-pitucha)

## [Stanislaw Pitucha](https://launchpad.net/~stanislaw-pitucha)

* Overview
* [Code](https://code.launchpad.net/~stanislaw-pitucha)
* [Bugs](https://bugs.launchpad.net/~stanislaw-pitucha)
* [Blueprints](https://blueprints.launchpad.net/~stanislaw-pitucha)
* [Translations](https://translations.launchpad.net/~stanislaw-pitucha)
* [Answers](https://answers.launchpad.net/~stanislaw-pitucha)

* [Related packages](https://launchpad.net/~stanislaw-pitucha/%2Brelated-packages)
* [Related projects](https://launchpad.net/~stanislaw-pitucha/%2Brelated-projects)

## User information

Launchpad Id:
stanislaw-pitucha

Email:
[Log in](%2Blogin) for email information.

Member since:
2011-09-15

[![Icon of OpenStack Security SIG](https://launchpadlibrarian.net/203991792/os14.png "Member of OpenStack Security SIG")](/~openstack-ossg)
[![Icon of OpenStack Team](https://launchpadlibrarian.net/52313052/os14.png "Member of OpenStack Team")](/~openstack)

Languages:

English

Time zone:

UTC
(UTC+0000)

Karma:
[0](https://launchpad.net/~stanislaw-pitucha/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## [All memberships](https://launchpad.net/~stanislaw-pitucha/%2Bparticipation) Latest memberships

| [Bandit Core](/~bandit-core)  Joined on 2015-12-11 | |
| --- | --- |
| [Anchor Developers](/~anchor-dev)  Joined on 2015-06-04 | |
| [OpenStack Security SIG](/~openstack-ossg)  Joined on 2014-04-11 | |
| [OpenStack Contributors](/~openstack-cla)  Joined on 2012-08-02 | |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from www.openwall.com_edf6e898_20250125_053234.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](5) [[next>]](../../../2014/03/28/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <533460E6.6030009@enovance.com>
Date: Thu, 27 Mar 2014 18:33:26 +0100
From: Tristan Cacqueray <tristan.cacqueray@...vance.com>
To: oss-security@...ts.openwall.com
Subject: [OSSA 2014-009] Nova host data leak to vm instance in rescue mode
 (CVE-2014-0134)

OpenStack Security Advisory: 2014-009
CVE: CVE-2014-0134
Date: March 27, 2014
Title: Nova host data leak to vm instance in rescue mode.
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Versions: 2013.2 versions up to 2013.2.2

Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the
Nova instance rescue mode. By overwriting the disk inside an instance
with a malicious image and switching the instance to rescue mode, an
authenticated user would be able to leak an arbitrary file from the
compute host to the virtual instance. Note that the host file must be
readable by the libvirt/kvm context to be exposed. Only setups using
libvirt to spawn instance, and having "use_cow_images = False" in Nova
configuration are affected.

Icehouse (development branch) fix:
<https://review.openstack.org/82840>

Havana fix:
<https://review.openstack.org/82841>

Notes:
This fix will be included in the icehouse-rc1 development milestone and
in a future 2013.2.3 release.

References:
<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0134>
<https://launchpad.net/bugs/1221190>

--
Tristan Cacqueray
OpenStack Vulnerability Management Team

Download attachment "[signature.asc](6/1)" of type "application/pgp-signature" (556 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from translations.launchpad.net_13b83fdf_20250126_062059.html ===

[Log in / Register](https://translations.launchpad.net/nova/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* Translations
* [Answers](https://answers.launchpad.net/nova)

# Translation overview

[Help for translations](https://help.launchpad.net/Translations)

### Translation details

Launchpad currently recommends translating
[OpenStack Compute (nova) trunk series](/nova/trunk).

To see all the translation files that are waiting to be
imported, please look at
[OpenStack Compute (nova) import queue](/nova/%2Bimports).

### Permissions

[OpenStack Compute (nova)](https://launchpad.net/nova) is translated
with [Open](/%2Bhelp-translations/permissions-policies.html)
permissions.

### All translatable series

* [OpenStack Compute (nova) trunk series](/nova/trunk/%2Btranslations)
* [OpenStack Compute (nova) bexar series](/nova/bexar/%2Btranslations)
* [OpenStack Compute (nova) cactus series](/nova/cactus/%2Btranslations)

### All translatable distribution packages

* [nova source package in Plucky](/ubuntu/plucky/%2Bsources/nova/%2Btranslations)
* [nova source package in Oracular](/ubuntu/oracular/%2Bsources/nova/%2Btranslations)
* [nova source package in Noble](/ubuntu/noble/%2Bsources/nova/%2Btranslations)
* [nova source package in Mantic](/ubuntu/mantic/%2Bsources/nova/%2Btranslations)
* [nova source package in Lunar](/ubuntu/lunar/%2Bsources/nova/%2Btranslations)
* [nova source package in Kinetic](/ubuntu/kinetic/%2Bsources/nova/%2Btranslations)
* [nova source package in Jammy](/ubuntu/jammy/%2Bsources/nova/%2Btranslations)
* [nova source package in Impish](/ubuntu/impish/%2Bsources/nova/%2Btranslations)
* [nova source package in Hirsute](/ubuntu/hirsute/%2Bsources/nova/%2Btranslations)
* [nova source package in Groovy](/ubuntu/groovy/%2Bsources/nova/%2Btranslations)
* [nova source package in Focal](/ubuntu/focal/%2Bsources/nova/%2Btranslations)
* [nova source package in Eoan](/ubuntu/eoan/%2Bsources/nova/%2Btranslations)
* [nova source package in Disco](/ubuntu/disco/%2Bsources/nova/%2Btranslations)
* [nova source package in Cosmic](/ubuntu/cosmic/%2Bsources/nova/%2Btranslations)
* [nova source package in Bionic](/ubuntu/bionic/%2Bsources/nova/%2Btranslations)
* [nova source package in Artful](/ubuntu/artful/%2Bsources/nova/%2Btranslations)
* [nova source package in Zesty](/ubuntu/zesty/%2Bsources/nova/%2Btranslations)
* [nova source package in Yakkety](/ubuntu/yakkety/%2Bsources/nova/%2Btranslations)
* [nova source package in Xenial](/ubuntu/xenial/%2Bsources/nova/%2Btranslations)
* [nova source package in Wily](/ubuntu/wily/%2Bsources/nova/%2Btranslations)
* [nova source package in Vivid](/ubuntu/vivid/%2Bsources/nova/%2Btranslations)
* [nova source package in Utopic](/ubuntu/utopic/%2Bsources/nova/%2Btranslations)
* [nova source package in Trusty](/ubuntu/trusty/%2Bsources/nova/%2Btranslations)
* [nova source package in Saucy](/ubuntu/saucy/%2Bsources/nova/%2Btranslations)
* [nova source package in Raring](/ubuntu/raring/%2Bsources/nova/%2Btranslations)
* [nova source package in Quantal](/ubuntu/quantal/%2Bsources/nova/%2Btranslations)
* [nova source package in Precise](/ubuntu/precise/%2Bsources/nova/%2Btranslations)

## Translation for trunk

| Language | Status | Untranslated | Needs review | Last Changed |
| --- | --- | --- | --- | --- |
| [Afrikaans](/nova/trunk/%2Bpots/nova/af/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/af/%2Btranslate?show=untranslated) | 254 [254](/nova/trunk/%2Bpots/nova/af/%2Btranslate?show=new_suggestions) | 2022-09-12 03:14:23 UTC 2022-09-12 |
| [Albanian](/nova/trunk/%2Bpots/nova/sq/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/sq/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:19 UTC 2014-04-02 |
| [Arabic](/nova/trunk/%2Bpots/nova/ar/%2Btranslate) | 13 099.14  0.8563899868247694% translated  99.14361001317523% untranslated | 1505 [1505](/nova/trunk/%2Bpots/nova/ar/%2Btranslate?show=untranslated) | 0 0 | 2013-02-16 21:33:39 UTC 2013-02-16 |
| [Asturian](/nova/trunk/%2Bpots/nova/ast/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/ast/%2Btranslate?show=untranslated) | 0 0 | 2011-01-12 19:50:20 UTC 2011-01-12 |
| [Azerbaijani](/nova/trunk/%2Bpots/nova/az/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/az/%2Btranslate?show=untranslated) | 5 [5](/nova/trunk/%2Bpots/nova/az/%2Btranslate?show=new_suggestions) | 2013-04-03 14:46:02 UTC 2013-04-03 |
| [Basque](/nova/trunk/%2Bpots/nova/eu/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/eu/%2Btranslate?show=untranslated) | 0 0 | 2013-12-05 23:09:27 UTC 2013-12-05 |
| [Belarusian](/nova/trunk/%2Bpots/nova/be/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/be/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/be/%2Btranslate?show=new_suggestions) | 2020-05-03 16:45:18 UTC 2020-05-03 |
| [Bosnian](/nova/trunk/%2Bpots/nova/bs/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/bs/%2Btranslate?show=untranslated) | 914 [914](/nova/trunk/%2Bpots/nova/bs/%2Btranslate?show=new_suggestions) | 2012-01-19 20:22:10 UTC 2012-01-19 |
| [Brazilian Portuguese](/nova/trunk/%2Bpots/nova/pt_BR/%2Btranslate) | 815 046.31  53.689064558629774% translated  46.31093544137022% untranslated | 703 [703](/nova/trunk/%2Bpots/nova/pt_BR/%2Btranslate?show=untranslated) | 84 [84](/nova/trunk/%2Bpots/nova/pt_BR/%2Btranslate?show=new_suggestions) | 2013-02-06 03:43:42 UTC 2013-02-06 |
| [Catalan](/nova/trunk/%2Bpots/nova/ca/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ca/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:32 UTC 2013-06-07 |
| [Chechen](/nova/trunk/%2Bpots/nova/ce/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ce/%2Btranslate?show=untranslated) | 0 0 | 2014-08-13 08:13:14 UTC 2014-08-13 |
| [Chinese (Hong Kong)](/nova/trunk/%2Bpots/nova/zh_HK/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/zh_HK/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:31 UTC 2013-06-07 |
| [Chinese (Simplified)](/nova/trunk/%2Bpots/nova/zh_CN/%2Btranslate) | 1518 000.00  100.0% translated | 0 0 | 106 [106](/nova/trunk/%2Bpots/nova/zh_CN/%2Btranslate?show=new_suggestions) | 2013-06-05 09:20:38 UTC 2013-06-05 |
| [Chinese (Traditional)](/nova/trunk/%2Bpots/nova/zh_TW/%2Btranslate) | 294 080.63  19.367588932806324% translated  80.63241106719367% untranslated | 1224 [1224](/nova/trunk/%2Bpots/nova/zh_TW/%2Btranslate?show=untranslated) | 30 [30](/nova/trunk/%2Bpots/nova/zh_TW/%2Btranslate?show=new_suggestions) | 2012-08-15 07:46:05 UTC 2012-08-15 |
| [Croatian](/nova/trunk/%2Bpots/nova/hr/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/hr/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:33 UTC 2013-06-07 |
| [Czech](/nova/trunk/%2Bpots/nova/cs/%2Btranslate) | 1518 000.00  100.0% translated | 0 0 | 4 [4](/nova/trunk/%2Bpots/nova/cs/%2Btranslate?show=new_suggestions) | 2013-05-12 21:44:53 UTC 2013-05-12 |
| [Danish](/nova/trunk/%2Bpots/nova/da/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/da/%2Btranslate?show=untranslated) | 2 [2](/nova/trunk/%2Bpots/nova/da/%2Btranslate?show=new_suggestions) | 2011-01-15 21:46:58 UTC 2011-01-15 |
| [English (Australia)](/nova/trunk/%2Bpots/nova/en_AU/%2Btranslate) | 350 076.94  23.056653491436098% translated  76.9433465085639% untranslated | 1168 [1168](/nova/trunk/%2Bpots/nova/en_AU/%2Btranslate?show=untranslated) | 1166 [1166](/nova/trunk/%2Bpots/nova/en_AU/%2Btranslate?show=new_suggestions) | 2012-06-17 06:35:56 UTC 2012-06-17 |
| [English (Canada)](/nova/trunk/%2Bpots/nova/en_CA/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/en_CA/%2Btranslate?show=untranslated) | 0 0 | 2013-09-10 14:44:32 UTC 2013-09-10 |
| [English (United Kingdom)](/nova/trunk/%2Bpots/nova/en_GB/%2Btranslate) | 1518 000.00  100.0% translated | 0 0 | 10 [10](/nova/trunk/%2Bpots/nova/en_GB/%2Btranslate?show=new_suggestions) | 2013-06-04 15:36:12 UTC 2013-06-04 |
| [Filipino](/nova/trunk/%2Bpots/nova/fil/%2Btranslate) | 30 098.02  1.9762845849802373% translated  98.02371541501977% untranslated | 1488 [1488](/nova/trunk/%2Bpots/nova/fil/%2Btranslate?show=untranslated) | 0 0 | 2012-07-20 05:07:53 UTC 2012-07-20 |
| [French](/nova/trunk/%2Bpots/nova/fr/%2Btranslate) | 641 057.77  42.226613965744406% translated  57.7733860342556% untranslated | 877 [877](/nova/trunk/%2Bpots/nova/fr/%2Btranslate?show=untranslated) | 139 [139](/nova/trunk/%2Bpots/nova/fr/%2Btranslate?show=new_suggestions) | 2013-03-04 16:32:33 UTC 2013-03-04 |
| [Galician](/nova/trunk/%2Bpots/nova/gl/%2Btranslate) | 97 093.61  6.389986824769434% translated  93.61001317523056% untranslated | 1421 [1421](/nova/trunk/%2Bpots/nova/gl/%2Btranslate?show=untranslated) | 5 [5](/nova/trunk/%2Bpots/nova/gl/%2Btranslate?show=new_suggestions) | 2013-07-10 23:58:13 UTC 2013-07-10 |
| [German](/nova/trunk/%2Bpots/nova/de/%2Btranslate) | 1094 027.93  72.06851119894598% translated  27.931488801054016% untranslated | 424 [424](/nova/trunk/%2Bpots/nova/de/%2Btranslate?show=untranslated) | 31 [31](/nova/trunk/%2Bpots/nova/de/%2Btranslate?show=new_suggestions) | 2013-07-10 09:57:58 UTC 2013-07-10 |
| [Greek](/nova/trunk/%2Bpots/nova/el/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/el/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:24 UTC 2014-04-02 |
| [Hebrew](/nova/trunk/%2Bpots/nova/he/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/he/%2Btranslate?show=untranslated) | 0 0 | 2014-03-07 06:39:29 UTC 2014-03-07 |
| [Hindi](/nova/trunk/%2Bpots/nova/hi/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/hi/%2Btranslate?show=untranslated) | 0 0 | 2013-09-09 20:15:29 UTC 2013-09-09 |
| [Hungarian](/nova/trunk/%2Bpots/nova/hu/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/hu/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:34 UTC 2013-06-07 |
| [Indonesian](/nova/trunk/%2Bpots/nova/id/%2Btranslate) | 1166 023.19  76.81159420289855% translated  23.18840579710145% untranslated | 352 [352](/nova/trunk/%2Bpots/nova/id/%2Btranslate?show=untranslated) | 4 [4](/nova/trunk/%2Bpots/nova/id/%2Btranslate?show=new_suggestions) | 2013-06-12 06:23:30 UTC 2013-06-12 |
| [Italian](/nova/trunk/%2Bpots/nova/it/%2Btranslate) | 399 073.72  26.284584980237153% translated  73.71541501976284% untranslated | 1119 [1119](/nova/trunk/%2Bpots/nova/it/%2Btranslate?show=untranslated) | 3 [3](/nova/trunk/%2Bpots/nova/it/%2Btranslate?show=new_suggestions) | 2013-04-12 14:24:26 UTC 2013-04-12 |
| [Japanese](/nova/trunk/%2Bpots/nova/ja/%2Btranslate) | 526 065.35  34.65085638998682% translated  65.34914361001317% untranslated | 992 [992](/nova/trunk/%2Bpots/nova/ja/%2Btranslate?show=untranslated) | 4 [4](/nova/trunk/%2Bpots/nova/ja/%2Btranslate?show=new_suggestions) | 2012-06-17 06:26:26 UTC 2012-06-17 |
| [Kabyle](/nova/trunk/%2Bpots/nova/kab/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/kab/%2Btranslate?show=untranslated) | 0 0 | 2020-09-26 09:29:19 UTC 2020-09-26 |
| [Kannada](/nova/trunk/%2Bpots/nova/kn/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/kn/%2Btranslate?show=untranslated) | 0 0 | 2013-10-03 20:33:34 UTC 2013-10-03 |
| [Khmer](/nova/trunk/%2Bpots/nova/km/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/km/%2Btranslate?show=untranslated) | 12 [12](/nova/trunk/%2Bpots/nova/km/%2Btranslate?show=new_suggestions) | 2013-12-05 23:09:30 UTC 2013-12-05 |
| [Korean](/nova/trunk/%2Bpots/nova/ko/%2Btranslate) | 133 091.24  8.761528326745719% translated  91.23847167325428% untranslated | 1385 [1385](/nova/trunk/%2Bpots/nova/ko/%2Btranslate?show=untranslated) | 0 0 | 2012-08-18 04:14:44 UTC 2012-08-18 |
| [Latgalian](/nova/trunk/%2Bpots/nova/ltg/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ltg/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/ltg/%2Btranslate?show=new_suggestions) | 2013-12-03 08:45:58 UTC 2013-12-03 |
| [Latvian](/nova/trunk/%2Bpots/nova/lv/%2Btranslate) | 5 099.67  0.32938076416337286% translated  99.67061923583663% untranslated | 1513 [1513](/nova/trunk/%2Bpots/nova/lv/%2Btranslate?show=untranslated) | 0 0 | 2013-03-07 16:14:28 UTC 2013-03-07 |
| [Malay](/nova/trunk/%2Bpots/nova/ms/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ms/%2Btranslate?show=untranslated) | 406 [406](/nova/trunk/%2Bpots/nova/ms/%2Btranslate?show=new_suggestions) | 2012-06-13 09:15:03 UTC 2012-06-13 |
| [Mari (Meadow)](/nova/trunk/%2Bpots/nova/mhr/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/mhr/%2Btranslate?show=untranslated) | 3 [3](/nova/trunk/%2Bpots/nova/mhr/%2Btranslate?show=new_suggestions) | 2013-11-05 08:44:17 UTC 2013-11-05 |
| [Nepali](/nova/trunk/%2Bpots/nova/ne/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ne/%2Btranslate?show=untranslated) | 0 0 | 2013-10-03 20:33:29 UTC 2013-10-03 |
| [Norwegian Bokmal](/nova/trunk/%2Bpots/nova/nb/%2Btranslate) | 74 095.13  4.874835309617918% translated  95.12516469038208% untranslated | 1444 [1444](/nova/trunk/%2Bpots/nova/nb/%2Btranslate?show=untranslated) | 0 0 | 2012-03-13 11:36:56 UTC 2012-03-13 |
| [Occitan (post 1500)](/nova/trunk/%2Bpots/nova/oc/%2Btranslate) | 16 098.95  1.0540184453227932% translated  98.9459815546772% untranslated | 1502 [1502](/nova/trunk/%2Bpots/nova/oc/%2Btranslate?show=untranslated) | 394 [394](/nova/trunk/%2Bpots/nova/oc/%2Btranslate?show=new_suggestions) | 2011-11-17 07:23:06 UTC 2011-11-17 |
| [Persian](/nova/trunk/%2Bpots/nova/fa/%2Btranslate) | 14 099.08  0.922266139657444% translated  99.07773386034255% untranslated | 1504 [1504](/nova/trunk/%2Bpots/nova/fa/%2Btranslate?show=untranslated) | 0 0 | 2012-09-18 11:44:07 UTC 2012-09-18 |
| [Polish](/nova/trunk/%2Bpots/nova/pl/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/pl/%2Btranslate?show=untranslated) | 0 0 | 2012-09-04 20:24:42 UTC 2012-09-04 |
| [Portuguese](/nova/trunk/%2Bpots/nova/pt/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/pt/%2Btranslate?show=untranslated) | 8 [8](/nova/trunk/%2Bpots/nova/pt/%2Btranslate?show=new_suggestions) | 2013-06-07 09:16:30 UTC 2013-06-07 |
| [Romanian](/nova/trunk/%2Bpots/nova/ro/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/ro/%2Btranslate?show=untranslated) | 4 [4](/nova/trunk/%2Bpots/nova/ro/%2Btranslate?show=new_suggestions) | 2013-03-03 09:38:48 UTC 2013-03-03 |
| [Russian](/nova/trunk/%2Bpots/nova/ru/%2Btranslate) | 1307 013.90  86.10013175230566% translated  13.899868247694336% untranslated | 211 [211](/nova/trunk/%2Bpots/nova/ru/%2Btranslate?show=untranslated) | 15 [15](/nova/trunk/%2Bpots/nova/ru/%2Btranslate?show=new_suggestions) | 2013-05-21 06:50:11 UTC 2013-05-21 |
| [Serbian](/nova/trunk/%2Bpots/nova/sr/%2Btranslate) | 1 099.93  0.06587615283267458% translated  99.93412384716733% untranslated | 1517 [1517](/nova/trunk/%2Bpots/nova/sr/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:24 UTC 2014-04-02 |
| [Slovak](/nova/trunk/%2Bpots/nova/sk/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/sk/%2Btranslate?show=untranslated) | 6 [6](/nova/trunk/%2Bpots/nova/sk/%2Btranslate?show=new_suggestions) | 2013-09-09 20:15:25 UTC 2013-09-09 |
| [Spanish](/nova/trunk/%2Bpots/nova/es/%2Btranslate) | 1517 000.07  99.93412384716733% translated  0.06587615283267458% untranslated | 1 [1](/nova/trunk/%2Bpots/nova/es/%2Btranslate?show=untranslated) | 80 [80](/nova/trunk/%2Bpots/nova/es/%2Btranslate?show=new_suggestions) | 2013-07-09 23:15:49 UTC 2013-07-09 |
| [Swedish](/nova/trunk/%2Bpots/nova/sv/%2Btranslate) | 20 098.68  1.3175230566534915% translated  98.68247694334651% untranslated | 1498 [1498](/nova/trunk/%2Bpots/nova/sv/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/sv/%2Btranslate?show=new_suggestions) | 2013-01-15 20:08:01 UTC 2013-01-15 |
| [Tagalog](/nova/trunk/%2Bpots/nova/tl/%2Btranslate) | 6 099.60  0.3952569169960474% translated  99.60474308300395% untranslated | 1512 [1512](/nova/trunk/%2Bpots/nova/tl/%2Btranslate?show=untranslated) | 0 0 | 2011-08-23 11:21:43 UTC 2011-08-23 |
| [Tajik](/nova/trunk/%2Bpots/nova/tg/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/tg/%2Btranslate?show=untranslated) | 0 0 | 2020-07-23 06:12:18 UTC 2020-07-23 |
| [Tamil](/nova/trunk/%2Bpots/nova/ta/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ta/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:25 UTC 2014-04-02 |
| [Thai](/nova/trunk/%2Bpots/nova/th/%2Btranslate) | 5 099.67  0.32938076416337286% translated  99.67061923583663% untranslated | 1513 [1513](/nova/trunk/%2Bpots/nova/th/%2Btranslate?show=untranslated) | 0 0 | 2012-05-27 00:06:52 UTC 2012-05-27 |
| [Tibetan](/nova/trunk/%2Bpots/nova/bo/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/bo/%2Btranslate?show=untranslated) | 0 0 | 2019-12-12 01:59:05 UTC 2019-12-12 |
| [Turkish](/nova/trunk/%2Bpots/nova/tr/%2Btranslate) | 28 098.16  1.844532279314888% translated  98.15546772068511% untranslated | 1490 [1490](/nova/trunk/%2Bpots/nova/tr/%2Btranslate?show=untranslated) | 43 [43](/nova/trunk/%2Bpots/nova/tr/%2Btranslate?show=new_suggestions) | 2013-03-14 06:55:20 UTC 2013-03-14 |
| [Ukrainian](/nova/trunk/%2Bpots/nova/uk/%2Btranslate) | 19 098.75  1.251646903820817% translated  98.74835309617919% untranslated | 1499 [1499](/nova/trunk/%2Bpots/nova/uk/%2Btranslate?show=untranslated) | 391 [391](/nova/trunk/%2Bpots/nova/uk/%2Btranslate?show=new_suggestions) | 2011-08-23 11:21:35 UTC 2011-08-23 |
| [Urdu](/nova/trunk/%2Bpots/nova/ur/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ur/%2Btranslate?show=untranslated) | 0 0 | 2013-12-05 23:09:34 UTC 2013-12-05 |
| [Uyghur](/nova/trunk/%2Bpots/nova/ug/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ug/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/ug/%2Btranslate?show=new_suggestions) | 2012-03-18 09:35:05 UTC 2012-03-18 |

[ [Change your preferred languages...](/%2Beditmylanguages)
—
View all languages
]

![Key to this table: “Unchanged” means](/@@/green-bar)
Translated

![and “untranslated” means just that,](/@@/red-bar)
Untranslated

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from www.ubuntu.com_c2daf951_20250125_053235.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-2247-1: OpenStack Nova vulnerabilities

17 June 2014

Several security issues were fixed in OpenStack Nova.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)
* [Ubuntu 13.10](/security/notices?release=saucy)
* [Ubuntu 12.04](/security/notices?release=precise)

## Packages

* [nova](/security/cves?package=nova) - OpenStack Compute cloud infrastructure

## Details

Darragh O'Reilly discovered that the Ubuntu packaging for OpenStack Nova

did not properly set up its sudo configuration. If a different flaw was

found in OpenStack Nova, this vulnerability could be used to escalate

privileges. This issue only affected Ubuntu 13.10 and Ubuntu 14.04 LTS.

([CVE-2013-1068](/security/CVE-2013-1068))

Bernhard M. Wiedemann and Pedraig Brady discovered that OpenStack Nova did

not properly verify the virtual size of a QCOW2 images. A remote

authenticated attacker could exploit this to create a denial of service via

disk consumption. This issue did not affect Ubuntu 14.04 LTS.

([CVE-2013-4463](/security/CVE-2013-4463), [CVE-2013-4469](/security/CVE-2013-4469))

JuanFra Rodriguez Cardoso discovered that OpenStack Nova did not enforce

SSL connections when Nova was configured to use QPid and qpid\_protocol is

set to 'ssl'. If a remote attacker were able to perform a machine-in-the-middle

attack, this flaw could be exploited to view sensitive information. Ubuntu

does not use QPid with Nova by default. This issue did not affect Ubuntu

14.04 LTS. ([CVE-2013-6491](/security/CVE-2013-6491))

Loganathan Parthipan discovered that OpenStack Nova did not properly create

expected files during KVM live block migration. A remote authenticated

attacker could exploit this to obtain root disk snapshot contents via

ephemeral storage. This issue did not affect Ubuntu 14.04 LTS.

([CVE-2013-7130](/security/CVE-2013-7130))

Stanislaw Pitucha discovered that OpenStack Nova did not enforce the image

format when rescuing an instance. A remote authenticated attacker could

exploit this to read host files. In the default installation, attackers

would be isolated by the libvirt guest AppArmor profile. This issue only

affected Ubuntu 13.10. ([CVE-2014-0134](/security/CVE-2014-0134))

Mark Heckmann discovered that OpenStack Nova did not enforce RBAC policy

when adding security group rules via the EC2 API. A remote authenticated

user could exploit this to gain unintended access to this API. This issue

only affected Ubuntu 13.10. ([CVE-2014-0167](/security/CVE-2014-0167))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [python-nova](https://launchpad.net/ubuntu/%2Bsource/nova)
  -
  [1:2014.1-0ubuntu1.2](https://launchpad.net/ubuntu/%2Bsource/nova/1%3A2014.1-0ubuntu1.2)

##### Ubuntu 13.10

* [python-nova](https://launchpad.net/ubuntu/%2Bsource/nova)
  -
  [1:2013.2.3-0ubuntu1.2](https://launchpad.net/ubuntu/%2Bsource/nova/1%3A2013.2.3-0ubuntu1.2)

##### Ubuntu 12.04

* [python-nova](https://launchpad.net/ubuntu/%2Bsource/nova)
  -
  [2012.1.3+stable-20130423-e52e6912-0ubuntu1.4](https://launchpad.net/ubuntu/%2Bsource/nova/2012.1.3%2Bstable-20130423-e52e6912-0ubuntu1.4)

In general, a standard system update will make all the necessary changes.

## References

* [CVE-2013-1068](/security/CVE-2013-1068)
* [CVE-2013-4463](/security/CVE-2013-4463)
* [CVE-2013-4469](/security/CVE-2013-4469)
* [CVE-2013-6491](/security/CVE-2013-6491)
* [CVE-2013-7130](/security/CVE-2013-7130)
* [CVE-2014-0134](/security/CVE-2014-0134)
* [CVE-2014-0167](/security/CVE-2014-0167)

## Related notices

* [USN-2248-1](/security/notices/USN-2248-1)
* [USN-2208-1](/security/notices/USN-2208-1)
* [USN-2208-2](/security/notices/USN-2208-2)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from launchpad.net_358978c3_20250126_062055.html ===

[Log in / Register](https://launchpad.net/~hudson-openstack/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~hudson-openstack)

## [OpenStack Infra](https://launchpad.net/~hudson-openstack)

* Overview
* [Code](https://code.launchpad.net/~hudson-openstack)
* [Bugs](https://bugs.launchpad.net/~hudson-openstack)
* [Blueprints](https://blueprints.launchpad.net/~hudson-openstack)
* [Translations](https://translations.launchpad.net/~hudson-openstack)
* [Answers](https://answers.launchpad.net/~hudson-openstack)

* [Related packages](https://launchpad.net/~hudson-openstack/%2Brelated-packages)
* [Related projects](https://launchpad.net/~hudson-openstack/%2Brelated-projects)

## User information

Launchpad Id:
hudson-openstack

Email:
[Log in](%2Blogin) for email information.

Member since:
2010-07-14

[![Icon of Burrow](https://launchpadlibrarian.net/67728214/os14.png "Member of Burrow")](/~burrow)
[![Icon of Citrix OpenStack development team](https://launchpadlibrarian.net/64472709/Citrix%2014.png "Member of Citrix OpenStack development team")](/~citrix-openstack)
[![Icon of (deprecated) OpenStack PPA maintainers](https://launchpadlibrarian.net/87891894/ppa.gif "Member of (deprecated) OpenStack PPA maintainers")](/~openstack-ppa)
[![Icon of Designate Core](https://launchpadlibrarian.net/360468328/designate_14.jpg "Member of Designate Core")](/~designate-core)
[![Icon of Designate Drivers](https://launchpadlibrarian.net/360468067/designate_14.jpg "Member of Designate Drivers")](/~designate-drivers)
[![Icon of MidoNet Bugs](https://launchpadlibrarian.net/228074955/midonet_14x14.png "Member of MidoNet Bugs")](/~midonet-bugs)
[![Icon of Nova Bug Team](https://launchpadlibrarian.net/108832444/bug.gif "Member of Nova Bug Team")](/~nova-bugs)
[![Icon of Nova](https://launchpadlibrarian.net/52560219/os14.png "Member of Nova")](/~nova)
[![Icon of OpenStack Team](https://launchpadlibrarian.net/52313052/os14.png "Member of OpenStack Team")](/~openstack)

Languages:

English

OpenPGP keys:

72571ACC301E6FE900837F5CDF85501232EE128C

SSH keys:

[hudson@hudson](%2Bsshkeys)

[jenkins@vpcslave](%2Bsshkeys)

Time zone:

UTC
(UTC+0000)

Karma:
[6535](https://launchpad.net/~hudson-openstack/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## [All memberships](https://launchpad.net/~hudson-openstack/%2Bparticipation) Latest memberships

| [Compute Hyper-V Bugs](/~compute-hyperv-bugs)  Joined on 2019-08-28 | |
| --- | --- |
| [OS-Win Bugs](/~os-win-bugs)  Joined on 2019-08-28 | |
| [Networking Hyper-V Bugs](/~networking-hyperv-bugs)  Joined on 2019-08-28 | |
| [kolla-drivers](/~kolla-drivers)  Joined on 2019-05-20 | |
| [fixtures-git-bugs](/~fixtures-git-bugs)  Joined on 2018-03-25 | |

## [Recent activities](https://launchpad.net/~hudson-openstack/%2Bkarma) Most active in

| [StarlingX](/starlingx) |  |
| --- | --- |
| [kolla-ansible](/kolla-ansible) |  |
| [kolla](/kolla) |  |
| [kayobe](/kayobe) |  |
| [OpenStack Compute (nova)](/nova) |  |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_ea2260c8_20250126_062103.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# [0SSA 2014-009] Image format not enforced when using rescue (CVE-2014-0134)

Bug #1221190 reported by
[Stanislaw Pitucha](https://launchpad.net/~stanislaw-pitucha)
on 2013-09-05

[280](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [David Ripton](https://launchpad.net/~dripton) | [OpenStack Compute (nova) 2014.1 "icehouse"](https://launchpad.net/nova/%2Bmilestone/2014.1) |
|  | [Havana](https://bugs.launchpad.net/nova/havana) | Fix Released | High | [David Ripton](https://launchpad.net/~dripton) | [OpenStack Compute (nova) 2013.2.3](https://launchpad.net/nova/%2Bmilestone/2013.2.3) |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | High | [Tristan Cacqueray](https://launchpad.net/~tristan-cacqueray) |  |

### Bug Description

Rescuing an instance seems to guess the image format at some point. This allows reading files from the compute host via the qcow2 backing file.

Requirements:

- instances spawned using libvirt

- use\_cow\_images = False in the config

To reproduce:

1. Create a qcow2 file backed by the path you want to read from the compute host. (qemu-img create -f qcow2 -b /path/to/the/file $((1024\*1024)) evil.qcow2)

2. Spawn an instance, scp the file into it.

3. Overwrite the disk inside the instance (dd if=evil.qcow2 of=/dev/vda)

4. Shutdown the instance.

5. Rescue the instance

6. While in rescue mode, login and read /dev/vdb - beginning should be read from the qcow backing file

Libvirt description of the rescued instance will contain the entry for the second disk with attribute type="qcow2", even though it should be "raw" - same as the original instance.

Mitigating factors:

- files have to be readable by libvirt/kvm

- apparmor/selinux will limit the number of accessible files

- only full blocks of the file are visible in the rescued instance, so short files will not be available at all and long files are going to be truncated

Possible targets:

- private snapshots with known uuids, or instances of other tenants are a good target for this attack

Tags:

[libvirt](/nova/%2Bbugs?field.tag=libvirt)
[havana-backport-potential](/nova/%2Bbugs?field.tag=havana-backport-potential)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2013-09-05: |  |  | [#1](/nova/%2Bbug/1221190/comments/1) |
| --- | --- | --- | --- |

Added a new OSSA task, since this looks like it will probably require an advisory once addressed.

Added a new OSSA task, since this looks like it will probably require an advisory once addressed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-06: |  |  | [#2](/nova/%2Bbug/1221190/comments/2) |
| --- | --- | --- | --- |

Adding Russell and Padraig for a quick sanity-check

Adding Russell and Padraig for a quick sanity-check

| Changed in ossa: | |
| --- | --- |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-06: |  |  | [#3](/nova/%2Bbug/1221190/comments/3) |
| --- | --- | --- | --- |

> - files have to be readable by libvirt/kvm

> - apparmor/selinux will limit the number of accessible files

I don't believe those points help much, if at all.

Remember while guests are running as a KVM user, libvirtd which launches them is root. If the XML config tells libvirtd to give access to a particular file, libvirtd will do that and setup the selinux/apparmour policy to allow it too.

> - files have to be readable by libvirt/kvm
> - apparmor/selinux will limit the number of accessible files
I don't believe those points help much, if at all.
Remember while guests are running as a KVM user, libvirtd which launches them is root. If the XML config tells libvirtd to give access to a particular file, libvirtd will do that and setup the selinux/apparmour policy to allow it too.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2013-09-06: |  |  | [#4](/nova/%2Bbug/1221190/comments/4) |
| --- | --- | --- | --- |

Added Daniel Berrange as well, since this is related to the libvirt driver.

Added Daniel Berrange as well, since this is related to the libvirt driver.

[Russell Bryant (russellb)](https://launchpad.net/~russellb)
on 2013-09-09

| **tags**: | added: libvirt |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-10: |  |  | [#5](/nova/%2Bbug/1221190/comments/5) |
| --- | --- | --- | --- |

Russell, Daniel: so if I read this correctly this a a genuine flaw which can result in limited host data leakage. Likely targets would be ACL-protected files like /etc/shadow ?

Russell, Daniel: so if I read this correctly this a a genuine flaw which can result in limited host data leakage. Likely targets would be ACL-protected files like /etc/shadow ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-10: |  |  | [#6](/nova/%2Bbug/1221190/comments/6) |
| --- | --- | --- | --- |

Yes, at the very least, this is a serious information leakage flaw. This same issue has been given a CVE many times before in various virt projects. QEMU has the ability to merge a snapshot back into the base file - if there was a way to trigger this in openstack, the flaw would be even more serious - host data overwriting.

Yes, at the very least, this is a serious information leakage flaw. This same issue has been given a CVE many times before in various virt projects. QEMU has the ability to merge a snapshot back into the base file - if there was a way to trigger this in openstack, the flaw would be even more serious - host data overwriting.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-13: |  |  | [#7](/nova/%2Bbug/1221190/comments/7) |
| --- | --- | --- | --- |

Anyone working on a patch for this ? Does this also affect Grizzly/Folsom ?

Anyone working on a patch for this ? Does this also affect Grizzly/Folsom ?

| Changed in ossa: | |
| --- | --- |
| **importance**: | Undecided → Medium |
| **status**: | Incomplete → Confirmed |
| Changed in nova: | |
| **importance**: | Undecided → High |
| **milestone**: | none → havana-rc1 |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-13: |  |  | [#8](/nova/%2Bbug/1221190/comments/8) |
| --- | --- | --- | --- |

It goes all the way back to Diablo as far as I can tell. I'm not actively working on a patch, but will be happy to help with details / reproducing if needed.

It goes all the way back to Diablo as far as I can tell. I'm not actively working on a patch, but will be happy to help with details / reproducing if needed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-13: |  |  | [#9](/nova/%2Bbug/1221190/comments/9) |
| --- | --- | --- | --- |

Actually, I have not tried on the releases in between, so just to be sure, you can retest on Grizzly / Folsom. I don't have an environment to do that unfortunately.

Tested only Diablo and trunk.

Actually, I have not tried on the releases in between, so just to be sure, you can retest on Grizzly / Folsom. I don't have an environment to do that unfortunately.
Tested only Diablo and trunk.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-17: |  |  | [#10](/nova/%2Bbug/1221190/comments/10) |
| --- | --- | --- | --- |

I just tested trunk and didn't see the behaviour described in this report.

I have nova setup to use raw files

$ grep cow /etc/nova/nova.conf

use\_cow\_images = False

I then booted, stopped & rescued an instance

$ nova boot --flavor m1.small --image f16-x86\_64-openstack-sda f16demo

$ nova stop f16demo

$ nova rescue f16demo

When I look at the config libvirt generated, it is correctly setting 'raw' as the disk type

# virsh dumpxml instance-00000003

<disk type='file' device='disk'>

      <driver name='qemu' type='raw' cache='none'/>

      <source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk.rescue'/>

      <target dev='vda' bus='virtio'/>

      <alias name='virtio-disk0'/>

      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>

    </disk>

    <disk type='file' device='disk'>

      <driver name='qemu' type='raw' cache='none'/>

      <source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk'/>

      <target dev='vdb' bus='virtio'/>

      <alias name='virtio-disk1'/>

      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>

    </disk>

> Libvirt description of the rescued instance will contain the entry for the second disk with attribute type="qcow2", even though it should be "raw" - same as the original instance.

@stanislaw What version of Nova do you see this behaviour with ? Today's GIT master doesn't show it

I just tested trunk and didn't see the behaviour described in this report.
I have nova setup to use raw files
$ grep cow /etc/nova/nova.conf
use\_cow\_images = False
I then booted, stopped & rescued an instance
$ nova boot --flavor m1.small --image f16-x86\_64-openstack-sda f16demo
$ nova stop f16demo
$ nova rescue f16demo
When I look at the config libvirt generated, it is correctly setting 'raw' as the disk type
# virsh dumpxml instance-00000003
<disk type='file' device='disk'>
<driver name='qemu' type='raw' cache='none'/>
<source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk.rescue'/>
<target dev='vda' bus='virtio'/>
<alias name='virtio-disk0'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>
</disk>
<disk type='file' device='disk'>
<driver name='qemu' type='raw' cache='none'/>
<source file='/home/berrange/src/cloud/data/nova/instances/cd627e5e-928d-47c2-a24c-e1ccfb01ab6d/disk'/>
<target dev='vdb' bus='virtio'/>
<alias name='virtio-disk1'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
</disk>
> Libvirt description of the rescued instance will contain the entry for the second disk with attribute type="qcow2", even though it should be "raw" - same as the original instance.
@stanislaw What version of Nova do you see this behaviour with ? Today's GIT master doesn't show it

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-18: |  |  | [#11](/nova/%2Bbug/1221190/comments/11) |
| --- | --- | --- | --- |

* ["script" capture of the hack, starting with a clean host](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3827442/%2Bfiles/image_hack_typescript)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3827442)
  (15.7 KiB,
  application/octet-stream)

I started from scratch right now and I'm still seeing the same, broken behaviour. Attached, is my whole test (well - I edited out devstack installation) captured via `script`.

Current nova's commit is 82a598318f5d045a2d422f257f9a770ae1f92dc8

I started from scratch right now and I'm still seeing the same, broken behaviour. Attached, is my whole test (well - I edited out devstack installation) captured via `script`.
Current nova's commit is 82a598318f5d045a2d422f257f9a770ae1f92dc8

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-23: |  |  | [#12](/nova/%2Bbug/1221190/comments/12) |
| --- | --- | --- | --- |

Setting to incomplete while we confirm that current trunk is affected

Setting to incomplete while we confirm that current trunk is affected

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → Incomplete |
| Changed in ossa: | |
| **status**: | Confirmed → Incomplete |
| **importance**: | Medium → Undecided |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2013-09-25: |  |  | [#13](/nova/%2Bbug/1221190/comments/13) |
| --- | --- | --- | --- |

I don't see this behavior either, although I see different things from Daniel.

I don't see the contents of the evil backing file in /dev/vdb from inside the rescuing guest, but I do see the path I set as the first string, which means the dd worked:

$ sudo strings /dev/vdb | head -1

/etc/libvirt/libvirt.conf

My libvirt config does show qcow2 as the disk format though:

<disk type='file' device='disk'>

      <driver name='qemu' type='qcow2' cache='none'/>

      <source file='/opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk'/>

      <target dev='vdb' bus='virtio'/>

      <alias name='virtio-disk1'/>

      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>

</disk>

However, if I look at the image itself:

# qemu-img info /opt/stack/data/nova/instances/77304a99-9453-4e21-8dbb-ccf61dfa5c23/disk

image: /opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk

file format: qcow2

virtual size: 1.0G (1073741824 bytes)

disk size: 12M

cluster\_size: 65536

backing file: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6)

and if I follow the backing file reference:

# qemu-img info /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07

image: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07

file format: raw

virtual size: 24M (25165824 bytes)

disk size: 24M

it backs up to a raw file. This was on a precise machine:

ii libvirt-bin 0.9.8-2ubuntu17 programs for the libvirt library

On a very recent commit from master:

commit 78810135d851a4db60a2cb2e2fbdb11d032a8b97

Merge: 5429048 2d13161

Author: Jenkins <email address hidden>

Date: Wed Sep 25 19:56:34 2013 +0000

I don't see this behavior either, although I see different things from Daniel.
I don't see the contents of the evil backing file in /dev/vdb from inside the rescuing guest, but I do see the path I set as the first string, which means the dd worked:
$ sudo strings /dev/vdb | head -1
/etc/libvirt/libvirt.conf
My libvirt config does show qcow2 as the disk format though:
<disk type='file' device='disk'>
<driver name='qemu' type='qcow2' cache='none'/>
<source file='/opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk'/>
<target dev='vdb' bus='virtio'/>
<alias name='virtio-disk1'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
</disk>
However, if I look at the image itself:
# qemu-img info /opt/stack/data/nova/instances/77304a99-9453-4e21-8dbb-ccf61dfa5c23/disk
image: /opt/stack/data/nova/instances/77304a99-9453-4e21-8d5b-ccf61dfa5c23/disk
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 12M
cluster\_size: 65536
backing file: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6)
and if I follow the backing file reference:
# qemu-img info /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07
image: /opt/stack/data/nova/instances/\_base/c193393ae54e6028da799b4afdd8ccd8db6efc07
file format: raw
virtual size: 24M (25165824 bytes)
disk size: 24M
it backs up to a raw file. This was on a precise machine:
ii libvirt-bin 0.9.8-2ubuntu17 programs for the libvirt library
On a very recent commit from master:
commit 78810135d851a4db60a2cb2e2fbdb11d032a8b97
Merge: 5429048 2d13161
Author: Jenkins <jenkins@review.openstack.org>
Date: Wed Sep 25 19:56:34 2013 +0000

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-26: |  |  | [#14](/nova/%2Bbug/1221190/comments/14) |
| --- | --- | --- | --- |

Dan, I'll double-check on my machine, but I don't think what you see looks right for this scenario. In case of use\_cow\_images=false, I wouldn't expect the backing file to point at the \_base directory at any time. That looks like the instance was created with a qcow2 disk from the start.

Dan, I'll double-check on my machine, but I don't think what you see looks right for this scenario. In case of use\_cow\_images=false, I wouldn't expect the backing file to point at the \_base directory at any time. That looks like the instance was created with a qcow2 disk from the start.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#15](/nova/%2Bbug/1221190/comments/15) |
| --- | --- | --- | --- |

FYI, I have managed to reproduce the problem now & confirm it is flawed.

FYI, I have managed to reproduce the problem now & confirm it is flawed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#16](/nova/%2Bbug/1221190/comments/16) |
| --- | --- | --- | --- |

Looks like the flaw was introduced in this patch - it causes the libvirt imagebackend.py code to run qemu-img info to probe the disk format which is unsafe :-(

commit 494a3cb5749d52aa90daeacd980362df5f971c0d

Author: Vishvananda Ishaya <email address hidden>

Date: Mon Apr 1 14:19:49 2013 -0700

libvirt: Get driver type from base image type.

If we are using the raw backend (no cow), we should set the driver

    type based on the type of the source image instead of always

    using raw.

Calls to to\_xml were moved after \_create\_image so that the image

    type could be determined when creating the xml for libvirt.

Fixes [bug 1163009](/bugs/1163009)

Change-Id: Ic8d5f0ab83d868a42f834d39c0afb64818d7e027

Looks like the flaw was introduced in this patch - it causes the libvirt imagebackend.py code to run qemu-img info to probe the disk format which is unsafe :-(
commit 494a3cb5749d52aa90daeacd980362df5f971c0d
Author: Vishvananda Ishaya <vishvananda@gmail.com>
Date: Mon Apr 1 14:19:49 2013 -0700
libvirt: Get driver type from base image type.
If we are using the raw backend (no cow), we should set the driver
type based on the type of the source image instead of always
using raw.
Calls to to\_xml were moved after \_create\_image so that the image
type could be determined when creating the xml for libvirt.
Fixes bug 1163009
Change-Id: Ic8d5f0ab83d868a42f834d39c0afb64818d7e027

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#17](/nova/%2Bbug/1221190/comments/17) |
| --- | --- | --- | --- |

I think we need to just revert that patch entirely, as the approach it takes is not safe. It injects the probing into the imagebackend.py code, which means it is run in every single code path that uses the image backends.

To address the [bug 1163009](/bugs/1163009) safely, we would need something that only does the probing when the image is first downloaded from glance. The detected format should then be recorded (in the database?) and used for all subsequent boots of that image, whether normal start, or rescue start, or something else.

I think we need to just revert that patch entirely, as the approach it takes is not safe. It injects the probing into the imagebackend.py code, which means it is run in every single code path that uses the image backends.
To address the bug 1163009 safely, we would need something that only does the probing when the image is first downloaded from glance. The detected format should then be recorded (in the database?) and used for all subsequent boots of that image, whether normal start, or rescue start, or something else.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-26: |  |  | [#18](/nova/%2Bbug/1221190/comments/18) |
| --- | --- | --- | --- |

This was introduced in stable/grizzly, which complicates things a bit. Purely reverting (and introducing a small regression) might not be an option there. That said, changing db format is not an option there either... Is there a plan C ?

This was introduced in stable/grizzly, which complicates things a bit. Purely reverting (and introducing a small regression) might not be an option there. That said, changing db format is not an option there either... Is there a plan C ?

| Changed in nova: | |
| --- | --- |
| **status**: | Incomplete → Confirmed |
| Changed in ossa: | |
| **status**: | Incomplete → Confirmed |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2013-09-26

| Changed in ossa: | |
| --- | --- |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#19](/nova/%2Bbug/1221190/comments/19) |
| --- | --- | --- | --- |

The key issue is that we must only ever probe the image format once and persist that data in some manner. If using the database is not possible, then perhaps we can change the naming convention used for image files, eg instead of

$INSTANCE\_DIR/disk

use

$INSTANCE\_DIR/disk.qcow2

or

$INSTANCE\_DIR/disk.raw

I'd be somewhat scared about making such a change in grizzly stable though, since hunting down all the places which assume a plain name of 'disk' may be hard.

The key issue is that we must only ever probe the image format once and persist that data in some manner. If using the database is not possible, then perhaps we can change the naming convention used for image files, eg instead of
$INSTANCE\_DIR/disk
use
$INSTANCE\_DIR/disk.qcow2
or
$INSTANCE\_DIR/disk.raw
I'd be somewhat scared about making such a change in grizzly stable though, since hunting down all the places which assume a plain name of 'disk' may be hard.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#20](/nova/%2Bbug/1221190/comments/20) |
| --- | --- | --- | --- |

Another option for grizzly stable would be to have something run on VM shutdown that probed the disk image and compard it to the XML nova saved in the instance directory. If it detected that the format had changed, it could do something to prevent the VM being started again - eg renamed the image from 'disk' to 'disk.compromised'

Another option for grizzly stable would be to have something run on VM shutdown that probed the disk image and compard it to the XML nova saved in the instance directory. If it detected that the format had changed, it could do something to prevent the VM being started again - eg renamed the image from 'disk' to 'disk.compromised'

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2013-09-26: |  |  | [#21](/nova/%2Bbug/1221190/comments/21) |
| --- | --- | --- | --- |

Ah, sorry, I mis-correlated the default of use\_cow\_images with what you said it needed to be, my bad.

Ah, sorry, I mis-correlated the default of use\_cow\_images with what you said it needed to be, my bad.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2013-09-26: |  |  | [#22](/nova/%2Bbug/1221190/comments/22) |
| --- | --- | --- | --- |

I really like the file renaming, but even if we changed all of the places in openstack itself, there's bound to be a number of custom modules or supporting scripts people use that assume this name. I know we have a number of those.

To further complicate the shutdown check, you can probably find some situations where proper shutdown doesn't happen. Host reboots (crashes or forced by dos) would not run shutdown. Live migration be another edge case to check, I guess.

Just to brainstorm more ideas: what about renaming the files and leaving a symlink in place? This will require lots of renaming in libvirt driver, but hopefully it will fix the problem itself. For anything that gets accidentally left over or things that exist outside of openstack's control, the symlink from disk -> disk.{format} should be enough to keep it working.

Or maybe even better -> create disk.{format} itself as a symlink to disk and verify the format based on that file?

I really like the file renaming, but even if we changed all of the places in openstack itself, there's bound to be a number of custom modules or supporting scripts people use that assume this name. I know we have a number of those.
To further complicate the shutdown check, you can probably find some situations where proper shutdown doesn't happen. Host reboots (crashes or forced by dos) would not run shutdown. Live migration be another edge case to check, I guess.
Just to brainstorm more ideas: what about renaming the files and leaving a symlink in place? This will require lots of renaming in libvirt driver, but hopefully it will fix the problem itself. For anything that gets accidentally left over or things that exist outside of openstack's control, the symlink from disk -> disk.{format} should be enough to keep it working.
Or maybe even better -> create disk.{format} itself as a symlink to disk and verify the format based on that file?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Pádraig Brady (p-draigbrady)](https://launchpad.net/~p-draigbrady) wrote on 2013-09-26: |  |  | [#23](/nova/%2Bbug/1221190/comments/23) |
| --- | --- | --- | --- |

Is there a related case with force\_raw\_images=False, use\_cow\_images=False

where a qcow is copied directly from glance to the instance/disk ?

I.E. the disk is validly qcow2 format but not backed by an image in base\_/

Even if that case isn't susceptible to the dd if=evil.qcow attach,

it could impact on the format detection.

Is there a related case with force\_raw\_images=False, use\_cow\_images=False
where a qcow is copied directly from glance to the instance/disk ?
I.E. the disk is validly qcow2 format but not backed by an image in base\_/
Even if that case isn't susceptible to the dd if=evil.qcow attach,
it could impact on the format detection.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2013-09-26: |  |  | [#24](/nova/%2Bbug/1221190/comments/24) |
| --- | --- | --- | --- |

Yet another idea for a easy hack for stable... rather than renaming disk images, we could save a little 'disks.info' file in the instance directory listing the expected formats when first booting. On subsequent boots/rescues we can consult that file instead of probing

> I.E. the disk is validly qcow2 format but not backed by an image in base\_/

Glance itself validates that users don't have a nasty backing file listed when they upload qcow2 files, so that's safe enough I believe. So the issue is only with raw files being turned into qcow2 files by a malicious guest action

Yet another idea for a easy hack for stable... rather than renaming disk images, we could save a little 'disks.info' file in the instance directory listing the expected formats when first booting. On subsequent boots/rescues we can consult that file instead of probing
> I.E. the disk is validly qcow2 format but not backed by an image in base\_/
Glance itself validates that users don't have a nasty backing file listed when they upload qcow2 files, so that's safe enough I believe. So the issue is only with raw files being turned into qcow2 files by a malicious guest action

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-09-27: |  |  | [#25](/nova/%2Bbug/1221190/comments/25) |
| --- | --- | --- | --- |

@Daniel: personally I like the disks.info approach, it appears to be the most foolproof (that file is only used by the verification code so all the other code paths should not be affected).

At this point in the cycle, we might apply this workaround to both grizzly and havana, and fix it "properly" in icehouse ?

@Daniel: personally I like the disks.info approach, it appears to be the most foolproof (that file is only used by the verification code so all the other code paths should not be affected).
At this point in the cycle, we might apply this workaround to both grizzly and havana, and fix it "properly" in icehouse ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2013-09-30: |  |  | [#26](/nova/%2Bbug/1221190/comments/26) |
| --- | --- | --- | --- |

Yes, I like the disk info metadata file, as well. It seems a lot less risky than renaming the files for grizzly and havana.

Yes, I like the disk info metadata file, as well. It seems a lot less risky than renaming the files for grizzly and havana.

[Russell Bryant (russellb)](https://launchpad.net/~russellb)
on 2013-10-01

| Changed in nova: | |
| --- | --- |
| **milestone**: | havana-rc1 → none |
| **tags**: | added: havana-rc-potential |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-10-02: |  |  | [#27](/nova/%2Bbug/1221190/comments/27) |
| --- | --- | --- | --- |

@Daniel: would you be up for a patch on this one ? Attach to this bug if you do.

@Daniel: would you be up for a patch on this one ? Attach to this bug if you do.

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2013-10-14

| **tags**: | added: havana-backport-potentialremoved: havana-rc-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-10-24: |  |  | [#28](/nova/%2Bbug/1221190/comments/28) |
| --- | --- | --- | --- |

Daniel should look at it next week.

Daniel should look at it next week.

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Daniel Berrange (berrange) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2013-11-20: |  |  | [#29](/nova/%2Bbug/1221190/comments/29) |
| --- | --- | --- | --- |

Looks like Dan doesn't have time for this in the immediate future. Anyone else wanting to work on a patch ?

Looks like Dan doesn't have time for this in the immediate future. Anyone else wanting to work on a patch ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2014-01-17: |  |  | [#30](/nova/%2Bbug/1221190/comments/30) |
| --- | --- | --- | --- |

I'm actively working on finding an assignee for this. If I'm not able to, I'll take it on.

I'm actively working on finding an assignee for this. If I'm not able to, I'll take it on.

| Changed in nova: | |
| --- | --- |
| **assignee**: | Daniel Berrange (berrange) → Russell Bryant (russellb) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Russell Bryant (russellb)](https://launchpad.net/~russellb) wrote on 2014-01-20: |  |  | [#31](/nova/%2Bbug/1221190/comments/31) |
| --- | --- | --- | --- |

David Ripton has now been assigned to work on the fix for this.

David Ripton has now been assigned to work on the fix for this.

| Changed in nova: | |
| --- | --- |
| **assignee**: | Russell Bryant (russellb) → David Ripton (dripton) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-01-22: |  |  | [#32](/nova/%2Bbug/1221190/comments/32) |
| --- | --- | --- | --- |

I agree that Dan's disks.info file seems to be the most backward-compatible way.

Here's my thinking:

In imagebackend.Raw.correct\_format(), we check for the existence of disks.info. And for an entry for 'path' in it. (like path~format, where format is 'raw' or 'qcow2'). If the disks.info does not exist, or does not have an entry for 'path', we probe for the image type and create the file (if needed) and entry. If it does have an entry, we use that entry, and let the instance fail to load if the image type is wrong.

In imagebackend.Qcow2, we add a parallel correct\_format() that does the same thing, with the format always being 'qcow2'. (If the entry already exists and is 'raw' we raise an exception.)

The purpose of keeping this code in imagebackend rather than doing it when we download the file using glance is to simplify the timing in the upgrade case. New code plus existing data keeps working. Granted, it means there's a chance of an attack, once, right after the code is upgraded, but the chance for the attack was already there before the code was upgraded, so in practice I don't think it makes a difference.

Finally, I'm leaning toward using disks.info in Icehouse as well, to have less code and simplify upgrades from stable/havana to Icehouse. Another database column would work, but then we need a database migration script (and more chance of collision with another patch in progress), and (possibly) logic to upgrade a stable/havana box with a disks.info file.

I agree that Dan's disks.info file seems to be the most backward-compatible way.
Here's my thinking:
In imagebackend.Raw.correct\_format(), we check for the existence of disks.info. And for an entry for 'path' in it. (like path~format, where format is 'raw' or 'qcow2'). If the disks.info does not exist, or does not have an entry for 'path', we probe for the image type and create the file (if needed) and entry. If it does have an entry, we use that entry, and let the instance fail to load if the image type is wrong.
In imagebackend.Qcow2, we add a parallel correct\_format() that does the same thing, with the format always being 'qcow2'. (If the entry already exists and is 'raw' we raise an exception.)
The purpose of keeping this code in imagebackend rather than doing it when we download the file using glance is to simplify the timing in the upgrade case. New code plus existing data keeps working. Granted, it means there's a chance of an attack, once, right after the code is upgraded, but the chance for the attack was already there before the code was upgraded, so in practice I don't think it makes a difference.
Finally, I'm leaning toward using disks.info in Icehouse as well, to have less code and simplify upgrades from stable/havana to Icehouse. Another database column would work, but then we need a database migration script (and more chance of collision with another patch in progress), and (possibly) logic to upgrade a stable/havana box with a disks.info file.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-01-30: |  |  | [#33](/nova/%2Bbug/1221190/comments/33) |
| --- | --- | --- | --- |

Draft impact description #1 -

Title: Host data leak to vm instance in rescue mode through image backing file.

Reporter: Stanislaw Pitucha (HP)

Products: Nova

Affects: All supported versions

Description:

Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. An instance administrator can overwrite the disk from inside the instance using a malicious qcow2 image crafted to be backed by an arbitary file path. By switching the instance to rescue mode, libvirt driver will guess the new image format to be a qcow2 resulting in the compute host backing file path (controlled by the user) to be exposed to the vm as the backing device. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Draft impact description #1 -
Title: Host data leak to vm instance in rescue mode through image backing file.
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Affects: All supported versions
Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. An instance administrator can overwrite the disk from inside the instance using a malicious qcow2 image crafted to be backed by an arbitary file path. By switching the instance to rescue mode, libvirt driver will guess the new image format to be a qcow2 resulting in the compute host backing file path (controlled by the user) to be exposed to the vm as the backing device. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

| Changed in ossa: | |
| --- | --- |
| **assignee**: | nobody → Tristan Cacqueray (tristan-cacqueray) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-01-31: |  |  | [#34](/nova/%2Bbug/1221190/comments/34) |
| --- | --- | --- | --- |

@Tristan: nice work, but the "By... a... will... resulting in... " construct should rather be used to describe the attack vector and the impact. The goal is not to use it to get into details over what technically happens in this bug.

By doing this THING, a type of attacker can trigger THAT, resulting in THIS IMPACT for the system/normal user etc.

Your description is, I think, a bit too detailed on the defect and not detailed enough on the attack vector. We don't know what type of attacker would abuse this (local user ? unauthenticated cloud user ? authenticated cloud user ?), the complexity of the attack, and most importantly the end result impact for the rest of the world.

I would say something like...

By overwiting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would..., resulting in... (data exposure ? denial of service ?)

@Tristan: nice work, but the "By... a... will... resulting in... " construct should rather be used to describe the attack vector and the impact. The goal is not to use it to get into details over what technically happens in this bug.
By doing this THING, a type of attacker can trigger THAT, resulting in THIS IMPACT for the system/normal user etc.
Your description is, I think, a bit too detailed on the defect and not detailed enough on the attack vector. We don't know what type of attacker would abuse this (local user ? unauthenticated cloud user ? authenticated cloud user ?), the complexity of the attack, and most importantly the end result impact for the rest of the world.
I would say something like...
By overwiting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would..., resulting in... (data exposure ? denial of service ?)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-02-05: |  |  | [#35](/nova/%2Bbug/1221190/comments/35) |
| --- | --- | --- | --- |

Many thanks for your review Thierry, I removed the technical details.

Draft impact description #2 -

Title: Host data leak to instance in rescue mode

Reporter: Stanislaw Pitucha (HP)

Products: Nova

Affects: All supported versions

Description:

Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Many thanks for your review Thierry, I removed the technical details.
Draft impact description #2 -
Title: Host data leak to instance in rescue mode
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Affects: All supported versions
Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-05: |  |  | [#36](/nova/%2Bbug/1221190/comments/36) |
| --- | --- | --- | --- |

* [patch vs. nova master for #1221190](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3970013/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3970013)
  (21.1 KiB,
  text/plain)

Attaching a patch for review. This is against current (icehouse) master.

Attaching a patch for review. This is against current (icehouse) master.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-05: |  |  | [#37](/nova/%2Bbug/1221190/comments/37) |
| --- | --- | --- | --- |

Impact looks good. You should add a comma between "rescue mode" and "an authenticated user" for readability though.

Impact looks good. You should add a comma between "rescue mode" and "an authenticated user" for readability though.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2014-02-05: |  |  | [#38](/nova/%2Bbug/1221190/comments/38) |
| --- | --- | --- | --- |

It looks good. Just some comments about edge cases:

Is the path always guaranteed to not contain "~"? Wouldn't it be safer to do the serialisation properly? It shouldn't be a big change between:

parts = line.strip().split('~')

and

parts = json.loads(line)

Is there any chance for race conditions here? Maybe just os.makedirs() except OSError would be enough?

+ if not os.path.exists(CONF.instances\_path):

+ os.makedirs(CONF.instances\_path, 0750)

Do we need to do the mode detection in get\_set\_driver\_format()? It looks like it could be always "a".

Since the file is created under instances\_path, should it also use an external lock? (in case of shared storage)

It looks good. Just some comments about edge cases:
Is the path always guaranteed to not contain "~"? Wouldn't it be safer to do the serialisation properly? It shouldn't be a big change between:
parts = line.strip().split('~')
and
parts = json.loads(line)
Is there any chance for race conditions here? Maybe just os.makedirs() except OSError would be enough?
+ if not os.path.exists(CONF.instances\_path):
+ os.makedirs(CONF.instances\_path, 0750)
Do we need to do the mode detection in get\_set\_driver\_format()? It looks like it could be always "a".
Since the file is created under instances\_path, should it also use an external lock? (in case of shared storage)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-05: |  |  | [#39](/nova/%2Bbug/1221190/comments/39) |
| --- | --- | --- | --- |

Thanks for the review Stanislaw.

'~' characters are extremely rare in paths, but I concede that extremely rare is not the same as impossible. I'll change the serialization to json.

I will add the try/except around makedirs in case of a directory creation race.

I believe the mode detection is needed; I saw errors in testing without it.

It's probably a good idea to use the existing lock directory to serialize accesses to get\_set\_driver\_format. I believe it's safe to read the file without the lock, but we should use the lock when we write the file.

I will make these changes (and some other improvements to the tests) and submit an updated patch.

Thanks for the review Stanislaw.
'~' characters are extremely rare in paths, but I concede that extremely rare is not the same as impossible. I'll change the serialization to json.
I will add the try/except around makedirs in case of a directory creation race.
I believe the mode detection is needed; I saw errors in testing without it.
It's probably a good idea to use the existing lock directory to serialize accesses to get\_set\_driver\_format. I believe it's safe to read the file without the lock, but we should use the lock when we write the file.
I will make these changes (and some other improvements to the tests) and submit an updated patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#40](/nova/%2Bbug/1221190/comments/40) |
| --- | --- | --- | --- |

Several more comments from my side in order of importance, and I agree with all the stuff Stanislaw said.

\* We really should not be creating the instance\_path dir like you are doing in get\_set\_driver\_format. We use libvirt\_utils.get\_instance\_path, and ensure\_tree - for inspiration, check the libvirt driver's \_create\_image method. Also - we really should not be creating the instance directory in imagebackend classes ever, this is really not it's responsibility but this is just IMHO.

\* Why not have a disks.info file per instance? The code here creates one for all the instances. Currently we can have only one image really per instance but that might change in the future (see [https://blueprints.launchpad.net/nova/+spec/libvirt-image-to-local-bdm](https://blueprints.launchpad.net/nova/%2Bspec/libvirt-image-to-local-bdm)), and this seems like a more natural place to keep it, plus we need only per instance locking. There may be something I'm missing here so feel free to let me know :)

\* get\_set\_driver\_format is not a good name IMHO.

Several more comments from my side in order of importance, and I agree with all the stuff Stanislaw said.
\* We really should not be creating the instance\_path dir like you are doing in get\_set\_driver\_format. We use libvirt\_utils.get\_instance\_path, and ensure\_tree - for inspiration, check the libvirt driver's \_create\_image method. Also - we really should not be creating the instance directory in imagebackend classes ever, this is really not it's responsibility but this is just IMHO.
\* Why not have a disks.info file per instance? The code here creates one for all the instances. Currently we can have only one image really per instance but that might change in the future (see https://blueprints.launchpad.net/nova/+spec/libvirt-image-to-local-bdm), and this seems like a more natural place to keep it, plus we need only per instance locking. There may be something I'm missing here so feel free to let me know :)
\* get\_set\_driver\_format is not a good name IMHO.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-06: |  |  | [#41](/nova/%2Bbug/1221190/comments/41) |
| --- | --- | --- | --- |

Thanks for the review Nikola.

I agree with your first point and will fix it in the next patch.

It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now, since we don't support multiple images per instance yet. And we definitely didn't support them in grizzly or havana, to which this security fix needs to be backported. I'd rather keep it simpler for now, but I'll be happy to add the multiple image support to disks.info later, after that blueprint goes in.

I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion? I thought of just calling it get\_driver\_format, but didn't because I wanted to make the side effect clear, as well as the reason to call it rather than just looking at self.driver\_format.

Thanks for the review Nikola.
I agree with your first point and will fix it in the next patch.
It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now, since we don't support multiple images per instance yet. And we definitely didn't support them in grizzly or havana, to which this security fix needs to be backported. I'd rather keep it simpler for now, but I'll be happy to add the multiple image support to disks.info later, after that blueprint goes in.
I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion? I thought of just calling it get\_driver\_format, but didn't because I wanted to make the side effect clear, as well as the reason to call it rather than just looking at self.driver\_format.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#42](/nova/%2Bbug/1221190/comments/42) |
| --- | --- | --- | --- |

Also, please consider using git format-patch next time just for the ease of applying it for review.

Also, please consider using git format-patch next time just for the ease of applying it for review.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#43](/nova/%2Bbug/1221190/comments/43) |
| --- | --- | --- | --- |

> It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now

Ok - but we do get the added benefit of not global locking needed with no real additional cost, plus if we put the file in instance dir. we get it cleaned automatically, and code wise - it's just changing how you get the path of the file all else can stay.

> I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion?

Maybe safe\_get... that way we emphasize what was the reason for introducing it and make it less confusing?

> It's easy enough to add disks.info.instance\_name or disks.info.instance\_uuid, but I think it's premature to add it now
Ok - but we do get the added benefit of not global locking needed with no real additional cost, plus if we put the file in instance dir. we get it cleaned automatically, and code wise - it's just changing how you get the path of the file all else can stay.
> I agree that get\_set\_driver\_format is an ugly name, but could not think of a better one. Do you have a suggestion?
Maybe safe\_get... that way we emphasize what was the reason for introducing it and make it less confusing?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stanislaw Pitucha (stanislaw-pitucha)](https://launchpad.net/~stanislaw-pitucha) wrote on 2014-02-06: |  |  | [#44](/nova/%2Bbug/1221190/comments/44) |
| --- | --- | --- | --- |

resolve\_driver\_format() - doesn't imply a simple getter, but I'd expect it to cache things if possible. Or even a more explicit -

cached\_driver\_format() - but it would require an explanation that it's security-related permament record, rather than a pure performance improving cache.

resolve\_driver\_format() - doesn't imply a simple getter, but I'd expect it to cache things if possible. Or even a more explicit -
cached\_driver\_format() - but it would require an explanation that it's security-related permament record, rather than a pure performance improving cache.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-06: |  |  | [#45](/nova/%2Bbug/1221190/comments/45) |
| --- | --- | --- | --- |

I think either safe\_get\_driver\_format or resolve\_driver\_format is reasonable. I'll use one of those.

Nikola, if we do per-instance disks.info files, is disk.info.{instance\_uuid} okay?

I think either safe\_get\_driver\_format or resolve\_driver\_format is reasonable. I'll use one of those.
Nikola, if we do per-instance disks.info files, is disk.info.{instance\_uuid} okay?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2014-02-06: |  |  | [#46](/nova/%2Bbug/1221190/comments/46) |
| --- | --- | --- | --- |

I have the same thoughts as Nikola on this - when I proposed this idea, I was certainly thinking of disks.info being a per instance file, not global to the entire host. As Nikola says it gives us saner cleanup on VM delete if we can just rm the entire file and not worry about doing string manipulation of lines inside a shared file. It also avoids having to acquire any global lock to protect the file. If an instances disk.info file gets corrupted that's fairly harmless, but if we have a single global disks.info file and that's corrupted the impact is pretty bad. So I'd rather prefer a per-instance file

I have the same thoughts as Nikola on this - when I proposed this idea, I was certainly thinking of disks.info being a per instance file, not global to the entire host. As Nikola says it gives us saner cleanup on VM delete if we can just rm the entire file and not worry about doing string manipulation of lines inside a shared file. It also avoids having to acquire any global lock to protect the file. If an instances disk.info file gets corrupted that's fairly harmless, but if we have a single global disks.info file and that's corrupted the impact is pretty bad. So I'd rather prefer a per-instance file

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2014-02-06: |  |  | [#47](/nova/%2Bbug/1221190/comments/47) |
| --- | --- | --- | --- |

Oh one final think - I'm unclear whether things like RBD have any implications on this. eg if we're using RBD for images, do we still have a local directory where we can store this info file ? I guess all RBD volumes are assumed to be raw by nova and we don't (currently) do anything stupid like storing a qcow2 file inside an RBD volume. Nice to have confirmation that this at least doesn't cause any problems for RBD and similar drivers.

Oh one final think - I'm unclear whether things like RBD have any implications on this. eg if we're using RBD for images, do we still have a local directory where we can store this info file ? I guess all RBD volumes are assumed to be raw by nova and we don't (currently) do anything stupid like storing a qcow2 file inside an RBD volume. Nice to have confirmation that this at least doesn't cause any problems for RBD and similar drivers.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-06: |  |  | [#48](/nova/%2Bbug/1221190/comments/48) |
| --- | --- | --- | --- |

David, so like Dan said - just stick it in the instance directory (where we keep disk overlays and libvirt.xml file etc) and call it disk.info, since each instance has it's own directiry anyway. Are there some permission issues with that?

David, so like Dan said - just stick it in the instance directory (where we keep disk overlays and libvirt.xml file etc) and call it disk.info, since each instance has it's own directiry anyway. Are there some permission issues with that?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2014-02-06: |  |  | [#49](/nova/%2Bbug/1221190/comments/49) |
| --- | --- | --- | --- |

Just make sure that the disk.info file is owned by root:root, or nova:nova - we explicitly don't want QEMU to be able to write to that file

Just make sure that the disk.info file is owned by root:root, or nova:nova - we explicitly don't want QEMU to be able to write to that file

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-10: |  |  | [#50](/nova/%2Bbug/1221190/comments/50) |
| --- | --- | --- | --- |

@Daniel: planning to propose a new version of that patch addressing the last comments ?

@Daniel: planning to propose a new version of that patch addressing the last comments ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-10: |  |  | [#51](/nova/%2Bbug/1221190/comments/51) |
| --- | --- | --- | --- |

err... I mean @David: ^

err... I mean @David: ^

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-10: |  |  | [#52](/nova/%2Bbug/1221190/comments/52) |
| --- | --- | --- | --- |

@Thierry, yes, new patch should be ready later today.

@Thierry, yes, new patch should be ready later today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-02-11: |  |  | [#53](/nova/%2Bbug/1221190/comments/53) |
| --- | --- | --- | --- |

Added Nova in title and the new affected version field.

Draft impact description #3 -

Title: Nova host data leak to vm instance in rescue mode.

Reporter: Stanislaw Pitucha (HP)

Products: Nova

Versions: 2013.1.1 to 2013.1.4 and 2013.2 versions up to 2013.2.1

Description:

Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Added Nova in title and the new affected version field.
Draft impact description #3 -
Title: Nova host data leak to vm instance in rescue mode.
Reporter: Stanislaw Pitucha (HP)
Products: Nova
Versions: 2013.1.1 to 2013.1.4 and 2013.2 versions up to 2013.2.1
Description:
Stanislaw Pitucha from Hewlett Packard reported a vulnerability in the Nova instance rescue mode. By overwriting the disk inside an instance with a malicious image and switching the instance to rescue mode, an authenticated user would be able to leak an arbitrary file from the compute host to the virtual instance. Note that the host file must be readable by the libvirt/kvm context to be exposed. Only setups using libvirt to spawn instance, and having "use\_cow\_images = False" in Nova configuration are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-11: |  |  | [#54](/nova/%2Bbug/1221190/comments/54) |
| --- | --- | --- | --- |

+1 for version 3 of impact description

+1 for version 3 of impact description

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-25: |  |  | [#55](/nova/%2Bbug/1221190/comments/55) |
| --- | --- | --- | --- |

* [patch attempt #2](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3996415/%2Bfiles/0001-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3996415)
  (21.0 KiB,
  text/plain)

New patch attached, incorporating all the review comments so far.

New patch attached, incorporating all the review comments so far.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-02-26: |  |  | [#56](/nova/%2Bbug/1221190/comments/56) |
| --- | --- | --- | --- |

@nova-coresec, please review on bug

@nova-coresec, please review on bug

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-02-26: |  |  | [#57](/nova/%2Bbug/1221190/comments/57) |
| --- | --- | --- | --- |

The fix seems sound and incorporates the feedback from Nikola and Daniel. I have a minor issue with one part but overall the fix is good.

The resolve\_driver\_format method works as if there could be multiple lines within a disk.info file. Since the file is now per instance I don't see why it would need to be opened in append mode, or need to iterate over multiple lines in the file. But this is cleanup and not relevant to the security fix aspect of the patch.

The fix seems sound and incorporates the feedback from Nikola and Daniel. I have a minor issue with one part but overall the fix is good.
The resolve\_driver\_format method works as if there could be multiple lines within a disk.info file. Since the file is now per instance I don't see why it would need to be opened in append mode, or need to iterate over multiple lines in the file. But this is cleanup and not relevant to the security fix aspect of the patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-26: |  |  | [#58](/nova/%2Bbug/1221190/comments/58) |
| --- | --- | --- | --- |

Good point Andrew. I didn't change that code when we switched from a one-file multiple-lines model to a one-file-per-instance model. I will change it and submit another patch. (It's a small change.)

Good point Andrew. I didn't change that code when we switched from a one-file multiple-lines model to a one-file-per-instance model. I will change it and submit another patch. (It's a small change.)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-26: |  |  | [#59](/nova/%2Bbug/1221190/comments/59) |
| --- | --- | --- | --- |

* [third attempt at a patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3998421/%2Bfiles/0002-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3998421)
  (22.8 KiB,
  text/plain)

Here's a patch, with resolve\_driver\_format updated to only read one line (and catch the exception if json is invalid). Also some small test tweaks.

Here's a patch, with resolve\_driver\_format updated to only read one line (and catch the exception if json is invalid). Also some small test tweaks.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-27: |  |  | [#60](/nova/%2Bbug/1221190/comments/60) |
| --- | --- | --- | --- |

Looks awesome - one nit tho.

We are currently relying on umask being set properly since the permissions will be set by open() builtin, and then we are just chowning it, meaning that if umask allows for world writable files, chowning will make no difference. Not a huge deal but also really easy to fix (not realy on umask when creating see python's os.open). What do you think?

Looks awesome - one nit tho.
We are currently relying on umask being set properly since the permissions will be set by open() builtin, and then we are just chowning it, meaning that if umask allows for world writable files, chowning will make no difference. Not a huge deal but also really easy to fix (not realy on umask when creating see python's os.open). What do you think?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-02-27: |  |  | [#61](/nova/%2Bbug/1221190/comments/61) |
| --- | --- | --- | --- |

* [0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3999458/%2Bfiles/0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3999458)
  (23.0 KiB,
  text/plain)

Nikola, thanks for the review. Attached is a revised patch that does os.open for mode 644, when writing a disk.info file.

Nikola, thanks for the review. Attached is a revised patch that does os.open for mode 644, when writing a disk.info file.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-02-28: |  |  | [#62](/nova/%2Bbug/1221190/comments/62) |
| --- | --- | --- | --- |

thanks for addressing the comment David.

I am +2 on the patch. Will also try it later and report back.

thanks for addressing the comment David.
I am +2 on the patch. Will also try it later and report back.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-03: |  |  | [#63](/nova/%2Bbug/1221190/comments/63) |
| --- | --- | --- | --- |

nova-core, another +2 on that patch would be nice.

Also it will be applied as-is to havana, so let us know if the change of behavior looks acceptable to you there.

nova-core, another +2 on that patch would be nice.
Also it will be applied as-is to havana, so let us know if the change of behavior looks acceptable to you there.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-03: |  |  | [#64](/nova/%2Bbug/1221190/comments/64) |
| --- | --- | --- | --- |

Adding Alan and Adam for the stable maint check on the proposed patch

Adding Alan and Adam for the stable maint check on the proposed patch

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-03-04: |  |  | [#65](/nova/%2Bbug/1221190/comments/65) |
| --- | --- | --- | --- |

I'm +2 on the patch as well. Looks good, thanks!

I'm +2 on the patch as well. Looks good, thanks!

[David Ripton (dripton)](https://launchpad.net/~dripton)
on 2014-03-10

| Changed in nova: | |
| --- | --- |
| **milestone**: | none → icehouse-rc1 |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-03-10: |  |  | [#66](/nova/%2Bbug/1221190/comments/66) |
| --- | --- | --- | --- |

Seems this no longer cleanly applies to master :(

Would be awesome to have an updated version and the stable/havana fix (I can do the backport too). Would love to see us agree on ago public that so that this is in Icehouse rc1 if at all possible.

Seems this no longer cleanly applies to master :(
Would be awesome to have an updated version and the stable/havana fix (I can do the backport too). Would love to see us agree on ago public that so that this is in Icehouse rc1 if at all possible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-10: |  |  | [#67](/nova/%2Bbug/1221190/comments/67) |
| --- | --- | --- | --- |

* [rebased patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4017090/%2Bfiles/0004-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4017090)
  (22.8 KiB,
  text/plain)

Here's an rebased patch. (git was able to resolve the merge conflicts without manual intervention.)

I got Russell's approval before adding this to the icehouse-rc1 milestone earlier today.

Here's an rebased patch. (git was able to resolve the merge conflicts without manual intervention.)
I got Russell's approval before adding this to the icehouse-rc1 milestone earlier today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-10: |  |  | [#68](/nova/%2Bbug/1221190/comments/68) |
| --- | --- | --- | --- |

Thank you David,

Do you know if this will also be the backport for Havana ?

Thank you David,
Do you know if this will also be the backport for Havana ?

| **no longer affects**: | nova/grizzly |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-10: |  |  | [#69](/nova/%2Bbug/1221190/comments/69) |
| --- | --- | --- | --- |

Tristan, that patch does not apply cleanly to stable/havana. I'm happy to backport it though. (Preferably after it has final approval for Icehouse, so I don't have to do the backport multiple times.)

Tristan, that patch does not apply cleanly to stable/havana. I'm happy to backport it though. (Preferably after it has final approval for Icehouse, so I don't have to do the backport multiple times.)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-03-11: |  |  | [#70](/nova/%2Bbug/1221190/comments/70) |
| --- | --- | --- | --- |

The rebased patch applies cleanly to master. I'm still +2 for it.

The rebased patch applies cleanly to master. I'm still +2 for it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-03-11: |  |  | [#71](/nova/%2Bbug/1221190/comments/71) |
| --- | --- | --- | --- |

+2 as well!

+2 as well!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-12: |  |  | [#72](/nova/%2Bbug/1221190/comments/72) |
| --- | --- | --- | --- |

Thank you guys, this is an updated Affect line for impact description of comment #53:

Versions: 2013.2 versions up to 2013.2.2

Sending CVE requests now

Thank you guys, this is an updated Affect line for impact description of comment #53:
Versions: 2013.2 versions up to 2013.2.2
Sending CVE requests now

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-13

| **summary**: | - Image format not enforced when using rescue+ Image format not enforced when using rescue (CVE-2014-0134) |
| --- | --- |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-03-17

| Changed in ossa: | |
| --- | --- |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-17:  [**Re: Image format not enforced when using rescue (CVE-2014-0134)**](/nova/%2Bbug/1221190/comments/73) |  |  | [#73](/nova/%2Bbug/1221190/comments/73) |
| --- | --- | --- | --- |

@dripton Could you attach an havana backport of your patch please ? Once the backport is reviewed, we will then schedule publication.

Thanks you in advance!

@dripton Could you attach an havana backport of your patch please ? Once the backport is reviewed, we will then schedule publication.
Thanks you in advance!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-18: |  |  | [#74](/nova/%2Bbug/1221190/comments/74) |
| --- | --- | --- | --- |

* [Version of the patch against stable/havana](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4029445/%2Bfiles/0005-Persist-image-format-to-a-file-to-prevent-attacks-ba.havana.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4029445)
  (22.9 KiB,
  text/plain)

@Tristan, attached is a version of the patch against stable/havana. It required a manual conflict resolution because the snapshot\_delete method was removed in icehouse but is still there in havana. Other than that, the code is identical.

@Tristan, attached is a version of the patch against stable/havana. It required a manual conflict resolution because the snapshot\_delete method was removed in icehouse but is still there in havana. Other than that, the code is identical.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2014-03-18: |  |  | [#75](/nova/%2Bbug/1221190/comments/75) |
| --- | --- | --- | --- |

I confirmed that the stable/havana patch and master patch from [https://bugs.launchpad.net/nova/+bug/1221190/comments/67](https://bugs.launchpad.net/nova/%2Bbug/1221190/comments/67) both apply cleanly and look ready to go.

I confirmed that the stable/havana patch and master patch from https://bugs.launchpad.net/nova/+bug/1221190/comments/67 both apply cleanly and look ready to go.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-18: |  |  | [#76](/nova/%2Bbug/1221190/comments/76) |
| --- | --- | --- | --- |

Thank you very much guys, the pre-OSSA have been sent.

Proposed public disclosure date/time:

2014-03-25 15:00 UTC

Thank you very much guys, the pre-OSSA have been sent.
Proposed public disclosure date/time:
2014-03-25 15:00 UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikola Đipanov (ndipanov)](https://launchpad.net/~ndipanov) wrote on 2014-03-19: |  |  | [#77](/nova/%2Bbug/1221190/comments/77) |
| --- | --- | --- | --- |

This date seems reasonable for me - I will be sure to +A the patch once it hits the gerrit.

This date seems reasonable for me - I will be sure to +A the patch once it hits the gerrit.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2014-03-19: |  |  | [#78](/nova/%2Bbug/1221190/comments/78) |
| --- | --- | --- | --- |

@ndipanov, That is very much appreciated. Thanks!

@dripton would you be available to actually push the patch to gerrit at disclosure date ? Else I can take care of that.

@ndipanov, That is very much appreciated. Thanks!
@dripton would you be available to actually push the patch to gerrit at disclosure date ? Else I can take care of that.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David Ripton (dripton)](https://launchpad.net/~dripton) wrote on 2014-03-19: |  |  | [#79](/nova/%2Bbug/1221190/comments/79) |
| --- | --- | --- | --- |

Tristan, I'll be available to put to Gerrit on disclosure date.

Tristan, I'll be available to put to Gerrit on disclosure date.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-19: |  |  | [#80](/nova/%2Bbug/1221190/comments/80) |
| --- | --- | --- | --- |

Setting task to FixCommitted since we are in pre-OSSA stage

Setting task to FixCommitted since we are in pre-OSSA stage

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-03-25

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → In Progress |

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-25

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2014-03-27: |  |  | [#81](/nova/%2Bbug/1221190/comments/81) |
| --- | --- | --- | --- |

Master patch @ <https://review.openstack.org/#/c/82840>

Stable/Havana patch @ <https://review.openstack.org/#/c/82841>

Master patch @ https://review.openstack.org/#/c/82840
Stable/Havana patch @ https://review.openstack.org/#/c/82841

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-27

| **summary**: | - Image format not enforced when using rescue (CVE-2014-0134)+ [0SSA 2014-009] Image format not enforced when using rescue+ (CVE-2014-0134) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-03-27:  [**Fix merged to nova (master)**](/nova/%2Bbug/1221190/comments/82) |  |  | [#82](/nova/%2Bbug/1221190/comments/82) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/82840>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=dc8de426066969a3f0624fdc2a7b29371a2d55bf>

Submitter: Jenkins

Branch: master

commit dc8de426066969a3f0624fdc2a7b29371a2d55bf

Author: David Ripton <email address hidden>

Date: Tue Jan 28 16:38:51 2014 -0500

Persist image format to a file, to prevent attacks based on changing it

The attack is based on creating a raw image that looks like a qcow2

    image, and taking advantage of the code that used 'qemu-img info' to

    autodetect the image format.

Now we store the image format to a 'disk.info' file, for Qcow2 and Raw

    images, and only autodetect for images that have never been written to

    that file.

SecurityImpact

Co-authored-by: Nikola Dipanov <email address hidden>

    Closes-bug: #1221190

    Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a

Reviewed: https://review.openstack.org/82840
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=dc8de426066969a3f0624fdc2a7b29371a2d55bf
Submitter: Jenkins
Branch: master
commit dc8de426066969a3f0624fdc2a7b29371a2d55bf
Author: David Ripton <dripton@redhat.com>
Date: Tue Jan 28 16:38:51 2014 -0500
Persist image format to a file, to prevent attacks based on changing it
The attack is based on creating a raw image that looks like a qcow2
image, and taking advantage of the code that used 'qemu-img info' to
autodetect the image format.
Now we store the image format to a 'disk.info' file, for Qcow2 and Raw
images, and only autodetect for images that have never been written to
that file.
SecurityImpact
Co-authored-by: Nikola Dipanov <ndipanov@redhat.com>
Closes-bug: #1221190
Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-03-27:  [**Fix merged to nova (stable/havana)**](/nova/%2Bbug/1221190/comments/83) |  |  | [#83](/nova/%2Bbug/1221190/comments/83) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/82841>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=25e761acd56d4c820273fc0245ada06c500c1637>

Submitter: Jenkins

Branch: stable/havana

commit 25e761acd56d4c820273fc0245ada06c500c1637

Author: David Ripton <email address hidden>

Date: Tue Jan 28 16:38:51 2014 -0500

Persist image format to a file, to prevent attacks based on changing it

The attack is based on creating a raw image that looks like a qcow2

    image, and taking advantage of the code that used 'qemu-img info' to

    autodetect the image format.

Now we store the image format to a 'disk.info' file, for Qcow2 and Raw

    images, and only autodetect for images that have never been written to

    that file.

SecurityImpact

Conflicts:

     nova/virt/libvirt/imagebackend.py

Manual tweaks to some mocking in test\_imagebackend.py

Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a

    Co-authored-by: Nikola Dipanov <email address hidden>

    Closes-bug: #1221190

Reviewed: https://review.openstack.org/82841
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=25e761acd56d4c820273fc0245ada06c500c1637
Submitter: Jenkins
Branch: stable/havana
commit 25e761acd56d4c820273fc0245ada06c500c1637
Author: David Ripton <dripton@redhat.com>
Date: Tue Jan 28 16:38:51 2014 -0500
Persist image format to a file, to prevent attacks based on changing it
The attack is based on creating a raw image that looks like a qcow2
image, and taking advantage of the code that used 'qemu-img info' to
autodetect the image format.
Now we store the image format to a 'disk.info' file, for Qcow2 and Raw
images, and only autodetect for images that have never been written to
that file.
SecurityImpact
Conflicts:
nova/virt/libvirt/imagebackend.py
Manual tweaks to some mocking in test\_imagebackend.py
Change-Id: I2016efdb3f49a44ec4d677ac596eacc97871f30a
Co-authored-by: Nikola Dipanov <ndipanov@redhat.com>
Closes-bug: #1221190

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2014-03-27

| Changed in ossa: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-03-31

| Changed in nova: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-04-11:  [**Fix merged to nova (master)**](/nova/%2Bbug/1221190/comments/84) |  |  | [#84](/nova/%2Bbug/1221190/comments/84) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/86353>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=d416f4310bb946b4b127201ec3c37e530d988714>

Submitter: Jenkins

Branch: master

commit d416f4310bb946b4b127201ec3c37e530d988714

Author: Nikola Dipanov <email address hidden>

Date: Wed Apr 9 15:50:20 2014 +0200

Avoid the possibility of truncating disk info file

Commit dc8de42 makes nova persist image format to a file to avoid

    attacks based on changing it later. However the way it was implemented

    leaves a small window of opportunity for the file to be truncated before

    it gets written back to effectively making it possible for data to get

    lost leaving us with a potential problem next time it is attempted to be

    read.

This patch changes the way file is updated to be atomic, thus closing

    the race window (and also removes the chown that we did not really

    need).

It is worth noting that a better solution to this would be

    to allow the code calling the imagebackend to write the file (once!)

    and make it impossible to update after the boot process is done. This

    approach would require more refactoring of the libvirt driver code, and

    may be done in the future.

Partial-bug: #1221190

    Change-Id: Ia1b073f38e096989f34d1774a12a1b4151773fc7

Reviewed: https://review.openstack.org/86353
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=d416f4310bb946b4b127201ec3c37e530d988714
Submitter: Jenkins
Branch: master
commit d416f4310bb946b4b127201ec3c37e530d988714
Author: Nikola Dipanov <ndipanov@redhat.com>
Date: Wed Apr 9 15:50:20 2014 +0200
Avoid the possibility of truncating disk info file
Commit dc8de42 makes nova persist image format to a file to avoid
attacks based on changing it later. However the way it was implemented
leaves a small window of opportunity for the file to be truncated before
it gets written back to effectively making it possible for data to get
lost leaving us with a potential problem next time it is attempted to be
read.
This patch changes the way file is updated to be atomic, thus closing
the race window (and also removes the chown that we did not really
need).
It is worth noting that a better solution to this would be
to allow the code calling the imagebackend to write the file (once!)
and make it impossible to update after the boot process is done. This
approach would require more refactoring of the libvirt driver code, and
may be done in the future.
Partial-bug: #1221190
Change-Id: Ia1b073f38e096989f34d1774a12a1b4151773fc7

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2014-04-11:  [**Fix proposed to nova (stable/havana)**](/nova/%2Bbug/1221190/comments/85) |  |  | [#85](/nova/%2Bbug/1221190/comments/85) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/havana

Review: <https://review.openstack.org/86895>

Fix proposed to branch: stable/havana
Review: https://review.openstack.org/86895

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2014-04-17

| Changed in nova: | |
| --- | --- |
| **milestone**: | icehouse-rc1 → 2014.1 |

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/1221190/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [patch attempt #2](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3996415/%2Bfiles/0001-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3996415 "Change patch details")
* [third attempt at a patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3998421/%2Bfiles/0002-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3998421 "Change patch details")
* [0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3999458/%2Bfiles/0003-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3999458 "Change patch details")
* [rebased patch](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4017090/%2Bfiles/0004-Persist-image-format-to-a-file-to-prevent-attacks-ba.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4017090 "Change patch details")
* [Version of the patch against stable/havana](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/4029445/%2Bfiles/0005-Persist-image-format-to-a-file-to-prevent-attacks-ba.havana.patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/4029445 "Change patch details")

* [Add patch](/nova/%2Bbug/1221190/%2Baddcomment?field.patch=on)

## Bug attachments

* ["script" capture of the hack, starting with a clean host](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3827442/%2Bfiles/image_hack_typescript)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3827442 "Change attachment details")
* [patch vs. nova master for #1221190](https://bugs.launchpad.net/nova/%2Bbug/1221190/%2Battachment/3970013/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/1221190/%2Battachment/3970013 "Change attachment details")

* [Add attachment](/nova/%2Bbug/1221190/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_1d0b4763_20250126_062057.html ===

[Log in / Register](https://launchpad.net/~ttx/%2Blogin)

[![](https://launchpadlibrarian.net/116816327/ttx64.jpg)](https://launchpad.net/~ttx)

## [Thierry Carrez](https://launchpad.net/~ttx)

* Overview
* [Code](https://code.launchpad.net/~ttx)
* [Bugs](https://bugs.launchpad.net/~ttx)
* [Blueprints](https://blueprints.launchpad.net/~ttx)
* [Translations](https://translations.launchpad.net/~ttx)
* [Answers](https://answers.launchpad.net/~ttx)

Chair of the Technical Committee and Release Manager for OpenStack.

Python Software Foundation member.

Ubuntu core developer.

* [Related packages](https://launchpad.net/~ttx/%2Brelated-packages)
* [Related projects](https://launchpad.net/~ttx/%2Brelated-projects)

## User information

Launchpad Id:
ttx

Email:
[Log in](%2Blogin) for email information.

Member since:
2008-05-12

[![Icon of Cassandra Ubuntu Packaging](https://launchpadlibrarian.net/59580596/cassandra-ubuntu-icon.png "Member of Cassandra Ubuntu Packaging")](/~cassandra-ubuntu)
[![Icon of (deprecated) OpenStack PPA maintainers](https://launchpadlibrarian.net/87891894/ppa.gif "Member of (deprecated) OpenStack PPA maintainers")](/~openstack-ppa)
[![Icon of Designate Drivers](https://launchpadlibrarian.net/360468067/designate_14.jpg "Member of Designate Drivers")](/~designate-drivers)
[![Icon of Launchpad Beta Testers](https://launchpadlibrarian.net/600856498/Canonical_Launchpad_icon_14px.png "Member of Launchpad Beta Testers")](/~launchpad-beta-testers)
[![Icon of Martin Pitt's fan](https://launchpadlibrarian.net/16410730/immaginexz0.png "Member of Martin Pitt's fan")](/~we-love-pitti)
[![Icon of Nova](https://launchpadlibrarian.net/52560219/os14.png "Member of Nova")](/~nova)
[![Icon of OpenStack release team](https://launchpadlibrarian.net/73211233/openstack-release.png "Member of OpenStack release team")](/~openstack-release)
[![Icon of OpenStack Security SIG](https://launchpadlibrarian.net/203991792/os14.png "Member of OpenStack Security SIG")](/~openstack-ossg)
[![Icon of OpenStack Team](https://launchpadlibrarian.net/52313052/os14.png "Member of OpenStack Team")](/~openstack)
[![Icon of Python OpenStack Client Drivers](https://launchpadlibrarian.net/697274978/osc-icon.png "Member of Python OpenStack Client Drivers")](/~python-openstackclient-drivers)
[![Icon of Python OpenStack Client](https://launchpadlibrarian.net/697274843/osc-icon.png "Member of Python OpenStack Client")](/~python-openstackclient)
[![Icon of Soren's Target Audience](https://launchpadlibrarian.net/20548684/golf.png "Member of Soren's Target Audience")](/~sorens-target-audience)
[![Icon of Ubuntu Contributing Developers](https://launchpadlibrarian.net/17290192/wrench_emblem-trans.png "Member of Ubuntu Contributing Developers")](/~ubuntu-developer-members)
[![Icon of Ubuntu Members](https://launchpadlibrarian.net/606495581/CoF%2014px.png "Member of Ubuntu Members")](/~ubuntumembers)
[![Icon of Ubuntu Server papercutters](https://launchpadlibrarian.net/38078797/14.png "Member of Ubuntu Server papercutters")](/~server-papercutters)

Signed Ubuntu Code of Conduct:
Yes

Languages:

English, French

OpenPGP keys:

22A7943050DB1E67EC2B641A507AF89025B10423

SSH keys:

[ttx@stardust](%2Bsshkeys)

[ttx@mercury](%2Bsshkeys)

Time zone:

Europe/Paris
(UTC+0100)

Karma:
[0](https://launchpad.net/~ttx/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

Social accounts:
![IRC](/@@/social-irc "IRC")
**ttx**
 on
**FreeNode**

## [All bugs in progress](https://launchpad.net/~ttx/%2Bassignedbugs?search=Search&field.status=In+Progress) Assigned bugs

||  | #1473369 [new mock release broke a bunch of unit tests](https://bugs.launchpad.net/python-muranoclient/kilo/%2Bbug/1473369) |  |
| --- | --- | --- |
| in [python-muranoclient](/python-muranoclient), [Glance](/glance), [glance\_store](/glance-store), [Murano](/murano), [neutron](/neutron), [OpenStack Object Storage (swift)](/swift) | | |

| --- | --- | --- | --- | --- | --- |

## Personal package archives

| [Test Openstack 2011.3](/~ttx/%2Barchive/ubuntu/2011.3) |
| --- |
| [Extra packages](/~ttx/%2Barchive/ubuntu/extras) |
| [Bexar update candidates](/~ttx/%2Barchive/ubuntu/nova-bexar-updates) |
| [Junk PPA](/~ttx/%2Barchive/ubuntu/ppa) |
| [Terracotta stack](/~ttx/%2Barchive/ubuntu/terracotta) |

## [All memberships](https://launchpad.net/~ttx/%2Bparticipation) Latest memberships

| [kata-containers](/~kata-containers)  Joined on 2018-10-09 | |
| --- | --- |
| [OpenStack Folsom Stable Maintainers](/~openstack-folsom-maint)  Joined on 2013-04-11 | |
| [OpenStack Python3 Migration Team](/~openstack-py3-team)  Joined on 2013-03-20 | |
| [OpenStack Security SIG](/~openstack-ossg)  Joined on 2012-05-25 | |
| [Swift Drivers](/~swift-drivers)  Joined on 2012-04-06 | |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))


