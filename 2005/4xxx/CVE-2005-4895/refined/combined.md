=== Content from code.google.com_3dfa8467_20250124_230221.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgperftools%2Fgperftools)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgperftools%2Fgperftools)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=gperftools%2Fgperftools)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[gperftools](/gperftools)
/
**[gperftools](/gperftools/gperftools)**
Public

* [Notifications](/login?return_to=%2Fgperftools%2Fgperftools) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fgperftools%2Fgperftools)
* [Star
   8.5k](/login?return_to=%2Fgperftools%2Fgperftools)

Main gperftools repository

### License

[BSD-3-Clause license](/gperftools/gperftools/blob/master/COPYING)

[8.5k
stars](/gperftools/gperftools/stargazers) [1.5k
forks](/gperftools/gperftools/forks) [Branches](/gperftools/gperftools/branches) [Tags](/gperftools/gperftools/tags) [Activity](/gperftools/gperftools/activity)
 [Star](/login?return_to=%2Fgperftools%2Fgperftools)

 [Notifications](/login?return_to=%2Fgperftools%2Fgperftools) You must be signed in to change notification settings

* [Code](/gperftools/gperftools)
* [Issues
  103](/gperftools/gperftools/issues)
* [Pull requests
  15](/gperftools/gperftools/pulls)
* [Discussions](/gperftools/gperftools/discussions)
* [Actions](/gperftools/gperftools/actions)
* [Projects
  0](/gperftools/gperftools/projects)
* [Wiki](/gperftools/gperftools/wiki)
* [Security](/gperftools/gperftools/security)
* [Insights](/gperftools/gperftools/pulse)

Additional navigation options

* [Code](/gperftools/gperftools)
* [Issues](/gperftools/gperftools/issues)
* [Pull requests](/gperftools/gperftools/pulls)
* [Discussions](/gperftools/gperftools/discussions)
* [Actions](/gperftools/gperftools/actions)
* [Projects](/gperftools/gperftools/projects)
* [Wiki](/gperftools/gperftools/wiki)
* [Security](/gperftools/gperftools/security)
* [Insights](/gperftools/gperftools/pulse)

# gperftools/gperftools

    master[Branches](/gperftools/gperftools/branches)[Tags](/gperftools/gperftools/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[1,213 Commits](/gperftools/gperftools/commits/master/) | | |
| [.github/workflows](/gperftools/gperftools/tree/master/.github/workflows "This path skips through empty directories") | | [.github/workflows](/gperftools/gperftools/tree/master/.github/workflows "This path skips through empty directories") |  |  |
| [benchmark](/gperftools/gperftools/tree/master/benchmark "benchmark") | | [benchmark](/gperftools/gperftools/tree/master/benchmark "benchmark") |  |  |
| [cmake](/gperftools/gperftools/tree/master/cmake "cmake") | | [cmake](/gperftools/gperftools/tree/master/cmake "cmake") |  |  |
| [docs](/gperftools/gperftools/tree/master/docs "docs") | | [docs](/gperftools/gperftools/tree/master/docs "docs") |  |  |
| [m4](/gperftools/gperftools/tree/master/m4 "m4") | | [m4](/gperftools/gperftools/tree/master/m4 "m4") |  |  |
| [src](/gperftools/gperftools/tree/master/src "src") | | [src](/gperftools/gperftools/tree/master/src "src") |  |  |
| [vendor](/gperftools/gperftools/tree/master/vendor "vendor") | | [vendor](/gperftools/gperftools/tree/master/vendor "vendor") |  |  |
| [vsprojects](/gperftools/gperftools/tree/master/vsprojects "vsprojects") | | [vsprojects](/gperftools/gperftools/tree/master/vsprojects "vsprojects") |  |  |
| [.gitignore](/gperftools/gperftools/blob/master/.gitignore ".gitignore") | | [.gitignore](/gperftools/gperftools/blob/master/.gitignore ".gitignore") |  |  |
| [AUTHORS](/gperftools/gperftools/blob/master/AUTHORS "AUTHORS") | | [AUTHORS](/gperftools/gperftools/blob/master/AUTHORS "AUTHORS") |  |  |
| [CMakeLists.txt](/gperftools/gperftools/blob/master/CMakeLists.txt "CMakeLists.txt") | | [CMakeLists.txt](/gperftools/gperftools/blob/master/CMakeLists.txt "CMakeLists.txt") |  |  |
| [COPYING](/gperftools/gperftools/blob/master/COPYING "COPYING") | | [COPYING](/gperftools/gperftools/blob/master/COPYING "COPYING") |  |  |
| [ChangeLog.old](/gperftools/gperftools/blob/master/ChangeLog.old "ChangeLog.old") | | [ChangeLog.old](/gperftools/gperftools/blob/master/ChangeLog.old "ChangeLog.old") |  |  |
| [INSTALL](/gperftools/gperftools/blob/master/INSTALL "INSTALL") | | [INSTALL](/gperftools/gperftools/blob/master/INSTALL "INSTALL") |  |  |
| [Makefile.am](/gperftools/gperftools/blob/master/Makefile.am "Makefile.am") | | [Makefile.am](/gperftools/gperftools/blob/master/Makefile.am "Makefile.am") |  |  |
| [NEWS](/gperftools/gperftools/blob/master/NEWS "NEWS") | | [NEWS](/gperftools/gperftools/blob/master/NEWS "NEWS") |  |  |
| [README](/gperftools/gperftools/blob/master/README "README") | | [README](/gperftools/gperftools/blob/master/README "README") |  |  |
| [README\_windows.txt](/gperftools/gperftools/blob/master/README_windows.txt "README_windows.txt") | | [README\_windows.txt](/gperftools/gperftools/blob/master/README_windows.txt "README_windows.txt") |  |  |
| [autogen.sh](/gperftools/gperftools/blob/master/autogen.sh "autogen.sh") | | [autogen.sh](/gperftools/gperftools/blob/master/autogen.sh "autogen.sh") |  |  |
| [configure.ac](/gperftools/gperftools/blob/master/configure.ac "configure.ac") | | [configure.ac](/gperftools/gperftools/blob/master/configure.ac "configure.ac") |  |  |
| [gperftools.sln](/gperftools/gperftools/blob/master/gperftools.sln "gperftools.sln") | | [gperftools.sln](/gperftools/gperftools/blob/master/gperftools.sln "gperftools.sln") |  |  |
| View all files | | |

## Repository files navigation

* README
* License
```
gperftools
----------
(originally Google Performance Tools)

The fastest malloc we’ve seen; works particularly well with threads
and STL. Also: heap-profiler, and cpu-profiler.

OVERVIEW
---------

gperftools is a collection of a high-performance multi-threaded
malloc() implementation, plus some pretty nifty performance analysis
tools.

gperftools is distributed under the terms of the BSD License. Join our
mailing list at gperftools@googlegroups.com for updates:
<https://groups.google.com/forum/#!forum/gperftools>

gperftools was original home for pprof program. But do note that
original pprof (which is still included with gperftools) is now
deprecated in favor of Go version at <https://github.com/google/pprof>

TCMALLOC
--------
Just link in -ltcmalloc or -ltcmalloc_minimal to get the advantages of
tcmalloc -- a replacement for malloc and new.  See below for some
environment variables you can use with tcmalloc, as well.

tcmalloc functionality is available on all systems we've tested; see
INSTALL for more details.  See README_windows.txt for instructions on
using tcmalloc on Windows.

when compiling.  gcc makes some optimizations assuming it is using its
own, built-in malloc; that assumption obviously isn't true with
tcmalloc.  In practice, we haven't seen any problems with this, but
the expected risk is highest for users who register their own malloc
hooks with tcmalloc (using gperftools/malloc_hook.h).  The risk is
lowest for folks who use tcmalloc_minimal (or, of course, who pass in
the above flags :-) ).

HEAP PROFILER
-------------
See docs/heapprofile.html for information about how to use tcmalloc's
heap profiler and analyze its output.

As a quick-start, do the following after installing this package:

1) Link your executable with -ltcmalloc
2) Run your executable with the HEAPPROFILE environment var set:
     $ HEAPPROFILE=/tmp/heapprof <path/to/binary> [binary args]
3) Run pprof to analyze the heap usage
     $ pprof <path/to/binary> /tmp/heapprof.0045.heap  # run 'ls' to see options
     $ pprof --gv <path/to/binary> /tmp/heapprof.0045.heap

You can also use LD_PRELOAD to heap-profile an executable that you
didn't compile.

There are other environment variables, besides HEAPPROFILE, you can
set to adjust the heap-profiler behavior; c.f. "ENVIRONMENT VARIABLES"
below.

The heap profiler is available on all unix-based systems we've tested;
see INSTALL for more details.  It is not currently available on Windows.

CPU PROFILER
------------
See docs/cpuprofile.html for information about how to use the CPU
profiler and analyze its output.

As a quick-start, do the following after installing this package:

1) Link your executable with -lprofiler
2) Run your executable with the CPUPROFILE environment var set:
     $ CPUPROFILE=/tmp/prof.out <path/to/binary> [binary args]
3) Run pprof to analyze the CPU usage
     $ pprof <path/to/binary> /tmp/prof.out      # -pg-like text output
     $ pprof --gv <path/to/binary> /tmp/prof.out # really cool graphical output

There are other environment variables, besides CPUPROFILE, you can set
to adjust the cpu-profiler behavior; cf "ENVIRONMENT VARIABLES" below.

The CPU profiler is available on all unix-based systems we've tested;
see INSTALL for more details.  It is not currently available on Windows.

NOTE: CPU profiling doesn't work after fork (unless you immediately
      do an exec()-like call afterwards).  Furthermore, if you do
      fork, and the child calls exit(), it may corrupt the profile
      data.  You can use _exit() to work around this.  We hope to have
      a fix for both problems in the next release of perftools
      (hopefully perftools 1.2).

EVERYTHING IN ONE
-----------------
If you want the CPU profiler, heap profiler, and heap leak-checker to
all be available for your application, you can do:
   gcc -o myapp ... -lprofiler -ltcmalloc

However, if you have a reason to use the static versions of the
library, this two-library linking won't work:
   gcc -o myapp ... /usr/lib/libprofiler.a /usr/lib/libtcmalloc.a  # errors!

Instead, use the special libtcmalloc_and_profiler library, which we
make for just this purpose:
   gcc -o myapp ... /usr/lib/libtcmalloc_and_profiler.a

CONFIGURATION OPTIONS
---------------------
For advanced users, there are several flags you can pass to
'./configure' that tweak tcmalloc performance.  (These are in addition
to the environment variables you can set at runtime to affect
tcmalloc, described below.)  See the INSTALL file for details.

ENVIRONMENT VARIABLES
---------------------
The cpu profiler, heap checker, and heap profiler will lie dormant,
using no memory or CPU, until you turn them on.  (Thus, there's no
harm in linking -lprofiler into every application, and also -ltcmalloc
assuming you're ok using the non-libc malloc library.)

The easiest way to turn them on is by setting the appropriate
environment variables.  We have several variables that let you
enable/disable features as well as tweak parameters.

Here are some of the most important variables:

HEAPPROFILE=<pre> -- turns on heap profiling and dumps data using this prefix
HEAPCHECK=<type>  -- turns on heap checking with strictness 'type'
CPUPROFILE=<file> -- turns on cpu profiling and dumps data to this file.
PROFILESELECTED=1 -- if set, cpu-profiler will only profile regions of code
                     surrounded with ProfilerEnable()/ProfilerDisable().
CPUPROFILE_FREQUENCY=x-- how many interrupts/second the cpu-profiler samples.

PERFTOOLS_VERBOSE=<level> -- the higher level, the more messages malloc emits
MALLOCSTATS=<level>    -- prints memory-use stats at program-exit

For a full list of variables, see the documentation pages:
   docs/cpuprofile.html
   docs/heapprofile.html
   docs/heap_checker.html

See also TCMALLOC_STACKTRACE_METHOD_VERBOSE and
TCMALLOC_STACKTRACE_METHOD environment variables briefly documented in
our INSTALL file and on our wiki page at:
[https://github.com/gperftools/gperftools/wiki/gperftools'-stacktrace-capturing-methods-and-their-issues](https://github.com/gperftools/gperftools/wiki/gperftools%27-stacktrace-capturing-methods-and-their-issues)

COMPILING ON NON-LINUX SYSTEMS
------------------------------

Perftools was developed and tested on x86, aarch64 and riscv Linux
systems, and it works in its full generality only on those systems.

However, we've successfully ported much of the tcmalloc library to
FreeBSD, Solaris x86 (not tested recently though), and Mac OS X
(aarch64; x86 and ppc have not been tested recently); and we've ported
the basic functionality in tcmalloc_minimal to Windows.  See INSTALL
for details.  See README_windows.txt for details on the Windows port.

---
Originally written: 17 May 2011
Last refreshed: 10 Aug 2023

```

## About

Main gperftools repository

### Resources

[Readme](#readme-ov-file)
### License

[BSD-3-Clause license](#BSD-3-Clause-1-ov-file)

[Activity](/gperftools/gperftools/activity)
[Custom properties](/gperftools/gperftools/custom-properties)
### Stars

[**8.5k**
stars](/gperftools/gperftools/stargazers)
### Watchers

[**362**
watching](/gperftools/gperftools/watchers)
### Forks

[**1.5k**
forks](/gperftools/gperftools/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fgperftools%2Fgperftools&report=gperftools+%28user%29)

## [Releases 36](/gperftools/gperftools/releases)

[gperftools-2.16
Latest

Sep 25, 2024](/gperftools/gperftools/releases/tag/gperftools-2.16)
[+ 35 releases](/gperftools/gperftools/releases)

## [Packages 0](/orgs/gperftools/packages?repo_name=gperftools)

No packages published

## [Contributors 101](/gperftools/gperftools/graphs/contributors)

* [![@alk](https://avatars.githubusercontent.com/u/14850?s=64&v=4)](https://github.com/alk)
* [![@isaachier](https://avatars.githubusercontent.com/u/2578297?s=64&v=4)](https://github.com/isaachier)
* [![@lennoxho](https://avatars.githubusercontent.com/u/9140100?s=64&v=4)](https://github.com/lennoxho)
* [![@HolyWu](https://avatars.githubusercontent.com/u/5151987?s=64&v=4)](https://github.com/HolyWu)
* [![@bsilver8192](https://avatars.githubusercontent.com/u/2999225?s=64&v=4)](https://github.com/bsilver8192)
* [![@m-fila](https://avatars.githubusercontent.com/u/37295697?s=64&v=4)](https://github.com/m-fila)
* [![@barracuda156](https://avatars.githubusercontent.com/u/92015510?s=64&v=4)](https://github.com/barracuda156)
* [![@Romain-Geissler-1A](https://avatars.githubusercontent.com/u/13091109?s=64&v=4)](https://github.com/Romain-Geissler-1A)
* [![@tuliom](https://avatars.githubusercontent.com/u/85220?s=64&v=4)](https://github.com/tuliom)
* [![@blahgeek](https://avatars.githubusercontent.com/u/1308450?s=64&v=4)](https://github.com/blahgeek)
* [![@ffontaine](https://avatars.githubusercontent.com/u/1485263?s=64&v=4)](https://github.com/ffontaine)
* [![@toddlipcon](https://avatars.githubusercontent.com/u/14135?s=64&v=4)](https://github.com/toddlipcon)
* [![@cmuellner](https://avatars.githubusercontent.com/u/92810?s=64&v=4)](https://github.com/cmuellner)
* [![@acmorrow](https://avatars.githubusercontent.com/u/268253?s=64&v=4)](https://github.com/acmorrow)

[+ 87 contributors](/gperftools/gperftools/graphs/contributors)

## Languages

* [C++
  80.6%](/gperftools/gperftools/search?l=c%2B%2B)
* [Perl
  8.8%](/gperftools/gperftools/search?l=perl)
* [M4
  3.3%](/gperftools/gperftools/search?l=m4)
* [C
  2.3%](/gperftools/gperftools/search?l=c)
* [Makefile
  2.0%](/gperftools/gperftools/search?l=makefile)
* [CMake
  1.8%](/gperftools/gperftools/search?l=cmake)
* Other
  1.2%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from kqueue.org_0b37f494_20250124_230222.html ===

[kqueue.org](/)

[About](/about/)

# Memory allocator security revisited

Mar 5, 2012
•
Xi Wang

C/C++ 101:

* What does `malloc(n)` return if `n` is a big number (e.g., `-1` or `SIZE_MAX`)?
* What does `calloc(n, size)` return if `n` and `size` are big numbers?
* What does `new T[n]` return if `n` is a big number (assuming `-fno-exception`)?

I believe everyone expects the answer `NULL` for all the questions,
as `NULL` is used to indicate out of memory.
Unfortunately, in reality many memory allocators break (or used to
break) these expectations, which could lead to memory corruption and
security vulnerabilities, especially if the allocation size
can be controlled by an adversary.

Here goes a summary of some known and unknown vulnerabilities
(notably multiplication, rounding, and pointer overflows)
in popular memory allocators.

## GLIBC malloc

An infamous multiplication overflow used to exist in the `calloc`
implementation in GNU libc and Microsoft’s C runtime, as detailed
in
[RUS-CERT Advisory 2002-08:02](https://seclists.org/bugtraq/2002/Aug/91).
This overflow vulnerability can be easily misused to mount buffer
overflow attacks. It was
[fixed](http://sourceware.org/git/?p=glibc.git;a=commit;h=0950889b810736fe7ad340a13a5ecf76672e1a84)
in GLIBC in 2002.

## Hoard

I cannot find the revision log of the [Hoard](http://www.hoard.org/)
allocator, so it’s hard to say what vulnerabilities it used to have.
Though it’s easy to exploit the current version (3.8) via a rounding
overflow. Below is the buggy code snippet in `tlab.h`.

```
// ThreadLocalAllocationBuffer::malloc(size_t sz)
sz = align (sz); // (sz + (sizeof(double) - 1)) & ~(sizeof(double) - 1);
// Get memory from the local heap,
// and deduct that amount from the local heap bytes counter.
if (sz <= LargestObject) {
  int c = getSizeClass (sz);
  void * ptr = _localHeap(c).get();
  if (ptr) {
    assert (_localHeapBytes >= sz);
    _localHeapBytes -= sz;
    assert (getSize(ptr) >= sz);
    return ptr;
  }
}

```

When `sz` is `(size_t)-1`, a big value, the `align` call overflows
and rounds `sz` up to 0. Thus, `malloc(-1)` is basically `malloc(0)`,
which could lead to a buffer overflow.

Hoard’s `calloc` implementation is also vulnerable to multiplication
overflow. With glibc Hoard is injected via `__malloc_hook`,
and its `calloc` won’t be used. However, the vulnerability can
be triggered on platforms that do not use glibc, such as Mac OS X.

## jemalloc

The [jemalloc](http://www.canonware.com/jemalloc/) allocator is
used by the libc of FreeBSD and NetBSD, as well as Mozilla Firefox.

It used to have the `calloc` multiplication overflow vulnerability.
The bug was
[fixed](http://svnweb.freebsd.org/base?view=revision&revision=161263) in 2006.

A rounding overflow bug was
[fixed](http://svnweb.freebsd.org/base?view=revision&revision=167872)
in 2007.

Another interesting signedness bug was
[fixed](http://svnweb.freebsd.org/base?diff_format=l&view=revision&revision=178645)
in 2008. Below is the simplified code snippet in `jemalloc.c`.

```
/* chunk_alloc_dss(size_t size) */
/* assert(size != 0);                    */
/* assert((size & chunksize_mask) == 0); */
intptr_t incr;
void *ret;

/* Get the current end of the DSS. */
dss_max = sbrk(0);

/*
 * Calculate how much padding is necessary to
 * chunk-align the end of the DSS.
 */
incr = (intptr_t)size - (intptr_t)CHUNK_ADDR2OFFSET(dss_max);
if (incr == (intptr_t)size)
    ret = dss_max;
else {
    ret = (void *)((intptr_t)dss_max + incr);
    incr += size;
}

sbrk(incr);
return (ret);

```

Note that `size` is unsigned and `incr` is signed.
When `size` is big enough, `incr` is misinterpreted as negative
and causes the `sbrk` system call to shrink the memory.

## Bionic malloc

Bionic, the Android libc, is derived from the BSD libc. When
`libc.debug.malloc` is set, allocation calls will be rerouted to
its own debugging library.

Again, the debugging library had `calloc` multiplication overflows
([CVE-2009-0607](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-0607)).

Also, its `malloc` implementation still has multiple rounding
overflows, at least in in `chk_malloc` and `leak_malloc`.

Hope that no production phone ships the debugging library.

## TCMalloc

Google’s [TCMalloc](http://goog-perftools.sourceforge.net/doc/tcmalloc.html)
repeated the `calloc` multiplication overflow bug and got it
[fixed](http://code.google.com/p/gperftools/source/detail?r=15&path=/trunk/src/tcmalloc.cc)
in 2005.

I didn’t spot any serious rounding issues in TCMalloc,
but just a slip in `ReportLargeAlloc`:
the error message says “tcmalloc: large alloc *0* bytes == (nil)”
given `malloc(-1)`, because the size to be output overflows.

## APR pool

[APR pool](http://apr.apache.org/docs/apr/group__apr__pools.html) is
developed for the Apache web server. It is also adopted by other
projects such as Subversion. The interface is similar to
allocate-and-free allocators, but takes one extra parameter specifying
which pool to allocate from.

APR pool had a series of interesting pointer arithmetic fixes,
listed as follows.

In Aug 2002, the sanity check `p + size < q` was
[changed](http://svn.apache.org/viewvc?view=revision&revision=63806)
to `size < q - p`, where
the two pointers `p` (i.e., `node->first_evail`) and `q` (i.e.,
`node->endp`) point to the start and the end of a memory block,
respectively.

```
-    endp = node->first_avail + size;
-    if (endp < node->endp) {
+    if (size < node->endp - node->first_avail) {

```

Over a month later (Sep 2002), the check was
[reverted](http://svn.apache.org/viewvc?view=revision&revision=63887)
to `p + size < q`.

```
-    if (size < node->endp - node->first_avail) {
+    if (node->first_avail + size < node->endp) {

```

One week later (Oct 2002), the check was again
[changed](http://svn.apache.org/viewvc?view=revision&revision=63894)
to `size < q - p`.

```
-    if (node->first_avail + size < node->endp) {
+    if (size < (apr_size_t)(node->endp - node->first_avail)) {

```

After over five years (Apr 2008), the check was
[revised](http://svn.apache.org/viewvc?view=revision&revision=645436)
to `size <= q - p` with an off-by-one fix.

```
+/* Returns the amount of free space in the given node. */
+#define node_free_space(node_) ((apr_size_t)(node_->endp - node_->first_avail))
...
-    if (size < (apr_size_t)(node->endp - node->first_avail)) {
+    if (size <= node_free_space(node)) {

```

Here `p + size < q` is more dangerous than `size < q - p`. One obvious
reason is that `p + size` could wrap around to a small pointer given
a big `size`, while the latter check doesn’t have the pointer
overflow issue.

But how about adding a wrap check `p + size < p`? A subtle
problem is that pointer overflow (or more precisely, out-of-bounds
pointer) is undefined in C, which means that the compiler can do
anything to the wrap check `p + size < p`, such as optimizing it
away ([VU#162289](http://www.kb.cert.org/vuls/id/162289)).
I tried to compile the wrap check using GCC 4.6 and Clang 3.0 on x86:
it’s optimized as extracting the sign of `size`, without even looking
at the value of `p`.

```
movl	8(%esp), %eax
shrl	$31, %eax
ret

```

The size rounding vulnerability was also discovered and fixed in APR pool
([CVE-2009-2412](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-2412))
in 2009.

## boost::pool

[Boost Pool](http://www.boost.org/libs/pool/) has the multiplication overflow
issue in its `ordered_malloc` implementation.

```
template <typename UserAllocator>
void * pool<UserAllocator>::ordered_malloc(const size_type n)
{
  const size_type partition_size = alloc_size();
  const size_type total_req_size = n * requested_size;
  const size_type num_chunks = total_req_size / partition_size +
      ((total_req_size % partition_size) ? true : false);

  void * ret = store().malloc_n(num_chunks, partition_size);
  ...
]

```

We can see that `total_req_size` may wrap around to a small number
given a big `n`.

## Boehm GC

[Boehm GC](http://www.hpl.hp.com/personal/Hans_Boehm/gc/) is probably
the most popular open-source garbage collector. It provides C
allocation calls and overloads the C++ `new` operator.

Boehm GC’s `calloc` implementation, in both `malloc.c` and its
[documentation](http://www.hpl.hp.com/personal/Hans_Boehm/gc/leak.html),
simply redirects `calloc(n, size)` to `GC_MALLOC((n) * (size))`,
thus is vulnerable to multiplication overflow.

It also has the size rounding vulnerability, so `GC_MALLOC(-1)`
doesn’t return a null pointer either.

## Safe by Design

Some allocators are designed to be used in “safe”
environment. For example, LLVM’s `BumpPtrAllocator`
doesn’t consider out-of-memory or overflow issues.

[kLIBC](http://git.kernel.org/?p=libs/klibc/klibc.git;a=blob;f=usr/klibc/calloc.c;hb=HEAD) is another example.

```
/* FIXME: This should look for multiplication overflow */

void *calloc(size_t nmemb, size_t size)
{
	void *ptr;

	size *= nmemb;
	ptr = malloc(size);
	if (ptr)
		memset(ptr, 0, size);

	return ptr;
}

```
## Compiler

The C++ array allocation `new T[n]` has a potential integer overflow
vulnerability if `n` is not limited correctly, which could lead to
a buffer overflow. This is similar to `calloc(n, sizeof(T))`.

The code generated by GCC simply calculates the
allocation size as `n * sizeof(T)` without any overflow checks,
though GCC developers have been
[discussing the problem](http://gcc.gnu.org/bugzilla/show_bug.cgi?id=19351)
for a long time.

Clang
[generates “safe” code](http://blog.llvm.org/2011/05/what-every-c-programmer-should-know_21.html)
that defends against integer overflow attacks, via setting the
allocation size to -1 if any multiplication overflow happens. This
implies an assumption that the underlying allocator must return a
null pointer given a large size. As we have seen, this assumption
doesn’t hold well in practice.

[Subscribe](/feed.xml)


