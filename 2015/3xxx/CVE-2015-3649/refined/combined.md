=== Content from github.com_83845ce3_20250125_032151.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftigris%2Fopen-uri-cached%2Fblob%2Fmaster%2Flib%2Fopen-uri%2Fcached.rb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftigris%2Fopen-uri-cached%2Fblob%2Fmaster%2Flib%2Fopen-uri%2Fcached.rb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tigris%2Fopen-uri-cached)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tigris](/tigris)
/
**[open-uri-cached](/tigris/open-uri-cached)**
Public

* [Notifications](/login?return_to=%2Ftigris%2Fopen-uri-cached) You must be signed in to change notification settings
* [Fork
  18](/login?return_to=%2Ftigris%2Fopen-uri-cached)
* [Star
   32](/login?return_to=%2Ftigris%2Fopen-uri-cached)

* [Code](/tigris/open-uri-cached)
* [Issues
  2](/tigris/open-uri-cached/issues)
* [Pull requests
  2](/tigris/open-uri-cached/pulls)
* [Actions](/tigris/open-uri-cached/actions)
* [Projects
  0](/tigris/open-uri-cached/projects)
* [Wiki](/tigris/open-uri-cached/wiki)
* [Security](/tigris/open-uri-cached/security)
* [Insights](/tigris/open-uri-cached/pulse)

Additional navigation options

* [Code](/tigris/open-uri-cached)
* [Issues](/tigris/open-uri-cached/issues)
* [Pull requests](/tigris/open-uri-cached/pulls)
* [Actions](/tigris/open-uri-cached/actions)
* [Projects](/tigris/open-uri-cached/projects)
* [Wiki](/tigris/open-uri-cached/wiki)
* [Security](/tigris/open-uri-cached/security)
* [Insights](/tigris/open-uri-cached/pulse)

## Files

 master
## Breadcrumbs

1. [open-uri-cached](/tigris/open-uri-cached/tree/master)
2. /[lib](/tigris/open-uri-cached/tree/master/lib)
3. /[open-uri](/tigris/open-uri-cached/tree/master/lib/open-uri)
/
# cached.rb

Copy path Blame  Blame
## Latest commit

## History

[History](/tigris/open-uri-cached/commits/master/lib/open-uri/cached.rb)144 lines (127 loc) · 3.91 KB master
## Breadcrumbs

1. [open-uri-cached](/tigris/open-uri-cached/tree/master)
2. /[lib](/tigris/open-uri-cached/tree/master/lib)
3. /[open-uri](/tigris/open-uri-cached/tree/master/lib/open-uri)
/
# cached.rb

Top
## File metadata and controls

* Code
* Blame

144 lines (127 loc) · 3.91 KB[Raw](https://github.com/tigris/open-uri-cached/raw/refs/heads/master/lib/open-uri/cached.rb)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144require 'digest/sha1'require 'fileutils'require 'open-uri'require 'yaml'
module OpenURI class << self alias original\_open\_uri open\_uri #:nodoc: def open\_uri(uri, \*rest, &block) response = Cache.get(uri.to\_s) || Cache.set(uri.to\_s, original\_open\_uri(uri, \*rest))
 if block\_given? begin yield response ensure response.close end else response end end end
 class Cache @cache\_path = "/tmp/open-uri-#{Process.uid}"
 class << self attr\_accessor :cache\_path
 ## # Retrieve file content and meta data from cache # @param [String] key # @return [StringIO] def get(key) filename = filename\_from\_url(key) # TODO: head request to determine last\_modified vs file modtime
 # Read metadata, if it exists if File.exist?("#{filename}.meta") if YAML.respond\_to?(:unsafe\_load) meta = YAML.unsafe\_load(File.read("#{filename}.meta")) else meta = YAML.load(File.read("#{filename}.meta")) end end
 f = File.exist?(filename) ? StringIO.new(File.open(filename, "rb") { |fd| fd.read }) : nil
 # Add meta accessors if meta && f f.instance\_variable\_set(:"@meta", meta)
 def f.meta @meta end def f.base\_uri @meta[:base\_uri] end def f.content\_type @meta[:content\_type] end def f.charset @meta[:charset] end def f.content\_encoding @meta[:content\_encoding] end def f.last\_modified @meta[:last\_modified] end def f.status @meta[:status] end end
 f end
 # Cache file content and metadata # @param [String] key # URL of content to be cached # @param [StringIO] value # value to be cached, typically StringIO returned from `original\_open\_uri` # @return [StringIO] # Returns value def set(key, value) filename = filename\_from\_url(key) mkpath(filename)
 # Save metadata in a parallel file if value.respond\_to?(:meta) filename\_meta = "#{filename}.meta" meta = value.meta meta[:status] = value.status if value.respond\_to?(:status) meta[:content\_type] = value.content\_type if value.respond\_to?(:content\_type) meta[:base\_uri] = value.base\_uri if value.respond\_to?(:base\_uri) File.open(filename\_meta, 'wb') {|f| YAML::dump(meta, f)} end
 # Save file contents File.open(filename, 'wb'){|f| f.write value.read } value.rewind value end
 # Invalidate cache for a key, optionally if older than time givan # @param [String] key # URL of content to be invalidated # @param [Time] time # (optional): the maximum age at which the cached value is still acceptable # @return # Returns 1 if a cached value was invalidated, false otherwise def invalidate(key, time = Time.now) filename = filename\_from\_url(key) File.delete(filename) if File.stat(filename).mtime < time rescue Errno::ENOENT false end
 # Invalidate all caches we know about def invalidate\_all! FileUtils.rm\_r(@cache\_path, force: true, secure: true) end
 protected def filename\_from\_url(url) uri = URI.parse(url) # TODO: rescue here? [ @cache\_path, uri.host, Digest::SHA1.hexdigest(url) ].join('/') end
 def mkpath(path) full = [] dirs = path.split('/'); dirs.pop dirs.each do |dir| full.push(dir) dir = full.join('/') next if dir.to\_s == '' Dir.mkdir(dir) unless File.exist?(dir) end end end endend

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_54831a8b_20250125_032152.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftigris%2Fopen-uri-cached%2Fblob%2Fmaster%2Flib%2Fopen-uri%2Fcached.rb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftigris%2Fopen-uri-cached%2Fblob%2Fmaster%2Flib%2Fopen-uri%2Fcached.rb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tigris%2Fopen-uri-cached)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tigris](/tigris)
/
**[open-uri-cached](/tigris/open-uri-cached)**
Public

* [Notifications](/login?return_to=%2Ftigris%2Fopen-uri-cached) You must be signed in to change notification settings
* [Fork
  18](/login?return_to=%2Ftigris%2Fopen-uri-cached)
* [Star
   32](/login?return_to=%2Ftigris%2Fopen-uri-cached)

* [Code](/tigris/open-uri-cached)
* [Issues
  2](/tigris/open-uri-cached/issues)
* [Pull requests
  2](/tigris/open-uri-cached/pulls)
* [Actions](/tigris/open-uri-cached/actions)
* [Projects
  0](/tigris/open-uri-cached/projects)
* [Wiki](/tigris/open-uri-cached/wiki)
* [Security](/tigris/open-uri-cached/security)
* [Insights](/tigris/open-uri-cached/pulse)

Additional navigation options

* [Code](/tigris/open-uri-cached)
* [Issues](/tigris/open-uri-cached/issues)
* [Pull requests](/tigris/open-uri-cached/pulls)
* [Actions](/tigris/open-uri-cached/actions)
* [Projects](/tigris/open-uri-cached/projects)
* [Wiki](/tigris/open-uri-cached/wiki)
* [Security](/tigris/open-uri-cached/security)
* [Insights](/tigris/open-uri-cached/pulse)

## Files

 master
## Breadcrumbs

1. [open-uri-cached](/tigris/open-uri-cached/tree/master)
2. /[lib](/tigris/open-uri-cached/tree/master/lib)
3. /[open-uri](/tigris/open-uri-cached/tree/master/lib/open-uri)
/
# cached.rb

Copy path Blame  Blame
## Latest commit

## History

[History](/tigris/open-uri-cached/commits/master/lib/open-uri/cached.rb)144 lines (127 loc) · 3.91 KB master
## Breadcrumbs

1. [open-uri-cached](/tigris/open-uri-cached/tree/master)
2. /[lib](/tigris/open-uri-cached/tree/master/lib)
3. /[open-uri](/tigris/open-uri-cached/tree/master/lib/open-uri)
/
# cached.rb

Top
## File metadata and controls

* Code
* Blame

144 lines (127 loc) · 3.91 KB[Raw](https://github.com/tigris/open-uri-cached/raw/refs/heads/master/lib/open-uri/cached.rb)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144require 'digest/sha1'require 'fileutils'require 'open-uri'require 'yaml'
module OpenURI class << self alias original\_open\_uri open\_uri #:nodoc: def open\_uri(uri, \*rest, &block) response = Cache.get(uri.to\_s) || Cache.set(uri.to\_s, original\_open\_uri(uri, \*rest))
 if block\_given? begin yield response ensure response.close end else response end end end
 class Cache @cache\_path = "/tmp/open-uri-#{Process.uid}"
 class << self attr\_accessor :cache\_path
 ## # Retrieve file content and meta data from cache # @param [String] key # @return [StringIO] def get(key) filename = filename\_from\_url(key) # TODO: head request to determine last\_modified vs file modtime
 # Read metadata, if it exists if File.exist?("#{filename}.meta") if YAML.respond\_to?(:unsafe\_load) meta = YAML.unsafe\_load(File.read("#{filename}.meta")) else meta = YAML.load(File.read("#{filename}.meta")) end end
 f = File.exist?(filename) ? StringIO.new(File.open(filename, "rb") { |fd| fd.read }) : nil
 # Add meta accessors if meta && f f.instance\_variable\_set(:"@meta", meta)
 def f.meta @meta end def f.base\_uri @meta[:base\_uri] end def f.content\_type @meta[:content\_type] end def f.charset @meta[:charset] end def f.content\_encoding @meta[:content\_encoding] end def f.last\_modified @meta[:last\_modified] end def f.status @meta[:status] end end
 f end
 # Cache file content and metadata # @param [String] key # URL of content to be cached # @param [StringIO] value # value to be cached, typically StringIO returned from `original\_open\_uri` # @return [StringIO] # Returns value def set(key, value) filename = filename\_from\_url(key) mkpath(filename)
 # Save metadata in a parallel file if value.respond\_to?(:meta) filename\_meta = "#{filename}.meta" meta = value.meta meta[:status] = value.status if value.respond\_to?(:status) meta[:content\_type] = value.content\_type if value.respond\_to?(:content\_type) meta[:base\_uri] = value.base\_uri if value.respond\_to?(:base\_uri) File.open(filename\_meta, 'wb') {|f| YAML::dump(meta, f)} end
 # Save file contents File.open(filename, 'wb'){|f| f.write value.read } value.rewind value end
 # Invalidate cache for a key, optionally if older than time givan # @param [String] key # URL of content to be invalidated # @param [Time] time # (optional): the maximum age at which the cached value is still acceptable # @return # Returns 1 if a cached value was invalidated, false otherwise def invalidate(key, time = Time.now) filename = filename\_from\_url(key) File.delete(filename) if File.stat(filename).mtime < time rescue Errno::ENOENT false end
 # Invalidate all caches we know about def invalidate\_all! FileUtils.rm\_r(@cache\_path, force: true, secure: true) end
 protected def filename\_from\_url(url) uri = URI.parse(url) # TODO: rescue here? [ @cache\_path, uri.host, Digest::SHA1.hexdigest(url) ].join('/') end
 def mkpath(path) full = [] dirs = path.split('/'); dirs.pop dirs.each do |dir| full.push(dir) dir = full.join('/') next if dir.to\_s == '' Dir.mkdir(dir) unless File.exist?(dir) end end end endend

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_aa8cc7cd_20250125_032153.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftigris%2Fopen-uri-cached%2Fblob%2Fmaster%2Flib%2Fopen-uri%2Fcached.rb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftigris%2Fopen-uri-cached%2Fblob%2Fmaster%2Flib%2Fopen-uri%2Fcached.rb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tigris%2Fopen-uri-cached)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tigris](/tigris)
/
**[open-uri-cached](/tigris/open-uri-cached)**
Public

* [Notifications](/login?return_to=%2Ftigris%2Fopen-uri-cached) You must be signed in to change notification settings
* [Fork
  18](/login?return_to=%2Ftigris%2Fopen-uri-cached)
* [Star
   32](/login?return_to=%2Ftigris%2Fopen-uri-cached)

* [Code](/tigris/open-uri-cached)
* [Issues
  2](/tigris/open-uri-cached/issues)
* [Pull requests
  2](/tigris/open-uri-cached/pulls)
* [Actions](/tigris/open-uri-cached/actions)
* [Projects
  0](/tigris/open-uri-cached/projects)
* [Wiki](/tigris/open-uri-cached/wiki)
* [Security](/tigris/open-uri-cached/security)
* [Insights](/tigris/open-uri-cached/pulse)

Additional navigation options

* [Code](/tigris/open-uri-cached)
* [Issues](/tigris/open-uri-cached/issues)
* [Pull requests](/tigris/open-uri-cached/pulls)
* [Actions](/tigris/open-uri-cached/actions)
* [Projects](/tigris/open-uri-cached/projects)
* [Wiki](/tigris/open-uri-cached/wiki)
* [Security](/tigris/open-uri-cached/security)
* [Insights](/tigris/open-uri-cached/pulse)

## Files

 master
## Breadcrumbs

1. [open-uri-cached](/tigris/open-uri-cached/tree/master)
2. /[lib](/tigris/open-uri-cached/tree/master/lib)
3. /[open-uri](/tigris/open-uri-cached/tree/master/lib/open-uri)
/
# cached.rb

Copy path Blame  Blame
## Latest commit

## History

[History](/tigris/open-uri-cached/commits/master/lib/open-uri/cached.rb)144 lines (127 loc) · 3.91 KB master
## Breadcrumbs

1. [open-uri-cached](/tigris/open-uri-cached/tree/master)
2. /[lib](/tigris/open-uri-cached/tree/master/lib)
3. /[open-uri](/tigris/open-uri-cached/tree/master/lib/open-uri)
/
# cached.rb

Top
## File metadata and controls

* Code
* Blame

144 lines (127 loc) · 3.91 KB[Raw](https://github.com/tigris/open-uri-cached/raw/refs/heads/master/lib/open-uri/cached.rb)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144require 'digest/sha1'require 'fileutils'require 'open-uri'require 'yaml'
module OpenURI class << self alias original\_open\_uri open\_uri #:nodoc: def open\_uri(uri, \*rest, &block) response = Cache.get(uri.to\_s) || Cache.set(uri.to\_s, original\_open\_uri(uri, \*rest))
 if block\_given? begin yield response ensure response.close end else response end end end
 class Cache @cache\_path = "/tmp/open-uri-#{Process.uid}"
 class << self attr\_accessor :cache\_path
 ## # Retrieve file content and meta data from cache # @param [String] key # @return [StringIO] def get(key) filename = filename\_from\_url(key) # TODO: head request to determine last\_modified vs file modtime
 # Read metadata, if it exists if File.exist?("#{filename}.meta") if YAML.respond\_to?(:unsafe\_load) meta = YAML.unsafe\_load(File.read("#{filename}.meta")) else meta = YAML.load(File.read("#{filename}.meta")) end end
 f = File.exist?(filename) ? StringIO.new(File.open(filename, "rb") { |fd| fd.read }) : nil
 # Add meta accessors if meta && f f.instance\_variable\_set(:"@meta", meta)
 def f.meta @meta end def f.base\_uri @meta[:base\_uri] end def f.content\_type @meta[:content\_type] end def f.charset @meta[:charset] end def f.content\_encoding @meta[:content\_encoding] end def f.last\_modified @meta[:last\_modified] end def f.status @meta[:status] end end
 f end
 # Cache file content and metadata # @param [String] key # URL of content to be cached # @param [StringIO] value # value to be cached, typically StringIO returned from `original\_open\_uri` # @return [StringIO] # Returns value def set(key, value) filename = filename\_from\_url(key) mkpath(filename)
 # Save metadata in a parallel file if value.respond\_to?(:meta) filename\_meta = "#{filename}.meta" meta = value.meta meta[:status] = value.status if value.respond\_to?(:status) meta[:content\_type] = value.content\_type if value.respond\_to?(:content\_type) meta[:base\_uri] = value.base\_uri if value.respond\_to?(:base\_uri) File.open(filename\_meta, 'wb') {|f| YAML::dump(meta, f)} end
 # Save file contents File.open(filename, 'wb'){|f| f.write value.read } value.rewind value end
 # Invalidate cache for a key, optionally if older than time givan # @param [String] key # URL of content to be invalidated # @param [Time] time # (optional): the maximum age at which the cached value is still acceptable # @return # Returns 1 if a cached value was invalidated, false otherwise def invalidate(key, time = Time.now) filename = filename\_from\_url(key) File.delete(filename) if File.stat(filename).mtime < time rescue Errno::ENOENT false end
 # Invalidate all caches we know about def invalidate\_all! FileUtils.rm\_r(@cache\_path, force: true, secure: true) end
 protected def filename\_from\_url(url) uri = URI.parse(url) # TODO: rescue here? [ @cache\_path, uri.host, Digest::SHA1.hexdigest(url) ].join('/') end
 def mkpath(path) full = [] dirs = path.split('/'); dirs.pop dirs.each do |dir| full.push(dir) dir = full.join('/') next if dir.to\_s == '' Dir.mkdir(dir) unless File.exist?(dir) end end end endend

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_f5c04e6e_20250125_032150.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2015/05/05/14) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <20150506154303.682FD52E067@smtpvbsrv1.mitre.org>
Date: Wed,  6 May 2015 11:43:03 -0400 (EDT)
From: cve-assign@...re.org
To: misc@...b.org
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: Local privileges escalation in rubygem open-uri-cached

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

> open-uri-cached, a rubygem that will cache downloaded data when using
> open-uri, is susceptible to a local attack

It appears that the critical issue you've identified is execution of
code found in an untrusted location under /tmp. Use CVE-2015-3649.

In most cases, this specific class of /tmp misuse issues is unrelated
to Symlink Following. However, when such an issue exists, it is
conceivable that a Symlink Following vulnerability also exists, could
be fixed independently, and would be of interest to an attacker who
has a goal of overwriting a file rather than directly executing code.
The MITRE CVE team has not done any original research to check for a
Symlink Following vulnerability. If a Symlink Following vulnerability
were to exist, it would not be within the scope of CVE-2015-3649.

Also, the message refers to "usage of YAML in a insecure way." We have
not done any original research to determine whether, in a scenario
where the "untrusted location under /tmp" were no longer used, a
YAML-related vulnerability would still be exploitable. If an
independent "YAML misuse" vulnerability were to exist, it would not be
within the scope of CVE-2015-3649.

- --
CVE assignment team, MITRE CVE Numbering Authority
M/S M300
202 Burlington Road, Bedford, MA 01730 USA
[ PGP key available through <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.14 (SunOS)

iQEcBAEBAgAGBQJVSjYYAAoJEKllVAevmvmsBc0H/1rb5MtLd0UXcNc1Ez6dL3dC
tLUB6CrujIs3yp5ynaNsg6b2cmBoF6GxGRTB4ea4Lg9n4Bv/Ovr6u1aRhtx1gz1f
XtlPnlO4nOzC1Kh9aOa33SvxiRqUw+Ch7G4Vi9tAHYxaxBFH9DGhEvYCC3KWQ4Za
dSMirU3CfkNIywwp3xzAAltXy/tg4VXq4tM0x6j9KK2URhaPJuNVcZDsp12OSpDO
umhE3JJY0FL5eY1QD6YjbyrZbDe7HxjxjhpdpPV8Jh1qcdsttiY1vYq/CQWSwmDu
v/4GfZjw7pR3Bh0uBfVgZ2CmmnWNFCgX2ECWH8D6Nyfy2Im5vG16eFE45ANtRkY=
=NJDF
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.benjaminfleischer.com_83de17f2_20250125_032150.html ===

[Benjamin Fleischer](/)

* [Archive](/archive/)
* [Categories](/categories/)
* [Fragments](/fragments/)
* [Pages](/pages/)
* [Tags](/tags/)

[![](https://gravatar.com/userimage/455248/07b6758e7d309cff827fd0b287281639.png?s=150)](/)
[Benjamin
Fleischer](/)

[![](/assets/themes/left/images/github.png)](https://github.com/bf4)
[![](/assets/themes/left/images/twitter.png)](https://twitter.com/hazula)
[![](/assets/themes/left/images/rss.png)](/atom.xml)

* [about](/about)
* [posts](/)
* [resume](/resume)
* [pair](/pair)

# YAML and security in Ruby

20 March 2013

[Tweet](http://twitter.com/share)
[Follow @hazula](http://twitter.com/hazula)

## Vulnerability Summary

* YAML allows the de/serialization of arbitrary objects
* YAML libraries in Ruby allow the de/serialization of arbitary ruby objects
  + If the Ruby YAML implementation allocates and initializs the Ruby objects upon deserialization
    - Since symbols in Ruby aren’t garbage collected, a hash can be crafted to crash the stack
    - Some system calls can be sent

There are relevant differences in the Syck and Psych implementations I will later expand upon.

## Required Reading

* [What this means for your startup](http://www.kalzumeus.com/2013/01/31/what-the-rails-security-issue-means-for-your-startup/)

## Recommended Reading

* <http://tenderlovemaking.com/2013/02/06/yaml-f7u12.html>
* <http://blog.codeclimate.com/blog/2013/01/10/rails-remote-code-execution-vulnerability-explained>/
* <http://www.insinuator.net/2013/01/rails-yaml>/
* <http://www.reddit.com/r/netsec/comments/167c11/serious_vulnerability_in_ruby_on_rails_allowing>/
* <https://news.ycombinator.com/item?id=5028270>

## Supplemental Reading

* <https://github.com/tenderlove/psych/issues/119#issuecomment-12875715>
* <http://weblog.rubyonrails.org/2013/2/11/SEC-ANN-Rails-3-2-12-3-1-11-and-2-3-17-have-been-released>/
* <https://groups.google.com/forum/?fromgroups=#!topic/rubyonrails-security/61bkgvnSGTQ>
* <http://ronin-ruby.github.com/blog/2013/01/09/rails-pocs.html>
* <https://github.com/ronin-ruby/ronin-ruby.github.com/blob/rails-pocs/blog/_posts/2013-01-09-rails-pocs.md>
* <https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/http/rails_xml_yaml_scanner.rb>
* <https://community.rapid7.com/community/metasploit/blog/2013/01/09/serialization-mischief-in-ruby-land-cve-2013-0156>
* <https://community.rapid7.com/community/metasploit/blog/2013/01/10/exploiting-ruby-on-rails-with-metasploit-cve-2013-0156>

## Workarounds

### [SafeYaml](https://github.com/dtao/safe_yaml)

```
    SafeYAML::OPTIONS[:default_mode] = :unsafe
    SafeYAML::OPTIONS[:default_mode] = :safe

    # Ruby >= 1.9.3
    YAML.load(yaml, filename, :safe => true) # calls safe_load
    YAML.load(yaml, filename, :safe => false) # calls unsafe_load

    # Ruby < 1.9.3
    YAML.load(yaml, :safe => true) # calls safe_load
    YAML.load(yaml, :safe => false) # calls unsafe_load
    # The way that SafeYAML works is by restricting the kinds of objects that can be deserialized via YAML.load. More specifically, only the following types of objects can be deserialized by default:

    # Hashes
    # Arrays
    # Strings
    # Numbers
    # Dates
    # Times
    # Booleans
    # Nils

    # Using Syck (unfortunately, Syck and Psych use different tagging schemes)
    SafeYAML::OPTIONS[:whitelisted_tags] = ["tag:ruby.yaml.org,2002:object:OpenStruct"]

    # Using Psych
    SafeYAML::OPTIONS[:whitelisted_tags] = ["!ruby/object:OpenStruct"]

    # Don't sanitize disallowed types silently
    SafeYAML::OPTIONS[:raise_on_unknown_tag] = true

    # Symbols in Ruby are not garbage-collected; therefore enabling symbol deserialization in your application may leave you vulnerable to DOS attacks.
    # Guard: Uses YAML as a serialization format for notifications. The data serialized uses symbolic keys, so setting `SafeYAML::OPTIONS[:deserialize_symbols] = true` is necessary to allow Guard to work.
    # sidekiq: Uses a YAML configiuration file with symbolic keys, so setting `SafeYAML::OPTIONS[:deserialize_symbols] = true` should allow it to work.
```

see re: [PsychShield](https://github.com/dtao/safe_yaml/issues/22)

### [PsychShield](https://github.com/rapid7/psych_shield)

```
    # By default, Psych Shield allows the following types of objects:

    # Hash Array String Range
    # Numeric Fixnum Integer Bignum Float Rational Complex
    # Time DateTime
    # NilClass TrueClass FalseClass
    # To enable additional classes, add the stringified form using the "add" method:

    PsychShield.add('MyClass::IsAwesome::And::Safe')
    # To disable all classes (even the defaults), use the clear method:

    PsychShield.clear
```

* [Code 28](/categories#Code-ref)
* [top 43](/categories#top-ref)

* [yaml 1](/tags#yaml-ref)

---

* [← Previous](/2013/03/20/letter-to-my-past-self/ "Letter to my past self")
* [Archive](/archive)
* [Next →](/2013/04/03/mechanized-download/ "Downloading RubyTapas files with Mechanize")

---

---

© 2022 Benjamin Fleischer


