=== Content from security-tracker.debian.org_aaeeb733_20250126_023256.html ===

# CVE-2015-7225

| **Name** | CVE-2015-7225 |
| --- | --- |
| **Description** | Tinfoil Devise-two-factor before 2.0.0 does not strictly follow section 5.2 of RFC 6238 and does not "burn" a successfully validated one-time password (aka OTP), which allows remote or physically proximate attackers with a target user's login credentials to log in as said user by obtaining the OTP through performing a man-in-the-middle attack between the provider and verifier, or shoulder surfing, and replaying the OTP in the current time-step. |
| **Source** | [CVE](https://www.cve.org/CVERecord?id=CVE-2015-7225) (at [NVD](https://nvd.nist.gov/vuln/detail/CVE-2015-7225); [CERT](https://www.kb.cert.org/vuls/byid?searchview=&query=CVE-2015-7225), [LWN](https://lwn.net/Search/DoSearch?words=CVE-2015-7225), [oss-sec](https://marc.info/?l=oss-security&s=CVE-2015-7225), [fulldisc](https://marc.info/?l=full-disclosure&s=CVE-2015-7225), [Red Hat](https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2015-7225), [Ubuntu](https://people.canonical.com/~ubuntu-security/cve/CVE-2015-7225), [Gentoo](https://bugs.gentoo.org/show_bug.cgi?id=CVE-2015-7225), SUSE [bugzilla](https://bugzilla.suse.com/show_bug.cgi?id=CVE-2015-7225)/[CVE](https://www.suse.com/security/cve/CVE-2015-7225/), GitHub [advisories](https://github.com/advisories?query=CVE-2015-7225)/[code](https://github.com/search?type=Code&q=%22CVE-2015-7225%22)/[issues](https://github.com/search?type=Issues&q=%22CVE-2015-7225%22), [web search](https://duckduckgo.com/html?q=%22CVE-2015-7225%22), [more](https://oss-security.openwall.org/wiki/vendors)) |
| **Debian Bugs** | [798466](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=798466) |

## Vulnerable and fixed packages

The table below lists information on source packages.

| Source Package | Release | Version | Status |
| --- | --- | --- | --- |
| [ruby-devise-two-factor](/tracker/source-package/ruby-devise-two-factor) ([PTS](https://tracker.debian.org/pkg/ruby-devise-two-factor)) | bullseye | 3.1.0-2 | fixed |
|  | sid, bookworm | 4.0.2-1 | fixed |

The information below is based on the following data on fixed versions.

| Package | Type | Release | Fixed Version | Urgency | Origin | Debian Bugs |
| --- | --- | --- | --- | --- | --- | --- |
| [ruby-devise-two-factor](/tracker/source-package/ruby-devise-two-factor) | source | (unstable) | 2.0.0-1 |  |  | [798466](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=798466) |

## Notes

```
<https://www.openwall.com/lists/oss-security/2015/09/06/2>

```

---

Search for package or bug name:  [Reporting problems](/tracker/data/report)

[Home](/tracker/) - [Debian Security](https://www.debian.org/security/) - [Source](https://salsa.debian.org/security-tracker-team/security-tracker/blob/master/bin/tracker_service.py) [(Git)](https://salsa.debian.org/security-tracker-team/security-tracker)



=== Content from www.openwall.com_b176f381_20250124_172938.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2015/09/16/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <20150917142530.46F9A52E1E7@smtpvbsrv1.mitre.org>
Date: Thu, 17 Sep 2015 10:25:30 -0400 (EDT)
From: cve-assign@...re.org
To: me@...tinbull.ca
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: CVE Request: TOTP Replay Attack in Ruby library "devise-two-factor"

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

> Date: Sun, 6 Sep 2015 11:55:41 -0400

> Given an attacker already knows a victim's credentials, they could
> "shoulder surf" the victim's second factor device, obtaining the OTP,
> and login with the known credentials & OTP within the current
> time-step (a default 30 second window). This defeats two-factor
> authentication for the duration of the time-step.

This 2015-09-06 message is directly related to a discussion of CVE
assignment here on 2015-06-22, but doesn't mention that that
discussion had occurred. Specifically:

  <http://www.openwall.com/lists/oss-security/2015/06/22/2>

  From: cve-assign@...re.org

  devise-two-factor can potentially have a CVE ID. As you mentioned, the
  attack surface is somewhat narrow, and it might make more sense to see
  how the devise-two-factor vendor announces the update. For example, if
  the vendor makes a code change to prevent multiple submissions and
  describes the code change as resolving a vulnerability, then there can
  be a CVE ID.

The vendor did all of that, so we're assigning CVE-2015-7225.

[ relevant parts include 'to protect against "shoulder-surfing" attacks' in
<https://github.com/tinfoil/devise-two-factor/blob/master/UPGRADING.md> and
'While a valid security issue, this is a very narrow vulnerability' in
<https://github.com/tinfoil/devise-two-factor/issues/45#issuecomment-139335608> ]

- --
CVE assignment team, MITRE CVE Numbering Authority
M/S M300
202 Burlington Road, Bedford, MA 01730 USA
[ PGP key available through <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQIcBAEBCAAGBQJV+sz+AAoJEL54rhJi8gl5FkUQAIUNoqnHZHkc6ZY5OXkG1Si+
UIiPAUEtxTXe067zoZjEzqlsjzexzh0ld96XzD0kmfrCR0O/4tddpyX6n5Q7ooqI
VrVp+UDJO36/qDW/ODlxjbJoWD02TdHlWd5gZVb4h7uBSKbj4PItDAMx5VGZbJgP
msCoSOVG48odcGdbOKXR+Bb0zQQURq0s9Qxqwi28MT3IAXlyz9jjSrgyd7W4J87m
+SrS+dL8gH22BA0rNI7UUNeCRpBOmUt9i1QPRRi9nmPjTmBtGZ1AxUXQj/VFTe1c
fcwyvTHBsAslavhVEwbN2IzO+8ycuP55NVW90e2v2k977kHSTjiEpdJ8b3Hl7BtR
2Tu+uZjHIUvNoLznhag/+f9LL3yhxdpgPXlmYQNFeKcsaIxiXxaNF6zg8soRQDMi
f0hMP8yfBkwzSVZY2xl1QeZyww00+RY45WvLPilH7fkoCZmsT3ftxfQkurNViFAU
zCDyKmQIaHXIpcOrC9qLuWmSE02NB8Qod+XkBGOd1/tRDxzMBYoVSDabFfS3npBZ
qDK13djTq8rZKhlXrzdeTrmW5RwDhZrZSrNcdAh140lIL9DwkD/6n/JAubfH68Gn
uFGwgRSCUbNUP8nLJ97Rv81NHNP+XYcd+X3mHumJpPf/R94/dEwkAoi6ytQsE5pr
s9eZT7jONl8mzpQL1Vzl
=aeha
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_760bbf33_20250124_172942.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdevise-two-factor%2Fdevise-two-factor%2Fissues%2F45)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdevise-two-factor%2Fdevise-two-factor%2Fissues%2F45)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=devise-two-factor%2Fdevise-two-factor)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[devise-two-factor](/devise-two-factor)
/
**[devise-two-factor](/devise-two-factor/devise-two-factor)**
Public

* [Notifications](/login?return_to=%2Fdevise-two-factor%2Fdevise-two-factor) You must be signed in to change notification settings
* [Fork
  250](/login?return_to=%2Fdevise-two-factor%2Fdevise-two-factor)
* [Star
   1.2k](/login?return_to=%2Fdevise-two-factor%2Fdevise-two-factor)

* [Code](/devise-two-factor/devise-two-factor)
* [Issues
  33](/devise-two-factor/devise-two-factor/issues)
* [Pull requests
  11](/devise-two-factor/devise-two-factor/pulls)
* [Discussions](/devise-two-factor/devise-two-factor/discussions)
* [Actions](/devise-two-factor/devise-two-factor/actions)
* [Security](/devise-two-factor/devise-two-factor/security)
* [Insights](/devise-two-factor/devise-two-factor/pulse)

Additional navigation options

* [Code](/devise-two-factor/devise-two-factor)
* [Issues](/devise-two-factor/devise-two-factor/issues)
* [Pull requests](/devise-two-factor/devise-two-factor/pulls)
* [Discussions](/devise-two-factor/devise-two-factor/discussions)
* [Actions](/devise-two-factor/devise-two-factor/actions)
* [Security](/devise-two-factor/devise-two-factor/security)
* [Insights](/devise-two-factor/devise-two-factor/pulse)

# Security Bug #45

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Security Bug](#top)#45Copy link[![@balasankarc](https://avatars.githubusercontent.com/u/2379271?u=d9ed44326b04182de4322046b2571a802e6d0b42&v=4&size=80)](/balasankarc)
## Description

[![@balasankarc](https://avatars.githubusercontent.com/u/2379271?u=d9ed44326b04182de4322046b2571a802e6d0b42&v=4&size=48)](/balasankarc)[balasankarc](https://github.com/balasankarc)opened [on Sep 10, 2015](https://github.com/devise-two-factor/devise-two-factor/issues/45#issue-105797997)

Hi,

Can you take a look at <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=798466> ?

## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_0f2843c4_20250124_172937.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](../../../2015/06/21/1) [[thread-next>]](../../../2015/06/21/4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <0F109ADF-DF22-4D47-8810-6229FC0D4F73@justinbull.ca>
Date: Sat, 20 Jun 2015 17:12:27 -0400
From: Justin Bull <me@...tinbull.ca>
To: oss-security@...ts.openwall.com
Subject: CVE Request: MITM & Shoulder-surfing vuln in Ruby OTP/HOTP/TOTP library "ROPT"

Hello,

Please excuse me if I’m doing this incorrectly, this is my first time attempting to acquire a CVE ID for a discovered vulnerability.

NOTE: I have already sent a similar email to MITRE requesting a CVE ID, but been advised to submit here as well (then cancel the request to MITRE, since those poor folks deal with thousands of requests).

== Affected Software: ==

The Ruby One Time Password Library (<https://github.com/mdp/rotp>)

A ruby library for generating one time passwords (HOTP & TOTP) according to RFC 4226 and RFC 6238.

ROTP is compatible with the Google Authenticator available for Android and iPhone.

== Type of Attack: ==

- Man in The Middle
- Shoulder Surfing

== Versions affected: ==

All versions.

== Description of Vulnerability: ==

The TOTP feature of the software is not fully compliant with Section 5.2 of RFC 6238[1] and does not “burn” a successfully validated OTP.

When the provider sends a valid OTP to the verifier, the verify must not accept subsequent submissions of the same OTP in that given time step. That is, in order to maintain the “One-Time” aspect of a One-Time Password, it can be used once and only once.

== Impact / Attack: ==

In a two-factor authentication context, an attacker could Man-in-The-Middle the connection between the verifier and provider, obtain the username, password, & OTP values, and log in with the credentials within the current time step (a 30 second window, if defaults are used). Arguably, this defeats the two-factor authentication since the OTP can be replayed multiple times.

Alternatively, an attacker could “shoulder surf” the victim’s second factor device in lieu of compromising the connection.

This information has been captured in the bug report to the maintainer of ROTP[2].

== Solution: ==

None yet, the fix[3] is not merged into codebase and not released.

== Acknowledgements: ==

Thanks to Viliam Holub (<https://github.com/vilda>) for originally tipping me off to the RFC non-compliance in software that utilizes the ROTP library[4].

== References:==

[1]: <https://tools.ietf.org/html/rfc6238#section-5.2>
[2]: <https://github.com/mdp/rotp/issues/44>
[3]: <https://github.com/mdp/rotp/pull/45>
[4]: <https://github.com/tinfoil/devise-two-factor/issues/30>

Best Regards,

Justin Bull
PGP Fingerprint: E09D 38DE 8FB7 5745 2044 A0F4 1A2B DEAA 68FD B34C

Download attachment "[signature.asc](4/1)" of type "application/pgp-signature" (843 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from bugs.debian.org_3371b641_20250124_172940.html ===

# Debian Bug report logs - #798466 ruby-devise-two-factor: CVE-2015-7225: TOTP Replay Attack

[![version graph](version.cgi?collapse=1;fixed=ruby-devise-two-factor%2F2.0.0-1;width=2;absolute=0;found=ruby-devise-two-factor%2F1.1.0-1;package=ruby-devise-two-factor;height=2)](version.cgi?found=ruby-devise-two-factor%2F1.1.0-1;fixed=ruby-devise-two-factor%2F2.0.0-1;info=1;absolute=0;collapse=1;package=ruby-devise-two-factor)

Package:
[ruby-devise-two-factor](pkgreport.cgi?package=ruby-devise-two-factor);
Maintainer for [ruby-devise-two-factor](pkgreport.cgi?package=ruby-devise-two-factor) is [Debian Ruby Team <pkg-ruby-extras-maintainers@lists.alioth.debian.org>](pkgreport.cgi?maint=pkg-ruby-extras-maintainers%40lists.alioth.debian.org); Source for [ruby-devise-two-factor](pkgreport.cgi?package=ruby-devise-two-factor) is [src:ruby-devise-two-factor](pkgreport.cgi?src=ruby-devise-two-factor) ([PTS](https://tracker.debian.org/pkg/ruby-devise-two-factor), [buildd](https://buildd.debian.org/ruby-devise-two-factor), [popcon](https://qa.debian.org/popcon.php?package=ruby-devise-two-factor)).

Reported by: [Moritz Muehlenhoff <jmm@inutil.org>](pkgreport.cgi?submitter=jmm%40inutil.org)

Date: Wed, 9 Sep 2015 17:45:02 UTC

Severity: *grave*

Tags: fixed-upstream, security

Found in version ruby-devise-two-factor/1.1.0-1

Fixed in version ruby-devise-two-factor/2.0.0-1

**Done:** Balasankar C <balasankarc@autistici.org>

Bug is archived. No further changes may be made.

Forwarded to <https://github.com/tinfoil/devise-two-factor/issues/45>

Display info messages

View this report as an [mbox folder](bugreport.cgi?bug=798466;mbox=yes), [status mbox](bugreport.cgi?bug=798466;mbox=yes;mboxstatus=yes), [maintainer mbox](bugreport.cgi?bug=798466;mbox=yes;mboxmaint=yes)

---

**Report forwarded**
to `debian-bugs-dist@lists.debian.org, team@security.debian.org, secure-testing-team@lists.alioth.debian.org, Debian Ruby Extras Maintainers <pkg-ruby-extras-maintainers@lists.alioth.debian.org>`:

`Bug#798466`; Package `ruby-devise-two-factor`.
(Wed, 09 Sep 2015 17:45:05 GMT) ([full text](bugreport.cgi?bug=798466;msg=2), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=2), [link](#1)).

---

**Acknowledgement sent**
to `Moritz Muehlenhoff <jmm@inutil.org>`:

New Bug report received and forwarded. Copy sent to `team@security.debian.org, secure-testing-team@lists.alioth.debian.org, Debian Ruby Extras Maintainers <pkg-ruby-extras-maintainers@lists.alioth.debian.org>`.
(Wed, 09 Sep 2015 17:45:05 GMT) ([full text](bugreport.cgi?bug=798466;msg=4), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=4), [link](#3)).

---

[Message #5](#5) received at submit@bugs.debian.org ([full text](bugreport.cgi?bug=798466;msg=5), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=5), reply):

![](/cgi-bin/libravatar.cgi?email=jmm%40inutil.org)
From: Moritz Muehlenhoff <jmm@inutil.org>
To: Debian Bug Tracking System <submit@bugs.debian.org>
Subject: ruby-devise-two-factor: TOTP Replay Attack (no CVE yet)
Date: Wed, 09 Sep 2015 19:10:29 +0200
```
Package: ruby-devise-two-factor
Severity: grave
Tags: security
Justification: user security hole

Hi,
please see <http://www.openwall.com/lists/oss-security/2015/09/06/2>
for details.

Cheers,
        Moritz

```

---

**Marked as found in versions ruby-devise-two-factor/1.1.0-1.**
Request was from `Salvatore Bonaccorso <carnil@debian.org>`
to `control@bugs.debian.org`.
(Thu, 10 Sep 2015 12:06:13 GMT) ([full text](bugreport.cgi?bug=798466;msg=7), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=7), [link](#6)).

---

**Set Bug forwarded-to-address to '<https://github.com/tinfoil/devise-two-factor/issues/45>'.**
Request was from `Balasankar C <balasankarc@autistici.org>`
to `control@bugs.debian.org`.
(Thu, 10 Sep 2015 18:51:03 GMT) ([full text](bugreport.cgi?bug=798466;msg=9), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=9), [link](#8)).

---

**Added tag(s) fixed-upstream.**
Request was from `bts-link-upstream@lists.alioth.debian.org`
to `control@bugs.debian.org`.
(Thu, 17 Sep 2015 17:09:12 GMT) ([full text](bugreport.cgi?bug=798466;msg=11), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=11), [link](#10)).

---

**Information forwarded**
to `debian-bugs-dist@lists.debian.org, Debian Ruby Extras Maintainers <pkg-ruby-extras-maintainers@lists.alioth.debian.org>`:

`Bug#798466`; Package `ruby-devise-two-factor`.
(Thu, 17 Sep 2015 17:54:03 GMT) ([full text](bugreport.cgi?bug=798466;msg=13), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=13), [link](#12)).

---

**Acknowledgement sent**
to `Salvatore Bonaccorso <carnil@debian.org>`:

Extra info received and forwarded to list. Copy sent to `Debian Ruby Extras Maintainers <pkg-ruby-extras-maintainers@lists.alioth.debian.org>`.
(Thu, 17 Sep 2015 17:54:03 GMT) ([full text](bugreport.cgi?bug=798466;msg=15), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=15), [link](#14)).

---

[Message #16](#16) received at 798466@bugs.debian.org ([full text](bugreport.cgi?bug=798466;msg=16), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=16), reply):

![](/cgi-bin/libravatar.cgi?email=carnil%40debian.org)
From: Salvatore Bonaccorso <carnil@debian.org>
To: Moritz Muehlenhoff <jmm@inutil.org>, 798466@bugs.debian.org
Subject: Re: Bug#798466: ruby-devise-two-factor: TOTP Replay Attack (no CVE
yet)
Date: Thu, 17 Sep 2015 19:51:29 +0200
```
Control: retitle ruby-devise-two-factor: [CVE-2015-7225](https://security-tracker.debian.org/tracker/CVE-2015-7225): TOTP Replay Attack

Hi,

On Wed, Sep 09, 2015 at 07:10:29PM +0200, Moritz Muehlenhoff wrote:
> Package: ruby-devise-two-factor
> Severity: grave
> Tags: security
> Justification: user security hole
>
> Hi,
> please see <http://www.openwall.com/lists/oss-security/2015/09/06/2>
> for details.

[CVE-2015-7225](https://security-tracker.debian.org/tracker/CVE-2015-7225) has now been assigned for this issue.

Regards,
Salvatore

```

---

**Changed Bug title to 'ruby-devise-two-factor: CVE-2015-7225: TOTP Replay Attack' from 'ruby-devise-two-factor: TOTP Replay Attack (no CVE yet)'**
Request was from `Salvatore Bonaccorso <carnil@debian.org>`
to `control@bugs.debian.org`.
(Thu, 17 Sep 2015 18:00:08 GMT) ([full text](bugreport.cgi?bug=798466;msg=18), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=18), [link](#17)).

---

**Reply sent**
to `Balasankar C <balasankarc@autistici.org>`:

You have taken responsibility.
(Thu, 17 Sep 2015 18:39:04 GMT) ([full text](bugreport.cgi?bug=798466;msg=20), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=20), [link](#19)).

---

**Notification sent**
to `Moritz Muehlenhoff <jmm@inutil.org>`:

Bug acknowledged by developer.
(Thu, 17 Sep 2015 18:39:04 GMT) ([full text](bugreport.cgi?bug=798466;msg=22), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=22), [link](#21)).

---

[Message #23](#23) received at 798466-close@bugs.debian.org ([full text](bugreport.cgi?bug=798466;msg=23), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=23), reply):

![](/cgi-bin/libravatar.cgi?email=balasankarc%40autistici.org)
From: Balasankar C <balasankarc@autistici.org>
To: 798466-close@bugs.debian.org
Subject: Bug#798466: fixed in ruby-devise-two-factor 2.0.0-1
Date: Thu, 17 Sep 2015 18:36:13 +0000
```
Source: ruby-devise-two-factor
Source-Version: 2.0.0-1

We believe that the bug you reported is fixed in the latest version of
ruby-devise-two-factor, which is due to be installed in the Debian FTP archive.

A summary of the changes between this version and the previous one is
attached.

Thank you for reporting the bug, which will now be closed.  If you
have further comments please address them to 798466@bugs.debian.org,
and the maintainer will reopen the bug report if appropriate.

Debian distribution maintenance software
pp.
Balasankar C <balasankarc@autistici.org> (supplier of updated ruby-devise-two-factor package)

(This message was generated automatically at their request; if you
believe that there is a problem with it please contact the archive
administrators by mailing ftpmaster@ftp-master.debian.org)

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Format: 1.8
Date: Thu, 17 Sep 2015 23:35:16 +0530
Source: ruby-devise-two-factor
Binary: ruby-devise-two-factor
Architecture: source all
Version: 2.0.0-1
Distribution: unstable
Urgency: medium
Maintainer: Debian Ruby Extras Maintainers <pkg-ruby-extras-maintainers@lists.alioth.debian.org>
Changed-By: Balasankar C <balasankarc@autistici.org>
Description:
 ruby-devise-two-factor - Barebones two-factor authentication with Devise
Closes: [798466](bugreport.cgi?bug=798466)
Changes:
 ruby-devise-two-factor (2.0.0-1) unstable; urgency=medium
 .
   * Upstream update.
   * Upstream fixed [CVE-2015-7225](https://security-tracker.debian.org/tracker/CVE-2015-7225) (Closes: #[798466](bugreport.cgi?bug=798466))
   * Bump debhelper compatibility to 9
Checksums-Sha1:
 79b7937d6cfe3c34c809679934a47b0b9b41fded 1980 ruby-devise-two-factor_2.0.0-1.dsc
 a9b3a683c62cb3a85b69352fcd22942976ab0910 31864 ruby-devise-two-factor_2.0.0.orig.tar.gz
 69011bd8b7057cdd5957445172b7c99066a9405a 3024 ruby-devise-two-factor_2.0.0-1.debian.tar.xz
 090839d598523659abd60ee2f59b8feb77f031d3 12072 ruby-devise-two-factor_2.0.0-1_all.deb
Checksums-Sha256:
 e1f31844f7899902343926eed7a2df92141b6144e6638a1a41ecd23a32fd469e 1980 ruby-devise-two-factor_2.0.0-1.dsc
 5502b15dc5fac722776dc35d62cf021504183da60c841dbd6b5b2a335c5e4cc6 31864 ruby-devise-two-factor_2.0.0.orig.tar.gz
 6e71ee5ceb6628823b117d64254f685d72e368c623630e7fb88d79ceea7dd781 3024 ruby-devise-two-factor_2.0.0-1.debian.tar.xz
 d337675da72d86c3f38f5a61dc02b71578d944b0f6d1ee5e1ff39159ce5b3472 12072 ruby-devise-two-factor_2.0.0-1_all.deb
Files:
 a21ab74517c8d75c57ad01733bacead5 1980 ruby optional ruby-devise-two-factor_2.0.0-1.dsc
 3c7d2cf0ea4bd93f5229e76335551f61 31864 ruby optional ruby-devise-two-factor_2.0.0.orig.tar.gz
 8cf7a11952b0ad4b8b571578a242c1ac 3024 ruby optional ruby-devise-two-factor_2.0.0-1.debian.tar.xz
 e79b91d8dc9e07e31369474673feb875 12072 ruby optional ruby-devise-two-factor_2.0.0-1_all.deb

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQEcBAEBCgAGBQJV+wR6AAoJEJbtq5sua3FxLCwH/jDrIDEmdXcmvh1KZKtyoeR2
vzJdtWgFDq1NIyOHcMGO4V/Jdxajyr8KbsGGD3RHgP1K+M8kL5vM2BA0qhoxHkIe
fpKKAVct59XFTxVpUCf171cBwsjCASyzMs2u+dFZK78IbSF20A2AKPLVz2BCvK0v
MniA8Cms0JOVIEkFbz9OH8ZkolxIrrAfTeaSoCPp19VNbBg3kFR4yN0EIEfcTjaY
5hA7jB0QndU/oxQf22bj+5WSpB2gj2JWHuHhnD6MD50slzPbLj/vjAj0tqd0QYvB
6zwg4CDJ/dSpq8tqR46iIgbTXGtKKPikoOUGBQ56Gqzo22B+ol6Y9BLfBx9Zgzs=
=4J5f
-----END PGP SIGNATURE-----

```

---

**Bug archived.**
Request was from `Debbugs Internal Request <owner@bugs.debian.org>`
to `internal_control@bugs.debian.org`.
(Fri, 16 Oct 2015 07:33:50 GMT) ([full text](bugreport.cgi?bug=798466;msg=25), [mbox](bugreport.cgi?bug=798466;mbox=yes;msg=25), [link](#24)).

---

Send a report that [this bug log contains spam](https://bugs.debian.org/cgi-bin/bugspam.cgi?bug=798466).

---

Debian bug tracking system administrator <owner@bugs.debian.org>.
Last modified:
Fri Jan 24 17:29:39 2025;
Machine Name:
buxtehude

[Debian Bug tracking system](https://www.debian.org/Bugs/)

Debbugs is free software and licensed under the terms of the GNU General
Public License version 2. The current version can be obtained
from <https://bugs.debian.org/debbugs-source/>.

Copyright © 1999 Darren O. Benham,
1997,2003 nCipher Corporation Ltd,
1994-97 Ian Jackson,
2005-2017 Don Armstrong, and many other contributors.



=== Content from github.com_008c8546_20250126_023255.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdevise-two-factor%2Fdevise-two-factor%2Fblob%2Fmain%2FUPGRADING.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdevise-two-factor%2Fdevise-two-factor%2Fblob%2Fmain%2FUPGRADING.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=devise-two-factor%2Fdevise-two-factor)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[devise-two-factor](/devise-two-factor)
/
**[devise-two-factor](/devise-two-factor/devise-two-factor)**
Public

* [Notifications](/login?return_to=%2Fdevise-two-factor%2Fdevise-two-factor) You must be signed in to change notification settings
* [Fork
  250](/login?return_to=%2Fdevise-two-factor%2Fdevise-two-factor)
* [Star
   1.2k](/login?return_to=%2Fdevise-two-factor%2Fdevise-two-factor)

* [Code](/devise-two-factor/devise-two-factor)
* [Issues
  33](/devise-two-factor/devise-two-factor/issues)
* [Pull requests
  11](/devise-two-factor/devise-two-factor/pulls)
* [Discussions](/devise-two-factor/devise-two-factor/discussions)
* [Actions](/devise-two-factor/devise-two-factor/actions)
* [Security](/devise-two-factor/devise-two-factor/security)
* [Insights](/devise-two-factor/devise-two-factor/pulse)

Additional navigation options

* [Code](/devise-two-factor/devise-two-factor)
* [Issues](/devise-two-factor/devise-two-factor/issues)
* [Pull requests](/devise-two-factor/devise-two-factor/pulls)
* [Discussions](/devise-two-factor/devise-two-factor/discussions)
* [Actions](/devise-two-factor/devise-two-factor/actions)
* [Security](/devise-two-factor/devise-two-factor/security)
* [Insights](/devise-two-factor/devise-two-factor/pulse)

## Files

 main
## Breadcrumbs

1. [devise-two-factor](/devise-two-factor/devise-two-factor/tree/main)
/
# UPGRADING.md

Copy path Blame  Blame
## Latest commit

## History

[History](/devise-two-factor/devise-two-factor/commits/main/UPGRADING.md)249 lines (194 loc) · 11.8 KB main
## Breadcrumbs

1. [devise-two-factor](/devise-two-factor/devise-two-factor/tree/main)
/
# UPGRADING.md

Top
## File metadata and controls

* Preview
* Code
* Blame

249 lines (194 loc) · 11.8 KB[Raw](https://github.com/devise-two-factor/devise-two-factor/raw/refs/heads/main/UPGRADING.md)
# Upgrading

## Upgrading from 5.x to 6.x

### save!

`consume_otp!` and `invalidate_otp_backup_code!` now call `save!` instead of `save` (or nothing at all in the case of `invalidate_otp_backup_code!`). If you manually called `save`/`save!` after calling `invalidate_otp_backup_code!` you may be able to remove it.

### Secret Lengths

The `otp_secret_length` and `otp_backup_code_length` options have changed to be the number of random bytes that are generated.
If you had configured these values you may want to change them if you wish to keep the same output length.

`otp_secret_length` now has a default value of 20, generating a 160 bit secret key with an output length length of 32 bytes.

`otp_backup_code_length` now has a default value of 16, generating a 32 byte backup code.

## Upgrading from 4.x to 5.x

### Background

#### Database columns in version 4.x and older

Versions 4.x and older stored the OTP secret in an attribute called `encrypted_otp_secret` using the [attr\_encrypted](https://github.com/attr-encrypted/attr_encrypted) gem. This gem is currently unmaintained which is part of the motivation for moving to Rails encrypted attributes. This attribute was backed by three database columns:

```
encrypted_otp_secret
encrypted_otp_secret_iv
encrypted_otp_secret_salt

```

Two other columns were also created:

```
consumed_timestep
otp_required_for_login

```

A fresh install of 4.x would create all five of the database columns above.

#### Database columns in version 5.x and later

Versions 5+ of this gem uses a single [Rails 7+ encrypted attribute](https://edgeguides.rubyonrails.org/active_record_encryption.html) named `otp_secret`to store the OTP secret in the database table (usually `users` but will be whatever model you picked).

A fresh install of 5+ will add the following columns to your `users` table:

```
otp_secret # this replaces encrypted_otp_secret, encrypted_otp_secret_iv, encrypted_otp_secret_salt
consumed_timestep
otp_required_for_login
```

We have attempted to make the upgrade as painless as possible but unfortunately because of the secret storage change, it cannot be as simple as `bundle update devise-two-factor` ❤️

### Assumptions

This guide assumes you are upgrading an existing Rails 6 app (with `devise` and `devise-two-factor`) to Rails 7.

This gem must be upgraded **as part of a Rails 7 upgrade**. See [the official Rails upgrading guide](https://guides.rubyonrails.org/upgrading_ruby_on_rails.html) for an overview of upgrading Rails.

### Phase 1: Upgrading devise-two-factor as part of Rails 7 upgrade

1. Update the version constraint for Rails in your `Gemfile` to your desired version e.g. `gem "rails", "~> 7.0.3"`
2. Run `bundle install` and resolve any issues with dependencies.
3. Update the version constraint for `devise-two-factor` in your `Gemfile` to the the latest version (must be at least 5.x e.g. `~> 5.0`
4. Run `./bin/rails app:update` as per the [Rails upgrade guide](https://guides.rubyonrails.org/upgrading_ruby_on_rails.html) and tweak the output as required for your app.
5. Run `./bin/rails db:migrate` to update your DB based on the changes made by `app:update`
6. Add a new `otp_secret` attribute to your user model
   ```
   # TODO: replace 'User' in the migration name with the name of your user model
   ./bin/rails g migration AddOtpSecretToUser otp_secret:string
   ./bin/rails db:migrate
   ```
7. Add a `legacy_otp_secret` method to your user model e.g. `User`.

* This method is used by the gem to find and decode the OTP secret from the legacy database columns.
* The implementation shown below works if you set up devise-two-factor with the settings suggested in the [OLD README](https://github.com/devise-two-factor/devise-two-factor/blob/8d74f5ee45594bf00e60d5d49eb6fcde82c2d2ba/README.md).
* If you have customised the encryption scheme used to store the OTP secret then you will need to update this method to match.
* If you are unsure, you should try the method below as is, and if you can still sign in users with OTP enabled then all is well.
  ```
  class User
    # ...

    private

    ##
    # Decrypt and return the `encrypted_otp_secret` attribute which was used in
    # prior versions of devise-two-factor
    # @return [String] The decrypted OTP secret
    def legacy_otp_secret
      return nil unless self[:encrypted_otp_secret]
      return nil unless self.class.otp_secret_encryption_key

      hmac_iterations = 2000 # a default set by the Encryptor gem
      key = self.class.otp_secret_encryption_key
      salt = Base64.decode64(encrypted_otp_secret_salt)
      iv = Base64.decode64(encrypted_otp_secret_iv)

      raw_cipher_text = Base64.decode64(encrypted_otp_secret)
      # The last 16 bytes of the ciphertext are the authentication tag - we use
      # Galois Counter Mode which is an authenticated encryption mode
      cipher_text = raw_cipher_text[0..-17]
      auth_tag =  raw_cipher_text[-16..-1]

      # this algorithm lifted from
      # https://github.com/attr-encrypted/encryptor/blob/master/lib/encryptor.rb#L54

      # create an OpenSSL object which will decrypt the AES cipher with 256 bit
      # keys in Galois Counter Mode (GCM). See
      # https://ruby.github.io/openssl/OpenSSL/Cipher.html
      cipher = OpenSSL::Cipher.new('aes-256-gcm')

      # tell the cipher we want to decrypt. Symmetric algorithms use a very
      # similar process for encryption and decryption, hence the same object can
      # do both.
      cipher.decrypt

      # Use a Password-Based Key Derivation Function to generate the key actually
      # used for encryption from the key we got as input.
      cipher.key = OpenSSL::PKCS5.pbkdf2_hmac_sha1(key, salt, hmac_iterations, cipher.key_len)

      # set the Initialization Vector (IV)
      cipher.iv = iv

      # The tag must be set after calling Cipher#decrypt, Cipher#key= and
      # Cipher#iv=, but before calling Cipher#final. After all decryption is
      # performed, the tag is verified automatically in the call to Cipher#final.
      #
      # If the auth_tag does not verify, then #final will raise OpenSSL::Cipher::CipherError
      cipher.auth_tag = auth_tag

      # auth_data must be set after auth_tag has been set when decrypting See
      # http://ruby-doc.org/stdlib-2.0.0/libdoc/openssl/rdoc/OpenSSL/Cipher.html#method-i-auth_data-3D
      # we are not adding any authenticated data but OpenSSL docs say this should
      # still be called.
      cipher.auth_data = ''

      # #update is (somewhat confusingly named) the method which actually
      # performs the decryption on the given chunk of data. Our OTP secret is
      # short so we only need to call it once.
      #
      # It is very important that we call #final because:
      #
      # 1. The authentication tag is checked during the call to #final
      # 2. Block based cipher modes (e.g. CBC) work on fixed size chunks. We need
      #    to call #final to get it to process the last chunk properly. The output
      #    of #final should be appended to the decrypted value. This isn't
      #    required for streaming cipher modes but including it is a best practice
      #    so that your code will continue to function correctly even if you later
      #    change to a block cipher mode.
      cipher.update(cipher_text) + cipher.final
    end
  end
  ```

2. Set up [Rails encrypted secrets](https://edgeguides.rubyonrails.org/active_record_encryption.html)
   ```
   ./bin/rails db:encryption:init
   # capture the output and put in encrypted credentials via
   ./bin/rails credentials:edit
   ```
3. Complete your Rails 7 upgrade (making whatever other changes are required)

You can now deploy your upgraded application and devise-two-factor should work as before.

This gem will fall back to **reading** the OTP secret from the legacy columns if it cannot find one in the new `otp_secret` column. When you **write** a new OTP secret it will always be written to the new `otp_secret` column.

### Phase 2: Clean up

This "clean up" phase can happen at the same time as your initial deployment but teams managing existing apps will likely want to do clean-up as separate, later deployments.

1. Create a rake task to copy the OTP secret for each user from the legacy column to the new `otp_secret` column. This prepares the way for us to remove the legacy columns in a later step.
   ```
   # lib/tasks/devise_two_factor_migration.rake

   # Use this as a starting point for your task to migrate your user's OTP secrets.
   namespace :devise_two_factor do
     desc "Copy devise_two_factor OTP secret from old format to new format"
     task copy_otp_secret_to_rails7_encrypted_attr: [:environment] do
       # TODO: change User to your user model
       User.find_each do |user| # find_each finds in batches of 1,000 by default
         otp_secret = user.otp_secret # read from otp_secret column, fall back to legacy columns if new column is empty
         puts "Processing #{user.email}"
         user.update!(otp_secret: otp_secret)
       end
     end
   end
   ```
2. Remove the `#legacy_otp_secret` method from your user model (e.g. `User`) because it is no longer required.
3. Remove the now unused legacy columns from the database. This assumes you have run a rake task as in the previous step to migrate all the legacy stored secrets to the new storage.
   ```
   # TODO: replace 'Users' in migration name with the name of your user model
   ./bin/rails g migration RemoveLegacyDeviseTwoFactorSecretsFromUsers
   ```

   which generates
   ```
   class RemoveLegacyDeviseTwoFactorSecretsFromUsers < ActiveRecord::Migration[7.0]
     def change
       # TODO: change :users to whatever your users table is

       # WARNING: Only run this when you are confident you have copied the OTP
       # secret for ALL users from `encrypted_otp_secret` to `otp_secret`!
       remove_column :users, :encrypted_otp_secret
       remove_column :users, :encrypted_otp_secret_iv
       remove_column :users, :encrypted_otp_secret_salt
     end
   end
   ```
4. Remove `otp_secret_encryption_key` from the model setup. This also assumes you successfully ran the rake task in step 1.
   ```
   # from this:
   devise :two_factor_authenticatable,
       otp_secret_encryption_key: ENV['YOUR_ENCRYPTION_KEY_HERE']

   # to this:
   devise :two_factor_authenticatable
   ```

## Upgrading from 2.x to 3.x

Pull request #76 allows for compatibility with `attr_encrypted` 3.0, which should be used due to a security vulnerability discovered in 2.0.

Pull request #73 allows for compatibility with `attr_encrypted` 2.0. This version changes many of the defaults which must be taken into account to avoid corrupted OTP secrets on your model.

Due to new security practices in `attr_encrypted` an encryption key with insufficient length will cause an error. If you run into this, you may set `insecure_mode: true` in the `attr_encrypted` options.

You should initially add compatibility by specifying the `attr_encrypted` attribute in your model (`User` for these examples) with the old default encryption algorithm before invoking `devise :two_factor_authenticatable`:

```
class User < ActiveRecord::Base
  attr_encrypted :otp_secret,
    :key       => self.otp_secret_encryption_key,
    :mode      => :per_attribute_iv_and_salt,
    :algorithm => 'aes-256-cbc'

  devise :two_factor_authenticatable,
         :otp_secret_encryption_key => ENV['DEVISE_TWO_FACTOR_ENCRYPTION_KEY']
```

## Upgrading from 1.x to 2.x

Pull request #43 added a new field to protect against "shoulder-surfing" attacks. If upgrading, you'll need to add the `:consumed_timestep` column to your `Users` model.

```
class AddConsumedTimestepToUsers < ActiveRecord::Migration
  def change
    add_column :users, :consumed_timestep, :integer
  end
end
```

All uses of the `valid_otp?` method should be switched to `validate_and_consume_otp!`

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


