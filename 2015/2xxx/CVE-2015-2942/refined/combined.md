=== Content from www.openwall.com_473cc16a_20250125_153253.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2015/03/31/9) [[next>]](2) [[thread-next>]](../../../2015/04/07/3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAKcmtDzP7GhQWdTNb2XaVD1dzfDPXzyjWRhoYaKPrZy+NALygA@mail.gmail.com>
Date: Tue, 31 Mar 2015 18:34:21 -0700
From: Chris Steipp <csteipp@...imedia.org>
To: oss-security@...ts.openwall.com
Subject: CVE request: MediaWiki 1.24.2/1.23.9/1.19.24

Hi, we patched several security issues in MediaWiki today. Could we get
CVE's assigned?

* iSEC Partners discovered a way to circumvent the SVG MIME blacklist for
embedded resources (iSEC-WMF1214-11). This allowed an attacker to embed
JavaScript in the SVG. The issue was additionally identified by Mario
Heiderich / Cure53. MIME types are now whitelisted.
<<https://phabricator.wikimedia.org/T85850>>

* MediaWiki user Bawolff pointed out that the SVG filter to prevent
injecting JavaScript using animate elements was incorrect.
<<https://phabricator.wikimedia.org/T86711>>

* MediaWiki user Bawolff reported a stored XSS vulnerability due to the way
attributes were expanded in MediaWiki's Html class, in combination with
LanguageConverter substitutions.
<<https://phabricator.wikimedia.org/T73394>>

* Internal review discovered that MediaWiki's SVG filtering could be
bypassed with entity encoding under the Zend interpreter. This could be
used to inject JavaScript. This issue was also discovered by Mario Gomes /
Beyond Security.
<<https://phabricator.wikimedia.org/T88310>>

* iSEC Partners discovered a way to bypass the style filtering for SVG
files (iSEC-WMF1214-3) to load external resource. This could violate the
anonymity of users viewing the SVG.
<<https://phabricator.wikimedia.org/T85349>>

* Internal review and iSEC Partners discovered (iSEC-WMF1214-1) that
MediaWiki versions using PBKDF2 for password hashing (the default since
1.24) are vulnerable to DoS attacks using extremely long passwords.
<<https://phabricator.wikimedia.org/T64685>>

* Internal review found that MediaWiki is vulnerable to "Quadratic Blowup"
DoS attacks, under both HHVM and Zend PHP.
<<https://phabricator.wikimedia.org/T71210>>

* iSEC Partners reported that the MediaWiki feature allowing a user to
preview another user's custom JavaScript could be abused for privilege
escalation (iSEC-WMF1214-10). This feature has been removed.
<<https://phabricator.wikimedia.org/T85855>>

* Extension:Scribunto - MediaWiki user Jackmcbarn discovered that function
names were sanitized in Lua error backtraces, which could lead to XSS.
<<https://phabricator.wikimedia.org/T85113>>

* Extension:CheckUser - iSEC Partners discovered that the CheckUser
extension did not prevent CSRF attacks on the form allowing checkusers to
look up sensitive information about other users (iSEC-WMF1214-6). Since the
use of CheckUser is logged, the CSRF could be abused to defame a trusted
user or flood the logs with noise.
<<https://phabricator.wikimedia.org/T85858>>

These next issues came up because of the difference in how HHVM handles PHP
code vs Zend. I'm not sure if CVE's are assigned for specific runtime
configurations? For MediaWiki, we say that HHVM support is experimental,
although we do run Wikipedia on it.

* iSEC Partners discovered a XSS vulnerability in the way api errors were
reflected under HHVM versions before 3.6.1 (iSEC-WMF1214-8). MediaWiki now
detects and mitigates this issue on older versions of HHVM.
<<https://phabricator.wikimedia.org/T85851>>

* iSEC Partners discovered that MediaWiki's SVG and XMP parsing running
under HHVM was susceptible to "Billion Laughs" DoS attacks
(iSEC-WMF1214-13).
<<https://phabricator.wikimedia.org/T85848>>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from security.gentoo.org_ee772b69_20250125_153259.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# MediaWiki: Multiple vulnerabilities — GLSA **201510-05**

Multiple vulnerabilities have been found in MediaWiki, the worst of
which may allow remote attackers to cause a Denial of Service.

### Affected packages

| Package | **www-apps/mediawiki** on all architectures |
| --- | --- |
| Affected versions | < **1.25.2** |
| Unaffected versions | >= **1.25.2**revision >= **1.24.3**revision >= **1.23.10** |

### Background

MediaWiki is a collaborative editing software used by large projects
such as Wikipedia.

### Description

Multiple vulnerabilities have been discovered in MediaWiki. Please
review the CVE identifiers referenced below for details.

### Impact

A remote attacker may be able to create a Denial of Service condition,
obtain sensitive information, bypass security restrictions, and inject
arbitrary web script or HTML.

### Workaround

There is no known workaround at this time.

### Resolution

All MediaWiki 1.25 users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-apps/mediawiki-1.25.2"

```

All MediaWiki 1.24 users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-apps/mediawiki-1.24.3"

```

All MediaWiki 1.23 users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-apps/mediawiki-1.23.10"

```
### References

* [CVE-2015-2931](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2931)
* [CVE-2015-2932](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2932)
* [CVE-2015-2933](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2933)
* [CVE-2015-2934](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2934)
* [CVE-2015-2935](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2935)
* [CVE-2015-2936](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2936)
* [CVE-2015-2937](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2937)
* [CVE-2015-2938](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2938)
* [CVE-2015-2939](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2939)
* [CVE-2015-2940](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2940)
* [CVE-2015-2941](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2941)
* [CVE-2015-2942](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-2942)
* [CVE-2015-6728](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6728)
* [CVE-2015-6729](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6729)
* [CVE-2015-6730](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6730)
* [CVE-2015-6731](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6731)
* [CVE-2015-6732](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6732)
* [CVE-2015-6733](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6733)
* [CVE-2015-6734](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6734)
* [CVE-2015-6735](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6735)
* [CVE-2015-6736](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6736)
* [CVE-2015-6737](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2015-6737)

**Release date**

October 31, 2015

**Latest revision**

October 31, 2015: 1

**Severity**

normal

**Exploitable**

remote

**Bugzilla entries**

* [545944](https://bugs.gentoo.org/show_bug.cgi?id=545944)
* [557844](https://bugs.gentoo.org/show_bug.cgi?id=557844)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from phabricator.wikimedia.org_51ce9b9c_20250126_095553.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT71210)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T71210
# MediaWiki is vulnerable to XML quadratic blowup attacksClosed, Resolved[Public](/policy/explain/PHID-TASK-76n62uwrt6xcmuizwyed/view/)Actions

* [Edit Task](/maniphest/task/edit/71210/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/71210/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-76n62uwrt6xcmuizwyed/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-76n62uwrt6xcmuizwyed/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-76n62uwrt6xcmuizwyed/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-76n62uwrt6xcmuizwyed/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-76n62uwrt6xcmuizwyed/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-76n62uwrt6xcmuizwyed/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-76n62uwrt6xcmuizwyed/)
* [Protect as security issue](/wmf/escalate-task/71210/)
* [Award Token](/token/give/PHID-TASK-76n62uwrt6xcmuizwyed/)
* [Flag For Later](/flag/edit/PHID-TASK-76n62uwrt6xcmuizwyed/)

Assigned To

|  | [• csteipp](/p/csteipp/) |
| --- | --- |

Authored By

|  | [• csteipp](/p/csteipp/) |
| --- | --- |
| Aug 6 2014, 11:14 PM2014-08-06 23:14:00 (UTC+0) |

Tags

* [Security-Core](/tag/security-core/) [(Backlog)](/project/board/427/)
* [Vuln-DoS](/tag/vuln-dos/) [(Tracked)](/project/board/1446/)
* [Security](/tag/security/)
Referenced Files

|  | [F40488: qbs2.svg](/F40488) |
| --- | --- |
| Feb 12 2015, 9:37 PM2015-02-12 21:37:32 (UTC+0) |

Subscribers

|  | [• csteipp](/p/csteipp/) |
| --- | --- |

|  | [Grunny](/p/Grunny/) |
| --- | --- |

|  | [ProgramCeltic](/p/ProgramCeltic/) |
| --- | --- |

# Description

When xml\_parse is used to process xml, and the data is buffered (like we do in XmlTypeCheck and XMPReader), it can exhaust memory up to php's configured memory\_limit.

---

**Version**: unspecified

**Severity**: normal

**Type**: DoS

**CVE**: CVE-2015-2937

# Details

Reference bz69210
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T88120 [Release MW 1.24.2 and 1.23.9 tarballs](/T88120) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85862 [Make iSec assessment public](/T85862) |
|  |  | Declined |  | [• csteipp](/p/csteipp/) | T85860 [User access roles are public](/T85860) |
|  |  | Resolved |  | [Bawolff](/p/Bawolff/) | T85856 [Add warning to user Javascript files, warning the contents is public](/T85856) |
|  |  |  |  |  | Restricted Task |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T89744 [External reference in PDF](/T89744) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T89745 [Stored XSS in PDF files](/T89745) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T87275 [MediaWiki Security release 1.24.2](/T87275) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85850 [Stored XSS in SVG via embedded SVG](/T85850) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85858 [Check User page lacks CSRF protection](/T85858) |
|  |  | Resolved |  | [Parent5446](/p/Parent5446/) | T64685 [Extremely large passwords as DoS](/T64685) |
|  |  | Resolved |  | [Parent5446](/p/Parent5446/) | T85349 [SVG @import style validation bypass](/T85349) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85851 [Reflected XSS in api.php using wddx formatting](/T85851) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T71210 [MediaWiki is vulnerable to XML quadratic blowup attacks](/T71210) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85848 [Billion Laughs attack in SVG and XMP Metadata](/T85848) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T88310 [xml\_parse doesn't expand internal entities sometimes](/T88310) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85855 [Custom JavaScript may yield privilege escalation](/T85855) |

Mentioned In [T85848: Billion Laughs attack in SVG and XMP Metadata](/T85848) Mentioned Here [T88310: xml\_parse doesn't expand internal entities sometimes](/T88310)
[T85848: Billion Laughs attack in SVG and XMP Metadata](/T85848)
### Event Timeline

[• bzimport](/p/bzimport/) raised the priority of this task from  to Needs Triage.[Nov 22 2014, 3:41 AM2014-11-22 03:41:01 (UTC+0)](#741096)[• bzimport](/p/bzimport/) added a project: [Security-Core](/tag/security-core/).[• bzimport](/p/bzimport/) set Reference to bz69210.[• bzimport](/p/bzimport/) changed Security from none to Software security bug.Restricted Application changed the visibility from "Public (No Login Required)" to "[acl\*security](/tag/acl_security/) (Project)".  · [View Herald Transcript](/herald/transcript/399826/)[Nov 22 2014, 3:41 AM2014-11-22 03:41:01 (UTC+0)](#741099)Restricted Application changed the edit policy from "All Users" to "[acl\*security](/tag/acl_security/) (Project)".  · [View Herald Transcript](/herald/transcript/399826/)[• csteipp](/p/csteipp/) created this task.[Aug 6 2014, 11:14 PM2014-08-06 23:14:00 (UTC+0)](#741101)[• csteipp](/p/csteipp/) added a project: [acl\*security](/tag/acl_security/).[Nov 24 2014, 9:27 PM2014-11-24 21:27:52 (UTC+0)](#782171)Restricted Application changed the visibility from "[acl\*security](/tag/acl_security/) (Project)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-khfjlzcjvqnwba7/)".  · [View Herald Transcript](/herald/transcript/420998/)[Nov 24 2014, 9:27 PM2014-11-24 21:27:52 (UTC+0)](#782172)Restricted Application changed the edit policy from "[acl\*security](/tag/acl_security/) (Project)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-b6ikvtqnkagtmte/)".  · [View Herald Transcript](/herald/transcript/420998/)[• csteipp](/p/csteipp/) added a comment.[Feb 12 2015, 9:37 PM2015-02-12 21:37:32 (UTC+0)](#1035288)Comment Actions

While investigating [T85848](/T85848), realized that yes, we are vulnerable to this.

In the most basic attack where all of the entities are in the text of a single element, it results in a String size overflow when the size gets over 2GB. If the entities are grouped into elements so no string is longer than 2GB, then zend eventually bails with zend\_mm\_heap corrupted.

The fix for [T85848](/T85848) should fix this (require resource limits before doing xml parsing). I'm not sure if that's more or less ugly than wordpress removing the DOCTYPE section before processing.

Demo of standard quadratic blowup, divided up so no string exceeds 2GB: qbs2.svg565 KB[Download](https://phab.wmfusercontent.org/file/download/feggppcrckef65acka3p/PHID-FILE-zoemebv72pkoqejjmdlg/qbs2.svg)

[• csteipp](/p/csteipp/) added a subtask: [T85848: Billion Laughs attack in SVG and XMP Metadata](/T85848).[Feb 12 2015, 9:37 PM2015-02-12 21:37:55 (UTC+0)](#1035297)[• csteipp](/p/csteipp/) mentioned this in [T85848: Billion Laughs attack in SVG and XMP Metadata](/T85848).[Feb 12 2015, 9:40 PM2015-02-12 21:40:17 (UTC+0)](#1035310)[• csteipp](/p/csteipp/) added a comment.[Feb 12 2015, 9:44 PM2015-02-12 21:44:32 (UTC+0)](#1035343)Comment Actions
> In [T71210#1035288](/T71210#1035288), [@csteipp](/p/csteipp/) wrote:
>
> I'm not sure if that's more or less ugly than wordpress removing the DOCTYPE section before processing.

For reference, <https://core.trac.wordpress.org/changeset/29404>.

We could probably get away with that when we're just trying to figure out if the file is xml (MimeMagic's use of XmlTypeCheck), but we obviously have to leave entity expansion in for SVG filtering.

[• csteipp](/p/csteipp/) closed subtask [T85848: Billion Laughs attack in SVG and XMP Metadata](/T85848) as Resolved.[Mar 17 2015, 11:33 PM2015-03-17 23:33:33 (UTC+0)](#1126890)[• csteipp](/p/csteipp/) renamed this task from Check "XML Quadratic Blowup Attack" to MediaWiki is vulnerable to XML quadratic blowup attacks.[Mar 19 2015, 8:59 PM2015-03-19 20:59:05 (UTC+0)](#1133309)[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-ngexmlliuxyokyx/)[• csteipp](/p/csteipp/) added a subtask: [T88310: xml\_parse doesn't expand internal entities sometimes](/T88310).[• csteipp](/p/csteipp/) added a comment.[Mar 19 2015, 9:15 PM2015-03-19 21:15:01 (UTC+0)](#1133344)Comment Actions

XMLReader sanely stops parsing the xml when the expansion gets too big (around 15KB of entities for attributes, and somewhere between 50-100KB of entities in the body). xml\_parse (under zend) stops parsing after about 10KB of entities, but when the entities are in the xml body, it keeps processing the expansion until it finishes. When the xml body data is added to a string in php, the string can either cause php to hit the memory limit, overflow the string length limit, or if memory\_limit isn't set below the available memory zend quits and complains about heap corruption.

With the patch for [T88310](/T88310), svg parsing uses XMLReader so it's safe. XMP parsing is vulnerable without the patch from [T85848](/T85848). We can either backport the XMP patch to address this, or ensure memory\_limit is set before parsing XMP blocks. Backporting the full XMP patch is probably easiest.

[• csteipp](/p/csteipp/) added a parent task: [T87275: MediaWiki Security release 1.24.2](/T87275).[Mar 19 2015, 9:17 PM2015-03-19 21:17:57 (UTC+0)](#1133351)[• csteipp](/p/csteipp/) closed this task as Resolved.[Mar 28 2015, 5:17 AM2015-03-28 05:17:36 (UTC+0)](#1159132)[• csteipp](/p/csteipp/) claimed this task.Comment Actions
> In [T71210#1133344](/T71210#1133344), [@csteipp](/p/csteipp/) wrote:
>
> With the patch for [T88310](/T88310), svg parsing uses XMLReader so it's safe. XMP parsing is vulnerable without the patch from [T85848](/T85848). We can either backport the XMP patch to address this, or ensure memory\_limit is set before parsing XMP blocks. Backporting the full XMP patch is probably easiest.

Backported the XMP patch from [T85848](/T85848) to all branches, so both zend and hhvm are safe against this now.

[• csteipp](/p/csteipp/) added subscribers: [Grunny](/p/Grunny/), [ProgramCeltic](/p/ProgramCeltic/).[Mar 30 2015, 8:00 PM2015-03-30 20:00:49 (UTC+0)](#1164339)[• csteipp](/p/csteipp/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-nkwg2vurwoiplzr/)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-nkwg2vurwoiplzr/)".[Mar 31 2015, 12:35 PM2015-03-31 12:35:55 (UTC+0)](#1166653)[• csteipp](/p/csteipp/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-c44ey6yq2iyqhm5/)" to "Public (No Login Required)".[Mar 31 2015, 9:14 PM2015-03-31 21:14:32 (UTC+0)](#1168301)[• csteipp](/p/csteipp/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-onm3kxfauq25zfi/)" to "All Users".[• csteipp](/p/csteipp/) changed Security from Software security bug to None.[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-xkicu75opbiwp75/)[Apr 9 2015, 10:56 PM2015-04-09 22:56:17 (UTC+0)](#1196361)[• csteipp](/p/csteipp/) added a project: [Vuln-DoS](/tag/vuln-dos/).[Aug 20 2015, 10:01 PM2015-08-20 22:01:07 (UTC+0)](#1558972)[• chasemp](/p/chasemp/) added a project: [Security](/tag/security/).[Feb 10 2020, 10:53 PM2020-02-10 22:53:37 (UTC+0)](#5868054) · [• chasemp](/p/chasemp/) removed a project: [acl\*security](/tag/acl_security/).[Feb 20 2020, 8:14 PM2020-02-20 20:14:24 (UTC+0)](#5903779) · [Log In to Comment](/login/?next=)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from www.openwall.com_697f15b9_20250125_153254.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](4) [[<thread-prev]](../../../2015/04/01/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <20150407073412.354C26C0003@smtpvmsrv1.mitre.org>
Date: Tue,  7 Apr 2015 03:34:12 -0400 (EDT)
From: cve-assign@...re.org
To: csteipp@...imedia.org
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: CVE request: MediaWiki 1.24.2/1.23.9/1.19.24

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

> * iSEC Partners discovered a way to circumvent the SVG MIME blacklist for
> embedded resources (iSEC-WMF1214-11). This allowed an attacker to embed
> JavaScript in the SVG. The issue was additionally identified by Mario
> Heiderich / Cure53. MIME types are now whitelisted.
> <https://phabricator.wikimedia.org/T85850>

Use CVE-2015-2931 for this issue involving an incomplete list of
disallowed MIME types for data: URIs (the application/xml type wasn't
in this list). In other words, CVE-2015-2931 does not refer more
generally to the desirability of the "MIME types are now whitelisted"
decision.

> * MediaWiki user Bawolff pointed out that the SVG filter to prevent
> injecting JavaScript using animate elements was incorrect.
> <https://phabricator.wikimedia.org/T86711>

Use CVE-2015-2932 for this issue involving an incomplete list of
dangerous parts of HTML5. (The list is supposed to include all uses of
'animate attributename="xlink:href"' in SVG documents.)

> * MediaWiki user Bawolff reported a stored XSS vulnerability due to the way
> attributes were expanded in MediaWiki's Html class, in combination with
> LanguageConverter substitutions.
> <https://phabricator.wikimedia.org/T73394>

Use CVE-2015-2933 for this XSS issue.

Also, this part of T73394 seems potentially interesting although it is
apparently neither a MediaWiki bug nor a PHP bug:

  <https://phabricator.wikimedia.org/T73394#750588>
  preg_match() silently returns false on limit exhaustion

In other words, if a PHP application uses
"ini_set('pcre.recursion_limit'" and does not properly handle the
preg_match return value, then a hard-to-find XSS vulnerability might
exist.

> * Internal review discovered that MediaWiki's SVG filtering could be
> bypassed with entity encoding under the Zend interpreter. This could be
> used to inject JavaScript. This issue was also discovered by Mario Gomes /
> Beyond Security.
> <https://phabricator.wikimedia.org/T88310>

Use CVE-2015-2934 for this interaction issue in which (roughly
speaking) secure operation of MediaWiki had been relying on a libxml
behavior that was removed for unrelated security reasons. (In other
words, it's apparently an usual type of vulnerability whose avoidance
requires studying all "improvements" in new releases of library code,
and determining whether any of them have unintended adverse
consequences.)

> * iSEC Partners discovered a way to bypass the style filtering for SVG
> files (iSEC-WMF1214-3) to load external resource. This could violate the
> anonymity of users viewing the SVG.
> <https://phabricator.wikimedia.org/T85349>

Use CVE-2015-2935 for this issue of information leaks observable in
log files on an attacker-controlled web server. This issue exists
because of an incomplete fix for CVE-2014-7199.

> * Internal review and iSEC Partners discovered (iSEC-WMF1214-1) that
> MediaWiki versions using PBKDF2 for password hashing (the default since
> 1.24) are vulnerable to DoS attacks using extremely long passwords.
> <https://phabricator.wikimedia.org/T64685>

Use CVE-2015-2936 for this vulnerability with a CPU consumption impact.

> * Internal review found that MediaWiki is vulnerable to "Quadratic Blowup"
> DoS attacks, under both HHVM and Zend PHP.
> <https://phabricator.wikimedia.org/T71210>

Use CVE-2015-2937. This is a quadratic issue and isn't the same as the
CVE-2015-2942 exponential issue affecting only HHVM (see below).

> * iSEC Partners reported that the MediaWiki feature allowing a user to
> preview another user's custom JavaScript could be abused for privilege
> escalation (iSEC-WMF1214-10). This feature has been removed.
> <https://phabricator.wikimedia.org/T85855>

Use CVE-2015-2938 for this XSS issue.

> * Extension:Scribunto - MediaWiki user Jackmcbarn discovered that function
> names were sanitized in Lua error backtraces, which could lead to XSS.
> <https://phabricator.wikimedia.org/T85113>

Use CVE-2015-2939 for this XSS issue. In the above quoted text, "were
sanitized" should be "were not sanitized" instead.

> * Extension:CheckUser - iSEC Partners discovered that the CheckUser
> extension did not prevent CSRF attacks on the form allowing checkusers to
> look up sensitive information about other users (iSEC-WMF1214-6). Since the
> use of CheckUser is logged, the CSRF could be abused to defame a trusted
> user or flood the logs with noise.
> <https://phabricator.wikimedia.org/T85858>

For purposes of CVE, we'll accept reports from a software's author
stating that there is a CSRF vulnerability for a request to read data.
Use CVE-2015-2940. This does not mean that similar reports from
arbitrary researchers about arbitrary products would have CVE IDs
assigned. For many products, the implied security policy does not
include a CSRF protection mechanism that prevents all
undesirable/confusing log entries.

> I'm not sure if CVE's are assigned for specific runtime
> configurations? For MediaWiki, we say that HHVM support is experimental,
> although we do run Wikipedia on it.

There isn't a general rule that CVE IDs are assigned for arbitrary
unsupported deployments of a product. Our impression is that users may
realistically decide that the HHVM support is "complete enough" for
their purposes. Also, in some cases, HHVM support is referenced or
documented in places that don't directly discuss the experimental
nature, such as on the <http://www.mediawiki.org/wiki/HHVM> and
[http://www.mediawiki.org/wiki/Manual:How_to_debug](http://www.mediawiki.org/wiki/Manual%3AHow_to_debug) pages. So, here, we
do want to assign CVE IDs applicable only to HHVM deployments.

> * iSEC Partners discovered a XSS vulnerability in the way api errors were
> reflected under HHVM versions before 3.6.1 (iSEC-WMF1214-8). MediaWiki now
> detects and mitigates this issue on older versions of HHVM.
> <https://phabricator.wikimedia.org/T85851>

It seems that the major concern here is the HHVM vulnerability fixed
by the
<https://github.com/facebook/hhvm/commit/324701c9fd31beb4f070f1b7ef78b115fbdfec34>
commit. Use CVE-2014-9714 for that HHVM vulnerability.

As far as we can tell, T85851 is recommending
<https://gerrit.wikimedia.org/r/#/c/201020/1/includes/api/ApiFormatWddx.php,unified>
as a vulnerability fix for MediaWiki deployments that use an older
version of HHVM. Use CVE-2015-2941 for this MediaWiki vulnerability in
which unsafe calls to wddx_serialize_value can occur.

> * iSEC Partners discovered that MediaWiki's SVG and XMP parsing running
> under HHVM was susceptible to "Billion Laughs" DoS attacks
> (iSEC-WMF1214-13).
> <https://phabricator.wikimedia.org/T85848>

Use CVE-2015-2942 for this exponential issue, which is different from
the CVE-2015-2937 quadratic issue mentioned above.

- --
CVE assignment team, MITRE CVE Numbering Authority
M/S M300
202 Burlington Road, Bedford, MA 01730 USA
[ PGP key available through <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.14 (SunOS)

iQEcBAEBAgAGBQJVI4etAAoJEKllVAevmvmsxk0H/R0orjbDyN56mEOJ9a/rlowS
D5cuaiDe4dzWbqEOzii8g+3d2iVsb1BUJHxfuGOFjf0zstb2KhJP5iaKN6hsXcHn
HKdtHE8uKMzs5DYxxeGsbphrp/J/Uff1+G7vwPmBTG3Z+tcLNXstuoIO18Pg3HuP
yT/P37KKJvlyhn5l325M4h0ln3kRu7egDHEctsJGNnb0IHoSoT8VmaiMYs/OwdP/
GT0XZVc7iNIBpXx0Ao03HxaSMgEfFs5X8PNnO95j9V9ngcP7zKQVT9ycsBHAhawP
dP+etPml55OJJKViqVZji5Dvv6BxZWnBACgzDI9ZcNFSHSykgr6Y3E+6nxmEKWY=
=vxIE
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from lists.wikimedia.org_c65686ea_20250125_153255.html ===


[lists.wikimedia.org](/hyperkitty/)

[Sign In](/accounts/login/?next=/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/message/OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN/)
[Sign Up](/accounts/signup/?next=/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/message/OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN/)

* [Sign In](/accounts/login/?next=/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/message/OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN/)
* [Sign Up](/accounts/signup/?next=/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/message/OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN/)

* [Manage this list](/postorius/lists/mediawiki-announce.lists.wikimedia.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2025/1/)

### 2024

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2024/1/)

### 2023

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2023/1/)

### 2022

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2022/1/)

### 2021

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2021/1/)

### 2020

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2020/1/)

### 2019

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2019/1/)

### 2018

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2018/1/)

### 2017

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2017/1/)

### 2016

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2016/1/)

### 2015

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2015/1/)

### 2014

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2014/1/)

### 2013

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2013/1/)

### 2012

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2012/1/)

### 2011

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2011/1/)

### 2010

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2010/1/)

### 2009

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2009/1/)

### 2008

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2008/1/)

### 2007

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2007/1/)

### 2006

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2006/1/)

### 2005

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/12/)
* [November](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/11/)
* [October](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/10/)
* [September](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/9/)
* [August](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/8/)
* [July](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/7/)
* [June](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/6/)
* [May](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/5/)
* [April](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/4/)
* [March](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/3/)
* [February](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/2/)
* [January](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2005/1/)

### 2004

* [December](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/2004/12/)

[List overview](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/)

[Download](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/export/mediawiki-announce%40lists.wikimedia.org-OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN.mbox.gz?message=OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN "This message in gzipped mbox format")

[thread](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/thread/OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN/#OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN)

# [MediaWiki-announce] MediaWiki Security and Maintenance Releases: 1.19.24, 1.23.9, and 1.24.2

[Chris Steipp](/hyperkitty/users/dd272b532a8d4667a37daa128483ef95/ "See the profile for Chris Steipp")

31 Mar
2015

31 Mar
'15

11:20 p.m.

I would like to announce the release of MediaWiki 1.24.2, 1.23.9 and
1.19.24. These releases fix 10 security issues, in addition to other bug
fixes. Download links are given at the end of this email.

== Security fixes ==

\* iSEC Partners discovered a way to circumvent the SVG MIME blacklist for
embedded resources (iSEC-WMF1214-11). This allowed an attacker to embed
JavaScript in the SVG. The issue was additionally identified by Mario
Heiderich / Cure53. MIME types are now whitelisted.
<https://phabricator.wikimedia.org/T85850>

\* MediaWiki user Bawolff pointed out that the SVG filter to prevent
injecting JavaScript using animate elements was incorrect.
<https://phabricator.wikimedia.org/T86711>

\* MediaWiki user Bawolff reported a stored XSS vulnerability due to the way
attributes were expanded in MediaWiki's Html class, in combination with
LanguageConverter substitutions.
<https://phabricator.wikimedia.org/T73394>

\* Internal review discovered that MediaWiki's SVG filtering could be
bypassed with entity encoding under the Zend interpreter. This could be
used to inject JavaScript. This issue was also discovered by Mario Gomes
from Beyond Security.
<https://phabricator.wikimedia.org/T88310>

\* iSEC Partners discovered a XSS vulnerability in the way api errors were
reflected when running under HHVM versions before 3.6.1 (iSEC-WMF1214-8).
MediaWiki now detects and mitigates this issue on older versions of HHVM.
<https://phabricator.wikimedia.org/T85851>

\* Internal review and iSEC Partners discovered (iSEC-WMF1214-1) that
MediaWiki versions using PBKDF2 for password hashing (the default since
1.24) are vulnerable to DoS attacks using extremely long passwords.
<https://phabricator.wikimedia.org/T64685>

\* iSEC Partners discovered that MediaWiki's SVG and XMP parsing, running
under HHVM, was susceptible to "Billion Laughs" DoS attacks
(iSEC-WMF1214-13).
<https://phabricator.wikimedia.org/T85848>

\* Internal review found that MediaWiki is vulnerable to "Quadratic Blowup"
DoS attacks, under both HHVM and Zend PHP.
<https://phabricator.wikimedia.org/T71210>

\* iSEC Partners discovered a way to bypass the style filtering for SVG
files (iSEC-WMF1214-3). This could violate the anonymity of users viewing
the SVG.
<https://phabricator.wikimedia.org/T85349>

\* iSEC Partners reported that the MediaWiki feature allowing a user to
preview another user's custom JavaScript could be abused for privilege
escalation (iSEC-WMF1214-10). This feature has been removed.
<https://phabricator.wikimedia.org/T85855>

Additionally, the following extensions have been updated to fix security
issues:

\* Extension:Scribunto - MediaWiki user Jackmcbarn discovered that function
names were not sanitized in Lua error backtraces, which could lead to XSS.
<https://phabricator.wikimedia.org/T85113>

\* Extension:CheckUser - iSEC Partners discovered that the CheckUser
extension did not prevent CSRF attacks on the form allowing checkusers to
look up sensitive information about other users (iSEC-WMF1214-6). Since the
use of CheckUser is logged, the CSRF could be abused to defame a trusted
user or flood the logs with noise.
<https://phabricator.wikimedia.org/T85858>

== Bug fixes ==

=== 1.24 ===

\* Fix case of SpecialAllPages/SpecialAllMessages in SpecialPageFactory to
fix loading these special pages when $wgAutoloadAttemptLowercase is false.
\* (bug T76254) Fix deleting of pages with PostgreSQL. Requires a schema
change and running update.php to fix.

== 1.23 & 1.24 ==

\* (bug T70087) Fix Special:ActiveUsers page for installations using
PostgreSQL.

\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*

Full release notes:
<https://www.mediawiki.org/wiki/Release_notes/1.24>
<https://www.mediawiki.org/wiki/Release_notes/1.23>
<https://www.mediawiki.org/wiki/Release_notes/1.19>

Download:
<http://download.wikimedia.org/mediawiki/1.24/mediawiki-1.24.2.tar.gz>
<http://download.wikimedia.org/mediawiki/1.23/mediawiki-1.23.9.tar.gz>
<http://download.wikimedia.org/mediawiki/1.19/mediawiki-1.19.24.tar.gz>

Patch to previous version:
<http://download.wikimedia.org/mediawiki/1.24/mediawiki-1.24.2.patch.gz>
<http://download.wikimedia.org/mediawiki/1.23/mediawiki-1.23.9.patch.gz>
<http://download.wikimedia.org/mediawiki/1.19/mediawiki-1.19.24.patch.gz>

GPG signatures:
<http://download.wikimedia.org/mediawiki/1.24/mediawiki-1.24.2.tar.gz.sig>
<http://download.wikimedia.org/mediawiki/1.24/mediawiki-1.24.2.patch.gz.sig>
<http://download.wikimedia.org/mediawiki/1.23/mediawiki-1.23.9.tar.gz.sig>
<http://download.wikimedia.org/mediawiki/1.23/mediawiki-1.23.9.patch.gz.sig>
<http://download.wikimedia.org/mediawiki/1.19/mediawiki-1.19.24.tar.gz.sig>
<http://download.wikimedia.org/mediawiki/1.19/mediawiki-1.19.24.patch.gz.sig>

Extensions:
[http://www.mediawiki.org/wiki/Extension:Scribunto](http://www.mediawiki.org/wiki/Extension%3AScribunto)
[http://www.mediawiki.org/wiki/Extension:CheckUser](http://www.mediawiki.org/wiki/Extension%3ACheckUser)

Public keys:
<https://www.mediawiki.org/keys/keys.html>

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/thread/OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN/#OTOGQLR6TBG7FPQ2OKWLZ4LKLLR5UAKN)

[Back to the list](/hyperkitty/list/mediawiki-announce%40lists.wikimedia.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from gerrit.wikimedia.org_3745b83d_20250126_095557.html ===




=== Content from phabricator.wikimedia.org_85a4969a_20250126_095556.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT85848)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T85848
# Billion Laughs attack in SVG and XMP MetadataClosed, Resolved[Public](/policy/explain/PHID-TASK-l3vwlaahn3o7ayyfk7bm/view/)Actions

* [Edit Task](/maniphest/task/edit/85848/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/85848/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* [Protect as security issue](/wmf/escalate-task/85848/)
* [Award Token](/token/give/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)
* [Flag For Later](/flag/edit/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)

Assigned To

|  | [• csteipp](/p/csteipp/) |
| --- | --- |

Authored By

|  | [• csteipp](/p/csteipp/) |
| --- | --- |
| Jan 5 2015, 8:36 PM2015-01-05 20:36:08 (UTC+0) |

Tags

* [MediaWiki-Core-Team](/tag/mediawiki-core-team/)
* [Patch-For-Review](/tag/patch-for-review/)
* [Vuln-DoS](/tag/vuln-dos/) [(Tracked)](/project/board/1446/)
* [Security](/tag/security/)
Referenced Files

|  | [F107240: T85848-xmptest6-REL1\_24b.patch](/F107240) |
| --- | --- |
| Mar 31 2015, 1:49 AM2015-03-31 01:49:48 (UTC+0) |

|  | [F106277: T85848-xmptest6-REL1\_24.patch](/F106277) |
| --- | --- |
| Mar 28 2015, 5:11 AM2015-03-28 05:11:28 (UTC+0) |

|  | [F106276: T85848-xmptest6-REL1\_19.patch](/F106276) |
| --- | --- |
| Mar 28 2015, 5:11 AM2015-03-28 05:11:28 (UTC+0) |

|  | [F106145: T85848-xmptest6.patch](/F106145) |
| --- | --- |
| Mar 27 2015, 7:32 PM2015-03-27 19:32:58 (UTC+0) |

|  | [F95562: xmp-test5.patch](/F95562) |
| --- | --- |
| Mar 16 2015, 8:37 PM2015-03-16 20:37:06 (UTC+0) |

|  | [F95557: xmp-test4.patch](/F95557) |
| --- | --- |
| Mar 16 2015, 8:30 PM2015-03-16 20:30:56 (UTC+0) |

|  | [F95554: xmp-test3.patch](/F95554) |
| --- | --- |
| Mar 16 2015, 8:18 PM2015-03-16 20:18:46 (UTC+0) |

|  | [F90270: iswellformed.patch](/F90270) |
| --- | --- |
| Mar 14 2015, 12:13 AM2015-03-14 00:13:25 (UTC+0) |

[View All 17 Files](/file/ui/curtain/list/PHID-TASK-l3vwlaahn3o7ayyfk7bm/)Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [• csteipp](/p/csteipp/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Grunny](/p/Grunny/) |
| --- | --- |

|  | [Joe](/p/Joe/) |
| --- | --- |

|  | [ProgramCeltic](/p/ProgramCeltic/) |
| --- | --- |

|  | [tstarling](/p/tstarling/) |
| --- | --- |

# Description

iSec found that a standard Billion Laughs attack works with SVG's and PDF's with XMP metadata. They tested this on mediawiki vagrant, so it's not clear if production is vulnerable or not.

FINDING ID: iSEC-WMF1214-13

DESCRIPTION: When uploading an SVG file, or any file which includes XMP metadata, it is possible to

include XML Doctype Declarations which trigger a Billion Laughs attack against the XML parser when

the uploaded file is processed. This attack uses a series of expanding XML entities which, when fully

expanded, result in approximately 3GB of data to be processed. This causes the XML parser to consume

all available resources on the system, leaving the webserver unresponsive. An example of a file which

exploits this vulnerability is below:

```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE svg [
<!ENTITY lol "lol">
<!ELEMENT lolz (#PCDATA)>
<!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
<!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
<!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
<!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
<!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
<!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
<!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
<!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
<!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<svg>
<lolz>&lol9;</lolz>
</svg>
```

---

**Patches**: T85848-xmptest6.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/ulmkqhqzrs5vlkm4tnmm/PHID-FILE-3gqkci3wqtdr72grh42o/T85848-xmptest6.patch), iswellformed.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/phqtwhoptfn2upvmwqih/PHID-FILE-7amvv4zla6ziz5nsvpbq/iswellformed.patch)

* 1.24: T85848-xmptest6-REL1\_24b.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/qsrkzvev3obn6vuymhor/PHID-FILE-jw2qf52a6bawqh5inolr/T85848-xmptest6-REL1_24b.patch), iswellformed.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/phqtwhoptfn2upvmwqih/PHID-FILE-7amvv4zla6ziz5nsvpbq/iswellformed.patch)
* 1.23: T85848-xmptest6-REL1\_24b.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/qsrkzvev3obn6vuymhor/PHID-FILE-jw2qf52a6bawqh5inolr/T85848-xmptest6-REL1_24b.patch), iswellformed.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/phqtwhoptfn2upvmwqih/PHID-FILE-7amvv4zla6ziz5nsvpbq/iswellformed.patch) (only needed for hhvm, but keep consistent with master for LTS)
* 1.19: T85848-xmptest6-REL1\_19.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/sxhqnf5wycdorjukkft6/PHID-FILE-ozbgu4egmxcx3a57reen/T85848-xmptest6-REL1_19.patch)

**Affected Versions**: MediaWiki on HHVM

**Type**: DoS

**CVE**: CVE-2015-2942

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Don't allow entities in XMP with HHVM](https://gerrit.wikimedia.org/r/c/201225) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +179 -4 |
|  | [SECURITY: Don't allow directly calling Xml::isWellFormed](https://gerrit.wikimedia.org/r/c/201224) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +3 -1 |
|  | [SECURITY: Don't allow entities in XMP](https://gerrit.wikimedia.org/r/c/201030) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_23](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_23) | +176 -4 |
|  | [SECURITY: Don't allow directly calling Xml::isWellFormed](https://gerrit.wikimedia.org/r/c/201029) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_23](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_23) | +3 -1 |
|  | [SECURITY: Don't allow entities in XMP](https://gerrit.wikimedia.org/r/c/201039) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_19](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_19) | +175 -4 |
|  | [SECURITY: Don't allow entities in XMP](https://gerrit.wikimedia.org/r/c/201019) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_24](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_24) | +176 -4 |
|  | [SECURITY: Don't allow directly calling Xml::isWellFormed](https://gerrit.wikimedia.org/r/c/201018) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_24](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_24) | +3 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T85848)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T88120 [Release MW 1.24.2 and 1.23.9 tarballs](/T88120) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85862 [Make iSec assessment public](/T85862) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T87275 [MediaWiki Security release 1.24.2](/T87275) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T71210 [MediaWiki is vulnerable to XML quadratic blowup attacks](/T71210) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T85848 [Billion Laughs attack in SVG and XMP Metadata](/T85848) |
|  |  | Resolved |  | [• csteipp](/p/csteipp/) | T88310 [xml\_parse doesn't expand internal entities sometimes](/T88310) |

Mentioned In [T116701: XMPReader::checkParseSafely requires allow\_url\_fopen to be set enabled](/T116701)
[rMW15ce698afc0b: SECURITY: Don't allow entities in XMP with HHVM](/rMW15ce698afc0bb3ab56217981c3e16ef0d4f9de74)
[rMW00bd303b6048: SECURITY: Don't allow directly calling Xml::isWellFormed](/rMW00bd303b6048213bb75ee0d0307256a678a91cc9)
[rMW9a2b649587f1: SECURITY: Don't allow entities in XMP](/rMW9a2b649587f14c3c067ea00ba89dff07fd2c68ed)
[rMW3ed926d89e77: SECURITY: Don't allow entities in XMP](/rMW3ed926d89e775b797451a2b67c6825e8a959363b)
[rMW336bcd330c6e: SECURITY: Don't allow directly calling Xml::isWellFormed](/rMW336bcd330c6ea1a34062480468f4aea1a7280cee)
[rMW31f089fc4be2: SECURITY: Don't allow directly calling Xml::isWellFormed](/rMW31f089fc4be2940757aa313efc1bd42fe2a8f4fb)
[rMWc1fcf97e9a5a: SECURITY: Don't allow entities in XMP](/rMWc1fcf97e9a5ab83dae1efa770bcb8ab6f1ed0cf4)
[T88310: xml\_parse doesn't expand internal entities sometimes](/T88310)
[T71210: MediaWiki is vulnerable to XML quadratic blowup attacks](/T71210) Mentioned Here [T88310: xml\_parse doesn't expand internal entities sometimes](/T88310)
[T71210: MediaWiki is vulnerable to XML quadratic blowup attacks](/T71210)
### Event Timeline

There are a very large number of changes, so older changes are hidden. [Show Older Changes](/transactions/showolder/PHID-TASK-l3vwlaahn3o7ayyfk7bm/?after=1002970&quoteTargetID=UQ0_1&quoteRef=T85848)[• csteipp](/p/csteipp/) added a subscriber: [tstarling](/p/tstarling/).[Jan 30 2015, 12:52 AM2015-01-30 00:52:26 (UTC+0)](#1002970)Comment Actions

[@tstarling](/p/tstarling/), any idea why hhvm would (seemingly) try to expand the entities, while zend doesn't?

[• csteipp](/p/csteipp/) added a comment.[Jan 30 2015, 10:35 PM2015-01-30 22:35:35 (UTC+0)](#1005265)Comment Actions

The source of the memory increasing seems to be when XmlTypeCheck is used (using xml\_parse again), and we set elementData as a callback to handle the body of elements. This gets recalled for each expansion of the entity, so memory rises to memory\_limit, and then the call is appropriately killed.

The mediawiki vagrant image doesn't set memory\_limit, so that's why iSec saw it eating up 3GB of memory. In production, we set this to 300MB, so I'm fairly confident the memory

Slightly more concerning to me is that when I comment out the xml\_set\_character\_data\_handler, so xml\_parse just keeps expanding and reading the xml without using more memory, the process keeps running for well beyond max\_execution\_time. [@tstarling](/p/tstarling/), are we sure max\_execution\_time is being enforced in production?

[• csteipp](/p/csteipp/) added a comment.[Jan 30 2015, 11:18 PM2015-01-30 23:18:44 (UTC+0)](#1005433)Comment Actions
> In [T85848#1002970](/T85848#1002970), [@csteipp](/p/csteipp/) wrote:
>
> [@tstarling](/p/tstarling/), any idea why hhvm would (seemingly) try to expand the entities, while zend doesn't?

And actually, zend not doing the expansion is an issue, since at least Chrome will expand the entities when interpreting the svg, so we should expand before we run the filtering.

[tstarling](/p/tstarling/) added a comment.[Jan 31 2015, 12:07 AM2015-01-31 00:07:41 (UTC+0)](#1005632)Comment Actions
> In [T85848#1002970](/T85848#1002970), [@csteipp](/p/csteipp/) wrote:
>
> [@tstarling](/p/tstarling/), any idea why hhvm would (seemingly) try to expand the entities, while zend doesn't?

Sounds like a bug to me.

> In [T85848#1005433](/T85848#1005433), [@csteipp](/p/csteipp/) wrote:
> > In [T85848#1002970](/T85848#1002970), [@csteipp](/p/csteipp/) wrote:
> >
> > [@tstarling](/p/tstarling/), any idea why hhvm would (seemingly) try to expand the entities, while zend doesn't?
>
> And actually, zend not doing the expansion is an issue, since at least Chrome will expand the entities when interpreting the svg, so we should expand before we run the filtering.

Presumably there is some option we should be setting to enable that.

> In [T85848#1005265](/T85848#1005265), [@csteipp](/p/csteipp/) wrote:
>
> The source of the memory increasing seems to be when XmlTypeCheck is used (using xml\_parse again), and we set elementData as a callback to handle the body of elements. This gets recalled for each expansion of the entity, so memory rises to memory\_limit, and then the call is appropriately killed.
>
> The mediawiki vagrant image doesn't set memory\_limit, so that's why iSec saw it eating up 3GB of memory. In production, we set this to 300MB, so I'm fairly confident the memory
>
> Slightly more concerning to me is that when I comment out the xml\_set\_character\_data\_handler, so xml\_parse just keeps expanding and reading the xml without using more memory, the process keeps running for well beyond max\_execution\_time. [@tstarling](/p/tstarling/), are we sure max\_execution\_time is being enforced in production?

No, I am not sure. I couldn't find any execution time exceeded messages in hhvm.log.

[• csteipp](/p/csteipp/) added a comment.[Feb 2 2015, 6:53 PM2015-02-02 18:53:02 (UTC+0)](#1008890)Comment Actions
> Presumably there is some option we should be setting to enable that.

I haven't managed to find a way to get php to do that. Talking to Tim in person, it sounds like we might want to move processing to XMLReader instead. I'm going to move this to a subtask, since it's a flaw specific to Zend, that allows getting around the blacklist.

For this bug (DoS via billion-laughs xml), the memory and time limits are what we'll use to prevent the DoS. The more I've thought through this, I think the security patch might need to check memory\_limit and max\_execution\_time, and throw an exception if someone is uploading an svg and either of those is set to infinite, along with a config flag to disable the check (defaulted to false) that would allow third-party users to skip the check if they want to accept the risk. That means a 3rd party that has svg/pdf uploading, and doesn't have memory/time limits set will get a (hopefully helpful) exception message until they either set limits or the config flag.

We could probably also try to set a limit if none is defined before throwing an exception, so only systems where those configs are protected will actually lose the feature.

[• csteipp](/p/csteipp/) moved this task from [Backlog](/project/board/37/) to [In Dev/Progress](/project/board/37/) on the [MediaWiki-Core-Team](/tag/mediawiki-core-team/) board.[Feb 2 2015, 10:09 PM2015-02-02 22:09:40 (UTC+0)](#1009709)[• csteipp](/p/csteipp/) added a comment.[Feb 11 2015, 1:50 AM2015-02-11 01:50:24 (UTC+0)](#1029715)Comment Actions

T85848.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/pzx7jrqwufi7ub4qhvya/PHID-FILE-yv6xi43yevdudc3ofhc2/T85848.patch)

Patch to throw an exception if limits aren't set whenever we use XMLReader with SUBST\_ENTITIES set, or we're on hhvm and use xml\_parse in core. I added a warning in Setup.php when hhvm is used and limits aren't set because there are a ton of extensions that use xml\_parse.

[• csteipp](/p/csteipp/) added a subscriber: [Anomie](/p/Anomie/).[Feb 11 2015, 1:54 AM2015-02-11 01:54:26 (UTC+0)](#1029730)Comment Actions
> In [T85848#1029715](/T85848#1029715), [@csteipp](/p/csteipp/) wrote:
>
> T85848.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/pzx7jrqwufi7ub4qhvya/PHID-FILE-yv6xi43yevdudc3ofhc2/T85848.patch)

[@tstarling](/p/tstarling/) or [@Anomie](/p/Anomie/), your input would be appreciated.

[Anomie](/p/Anomie/) added a comment.[Feb 11 2015, 6:03 PM2015-02-11 18:03:38 (UTC+0)](#1031832)Comment Actions

ini\_get() returns the setting as a string, so === with integers is never going to match.

While this particular attack only affects HHVM, I wonder whether we shouldn't remove wfIsHHVM() from the check you're adding in Setup.php.

Similarly, in XmlTypeCheck.php and XMP.php, I wonder if wfIsHHVM() is really the best check versus just assuming vulnerability (in case Zend gets fixed) or processing a minimal XML document to directly see if it's going to be expanded (in case HHVM gets unfixed).

[• csteipp](/p/csteipp/) mentioned this in [T71210: MediaWiki is vulnerable to XML quadratic blowup attacks](/T71210).[Feb 12 2015, 9:37 PM2015-02-12 21:37:32 (UTC+0)](#1035289)[• csteipp](/p/csteipp/) added a parent task: [T71210: MediaWiki is vulnerable to XML quadratic blowup attacks](/T71210).[• csteipp](/p/csteipp/) added a comment.[Feb 12 2015, 9:40 PM2015-02-12 21:40:17 (UTC+0)](#1035309)Comment Actions
> In [T85848#1031832](/T85848#1031832), [@Anomie](/p/Anomie/) wrote:
>
> While this particular attack only affects HHVM, I wonder whether we shouldn't remove wfIsHHVM() from the check you're adding in Setup.php.

Since you mentioned it, I realized that zend is still vulnerable to a slightly different version of the attack (what I had flagged to look into in [T71210](/T71210)). So yeah, I'm going to remove the checks for hhvm.

[• csteipp](/p/csteipp/) added a comment.[Feb 12 2015, 9:51 PM2015-02-12 21:51:16 (UTC+0)](#1035377)Comment Actions

T85848b.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/7ydolidcqk6de26t55qc/PHID-FILE-iynkrpelbhawz6y45mlf/T85848b.patch)

[Anomie](/p/Anomie/) added a comment.[Feb 13 2015, 4:05 PM2015-02-13 16:05:10 (UTC+0)](#1036792)Comment Actions

Code review: +1 Looks sane, haven't tested.

[• csteipp](/p/csteipp/) claimed this task.[Feb 14 2015, 12:38 AM2015-02-14 00:38:57 (UTC+0)](#1038259)[• csteipp](/p/csteipp/) moved this task from [In Dev/Progress](/project/board/37/) to [Needs Review/Feedback](/project/board/37/) on the [MediaWiki-Core-Team](/tag/mediawiki-core-team/) board.[• csteipp](/p/csteipp/) closed subtask [T88310: xml\_parse doesn't expand internal entities sometimes](/T88310) as Resolved.[Feb 17 2015, 10:43 PM2015-02-17 22:43:39 (UTC+0)](#1045002)[• csteipp](/p/csteipp/) added a comment.[Feb 18 2015, 12:20 AM2015-02-18 00:20:46 (UTC+0)](#1045254)Comment Actions

I attempted to deploy T85848b.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/7ydolidcqk6de26t55qc/PHID-FILE-iynkrpelbhawz6y45mlf/T85848b.patch) today, and when I ran it on testwiki before deploying it everywhere, I got the exception trying to upload saying that either memory\_limit or max\_execution time wasn't set. The exception should probably show the current settings.

Looking at our puppet repo, we're setting memory\_limit in modules/hhvm/manifests/init.pp, modules/mediawiki/files/php/php.ini, and modules/mediawiki/files/php/php.ini.cli, but max\_execution\_time we're only setting in the mediawiki php.ini files. It doesn't look like we're setting it for hhvm.

I'll update the patch to output the actual values, and then I can track down why it's not getting set.

[• csteipp](/p/csteipp/) added a comment.[Feb 18 2015, 12:35 AM2015-02-18 00:35:51 (UTC+0)](#1045317)Comment Actions

T85848d.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/pbtxxauovjqan4tekvpi/PHID-FILE-5w27zra5nidvyuvllzn7/T85848d.patch)

Rebased on top of the final patch for [T88310](/T88310), and outputs the current limits with wfWarn in Setup.php. I'll deploy this to test briefly to see which one is triggering it.

[• csteipp](/p/csteipp/) added a subscriber: [Joe](/p/Joe/).[Feb 19 2015, 9:36 PM2015-02-19 21:36:39 (UTC+0)](#1051343)Comment Actions

Confirmed that we're not setting max\_execution\_time on testwiki, and it looks like all of our wikis.

[warning] Running without memory\_limit (currently 346030080) or max\_execution\_time (currently 0) defined might allow some DoS attacks to succeed. [Called from include in /srv/mediawiki/php-1.25wmf18/includes/Setup.php at line 681]

[@Joe](/p/Joe/), are we supposed to be setting max\_execution\_time for hhvm?

[• csteipp](/p/csteipp/) added a comment.[Feb 24 2015, 8:58 PM2015-02-24 20:58:42 (UTC+0)](#1063822)Comment Actions

And another wrinkle..

When using xml\_parse without an xml\_set\_character\_data\_handler callback, hhvm will spend will over max\_execution\_time trying to parse the xml. E.g., blol.php1 KB[Download](https://phab.wmfusercontent.org/file/download/zukx3fzhjjnh4ctztbku/PHID-FILE-2nezj5lss7tw6ztcl66u/blol.php) gives,

```
vagrant@mediawiki-vagrant:/vagrant/mediawiki/maintenance$ time hhvm blol.php
max_execution_time: 2

Done in 73.960172176361 secs
[Tue Feb 24 20:16:41 2015] [hphp] [6573:7fed8595abc0:0:000001] [834dc6:835050:9ca744:9caa13:9cf12a:9d070f:856a69:7fed7d5efec5:909e04]
Fatal error: Maximum execution time of 2 seconds exceeded in /vagrant/mediawiki/maintenance/blol.php on line 54

real	1m14.164s
user	0m36.122s
sys	0m34.261s
```

We use xml\_parse without a callback in MimeMagic.php, so even with max\_execution\_time set, hhvm continues consuming 100% of a cpu for a while after apache has returned an error, when an svg with something like this is uploaded.

I emailed Brett upstream to see what their thoughts on it are. We can always use XMLReader without entity expansion for the MimeMagic check. Or we can define a dummy xml\_set\_character\_data\_handler so hhvm checks max\_execution\_time more regularly. I'm leaning towards the first.

[• csteipp](/p/csteipp/) added a comment.[Feb 25 2015, 2:49 AM2015-02-25 02:49:46 (UTC+0)](#1064712)Comment Actions
> In [T85848#1063822](/T85848#1063822), [@csteipp](/p/csteipp/) wrote:
>
> We can always use XMLReader without entity expansion for the MimeMagic check. Or we can define a dummy xml\_set\_character\_data\_handler so hhvm checks max\_execution\_time more regularly. I'm leaning towards the first.

That doesn't work out so well... Adobe Illustrator does stuff like,

<!ENTITY ns\_svg "[http://www.w3.org/2000/svg">](http://www.w3.org/2000/svg%22%3E)

...

<svg version="1.1" id="Layer\_1" xmlns="&ns\_svg;"

Which screws up MimeMagic::doGuessMimeType() becuase $xmlMimeTypes['&ns\_svg;:svg'] isn't defined, for obvious reasons.

On to plan b..

[• csteipp](/p/csteipp/) added a comment.[Feb 26 2015, 8:32 PM2015-02-26 20:32:14 (UTC+0)](#1071192)Comment Actions

I tested setting a dummy callback in XmlTypeCheck, which works great for when the entity is in the xml body. But if the entity is in an attribute value, the whole thing blows up again (dies after it's tries to allocate more than all available memory on the machine).

So I think we're stuck with using the (slightly slower) XmlReaderTypeCheck with entity expansion enabled in MimeMagic.

Which is probably the right way to do this whole things since XMLReader in hhvm uses libxml (just like zend does), which has built in limits for entity expansion, so we actually don't need to the memory\_limit and max\_execution\_time checks before running it.

[• csteipp](/p/csteipp/) added a comment.[Feb 28 2015, 12:20 AM2015-02-28 00:20:58 (UTC+0)](#1075066)Comment Actions

I haven't managed to get an answer from brett if FB is interested in fixing hhvm's version of xml\_parse, so I'm assuming that we need to update mediawiki to avoid calling it on user-controlled xml.

So I patched MimeMagic and XMPReader in mimemagic-and-xmp.patch20 KB[Download](https://phab.wmfusercontent.org/file/download/6jf2bxdmjs2rzsmgel34/PHID-FILE-bzgz7qcim7blbrqqzfee/mimemagic-and-xmp.patch), the two other places in core that we were using xml\_parse on xml that we didn't control. There was one place in the parser, but it doesn't look like users can control the start of the xml there. XMPReader admits in comments that there isn't good test coverage, but the new patch passes all the existing tests.

There we very few extensions that used xml\_parse directly. SMW being one exception, although I'm not sure if user controlled xml can get to their usage.

I could probably update XmlTypeCheck to use thew new SafeXmlParser, so anything that uses an XmlTypeCheck is protected by default, but I might leave that for a public patchset.

[@Anomie](/p/Anomie/), care to sanity check?

[Anomie](/p/Anomie/) added a comment.[Mar 2 2015, 6:19 PM2015-03-02 18:19:59 (UTC+0)](#1078851)Comment Actions

Code itself seems mostly ok, although I don't really know enough about xml\_parse to say whether SafeXmlParser is functionally correct.

The bit in XMP.php where it has to cache the whole file before calling ->parse() is a little worrying if it's supposed to be completely interoperable though. And it's not clear how using XmlReader::open() avoids problems with partial documents in XmlReader::XML(), while it seems likely that using 'open' will use more memory for large XML documents due to the need to urlencode the input string.

Should there be a ScopedCallback or a catch-and-rethrow to ensure libxml\_disable\_entity\_loader( $oldDisable ) gets called even if one of the callbacks throws an exception?

I see includes/media/BitmapMetadataHandler.php and includes/media/JpegMetadataExtractor.php are still calling function\_exists( 'xml\_parser\_create\_ns' ) in a few places before loading XMPReader, which should be fixed. Even better, add some sort of XMPReader::isSupported() method instead of having callers know what magic to test for.

I see Xml::isWellFormed still uses xml\_parse, and the only caller seems to be the function in Parser for checking user-supplied sigs.

I don't know if maintenance/backupTextPass.inc needs fixing or not. tests/parser/parserTest.inc is theoretically ok, since parser tests shouldn't be taking user input. includes/installer/PhpBugTests.php is safe, although I don't know how useful it might be if we're removing xml\_parse from use.

If you want nitpicking, there shouldn't be a space between "list" and the open-paren, much like array(). Nor between "set\_error\_handler" and its open-paren. And there 4 lines in SafeXmlParserTest.php with whitespace at the end of the line.

[• csteipp](/p/csteipp/) added a comment.[Mar 3 2015, 3:03 AM2015-03-03 03:03:04 (UTC+0)](#1080879)Comment Actions

Thanks Brad,

> In [T85848#1078851](/T85848#1078851), [@Anomie](/p/Anomie/) wrote:
>
> Code itself seems mostly ok, although I don't really know enough about xml\_parse to say whether SafeXmlParser is functionally correct.
>
> The bit in XMP.php where it has to cache the whole file before calling ->parse() is a little worrying if it's supposed to be completely interoperable though. And it's not clear how using XmlReader::open() avoids problems with partial documents in XmlReader::XML(), while it seems likely that using 'open' will use more memory for large XML documents due to the need to urlencode the input string.

It's weird. But basically, I'm trying to parse as much of the xml as I can, even if it's invalid.

```
> $xml = '<a>foo<b>bar<c>baz<d/>';

> $r = new XMLReader();

> $r->open( 'data://text/plain,' . urlencode( $xml ), null, LIBXML_NOERROR | LIBXML_NOWARNING  );

> while ( $r->read() ) { print "{$r->nodeType}: {$r->name}\n"; }
1: a
3: #text
1: b
3: #text
1: c
3: #text
1: d
PHP Warning:  XMLReader::read(): An Error Occurred while reading in /home/csteipp/code/core/maintenance/eval.php(78) : eval()'d code on line 1

Warning: XMLReader::read(): An Error Occurred while reading in /home/csteipp/code/core/maintenance/eval.php(78) : eval()'d code on line 1

> unset( $r );

> $r = new XMLReader();

> $r->XML( $xml, null, LIBXML_NOERROR | LIBXML_NOWARNING  );

> while ( $r->read() ) { print "{$r->nodeType}: {$r->name}\n"; }
PHP Warning:  XMLReader::read(): An Error Occurred while reading in /home/csteipp/code/core/maintenance/eval.php(78) : eval()'d code on line 1

Warning: XMLReader::read(): An Error Occurred while reading in /home/csteipp/code/core/maintenance/eval.php(78) : eval()'d code on line 1

>
```
> Should there be a ScopedCallback or a catch-and-rethrow to ensure libxml\_disable\_entity\_loader( $oldDisable ) gets called even if one of the callbacks throws an exception?
>
> I see includes/media/BitmapMetadataHandler.php and includes/media/JpegMetadataExtractor.php are still calling function\_exists( 'xml\_parser\_create\_ns' ) in a few places before loading XMPReader, which should be fixed. Even better, add some sort of XMPReader::isSupported() method instead of having callers know what magic to test for.
>
> If you want nitpicking, there shouldn't be a space between "list" and the open-paren, much like array(). Nor between "set\_error\_handler" and its open-paren. And there 4 lines in SafeXmlParserTest.php with whitespace at the end of the line.

Should be all fixed in mimemagic-and-xmp2.patch22 KB[Download](https://phab.wmfusercontent.org/file/download/smln7chpkg4brxcxzcmx/PHID-FILE-zwvwluyrvwrrt2eaqcn3/mimemagic-and-xmp2.patch)

[• csteipp](/p/csteipp/) added a comment.[Mar 3 2015, 3:05 AM2015-03-03 03:05:09 (UTC+0)](#1080880)Comment Actions

Brett indicated that FB is looking at what they can do to solve the issue, so this might all be unnecessary.

[Anomie](/p/Anomie/) added a comment.[Mar 3 2015, 7:08 PM2015-03-03 19:08:59 (UTC+0)](#1083463)Comment Actions
> In [T85848#1080879](/T85848#1080879), [@csteipp](/p/csteipp/) wrote:
>
> It's weird. But basically, I'm trying to parse as much of the xml as I can, even if it's invalid.

That's some weird behavior from XmlReader.

What we really need is some stream wrapper that'll read directly from a variable, rather than having to re-encode as a data URI... If I write that, would you be interested? Or should I not bother?

> Should be all fixed in mimemagic-and-xmp2.patch22 KB[Download](https://phab.wmfusercontent.org/file/download/smln7chpkg4brxcxzcmx/PHID-FILE-zwvwluyrvwrrt2eaqcn3/mimemagic-and-xmp2.patch)

You missed one check of xml\_parser\_create\_ns in BitmapMetadataHandler::GIF.

Also, what happened to this one?

> I see Xml::isWellFormed still uses xml\_parse, and the only caller seems to be the function in Parser for checking user-supplied sigs.

[• csteipp](/p/csteipp/) added a comment.[Mar 11 2015, 6:34 PM2015-03-11 18:34:02 (UTC+0)](#1110406)Comment Actions

Brett got back to me, and they're ok with us releasing patches to work around hhvm. They're aware it's an issue, but it's not super high priority for them right now, and they haven't been able to find a quick solution for the issue.

I really don't feel comfortable with the XMP patch, so I think the best way to handle that is like Wordpress-- detect a doctype declaration in the xml and just abort if we see one. XMP implements RDF/XML, which as far as I can tell does support a doctype and expandable entities, but I'm hoping these are rare in practice. I'll download and grep a big chunk of commons to check that.

[• csteipp](/p/csteipp/) added a comment.[Mar 13 2015, 12:53 AM2015-03-13 00:53:04 (UTC+0)](#1115508)Comment Actions
> In [T85848#1110406](/T85848#1110406), [@csteipp](/p/csteipp/) wrote:
>
> I really don't feel comfortable with the XMP patch, so I think the best way to handle that is like Wordpress-- detect a doctype declaration in the xml and just abort if we see one. XMP implements RDF/XML, which as far as I can tell does support a doctype and expandable entities, but I'm hoping these are rare in practice. I'll download and grep a big chunk of commons to check that.

I downloaded about 3k recent jpg/gif/png/pdf files from commons, and just over 1k included XML blocks. Of those, none had a doctype in the XMP block. So I feel pretty good about simply not parsing the XMP block if there is a doctype found in the xml.

So these two:

mimemagic2.patch933 B[Download](https://phab.wmfusercontent.org/file/download/no5wjhhre67oraddi7my/PHID-FILE-zey7nz25nxltqjwm3xgm/mimemagic2.patch)

xmp-test.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/wv42ecthitpbjqss3kh2/PHID-FILE-cjuxxgxkf6rl2z62c7uj/xmp-test.patch)

Replace mimemagic-and-xmp2.patch22 KB[Download](https://phab.wmfusercontent.org/file/download/smln7chpkg4brxcxzcmx/PHID-FILE-zwvwluyrvwrrt2eaqcn3/mimemagic-and-xmp2.patch).

As for,

> I see Xml::isWellFormed still uses xml\_parse, and the only caller seems to be the function in Parser for checking user-supplied sigs.

As you said, the only caller seems to be internal to the Xml class, which is setting a root element and its own doctype around the xml. So no danger of expansion for anything coming in through Xml::isWellFormedXmlFragment. Maybe make isWellFormed protected, so calls have to go through isWellFormedXmlFragment?

[Anomie](/p/Anomie/) added a comment.Edited · [Mar 13 2015, 3:04 PM2015-03-13 15:04:20 (UTC+0)](#1116668)Comment Actions
> In [T85848#1115508](/T85848#1115508), [@csteipp](/p/csteipp/) wrote:
>
> mimemagic2.patch933 B[Download](https://phab.wmfusercontent.org/file/download/no5wjhhre67oraddi7my/PHID-FILE-zey7nz25nxltqjwm3xgm/mimemagic2.patch)

Seems ok.

> xmp-test.patch6 KB[Download](https://phab.wmfusercontent.org/file/download/wv42ecthitpbjqss3kh2/PHID-FILE-cjuxxgxkf6rl2z62c7uj/xmp-test.patch)

In XMPReader, you create a field "parseInProgress" but never set it to true?

There's no way that something could somehow fragment things so the full doctype isn't passed to XMPReader::parse() in a way that it would be detected? For example, if I read [this Adobe PDF about XMP](https://a248.e.akamai.net/f/1953/8974/2h/wwwimages.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf) correctly it sounds like the XML document for extended XMP in a jpeg is just chopped up substr()-wise into multiple ExtendedXMP segments with no minimum size. What if the doctype part is chopped into single byte segments?

> As you said, the only caller seems to be internal to the Xml class, which is setting a root element and its own doctype around the xml. So no danger of expansion for anything coming in through Xml::isWellFormedXmlFragment. Maybe make isWellFormed protected, so calls have to go through isWellFormedXmlFragment?

Ah, that makes sense. I like the protected idea, but I'd like private even better, or maybe just inline it into isWellFormedXmlFragment and remove it as a separate function entirely.

[• csteipp](/p/csteipp/) added a comment.[Mar 14 2015, 12:13 AM2015-03-14 00:13:25 (UTC+0)](#1118447)Comment Actions
> There's no way that something could somehow fragment things so the full doctype isn't passed to XMPReader::parse() in a way that it would be detected? For example, if I read [this Adobe PDF about XMP](https://a248.e.akamai.net/f/1953/8974/2h/wwwimages.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf) correctly it sounds like the XML document for extended XMP in a jpeg is just chopped up substr()-wise into multiple ExtendedXMP segments with no minimum size. What if the doctype part is chopped into single byte segments?

True, need to buffer and check. Added a test case for that situation too.

xmp-test2.patch9 KB[Download](https://phab.wmfusercontent.org/file/download/6fw7llous6bllwblk56s/PHID-FILE-klsmeb2v3vhz7qiam37r/xmp-test2.patch)

> Ah, that makes sense. I like the protected idea, but I'd like private even better, or maybe just inline it into isWellFormedXmlFragment and remove it as a separate function entirely.

iswellformed.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/phqtwhoptfn2upvmwqih/PHID-FILE-7amvv4zla6ziz5nsvpbq/iswellformed.patch)

[Anomie](/p/Anomie/) added a comment.[Mar 16 2015, 5:33 PM2015-03-16 17:33:04 (UTC+0)](#1122080)Comment Actions
> In [T85848#1118447](/T85848#1118447), [@csteipp](/p/csteipp/) wrote:
>
> True, need to buffer and check. Added a test case for that situation too.
>
> xmp-test2.patch9 KB[Download](https://phab.wmfusercontent.org/file/download/6fw7llous6bllwblk56s/PHID-FILE-klsmeb2v3vhz7qiam37r/xmp-test2.patch)

* The behavior of xml\_parse(), and therefore XMPReader::parse(), when $allOfIt = false is that it returns true until it finds an error. You seem to have assumed it returns false until it knows the file is good. Create an otherwise-valid file that leaves off the final '>', for example, and compare the return value when you run it through whole versus how you do testCheckParseSafety().
  + Which also means the logic you're adding in XMPReader after the call to checkParseSafety() needs adjustment to return true if !$allOfIt and $this->parsable is not NO, and revise the error message for the non-NO case when $allOfIt === true.
* The comment "XMP blocks must be less than 64KB, so urlencoding isn't completely crazy." doesn't really apply anymore, since we could be buffering hundreds of them.

> iswellformed.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/phqtwhoptfn2upvmwqih/PHID-FILE-7amvv4zla6ziz5nsvpbq/iswellformed.patch)

+1

[• csteipp](/p/csteipp/) added a comment.[Mar 16 2015, 8:18 PM2015-03-16 20:18:46 (UTC+0)](#1122924)Comment Actions
> * The behavior of xml\_parse(), and therefore XMPReader::parse(), when $allOfIt = false is that it returns true until it finds an error. You seem to have assumed it returns false until it knows the file is good. Create an otherwise-valid file that leaves off the final '>', for example, and compare the return value when you run it through whole versus how you do testCheckParseSafety().
>   + Which also means the logic you're adding in XMPReader after the call to checkParseSafety() needs adjustment to return true if !$allOfIt and $this->parsable is not NO, and revise the error message for the non-NO case when $allOfIt === true.
> * The comment "XMP blocks must be less than 64KB, so urlencoding isn't completely crazy." doesn't really apply anymore, since we could be buffering hundreds of them.

No current code (core or WMF repos) checks the return of parse / parseExtended, but you're right, it shouldn't really indicate that it was unsuccessful. I also updated the test case to have it's own "good" .xmp file for testing.

xmp-test3.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/v5qnwhqpqhnebrk2i6wx/PHID-FILE-sbiuu6wop7qza2rsnkeg/xmp-test3.patch)

[Anomie](/p/Anomie/) added a comment.[Mar 16 2015, 8:26 PM2015-03-16 20:26:37 (UTC+0)](#1122959)Comment Actions
> In [T85848#1122924](/T85848#1122924), [@csteipp](/p/csteipp/) wrote:
>
> xmp-test3.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/v5qnwhqpqhnebrk2i6wx/PHID-FILE-sbiuu6wop7qza2rsnkeg/xmp-test3.patch)

+1, although "fregmented" looks like a typo.

[• csteipp](/p/csteipp/) added a comment.[Mar 16 2015, 8:30 PM2015-03-16 20:30:56 (UTC+0)](#1122963)Comment Actions

I hear all the cool kids are fregmenting nowadays.

xmp-test4.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/ilsyucx4tcevvjxxzfof/PHID-FILE-jqkrbyfrjqaiabel52wa/xmp-test4.patch) fixed typo

[• csteipp](/p/csteipp/) added a comment.[Mar 16 2015, 8:37 PM2015-03-16 20:37:06 (UTC+0)](#1122987)Comment Actions

xmp-test5.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/r3l7ggtejl7z4mrzemsn/PHID-FILE-leashwj7u7afm4mzknbu/xmp-test5.patch)

[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-kgdgozijra4yrol/)[Mar 16 2015, 8:40 PM2015-03-16 20:40:24 (UTC+0)](#1122992)

[Anomie](/p/Anomie/) added a comment.[Mar 16 2015, 8:41 PM2015-03-16 20:41:00 (UTC+0)](#1122993)Comment Actions
> In [T85848#1122987](/T85848#1122987), [@csteipp](/p/csteipp/) wrote:
>
> xmp-test5.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/r3l7ggtejl7z4mrzemsn/PHID-FILE-leashwj7u7afm4mzknbu/xmp-test5.patch)

+1

[• csteipp](/p/csteipp/) closed this task as Resolved.[Mar 17 2015, 11:33 PM2015-03-17 23:33:33 (UTC+0)](#1126886)Comment Actions

Fixes all deployed

[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-a5f2c23cqciujsg/)[Mar 18 2015, 12:03 AM2015-03-18 00:03:13 (UTC+0)](#1126962)[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-eybdvfh22vyhprd/)[Anomie](/p/Anomie/) moved this task from [Needs Review/Feedback](/project/board/37/) to [Done](/project/board/37/) on the [MediaWiki-Core-Team](/tag/mediawiki-core-team/) board.[Mar 18 2015, 6:25 PM2015-03-18 18:25:52 (UTC+0)](#1129664)[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-luvicjw6yojiokh/)[Mar 19 2015, 9:17 PM2015-03-19 21:17:25 (UTC+0)](#1133349)[bd808](/p/bd808/) moved this task from [Done](/project/board/37/) to [Archive](/project/board/37/) on the [MediaWiki-Core-Team](/tag/mediawiki-core-team/) board.[Mar 24 2015, 11:05 PM2015-03-24 23:05:22 (UTC+0)](#1147002)[• csteipp](/p/csteipp/) mentioned this in [T88310: xml\_parse doesn't expand internal entities sometimes](/T88310).[Mar 25 2015, 1:27 AM2015-03-25 01:27:17 (UTC+0)](#1147436)[• csteipp](/p/csteipp/) added a comment.[Mar 27 2015, 7:32 PM2015-03-27 19:32:58 (UTC+0)](#1157830)Comment Actions

To address [T71210](/T71210), we can update the XMP patch to always check the xml with XMLReader before sending it through xml\_parse, and backport that. The patch has been running on hhvm servers for a while with no complaints from the commons community that I've been able to find, so I believe this shouldn't break things for most installs.

T85848-xmptest6.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/ulmkqhqzrs5vlkm4tnmm/PHID-FILE-3gqkci3wqtdr72grh42o/T85848-xmptest6.patch)

[Anomie](/p/Anomie/) added a comment.[Mar 27 2015, 8:38 PM2015-03-27 20:38:31 (UTC+0)](#1158031)Comment Actions
> In [T85848#1157830](/T85848#1157830), [@csteipp](/p/csteipp/) wrote:
>
> T85848-xmptest6.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/ulmkqhqzrs5vlkm4tnmm/PHID-FILE-3gqkci3wqtdr72grh42o/T85848-xmptest6.patch)

+1 I like this even better than xmp-test5.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/r3l7ggtejl7z4mrzemsn/PHID-FILE-leashwj7u7afm4mzknbu/xmp-test5.patch), since it doesn't assume non-HHVM is automatically ok.

[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-i35tfx3t7rukpfy/)[Mar 27 2015, 9:24 PM2015-03-27 21:24:16 (UTC+0)](#1158284)[• csteipp](/p/csteipp/) added a comment.[Mar 28 2015, 5:11 AM2015-03-28 05:11:28 (UTC+0)](#1159127)Comment Actions

T85848-xmptest6-REL1\_19.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/sxhqnf5wycdorjukkft6/PHID-FILE-ozbgu4egmxcx3a57reen/T85848-xmptest6-REL1_19.patch)

T85848-xmptest6-REL1\_24.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/lhrpu45oi2iwoesvfjtc/PHID-FILE-fept2xynptefvgyaoehe/T85848-xmptest6-REL1_24.patch)

[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-z2zsot3dlz6n5mo/)[Mar 28 2015, 5:15 AM2015-03-28 05:15:41 (UTC+0)](#1159130)[• csteipp](/p/csteipp/) added a comment.[Mar 28 2015, 5:19 AM2015-03-28 05:19:15 (UTC+0)](#1159140)Comment Actions
> In [T85848#1158031](/T85848#1158031), [@Anomie](/p/Anomie/) wrote:
>
> +1 I like this even better than xmp-test5.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/r3l7ggtejl7z4mrzemsn/PHID-FILE-leashwj7u7afm4mzknbu/xmp-test5.patch), since it doesn't assume non-HHVM is automatically ok.

Deployed this afternoon as part of,

21:10 csteipp: redeploy security patches to wmf22

21:02 csteipp: redeploy security patches to wmf23

[• csteipp](/p/csteipp/) added subscribers: [Grunny](/p/Grunny/), [ProgramCeltic](/p/ProgramCeltic/).[Mar 30 2015, 8:01 PM2015-03-30 20:01:37 (UTC+0)](#1164346)[• csteipp](/p/csteipp/) added a comment.[Mar 31 2015, 1:49 AM2015-03-31 01:49:48 (UTC+0)](#1165717)Comment Actions

While testing the backported 1.24 tarball, there's something weird with ScopedCallback never resetting the libxml flag... oh, hey, in 1.24, ScopedCallback doesn't pass parameters to the callback, just silently drops them.

T85848-xmptest6-REL1\_24b.patch11 KB[Download](https://phab.wmfusercontent.org/file/download/qsrkzvev3obn6vuymhor/PHID-FILE-jw2qf52a6bawqh5inolr/T85848-xmptest6-REL1_24b.patch)

[• csteipp](/p/csteipp/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-hf4k3axshjhcekl/)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-hf4k3axshjhcekl/)".[Mar 31 2015, 12:37 PM2015-03-31 12:37:12 (UTC+0)](#1166658)[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-6emle4gktmhqu2l/)[Mar 31 2015, 1:05 PM2015-03-31 13:05:55 (UTC+0)](#1166707)[• csteipp](/p/csteipp/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-7kkzy3oco4pml4k/)" to "Public (No Login Required)".[Mar 31 2015, 9:15 PM2015-03-31 21:15:15 (UTC+0)](#1168313)[• csteipp](/p/csteipp/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-kqxlcp4hkpniptz/)" to "All Users".[• csteipp](/p/csteipp/) changed Security from Software security bug to None.[gerritbot](/p/gerritbot/) subscribed.[Mar 31 2015, 9:22 PM2015-03-31 21:22:28 (UTC+0)](#1168377)Comment Actions

Change 201018 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow directly calling Xml::isWellFormed

<https://gerrit.wikimedia.org/r/201018>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Mar 31 2015, 9:22 PM2015-03-31 21:22:28 (UTC+0)](#1168378)Comment Actions

Change 201019 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow entities in XMP

<https://gerrit.wikimedia.org/r/201019>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 9:30 PM2015-03-31 21:30:05 (UTC+0)](#1168414)Comment Actions

Change 201029 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow directly calling Xml::isWellFormed

<https://gerrit.wikimedia.org/r/201029>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 9:30 PM2015-03-31 21:30:06 (UTC+0)](#1168415)Comment Actions

Change 201030 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow entities in XMP

<https://gerrit.wikimedia.org/r/201030>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 9:35 PM2015-03-31 21:35:37 (UTC+0)](#1168439)Comment Actions

Change 201039 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow entities in XMP

<https://gerrit.wikimedia.org/r/201039>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 10:05 PM2015-03-31 22:05:07 (UTC+0)](#1168507)Comment Actions

Change 201018 merged by jenkins-bot:

SECURITY: Don't allow directly calling Xml::isWellFormed

<https://gerrit.wikimedia.org/r/201018>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 10:05 PM2015-03-31 22:05:28 (UTC+0)](#1168515)Comment Actions

Change 201019 merged by jenkins-bot:

SECURITY: Don't allow entities in XMP

<https://gerrit.wikimedia.org/r/201019>

[• csteipp](/p/csteipp/) mentioned this in [rMW31f089fc4be2: SECURITY: Don't allow directly calling Xml::isWellFormed](/rMW31f089fc4be2940757aa313efc1bd42fe2a8f4fb).[Mar 31 2015, 10:05 PM2015-03-31 22:05:32 (UTC+0)](#1168518)[• csteipp](/p/csteipp/) mentioned this in [rMWc1fcf97e9a5a: SECURITY: Don't allow entities in XMP](/rMWc1fcf97e9a5ab83dae1efa770bcb8ab6f1ed0cf4).[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 10:22 PM2015-03-31 22:22:02 (UTC+0)](#1168592)Comment Actions

Change 201029 merged by jenkins-bot:

SECURITY: Don't allow directly calling Xml::isWellFormed

<https://gerrit.wikimedia.org/r/201029>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 10:22 PM2015-03-31 22:22:05 (UTC+0)](#1168593)Comment Actions

Change 201030 merged by jenkins-bot:

SECURITY: Don't allow entities in XMP

<https://gerrit.wikimedia.org/r/201030>

[• csteipp](/p/csteipp/) mentioned this in [rMW336bcd330c6e: SECURITY: Don't allow directly calling Xml::isWellFormed](/rMW336bcd330c6ea1a34062480468f4aea1a7280cee).[Mar 31 2015, 10:22 PM2015-03-31 22:22:16 (UTC+0)](#1168603)[• csteipp](/p/csteipp/) mentioned this in [rMW3ed926d89e77: SECURITY: Don't allow entities in XMP](/rMW3ed926d89e775b797451a2b67c6825e8a959363b).[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2015, 10:28 PM2015-03-31 22:28:12 (UTC+0)](#1168638)Comment Actions

Change 201039 merged by jenkins-bot:

SECURITY: Don't allow entities in XMP

<https://gerrit.wikimedia.org/r/201039>

[• csteipp](/p/csteipp/) mentioned this in [rMW9a2b649587f1: SECURITY: Don't allow entities in XMP](/rMW9a2b649587f14c3c067ea00ba89dff07fd2c68ed).[Mar 31 2015, 10:28 PM2015-03-31 22:28:25 (UTC+0)](#1168639)[gerritbot](/p/gerritbot/) added a comment.[Apr 1 2015, 4:57 PM2015-04-01 16:57:24 (UTC+0)](#1170744)Comment Actions

Change 201224 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow directly calling Xml::isWellFormed

<https://gerrit.wikimedia.org/r/201224>

[gerritbot](/p/gerritbot/) added a comment.[Apr 1 2015, 4:57 PM2015-04-01 16:57:25 (UTC+0)](#1170745)Comment Actions

Change 201225 had a related patch set uploaded (by CSteipp):

SECURITY: Don't allow entities in XMP with HHVM

<https://gerrit.wikimedia.org/r/201225>

[gerritbot](/p/gerritbot/) added a comment.[Apr 1 2015, 5:40 PM2015-04-01 17:40:15 (UTC+0)](#1170940)Comment Actions

Change 201224 merged by jenkins-bot:

SECURITY: Don't allow directly calling Xml::isWellFormed

<https://gerrit.wikimedia.org/r/201224>

[gerritbot](/p/gerritbot/) added a comment.[Apr 1 2015, 5:40 PM2015-04-01 17:40:19 (UTC+0)](#1170941)Comment Actions

Change 201225 merged by jenkins-bot:

SECURITY: Don't allow entities in XMP with HHVM

<https://gerrit.wikimedia.org/r/201225>

[• csteipp](/p/csteipp/) mentioned this in [rMW00bd303b6048: SECURITY: Don't allow directly calling Xml::isWellFormed](/rMW00bd303b6048213bb75ee0d0307256a678a91cc9).[Apr 1 2015, 5:40 PM2015-04-01 17:40:25 (UTC+0)](#1170943)[• csteipp](/p/csteipp/) mentioned this in [rMW15ce698afc0b: SECURITY: Don't allow entities in XMP with HHVM](/rMW15ce698afc0bb3ab56217981c3e16ef0d4f9de74).[• csteipp](/p/csteipp/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-2wxmsgtvuhdhdco/)[Apr 9 2015, 11:30 PM2015-04-09 23:30:22 (UTC+0)](#1196446)[• csteipp](/p/csteipp/) added a project: [Vuln-DoS](/tag/vuln-dos/).[Aug 20 2015, 10:00 PM2015-08-20 22:00:51 (UTC+0)](#1558971)[Seb35](/p/Seb35/) mentioned this in [T116701: XMPReader::checkParseSafely requires allow\_url\_fopen to be set enabled](/T116701).[Sep 24 2018, 11:55 AM2018-09-24 11:55:46 (UTC+0)](#4610443)[• chasemp](/p/chasemp/) added a project: [Security](/tag/security/).[Feb 10 2020, 10:56 PM2020-02-10 22:56:08 (UTC+0)](#5868769) · [• chasemp](/p/chasemp/) removed a project: [acl\*security](/tag/acl_security/).[Feb 20 2020, 8:16 PM2020-02-20 20:16:13 (UTC+0)](#5904315) · [Aklapper](/p/Aklapper/) removed a subscriber: [Anomie](/p/Anomie/).[Oct 16 2020, 5:41 PM2020-10-16 17:41:12 (UTC+0)](#6554397) · [Log In to Comment](/login/?next=)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from phab.wmfusercontent.org_fbe2f491_20250126_095557.html ===
From a9852fead009bf82c6a9e2259aff081f3225b574 Mon Sep 17 00:00:00 2001
From: csteipp
Date: Fri, 27 Mar 2015 16:27:19 -0700
Subject: [PATCH] SECURITY: Don't allow entities in XMP
Test for, and refuse to parse, XMP chunks with a doctype declaration
when parsing XMP.
Bug: T85848
Change-Id: Iea4feb077ee85a35509a920153daaa9321ee69f3
---
includes/media/BitmapMetadataHandler.php | 6 +-
includes/media/JpegMetadataExtractor.php | 2 +-
includes/media/XMP.php | 96 ++++++++++++++++++++++
tests/phpunit/data/xmp/doctype-included.result.php | 3 +
tests/phpunit/data/xmp/doctype-included.xmp | 12 +++
tests/phpunit/data/xmp/doctype-not-included.xmp | 11 +++
tests/phpunit/includes/media/XMPTest.php | 49 +++++++++++
7 files changed, 175 insertions(+), 4 deletions(-)
create mode 100644 tests/phpunit/data/xmp/doctype-included.result.php
create mode 100644 tests/phpunit/data/xmp/doctype-included.xmp
create mode 100644 tests/phpunit/data/xmp/doctype-not-included.xmp
diff --git a/includes/media/BitmapMetadataHandler.php b/includes/media/BitmapMetadataHandler.php
index 746dddd..566018c 100644
--- a/includes/media/BitmapMetadataHandler.php
+++ b/includes/media/BitmapMetadataHandler.php
@@ -126,7 +126,7 @@ class BitmapMetadataHandler {
\* @throws MWException on invalid file.
\*/
static function Jpeg ( $filename ) {
- $showXMP = function\_exists( 'xml\_parser\_create\_ns' );
+ $showXMP = XMPReader::isSupported();
$meta = new self();
$seg = JpegMetadataExtractor::segmentSplitter( $filename );
@@ -168,7 +168,7 @@ class BitmapMetadataHandler {
\* @return Array Array for storage in img\_metadata.
\*/
static public function PNG ( $filename ) {
- $showXMP = function\_exists( 'xml\_parser\_create\_ns' );
+ $showXMP = XMPReader::isSupported();
$meta = new self();
$array = PNGMetadataExtractor::getMetadata( $filename );
@@ -205,7 +205,7 @@ class BitmapMetadataHandler {
$meta->addMetadata( array( 'GIFFileComment' => $baseArray['comment'] ), 'native' );
}
- if ( $baseArray['xmp'] !== '' && function\_exists( 'xml\_parser\_create\_ns' ) ) {
+ if ( $baseArray['xmp'] !== '' && XMPReader::isSupported() ) {
$xmp = new XMPReader();
$xmp->parse( $baseArray['xmp'] );
$xmpRes = $xmp->getResults();
diff --git a/includes/media/JpegMetadataExtractor.php b/includes/media/JpegMetadataExtractor.php
index 224b4a2..7cbd2e9 100644
--- a/includes/media/JpegMetadataExtractor.php
+++ b/includes/media/JpegMetadataExtractor.php
@@ -24,7 +24,7 @@ class JpegMetadataExtractor {
\* @throws MWException if given invalid file.
\*/
static function segmentSplitter ( $filename ) {
- $showXMP = function\_exists( 'xml\_parser\_create\_ns' );
+ $showXMP = XMPReader::isSupported();
$segmentCount = 0;
diff --git a/includes/media/XMP.php b/includes/media/XMP.php
index 0dbf563..3a4a915 100644
--- a/includes/media/XMP.php
+++ b/includes/media/XMP.php
@@ -40,6 +40,12 @@ class XMPReader {
protected $items;
+ /\*\* @var int Flag determining if the XMP is safe to parse \*\*/
+ private $parsable = 0;
+
+ /\*\* @var string Buffer of XML to parse \*\*/
+ private $xmlParsableBuffer = '';
+
/\*\*
\* These are various mode constants.
\* they are used to figure out what to do
@@ -69,6 +75,12 @@ class XMPReader {
const NS\_XML = 'http://www.w3.org/XML/1998/namespace';
+ // States used while determining if XML is safe to parse
+ const PARSABLE\_UNKNOWN = 0;
+ const PARSABLE\_OK = 1;
+ const PARSABLE\_BUFFERING = 2;
+ const PARSABLE\_NO = 3;
+
/\*\*
\* Constructor.
\*
@@ -106,6 +118,9 @@ class XMPReader {
array( $this, 'endElement' ) );
xml\_set\_character\_data\_handler( $this->xmlParser, array( $this, 'char' ) );
+
+ $this->parsable = self::PARSABLE\_UNKNOWN;
+ $this->xmlParsableBuffer = '';
}
/\*\* Destroy the xml parser
@@ -117,6 +132,13 @@ class XMPReader {
xml\_parser\_free( $this->xmlParser );
}
+ /\*\*
+ \* Check if this instance supports using this class
+ \*/
+ public static function isSupported() {
+ return function\_exists( 'xml\_parser\_create\_ns' ) && class\_exists( 'XMLReader' );
+ }
+
/\*\* Get the result array. Do some post-processing before returning
\* the array, and transform any metadata that is special-cased.
\*
@@ -263,6 +285,27 @@ class XMPReader {
wfRestoreWarnings();
}
+ // Ensure the XMP block does not have an xml doctype declaration, which
+ // could declare entities unsafe to parse with xml\_parse (T85848/T71210).
+ if ( $this->parsable !== self::PARSABLE\_OK ) {
+ if ( $this->parsable === self::PARSABLE\_NO ) {
+ throw new MWException( 'Unsafe doctype declaration in XML.' );
+ }
+
+ $content = $this->xmlParsableBuffer . $content;
+ if ( !$this->checkParseSafety( $content ) ) {
+ if ( !$allOfIt && $this->parsable !== self::PARSABLE\_NO ) {
+ // parse wasn't Unsuccessful yet, so return true
+ // in this case.
+ return true;
+ }
+ $msg = ( $this->parsable === self::PARSABLE\_NO ) ?
+ 'Unsafe doctype declaration in XML.' :
+ 'No root element found in XML.';
+ throw new MWException( $msg );
+ }
+ }
+
$ok = xml\_parse( $this->xmlParser, $content, $allOfIt );
if ( !$ok ) {
$error = xml\_error\_string( xml\_get\_error\_code( $this->xmlParser ) );
@@ -385,6 +428,59 @@ class XMPReader {
}
+ /\*\*
+ \* Check if a block of XML is safe to pass to xml\_parse, i.e. doesn't
+ \* contain a doctype declaration which could contain a dos attack if we
+ \* parse it and expand internal entities (T85848).
+ \*
+ \* @param string $content xml string to check for parse safety
+ \* @return bool true if the xml is safe to parse, false otherwise
+ \*/
+ private function checkParseSafety( $content ) {
+ $reader = new XMLReader();
+ $result = null;
+
+ // For XMLReader to parse incomplete/invalid XML, it has to be open()'ed
+ // instead of using XML().
+ $reader->open(
+ 'data://text/plain,' . urlencode( $content ),
+ null,
+ LIBXML\_NOERROR | LIBXML\_NOWARNING | LIBXML\_NONET
+ );
+
+ $oldDisable = libxml\_disable\_entity\_loader( true );
+ $reader->setParserProperty( XMLReader::SUBST\_ENTITIES, false );
+
+ // Even with LIBXML\_NOWARNING set, XMLReader::read gives a warning
+ // when parsing truncated XML, which causes unit tests to fail.
+ wfSuppressWarnings();
+ while ( $reader->read() ) {
+ if ( $reader->nodeType === XMLReader::ELEMENT ) {
+ // Reached the first element without hitting a doctype declaration
+ $this->parsable = self::PARSABLE\_OK;
+ $result = true;
+ break;
+ }
+ if ( $reader->nodeType === XMLReader::DOC\_TYPE ) {
+ $this->parsable = self::PARSABLE\_NO;
+ $result = false;
+ break;
+ }
+ }
+ wfRestoreWarnings();
+ libxml\_disable\_entity\_loader( $oldDisable );
+
+ if ( !is\_null( $result ) ) {
+ return $result;
+ }
+
+ // Reached the end of the parsable xml without finding an element
+ // or doctype. Buffer and try again.
+ $this->parsable = self::PARSABLE\_BUFFERING;
+ $this->xmlParsableBuffer = $content;
+ return false;
+ }
+
/\*\* When we hit a closing element in MODE\_IGNORE
\* Check to see if this is the element we started to ignore,
\* in which case we get out of MODE\_IGNORE
diff --git a/tests/phpunit/data/xmp/doctype-included.result.php b/tests/phpunit/data/xmp/doctype-included.result.php
new file mode 100644
index 0000000..9a9cc36
--- /dev/null
+++ b/tests/phpunit/data/xmp/doctype-included.result.php
@@ -0,0 +1,3 @@
+php
+
+$result = array();
diff --git a/tests/phpunit/data/xmp/doctype-included.xmp b/tests/phpunit/data/xmp/doctype-included.xmp
new file mode 100644
index 0000000..8c94675
--- /dev/null
+++ b/tests/phpunit/data/xmp/doctype-included.xmp
@@ -0,0 +1,12 @@
+<?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?  ]>
+
+
+
+
+True 0 1 False False
+
+xpacket end="w"?
diff --git a/tests/phpunit/data/xmp/doctype-not-included.xmp b/tests/phpunit/data/xmp/doctype-not-included.xmp
new file mode 100644
index 0000000..9a40b4b
--- /dev/null
+++ b/tests/phpunit/data/xmp/doctype-not-included.xmp
@@ -0,0 +1,11 @@
+xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?
+
+
+
+True 0 1 False False
+
+xpacket end="w"?
diff --git a/tests/phpunit/includes/media/XMPTest.php b/tests/phpunit/includes/media/XMPTest.php
index c952b23..01cd657 100644
--- a/tests/phpunit/includes/media/XMPTest.php
+++ b/tests/phpunit/includes/media/XMPTest.php
@@ -53,6 +53,8 @@ class XMPTest extends MediaWikiTestCase {
array( 'utf32LE', 'UTF-32LE encoding' ),
array( 'xmpExt', 'Extended XMP missing second part' ),
);
+ $xmpFiles[] = array( 'doctype-included', 'XMP includes doctype' );
+
foreach( $xmpFiles as $file ) {
$xmp = file\_get\_contents( $xmpPath . $file[0] . '.xmp' );
// I'm not sure if this is the best way to handle getting the
@@ -154,4 +156,51 @@ class XMPTest extends MediaWikiTestCase {
$this->assertEquals( $expected, $actual );
}
+ /\*\*
+ \* Test for multi-section, hostile XML
+ \* @covers checkParseSafety
+ \*/
+ public function testCheckParseSafety() {
+
+ // Test for detection
+ $xmpPath = \_\_DIR\_\_ . '/../../data/xmp/';
+ $file = fopen( $xmpPath . 'doctype-included.xmp', 'rb' );
+ $valid = false;
+ $reader = new XMPReader();
+ do {
+ $chunk = fread( $file, 10 );
+ $valid = $reader->parse( $chunk, feof( $file ) );
+ } while ( !feof( $file ) );
+ $this->assertFalse( $valid, 'Check that doctype is detected in fragmented XML' );
+ $this->assertEquals(
+ array(),
+ $reader->getResults(),
+ 'Check that doctype is detected in fragmented XML'
+ );
+ fclose( $file );
+ unset( $reader );
+
+ // Test for false positives
+ $file = fopen( $xmpPath . 'doctype-not-included.xmp', 'rb' );
+ $valid = false;
+ $reader = new XMPReader();
+ do {
+ $chunk = fread( $file, 10 );
+ $valid = $reader->parse( $chunk, feof( $file ) );
+ } while ( !feof( $file ) );
+ $this->assertTrue(
+ $valid,
+ 'Check for false-positive detecting doctype in fragmented XML'
+ );
+ $this->assertEquals(
+ array(
+ 'xmp-exif' => array(
+ 'DigitalZoomRatio' => '0/10',
+ 'Flash' => '9'
+ )
+ ),
+ $reader->getResults(),
+ 'Check that doctype is detected in fragmented XML'
+ );
+ }
}
--
1.8.4.5

