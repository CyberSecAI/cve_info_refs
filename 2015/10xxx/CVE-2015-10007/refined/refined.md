The provided content is related to CVE-2015-10007. This commit addresses SQL injection and XSS vulnerabilities in the WEIPDCRM project.

**Root cause of vulnerability:**
The code was vulnerable to SQL injection because it was directly concatenating user-supplied input into SQL queries without proper sanitization. It also had XSS vulnerabilities because it was not sanitizing user supplied data before using it in HTML output.

**Weaknesses/vulnerabilities present:**
*   **SQL Injection:** The original code used direct string concatenation to build SQL queries, making it susceptible to SQL injection attacks. Specifically the `commercial.php` file is using unsanitized input from the `$_GET['Package']` variable.
*   **Cross-Site Scripting (XSS):** The code was not properly sanitizing the `$_GET` parameters which are then displayed in HTML, leading to potential XSS attacks. Specifically in the `commercial.php` file several `$_GET` variables, such as `optEmail`, `payAmount`, `title`, and `memo` are echoed back to the page.

**Impact of exploitation:**
*   **SQL Injection:** An attacker could manipulate SQL queries to extract sensitive information from the database, modify data, or even gain unauthorized access to the system.
*  **XSS:** An attacker could inject malicious scripts into the page, which would then be executed by other users viewing the affected pages, potentially leading to session hijacking, cookie stealing, or other malicious activities.

**Attack vectors:**
*   **SQL Injection:** By crafting a malicious `Package` parameter in the URL, an attacker could inject arbitrary SQL code into the database query.
*   **XSS:** By crafting malicious `optEmail`, `payAmount`, `title`, or `memo` parameters in the URL, an attacker could inject arbitrary javascript into the HTML output.

**Required attacker capabilities/position:**
*   The attacker needs to be able to make HTTP requests to the vulnerable application with malicious parameters. No special user privileges or positions are required, as it appears the affected functionality is publicly accessible.

**Changes made:**
*   **SQL Injection:** The code was updated to use prepared statements via `DB::prepare` instead of directly concatenating user-provided values into SQL queries. This change is implemented in `commercial.php` and other files using `DB::query`, ensuring that all user-provided data is properly escaped and sanitized before being used in SQL queries.
*   **XSS:** A new `xss_clean` function was added, and the code was updated to apply this function to user-provided `$_GET` parameters before using them in HTML output, which helps to prevent XSS attacks. This change is implemented in the `commercial.php` file.
*   **Error Suppression:** The install function now suppresses errors.
*   **Login Fix:** There was a fix for login failures not auto-resetting.