=== Content from www.sudo.ws_1aaba59e_20250125_092023.html ===

[![mercurial](/repos/sudo/static/hglogo.png)](https://mercurial-scm.org/)

* [log](/repos/sudo/shortlog/397722cdd7ec)
* [graph](/repos/sudo/graph/397722cdd7ec)
* [tags](/repos/sudo/tags)
* [bookmarks](/repos/sudo/bookmarks)
* [branches](/repos/sudo/branches)

* changeset
* [raw](/repos/sudo/raw-rev/397722cdd7ec)
* [browse](/repos/sudo/file/397722cdd7ec)

* [help](/repos/sudo/help)

## [Mercurial](/) > [repos](/repos) > [sudo](/repos/sudo)

### changeset 10293:[397722cdd7ec](/repos/sudo/rev/397722cdd7ec)

Find changesets by keywords (author, files, the commit message), revision
number or hash, or [revset expression](/repos/sudo/help/revsets).

Add support for using fexecve() if supported on commands that are
checksummed.

| author | Todd C. Miller <Todd.Miller@courtesan.com> |
| --- | --- |
| date | Mon, 04 Jan 2016 10:35:18 -0700 |
| parents | [33272418bb10](/repos/sudo/rev/33272418bb10) |
| children | [94ffd6b18431](/repos/sudo/rev/94ffd6b18431) |
| files | [configure](/repos/sudo/file/397722cdd7ec/configure) [configure.ac](/repos/sudo/file/397722cdd7ec/configure.ac) [doc/sudo\_plugin.cat](/repos/sudo/file/397722cdd7ec/doc/sudo_plugin.cat) [doc/sudo\_plugin.man.in](/repos/sudo/file/397722cdd7ec/doc/sudo_plugin.man.in) [doc/sudo\_plugin.mdoc.in](/repos/sudo/file/397722cdd7ec/doc/sudo_plugin.mdoc.in) [doc/sudoers.cat](/repos/sudo/file/397722cdd7ec/doc/sudoers.cat) [doc/sudoers.man.in](/repos/sudo/file/397722cdd7ec/doc/sudoers.man.in) [doc/sudoers.mdoc.in](/repos/sudo/file/397722cdd7ec/doc/sudoers.mdoc.in) [include/sudo\_plugin.h](/repos/sudo/file/397722cdd7ec/include/sudo_plugin.h) [plugins/sudoers/match.c](/repos/sudo/file/397722cdd7ec/plugins/sudoers/match.c) [plugins/sudoers/policy.c](/repos/sudo/file/397722cdd7ec/plugins/sudoers/policy.c) [plugins/sudoers/sudoers.h](/repos/sudo/file/397722cdd7ec/plugins/sudoers/sudoers.h) [src/exec.c](/repos/sudo/file/397722cdd7ec/src/exec.c) [src/exec\_common.c](/repos/sudo/file/397722cdd7ec/src/exec_common.c) [src/selinux.c](/repos/sudo/file/397722cdd7ec/src/selinux.c) [src/sesh.c](/repos/sudo/file/397722cdd7ec/src/sesh.c) [src/sudo.c](/repos/sudo/file/397722cdd7ec/src/sudo.c) [src/sudo.h](/repos/sudo/file/397722cdd7ec/src/sudo.h) [src/sudo\_exec.h](/repos/sudo/file/397722cdd7ec/src/sudo_exec.h) |
| diffstat | 19 files changed, 209 insertions(+), 68 deletions(-) [+] [-]  | [configure](#l1.1) | 7 |  | | --- | --- | --- | | [configure.ac](#l2.1) | 8 |  | | [doc/sudo\_plugin.cat](#l3.1) | 10 |  | | [doc/sudo\_plugin.man.in](#l4.1) | 22 |  | | [doc/sudo\_plugin.mdoc.in](#l5.1) | 20 |  | | [doc/sudoers.cat](#l6.1) | 12 |  | | [doc/sudoers.man.in](#l7.1) | 16 |  | | [doc/sudoers.mdoc.in](#l8.1) | 16 |  | | [include/sudo\_plugin.h](#l9.1) | 4 |  | | [plugins/sudoers/match.c](#l10.1) | 57 |  | | [plugins/sudoers/policy.c](#l11.1) | 15 |  | | [plugins/sudoers/sudoers.h](#l12.1) | 4 |  | | [src/exec.c](#l13.1) | 10 |  | | [src/exec\_common.c](#l14.1) | 13 |  | | [src/selinux.c](#l15.1) | 17 |  | | [src/sesh.c](#l16.1) | 17 |  | | [src/sudo.c](#l17.1) | 18 |  | | [src/sudo.h](#l18.1) | 7 |  | | [src/sudo\_exec.h](#l19.1) | 4 |  | |

line wrap: on
 line diff
```

--- a/configure	Tue Dec 29 13:38:14 2015 -0700
+++ b/configure	Mon Jan 04 10:35:18 2016 -0700
@@ -2650,6 +2650,7 @@
 as_fn_append ac_header_list " sys/select.h"
 as_fn_append ac_header_list " sys/stropts.h"
 as_fn_append ac_header_list " sys/sysmacros.h"
+as_fn_append ac_func_list " fexecve"
 as_fn_append ac_func_list " killpg"
 as_fn_append ac_func_list " nl_langinfo"
 as_fn_append ac_func_list " strftime"
@@ -18078,6 +18079,8 @@

+
+
 for ac_func in getgrouplist
 do :
   ac_fn_c_check_func "$LINENO" "getgrouplist" "ac_cv_func_getgrouplist"
@@ -19903,8 +19906,8 @@
 fi
 done

-    # Check for fexecve, posix_spawn, and posix_spawnp
-    for ac_func in fexecve posix_spawn posix_spawnp
+    # Check for posix_spawn, and posix_spawnp
+    for ac_func in posix_spawn posix_spawnp
 do :
   as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
 ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
```
```

--- a/configure.ac	Tue Dec 29 13:38:14 2015 -0700
+++ b/configure.ac	Mon Jan 04 10:35:18 2016 -0700
@@ -1,7 +1,7 @@
 dnl
 dnl Use the top-level autogen.sh script to generate configure and config.h.in
 dnl
-dnl Copyright (c) 1994-1996,1998-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+dnl Copyright (c) 1994-1996,1998-2016 Todd C. Miller <Todd.Miller@courtesan.com>
 dnl
 AC_PREREQ([2.59])
 AC_INIT([sudo], [1.8.16], [https://bugzilla.sudo.ws/], [sudo])
@@ -2384,7 +2384,7 @@
 dnl Function checks
 dnl
 AC_FUNC_GETGROUPS
-AC_CHECK_FUNCS_ONCE([killpg nl_langinfo strftime pread pwrite openat])
+AC_CHECK_FUNCS_ONCE([fexecve killpg nl_langinfo strftime pread pwrite openat])
 AC_CHECK_FUNCS([getgrouplist], [], [
     case "$host_os" in
     aix*)
@@ -2676,8 +2676,8 @@
 if test X"$with_noexec" != X"no"; then
     # Check for non-standard exec functions
     AC_CHECK_FUNCS([exect execvP execvpe])
-    # Check for fexecve, posix_spawn, and posix_spawnp
-    AC_CHECK_FUNCS([fexecve posix_spawn posix_spawnp])
+    # Check for posix_spawn, and posix_spawnp
+    AC_CHECK_FUNCS([posix_spawn posix_spawnp])
 fi

 dnl
```
```

--- a/doc/sudo_plugin.cat	Tue Dec 29 13:38:14 2015 -0700
+++ b/doc/sudo_plugin.cat	Mon Jan 04 10:35:18 2016 -0700
@@ -499,6 +499,11 @@
                        This setting has no effect unless I/O logging is
                        enabled or _u_s_e___p_t_y is enabled.

+                 execfd=number
+                       If specified, ssuuddoo will use the fexecve(2) system call
+                       to execute the command instead of execve(2).  The
+                       specified _n_u_m_b_e_r must refer to an open file descriptor.
+
                  iolog_compress=bool
                        Set to true if the I/O logging plugins, if any, should
                        compress the log data.  This is a hint to the I/O
@@ -1505,6 +1510,9 @@
            it supports plugin API version 1.8 or higher to receive a
            conversation function pointer that supports this argument.

+     Version 1.9 (sudo 1.8.16)
+           The _e_x_e_c_f_d entry was added to the command_info list.
+
 SSEEEE AALLSSOO
      sudo.conf(4), sudoers(4), sudo(1m)

@@ -1534,4 +1542,4 @@
      file distributed with ssuuddoo or https://www.sudo.ws/license.html for
      complete details.

-Sudo 1.8.16                    November 20, 2015                   Sudo 1.8.16
+Sudo 1.8.16                     January 4, 2016                    Sudo 1.8.16
```
```

--- a/doc/sudo_plugin.man.in	Tue Dec 29 13:38:14 2015 -0700
+++ b/doc/sudo_plugin.man.in	Mon Jan 04 10:35:18 2016 -0700
@@ -1,7 +1,7 @@
 .\" DO NOT EDIT THIS FILE, IT IS NOT THE MASTER!
 .\" IT IS GENERATED AUTOMATICALLY FROM sudo_plugin.mdoc.in
 .\"
-.\" Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+.\" Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
 .\"
 .\" Permission to use, copy, modify, and distribute this software for any
 .\" purpose with or without fee is hereby granted, provided that the above
@@ -16,7 +16,7 @@
 .\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 .\" ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 .\"
-.TH "SUDO_PLUGIN" "5" "November 20, 2015" "Sudo @PACKAGE_VERSION@" "File Formats Manual"
+.TH "SUDO_PLUGIN" "5" "January 4, 2016" "Sudo @PACKAGE_VERSION@" "File Formats Manual"
 .nh
 .if n .ad l
 .SH "NAME"
@@ -881,6 +881,17 @@
 \fIuse_pty\fR
 is enabled.
 .TP 6n
+execfd=number
+If specified,
+\fBsudo\fR
+will use the
+fexecve(2)
+system call to execute the command instead of
+execve(2).
+The specified
+\fInumber\fR
+must refer to an open file descriptor.
+.TP 6n
 iolog_compress=bool
 Set to true if the I/O logging plugins, if any, should compress the
 log data.
@@ -2703,6 +2714,13 @@
 definition has been updated to match.
 The plugin must specify that it supports plugin API version 1.8 or higher
 to receive a conversation function pointer that supports this argument.
+.TP 6n
+Version 1.9 (sudo 1.8.16)
+The
+\fIexecfd\fR
+entry was added to the
+\fRcommand_info\fR
+list.
 .SH "SEE ALSO"
 sudo.conf(@mansectform@),
 sudoers(@mansectform@),
```
```

--- a/doc/sudo_plugin.mdoc.in	Tue Dec 29 13:38:14 2015 -0700
+++ b/doc/sudo_plugin.mdoc.in	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 .\"
-.\" Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+.\" Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
 .\"
 .\" Permission to use, copy, modify, and distribute this software for any
 .\" purpose with or without fee is hereby granted, provided that the above
@@ -14,7 +14,7 @@
 .\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 .\" ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 .\"
-.Dd November 20, 2015
+.Dd January 4, 2016
 .Dt SUDO_PLUGIN @mansectform@
 .Os Sudo @PACKAGE_VERSION@
 .Sh NAME
@@ -784,6 +784,16 @@
 This setting has no effect unless I/O logging is enabled or
 .Em use_pty
 is enabled.
+.It execfd=number
+If specified,
+.Nm sudo
+will use the
+.Xr fexecve 2
+system call to execute the command instead of
+.Xr execve 2 .
+The specified
+.Em number
+must refer to an open file descriptor.
 .It iolog_compress=bool
 Set to true if the I/O logging plugins, if any, should compress the
 log data.
@@ -2367,6 +2377,12 @@
 definition has been updated to match.
 The plugin must specify that it supports plugin API version 1.8 or higher
 to receive a conversation function pointer that supports this argument.
+.It Version 1.9 (sudo 1.8.16)
+The
+.Em execfd
+entry was added to the
+.Li command_info
+list.
 .El
 .Sh SEE ALSO
 .Xr sudo.conf @mansectform@ ,
```
```

--- a/doc/sudoers.cat	Tue Dec 29 13:38:14 2015 -0700
+++ b/doc/sudoers.cat	Mon Jan 04 10:35:18 2016 -0700
@@ -408,10 +408,12 @@
      $ openssl dgst -binary -sha224 /bin/ls | openssl base64
      EYGH2oNk1JC0p9679IMATo8+BT7JVDCd4sQaJQ==

-     If the user has write access to either the command itself or the
-     directory in which the command is located (directly or via a ssuuddoo
-     command) it may be possible for the user to replace the command after the
-     digest check has been performed but before the command is executed.
+     Warning, if the user has write access to the command itself (directly or
+     via a ssuuddoo command), it may be possible for the user to replace the
+     command after the digest check has been performed but before the command
+     is executed.  A similar race condition exists on systems that lack the
+     fexecve(2) system call when the directory in which the command is located
+     is writable by the user.

      Command digests are only supported by version 1.8.7 or higher.

@@ -2493,4 +2495,4 @@
      file distributed with ssuuddoo or https://www.sudo.ws/license.html for
      complete details.

-Sudo 1.8.16                    December 11, 2015                   Sudo 1.8.16
+Sudo 1.8.16                     January 4, 2015                    Sudo 1.8.16
```
```

--- a/doc/sudoers.man.in	Tue Dec 29 13:38:14 2015 -0700
+++ b/doc/sudoers.man.in	Mon Jan 04 10:35:18 2016 -0700
@@ -1,7 +1,7 @@
 .\" DO NOT EDIT THIS FILE, IT IS NOT THE MASTER!
 .\" IT IS GENERATED AUTOMATICALLY FROM sudoers.mdoc.in
 .\"
-.\" Copyright (c) 1994-1996, 1998-2005, 2007-2015
+.\" Copyright (c) 1994-1996, 1998-2005, 2007-2016
 .\"	Todd C. Miller <Todd.Miller@courtesan.com>
 .\"
 .\" Permission to use, copy, modify, and distribute this software for any
@@ -21,7 +21,7 @@
 .\" Agency (DARPA) and Air Force Research Laboratory, Air Force
 .\" Materiel Command, USAF, under agreement number F39502-99-1-0512.
 .\"
-.TH "SUDOERS" "5" "December 11, 2015" "Sudo @PACKAGE_VERSION@" "File Formats Manual"
+.TH "SUDOERS" "5" "January 4, 2015" "Sudo @PACKAGE_VERSION@" "File Formats Manual"
 .nh
 .if n .ad l
 .SH "NAME"
@@ -874,12 +874,14 @@
 .RE
 .fi
 .PP
-If the user has write access to either the command itself or the
-directory in which the command is located (directly or via a
+Warning, if the user has write access to the command itself (directly or via a
 \fBsudo\fR
-command) it may be possible for the user to replace the command
-after the digest check has been performed but before the command
-is executed.
+command), it may be possible for the user to replace the command after the
+digest check has been performed but before the command is executed.
+A similar race condition exists on systems that lack the
+fexecve(2)
+system call when the directory in which the command is located
+is writable by the user.
 .PP
 Command digests are only supported by version 1.8.7 or higher.
 .SS "Defaults"
```
```

--- a/doc/sudoers.mdoc.in	Tue Dec 29 13:38:14 2015 -0700
+++ b/doc/sudoers.mdoc.in	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 .\"
-.\" Copyright (c) 1994-1996, 1998-2005, 2007-2015
+.\" Copyright (c) 1994-1996, 1998-2005, 2007-2016
 .\"	Todd C. Miller <Todd.Miller@courtesan.com>
 .\"
 .\" Permission to use, copy, modify, and distribute this software for any
@@ -19,7 +19,7 @@
 .\" Agency (DARPA) and Air Force Research Laboratory, Air Force
 .\" Materiel Command, USAF, under agreement number F39502-99-1-0512.
 .\"
-.Dd December 11, 2015
+.Dd January 4, 2015
 .Dt SUDOERS @mansectform@
 .Os Sudo @PACKAGE_VERSION@
 .Sh NAME
@@ -831,12 +831,14 @@
 EYGH2oNk1JC0p9679IMATo8+BT7JVDCd4sQaJQ==
 .Ed
 .Pp
-If the user has write access to either the command itself or the
-directory in which the command is located (directly or via a
+Warning, if the user has write access to the command itself (directly or via a
 .Nm sudo
-command) it may be possible for the user to replace the command
-after the digest check has been performed but before the command
-is executed.
+command), it may be possible for the user to replace the command after the
+digest check has been performed but before the command is executed.
+A similar race condition exists on systems that lack the
+.Xr fexecve 2
+system call when the directory in which the command is located
+is writable by the user.
 .Pp
 Command digests are only supported by version 1.8.7 or higher.
 .Ss Defaults
```
```

--- a/include/sudo_plugin.h	Tue Dec 29 13:38:14 2015 -0700
+++ b/include/sudo_plugin.h	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -19,7 +19,7 @@

 /* API version major/minor */
 #define SUDO_API_VERSION_MAJOR 1
-#define SUDO_API_VERSION_MINOR 8
+#define SUDO_API_VERSION_MINOR 9
 #define SUDO_API_MKVERSION(x, y) (((x) << 16) | (y))
 #define SUDO_API_VERSION SUDO_API_MKVERSION(SUDO_API_VERSION_MAJOR, SUDO_API_VERSION_MINOR)

```
```

--- a/plugins/sudoers/match.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/plugins/sudoers/match.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 1996, 1998-2005, 2007-2015
+ * Copyright (c) 1996, 1998-2005, 2007-2016
  *	Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
@@ -55,6 +55,7 @@
 # include <netdb.h>
 #endif /* HAVE_NETGROUP_H */
 #include <dirent.h>
+#include <fcntl.h>
 #include <pwd.h>
 #include <grp.h>
 #include <errno.h>
@@ -583,17 +584,18 @@
 };

 static bool
-digest_matches(const char *file, const struct sudo_digest *sd)
+digest_matches(const char *file, const struct sudo_digest *sd, int *fd)
 {
     unsigned char file_digest[SHA512_DIGEST_LENGTH];
     unsigned char sudoers_digest[SHA512_DIGEST_LENGTH];
     unsigned char buf[32 * 1024];
     struct digest_function *func = NULL;
+    bool first = true;
+    bool is_script = false;
     size_t nread;
     SHA2_CTX ctx;
     FILE *fp;
     unsigned int i;
-    int h;
     debug_decl(digest_matches, SUDOERS_DEBUG_MATCH)

     for (i = 0; digest_functions[i].digest_name != NULL; i++) {
@@ -609,7 +611,7 @@
     if (strlen(sd->digest_str) == func->digest_len * 2) {
 	/* Convert the command digest from ascii hex to binary. */
 	for (i = 0; i < func->digest_len; i++) {
-	    h = hexchar(&sd->digest_str[i + i]);
+	    const int h = hexchar(&sd->digest_str[i + i]);
 	    if (h == -1)
 		goto bad_format;
 	    sudoers_digest[i] = (unsigned char)h;
@@ -633,6 +635,12 @@

     func->init(&ctx);
     while ((nread = fread(buf, 1, sizeof(buf), fp)) != 0) {
+	/* Check for #! cookie and set is_script. */
+	if (first) {
+	    first = false;
+	    if (nread >= 2 && buf[0] == '#' && buf[1] == '!')
+		is_script = true;
+	}
 	func->update(&ctx, buf, nread);
     }
     if (ferror(fp)) {
@@ -640,15 +648,36 @@
 	fclose(fp);
 	debug_return_bool(false);
     }
-    fclose(fp);
     func->final(file_digest, &ctx);

-    if (memcmp(file_digest, sudoers_digest, func->digest_len) == 0)
-	debug_return_bool(true);
-    sudo_debug_printf(SUDO_DEBUG_DIAG|SUDO_DEBUG_LINENO,
-	"%s digest mismatch for %s, expecting %s",
-	func->digest_name, file, sd->digest_str);
-    debug_return_bool(false);
+    if (memcmp(file_digest, sudoers_digest, func->digest_len) != 0) {
+	fclose(fp);
+	sudo_debug_printf(SUDO_DEBUG_DIAG|SUDO_DEBUG_LINENO,
+	    "%s digest mismatch for %s, expecting %s",
+	    func->digest_name, file, sd->digest_str);
+	debug_return_bool(false);
+    }
+
+#ifdef HAVE_FEXECVE
+    /*
+     * On systems with fexecve(2) we can use that to execute the
+     * matching command even when the directory is writable.
+     */
+    if ((*fd = dup(fileno(fp))) == -1) {
+	sudo_debug_printf(SUDO_DEBUG_INFO, "unable to dup %s: %s",
+	    file, strerror(errno));
+	fclose(fp);
+	debug_return_bool(false);
+    }
+    /*
+     * Shell scripts go through namei twice and so we can't set the close
+     * on exec flag on the fd for fexecve(2).
+     */
+    if (!is_script)
+	fcntl(*fd, F_SETFD, FD_CLOEXEC);
+#endif /* HAVE_FEXECVE */
+    fclose(fp);
+    debug_return_bool(true);
 bad_format:
     sudo_warnx(U_("digest for %s (%s) is not in %s form"), file,
 	sd->digest_str, func->digest_name);
@@ -690,7 +719,11 @@
 	debug_return_bool(false);
     if (!command_args_match(sudoers_cmnd, sudoers_args))
 	debug_return_bool(false);
-    if (digest != NULL && !digest_matches(sudoers_cmnd, digest)) {
+    if (cmnd_fd != -1) {
+	close(cmnd_fd);
+	cmnd_fd = -1;
+    }
+    if (digest != NULL && !digest_matches(sudoers_cmnd, digest, &cmnd_fd)) {
 	/* XXX - log functions not available but we should log very loudly */
 	debug_return_bool(false);
     }
```
```

--- a/plugins/sudoers/policy.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/plugins/sudoers/policy.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2010-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2010-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -377,6 +377,9 @@
     user_umask = umask(SUDO_UMASK);
     umask(user_umask);

+    /* Some systems support fexecve() which we use for digest matches. */
+    cmnd_fd = -1;
+
     /* Dump settings and user info (XXX - plugin args) */
     for (cur = info->settings; *cur != NULL; cur++)
 	sudo_debug_printf(SUDO_DEBUG_INFO, "settings: %s", *cur);
@@ -551,6 +554,16 @@
 	if (asprintf(&command_info[info_len++], "umask=0%o", (unsigned int)cmnd_umask) == -1)
 	    goto oom;
     }
+    if (cmnd_fd != -1) {
+	if (sudo_version < SUDO_API_MKVERSION(1, 9)) {
+	    /* execfd only supported by plugin API 1.9 and higher */
+	    close(cmnd_fd);
+	    cmnd_fd = -1;
+	} else {
+	    if (asprintf(&command_info[info_len++], "execfd=%d", cmnd_fd) == -1)
+		goto oom;
+	}
+    }
 #ifdef HAVE_LOGIN_CAP_H
     if (def_use_loginclass) {
 	if ((command_info[info_len++] = sudo_new_key_val("login_class", login_class)) == NULL)
```
```

--- a/plugins/sudoers/sudoers.h	Tue Dec 29 13:38:14 2015 -0700
+++ b/plugins/sudoers/sudoers.h	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 1993-1996, 1998-2005, 2007-2015
+ * Copyright (c) 1993-1996, 1998-2005, 2007-2016
  *	Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
@@ -90,6 +90,7 @@
     const char *cwd;
     char *iolog_file;
     GETGROUPS_T *gids;
+    int   execfd;
     int   ngids;
     int   closefrom;
     int   lines;
@@ -197,6 +198,7 @@
 #define user_srunhost		(sudo_user.srunhost)
 #define user_ccname		(sudo_user.krb5_ccname)
 #define safe_cmnd		(sudo_user.cmnd_safe)
+#define cmnd_fd			(sudo_user.execfd)
 #define login_class		(sudo_user.class_name)
 #define runas_pw		(sudo_user._runas_pw)
 #define runas_gr		(sudo_user._runas_gr)
```
```

--- a/src/exec.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/exec.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -176,13 +176,13 @@
 	}
 #ifdef HAVE_SELINUX
 	if (ISSET(details->flags, CD_RBAC_ENABLED)) {
-	    selinux_execve(details->command, details->argv, details->envp,
-		ISSET(details->flags, CD_NOEXEC));
+	    selinux_execve(details->execfd, details->command, details->argv,
+		details->envp, ISSET(details->flags, CD_NOEXEC));
 	} else
 #endif
 	{
-	    sudo_execve(details->command, details->argv, details->envp,
-		ISSET(details->flags, CD_NOEXEC));
+	    sudo_execve(details->execfd, details->command, details->argv,
+		details->envp, ISSET(details->flags, CD_NOEXEC));
 	}
     }
     cstat->type = CMD_ERRNO;
```
```

--- a/src/exec_common.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/exec_common.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -179,14 +179,19 @@
  * ala execvp(3) if we get ENOEXEC.
  */
 int
-sudo_execve(const char *path, char *const argv[], char *envp[], bool noexec)
+sudo_execve(int fd, const char *path, char *const argv[], char *envp[], bool noexec)
 {
     /* Modify the environment as needed to disable further execve(). */
     if (noexec)
 	envp = disable_execute(envp);

-    execve(path, argv, envp);
-    if (errno == ENOEXEC) {
+#ifdef HAVE_FEXECVE
+    if (fd != -1)
+	    fexecve(fd, argv, envp);
+    else
+#endif
+	    execve(path, argv, envp);
+    if (fd == -1 && errno == ENOEXEC) {
 	int argc;
 	char **nargv;

```
```

--- a/src/selinux.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/selinux.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  * Copyright (c) 2008 Dan Walsh <dwalsh@redhat.com>
  *
  * Borrowed heavily from newrole source code
@@ -373,7 +373,7 @@
 }

 void
-selinux_execve(const char *path, char *const argv[], char *const envp[],
+selinux_execve(int fd, const char *path, char *const argv[], char *envp[],
     bool noexec)
 {
     char **nargv;
@@ -409,6 +409,8 @@
      */
     for (argc = 0; argv[argc] != NULL; argc++)
 	continue;
+    if (fd != -1)
+	argc++;
     nargv = reallocarray(NULL, argc + 2, sizeof(char *));
     if (nargv == NULL) {
 	sudo_warnx(U_("%s: %s"), __func__, U_("unable to allocate memory"));
@@ -418,11 +420,16 @@
 	nargv[0] = *argv[0] == '-' ? "-sesh-noexec" : "sesh-noexec";
     else
 	nargv[0] = *argv[0] == '-' ? "-sesh" : "sesh";
-    nargv[1] = (char *)path;
-    memcpy(&nargv[2], &argv[1], argc * sizeof(char *)); /* copies NULL */
+    argc = 1;
+    if (fd != -1 && asprintf(&nargv[argc++], "--execfd=%d", fd) == -1) {
+	sudo_warnx(U_("%s: %s"), __func__, U_("unable to allocate memory"));
+	debug_return;
+    }
+    nargv[argc] = (char *)path;
+    memcpy(&nargv[argc + 1], &argv[argc], argc * sizeof(char *)); /* copies NULL */

     /* sesh will handle noexec for us. */
-    sudo_execve(sesh, nargv, envp, false);
+    sudo_execve(-1, sesh, nargv, envp, false);
     serrno = errno;
     free(nargv);
     errno = serrno;
```
```

--- a/src/sesh.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/sesh.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2008, 2010-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2008, 2010-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -87,6 +87,7 @@
     } else {
 	bool login_shell, noexec = false;
 	char *cp, *cmnd;
+	int fd = -1;

 	/* If the first char of argv[0] is '-', we are running a login shell. */
 	login_shell = argv[0][0] == '-';
@@ -95,6 +96,18 @@
 	if ((cp = strrchr(argv[0], '-')) != NULL && cp != argv[0])
 	    noexec = strcmp(cp, "-noexec") == 0;

+	/* If argv[1] is --execfd=%d, extract the fd to exec with. */
+	if (strncmp(argv[1], "--execfd=", 9) == 0) {
+	    const char *errstr;
+
+	    cp = argv[1] + 9;
+	    fd = strtonum(cp, 0, INT_MAX, &errstr);
+	    if (errstr != NULL)
+		sudo_fatalx(U_("invalid file descriptor number: %s"), cp);
+	    argv++;
+	    argc--;
+	}
+
 	/* Shift argv and make a copy of the command to execute. */
 	argv++;
 	argc--;
@@ -108,7 +121,7 @@
 	    *cp = '-';
 	    argv[0] = cp;
 	}
-	sudo_execve(cmnd, argv, envp, noexec);
+	sudo_execve(fd, cmnd, argv, envp, noexec);
 	sudo_warn(U_("unable to execute %s"), cmnd);
 	ret = SESH_ERR_FAILURE;
     }
```
```

--- a/src/sudo.c	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/sudo.c	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2009-2015 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2009-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -585,6 +585,7 @@

     memset(details, 0, sizeof(*details));
     details->closefrom = -1;
+    details->execfd = -1;
     TAILQ_INIT(&details->preserved_fds);

 #define SET_STRING(s, n) \
@@ -615,6 +616,21 @@
 			SET(details->flags, CD_EXEC_BG);
 		    break;
 		}
+		if (strncmp("execfd=", info[i], sizeof("execfd=") - 1) == 0) {
+		    cp = info[i] + sizeof("execfd=") - 1;
+		    details->execfd = strtonum(cp, 0, INT_MAX, &errstr);
+		    if (errstr != NULL)
+			sudo_fatalx(U_("%s: %s"), info[i], U_(errstr));
+#ifdef HAVE_FEXECVE
+		    /* Must keep fd open during exec. */
+		    add_preserved_fd(&details->preserved_fds, details->execfd);
+#else
+		    /* Plugin thinks we support fexecve() but we don't. */
+		    fcntl(details->execfd, F_SETFD, FD_CLOEXEC);
+		    details->execfd = -1;
+#endif
+		    break;
+		}
 		break;
 	    case 'l':
 		SET_STRING("login_class=", login_class)
```
```

--- a/src/sudo.h	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/sudo.h	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 1993-1996, 1998-2005, 2007-2014
+ * Copyright (c) 1993-1996, 1998-2005, 2007-2016
  *	Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
@@ -149,6 +149,7 @@
     int ngroups;
     int closefrom;
     int flags;
+    int execfd;
     struct preserved_fd_list preserved_fds;
     struct passwd *pw;
     GETGROUPS_T *groups;
@@ -221,8 +222,8 @@
 int selinux_restore_tty(void);
 int selinux_setup(const char *role, const char *type, const char *ttyn,
     int ttyfd);
-void selinux_execve(const char *path, char *const argv[], char *const envp[],
-    bool noexec);
+void selinux_execve(int fd, const char *path, char *const argv[],
+    char *envp[], bool noexec);

 /* solaris.c */
 void set_project(struct passwd *);
```
```

--- a/src/sudo_exec.h	Tue Dec 29 13:38:14 2015 -0700
+++ b/src/sudo_exec.h	Mon Jan 04 10:35:18 2016 -0700
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2010-2013 Todd C. Miller <Todd.Miller@courtesan.com>
+ * Copyright (c) 2010-2016 Todd C. Miller <Todd.Miller@courtesan.com>
  *
  * Permission to use, copy, modify, and distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
@@ -74,7 +74,7 @@

 /* exec.c */
 struct sudo_event_base;
-int sudo_execve(const char *path, char *const argv[], char *envp[], bool noexec);
+int sudo_execve(int fd, const char *path, char *const argv[], char *envp[], bool noexec);
 extern volatile pid_t cmnd_pid;

 /* exec_pty.c */
```



=== Content from www.openwall.com_898173f0_20250125_092017.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](21) [[next>]](23) [[<thread-prev]](../../../2015/11/10/12) [[thread-next>]](../../../2015/12/01/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <20151118155903.69F3E332396@smtpvbsrv1.mitre.org>
Date: Wed, 18 Nov 2015 10:59:03 -0500 (EST)
From: cve-assign@...re.org
To: amilburn@...l.org
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com, Todd.Miller@...rtesan.com
Subject: Re: race condition checking digests/checksums in sudoers

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

>> <http://www.sudo.ws/man/1.8.15/sudoers.man.html>

>> If a command name is prefixed with a Digest_Spec, the command will
>> only match successfully if it can be verified using the specified
>> SHA-2 digest. This may be useful in situations where the user invoking
>> sudo has write access to the command or its parent directory.

> This results in a race condition if the digest functionality is used
> as suggested (in fact, the rules are matched before the user is
> prompted for a password, so you have quite some time to replace the
> binary from underneath sudo).

Use CVE-2015-8239.

- --
CVE assignment team, MITRE CVE Numbering Authority
M/S M300
202 Burlington Road, Bedford, MA 01730 USA
[ PGP key available through <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQIcBAEBCAAGBQJWTJ/cAAoJEL54rhJi8gl5Ej8QALlEI/5YbcrblU789Kk+Xk/R
zpoF0hgkKfkN4nKIjYDDz/BVQCa7glsZh2tRdcS6HAChsKhEzHc3cFfkZbw4p1nF
ftNANRAMZRnnkyh4IfZdVdgWlW+UFWJ5nEFqGTwMmcaSTDmD7AonAkbak/mxJKCH
gewR9Lv6+Gt2urw32OMUxTtFBtQM7suIpI5Cs0nvyEg4VXxIqiiIS7uZa1RqFQPv
XI2u22+eD3kNewTpif9VzlkDM1tehkjZWhKcIOswwbIyCDOKCj2DlzvPRCx/90DX
owanq/ZNpPt8Uw8xN4VtoN/7SFZcaqekONbRCcqYQu+aSzZc8k8XEYLZjxLaAeKG
jHMpxDhPj2DInZzel2gyCPG+bkqpzHuNvUmTebJPU+8GLCDnq7RjCZ9UvvOT0BXT
JTRd72wEWXxHa3Gxc7fwS1rincgg4Cw18tDguZMYG2y/LvNLsm9UP0aeZVhCnP0N
7ich7V8ZrgiyDupPqEGMAupE/c9bC+o90/nKzoSDliuj+mRAjmVuA5ZpVRBo6i69
qiJxlwep7PFgVE1FmG7AsQACXq7cd6e8wsb2xxF/b2eNnwEp2QGVmOkDs5WUB7wU
3OXLJVppMPWwX2Y9Wpf4imGUV+4oKRczo2CDu58+muMf95ng5yosPIKKIhd3MqKY
HJN2Edk+lRA5O8oPxvf4
=l+r1
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from bugzilla.redhat.com_8d8f4d2f_20250125_092018.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1283635)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1283635)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1283635)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1283635

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1283635**](show_bug.cgi?id=1283635)
(CVE-2015-8239)
- [CVE-2015-8239](https://access.redhat.com/security/cve/CVE-2015-8239) sudo: Race condition when checking digests in sudoers

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2015-8239 sudo: Race condition when checking digests in sudoers

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED WONTFIX | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2015-8239 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1283636](show_bug.cgi?id=1283636 "CLOSED ERRATA - CVE-2015-8239 sudo: Race condition when checking digests in sudoers [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1283688](show_bug.cgi?id=1283688) | | TreeView+ | [depends on](buglist.cgi?bug_id=1283635&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1283635&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2015-11-19 13:36 UTC by Adam Mariš | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-02-17 04:42 UTC ([History](show_activity.cgi?id=1283635)) | | [CC List:](page.cgi?id=fields.html#cclist) | 6 users (show)  carnil dkopecek kzak pkis rsroka slawomir | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: |  | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2016-01-19 13:14:56 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1283635#c0)  Adam Mariš    2015-11-19 13:36:46 UTC  ``` A vulnerability in functionality for adding support of SHA-2 digests along with the command was found. The sudoers plugin performs this digest verification while matching rules, and later independently calls execve() to execute the binary. This results in a race condition if the digest functionality is used as suggested (in fact, the rules are matched before the user is prompted for a password, so there is not negligible time frame to replace the binary from underneath sudo). Versions affected are since 1.8.7.  CVE assignment:  <http://seclists.org/oss-sec/2015/q4/327>   ```  [Comment 1](show_bug.cgi?id=1283635#c1)  Adam Mariš    2015-11-19 13:37:25 UTC  ```  Created sudo tracking bugs for this issue:  Affects: fedora-all [[bug 1283636](show_bug.cgi?id=1283636 "CLOSED ERRATA - CVE-2015-8239 sudo: Race condition when checking digests in sudoers [fedora-all]")]   ```  [Comment 3](show_bug.cgi?id=1283635#c3)  Daniel Kopeček    2015-11-19 14:18:16 UTC  ``` (In reply to Adam Mariš from [comment #2](show_bug.cgi?id=1283635#c2)) > Statement: >  > Not vulnerable. This issue did not affect the versions of sudo as > shipped with Red Hat Enterprise Linux 5, 6 and 7.  Not vulnerable in RHEL 7? What about this one:  [https://bugzilla.redhat.com/show_bug.cgi?id=1183818](show_bug.cgi?id=1183818)   ```  [Comment 4](show_bug.cgi?id=1283635#c4)  Adam Mariš    2015-11-19 15:01:40 UTC  ``` Thanks, I'll update it.   ```  [Comment 5](show_bug.cgi?id=1283635#c5)  Adam Mariš    2015-11-19 15:08:46 UTC  ``` Statement:  (none)   ```  [Comment 6](show_bug.cgi?id=1283635#c6)  Daniel Kopeček    2015-12-07 09:46:36 UTC  ``` sudo upstream updated the docs:  <https://www.sudo.ws/repos/sudo/rev/24a3d9215c64>   ```  [Comment 7](show_bug.cgi?id=1283635#c7)  Tomas Hoger    2016-01-19 13:04:34 UTC  ``` There are now additional changes applied upstream to make sudo use fexecve where available, so the program is executed using the same file descriptor that was used to read the file for checksumming purposes.  <https://www.sudo.ws/repos/sudo/rev/397722cdd7ec> <https://www.sudo.ws/repos/sudo/rev/0cd3cc8fa195>  Note that fexecve documentation explicitly notes that fexecve can only help when file to be executed is in a user writeable directory, but not when the file is also user writeable.    The idea behind fexecve() is to allow the caller to verify (checksum) the   contents of an executable before executing it.  Simply opening the file,   checksumming the contents, and then doing an execve(2) would not suffice,   since, between the two steps, the filename, or a directory prefix of the   pathname, could have been exchanged (by, for example, modifying the target   of a symbolic link).  fexecve() does not mitigate the problem that the   contents of a file could be changed between the checksumming and the call   to fexecve(); for that, the solution is to ensure that the permissions on   the file prevent it from being modified by malicious users.   ```  [Comment 8](show_bug.cgi?id=1283635#c8)  Tomas Hoger    2016-01-19 13:14:56 UTC  ``` This is most likely not going to get any "full" fix upstream other than documenting that it's unsafe to execute user writeable programs even if the digest check is performed.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1283635&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from www.sudo.ws_05dbc54f_20250125_092020.html ===

[![mercurial](/repos/sudo/static/hglogo.png)](https://mercurial-scm.org/)

* [log](/repos/sudo/shortlog/0cd3cc8fa195)
* [graph](/repos/sudo/graph/0cd3cc8fa195)
* [tags](/repos/sudo/tags)
* [bookmarks](/repos/sudo/bookmarks)
* [branches](/repos/sudo/branches)

* changeset
* [raw](/repos/sudo/raw-rev/0cd3cc8fa195)
* [browse](/repos/sudo/file/0cd3cc8fa195)

* [help](/repos/sudo/help)

## [Mercurial](/) > [repos](/repos) > [sudo](/repos/sudo)

### changeset 10301:[0cd3cc8fa195](/repos/sudo/rev/0cd3cc8fa195)

Find changesets by keywords (author, files, the commit message), revision
number or hash, or [revset expression](/repos/sudo/help/revsets).

Silence warning in digest\_matches() on systems with no fexecve(2).

| author | Todd C. Miller <Todd.Miller@courtesan.com> |
| --- | --- |
| date | Mon, 11 Jan 2016 16:55:52 -0700 |
| parents | [4d2c1761c752](/repos/sudo/rev/4d2c1761c752) |
| children | [e1abfdc82242](/repos/sudo/rev/e1abfdc82242) |
| files | [plugins/sudoers/match.c](/repos/sudo/file/0cd3cc8fa195/plugins/sudoers/match.c) |
| diffstat | 1 files changed, 4 insertions(+), 0 deletions(-) [+] [-]  | [plugins/sudoers/match.c](#l1.1) | 4 |  | | --- | --- | --- | |

line wrap: on
 line diff
```

--- a/plugins/sudoers/match.c	Mon Jan 11 16:52:52 2016 -0700
+++ b/plugins/sudoers/match.c	Mon Jan 11 16:55:52 2016 -0700
@@ -590,8 +590,10 @@
     unsigned char sudoers_digest[SHA512_DIGEST_LENGTH];
     unsigned char buf[32 * 1024];
     struct digest_function *func = NULL;
+#ifdef HAVE_FEXECVE
     bool first = true;
     bool is_script = false;
+#endif /* HAVE_FEXECVE */
     size_t nread;
     SHA2_CTX ctx;
     FILE *fp;
@@ -635,12 +637,14 @@

     func->init(&ctx);
     while ((nread = fread(buf, 1, sizeof(buf), fp)) != 0) {
+#ifdef HAVE_FEXECVE
 	/* Check for #! cookie and set is_script. */
 	if (first) {
 	    first = false;
 	    if (nread >= 2 && buf[0] == '#' && buf[1] == '!')
 		is_script = true;
 	}
+#endif /* HAVE_FEXECVE */
 	func->update(&ctx, buf, nread);
     }
     if (ferror(fp)) {
```



=== Content from www.sudo.ws_1b2912f5_20250125_092021.html ===

[![mercurial](/repos/sudo/static/hglogo.png)](https://mercurial-scm.org/)

* [log](/repos/sudo/shortlog/24a3d9215c64)
* [graph](/repos/sudo/graph/24a3d9215c64)
* [tags](/repos/sudo/tags)
* [bookmarks](/repos/sudo/bookmarks)
* [branches](/repos/sudo/branches)

* changeset
* [raw](/repos/sudo/raw-rev/24a3d9215c64)
* [browse](/repos/sudo/file/24a3d9215c64)

* [help](/repos/sudo/help)

## [Mercurial](/) > [repos](/repos) > [sudo](/repos/sudo)

### changeset 10278:[24a3d9215c64](/repos/sudo/rev/24a3d9215c64)

Find changesets by keywords (author, files, the commit message), revision
number or hash, or [revset expression](/repos/sudo/help/revsets).

Document the race condition between the digest check and command
execution.

| author | Todd C. Miller <Todd.Miller@courtesan.com> |
| --- | --- |
| date | Sun, 06 Dec 2015 15:34:53 -0700 |
| parents | [31004144421b](/repos/sudo/rev/31004144421b) |
| children | [dcc9d15b0f3c](/repos/sudo/rev/dcc9d15b0f3c) |
| files | [doc/sudoers.cat](/repos/sudo/file/24a3d9215c64/doc/sudoers.cat) [doc/sudoers.man.in](/repos/sudo/file/24a3d9215c64/doc/sudoers.man.in) [doc/sudoers.mdoc.in](/repos/sudo/file/24a3d9215c64/doc/sudoers.mdoc.in) |
| diffstat | 3 files changed, 24 insertions(+), 13 deletions(-) [+] [-]  | [doc/sudoers.cat](#l1.1) | 17 |  | | --- | --- | --- | | [doc/sudoers.man.in](#l2.1) | 10 |  | | [doc/sudoers.mdoc.in](#l3.1) | 10 |  | |

line wrap: on
 line diff
```

--- a/doc/sudoers.cat	Wed Dec 02 14:06:37 2015 -0700
+++ b/doc/sudoers.cat	Sun Dec 06 15:34:53 2015 -0700
@@ -392,13 +392,11 @@

      If a command name is prefixed with a Digest_Spec, the command will only
      match successfully if it can be verified using the specified SHA-2
-     digest.  This may be useful in situations where the user invoking ssuuddoo
-     has write access to the command or its parent directory.  The following
-     digest formats are supported: sha224, sha256, sha384 and sha512.  The
-     string may be specified in either hex or base64 format (base64 is more
-     compact).  There are several utilities capable of generating SHA-2
-     digests in hex format such as openssl, shasum, sha224sum, sha256sum,
-     sha384sum, sha512sum.
+     digest.  The following digest formats are supported: sha224, sha256,
+     sha384 and sha512.  The string may be specified in either hex or base64
+     format (base64 is more compact).  There are several utilities capable of
+     generating SHA-2 digests in hex format such as openssl, shasum,
+     sha224sum, sha256sum, sha384sum, sha512sum.

      For example, using openssl:

@@ -410,6 +408,11 @@
      $ openssl dgst -binary -sha224 /bin/ls | openssl base64
      EYGH2oNk1JC0p9679IMATo8+BT7JVDCd4sQaJQ==

+     If the user has write access to either the command itself or the
+     directory in which the command is located (directly or via a ssuuddoo
+     command) it may be possible for the user to replace the command after the
+     digest check has been performed but before the command is executed.
+
      Command digests are only supported by version 1.8.7 or higher.

    DDeeffaauullttss
```
```

--- a/doc/sudoers.man.in	Wed Dec 02 14:06:37 2015 -0700
+++ b/doc/sudoers.man.in	Sun Dec 06 15:34:53 2015 -0700
@@ -850,9 +850,6 @@
 \fRDigest_Spec\fR,
 the command will only match successfully if it can be verified
 using the specified SHA-2 digest.
-This may be useful in situations where the user invoking
-\fBsudo\fR
-has write access to the command or its parent directory.
 The following digest formats are supported: sha224, sha256, sha384 and sha512.
 The string may be specified in either hex or base64 format
 (base64 is more compact).
@@ -877,6 +874,13 @@
 .RE
 .fi
 .PP
+If the user has write access to either the command itself or the
+directory in which the command is located (directly or via a
+\fBsudo\fR
+command) it may be possible for the user to replace the command
+after the digest check has been performed but before the command
+is executed.
+.PP
 Command digests are only supported by version 1.8.7 or higher.
 .SS "Defaults"
 Certain configuration options may be changed from their default
```
```

--- a/doc/sudoers.mdoc.in	Wed Dec 02 14:06:37 2015 -0700
+++ b/doc/sudoers.mdoc.in	Sun Dec 06 15:34:53 2015 -0700
@@ -813,9 +813,6 @@
 .Li Digest_Spec ,
 the command will only match successfully if it can be verified
 using the specified SHA-2 digest.
-This may be useful in situations where the user invoking
-.Nm sudo
-has write access to the command or its parent directory.
 The following digest formats are supported: sha224, sha256, sha384 and sha512.
 The string may be specified in either hex or base64 format
 (base64 is more compact).
@@ -834,6 +831,13 @@
 EYGH2oNk1JC0p9679IMATo8+BT7JVDCd4sQaJQ==
 .Ed
 .Pp
+If the user has write access to either the command itself or the
+directory in which the command is located (directly or via a
+.Nm sudo
+command) it may be possible for the user to replace the command
+after the digest check has been performed but before the command
+is executed.
+.Pp
 Command digests are only supported by version 1.8.7 or higher.
 .Ss Defaults
 Certain configuration options may be changed from their default
```



=== Content from access.redhat.com_6e52db96_20250126_074523.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)


