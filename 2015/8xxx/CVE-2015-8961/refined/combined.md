=== Content from git.kernel.org_675c7033_20250124_202443.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=6934da9238da947628be83635e365df41064b09b)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6934da9238da947628be83635e365df41064b09b)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6934da9238da947628be83635e365df41064b09b)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6934da9238da947628be83635e365df41064b09b)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Czerner <lczerner@redhat.com> | 2015-10-17 22:57:06 -0400 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2015-10-17 22:57:06 -0400 |
| commit | [6934da9238da947628be83635e365df41064b09b](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6934da9238da947628be83635e365df41064b09b) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=6934da9238da947628be83635e365df41064b09b)) | |
| tree | [a7d5770b2fbd3961c40b6bb2da86873dcfab19c0](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6934da9238da947628be83635e365df41064b09b) | |
| parent | [33d14975e5ac469963d5d63856b61698ad0bff07](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=33d14975e5ac469963d5d63856b61698ad0bff07) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6934da9238da947628be83635e365df41064b09b&id2=33d14975e5ac469963d5d63856b61698ad0bff07)) | |
| download | [linux-6934da9238da947628be83635e365df41064b09b.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-6934da9238da947628be83635e365df41064b09b.tar.gz) | |

ext4: fix potential use after free in \_\_ext4\_journal\_stopThere is a use-after-free possibility in \_\_ext4\_journal\_stop() in the
case that we free the handle in the first jbd2\_journal\_stop() because
we're referencing handle->h\_err afterwards. This was introduced in
9705acd63b125dee8b15c705216d7186daea4625 and it is wrong. Fix it by
storing the handle->h\_err value beforehand and avoid referencing
potentially freed handle.
Fixes: 9705acd63b125dee8b15c705216d7186daea4625
Signed-off-by: Lukas Czerner <lczerner@redhat.com>
Reviewed-by: Andreas Dilger <adilger@dilger.ca>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6934da9238da947628be83635e365df41064b09b)

| -rw-r--r-- | [fs/ext4/ext4\_jbd2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/ext4_jbd2.c?id=6934da9238da947628be83635e365df41064b09b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/fs/ext4/ext4\_jbd2.c b/fs/ext4/ext4\_jbd2.cindex d4184318181878..e770c1ee4613ed 100644--- a/[fs/ext4/ext4\_jbd2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/ext4_jbd2.c?id=33d14975e5ac469963d5d63856b61698ad0bff07)+++ b/[fs/ext4/ext4\_jbd2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/ext4_jbd2.c?id=6934da9238da947628be83635e365df41064b09b)@@ -88,13 +88,13 @@ int \_\_ext4\_journal\_stop(const char \*where, unsigned int line, handle\_t \*handle) return 0; } + err = handle->h\_err; if (!handle->h\_transaction) {- err = jbd2\_journal\_stop(handle);- return handle->h\_err ? handle->h\_err : err;+ rc = jbd2\_journal\_stop(handle);+ return err ? err : rc; }  sb = handle->h\_transaction->t\_journal->j\_private;- err = handle->h\_err; rc = jbd2\_journal\_stop(handle);  if (!err) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-24 20:23:20 +0000



=== Content from github.com_3ae0c999_20250124_202446.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F6934da9238da947628be83635e365df41064b09b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F6934da9238da947628be83635e365df41064b09b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/6934da9238da947628be83635e365df41064b09b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ext4: fix potential use after free in \_\_ext4\_journal\_stop

[Browse files](/torvalds/linux/tree/6934da9238da947628be83635e365df41064b09b)
Browse the repository at this point in the history

```
There is a use-after-free possibility in __ext4_journal_stop() in the
case that we free the handle in the first jbd2_journal_stop() because
we're referencing handle->h_err afterwards. This was introduced in
[9705acd](https://github.com/torvalds/linux/commit/9705acd63b125dee8b15c705216d7186daea4625) and it is wrong. Fix it by
storing the handle->h_err value beforehand and avoid referencing
potentially freed handle.

Fixes: [9705acd](https://github.com/torvalds/linux/commit/9705acd63b125dee8b15c705216d7186daea4625)
Signed-off-by: Lukas Czerner <lczerner@redhat.com>
Reviewed-by: Andreas Dilger <adilger@dilger.ca>
Cc: stable@vger.kernel.org
```

* Loading branch information

[![@tytso](https://avatars.githubusercontent.com/u/51416?s=40&v=4)](/tytso)

Lukas Czerner
authored and
[tytso](/torvalds/linux/commits?author=tytso "View all commits by tytso")
committed
Oct 18, 2015

1 parent
[33d1497](/torvalds/linux/commit/33d14975e5ac469963d5d63856b61698ad0bff07)

commit 6934da9

Showing
**1 changed file**
with
**3 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[fs/ext4/ext4\_jbd2.c](#diff-819723b40805291d46a5383e8a87025dcb345db81ff9ea73f03576ce49f1a308 "fs/ext4/ext4_jbd2.c")

Show comments

[View file](/torvalds/linux/blob/6934da9238da947628be83635e365df41064b09b/fs/ext4/ext4_jbd2.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -88,13 +88,13 @@ int \_\_ext4\_journal\_stop(const char \*where, unsigned int line, handle\_t \*handle) |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | err = handle->h\_err; |
|  |  | if (!handle->h\_transaction) { |
|  |  | err = jbd2\_journal\_stop(handle); |
|  |  | return handle->h\_err ? handle->h\_err : err; |
|  |  | rc = jbd2\_journal\_stop(handle); |
|  |  | return err ? err : rc; |
|  |  | } |
|  |  |  |
|  |  | sb = handle->h\_transaction->t\_journal->j\_private; |
|  |  | err = handle->h\_err; |
|  |  | rc = jbd2\_journal\_stop(handle); |
|  |  |  |
|  |  | if (!err) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6934da9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F6934da9238da947628be83635e365df41064b09b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.kernel.org_d4cf2c98_20250124_202445.html ===
commit 35483418917d63df90bae5b2d0b7b047d7ed8ec7
Author: Greg Kroah-Hartman
Date: Mon Dec 14 21:41:43 2015 -0800
Linux 4.3.3
commit e0aa614dc9ce697f51a0992507b36b3edbc7a641
Author: Filipe Manana
Date: Fri Oct 23 07:52:54 2015 +0100
Btrfs: fix regression running delayed references when using qgroups
commit b06c4bf5c874a57254b197f53ddf588e7a24a2bf upstream.
In the kernel 4.2 merge window we had a big changes to the implementation
of delayed references and qgroups which made the no\_quota field of delayed
references not used anymore. More specifically the no\_quota field is not
used anymore as of:
commit 0ed4792af0e8 ("btrfs: qgroup: Switch to new extent-oriented qgroup mechanism.")
Leaving the no\_quota field actually prevents delayed references from
getting merged, which in turn cause the following BUG\_ON(), at
fs/btrfs/extent-tree.c, to be hit when qgroups are enabled:
static int run\_delayed\_tree\_ref(...)
{
(...)
BUG\_ON(node->ref\_mod != 1);
(...)
}
This happens on a scenario like the following:
1) Ref1 bytenr X, action = BTRFS\_ADD\_DELAYED\_REF, no\_quota = 1, added.
2) Ref2 bytenr X, action = BTRFS\_DROP\_DELAYED\_REF, no\_quota = 0, added.
It's not merged with Ref1 because Ref1->no\_quota != Ref2->no\_quota.
3) Ref3 bytenr X, action = BTRFS\_ADD\_DELAYED\_REF, no\_quota = 1, added.
It's not merged with the reference at the tail of the list of refs
for bytenr X because the reference at the tail, Ref2 is incompatible
due to Ref2->no\_quota != Ref3->no\_quota.
4) Ref4 bytenr X, action = BTRFS\_DROP\_DELAYED\_REF, no\_quota = 0, added.
It's not merged with the reference at the tail of the list of refs
for bytenr X because the reference at the tail, Ref3 is incompatible
due to Ref3->no\_quota != Ref4->no\_quota.
5) We run delayed references, trigger merging of delayed references,
through \_\_btrfs\_run\_delayed\_refs() -> btrfs\_merge\_delayed\_refs().
6) Ref1 and Ref3 are merged as Ref1->no\_quota = Ref3->no\_quota and
all other conditions are satisfied too. So Ref1 gets a ref\_mod
value of 2.
7) Ref2 and Ref4 are merged as Ref2->no\_quota = Ref4->no\_quota and
all other conditions are satisfied too. So Ref2 gets a ref\_mod
value of 2.
8) Ref1 and Ref2 aren't merged, because they have different values
for their no\_quota field.
9) Delayed reference Ref1 is picked for running (select\_delayed\_ref()
always prefers references with an action == BTRFS\_ADD\_DELAYED\_REF).
So run\_delayed\_tree\_ref() is called for Ref1 which triggers the
BUG\_ON because Ref1->red\_mod != 1 (equals 2).
So fix this by removing the no\_quota field, as it's not used anymore as
of commit 0ed4792af0e8 ("btrfs: qgroup: Switch to new extent-oriented
qgroup mechanism.").
The use of no\_quota was also buggy in at least two places:
1) At delayed-refs.c:btrfs\_add\_delayed\_tree\_ref() - we were setting
no\_quota to 0 instead of 1 when the following condition was true:
is\_fstree(ref\_root) || !fs\_info->quota\_enabled
2) At extent-tree.c:\_\_btrfs\_inc\_extent\_ref() - we were attempting to
reset a node's no\_quota when the condition "!is\_fstree(root\_objectid)
|| !root->fs\_info->quota\_enabled" was true but we did it only in
an unused local stack variable, that is, we never reset the no\_quota
value in the node itself.
This fixes the remainder of problems several people have been having when
running delayed references, mostly while a balance is running in parallel,
on a 4.2+ kernel.
Very special thanks to Stéphane Lesimple for helping debugging this issue
and testing this fix on his multi terabyte filesystem (which took more
than one day to balance alone, plus fsck, etc).
Also, this fixes deadlock issue when using the clone ioctl with qgroups
enabled, as reported by Elias Probst in the mailing list. The deadlock
happens because after calling btrfs\_insert\_empty\_item we have our path
holding a write lock on a leaf of the fs/subvol tree and then before
releasing the path we called check\_ref() which did backref walking, when
qgroups are enabled, and tried to read lock the same leaf. The trace for
this case is the following:
INFO: task systemd-nspawn:6095 blocked for more than 120 seconds.
(...)
Call Trace:
[] schedule+0x74/0x83
[] btrfs\_tree\_read\_lock+0xc0/0xea
[] ? wait\_woken+0x74/0x74
[] btrfs\_search\_old\_slot+0x51a/0x810
[] btrfs\_next\_old\_leaf+0xdf/0x3ce
[] ? ulist\_add\_merge+0x1b/0x127
[] \_\_resolve\_indirect\_refs+0x62a/0x667
[] ? btrfs\_clear\_lock\_blocking\_rw+0x78/0xbe
[] find\_parent\_nodes+0xaf3/0xfc6
[] \_\_btrfs\_find\_all\_roots+0x92/0xf0
[] btrfs\_find\_all\_roots+0x45/0x65
[] ? btrfs\_get\_tree\_mod\_seq+0x2b/0x88
[] check\_ref+0x64/0xc4
[] btrfs\_clone+0x66e/0xb5d
[] btrfs\_ioctl\_clone+0x48f/0x5bb
[] ? native\_sched\_clock+0x28/0x77
[] btrfs\_ioctl+0xabc/0x25cb
(...)
The problem goes away by eleminating check\_ref(), which no longer is
needed as its purpose was to get a value for the no\_quota field of
a delayed reference (this patch removes the no\_quota field as mentioned
earlier).
Reported-by: Stéphane Lesimple
Tested-by: Stéphane Lesimple
Reported-by: Elias Probst
Reported-by: Peter Becker
Reported-by: Malte Schröder
Reported-by: Derek Dongray
Reported-by: Erkki Seppala
Cc: stable@vger.kernel.org # 4.2+
Signed-off-by: Filipe Manana
Reviewed-by: Qu Wenruo
commit 4f2347e64803932bc354a12830e3cd10d86e5b49
Author: Hans Verkuil
Date: Mon Sep 21 08:42:04 2015 -0300
cobalt: fix Kconfig dependency
commit fc88dd16a0e430f57458e6bd9b62a631c6ea53a1 upstream.
The cobalt driver should depend on VIDEO\_V4L2\_SUBDEV\_API.
This fixes this kbuild error:
tree: https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git master
head: 99bc7215bc60f6cd414cf1b85cd9d52cc596cccb
commit: 85756a069c55e0315ac5990806899cfb607b987f [media] cobalt: add new driver
config: x86\_64-randconfig-s0-09201514 (attached as .config)
reproduce:
git checkout 85756a069c55e0315ac5990806899cfb607b987f
# save the attached .config to linux build tree
make ARCH=x86\_64
All error/warnings (new ones prefixed by >>):
drivers/media/i2c/adv7604.c: In function 'adv76xx\_get\_format':
>> drivers/media/i2c/adv7604.c:1853:9: error: implicit declaration of function 'v4l2\_subdev\_get\_try\_format' [-Werror=implicit-function-declaration]
fmt = v4l2\_subdev\_get\_try\_format(sd, cfg, format->pad);
^
drivers/media/i2c/adv7604.c:1853:7: warning: assignment makes pointer from integer without a cast [-Wint-conversion]
fmt = v4l2\_subdev\_get\_try\_format(sd, cfg, format->pad);
^
drivers/media/i2c/adv7604.c: In function 'adv76xx\_set\_format':
drivers/media/i2c/adv7604.c:1882:7: warning: assignment makes pointer from integer without a cast [-Wint-conversion]
fmt = v4l2\_subdev\_get\_try\_format(sd, cfg, format->pad);
^
cc1: some warnings being treated as errors
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit de48652f0e6acd07b4fa0e58a5e76f43477f8e2a
Author: Lu, Han
Date: Wed Nov 11 16:54:27 2015 +0800
ALSA: hda/hdmi - apply Skylake fix-ups to Broxton display codec
commit e2656412f2a7343ecfd13eb74bac0a6e6e9c5aad upstream.
Broxton and Skylake have the same behavior on display audio. So this patch
applys Skylake fix-ups to Broxton.
Signed-off-by: Lu, Han
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 4ba2bd2c4729caaf6702c5426ffb7c65b9b1405d
Author: Dan Williams
Date: Thu Nov 12 12:13:57 2015 -0800
ALSA: pci: depend on ZONE\_DMA
commit 2db1a57986d37653583e67ccbf13082aadc8f25d upstream.
There are several sound drivers that 'select ZONE\_DMA'. This is
backwards as ZONE\_DMA is an architecture capability exported to drivers.
Switch the polarity of the dependency to disable these drivers when the
architecture does not support ZONE\_DMA. This was discovered in the
context of testing/enabling devm\_memremap\_pages() which depends on
ZONE\_DEVICE. ZONE\_DEVICE in turn depends on !ZONE\_DMA.
Reported-by: Jeff Moyer
Signed-off-by: Dan Williams
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 4bf8855ea964d7faa5dece0a3dd032d47f4b9a42
Author: Arnd Bergmann
Date: Wed Sep 30 15:04:42 2015 +0200
ceph: fix message length computation
commit 777d738a5e58ba3b6f3932ab1543ce93703f4873 upstream.
create\_request\_message() computes the maximum length of a message,
but uses the wrong type for the time stamp: sizeof(struct timespec)
may be 8 or 16 depending on the architecture, while sizeof(struct
ceph\_timespec) is always 8, and that is what gets put into the
message.
Found while auditing the uses of timespec for y2038 problems.
Fixes: b8e69066d8af ("ceph: include time stamp in every MDS request")
Signed-off-by: Arnd Bergmann
Signed-off-by: Yan, Zheng
Signed-off-by: Greg Kroah-Hartman
commit 278b54df14299e1cfbe6175e2a098bf0b6616611
Author: Ming Lei
Date: Tue Nov 24 10:35:29 2015 +0800
block: fix segment split
commit 578270bfbd2803dc7b0b03fbc2ac119efbc73195 upstream.
Inside blk\_bio\_segment\_split(), previous bvec pointer(bvprvp)
always points to the iterator local variable, which is obviously
wrong, so fix it by pointing to the local variable of 'bvprv'.
Fixes: 5014c311baa2b(block: fix bogus compiler warnings in blk-merge.c)
Reported-by: Michael Ellerman
Reported-by: Mark Salter
Tested-by: Laurent Dufour
Tested-by: Mark Salter
Signed-off-by: Ming Lei
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit eeec50cb5826af4c70564ed49d88626439598327
Author: Junxiao Bi
Date: Fri Nov 20 15:57:30 2015 -0800
ocfs2: fix umask ignored issue
commit 8f1eb48758aacf6c1ffce18179295adbf3bd7640 upstream.
New created file's mode is not masked with umask, and this makes umask not
work for ocfs2 volume.
Fixes: 702e5bc ("ocfs2: use generic posix ACL infrastructure")
Signed-off-by: Junxiao Bi
Cc: Gang He
Cc: Mark Fasheh
Cc: Joel Becker
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3994c2dee338ddc51adc2426d1208b41f04d15eb
Author: Jeff Layton
Date: Wed Nov 25 13:50:11 2015 -0500
nfs: if we have no valid attrs, then don't declare the attribute cache valid
commit c812012f9ca7cf89c9e1a1cd512e6c3b5be04b85 upstream.
If we pass in an empty nfs\_fattr struct to nfs\_update\_inode, it will
(correctly) not update any of the attributes, but it then clears the
NFS\_INO\_INVALID\_ATTR flag, which indicates that the attributes are
up to date. Don't clear the flag if the fattr struct has no valid
attrs to apply.
Reviewed-by: Steve French
Signed-off-by: Jeff Layton
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 4ffcc6f992ca1bef2e710ebe2fde80ced92ec263
Author: Jeff Layton
Date: Wed Nov 25 13:43:14 2015 -0500
nfs4: resend LAYOUTGET when there is a race that changes the seqid
commit 4f2e9dce0c6348a95eaa56ade9bab18572221088 upstream.
pnfs\_layout\_process will check the returned layout stateid against what
the kernel has in-core. If it turns out that the stateid we received is
older, then we should resend the LAYOUTGET instead of falling back to
MDS I/O.
Signed-off-by: Jeff Layton
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 9a08c6f60bbc067199214b4730df27979716f242
Author: Benjamin Coddington
Date: Fri Nov 20 09:56:20 2015 -0500
nfs4: start callback\_ident at idr 1
commit c68a027c05709330fe5b2f50c50d5fa02124b5d8 upstream.
If clp->cl\_cb\_ident is zero, then nfs\_cb\_idr\_remove\_locked() skips removing
it when the nfs\_client is freed. A decoding or server bug can then find
and try to put that first nfs\_client which would lead to a crash.
Signed-off-by: Benjamin Coddington
Fixes: d6870312659d ("nfs4client: convert to idr\_alloc()")
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 8489733094edbec8f3d62f96cd8b15402e66350a
Author: Daniel Borkmann
Date: Thu Nov 5 00:01:51 2015 +0100
debugfs: fix refcount imbalance in start\_creating
commit 0ee9608c89e81a1ccee52ecb58a7ff040e2522d9 upstream.
In debugfs' start\_creating(), we pin the file system to safely access
its root. When we failed to create a file, we unpin the file system via
failed\_creating() to release the mount count and eventually the reference
of the vfsmount.
However, when we run into an error during lookup\_one\_len() when still
in start\_creating(), we only release the parent's mutex but not so the
reference on the mount. Looks like it was done in the past, but after
splitting portions of \_\_create\_file() into start\_creating() and
end\_creating() via 190afd81e4a5 ("debugfs: split the beginning and the
end of \_\_create\_file() off"), this seemed missed. Noticed during code
review.
Fixes: 190afd81e4a5 ("debugfs: split the beginning and the end of \_\_create\_file() off")
Signed-off-by: Daniel Borkmann
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 4e9f452926507ecabd3030efda61413a7cd9bef2
Author: Andrew Elble
Date: Thu Oct 15 12:07:28 2015 -0400
nfsd: eliminate sending duplicate and repeated delegations
commit 34ed9872e745fa56f10e9bef2cf3d2336c6c8816 upstream.
We've observed the nfsd server in a state where there are
multiple delegations on the same nfs4\_file for the same client.
The nfs client does attempt to DELEGRETURN these when they are presented to
it - but apparently under some (unknown) circumstances the client does not
manage to return all of them. This leads to the eventual
attempt to CB\_RECALL more than one delegation with the same nfs
filehandle to the same client. The first recall will succeed, but the
next recall will fail with NFS4ERR\_BADHANDLE. This leads to the server
having delegations on cl\_revoked that the client has no way to FREE
or DELEGRETURN, with resulting inability to recover. The state manager
on the server will continually assert SEQ4\_STATUS\_RECALLABLE\_STATE\_REVOKED,
and the state manager on the client will be looping unable to satisfy
the server.
List discussion also reports a race between OPEN and DELEGRETURN that
will be avoided by only sending the delegation once to the
client. This is also logically in accordance with RFC5561 9.1.1 and 10.2.
So, let's:
1.) Not hand out duplicate delegations.
2.) Only send them to the client once.
RFC 5561:
9.1.1:
"Delegations and layouts, on the other hand, are not associated with a
specific owner but are associated with the client as a whole
(identified by a client ID)."
10.2:
"...the stateid for a delegation is associated with a client ID and may be
used on behalf of all the open-owners for the given client. A
delegation is made to the client as a whole and not to any specific
process or thread of control within it."
Reported-by: Eric Meddaugh
Cc: Trond Myklebust
Cc: Olga Kornievskaia
Signed-off-by: Andrew Elble
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 9a4a72786164f9aa3ca99189ef2948e020d31068
Author: Jeff Layton
Date: Thu Sep 17 07:47:08 2015 -0400
nfsd: serialize state seqid morphing operations
commit 35a92fe8770ce54c5eb275cd76128645bea2d200 upstream.
Andrew was seeing a race occur when an OPEN and OPEN\_DOWNGRADE were
running in parallel. The server would receive the OPEN\_DOWNGRADE first
and check its seqid, but then an OPEN would race in and bump it. The
OPEN\_DOWNGRADE would then complete and bump the seqid again. The result
was that the OPEN\_DOWNGRADE would be applied after the OPEN, even though
it should have been rejected since the seqid changed.
The only recourse we have here I think is to serialize operations that
bump the seqid in a stateid, particularly when we're given a seqid in
the call. To address this, we add a new rw\_semaphore to the
nfs4\_ol\_stateid struct. We do a down\_write prior to checking the seqid
after looking up the stateid to ensure that nothing else is going to
bump it while we're operating on it.
In the case of OPEN, we do a down\_read, as the call doesn't contain a
seqid. Those can run in parallel -- we just need to serialize them when
there is a concurrent OPEN\_DOWNGRADE or CLOSE.
LOCK and LOCKU however always take the write lock as there is no
opportunity for parallelizing those.
Reported-and-Tested-by: Andrew W Elble
Signed-off-by: Jeff Layton
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit eee26fbfd7a6970ad29daa83f5d7d83df17b017c
Author: Stefan Richter
Date: Tue Nov 3 01:46:21 2015 +0100
firewire: ohci: fix JMicron JMB38x IT context discovery
commit 100ceb66d5c40cc0c7018e06a9474302470be73c upstream.
Reported by Clifford and Craig for JMicron OHCI-1394 + SDHCI combo
controllers: Often or even most of the time, the controller is
initialized with the message "added OHCI v1.10 device as card 0, 4 IR +
0 IT contexts, quirks 0x10". With 0 isochronous transmit DMA contexts
(IT contexts), applications like audio output are impossible.
However, OHCI-1394 demands that at least 4 IT contexts are implemented
by the link layer controller, and indeed JMicron JMB38x do implement
four of them. Only their IsoXmitIntMask register is unreliable at early
access.
With my own JMB381 single function controller I found:
- I can reproduce the problem with a lower probability than Craig's.
- If I put a loop around the section which clears and reads
IsoXmitIntMask, then either the first or the second attempt will
return the correct initial mask of 0x0000000f. I never encountered
a case of needing more than a second attempt.
- Consequently, if I put a dummy reg\_read(...IsoXmitIntMaskSet)
before the first write, the subsequent read will return the correct
result.
- If I merely ignore a wrong read result and force the known real
result, later isochronous transmit DMA usage works just fine.
So let's just fix this chip bug up by the latter method. Tested with
JMB381 on kernel 3.13 and 4.3.
Since OHCI-1394 generally requires 4 IT contexts at a minium, this
workaround is simply applied whenever the initial read of IsoXmitIntMask
returns 0, regardless whether it's a JMicron chip or not. I never heard
of this issue together with any other chip though.
I am not 100% sure that this fix works on the OHCI-1394 part of JMB380
and JMB388 combo controllers exactly the same as on the JMB381 single-
function controller, but so far I haven't had a chance to let an owner
of a combo chip run a patched kernel.
Strangely enough, IsoRecvIntMask is always reported correctly, even
though it is probed right before IsoXmitIntMask.
Reported-by: Clifford Dunn
Reported-by: Craig Moore
Signed-off-by: Stefan Richter
Signed-off-by: Greg Kroah-Hartman
commit 5cbe4871e7fd45910472918126b9f1e77a5bda84
Author: Daeho Jeong
Date: Sun Oct 18 17:02:56 2015 -0400
ext4, jbd2: ensure entering into panic after recording an error in superblock
commit 4327ba52afd03fc4b5afa0ee1d774c9c5b0e85c5 upstream.
If a EXT4 filesystem utilizes JBD2 journaling and an error occurs, the
journaling will be aborted first and the error number will be recorded
into JBD2 superblock and, finally, the system will enter into the
panic state in "errors=panic" option. But, in the rare case, this
sequence is little twisted like the below figure and it will happen
that the system enters into panic state, which means the system reset
in mobile environment, before completion of recording an error in the
journal superblock. In this case, e2fsck cannot recognize that the
filesystem failure occurred in the previous run and the corruption
wouldn't be fixed.
Task A Task B
ext4\_handle\_error()
-> jbd2\_journal\_abort()
-> \_\_journal\_abort\_soft()
-> \_\_jbd2\_journal\_abort\_hard()
| -> journal->j\_flags |= JBD2\_ABORT;
|
| \_\_ext4\_abort()
| -> jbd2\_journal\_abort()
| | -> \_\_journal\_abort\_soft()
| | -> if (journal->j\_flags & JBD2\_ABORT)
| | return;
| -> panic()
|
-> jbd2\_journal\_update\_sb\_errno()
Tested-by: Hobin Woo
Signed-off-by: Daeho Jeong
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 5a4ead78e6a00d20924ea1485d51529d9d6c335f
Author: Lukas Czerner
Date: Sat Oct 17 22:57:06 2015 -0400
ext4: fix potential use after free in \_\_ext4\_journal\_stop
commit 6934da9238da947628be83635e365df41064b09b upstream.
There is a use-after-free possibility in \_\_ext4\_journal\_stop() in the
case that we free the handle in the first jbd2\_journal\_stop() because
we're referencing handle->h\_err afterwards. This was introduced in
9705acd63b125dee8b15c705216d7186daea4625 and it is wrong. Fix it by
storing the handle->h\_err value beforehand and avoid referencing
potentially freed handle.
Fixes: 9705acd63b125dee8b15c705216d7186daea4625
Signed-off-by: Lukas Czerner
Reviewed-by: Andreas Dilger
Signed-off-by: Greg Kroah-Hartman
commit bcdde051c4086a43f97119fefd70735b26f924b6
Author: Theodore Ts'o
Date: Sat Oct 3 10:49:29 2015 -0400
ext4 crypto: fix bugs in ext4\_encrypted\_zeroout()
commit 36086d43f6575c081067de9855786a2fc91df77b upstream.
Fix multiple bugs in ext4\_encrypted\_zeroout(), including one that
could cause us to write an encrypted zero page to the wrong location
on disk, potentially causing data and file system corruption.
Fortunately, this tends to only show up in stress tests, but even with
these fixes, we are seeing some test failures with generic/127 --- but
these are now caused by data failures instead of metadata corruption.
Since ext4\_encrypted\_zeroout() is only used for some optimizations to
keep the extent tree from being too fragmented, and
ext4\_encrypted\_zeroout() itself isn't all that optimized from a time
or IOPS perspective, disable the extent tree optimization for
encrypted inodes for now. This prevents the data corruption issues
reported by generic/127 until we can figure out what's going wrong.
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 99d17a1f12d6e56fa197f9e6c131236df50ef391
Author: Theodore Ts'o
Date: Fri Oct 2 23:54:58 2015 -0400
ext4 crypto: fix memory leak in ext4\_bio\_write\_page()
commit 937d7b84dca58f2565715f2c8e52f14c3d65fb22 upstream.
There are times when ext4\_bio\_write\_page() is called even though we
don't actually need to do any I/O. This happens when ext4\_writepage()
gets called by the jbd2 commit path when an inode needs to force its
pages written out in order to provide data=ordered guarantees --- and
a page is backed by an unwritten (e.g., uninitialized) block on disk,
or if delayed allocation means the page's backing store hasn't been
allocated yet. In that case, we need to skip the call to
ext4\_encrypt\_page(), since in addition to wasting CPU, it leads to a
bounce page and an ext4 crypto context getting leaked.
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 4d8dce2c10dfaba12c767e48d254082333424c7e
Author: Ilya Dryomov
Date: Fri Nov 27 19:23:24 2015 +0100
rbd: don't put snap\_context twice in rbd\_queue\_workfn()
commit 70b16db86f564977df074072143284aec2cb1162 upstream.
Commit 4e752f0ab0e8 ("rbd: access snapshot context and mapping size
safely") moved ceph\_get\_snap\_context() out of rbd\_img\_request\_create()
and into rbd\_queue\_workfn(), adding a ceph\_put\_snap\_context() to the
error path in rbd\_queue\_workfn(). However, rbd\_img\_request\_create()
consumes a ref on snapc, so calling ceph\_put\_snap\_context() after
a successful rbd\_img\_request\_create() leads to an extra put. Fix it.
Signed-off-by: Ilya Dryomov
Reviewed-by: Josh Durgin
Signed-off-by: Greg Kroah-Hartman
commit f0009492b51e67fc498ab6bcc127c9b418806e71
Author: David Sterba
Date: Mon Nov 9 11:44:45 2015 +0100
btrfs: fix signed overflows in btrfs\_sync\_file
commit 9dcbeed4d7e11e1dcf5e55475de3754f0855d1c2 upstream.
The calculation of range length in btrfs\_sync\_file leads to signed
overflow. This was caught by PaX gcc SIZE\_OVERFLOW plugin.
https://forums.grsecurity.net/viewtopic.php?f=1&t=4284
The fsync call passes 0 and LLONG\_MAX, the range length does not fit to
loff\_t and overflows, but the value is converted to u64 so it silently
works as expected.
The minimal fix is a typecast to u64, switching functions to take
(start, end) instead of (start, len) would be more intrusive.
Coccinelle script found that there's one more opencoded calculation of
the length.
@@
loff\_t start, end;
@@
\* end - start

Signed-off-by: David Sterba
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 82c82fadbd75f62bfb9d83eb3a308b55f4c4507d
Author: Filipe Manana
Date: Mon Nov 9 18:06:38 2015 +0000
Btrfs: fix race when listing an inode's xattrs
commit f1cd1f0b7d1b5d4aaa5711e8f4e4898b0045cb6d upstream.
When listing a inode's xattrs we have a time window where we race against
a concurrent operation for adding a new hard link for our inode that makes
us not return any xattr to user space. In order for this to happen, the
first xattr of our inode needs to be at slot 0 of a leaf and the previous
leaf must still have room for an inode ref (or extref) item, and this can
happen because an inode's listxattrs callback does not lock the inode's
i\_mutex (nor does the VFS does it for us), but adding a hard link to an
inode makes the VFS lock the inode's i\_mutex before calling the inode's
link callback.
If we have the following leafs:
Leaf X (has N items) Leaf Y
[ ... (257 INODE\_ITEM 0) (257 INODE\_REF 256) ] [ (257 XATTR\_ITEM 12345), ... ]
slot N - 2 slot N - 1 slot 0
The race illustrated by the following sequence diagram is possible:
CPU 1 CPU 2
btrfs\_listxattr()
searches for key (257 XATTR\_ITEM 0)
gets path with path->nodes[0] == leaf X
and path->slots[0] == N
because path->slots[0] is >=
btrfs\_header\_nritems(leaf X), it calls
btrfs\_next\_leaf()
btrfs\_next\_leaf()
releases the path
adds key (257 INODE\_REF 666)
to the end of leaf X (slot N),
and leaf X now has N + 1 items
searches for the key (257 INODE\_REF 256),
with path->keep\_locks == 1, because that
is the last key it saw in leaf X before
releasing the path
ends up at leaf X again and it verifies
that the key (257 INODE\_REF 256) is no
longer the last key in leaf X, so it
returns with path->nodes[0] == leaf X
and path->slots[0] == N, pointing to
the new item with key (257 INODE\_REF 666)
btrfs\_listxattr's loop iteration sees that
the type of the key pointed by the path is
different from the type BTRFS\_XATTR\_ITEM\_KEY
and so it breaks the loop and stops looking
for more xattr items
--> the application doesn't get any xattr
listed for our inode
So fix this by breaking the loop only if the key's type is greater than
BTRFS\_XATTR\_ITEM\_KEY and skip the current key if its type is smaller.
Signed-off-by: Filipe Manana
Signed-off-by: Greg Kroah-Hartman
commit 42c6cb15b97363f55f34f4845fe2c1503a9558a4
Author: Filipe Manana
Date: Mon Nov 9 00:33:58 2015 +0000
Btrfs: fix race leading to BUG\_ON when running delalloc for nodatacow
commit 1d512cb77bdbda80f0dd0620a3b260d697fd581d upstream.
If we are using the NO\_HOLES feature, we have a tiny time window when
running delalloc for a nodatacow inode where we can race with a concurrent
link or xattr add operation leading to a BUG\_ON.
This happens because at run\_delalloc\_nocow() we end up casting a leaf item
of type BTRFS\_INODE\_[REF|EXTREF]\_KEY or of type BTRFS\_XATTR\_ITEM\_KEY to a
file extent item (struct btrfs\_file\_extent\_item) and then analyse its
extent type field, which won't match any of the expected extent types
(values BTRFS\_FILE\_EXTENT\_[REG|PREALLOC|INLINE]) and therefore trigger an
explicit BUG\_ON(1).
The following sequence diagram shows how the race happens when running a
no-cow dellaloc range [4K, 8K[ for inode 257 and we have the following
neighbour leafs:
Leaf X (has N items) Leaf Y
[ ... (257 INODE\_ITEM 0) (257 INODE\_REF 256) ] [ (257 EXTENT\_DATA 8192), ... ]
slot N - 2 slot N - 1 slot 0
(Note the implicit hole for inode 257 regarding the [0, 8K[ range)
CPU 1 CPU 2
run\_dealloc\_nocow()
btrfs\_lookup\_file\_extent()
--> searches for a key with value
(257 EXTENT\_DATA 4096) in the
fs/subvol tree
--> returns us a path with
path->nodes[0] == leaf X and
path->slots[0] == N
because path->slots[0] is >=
btrfs\_header\_nritems(leaf X), it
calls btrfs\_next\_leaf()
btrfs\_next\_leaf()
--> releases the path
hard link added to our inode,
with key (257 INODE\_REF 500)
added to the end of leaf X,
so leaf X now has N + 1 keys
--> searches for the key
(257 INODE\_REF 256), because
it was the last key in leaf X
before it released the path,
with path->keep\_locks set to 1
--> ends up at leaf X again and
it verifies that the key
(257 INODE\_REF 256) is no longer
the last key in the leaf, so it
returns with path->nodes[0] ==
leaf X and path->slots[0] == N,
pointing to the new item with
key (257 INODE\_REF 500)
the loop iteration of run\_dealloc\_nocow()
does not break out the loop and continues
because the key referenced in the path
at path->nodes[0] and path->slots[0] is
for inode 257, its type is < BTRFS\_EXTENT\_DATA\_KEY
and its offset (500) is less then our delalloc
range's end (8192)
the item pointed by the path, an inode reference item,
is (incorrectly) interpreted as a file extent item and
we get an invalid extent type, leading to the BUG\_ON(1):
if (extent\_type == BTRFS\_FILE\_EXTENT\_REG ||
extent\_type == BTRFS\_FILE\_EXTENT\_PREALLOC) {
(...)
} else if (extent\_type == BTRFS\_FILE\_EXTENT\_INLINE) {
(...)
} else {
BUG\_ON(1)
}
The same can happen if a xattr is added concurrently and ends up having
a key with an offset smaller then the delalloc's range end.
So fix this by skipping keys with a type smaller than
BTRFS\_EXTENT\_DATA\_KEY.
Signed-off-by: Filipe Manana
Signed-off-by: Greg Kroah-Hartman
commit 280bd68e66a0fe027ee186a01a9edd869700a295
Author: Filipe Manana
Date: Fri Nov 6 13:33:33 2015 +0000
Btrfs: fix race leading to incorrect item deletion when dropping extents
commit aeafbf8486c9e2bd53f5cc3c10c0b7fd7149d69c upstream.
While running a stress test I got the following warning triggered:
[191627.672810] ------------[ cut here ]------------
[191627.673949] WARNING: CPU: 8 PID: 8447 at fs/btrfs/file.c:779 \_\_btrfs\_drop\_extents+0x391/0xa50 [btrfs]()
(...)
[191627.701485] Call Trace:
[191627.702037] [] dump\_stack+0x4f/0x7b
[191627.702992] [] ? console\_unlock+0x356/0x3a2
[191627.704091] [] warn\_slowpath\_common+0xa1/0xbb
[191627.705380] [] ? \_\_btrfs\_drop\_extents+0x391/0xa50 [btrfs]
[191627.706637] [] warn\_slowpath\_null+0x1a/0x1c
[191627.707789] [] \_\_btrfs\_drop\_extents+0x391/0xa50 [btrfs]
[191627.709155] [] ? cache\_alloc\_debugcheck\_after.isra.32+0x171/0x1d0
[191627.712444] [] ? kmemleak\_alloc\_recursive.constprop.40+0x16/0x18
[191627.714162] [] insert\_reserved\_file\_extent.constprop.40+0x83/0x24e [btrfs]
[191627.715887] [] ? start\_transaction+0x3bb/0x610 [btrfs]
[191627.717287] [] btrfs\_finish\_ordered\_io+0x273/0x4e2 [btrfs]
[191627.728865] [] finish\_ordered\_fn+0x15/0x17 [btrfs]
[191627.730045] [] normal\_work\_helper+0x14c/0x32c [btrfs]
[191627.731256] [] btrfs\_endio\_write\_helper+0x12/0x14 [btrfs]
[191627.732661] [] process\_one\_work+0x24c/0x4ae
[191627.733822] [] worker\_thread+0x206/0x2c2
[191627.734857] [] ? process\_scheduled\_works+0x2f/0x2f
[191627.736052] [] ? process\_scheduled\_works+0x2f/0x2f
[191627.737349] [] kthread+0xef/0xf7
[191627.738267] [] ? time\_hardirqs\_on+0x15/0x28
[191627.739330] [] ? \_\_kthread\_parkme+0xad/0xad
[191627.741976] [] ret\_from\_fork+0x42/0x70
[191627.743080] [] ? \_\_kthread\_parkme+0xad/0xad
[191627.744206] ---[ end trace bbfddacb7aaada8d ]---
$ cat -n fs/btrfs/file.c
691 int \_\_btrfs\_drop\_extents(struct btrfs\_trans\_handle \*trans,
(...)
758 btrfs\_item\_key\_to\_cpu(leaf, &key, path->slots[0]);
759 if (key.objectid > ino ||
760 key.type > BTRFS\_EXTENT\_DATA\_KEY || key.offset >= end)
761 break;
762
763 fi = btrfs\_item\_ptr(leaf, path->slots[0],
764 struct btrfs\_file\_extent\_item);
765 extent\_type = btrfs\_file\_extent\_type(leaf, fi);
766
767 if (extent\_type == BTRFS\_FILE\_EXTENT\_REG ||
768 extent\_type == BTRFS\_FILE\_EXTENT\_PREALLOC) {
(...)
774 } else if (extent\_type == BTRFS\_FILE\_EXTENT\_INLINE) {
(...)
778 } else {
779 WARN\_ON(1);
780 extent\_end = search\_start;
781 }
(...)
This happened because the item we were processing did not match a file
extent item (its key type != BTRFS\_EXTENT\_DATA\_KEY), and even on this
case we cast the item to a struct btrfs\_file\_extent\_item pointer and
then find a type field value that does not match any of the expected
values (BTRFS\_FILE\_EXTENT\_[REG|PREALLOC|INLINE]). This scenario happens
due to a tiny time window where a race can happen as exemplified below.
For example, consider the following scenario where we're using the
NO\_HOLES feature and we have the following two neighbour leafs:
Leaf X (has N items) Leaf Y
[ ... (257 INODE\_ITEM 0) (257 INODE\_REF 256) ] [ (257 EXTENT\_DATA 8192), ... ]
slot N - 2 slot N - 1 slot 0
Our inode 257 has an implicit hole in the range [0, 8K[ (implicit rather
than explicit because NO\_HOLES is enabled). Now if our inode has an
ordered extent for the range [4K, 8K[ that is finishing, the following
can happen:
CPU 1 CPU 2
btrfs\_finish\_ordered\_io()
insert\_reserved\_file\_extent()
\_\_btrfs\_drop\_extents()
Searches for the key
(257 EXTENT\_DATA 4096) through
btrfs\_lookup\_file\_extent()
Key not found and we get a path where
path->nodes[0] == leaf X and
path->slots[0] == N
Because path->slots[0] is >=
btrfs\_header\_nritems(leaf X), we call
btrfs\_next\_leaf()
btrfs\_next\_leaf() releases the path
inserts key
(257 INODE\_REF 4096)
at the end of leaf X,
leaf X now has N + 1 keys,
and the new key is at
slot N
btrfs\_next\_leaf() searches for
key (257 INODE\_REF 256), with
path->keep\_locks set to 1,
because it was the last key it
saw in leaf X
finds it in leaf X again and
notices it's no longer the last
key of the leaf, so it returns 0
with path->nodes[0] == leaf X and
path->slots[0] == N (which is now
< btrfs\_header\_nritems(leaf X)),
pointing to the new key
(257 INODE\_REF 4096)
\_\_btrfs\_drop\_extents() casts the
item at path->nodes[0], slot
path->slots[0], to a struct
btrfs\_file\_extent\_item - it does
not skip keys for the target
inode with a type less than
BTRFS\_EXTENT\_DATA\_KEY
(BTRFS\_INODE\_REF\_KEY < BTRFS\_EXTENT\_DATA\_KEY)
sees a bogus value for the type
field triggering the WARN\_ON in
the trace shown above, and sets
extent\_end = search\_start (4096)
does the if-then-else logic to
fixup 0 length extent items created
by a past bug from hole punching:
if (extent\_end == key.offset &&
extent\_end >= search\_start)
goto delete\_extent\_item;
that evaluates to true and it ends
up deleting the key pointed to by
path->slots[0], (257 INODE\_REF 4096),
from leaf X
The same could happen for example for a xattr that ends up having a key
with an offset value that matches search\_start (very unlikely but not
impossible).
So fix this by ensuring that keys smaller than BTRFS\_EXTENT\_DATA\_KEY are
skipped, never casted to struct btrfs\_file\_extent\_item and never deleted
by accident. Also protect against the unexpected case of getting a key
for a lower inode number by skipping that key and issuing a warning.
Signed-off-by: Filipe Manana
Signed-off-by: Greg Kroah-Hartman
commit fcb184a168452e315676f306b054c908e8ff94ab
Author: Filipe Manana
Date: Thu Oct 22 09:47:34 2015 +0100
Btrfs: fix regression when running delayed references
commit 2c3cf7d5f6105bb957df125dfce61d4483b8742d upstream.
In the kernel 4.2 merge window we had a refactoring/rework of the delayed
references implementation in order to fix certain problems with qgroups.
However that rework introduced one more regression that leads to the
following trace when running delayed references for metadata:
[35908.064664] kernel BUG at fs/btrfs/extent-tree.c:1832!
[35908.065201] invalid opcode: 0000 [#1] PREEMPT SMP DEBUG\_PAGEALLOC
[35908.065201] Modules linked in: dm\_flakey dm\_mod btrfs crc32c\_generic xor raid6\_pq nfsd auth\_rpcgss oid\_registry nfs\_acl nfs lockd grace fscache sunrpc loop fuse parport\_pc psmouse i2
[35908.065201] CPU: 14 PID: 15014 Comm: kworker/u32:9 Tainted: G W 4.3.0-rc5-btrfs-next-17+ #1
[35908.065201] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.8.1-0-g4adadbd-20150316\_085822-nilsson.home.kraxel.org 04/01/2014
[35908.065201] Workqueue: btrfs-extent-refs btrfs\_extent\_refs\_helper [btrfs]
[35908.065201] task: ffff880114b7d780 ti: ffff88010c4c8000 task.ti: ffff88010c4c8000
[35908.065201] RIP: 0010:[] [] insert\_inline\_extent\_backref+0x52/0xb1 [btrfs]
[35908.065201] RSP: 0018:ffff88010c4cbb08 EFLAGS: 00010293
[35908.065201] RAX: 0000000000000000 RBX: ffff88008a661000 RCX: 0000000000000000
[35908.065201] RDX: ffffffffa04dd58f RSI: 0000000000000001 RDI: 0000000000000000
[35908.065201] RBP: ffff88010c4cbb40 R08: 0000000000001000 R09: ffff88010c4cb9f8
[35908.065201] R10: 0000000000000000 R11: 000000000000002c R12: 0000000000000000
[35908.065201] R13: ffff88020a74c578 R14: 0000000000000000 R15: 0000000000000000
[35908.065201] FS: 0000000000000000(0000) GS:ffff88023edc0000(0000) knlGS:0000000000000000
[35908.065201] CS: 0010 DS: 0000 ES: 0000 CR0: 000000008005003b
[35908.065201] CR2: 00000000015e8708 CR3: 0000000102185000 CR4: 00000000000006e0
[35908.065201] Stack:
[35908.065201] ffff88010c4cbb18 0000000000000f37 ffff88020a74c578 ffff88015a408000
[35908.065201] ffff880154a44000 0000000000000000 0000000000000005 ffff88010c4cbbd8
[35908.065201] ffffffffa0492b9a 0000000000000005 0000000000000000 0000000000000000
[35908.065201] Call Trace:
[35908.065201] [] \_\_btrfs\_inc\_extent\_ref+0x8b/0x208 [btrfs]
[35908.065201] [] ? \_\_btrfs\_run\_delayed\_refs+0x4d4/0xd33 [btrfs]
[35908.065201] [] \_\_btrfs\_run\_delayed\_refs+0xafa/0xd33 [btrfs]
[35908.065201] [] ? join\_transaction.isra.10+0x25/0x41f [btrfs]
[35908.065201] [] ? join\_transaction.isra.10+0xa8/0x41f [btrfs]
[35908.065201] [] btrfs\_run\_delayed\_refs+0x75/0x1dd [btrfs]
[35908.065201] [] delayed\_ref\_async\_start+0x3c/0x7b [btrfs]
[35908.065201] [] normal\_work\_helper+0x14c/0x32a [btrfs]
[35908.065201] [] btrfs\_extent\_refs\_helper+0x12/0x14 [btrfs]
[35908.065201] [] process\_one\_work+0x24a/0x4ac
[35908.065201] [] worker\_thread+0x206/0x2c2
[35908.065201] [] ? rescuer\_thread+0x2cb/0x2cb
[35908.065201] [] ? rescuer\_thread+0x2cb/0x2cb
[35908.065201] [] kthread+0xef/0xf7
[35908.065201] [] ? kthread\_parkme+0x24/0x24
[35908.065201] [] ret\_from\_fork+0x3f/0x70
[35908.065201] [] ? kthread\_parkme+0x24/0x24
[35908.065201] Code: 6a 01 41 56 41 54 ff 75 10 41 51 4d 89 c1 49 89 c8 48 8d 4d d0 e8 f6 f1 ff ff 48 83 c4 28 85 c0 75 2c 49 81 fc ff 00 00 00 77 02 <0f> 0b 4c 8b 45 30 8b 4d 28 45 31
[35908.065201] RIP [] insert\_inline\_extent\_backref+0x52/0xb1 [btrfs]
[35908.065201] RSP
[35908.310885] ---[ end trace fe4299baf0666457 ]---
This happens because the new delayed references code no longer merges
delayed references that have different sequence values. The following
steps are an example sequence leading to this issue:
1) Transaction N starts, fs\_info->tree\_mod\_seq has value 0;
2) Extent buffer (btree node) A is allocated, delayed reference Ref1 for
bytenr A is created, with a value of 1 and a seq value of 0;
3) fs\_info->tree\_mod\_seq is incremented to 1;
4) Extent buffer A is deleted through btrfs\_del\_items(), which calls
btrfs\_del\_leaf(), which in turn calls btrfs\_free\_tree\_block(). The
later returns the metadata extent associated to extent buffer A to
the free space cache (the range is not pinned), because the extent
buffer was created in the current transaction (N) and writeback never
happened for the extent buffer (flag BTRFS\_HEADER\_FLAG\_WRITTEN not set
in the extent buffer).
This creates the delayed reference Ref2 for bytenr A, with a value
of -1 and a seq value of 1;
5) Delayed reference Ref2 is not merged with Ref1 when we create it,
because they have different sequence numbers (decided at
add\_delayed\_ref\_tail\_merge());
6) fs\_info->tree\_mod\_seq is incremented to 2;
7) Some task attempts to allocate a new extent buffer (done at
extent-tree.c:find\_free\_extent()), but due to heavy fragmentation
and running low on metadata space the clustered allocation fails
and we fall back to unclustered allocation, which finds the
extent at offset A, so a new extent buffer at offset A is allocated.
This creates delayed reference Ref3 for bytenr A, with a value of 1
and a seq value of 2;
8) Ref3 is not merged neither with Ref2 nor Ref1, again because they
all have different seq values;
9) We start running the delayed references (\_\_btrfs\_run\_delayed\_refs());
10) The delayed Ref1 is the first one being applied, which ends up
creating an inline extent backref in the extent tree;
10) Next the delayed reference Ref3 is selected for execution, and not
Ref2, because select\_delayed\_ref() always gives a preference for
positive references (that have an action of BTRFS\_ADD\_DELAYED\_REF);
11) When running Ref3 we encounter alreay the inline extent backref
in the extent tree at insert\_inline\_extent\_backref(), which makes
us hit the following BUG\_ON:
BUG\_ON(owner < BTRFS\_FIRST\_FREE\_OBJECTID);
This is always true because owner corresponds to the level of the
extent buffer/btree node in the btree.
For the scenario described above we hit the BUG\_ON because we never merge
references that have different seq values.
We used to do the merging before the 4.2 kernel, more specifically, before
the commmits:
c6fc24549960 ("btrfs: delayed-ref: Use list to replace the ref\_root in ref\_head.")
c43d160fcd5e ("btrfs: delayed-ref: Cleanup the unneeded functions.")
This issue became more exposed after the following change that was added
to 4.2 as well:
cffc3374e567 ("Btrfs: fix order by which delayed references are run")
Which in turn fixed another regression by the two commits previously
mentioned.
So fix this by bringing back the delayed reference merge code, with the
proper adaptations so that it operates against the new data structure
(linked list vs old red black tree implementation).
This issue was hit running fstest btrfs/063 in a loop. Several people have
reported this issue in the mailing list when running on kernels 4.2+.
Very special thanks to Stéphane Lesimple for helping debugging this issue
and testing this fix on his multi terabyte filesystem (which took more
than one day to balance alone, plus fsck, etc).
Fixes: c6fc24549960 ("btrfs: delayed-ref: Use list to replace the ref\_root in ref\_head.")
Reported-by: Peter Becker
Reported-by: Stéphane Lesimple
Tested-by: Stéphane Lesimple
Reported-by: Malte Schröder
Reported-by: Derek Dongray
Reported-by: Erkki Seppala
Signed-off-by: Filipe Manana
Reviewed-by: Liu Bo
Signed-off-by: Greg Kroah-Hartman
commit 90291b48b1d907425d8741861fff1dfe4cf7156f
Author: Filipe Manana
Date: Fri Oct 16 12:34:25 2015 +0100
Btrfs: fix truncation of compressed and inlined extents
commit 0305cd5f7fca85dae392b9ba85b116896eb7c1c7 upstream.
When truncating a file to a smaller size which consists of an inline
extent that is compressed, we did not discard (or made unusable) the
data between the new file size and the old file size, wasting metadata
space and allowing for the truncated data to be leaked and the data
corruption/loss mentioned below.
We were also not correctly decrementing the number of bytes used by the
inode, we were setting it to zero, giving a wrong report for callers of
the stat(2) syscall. The fsck tool also reported an error about a mismatch
between the nbytes of the file versus the real space used by the file.
Now because we weren't discarding the truncated region of the file, it
was possible for a caller of the clone ioctl to actually read the data
that was truncated, allowing for a security breach without requiring root
access to the system, using only standard filesystem operations. The
scenario is the following:
1) User A creates a file which consists of an inline and compressed
extent with a size of 2000 bytes - the file is not accessible to
any other users (no read, write or execution permission for anyone
else);
2) The user truncates the file to a size of 1000 bytes;
3) User A makes the file world readable;
4) User B creates a file consisting of an inline extent of 2000 bytes;
5) User B issues a clone operation from user A's file into its own
file (using a length argument of 0, clone the whole range);
6) User B now gets to see the 1000 bytes that user A truncated from
its file before it made its file world readbale. User B also lost
the bytes in the range [1000, 2000[ bytes from its own file, but
that might be ok if his/her intention was reading stale data from
user A that was never supposed to be public.
Note that this contrasts with the case where we truncate a file from 2000
bytes to 1000 bytes and then truncate it back from 1000 to 2000 bytes. In
this case reading any byte from the range [1000, 2000[ will return a value
of 0x00, instead of the original data.
This problem exists since the clone ioctl was added and happens both with
and without my recent data loss and file corruption fixes for the clone
ioctl (patch "Btrfs: fix file corruption and data loss after cloning
inline extents").
So fix this by truncating the compressed inline extents as we do for the
non-compressed case, which involves decompressing, if the data isn't already
in the page cache, compressing the truncated version of the extent, writing
the compressed content into the inline extent and then truncate it.
The following test case for fstests reproduces the problem. In order for
the test to pass both this fix and my previous fix for the clone ioctl
that forbids cloning a smaller inline extent into a larger one,
which is titled "Btrfs: fix file corruption and data loss after cloning
inline extents", are needed. Without that other fix the test fails in a
different way that does not leak the truncated data, instead part of
destination file gets replaced with zeroes (because the destination file
has a larger inline extent than the source).
seq=`basename $0`
seqres=$RESULT\_DIR/$seq
echo "QA output created by $seq"
tmp=/tmp/$$
status=1 # failure is the default!
trap "\_cleanup; exit \$status" 0 1 2 3 15
\_cleanup()
{
rm -f $tmp.\*
}
# get standard environment, filters and checks
. ./common/rc
. ./common/filter
# real QA test starts here
\_need\_to\_be\_root
\_supported\_fs btrfs
\_supported\_os Linux
\_require\_scratch
\_require\_cloner
rm -f $seqres.full
\_scratch\_mkfs >>$seqres.full 2>&1
\_scratch\_mount "-o compress"
# Create our test files. File foo is going to be the source of a clone operation
# and consists of a single inline extent with an uncompressed size of 512 bytes,
# while file bar consists of a single inline extent with an uncompressed size of
# 256 bytes. For our test's purpose, it's important that file bar has an inline
# extent with a size smaller than foo's inline extent.
$XFS\_IO\_PROG -f -c "pwrite -S 0xa1 0 128" \
-c "pwrite -S 0x2a 128 384" \
$SCRATCH\_MNT/foo | \_filter\_xfs\_io
$XFS\_IO\_PROG -f -c "pwrite -S 0xbb 0 256" $SCRATCH\_MNT/bar | \_filter\_xfs\_io
# Now durably persist all metadata and data. We do this to make sure that we get
# on disk an inline extent with a size of 512 bytes for file foo.
sync
# Now truncate our file foo to a smaller size. Because it consists of a
# compressed and inline extent, btrfs did not shrink the inline extent to the
# new size (if the extent was not compressed, btrfs would shrink it to 128
# bytes), it only updates the inode's i\_size to 128 bytes.
$XFS\_IO\_PROG -c "truncate 128" $SCRATCH\_MNT/foo
# Now clone foo's inline extent into bar.
# This clone operation should fail with errno EOPNOTSUPP because the source
# file consists only of an inline extent and the file's size is smaller than
# the inline extent of the destination (128 bytes < 256 bytes). However the
# clone ioctl was not prepared to deal with a file that has a size smaller
# than the size of its inline extent (something that happens only for compressed
# inline extents), resulting in copying the full inline extent from the source
# file into the destination file.
#
# Note that btrfs' clone operation for inline extents consists of removing the
# inline extent from the destination inode and copy the inline extent from the
# source inode into the destination inode, meaning that if the destination
# inode's inline extent is larger (N bytes) than the source inode's inline
# extent (M bytes), some bytes (N - M bytes) will be lost from the destination
# file. Btrfs could copy the source inline extent's data into the destination's
# inline extent so that we would not lose any data, but that's currently not
# done due to the complexity that would be needed to deal with such cases
# (specially when one or both extents are compressed), returning EOPNOTSUPP, as
# it's normally not a very common case to clone very small files (only case
# where we get inline extents) and copying inline extents does not save any
# space (unlike for normal, non-inlined extents).
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/foo $SCRATCH\_MNT/bar
# Now because the above clone operation used to succeed, and due to foo's inline
# extent not being shinked by the truncate operation, our file bar got the whole
# inline extent copied from foo, making us lose the last 128 bytes from bar
# which got replaced by the bytes in range [128, 256[ from foo before foo was
# truncated - in other words, data loss from bar and being able to read old and
# stale data from foo that should not be possible to read anymore through normal
# filesystem operations. Contrast with the case where we truncate a file from a
# size N to a smaller size M, truncate it back to size N and then read the range
# [M, N[, we should always get the value 0x00 for all the bytes in that range.
# We expected the clone operation to fail with errno EOPNOTSUPP and therefore
# not modify our file's bar data/metadata. So its content should be 256 bytes
# long with all bytes having the value 0xbb.
#
# Without the btrfs bug fix, the clone operation succeeded and resulted in
# leaking truncated data from foo, the bytes that belonged to its range
# [128, 256[, and losing data from bar in that same range. So reading the
# file gave us the following content:
#
# 0000000 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1 a1
# \*
# 0000200 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a 2a
# \*
# 0000400
echo "File bar's content after the clone operation:"
od -t x1 $SCRATCH\_MNT/bar
# Also because the foo's inline extent was not shrunk by the truncate
# operation, btrfs' fsck, which is run by the fstests framework everytime a
# test completes, failed reporting the following error:
#
# root 5 inode 257 errors 400, nbytes wrong
status=0
exit
Signed-off-by: Filipe Manana
Signed-off-by: Greg Kroah-Hartman
commit 8b15aa67a2a49cf332363186f1c8249bdf2059ca
Author: Filipe Manana
Date: Tue Oct 13 15:15:00 2015 +0100
Btrfs: fix file corruption and data loss after cloning inline extents
commit 8039d87d9e473aeb740d4fdbd59b9d2f89b2ced9 upstream.
Currently the clone ioctl allows to clone an inline extent from one file
to another that already has other (non-inlined) extents. This is a problem
because btrfs is not designed to deal with files having inline and regular
extents, if a file has an inline extent then it must be the only extent
in the file and must start at file offset 0. Having a file with an inline
extent followed by regular extents results in EIO errors when doing reads
or writes against the first 4K of the file.
Also, the clone ioctl allows one to lose data if the source file consists
of a single inline extent, with a size of N bytes, and the destination
file consists of a single inline extent with a size of M bytes, where we
have M > N. In this case the clone operation removes the inline extent
from the destination file and then copies the inline extent from the
source file into the destination file - we lose the M - N bytes from the
destination file, a read operation will get the value 0x00 for any bytes
in the the range [N, M] (the destination inode's i\_size remained as M,
that's why we can read past N bytes).
So fix this by not allowing such destructive operations to happen and
return errno EOPNOTSUPP to user space.
Currently the fstest btrfs/035 tests the data loss case but it totally
ignores this - i.e. expects the operation to succeed and does not check
the we got data loss.
The following test case for fstests exercises all these cases that result
in file corruption and data loss:
seq=`basename $0`
seqres=$RESULT\_DIR/$seq
echo "QA output created by $seq"
tmp=/tmp/$$
status=1 # failure is the default!
trap "\_cleanup; exit \$status" 0 1 2 3 15
\_cleanup()
{
rm -f $tmp.\*
}
# get standard environment, filters and checks
. ./common/rc
. ./common/filter
# real QA test starts here
\_need\_to\_be\_root
\_supported\_fs btrfs
\_supported\_os Linux
\_require\_scratch
\_require\_cloner
\_require\_btrfs\_fs\_feature "no\_holes"
\_require\_btrfs\_mkfs\_feature "no-holes"
rm -f $seqres.full
test\_cloning\_inline\_extents()
{
local mkfs\_opts=$1
local mount\_opts=$2
\_scratch\_mkfs $mkfs\_opts >>$seqres.full 2>&1
\_scratch\_mount $mount\_opts
# File bar, the source for all the following clone operations, consists
# of a single inline extent (50 bytes).
$XFS\_IO\_PROG -f -c "pwrite -S 0xbb 0 50" $SCRATCH\_MNT/bar \
| \_filter\_xfs\_io
# Test cloning into a file with an extent (non-inlined) where the
# destination offset overlaps that extent. It should not be possible to
# clone the inline extent from file bar into this file.
$XFS\_IO\_PROG -f -c "pwrite -S 0xaa 0K 16K" $SCRATCH\_MNT/foo \
| \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo
# Doing IO against any range in the first 4K of the file should work.
# Due to a past clone ioctl bug which allowed cloning the inline extent,
# these operations resulted in EIO errors.
echo "File foo data after clone operation:"
# All bytes should have the value 0xaa (clone operation failed and did
# not modify our file).
od -t x1 $SCRATCH\_MNT/foo
$XFS\_IO\_PROG -c "pwrite -S 0xcc 0 100" $SCRATCH\_MNT/foo | \_filter\_xfs\_io
# Test cloning the inline extent against a file which has a hole in its
# first 4K followed by a non-inlined extent. It should not be possible
# as well to clone the inline extent from file bar into this file.
$XFS\_IO\_PROG -f -c "pwrite -S 0xdd 4K 12K" $SCRATCH\_MNT/foo2 \
| \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo2
# Doing IO against any range in the first 4K of the file should work.
# Due to a past clone ioctl bug which allowed cloning the inline extent,
# these operations resulted in EIO errors.
echo "File foo2 data after clone operation:"
# All bytes should have the value 0x00 (clone operation failed and did
# not modify our file).
od -t x1 $SCRATCH\_MNT/foo2
$XFS\_IO\_PROG -c "pwrite -S 0xee 0 90" $SCRATCH\_MNT/foo2 | \_filter\_xfs\_io
# Test cloning the inline extent against a file which has a size of zero
# but has a prealloc extent. It should not be possible as well to clone
# the inline extent from file bar into this file.
$XFS\_IO\_PROG -f -c "falloc -k 0 1M" $SCRATCH\_MNT/foo3 | \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo3
# Doing IO against any range in the first 4K of the file should work.
# Due to a past clone ioctl bug which allowed cloning the inline extent,
# these operations resulted in EIO errors.
echo "First 50 bytes of foo3 after clone operation:"
# Should not be able to read any bytes, file has 0 bytes i\_size (the
# clone operation failed and did not modify our file).
od -t x1 $SCRATCH\_MNT/foo3
$XFS\_IO\_PROG -c "pwrite -S 0xff 0 90" $SCRATCH\_MNT/foo3 | \_filter\_xfs\_io
# Test cloning the inline extent against a file which consists of a
# single inline extent that has a size not greater than the size of
# bar's inline extent (40 < 50).
# It should be possible to do the extent cloning from bar to this file.
$XFS\_IO\_PROG -f -c "pwrite -S 0x01 0 40" $SCRATCH\_MNT/foo4 \
| \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo4
# Doing IO against any range in the first 4K of the file should work.
echo "File foo4 data after clone operation:"
# Must match file bar's content.
od -t x1 $SCRATCH\_MNT/foo4
$XFS\_IO\_PROG -c "pwrite -S 0x02 0 90" $SCRATCH\_MNT/foo4 | \_filter\_xfs\_io
# Test cloning the inline extent against a file which consists of a
# single inline extent that has a size greater than the size of bar's
# inline extent (60 > 50).
# It should not be possible to clone the inline extent from file bar
# into this file.
$XFS\_IO\_PROG -f -c "pwrite -S 0x03 0 60" $SCRATCH\_MNT/foo5 \
| \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo5
# Reading the file should not fail.
echo "File foo5 data after clone operation:"
# Must have a size of 60 bytes, with all bytes having a value of 0x03
# (the clone operation failed and did not modify our file).
od -t x1 $SCRATCH\_MNT/foo5
# Test cloning the inline extent against a file which has no extents but
# has a size greater than bar's inline extent (16K > 50).
# It should not be possible to clone the inline extent from file bar
# into this file.
$XFS\_IO\_PROG -f -c "truncate 16K" $SCRATCH\_MNT/foo6 | \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo6
# Reading the file should not fail.
echo "File foo6 data after clone operation:"
# Must have a size of 16K, with all bytes having a value of 0x00 (the
# clone operation failed and did not modify our file).
od -t x1 $SCRATCH\_MNT/foo6
# Test cloning the inline extent against a file which has no extents but
# has a size not greater than bar's inline extent (30 < 50).
# It should be possible to clone the inline extent from file bar into
# this file.
$XFS\_IO\_PROG -f -c "truncate 30" $SCRATCH\_MNT/foo7 | \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo7
# Reading the file should not fail.
echo "File foo7 data after clone operation:"
# Must have a size of 50 bytes, with all bytes having a value of 0xbb.
od -t x1 $SCRATCH\_MNT/foo7
# Test cloning the inline extent against a file which has a size not
# greater than the size of bar's inline extent (20 < 50) but has
# a prealloc extent that goes beyond the file's size. It should not be
# possible to clone the inline extent from bar into this file.
$XFS\_IO\_PROG -f -c "falloc -k 0 1M" \
-c "pwrite -S 0x88 0 20" \
$SCRATCH\_MNT/foo8 | \_filter\_xfs\_io
$CLONER\_PROG -s 0 -d 0 -l 0 $SCRATCH\_MNT/bar $SCRATCH\_MNT/foo8
echo "File foo8 data after clone operation:"
# Must have a size of 20 bytes, with all bytes having a value of 0x88
# (the clone operation did not modify our file).
od -t x1 $SCRATCH\_MNT/foo8
\_scratch\_unmount
}
echo -e "\nTesting without compression and without the no-holes feature...\n"
test\_cloning\_inline\_extents
echo -e "\nTesting with compression and without the no-holes feature...\n"
test\_cloning\_inline\_extents "" "-o compress"
echo -e "\nTesting without compression and with the no-holes feature...\n"
test\_cloning\_inline\_extents "-O no-holes" ""
echo -e "\nTesting with compression and with the no-holes feature...\n"
test\_cloning\_inline\_extents "-O no-holes" "-o compress"
status=0
exit
Signed-off-by: Filipe Manana
Signed-off-by: Greg Kroah-Hartman
commit b855aa43eb1c47d6e10fd90df2f0fb8ab6423c12
Author: Robin Ruede
Date: Wed Sep 30 21:23:33 2015 +0200
btrfs: fix resending received snapshot with parent
commit b96b1db039ebc584d03a9933b279e0d3e704c528 upstream.
This fixes a regression introduced by 37b8d27d between v4.1 and v4.2.
When a snapshot is received, its received\_uuid is set to the original
uuid of the subvolume. When that snapshot is then resent to a third
filesystem, it's received\_uuid is set to the second uuid
instead of the original one. The same was true for the parent\_uuid.
This behaviour was partially changed in 37b8d27d, but in that patch
only the parent\_uuid was taken from the real original,
not the uuid itself, causing the search for the parent to fail in
the case below.
This happens for example when trying to send a series of linked
snapshots (e.g. created by snapper) from the backup file system back
to the original one.
The following commands reproduce the issue in v4.2.1
(no error in 4.1.6)
# setup three test file systems
for i in 1 2 3; do
truncate -s 50M fs$i
mkfs.btrfs fs$i
mkdir $i
mount fs$i $i
done
echo "content" > 1/testfile
btrfs su snapshot -r 1/ 1/snap1
echo "changed content" > 1/testfile
btrfs su snapshot -r 1/ 1/snap2
# works fine:
btrfs send 1/snap1 | btrfs receive 2/
btrfs send -p 1/snap1 1/snap2 | btrfs receive 2/
# ERROR: could not find parent subvolume
btrfs send 2/snap1 | btrfs receive 3/
btrfs send -p 2/snap1 2/snap2 | btrfs receive 3/
Signed-off-by: Robin Ruede
Fixes: 37b8d27de5d0 ("Btrfs: use received\_uuid of parent during send")
Reviewed-by: Filipe Manana
Tested-by: Ed Tomlinson
Signed-off-by: Greg Kroah-Hartman
commit 36204ef3c3a43e1dc015d2401068e4bfb45e1e09
Author: Eric Dumazet
Date: Tue Dec 1 20:08:51 2015 -0800
net\_sched: fix qdisc\_tree\_decrease\_qlen() races
[ Upstream commit 4eaf3b84f2881c9c028f1d5e76c52ab575fe3a66 ]
qdisc\_tree\_decrease\_qlen() suffers from two problems on multiqueue
devices.
One problem is that it updates sch->q.qlen and sch->qstats.drops
on the mq/mqprio root qdisc, while it should not : Daniele
reported underflows errors :
[ 681.774821] PAX: sch->q.qlen: 0 n: 1
[ 681.774825] PAX: size overflow detected in function qdisc\_tree\_decrease\_qlen net/sched/sch\_api.c:769 cicus.693\_49 min, count: 72, decl: qlen; num: 0; context: sk\_buff\_head;
[ 681.774954] CPU: 2 PID: 19 Comm: ksoftirqd/2 Tainted: G O 4.2.6.201511282239-1-grsec #1
[ 681.774955] Hardware name: ASUSTeK COMPUTER INC. X302LJ/X302LJ, BIOS X302LJ.202 03/05/2015
[ 681.774956] ffffffffa9a04863 0000000000000000 0000000000000000 ffffffffa990ff7c
[ 681.774959] ffffc90000d3bc38 ffffffffa95d2810 0000000000000007 ffffffffa991002b
[ 681.774960] ffffc90000d3bc68 ffffffffa91a44f4 0000000000000001 0000000000000001
[ 681.774962] Call Trace:
[ 681.774967] [] dump\_stack+0x4c/0x7f
[ 681.774970] [] report\_size\_overflow+0x34/0x50
[ 681.774972] [] qdisc\_tree\_decrease\_qlen+0x152/0x160
[ 681.774976] [] fq\_codel\_dequeue+0x7b1/0x820 [sch\_fq\_codel]
[ 681.774978] [] ? qdisc\_peek\_dequeued+0xa0/0xa0 [sch\_fq\_codel]
[ 681.774980] [] \_\_qdisc\_run+0x4d/0x1d0
[ 681.774983] [] net\_tx\_action+0xc2/0x160
[ 681.774985] [] \_\_do\_softirq+0xf1/0x200
[ 681.774987] [] run\_ksoftirqd+0x1e/0x30
[ 681.774989] [] smpboot\_thread\_fn+0x150/0x260
[ 681.774991] [] ? sort\_range+0x40/0x40
[ 681.774992] [] kthread+0xe4/0x100
[ 681.774994] [] ? kthread\_worker\_fn+0x170/0x170
[ 681.774995] [] ret\_from\_fork+0x3e/0x70
mq/mqprio have their own ways to report qlen/drops by folding stats on
all their queues, with appropriate locking.
A second problem is that qdisc\_tree\_decrease\_qlen() calls qdisc\_lookup()
without proper locking : concurrent qdisc updates could corrupt the list
that qdisc\_match\_from\_root() parses to find a qdisc given its handle.
Fix first problem adding a TCQ\_F\_NOPARENT qdisc flag that
qdisc\_tree\_decrease\_qlen() can use to abort its tree traversal,
as soon as it meets a mq/mqprio qdisc children.
Second problem can be fixed by RCU protection.
Qdisc are already freed after RCU grace period, so qdisc\_list\_add() and
qdisc\_list\_del() simply have to use appropriate rcu list variants.
A future patch will add a per struct netdev\_queue list anchor, so that
qdisc\_tree\_decrease\_qlen() can have more efficient lookups.
Reported-by: Daniele Fucini
Signed-off-by: Eric Dumazet
Cc: Cong Wang
Cc: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bae56d7e3f815b339421306fc3b2e00107b56987
Author: Paolo Abeni
Date: Tue Dec 1 18:33:36 2015 +0100
openvswitch: fix hangup on vxlan/gre/geneve device deletion
[ Upstream commit 13175303024c8f4cd09e51079a8fcbbe572111ec ]
Each openvswitch tunnel vport (vxlan,gre,geneve) holds a reference
to the underlying tunnel device, but never released it when such
device is deleted.
Deleting the underlying device via the ip tool cause the kernel to
hangup in the netdev\_wait\_allrefs() loop.
This commit ensure that on device unregistration dp\_detach\_port\_notify()
is called for all vports that hold the device reference, properly
releasing it.
Fixes: 614732eaa12d ("openvswitch: Use regular VXLAN net\_device device")
Fixes: b2acd1dc3949 ("openvswitch: Use regular GRE net\_device instead of vport")
Fixes: 6b001e682e90 ("openvswitch: Use Geneve device.")
Signed-off-by: Paolo Abeni
Acked-by: Flavio Leitner
Acked-by: Pravin B Shelar
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7a439c4a677039b91804b6779de18ddab6d6ebf9
Author: Eric Dumazet
Date: Tue Dec 1 07:20:07 2015 -0800
ipv6: sctp: implement sctp\_v6\_destroy\_sock()
[ Upstream commit 602dd62dfbda3e63a2d6a3cbde953ebe82bf5087 ]
Dmitry Vyukov reported a memory leak using IPV6 SCTP sockets.
We need to call inet6\_destroy\_sock() to properly release
inet6 specific fields.
Reported-by: Dmitry Vyukov
Signed-off-by: Eric Dumazet
Acked-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a9c680b65484ecb6d1d257f761b2f04e1d9e2d6e
Author: Konstantin Khlebnikov
Date: Tue Dec 1 01:14:48 2015 +0300
net/neighbour: fix crash at dumping device-agnostic proxy entries
[ Upstream commit 6adc5fd6a142c6e2c80574c1db0c7c17dedaa42e ]
Proxy entries could have null pointer to net-device.
Signed-off-by: Konstantin Khlebnikov
Fixes: 84920c1420e2 ("net: Allow ipv6 proxies and arp proxies be shown with iproute2")
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 645e3f33c73ad1153db0680b6833cf70d0d4dce3
Author: Eric Dumazet
Date: Sun Nov 29 19:37:57 2015 -0800
ipv6: add complete rcu protection around np->opt
[ Upstream commit 45f6fad84cc305103b28d73482b344d7f5b76f39 ]
This patch addresses multiple problems :
UDP/RAW sendmsg() need to get a stable struct ipv6\_txoptions
while socket is not locked : Other threads can change np->opt
concurrently. Dmitry posted a syzkaller
(http://github.com/google/syzkaller) program desmonstrating
use-after-free.
Starting with TCP/DCCP lockless listeners, tcp\_v6\_syn\_recv\_sock()
and dccp\_v6\_request\_recv\_sock() also need to use RCU protection
to dereference np->opt once (before calling ipv6\_dup\_options())
This patch adds full RCU protection to np->opt
Reported-by: Dmitry Vyukov
Signed-off-by: Eric Dumazet
Acked-by: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 90d19ad685d03197418f5c8e970772192a032a87
Author: Daniel Borkmann
Date: Mon Nov 30 13:02:56 2015 +0100
bpf, array: fix heap out-of-bounds access when updating elements
[ Upstream commit fbca9d2d35c6ef1b323fae75cc9545005ba25097 ]
During own review but also reported by Dmitry's syzkaller [1] it has been
noticed that we trigger a heap out-of-bounds access on eBPF array maps
when updating elements. This happens with each map whose map->value\_size
(specified during map creation time) is not multiple of 8 bytes.
In array\_map\_alloc(), elem\_size is round\_up(attr->value\_size, 8) and
used to align array map slots for faster access. However, in function
array\_map\_update\_elem(), we update the element as ...
memcpy(array->value + array->elem\_size \* index, value, array->elem\_size);
... where we access 'value' out-of-bounds, since it was allocated from
map\_update\_elem() from syscall side as kmalloc(map->value\_size, GFP\_USER)
and later on copied through copy\_from\_user(value, uvalue, map->value\_size).
Thus, up to 7 bytes, we can access out-of-bounds.
Same could happen from within an eBPF program, where in worst case we
access beyond an eBPF program's designated stack.
Since 1be7f75d1668 ("bpf: enable non-root eBPF programs") didn't hit an
official release yet, it only affects priviledged users.
In case of array\_map\_lookup\_elem(), the verifier prevents eBPF programs
from accessing beyond map->value\_size through check\_map\_access(). Also
from syscall side map\_lookup\_elem() only copies map->value\_size back to
user, so nothing could leak.
[1] http://github.com/google/syzkaller
Fixes: 28fbcfa08d8e ("bpf: add array type of eBPF maps")
Reported-by: Dmitry Vyukov
Signed-off-by: Daniel Borkmann
Acked-by: Alexei Starovoitov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0eaa7b64f7c307249fc28f2a57ff20aa905910bb
Author: Quentin Casasnovas
Date: Tue Nov 24 17:13:21 2015 -0500
RDS: fix race condition when sending a message on unbound socket
[ Upstream commit 8c7188b23474cca017b3ef354c4a58456f68303a ]
Sasha's found a NULL pointer dereference in the RDS connection code when
sending a message to an apparently unbound socket. The problem is caused
by the code checking if the socket is bound in rds\_sendmsg(), which checks
the rs\_bound\_addr field without taking a lock on the socket. This opens a
race where rs\_bound\_addr is temporarily set but where the transport is not
in rds\_bind(), leading to a NULL pointer dereference when trying to
dereference 'trans' in \_\_rds\_conn\_create().
Vegard wrote a reproducer for this issue, so kindly ask him to share if
you're interested.
I cannot reproduce the NULL pointer dereference using Vegard's reproducer
with this patch, whereas I could without.
Complete earlier incomplete fix to CVE-2015-6937:
74e98eb08588 ("RDS: verify the underlying transport exists before creating a connection")
Cc: David S. Miller
Cc: stable@vger.kernel.org
Reviewed-by: Vegard Nossum
Reviewed-by: Sasha Levin
Acked-by: Santosh Shilimkar
Signed-off-by: Quentin Casasnovas
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit edd6db9dee45cdfd7b76f23ea513f5bab816c0bb
Author: Michal Kubeček
Date: Tue Nov 24 15:07:11 2015 +0100
ipv6: distinguish frag queues by device for multicast and link-local packets
[ Upstream commit 264640fc2c5f4f913db5c73fa3eb1ead2c45e9d7 ]
If a fragmented multicast packet is received on an ethernet device which
has an active macvlan on top of it, each fragment is duplicated and
received both on the underlying device and the macvlan. If some
fragments for macvlan are processed before the whole packet for the
underlying device is reassembled, the "overlapping fragments" test in
ip6\_frag\_queue() discards the whole fragment queue.
To resolve this, add device ifindex to the search key and require it to
match reassembling multicast packets and packets to link-local
addresses.
Note: similar patch has been already submitted by Yoshifuji Hideaki in
http://patchwork.ozlabs.org/patch/220979/
but got lost and forgotten for some reason.
Signed-off-by: Michal Kubecek
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 126bb499631ca8c61db5628bdaaa7294ae73d04f
Author: Ying Xue
Date: Tue Nov 24 13:57:57 2015 +0800
tipc: fix error handling of expanding buffer headroom
[ Upstream commit 7098356baca723513e97ca0020df4e18bc353be3 ]
Coverity says:
\*\*\* CID 1338065: Error handling issues (CHECKED\_RETURN)
/net/tipc/udp\_media.c: 162 in tipc\_udp\_send\_msg()
156 struct udp\_media\_addr \*dst = (struct udp\_media\_addr \*)&dest->value;
157 struct udp\_media\_addr \*src = (struct udp\_media\_addr \*)&b->addr.value;
158 struct sk\_buff \*clone;
159 struct rtable \*rt;
160
161 if (skb\_headroom(skb) < UDP\_MIN\_HEADROOM)
>>> CID 1338065: Error handling issues (CHECKED\_RETURN)
>>> Calling "pskb\_expand\_head" without checking return value (as is done elsewhere 51 out of 56
+times).
162 pskb\_expand\_head(skb, UDP\_MIN\_HEADROOM, 0, GFP\_ATOMIC);
163
164 clone = skb\_clone(skb, GFP\_ATOMIC);
165 skb\_set\_inner\_protocol(clone, htons(ETH\_P\_TIPC));
166 ub = rcu\_dereference\_rtnl(b->media\_ptr);
167 if (!ub) {
When expanding buffer headroom over udp tunnel with pskb\_expand\_head(),
it's unfortunate that we don't check its return value. As a result, if
the function returns an error code due to the lack of memory, it may
cause unpredictable consequence as we unconditionally consider that
it's always successful.
Fixes: e53567948f82 ("tipc: conditionally expand buffer headroom over udp tunnel")
Reported-by:
Cc: Stephen Hemminger
Signed-off-by: Ying Xue
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 309ef6d135b8d7baeb06afdea48e611bb16c9ee0
Author: Aaro Koskinen
Date: Sun Nov 22 01:08:54 2015 +0200
broadcom: fix PHY\_ID\_BCM5481 entry in the id table
[ Upstream commit 3c25a860d17b7378822f35d8c9141db9507e3beb ]
Commit fcb26ec5b18d ("broadcom: move all PHY\_ID's to header")
updated broadcom\_tbl to use PHY\_IDs, but incorrectly replaced 0x0143bca0
with PHY\_ID\_BCM5482 (making a duplicate entry, and completely omitting
the original). Fix that.
Fixes: fcb26ec5b18d ("broadcom: move all PHY\_ID's to header")
Signed-off-by: Aaro Koskinen
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b3abad339f8e268bb261e5844ab68b18a7797c29
Author: Nikolay Aleksandrov
Date: Sat Nov 21 19:46:19 2015 +0100
vrf: fix double free and memory corruption on register\_netdevice failure
[ Upstream commit 7f109f7cc37108cba7243bc832988525b0d85909 ]
When vrf's ->newlink is called, if register\_netdevice() fails then it
does free\_netdev(), but that's also done by rtnl\_newlink() so a second
free happens and memory gets corrupted, to reproduce execute the
following line a couple of times (1 - 5 usually is enough):
$ for i in `seq 1 5`; do ip link add vrf: type vrf table 1; done;
This works because we fail in register\_netdevice() because of the wrong
name "vrf:".
And here's a trace of one crash:
[ 28.792157] ------------[ cut here ]------------
[ 28.792407] kernel BUG at fs/namei.c:246!
[ 28.792608] invalid opcode: 0000 [#1] SMP
[ 28.793240] Modules linked in: vrf nfsd auth\_rpcgss oid\_registry
nfs\_acl nfs lockd grace sunrpc crct10dif\_pclmul crc32\_pclmul
crc32c\_intel qxl drm\_kms\_helper ttm drm aesni\_intel aes\_x86\_64 psmouse
glue\_helper lrw evdev gf128mul i2c\_piix4 ablk\_helper cryptd ppdev
parport\_pc parport serio\_raw pcspkr virtio\_balloon virtio\_console
i2c\_core acpi\_cpufreq button 9pnet\_virtio 9p 9pnet fscache ipv6 autofs4
ext4 crc16 mbcache jbd2 virtio\_blk virtio\_net sg sr\_mod cdrom
ata\_generic ehci\_pci uhci\_hcd ehci\_hcd e1000 usbcore usb\_common ata\_piix
libata virtio\_pci virtio\_ring virtio scsi\_mod floppy
[ 28.796016] CPU: 0 PID: 1148 Comm: ld-linux-x86-64 Not tainted
4.4.0-rc1+ #24
[ 28.796016] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),
BIOS 1.8.1-20150318\_183358- 04/01/2014
[ 28.796016] task: ffff8800352561c0 ti: ffff88003592c000 task.ti:
ffff88003592c000
[ 28.796016] RIP: 0010:[] []
putname+0x43/0x60
[ 28.796016] RSP: 0018:ffff88003592fe88 EFLAGS: 00010246
[ 28.796016] RAX: 0000000000000000 RBX: ffff8800352561c0 RCX:
0000000000000001
[ 28.796016] RDX: 0000000000000000 RSI: 0000000000000000 RDI:
ffff88003784f000
[ 28.796016] RBP: ffff88003592ff08 R08: 0000000000000001 R09:
0000000000000000
[ 28.796016] R10: 0000000000000000 R11: 0000000000000001 R12:
0000000000000000
[ 28.796016] R13: 000000000000047c R14: ffff88003784f000 R15:
ffff8800358c4a00
[ 28.796016] FS: 0000000000000000(0000) GS:ffff88003fc00000(0000)
knlGS:0000000000000000
[ 28.796016] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 28.796016] CR2: 00007ffd583bc2d9 CR3: 0000000035a99000 CR4:
00000000000406f0
[ 28.796016] Stack:
[ 28.796016] ffffffff8121045d ffffffff812102d3 ffff8800352561c0
ffff880035a91660
[ 28.796016] ffff8800008a9880 0000000000000000 ffffffff81a49940
00ffffff81218684
[ 28.796016] ffff8800352561c0 000000000000047c 0000000000000000
ffff880035b36d80
[ 28.796016] Call Trace:
[ 28.796016] [] ?
do\_execveat\_common.isra.34+0x74d/0x930
[ 28.796016] [] ?
do\_execveat\_common.isra.34+0x5c3/0x930
[ 28.796016] [] do\_execve+0x2c/0x30
[ 28.796016] []
call\_usermodehelper\_exec\_async+0xf0/0x140
[ 28.796016] [] ? umh\_complete+0x40/0x40
[ 28.796016] [] ret\_from\_fork+0x3f/0x70
[ 28.796016] Code: 48 8d 47 1c 48 89 e5 53 48 8b 37 48 89 fb 48 39 c6
74 1a 48 8b 3d 7e e9 8f 00 e8 49 fa fc ff 48 89 df e8 f1 01 fd ff 5b 5d
f3 c3 <0f> 0b 48 89 fe 48 8b 3d 61 e9 8f 00 e8 2c fa fc ff 5b 5d eb e9
[ 28.796016] RIP [] putname+0x43/0x60
[ 28.796016] RSP
Fixes: 193125dbd8eb ("net: Introduce VRF device driver")
Signed-off-by: Nikolay Aleksandrov
Acked-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4eb5e5c531d96b2397ad2b02fc5a496307b2e143
Author: Nikolay Aleksandrov
Date: Fri Nov 20 13:54:20 2015 +0100
net: ip6mr: fix static mfc/dev leaks on table destruction
[ Upstream commit 4c6980462f32b4f282c5d8e5f7ea8070e2937725 ]
Similar to ipv4, when destroying an mrt table the static mfc entries and
the static devices are kept, which leads to devices that can never be
destroyed (because of refcnt taken) and leaked memory. Make sure that
everything is cleaned up on netns destruction.
Fixes: 8229efdaef1e ("netns: ip6mr: enable namespace support in ipv6 multicast forwarding code")
CC: Benjamin Thery
Signed-off-by: Nikolay Aleksandrov
Reviewed-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 47f706657d85e1fbfb2e5ed8c7b90ff880bd4d6e
Author: Nikolay Aleksandrov
Date: Fri Nov 20 13:54:19 2015 +0100
net: ipmr: fix static mfc/dev leaks on table destruction
[ Upstream commit 0e615e9601a15efeeb8942cf7cd4dadba0c8c5a7 ]
When destroying an mrt table the static mfc entries and the static
devices are kept, which leads to devices that can never be destroyed
(because of refcnt taken) and leaked memory, for example:
unreferenced object 0xffff880034c144c0 (size 192):
comm "mfc-broken", pid 4777, jiffies 4320349055 (age 46001.964s)
hex dump (first 32 bytes):
98 53 f0 34 00 88 ff ff 98 53 f0 34 00 88 ff ff .S.4.....S.4....
ef 0a 0a 14 01 02 03 04 00 00 00 00 01 00 00 00 ................
backtrace:
[] kmemleak\_alloc+0x4e/0xb0
[] kmem\_cache\_alloc+0x190/0x300
[] ip\_mroute\_setsockopt+0x5cb/0x910
[] do\_ip\_setsockopt.isra.11+0x105/0xff0
[] ip\_setsockopt+0x30/0xa0
[] raw\_setsockopt+0x33/0x90
[] sock\_common\_setsockopt+0x14/0x20
[] SyS\_setsockopt+0x71/0xc0
[] entry\_SYSCALL\_64\_fastpath+0x16/0x7a
[] 0xffffffffffffffff
Make sure that everything is cleaned on netns destruction.
Signed-off-by: Nikolay Aleksandrov
Reviewed-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 609d60122e815cdad20f887de8d2d60d989ef2cb
Author: Daniel Borkmann
Date: Fri Nov 20 00:11:56 2015 +0100
net, scm: fix PaX detected msg\_controllen overflow in scm\_detach\_fds
[ Upstream commit 6900317f5eff0a7070c5936e5383f589e0de7a09 ]
David and HacKurx reported a following/similar size overflow triggered
in a grsecurity kernel, thanks to PaX's gcc size overflow plugin:
(Already fixed in later grsecurity versions by Brad and PaX Team.)
[ 1002.296137] PAX: size overflow detected in function scm\_detach\_fds net/core/scm.c:314
cicus.202\_127 min, count: 4, decl: msg\_controllen; num: 0; context: msghdr;
[ 1002.296145] CPU: 0 PID: 3685 Comm: scm\_rights\_recv Not tainted 4.2.3-grsec+ #7
[ 1002.296149] Hardware name: Apple Inc. MacBookAir5,1/Mac-66F35F19FE2A0D05, [...]
[ 1002.296153] ffffffff81c27366 0000000000000000 ffffffff81c27375 ffffc90007843aa8
[ 1002.296162] ffffffff818129ba 0000000000000000 ffffffff81c27366 ffffc90007843ad8
[ 1002.296169] ffffffff8121f838 fffffffffffffffc fffffffffffffffc ffffc90007843e60
[ 1002.296176] Call Trace:
[ 1002.296190] [] dump\_stack+0x45/0x57
[ 1002.296200] [] report\_size\_overflow+0x38/0x60
[ 1002.296209] [] scm\_detach\_fds+0x2ce/0x300
[ 1002.296220] [] unix\_stream\_read\_generic+0x609/0x930
[ 1002.296228] [] unix\_stream\_recvmsg+0x4f/0x60
[ 1002.296236] [] ? unix\_set\_peek\_off+0x50/0x50
[ 1002.296243] [] sock\_recvmsg+0x47/0x60
[ 1002.296248] [] \_\_\_sys\_recvmsg+0xe2/0x1e0
[ 1002.296257] [] \_\_sys\_recvmsg+0x46/0x80
[ 1002.296263] [] SyS\_recvmsg+0x2c/0x40
[ 1002.296271] [] entry\_SYSCALL\_64\_fastpath+0x12/0x85
Further investigation showed that this can happen when an \*odd\* number of
fds are being passed over AF\_UNIX sockets.
In these cases CMSG\_LEN(i \* sizeof(int)) and CMSG\_SPACE(i \* sizeof(int)),
where i is the number of successfully passed fds, differ by 4 bytes due
to the extra CMSG\_ALIGN() padding in CMSG\_SPACE() to an 8 byte boundary
on 64 bit. The padding is used to align subsequent cmsg headers in the
control buffer.
When the control buffer passed in from the receiver side \*lacks\* these 4
bytes (e.g. due to buggy/wrong API usage), then msg->msg\_controllen will
overflow in scm\_detach\_fds():
int cmlen = CMSG\_LEN(i \* sizeof(int)); <--- cmlen w/o tail-padding
err = put\_user(SOL\_SOCKET, &cm->cmsg\_level);
if (!err)
err = put\_user(SCM\_RIGHTS, &cm->cmsg\_type);
if (!err)
err = put\_user(cmlen, &cm->cmsg\_len);
if (!err) {
cmlen = CMSG\_SPACE(i \* sizeof(int)); <--- cmlen w/ 4 byte extra tail-padding
msg->msg\_control += cmlen;
msg->msg\_controllen -= cmlen; <--- iff no tail-padding space here ...
} ... wrap-around
F.e. it will wrap to a length of 18446744073709551612 bytes in case the
receiver passed in msg->msg\_controllen of 20 bytes, and the sender
properly transferred 1 fd to the receiver, so that its CMSG\_LEN results
in 20 bytes and CMSG\_SPACE in 24 bytes.
In case of MSG\_CMSG\_COMPAT (scm\_detach\_fds\_compat()), I haven't seen an
issue in my tests as alignment seems always on 4 byte boundary. Same
should be in case of native 32 bit, where we end up with 4 byte boundaries
as well.
In practice, passing msg->msg\_controllen of 20 to recvmsg() while receiving
a single fd would mean that on successful return, msg->msg\_controllen is
being set by the kernel to 24 bytes instead, thus more than the input
buffer advertised. It could f.e. become an issue if such application later
on zeroes or copies the control buffer based on the returned msg->msg\_controllen
elsewhere.
Maximum number of fds we can send is a hard upper limit SCM\_MAX\_FD (253).
Going over the code, it seems like msg->msg\_controllen is not being read
after scm\_detach\_fds() in scm\_recv() anymore by the kernel, good!
Relevant recvmsg() handler are unix\_dgram\_recvmsg() (unix\_seqpacket\_recvmsg())
and unix\_stream\_recvmsg(). Both return back to their recvmsg() caller,
and \_\_\_sys\_recvmsg() places the updated length, that is, new msg\_control -
old msg\_control pointer into msg->msg\_controllen (hence the 24 bytes seen
in the example).
Long time ago, Wei Yongjun fixed something related in commit 1ac70e7ad24a
("[NET]: Fix function put\_cmsg() which may cause usr application memory
overflow").
RFC3542, section 20.2. says:
The fields shown as "XX" are possible padding, between the cmsghdr
structure and the data, and between the data and the next cmsghdr
structure, if required by the implementation. While sending an
application may or may not include padding at the end of last
ancillary data in msg\_controllen and implementations must accept both
as valid. On receiving a portable application must provide space for
padding at the end of the last ancillary data as implementations may
copy out the padding at the end of the control message buffer and
include it in the received msg\_controllen. When recvmsg() is called
if msg\_controllen is too small for all the ancillary data items
including any trailing padding after the last item an implementation
may set MSG\_CTRUNC.
Since we didn't place MSG\_CTRUNC for already quite a long time, just do
the same as in 1ac70e7ad24a to avoid an overflow.
Btw, even man-page author got this wrong :/ See db939c9b26e9 ("cmsg.3: Fix
error in SCM\_RIGHTS code sample"). Some people must have copied this (?),
thus it got triggered in the wild (reported several times during boot by
David and HacKurx).
No Fixes tag this time as pre 2002 (that is, pre history tree).
Reported-by: David Sterba
Reported-by: HacKurx
Cc: PaX Team
Cc: Emese Revfy
Cc: Brad Spengler
Cc: Wei Yongjun
Cc: Eric Dumazet
Reviewed-by: Hannes Frederic Sowa
Signed-off-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b2d8d14ba2c37e3ff2d1267d4a32a32365859b8b
Author: Eric Dumazet
Date: Thu Nov 26 08:18:14 2015 -0800
tcp: initialize tp->copied\_seq in case of cross SYN connection
[ Upstream commit 142a2e7ece8d8ac0e818eb2c91f99ca894730e2a ]
Dmitry provided a syzkaller (http://github.com/google/syzkaller)
generated program that triggers the WARNING at
net/ipv4/tcp.c:1729 in tcp\_recvmsg() :
WARN\_ON(tp->copied\_seq != tp->rcv\_nxt &&
!(flags & (MSG\_PEEK | MSG\_TRUNC)));
His program is specifically attempting a Cross SYN TCP exchange,
that we support (for the pleasure of hackers ?), but it looks we
lack proper tcp->copied\_seq initialization.
Thanks again Dmitry for your report and testings.
Signed-off-by: Eric Dumazet
Reported-by: Dmitry Vyukov
Tested-by: Dmitry Vyukov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 11617ee108ae5bccaf3064d2304b8608874c85f9
Author: Eric Dumazet
Date: Wed Nov 18 21:03:33 2015 -0800
tcp: fix potential huge kmalloc() calls in TCP\_REPAIR
[ Upstream commit 5d4c9bfbabdb1d497f21afd81501e5c54b0c85d9 ]
tcp\_send\_rcvq() is used for re-injecting data into tcp receive queue.
Problems :
- No check against size is performed, allowed user to fool kernel in
attempting very large memory allocations, eventually triggering
OOM when memory is fragmented.
- In case of fault during the copy we do not return correct errno.
Lets use alloc\_skb\_with\_frags() to cook optimal skbs.
Fixes: 292e8d8c8538 ("tcp: Move rcvq sending to tcp\_input.c")
Fixes: c0e88ff0f256 ("tcp: Repair socket queues")
Signed-off-by: Eric Dumazet
Cc: Pavel Emelyanov
Acked-by: Pavel Emelyanov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6f5aa0f4aa406332521bde78e2b6290886f3961a
Author: Yuchung Cheng
Date: Wed Nov 18 18:17:30 2015 -0800
tcp: disable Fast Open on timeouts after handshake
[ Upstream commit 0e45f4da5981895e885dd72fe912a3f8e32bae73 ]
Some middle-boxes black-hole the data after the Fast Open handshake
(https://www.ietf.org/proceedings/94/slides/slides-94-tcpm-13.pdf).
The exact reason is unknown. The work-around is to disable Fast Open
temporarily after multiple recurring timeouts with few or no data
delivered in the established state.
Signed-off-by: Yuchung Cheng
Signed-off-by: Eric Dumazet
Reported-by: Christoph Paasch
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4ef5bc914bbd40811ebc0514d84175d303fb8b4f
Author: Eric Dumazet
Date: Wed Nov 18 12:40:13 2015 -0800
tcp: md5: fix lockdep annotation
[ Upstream commit 1b8e6a01e19f001e9f93b39c32387961c91ed3cc ]
When a passive TCP is created, we eventually call tcp\_md5\_do\_add()
with sk pointing to the child. It is not owner by the user yet (we
will add this socket into listener accept queue a bit later anyway)
But we do own the spinlock, so amend the lockdep annotation to avoid
following splat :
[ 8451.090932] net/ipv4/tcp\_ipv4.c:923 suspicious rcu\_dereference\_protected() usage!
[ 8451.090932]
[ 8451.090932] other info that might help us debug this:
[ 8451.090932]
[ 8451.090934]
[ 8451.090934] rcu\_scheduler\_active = 1, debug\_locks = 1
[ 8451.090936] 3 locks held by socket\_sockopt\_/214795:
[ 8451.090936] #0: (rcu\_read\_lock){.+.+..}, at: [] \_\_netif\_receive\_skb\_core+0x151/0xe90
[ 8451.090947] #1: (rcu\_read\_lock){.+.+..}, at: [] ip\_local\_deliver\_finish+0x43/0x2b0
[ 8451.090952] #2: (slock-AF\_INET){+.-...}, at: [] sk\_clone\_lock+0x1c5/0x500
[ 8451.090958]
[ 8451.090958] stack backtrace:
[ 8451.090960] CPU: 7 PID: 214795 Comm: socket\_sockopt\_
[ 8451.091215] Call Trace:
[ 8451.091216]  [] dump\_stack+0x55/0x76
[ 8451.091229] [] lockdep\_rcu\_suspicious+0xeb/0x110
[ 8451.091235] [] tcp\_md5\_do\_add+0x1bf/0x1e0
[ 8451.091239] [] tcp\_v4\_syn\_recv\_sock+0x1f1/0x4c0
[ 8451.091242] [] ? tcp\_v4\_md5\_hash\_skb+0x167/0x190
[ 8451.091246] [] tcp\_check\_req+0x3c8/0x500
[ 8451.091249] [] ? tcp\_v4\_inbound\_md5\_hash+0x11e/0x190
[ 8451.091253] [] tcp\_v4\_rcv+0x3c0/0x9f0
[ 8451.091256] [] ? ip\_local\_deliver\_finish+0x43/0x2b0
[ 8451.091260] [] ip\_local\_deliver\_finish+0xb6/0x2b0
[ 8451.091263] [] ? ip\_local\_deliver\_finish+0x43/0x2b0
[ 8451.091267] [] ip\_local\_deliver+0x48/0x80
[ 8451.091270] [] ip\_rcv\_finish+0x160/0x700
[ 8451.091273] [] ip\_rcv+0x29e/0x3d0
[ 8451.091277] [] \_\_netif\_receive\_skb\_core+0xb47/0xe90
Fixes: a8afca0329988 ("tcp: md5: protects md5sig\_info with RCU")
Signed-off-by: Eric Dumazet
Reported-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e8afa3cd3e6dfe713e0d7f8ca8062aea50a14725
Author: Bjørn Mork
Date: Wed Nov 18 21:13:07 2015 +0100
net: qmi\_wwan: add XS Stick W100-2 from 4G Systems
[ Upstream commit 68242a5a1e2edce39b069385cbafb82304eac0f1 ]
Thomas reports
"
4gsystems sells two total different LTE-surfsticks under the same name.
..
The newer version of XS Stick W100 is from "omega"
..
Under windows the driver switches to the same ID, and uses MI03\6 for
network and MI01\6 for modem.
..
echo "1c9e 9b01" > /sys/bus/usb/drivers/qmi\_wwan/new\_id
echo "1c9e 9b01" > /sys/bus/usb-serial/drivers/option1/new\_id
T: Bus=01 Lev=01 Prnt=01 Port=03 Cnt=01 Dev#= 4 Spd=480 MxCh= 0
D: Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs= 1
P: Vendor=1c9e ProdID=9b01 Rev=02.32
S: Manufacturer=USB Modem
S: Product=USB Modem
S: SerialNumber=
C: #Ifs= 5 Cfg#= 1 Atr=80 MxPwr=500mA
I: If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
I: If#= 1 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
I: If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
I: If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi\_wwan
I: If#= 4 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=usb-storage
Now all important things are there:
wwp0s29f7u2i3 (net), ttyUSB2 (at), cdc-wdm0 (qmi), ttyUSB1 (at)
There is also ttyUSB0, but it is not usable, at least not for at.
The device works well with qmi and ModemManager-NetworkManager.
"
Reported-by: Thomas Schäfer
Signed-off-by: Bjørn Mork
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d603fa768b63905317e9cf2cfb647ddff03d9715
Author: Paolo Abeni
Date: Wed Nov 18 16:40:19 2015 +0100
net/ip6\_tunnel: fix dst leak
[ Upstream commit 206b49500df558dbc15d8836b09f6397ec5ed8bb ]
the commit cdf3464e6c6b ("ipv6: Fix dst\_entry refcnt bugs in ip6\_tunnel")
introduced percpu storage for ip6\_tunnel dst cache, but while clearing
such cache it used raw\_cpu\_ptr to walk the per cpu entries, so cached
dst on non current cpu are not actually reset.
This patch replaces raw\_cpu\_ptr with per\_cpu\_ptr, properly cleaning
such storage.
Fixes: cdf3464e6c6b ("ipv6: Fix dst\_entry refcnt bugs in ip6\_tunnel")
Signed-off-by: Paolo Abeni
Acked-by: Martin KaFai Lau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3f7a8d274e209d0e5dba464618a78c37ec00e899
Author: Neil Horman
Date: Mon Nov 16 13:09:10 2015 -0500
snmp: Remove duplicate OUTMCAST stat increment
[ Upstream commit 41033f029e393a64e81966cbe34d66c6cf8a2e7e ]
the OUTMCAST stat is double incremented, getting bumped once in the mcast code
itself, and again in the common ip output path. Remove the mcast bump, as its
not needed
Validated by the reporter, with good results
Signed-off-by: Neil Horman
Reported-by: Claus Jensen
CC: Claus Jensen
CC: David Miller
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ce2ceca37c846767abceee497f8adbb3328a8dd9
Author: Pavel Fedin
Date: Mon Nov 16 17:51:34 2015 +0300
net: thunder: Check for driver data in nicvf\_remove()
[ Upstream commit 7750130d93decff06120df0d8ea024ff8a038a21 ]
In some cases the crash is caused by nicvf\_remove() being called from
outside. For example, if we try to feed the device to vfio after the
probe has failed for some reason. So, move the check to better place.
Signed-off-by: Pavel Fedin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5eceaad8488b24f98ada6d5dfd5a6ec2df875d07
Author: Dragos Tatulea
Date: Mon Nov 16 10:52:48 2015 +0100
net: switchdev: fix return code of fdb\_dump stub
[ Upstream commit 24cb7055a3066634a0f3fa0cd6a4780652905d35 ]
rtnl\_fdb\_dump always expects an index to be returned by the ndo\_fdb\_dump op,
but when CONFIG\_NET\_SWITCHDEV is off, it returns an error.
Fix that by returning the given unmodified idx.
A similar fix was 0890cf6cb6ab ("switchdev: fix return value of
switchdev\_port\_fdb\_dump in case of error") but for the CONFIG\_NET\_SWITCHDEV=y
case.
Fixes: 45d4122ca7cd ("switchdev: add support for fdb add/del/dump via switchdev\_port\_obj ops.")
Signed-off-by: Dragos Tatulea
Acked-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5c81f50e7fe60ed1d0820820df63f9193c6d5d0b
Author: Jason A. Donenfeld
Date: Thu Nov 12 17:35:58 2015 +0100
ip\_tunnel: disable preemption when updating per-cpu tstats
[ Upstream commit b4fe85f9c9146f60457e9512fb6055e69e6a7a65 ]
Drivers like vxlan use the recently introduced
udp\_tunnel\_xmit\_skb/udp\_tunnel6\_xmit\_skb APIs. udp\_tunnel6\_xmit\_skb
makes use of ip6tunnel\_xmit, and ip6tunnel\_xmit, after sending the
packet, updates the struct stats using the usual
u64\_stats\_update\_begin/end calls on this\_cpu\_ptr(dev->tstats).
udp\_tunnel\_xmit\_skb makes use of iptunnel\_xmit, which doesn't touch
tstats, so drivers like vxlan, immediately after, call
iptunnel\_xmit\_stats, which does the same thing - calls
u64\_stats\_update\_begin/end on this\_cpu\_ptr(dev->tstats).
While vxlan is probably fine (I don't know?), calling a similar function
from, say, an unbound workqueue, on a fully preemptable kernel causes
real issues:
[ 188.434537] BUG: using smp\_processor\_id() in preemptible [00000000] code: kworker/u8:0/6
[ 188.435579] caller is debug\_smp\_processor\_id+0x17/0x20
[ 188.435583] CPU: 0 PID: 6 Comm: kworker/u8:0 Not tainted 4.2.6 #2
[ 188.435607] Call Trace:
[ 188.435611] [] dump\_stack+0x4f/0x7b
[ 188.435615] [] check\_preemption\_disabled+0x19d/0x1c0
[ 188.435619] [] debug\_smp\_processor\_id+0x17/0x20
The solution would be to protect the whole
this\_cpu\_ptr(dev->tstats)/u64\_stats\_update\_begin/end blocks with
disabling preemption and then reenabling it.
Signed-off-by: Jason A. Donenfeld
Acked-by: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 289defb1e093535624376d7098c5364f8804fdc7
Author: Eran Ben Elisha
Date: Thu Nov 12 19:35:29 2015 +0200
net/mlx4\_core: Fix sleeping while holding spinlock at rem\_slave\_counters
[ Upstream commit f5adbfee72282bb1f456d52b04adacd4fe6ac502 ]
When cleaning slave's counter resources, we hold a spinlock that
protects the slave's counters list. As part of the clean, we call
\_\_mlx4\_clear\_if\_stat which calls mlx4\_alloc\_cmd\_mailbox which is a
sleepable function.
In order to fix this issue, hold the spinlock, and copy all counter
indices into a temporary array, and release the spinlock. Afterwards,
iterate over this array and free every counter. Repeat this scenario
until the original list is empty (a new counter might have been added
while releasing the counters from the temporary array).
Fixes: b72ca7e96acf ("net/mlx4\_core: Reset counters data when freed")
Reported-by: Moni Shoua
Tested-by: Moni Shoua
Signed-off-by: Jack Morgenstein
Signed-off-by: Eran Ben Elisha
Signed-off-by: Or Gerlitz
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 713a813ed2fab144e436a9a3e64445a441d9846d
Author: Tariq Toukan
Date: Thu Nov 12 19:35:26 2015 +0200
net/mlx5e: Added self loopback prevention
[ Upstream commit 66189961e986e53ae39822898fc2ce88f44c61bb ]
Prevent outgoing multicast frames from looping back to the RX queue.
By introducing new HW capability self\_lb\_en\_modifiable, which indicates
the support to modify self\_lb\_en bit in modify\_tir command.
When this capability is set we can prevent TIRs from sending back
loopback multicast traffic to their own RQs, by "refreshing TIRs" with
modify\_tir command, on every time new channels (SQs/RQs) are created at
device open.
This is needed since TIRs are static and only allocated once on driver
load, and the loopback decision is under their responsibility.
Fixes issues of the kind:
"IPv6: eth2: IPv6 duplicate address fe80::e61d:2dff:fe5c:f2e9 detected!"
The issue is seen since the IPv6 solicitations multicast messages are
loopedback and the network stack thinks they are coming from another host.
Fixes: 5c50368f3831 ("net/mlx5e: Light-weight netdev open/stop")
Signed-off-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Or Gerlitz
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 176cec782335b95d7830bce4a7e6a1fe0b644594
Author: lucien
Date: Thu Nov 12 13:07:07 2015 +0800
sctp: translate host order to network order when setting a hmacid
[ Upstream commit ed5a377d87dc4c87fb3e1f7f698cba38cd893103 ]
now sctp auth cannot work well when setting a hmacid manually, which
is caused by that we didn't use the network order for hmacid, so fix
it by adding the transformation in sctp\_auth\_ep\_set\_hmacs.
even we set hmacid with the network order in userspace, it still
can't work, because of this condition in sctp\_auth\_ep\_set\_hmacs():
if (id > SCTP\_AUTH\_HMAC\_ID\_MAX)
return -EOPNOTSUPP;
so this wasn't working before and thus it won't break compatibility.
Fixes: 65b07e5d0d09 ("[SCTP]: API updates to suport SCTP-AUTH extensions.")
Signed-off-by: Xin Long
Signed-off-by: Marcelo Ricardo Leitner
Acked-by: Neil Horman
Acked-by: Vlad Yasevich
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 377204f209fd51a24a359873ad44a97e4b5b72c8
Author: Daniel Borkmann
Date: Wed Nov 11 23:25:44 2015 +0100
packet: fix tpacket\_snd max frame len
[ Upstream commit 5cfb4c8d05b4409c4044cb9c05b19705c1d9818b ]
Since it's introduction in commit 69e3c75f4d54 ("net: TX\_RING and
packet mmap"), TX\_RING could be used from SOCK\_DGRAM and SOCK\_RAW
side. When used with SOCK\_DGRAM only, the size\_max > dev->mtu +
reserve check should have reserve as 0, but currently, this is
unconditionally set (in it's original form as dev->hard\_header\_len).
I think this is not correct since tpacket\_fill\_skb() would then
take dev->mtu and dev->hard\_header\_len into account for SOCK\_DGRAM,
the extra VLAN\_HLEN could be possible in both cases. Presumably, the
reserve code was copied from packet\_snd(), but later on missed the
check. Make it similar as we have it in packet\_snd().
Fixes: 69e3c75f4d54 ("net: TX\_RING and packet mmap")
Signed-off-by: Daniel Borkmann
Acked-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 263c8f423ade0e7bd72ea82e36da3a458fac1e30
Author: Daniel Borkmann
Date: Wed Nov 11 23:25:43 2015 +0100
packet: infer protocol from ethernet header if unset
[ Upstream commit c72219b75fde768efccf7666342282fab7f9e4e7 ]
In case no struct sockaddr\_ll has been passed to packet
socket's sendmsg() when doing a TX\_RING flush run, then
skb->protocol is set to po->num instead, which is the protocol
passed via socket(2)/bind(2).
Applications only xmitting can go the path of allocating the
socket as socket(PF\_PACKET, , 0) and do a bind(2) on the
TX\_RING with sll\_protocol of 0. That way, register\_prot\_hook()
is neither called on creation nor on bind time, which saves
cycles when there's no interest in capturing anyway.
That leaves us however with po->num 0 instead and therefore
the TX\_RING flush run sets skb->protocol to 0 as well. Eric
reported that this leads to problems when using tools like
trafgen over bonding device. I.e. the bonding's hash function
could invoke the kernel's flow dissector, which depends on
skb->protocol being properly set. In the current situation, all
the traffic is then directed to a single slave.
Fix it up by inferring skb->protocol from the Ethernet header
when not set and we have ARPHRD\_ETHER device type. This is only
done in case of SOCK\_RAW and where we have a dev->hard\_header\_len
length. In case of ARPHRD\_ETHER devices, this is guaranteed to
cover ETH\_HLEN, and therefore being accessed on the skb after
the skb\_store\_bits().
Reported-by: Eric Dumazet
Signed-off-by: Daniel Borkmann
Acked-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bbf14f8bb1041b5c11b9ccf998a075a03f04de3d
Author: Daniel Borkmann
Date: Wed Nov 11 23:25:42 2015 +0100
packet: only allow extra vlan len on ethernet devices
[ Upstream commit 3c70c132488794e2489ab045559b0ce0afcf17de ]
Packet sockets can be used by various net devices and are not
really restricted to ARPHRD\_ETHER device types. However, when
currently checking for the extra 4 bytes that can be transmitted
in VLAN case, our assumption is that we generally probe on
ARPHRD\_ETHER devices. Therefore, before looking into Ethernet
header, check the device type first.
This also fixes the issue where non-ARPHRD\_ETHER devices could
have no dev->hard\_header\_len in TX\_RING SOCK\_RAW case, and thus
the check would test unfilled linear part of the skb (instead
of non-linear).
Fixes: 57f89bfa2140 ("network: Allow af\_packet to transmit +4 bytes for VLAN packets.")
Fixes: 52f1454f629f ("packet: allow to transmit +4 byte in TX\_RING slot for VLAN case")
Signed-off-by: Daniel Borkmann
Acked-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6b4a14f4265267d8d1ff6b2465e0be19da0c256a
Author: Daniel Borkmann
Date: Wed Nov 11 23:25:41 2015 +0100
packet: always probe for transport header
[ Upstream commit 8fd6c80d9dd938ca338c70698533a7e304752846 ]
We concluded that the skb\_probe\_transport\_header() should better be
called unconditionally. Avoiding the call into the flow dissector has
also not really much to do with the direct xmit mode.
While it seems that only virtio\_net code makes use of GSO from non
RX/TX ring packet socket paths, we should probe for a transport header
nevertheless before they hit devices.
Reference: http://thread.gmane.org/gmane.linux.network/386173/
Signed-off-by: Daniel Borkmann
Acked-by: Jason Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1a43c235781426c2b4368bffb6478c379c4529aa
Author: Daniel Borkmann
Date: Wed Nov 11 23:25:40 2015 +0100
packet: do skb\_probe\_transport\_header when we actually have data
[ Upstream commit efdfa2f7848f64517008136fb41f53c4a1faf93a ]
In tpacket\_fill\_skb() commit c1aad275b029 ("packet: set transport
header before doing xmit") and later on 40893fd0fd4e ("net: switch
to use skb\_probe\_transport\_header()") was probing for a transport
header on the skb from a ring buffer slot, but at a time, where
the skb has \_not even\_ been filled with data yet. So that call into
the flow dissector is pretty useless. Lets do it after we've set
up the skb frags.
Fixes: c1aad275b029 ("packet: set transport header before doing xmit")
Reported-by: Eric Dumazet
Signed-off-by: Daniel Borkmann
Acked-by: Jason Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 55eabd378b2e07bc2b677f07fd142365be68cb2b
Author: Kamal Mostafa
Date: Wed Nov 11 14:24:27 2015 -0800
tools/net: Use include/uapi with \_\_EXPORTED\_HEADERS\_\_
[ Upstream commit d7475de58575c904818efa369c82e88c6648ce2e ]
Use the local uapi headers to keep in sync with "recently" added #define's
(e.g. SKF\_AD\_VLAN\_TPID). Refactored CFLAGS, and bpf\_asm doesn't need -I.
Fixes: 3f356385e8a4 ("filter: bpf\_asm: add minimal bpf asm tool")
Signed-off-by: Kamal Mostafa
Acked-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ea9b07516f19f4c6fc14697cb6c70bb9b74e3bfc
Author: Nicolas Dichtel
Date: Fri Nov 27 18:17:05 2015 +0100
Revert "ipv6: ndisc: inherit metadata dst when creating ndisc requests"
[ Upstream commit 304d888b29cf96f1dd53511ee686499cd8cdf249 ]
This reverts commit ab450605b35caa768ca33e86db9403229bf42be4.
In IPv6, we cannot inherit the dst of the original dst. ndisc packets
are IPv6 packets and may take another route than the original packet.
This patch breaks the following scenario: a packet comes from eth0 and
is forwarded through vxlan1. The encapsulated packet triggers an NS
which cannot be sent because of the wrong route.
CC: Jiri Benc
CC: Thomas Graf
Signed-off-by: Nicolas Dichtel
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4ab43ae83f90543998b1640fb2cb556ce1a604c0
Author: Martin KaFai Lau
Date: Wed Nov 11 11:51:08 2015 -0800
ipv6: Check rt->dst.from for the DST\_NOCACHE route
[ Upstrem commit 02bcf4e082e4dc634409a6a6cb7def8806d6e5e6 ]
All DST\_NOCACHE rt6\_info used to have rt->dst.from set to
its parent.
After commit 8e3d5be73681 ("ipv6: Avoid double dst\_free"),
DST\_NOCACHE is also set to rt6\_info which does not have
a parent (i.e. rt->dst.from is NULL).
This patch catches the rt->dst.from == NULL case.
Fixes: 8e3d5be73681 ("ipv6: Avoid double dst\_free")
Signed-off-by: Martin KaFai Lau
Cc: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit dd91a7e65f8008ac989d61131670949feec08d23
Author: Martin KaFai Lau
Date: Wed Nov 11 11:51:07 2015 -0800
ipv6: Check expire on DST\_NOCACHE route
[ Upstream commit 5973fb1e245086071bf71994c8b54d99526ded03 ]
Since the expires of the DST\_NOCACHE rt can be set during
the ip6\_rt\_update\_pmtu(), we also need to consider the expires
value when doing ip6\_dst\_check().
This patches creates \_\_rt6\_check\_expired() to only
check the expire value (if one exists) of the current rt.
In rt6\_dst\_from\_check(), it adds \_\_rt6\_check\_expired() as
one of the condition check.
Signed-off-by: Martin KaFai Lau
Cc: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fdaac6a92778b95ad41e65b6f9a88b454899d8d4
Author: Martin KaFai Lau
Date: Wed Nov 11 11:51:06 2015 -0800
ipv6: Avoid creating RTF\_CACHE from a rt that is not managed by fib6 tree
[ Upstream commit 0d3f6d297bfb7af24d0508460fdb3d1ec4903fa3 ]
The original bug report:
https://bugzilla.redhat.com/show\_bug.cgi?id=1272571
The setup has a IPv4 GRE tunnel running in a IPSec. The bug
happens when ndisc starts sending router solicitation at the gre
interface. The simplified oops stack is like:
\_\_lock\_acquire+0x1b2/0x1c30
lock\_acquire+0xb9/0x140
\_raw\_write\_lock\_bh+0x3f/0x50
\_\_ip6\_ins\_rt+0x2e/0x60
ip6\_ins\_rt+0x49/0x50
~~~~~~~~
\_\_ip6\_rt\_update\_pmtu.part.54+0x145/0x250
ip6\_rt\_update\_pmtu+0x2e/0x40
~~~~~~~~
ip\_tunnel\_xmit+0x1f1/0xf40
\_\_gre\_xmit+0x7a/0x90
ipgre\_xmit+0x15a/0x220
dev\_hard\_start\_xmit+0x2bd/0x480
\_\_dev\_queue\_xmit+0x696/0x730
dev\_queue\_xmit+0x10/0x20
neigh\_direct\_output+0x11/0x20
ip6\_finish\_output2+0x21f/0x770
ip6\_finish\_output+0xa7/0x1d0
ip6\_output+0x56/0x190
~~~~~~~~
ndisc\_send\_skb+0x1d9/0x400
ndisc\_send\_rs+0x88/0xc0
~~~~~~~~
The rt passed to ip6\_rt\_update\_pmtu() is created by
icmp6\_dst\_alloc() and it is not managed by the fib6 tree,
so its rt6i\_table == NULL. When \_\_ip6\_rt\_update\_pmtu() creates
a RTF\_CACHE clone, the newly created clone also has rt6i\_table == NULL
and it causes the ip6\_ins\_rt() oops.
During pmtu update, we only want to create a RTF\_CACHE clone
from a rt which is currently managed (or owned) by the
fib6 tree. It means either rt->rt6i\_node != NULL or
rt is a RTF\_PCPU clone.
It is worth to note that rt6i\_table may not be NULL even it is
not (yet) managed by the fib6 tree (e.g. addrconf\_dst\_alloc()).
Hence, rt6i\_node is a better check instead of rt6i\_table.
Fixes: 45e4fd26683c ("ipv6: Only create RTF\_CACHE routes after encountering pmtu")
Signed-off-by: Martin KaFai Lau
Reported-by: Chris Siebenmann
Cc: Chris Siebenmann
Cc: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 343f4f8c013a6e41ba51da7f00c3e5c95197fa59
Author: Hannes Frederic Sowa
Date: Thu Nov 26 12:08:18 2015 +0100
af-unix: passcred support for sendpage
[ Upstream commit 9490f886b192964796285907d777ff00fba1fa0f ]
sendpage did not care about credentials at all. This could lead to
situations in which because of fd passing between processes we could
append data to skbs with different scm data. It is illegal to splice those
skbs together. Instead we have to allocate a new skb and if requested
fill out the scm details.
Fixes: 869e7c62486ec ("net: af\_unix: implement stream sendpage support")
Reported-by: Al Viro
Cc: Al Viro
Cc: Eric Dumazet
Signed-off-by: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 58a6a46a036ce81a2a8ecaa6fc1537c894349e3f
Author: Rainer Weikusat
Date: Fri Nov 20 22:07:23 2015 +0000
unix: avoid use-after-free in ep\_remove\_wait\_queue
[ Upstream commit 7d267278a9ece963d77eefec61630223fce08c6c ]
Rainer Weikusat  writes:
An AF\_UNIX datagram socket being the client in an n:1 association with
some server socket is only allowed to send messages to the server if the
receive queue of this socket contains at most sk\_max\_ack\_backlog
datagrams. This implies that prospective writers might be forced to go
to sleep despite none of the message presently enqueued on the server
receive queue were sent by them. In order to ensure that these will be
woken up once space becomes again available, the present unix\_dgram\_poll
routine does a second sock\_poll\_wait call with the peer\_wait wait queue
of the server socket as queue argument (unix\_dgram\_recvmsg does a wake
up on this queue after a datagram was received). This is inherently
problematic because the server socket is only guaranteed to remain alive
for as long as the client still holds a reference to it. In case the
connection is dissolved via connect or by the dead peer detection logic
in unix\_dgram\_sendmsg, the server socket may be freed despite "the
polling mechanism" (in particular, epoll) still has a pointer to the
corresponding peer\_wait queue. There's no way to forcibly deregister a
wait queue with epoll.
Based on an idea by Jason Baron, the patch below changes the code such
that a wait\_queue\_t belonging to the client socket is enqueued on the
peer\_wait queue of the server whenever the peer receive queue full
condition is detected by either a sendmsg or a poll. A wake up on the
peer queue is then relayed to the ordinary wait queue of the client
socket via wake function. The connection to the peer wait queue is again
dissolved if either a wake up is about to be relayed or the client
socket reconnects or a dead peer is detected or the client socket is
itself closed. This enables removing the second sock\_poll\_wait from
unix\_dgram\_poll, thus avoiding the use-after-free, while still ensuring
that no blocked writer sleeps forever.
Signed-off-by: Rainer Weikusat
Fixes: ec0d215f9420 ("af\_unix: fix 'poll for write'/connected DGRAM sockets")
Reviewed-by: Jason Baron
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 26c04dfb4cfa10e6ed8cafd63313fef2be865fa0
Author: Hannes Frederic Sowa
Date: Tue Nov 17 15:10:59 2015 +0100
af\_unix: take receive queue lock while appending new skb
[ Upstream commit a3a116e04cc6a94d595ead4e956ab1bc1d2f4746 ]
While possibly in future we don't necessarily need to use
sk\_buff\_head.lock this is a rather larger change, as it affects the
af\_unix fd garbage collector, diag and socket cleanups. This is too much
for a stable patch.
For the time being grab sk\_buff\_head.lock without disabling bh and irqs,
so don't use locked skb\_queue\_tail.
Fixes: 869e7c62486e ("net: af\_unix: implement stream sendpage support")
Cc: Eric Dumazet
Signed-off-by: Hannes Frederic Sowa
Reported-by: Eric Dumazet
Acked-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a78f42950a48ed4f4721b29eb228d709ac91af9b
Author: Hannes Frederic Sowa
Date: Mon Nov 16 16:25:56 2015 +0100
af\_unix: don't append consumed skbs to sk\_receive\_queue
[ Upstream commit 8844f97238ca6c1ca92a5d6c69f53efd361a266f ]
In case multiple writes to a unix stream socket race we could end up in a
situation where we pre-allocate a new skb for use in unix\_stream\_sendpage
but have to free it again in the locked section because another skb
has been appended meanwhile, which we must use. Accidentally we didn't
clear the pointer after consuming it and so we touched freed memory
while appending it to the sk\_receive\_queue. So, clear the pointer after
consuming the skb.
This bug has been found with syzkaller
(http://github.com/google/syzkaller) by Dmitry Vyukov.
Fixes: 869e7c62486e ("net: af\_unix: implement stream sendpage support")
Reported-by: Dmitry Vyukov
Cc: Dmitry Vyukov
Cc: Eric Dumazet
Signed-off-by: Hannes Frederic Sowa
Acked-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 382c8e80e40bcadb90ba1a156f522f7b5a22109f
Author: Hannes Frederic Sowa
Date: Tue Nov 10 16:23:15 2015 +0100
af-unix: fix use-after-free with concurrent readers while splicing
[ Upstream commit 73ed5d25dce0354ea381d6dc93005c3085fae03d ]
During splicing an af-unix socket to a pipe we have to drop all
af-unix socket locks. While doing so we allow another reader to enter
unix\_stream\_read\_generic which can read, copy and finally free another
skb. If exactly this skb is just in process of being spliced we get a
use-after-free report by kasan.
First, we must make sure to not have a free while the skb is used during
the splice operation. We simply increment its use counter before unlocking
the reader lock.
Stream sockets have the nice characteristic that we don't care about
zero length writes and they never reach the peer socket's queue. That
said, we can take the UNIXCB.consumed field as the indicator if the
skb was already freed from the socket's receive queue. If the skb was
fully consumed after we locked the reader side again we know it has been
dropped by a second reader. We indicate a short read to user space and
abort the current splice operation.
This bug has been found with syzkaller
(http://github.com/google/syzkaller) by Dmitry Vyukov.
Fixes: 2b514574f7e8 ("net: af\_unix: implement splice for stream af\_unix sockets")
Reported-by: Dmitry Vyukov
Cc: Dmitry Vyukov
Cc: Eric Dumazet
Acked-by: Eric Dumazet
Signed-off-by: Hannes Frederic Sowa
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 808e146b0ae32eb615e048c3b87016fcad3dd500
Author: françois romieu
Date: Wed Nov 11 23:35:18 2015 +0100
r8169: fix kasan reported skb use-after-free.
[ Upstream commit 39174291d8e8acfd1113214a943263aaa03c57c8 ]
Signed-off-by: Francois Romieu
Reported-by: Dave Jones
Fixes: d7d2d89d4b0af ("r8169: Add software counter for multicast packages")
Acked-by: Eric Dumazet
Acked-by: Corinna Vinschen
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bfa97da9146ac6b41f9b749e7dfd0921eeff9170
Author: Paul Gortmaker
Date: Wed Oct 21 14:04:47 2015 +0100
certs: add .gitignore to stop git nagging about x509\_certificate\_list
commit 48dbc164b40dd9195dea8cd966e394819e420b64 upstream.
Currently we see this in "git status" if we build in the source dir:
Untracked files:
(use "git add ..." to include in what will be committed)
certs/x509\_certificate\_list
It looks like it used to live in kernel/ so we squash that .gitignore
entry at the same time. I didn't bother to dig through git history to
see when it moved, since it is just a minor annoyance at most.
Cc: David Woodhouse
Cc: keyrings@linux-nfs.org
Signed-off-by: Paul Gortmaker
Signed-off-by: David Howells
Signed-off-by: Greg Kroah-Hartman


=== Content from git.kernel.org_da052c41_20250126_032008.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=6934da9238da947628be83635e365df41064b09b)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6934da9238da947628be83635e365df41064b09b)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6934da9238da947628be83635e365df41064b09b)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6934da9238da947628be83635e365df41064b09b)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Czerner <lczerner@redhat.com> | 2015-10-17 22:57:06 -0400 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2015-10-17 22:57:06 -0400 |
| commit | [6934da9238da947628be83635e365df41064b09b](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6934da9238da947628be83635e365df41064b09b) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=6934da9238da947628be83635e365df41064b09b)) | |
| tree | [a7d5770b2fbd3961c40b6bb2da86873dcfab19c0](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6934da9238da947628be83635e365df41064b09b) | |
| parent | [33d14975e5ac469963d5d63856b61698ad0bff07](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=33d14975e5ac469963d5d63856b61698ad0bff07) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6934da9238da947628be83635e365df41064b09b&id2=33d14975e5ac469963d5d63856b61698ad0bff07)) | |
| download | [linux-6934da9238da947628be83635e365df41064b09b.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-6934da9238da947628be83635e365df41064b09b.tar.gz) | |

ext4: fix potential use after free in \_\_ext4\_journal\_stopThere is a use-after-free possibility in \_\_ext4\_journal\_stop() in the
case that we free the handle in the first jbd2\_journal\_stop() because
we're referencing handle->h\_err afterwards. This was introduced in
9705acd63b125dee8b15c705216d7186daea4625 and it is wrong. Fix it by
storing the handle->h\_err value beforehand and avoid referencing
potentially freed handle.
Fixes: 9705acd63b125dee8b15c705216d7186daea4625
Signed-off-by: Lukas Czerner <lczerner@redhat.com>
Reviewed-by: Andreas Dilger <adilger@dilger.ca>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6934da9238da947628be83635e365df41064b09b)

| -rw-r--r-- | [fs/ext4/ext4\_jbd2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/ext4_jbd2.c?id=6934da9238da947628be83635e365df41064b09b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/fs/ext4/ext4\_jbd2.c b/fs/ext4/ext4\_jbd2.cindex d4184318181878..e770c1ee4613ed 100644--- a/[fs/ext4/ext4\_jbd2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/ext4_jbd2.c?id=33d14975e5ac469963d5d63856b61698ad0bff07)+++ b/[fs/ext4/ext4\_jbd2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/ext4_jbd2.c?id=6934da9238da947628be83635e365df41064b09b)@@ -88,13 +88,13 @@ int \_\_ext4\_journal\_stop(const char \*where, unsigned int line, handle\_t \*handle) return 0; } + err = handle->h\_err; if (!handle->h\_transaction) {- err = jbd2\_journal\_stop(handle);- return handle->h\_err ? handle->h\_err : err;+ rc = jbd2\_journal\_stop(handle);+ return err ? err : rc; }  sb = handle->h\_transaction->t\_journal->j\_private;- err = handle->h\_err; rc = jbd2\_journal\_stop(handle);  if (!err) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-26 03:18:46 +0000



=== Content from source.android.com_5f9dbd78_20250124_202448.html ===


[![Android Open Source Project](https://www.gstatic.com/devrel-devsite/prod/v2c0608cfe9941cacf4435921a2ece588be3719df069d9fba67130a84e4743128/androidsource/images/lockup.svg)](/)

`/`

* English
* Deutsch
* Español
* Español – América Latina
* Français
* Indonesia
* Italiano
* Polski
* Português
* Português – Brasil
* Tiếng Việt
* Türkçe
* Русский
* עברית
* العربيّة
* فارسی
* हिंदी
* বাংলা
* ภาษาไทย
* 中文 – 简体
* 中文 – 繁體
* 日本語
* 한국어

[Android Code Search](https://cs.android.com/android/platform/superproject/main)
Sign in

* [Documentation](https://source.android.com/docs)

[What's New?](https://source.android.com/docs/whatsnew)

[Getting Started](https://source.android.com/docs/setup)

[Security](https://source.android.com/docs/security)

[Core Topics](https://source.android.com/docs/core)

[Compatibility](https://source.android.com/docs/compatibility)

[Android Devices](https://source.android.com/docs/devices)

[Automotive](https://source.android.com/docs/automotive)

[Reference](https://source.android.com/reference)

[![Android Open Source Project](https://www.gstatic.com/devrel-devsite/prod/v2c0608cfe9941cacf4435921a2ece588be3719df069d9fba67130a84e4743128/androidsource/images/lockup.svg)](/)

* [Docs](/docs)
  + More
  + [What's New?](/docs/whatsnew)
  + [Getting Started](/docs/setup)
  + [Security](/docs/security)
  + [Core Topics](/docs/core)
  + [Compatibility](/docs/compatibility)
  + [Android Devices](/docs/devices)
  + [Automotive](/docs/automotive)
  + [Reference](/reference)
* [Android Code Search](https://cs.android.com/android/platform/superproject/main)

* [Overview](/docs/security)
* Security overview
  + [Secure an Android device](/docs/security/overview)
  + [Kernel security](/docs/security/overview/kernel-security)
  + [App security](/docs/security/overview/app-security)
  + [Implement security](/docs/security/overview/implement)
  + [Updates and resources](/docs/security/overview/updates-resources)
  + [ASPIRE](/docs/security/overview/aspire)
  + [Reports](/docs/security/overview/reports)
  + [Enhancements](/docs/security/enhancements)
  + [Acknowledgements](/docs/security/overview/acknowledgements)
* Android Security Bulletins
  + [Bulletins home](/docs/security/bulletin)
  + [Overview](/docs/security/bulletin/asb-overview)
  + 2025 bulletins
    - [January](/docs/security/bulletin/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/2024-12-01)
    - [November](/docs/security/bulletin/2024-11-01)
    - [October](/docs/security/bulletin/2024-10-01)
    - [September](/docs/security/bulletin/2024-09-01)
    - [August](/docs/security/bulletin/2024-08-01)
    - [July](/docs/security/bulletin/2024-07-01)
    - [June](/docs/security/bulletin/2024-06-01)
    - [May](/docs/security/bulletin/2024-05-01)
    - [April](/docs/security/bulletin/2024-04-01)
    - [March](/docs/security/bulletin/2024-03-01)
    - [February](/docs/security/bulletin/2024-02-01)
    - [January](/docs/security/bulletin/2024-01-01)
    - [Android 15](/docs/security/bulletin/android-15)
  + 2023 bulletins
    - [December](/docs/security/bulletin/2023-12-01)
    - [November](/docs/security/bulletin/2023-11-01)
    - [October](/docs/security/bulletin/2023-10-01)
    - [September](/docs/security/bulletin/2023-09-01)
    - [August](/docs/security/bulletin/2023-08-01)
    - [July](/docs/security/bulletin/2023-07-01)
    - [June](/docs/security/bulletin/2023-06-01)
    - [May](/docs/security/bulletin/2023-05-01)
    - [April](/docs/security/bulletin/2023-04-01)
    - [March](/docs/security/bulletin/2023-03-01)
    - [February](/docs/security/bulletin/2023-02-01)
    - [January](/docs/security/bulletin/2023-01-01)
    - [Android 14](/docs/security/bulletin/android-14)
  + 2022 bulletins
    - [December](/docs/security/bulletin/2022-12-01)
    - [November](/docs/security/bulletin/2022-11-01)
    - [October](/docs/security/bulletin/2022-10-01)
    - [September](/docs/security/bulletin/2022-09-01)
    - [August](/docs/security/bulletin/2022-08-01)
    - [July](/docs/security/bulletin/2022-07-01)
    - [June](/docs/security/bulletin/2022-06-01)
    - [May](/docs/security/bulletin/2022-05-01)
    - [April](/docs/security/bulletin/2022-04-01)
    - [March](/docs/security/bulletin/2022-03-01)
    - [Android 12L](/docs/security/bulletin/android-12l)
    - [February](/docs/security/bulletin/2022-02-01)
    - [January](/docs/security/bulletin/2022-01-01)
    - [Android 13](/docs/security/bulletin/android-13)
    - [Index](/docs/security/bulletin/2022)
  + 2021 bulletins
    - [December](/docs/security/bulletin/2021-12-01)
    - [November](/docs/security/bulletin/2021-11-01)
    - [October](/docs/security/bulletin/2021-10-01)
    - [September](/docs/security/bulletin/2021-09-01)
    - [August](/docs/security/bulletin/2021-08-01)
    - [July](/docs/security/bulletin/2021-07-01)
    - [June](/docs/security/bulletin/2021-06-01)
    - [May](/docs/security/bulletin/2021-05-01)
    - [April](/docs/security/bulletin/2021-04-01)
    - [March](/docs/security/bulletin/2021-03-01)
    - [February](/docs/security/bulletin/2021-02-01)
    - [January](/docs/security/bulletin/2021-01-01)
    - [Android 12](/docs/security/bulletin/android-12)
    - [Index](/docs/security/bulletin/2021)
  + 2020 bulletins
    - [December](/docs/security/bulletin/2020-12-01)
    - [November](/docs/security/bulletin/2020-11-01)
    - [October](/docs/security/bulletin/2020-10-01)
    - [September](/docs/security/bulletin/2020-09-01)
    - [August](/docs/security/bulletin/2020-08-01)
    - [July](/docs/security/bulletin/2020-07-01)
    - [June](/docs/security/bulletin/2020-06-01)
    - [May](/docs/security/bulletin/2020-05-01)
    - [April](/docs/security/bulletin/2020-04-01)
    - [March](/docs/security/bulletin/2020-03-01)
    - [February](/docs/security/bulletin/2020-02-01)
    - [January](/docs/security/bulletin/2020-01-01)
    - [Android 11](/docs/security/bulletin/android-11)
    - [Index](/docs/security/bulletin/2020)
  + 2019 bulletins
    - [December](/docs/security/bulletin/2019-12-01)
    - [November](/docs/security/bulletin/2019-11-01)
    - [October](/docs/security/bulletin/2019-10-01)
    - [September](/docs/security/bulletin/2019-09-01)
    - [August](/docs/security/bulletin/2019-08-01)
    - [July](/docs/security/bulletin/2019-07-01)
    - [June](/docs/security/bulletin/2019-06-01)
    - [May](/docs/security/bulletin/2019-05-01)
    - [April](/docs/security/bulletin/2019-04-01)
    - [March](/docs/security/bulletin/2019-03-01)
    - [February](/docs/security/bulletin/2019-02-01)
    - [January](/docs/security/bulletin/2019-01-01)
    - [Android 10](/docs/security/bulletin/android-10)
    - [Index](/docs/security/bulletin/2019)
  + 2018 bulletins
    - [December](/docs/security/bulletin/2018-12-01)
    - [November](/docs/security/bulletin/2018-11-01)
    - [October](/docs/security/bulletin/2018-10-01)
    - [September](/docs/security/bulletin/2018-09-01)
    - [August](/docs/security/bulletin/2018-08-01)
    - [July](/docs/security/bulletin/2018-07-01)
    - [June](/docs/security/bulletin/2018-06-01)
    - [May](/docs/security/bulletin/2018-05-01)
    - [April](/docs/security/bulletin/2018-04-01)
    - [March](/docs/security/bulletin/2018-03-01)
    - [February](/docs/security/bulletin/2018-02-01)
    - [January](/docs/security/bulletin/2018-01-01)
    - [Index](/docs/security/bulletin/2018)
  + 2017 bulletins
    - [December](/docs/security/bulletin/2017-12-01)
    - [November](/docs/security/bulletin/2017-11-01)
    - [October](/docs/security/bulletin/2017-10-01)
    - [September](/docs/security/bulletin/2017-09-01)
    - [August](/docs/security/bulletin/2017-08-01)
    - [July](/docs/security/bulletin/2017-07-01)
    - [June](/docs/security/bulletin/2017-06-01)
    - [May](/docs/security/bulletin/2017-05-01)
    - [April](/docs/security/bulletin/2017-04-01)
    - [March](/docs/security/bulletin/2017-03-01)
    - [February](/docs/security/bulletin/2017-02-01)
    - [January](/docs/security/bulletin/2017-01-01)
    - [Index](/docs/security/bulletin/2017)
  + 2016 bulletins
    - [December](/docs/security/bulletin/2016-12-01)
    - [November](/docs/security/bulletin/2016-11-01)
    - [October](/docs/security/bulletin/2016-10-01)
    - [September](/docs/security/bulletin/2016-09-01)
    - [August](/docs/security/bulletin/2016-08-01)
    - [July](/docs/security/bulletin/2016-07-01)
    - [June](/docs/security/bulletin/2016-06-01)
    - [May](/docs/security/bulletin/2016-05-01)
    - [April](/docs/security/bulletin/2016-04-02)
    - [March](/docs/security/bulletin/2016-03-01)
    - [February](/docs/security/bulletin/2016-02-01)
    - [January](/docs/security/bulletin/2016-01-01)
    - [Index](/docs/security/bulletin/2016)
  + 2015 bulletins
    - [December](/docs/security/bulletin/2015-12-01)
    - [November](/docs/security/bulletin/2015-11-01)
    - [October](/docs/security/bulletin/2015-10-01)
    - [September](/docs/security/bulletin/2015-09-01)
    - [August](/docs/security/bulletin/2015-08-01)
    - [Index](/docs/security/bulletin/2015)
  + Pixel/Nexus bulletins
  + [Overview](/docs/security/bulletin/pixel)
  + 2025 bulletins
    - [January](/docs/security/bulletin/pixel/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/pixel/2024-12-01)
    - [November](/docs/security/bulletin/pixel/2024-11-01)
    - [October](/docs/security/bulletin/pixel/2024-10-01)
    - [September](/docs/security/bulletin/pixel/2024-09-01)
    - [August](/docs/security/bulletin/pixel/2024-08-01)
    - [July](/docs/security/bulletin/pixel/2024-07-01)
    - [June](/docs/security/bulletin/pixel/2024-06-01)
    - [May](/docs/security/bulletin/pixel/2024-05-01)
    - [April](/docs/security/bulletin/pixel/2024-04-01)
    - [March](/docs/security/bulletin/pixel/2024-03-01)
    - [February](/docs/security/bulletin/pixel/2024-02-01)
    - [January](/docs/security/bulletin/pixel/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/pixel/2023-12-01)
    - [November](/docs/security/bulletin/pixel/2023-11-01)
    - [October](/docs/security/bulletin/pixel/2023-10-01)
    - [September](/docs/security/bulletin/pixel/2023-09-01)
    - [August](/docs/security/bulletin/pixel/2023-08-01)
    - [July](/docs/security/bulletin/pixel/2023-07-01)
    - [June](/docs/security/bulletin/pixel/2023-06-01)
    - [May](/docs/security/bulletin/pixel/2023-05-01)
    - [April](/docs/security/bulletin/pixel/2023-04-01)
    - [March](/docs/security/bulletin/pixel/2023-03-01)
    - [February](/docs/security/bulletin/pixel/2023-02-01)
    - [January](/docs/security/bulletin/pixel/2023-01-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/pixel/2022-12-01)
    - [November](/docs/security/bulletin/pixel/2022-11-01)
    - [October](/docs/security/bulletin/pixel/2022-10-01)
    - [September](/docs/security/bulletin/pixel/2022-09-01)
    - [August](/docs/security/bulletin/pixel/2022-08-01)
    - [July](/docs/security/bulletin/pixel/2022-07-01)
    - [June](/docs/security/bulletin/pixel/2022-06-01)
    - [May](/docs/security/bulletin/pixel/2022-05-01)
    - [April](/docs/security/bulletin/pixel/2022-04-01)
    - [March](/docs/security/bulletin/pixel/2022-03-01)
    - [February](/docs/security/bulletin/pixel/2022-02-01)
    - [January](/docs/security/bulletin/pixel/2022-01-01)
  + 2021 bulletins
    - [December](/docs/security/bulletin/pixel/2021-12-01)
    - [November](/docs/security/bulletin/pixel/2021-11-01)
    - [October](/docs/security/bulletin/pixel/2021-10-01)
    - [September](/docs/security/bulletin/pixel/2021-09-01)
    - [August](/docs/security/bulletin/pixel/2021-08-01)
    - [July](/docs/security/bulletin/pixel/2021-07-01)
    - [June](/docs/security/bulletin/pixel/2021-06-01)
    - [May](/docs/security/bulletin/pixel/2021-05-01)
    - [April](/docs/security/bulletin/pixel/2021-04-01)
    - [March](/docs/security/bulletin/pixel/2021-03-01)
    - [February](/docs/security/bulletin/pixel/2021-02-01)
    - [January](/docs/security/bulletin/pixel/2021-01-01)
    - [Index](/docs/security/bulletin/pixel/2021)
  + 2020 bulletins
    - [December](/docs/security/bulletin/pixel/2020-12-01)
    - [November](/docs/security/bulletin/pixel/2020-11-01)
    - [October](/docs/security/bulletin/pixel/2020-10-01)
    - [September](/docs/security/bulletin/pixel/2020-09-01)
    - [August](/docs/security/bulletin/pixel/2020-08-01)
    - [July](/docs/security/bulletin/pixel/2020-07-01)
    - [June](/docs/security/bulletin/pixel/2020-06-01)
    - [May](/docs/security/bulletin/pixel/2020-05-01)
    - [April](/docs/security/bulletin/pixel/2020-04-01)
    - [March](/docs/security/bulletin/pixel/2020-03-01)
    - [February](/docs/security/bulletin/pixel/2020-02-01)
    - [January](/docs/security/bulletin/pixel/2020-01-01)
    - [Index](/docs/security/bulletin/pixel/2020)
  + 2019 bulletins
    - [December](/docs/security/bulletin/pixel/2019-12-01)
    - [November](/docs/security/bulletin/pixel/2019-11-01)
    - [October](/docs/security/bulletin/pixel/2019-10-01)
    - [September](/docs/security/bulletin/pixel/2019-09-01)
    - [August](/docs/security/bulletin/pixel/2019-08-01)
    - [July](/docs/security/bulletin/pixel/2019-07-01)
    - [June](/docs/security/bulletin/pixel/2019-06-01)
    - [May](/docs/security/bulletin/pixel/2019-05-01)
    - [April](/docs/security/bulletin/pixel/2019-04-01)
    - [March](/docs/security/bulletin/pixel/2019-03-01)
    - [February](/docs/security/bulletin/pixel/2019-02-01)
    - [January](/docs/security/bulletin/pixel/2019-01-01)
    - [Index](/docs/security/bulletin/pixel/2019)
  + 2018 bulletins
    - [December](/docs/security/bulletin/pixel/2018-12-01)
    - [November](/docs/security/bulletin/pixel/2018-11-01)
    - [October](/docs/security/bulletin/pixel/2018-10-01)
    - [September](/docs/security/bulletin/pixel/2018-09-01)
    - [August](/docs/security/bulletin/pixel/2018-08-01)
    - [July](/docs/security/bulletin/pixel/2018-07-01)
    - [June](/docs/security/bulletin/pixel/2018-06-01)
    - [May](/docs/security/bulletin/pixel/2018-05-01)
    - [April](/docs/security/bulletin/pixel/2018-04-01)
    - [March](/docs/security/bulletin/pixel/2018-03-01)
    - [February](/docs/security/bulletin/pixel/2018-02-01)
    - [January](/docs/security/bulletin/pixel/2018-01-01)
    - [Index](/docs/security/bulletin/pixel/2018)
  + 2017 bulletins
    - [December](/docs/security/bulletin/pixel/2017-12-01)
    - [November](/docs/security/bulletin/pixel/2017-11-01)
    - [October](/docs/security/bulletin/pixel/2017-10-01)
    - [Index](/docs/security/bulletin/pixel/2017)
  + Android Automotive
  + [Overview](/docs/security/bulletin/aaos)
  + 2025 bulletins
    - [January](/docs/security/bulletin/aaos/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/aaos/2024-12-01)
    - [November](/docs/security/bulletin/aaos/2024-11-01)
    - [October](/docs/security/bulletin/aaos/2024-10-01)
    - [September](/docs/security/bulletin/aaos/2024-09-01)
    - [August](/docs/security/bulletin/aaos/2024-08-01)
    - [July](/docs/security/bulletin/aaos/2024-07-01)
    - [June](/docs/security/bulletin/aaos/2024-06-01)
    - [May](/docs/security/bulletin/aaos/2024-05-01)
    - [April](/docs/security/bulletin/aaos/2024-04-01)
    - [March](/docs/security/bulletin/aaos/2024-03-01)
    - [February](/docs/security/bulletin/aaos/2024-02-01)
    - [January](/docs/security/bulletin/aaos/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/aaos/2023-12-01)
    - [November](/docs/security/bulletin/aaos/2023-11-01)
    - [October](/docs/security/bulletin/aaos/2023-10-01)
    - [September](/docs/security/bulletin/aaos/2023-09-01)
    - [August](/docs/security/bulletin/aaos/2023-08-01)
    - [July](/docs/security/bulletin/aaos/2023-07-01)
    - [June](/docs/security/bulletin/aaos/2023-06-01)
    - [May](/docs/security/bulletin/aaos/2023-05-01)
    - [April](/docs/security/bulletin/aaos/2023-04-01)
    - [March](/docs/security/bulletin/aaos/2023-03-01)
    - [February](/docs/security/bulletin/aaos/2023-02-01)
    - [January](/docs/security/bulletin/aaos/2023-01-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/aaos/2022-12-01)
    - [November](/docs/security/bulletin/aaos/2022-11-01)
    - [October](/docs/security/bulletin/aaos/2022-10-01)
    - [September](/docs/security/bulletin/aaos/2022-09-01)
    - [August](/docs/security/bulletin/aaos/2022-08-01)
    - [July](/docs/security/bulletin/aaos/2022-07-01)
    - [June](/docs/security/bulletin/aaos/2022-06-01)
    - [May](/docs/security/bulletin/aaos/2022-05-01)
    - [April](/docs/security/bulletin/aaos/2022-04-01)
    - [March](/docs/security/bulletin/aaos/2022-03-01)
    - [February](/docs/security/bulletin/aaos/2022-02-01)
    - [January](/docs/security/bulletin/aaos/2022-01-01)
  + 2021 bulletins
    - [December](/docs/security/bulletin/aaos/2021-12-01)
    - [November](/docs/security/bulletin/aaos/2021-11-01)
    - [October](/docs/security/bulletin/aaos/2021-10-01)
    - [September](/docs/security/bulletin/aaos/2021-09-01)
    - [August](/docs/security/bulletin/aaos/2021-08-01)
    - [July](/docs/security/bulletin/aaos/2021-07-01)
    - [June](/docs/security/bulletin/aaos/2021-06-01)
    - [May](/docs/security/bulletin/aaos/2021-05-01)
    - [April](/docs/security/bulletin/aaos/2021-04-01)
    - [March](/docs/security/bulletin/aaos/2021-03-01)
    - [February](/docs/security/bulletin/aaos/2021-02-01)
    - [January](/docs/security/bulletin/aaos/2021-01-01)
  + Chromecast
  + [Overview](/docs/security/bulletin/chromecast)
  + 2024 bulletins
    - [December](/docs/security/bulletin/chromecast/2024-12-01)
    - [September](/docs/security/bulletin/chromecast/2024-09-01)
    - [July](/docs/security/bulletin/chromecast/2024-07-01)
    - [March](/docs/security/bulletin/chromecast/2024-03-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/chromecast/2023-12-01)
    - [September](/docs/security/bulletin/chromecast/2023-07-01)
    - [June](/docs/security/bulletin/chromecast/2023-06-01)
    - [April](/docs/security/bulletin/chromecast/2023-04-01)
  + 2022 bulletins
    - [December](/docs/security/bulletin/chromecast/2022-12-01)
    - [October](/docs/security/bulletin/chromecast/2022-10-01)
    - [July](/docs/security/bulletin/chromecast/2022-07-01)
  + Wear
  + [Overview](/docs/security/bulletin/wear)
  + 2025 bulletins
    - [January](/docs/security/bulletin/wear/2025/2025-01-01)
  + 2024 bulletins
    - [December](/docs/security/bulletin/wear/2024/2024-12-01)
    - [November](/docs/security/bulletin/wear/2024/2024-11-01)
    - [October](/docs/security/bulletin/wear/2024/2024-10-01)
    - [September](/docs/security/bulletin/wear/2024/2024-09-01)
    - [August](/docs/security/bulletin/wear/2024/2024-08-01)
    - [July](/docs/security/bulletin/wear/2024/2024-07-01)
    - [June](/docs/security/bulletin/wear/2024/2024-06-01)
    - [May](/docs/security/bulletin/wear/2024/2024-05-01)
    - [April](/docs/security/bulletin/wear/2024/2024-04-01)
    - [March](/docs/security/bulletin/wear/2024/2024-03-01)
    - [February](/docs/security/bulletin/wear/2024/2024-02-01)
    - [January](/docs/security/bulletin/wear/2024/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/wear/2023/2023-12-01)
    - [November](/docs/security/bulletin/wear/2023/2023-11-01)
    - [October](/docs/security/bulletin/wear/2023/2023-10-01)
    - [September](/docs/security/bulletin/wear/2023/2023-09-01)
    - [August](/docs/security/bulletin/wear/2023/2023-08-01)
  + Pixel Watch
  + [Overview](/docs/security/bulletin/pixel-watch)
  + 2024 bulletins
    - [December](/docs/security/bulletin/pixel-watch/2024-12-01)
    - [August](/docs/security/bulletin/pixel-watch/2024-08-01)
    - [July](/docs/security/bulletin/pixel-watch/2024-07-01)
    - [June](/docs/security/bulletin/pixel-watch/2024-06-01)
    - [May](/docs/security/bulletin/pixel-watch/2024-05-01)
    - [April](/docs/security/bulletin/pixel-watch/2024-04-01)
    - [March](/docs/security/bulletin/pixel-watch/2024-03-01)
    - [February](/docs/security/bulletin/pixel-watch/2024-02-01)
    - [January](/docs/security/bulletin/pixel-watch/2024-01-01)
  + 2023 bulletins
    - [December](/docs/security/bulletin/pixel-watch/2023/2023-12-01)
    - [September](/docs/security/bulletin/pixel-watch/2023/2023-09-01)
    - [June](/docs/security/bulletin/pixel-watch/2023/2023-06-01)
  + Advisories
  + [Overview](/docs/security/bulletin/advisory)
  + [March 2016](/docs/security/bulletin/advisory/2016-03-18)
* Features
  + [Overview](/docs/security/features)
  + [Application Sandbox](/docs/security/app-sandbox)
  + [OMAPI vendor stable interface](/docs/security/features/open-mobile-api)
  + App signing
    - [Overview](/docs/security/features/apksigning)
    - [APK signature scheme v2](/docs/security/features/apksigning/v2)
    - [APK signature scheme v3](/docs/security/features/apksigning/v3)
    - [APK signature scheme v3.1](/docs/security/features/apksigning/v3-1)
    - [APK signature scheme v4](/docs/security/features/apksigning/v4)
  + Authentication
    - [Overview](/docs/security/features/authentication)
    - [Gatekeeper](/docs/security/features/authentication/gatekeeper)
    - Biometrics
      * [Overview](/docs/security/features/biometric)
      * [Measure biometric security](/docs/security/features/biometric/measure)
      * [Fingerprint HIDL](/docs/security/features/authentication/fingerprint-hal)
      * [Face authentication HIDL](/docs/security/features/biometric/face-authentication)
    - Protected confirmation
      * [Overview](/docs/security/features/protected-confirmation)
      * [Implementation](/docs/security/features/protected-confirmation/implementation)
      * [Design guidelines](/docs/security/features/protected-confirmation/design)
      * [Accessibility](/docs/security/features/protected-confirmation/accessibility)
  + DICE
    - [Overview](/docs/security/features/dice)
    - [Applications of DICE](/docs/security/features/dice/applications-of-dice)
  + Encryption
    - [Overview](/docs/security/features/encryption)
    - [File-based encryption](/docs/security/features/encryption/file-based)
    - [Full-disk encryption](/docs/security/features/encryption/full-disk)
    - [Metadata encryption](/docs/security/features/encryption/metadata)
    - [Enable Adiantum](/docs/security/features/encryption/adiantum)
    - [Hardware-wrapped keys](/docs/security/features/encryption/hw-wrapped-keys)
  + Keystore
    - [Overview](/docs/security/features/keystore)
    - [Features](/docs/security/features/keystore/features)
    - [Key and ID attestation](/docs/security/features/keystore/attestation)
    - [Version binding](/docs/security/features/keystore/version-binding)
    - [Authorization tags](/docs/security/features/keystore/tags)
    - [Functions](/docs/security/features/keystore/implementer-ref)
  + Identity credential
    - [Overview](/docs/security/features/identity-credentials)
  + SELinux
    - [Overview](/docs/security/features/selinux)
    - [Concepts](/docs/security/features/selinux/concepts)
    - [Implementation](/docs/security/features/selinux/implement)
    - [Customization](/docs/security/features/selinux/customize)
    - [Build sepolicy](/docs/security/features/selinux/build)
    - [Compatibility](/docs/security/features/selinux/compatibility)
    - [Validation](/docs/security/features/selinux/validate)
    - [Write policy](/docs/security/features/selinux/device-policy)
    - [Vendor init](/docs/security/features/selinux/vendor-init)
  + Trusty TEE
    - [Overview](/docs/security/features/trusty)
    - [Download and build](/docs/security/features/trusty/download-and-build)
    - [Trusty API reference](/docs/security/features/trusty/trusty-ref)
  + Verified Boot
    - [Overview](/docs/security/features/verifiedboot)
    - [Device state](/docs/security/features/verifiedboot/device-state)
    - [Verify Boot](/docs/security/features/verifiedboot/verified-boot)
    - [Boot flow](/docs/security/features/verifiedboot/boot-flow)
    - [Implement dm-verity](/docs/security/features/verifiedboot/dm-verity)
    - [Verify system\_other partition](/docs/security/features/verifiedboot/verify-system-other-partition)
    - [Reference implementation](/docs/security/features/verifiedboot/avb)
  + Safety Center
    - [Overview](/docs/security/safety-center/overview)
    - [Customize Safety Center](/docs/security/safety-center/customize)
    - [Customize Safety Center UI](/docs/security/safety-center/customize-ui)
    - [Interact with Safety Center](/docs/security/safety-center/interact)
    - [Testing and validation](/docs/security/safety-center/test-requirements)
  + Cellular security
    - [Overview](/docs/security/features/cellular-security/overview)
    - [Disable 2G](/docs/security/features/cellular-security/disable-2g)
  + [Private space](/docs/security/features/private-space)
* Testing
  + [Overview](/docs/security/test/fuzz-sanitize)
  + [Memory safety](/docs/security/test/memory-safety)
  + Arm Memory Tagging Extension
  + [Overview](/docs/security/test/memory-safety/arm-mte)
  + [Bootloader support](/docs/security/test/memory-safety/bootloader-support)
  + [Understand MTE reports](/docs/security/test/memory-safety/mte-reports)
  + [MTE configuration](/docs/security/test/memory-safety/mte-configuration)
  + Sanitizers
  + [Overview](/docs/security/test/sanitizers)
  + [AddressSanitizer](/docs/security/test/asan)
  + [Kernel AddressSanitizer](/docs/security/test/kasan)
  + [Hardware-assisted AddressSanitizer](/docs/security/test/hwasan)
  + [Understand HWASan reports](/docs/security/test/memory-safety/hwasan-reports)
  + [UndefinedBehaviorSanitizer](/docs/security/test/ubsan)
  + Other topics
  + [Control flow integrity](/docs/security/test/cfi)
  + [Kernel control flow integrity](/docs/security/test/kcfi)
  + [Execute-only memory](/docs/security/test/execute-only-memory)
  + [Fuzz with libFuzzer](/docs/security/test/libfuzzer)
  + [GWP-ASan and KFENCE](/docs/security/test/memory-safety/gwp-asan-kfence)
  + [Security Test Suite development kit](/docs/security/test/sts-sdk)
  + [Scudo](/docs/security/test/scudo)
  + [ShadowCallStack](/docs/security/test/shadow-call-stack)
  + [Tagged pointers](/docs/security/test/tagged-pointers)
  + [Zero initialized memory](/docs/security/test/memory-safety/zero-initialized-memory)
* Best practices
  + [Overview](/docs/security/best-practices)
  + [Operational security](/docs/security/best-practices/ops)
  + [System security](/docs/security/best-practices/system)
  + [App security](/docs/security/best-practices/app)
  + [Network security](/docs/security/best-practices/network)
  + [Hardware security](/docs/security/best-practices/hardware)
  + [Privacy security](/docs/security/best-practices/privacy)

* What's new?
* [Release notes](/docs/whatsnew/release-notes)
* [Latest security bulletins](/docs/whatsnew/latest-security-bulletins)
* [Latest Compatibility Definition Document (CDD)](/docs/whatsnew/latest-cdd)
* [Site updates](/docs/whatsnew/site-updates)
* Getting Started
* [About](/docs/setup/about)
* [Start](/docs/setup/start)
* [Download](/docs/setup/download)
* [Build](/docs/setup/build)
* [Test](/docs/setup/test)
* [Create](/docs/setup/create/coding-tasks)
* [Contribute](/docs/setup/contribute)
* [Community](/docs/setup/community/cofc)
* [Tools, build, and related reference](/docs/setup/reference)
* Security
* [Overview](/docs/security/overview)
* [Bulletins](/docs/security/bulletin)
* [Features](/docs/security/features)
* [Testing](/docs/security/test/fuzz-sanitize)
* [Best Practices](/docs/security/best-practices)
* Core Topics
* [Architecture](/docs/core/architecture)
* [Audio](/docs/core/audio)
* [Camera](/docs/core/camera)
* [Connectivity](/docs/core/connect)
* [Data](/docs/core/data)
* [Display](/docs/core/display)
* [Fonts](/docs/core/fonts/custom-font-fallback)
* [Graphics](/docs/core/graphics)
* [Interaction](/docs/core/interaction)
* [Media](/docs/core/media)
* [Performance](/docs/core/perf)
* [Permissions](/docs/core/permissions)
* [Power](/docs/core/power)
* [Runtime](/docs/core/runtime)
* [Settings](/docs/core/settings)
* [Storage](/docs/core/storage)
* [Tests](/docs/core/tests)
* [Updates](/docs/core/ota)
* [Virtualization](/docs/core/virtualization)
* Compatibility
* [Compatibility Definition Document (CDD)](/docs/compatibility/cdd)
* [Compatibility Test Suite (CTS)](/docs/compatibility/cts)
* Android Devices
* [Cuttlefish](/docs/devices/cuttlefish)
* [Enterprise](/docs/devices/admin)
* [TV](/docs/devices/tv)
* Automotive
* [Get Started](/docs/automotive/start/what_automotive)
* [Guidelines for Development](/docs/automotive/guidelines)
* [Development Tools](/docs/automotive/dev-tools)
* [Testing Tools and Infrastructure](/docs/automotive/tools)
* [Release Details](/docs/automotive/start/releases)
* Reference
* [HIDL](/reference/hidl)
* [HAL](/reference/hal)
* [Trade Federation](/reference/tradefed/classes)
* [Security Test Suite](/reference/sts/classes)

* [AOSP](https://source.android.com/)
* [Security](https://source.android.com/docs/security)

# Android Security Bulletin—November 2016

Stay organized with collections

Save and categorize content based on your preferences.

*Published November 07, 2016 | Updated December 21, 2016*

The Android Security Bulletin contains details of security vulnerabilities
affecting Android devices. Alongside the bulletin, we have released a security
update to Google devices through an over-the-air (OTA) update. The Google device
firmware images have also been released to the
[Google Developer
site](https://developers.google.com/android/nexus/images). Security patch levels of November 06, 2016 or later address all of
these issues. Refer to the
[Pixel
and Nexus update schedule](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices) to learn how to check a device's security patch level.

Partners were notified of the issues described in the bulletin on October 20,
2016 or earlier. Where applicable, source code patches for these issues have
been released to the Android Open Source Project (AOSP) repository. This
bulletin also includes links to patches outside of AOSP.

The most severe of these issues is a Critical security vulnerability that could
enable remote code execution on an affected device through multiple methods such
as email, web browsing, and MMS when processing media files. The
[severity
assessment](/docs/security/overview/updates-resources#severity) is based on the effect that exploiting the vulnerability would
possibly have on an affected device, assuming the platform and service
mitigations are disabled for development purposes or if successfully bypassed.

We have had no reports of active customer exploitation or abuse of these newly
reported issues. Refer to the
[Android and Google service
mitigations](#mitigations) section for details on the
[Android
security platform protections](/docs/security/enhancements) and service protections such as
[SafetyNet](https://developer.android.com/training/safetynet/index.html),
which improve the security of the Android platform.

We encourage all customers to accept these updates to their devices.

## Announcements

* With the introduction of the Pixel and Pixel XL devices, the term for
  [all devices supported by Google](#google-devices) is
  "Google devices" instead of "Nexus devices."
* This bulletin has three security patch levels to provide Android partners
  with the flexibility to more quickly fix a subset of vulnerabilities that are
  similar across all Android devices. See
  [Common questions and answers](#common-questions-and-answers) for
  additional information:
  + **2016-11-01**: Partial security patch level. This security
    patch level indicates that all issues associated with 2016-11-01 (and all
    previous security patch level) are addressed.
  + **2016-11-05**: Complete security patch level. This security
    patch level indicates that all issues associated with 2016-11-01 and 2016-11-05
    (and all previous security patch levels) are addressed.
  + **Supplemental security patch levels**

    Supplemental security patch levels are provided to identify devices
    that contain fixes for issues that were publicly disclosed after the
    patch level was defined. Addressing these recently disclosed
    vulnerabilities is not required until the 2016-12-01 security patch level.

    - **2016-11-06**: This security patch level indicates that the
      device has addressed all issues associated with 2016-11-05 and CVE-2016-5195,
      which was publicly disclosed on October 19, 2016.
* Supported Google devices will receive a single OTA update with the November
  05, 2016 security patch level.

## Android and Google service mitigations

This is a summary of the mitigations provided by the
[Android
security platform](/docs/security/enhancements) and service protections, such as SafetyNet. These
capabilities reduce the likelihood that security vulnerabilities could be
successfully exploited on Android.

* Exploitation for many issues on Android is made more difficult by
  enhancements in newer versions of the Android platform. We encourage all users
  to update to the latest version of Android where possible.
* The Android Security team actively monitors for abuse with
  [Verify
  Apps and SafetyNet](/static/docs/security/overview/reports/Google_Android_Security_2015_Report_Final.pdf), which are designed to warn users about
  [Potentially
  Harmful Applications](http://static.googleusercontent.com/media/source.android.com/en//security/reports/Google_Android_Security_PHA_classifications.pdf). Verify Apps is enabled by default on devices with
  [Google Mobile Services](http://www.android.com/gms) and is especially
  important for users who install applications from outside of Google Play. Device
  rooting tools are prohibited within Google Play, but Verify Apps warns users
  when they attempt to install a detected rooting application—no matter where it
  comes from. Additionally, Verify Apps attempts to identify and block
  installation of known malicious applications that exploit a privilege escalation
  vulnerability. If such an application has already been installed, Verify Apps
  will notify the user and attempt to remove the detected application.
* As appropriate, Google Hangouts and Messenger applications do not
  automatically pass media to processes such as Mediaserver.

## Acknowledgements

We would like to thank these researchers for their contributions:

* Abhishek Arya, Oliver Chang, and Martin Barbella of Google Chrome Security
  Team: CVE-2016-6722
* Andrei Kapishnikov and Miriam Gershenson of Google: CVE-2016-6703
* Ao Wang ([@ArayzSegment](https://twitter.com/ArayzSegment)) and
  [Zinuo Han](http://weibo.com/ele7enxxh) of
  [PKAV](http://www.pkav.net), Silence Information Technology:
  CVE-2016-6700, CVE-2016-6702
* Askyshang of Security Platform Department, Tencent: CVE-2016-6713
* Billy Lau of Android Security: CVE-2016-6737
* Constantinos Patsakis and
  Efthimios Alepis of University of Piraeus:
  CVE-2016-6715
* dragonltx of Alibaba mobile security team: CVE-2016-6714
* Gal Beniamini of Project Zero: CVE-2016-6707, CVE-2016-6717
* Gengjia Chen ([@chengjia4574](http://twitter.com/chengjia4574))
  and [pjf](http://weibo.com/jfpan) of IceSword Lab,
  [Qihoo 360 Technology Co. Ltd](http://www.360.com).: CVE-2016-6725,
  CVE-2016-6738, CVE-2016-6740, CVE-2016-6741, CVE-2016-6742, CVE-2016-6744,
  CVE-2016-6745, CVE-2016-3906
* Guang Gong (龚广) ([@oldfresher](http://twitter.com/oldfresher)) of
  Alpha Team, [Qihoo 360 Technology Co. Ltd](http://www.360.com).:
  CVE-2016-6754
* Jianqiang Zhao ([@jianqiangzhao](http://twitter.com/jianqiangzhao)) and
  [pjf](http://weibo.com/jfpan) of IceSword Lab,
  [Qihoo 360 Technology Co. Ltd](http://www.360.com).: CVE-2016-6739,
  CVE-2016-3904, CVE-2016-3907, CVE-2016-6698
* Marco Grassi ([@marcograss](http://twitter.com/marcograss)) of
  Keen Lab of Tencent ([@keen\_lab](http://twitter.com/keen_lab)):
  CVE-2016-6828
* Mark Brand of Project Zero: CVE-2016-6706
* Mark Renouf of Google: CVE-2016-6724
* Michał Bednarski ([github.com/michalbednarski](https://github.com/michalbednarski)):
  CVE-2016-6710
* Min Chong of Android Security: CVE-2016-6743
* Peter Pi ([@heisecode](http://twitter.com/heisecode)) of Trend
  Micro: CVE-2016-6721
* Qidan He (何淇丹) ([@flanker\_hqd](http://twitter.com/flanker_hqd))
  and Gengming Liu (刘耕铭) ([@dmxcsnsbh](http://twitter.com/dmxcsnsbh))
  of KeenLab, Tencent: CVE-2016-6705
* Robin Lee of Google: CVE-2016-6708
* Scott Bauer ([@ScottyBauer1](http://twitter.com/ScottyBauer1)): CVE-2016-6751
* Sergey Bobrov ([@Black2Fan](http://twitter.com/Black2Fan)) of
  Kaspersky Lab: CVE-2016-6716
* Seven Shen ([@lingtongshen](http://twitter.com/lingtongshen)) of
  Trend Micro Mobile Threat Research Team: CVE-2016-6748, CVE-2016-6749,
  CVE-2016-6750, CVE-2016-6753
* Victor van der Veen, Herbert Bos, Kaveh Razavi, and Cristiano Giuffrida of
  Vrije Universiteit Amsterdam and Yanick Fratantonio, Martina Lindorfer, and
  Giovanni Vigna of University of California, Santa Barbara: CVE-2016-6728
* Weichao Sun ([@sunblate](https://twitter.com/sunblate)) of
  Alibaba Inc: CVE-2016-6712, CVE-2016-6699, CVE-2016-6711
* Wenke Dou (vancouverdou@gmail.com), Chiachih Wu
  ([@chiachih\_wu](https://twitter.com/chiachih_wu)), and Xuxian Jiang
  of [C0RE Team](http://c0reteam.org): CVE-2016-6720
* Wish Wu (吴潍浠) ([@wish\_wu](http://twitter.com/wish_wu)) of Trend
  Micro Inc.: CVE-2016-6704
* Yakov Shafranovich of
  [Nightwatch Cybersecurity](https://wwws.nightwatchcybersecurity.com):
  CVE-2016-6723
* Yuan-Tsung Lo,
  Yao Jun,
  Tong Lin, Chiachih Wu ([@chiachih\_wu](https://twitter.com/chiachih_wu)), and Xuxian Jiang of
  [C0RE Team](http://c0reteam.org): CVE-2016-6730, CVE-2016-6732,
  CVE-2016-6734, CVE-2016-6736
* Yuan-Tsung Lo,
  Yao Jun,
  Xiaodong Wang, Chiachih Wu ([@chiachih\_wu](https://twitter.com/chiachih_wu)), and Xuxian Jiang of
  [C0RE Team](http://c0reteam.org): CVE-2016-6731, CVE-2016-6733,
  CVE-2016-6735, CVE-2016-6746

Additional thanks to Zach Riggle of Android Security for his contributions
to several issues in this bulletin.

## 2016-11-01 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities that apply to the 2016-11-01 patch level. There is a description of
the issue, a severity rationale, and a table with the CVE, associated
references, severity, updated Google devices, updated AOSP versions (where
applicable), and date reported. When available, we will link the public change
that addressed the issue to the bug ID, like the AOSP change list. When multiple
changes relate to a single bug, additional references are linked to numbers
following the bug ID.

### Remote code execution vulnerability in Mediaserver

A remote code execution vulnerability in Mediaserver could enable an attacker
using a specially crafted file to cause memory corruption during media file and
data processing. This issue is rated as Critical due to the possibility of
remote code execution within the context of the Mediaserver process.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6699 | [A-31373622](https://android.googlesource.com/platform/frameworks/av/%2B/3b1c9f692c4d4b7a683c2b358fc89e831a641b88) | Critical | All | 7.0 | Jul 27, 2016 |

### Elevation of privilege vulnerability in libzipfile

An elevation of privilege vulnerability in libzipfile could enable a local
malicious application to execute arbitrary code within the context of a
privileged process. This issue is rated as Critical due to the possibility of a
local permanent device compromise, which may require reflashing the operating
system to repair the device.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6700 | A-30916186 | Critical | None\* | 4.4.4, 5.0.2, 5.1.1 | Aug 17, 2016 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Remote code execution vulnerability in Skia

A remote code execution vulnerability in libskia could enable an attacker using
a specially crafted file to cause memory corruption during media file and data
processing. This issue is rated as High due to the possibility of remote code
execution within the context of the gallery process.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6701 | [A-30190637](https://android.googlesource.com/platform/external/skia/%2B/aca73722873e908633ff27375f6f93a08cbb7dd3) | High | All | 7.0 | Google internal |

### Remote code execution vulnerability in libjpeg

A remote code execution vulnerability in libjpeg could enable an attacker using
a specially crafted file to execute arbitrary code in the context of an
unprivileged process. This issue is rated as High due to the possibility of
remote code execution in an application that uses libjpeg.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6702 | A-30259087 | High | None\* | 4.4.4, 5.0.2, 5.1.1 | Jul 19, 2016 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Remote code execution vulnerability in Android runtime

A remote code execution vulnerability in an Android runtime library could enable
an attacker using a specially crafted payload to execute arbitrary code in the
context of an unprivileged process. This issue is rated as High due to the
possibility of remote code execution in an application that uses the Android
runtime.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6703 | A-30765246 | High | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Google internal |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in Mediaserver

An elevation of privilege vulnerability in Mediaserver could enable a local
malicious application to execute arbitrary code within the context of a
privileged process. This issue is rated as High because it could be used to gain
local access to elevated capabilities, which are not normally accessible to a
third-party application.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6704 | [A-30229821](https://android.googlesource.com/platform/frameworks/av/%2B/c6c446f9e022adf20064e65a17574804f8af8e7d) [[2](https://android.googlesource.com/platform/hardware/qcom/audio/%2B/9cb9810ecb63c8ff55ecf4bc77431dc5b0688b5f)] [[3](https://android.googlesource.com/platform/system/media/%2B/a6274f03b4dfe1c3a22af51e3a17ea56a314e747)] | High | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Jul 19, 2016 |
| CVE-2016-6705 | [A-30907212](https://android.googlesource.com/platform/frameworks/av/%2B/3a03fa24d21f97e84e796ac5ef14b3f434c0e8f1) [[2](https://android.googlesource.com/platform/frameworks/av/%2B/bd04b47d38a89f1dada1c6da2ef4a3d235c166b8)] | High | All | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Aug 16, 2016 |
| CVE-2016-6706 | [A-31385713](https://android.googlesource.com/platform/frameworks/av/%2B/1d4feebdb85db46e138530f360d9ff2490e14353) | High | All | 7.0 | Sep 8, 2016 |

### Elevation of privilege vulnerability in System Server

An elevation of privilege vulnerability in System Server could enable a local
malicious application to execute arbitrary code within the context of a
privileged process. This issue is rated as High because it could be used to gain
local access to elevated capabilities, which are not normally accessible to a
third-party application.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6707 | [A-31350622](https://android.googlesource.com/platform/frameworks/base/%2B/16024ea7c4bae08c972cf6b3734029aad33e8870) | High | All | 6.0, 6.0.1, 7.0 | Sep 7, 2016 |

### Elevation of privilege vulnerability in System UI

An elevation of privilege in the System UI could enable a local malicious user
to bypass the security prompt of a work profile in Multi-Window mode. This
issue is rated as High because it is a local bypass of user interaction
requirements for any developer or security setting modifications.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6708 | [A-30693465](https://android.googlesource.com/platform/frameworks/base/%2B/c9c73fde339b4db496f2c1ff8c18df1e9db5a7c1) | High | All | 7.0 | Google internal |

### Information disclosure vulnerability in Conscrypt

An information disclosure vulnerability in Conscrypt could enable
an attacker to gain access to sensitive information if a
legacy encryption API is used by an application. This issue is rated as High
because it could be used to access data without permission.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6709 | [A-31081987](https://android.googlesource.com/platform/external/conscrypt/%2B/44ef9535b9afb123d150d8e0362e4bb50794dd41) | High | All | 6.0, 6.0.1, 7.0 | Oct 9, 2015 |

### Information disclosure vulnerability in download manager

An information disclosure vulnerability in the download manager could enable a
local malicious application to bypass operating system protections that isolate
application data from other applications. This issue is rated as High because it
could be used to gain access to data that the application does not have access
to.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6710 | [A-30537115](https://android.googlesource.com/platform/frameworks/base/%2B/9fab683c9598d234dd8461335c276ed3e37c91e8) [[2](https://android.googlesource.com/platform/packages/providers/DownloadProvider/%2B/243e62949f7208d3b82eda3ee4ec22d3dbc1fb19)] | High | All | 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Jul 30, 2016 |

### Denial of service vulnerability in Bluetooth

A denial of service vulnerability in Bluetooth could enable a proximate attacker
to block Bluetooth access to an affected device. This issue is rated as High due
to the possibility of remote denial of service.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2014-9908 | A-28672558 | High | None\* | 4.4.4, 5.0.2, 5.1.1 | May 5, 2014 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Denial of service vulnerability in OpenJDK

A remote denial of service vulnerability in OpenJDK could enable an attacker to
use a specially crafted file to cause a device hang or reboot. This issue is
rated as High due to the possibility of remote denial of service.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2015-0410 | [A-30703445](https://android.googlesource.com/platform/libcore/%2B/21098574528bdf99dd50a74a60e161573e999108) | High | All | 7.0 | Jan 16, 2015 |

### Denial of service vulnerability in Mediaserver

A remote denial of service vulnerability in Mediaserver could enable an attacker
to use a specially crafted file to cause a device hang or reboot. This issue is
rated as High due to the possibility of remote denial of service.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6711 | [A-30593765](https://android.googlesource.com/platform/external/libvpx/%2B/063be1485e0099bc81ace3a08b0ec9186dcad693) | High | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Aug 1, 2016 |
| CVE-2016-6712 | [A-30593752](https://android.googlesource.com/platform/external/libvpx/%2B/fdb1b40e7bb147c07bda988c9501ad223795d12d) | High | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Aug 1, 2016 |
| CVE-2016-6713 | [A-30822755](https://android.googlesource.com/platform/external/libavc/%2B/8cafca0e8b1ed8125918e203118c5a4e612fd56c) | High | All | 6.0, 6.0.1, 7.0 | Aug 11, 2016 |
| CVE-2016-6714 | [A-31092462](https://android.googlesource.com/platform/external/libavc/%2B/5bdb0a6b72782e505671a387bb5f83222d891d6a) | High | All | 6.0, 6.0.1, 7.0 | Aug 22, 2016 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in Framework APIs

An elevation of privilege vulnerability in the Framework APIs could allow a
local malicious application to record audio without the user's permission. This
issue is rated as Moderate because it is a local bypass of user interaction
requirements (access to functionality that would normally require either user
initiation or user permission).

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6715 | [A-29833954](https://android.googlesource.com/platform/frameworks/base/%2B/3de09838fb0996bb4b420630800ad34e828fd1b6) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Jun 28, 2016 |

### Elevation of privilege vulnerability in AOSP Launcher

An elevation of privilege vulnerability in the AOSP Launcher could allow a local
malicious application to create shortcuts that have elevated privileges without
the user's consent. This issue is rated as Moderate because it is a local bypass
of user interaction requirements (access to functionality that would normally
require either user initiation or user permission).

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6716 | [A-30778130](https://android.googlesource.com/platform/packages/apps/Launcher3/%2B/e83fc11c982e67dd0181966f5f3a239ea6b14924) | Moderate | All | 7.0 | Aug 5, 2016 |

### Elevation of privilege vulnerability in Mediaserver

An elevation of privilege vulnerability in Mediaserver could enable a local
malicious application to execute arbitrary code within the context of a
privileged process. This issue is rated as Moderate because it first requires
exploitation of a separate vulnerability.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6717 | [A-31350239](https://android.googlesource.com/platform/frameworks/av/%2B/45d9bbabbe7920bf4e0a68074b97d8260aef2e07) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Sep 7, 2016 |

### Elevation of privilege vulnerability in Account Manager Service

An elevation of privilege vulnerability in the Account Manager Service could
enable a local malicious application to retrieve sensitive information without
user interaction. This issue is rated as Moderate because it is a local bypass
of user interaction requirements (access to functionality that would normally
require either user initiation or user permission.)

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6718 | [A-30455516](https://android.googlesource.com/platform/frameworks/base/%2B/fecfd550edeca422c0d9f32a9c0abe73398a1ff1) | Moderate | All | 7.0 | Google internal |

### Elevation of privilege vulnerability in Bluetooth

An elevation of privilege vulnerability in the Bluetooth component could enable
a local malicious application to pair with any Bluetooth device without user
consent. This issue is rated as Moderate because it is a local bypass of user
interaction requirements (access to functionality that would normally require
either user initiation or user permission).

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6719 | [A-29043989](https://android.googlesource.com/platform/packages/apps/Bluetooth/%2B/e1b6db10e913c09d0b695368336137f6aabee462) [[2](https://android.googlesource.com/platform/frameworks/base/%2B/b1dc1757071ba46ee653d68f331486e86778b8e4)] | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Google internal |

### Information disclosure vulnerability in Mediaserver

An information disclosure vulnerability in Mediaserver could enable a local
malicious application to access data outside of its permission levels. This
issue is rated as Moderate because it could be used to access sensitive data
without permission.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6720 | [A-29422020](https://android.googlesource.com/platform/frameworks/av/%2B/0f177948ae2640bfe4d70f8e4248e106406b3b0a) [[2](https://android.googlesource.com/platform/frameworks/av/%2B/2c75e1c3b98e4e94f50c63e2b7694be5f948477c)] [[3](https://android.googlesource.com/platform/frameworks/av/%2B/7c88b498fda1c2b608a9dd73960a2fd4d7b7e3f7)] [[4](https://android.googlesource.com/platform/frameworks/av/%2B/640b04121d7cd2cac90e2f7c82b97fce05f074a5)] | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Jun 15, 2016 |
| CVE-2016-6721 | [A-30875060](https://android.googlesource.com/platform/frameworks/av/%2B/f6bf0102bdc1adff973e08d8ce9c869c4e2efade) | Moderate | All | 6.0, 6.0.1, 7.0 | Aug 13, 2016 |
| CVE-2016-6722 | [A-31091777](https://android.googlesource.com/platform/frameworks/av/%2B/89c03b3b9ff74a507a8b8334c50b08b334483556) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Aug 23, 2016 |

### Denial of service vulnerability in Proxy Auto Config

A denial of service vulnerability in Proxy Auto Config could enable a remote
attacker to use a specially crafted file to cause a device hang or reboot. This
issue is rated as Moderate because it requires an uncommon device configuration.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6723 | [A-30100884](https://android.googlesource.com/platform/frameworks/base/%2B/d5b0d0b1df2e1a7943a4bb2034fd21487edd0264) [[2](https://android.googlesource.com/platform/frameworks/base/%2B/31f351160cdfd9dbe9919682ebe41bde3bcf91c6)] | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Jul 11, 2016 |

### Denial of service vulnerability in Input Manager Service

A denial of service vulnerability in the Input Manager Service could enable a
local malicious application to cause the device to continually reboot. This
issue is rated as Moderate because it is a temporary denial of service that
requires a factory reset to fix.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6724 | [A-30568284](https://android.googlesource.com/platform/frameworks/base/%2B/7625010a2d22f8c3f1aeae2ef88dde37cbebd0bf) | Moderate | All | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0 | Google internal |

## 2016-11-05 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities that apply to the 2016-11-05 patch level. There is a description of
the issue, a severity rationale, and a table with the CVE, associated
references, severity, updated Google devices, updated AOSP versions (where
applicable), and date reported. When available, we will link the public change
that addressed the issue to the bug ID, like the AOSP change list. When multiple
changes relate to a single bug, additional references are linked to numbers
following the bug ID.

### Remote code execution vulnerability in Qualcomm crypto driver

A remote code execution vulnerability in the Qualcomm crypto driver could enable
a remote attacker to execute arbitrary code within the context of the kernel.
This issue is rated as Critical due to the possibility of remote code execution
in the context of the kernel.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6725 | A-30515053 [QC-CR#1050970](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=cc95d644ee8a043f2883d65dda20e16f95041de3) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 25, 2016 |

### Elevation of privilege vulnerability in kernel file system

An elevation of privilege vulnerability in the kernel file system could enable a
local malicious application to execute arbitrary code within the context of the
kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2015-8961 | A-30952474  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=6934da9238da947628be83635e365df41064b09b) | Critical | Pixel, Pixel XL | Oct 18, 2015 |
| CVE-2016-7911 | A-30946378  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=8ba8682107ee2ca3347354e018865d8e1967c5f4) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Jul 01, 2016 |
| CVE-2016-7910 | A-30942273  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=77da160530dd1dc94f6ae15a981f24e5f0021e84) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Jul 29, 2016 |

### Elevation of privilege vulnerability in kernel SCSI driver

An elevation of privilege vulnerability in the kernel SCSI driver could enable a
local malicious application to execute arbitrary code within the context of the
kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2015-8962 | A-30951599  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=f3951a3709ff50990bf3e188c27d346792103432) | Critical | Pixel, Pixel XL | Oct 30, 2015 |

### Elevation of privilege vulnerability in kernel media driver

An elevation of privilege vulnerability in the kernel media driver could enable
a local malicious application to execute arbitrary code within the context of
the kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-7913 | A-30946097  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=8dfbcc4351a0b6d2f2d77f367552f48ffefafe18) | Critical | Nexus 6P, Android One, Nexus Player, Pixel, Pixel XL | Jan 28, 2016 |

### Elevation of privilege vulnerability in kernel USB driver

An elevation of privilege vulnerability in the kernel USB driver could enable a
local malicious application to execute arbitrary code within the context of the
kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-7912 | A-30950866  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=38740a5b87d53ceb89eb2c970150f6e94e00373a) | Critical | Pixel C, Pixel, Pixel XL | Apr 14, 2016 |

### Elevation of privilege vulnerability in kernel ION subsystem

An elevation of privilege vulnerability in the kernel ION subsystem could enable
a local malicious application to execute arbitrary code within the context of
the kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6728 | A-30400942\* | Critical | Nexus 5, Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Nexus Player, Pixel C, Android One | Jul 25, 2016 |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in Qualcomm bootloader

An elevation of privilege vulnerability in the Qualcomm bootloader could enable
a local malicious application to execute arbitrary code within the context of
the kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6729 | A-30977990\*  QC-CR#977684 | Critical | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 25, 2016 |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in NVIDIA GPU driver

An elevation of privilege vulnerability in the NVIDIA GPU driver could enable a
local malicious application to execute arbitrary code within the context of the
kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6730 | A-30904789\* N-CVE-2016-6730 | Critical | Pixel C | Aug 16, 2016 |
| CVE-2016-6731 | A-30906023\* N-CVE-2016-6731 | Critical | Pixel C | Aug 16, 2016 |
| CVE-2016-6732 | A-30906599\* N-CVE-2016-6732 | Critical | Pixel C | Aug 16, 2016 |
| CVE-2016-6733 | A-30906694\* N-CVE-2016-6733 | Critical | Pixel C | Aug 16, 2016 |
| CVE-2016-6734 | A-30907120\* N-CVE-2016-6734 | Critical | Pixel C | Aug 16, 2016 |
| CVE-2016-6735 | A-30907701\* N-CVE-2016-6735 | Critical | Pixel C | Aug 16, 2016 |
| CVE-2016-6736 | A-30953284\* N-CVE-2016-6736 | Critical | Pixel C | Aug 18, 2016 |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in kernel networking subsystem

An elevation of privilege vulnerability in the kernel networking subsystem could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Critical due to the possibility of
a local permanent device compromise, which may require reflashing the operating
system to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6828 | A-31183296  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/include/net/tcp.h?id=bb1fceca22492109be12640d49f5ea5a544c6bb4) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Aug 18, 2016 |

### Elevation of privilege vulnerability in kernel sound subsystem

An elevation of privilege vulnerability in the kernel sound subsystem could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Critical due to the possibility of
a local permanent device compromise, which may require reflashing the operating
system to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-2184 | A-30952477  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=836b34a935abc91e13e63053d0a83b24dfb5ea78) | Critical | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Mar 31, 2016 |

### Elevation of privilege vulnerability in kernel ION subsystem

An elevation of privilege vulnerability in the kernel ION subsystem could enable
a local malicious application to execute arbitrary code within the context of
the kernel. This issue is rated as Critical due to the possibility of a local
permanent device compromise, which may require reflashing the operating system
to repair the device.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6737 | A-30928456\* | Critical | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Google internal |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Vulnerabilities in Qualcomm components

The table below contains security vulnerabilities affecting Qualcomm components
and are described in further detail in Qualcomm AMSS June 2016 security
bulletin and Security Alert 80-NV606-17.

| CVE | References | Severity\* | Updated Google devices | Date reported |
| CVE-2016-6727 | A-31092400\*\* | Critical | Android One | Qualcomm internal |
| CVE-2016-6726 | A-30775830\*\* | High | Nexus 6, Android One | Qualcomm internal |

\* The severity rating for these vulnerabilities was determined by the vendor.

\*\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Remote code execution vulnerability in Expat

The table below contains security vulnerabilities affecting the Expat library.
The most severe of these issues is an elevation of privilege vulnerability in
the Expat XML parser, which could enable an attacker using a specially crafted
file to execute arbitrary code in an unprivileged process. This issue is rated
as High due to the possibility of arbitrary code execution in an application
that uses Expat.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-0718 | [A-28698301](https://android.googlesource.com/platform/external/expat/%2B/52ac633b73856ded34b33bd4adb4ab793bbbe963) | High | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | May 10, 2016 |
| CVE-2012-6702 | [A-29149404](https://android.googlesource.com/platform/external/expat/%2B/a11ff32280a863bff93df13ad643912ad9bf1302) | Moderate | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Mar 06, 2016 |
| CVE-2016-5300 | [A-29149404](https://android.googlesource.com/platform/external/expat/%2B/a11ff32280a863bff93df13ad643912ad9bf1302) | Moderate | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Jun 04, 2016 |
| CVE-2015-1283 | [A-27818751](https://android.googlesource.com/platform/external/expat/%2B/13b40c2040a17038b63a61e2b112c634da203d3b) | Low | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Jul 24, 2015 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Remote code execution vulnerability in Webview

A remote code execution vulnerability in Webview could enable a remote attacker
to execute arbitrary code when the user is navigating to a website. This issue
is rated as High due to the possibility of remote code execution in an
unprivileged process.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2016-6754 | A-31217937 | High | None\* | 5.0.2, 5.1.1, 6.0, 6.0.1 | Aug 23, 2016 |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Remote code execution vulnerability in Freetype

A remote code execution vulnerability in Freetype could enable a local malicious
application to load a specially crafted font to cause memory corruption in an
unprivileged process. This issue is rated as High due to the possibility of
remote code execution in applications that use Freetype.

| CVE | References | Severity | Updated Google devices | Updated AOSP versions | Date reported |
| CVE-2014-9675 | [A-24296662](https://android.googlesource.com/platform/external/freetype/%2B/f720f0dbcf012d6c984dbbefa0875ef9840458c6) [[2](https://android.googlesource.com/platform/external/pdfium/%2B/96f965ff7411f1edba72140fd70740e63cabec71)] | High | None\* | 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1 | Google internal |

\* Supported Google devices on Android 7.0 or later that have installed all
available updates are not affected by this vulnerability.

### Elevation of privilege vulnerability in kernel performance subsystem

An elevation of privilege vulnerability in the kernel performance subsystem
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2015-8963 | A-30952077  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=12ca6ad2e3a896256f086497a7c7406a547ee373) | High | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Dec 15, 2015 |

### Elevation of privilege vulnerability in kernel system-call auditing subsystem

An elevation of privilege vulnerability in the kernel system-call auditing
subsystem could enable a local malicious application to disrupt system-call
auditing in the kernel. This issue is rated as High because it is a general
bypass for a kernel-level defense in depth or exploit mitigation technology.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6136 | A-30956807  [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=43761473c254b45883a64441dd0bc85a42f3645c) | High | Android One, Pixel C, Nexus Player | Jul 1, 2016 |

### Elevation of privilege vulnerability in Qualcomm crypto engine driver

An elevation of privilege vulnerability in the Qualcomm crypto engine driver
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6738 | A-30034511  [QC-CR#1050538](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=a829c54236b455885c3e9c7c77ac528b62045e79) | High | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 7, 2016 |

### Elevation of privilege vulnerability in Qualcomm camera driver

An elevation of privilege vulnerability in the Qualcomm camera driver could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6739 | A-30074605\* QC-CR#1049826 | High | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Jul 11, 2016 |
| CVE-2016-6740 | A-30143904  [QC-CR#1056307](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=ef78bd62f0c064ae4c827e158d828b2c110ebcdc) | High | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 12, 2016 |
| CVE-2016-6741 | A-30559423  [QC-CR#1060554](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?id=d291eebd8e43bba3229ae7ef9146a132894dc293) | High | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 28, 2016 |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Elevation of privilege vulnerability in Qualcomm bus driver

An elevation of privilege vulnerability in the Qualcomm bus driver could enable
a local malicious application to execute arbitrary code within the context of
the kernel. This issue is rated as High because it first requires compromising a
privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-3904 | A-30311977  [QC-CR#1050455](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=069683407ca9a820d05c914b57c587bcd3f16a3a) | High | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Jul 22, 2016 |

### Elevation of privilege vulnerability in Synaptics touchscreen driver

An elevation of privilege vulnerability in the Synaptics touchscreen driver
could enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as High because it first requires
compromising a privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6742 | A-30799828\* | High | Nexus 5X, Android One | Aug 9, 2016 |
| CVE-2016-6744 | A-30970485\* | High | Nexus 5X | Aug 19, 2016 |
| CVE-2016-6745 | A-31252388\* | High | Nexus 5X, Nexus 6P, Nexus 9, Android One, Pixel, Pixel XL | Sep 1, 2016 |
| CVE-2016-6743 | A-30937462\* | High | Nexus 9, Android One | Google internal |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Information disclosure vulnerability in kernel components

An information disclosure vulnerability in kernel components, including the
human interface device driver, file system, and Teletype driver, could enable a
local malicious application to access data outside of its permission levels.
This issue is rated as High because it could be used to access sensitive data
without explicit user permission.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2015-8964 | A-30951112  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=dd42bf1197144ede075a9d4793123f7689e164bc) | High | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Nov 27, 2015 |
| CVE-2016-7915 | A-30951261  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=50220dead1650609206efe91f0cc116132d59b3f) | High | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | Jan 19, 2016 |
| CVE-2016-7914 | A-30513364  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=8d4a2ec1e0b41b0cf9a0c5cd4511da7f8e4f3de2) | High | Pixel C, Pixel, Pixel XL | Apr 06, 2016 |
| CVE-2016-7916 | A-30951939  [Upstream kernel](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=8148a73c9901a8794a50f950083c00ccf97d43b3) | High | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Android One, Pixel C, Nexus Player, Pixel, Pixel XL | May 05, 2016 |

### Information disclosure vulnerability in NVIDIA GPU driver

An information disclosure vulnerability in the NVIDIA GPU driver could enable a
local malicious application to access data outside of its permission levels.
This issue is rated as High because it could be used to access sensitive data
without explicit user permission.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6746 | A-30955105\* N-CVE-2016-6746 | High | Pixel C | Aug 18, 2016 |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Denial of service vulnerability in Mediaserver

A denial of service vulnerability in Mediaserver could enable an attacker to use
a specially crafted file to cause a device hang or reboot. This issue is rated
as High due to the possibility of remote denial of service.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6747 | A-31244612\* N-CVE-2016-6747 | High | Nexus 9 | Google internal |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Information disclosure vulnerability in kernel components

An information disclosure vulnerability in kernel components, including the
process-grouping subsystem and the networking subsystem, could enable a local
malicious application to access data outside of its permission levels. This
issue is rated as Moderate because it first requires compromising a privileged
process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-7917 | A-30947055  [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=c58d6c93680f28ac58984af61d0a7ebf4319c241) | Moderate | Pixel C, Pixel, Pixel XL | Feb 02, 2016 |
| CVE-2016-6753 | A-30149174\* | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Nexus 9, Pixel C, Nexus Player, Pixel, Pixel XL | Jul 13, 2016 |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

### Information disclosure vulnerability in Qualcomm components

An information disclosure vulnerability in Qualcomm components including the GPU
driver, power driver, SMSM Point-to-Point driver, and sound driver, could enable
a local malicious application to access data outside of its permission levels.
This issue is rated as Moderate because it first requires compromising a
privileged process.

| CVE | References | Severity | Updated Google devices | Date reported |
| CVE-2016-6748 | A-30076504  [QC-CR#987018](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=be651d020b122a1ba9410d23ca4ebbe9f5598df6) | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 12, 2016 |
| CVE-2016-6749 | A-30228438  [QC-CR#1052818](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=f9185dc83b92e7d1ee341e32e8cf5ed00a7253a7) | Moderate | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Jul 12, 2016 |
| CVE-2016-6750 | A-30312054  [QC-CR#1052825](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=34bda711a1c7bc7f9fd7bea3a5be439ed00577e5) | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Jul 21, 2016 |
| CVE-2016-3906 | A-30445973  [QC-CR#1054344](https://source.codeaurora.org/quic/la/kernel/msm-3.18/commit/?id=b333d32745fec4fb1098ee1a03d4425f3c1b4c2e) | Moderate | Nexus 5X, Nexus 6P | Jul 27, 2016 |
| CVE-2016-3907 | A-30593266  [QC-CR#1054352](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=744330f4e5d70dce71c4c9e03c5b6a8b59bb0cda) | Moderate | Nexus 5X, Nexus 6P, Pixel, Pixel XL | Aug 2, 2016 |
| CVE-2016-6698 | A-30741851  [QC-CR#1058826](https://source.codeaurora.org/quic/la//kernel/msm-3.10/commit/?id=de90beb76ad0b80da821c3b857dd30cd36319e61) | Moderate | Nexus 5X, Nexus 6P, Android One, Pixel, Pixel XL | Aug 2, 2016 |
| CVE-2016-6751 | A-30902162\* QC-CR#1062271 | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Aug 15, 2016 |
| CVE-2016-6752 | A-31498159  [QC-CR#987051](https://source.codeaurora.org/quic/la//kernel/msm-3.18/commit/?h=0de2c7600c8f1f0152a2f421c6593f931186400a) | Moderate | Nexus 5X, Nexus 6, Nexus 6P, Android One, Pixel, Pixel XL | Google internal |

\* The patch for this issue is not publicly available. The update is contained in
the latest binary drivers for Google devices available from the [Google Developer
site](https://developers.google.com/android/nexus/drivers).

## 2016-11-06 security patch level—Vulnerability details

In the sections below, we provide details for each of the security
vulnerabilities listed in the
[2016-11-06 security patch level—Vulnerability
summary](#2016-11-06-summary) above. There is a description of
the issue, a severity rationale, and a table with the CVE, associated
references, severity, updated Google devices, updated AOSP versions (where
applicable), and date reported. When available, we will link the public change
that addressed the issue to the bug ID, like the AOSP change list. When multiple
changes relate to a single bug, additional references are linked to numbers
following the bug ID.

### Elevation of privilege vulnerability in kernel memory subsystem

An elevation of privilege vulnerability in the kernel memory subsystem could
enable a local malicious application to execute arbitrary code within the
context of the kernel. This issue is rated as Critical due to the possibility of
a local permanent device compromise, which may require reflashing the operating
system to repair the device.

**Note:** A security patch level of 2016-11-06 indicates that this
issue, as well as all issues associated with 2016-11-01 and 2016-11-05 are
addressed.

| CVE | References | Severity | Updated kernel versions | Date reported |
| --- | --- | --- | --- | --- |
| CVE-2016-5195 | A-32141528 [Upstream kernel](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=9691eac5593ff1e2f82391ad327f21d90322aec1) [[2](https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=e45a502bdeae5a075257c4f061d1ff4ff0821354)] | Critical | 3.10, 3.18 | Oct 12, 2016 |

## Common Questions and Answers

This section answers common questions that may occur after reading this
bulletin.

**1. How do I determine if my device is updated to address these issues?**

To learn how to check a device’s security patch level, read the instructions on the
[Pixel
and Nexus update schedule](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices).

* Security patch levels of 2016-11-01 or later address all issues associated
  with the 2016-11-01 security patch level.
* Security patch levels of 2016-11-05 or later address all issues associated
  with the 2016-11-05 security patch level and all previous patch levels.
* Security patch levels of 2016-11-06 or later address all issues associated
  with the 2016-11-06 security patch level and all previous patch
  levels.

Device manufacturers that include these updates should set the patch level
string to:

* [ro.build.version.security\_patch]:[2016-11-01]
* [ro.build.version.security\_patch]:[2016-11-05]
* [ro.build.version.security\_patch]:[2016-11-06].

**2. Why does this bulletin have three security patch levels?**

This bulletin has three security patch levels so that Android partners have the
flexibility to fix a subset of vulnerabilities that are similar across all
Android devices more quickly. Android partners are encouraged to fix all issues
in this bulletin and use the latest security patch level.

* Devices that use the November 1, 2016 security patch level must include all
  issues associated with that security patch level, as well as fixes for all
  issues reported in previous security bulletins.
* Devices that use the security patch level of November 5, 2016 or newer must
  include all applicable patches in this (and previous) security bulletins.
* Devices that use the security patch level of November 6, 2016 or newer must
  include all applicable patches in this (and previous) security
  bulletins.

Partners are encouraged to bundle the fixes for all issues they are addressing
in a single update.

**3. How do I determine which Google devices are affected by each
issue?**

In the
[2016-11-01](#2016-11-01-details),
[2016-11-05](#2016-11-05-details),
and
[2016-11-06](#2016-11-06-details)
security vulnerability details sections, each table has an *Updated Google
devices* column that covers the range of affected Google devices updated for
each issue. This column has a few options:

* **All Google devices**: If an issue affects all Nexus and Pixel
  devices, the table will have "All" in the *Updated Google devices*
  column. "All" encapsulates the following
  [supported
  devices](https://support.google.com/pixelphone/answer/4457705#pixel_phones&nexus_devices): Nexus 5, Nexus 5X, Nexus 6, Nexus 6P, Nexus 9,
  Android One, Nexus Player, Pixel C, Pixel, and Pixel XL.
* **Some Google devices**: If an issue doesn't affect all Google
  devices, the affected Google devices are listed in the *Updated Google
  devices* column.
* **No Google devices**: If no Google devices running Android 7.0
  are affected by the issue, the table will have "None" in the *Updated Google
  devices* column.

**4. What do the entries in the references column map to?**

Entries under the *References* column of the vulnerability details table
may contain a prefix identifying the organization to which the reference value
belongs. These prefixes map as follows:

| Prefix | Reference |
| --- | --- |
| A- | Android bug ID |
| QC- | Qualcomm reference number |
| M- | MediaTek reference number |
| N- | NVIDIA reference number |
| B- | Broadcom reference number |

## Revisions

* November 07, 2016: Bulletin published.
* November 08: Bulletin revised to include AOSP links and updated
  description for CVE-2016-6709.
* November 17: Bulletin revised to include attribution for CVE-2016-6828.
* December 21: Updated researcher credit.

Content and code samples on this page are subject to the licenses described in the [Content License](/license). Java and OpenJDK are trademarks or registered trademarks of Oracle and/or its affiliates.

Last updated 2024-08-26 UTC.

[[["Easy to understand","easyToUnderstand","thumb-up"],["Solved my problem","solvedMyProblem","thumb-up"],["Other","otherUp","thumb-up"]],[["Missing the information I need","missingTheInformationINeed","thumb-down"],["Too complicated / too many steps","tooComplicatedTooManySteps","thumb-down"],["Out of date","outOfDate","thumb-down"],["Samples / code issue","samplesCodeIssue","thumb-down"],["Other","otherDown","thumb-down"]],["Last updated 2024-08-26 UTC."],[],[]]

* ### Build

  + [Android repository](//android.googlesource.com)
  + [Requirements](/source/requirements)
  + [Downloading](/source/downloading)
  + [Preview binaries](//developers.google.com/android/blobs-preview/)
  + [Factory images](//developers.google.com/android/images/)
  + [Driver binaries](//developers.google.com/android/drivers/)
* ### Connect

  + [@Android on Twitter](//twitter.com/Android/)
  + [@AndroidDev on Twitter](//twitter.com/AndroidDev/)
  + [Android Blog](//blog.google/products/android/)
  + [Google Security Blog](//security.googleblog.com)
  + [Platform on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-platform/)
  + [Building on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-building/)
  + [Porting on Google Groups](//groups.google.com/forum/?fromgroups#!forum/android-porting/)
* ### Get help

  + [Android Help Center](//support.google.com/android/)
  + [Pixel Help Center](//support.google.com/pixelphone/)
  + [www.android.com](//www.android.com)
  + [Google Mobile Services](//www.android.com/gms/)
  + [Stack Overflow](//stackoverflow.com/questions/tagged/android-source/)
  + [Issue Tracker](//issuetracker.google.com/issues?q=status:open%20componentid:190923)

* [About Android](/source/)
* [Community](/source/community)
* [Legal](/legal)
* [License](/license)
* [Privacy](//policies.google.com/privacy)
* [Site feedback](//issuetracker.google.com/issues/new?component=191476)
* Manage cookies

* English
* Deutsch
* Español
* Español – América Latina
* Français
* Indonesia
* Italiano
* Polski
* Português
* Português – Brasil
* Tiếng Việt
* Türkçe
* Русский
* עברית
* العربيّة
* فارسی
* हिंदी
* বাংলা
* ภาษาไทย
* 中文 – 简体
* 中文 – 繁體
* 日本語
* 한국어


