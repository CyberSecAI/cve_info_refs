=== Content from access.redhat.com_d9f010f6_20250126_115606.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from git.kernel.org_81213ffc_20250125_210307.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=be0726d33cb8f411945884664924bed3cb8c70ee)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=be0726d33cb8f411945884664924bed3cb8c70ee)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=be0726d33cb8f411945884664924bed3cb8c70ee)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=be0726d33cb8f411945884664924bed3cb8c70ee)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2016-02-22 11:56:38 -0500 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2016-02-22 11:56:38 -0500 |
| commit | [be0726d33cb8f411945884664924bed3cb8c70ee](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=be0726d33cb8f411945884664924bed3cb8c70ee) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=be0726d33cb8f411945884664924bed3cb8c70ee)) | |
| tree | [9460f6b33739e505f29cfa94a13530e8d087a624](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=be0726d33cb8f411945884664924bed3cb8c70ee) | |
| parent | [82939d7999dfc1f1998c4b1c12e2f19edbdff272](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=be0726d33cb8f411945884664924bed3cb8c70ee&id2=82939d7999dfc1f1998c4b1c12e2f19edbdff272)) | |
| download | [linux-be0726d33cb8f411945884664924bed3cb8c70ee.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-be0726d33cb8f411945884664924bed3cb8c70ee.tar.gz) | |

ext2: convert to mbcache2The conversion is generally straightforward. We convert filesystem from
a global cache to per-fs one. Similarly to ext4 the tricky part is that
xattr block corresponding to found mbcache entry can get freed before we
get buffer lock for that block. So we have to check whether the entry is
still valid after getting the buffer lock.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=be0726d33cb8f411945884664924bed3cb8c70ee)

| -rw-r--r-- | [fs/ext2/ext2.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext2/ext2.h?id=be0726d33cb8f411945884664924bed3cb8c70ee) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext2/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext2/super.c?id=be0726d33cb8f411945884664924bed3cb8c70ee) | 25 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext2/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext2/xattr.c?id=be0726d33cb8f411945884664924bed3cb8c70ee) | 143 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext2/xattr.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext2/xattr.h?id=be0726d33cb8f411945884664924bed3cb8c70ee) | 21 | |  |  |  | | --- | --- | --- | |

4 files changed, 92 insertions, 100 deletions

| diff --git a/fs/ext2/ext2.h b/fs/ext2/ext2.hindex 4c69c94cafd84d..f98ce7e60a0f84 100644--- a/[fs/ext2/ext2.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/ext2.h?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)+++ b/[fs/ext2/ext2.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/ext2.h?id=be0726d33cb8f411945884664924bed3cb8c70ee)@@ -61,6 +61,8 @@ struct ext2\_block\_alloc\_info { #define rsv\_start rsv\_window.\_rsv\_start #define rsv\_end rsv\_window.\_rsv\_end +struct mb2\_cache;+ /\* \* second extended-fs super-block data in memory \*/@@ -111,6 +113,7 @@ struct ext2\_sb\_info { \* of the mount options. \*/ spinlock\_t s\_lock;+ struct mb2\_cache \*s\_mb\_cache; };  static inline spinlock\_t \*diff --git a/fs/ext2/super.c b/fs/ext2/super.cindex 2a188413a2b099..b78caf25f74622 100644--- a/[fs/ext2/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/super.c?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)+++ b/[fs/ext2/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/super.c?id=be0726d33cb8f411945884664924bed3cb8c70ee)@@ -131,7 +131,10 @@ static void ext2\_put\_super (struct super\_block \* sb)  dquot\_disable(sb, -1, DQUOT\_USAGE\_ENABLED | DQUOT\_LIMITS\_ENABLED); - ext2\_xattr\_put\_super(sb);+ if (sbi->s\_mb\_cache) {+ ext2\_xattr\_destroy\_cache(sbi->s\_mb\_cache);+ sbi->s\_mb\_cache = NULL;+ } if (!(sb->s\_flags & MS\_RDONLY)) { struct ext2\_super\_block \*es = sbi->s\_es; @@ -1104,6 +1107,14 @@ static int ext2\_fill\_super(struct super\_block \*sb, void \*data, int silent) ext2\_msg(sb, KERN\_ERR, "error: insufficient memory"); goto failed\_mount3; }++#ifdef CONFIG\_EXT2\_FS\_XATTR+ sbi->s\_mb\_cache = ext2\_xattr\_create\_cache();+ if (!sbi->s\_mb\_cache) {+ ext2\_msg(sb, KERN\_ERR, "Failed to create an mb\_cache");+ goto failed\_mount3;+ }+#endif /\* \* set up enough so that it can read an inode \*/@@ -1149,6 +1160,8 @@ cantfind\_ext2: sb->s\_id); goto failed\_mount; failed\_mount3:+ if (sbi->s\_mb\_cache)+ ext2\_xattr\_destroy\_cache(sbi->s\_mb\_cache); percpu\_counter\_destroy(&sbi->s\_freeblocks\_counter); percpu\_counter\_destroy(&sbi->s\_freeinodes\_counter); percpu\_counter\_destroy(&sbi->s\_dirs\_counter);@@ -1555,20 +1568,17 @@ MODULE\_ALIAS\_FS("ext2");  static int \_\_init init\_ext2\_fs(void) {- int err = init\_ext2\_xattr();- if (err)- return err;+ int err;+ err = init\_inodecache(); if (err)- goto out1;+ return err; err = register\_filesystem(&ext2\_fs\_type); if (err) goto out; return 0; out: destroy\_inodecache();-out1:- exit\_ext2\_xattr(); return err; } @@ -1576,7 +1586,6 @@ static void \_\_exit exit\_ext2\_fs(void) { unregister\_filesystem(&ext2\_fs\_type); destroy\_inodecache();- exit\_ext2\_xattr(); }  MODULE\_AUTHOR("Remy Card and others");diff --git a/fs/ext2/xattr.c b/fs/ext2/xattr.cindex f57a7aba32ebbd..7162b4869bc325 100644--- a/[fs/ext2/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/xattr.c?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)+++ b/[fs/ext2/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/xattr.c?id=be0726d33cb8f411945884664924bed3cb8c70ee)@@ -56,7 +56,7 @@ #include <linux/buffer\_head.h> #include <linux/init.h> #include <linux/slab.h>-#include <linux/mbcache.h>+#include <linux/mbcache2.h> #include <linux/quotaops.h> #include <linux/rwsem.h> #include <linux/security.h>@@ -90,14 +90,12 @@ static int ext2\_xattr\_set2(struct inode \*, struct buffer\_head \*, struct ext2\_xattr\_header \*); -static int ext2\_xattr\_cache\_insert(struct buffer\_head \*);+static int ext2\_xattr\_cache\_insert(struct mb2\_cache \*, struct buffer\_head \*); static struct buffer\_head \*ext2\_xattr\_cache\_find(struct inode \*, struct ext2\_xattr\_header \*); static void ext2\_xattr\_rehash(struct ext2\_xattr\_header \*, struct ext2\_xattr\_entry \*); -static struct mb\_cache \*ext2\_xattr\_cache;- static const struct xattr\_handler \*ext2\_xattr\_handler\_map[] = { [EXT2\_XATTR\_INDEX\_USER] = &ext2\_xattr\_user\_handler, #ifdef CONFIG\_EXT2\_FS\_POSIX\_ACL@@ -152,6 +150,7 @@ ext2\_xattr\_get(struct inode \*inode, int name\_index, const char \*name, size\_t name\_len, size; char \*end; int error;+ struct mb2\_cache \*ext2\_mb\_cache = EXT2\_SB(inode->i\_sb)->s\_mb\_cache;  ea\_idebug(inode, "name=%d.%s, buffer=%p, buffer\_size=%ld", name\_index, name, buffer, (long)buffer\_size);@@ -196,7 +195,7 @@ bad\_block: ext2\_error(inode->i\_sb, "ext2\_xattr\_get", goto found; entry = next; }- if (ext2\_xattr\_cache\_insert(bh))+ if (ext2\_xattr\_cache\_insert(ext2\_mb\_cache, bh)) ea\_idebug(inode, "cache insert failed"); error = -ENODATA; goto cleanup;@@ -209,7 +208,7 @@ found: le16\_to\_cpu(entry->e\_value\_offs) + size > inode->i\_sb->s\_blocksize) goto bad\_block; - if (ext2\_xattr\_cache\_insert(bh))+ if (ext2\_xattr\_cache\_insert(ext2\_mb\_cache, bh)) ea\_idebug(inode, "cache insert failed"); if (buffer) { error = -ERANGE;@@ -247,6 +246,7 @@ ext2\_xattr\_list(struct dentry \*dentry, char \*buffer, size\_t buffer\_size) char \*end; size\_t rest = buffer\_size; int error;+ struct mb2\_cache \*ext2\_mb\_cache = EXT2\_SB(inode->i\_sb)->s\_mb\_cache;  ea\_idebug(inode, "buffer=%p, buffer\_size=%ld", buffer, (long)buffer\_size);@@ -281,7 +281,7 @@ bad\_block: ext2\_error(inode->i\_sb, "ext2\_xattr\_list", goto bad\_block; entry = next; }- if (ext2\_xattr\_cache\_insert(bh))+ if (ext2\_xattr\_cache\_insert(ext2\_mb\_cache, bh)) ea\_idebug(inode, "cache insert failed");  /\* list the attribute names \*/@@ -483,22 +483,23 @@ bad\_block: ext2\_error(sb, "ext2\_xattr\_set", /\* Here we know that we can set the new attribute. \*/  if (header) {- struct mb\_cache\_entry \*ce;- /\* assert(header == HDR(bh)); \*/- ce = mb\_cache\_entry\_get(ext2\_xattr\_cache, bh->b\_bdev,- bh->b\_blocknr); lock\_buffer(bh); if (header->h\_refcount == cpu\_to\_le32(1)) {+ \_\_u32 hash = le32\_to\_cpu(header->h\_hash);+ ea\_bdebug(bh, "modifying in-place");- if (ce)- mb\_cache\_entry\_free(ce);+ /\*+ \* This must happen under buffer lock for+ \* ext2\_xattr\_set2() to reliably detect modified block+ \*/+ mb2\_cache\_entry\_delete\_block(EXT2\_SB(sb)->s\_mb\_cache,+ hash, bh->b\_blocknr);+ /\* keep the buffer locked while modifying it. \*/ } else { int offset; - if (ce)- mb\_cache\_entry\_release(ce); unlock\_buffer(bh); ea\_bdebug(bh, "cloning"); header = kmalloc(bh->b\_size, GFP\_KERNEL);@@ -626,6 +627,7 @@ ext2\_xattr\_set2(struct inode \*inode, struct buffer\_head \*old\_bh, struct super\_block \*sb = inode->i\_sb; struct buffer\_head \*new\_bh = NULL; int error;+ struct mb2\_cache \*ext2\_mb\_cache = EXT2\_SB(sb)->s\_mb\_cache;  if (header) { new\_bh = ext2\_xattr\_cache\_find(inode, header);@@ -653,7 +655,7 @@ ext2\_xattr\_set2(struct inode \*inode, struct buffer\_head \*old\_bh, don't need to change the reference count. \*/ new\_bh = old\_bh; get\_bh(new\_bh);- ext2\_xattr\_cache\_insert(new\_bh);+ ext2\_xattr\_cache\_insert(ext2\_mb\_cache, new\_bh); } else { /\* We need to allocate a new block \*/ ext2\_fsblk\_t goal = ext2\_group\_first\_block\_no(sb,@@ -674,7 +676,7 @@ ext2\_xattr\_set2(struct inode \*inode, struct buffer\_head \*old\_bh, memcpy(new\_bh->b\_data, header, new\_bh->b\_size); set\_buffer\_uptodate(new\_bh); unlock\_buffer(new\_bh);- ext2\_xattr\_cache\_insert(new\_bh);+ ext2\_xattr\_cache\_insert(ext2\_mb\_cache, new\_bh);  ext2\_xattr\_update\_super\_block(sb); }@@ -707,19 +709,21 @@ ext2\_xattr\_set2(struct inode \*inode, struct buffer\_head \*old\_bh,  error = 0; if (old\_bh && old\_bh != new\_bh) {- struct mb\_cache\_entry \*ce;- /\* \* If there was an old block and we are no longer using it, \* release the old block. \*/- ce = mb\_cache\_entry\_get(ext2\_xattr\_cache, old\_bh->b\_bdev,- old\_bh->b\_blocknr); lock\_buffer(old\_bh); if (HDR(old\_bh)->h\_refcount == cpu\_to\_le32(1)) {+ \_\_u32 hash = le32\_to\_cpu(HDR(old\_bh)->h\_hash);++ /\*+ \* This must happen under buffer lock for+ \* ext2\_xattr\_set2() to reliably detect freed block+ \*/+ mb2\_cache\_entry\_delete\_block(ext2\_mb\_cache,+ hash, old\_bh->b\_blocknr); /\* Free the old block. \*/- if (ce)- mb\_cache\_entry\_free(ce); ea\_bdebug(old\_bh, "freeing"); ext2\_free\_blocks(inode, old\_bh->b\_blocknr, 1); mark\_inode\_dirty(inode);@@ -730,8 +734,6 @@ ext2\_xattr\_set2(struct inode \*inode, struct buffer\_head \*old\_bh, } else { /\* Decrement the refcount only. \*/ le32\_add\_cpu(&HDR(old\_bh)->h\_refcount, -1);- if (ce)- mb\_cache\_entry\_release(ce); dquot\_free\_block\_nodirty(inode, 1); mark\_inode\_dirty(inode); mark\_buffer\_dirty(old\_bh);@@ -757,7 +759,6 @@ void ext2\_xattr\_delete\_inode(struct inode \*inode) { struct buffer\_head \*bh = NULL;- struct mb\_cache\_entry \*ce;  down\_write(&EXT2\_I(inode)->xattr\_sem); if (!EXT2\_I(inode)->i\_file\_acl)@@ -777,19 +778,22 @@ ext2\_xattr\_delete\_inode(struct inode \*inode) EXT2\_I(inode)->i\_file\_acl); goto cleanup; }- ce = mb\_cache\_entry\_get(ext2\_xattr\_cache, bh->b\_bdev, bh->b\_blocknr); lock\_buffer(bh); if (HDR(bh)->h\_refcount == cpu\_to\_le32(1)) {- if (ce)- mb\_cache\_entry\_free(ce);+ \_\_u32 hash = le32\_to\_cpu(HDR(bh)->h\_hash);++ /\*+ \* This must happen under buffer lock for ext2\_xattr\_set2() to+ \* reliably detect freed block+ \*/+ mb2\_cache\_entry\_delete\_block(EXT2\_SB(inode->i\_sb)->s\_mb\_cache,+ hash, bh->b\_blocknr); ext2\_free\_blocks(inode, EXT2\_I(inode)->i\_file\_acl, 1); get\_bh(bh); bforget(bh); unlock\_buffer(bh); } else { le32\_add\_cpu(&HDR(bh)->h\_refcount, -1);- if (ce)- mb\_cache\_entry\_release(ce); ea\_bdebug(bh, "refcount now=%d", le32\_to\_cpu(HDR(bh)->h\_refcount)); unlock\_buffer(bh);@@ -806,18 +810,6 @@ cleanup: }  /\*- \* ext2\_xattr\_put\_super()- \*- \* This is called when a file system is unmounted.- \*/-void-ext2\_xattr\_put\_super(struct super\_block \*sb)-{- mb\_cache\_shrink(sb->s\_bdev);-}---/\* \* ext2\_xattr\_cache\_insert() \* \* Create a new entry in the extended attribute cache, and insert@@ -826,28 +818,20 @@ ext2\_xattr\_put\_super(struct super\_block \*sb) \* Returns 0, or a negative error number on failure. \*/ static int-ext2\_xattr\_cache\_insert(struct buffer\_head \*bh)+ext2\_xattr\_cache\_insert(struct mb2\_cache \*cache, struct buffer\_head \*bh) { \_\_u32 hash = le32\_to\_cpu(HDR(bh)->h\_hash);- struct mb\_cache\_entry \*ce; int error; - ce = mb\_cache\_entry\_alloc(ext2\_xattr\_cache, GFP\_NOFS);- if (!ce)- return -ENOMEM;- error = mb\_cache\_entry\_insert(ce, bh->b\_bdev, bh->b\_blocknr, hash);+ error = mb2\_cache\_entry\_create(cache, GFP\_NOFS, hash, bh->b\_blocknr); if (error) {- mb\_cache\_entry\_free(ce); if (error == -EBUSY) { ea\_bdebug(bh, "already in cache (%d cache entries)", atomic\_read(&ext2\_xattr\_cache->c\_entry\_count)); error = 0; }- } else {- ea\_bdebug(bh, "inserting [%x] (%d cache entries)", (int)hash,- atomic\_read(&ext2\_xattr\_cache->c\_entry\_count));- mb\_cache\_entry\_release(ce);- }+ } else+ ea\_bdebug(bh, "inserting [%x]", (int)hash); return error; } @@ -903,23 +887,17 @@ static struct buffer\_head \* ext2\_xattr\_cache\_find(struct inode \*inode, struct ext2\_xattr\_header \*header) { \_\_u32 hash = le32\_to\_cpu(header->h\_hash);- struct mb\_cache\_entry \*ce;+ struct mb2\_cache\_entry \*ce;+ struct mb2\_cache \*ext2\_mb\_cache = EXT2\_SB(inode->i\_sb)->s\_mb\_cache;  if (!header->h\_hash) return NULL; /\* never share \*/ ea\_idebug(inode, "looking for cached blocks [%x]", (int)hash); again:- ce = mb\_cache\_entry\_find\_first(ext2\_xattr\_cache, inode->i\_sb->s\_bdev,- hash);+ ce = mb2\_cache\_entry\_find\_first(ext2\_mb\_cache, hash); while (ce) { struct buffer\_head \*bh; - if (IS\_ERR(ce)) {- if (PTR\_ERR(ce) == -EAGAIN)- goto again;- break;- }- bh = sb\_bread(inode->i\_sb, ce->e\_block); if (!bh) { ext2\_error(inode->i\_sb, "ext2\_xattr\_cache\_find",@@ -927,7 +905,21 @@ again: inode->i\_ino, (unsigned long) ce->e\_block); } else { lock\_buffer(bh);- if (le32\_to\_cpu(HDR(bh)->h\_refcount) >+ /\*+ \* We have to be careful about races with freeing or+ \* rehashing of xattr block. Once we hold buffer lock+ \* xattr block's state is stable so we can check+ \* whether the block got freed / rehashed or not.+ \* Since we unhash mbcache entry under buffer lock when+ \* freeing / rehashing xattr block, checking whether+ \* entry is still hashed is reliable.+ \*/+ if (hlist\_bl\_unhashed(&ce->e\_hash\_list)) {+ mb2\_cache\_entry\_put(ext2\_mb\_cache, ce);+ unlock\_buffer(bh);+ brelse(bh);+ goto again;+ } else if (le32\_to\_cpu(HDR(bh)->h\_refcount) > EXT2\_XATTR\_REFCOUNT\_MAX) { ea\_idebug(inode, "block %ld refcount %d>%d", (unsigned long) ce->e\_block,@@ -936,13 +928,14 @@ again: } else if (!ext2\_xattr\_cmp(header, HDR(bh))) { ea\_bdebug(bh, "b\_count=%d", atomic\_read(&(bh->b\_count)));- mb\_cache\_entry\_release(ce);+ mb2\_cache\_entry\_touch(ext2\_mb\_cache, ce);+ mb2\_cache\_entry\_put(ext2\_mb\_cache, ce); return bh; } unlock\_buffer(bh); brelse(bh); }- ce = mb\_cache\_entry\_find\_next(ce, inode->i\_sb->s\_bdev, hash);+ ce = mb2\_cache\_entry\_find\_next(ext2\_mb\_cache, ce); } return NULL; }@@ -1015,17 +1008,15 @@ static void ext2\_xattr\_rehash(struct ext2\_xattr\_header \*header,  #undef BLOCK\_HASH\_SHIFT -int \_\_init-init\_ext2\_xattr(void)+#define HASH\_BUCKET\_BITS 10++struct mb2\_cache \*ext2\_xattr\_create\_cache(void) {- ext2\_xattr\_cache = mb\_cache\_create("ext2\_xattr", 6);- if (!ext2\_xattr\_cache)- return -ENOMEM;- return 0;+ return mb2\_cache\_create(HASH\_BUCKET\_BITS); } -void-exit\_ext2\_xattr(void)+void ext2\_xattr\_destroy\_cache(struct mb2\_cache \*cache) {- mb\_cache\_destroy(ext2\_xattr\_cache);+ if (cache)+ mb2\_cache\_destroy(cache); }diff --git a/fs/ext2/xattr.h b/fs/ext2/xattr.hindex 60edf298644ea2..6ea38aa9563a00 100644--- a/[fs/ext2/xattr.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/xattr.h?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)+++ b/[fs/ext2/xattr.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext2/xattr.h?id=be0726d33cb8f411945884664924bed3cb8c70ee)@@ -53,6 +53,8 @@ struct ext2\_xattr\_entry { #define EXT2\_XATTR\_SIZE(size) \ (((size) + EXT2\_XATTR\_ROUND) & ~EXT2\_XATTR\_ROUND) +struct mb2\_cache;+ # ifdef CONFIG\_EXT2\_FS\_XATTR  extern const struct xattr\_handler ext2\_xattr\_user\_handler;@@ -65,10 +67,9 @@ extern int ext2\_xattr\_get(struct inode \*, int, const char \*, void \*, size\_t); extern int ext2\_xattr\_set(struct inode \*, int, const char \*, const void \*, size\_t, int);  extern void ext2\_xattr\_delete\_inode(struct inode \*);-extern void ext2\_xattr\_put\_super(struct super\_block \*); -extern int init\_ext2\_xattr(void);-extern void exit\_ext2\_xattr(void);+extern struct mb2\_cache \*ext2\_xattr\_create\_cache(void);+extern void ext2\_xattr\_destroy\_cache(struct mb2\_cache \*cache);  extern const struct xattr\_handler \*ext2\_xattr\_handlers[]; @@ -93,19 +94,7 @@ ext2\_xattr\_delete\_inode(struct inode \*inode) { } -static inline void-ext2\_xattr\_put\_super(struct super\_block \*sb)-{-}--static inline int-init\_ext2\_xattr(void)-{- return 0;-}--static inline void-exit\_ext2\_xattr(void)+static inline void ext2\_xattr\_destroy\_cache(struct mb2\_cache \*cache) { } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 21:01:44 +0000



=== Content from www.openwall.com_67b50f8a_20250125_210309.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](5) [[<thread-prev]](../../../2016/08/22/2) [[thread-next>]](../../../2016/09/05/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-Id: <20160825175049.6E9186C0BB5@smtpvmsrv1.mitre.org>
Date: Thu, 25 Aug 2016 13:50:49 -0400 (EDT)
From: cve-assign@...re.org
To: wmealing@...hat.com
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: CVE request: Linux kernel mbcache lock contention denial of service.

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

> <http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=be0726d33cb8f411945884664924bed3cb8c70ee>
> <https://lwn.net/Articles/668718/>
> <https://bugzilla.kernel.org/show_bug.cgi?id=107301>
> <https://bugzilla.redhat.com/show_bug.cgi?id=1360968>
>
> A design flaw was found in the file extended attribute handling of the
> linux kernels handling of cached attributes. Too many entries in the
> cache cause a soft lockup while attempting to iterate the cache and
> access relevant locks.
>
> Upstream has replaced the mbcache code with an updated version which
> was not a patch but a clear-cut reimplementation of the code, no
> single diff
>
> Soft lockup information is in both the bugzilla.kernel.org and
> referred to in the LWN article. This would affect containers running
> with ext4 as it shares the same mbcache between all containers/host.
>
> This did not affect Red Hat Enterprise Linux versions 5,6 or 7, so I
> can't validate the claim that it does affect other newer kernels.
> This may be worthwhile tracking for others who are affected by this
> flaw.
>
> For those following along at home, this seemed to be fixed in:
>
> git tag --contains be0726d33cb8f411945884664924bed3cb8c70ee
> v4.6

Use CVE-2015-8952.

- --
CVE Assignment Team
M/S M300, 202 Burlington Road, Bedford, MA 01730 USA
[ A PGP key is available for encrypted communications at
  <http://cve.mitre.org/cve/request_id.html> ]
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQIcBAEBCAAGBQJXvy76AAoJEHb/MwWLVhi2lYkQAI/LDJTd/giN+MF4gT6DZ4Db
KZucD64daIHsBuKdvBWOTWhxGuFhCv1gGcfdJWZgTBWYow1yZx6HuxKQGfDGC1vh
rsQt26tP8RXcW9NiflvPovC++78bYMZhu6bzqVk6K9K7W8C8JjVgX2iU8lUa8XKw
Si1XKDN/jsXM+uyKrofVy/tYqDxYkQ9rDxVB8vpsJ6ezrN2WJiRfbTRnuMLE2BI6
bAUb9yoNWBoNMrP1YVwEAQQgzVshwsuwaEzF77khV/hmaJsTwOaomYdIfuHoRrqq
C02xBjvtzC3x79Tn71E29gfp+2/hK4E3fneQVRYO+3cShbcP8TADwEVSWGwuqOoM
ANuE6m76rIaN3peTwpXIHOFEDDjV56mj+60jkErse4yMbwMC2htiLWzssP1AklcD
y6/RpIoJLldhSJ+1KUjeAskCRozix2RTtyRveNK6ohD+BVRr6R3sfP9Y47RyIU36
6cPOowJICw0T3IkmD8HUn+cY0di7KuaopMu89hTdyOtugFSuOFVHBVFjdSo/kkjV
hgGExNuijnM/ts+vEVBB3UH7er3odyz7kTfPggr+pESZk2Jee4QMUQOlFMYgt9pW
ZIBwiDtf1N0+1Dk/E7aJxQvThW80xirWgg5ZuzCeyVstwEjgKX728cy/Qa7g2WIk
Zoe/WK1OI1qnr21ciAKg
=bAj5
-----END PGP SIGNATURE-----

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from git.kernel.org_2ab9b1c7_20250125_210306.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2016-02-22 11:50:13 -0500 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2016-02-22 11:50:13 -0500 |
| commit | [82939d7999dfc1f1998c4b1c12e2f19edbdff272](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)) | |
| tree | [3cebaf09ba5689f67b67bd73c79aca8d6e413140](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) | |
| parent | [f9a61eb4e2471c56a63cd804c7474128138c38ac](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272&id2=f9a61eb4e2471c56a63cd804c7474128138c38ac)) | |
| download | [linux-82939d7999dfc1f1998c4b1c12e2f19edbdff272.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-82939d7999dfc1f1998c4b1c12e2f19edbdff272.tar.gz) | |

ext4: convert to mbcache2The conversion is generally straightforward. The only tricky part is
that xattr block corresponding to found mbcache entry can get freed
before we get buffer lock for that block. So we have to check whether
the entry is still valid after getting buffer lock.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)

| -rw-r--r-- | [fs/ext4/ext4.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/ext4.h?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/super.c?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/xattr.c?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) | 136 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/ext4/xattr.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/xattr.h?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272) | 5 | |  |  |  | | --- | --- | --- | |

4 files changed, 75 insertions, 75 deletions

| diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.hindex 157b458a69d4b7..9ac9e62569ef8f 100644--- a/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/ext4.h?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)+++ b/[fs/ext4/ext4.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/ext4.h?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)@@ -1468,7 +1468,7 @@ struct ext4\_sb\_info { struct list\_head s\_es\_list; /\* List of inodes with reclaimable extents \*/ long s\_es\_nr\_inode; struct ext4\_es\_stats s\_es\_stats;- struct mb\_cache \*s\_mb\_cache;+ struct mb2\_cache \*s\_mb\_cache; spinlock\_t s\_es\_lock \_\_\_\_cacheline\_aligned\_in\_smp;  /\* Ratelimit ext4 messages. \*/diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 3ed01ec011d750..ecc37e1034358d 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/super.c?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/super.c?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)@@ -844,7 +844,6 @@ static void ext4\_put\_super(struct super\_block \*sb) ext4\_release\_system\_zone(sb); ext4\_mb\_release(sb); ext4\_ext\_release(sb);- ext4\_xattr\_put\_super(sb);  if (!(sb->s\_flags & MS\_RDONLY)) { ext4\_clear\_feature\_journal\_needs\_recovery(sb);@@ -3797,7 +3796,7 @@ static int ext4\_fill\_super(struct super\_block \*sb, void \*data, int silent)  no\_journal: if (ext4\_mballoc\_ready) {- sbi->s\_mb\_cache = ext4\_xattr\_create\_cache(sb->s\_id);+ sbi->s\_mb\_cache = ext4\_xattr\_create\_cache(); if (!sbi->s\_mb\_cache) { ext4\_msg(sb, KERN\_ERR, "Failed to create an mb\_cache"); goto failed\_mount\_wq;@@ -4027,6 +4026,10 @@ failed\_mount4: if (EXT4\_SB(sb)->rsv\_conversion\_wq) destroy\_workqueue(EXT4\_SB(sb)->rsv\_conversion\_wq); failed\_mount\_wq:+ if (sbi->s\_mb\_cache) {+ ext4\_xattr\_destroy\_cache(sbi->s\_mb\_cache);+ sbi->s\_mb\_cache = NULL;+ } if (sbi->s\_journal) { jbd2\_journal\_destroy(sbi->s\_journal); sbi->s\_journal = NULL;diff --git a/fs/ext4/xattr.c b/fs/ext4/xattr.cindex a95151e875bdcb..fe9f8d6ab6c91b 100644--- a/[fs/ext4/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/xattr.c?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)+++ b/[fs/ext4/xattr.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/xattr.c?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)@@ -53,7 +53,7 @@ #include <linux/init.h> #include <linux/fs.h> #include <linux/slab.h>-#include <linux/mbcache.h>+#include <linux/mbcache2.h> #include <linux/quotaops.h> #include "ext4\_jbd2.h" #include "ext4.h"@@ -78,10 +78,10 @@ # define ea\_bdebug(bh, fmt, ...) no\_printk(fmt, ##\_\_VA\_ARGS\_\_) #endif -static void ext4\_xattr\_cache\_insert(struct mb\_cache \*, struct buffer\_head \*);+static void ext4\_xattr\_cache\_insert(struct mb2\_cache \*, struct buffer\_head \*); static struct buffer\_head \*ext4\_xattr\_cache\_find(struct inode \*, struct ext4\_xattr\_header \*,- struct mb\_cache\_entry \*\*);+ struct mb2\_cache\_entry \*\*); static void ext4\_xattr\_rehash(struct ext4\_xattr\_header \*, struct ext4\_xattr\_entry \*); static int ext4\_xattr\_list(struct dentry \*dentry, char \*buffer,@@ -276,7 +276,7 @@ ext4\_xattr\_block\_get(struct inode \*inode, int name\_index, const char \*name, struct ext4\_xattr\_entry \*entry; size\_t size; int error;- struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);+ struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);  ea\_idebug(inode, "name=%d.%s, buffer=%p, buffer\_size=%ld", name\_index, name, buffer, (long)buffer\_size);@@ -428,7 +428,7 @@ ext4\_xattr\_block\_list(struct dentry \*dentry, char \*buffer, size\_t buffer\_size) struct inode \*inode = d\_inode(dentry); struct buffer\_head \*bh = NULL; int error;- struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);+ struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);  ea\_idebug(inode, "buffer=%p, buffer\_size=%ld", buffer, (long)buffer\_size);@@ -545,11 +545,8 @@ static void ext4\_xattr\_release\_block(handle\_t \*handle, struct inode \*inode, struct buffer\_head \*bh) {- struct mb\_cache\_entry \*ce = NULL; int error = 0;- struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); - ce = mb\_cache\_entry\_get(ext4\_mb\_cache, bh->b\_bdev, bh->b\_blocknr); BUFFER\_TRACE(bh, "get\_write\_access"); error = ext4\_journal\_get\_write\_access(handle, bh); if (error)@@ -557,9 +554,15 @@ ext4\_xattr\_release\_block(handle\_t \*handle, struct inode \*inode,  lock\_buffer(bh); if (BHDR(bh)->h\_refcount == cpu\_to\_le32(1)) {+ \_\_u32 hash = le32\_to\_cpu(BHDR(bh)->h\_hash);+ ea\_bdebug(bh, "refcount now=0; freeing");- if (ce)- mb\_cache\_entry\_free(ce);+ /\*+ \* This must happen under buffer lock for+ \* ext4\_xattr\_block\_set() to reliably detect freed block+ \*/+ mb2\_cache\_entry\_delete\_block(EXT4\_GET\_MB\_CACHE(inode), hash,+ bh->b\_blocknr); get\_bh(bh); unlock\_buffer(bh); ext4\_free\_blocks(handle, inode, bh, 0, 1,@@ -567,8 +570,6 @@ ext4\_xattr\_release\_block(handle\_t \*handle, struct inode \*inode, EXT4\_FREE\_BLOCKS\_FORGET); } else { le32\_add\_cpu(&BHDR(bh)->h\_refcount, -1);- if (ce)- mb\_cache\_entry\_release(ce); /\* \* Beware of this ugliness: Releasing of xattr block references \* from different inodes can race and so we have to protect@@ -781,17 +782,15 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, struct super\_block \*sb = inode->i\_sb; struct buffer\_head \*new\_bh = NULL; struct ext4\_xattr\_search \*s = &bs->s;- struct mb\_cache\_entry \*ce = NULL;+ struct mb2\_cache\_entry \*ce = NULL; int error = 0;- struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);+ struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);  #define header(x) ((struct ext4\_xattr\_header \*)(x))  if (i->value && i->value\_len > sb->s\_blocksize) return -ENOSPC; if (s->base) {- ce = mb\_cache\_entry\_get(ext4\_mb\_cache, bs->bh->b\_bdev,- bs->bh->b\_blocknr); BUFFER\_TRACE(bs->bh, "get\_write\_access"); error = ext4\_journal\_get\_write\_access(handle, bs->bh); if (error)@@ -799,10 +798,15 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, lock\_buffer(bs->bh);  if (header(s->base)->h\_refcount == cpu\_to\_le32(1)) {- if (ce) {- mb\_cache\_entry\_free(ce);- ce = NULL;- }+ \_\_u32 hash = le32\_to\_cpu(BHDR(bs->bh)->h\_hash);++ /\*+ \* This must happen under buffer lock for+ \* ext4\_xattr\_block\_set() to reliably detect modified+ \* block+ \*/+ mb2\_cache\_entry\_delete\_block(ext4\_mb\_cache, hash,+ bs->bh->b\_blocknr); ea\_bdebug(bs->bh, "modifying in-place"); error = ext4\_xattr\_set\_entry(i, s); if (!error) {@@ -826,10 +830,6 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, int offset = (char \*)s->here - bs->bh->b\_data;  unlock\_buffer(bs->bh);- if (ce) {- mb\_cache\_entry\_release(ce);- ce = NULL;- } ea\_bdebug(bs->bh, "cloning"); s->base = kmalloc(bs->bh->b\_size, GFP\_NOFS); error = -ENOMEM;@@ -884,6 +884,31 @@ inserted: if (error) goto cleanup\_dquot; lock\_buffer(new\_bh);+ /\*+ \* We have to be careful about races with+ \* freeing or rehashing of xattr block. Once we+ \* hold buffer lock xattr block's state is+ \* stable so we can check whether the block got+ \* freed / rehashed or not. Since we unhash+ \* mbcache entry under buffer lock when freeing+ \* / rehashing xattr block, checking whether+ \* entry is still hashed is reliable.+ \*/+ if (hlist\_bl\_unhashed(&ce->e\_hash\_list)) {+ /\*+ \* Undo everything and check mbcache+ \* again.+ \*/+ unlock\_buffer(new\_bh);+ dquot\_free\_block(inode,+ EXT4\_C2B(EXT4\_SB(sb),+ 1));+ brelse(new\_bh);+ mb2\_cache\_entry\_put(ext4\_mb\_cache, ce);+ ce = NULL;+ new\_bh = NULL;+ goto inserted;+ } le32\_add\_cpu(&BHDR(new\_bh)->h\_refcount, 1); ea\_bdebug(new\_bh, "reusing; refcount now=%d", le32\_to\_cpu(BHDR(new\_bh)->h\_refcount));@@ -894,7 +919,8 @@ inserted: if (error) goto cleanup\_dquot; }- mb\_cache\_entry\_release(ce);+ mb2\_cache\_entry\_touch(ext4\_mb\_cache, ce);+ mb2\_cache\_entry\_put(ext4\_mb\_cache, ce); ce = NULL; } else if (bs->bh && s->base == bs->bh->b\_data) { /\* We were modifying this block in-place. \*/@@ -959,7 +985,7 @@ getblk\_failed:  cleanup: if (ce)- mb\_cache\_entry\_release(ce);+ mb2\_cache\_entry\_put(ext4\_mb\_cache, ce); brelse(new\_bh); if (!(bs->bh && s->base == bs->bh->b\_data)) kfree(s->base);@@ -1512,17 +1538,6 @@ cleanup: }  /\*- \* ext4\_xattr\_put\_super()- \*- \* This is called when a file system is unmounted.- \*/-void-ext4\_xattr\_put\_super(struct super\_block \*sb)-{- mb\_cache\_shrink(sb->s\_bdev);-}--/\* \* ext4\_xattr\_cache\_insert() \* \* Create a new entry in the extended attribute cache, and insert@@ -1531,28 +1546,18 @@ ext4\_xattr\_put\_super(struct super\_block \*sb) \* Returns 0, or a negative error number on failure. \*/ static void-ext4\_xattr\_cache\_insert(struct mb\_cache \*ext4\_mb\_cache, struct buffer\_head \*bh)+ext4\_xattr\_cache\_insert(struct mb2\_cache \*ext4\_mb\_cache, struct buffer\_head \*bh) { \_\_u32 hash = le32\_to\_cpu(BHDR(bh)->h\_hash);- struct mb\_cache\_entry \*ce; int error; - ce = mb\_cache\_entry\_alloc(ext4\_mb\_cache, GFP\_NOFS);- if (!ce) {- ea\_bdebug(bh, "out of memory");- return;- }- error = mb\_cache\_entry\_insert(ce, bh->b\_bdev, bh->b\_blocknr, hash);+ error = mb2\_cache\_entry\_create(ext4\_mb\_cache, GFP\_NOFS, hash,+ bh->b\_blocknr); if (error) {- mb\_cache\_entry\_free(ce);- if (error == -EBUSY) {+ if (error == -EBUSY) ea\_bdebug(bh, "already in cache");- error = 0;- }- } else {+ } else ea\_bdebug(bh, "inserting [%x]", (int)hash);- mb\_cache\_entry\_release(ce);- } }  /\*@@ -1605,26 +1610,19 @@ ext4\_xattr\_cmp(struct ext4\_xattr\_header \*header1, \*/ static struct buffer\_head \* ext4\_xattr\_cache\_find(struct inode \*inode, struct ext4\_xattr\_header \*header,- struct mb\_cache\_entry \*\*pce)+ struct mb2\_cache\_entry \*\*pce) { \_\_u32 hash = le32\_to\_cpu(header->h\_hash);- struct mb\_cache\_entry \*ce;- struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);+ struct mb2\_cache\_entry \*ce;+ struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode);  if (!header->h\_hash) return NULL; /\* never share \*/ ea\_idebug(inode, "looking for cached blocks [%x]", (int)hash);-again:- ce = mb\_cache\_entry\_find\_first(ext4\_mb\_cache, inode->i\_sb->s\_bdev,- hash);+ ce = mb2\_cache\_entry\_find\_first(ext4\_mb\_cache, hash); while (ce) { struct buffer\_head \*bh; - if (IS\_ERR(ce)) {- if (PTR\_ERR(ce) == -EAGAIN)- goto again;- break;- } bh = sb\_bread(inode->i\_sb, ce->e\_block); if (!bh) { EXT4\_ERROR\_INODE(inode, "block %lu read error",@@ -1640,7 +1638,7 @@ again: return bh; } brelse(bh);- ce = mb\_cache\_entry\_find\_next(ce, inode->i\_sb->s\_bdev, hash);+ ce = mb2\_cache\_entry\_find\_next(ext4\_mb\_cache, ce); } return NULL; }@@ -1715,15 +1713,15 @@ static void ext4\_xattr\_rehash(struct ext4\_xattr\_header \*header,  #define HASH\_BUCKET\_BITS 10 -struct mb\_cache \*-ext4\_xattr\_create\_cache(char \*name)+struct mb2\_cache \*+ext4\_xattr\_create\_cache(void) {- return mb\_cache\_create(name, HASH\_BUCKET\_BITS);+ return mb2\_cache\_create(HASH\_BUCKET\_BITS); } -void ext4\_xattr\_destroy\_cache(struct mb\_cache \*cache)+void ext4\_xattr\_destroy\_cache(struct mb2\_cache \*cache) { if (cache)- mb\_cache\_destroy(cache);+ mb2\_cache\_destroy(cache); } diff --git a/fs/ext4/xattr.h b/fs/ext4/xattr.hindex ddc0957760ba00..10b0f7323ed6fc 100644--- a/[fs/ext4/xattr.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/xattr.h?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)+++ b/[fs/ext4/xattr.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/xattr.h?id=82939d7999dfc1f1998c4b1c12e2f19edbdff272)@@ -108,7 +108,6 @@ extern int ext4\_xattr\_set(struct inode \*, int, const char \*, const void \*, size\_ extern int ext4\_xattr\_set\_handle(handle\_t \*, struct inode \*, int, const char \*, const void \*, size\_t, int);  extern void ext4\_xattr\_delete\_inode(handle\_t \*, struct inode \*);-extern void ext4\_xattr\_put\_super(struct super\_block \*);  extern int ext4\_expand\_extra\_isize\_ea(struct inode \*inode, int new\_extra\_isize, struct ext4\_inode \*raw\_inode, handle\_t \*handle);@@ -124,8 +123,8 @@ extern int ext4\_xattr\_ibody\_inline\_set(handle\_t \*handle, struct inode \*inode, struct ext4\_xattr\_info \*i, struct ext4\_xattr\_ibody\_find \*is); -extern struct mb\_cache \*ext4\_xattr\_create\_cache(char \*name);-extern void ext4\_xattr\_destroy\_cache(struct mb\_cache \*);+extern struct mb2\_cache \*ext4\_xattr\_create\_cache(void);+extern void ext4\_xattr\_destroy\_cache(struct mb2\_cache \*);  #ifdef CONFIG\_EXT4\_FS\_SECURITY extern int ext4\_init\_security(handle\_t \*handle, struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 21:01:43 +0000



=== Content from bugzilla.redhat.com_f51dc33b_20250125_210312.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1360968)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1360968)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1360968)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1360968

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1360968**](show_bug.cgi?id=1360968)
(CVE-2015-8952)
- [CVE-2015-8952](https://access.redhat.com/security/cve/CVE-2015-8952) kernel: mbcache code subject to softlockup DOS in cache management

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2015-8952 kernel: mbcache code subject to softlockup DOS in cache management

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED WONTFIX | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2015-8952 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | low | | [Severity:](page.cgi?id=fields.html#bug_severity) | low | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1368919](show_bug.cgi?id=1368919 "CLOSED CURRENTRELEASE - CVE-2015-8952 kernel: mbcache code subject to softlockup DOS in cache management [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1352636](show_bug.cgi?id=1352636) | | TreeView+ | [depends on](buglist.cgi?bug_id=1360968&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1360968&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2016-07-28 05:10 UTC by Wade Mealing | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-05-12 16:51 UTC ([History](show_activity.cgi?id=1360968)) | | [CC List:](page.cgi?id=fields.html#cclist) | 19 users (show)  aquini bhu dhoward fhrbata iboverma jkacur joelsmith jross kernel-mgr kstutsma lgoncalv matt mcressma nmurray plougher rvrbovsk security-response-team slawomir williams | | Fixed In Version: |  | | | Doc Type: | If docs needed, set a value | | | Doc Text: | A design flaw was found in the file extended attribute handling of the Linux kernel's handling of cached attributes. Too many entries in the cache cause a soft lockup while attempting to iterate the cache and access relevant locks. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2019-06-08 02:56:42 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1360968#c0)  Wade Mealing    2016-07-28 05:10:20 UTC  ``` A design flaw was found in the file extended attribute handling of the linux kernels handling of cached attributes.  Too many entries in the cache cause a soft lockup while attempting to iterate the cache and access relevant locks.  Upstream has replaced the mbcache code with an updated version which was not a patch but a clear-cut reimplentation of the code.  Upstream discussion: <https://lwn.net/Articles/668718/>  Bugzilla kernel submission: <https://bugzilla.kernel.org/show_bug.cgi?id=107301>  Probable fix: <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=be0726d33cb8f411945884664924bed3cb8c70ee>   ```  [Comment 2](show_bug.cgi?id=1360968#c2)  Wade Mealing    2016-07-28 06:27:34 UTC  ``` Acknowledgements:  Red Hat would like to thank Laurent Guerby for bringing this to our attention.   ```  [Comment 3](show_bug.cgi?id=1360968#c3)  Wade Mealing    2016-08-18 03:09:32 UTC  ``` Statement:  This issue does not affect any shiping version of Red Hat Enterprise Linux.   ```  [Comment 4](show_bug.cgi?id=1360968#c4)  Prasad Pandit    2016-08-22 06:35:33 UTC  ```  Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1368919](show_bug.cgi?id=1368919 "CLOSED CURRENTRELEASE - CVE-2015-8952 kernel: mbcache code subject to softlockup DOS in cache management [fedora-all]")]   ```  [Comment 6](show_bug.cgi?id=1360968#c6)  Andrej Nemec    2016-08-26 08:00:13 UTC  ``` CVE assignment:  <http://seclists.org/oss-sec/2016/q3/378>   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1360968&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from github.com_552c26d0_20250125_210314.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fbe0726d33cb8f411945884664924bed3cb8c70ee)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fbe0726d33cb8f411945884664924bed3cb8c70ee)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/be0726d33cb8f411945884664924bed3cb8c70ee)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ext2: convert to mbcache2

[Browse files](/torvalds/linux/tree/be0726d33cb8f411945884664924bed3cb8c70ee)
Browse the repository at this point in the history

```
The conversion is generally straightforward. We convert filesystem from
a global cache to per-fs one. Similarly to ext4 the tricky part is that
xattr block corresponding to found mbcache entry can get freed before we
get buffer lock for that block. So we have to check whether the entry is
still valid after getting the buffer lock.

Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
```

* Loading branch information

[![@jankara](https://avatars.githubusercontent.com/u/5585575?s=40&v=4)](/jankara) [![@tytso](https://avatars.githubusercontent.com/u/51416?s=40&v=4)](/tytso)

[jankara](/torvalds/linux/commits?author=jankara "View all commits by jankara")
authored and
[tytso](/torvalds/linux/commits?author=tytso "View all commits by tytso")
committed
Feb 22, 2016

1 parent
[82939d7](/torvalds/linux/commit/82939d7999dfc1f1998c4b1c12e2f19edbdff272)

commit be0726d

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**92 additions**
and
**100 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* fs/ext2

  + fs/ext2/ext2.h
    [ext2.h](#diff-fbe703b6d326aaeca7ac51c2109494f3b4e2fb5fb065e8e95b92fd83a45025c4)
  + fs/ext2/super.c
    [super.c](#diff-feabcd23c9cfe70befd929e5fd48d6129a644502df54ab8bd83c4bc1a88e0bbd)
  + fs/ext2/xattr.c
    [xattr.c](#diff-a8ab8ad25419c124abee57dc0e568ac68bc8d99c4fac7b66608687db8ae2202d)
  + fs/ext2/xattr.h
    [xattr.h](#diff-9aa8ea1ee0f2e476f17a77f210311418dd999f64292f1ce9f4e6b83e4e551229)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[fs/ext2/ext2.h](#diff-fbe703b6d326aaeca7ac51c2109494f3b4e2fb5fb065e8e95b92fd83a45025c4 "fs/ext2/ext2.h")

Show comments

[View file](/torvalds/linux/blob/be0726d33cb8f411945884664924bed3cb8c70ee/fs/ext2/ext2.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -61,6 +61,8 @@ struct ext2\_block\_alloc\_info { |
|  |  | #define rsv\_start rsv\_window.\_rsv\_start |
|  |  | #define rsv\_end rsv\_window.\_rsv\_end |
|  |  |  |
|  |  | struct mb2\_cache; |
|  |  |  |
|  |  | /\* |
|  |  | \* second extended-fs super-block data in memory |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -111,6 +113,7 @@ struct ext2\_sb\_info { |
|  |  | \* of the mount options. |
|  |  | \*/ |
|  |  | spinlock\_t s\_lock; |
|  |  | struct mb2\_cache \*s\_mb\_cache; |
|  |  | }; |
|  |  |  |
|  |  | static inline spinlock\_t \* |
| Expand Down | |  |

25 changes: 17 additions & 8 deletions

25
[fs/ext2/super.c](#diff-feabcd23c9cfe70befd929e5fd48d6129a644502df54ab8bd83c4bc1a88e0bbd "fs/ext2/super.c")

Show comments

[View file](/torvalds/linux/blob/be0726d33cb8f411945884664924bed3cb8c70ee/fs/ext2/super.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -131,7 +131,10 @@ static void ext2\_put\_super (struct super\_block \* sb) |
|  |  |  |
|  |  | dquot\_disable(sb, -1, DQUOT\_USAGE\_ENABLED | DQUOT\_LIMITS\_ENABLED); |
|  |  |  |
|  |  | ext2\_xattr\_put\_super(sb); |
|  |  | if (sbi->s\_mb\_cache) { |
|  |  | ext2\_xattr\_destroy\_cache(sbi->s\_mb\_cache); |
|  |  | sbi->s\_mb\_cache = NULL; |
|  |  | } |
|  |  | if (!(sb->s\_flags & MS\_RDONLY)) { |
|  |  | struct ext2\_super\_block \*es = sbi->s\_es; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1104,6 +1107,14 @@ static int ext2\_fill\_super(struct super\_block \*sb, void \*data, int silent) |
|  |  | ext2\_msg(sb, KERN\_ERR, "error: insufficient memory"); |
|  |  | goto failed\_mount3; |
|  |  | } |
|  |  |  |
|  |  | #ifdef CONFIG\_EXT2\_FS\_XATTR |
|  |  | sbi->s\_mb\_cache = ext2\_xattr\_create\_cache(); |
|  |  | if (!sbi->s\_mb\_cache) { |
|  |  | ext2\_msg(sb, KERN\_ERR, "Failed to create an mb\_cache"); |
|  |  | goto failed\_mount3; |
|  |  | } |
|  |  | #endif |
|  |  | /\* |
|  |  | \* set up enough so that it can read an inode |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -1149,6 +1160,8 @@ static int ext2\_fill\_super(struct super\_block \*sb, void \*data, int silent) |
|  |  | sb->s\_id); |
|  |  | goto failed\_mount; |
|  |  | failed\_mount3: |
|  |  | if (sbi->s\_mb\_cache) |
|  |  | ext2\_xattr\_destroy\_cache(sbi->s\_mb\_cache); |
|  |  | percpu\_counter\_destroy(&sbi->s\_freeblocks\_counter); |
|  |  | percpu\_counter\_destroy(&sbi->s\_freeinodes\_counter); |
|  |  | percpu\_counter\_destroy(&sbi->s\_dirs\_counter); |
| Expand Down  Expand Up | | @@ -1555,28 +1568,24 @@ MODULE\_ALIAS\_FS("ext2"); |
|  |  |  |
|  |  | static int \_\_init init\_ext2\_fs(void) |
|  |  | { |
|  |  | int err = init\_ext2\_xattr(); |
|  |  | if (err) |
|  |  | return err; |
|  |  | int err; |
|  |  |  |
|  |  | err = init\_inodecache(); |
|  |  | if (err) |
|  |  | goto out1; |
|  |  | return err; |
|  |  | err = register\_filesystem(&ext2\_fs\_type); |
|  |  | if (err) |
|  |  | goto out; |
|  |  | return 0; |
|  |  | out: |
|  |  | destroy\_inodecache(); |
|  |  | out1: |
|  |  | exit\_ext2\_xattr(); |
|  |  | return err; |
|  |  | } |
|  |  |  |
|  |  | static void \_\_exit exit\_ext2\_fs(void) |
|  |  | { |
|  |  | unregister\_filesystem(&ext2\_fs\_type); |
|  |  | destroy\_inodecache(); |
|  |  | exit\_ext2\_xattr(); |
|  |  | } |
|  |  |  |
|  |  | MODULE\_AUTHOR("Remy Card and others"); |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `be0726d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fbe0726d33cb8f411945884664924bed3cb8c70ee) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from git.kernel.org_b6e716ee_20250125_210307.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2016-02-22 11:49:09 -0500 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2016-02-22 11:49:09 -0500 |
| commit | [f9a61eb4e2471c56a63cd804c7474128138c38ac](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)) | |
| tree | [4336a713bce2ea6d139775731848816d3b4b30fd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac) | |
| parent | [87f9a031af48defee9f34c6aaf06d6f1988c244d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=87f9a031af48defee9f34c6aaf06d6f1988c244d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac&id2=87f9a031af48defee9f34c6aaf06d6f1988c244d)) | |
| download | [linux-f9a61eb4e2471c56a63cd804c7474128138c38ac.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f9a61eb4e2471c56a63cd804c7474128138c38ac.tar.gz) | |

mbcache2: reimplement mbcacheOriginal mbcache was designed to have more features than what ext?
filesystems ended up using. It supported entry being in more hashes, it
had a home-grown rwlocking of each entry, and one cache could cache
entries from multiple filesystems. This genericity also resulted in more
complex locking, larger cache entries, and generally more code
complexity.
This is reimplementation of the mbcache functionality to exactly fit the
purpose ext? filesystems use it for. Cache entries are now considerably
smaller (7 instead of 13 longs), the code is considerably smaller as
well (414 vs 913 lines of code), and IMO also simpler. The new code is
also much more lightweight.
I have measured the speed using artificial xattr-bench benchmark, which
spawns P processes, each process sets xattr for F different files, and
the value of xattr is randomly chosen from a pool of V values. Averages
of runtimes for 5 runs for various combinations of parameters are below.
The first value in each cell is old mbache, the second value is the new
mbcache.
V=10
F\P 1 2 4 8 16 32 64
10 0.158,0.157 0.208,0.196 0.500,0.277 0.798,0.400 3.258,0.584 13.807,1.047 61.339,2.803
100 0.172,0.167 0.279,0.222 0.520,0.275 0.825,0.341 2.981,0.505 12.022,1.202 44.641,2.943
1000 0.185,0.174 0.297,0.239 0.445,0.283 0.767,0.340 2.329,0.480 6.342,1.198 16.440,3.888
V=100
F\P 1 2 4 8 16 32 64
10 0.162,0.153 0.200,0.186 0.362,0.257 0.671,0.496 1.433,0.943 3.801,1.345 7.938,2.501
100 0.153,0.160 0.221,0.199 0.404,0.264 0.945,0.379 1.556,0.485 3.761,1.156 7.901,2.484
1000 0.215,0.191 0.303,0.246 0.471,0.288 0.960,0.347 1.647,0.479 3.916,1.176 8.058,3.160
V=1000
F\P 1 2 4 8 16 32 64
10 0.151,0.129 0.210,0.163 0.326,0.245 0.685,0.521 1.284,0.859 3.087,2.251 6.451,4.801
100 0.154,0.153 0.211,0.191 0.276,0.282 0.687,0.506 1.202,0.877 3.259,1.954 8.738,2.887
1000 0.145,0.179 0.202,0.222 0.449,0.319 0.899,0.333 1.577,0.524 4.221,1.240 9.782,3.579
V=10000
F\P 1 2 4 8 16 32 64
10 0.161,0.154 0.198,0.190 0.296,0.256 0.662,0.480 1.192,0.818 2.989,2.200 6.362,4.746
100 0.176,0.174 0.236,0.203 0.326,0.255 0.696,0.511 1.183,0.855 4.205,3.444 19.510,17.760
1000 0.199,0.183 0.240,0.227 1.159,1.014 2.286,2.154 6.023,6.039 ---,10.933 ---,36.620
V=100000
F\P 1 2 4 8 16 32 64
10 0.171,0.162 0.204,0.198 0.285,0.230 0.692,0.500 1.225,0.881 2.990,2.243 6.379,4.771
100 0.151,0.171 0.220,0.210 0.295,0.255 0.720,0.518 1.226,0.844 3.423,2.831 19.234,17.544
1000 0.192,0.189 0.249,0.225 1.162,1.043 2.257,2.093 5.853,4.997 ---,10.399 ---,32.198
We see that the new code is faster in pretty much all the cases and
starting from 4 processes there are significant gains with the new code
resulting in upto 20-times shorter runtimes. Also for large numbers of
cached entries all values for the old code could not be measured as the
kernel started hitting softlockups and died before the test completed.
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)

| -rw-r--r-- | [fs/Makefile](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/Makefile?id=f9a61eb4e2471c56a63cd804c7474128138c38ac) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/mbcache2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/mbcache2.c?id=f9a61eb4e2471c56a63cd804c7474128138c38ac) | 359 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/mbcache2.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/mbcache2.h?id=f9a61eb4e2471c56a63cd804c7474128138c38ac) | 50 | |  |  |  | | --- | --- | --- | |

3 files changed, 410 insertions, 1 deletions

| diff --git a/fs/Makefile b/fs/Makefileindex 79f522575cba3e..15b3d6c4e46ac9 100644--- a/[fs/Makefile](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/Makefile?id=87f9a031af48defee9f34c6aaf06d6f1988c244d)+++ b/[fs/Makefile](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/Makefile?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)@@ -41,7 +41,7 @@ obj-$(CONFIG\_COMPAT\_BINFMT\_ELF) += compat\_binfmt\_elf.o obj-$(CONFIG\_BINFMT\_ELF\_FDPIC) += binfmt\_elf\_fdpic.o obj-$(CONFIG\_BINFMT\_FLAT) += binfmt\_flat.o -obj-$(CONFIG\_FS\_MBCACHE) += mbcache.o+obj-$(CONFIG\_FS\_MBCACHE) += mbcache.o mbcache2.o obj-$(CONFIG\_FS\_POSIX\_ACL) += posix\_acl.o obj-$(CONFIG\_NFS\_COMMON) += nfs\_common/ obj-$(CONFIG\_COREDUMP) += coredump.odiff --git a/fs/mbcache2.c b/fs/mbcache2.cnew file mode 100644index 00000000000000..5c3e1a8c38f61a--- /dev/null+++ b/[fs/mbcache2.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/mbcache2.c?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)@@ -0,0 +1,359 @@+#include <linux/spinlock.h>+#include <linux/slab.h>+#include <linux/list.h>+#include <linux/list\_bl.h>+#include <linux/module.h>+#include <linux/sched.h>+#include <linux/mbcache2.h>++/\*+ \* Mbcache is a simple key-value store. Keys need not be unique, however+ \* key-value pairs are expected to be unique (we use this fact in+ \* mb2\_cache\_entry\_delete\_block()).+ \*+ \* Ext2 and ext4 use this cache for deduplication of extended attribute blocks.+ \* They use hash of a block contents as a key and block number as a value.+ \* That's why keys need not be unique (different xattr blocks may end up having+ \* the same hash). However block number always uniquely identifies a cache+ \* entry.+ \*+ \* We provide functions for creation and removal of entries, search by key,+ \* and a special "delete entry with given key-value pair" operation. Fixed+ \* size hash table is used for fast key lookups.+ \*/++struct mb2\_cache {+ /\* Hash table of entries \*/+ struct hlist\_bl\_head \*c\_hash;+ /\* log2 of hash table size \*/+ int c\_bucket\_bits;+ /\* Protects c\_lru\_list, c\_entry\_count \*/+ spinlock\_t c\_lru\_list\_lock;+ struct list\_head c\_lru\_list;+ /\* Number of entries in cache \*/+ unsigned long c\_entry\_count;+ struct shrinker c\_shrink;+};++static struct kmem\_cache \*mb2\_entry\_cache;++/\*+ \* mb2\_cache\_entry\_create - create entry in cache+ \* @cache - cache where the entry should be created+ \* @mask - gfp mask with which the entry should be allocated+ \* @key - key of the entry+ \* @block - block that contains data+ \*+ \* Creates entry in @cache with key @key and records that data is stored in+ \* block @block. The function returns -EBUSY if entry with the same key+ \* and for the same block already exists in cache. Otherwise 0 is returned.+ \*/+int mb2\_cache\_entry\_create(struct mb2\_cache \*cache, gfp\_t mask, u32 key,+ sector\_t block)+{+ struct mb2\_cache\_entry \*entry, \*dup;+ struct hlist\_bl\_node \*dup\_node;+ struct hlist\_bl\_head \*head;++ entry = kmem\_cache\_alloc(mb2\_entry\_cache, mask);+ if (!entry)+ return -ENOMEM;++ INIT\_LIST\_HEAD(&entry->e\_lru\_list);+ /\* One ref for hash, one ref returned \*/+ atomic\_set(&entry->e\_refcnt, 1);+ entry->e\_key = key;+ entry->e\_block = block;+ head = &cache->c\_hash[hash\_32(key, cache->c\_bucket\_bits)];+ entry->e\_hash\_list\_head = head;+ hlist\_bl\_lock(head);+ hlist\_bl\_for\_each\_entry(dup, dup\_node, head, e\_hash\_list) {+ if (dup->e\_key == key && dup->e\_block == block) {+ hlist\_bl\_unlock(head);+ kmem\_cache\_free(mb2\_entry\_cache, entry);+ return -EBUSY;+ }+ }+ hlist\_bl\_add\_head(&entry->e\_hash\_list, head);+ hlist\_bl\_unlock(head);++ spin\_lock(&cache->c\_lru\_list\_lock);+ list\_add\_tail(&entry->e\_lru\_list, &cache->c\_lru\_list);+ /\* Grab ref for LRU list \*/+ atomic\_inc(&entry->e\_refcnt);+ cache->c\_entry\_count++;+ spin\_unlock(&cache->c\_lru\_list\_lock);++ return 0;+}+EXPORT\_SYMBOL(mb2\_cache\_entry\_create);++void \_\_mb2\_cache\_entry\_free(struct mb2\_cache\_entry \*entry)+{+ kmem\_cache\_free(mb2\_entry\_cache, entry);+}+EXPORT\_SYMBOL(\_\_mb2\_cache\_entry\_free);++static struct mb2\_cache\_entry \*\_\_entry\_find(struct mb2\_cache \*cache,+ struct mb2\_cache\_entry \*entry,+ u32 key)+{+ struct mb2\_cache\_entry \*old\_entry = entry;+ struct hlist\_bl\_node \*node;+ struct hlist\_bl\_head \*head;++ if (entry)+ head = entry->e\_hash\_list\_head;+ else+ head = &cache->c\_hash[hash\_32(key, cache->c\_bucket\_bits)];+ hlist\_bl\_lock(head);+ if (entry && !hlist\_bl\_unhashed(&entry->e\_hash\_list))+ node = entry->e\_hash\_list.next;+ else+ node = hlist\_bl\_first(head);+ while (node) {+ entry = hlist\_bl\_entry(node, struct mb2\_cache\_entry,+ e\_hash\_list);+ if (entry->e\_key == key) {+ atomic\_inc(&entry->e\_refcnt);+ goto out;+ }+ node = node->next;+ }+ entry = NULL;+out:+ hlist\_bl\_unlock(head);+ if (old\_entry)+ mb2\_cache\_entry\_put(cache, old\_entry);++ return entry;+}++/\*+ \* mb2\_cache\_entry\_find\_first - find the first entry in cache with given key+ \* @cache: cache where we should search+ \* @key: key to look for+ \*+ \* Search in @cache for entry with key @key. Grabs reference to the first+ \* entry found and returns the entry.+ \*/+struct mb2\_cache\_entry \*mb2\_cache\_entry\_find\_first(struct mb2\_cache \*cache,+ u32 key)+{+ return \_\_entry\_find(cache, NULL, key);+}+EXPORT\_SYMBOL(mb2\_cache\_entry\_find\_first);++/\*+ \* mb2\_cache\_entry\_find\_next - find next entry in cache with the same+ \* @cache: cache where we should search+ \* @entry: entry to start search from+ \*+ \* Finds next entry in the hash chain which has the same key as @entry.+ \* If @entry is unhashed (which can happen when deletion of entry races+ \* with the search), finds the first entry in the hash chain. The function+ \* drops reference to @entry and returns with a reference to the found entry.+ \*/+struct mb2\_cache\_entry \*mb2\_cache\_entry\_find\_next(struct mb2\_cache \*cache,+ struct mb2\_cache\_entry \*entry)+{+ return \_\_entry\_find(cache, entry, entry->e\_key);+}+EXPORT\_SYMBOL(mb2\_cache\_entry\_find\_next);++/\* mb2\_cache\_entry\_delete\_block - remove information about block from cache+ \* @cache - cache we work with+ \* @key - key of the entry to remove+ \* @block - block containing data for @key+ \*+ \* Remove entry from cache @cache with key @key with data stored in @block.+ \*/+void mb2\_cache\_entry\_delete\_block(struct mb2\_cache \*cache, u32 key,+ sector\_t block)+{+ struct hlist\_bl\_node \*node;+ struct hlist\_bl\_head \*head;+ struct mb2\_cache\_entry \*entry;++ head = &cache->c\_hash[hash\_32(key, cache->c\_bucket\_bits)];+ hlist\_bl\_lock(head);+ hlist\_bl\_for\_each\_entry(entry, node, head, e\_hash\_list) {+ if (entry->e\_key == key && entry->e\_block == block) {+ /\* We keep hash list reference to keep entry alive \*/+ hlist\_bl\_del\_init(&entry->e\_hash\_list);+ hlist\_bl\_unlock(head);+ spin\_lock(&cache->c\_lru\_list\_lock);+ if (!list\_empty(&entry->e\_lru\_list)) {+ list\_del\_init(&entry->e\_lru\_list);+ cache->c\_entry\_count--;+ atomic\_dec(&entry->e\_refcnt);+ }+ spin\_unlock(&cache->c\_lru\_list\_lock);+ mb2\_cache\_entry\_put(cache, entry);+ return;+ }+ }+ hlist\_bl\_unlock(head);+}+EXPORT\_SYMBOL(mb2\_cache\_entry\_delete\_block);++/\* mb2\_cache\_entry\_touch - cache entry got used+ \* @cache - cache the entry belongs to+ \* @entry - entry that got used+ \*+ \* Move entry in lru list to reflect the fact that it was used.+ \*/+void mb2\_cache\_entry\_touch(struct mb2\_cache \*cache,+ struct mb2\_cache\_entry \*entry)+{+ spin\_lock(&cache->c\_lru\_list\_lock);+ if (!list\_empty(&entry->e\_lru\_list))+ list\_move\_tail(&cache->c\_lru\_list, &entry->e\_lru\_list);+ spin\_unlock(&cache->c\_lru\_list\_lock);+}+EXPORT\_SYMBOL(mb2\_cache\_entry\_touch);++static unsigned long mb2\_cache\_count(struct shrinker \*shrink,+ struct shrink\_control \*sc)+{+ struct mb2\_cache \*cache = container\_of(shrink, struct mb2\_cache,+ c\_shrink);++ return cache->c\_entry\_count;+}++/\* Shrink number of entries in cache \*/+static unsigned long mb2\_cache\_scan(struct shrinker \*shrink,+ struct shrink\_control \*sc)+{+ int nr\_to\_scan = sc->nr\_to\_scan;+ struct mb2\_cache \*cache = container\_of(shrink, struct mb2\_cache,+ c\_shrink);+ struct mb2\_cache\_entry \*entry;+ struct hlist\_bl\_head \*head;+ unsigned int shrunk = 0;++ spin\_lock(&cache->c\_lru\_list\_lock);+ while (nr\_to\_scan-- && !list\_empty(&cache->c\_lru\_list)) {+ entry = list\_first\_entry(&cache->c\_lru\_list,+ struct mb2\_cache\_entry, e\_lru\_list);+ list\_del\_init(&entry->e\_lru\_list);+ cache->c\_entry\_count--;+ /\*+ \* We keep LRU list reference so that entry doesn't go away+ \* from under us.+ \*/+ spin\_unlock(&cache->c\_lru\_list\_lock);+ head = entry->e\_hash\_list\_head;+ hlist\_bl\_lock(head);+ if (!hlist\_bl\_unhashed(&entry->e\_hash\_list)) {+ hlist\_bl\_del\_init(&entry->e\_hash\_list);+ atomic\_dec(&entry->e\_refcnt);+ }+ hlist\_bl\_unlock(head);+ if (mb2\_cache\_entry\_put(cache, entry))+ shrunk++;+ cond\_resched();+ spin\_lock(&cache->c\_lru\_list\_lock);+ }+ spin\_unlock(&cache->c\_lru\_list\_lock);++ return shrunk;+}++/\*+ \* mb2\_cache\_create - create cache+ \* @bucket\_bits: log2 of the hash table size+ \*+ \* Create cache for keys with 2^bucket\_bits hash entries.+ \*/+struct mb2\_cache \*mb2\_cache\_create(int bucket\_bits)+{+ struct mb2\_cache \*cache;+ int bucket\_count = 1 << bucket\_bits;+ int i;++ if (!try\_module\_get(THIS\_MODULE))+ return NULL;++ cache = kzalloc(sizeof(struct mb2\_cache), GFP\_KERNEL);+ if (!cache)+ goto err\_out;+ cache->c\_bucket\_bits = bucket\_bits;+ INIT\_LIST\_HEAD(&cache->c\_lru\_list);+ spin\_lock\_init(&cache->c\_lru\_list\_lock);+ cache->c\_hash = kmalloc(bucket\_count \* sizeof(struct hlist\_bl\_head),+ GFP\_KERNEL);+ if (!cache->c\_hash) {+ kfree(cache);+ goto err\_out;+ }+ for (i = 0; i < bucket\_count; i++)+ INIT\_HLIST\_BL\_HEAD(&cache->c\_hash[i]);++ cache->c\_shrink.count\_objects = mb2\_cache\_count;+ cache->c\_shrink.scan\_objects = mb2\_cache\_scan;+ cache->c\_shrink.seeks = DEFAULT\_SEEKS;+ register\_shrinker(&cache->c\_shrink);++ return cache;++err\_out:+ module\_put(THIS\_MODULE);+ return NULL;+}+EXPORT\_SYMBOL(mb2\_cache\_create);++/\*+ \* mb2\_cache\_destroy - destroy cache+ \* @cache: the cache to destroy+ \*+ \* Free all entries in cache and cache itself. Caller must make sure nobody+ \* (except shrinker) can reach @cache when calling this.+ \*/+void mb2\_cache\_destroy(struct mb2\_cache \*cache)+{+ struct mb2\_cache\_entry \*entry, \*next;++ unregister\_shrinker(&cache->c\_shrink);++ /\*+ \* We don't bother with any locking. Cache must not be used at this+ \* point.+ \*/+ list\_for\_each\_entry\_safe(entry, next, &cache->c\_lru\_list, e\_lru\_list) {+ if (!hlist\_bl\_unhashed(&entry->e\_hash\_list)) {+ hlist\_bl\_del\_init(&entry->e\_hash\_list);+ atomic\_dec(&entry->e\_refcnt);+ } else+ WARN\_ON(1);+ list\_del(&entry->e\_lru\_list);+ WARN\_ON(atomic\_read(&entry->e\_refcnt) != 1);+ mb2\_cache\_entry\_put(cache, entry);+ }+ kfree(cache->c\_hash);+ kfree(cache);+ module\_put(THIS\_MODULE);+}+EXPORT\_SYMBOL(mb2\_cache\_destroy);++static int \_\_init mb2cache\_init(void)+{+ mb2\_entry\_cache = kmem\_cache\_create("mbcache",+ sizeof(struct mb2\_cache\_entry), 0,+ SLAB\_RECLAIM\_ACCOUNT|SLAB\_MEM\_SPREAD, NULL);+ BUG\_ON(!mb2\_entry\_cache);+ return 0;+}++static void \_\_exit mb2cache\_exit(void)+{+ kmem\_cache\_destroy(mb2\_entry\_cache);+}++module\_init(mb2cache\_init)+module\_exit(mb2cache\_exit)++MODULE\_AUTHOR("Jan Kara <jack@suse.cz>");+MODULE\_DESCRIPTION("Meta block cache (for extended attributes)");+MODULE\_LICENSE("GPL");diff --git a/include/linux/mbcache2.h b/include/linux/mbcache2.hnew file mode 100644index 00000000000000..b6f160ff253332--- /dev/null+++ b/[include/linux/mbcache2.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/mbcache2.h?id=f9a61eb4e2471c56a63cd804c7474128138c38ac)@@ -0,0 +1,50 @@+#ifndef \_LINUX\_MB2CACHE\_H+#define \_LINUX\_MB2CACHE\_H++#include <linux/hash.h>+#include <linux/list\_bl.h>+#include <linux/list.h>+#include <linux/atomic.h>+#include <linux/fs.h>++struct mb2\_cache;++struct mb2\_cache\_entry {+ /\* LRU list - protected by cache->c\_lru\_list\_lock \*/+ struct list\_head e\_lru\_list;+ /\* Hash table list - protected by bitlock in e\_hash\_list\_head \*/+ struct hlist\_bl\_node e\_hash\_list;+ atomic\_t e\_refcnt;+ /\* Key in hash - stable during lifetime of the entry \*/+ u32 e\_key;+ /\* Block number of hashed block - stable during lifetime of the entry \*/+ sector\_t e\_block;+ /\* Head of hash list (for list bit lock) - stable \*/+ struct hlist\_bl\_head \*e\_hash\_list\_head;+};++struct mb2\_cache \*mb2\_cache\_create(int bucket\_bits);+void mb2\_cache\_destroy(struct mb2\_cache \*cache);++int mb2\_cache\_entry\_create(struct mb2\_cache \*cache, gfp\_t mask, u32 key,+ sector\_t block);+void \_\_mb2\_cache\_entry\_free(struct mb2\_cache\_entry \*entry);+static inline int mb2\_cache\_entry\_put(struct mb2\_cache \*cache,+ struct mb2\_cache\_entry \*entry)+{+ if (!atomic\_dec\_and\_test(&entry->e\_refcnt))+ return 0;+ \_\_mb2\_cache\_entry\_free(entry);+ return 1;+}++void mb2\_cache\_entry\_delete\_block(struct mb2\_cache \*cache, u32 key,+ sector\_t block);+struct mb2\_cache\_entry \*mb2\_cache\_entry\_find\_first(struct mb2\_cache \*cache,+ u32 key);+struct mb2\_cache\_entry \*mb2\_cache\_entry\_find\_next(struct mb2\_cache \*cache,+ struct mb2\_cache\_entry \*entry);+void mb2\_cache\_entry\_touch(struct mb2\_cache \*cache,+ struct mb2\_cache\_entry \*entry);++#endif /\* \_LINUX\_MB2CACHE\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 21:01:45 +0000



=== Content from github.com_fbd7fd1d_20250125_210316.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ff9a61eb4e2471c56a63cd804c7474128138c38ac)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ff9a61eb4e2471c56a63cd804c7474128138c38ac)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/f9a61eb4e2471c56a63cd804c7474128138c38ac)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

mbcache2: reimplement mbcache

[Browse files](/torvalds/linux/tree/f9a61eb4e2471c56a63cd804c7474128138c38ac)
Browse the repository at this point in the history

```
Original mbcache was designed to have more features than what ext?
filesystems ended up using. It supported entry being in more hashes, it
had a home-grown rwlocking of each entry, and one cache could cache
entries from multiple filesystems. This genericity also resulted in more
complex locking, larger cache entries, and generally more code
complexity.

This is reimplementation of the mbcache functionality to exactly fit the
purpose ext? filesystems use it for. Cache entries are now considerably
smaller (7 instead of 13 longs), the code is considerably smaller as
well (414 vs 913 lines of code), and IMO also simpler. The new code is
also much more lightweight.

I have measured the speed using artificial xattr-bench benchmark, which
spawns P processes, each process sets xattr for F different files, and
the value of xattr is randomly chosen from a pool of V values. Averages
of runtimes for 5 runs for various combinations of parameters are below.
The first value in each cell is old mbache, the second value is the new
mbcache.

V=10
F\P	1		2		4		8		16		32		64
10	0.158,0.157	0.208,0.196	0.500,0.277	0.798,0.400	3.258,0.584	13.807,1.047	61.339,2.803
100	0.172,0.167	0.279,0.222	0.520,0.275	0.825,0.341	2.981,0.505	12.022,1.202	44.641,2.943
1000	0.185,0.174	0.297,0.239	0.445,0.283	0.767,0.340	2.329,0.480	6.342,1.198	16.440,3.888

V=100
F\P	1		2		4		8		16		32		64
10	0.162,0.153	0.200,0.186	0.362,0.257	0.671,0.496	1.433,0.943	3.801,1.345	7.938,2.501
100	0.153,0.160	0.221,0.199	0.404,0.264	0.945,0.379	1.556,0.485	3.761,1.156	7.901,2.484
1000	0.215,0.191	0.303,0.246	0.471,0.288	0.960,0.347	1.647,0.479	3.916,1.176	8.058,3.160

V=1000
F\P	1		2		4		8		16		32		64
10	0.151,0.129	0.210,0.163	0.326,0.245	0.685,0.521	1.284,0.859	3.087,2.251	6.451,4.801
100	0.154,0.153	0.211,0.191	0.276,0.282	0.687,0.506	1.202,0.877	3.259,1.954	8.738,2.887
1000	0.145,0.179	0.202,0.222	0.449,0.319	0.899,0.333	1.577,0.524	4.221,1.240	9.782,3.579

V=10000
F\P	1		2		4		8		16		32		64
10	0.161,0.154	0.198,0.190	0.296,0.256	0.662,0.480	1.192,0.818	2.989,2.200	6.362,4.746
100	0.176,0.174	0.236,0.203	0.326,0.255	0.696,0.511	1.183,0.855	4.205,3.444	19.510,17.760
1000	0.199,0.183	0.240,0.227	1.159,1.014	2.286,2.154	6.023,6.039	---,10.933	---,36.620

V=100000
F\P	1		2		4		8		16		32		64
10	0.171,0.162	0.204,0.198	0.285,0.230	0.692,0.500	1.225,0.881	2.990,2.243	6.379,4.771
100	0.151,0.171	0.220,0.210	0.295,0.255	0.720,0.518	1.226,0.844	3.423,2.831	19.234,17.544
1000	0.192,0.189	0.249,0.225	1.162,1.043	2.257,2.093	5.853,4.997	---,10.399	---,32.198

We see that the new code is faster in pretty much all the cases and
starting from 4 processes there are significant gains with the new code
resulting in upto 20-times shorter runtimes. Also for large numbers of
cached entries all values for the old code could not be measured as the
kernel started hitting softlockups and died before the test completed.

Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
```

* Loading branch information

[![@jankara](https://avatars.githubusercontent.com/u/5585575?s=40&v=4)](/jankara) [![@tytso](https://avatars.githubusercontent.com/u/51416?s=40&v=4)](/tytso)

[jankara](/torvalds/linux/commits?author=jankara "View all commits by jankara")
authored and
[tytso](/torvalds/linux/commits?author=tytso "View all commits by tytso")
committed
Feb 22, 2016

1 parent
[87f9a03](/torvalds/linux/commit/87f9a031af48defee9f34c6aaf06d6f1988c244d)

commit f9a61eb

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**410 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* fs

  + fs/Makefile
    [Makefile](#diff-2f1527f0fd602e0ac3001241ce64da69110203aade9eb22eb26b880450845c1f)
  + fs/mbcache2.c
    [mbcache2.c](#diff-91b7130e15740de25200c67e88eafb486376bc02ba5ff480867537f3496daa09)
* include/linux

  + include/linux/mbcache2.h
    [mbcache2.h](#diff-a724a60e85cd2e5819316518dcf3edd680e9fb5e8293152715c2bd709459e566)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[fs/Makefile](#diff-2f1527f0fd602e0ac3001241ce64da69110203aade9eb22eb26b880450845c1f "fs/Makefile")

Show comments

[View file](/torvalds/linux/blob/f9a61eb4e2471c56a63cd804c7474128138c38ac/fs/Makefile)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -41,7 +41,7 @@ obj-$(CONFIG\_COMPAT\_BINFMT\_ELF) += compat\_binfmt\_elf.o |
|  |  | obj-$(CONFIG\_BINFMT\_ELF\_FDPIC) += binfmt\_elf\_fdpic.o |
|  |  | obj-$(CONFIG\_BINFMT\_FLAT) += binfmt\_flat.o |
|  |  |  |
|  |  | obj-$(CONFIG\_FS\_MBCACHE) += mbcache.o |
|  |  | obj-$(CONFIG\_FS\_MBCACHE) += mbcache.o mbcache2.o |
|  |  | obj-$(CONFIG\_FS\_POSIX\_ACL) += posix\_acl.o |
|  |  | obj-$(CONFIG\_NFS\_COMMON) += nfs\_common/ |
|  |  | obj-$(CONFIG\_COREDUMP) += coredump.o |
| Expand Down | |  |

359 changes: 359 additions & 0 deletions

359
[fs/mbcache2.c](#diff-91b7130e15740de25200c67e88eafb486376bc02ba5ff480867537f3496daa09 "fs/mbcache2.c")

Show comments

[View file](/torvalds/linux/blob/f9a61eb4e2471c56a63cd804c7474128138c38ac/fs/mbcache2.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,359 @@ |
|  |  | #include <linux/spinlock.h> |
|  |  | #include <linux/slab.h> |
|  |  | #include <linux/list.h> |
|  |  | #include <linux/list\_bl.h> |
|  |  | #include <linux/module.h> |
|  |  | #include <linux/sched.h> |
|  |  | #include <linux/mbcache2.h> |
|  |  |  |
|  |  | /\* |
|  |  | \* Mbcache is a simple key-value store. Keys need not be unique, however |
|  |  | \* key-value pairs are expected to be unique (we use this fact in |
|  |  | \* mb2\_cache\_entry\_delete\_block()). |
|  |  | \* |
|  |  | \* Ext2 and ext4 use this cache for deduplication of extended attribute blocks. |
|  |  | \* They use hash of a block contents as a key and block number as a value. |
|  |  | \* That's why keys need not be unique (different xattr blocks may end up having |
|  |  | \* the same hash). However block number always uniquely identifies a cache |
|  |  | \* entry. |
|  |  | \* |
|  |  | \* We provide functions for creation and removal of entries, search by key, |
|  |  | \* and a special "delete entry with given key-value pair" operation. Fixed |
|  |  | \* size hash table is used for fast key lookups. |
|  |  | \*/ |
|  |  |  |
|  |  | struct mb2\_cache { |
|  |  | /\* Hash table of entries \*/ |
|  |  | struct hlist\_bl\_head \*c\_hash; |
|  |  | /\* log2 of hash table size \*/ |
|  |  | int c\_bucket\_bits; |
|  |  | /\* Protects c\_lru\_list, c\_entry\_count \*/ |
|  |  | spinlock\_t c\_lru\_list\_lock; |
|  |  | struct list\_head c\_lru\_list; |
|  |  | /\* Number of entries in cache \*/ |
|  |  | unsigned long c\_entry\_count; |
|  |  | struct shrinker c\_shrink; |
|  |  | }; |
|  |  |  |
|  |  | static struct kmem\_cache \*mb2\_entry\_cache; |
|  |  |  |
|  |  | /\* |
|  |  | \* mb2\_cache\_entry\_create - create entry in cache |
|  |  | \* @cache - cache where the entry should be created |
|  |  | \* @mask - gfp mask with which the entry should be allocated |
|  |  | \* @key - key of the entry |
|  |  | \* @block - block that contains data |
|  |  | \* |
|  |  | \* Creates entry in @cache with key @key and records that data is stored in |
|  |  | \* block @block. The function returns -EBUSY if entry with the same key |
|  |  | \* and for the same block already exists in cache. Otherwise 0 is returned. |
|  |  | \*/ |
|  |  | int mb2\_cache\_entry\_create(struct mb2\_cache \*cache, gfp\_t mask, u32 key, |
|  |  | sector\_t block) |
|  |  | { |
|  |  | struct mb2\_cache\_entry \*entry, \*dup; |
|  |  | struct hlist\_bl\_node \*dup\_node; |
|  |  | struct hlist\_bl\_head \*head; |
|  |  |  |
|  |  | entry = kmem\_cache\_alloc(mb2\_entry\_cache, mask); |
|  |  | if (!entry) |
|  |  | return -ENOMEM; |
|  |  |  |
|  |  | INIT\_LIST\_HEAD(&entry->e\_lru\_list); |
|  |  | /\* One ref for hash, one ref returned \*/ |
|  |  | atomic\_set(&entry->e\_refcnt, 1); |
|  |  | entry->e\_key = key; |
|  |  | entry->e\_block = block; |
|  |  | head = &cache->c\_hash[hash\_32(key, cache->c\_bucket\_bits)]; |
|  |  | entry->e\_hash\_list\_head = head; |
|  |  | hlist\_bl\_lock(head); |
|  |  | hlist\_bl\_for\_each\_entry(dup, dup\_node, head, e\_hash\_list) { |
|  |  | if (dup->e\_key == key && dup->e\_block == block) { |
|  |  | hlist\_bl\_unlock(head); |
|  |  | kmem\_cache\_free(mb2\_entry\_cache, entry); |
|  |  | return -EBUSY; |
|  |  | } |
|  |  | } |
|  |  | hlist\_bl\_add\_head(&entry->e\_hash\_list, head); |
|  |  | hlist\_bl\_unlock(head); |
|  |  |  |
|  |  | spin\_lock(&cache->c\_lru\_list\_lock); |
|  |  | list\_add\_tail(&entry->e\_lru\_list, &cache->c\_lru\_list); |
|  |  | /\* Grab ref for LRU list \*/ |
|  |  | atomic\_inc(&entry->e\_refcnt); |
|  |  | cache->c\_entry\_count++; |
|  |  | spin\_unlock(&cache->c\_lru\_list\_lock); |
|  |  |  |
|  |  | return 0; |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_entry\_create); |
|  |  |  |
|  |  | void \_\_mb2\_cache\_entry\_free(struct mb2\_cache\_entry \*entry) |
|  |  | { |
|  |  | kmem\_cache\_free(mb2\_entry\_cache, entry); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(\_\_mb2\_cache\_entry\_free); |
|  |  |  |
|  |  | static struct mb2\_cache\_entry \*\_\_entry\_find(struct mb2\_cache \*cache, |
|  |  | struct mb2\_cache\_entry \*entry, |
|  |  | u32 key) |
|  |  | { |
|  |  | struct mb2\_cache\_entry \*old\_entry = entry; |
|  |  | struct hlist\_bl\_node \*node; |
|  |  | struct hlist\_bl\_head \*head; |
|  |  |  |
|  |  | if (entry) |
|  |  | head = entry->e\_hash\_list\_head; |
|  |  | else |
|  |  | head = &cache->c\_hash[hash\_32(key, cache->c\_bucket\_bits)]; |
|  |  | hlist\_bl\_lock(head); |
|  |  | if (entry && !hlist\_bl\_unhashed(&entry->e\_hash\_list)) |
|  |  | node = entry->e\_hash\_list.next; |
|  |  | else |
|  |  | node = hlist\_bl\_first(head); |
|  |  | while (node) { |
|  |  | entry = hlist\_bl\_entry(node, struct mb2\_cache\_entry, |
|  |  | e\_hash\_list); |
|  |  | if (entry->e\_key == key) { |
|  |  | atomic\_inc(&entry->e\_refcnt); |
|  |  | goto out; |
|  |  | } |
|  |  | node = node->next; |
|  |  | } |
|  |  | entry = NULL; |
|  |  | out: |
|  |  | hlist\_bl\_unlock(head); |
|  |  | if (old\_entry) |
|  |  | mb2\_cache\_entry\_put(cache, old\_entry); |
|  |  |  |
|  |  | return entry; |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* mb2\_cache\_entry\_find\_first - find the first entry in cache with given key |
|  |  | \* @cache: cache where we should search |
|  |  | \* @key: key to look for |
|  |  | \* |
|  |  | \* Search in @cache for entry with key @key. Grabs reference to the first |
|  |  | \* entry found and returns the entry. |
|  |  | \*/ |
|  |  | struct mb2\_cache\_entry \*mb2\_cache\_entry\_find\_first(struct mb2\_cache \*cache, |
|  |  | u32 key) |
|  |  | { |
|  |  | return \_\_entry\_find(cache, NULL, key); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_entry\_find\_first); |
|  |  |  |
|  |  | /\* |
|  |  | \* mb2\_cache\_entry\_find\_next - find next entry in cache with the same |
|  |  | \* @cache: cache where we should search |
|  |  | \* @entry: entry to start search from |
|  |  | \* |
|  |  | \* Finds next entry in the hash chain which has the same key as @entry. |
|  |  | \* If @entry is unhashed (which can happen when deletion of entry races |
|  |  | \* with the search), finds the first entry in the hash chain. The function |
|  |  | \* drops reference to @entry and returns with a reference to the found entry. |
|  |  | \*/ |
|  |  | struct mb2\_cache\_entry \*mb2\_cache\_entry\_find\_next(struct mb2\_cache \*cache, |
|  |  | struct mb2\_cache\_entry \*entry) |
|  |  | { |
|  |  | return \_\_entry\_find(cache, entry, entry->e\_key); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_entry\_find\_next); |
|  |  |  |
|  |  | /\* mb2\_cache\_entry\_delete\_block - remove information about block from cache |
|  |  | \* @cache - cache we work with |
|  |  | \* @key - key of the entry to remove |
|  |  | \* @block - block containing data for @key |
|  |  | \* |
|  |  | \* Remove entry from cache @cache with key @key with data stored in @block. |
|  |  | \*/ |
|  |  | void mb2\_cache\_entry\_delete\_block(struct mb2\_cache \*cache, u32 key, |
|  |  | sector\_t block) |
|  |  | { |
|  |  | struct hlist\_bl\_node \*node; |
|  |  | struct hlist\_bl\_head \*head; |
|  |  | struct mb2\_cache\_entry \*entry; |
|  |  |  |
|  |  | head = &cache->c\_hash[hash\_32(key, cache->c\_bucket\_bits)]; |
|  |  | hlist\_bl\_lock(head); |
|  |  | hlist\_bl\_for\_each\_entry(entry, node, head, e\_hash\_list) { |
|  |  | if (entry->e\_key == key && entry->e\_block == block) { |
|  |  | /\* We keep hash list reference to keep entry alive \*/ |
|  |  | hlist\_bl\_del\_init(&entry->e\_hash\_list); |
|  |  | hlist\_bl\_unlock(head); |
|  |  | spin\_lock(&cache->c\_lru\_list\_lock); |
|  |  | if (!list\_empty(&entry->e\_lru\_list)) { |
|  |  | list\_del\_init(&entry->e\_lru\_list); |
|  |  | cache->c\_entry\_count--; |
|  |  | atomic\_dec(&entry->e\_refcnt); |
|  |  | } |
|  |  | spin\_unlock(&cache->c\_lru\_list\_lock); |
|  |  | mb2\_cache\_entry\_put(cache, entry); |
|  |  | return; |
|  |  | } |
|  |  | } |
|  |  | hlist\_bl\_unlock(head); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_entry\_delete\_block); |
|  |  |  |
|  |  | /\* mb2\_cache\_entry\_touch - cache entry got used |
|  |  | \* @cache - cache the entry belongs to |
|  |  | \* @entry - entry that got used |
|  |  | \* |
|  |  | \* Move entry in lru list to reflect the fact that it was used. |
|  |  | \*/ |
|  |  | void mb2\_cache\_entry\_touch(struct mb2\_cache \*cache, |
|  |  | struct mb2\_cache\_entry \*entry) |
|  |  | { |
|  |  | spin\_lock(&cache->c\_lru\_list\_lock); |
|  |  | if (!list\_empty(&entry->e\_lru\_list)) |
|  |  | list\_move\_tail(&cache->c\_lru\_list, &entry->e\_lru\_list); |
|  |  | spin\_unlock(&cache->c\_lru\_list\_lock); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_entry\_touch); |
|  |  |  |
|  |  | static unsigned long mb2\_cache\_count(struct shrinker \*shrink, |
|  |  | struct shrink\_control \*sc) |
|  |  | { |
|  |  | struct mb2\_cache \*cache = container\_of(shrink, struct mb2\_cache, |
|  |  | c\_shrink); |
|  |  |  |
|  |  | return cache->c\_entry\_count; |
|  |  | } |
|  |  |  |
|  |  | /\* Shrink number of entries in cache \*/ |
|  |  | static unsigned long mb2\_cache\_scan(struct shrinker \*shrink, |
|  |  | struct shrink\_control \*sc) |
|  |  | { |
|  |  | int nr\_to\_scan = sc->nr\_to\_scan; |
|  |  | struct mb2\_cache \*cache = container\_of(shrink, struct mb2\_cache, |
|  |  | c\_shrink); |
|  |  | struct mb2\_cache\_entry \*entry; |
|  |  | struct hlist\_bl\_head \*head; |
|  |  | unsigned int shrunk = 0; |
|  |  |  |
|  |  | spin\_lock(&cache->c\_lru\_list\_lock); |
|  |  | while (nr\_to\_scan-- && !list\_empty(&cache->c\_lru\_list)) { |
|  |  | entry = list\_first\_entry(&cache->c\_lru\_list, |
|  |  | struct mb2\_cache\_entry, e\_lru\_list); |
|  |  | list\_del\_init(&entry->e\_lru\_list); |
|  |  | cache->c\_entry\_count--; |
|  |  | /\* |
|  |  | \* We keep LRU list reference so that entry doesn't go away |
|  |  | \* from under us. |
|  |  | \*/ |
|  |  | spin\_unlock(&cache->c\_lru\_list\_lock); |
|  |  | head = entry->e\_hash\_list\_head; |
|  |  | hlist\_bl\_lock(head); |
|  |  | if (!hlist\_bl\_unhashed(&entry->e\_hash\_list)) { |
|  |  | hlist\_bl\_del\_init(&entry->e\_hash\_list); |
|  |  | atomic\_dec(&entry->e\_refcnt); |
|  |  | } |
|  |  | hlist\_bl\_unlock(head); |
|  |  | if (mb2\_cache\_entry\_put(cache, entry)) |
|  |  | shrunk++; |
|  |  | cond\_resched(); |
|  |  | spin\_lock(&cache->c\_lru\_list\_lock); |
|  |  | } |
|  |  | spin\_unlock(&cache->c\_lru\_list\_lock); |
|  |  |  |
|  |  | return shrunk; |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* mb2\_cache\_create - create cache |
|  |  | \* @bucket\_bits: log2 of the hash table size |
|  |  | \* |
|  |  | \* Create cache for keys with 2^bucket\_bits hash entries. |
|  |  | \*/ |
|  |  | struct mb2\_cache \*mb2\_cache\_create(int bucket\_bits) |
|  |  | { |
|  |  | struct mb2\_cache \*cache; |
|  |  | int bucket\_count = 1 << bucket\_bits; |
|  |  | int i; |
|  |  |  |
|  |  | if (!try\_module\_get(THIS\_MODULE)) |
|  |  | return NULL; |
|  |  |  |
|  |  | cache = kzalloc(sizeof(struct mb2\_cache), GFP\_KERNEL); |
|  |  | if (!cache) |
|  |  | goto err\_out; |
|  |  | cache->c\_bucket\_bits = bucket\_bits; |
|  |  | INIT\_LIST\_HEAD(&cache->c\_lru\_list); |
|  |  | spin\_lock\_init(&cache->c\_lru\_list\_lock); |
|  |  | cache->c\_hash = kmalloc(bucket\_count \* sizeof(struct hlist\_bl\_head), |
|  |  | GFP\_KERNEL); |
|  |  | if (!cache->c\_hash) { |
|  |  | kfree(cache); |
|  |  | goto err\_out; |
|  |  | } |
|  |  | for (i = 0; i < bucket\_count; i++) |
|  |  | INIT\_HLIST\_BL\_HEAD(&cache->c\_hash[i]); |
|  |  |  |
|  |  | cache->c\_shrink.count\_objects = mb2\_cache\_count; |
|  |  | cache->c\_shrink.scan\_objects = mb2\_cache\_scan; |
|  |  | cache->c\_shrink.seeks = DEFAULT\_SEEKS; |
|  |  | register\_shrinker(&cache->c\_shrink); |
|  |  |  |
|  |  | return cache; |
|  |  |  |
|  |  | err\_out: |
|  |  | module\_put(THIS\_MODULE); |
|  |  | return NULL; |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_create); |
|  |  |  |
|  |  | /\* |
|  |  | \* mb2\_cache\_destroy - destroy cache |
|  |  | \* @cache: the cache to destroy |
|  |  | \* |
|  |  | \* Free all entries in cache and cache itself. Caller must make sure nobody |
|  |  | \* (except shrinker) can reach @cache when calling this. |
|  |  | \*/ |
|  |  | void mb2\_cache\_destroy(struct mb2\_cache \*cache) |
|  |  | { |
|  |  | struct mb2\_cache\_entry \*entry, \*next; |
|  |  |  |
|  |  | unregister\_shrinker(&cache->c\_shrink); |
|  |  |  |
|  |  | /\* |
|  |  | \* We don't bother with any locking. Cache must not be used at this |
|  |  | \* point. |
|  |  | \*/ |
|  |  | list\_for\_each\_entry\_safe(entry, next, &cache->c\_lru\_list, e\_lru\_list) { |
|  |  | if (!hlist\_bl\_unhashed(&entry->e\_hash\_list)) { |
|  |  | hlist\_bl\_del\_init(&entry->e\_hash\_list); |
|  |  | atomic\_dec(&entry->e\_refcnt); |
|  |  | } else |
|  |  | WARN\_ON(1); |
|  |  | list\_del(&entry->e\_lru\_list); |
|  |  | WARN\_ON(atomic\_read(&entry->e\_refcnt) != 1); |
|  |  | mb2\_cache\_entry\_put(cache, entry); |
|  |  | } |
|  |  | kfree(cache->c\_hash); |
|  |  | kfree(cache); |
|  |  | module\_put(THIS\_MODULE); |
|  |  | } |
|  |  | EXPORT\_SYMBOL(mb2\_cache\_destroy); |
|  |  |  |
|  |  | static int \_\_init mb2cache\_init(void) |
|  |  | { |
|  |  | mb2\_entry\_cache = kmem\_cache\_create("mbcache", |
|  |  | sizeof(struct mb2\_cache\_entry), 0, |
|  |  | SLAB\_RECLAIM\_ACCOUNT|SLAB\_MEM\_SPREAD, NULL); |
|  |  | BUG\_ON(!mb2\_entry\_cache); |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | static void \_\_exit mb2cache\_exit(void) |
|  |  | { |
|  |  | kmem\_cache\_destroy(mb2\_entry\_cache); |
|  |  | } |
|  |  |  |
|  |  | module\_init(mb2cache\_init) |
|  |  | module\_exit(mb2cache\_exit) |
|  |  |  |
|  |  | MODULE\_AUTHOR("Jan Kara <jack@suse.cz>"); |
|  |  | MODULE\_DESCRIPTION("Meta block cache (for extended attributes)"); |
|  |  | MODULE\_LICENSE("GPL"); |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f9a61eb`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Ff9a61eb4e2471c56a63cd804c7474128138c38ac) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lwn.net_90b4fd68_20250125_210316.html ===


[![LWN.net Logo](https://static.lwn.net/images/logo/barepenguin-70.png)
LWN
.net
News from the source](/)
[![LWN](https://static.lwn.net/images/lcorner-ss.png)](/)

* [**Content**](#t)
  + [Weekly Edition](/current/)
  + [Archives](/Archives/)
  + [Search](/Search/)
  + [Kernel](/Kernel/)
  + [Security](/Security/)
  + [Events calendar](/Calendar/)
  + [Unread comments](/Comments/unread)
  + ---
  + [LWN FAQ](/op/FAQ.lwn)
  + [Write for us](/op/AuthorGuide.lwn)
* [**Edition**](#t)
  + [Return to the Kernel page](/Articles/668321/)

**User:**
**Password:**    |

 |

[**Subscribe**](/subscribe/) /
[**Log in**](/Login/) /
[**New account**](/Login/newaccount)

# ext[24]: MBCache rewrite

| **From**: |  | Jan Kara <jack@suse.cz> |
| --- | --- | --- |
| **To**: |  | Ted Tso <tytso@mit.edu> |
| **Subject**: |  | [PATCH 0/7 v2] ext[24]: MBCache rewrite |
| **Date**: |  | Wed, 16 Dec 2015 18:00:17 +0100 |
| **Message-ID**: |  | <1450285224-1525-1-git-send-email-jack@suse.cz> |
| **Cc**: |  | =?UTF-8?q?Andreas=20Gr=C3=BCnbacher?= <andreas.gruenbacher@gmail.com>, Andreas Dilger <adilger@dilger.ca>, Laurent GUERBY <laurent@guerby.net>, linux-ext4@vger.kernel.org, Jan Kara <jack@suse.cz> |
| **Archive‑link**: |  | [Article](https://lore.kernel.org/all/1450285224-1525-1-git-send-email-jack%40suse.cz/) |

```

Hello,

here is a new version of mbcache rewrite series. I've implemented some small
changes suggested by Andreas since the previous version.

Changes since v1:
* renamed mbcache2 to mbcache (and all functions and structures) once old
  mbcache code is removed.
* renamed LRU list since it isn't LRU anymore
* removed unused mb2_cache_entry_delete() function
* updated explanation of mbcache function
* fixed swapped entries in table of benchmark results

I have also investigated options of not caching xattr blocks with max refcount
but it didn't bring is significant benefit in the measurements I did. We'd
need more sophisticated (and costly) logic to avoid caching many blocks with
the same content which doesn't seem worth it for now.

I also had a look into using rhashtables instead of normal fixed-size hash
table however the complexity increase is noticeable and we'd have to somehow
handle issue with non-unique keys which rhashtables don't support. So again
I've decided the gain is not worth it.

---
Full motivation:

Inspired by recent reports [1] of problems with mbcache I had a look into what
we could to improve it. I found the current code rather overengineered
(counting with single entry being in several indices, having homegrown
implementation of rw semaphore, ...).

After some thinking I've decided to just reimplement mbcache instead of
improving the original code in small steps since the fundamental changes in
locking and layout would be actually harder to review in small steps than in
one big chunk and overall the new mbcache is actually pretty simple piece of
code (~450 lines).

The result of rewrite is smaller code (almost half the original size), smaller
cache entries (7 longs instead of 13), and better performance (see below
for details).

For measuring performance of mbcache I have written a stress test (I called it
xattr-bench). The test spawns P processes, each process sets xattr for F
different files, and the value of xattr is randomly chosen from a pool of V
values. Each process runs until it sets extended attribute 50000 times (this is
arbitrarily chosen number so that run times for the particular test machine are
reasonable). The test machine has 24 CPUs and 64 GB of RAM, the test filesystem
was created on ramdisk. Each test has been run 5 times.

I have measured performance for original mbache, new mbcache2 code where LRU
is implemented as a simple list, mbcache2 where LRU is implemented using
list_lru, and mbcache2 where we keep LRU lazily and just use referenced bit.
I have also measured performance when mbcache was completely disabled (to
be able to quantify how much gain can some loads get from disabling mbcache).
The graphs for different combinations of parameters (I have measured
P=1,2,4,8,16,32,64; F=10,100,1000; V=10,100,1000,10000,100000) can be found
at [2].

Based on the numbers I have chosen the implementation using LRU with referenced
bit for submission. Implementation using list_lru is faster in some heavily
contended cases but slower in most of the cases so I figured it is not worth
it. My measurements show that completely disabling mbcache can still result
in upto ~2x faster execution of the benchmark so even after improvements
there is some gain users like Lustre or Ceph could have from completely
disabling mbcache.

Here is a comparison table with averages of 5 runs. Measured numbers are in
order "old mbcache", "mbcache2 with normal LRU", "mbcache2 with list_lru LRU",
"mbcache2 with referenced bit", "disabled mbcache". Note that some numbers for
"old mbcache" are not available since the machine just dies due to softlockups
under the pressure.

V=10
F\P	1				2				4				8				16				32				64
10	0.158,0.157,0.209,0.155,0.135	0.208,0.196,0.263,0.229,0.154	0.500,0.277,0.364,0.305,0.176	0.798,0.400,0.380,0.384,0.237	3.258,0.584,0.593,0.664,0.500	13.807,1.047,1.029,1.100,0.986	61.339,2.803,3.615,2.994,1.799
100	0.172,0.167,0.161,0.185,0.126	0.279,0.222,0.244,0.222,0.156	0.520,0.275,0.275,0.273,0.199	0.825,0.341,0.408,0.333,0.217	2.981,0.505,0.523,0.523,0.315	12.022,1.202,1.210,1.125,1.293	44.641,2.943,2.869,3.337,13.056
1000	0.185,0.174,0.187,0.153,0.160	0.297,0.239,0.247,0.227,0.176	0.445,0.283,0.276,0.272,0.957	0.767,0.340,0.357,0.324,1.975	2.329,0.480,0.498,0.476,5.391	6.342,1.198,1.235,1.204,8.283	16.440,3.888,3.817,3.896,17.878

V=100
F\P	1				2				4				8				16				32				64
10	0.162,0.153,0.180,0.126,0.126	0.200,0.186,0.241,0.165,0.154	0.362,0.257,0.313,0.208,0.181	0.671,0.496,0.422,0.379,0.194	1.433,0.943,0.773,0.676,0.570	3.801,1.345,1.353,1.221,1.021	7.938,2.501,2.700,2.484,1.790
100	0.153,0.160,0.164,0.130,0.144	0.221,0.199,0.232,0.217,0.166	0.404,0.264,0.300,0.270,0.180	0.945,0.379,0.400,0.322,0.240	1.556,0.485,0.512,0.496,0.339	3.761,1.156,1.214,1.197,1.301	7.901,2.484,2.508,2.526,13.039
1000	0.215,0.191,0.205,0.212,0.156	0.303,0.246,0.246,0.247,0.182	0.471,0.288,0.305,0.300,0.896	0.960,0.347,0.375,0.347,1.892	1.647,0.479,0.530,0.509,4.744	3.916,1.176,1.288,1.205,8.300	8.058,3.160,3.232,3.200,17.616

V=1000
F\P	1				2				4				8				16				32				64
10	0.151,0.129,0.179,0.160,0.130	0.210,0.163,0.248,0.193,0.155	0.326,0.245,0.313,0.204,0.191	0.685,0.521,0.493,0.365,0.210	1.284,0.859,0.772,0.613,0.389	3.087,2.251,1.307,1.745,0.896	6.451,4.801,2.693,3.736,1.806
100	0.154,0.153,0.156,0.159,0.120	0.211,0.191,0.232,0.194,0.158	0.276,0.282,0.286,0.228,0.170	0.687,0.506,0.496,0.400,0.259	1.202,0.877,0.712,0.632,0.326	3.259,1.954,1.564,1.336,1.255	8.738,2.887,14.421,3.111,13.175
1000	0.145,0.179,0.184,0.175,0.156	0.202,0.222,0.218,0.220,0.174	0.449,0.319,0.836,0.276,0.965	0.899,0.333,0.793,0.353,2.002	1.577,0.524,0.529,0.523,4.676	4.221,1.240,1.280,1.281,8.371	9.782,3.579,3.605,3.585,17.425

V=10000
F\P	1				2				4				8				16				32				64
10	0.161,0.154,0.204,0.158,0.137	0.198,0.190,0.271,0.190,0.153	0.296,0.256,0.340,0.229,0.164	0.662,0.480,0.475,0.368,0.239	1.192,0.818,0.785,0.646,0.349	2.989,2.200,1.237,1.725,0.961	6.362,4.746,2.666,3.718,1.793
100	0.176,0.174,0.136,0.155,0.123	0.236,0.203,0.202,0.188,0.165	0.326,0.255,0.267,0.241,0.182	0.696,0.511,0.415,0.387,0.213	1.183,0.855,0.679,0.689,0.330	4.205,3.444,1.444,2.760,1.249	19.510,17.760,15.203,17.387,12.828
1000	0.199,0.183,0.183,0.183,0.164	0.240,0.227,0.225,0.226,0.179	1.159,1.014,1.014,1.036,0.985	2.286,2.154,1.987,2.019,1.997	6.023,6.039,6.594,5.657,5.069	N/A,10.933,9.272,10.382,8.305	N/A,36.620,27.886,36.165,17.683

V=100000
F\P	1				2				4				8				16				32				64
10	0.171,0.162,0.220,0.163,0.143	0.204,0.198,0.272,0.192,0.154	0.285,0.230,0.318,0.218,0.172	0.692,0.500,0.505,0.367,0.210	1.225,0.881,0.827,0.687,0.338	2.990,2.243,1.266,1.696,0.942	6.379,4.771,2.609,3.722,1.778
100	0.151,0.171,0.176,0.171,0.153	0.220,0.210,0.226,0.201,0.167	0.295,0.255,0.265,0.242,0.175	0.720,0.518,0.417,0.387,0.221	1.226,0.844,0.689,0.672,0.343	3.423,2.831,1.392,2.370,1.354	19.234,17.544,15.419,16.700,13.172
1000	0.192,0.189,0.188,0.184,0.164	0.249,0.225,0.223,0.218,0.178	1.162,1.043,1.031,1.024,1.003	2.257,2.093,2.180,2.004,1.960	5.853,4.997,6.143,5.315,5.350	N/A,10.399,8.578,9.190,8.309	N/A,32.198,19.465,19.194,17.210

Thoughs, opinions, comments welcome.

								Honza

[1] <https://bugzilla.kernel.org/show_bug.cgi?id=107301>
[2] <http://beta.suse.com/private/jack/mbcache2/>
--
To unsubscribe from this list: send the line "unsubscribe linux-ext4" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  <http://vger.kernel.org/majordomo-info.html>

```

Copyright © 2015, Eklektix, Inc.

Comments and public postings are copyrighted by their creators.

Linux is a registered trademark of Linus Torvalds



=== Content from usn.ubuntu.com_123b89e3_20250125_210317.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3582-1: Linux kernel vulnerabilities

22 February 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2
* [linux-snapdragon](/security/cves?package=linux-snapdragon) - Linux kernel for Snapdragon processors

## Details

Mohamed Ghannam discovered that the IPv4 raw socket implementation in the

Linux kernel contained a race condition leading to uninitialized pointer

usage. A local attacker could use this to cause a denial of service or

possibly execute arbitrary code. ([CVE-2017-17712](/security/CVE-2017-17712))

Laurent Guerby discovered that the mbcache feature in the ext2 and ext4

filesystems in the Linux kernel improperly handled xattr block caching. A

local attacker could use this to cause a denial of service. ([CVE-2015-8952](/security/CVE-2015-8952))

Vitaly Mayatskikh discovered that the SCSI subsystem in the Linux kernel

did not properly track reference counts when merging buffers. A local

attacker could use this to cause a denial of service (memory exhaustion).

([CVE-2017-12190](/security/CVE-2017-12190))

ChunYu Wang discovered that a use-after-free vulnerability existed in the

SCTP protocol implementation in the Linux kernel. A local attacker could

use this to cause a denial of service (system crash) or possibly execute

arbitrary code, ([CVE-2017-15115](/security/CVE-2017-15115))

Mohamed Ghannam discovered a use-after-free vulnerability in the DCCP

protocol implementation in the Linux kernel. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2017-8824](/security/CVE-2017-8824))

USN-3540-1 mitigated [CVE-2017-5715](/security/CVE-2017-5715) (Spectre Variant 2) for the

amd64 architecture in Ubuntu 16.04 LTS. This update provides the

compiler-based retpoline kernel mitigation for the amd64 and i386

architectures. Original advisory details:

Jann Horn discovered that microprocessors utilizing speculative execution

and branch prediction may allow unauthorized memory reads via sidechannel

attacks. This flaw is known as Spectre. A local attacker could use this to

expose sensitive information, including kernel memory. ([CVE-2017-5715](/security/CVE-2017-5715))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-1019-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [4.4.0-1019.24](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/4.4.0-1019.24)
* [linux-image-4.4.0-1052-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1052.61](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1052.61)
* [linux-image-4.4.0-1085-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.4.0-1085.93](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.4.0-1085.93)
* [linux-image-4.4.0-1087-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon)
  -
  [4.4.0-1087.92](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon/4.4.0-1087.92)
* [linux-image-4.4.0-116-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)
* [linux-image-4.4.0-116-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)
* [linux-image-4.4.0-116-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)
* [linux-image-4.4.0-116-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)
* [linux-image-4.4.0-116-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)
* [linux-image-4.4.0-116-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)
* [linux-image-4.4.0-116-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-116.140](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-116.140)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2015-8952](/security/CVE-2015-8952)
* [CVE-2017-12190](/security/CVE-2017-12190)
* [CVE-2017-15115](/security/CVE-2017-15115)
* [CVE-2017-17712](/security/CVE-2017-17712)
* [CVE-2017-5715](/security/CVE-2017-5715)
* [CVE-2017-8824](/security/CVE-2017-8824)

## Related notices

* [USN-3582-2](/security/notices/USN-3582-2)
* [USN-3487-1](/security/notices/USN-3487-1)
* [USN-3583-2](/security/notices/USN-3583-2)
* [USN-3583-1](/security/notices/USN-3583-1)
* [USN-3581-1](/security/notices/USN-3581-1)
* [USN-3581-3](/security/notices/USN-3581-3)
* [USN-3581-2](/security/notices/USN-3581-2)
* [USN-3530-1](/security/notices/USN-3530-1)
* [USN-3594-1](/security/notices/USN-3594-1)
* [USN-3580-1](/security/notices/USN-3580-1)
* [USN-3620-2](/security/notices/USN-3620-2)
* [USN-3541-2](/security/notices/USN-3541-2)
* [USN-3531-3](/security/notices/USN-3531-3)
* [USN-3560-1](/security/notices/USN-3560-1)
* [USN-3531-1](/security/notices/USN-3531-1)
* [USN-3540-1](/security/notices/USN-3540-1)
* [USN-3540-2](/security/notices/USN-3540-2)
* [USN-3561-1](/security/notices/USN-3561-1)
* [USN-3549-1](/security/notices/USN-3549-1)
* [USN-3777-3](/security/notices/USN-3777-3)
* [USN-3690-1](/security/notices/USN-3690-1)
* [USN-3597-2](/security/notices/USN-3597-2)
* [USN-3516-1](/security/notices/USN-3516-1)
* [USN-3541-1](/security/notices/USN-3541-1)
* [USN-3597-1](/security/notices/USN-3597-1)
* [USN-3542-1](/security/notices/USN-3542-1)
* [USN-3542-2](/security/notices/USN-3542-2)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from github.com_9c9349b5_20250125_210314.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F82939d7999dfc1f1998c4b1c12e2f19edbdff272)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F82939d7999dfc1f1998c4b1c12e2f19edbdff272)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/82939d7999dfc1f1998c4b1c12e2f19edbdff272)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ext4: convert to mbcache2

[Browse files](/torvalds/linux/tree/82939d7999dfc1f1998c4b1c12e2f19edbdff272)
Browse the repository at this point in the history

```
The conversion is generally straightforward. The only tricky part is
that xattr block corresponding to found mbcache entry can get freed
before we get buffer lock for that block. So we have to check whether
the entry is still valid after getting buffer lock.

Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
```

* Loading branch information

[![@jankara](https://avatars.githubusercontent.com/u/5585575?s=40&v=4)](/jankara) [![@tytso](https://avatars.githubusercontent.com/u/51416?s=40&v=4)](/tytso)

[jankara](/torvalds/linux/commits?author=jankara "View all commits by jankara")
authored and
[tytso](/torvalds/linux/commits?author=tytso "View all commits by tytso")
committed
Feb 22, 2016

1 parent
[f9a61eb](/torvalds/linux/commit/f9a61eb4e2471c56a63cd804c7474128138c38ac)

commit 82939d7

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**75 additions**
and
**75 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* fs/ext4

  + fs/ext4/ext4.h
    [ext4.h](#diff-64e57d4ee57a17521615eb4d7b6ed116c30a264f893130761219571fc9f583e8)
  + fs/ext4/super.c
    [super.c](#diff-773a60cd0017df1875af314504cdf90231103034bc5a49c96e38f044e5cb55ec)
  + fs/ext4/xattr.c
    [xattr.c](#diff-a610c34adcfd97e4a91e25006c50cacf506a2a882627ce61353bba3e67f0a1e6)
  + fs/ext4/xattr.h
    [xattr.h](#diff-5093adfdbfe827fe2555fe545570526edbb1d1e44bd5a8f92dc9650c0ae54905)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[fs/ext4/ext4.h](#diff-64e57d4ee57a17521615eb4d7b6ed116c30a264f893130761219571fc9f583e8 "fs/ext4/ext4.h")

Show comments

[View file](/torvalds/linux/blob/82939d7999dfc1f1998c4b1c12e2f19edbdff272/fs/ext4/ext4.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1468,7 +1468,7 @@ struct ext4\_sb\_info { |
|  |  | struct list\_head s\_es\_list; /\* List of inodes with reclaimable extents \*/ |
|  |  | long s\_es\_nr\_inode; |
|  |  | struct ext4\_es\_stats s\_es\_stats; |
|  |  | struct mb\_cache \*s\_mb\_cache; |
|  |  | struct mb2\_cache \*s\_mb\_cache; |
|  |  | spinlock\_t s\_es\_lock \_\_\_\_cacheline\_aligned\_in\_smp; |
|  |  |  |
|  |  | /\* Ratelimit ext4 messages. \*/ |
| Expand Down | |  |

7 changes: 5 additions & 2 deletions

7
[fs/ext4/super.c](#diff-773a60cd0017df1875af314504cdf90231103034bc5a49c96e38f044e5cb55ec "fs/ext4/super.c")

Show comments

[View file](/torvalds/linux/blob/82939d7999dfc1f1998c4b1c12e2f19edbdff272/fs/ext4/super.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -844,7 +844,6 @@ static void ext4\_put\_super(struct super\_block \*sb) |
|  |  | ext4\_release\_system\_zone(sb); |
|  |  | ext4\_mb\_release(sb); |
|  |  | ext4\_ext\_release(sb); |
|  |  | ext4\_xattr\_put\_super(sb); |
|  |  |  |
|  |  | if (!(sb->s\_flags & MS\_RDONLY)) { |
|  |  | ext4\_clear\_feature\_journal\_needs\_recovery(sb); |
| Expand Down  Expand Up | | @@ -3797,7 +3796,7 @@ static int ext4\_fill\_super(struct super\_block \*sb, void \*data, int silent) |
|  |  |  |
|  |  | no\_journal: |
|  |  | if (ext4\_mballoc\_ready) { |
|  |  | sbi->s\_mb\_cache = ext4\_xattr\_create\_cache(sb->s\_id); |
|  |  | sbi->s\_mb\_cache = ext4\_xattr\_create\_cache(); |
|  |  | if (!sbi->s\_mb\_cache) { |
|  |  | ext4\_msg(sb, KERN\_ERR, "Failed to create an mb\_cache"); |
|  |  | goto failed\_mount\_wq; |
| Expand Down  Expand Up | | @@ -4027,6 +4026,10 @@ static int ext4\_fill\_super(struct super\_block \*sb, void \*data, int silent) |
|  |  | if (EXT4\_SB(sb)->rsv\_conversion\_wq) |
|  |  | destroy\_workqueue(EXT4\_SB(sb)->rsv\_conversion\_wq); |
|  |  | failed\_mount\_wq: |
|  |  | if (sbi->s\_mb\_cache) { |
|  |  | ext4\_xattr\_destroy\_cache(sbi->s\_mb\_cache); |
|  |  | sbi->s\_mb\_cache = NULL; |
|  |  | } |
|  |  | if (sbi->s\_journal) { |
|  |  | jbd2\_journal\_destroy(sbi->s\_journal); |
|  |  | sbi->s\_journal = NULL; |
| Expand Down | |  |

136 changes: 67 additions & 69 deletions

136
[fs/ext4/xattr.c](#diff-a610c34adcfd97e4a91e25006c50cacf506a2a882627ce61353bba3e67f0a1e6 "fs/ext4/xattr.c")

Show comments

[View file](/torvalds/linux/blob/82939d7999dfc1f1998c4b1c12e2f19edbdff272/fs/ext4/xattr.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -53,7 +53,7 @@ |
|  |  | #include <linux/init.h> |
|  |  | #include <linux/fs.h> |
|  |  | #include <linux/slab.h> |
|  |  | #include <linux/mbcache.h> |
|  |  | #include <linux/mbcache2.h> |
|  |  | #include <linux/quotaops.h> |
|  |  | #include "ext4\_jbd2.h" |
|  |  | #include "ext4.h" |
| Expand All | | @@ -78,10 +78,10 @@ |
|  |  | # define ea\_bdebug(bh, fmt, ...) no\_printk(fmt, ##\_\_VA\_ARGS\_\_) |
|  |  | #endif |
|  |  |  |
|  |  | static void ext4\_xattr\_cache\_insert(struct mb\_cache \*, struct buffer\_head \*); |
|  |  | static void ext4\_xattr\_cache\_insert(struct mb2\_cache \*, struct buffer\_head \*); |
|  |  | static struct buffer\_head \*ext4\_xattr\_cache\_find(struct inode \*, |
|  |  | struct ext4\_xattr\_header \*, |
|  |  | struct mb\_cache\_entry \*\*); |
|  |  | struct mb2\_cache\_entry \*\*); |
|  |  | static void ext4\_xattr\_rehash(struct ext4\_xattr\_header \*, |
|  |  | struct ext4\_xattr\_entry \*); |
|  |  | static int ext4\_xattr\_list(struct dentry \*dentry, char \*buffer, |
| Expand Down  Expand Up | | @@ -276,7 +276,7 @@ ext4\_xattr\_block\_get(struct inode \*inode, int name\_index, const char \*name, |
|  |  | struct ext4\_xattr\_entry \*entry; |
|  |  | size\_t size; |
|  |  | int error; |
|  |  | struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  | struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  |  |
|  |  | ea\_idebug(inode, "name=%d.%s, buffer=%p, buffer\_size=%ld", |
|  |  | name\_index, name, buffer, (long)buffer\_size); |
| Expand Down  Expand Up | | @@ -428,7 +428,7 @@ ext4\_xattr\_block\_list(struct dentry \*dentry, char \*buffer, size\_t buffer\_size) |
|  |  | struct inode \*inode = d\_inode(dentry); |
|  |  | struct buffer\_head \*bh = NULL; |
|  |  | int error; |
|  |  | struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  | struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  |  |
|  |  | ea\_idebug(inode, "buffer=%p, buffer\_size=%ld", |
|  |  | buffer, (long)buffer\_size); |
| Expand Down  Expand Up | | @@ -545,30 +545,31 @@ static void |
|  |  | ext4\_xattr\_release\_block(handle\_t \*handle, struct inode \*inode, |
|  |  | struct buffer\_head \*bh) |
|  |  | { |
|  |  | struct mb\_cache\_entry \*ce = NULL; |
|  |  | int error = 0; |
|  |  | struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  |  |
|  |  | ce = mb\_cache\_entry\_get(ext4\_mb\_cache, bh->b\_bdev, bh->b\_blocknr); |
|  |  | BUFFER\_TRACE(bh, "get\_write\_access"); |
|  |  | error = ext4\_journal\_get\_write\_access(handle, bh); |
|  |  | if (error) |
|  |  | goto out; |
|  |  |  |
|  |  | lock\_buffer(bh); |
|  |  | if (BHDR(bh)->h\_refcount == cpu\_to\_le32(1)) { |
|  |  | \_\_u32 hash = le32\_to\_cpu(BHDR(bh)->h\_hash); |
|  |  |  |
|  |  | ea\_bdebug(bh, "refcount now=0; freeing"); |
|  |  | if (ce) |
|  |  | mb\_cache\_entry\_free(ce); |
|  |  | /\* |
|  |  | \* This must happen under buffer lock for |
|  |  | \* ext4\_xattr\_block\_set() to reliably detect freed block |
|  |  | \*/ |
|  |  | mb2\_cache\_entry\_delete\_block(EXT4\_GET\_MB\_CACHE(inode), hash, |
|  |  | bh->b\_blocknr); |
|  |  | get\_bh(bh); |
|  |  | unlock\_buffer(bh); |
|  |  | ext4\_free\_blocks(handle, inode, bh, 0, 1, |
|  |  | EXT4\_FREE\_BLOCKS\_METADATA | |
|  |  | EXT4\_FREE\_BLOCKS\_FORGET); |
|  |  | } else { |
|  |  | le32\_add\_cpu(&BHDR(bh)->h\_refcount, -1); |
|  |  | if (ce) |
|  |  | mb\_cache\_entry\_release(ce); |
|  |  | /\* |
|  |  | \* Beware of this ugliness: Releasing of xattr block references |
|  |  | \* from different inodes can race and so we have to protect |
| Expand Down  Expand Up | | @@ -781,28 +782,31 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, |
|  |  | struct super\_block \*sb = inode->i\_sb; |
|  |  | struct buffer\_head \*new\_bh = NULL; |
|  |  | struct ext4\_xattr\_search \*s = &bs->s; |
|  |  | struct mb\_cache\_entry \*ce = NULL; |
|  |  | struct mb2\_cache\_entry \*ce = NULL; |
|  |  | int error = 0; |
|  |  | struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  | struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  |  |
|  |  | #define header(x) ((struct ext4\_xattr\_header \*)(x)) |
|  |  |  |
|  |  | if (i->value && i->value\_len > sb->s\_blocksize) |
|  |  | return -ENOSPC; |
|  |  | if (s->base) { |
|  |  | ce = mb\_cache\_entry\_get(ext4\_mb\_cache, bs->bh->b\_bdev, |
|  |  | bs->bh->b\_blocknr); |
|  |  | BUFFER\_TRACE(bs->bh, "get\_write\_access"); |
|  |  | error = ext4\_journal\_get\_write\_access(handle, bs->bh); |
|  |  | if (error) |
|  |  | goto cleanup; |
|  |  | lock\_buffer(bs->bh); |
|  |  |  |
|  |  | if (header(s->base)->h\_refcount == cpu\_to\_le32(1)) { |
|  |  | if (ce) { |
|  |  | mb\_cache\_entry\_free(ce); |
|  |  | ce = NULL; |
|  |  | } |
|  |  | \_\_u32 hash = le32\_to\_cpu(BHDR(bs->bh)->h\_hash); |
|  |  |  |
|  |  | /\* |
|  |  | \* This must happen under buffer lock for |
|  |  | \* ext4\_xattr\_block\_set() to reliably detect modified |
|  |  | \* block |
|  |  | \*/ |
|  |  | mb2\_cache\_entry\_delete\_block(ext4\_mb\_cache, hash, |
|  |  | bs->bh->b\_blocknr); |
|  |  | ea\_bdebug(bs->bh, "modifying in-place"); |
|  |  | error = ext4\_xattr\_set\_entry(i, s); |
|  |  | if (!error) { |
| Expand All | | @@ -826,10 +830,6 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, |
|  |  | int offset = (char \*)s->here - bs->bh->b\_data; |
|  |  |  |
|  |  | unlock\_buffer(bs->bh); |
|  |  | if (ce) { |
|  |  | mb\_cache\_entry\_release(ce); |
|  |  | ce = NULL; |
|  |  | } |
|  |  | ea\_bdebug(bs->bh, "cloning"); |
|  |  | s->base = kmalloc(bs->bh->b\_size, GFP\_NOFS); |
|  |  | error = -ENOMEM; |
| Expand Down  Expand Up | | @@ -884,6 +884,31 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, |
|  |  | if (error) |
|  |  | goto cleanup\_dquot; |
|  |  | lock\_buffer(new\_bh); |
|  |  | /\* |
|  |  | \* We have to be careful about races with |
|  |  | \* freeing or rehashing of xattr block. Once we |
|  |  | \* hold buffer lock xattr block's state is |
|  |  | \* stable so we can check whether the block got |
|  |  | \* freed / rehashed or not. Since we unhash |
|  |  | \* mbcache entry under buffer lock when freeing |
|  |  | \* / rehashing xattr block, checking whether |
|  |  | \* entry is still hashed is reliable. |
|  |  | \*/ |
|  |  | if (hlist\_bl\_unhashed(&ce->e\_hash\_list)) { |
|  |  | /\* |
|  |  | \* Undo everything and check mbcache |
|  |  | \* again. |
|  |  | \*/ |
|  |  | unlock\_buffer(new\_bh); |
|  |  | dquot\_free\_block(inode, |
|  |  | EXT4\_C2B(EXT4\_SB(sb), |
|  |  | 1)); |
|  |  | brelse(new\_bh); |
|  |  | mb2\_cache\_entry\_put(ext4\_mb\_cache, ce); |
|  |  | ce = NULL; |
|  |  | new\_bh = NULL; |
|  |  | goto inserted; |
|  |  | } |
|  |  | le32\_add\_cpu(&BHDR(new\_bh)->h\_refcount, 1); |
|  |  | ea\_bdebug(new\_bh, "reusing; refcount now=%d", |
|  |  | le32\_to\_cpu(BHDR(new\_bh)->h\_refcount)); |
| Expand All | | @@ -894,7 +919,8 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, |
|  |  | if (error) |
|  |  | goto cleanup\_dquot; |
|  |  | } |
|  |  | mb\_cache\_entry\_release(ce); |
|  |  | mb2\_cache\_entry\_touch(ext4\_mb\_cache, ce); |
|  |  | mb2\_cache\_entry\_put(ext4\_mb\_cache, ce); |
|  |  | ce = NULL; |
|  |  | } else if (bs->bh && s->base == bs->bh->b\_data) { |
|  |  | /\* We were modifying this block in-place. \*/ |
| Expand Down  Expand Up | | @@ -959,7 +985,7 @@ ext4\_xattr\_block\_set(handle\_t \*handle, struct inode \*inode, |
|  |  |  |
|  |  | cleanup: |
|  |  | if (ce) |
|  |  | mb\_cache\_entry\_release(ce); |
|  |  | mb2\_cache\_entry\_put(ext4\_mb\_cache, ce); |
|  |  | brelse(new\_bh); |
|  |  | if (!(bs->bh && s->base == bs->bh->b\_data)) |
|  |  | kfree(s->base); |
| Expand Down  Expand Up | | @@ -1511,17 +1537,6 @@ ext4\_xattr\_delete\_inode(handle\_t \*handle, struct inode \*inode) |
|  |  | brelse(bh); |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* ext4\_xattr\_put\_super() |
|  |  | \* |
|  |  | \* This is called when a file system is unmounted. |
|  |  | \*/ |
|  |  | void |
|  |  | ext4\_xattr\_put\_super(struct super\_block \*sb) |
|  |  | { |
|  |  | mb\_cache\_shrink(sb->s\_bdev); |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* ext4\_xattr\_cache\_insert() |
|  |  | \* |
| Expand All | | @@ -1531,28 +1546,18 @@ ext4\_xattr\_put\_super(struct super\_block \*sb) |
|  |  | \* Returns 0, or a negative error number on failure. |
|  |  | \*/ |
|  |  | static void |
|  |  | ext4\_xattr\_cache\_insert(struct mb\_cache \*ext4\_mb\_cache, struct buffer\_head \*bh) |
|  |  | ext4\_xattr\_cache\_insert(struct mb2\_cache \*ext4\_mb\_cache, struct buffer\_head \*bh) |
|  |  | { |
|  |  | \_\_u32 hash = le32\_to\_cpu(BHDR(bh)->h\_hash); |
|  |  | struct mb\_cache\_entry \*ce; |
|  |  | int error; |
|  |  |  |
|  |  | ce = mb\_cache\_entry\_alloc(ext4\_mb\_cache, GFP\_NOFS); |
|  |  | if (!ce) { |
|  |  | ea\_bdebug(bh, "out of memory"); |
|  |  | return; |
|  |  | } |
|  |  | error = mb\_cache\_entry\_insert(ce, bh->b\_bdev, bh->b\_blocknr, hash); |
|  |  | error = mb2\_cache\_entry\_create(ext4\_mb\_cache, GFP\_NOFS, hash, |
|  |  | bh->b\_blocknr); |
|  |  | if (error) { |
|  |  | mb\_cache\_entry\_free(ce); |
|  |  | if (error == -EBUSY) { |
|  |  | if (error == -EBUSY) |
|  |  | ea\_bdebug(bh, "already in cache"); |
|  |  | error = 0; |
|  |  | } |
|  |  | } else { |
|  |  | } else |
|  |  | ea\_bdebug(bh, "inserting [%x]", (int)hash); |
|  |  | mb\_cache\_entry\_release(ce); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\* |
| Expand Down  Expand Up | | @@ -1605,26 +1610,19 @@ ext4\_xattr\_cmp(struct ext4\_xattr\_header \*header1, |
|  |  | \*/ |
|  |  | static struct buffer\_head \* |
|  |  | ext4\_xattr\_cache\_find(struct inode \*inode, struct ext4\_xattr\_header \*header, |
|  |  | struct mb\_cache\_entry \*\*pce) |
|  |  | struct mb2\_cache\_entry \*\*pce) |
|  |  | { |
|  |  | \_\_u32 hash = le32\_to\_cpu(header->h\_hash); |
|  |  | struct mb\_cache\_entry \*ce; |
|  |  | struct mb\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  | struct mb2\_cache\_entry \*ce; |
|  |  | struct mb2\_cache \*ext4\_mb\_cache = EXT4\_GET\_MB\_CACHE(inode); |
|  |  |  |
|  |  | if (!header->h\_hash) |
|  |  | return NULL; /\* never share \*/ |
|  |  | ea\_idebug(inode, "looking for cached blocks [%x]", (int)hash); |
|  |  | again: |
|  |  | ce = mb\_cache\_entry\_find\_first(ext4\_mb\_cache, inode->i\_sb->s\_bdev, |
|  |  | hash); |
|  |  | ce = mb2\_cache\_entry\_find\_first(ext4\_mb\_cache, hash); |
|  |  | while (ce) { |
|  |  | struct buffer\_head \*bh; |
|  |  |  |
|  |  | if (IS\_ERR(ce)) { |
|  |  | if (PTR\_ERR(ce) == -EAGAIN) |
|  |  | goto again; |
|  |  | break; |
|  |  | } |
|  |  | bh = sb\_bread(inode->i\_sb, ce->e\_block); |
|  |  | if (!bh) { |
|  |  | EXT4\_ERROR\_INODE(inode, "block %lu read error", |
| Expand All | | @@ -1640,7 +1638,7 @@ ext4\_xattr\_cache\_find(struct inode \*inode, struct ext4\_xattr\_header \*header, |
|  |  | return bh; |
|  |  | } |
|  |  | brelse(bh); |
|  |  | ce = mb\_cache\_entry\_find\_next(ce, inode->i\_sb->s\_bdev, hash); |
|  |  | ce = mb2\_cache\_entry\_find\_next(ext4\_mb\_cache, ce); |
|  |  | } |
|  |  | return NULL; |
|  |  | } |
| Expand Down  Expand Up | | @@ -1715,15 +1713,15 @@ static void ext4\_xattr\_rehash(struct ext4\_xattr\_header \*header, |
|  |  |  |
|  |  | #define HASH\_BUCKET\_BITS 10 |
|  |  |  |
|  |  | struct mb\_cache \* |
|  |  | ext4\_xattr\_create\_cache(char \*name) |
|  |  | struct mb2\_cache \* |
|  |  | ext4\_xattr\_create\_cache(void) |
|  |  | { |
|  |  | return mb\_cache\_create(name, HASH\_BUCKET\_BITS); |
|  |  | return mb2\_cache\_create(HASH\_BUCKET\_BITS); |
|  |  | } |
|  |  |  |
|  |  | void ext4\_xattr\_destroy\_cache(struct mb\_cache \*cache) |
|  |  | void ext4\_xattr\_destroy\_cache(struct mb2\_cache \*cache) |
|  |  | { |
|  |  | if (cache) |
|  |  | mb\_cache\_destroy(cache); |
|  |  | mb2\_cache\_destroy(cache); |
|  |  | } |
|  |  |  |

5 changes: 2 additions & 3 deletions

5
[fs/ext4/xattr.h](#diff-5093adfdbfe827fe2555fe545570526edbb1d1e44bd5a8f92dc9650c0ae54905 "fs/ext4/xattr.h")

Show comments

[View file](/torvalds/linux/blob/82939d7999dfc1f1998c4b1c12e2f19edbdff272/fs/ext4/xattr.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -108,7 +108,6 @@ extern int ext4\_xattr\_set(struct inode \*, int, const char \*, const void \*, size\_ |
|  |  | extern int ext4\_xattr\_set\_handle(handle\_t \*, struct inode \*, int, const char \*, const void \*, size\_t, int); |
|  |  |  |
|  |  | extern void ext4\_xattr\_delete\_inode(handle\_t \*, struct inode \*); |
|  |  | extern void ext4\_xattr\_put\_super(struct super\_block \*); |
|  |  |  |
|  |  | extern int ext4\_expand\_extra\_isize\_ea(struct inode \*inode, int new\_extra\_isize, |
|  |  | struct ext4\_inode \*raw\_inode, handle\_t \*handle); |
| Expand All | | @@ -124,8 +123,8 @@ extern int ext4\_xattr\_ibody\_inline\_set(handle\_t \*handle, struct inode \*inode, |
|  |  | struct ext4\_xattr\_info \*i, |
|  |  | struct ext4\_xattr\_ibody\_find \*is); |
|  |  |  |
|  |  | extern struct mb\_cache \*ext4\_xattr\_create\_cache(char \*name); |
|  |  | extern void ext4\_xattr\_destroy\_cache(struct mb\_cache \*); |
|  |  | extern struct mb2\_cache \*ext4\_xattr\_create\_cache(void); |
|  |  | extern void ext4\_xattr\_destroy\_cache(struct mb2\_cache \*); |
|  |  |  |
|  |  | #ifdef CONFIG\_EXT4\_FS\_SECURITY |
|  |  | extern int ext4\_init\_security(handle\_t \*handle, struct inode \*inode, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `82939d7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F82939d7999dfc1f1998c4b1c12e2f19edbdff272) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugzilla.kernel.org_49cb5123_20250125_210311.html ===


Kernel.org Bugzilla – Bug 107301
system hang during ext4 xattr operation
Last modified: 2016-04-13 09:07:35 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/latest/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=107301&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](createaccount.cgi?request_new_password=1)
  Login:

  [x]

[**Bug 107301**](show_bug.cgi?id=107301)
- system hang during ext4 xattr operation

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
system hang during ext4 xattr operation

| | [Status](page.cgi?id=fields.html#bug_status): | NEEDINFO | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | File System | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=File System "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | ext4 ([show other bugs](buglist.cgi?component=ext4&product=File%20System&bug_status=__open__)) | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | P1 high | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | fs\_ext4@kernel-bugs.osdl.org | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2015-11-05 13:54 UTC by Mehdi Abaakouk | | --- | --- | | Modified: | 2016-04-13 09:07 UTC ([History](show_activity.cgi?id=107301)) | | CC List: | 9 users (show)  adilger.kernelbugzilla agruen erwan jack laurent pmhahn sage szg00000 tytso | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Kernel Version:](page.cgi?id=fields.html#cf_kernel_version "A custom Free Text field in this installation of Bugzilla.") | 4.2.3 3.19 3.16 | | [Subsystem:](page.cgi?id=fields.html#cf_subsystem "The subsystem responsible for this bug (must match MAINTAINERS entry verbatim)") |  | | [Regression:](page.cgi?id=fields.html#cf_regression "A custom Drop Down field in this installation of Bugzilla.") | No | | [Bisected commit-id:](page.cgi?id=fields.html#cf_bisect_commit "Full commit-id of the commit that introduced this regression.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**dmesg received via netconsole before the system hang**](attachment.cgi?id=192191 "View the content of the attachment") (158.93 KB, text/plain)  [2015-11-05 13:54 UTC](#attach_192191 "Go to the comment associated with the attachment"), Mehdi Abaakouk | [Details](attachment.cgi?id=192191&action=edit) | | [**attachment-4900-0.html**](attachment.cgi?id=192211 "View the content of the attachment") (1.47 KB, text/html)  [2015-11-05 17:41 UTC](#attach_192211 "Go to the comment associated with the attachment"), Mehdi Abaakouk | [Details](attachment.cgi?id=192211&action=edit) | | [**Remove ext4 mbcache**](attachment.cgi?id=192351 "View the content of the attachment") (10.69 KB, patch)  [2015-11-07 17:58 UTC](#attach_192351 "Go to the comment associated with the attachment"), Laurent GUERBY | [Details](attachment.cgi?id=192351&action=edit) | [Diff](attachment.cgi?id=192351&action=diff) | | [**xattr -l on random ceph files**](attachment.cgi?id=192491 "View the content of the attachment") (15.40 KB, text/plain)  [2015-11-09 09:24 UTC](#attach_192491 "Go to the comment associated with the attachment"), Laurent GUERBY | [Details](attachment.cgi?id=192491&action=edit) | | [**add "no\_mbcache**](attachment.cgi?id=192551 "View the content of the attachment") (5.80 KB, patch)  [2015-11-09 18:13 UTC](#attach_192551 "Go to the comment associated with the attachment"), Andreas Dilger | [Details](attachment.cgi?id=192551&action=edit) | [Diff](attachment.cgi?id=192551&action=diff) | | [**Multiple NMI watchdog: BUG: soft lockup - CPU#1 stuck for 22s! [smbd:8822]**](attachment.cgi?id=212131 "View the content of the attachment") (14.26 KB, text/plain)  [2016-04-08 10:09 UTC](#attach_212131 "Go to the comment associated with the attachment"), Philipp Matthias Hahn | [Details](attachment.cgi?id=212131&action=edit) | | [Add an attachment](attachment.cgi?bugid=107301&action=enter) (proposed patch, testcase, etc.) | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=107301#c0)  Mehdi Abaakouk    2015-11-05 13:54:24 UTC  ``` Created [attachment 192191](attachment.cgi?id=192191 "dmesg received via netconsole before the system hang") [[details]](attachment.cgi?id=192191&action=edit "dmesg received via netconsole before the system hang") dmesg received via netconsole before the system hang  Hi,  We are running a ceph cluster on ext4 filesystem, we recently got a hardware failure, the ceph recovery process provokes a huge amount of data write on all our ext4 filesystems (~40 disks).  Now, we are experienced random nodes hang, we catch some partial backtrace (that can be found on the ceph bug tracker). And recently we got the full dmesg log via netconsole (attached to this BZ).  When the freeze occurs, it seems ceph processes lockup all the CPUs, each CPUs backtrace is related to a xattr operation.   bug report on ceph side: <http://tracker.ceph.com/issues/13662>  We have some nodes on debian and some other on ubuntu, we tried kernels 3.16, 3.19, 4.2.3. The issue occurs with all of them.   Cheers, ```  [Comment 1](show_bug.cgi?id=107301#c1)  Jan Kara    2015-11-05 17:02:57 UTC  ``` Hum, from the stack traces in the log it seems mb_cache_entry_alloc() is racing with other operations on the LRU and restarting all the time. Another possibility is that there are lots of entries in the LRU and it takes a long time to scan (if I remember right ceph is a heavy user of xattrs).  The first problem would be easily fixed by adding cond_resched() at appropriate place, the second problem would require more intrusive changes in how LRU is handled.  Can you reproduce the issue? ```  [Comment 2](show_bug.cgi?id=107301#c2)  Mehdi Abaakouk    2015-11-05 17:41:54 UTC  ``` Created [attachment 192211](attachment.cgi?id=192211 "attachment-4900-0.html") [[details]](attachment.cgi?id=192211&action=edit "attachment-4900-0.html") attachment-4900-0.html  Yes ceph heavy uses xattr  I don't have a 'step by step to reproduce' list. But I have the issue ~4-5 times per day on a ceph cluster since the first incident.  On November 5, 2015 6:02:57 PM GMT+01:00, bugzilla-daemon@bugzilla.kernel.org wrote: >[https://bugzilla.kernel.org/show_bug.cgi?id=107301](show_bug.cgi?id=107301 "NEEDINFO - system hang during ext4 xattr operation") > >Jan Kara <jack@suse.cz> changed: > >           What    |Removed                     |Added >---------------------------------------------------------------------------- >             Status|NEW                         |NEEDINFO > >--- [Comment #1](show_bug.cgi?id=107301#c1) from Jan Kara <jack@suse.cz> --- >Hum, from the stack traces in the log it seems mb_cache_entry_alloc() >is racing >with other operations on the LRU and restarting all the time. Another >possibility is that there are lots of entries in the LRU and it takes a >long >time to scan (if I remember right ceph is a heavy user of xattrs). > >The first problem would be easily fixed by adding cond_resched() at >appropriate >place, the second problem would require more intrusive changes in how >LRU is >handled. > >Can you reproduce the issue? > >--  >You are receiving this mail because: >You reported the bug. ```  [Comment 3](show_bug.cgi?id=107301#c3)  Theodore Tso    2015-11-06 02:43:17 UTC  ``` If Ceph is using xattrs that are all different for each inode, the mbcache is not really useful at all.   So I wonder if we should have a mount option which disables the mbcache.   This will prove the scalability of the xattr functions, and should be a pretty big performance win for Ceph. ```  [Comment 4](show_bug.cgi?id=107301#c4)  Laurent GUERBY    2015-11-06 20:29:15 UTC  ``` Don't know if this is still around:  <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/fs/mbcache.c?id=335e92e8a515420bd47a6b0f01cb9a206c0ed6e4> ```  [Comment 5](show_bug.cgi?id=107301#c5)  Laurent GUERBY    2015-11-07 15:24:34 UTC  ``` My reading of the mbcache code is that  cache->c_max_entries = bucket_count << 4  is limiting to on average 16 entries per bucket. For ext4 bucket_bits is 10 so 1024 buckets.  Once the cache is full which is very likely situation given ceph use of xattr with differing values all ceph threads will compete for the global mbcache locks on *each* xattr operation.  Am I correct here?  ceph is designed to have one process managing one non shared device the mbcache design is very likely limiting scalability here by having global locks. Plus probably has a locking bug. ```  [Comment 6](show_bug.cgi?id=107301#c6)  Laurent GUERBY    2015-11-07 17:58:55 UTC  ``` Created [attachment 192351](attachment.cgi?id=192351&action=diff "Remove ext4 mbcache") [[details]](attachment.cgi?id=192351&action=edit "Remove ext4 mbcache") Remove ext4 mbcache  Would this (untested/mechanical) patch be ok to test mbcache removal? ```  [Comment 7](show_bug.cgi?id=107301#c7)  Jan Kara    2015-11-09 08:50:58 UTC  ``` Yeah, that would test what the performance would look like without mbcache. BTW: Among xattrs ceph is using how many of them are the same? Mbcache is a win for the common case where xattrs are mostly used for ACLs or SE Linux labels and thus the reuse is big (mbcache is essentially a deduplication layer for xattrs).   And yes, it is in a need of some updates to meet current scalability demands (I don't think what you hit is a bug as such, rather an inefficiency that becomes lethal at your scale) - other users than ceph occasionally report issues as well. Probably we should track things per-fs, not globally, hook each per-fs mbcache into the shrinker framework and don't introduce artificial upper bounds on the number of entries and instead let natural memory pressure deal with it.  For now I'm not convinced adding a mount option to disable mbcache is the right way to go. Rather we should make it lightweight enough that it doesn't add too much overhead for the cases where it is not needed. With the mount option there is always the trouble that someone has to know it to turn it on/off and sometimes there even isn't a good choice as you can have heavy xattr reuse for some inodes and also quite a few unique xattrs for other inodes... ```  [Comment 8](show_bug.cgi?id=107301#c8)  Laurent GUERBY    2015-11-09 09:24:04 UTC  ``` Created [attachment 192491](attachment.cgi?id=192491 "xattr -l on random ceph files") [[details]](attachment.cgi?id=192491&action=edit "xattr -l on random ceph files") xattr -l on random ceph files  I ran xattr on various ceph files on our cluster and there are small ones that look mostly constant (or small value set), but the big ones "user.ceph._" are clearly all differents (beginning common but there's probably hash or something inside near the end). ```  [Comment 9](show_bug.cgi?id=107301#c9)  Laurent GUERBY    2015-11-09 10:11:07 UTC  ``` Note: ceph files are all big in our use case since we use it for rbd, about 4 Mbyte each, so two or three additional xattr blocks per file won't change disk usage in volume for us. For people using ceph as object store and with their own use of xattr the situation could be different. ```  [Comment 10](show_bug.cgi?id=107301#c10)  Sage Weil    2015-11-09 14:31:37 UTC  ``` The most common Ceph xattr is ~270 bytes and always has a unique value.  There are also a couple that are a few bytes each (and always the same), but i would expect the little ones get inlined in the inode?  Anyway, it sounds like disabling mbcache would be a win! ```  [Comment 11](show_bug.cgi?id=107301#c11)  Jan Kara    2015-11-09 15:22:23 UTC  ``` Actually if most of inodes have xattrs like this, then the biggest win would probably be to create filesystem with 512-byte inodes where the ~270-byte xattr will fit into the inode as well. Then you save on extra block lookup etc.  WRT disabling mbcache, it seems disabling it would really help your usecase. However I'm not a big fan of mount options for disabling/enabling various functionality in the filesystem as it blows up a test matrix and tends to be a usability issue as well (people don't know the option or don't know when to enable / disable it). So I'd prefer if we just fixed mbcache... ```  [Comment 12](show_bug.cgi?id=107301#c12)  Andreas Dilger    2015-11-09 18:13:16 UTC  ``` Created [attachment 192551](attachment.cgi?id=192551&action=diff "add \"no_mbcache") [[details]](attachment.cgi?id=192551&action=edit "add \"no_mbcache") add "no_mbcache  We have a patch for Lustre ldiskfs (ext4 modified with Lustre patches) to disable mbcache, since it has similar performance impact for Lustre servers, and provides no value because the xattrs Lustre stores on each file are unique and cannot be shared.    Canonical patch location: [http://git.hpdd.intel.com/fs/lustre-release.git/blob_plain/HEAD:/ldiskfs/kernel_patches/patches/rhel7/ext4-disable-mb-cache.patch](http://git.hpdd.intel.com/fs/lustre-release.git/blob_plain/HEAD%3A/ldiskfs/kernel_patches/patches/rhel7/ext4-disable-mb-cache.patch)  While the referenced patch is for RHEL 7, it is small enough to port easily to the upstream kernel.  This patch adds a "no_mbcache" mount option, which Lustre automatically adds to the filesystem options when the servers are mounted.  There was a patch to improve mbcache performance in ext4 by making the cache per-sb, but that doesn't improve the contention within a filesystem, and doesn't avoid the fact that mbcache provides absolutely no value for Lustre (or Ceph, it seems).  Doing no work at all is better than doing it somewhat more efficiently.  The only way I could see this working automatically is if mbcache disabled itself after having a low/zero cache hit ratio within a certain number of inserts, and if not finding any shared xattr blocks when reading from disk.  In the meantime, I think having a mount option is a viable alternative for those people who know better than the auto-detection heuristics. ```  [Comment 13](show_bug.cgi?id=107301#c13)  Laurent GUERBY    2015-11-10 11:16:37 UTC  ``` We restarted all of our cluster machines with ubuntu 3.19 + my ext4 mbcache removal patch: so far no data loss, no new freeze and no visible change in performance (production too noisy to detect small changes). ```  [Comment 14](show_bug.cgi?id=107301#c14)  Theodore Tso    2015-11-11 02:37:59 UTC  ``` In response to Jan's concerns in [comment #11](show_bug.cgi?id=107301#c11), I wonder if we can use some hueristics to decide when to use mbcache and when to skip it.   So if there are ways that we can identify certain xattr's by name or type as being almost always unique, then if there are any of those xattrs in the external xattr block, there's no point using the mbcache.   If we had such a function, we could also use it to bias putting the unique xattrs in the extended inode space, which might increase the chance that the external xattr block is more likely to be shareable.  The final thing I'll note is that because of the mbcache locking, it can turn into a real scalability bottlencheck for ext4, and it's not clear this is a soluble problem.   So if you are running on a high-CPU count machine, and you are using xattrs, and (for example) the SELinux xattr is so piggy that it won't fit in your 256-byte inodes, things can get pretty painful. ```  [Comment 15](show_bug.cgi?id=107301#c15)  Jan Kara    2015-11-11 10:28:17 UTC  ``` So I guess there are two separate issues: 1) mbcache scales poorly - that is worth addressing regardless of whether ceph / lustre really need it or not since as you mention there are cases where mbcache helps and scalability is an issue. 2) some usecases do not benefit from mbache much (or at all) and so we could possibly have a heuristic to disable mbcache altogether.  My current feeling is that if mbcache is implemented properly, then the overhead of it is a hash-table insertion / deletion when creating / removing xattr and that should be pretty cheap compared to all the other work we do to create external xattr (although cache line contention could be an issue here to some degree). ```  [Comment 16](show_bug.cgi?id=107301#c16)  Andreas Dilger    2015-11-11 11:37:33 UTC  ``` I think that regardless of how efficient mbcache can be made, it is not as efficient (both CPU and RAM) as not using it at all in cases where it is not providing any benefit.  I'm not against improving the efficiency, but I think it still makes sense to have an option to disable it completely. Since mbcache is already a per-sb cache, having a per-sb mount option makes sense and doesn't interfere with other improvements to mbcache. ```  [Comment 17](show_bug.cgi?id=107301#c17)  Jan Kara    2015-11-11 14:53:10 UTC  ``` Ultimately it is Ted's call but your argument is like (randomly taken out of top of my head): "Proper locking to protect from hole punching costs us some performance and our workload doesn't use hole punching so let's create mount option to disable the locking". Sure it can be done and it will benefit your workload but how much you gain? And how many users need this? This has to be weighted against the cost of the new mount option in terms of testing and usability (and code complexity but that is fairly small in this case so I'm not that concerned). ```  [Comment 18](show_bug.cgi?id=107301#c18)  Laurent GUERBY    2015-11-18 20:48:49 UTC  ``` Should I formally submit the mbcache removal patch? ```  [Comment 19](show_bug.cgi?id=107301#c19)  Andreas Dilger    2015-11-19 00:49:16 UTC  ``` Jan, your example is a red herring, because the removal of mbcache at most affects the performance and space efficiency, not correctness.   I agree that making mbcache more efficient is a good goal, but I don't think that ot should block the landing of this patch. Rather, it makes sense to land the patch and we can still fix mbcache performance if anyone actually wants to use it. It will also serve as the basis for any heuristic to turn mbcache on and off dynamically instead of (or in addition to) the mount option.  Laurent, I'd be greatful if you pushed the patch upstream for the latest kernel as I'm traveling this week. ```  [Comment 20](show_bug.cgi?id=107301#c20)  Theodore Tso    2015-11-19 15:11:22 UTC  ``` Apologies for not responding right away.  I'm currently on vacation. So this also means that if someone sends me a patch right away, I'm not likely to have time to look at it for a week or two.  As far as trying to make mbcache more scalable, this would be great, but I suspect it's not going to be very easy because it requires a global data structure, which is fundamentally hard to scale.  I can imagine some schemes that sacrifice some of mbcache's ability to spot duplicate xattr sets --- for example, you could just use a trylock, and if there is lock contention just give up on detecting duplicate xattrs.  Or maybe we could use some hueristics based on the xattr type/key to decide whether using mbcache is likely to be successful.  So if we know that Posix ACL's are very likely to be shared, and ceph xattrs are very unlikely to be shared, this could be used to decide whether or not to use mbcache automatically, without requiring a mount option.  Even better would be one where for unknonw xattr type/key combinations, we use some learning algorithm which determines after using mbcache for N instances of that xattr, if the percentage of cache hits is too low, we stop using mbcache for that type/key combination. ```  [Comment 21](show_bug.cgi?id=107301#c21)  Andreas Gruenbacher    2015-12-10 02:51:52 UTC  ``` As far as ceph is concerned, are there reasons for not using 512-byte inodes? In-inode xattrs are generally much faster. ```  [Comment 22](show_bug.cgi?id=107301#c22)  Theodore Tso    2015-12-10 16:51:43 UTC  ``` Using 512 byte inodes for Ceph is a really good idea.  Before folks go there, can people give Jan Kara's mbcache rewrite a try?  <http://thread.gmane.org/gmane.comp.file-systems.ext4/51094>  I'd really appreciate comments and any performance numbers you could give me on your workloads.  Thanks!! ```  [Comment 23](show_bug.cgi?id=107301#c23)  Erwan Velu    2016-03-31 13:53:44 UTC  ``` I'm making a short review on that issue that Ceph user could trigger.  Regarding the current state, it seems that Jan got his work to be present in the 4.6.x series.  Laurent, Medhi, could you make a try with Jan's patch to confirm that its ok for you too ?  Testing the 4.6-rc1 would be ideal as we could tell Ceph's users then that 4.6 is fixing the issue you had.  Thanks, ```  [Comment 24](show_bug.cgi?id=107301#c24)  Philipp Matthias Hahn    2016-04-08 10:09:28 UTC  ``` Created [attachment 212131](attachment.cgi?id=212131 "Multiple NMI watchdog: BUG: soft lockup - CPU#1 stuck for 22s! [smbd:8822]") [[details]](attachment.cgi?id=212131&action=edit "Multiple NMI watchdog: BUG: soft lockup - CPU#1 stuck for 22s! [smbd:8822]") Multiple NMI watchdog: BUG: soft lockup - CPU#1 stuck for 22s! [smbd:8822]  We have a similar situation with Samba4, which also heavily uses xattr to store the NTACLs.  From OCR (may contain errors):  [281537.032878] Call Trace: [281537.032882]  [<ffffffffa0117c7c>] ? mb_cache_entry_get+0x1ac/0x1f0 [mbcache] [281537.032883]  [<ffffffff81208f1f>] ? __find_get_block+0xef/0x120 [281537.032889]  [<ffffffffa033de70>] ? ext4_xattr_block_set+0x80/0xa50 [ext4] [281537.032890]  [<ffffffff81208f1f>] ? __find_get_block+0xef/0x120 [281537.032896]  [<ffffffffa033d1da>] ? ext4_xattr_set_entrg+0x2a/0x350 [ext4] [281537.032901]  [<ffffffffa033f3e6>] ? ext4_xattr_set_handle+0x376/0x4d0 [ext4] [281537.032907]  [<ffffffffa033f614>] ? ext4_xattr_set+0xd4/0x130 [ext4] [281537.032909]  [<ffffffff811f917e>] ? generic_setxattr+0x6e/0xa0 [281537.032910]  [<ffffffff811f9d91>] ? __ufs_setxattr_noperm+0x71/0x1d0 [281537.032912]  [<ffffffff811f9fb4>] ? ufs_setxattr+0xc4/0xd0 [281537.032914]  [<ffffffff811fa0f4>] ? setxattr+0x134/0x1f0 [281537.032916]  [<ffffffff811e1301>] ? filenane_lookup+0x31/0xd0 [281537.032917]  [<ffffffff811e50bc>] ? user_path_at_emptg+0x60/0xc0 [281537.032918]  [<ffffffff811d7473>] ? __sb_start_urite+0x53/0x100 [281537.032919]  [<ffffffff811fa240>] ? path_setxattr+0x90/0xc0 [281537.032921]  [<ffffffff811fa314>] ? SgS_setxattr+0x14/0x20 [281537.032922]  [<ffffffff8159de72>] ? system_call_fast_compare_end+0x0/0x6b [281537.032933] Code: f0 0f c1 07 89 02 c1 ea 10 66 39 02 75 01 03 0f b7 f2 b8 00 80 00 00 0f b7 0f 41 89 08 41 31 d0 41 81 e0 f e ff 00 00 74 10 f3 90 <83> e8 01 75 e7 0f 1f 80 00 00 00 00 eb d9 0f b7 f1 e8 08 75 ff ```  [Comment 25](show_bug.cgi?id=107301#c25)  Jan Kara    2016-04-08 20:46:12 UTC  ``` Phillip, I see you are using some variant of 4.1 kernel. As [comment 23](show_bug.cgi?id=107301#c23) mentions, fixes for the problem have landed in 4.6-rc1. So is it possible for you to test that kernel? ```  [Comment 26](show_bug.cgi?id=107301#c26)  Philipp Matthias Hahn    2016-04-12 12:52:24 UTC  ``` (In reply to Jan Kara from [comment #25](show_bug.cgi?id=107301#c25)) > Phillip, I see you are using some variant of 4.1 kernel. As [comment 23](show_bug.cgi?id=107301#c23) > mentions, fixes for the problem have landed in 4.6-rc1. So is it possible > for you to test that kernel?  As that problem happend in production, I'm unwilling to install an -rc kernel there. Currently I don't have the time to try to reproduce it in my development environment, but that may change if that lockup happens again. Can you be more specific on which change in 4.6-rc1 you're referencing? ```  [Comment 27](show_bug.cgi?id=107301#c27)  Jan Kara    2016-04-13 09:07:35 UTC  ``` (In reply to Philipp Matthias Hahn from [comment #26](show_bug.cgi?id=107301#c26)) > Can you be more specific on which change in 4.6-rc1 you're referencing?  Well, it is a series of changes, commits: f9a61eb4e2471c56a63cd804c7474128138c38ac 82939d7999dfc1f1998c4b1c12e2f19edbdff272 be0726d33cb8f411945884664924bed3cb8c70ee ecd1e64412d5242b8afdef58a714bab3c5464f79 c2f3140fe2eceb3a6c1615b2648b9471544881c6 f0c8b46238db9d51ef9ea0858259958d0c601cec 7a2508e1b657cfc7e1371550f88c7a7bc4288f32 2335d05f3a83f5290ec28c1ed30c1c742a37edc9 dc8d5e565f00c9442fa1cbf9acc115475628527c 3fd164629d25b04f291a79a013dcc7ce1a301269 6048c64b26097a0ffbd966866b599f990e674e9b ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=107301&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=107301)
* - [XML](show_bug.cgi?ctype=xml&id=107301)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=107301)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/latest/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=107301&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](createaccount.cgi?request_new_password=1)
    Login:

    [x]



=== Content from www.openwall.com_ddb21b86_20250125_210308.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2016/08/25/4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CALJHwhSmb-Fx6VYaqW4FwNg=GTm=q2d7LqqoZ10U5TjA1=nTOA@mail.gmail.com>
Date: Mon, 22 Aug 2016 15:28:51 +1000
From: Wade Mealing <wmealing@...hat.com>
To: oss-security@...ts.openwall.com, cve-assign@...re.org
Subject: CVE request: Linux kernel mbcache lock contention denial of service.

Gday,

A design flaw was found in the file extended attribute handling of the
linux kernels handling of cached attributes.  Too many entries in the
cache cause a soft lockup while attempting to iterate the cache and
access relevant locks.

Upstream has replaced the mbcache code with an updated version which
was not a patch but a clear-cut reimplementation of the code, no
single diff

Soft lockup information is in both the bugzilla.kernel.org and
referred to in the LWN article.  This would affect containers running
with ext4 as it shares the same mbcache between all containers/host.

This did not affect Red Hat Enterprise Linux versions 5,6 or 7, so I
can't validate the claim that it does affect other newer kernels.
This may be worthwhile tracking for others who are affected by this
flaw.

For those following along at home, this seemed to be fixed in:

 ±  git tag --contains be0726d33cb8f411945884664924bed3cb8c70ee
v4.6

However I can't be sure which factor introduced the issue, but I've
been unable to reproduce with the given instructions.

Thanks,

Wade Mealing
Red Hat Product Security

Upstream discussion:
<https://lwn.net/Articles/668718/>

Bugzilla kernel submission:
<https://bugzilla.kernel.org/show_bug.cgi?id=107301>

Red Hat Bugzilla:
<https://bugzilla.redhat.com/show_bug.cgi?id=1360968>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from usn.ubuntu.com_dae4f873_20250125_210319.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3582-2: Linux kernel (Xenial HWE) vulnerabilities

22 February 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-lts-xenial](/security/cves?package=linux-lts-xenial) - Linux hardware enablement kernel from Xenial for Trusty

## Details

USN-3582-1 fixed vulnerabilities in the Linux kernel for Ubuntu 16.04

LTS. This update provides the corresponding updates for the Linux

Hardware Enablement (HWE) kernel from Ubuntu 16.04 LTS for Ubuntu

14.04 LTS.

Mohamed Ghannam discovered that the IPv4 raw socket implementation in the

Linux kernel contained a race condition leading to uninitialized pointer

usage. A local attacker could use this to cause a denial of service or

possibly execute arbitrary code. ([CVE-2017-17712](/security/CVE-2017-17712))

Laurent Guerby discovered that the mbcache feature in the ext2 and ext4

filesystems in the Linux kernel improperly handled xattr block caching. A

local attacker could use this to cause a denial of service. ([CVE-2015-8952](/security/CVE-2015-8952))

Vitaly Mayatskikh discovered that the SCSI subsystem in the Linux kernel

did not properly track reference counts when merging buffers. A local

attacker could use this to cause a denial of service (memory exhaustion).

([CVE-2017-12190](/security/CVE-2017-12190))

ChunYu Wang discovered that a use-after-free vulnerability existed in the

SCTP protocol implementation in the Linux kernel. A local attacker could

use this to cause a denial of service (system crash) or possibly execute

arbitrary code, ([CVE-2017-15115](/security/CVE-2017-15115))

Mohamed Ghannam discovered a use-after-free vulnerability in the DCCP

protocol implementation in the Linux kernel. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2017-8824](/security/CVE-2017-8824))

USN-3540-2 mitigated [CVE-2017-5715](/security/CVE-2017-5715) (Spectre Variant 2) for the

amd64 architecture in Ubuntu 14.04 LTS. This update provides the

compiler-based retpoline kernel mitigation for the amd64 and i386

architectures. Original advisory details:

Jann Horn discovered that microprocessors utilizing speculative execution

and branch prediction may allow unauthorized memory reads via sidechannel

attacks. This flaw is known as Spectre. A local attacker could use this to

expose sensitive information, including kernel memory. ([CVE-2017-5715](/security/CVE-2017-5715))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-4.4.0-1014-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1014.14](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1014.14)
* [linux-image-4.4.0-116-generic](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)
* [linux-image-4.4.0-116-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)
* [linux-image-4.4.0-116-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)
* [linux-image-4.4.0-116-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)
* [linux-image-4.4.0-116-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)
* [linux-image-4.4.0-116-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)
* [linux-image-4.4.0-116-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-116.140~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-116.140~14.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2015-8952](/security/CVE-2015-8952)
* [CVE-2017-12190](/security/CVE-2017-12190)
* [CVE-2017-15115](/security/CVE-2017-15115)
* [CVE-2017-17712](/security/CVE-2017-17712)
* [CVE-2017-5715](/security/CVE-2017-5715)
* [CVE-2017-8824](/security/CVE-2017-8824)

## Related notices

* [USN-3582-1](/security/notices/USN-3582-1)
* [USN-3487-1](/security/notices/USN-3487-1)
* [USN-3583-2](/security/notices/USN-3583-2)
* [USN-3583-1](/security/notices/USN-3583-1)
* [USN-3581-1](/security/notices/USN-3581-1)
* [USN-3581-3](/security/notices/USN-3581-3)
* [USN-3581-2](/security/notices/USN-3581-2)
* [USN-3530-1](/security/notices/USN-3530-1)
* [USN-3594-1](/security/notices/USN-3594-1)
* [USN-3580-1](/security/notices/USN-3580-1)
* [USN-3620-2](/security/notices/USN-3620-2)
* [USN-3541-2](/security/notices/USN-3541-2)
* [USN-3531-3](/security/notices/USN-3531-3)
* [USN-3560-1](/security/notices/USN-3560-1)
* [USN-3531-1](/security/notices/USN-3531-1)
* [USN-3540-1](/security/notices/USN-3540-1)
* [USN-3540-2](/security/notices/USN-3540-2)
* [USN-3561-1](/security/notices/USN-3561-1)
* [USN-3549-1](/security/notices/USN-3549-1)
* [USN-3777-3](/security/notices/USN-3777-3)
* [USN-3690-1](/security/notices/USN-3690-1)
* [USN-3597-2](/security/notices/USN-3597-2)
* [USN-3516-1](/security/notices/USN-3516-1)
* [USN-3541-1](/security/notices/USN-3541-1)
* [USN-3597-1](/security/notices/USN-3597-1)
* [USN-3542-1](/security/notices/USN-3542-1)
* [USN-3542-2](/security/notices/USN-3542-2)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page


