=== Content from github.com_44e394d9_20250124_233106.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F25856)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F25856)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  13k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   101k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  701](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  9](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# collections: Make BinaryHeap panic safe in sift\_up / sift\_down #25856

 Merged

[bors](/bors)
merged 1 commit into
[rust-lang:master](/rust-lang/rust/tree/master "rust-lang/rust:master")
from
[bluss:binary-heap-hole](/bluss/rust/tree/binary-heap-hole "bluss/rust:binary-heap-hole")

May 28, 2015

 Merged

# [collections: Make BinaryHeap panic safe in sift\_up / sift\_down](#top) #25856

[bors](/bors)
merged 1 commit into
[rust-lang:master](/rust-lang/rust/tree/master "rust-lang/rust:master")
from
[bluss:binary-heap-hole](/bluss/rust/tree/binary-heap-hole "bluss/rust:binary-heap-hole")

May 28, 2015

+196

‚àí25

[Conversation
28](/rust-lang/rust/pull/25856)
[Commits
1](/rust-lang/rust/pull/25856/commits)
[Checks
0](/rust-lang/rust/pull/25856/checks)
[Files changed
2](/rust-lang/rust/pull/25856/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![bluss](https://avatars.githubusercontent.com/u/3209739?s=60&v=4)](/bluss)

Copy link

Member

### @bluss **[bluss](/bluss)** commented [May 28, 2015](#issue-81899892)

collections: Make BinaryHeap panic safe in sift\_up / sift\_down

Use a struct called Hole that keeps track of an invalid location

in the vector and fills the hole on drop.

I include a run-pass test that the current BinaryHeap fails, and the new

one passes.

NOTE: The BinaryHeap will still be inconsistent after a comparison fails. It will

not have the heap property. What we fix is just that elements will be valid

values.

This is actually a performance win -- the new code does not bother to write in `zeroed()`

values in the holes, it just leaves them as they were.

Net result is something like a 5% decrease in runtime for `BinaryHeap::from_vec`. This

can be further improved by using unchecked indexing (I confirmed it makes a difference,

not a surprise with the non-sequential access going on), but let's leave that for another PR.

Safety first üòâ

Fixes [#25842](https://github.com/rust-lang/rust/issues/25842)

Sorry, something went wrong.

All reactions

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=40&v=4)](/rust-highfive)
[rust-highfive](/rust-highfive)
assigned [brson](/brson)
[May 28, 2015](#event-315923966)

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=80&u=ac9407540fb10c9a2c6ed7b85e0f3e5bff83d5d6&v=4)](/rust-highfive)

Copy link

Collaborator

### **[rust-highfive](/rust-highfive)** commented [May 28, 2015](#issuecomment-106292140)

| Thanks for the pull request, and welcome! The Rust team is excited to review your changes, and you should hear from [@brson](https://github.com/brson) (or someone else) soon.  If any changes to this PR are deemed necessary, please add them as extra commits. This ensures that the reviewer can see what has changed since they last reviewed the code. The way Github handles out-of-date commits, this should also make it reasonably obvious what issues have or haven't been addressed. Large or tricky changes may require several passes of review and changes.  Please see [the contribution instructions](https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md) for more information. |
| --- |

All reactions

Sorry, something went wrong.

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=80&v=4)](/bluss)

Copy link

Member

Author

### **[bluss](/bluss)** commented [May 28, 2015](#issuecomment-106292713)

| I prototyped this using a [general scope guard](https://crates.io/crates/scopeguard), but this Hole representation turned out to be nice.  LLVM needs to be on our side here and see that the removed element's `Option<T>` is always Some, etc. If you wonder why I use `hole.pos()` in one location and `hole.pos` in another, it's because those choices benched the best, both locations. Optimizing compilers, they are chaotic.  Edited: Moved useful info from this comment into the merge message itself (above)  cc [@alexcrichton](https://github.com/alexcrichton) [@gankro](https://github.com/gankro) |
| --- |

All reactions

Sorry, something went wrong.

 [![@bluss](https://avatars.githubusercontent.com/u/3209739?s=40&v=4)](/bluss)
[bluss](/bluss)
[force-pushed](/rust-lang/rust/compare/5f44f5b9d30d9e815fb3b622c7bbe5e31dfd131f..b2218539633915c1fa3746da073f951c885ad4e8)
the
binary-heap-hole

branch
from
[`5f44f5b`](/rust-lang/rust/commit/5f44f5b9d30d9e815fb3b622c7bbe5e31dfd131f) to
[`b221853`](/rust-lang/rust/commit/b2218539633915c1fa3746da073f951c885ad4e8)  [Compare](/rust-lang/rust/compare/5f44f5b9d30d9e815fb3b622c7bbe5e31dfd131f..b2218539633915c1fa3746da073f951c885ad4e8)
[May 28, 2015 12:14](#event-315927005)

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=80&v=4)](/bluss)

Copy link

Member

Author

### **[bluss](/bluss)** commented [May 28, 2015](#issuecomment-106349433)

| Using only unchecked indexing in `Hole` removes the bench result dependence on `hole.pos` vs `hole.pos()` -- just shows how panicking can be an impediment to optimization. |
| --- |

All reactions

Sorry, something went wrong.

![alexcrichton](https://avatars.githubusercontent.com/u/64996?s=60&v=4)

 **[alexcrichton](/alexcrichton)**
reviewed
[May 28, 2015](#discussion-diff-31253686)
 [View reviewed changes](/rust-lang/rust/pull/25856/files/b2218539633915c1fa3746da073f951c885ad4e8#diff-d2d3cd4c80b039cb0c49afa6fcbede27b80b191ea32a0a4e98484b07e6609b94)

[src/libcollections/binary\_heap.rs](/rust-lang/rust/pull/25856/files#diff-d2d3cd4c80b039cb0c49afa6fcbede27b80b191ea32a0a4e98484b07e6609b94)

|  |  |  |
| --- | --- | --- |
|  |  | impl<'a, T> Hole<'a, T> { |
|  |  | /// Create a new Hole at index `pos`. |
|  |  | pub fn new(data: &'a mut [T], pos: usize) -> Self { |

Copy link

Member

### @alexcrichton **[alexcrichton](/alexcrichton)** [May 28, 2015](#discussion_r31253686)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Could the `pub` be dropped from these functions? (`Hole` isn't exposed so they shouldn't need to be exposed either)

Sorry, something went wrong.

All reactions

Copy link

Contributor

### @Gankra **[Gankra](/Gankra)** [May 28, 2015](#discussion_r31256566)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It makes the code more portable, though. e.g. we can happily move this to a module without worrying.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @bluss **[bluss](/bluss)** [May 28, 2015](#discussion_r31258240)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It came out with pub, I think `pub` is natural as soon as the methods are intended to be called from outside the struct itself. I know our privacy doesn't work that way, but it does once the code grows and yes you move it out to a module. I'm fine either way but I prefer pub.

Sorry, something went wrong.

All reactions

Copy link

Member

### @alexcrichton **[alexcrichton](/alexcrichton)** [May 28, 2015](#discussion_r31259035)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Idiomatically code in the rest of the standard library does not do this, so let's stick to existing conventions. We can add `pub` if necessary at a later date, but code should be as conservative as possible in exports today.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @bluss **[bluss](/bluss)** [May 28, 2015](#discussion_r31259405)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

ok that's fine

Sorry, something went wrong.

All reactions

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=80&v=4)](/alexcrichton)

Copy link

Member

### **[alexcrichton](/alexcrichton)** commented [May 28, 2015](#issuecomment-106486796)

| Looks good to me, thanks [@bluss](https://github.com/bluss)! Perhaps the test could also be modified to ensure that the destructor for each element in the heap isn't run more than once?  Other than that though r=me, we can always tweak the performance at a later date.  cc [@gankro](https://github.com/gankro) |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
[alexcrichton](/alexcrichton)
added
the
[beta-nominated](/rust-lang/rust/labels/beta-nominated)
Nominated for backporting to the compiler in the beta channel.
label
[May 28, 2015](#event-316336911)

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=80&v=4)](/bluss)

Copy link

Member

Author

### **[bluss](/bluss)** commented [May 28, 2015](#issuecomment-106495312)

| Thanks. I'll add a test that makes sure no destructors were called right after catching the panic, before I inspect the data further. That should cover it (and fails on old version of BinaryHeap). |
| --- |

All reactions

Sorry, something went wrong.

![Gankra](https://avatars.githubusercontent.com/u/1136864?s=60&v=4)

 **[Gankra](/Gankra)**
reviewed
[May 28, 2015](#discussion-diff-31256194)
 [View reviewed changes](/rust-lang/rust/pull/25856/files/b2218539633915c1fa3746da073f951c885ad4e8#diff-d2d3cd4c80b039cb0c49afa6fcbede27b80b191ea32a0a4e98484b07e6609b94)

[src/libcollections/binary\_heap.rs](/rust-lang/rust/pull/25856/files#diff-d2d3cd4c80b039cb0c49afa6fcbede27b80b191ea32a0a4e98484b07e6609b94)

|  |  | ptr::write(&mut self.data[pos], x); |
| --- | --- | --- |
|  |  | pos = parent; |
|  |  | while hole.pos() > start { |
|  |  | let parent = (hole.pos() - 1) >> 1; |

Copy link

Contributor

### @Gankra **[Gankra](/Gankra)** [May 28, 2015](#discussion_r31256194)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Surely LLVM can convert the much more semantically clear `/2` to this?

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @bluss **[bluss](/bluss)** [May 28, 2015](#discussion_r31258065)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I'll fix it. Haven't really looked at changing anything besides what's needed, though.

Sorry, something went wrong.

All reactions

[![@Gankra](https://avatars.githubusercontent.com/u/1136864?s=80&u=b96545de2b1678fbc4405804f7fd4231c9a9ec7a&v=4)](/Gankra)

Copy link

Contributor

### **[Gankra](/Gankra)** commented [May 28, 2015](#issuecomment-106525839)

| This looks great! |
| --- |

All reactions

Sorry, something went wrong.

 [![@bluss](https://avatars.githubusercontent.com/u/3209739?s=40&v=4)](/bluss)
[bluss](/bluss)
[force-pushed](/rust-lang/rust/compare/b2218539633915c1fa3746da073f951c885ad4e8..c41a5cc3f2bdf4e4c9faa9d49bc5df7d5a7159ff)
the
binary-heap-hole

branch
from
[`b221853`](/rust-lang/rust/commit/b2218539633915c1fa3746da073f951c885ad4e8) to
[`c41a5cc`](/rust-lang/rust/commit/c41a5cc3f2bdf4e4c9faa9d49bc5df7d5a7159ff)  [Compare](/rust-lang/rust/compare/b2218539633915c1fa3746da073f951c885ad4e8..c41a5cc3f2bdf4e4c9faa9d49bc5df7d5a7159ff)
[May 28, 2015 18:03](#event-316435609)

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=80&v=4)](/bluss)

Copy link

Member

Author

### **[bluss](/bluss)** commented [May 28, 2015](#issuecomment-106540183)

| PR updated. Everything is addressed, removed pub. The test checks for number of drop calls now (old binary heap used to drop 1 on panic), but it could still have tracked drops in even more detail. |
| --- |

All reactions

Sorry, something went wrong.

`[collections: Make BinaryHeap panic safe in sift_up / sift_down](/rust-lang/rust/pull/25856/commits/5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7 "collections: Make BinaryHeap panic safe in sift_up / sift_down

Use a struct called Hole that keeps track of an invalid location
in the vector and fills the hole on drop.

I include a run-pass test that the current BinaryHeap fails, and the new
one passes.

Fixes #25842")`
 ‚Ä¶

`[5249cbb](/rust-lang/rust/pull/25856/commits/5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7)`

```
Use a struct called Hole that keeps track of an invalid location
in the vector and fills the hole on drop.

I include a run-pass test that the current BinaryHeap fails, and the new
one passes.

Fixes [rust-lang#25842](https://github.com/rust-lang/rust/issues/25842)
```

 [![@bluss](https://avatars.githubusercontent.com/u/3209739?s=40&v=4)](/bluss)
[bluss](/bluss)
[force-pushed](/rust-lang/rust/compare/c41a5cc3f2bdf4e4c9faa9d49bc5df7d5a7159ff..5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7)
the
binary-heap-hole

branch
from
[`c41a5cc`](/rust-lang/rust/commit/c41a5cc3f2bdf4e4c9faa9d49bc5df7d5a7159ff) to
[`5249cbb`](/rust-lang/rust/commit/5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7)  [Compare](/rust-lang/rust/compare/c41a5cc3f2bdf4e4c9faa9d49bc5df7d5a7159ff..5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7)
[May 28, 2015 18:24](#event-316468889)

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=80&v=4)](/bluss)

Copy link

Member

Author

### **[bluss](/bluss)** commented [May 28, 2015](#issuecomment-106550532)

| wait, oh I totally thought I had spotted a bug and wondered how that could have slipped my tests, but no, it's fine. Pushed an update with one scope less that I didn't need, so the diff for sift\_down is easier to read. |
| --- |

All reactions

Sorry, something went wrong.

[![@Gankra](https://avatars.githubusercontent.com/u/1136864?s=80&u=b96545de2b1678fbc4405804f7fd4231c9a9ec7a&v=4)](/Gankra)

Copy link

Contributor

### **[Gankra](/Gankra)** commented [May 28, 2015](#issuecomment-106564498)

| [@bors](https://github.com/bors) r+  Sweet! |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [May 28, 2015](#issuecomment-106564516)

| üìå Commit [5249cbb](https://github.com/rust-lang/rust/commit/5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7) has been approved by `Gankro` |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
[alexcrichton](/alexcrichton)
added
the
[T-libs-api](/rust-lang/rust/labels/T-libs-api)
Relevant to the library API team, which will review and decide on the PR/issue.
label
[May 28, 2015](#event-316505964)

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [May 28, 2015](#issuecomment-106584141)

| ‚åõ Testing commit [5249cbb](https://github.com/rust-lang/rust/commit/5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7) with merge [efebe45](https://github.com/rust-lang/rust/commit/efebe45cc0f3265ee8bb6396952e93a2004128c8)... |
| --- |

All reactions

Sorry, something went wrong.

[bors](/bors)
added a commit
that referenced
this pull request
[May 28, 2015](#ref-commit-efebe45)
[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)

`[Auto merge of](/rust-lang/rust/commit/efebe45cc0f3265ee8bb6396952e93a2004128c8 "Auto merge of #25856 - bluss:binary-heap-hole, r=Gankro

collections: Make BinaryHeap panic safe in sift_up / sift_down

Use a struct called Hole that keeps track of an invalid location
in the vector and fills the hole on drop.

I include a run-pass test that the current BinaryHeap fails, and the new
one passes.

NOTE: The BinaryHeap will still be inconsistent after a comparison fails. It will
not have the heap property. What we fix is just that elements will be valid
values.

This is actually a performance win -- the new code does not bother to write in `zeroed()`
values in the holes, it just leaves them as they were.

Net result is something like a 5% decrease in runtime for `BinaryHeap::from_vec`. This
can be further improved by using unchecked indexing (I confirmed it makes a difference,
not a surprise with the non-sequential access going on), but let's leave that for another PR.
Safety first :wink:

Fixes #25842") [#25856](https://github.com/rust-lang/rust/pull/25856) [- bluss:binary-heap-hole, r=Gankro](/rust-lang/rust/commit/efebe45cc0f3265ee8bb6396952e93a2004128c8 "Auto merge of #25856 - bluss:binary-heap-hole, r=Gankro

collections: Make BinaryHeap panic safe in sift_up / sift_down

Use a struct called Hole that keeps track of an invalid location
in the vector and fills the hole on drop.

I include a run-pass test that the current BinaryHeap fails, and the new
one passes.

NOTE: The BinaryHeap will still be inconsistent after a comparison fails. It will
not have the heap property. What we fix is just that elements will be valid
values.

This is actually a performance win -- the new code does not bother to write in `zeroed()`
values in the holes, it just leaves them as they were.

Net result is something like a 5% decrease in runtime for `BinaryHeap::from_vec`. This
can be further improved by using unchecked indexing (I confirmed it makes a difference,
not a surprise with the non-sequential access going on), but let's leave that for another PR.
Safety first :wink:

Fixes #25842")`
‚Ä¶

`[efebe45](/rust-lang/rust/commit/efebe45cc0f3265ee8bb6396952e93a2004128c8)`

```
collections: Make BinaryHeap panic safe in sift_up / sift_down

Use a struct called Hole that keeps track of an invalid location
in the vector and fills the hole on drop.

I include a run-pass test that the current BinaryHeap fails, and the new
one passes.

NOTE: The BinaryHeap will still be inconsistent after a comparison fails. It will
not have the heap property. What we fix is just that elements will be valid
values.

This is actually a performance win -- the new code does not bother to write in `zeroed()`
values in the holes, it just leaves them as they were.

Net result is something like a 5% decrease in runtime for `BinaryHeap::from_vec`. This
can be further improved by using unchecked indexing (I confirmed it makes a difference,
not a surprise with the non-sequential access going on), but let's leave that for another PR.
Safety first üòâ

Fixes [#25842](https://github.com/rust-lang/rust/issues/25842)
```

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [May 28, 2015](#issuecomment-106610361)

| ‚òÄÔ∏è Test successful - [auto-linux-32-nopt-t](http://buildbot.rust-lang.org/builders/auto-linux-32-nopt-t/builds/5139), [auto-linux-32-opt](http://buildbot.rust-lang.org/builders/auto-linux-32-opt/builds/5147), [auto-linux-64-nopt-t](http://buildbot.rust-lang.org/builders/auto-linux-64-nopt-t/builds/5102), [auto-linux-64-opt](http://buildbot.rust-lang.org/builders/auto-linux-64-opt/builds/5127), [auto-linux-64-x-android-t](http://buildbot.rust-lang.org/builders/auto-linux-64-x-android-t/builds/5096), [auto-mac-32-opt](http://buildbot.rust-lang.org/builders/auto-mac-32-opt/builds/5169), [auto-mac-64-nopt-t](http://buildbot.rust-lang.org/builders/auto-mac-64-nopt-t/builds/5163), [auto-mac-64-opt](http://buildbot.rust-lang.org/builders/auto-mac-64-opt/builds/5136), [auto-win-gnu-32-nopt-t](http://buildbot.rust-lang.org/builders/auto-win-gnu-32-nopt-t/builds/114), [auto-win-gnu-32-opt](http://buildbot.rust-lang.org/builders/auto-win-gnu-32-opt/builds/114), [auto-win-gnu-64-nopt-t](http://buildbot.rust-lang.org/builders/auto-win-gnu-64-nopt-t/builds/114), [auto-win-gnu-64-opt](http://buildbot.rust-lang.org/builders/auto-win-gnu-64-opt/builds/113) |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)
[bors](/bors)
merged commit [`5249cbb`](/rust-lang/rust/commit/5249cbb7fa31ea2e6e8d77b49bfda386215b1ce7)
into
rust-lang:master

[May 28, 2015](https://github.com/rust-lang/rust/pull/25856#event-316653614)

 [![@bluss](https://avatars.githubusercontent.com/u/3209739?s=40&v=4)](/bluss)
[bluss](/bluss)
deleted the
binary-heap-hole

branch
[May 28, 2015 22:24](#event-316676772)

[![@huonw](https://avatars.githubusercontent.com/u/1203825?s=80&u=5e9be09a72b0fe0289c65d7e2b94f45e2d2a63e8&v=4)](/huonw)

Copy link

Member

### **[huonw](/huonw)** commented [May 29, 2015](#issuecomment-106640419)

| Nice work [@bluss](https://github.com/bluss)! |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=80&v=4)](/alexcrichton)

Copy link

Member

### **[alexcrichton](/alexcrichton)** commented [Jun 9, 2015](#issuecomment-110525217)

| triage: beta-accepted |
| --- |

All reactions

Sorry, something went wrong.

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
[alexcrichton](/alexcrichton)
added
the
[beta-accepted](/rust-lang/rust/labels/beta-accepted)
Accepted for backporting to the compiler in the beta channel.
label
[Jun 9, 2015](#event-326844532)

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
[alexcrichton](/alexcrichton)
mentioned this pull request
[Jun 10, 2015](#ref-pullrequest-86776486)

[Backport accepted PRs to beta
#26161](/rust-lang/rust/pull/26161)
 Merged

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
[alexcrichton](/alexcrichton)
removed
the
[beta-nominated](/rust-lang/rust/labels/beta-nominated)
Nominated for backporting to the compiler in the beta channel.
label
[Jun 11, 2015](#event-328040709)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F25856)

Reviewers

No reviews

Assignees

[![@brson](https://avatars.githubusercontent.com/u/147214?s=40&v=4)](/brson) [brson](/brson)

Labels

[beta-accepted](/rust-lang/rust/labels/beta-accepted)
Accepted for backporting to the compiler in the beta channel.
[T-libs-api](/rust-lang/rust/labels/T-libs-api)
Relevant to the library API team, which will review and decide on the PR/issue.

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [BinaryHeap is not exception safe](https://github.com/rust-lang/rust/issues/25842)

7 participants

[![@bluss](https://avatars.githubusercontent.com/u/3209739?s=52&v=4)](/bluss) [![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=52&v=4)](/rust-highfive) [![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=52&v=4)](/alexcrichton) [![@Gankra](https://avatars.githubusercontent.com/u/1136864?s=52&v=4)](/Gankra) [![@bors](https://avatars.githubusercontent.com/u/3372342?s=52&v=4)](/bors) [![@huonw](https://avatars.githubusercontent.com/u/1203825?s=52&v=4)](/huonw) [![@brson](https://avatars.githubusercontent.com/u/147214?s=52&v=4)](/brson)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_2c343216_20250124_233103.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F25842)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F25842)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  13k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   101k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  701](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  9](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

# BinaryHeap is not exception safe¬†#25842

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosed[#25856](https://github.com/rust-lang/rust/pull/25856)Closed[BinaryHeap is not exception safe](#top)#25842[#25856](https://github.com/rust-lang/rust/pull/25856)Copy linkLabels[T-libs-apiRelevant to the library API team, which will review and decide on the PR/issue.](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22T-libs-api%22)Relevant to the library API team, which will review and decide on the PR/issue.[![@bluss](https://avatars.githubusercontent.com/u/3209739?v=4&size=80)](/bluss)
## Description

[![@bluss](https://avatars.githubusercontent.com/u/3209739?v=4&size=48)](/bluss)[bluss](https://github.com/bluss)opened [on May 27, 2015](https://github.com/rust-lang/rust/issues/25842#issue-81645685)

BinaryHeap is using `zeroed()` and may not be exception safe. I.e. it is in an inconsistent state after being recovered after panic. See issue [#25662](https://github.com/rust-lang/rust/issues/25662) and others.

Relevant code is [BinaryHeap::sift\_up, sift\_down\_range](https://github.com/rust-lang/rust/blob/47f9e528f13403f48dc0521f360055430da6d538/src/libcollections/binary_heap.rs#L485-L527)

cc [@cmr](https://github.com/cmr)

## Metadata

### Assignees

No one assigned

### Labels

[T-libs-apiRelevant to the library API team, which will review and decide on the PR/issue.](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22T-libs-api%22)Relevant to the library API team, which will review and decide on the PR/issue.
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


