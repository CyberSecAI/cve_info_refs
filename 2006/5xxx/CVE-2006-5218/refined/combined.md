=== Content from scary.beasts.org_ffb1a4d7_20250125_010320.html ===

## CESA-2006-003 - rev 1

[See all my vulnerabilities at
<http://scary.beasts.org/security>]
### OpenBSD / NetBSD systrace kernel integer overflow

---

Programs affected: OpenBSD 3.9, NetBSD 3.

Severity: Local privilege escalation.systrace is a technology which allows supervision and allow / deny of syscalls
made by a supervised process. There is an integer overflow condition in the
kernel component of systrace which can be triggered by specifiying large
integer values in a systrace ioctl(). The integer overflow condition allows
the sidestep of a sanity check, and subsequent out-of-bounds write of a NULL
byte to a fairly arbitrary kernel address. Reading of chunks of kernel memory
may also be possible.Possible fruitful attacks here include:

* Writing NULL bytes over your own UID, to get UID 0.
* Writing NULL bytes over wherever securelevel is stored.

The actual code flaw can be observed in the systrace\_preprepl function:`for (i = 0, len = 0; i < repl->strr_nrepl; i++) {

 len += repl->strr_offlen[i];

 if (repl->strr_offlen[i] == 0)

 continue;

 if (repl->strr_offlen[i] + repl->strr_off[i] > len)

 return (EINVAL);

 }

 /* Make sure that the length adds up */

 if (repl->strr_len != len)

 return (EINVAL);

 /* Check against a maximum length */

 if (repl->strr_len > 2048)

 return (EINVAL);`Here, strr\_offlen[i] + strr\_off[i] can overflow, leading to the attacker's
choice of very large strr\_offlen or strr\_off. The "len" variable is also
subject to integer overflow, making the strr\_len <= 2048 requirement easy
to satisfy. Subsequently, in systrace\_replace, the attacker-supplied huge
value is used:`if (repl->strr_flags[i] & SYSTR_NOLINKS) {

 ret = systrace_fname(strp, kdata, repl->strr_offlen[i]);`And looking at systrace\_fname:`int

systrace_fname(struct str_process *strp, caddr_t kdata, size_t len)

{

 if (strp->nfname >= SYSTR_MAXFNAME || len < 1)

 return EINVAL;

 strp->fname[strp->nfname] = kdata;

 strp->fname[strp->nfname][len - 1] = '\0';

 strp->nfname++;

 return 0;

}`"len" is fairly arbitrarily attacker-controlled, leading to the ability to
write NULLs anywhere in kernel space.
Also, in systrace\_replace, there's the use of this attacker-controlled
length to copy out to userspace, probably resulting in ability to steal
contents of kernel memory:`if (copyout(kdata, udata, repl->strr_offlen[i])) {

 ret = EINVAL;

 goto out;

 }`
### Credits

* Google - this flaw was discovered in Google's time. I'm with Google's
  Security Team, and we're always recruiting talented security individuals.
  Mail me.
* Damien Miller - for great proof of concept work looking into how serious
  the flaw actually is.

CESA-2006-003 - rev 1

Chris Evans

scarybeasts@gmail.com


=== Content from openbsd.org_6b8e78d5_20250125_010319.html ===


OpenBSD: Errata and Patches

## [*Open***BSD**](index.html) Errata and Patches

---

For OpenBSD patch branch information, please refer
[here](stable.html).

For errata on a certain release, click below:

[2.0](errata20.html),
[2.1](errata21.html),
[2.2](errata22.html),
[2.3](errata23.html),
[2.4](errata24.html),
[2.5](errata25.html),
[2.6](errata26.html),
[2.7](errata27.html),
[2.8](errata28.html),
[2.9](errata29.html),
[3.0](errata30.html),
[3.1](errata31.html),
[3.2](errata32.html),
[3.3](errata33.html),
[3.4](errata34.html),
[3.5](errata35.html),

[3.6](errata36.html),
[3.7](errata37.html),
[3.8](errata38.html),
[3.9](errata39.html),
[4.0](errata40.html),
[4.1](errata41.html),
[4.2](errata42.html),
[4.3](errata43.html),
[4.4](errata44.html),
[4.5](errata45.html),
[4.6](errata46.html),
[4.7](errata47.html),
[4.8](errata48.html),
[4.9](errata49.html),
[5.0](errata50.html),
[5.1](errata51.html),

[5.2](errata52.html),
[5.3](errata53.html),
[5.4](errata54.html),
[5.5](errata55.html),
[5.6](errata56.html),
[5.7](errata57.html),
[5.8](errata58.html),
[5.9](errata59.html),
[6.0](errata60.html),
[6.1](errata61.html),
[6.2](errata62.html),
[6.3](errata63.html),
[6.4](errata64.html),
[6.5](errata65.html),
[6.6](errata66.html),
[6.7](errata67.html),

[6.8](errata68.html),
[6.9](errata69.html),
[7.0](errata70.html),
[7.1](errata71.html),
[7.2](errata72.html),
[7.3](errata73.html),
[7.4](errata74.html),
[7.5](errata75.html),
[7.6](errata76.html).


