=== Content from www.kb.cert.org_ac7a9760_20250124_153455.html ===


search

menu

icon-carat-right

cmu-wordmark

* ×
* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

[[Carnegie Mellon University](https://www.cmu.edu)](https://www.cmu.edu/)

# [Software Engineering Institute](https://www.sei.cmu.edu/)

## CERT Coordination Center

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* Current:  VU#357851

## UPnP requests accepted over router WAN interfaces

#### Vulnerability Note VU#357851

Original Release Date: 2011-10-05 | Last Revised: 2012-11-30

---

### Overview

Some Internet router devices incorrectly accept UPnP requests over the WAN interface.

### Description

| Universal Plug and Play (UPnP) is a networking protocol mostly used for personal computing devices to discover and communicate with each other and the Internet. Some UPnP enabled router devices incorrectly accept UPnP requests over the WAN interface. "AddPortMapping" and "DeletePortMapping" actions are accepted on these devices. These requests can be used to connect to internal hosts behind a NAT firewall and also proxy connections through the device and back out to the Internet. Additional details can be found in Daniel Garcia's whitepaper, ["Universal plug and play (UPnP) mapping attacks"](http://toor.do/DEFCON-19-Garcia-UPnP-Mapping-WP.pdf). [PDF] A list of devices reported to be vulnerable can be found on the [UPnP hacks website](http://www.upnp-hacks.org/devices.html). |
| --- |

### Impact

| A remote unauthenticated attacker may be able to scan internal hosts or proxy Internet traffic through the device. |
| --- |

### Solution

| Contact the device's vendor to find out if a firmware update is available to address this vulnerability. |
| --- |

| **Workarounds**  Disable UPnP on the device. |
| --- |

### Vendor Information

357851
Filter by status:
All
Affected
Not Affected
Unknown

Filter by content:
 Additional information available

 Sort by:
Status
Alphabetical

Expand all

**Javascript is disabled. Click [here](/vuls/vendor/VU%23357851/) to view vendors.**
### [Canyon-Tech](#JALR-8MCPYM) Affected

Updated:  October 05, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

We are not aware of further vendor information regarding this vulnerability.

### [Edimax Computer Company](#JALR-8MCPXS) Affected

Updated:  October 05, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

We are not aware of further vendor information regarding this vulnerability.

### [Linksys (A division of Cisco Systems)](#JALR-8MARGH) Affected

Updated:  October 03, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

We are not aware of further vendor information regarding this vulnerability.

### [Sitecom](#JALR-8MCPYH) Affected

Updated:  October 05, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

We are not aware of further vendor information regarding this vulnerability.

### [Sweex](#JALR-8MCPYS) Affected

Updated:  October 05, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

We are not aware of further vendor information regarding this vulnerability.

### [Technicolor](#JALR-8MEKG2) Affected

Updated:  October 07, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

Thomson and Speedtouch brands have been assimilated into the Technicolor company and brand.

### [ZyXEL](#JALR-8MARGM) Affected

Updated:  October 05, 2011

### Status

Affected

### Vendor Statement

We have not received a statement from the vendor.

### Vendor Information

We are not aware of further vendor information regarding this vulnerability.

### CVSS Metrics

| Group | Score | Vector |
| --- | --- | --- |
| Base | 9.4 | AV:N/AC:L/Au:N/C:N/I:C/A:C |
| Temporal | 8 | E:POC/RL:W/RC:C |
| Environmental | 8 | CDP:ND/TD:ND/CR:ND/IR:ND/AR:ND |

### References

* <http://toor.do/upnp.html>
* <http://www.h-online.com/security/news/item/UPnP-enabled-routers-allow-attacks-on-LANs-1329727.html>
* <http://toor.do/DEFCON-19-Garcia-UPnP-Mapping-WP.pdf>
* <http://www.upnp-hacks.org/devices.html>
### Acknowledgements

Thanks to Daniel Garcia for reporting this vulnerability.

This document was written by Jared Allar.

### Other Information

| **CVE IDs:** | [None](http://web.nvd.nist.gov/vuln/detail/None) |
| --- | --- |
| **Severity Metric:** | 0.85 |
| **Date Public:** | 2011-08-05 |
| **Date First Published:** | 2011-10-05 |
| **Date Last Updated:** | 2012-11-30 17:58 UTC |
| **Document Revision:** | 17 |

* [About vulnerability notes](https://vuls.cert.org/confluence/display/VIN/Vulnerability%2BNote%2BHelp)
* Contact us about this vulnerability
* [Provide a vendor statement](https://vuls.cert.org/confluence/display/VIN/Case%2BHandling#CaseHandling-Givingavendorstatusandstatement)

Sponsored by [CISA.](https://www.cisa.gov/cybersecurity)

 [Download PGP Key](https://vuls.cert.org/confluence/pages/viewpage.action?pageId=25985026)

[Read CERT/CC Blog](https://insights.sei.cmu.edu/cert/)

[Learn about Vulnerability Analysis](https://www.sei.cmu.edu/research-capabilities/all-work/display.cfm?customel_datapageid_4050=21304)

Carnegie Mellon University

Software Engineering Institute

4500 Fifth Avenue

Pittsburgh, PA 15213-2612

412-268-5800

[Office Locations](http://www.sei.cmu.edu/locations/index.cfm) | [Additional Sites Directory](http://www.sei.cmu.edu/additional-sites-directory/index.cfm) | [Legal](https://vuls.cert.org/confluence/display/VIN/VINCE%2BCode%2Bof%2BConduct#VINCECodeofConduct-TermsofUse) | [Privacy Notice](https://www.sei.cmu.edu/legal/privacy-notice/index.cfm) | [CMU Ethics Hotline](https://www.cmu.edu/hr/ethics-hotline/) | [www.sei.cmu.edu](http://www.sei.cmu.edu)

Â©2022 Carnegie Mellon University

[Contact SEI](https://www.sei.cmu.edu/contact-us/)
#### Contact CERT/CC

 412-268-5800



=== Content from toor.do_4e19abd0_20250124_153454.html ===
Universal plug and play
(UPnP)
mapping attacks

Daniel Garcia

Abstract

Universal   Plug   and   Play   is   a   popular   method   for   NAT   traversal   used   by   common
household devices. This document explores the different techniques attackers can use to
exploit port mapping services of UPnP/IGD devices on WAN ports. It also details a tool
called Umap that  can do manual  port-mapping(WAN to LAN, WAN to WAN), nat-
traversal   and   SOCKSv4   proxy   service   that   automatically   maps   to   UPnP   devices.
Devices with WAN ports allowing UPnP actions are the minority, but still a big threat.

Introduction

Universal Plug and Play(UPnP) is a technology developed by the UPnP Forum in 1999,
after funding mainly by Microsoft. The goal set by the UPnP forum, at that time, was to
allow devices to connect seamlessly and simplify network implementations. The only
problem with this goal is that it is inherently insecure. A secure system can't be plug and
play, it needs to ask questions and validate information. This is exactly one of the main
problems in UPnP, as it lacks any form of authentication.

To worsen the situation, control points are sometimes configured to accept requests from
the LAN and WAN side of the device. The control points are URL's where the SOAP
requests are directed for the execution of actions in UPnP. The most common actions
used are AddPortMapping and DeletePortMapping, used for the port mapping of devices
wanting to traverse the NAT.

UPnP Steps

0. Addressing: Interaction with the addressing methods used by the devices. It also
establishes rules for devices that are unable to get an address through DHCP.

1. Discovery: Discovery and announcement of the devices using SSDP. The devices

send multicast search requests using HTTPU. Control points respond with
HTTPU packets that specify a location for the XML description file.

2. Description: After the discovery of the XML description file location, the device
downloads the XML to discover the different services and actions that the device
has available.

3. Control: Through the description process, the device learns vital information to

interact with the control point. At this point it sends SOAP requests(actions) to the
specified control points to execute the different functions on the control point.
This is where the actual execution of the actions like AddPortMapping and
DeletePortMapping happen.

4. Eventing: Control points listen to changes in devices

5. Presentation: The referral to an HTML-based user interface for controlling

and/or viewing the device status.

Vulnerabilities

The first problem reported for UPnP was a Denial of Service attack reported by Ken
from FTUSecurity and applied to the Microsoft Windows 98/ME/XP stack. Afterwards
eEye published an advisory for a buffer overflow attack, also on the Microsoft stack. In
2003   Björn   Stickler   published   an   information   disclosure   advisory   for   the   Netgear
FM114P, the information disclosure was based on using the GetUserName action of
UPnP. Then in 2006 Armijn Hemel reported the vulnerability on remote users being able
to use UPnP to forward packets on external hosts. He also published his findings on the
www.upnp-hacks.org  site, one of the best sources of UPnP hacking information up to
date. This flaw highlighted by Armijn is what Umap relies on for the port mapping.

The main workings of  Umap rely on the “AddPortMapping” and “DeletePortMapping”
actions in the UPnP protocol. They are meant to be used by devices on a LAN that want
to traverse a NAT. Unfortunately, these control points are also available on the WAN
interfaces of the devices, allowing attackers to add a port map from the external WAN IP
to any host desired. The attacker can map a port on the external IP and forward that
traffic to another external host. The attacker can also map external ports on the WAN IP
to internal hosts behind the NAT of the device. This allows the attackers to scan for hosts
inside the NAT, forward traffic to external hosts and forward traffic to internal hosts.
Some   routers,   have   an   open   control   point   by   default.   In   fact,   some   routers   keep
accepting UPnP requests after disabling UPnP WAN requests.

There   are   many   problems   besides   port   mapping:   information   disclosure,   command
execution and DoS. For example, another problem that is less intrusive is the disclosure
of information regarding the device. On average the minimum information you can get
from UPnP IGD devices on the WAN side are the MAC address, serial number and
device model. This information could be used by attackers as an identifier to locate
modems on dynamic IP pools or just to target.

Umap

Umap is designed to work in different modes:

– Scanner for UPnP devices with exposed WAN control points
– SOCKSv4 proxy that forwards traffic through devices with exposed control

points

– Scanner/mapper of internal hosts behind a NAT of a device with exposed

control points

– Manual TCP/UDP mapping of exposed control points

There is not a lot of  PoC on UPnP publicly available. A clever exploit that sends UPnP
commands through the execution of javascript on the victim's browser was created by
GNUCitizen. There is also a tool available named Miranda by SecuriTeam. Its pretty
good and works well manipulating UPnP devices to execute actions. This tool, however,
is designed for LAN use only as it relies on SSDP and multicast for the discovery of
UPnP devices, which makes a lot of sense since the UPnP protocol v1.0 states that it is
the standard way of discovering UPnP devices. Umap, on the other hand, skips this step
and simply tries to fetch the XML descriptions of the devices. Relying on the Unicast
part of the UPnP transaction makes it suitable for scanning UPnP on WAN scenarios.

It relies on   a database of common locations and ports for XML description files on
UPnP   devices.   After   it   fetches   those   description   files   it   tries   to   execute   the
AddPortMapping and DeletePortMapping actions. For the internal network scanning, it
tries   to   guess   the   internal   IP  set   by   the   device   and   scans   each   host   for   a   group   of
common ports or the ports specified by argument.

Flow diagram on SOCKSv4 mode

Flow diagram on scanner mode

Negative aspects of UPnP mapping

There are many aspects on UPnP mapping that are not favorable. The biggest impact is
performance   when   using   other   routers.   Most   UPnP   devices   are   residential
gateways/CPEs that have a very limited upload bandwidth. Another factor that affects
performance greatly is the unpredictability of the different UPnP stacks on executing the
actions for the mapping. Most vendors cap the amount of port mappings in the stack,
limiting the amount of mappings. Some devices only allow, 10 mappings at a given
time, which lowers the performance of UPnP mapping in heavy connection scenarios
like web-browsing.

In terms of the noise made by the attack, some devices actively log the port mappings
with the source IP of the request. Unfortunately, residential users do not care/read the
logs of their devices. The operators that own the lines for the devices could implement
centralized   logging   solutions   which   could   allow   some   kind   of   mitigation   for   the
problem.

Mitigations

The mitigation falls down to two elements: Operators and Users. Users can mitigate by
reconfiguring their devices to disallow WAN traffic to a UPnP control point. Some IGD
devices only allow enabling/disabling UPnP services, without the ability to indicate if
you want to receive WAN traffic to the UPnP control point. Disabling UPnP completely
is sometimes troublesome, some devices require UPnP for NAT traversal.

Operators   can   mitigate   either   by   blocking   WAN   requests   to   client   devices   or   by
deploying the devices with base configurations that disable the UPnP WAN requests.
Using base configuration packages is a better solution because some UPnP stacks rely
on port 80 for the transmission of UPnP SOAP requests. Blocking WAN traffic could
block user management interfaces for the devices.

Disabling UPnP totally is a nightmare, because a lot of devices use UPnP to traverse.
Gaming   consoles   are   the   perfect   example   of   devices   that   need   UPnP   for   better
performance. The only reason I would recommend disabling UPnP is if you have a stack
that   keeps   accepting   WAN   requests   even   if   you   specify   that   you   don't   want  WAN
requests.

Affected devices

I have scanned different IP pools around the world looking for different stacks of UPnP
devices.   During   a   1   week   period   I   discovered   more   than   150,000   devices,   just   by
scanning random DSL IP pools. The speedtouch stack is by far the most common. There
may be many other devices vulnerable on-line, but I don't think there has been a lot of
research around that subject.

Manufacturer

Linksys

Edimax

Sitecom

Model

Version

WRT54GX < 4.30.5

BR-6104K < 3.21

WL-153

< 1.39

Speedtouch/Alcatel/Thomson 5x6

< 6.2.29

Thomson

TG585 v7 < 7.4.3.2


