=== Content from bugs.launchpad.net_4455d17b_20250126_011729.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# Potential directory traversal in \_untarzip\_image

Bug #894755 reported by
[Thierry Carrez](https://launchpad.net/~ttx)
on 2011-11-25

[260](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [Thierry Carrez](https://launchpad.net/~ttx) | [OpenStack Compute (nova) 2012.1 "essex"](https://launchpad.net/nova/%2Bmilestone/2012.1) |
|  | [Diablo](https://bugs.launchpad.net/nova/diablo) | Fix Released | Undecided | Unassigned | [OpenStack Compute (nova) 2011.3.1](https://launchpad.net/nova/%2Bmilestone/2011.3.1) |

### Bug Description

From David Black on [bug 885167](/bugs/885167):

One more possible bug (I don't know if this is reachable) is that the tarfile.extractall method is used in the

 static method \_untarzip\_image. This method is also vulnerable to path traversal (as per the warning in the tarfile module documentation).

Filing this here for further investigation.

Tags:

[in-stable-diablo](/nova/%2Bbugs?field.tag=in-stable-diablo)

## CVE References

* [2011-4596](/bugs/cve/2011-4596 "Multiple directory traversal vulnerab...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-25: |  |  | [#1](/nova/%2Bbug/894755/comments/1) |
| --- | --- | --- | --- |

We should definitely protect against directory traversal here... I'm pretty sure you can inject a malicious tarfile in the EC2 image upload process.

We should definitely protect against directory traversal here... I'm pretty sure you can inject a malicious tarfile in the EC2 image upload process.

| Changed in nova: | |
| --- | --- |
| **importance**: | Undecided → High |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-01: |  |  | [#2](/nova/%2Bbug/894755/comments/2) |
| --- | --- | --- | --- |

* [patch](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2614859/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2614859)
  (748 bytes,
  text/plain)

Proposed fix, nova-core please pre-review before we make it public.

Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

Proposed fix, nova-core please pre-review before we make it public.
Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Thierry Carrez (ttx) |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-02: |  |  | [#3](/nova/%2Bbug/894755/comments/3) |
| --- | --- | --- | --- |

Can you include a test to make sure we actually plug the hole? Include a "malicious" tarball in the tests directory (remember to add it to MANIFEST.in) and run it through this routine.

Can you include a test to make sure we actually plug the hole? Include a "malicious" tarball in the tests directory (remember to add it to MANIFEST.in) and run it through this routine.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-02: |  |  | [#4](/nova/%2Bbug/894755/comments/4) |
| --- | --- | --- | --- |

* [patch2](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616074/%2Bfiles/patch2)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616074)
  (2.7 KiB,
  text/plain)

Attached version including tarballs and test

Attached version including tarballs and test

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-02: |  |  | [#5](/nova/%2Bbug/894755/comments/5) |
| --- | --- | --- | --- |

* [abs.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616209/%2Bfiles/abs.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616209)
  (153 bytes,
  application/x-tar)

Tarballs for the test case

Tarballs for the test case

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-02: |  |  | [#6](/nova/%2Bbug/894755/comments/6) |
| --- | --- | --- | --- |

* [rel.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616210/%2Bfiles/rel.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616210)
  (165 bytes,
  application/x-tar)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-06: |  |  | [#7](/nova/%2Bbug/894755/comments/7) |
| --- | --- | --- | --- |

Patch lgtm.

Patch lgtm.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-06: |  |  | [#8](/nova/%2Bbug/894755/comments/8) |
| --- | --- | --- | --- |

See proposed advisory at: [https://bugs.launchpad.net/nova/+bug/885167/comments/15](https://bugs.launchpad.net/nova/%2Bbug/885167/comments/15)

See proposed advisory at: https://bugs.launchpad.net/nova/+bug/885167/comments/15

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark McLoughlin (markmc)](https://launchpad.net/~markmc) wrote on 2011-12-06: |  |  | [#9](/nova/%2Bbug/894755/comments/9) |
| --- | --- | --- | --- |

Issue looks valid to me - we can't trust what users upload to s3/objectstore

Fix looks fine too - it's a bit odd to open the file twice, but the alternative of doing something like tar\_file.fileobj.seek(0) is just too hacky. Also, no attempt is made to explicitly close the file if there's an exception, but that's true of the original untarzip\_image() code too

So, yeah - lgtm too

Issue looks valid to me - we can't trust what users upload to s3/objectstore
Fix looks fine too - it's a bit odd to open the file twice, but the alternative of doing something like tar\_file.fileobj.seek(0) is just too hacky. Also, no attempt is made to explicitly close the file if there's an exception, but that's true of the original untarzip\_image() code too
So, yeah - lgtm too

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-12-07: |  |  | [#10](/nova/%2Bbug/894755/comments/10) |
| --- | --- | --- | --- |

lgtm. We might want to refactor into a specific exception later, but lets keep the patch small for now.

lgtm. We might want to refactor into a specific exception later, but lets keep the patch small for now.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-08: |  |  | [#11](/nova/%2Bbug/894755/comments/11) |
| --- | --- | --- | --- |

Notification sent to downstream distros / public users (common with [bug 885167](/bugs/885167))

Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Notification sent to downstream distros / public users (common with bug 885167)
Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-09: |  |  | [#12](/nova/%2Bbug/894755/comments/12) |
| --- | --- | --- | --- |

Assigned CVE-2011-4596

Assigned CVE-2011-4596

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-13

| **visibility**: | private → public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (master)**](/nova/%2Bbug/894755/comments/13) |  |  | [#13](/nova/%2Bbug/894755/comments/13) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2283>

Committed: <http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e>

Submitter: Jenkins

Branch: master

status fixcommitted

 done

commit ad3241929ea00569c74505ed002208ce360c667e

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2283
Committed: http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e
Submitter: Jenkins
Branch: master
status fixcommitted
done
commit ad3241929ea00569c74505ed002208ce360c667e
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (stable/diablo)**](/nova/%2Bbug/894755/comments/14) |  |  | [#14](/nova/%2Bbug/894755/comments/14) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2284>

Committed: <http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6>

Submitter: James E. Blair (<email address hidden>)

Branch: stable/diablo

tag in-stable-diablo

 done

commit 76363226bd8533256f7795bba358d7f4b8a6c9e6

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2284
Committed: http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6
Submitter: James E. Blair (corvus@inaugust.com)
Branch: stable/diablo
tag in-stable-diablo
done
commit 76363226bd8533256f7795bba358d7f4b8a6c9e6
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-13: |  |  | [#15](/nova/%2Bbug/894755/comments/15) |
| --- | --- | --- | --- |

Released as OSSA 2011-001

Released as OSSA 2011-001

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-14

| Changed in nova: | |
| --- | --- |
| **milestone**: | none → essex-2 |
| **status**: | Fix Committed → Fix Released |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2012-04-05

| Changed in nova: | |
| --- | --- |
| **milestone**: | essex-2 → 2012.1 |

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/894755/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [patch](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2614859/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2614859 "Change patch details")
* [patch2](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616074/%2Bfiles/patch2)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616074 "Change patch details")

* [Add patch](/nova/%2Bbug/894755/%2Baddcomment?field.patch=on)

## Bug attachments

* [abs.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616209/%2Bfiles/abs.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616209 "Change attachment details")
* [rel.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616210/%2Bfiles/rel.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616210 "Change attachment details")

* [Add attachment](/nova/%2Bbug/894755/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_1d0b4763_20250126_011726.html ===

[Log in / Register](https://launchpad.net/~ttx/%2Blogin)

[![](https://launchpadlibrarian.net/116816327/ttx64.jpg)](https://launchpad.net/~ttx)

## [Thierry Carrez](https://launchpad.net/~ttx)

* Overview
* [Code](https://code.launchpad.net/~ttx)
* [Bugs](https://bugs.launchpad.net/~ttx)
* [Blueprints](https://blueprints.launchpad.net/~ttx)
* [Translations](https://translations.launchpad.net/~ttx)
* [Answers](https://answers.launchpad.net/~ttx)

Chair of the Technical Committee and Release Manager for OpenStack.

Python Software Foundation member.

Ubuntu core developer.

* [Related packages](https://launchpad.net/~ttx/%2Brelated-packages)
* [Related projects](https://launchpad.net/~ttx/%2Brelated-projects)

## User information

Launchpad Id:
ttx

Email:
[Log in](%2Blogin) for email information.

Member since:
2008-05-12

[![Icon of Cassandra Ubuntu Packaging](https://launchpadlibrarian.net/59580596/cassandra-ubuntu-icon.png "Member of Cassandra Ubuntu Packaging")](/~cassandra-ubuntu)
[![Icon of (deprecated) OpenStack PPA maintainers](https://launchpadlibrarian.net/87891894/ppa.gif "Member of (deprecated) OpenStack PPA maintainers")](/~openstack-ppa)
[![Icon of Designate Drivers](https://launchpadlibrarian.net/360468067/designate_14.jpg "Member of Designate Drivers")](/~designate-drivers)
[![Icon of Launchpad Beta Testers](https://launchpadlibrarian.net/600856498/Canonical_Launchpad_icon_14px.png "Member of Launchpad Beta Testers")](/~launchpad-beta-testers)
[![Icon of Martin Pitt's fan](https://launchpadlibrarian.net/16410730/immaginexz0.png "Member of Martin Pitt's fan")](/~we-love-pitti)
[![Icon of Nova](https://launchpadlibrarian.net/52560219/os14.png "Member of Nova")](/~nova)
[![Icon of OpenStack release team](https://launchpadlibrarian.net/73211233/openstack-release.png "Member of OpenStack release team")](/~openstack-release)
[![Icon of OpenStack Security SIG](https://launchpadlibrarian.net/203991792/os14.png "Member of OpenStack Security SIG")](/~openstack-ossg)
[![Icon of OpenStack Team](https://launchpadlibrarian.net/52313052/os14.png "Member of OpenStack Team")](/~openstack)
[![Icon of Python OpenStack Client Drivers](https://launchpadlibrarian.net/697274978/osc-icon.png "Member of Python OpenStack Client Drivers")](/~python-openstackclient-drivers)
[![Icon of Python OpenStack Client](https://launchpadlibrarian.net/697274843/osc-icon.png "Member of Python OpenStack Client")](/~python-openstackclient)
[![Icon of Soren's Target Audience](https://launchpadlibrarian.net/20548684/golf.png "Member of Soren's Target Audience")](/~sorens-target-audience)
[![Icon of Ubuntu Contributing Developers](https://launchpadlibrarian.net/17290192/wrench_emblem-trans.png "Member of Ubuntu Contributing Developers")](/~ubuntu-developer-members)
[![Icon of Ubuntu Members](https://launchpadlibrarian.net/606495581/CoF%2014px.png "Member of Ubuntu Members")](/~ubuntumembers)
[![Icon of Ubuntu Server papercutters](https://launchpadlibrarian.net/38078797/14.png "Member of Ubuntu Server papercutters")](/~server-papercutters)

Signed Ubuntu Code of Conduct:
Yes

Languages:

English, French

OpenPGP keys:

22A7943050DB1E67EC2B641A507AF89025B10423

SSH keys:

[ttx@stardust](%2Bsshkeys)

[ttx@mercury](%2Bsshkeys)

Time zone:

Europe/Paris
(UTC+0100)

Karma:
[0](https://launchpad.net/~ttx/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

Social accounts:
![IRC](/@@/social-irc "IRC")
**ttx**
 on
**FreeNode**

## [All bugs in progress](https://launchpad.net/~ttx/%2Bassignedbugs?search=Search&field.status=In+Progress) Assigned bugs

||  | #1473369 [new mock release broke a bunch of unit tests](https://bugs.launchpad.net/python-muranoclient/kilo/%2Bbug/1473369) |  |
| --- | --- | --- |
| in [python-muranoclient](/python-muranoclient), [Glance](/glance), [glance\_store](/glance-store), [Murano](/murano), [neutron](/neutron), [OpenStack Object Storage (swift)](/swift) | | |

| --- | --- | --- | --- | --- | --- |

## Personal package archives

| [Test Openstack 2011.3](/~ttx/%2Barchive/ubuntu/2011.3) |
| --- |
| [Extra packages](/~ttx/%2Barchive/ubuntu/extras) |
| [Bexar update candidates](/~ttx/%2Barchive/ubuntu/nova-bexar-updates) |
| [Junk PPA](/~ttx/%2Barchive/ubuntu/ppa) |
| [Terracotta stack](/~ttx/%2Barchive/ubuntu/terracotta) |

## [All memberships](https://launchpad.net/~ttx/%2Bparticipation) Latest memberships

| [kata-containers](/~kata-containers)  Joined on 2018-10-09 | |
| --- | --- |
| [OpenStack Folsom Stable Maintainers](/~openstack-folsom-maint)  Joined on 2013-04-11 | |
| [OpenStack Python3 Migration Team](/~openstack-py3-team)  Joined on 2013-03-20 | |
| [OpenStack Security SIG](/~openstack-ossg)  Joined on 2012-05-25 | |
| [Swift Drivers](/~swift-drivers)  Joined on 2012-04-06 | |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_a734180a_20250126_011729.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# Potential directory traversal in \_untarzip\_image

Bug #894755 reported by
[Thierry Carrez](https://launchpad.net/~ttx)
on 2011-11-25

[260](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [Thierry Carrez](https://launchpad.net/~ttx) | [OpenStack Compute (nova) 2012.1 "essex"](https://launchpad.net/nova/%2Bmilestone/2012.1) |
|  | [Diablo](https://bugs.launchpad.net/nova/diablo) | Fix Released | Undecided | Unassigned | [OpenStack Compute (nova) 2011.3.1](https://launchpad.net/nova/%2Bmilestone/2011.3.1) |

### Bug Description

From David Black on [bug 885167](/bugs/885167):

One more possible bug (I don't know if this is reachable) is that the tarfile.extractall method is used in the

 static method \_untarzip\_image. This method is also vulnerable to path traversal (as per the warning in the tarfile module documentation).

Filing this here for further investigation.

Tags:

[in-stable-diablo](/nova/%2Bbugs?field.tag=in-stable-diablo)

## CVE References

* [2011-4596](/bugs/cve/2011-4596 "Multiple directory traversal vulnerab...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-25: |  |  | [#1](/nova/%2Bbug/894755/comments/1) |
| --- | --- | --- | --- |

We should definitely protect against directory traversal here... I'm pretty sure you can inject a malicious tarfile in the EC2 image upload process.

We should definitely protect against directory traversal here... I'm pretty sure you can inject a malicious tarfile in the EC2 image upload process.

| Changed in nova: | |
| --- | --- |
| **importance**: | Undecided → High |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-01: |  |  | [#2](/nova/%2Bbug/894755/comments/2) |
| --- | --- | --- | --- |

* [patch](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2614859/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2614859)
  (748 bytes,
  text/plain)

Proposed fix, nova-core please pre-review before we make it public.

Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

Proposed fix, nova-core please pre-review before we make it public.
Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Thierry Carrez (ttx) |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-02: |  |  | [#3](/nova/%2Bbug/894755/comments/3) |
| --- | --- | --- | --- |

Can you include a test to make sure we actually plug the hole? Include a "malicious" tarball in the tests directory (remember to add it to MANIFEST.in) and run it through this routine.

Can you include a test to make sure we actually plug the hole? Include a "malicious" tarball in the tests directory (remember to add it to MANIFEST.in) and run it through this routine.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-02: |  |  | [#4](/nova/%2Bbug/894755/comments/4) |
| --- | --- | --- | --- |

* [patch2](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616074/%2Bfiles/patch2)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616074)
  (2.7 KiB,
  text/plain)

Attached version including tarballs and test

Attached version including tarballs and test

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-02: |  |  | [#5](/nova/%2Bbug/894755/comments/5) |
| --- | --- | --- | --- |

* [abs.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616209/%2Bfiles/abs.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616209)
  (153 bytes,
  application/x-tar)

Tarballs for the test case

Tarballs for the test case

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-02: |  |  | [#6](/nova/%2Bbug/894755/comments/6) |
| --- | --- | --- | --- |

* [rel.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616210/%2Bfiles/rel.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616210)
  (165 bytes,
  application/x-tar)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-06: |  |  | [#7](/nova/%2Bbug/894755/comments/7) |
| --- | --- | --- | --- |

Patch lgtm.

Patch lgtm.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-06: |  |  | [#8](/nova/%2Bbug/894755/comments/8) |
| --- | --- | --- | --- |

See proposed advisory at: [https://bugs.launchpad.net/nova/+bug/885167/comments/15](https://bugs.launchpad.net/nova/%2Bbug/885167/comments/15)

See proposed advisory at: https://bugs.launchpad.net/nova/+bug/885167/comments/15

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark McLoughlin (markmc)](https://launchpad.net/~markmc) wrote on 2011-12-06: |  |  | [#9](/nova/%2Bbug/894755/comments/9) |
| --- | --- | --- | --- |

Issue looks valid to me - we can't trust what users upload to s3/objectstore

Fix looks fine too - it's a bit odd to open the file twice, but the alternative of doing something like tar\_file.fileobj.seek(0) is just too hacky. Also, no attempt is made to explicitly close the file if there's an exception, but that's true of the original untarzip\_image() code too

So, yeah - lgtm too

Issue looks valid to me - we can't trust what users upload to s3/objectstore
Fix looks fine too - it's a bit odd to open the file twice, but the alternative of doing something like tar\_file.fileobj.seek(0) is just too hacky. Also, no attempt is made to explicitly close the file if there's an exception, but that's true of the original untarzip\_image() code too
So, yeah - lgtm too

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-12-07: |  |  | [#10](/nova/%2Bbug/894755/comments/10) |
| --- | --- | --- | --- |

lgtm. We might want to refactor into a specific exception later, but lets keep the patch small for now.

lgtm. We might want to refactor into a specific exception later, but lets keep the patch small for now.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-08: |  |  | [#11](/nova/%2Bbug/894755/comments/11) |
| --- | --- | --- | --- |

Notification sent to downstream distros / public users (common with [bug 885167](/bugs/885167))

Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Notification sent to downstream distros / public users (common with bug 885167)
Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-09: |  |  | [#12](/nova/%2Bbug/894755/comments/12) |
| --- | --- | --- | --- |

Assigned CVE-2011-4596

Assigned CVE-2011-4596

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-13

| **visibility**: | private → public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (master)**](/nova/%2Bbug/894755/comments/13) |  |  | [#13](/nova/%2Bbug/894755/comments/13) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2283>

Committed: <http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e>

Submitter: Jenkins

Branch: master

status fixcommitted

 done

commit ad3241929ea00569c74505ed002208ce360c667e

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2283
Committed: http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e
Submitter: Jenkins
Branch: master
status fixcommitted
done
commit ad3241929ea00569c74505ed002208ce360c667e
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (stable/diablo)**](/nova/%2Bbug/894755/comments/14) |  |  | [#14](/nova/%2Bbug/894755/comments/14) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2284>

Committed: <http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6>

Submitter: James E. Blair (<email address hidden>)

Branch: stable/diablo

tag in-stable-diablo

 done

commit 76363226bd8533256f7795bba358d7f4b8a6c9e6

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2284
Committed: http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6
Submitter: James E. Blair (corvus@inaugust.com)
Branch: stable/diablo
tag in-stable-diablo
done
commit 76363226bd8533256f7795bba358d7f4b8a6c9e6
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-13: |  |  | [#15](/nova/%2Bbug/894755/comments/15) |
| --- | --- | --- | --- |

Released as OSSA 2011-001

Released as OSSA 2011-001

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-14

| Changed in nova: | |
| --- | --- |
| **milestone**: | none → essex-2 |
| **status**: | Fix Committed → Fix Released |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2012-04-05

| Changed in nova: | |
| --- | --- |
| **milestone**: | essex-2 → 2012.1 |

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/894755/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [patch](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2614859/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2614859 "Change patch details")
* [patch2](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616074/%2Bfiles/patch2)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616074 "Change patch details")

* [Add patch](/nova/%2Bbug/894755/%2Baddcomment?field.patch=on)

## Bug attachments

* [abs.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616209/%2Bfiles/abs.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616209 "Change attachment details")
* [rel.tar.gz](https://bugs.launchpad.net/nova/%2Bbug/894755/%2Battachment/2616210/%2Bfiles/rel.tar.gz)
  [Edit](/nova/%2Bbug/894755/%2Battachment/2616210 "Change attachment details")

* [Add attachment](/nova/%2Bbug/894755/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_49e768cb_20250126_011727.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# Path Traversal possible when downloading an image

Bug #885167 reported by
[David](https://launchpad.net/~d--)
on 2011-11-02

[258](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [Thierry Carrez](https://launchpad.net/~ttx) | [OpenStack Compute (nova) 2012.1 "essex"](https://launchpad.net/nova/%2Bmilestone/2012.1) |
|  | [Diablo](https://bugs.launchpad.net/nova/diablo) | Fix Released | Undecided | Unassigned | [OpenStack Compute (nova) 2011.3.1](https://launchpad.net/nova/%2Bmilestone/2011.3.1) |

### Bug Description

Because of #885165, it maybe possible for a remote attacker who can perform a man in the middle attack to provide a bucket with an image file-name which includes "/" and or "..". The path for the image file which is taken from the desired destination directory joined with the filename found in the bucket. This occurs in the static method \_download\_file. The \_download\_file method, as the name indicates also downloads the image to the respective file path.

The actual downloading of the image occurs via the key.get\_contents\_to\_filename call. The get\_contents\_to\_filename method will open a file at the 'local\_filename' location through the following code( as found in boto/s3/key.py):

def get\_contents\_to\_filename(self, filename, headers=None,

      ...

     fp = open(filename, 'wb')

Which opens a new file object at the location provided. The \_download\_file method should ensure that the file-name is safe to use before calling the get\_contents\_to\_filename method.

[0]

    @staticmethod

    def \_download\_file(bucket, filename, local\_dir):

        key = bucket.get\_key(filename)

        local\_filename = os.path.join(local\_dir, filename)

        key.get\_contents\_to\_filename(local\_filename)

        return local\_filename

See [original description](comments/0)

Tags:

[in-stable-diablo](/nova/%2Bbugs?field.tag=in-stable-diablo)

## CVE References

* [2011-4596](/bugs/cve/2011-4596 "Multiple directory traversal vulnerab...")

[David (d--)](https://launchpad.net/~d--)
on 2011-11-02

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David (d--)](https://launchpad.net/~d--) wrote on 2011-11-02: |  |  | [#1](/nova/%2Bbug/885167/comments/1) |
| --- | --- | --- | --- |

One more possible bug (I don't know if this is reachable) is that the tarfile.extractall method is used in the

 static method \_untarzip\_image. This method is also vulnerable to path traversal (as per the warning in the tarfile module documentation).

One more possible bug (I don't know if this is reachable) is that the tarfile.extractall method is used in the
static method \_untarzip\_image. This method is also vulnerable to path traversal (as per the warning in the tarfile module documentation).

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Robert Clark (robert-clark)](https://launchpad.net/~robert-clark) wrote on 2011-11-14: |  |  | [#2](/nova/%2Bbug/885167/comments/2) |
| --- | --- | --- | --- |

This isn't because of the other bug although the fact that it can be exploited when traffic is in the clear is significant.

It would seem to me that the main issue is that an attacker making this call (either a malicious user or a man-in-the-middle) can perform a path traversal because get\_contents\_to\_filename doesn't validate strings correctly.

This isn't because of the other bug although the fact that it can be exploited when traffic is in the clear is significant.
It would seem to me that the main issue is that an attacker making this call (either a malicious user or a man-in-the-middle) can perform a path traversal because get\_contents\_to\_filename doesn't validate strings correctly.

| Changed in nova: | |
| --- | --- |
| **status**: | New → Confirmed |

[Robert Clark (robert-clark)](https://launchpad.net/~robert-clark)
on 2011-11-14

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Robert Clark (robert-clark) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-14: |  |  | [#3](/nova/%2Bbug/885167/comments/3) |
| --- | --- | --- | --- |

At the very least the filename retrieved from the manifest should be filtered through basename ?

That said I wonder if that code is even used since it contains a typo on line 215 (use of "ec2\_utils") that should be hit with every manifest with a kernel id, and various other strange things (unused image\_id and image\_type fields). Vish ?

David: could you open a separate security bug so that we investigate the tarfile thing separately ?

At the very least the filename retrieved from the manifest should be filtered through basename ?
That said I wonder if that code is even used since it contains a typo on line 215 (use of "ec2\_utils") that should be hit with every manifest with a kernel id, and various other strange things (unused image\_id and image\_type fields). Vish ?
David: could you open a separate security bug so that we investigate the tarfile thing separately ?

| Changed in nova: | |
| --- | --- |
| **assignee**: | Robert Clark (robert-clark) → nobody |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-14: |  |  | [#4](/nova/%2Bbug/885167/comments/4) |
| --- | --- | --- | --- |

Oops, concurrent change

Oops, concurrent change

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Robert Clark (robert-clark) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David (d--)](https://launchpad.net/~d--) wrote on 2011-11-14: |  |  | [#5](/nova/%2Bbug/885167/comments/5) |
| --- | --- | --- | --- |

Well I don't know if the tarfile bug is reachable. From what I saw the image would need to be signed?

(I can open another issue but I wasn't even sure if this code was actually used ...).

Well I don't know if the tarfile bug is reachable. From what I saw the image would need to be signed?
(I can open another issue but I wasn't even sure if this code was actually used ...).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-11-14:  [**Re: [Bug 885167] Re: Path Traversal possible when downloading an image**](/nova/%2Bbug/885167/comments/6) |  |  | [#6](/nova/%2Bbug/885167/comments/6) |
| --- | --- | --- | --- |

Thierry: The ec2\_utils thing is definitely a bug. Not sure about the image\_id. Checking with waldon

Thierry: The ec2\_utils thing is definitely a bug. Not sure about the image\_id. Checking with waldon

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-17: |  |  | [#7](/nova/%2Bbug/885167/comments/7) |
| --- | --- | --- | --- |

@DavidB: please open a bug about it, just in case, so that we can investigate further.

@Robert: Are you going to propose a change to Gerrit for this ?

@VMT: I suggest VMT Level = Medium, looks like it could be exploited by uploading a crafted manifest

@DavidB: please open a bug about it, just in case, so that we can investigate further.
@Robert: Are you going to propose a change to Gerrit for this ?
@VMT: I suggest VMT Level = Medium, looks like it could be exploited by uploading a crafted manifest

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-25: |  |  | [#8](/nova/%2Bbug/885167/comments/8) |
| --- | --- | --- | --- |

The tarfile bug was filed separately as [bug 894755](/bugs/894755).

The tarfile bug was filed separately as bug 894755.

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → Triaged |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Robert Clark (robert-clark)](https://launchpad.net/~robert-clark) wrote on 2011-11-25: |  |  | [#9](/nova/%2Bbug/885167/comments/9) |
| --- | --- | --- | --- |

Vish, Please can you take a look at this.

Thanks

Vish, Please can you take a look at this.
Thanks

| Changed in nova: | |
| --- | --- |
| **assignee**: | Robert Clark (robert-clark) → Vish Ishaya (vishvananda) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-11-28: |  |  | [#10](/nova/%2Bbug/885167/comments/10) |
| --- | --- | --- | --- |

Robert: what specifically do you want me to look at? This is definitely a bug. Were you going to propose a fix?

Robert: what specifically do you want me to look at? This is definitely a bug. Were you going to propose a fix?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-29: |  |  | [#11](/nova/%2Bbug/885167/comments/11) |
| --- | --- | --- | --- |

I think Robert is deferring to you for advice on who could do it. If nobody else picks it up, I can propose a fix.

I think Robert is deferring to you for advice on who could do it. If nobody else picks it up, I can propose a fix.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-11-29:  [**Re: [Bug 885167] Path Traversal possible when downloading an image**](/nova/%2Bbug/885167/comments/12) |  |  | [#12](/nova/%2Bbug/885167/comments/12) |
| --- | --- | --- | --- |

I don't have someone specific in mind, but it looks like a pretty simple change.

Vish

On Nov 29, 2011, at 2:54 AM, Thierry Carrez wrote:

> I think Robert is deferring to you for advice on who could do it. If

> nobody else picks it up, I can propose a fix.

>

> --

> You received this bug notification because you are a member of Nova

> Core, which is subscribed to the bug report.

> <https://bugs.launchpad.net/bugs/885167>

>

> Title:

> Path Traversal possible when downloading an image

>

> Status in OpenStack Compute (Nova):

> Triaged

>

> Bug description:

> Because of #885165, it maybe possible for a remote attacker who can perform a man in the middle attack to provide a bucket with an image file-name which includes "/" and or "..". The path for the image file which is taken from the desired destination directory joined with the filename found in the bucket. This occurs in the static method \_download\_file. The \_download\_file method, as the name indicates also downloads the image to the respective file path.

> The actual downloading of the image occurs via the key.get\_contents\_to\_filename call. The get\_contents\_to\_filename method will open a file at the 'local\_filename' location through the following code( as found in boto/s3/key.py):

>

> def get\_contents\_to\_filename(self, filename, headers=None,

> ...

> fp = open(filename, 'wb')

>

>

> Which opens a new file object at the location provided. The \_download\_file method should ensure that the file-name is safe to use before calling the get\_contents\_to\_filename method.

>

>

>

> [0]

> @staticmethod

> def \_download\_file(bucket, filename, local\_dir):

> key = bucket.get\_key(filename)

> local\_filename = os.path.join(local\_dir, filename)

> key.get\_contents\_to\_filename(local\_filename)

> return local\_filename

>

> To manage notifications about this bug go to:

> [https://bugs.launchpad.net/nova/+bug/885167/+subscriptions](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Bsubscriptions)

I don't have someone specific in mind, but it looks like a pretty simple change.
Vish
On Nov 29, 2011, at 2:54 AM, Thierry Carrez wrote:
> I think Robert is deferring to you for advice on who could do it. If
> nobody else picks it up, I can propose a fix.
>
> --
> You received this bug notification because you are a member of Nova
> Core, which is subscribed to the bug report.
> https://bugs.launchpad.net/bugs/885167
>
> Title:
> Path Traversal possible when downloading an image
>
> Status in OpenStack Compute (Nova):
> Triaged
>
> Bug description:
> Because of #885165, it maybe possible for a remote attacker who can perform a man in the middle attack to provide a bucket with an image file-name which includes "/" and or "..". The path for the image file which is taken from the desired destination directory joined with the filename found in the bucket. This occurs in the static method \_download\_file. The \_download\_file method, as the name indicates also downloads the image to the respective file path.
> The actual downloading of the image occurs via the key.get\_contents\_to\_filename call. The get\_contents\_to\_filename method will open a file at the 'local\_filename' location through the following code( as found in boto/s3/key.py):
>
> def get\_contents\_to\_filename(self, filename, headers=None,
> ...
> fp = open(filename, 'wb')
>
>
> Which opens a new file object at the location provided. The \_download\_file method should ensure that the file-name is safe to use before calling the get\_contents\_to\_filename method.
>
>
>
> [0]
> @staticmethod
> def \_download\_file(bucket, filename, local\_dir):
> key = bucket.get\_key(filename)
> local\_filename = os.path.join(local\_dir, filename)
> key.get\_contents\_to\_filename(local\_filename)
> return local\_filename
>
> To manage notifications about this bug go to:
> https://bugs.launchpad.net/nova/+bug/885167/+subscriptions

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-01: |  |  | [#13](/nova/%2Bbug/885167/comments/13) |
| --- | --- | --- | --- |

* [patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2614837/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2614837)
  (513 bytes,
  text/plain)

Proposed fix, nova-core please pre-review before we make it public.

Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

Proposed fix, nova-core please pre-review before we make it public.
Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-01

| Changed in nova: | |
| --- | --- |
| **assignee**: | Vish Ishaya (vishvananda) → Thierry Carrez (ttx) |
| **status**: | Triaged → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-06: |  |  | [#14](/nova/%2Bbug/885167/comments/14) |
| --- | --- | --- | --- |

Patch lgtm.

Patch lgtm.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-06: |  |  | [#15](/nova/%2Bbug/885167/comments/15) |
| --- | --- | --- | --- |

Proposed advisory (merged with [bug 894755](/bugs/894755)):

Title: Path traversal issues registering malicious images using EC2 API

Impact: High

Announced: ...

Reporter: David Black

Products: Nova

Description:

David Black reported two issues in OpenStack Nova's support for EC2 RegisterImage action. By registering images from malicious tarballs or manifests, an attacker could potentially traverse directories and overwrite files with the rights of the user Nova runs under. Only setups allowing the EC2 API and the S3/RegisterImage method for registering images are affected.

Proposed advisory (merged with bug 894755):
Title: Path traversal issues registering malicious images using EC2 API
Impact: High
Announced: ...
Reporter: David Black
Products: Nova
Description:
David Black reported two issues in OpenStack Nova's support for EC2 RegisterImage action. By registering images from malicious tarballs or manifests, an attacker could potentially traverse directories and overwrite files with the rights of the user Nova runs under. Only setups allowing the EC2 API and the S3/RegisterImage method for registering images are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark McLoughlin (markmc)](https://launchpad.net/~markmc) wrote on 2011-12-06: |  |  | [#16](/nova/%2Bbug/885167/comments/16) |
| --- | --- | --- | --- |

* [Untested patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2621840/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2621840)
  (1.4 KiB,
  text/plain)

Issue looks valid here too - user-uploaded image manifest can't be trusted

The patch is fine, I think. But it might be worth considering an even safer option - use image.part.N as the filename, since we're downloading to a temporary directory we've just created

Issue looks valid here too - user-uploaded image manifest can't be trusted
The patch is fine, I think. But it might be worth considering an even safer option - use image.part.N as the filename, since we're downloading to a temporary directory we've just created

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-06: |  |  | [#17](/nova/%2Bbug/885167/comments/17) |
| --- | --- | --- | --- |

markmc: Your patch is better -- though for security patches the idea is to simplify the fix as much as you can (here you don't just weed out malicious filenames, you also change filenames for non-malicious files, which I suppose is OK, but maybe not).

markmc: Your patch is better -- though for security patches the idea is to simplify the fix as much as you can (here you don't just weed out malicious filenames, you also change filenames for non-malicious files, which I suppose is OK, but maybe not).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-12-07: |  |  | [#18](/nova/%2Bbug/885167/comments/18) |
| --- | --- | --- | --- |

I think marks patch is fine. It is a little bigger, but I do like ignoring the passed in name completely.

I think marks patch is fine. It is a little bigger, but I do like ignoring the passed in name completely.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-08: |  |  | [#19](/nova/%2Bbug/885167/comments/19) |
| --- | --- | --- | --- |

I don't have any particular preference about either approach, but only Thierry's patch comes with unit tests proving that it actually fixes the problem, so that has my vote so far.

I don't have any particular preference about either approach, but only Thierry's patch comes with unit tests proving that it actually fixes the problem, so that has my vote so far.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark McLoughlin (markmc)](https://launchpad.net/~markmc) wrote on 2011-12-08: |  |  | [#20](/nova/%2Bbug/885167/comments/20) |
| --- | --- | --- | --- |

Hmm, I don't see unit tests? Am I missing something? I expect any unit test for this would work with my variant too anyway

I don't mind either way - we can go with the one-liner patch and add my version later

Hmm, I don't see unit tests? Am I missing something? I expect any unit test for this would work with my variant too anyway
I don't mind either way - we can go with the one-liner patch and add my version later

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-08: |  |  | [#21](/nova/%2Bbug/885167/comments/21) |
| --- | --- | --- | --- |

Mark, sorry, I was confused. I was thinking of Thierry's patch for [bug 894755](/bugs/894755).

I think I prefer ttx's approach for the quick fix, and then we can go with yours from Essex and onwards.

Mark, sorry, I was confused. I was thinking of Thierry's patch for bug 894755.
I think I prefer ttx's approach for the quick fix, and then we can go with yours from Essex and onwards.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-08: |  |  | [#22](/nova/%2Bbug/885167/comments/22) |
| --- | --- | --- | --- |

Notification sent to downstream distros / public users.

Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Notification sent to downstream distros / public users.
Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-09: |  |  | [#23](/nova/%2Bbug/885167/comments/23) |
| --- | --- | --- | --- |

Assigned CVE-2011-4596

Assigned CVE-2011-4596

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-13

| **visibility**: | private → public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (master)**](/nova/%2Bbug/885167/comments/24) |  |  | [#24](/nova/%2Bbug/885167/comments/24) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2283>

Committed: <http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e>

Submitter: Jenkins

Branch: master

status fixcommitted

 done

commit ad3241929ea00569c74505ed002208ce360c667e

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2283
Committed: http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e
Submitter: Jenkins
Branch: master
status fixcommitted
done
commit ad3241929ea00569c74505ed002208ce360c667e
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (stable/diablo)**](/nova/%2Bbug/885167/comments/25) |  |  | [#25](/nova/%2Bbug/885167/comments/25) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2284>

Committed: <http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6>

Submitter: James E. Blair (<email address hidden>)

Branch: stable/diablo

tag in-stable-diablo

 done

commit 76363226bd8533256f7795bba358d7f4b8a6c9e6

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2284
Committed: http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6
Submitter: James E. Blair (corvus@inaugust.com)
Branch: stable/diablo
tag in-stable-diablo
done
commit 76363226bd8533256f7795bba358d7f4b8a6c9e6
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-13: |  |  | [#26](/nova/%2Bbug/885167/comments/26) |
| --- | --- | --- | --- |

Released as OSSA 2011-001

Released as OSSA 2011-001

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-14

| Changed in nova: | |
| --- | --- |
| **milestone**: | none → essex-2 |
| **status**: | Fix Committed → Fix Released |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2012-04-05

| Changed in nova: | |
| --- | --- |
| **milestone**: | essex-2 → 2012.1 |

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/885167/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2614837/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2614837 "Change patch details")

* [Add patch](/nova/%2Bbug/885167/%2Baddcomment?field.patch=on)

## Bug attachments

* [Untested patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2621840/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2621840 "Change attachment details")

* [Add attachment](/nova/%2Bbug/885167/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from github.com_b0d4c90a_20250124_131800.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenstack%2Fnova%2Fcommit%2Fad3241929ea00569c74505ed002208ce360c667e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenstack%2Fnova%2Fcommit%2Fad3241929ea00569c74505ed002208ce360c667e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=openstack%2Fnova)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openstack](/openstack)
/
**[nova](/openstack/nova)**
Public

* [Notifications](/login?return_to=%2Fopenstack%2Fnova) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fopenstack%2Fnova)
* [Star
   3.1k](/login?return_to=%2Fopenstack%2Fnova)

* [Code](/openstack/nova)
* [Pull requests
  0](/openstack/nova/pulls)
* [Actions](/openstack/nova/actions)
* [Security](/openstack/nova/security)
* [Insights](/openstack/nova/pulse)

Additional navigation options

* [Code](/openstack/nova)
* [Pull requests](/openstack/nova/pulls)
* [Actions](/openstack/nova/actions)
* [Security](/openstack/nova/security)
* [Insights](/openstack/nova/pulse)

## Commit

[Permalink](/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Sanitize EC2 manifests and image tarballs

[Browse files](/openstack/nova/tree/ad3241929ea00569c74505ed002208ce360c667e)
Browse the repository at this point in the history

```
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755

Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1
```

* Loading branch information

[![@ttx](https://avatars.githubusercontent.com/u/712511?s=40&v=4)](/ttx)

[ttx](/openstack/nova/commits?author=ttx "View all commits by ttx")
committed
Dec 13, 2011

1 parent
[1c08592](/openstack/nova/commit/1c0859283f4e497cc9abea06039f5595406208ef)

commit ad32419

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**23 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* MANIFEST.in
  [MANIFEST.in](#diff-41d5a52589e0480be9c099d2bba7a8135b8b0d71bcbb8df3582a8df1c2295003)
* nova

  + image

    - nova/image/s3.py
      [s3.py](#diff-8d7b82dbb34648676417f6d4de3a2b0cd629ec4b4511473aec943273ac460798)
  + tests/image

    - nova/tests/image/abs.tar.gz
      [abs.tar.gz](#diff-36f0cb37540c98217551bf38cc16ff8fc1d6a2dc8bb4101c1e390d3d0f855b36)
    - nova/tests/image/rel.tar.gz
      [rel.tar.gz](#diff-a354cccf0f5a5a685b5e17eaf9d6a500b5569e44484ae9ef7c34b565558548e0)
    - nova/tests/image/test\_s3.py
      [test\_s3.py](#diff-0287cf899944cb22993ccc2ad3198b824d34c7215d3bbc43515af2fe9994701f)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[MANIFEST.in](#diff-41d5a52589e0480be9c099d2bba7a8135b8b0d71bcbb8df3582a8df1c2295003 "MANIFEST.in")

Show comments

[View file](/openstack/nova/blob/ad3241929ea00569c74505ed002208ce360c667e/MANIFEST.in)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,6 +37,7 @@ include nova/tests/bundle/1mb.part.0 |
|  |  | include nova/tests/bundle/1mb.part.1 |
|  |  | include nova/tests/api/ec2/public\_key/\* |
|  |  | include nova/tests/db/nova.austin.sqlite |
|  |  | include nova/tests/image/\*.tar.gz |
|  |  | include plugins/xenapi/README |
|  |  | include plugins/xenapi/etc/xapi.d/plugins/objectstore |
|  |  | include plugins/xenapi/etc/xapi.d/plugins/pluginlib\_nova.py |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[nova/image/s3.py](#diff-8d7b82dbb34648676417f6d4de3a2b0cd629ec4b4511473aec943273ac460798 "nova/image/s3.py")

Show comments

[View file](/openstack/nova/blob/ad3241929ea00569c74505ed002208ce360c667e/nova/image/s3.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -155,7 +155,7 @@ def \_conn(context): |
|  |  | @staticmethod |
|  |  | def \_download\_file(bucket, filename, local\_dir): |
|  |  | key = bucket.get\_key(filename) |
|  |  | local\_filename = os.path.join(local\_dir, filename) |
|  |  | local\_filename = os.path.join(local\_dir, os.path.basename(filename)) |
|  |  | key.get\_contents\_to\_filename(local\_filename) |
|  |  | return local\_filename |
|  |  |  |
| Expand Down  Expand Up | | @@ -387,8 +387,19 @@ def \_decrypt\_image(encrypted\_filename, encrypted\_key, encrypted\_iv, |
|  |  | {'image\_file': encrypted\_filename, |
|  |  | 'err': err}) |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_test\_for\_malicious\_tarball(path, filename): |
|  |  | """Raises exception if extracting tarball would escape extract path""" |
|  |  | tar\_file = tarfile.open(filename, 'r|gz') |
|  |  | for n in tar\_file.getnames(): |
|  |  | if not os.path.abspath(os.path.join(path, n)).startswith(path): |
|  |  | tar\_file.close() |
|  |  | raise exception.Error(\_('Unsafe filenames in image')) |
|  |  | tar\_file.close() |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_untarzip\_image(path, filename): |
|  |  | S3ImageService.\_test\_for\_malicious\_tarball(path, filename) |
|  |  | tar\_file = tarfile.open(filename, 'r|gz') |
|  |  | tar\_file.extractall(path) |
|  |  | image\_file = tar\_file.getnames()[0] |
| Expand Down | |  |

Binary file added
BIN
+153 Bytes

[nova/tests/image/abs.tar.gz](#diff-36f0cb37540c98217551bf38cc16ff8fc1d6a2dc8bb4101c1e390d3d0f855b36 "nova/tests/image/abs.tar.gz")

Show comments

[View file](/openstack/nova/blob/ad3241929ea00569c74505ed002208ce360c667e/nova/tests/image/abs.tar.gz)
Edit file

Delete file

Binary file not shown.

Binary file added
BIN
+165 Bytes

[nova/tests/image/rel.tar.gz](#diff-a354cccf0f5a5a685b5e17eaf9d6a500b5569e44484ae9ef7c34b565558548e0 "nova/tests/image/rel.tar.gz")

Show comments

[View file](/openstack/nova/blob/ad3241929ea00569c74505ed002208ce360c667e/nova/tests/image/rel.tar.gz)
Edit file

Delete file

Binary file not shown.

10 changes: 10 additions & 0 deletions

10
[nova/tests/image/test\_s3.py](#diff-0287cf899944cb22993ccc2ad3198b824d34c7215d3bbc43515af2fe9994701f "nova/tests/image/test_s3.py")

Show comments

[View file](/openstack/nova/blob/ad3241929ea00569c74505ed002208ce360c667e/nova/tests/image/test_s3.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,6 +15,8 @@ |
|  |  | # License for the specific language governing permissions and limitations |
|  |  | # under the License. |
|  |  |  |
|  |  | import os |
|  |  |  |
|  |  | from nova import context |
|  |  | import nova.db.api |
|  |  | from nova import exception |
| Expand Down  Expand Up | | @@ -130,3 +132,11 @@ def test\_s3\_create(self): |
|  |  | {'device\_name': '/dev/sdb0', |
|  |  | 'no\_device': True}] |
|  |  | self.assertEqual(block\_device\_mapping, expected\_bdm) |
|  |  |  |
|  |  | def test\_s3\_malicious\_tarballs(self): |
|  |  | self.assertRaises(exception.Error, |
|  |  | self.image\_service.\_test\_for\_malicious\_tarball, |
|  |  | "/unused", os.path.join(os.path.dirname(\_\_file\_\_), 'abs.tar.gz')) |
|  |  | self.assertRaises(exception.Error, |
|  |  | self.image\_service.\_test\_for\_malicious\_tarball, |
|  |  | "/unused", os.path.join(os.path.dirname(\_\_file\_\_), 'rel.tar.gz')) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ad32419`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenstack%2Fnova%2Fcommit%2Fad3241929ea00569c74505ed002208ce360c667e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugs.launchpad.net_b3972835_20250126_011729.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# Path Traversal possible when downloading an image

Bug #885167 reported by
[David](https://launchpad.net/~d--)
on 2011-11-02

[258](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [Thierry Carrez](https://launchpad.net/~ttx) | [OpenStack Compute (nova) 2012.1 "essex"](https://launchpad.net/nova/%2Bmilestone/2012.1) |
|  | [Diablo](https://bugs.launchpad.net/nova/diablo) | Fix Released | Undecided | Unassigned | [OpenStack Compute (nova) 2011.3.1](https://launchpad.net/nova/%2Bmilestone/2011.3.1) |

### Bug Description

Because of #885165, it maybe possible for a remote attacker who can perform a man in the middle attack to provide a bucket with an image file-name which includes "/" and or "..". The path for the image file which is taken from the desired destination directory joined with the filename found in the bucket. This occurs in the static method \_download\_file. The \_download\_file method, as the name indicates also downloads the image to the respective file path.

The actual downloading of the image occurs via the key.get\_contents\_to\_filename call. The get\_contents\_to\_filename method will open a file at the 'local\_filename' location through the following code( as found in boto/s3/key.py):

def get\_contents\_to\_filename(self, filename, headers=None,

      ...

     fp = open(filename, 'wb')

Which opens a new file object at the location provided. The \_download\_file method should ensure that the file-name is safe to use before calling the get\_contents\_to\_filename method.

[0]

    @staticmethod

    def \_download\_file(bucket, filename, local\_dir):

        key = bucket.get\_key(filename)

        local\_filename = os.path.join(local\_dir, filename)

        key.get\_contents\_to\_filename(local\_filename)

        return local\_filename

See [original description](comments/0)

Tags:

[in-stable-diablo](/nova/%2Bbugs?field.tag=in-stable-diablo)

## CVE References

* [2011-4596](/bugs/cve/2011-4596 "Multiple directory traversal vulnerab...")

[David (d--)](https://launchpad.net/~d--)
on 2011-11-02

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David (d--)](https://launchpad.net/~d--) wrote on 2011-11-02: |  |  | [#1](/nova/%2Bbug/885167/comments/1) |
| --- | --- | --- | --- |

One more possible bug (I don't know if this is reachable) is that the tarfile.extractall method is used in the

 static method \_untarzip\_image. This method is also vulnerable to path traversal (as per the warning in the tarfile module documentation).

One more possible bug (I don't know if this is reachable) is that the tarfile.extractall method is used in the
static method \_untarzip\_image. This method is also vulnerable to path traversal (as per the warning in the tarfile module documentation).

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Robert Clark (robert-clark)](https://launchpad.net/~robert-clark) wrote on 2011-11-14: |  |  | [#2](/nova/%2Bbug/885167/comments/2) |
| --- | --- | --- | --- |

This isn't because of the other bug although the fact that it can be exploited when traffic is in the clear is significant.

It would seem to me that the main issue is that an attacker making this call (either a malicious user or a man-in-the-middle) can perform a path traversal because get\_contents\_to\_filename doesn't validate strings correctly.

This isn't because of the other bug although the fact that it can be exploited when traffic is in the clear is significant.
It would seem to me that the main issue is that an attacker making this call (either a malicious user or a man-in-the-middle) can perform a path traversal because get\_contents\_to\_filename doesn't validate strings correctly.

| Changed in nova: | |
| --- | --- |
| **status**: | New → Confirmed |

[Robert Clark (robert-clark)](https://launchpad.net/~robert-clark)
on 2011-11-14

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Robert Clark (robert-clark) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-14: |  |  | [#3](/nova/%2Bbug/885167/comments/3) |
| --- | --- | --- | --- |

At the very least the filename retrieved from the manifest should be filtered through basename ?

That said I wonder if that code is even used since it contains a typo on line 215 (use of "ec2\_utils") that should be hit with every manifest with a kernel id, and various other strange things (unused image\_id and image\_type fields). Vish ?

David: could you open a separate security bug so that we investigate the tarfile thing separately ?

At the very least the filename retrieved from the manifest should be filtered through basename ?
That said I wonder if that code is even used since it contains a typo on line 215 (use of "ec2\_utils") that should be hit with every manifest with a kernel id, and various other strange things (unused image\_id and image\_type fields). Vish ?
David: could you open a separate security bug so that we investigate the tarfile thing separately ?

| Changed in nova: | |
| --- | --- |
| **assignee**: | Robert Clark (robert-clark) → nobody |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-14: |  |  | [#4](/nova/%2Bbug/885167/comments/4) |
| --- | --- | --- | --- |

Oops, concurrent change

Oops, concurrent change

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Robert Clark (robert-clark) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [David (d--)](https://launchpad.net/~d--) wrote on 2011-11-14: |  |  | [#5](/nova/%2Bbug/885167/comments/5) |
| --- | --- | --- | --- |

Well I don't know if the tarfile bug is reachable. From what I saw the image would need to be signed?

(I can open another issue but I wasn't even sure if this code was actually used ...).

Well I don't know if the tarfile bug is reachable. From what I saw the image would need to be signed?
(I can open another issue but I wasn't even sure if this code was actually used ...).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-11-14:  [**Re: [Bug 885167] Re: Path Traversal possible when downloading an image**](/nova/%2Bbug/885167/comments/6) |  |  | [#6](/nova/%2Bbug/885167/comments/6) |
| --- | --- | --- | --- |

Thierry: The ec2\_utils thing is definitely a bug. Not sure about the image\_id. Checking with waldon

Thierry: The ec2\_utils thing is definitely a bug. Not sure about the image\_id. Checking with waldon

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-17: |  |  | [#7](/nova/%2Bbug/885167/comments/7) |
| --- | --- | --- | --- |

@DavidB: please open a bug about it, just in case, so that we can investigate further.

@Robert: Are you going to propose a change to Gerrit for this ?

@VMT: I suggest VMT Level = Medium, looks like it could be exploited by uploading a crafted manifest

@DavidB: please open a bug about it, just in case, so that we can investigate further.
@Robert: Are you going to propose a change to Gerrit for this ?
@VMT: I suggest VMT Level = Medium, looks like it could be exploited by uploading a crafted manifest

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-25: |  |  | [#8](/nova/%2Bbug/885167/comments/8) |
| --- | --- | --- | --- |

The tarfile bug was filed separately as [bug 894755](/bugs/894755).

The tarfile bug was filed separately as bug 894755.

| Changed in nova: | |
| --- | --- |
| **status**: | Confirmed → Triaged |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Robert Clark (robert-clark)](https://launchpad.net/~robert-clark) wrote on 2011-11-25: |  |  | [#9](/nova/%2Bbug/885167/comments/9) |
| --- | --- | --- | --- |

Vish, Please can you take a look at this.

Thanks

Vish, Please can you take a look at this.
Thanks

| Changed in nova: | |
| --- | --- |
| **assignee**: | Robert Clark (robert-clark) → Vish Ishaya (vishvananda) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-11-28: |  |  | [#10](/nova/%2Bbug/885167/comments/10) |
| --- | --- | --- | --- |

Robert: what specifically do you want me to look at? This is definitely a bug. Were you going to propose a fix?

Robert: what specifically do you want me to look at? This is definitely a bug. Were you going to propose a fix?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-11-29: |  |  | [#11](/nova/%2Bbug/885167/comments/11) |
| --- | --- | --- | --- |

I think Robert is deferring to you for advice on who could do it. If nobody else picks it up, I can propose a fix.

I think Robert is deferring to you for advice on who could do it. If nobody else picks it up, I can propose a fix.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-11-29:  [**Re: [Bug 885167] Path Traversal possible when downloading an image**](/nova/%2Bbug/885167/comments/12) |  |  | [#12](/nova/%2Bbug/885167/comments/12) |
| --- | --- | --- | --- |

I don't have someone specific in mind, but it looks like a pretty simple change.

Vish

On Nov 29, 2011, at 2:54 AM, Thierry Carrez wrote:

> I think Robert is deferring to you for advice on who could do it. If

> nobody else picks it up, I can propose a fix.

>

> --

> You received this bug notification because you are a member of Nova

> Core, which is subscribed to the bug report.

> <https://bugs.launchpad.net/bugs/885167>

>

> Title:

> Path Traversal possible when downloading an image

>

> Status in OpenStack Compute (Nova):

> Triaged

>

> Bug description:

> Because of #885165, it maybe possible for a remote attacker who can perform a man in the middle attack to provide a bucket with an image file-name which includes "/" and or "..". The path for the image file which is taken from the desired destination directory joined with the filename found in the bucket. This occurs in the static method \_download\_file. The \_download\_file method, as the name indicates also downloads the image to the respective file path.

> The actual downloading of the image occurs via the key.get\_contents\_to\_filename call. The get\_contents\_to\_filename method will open a file at the 'local\_filename' location through the following code( as found in boto/s3/key.py):

>

> def get\_contents\_to\_filename(self, filename, headers=None,

> ...

> fp = open(filename, 'wb')

>

>

> Which opens a new file object at the location provided. The \_download\_file method should ensure that the file-name is safe to use before calling the get\_contents\_to\_filename method.

>

>

>

> [0]

> @staticmethod

> def \_download\_file(bucket, filename, local\_dir):

> key = bucket.get\_key(filename)

> local\_filename = os.path.join(local\_dir, filename)

> key.get\_contents\_to\_filename(local\_filename)

> return local\_filename

>

> To manage notifications about this bug go to:

> [https://bugs.launchpad.net/nova/+bug/885167/+subscriptions](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Bsubscriptions)

I don't have someone specific in mind, but it looks like a pretty simple change.
Vish
On Nov 29, 2011, at 2:54 AM, Thierry Carrez wrote:
> I think Robert is deferring to you for advice on who could do it. If
> nobody else picks it up, I can propose a fix.
>
> --
> You received this bug notification because you are a member of Nova
> Core, which is subscribed to the bug report.
> https://bugs.launchpad.net/bugs/885167
>
> Title:
> Path Traversal possible when downloading an image
>
> Status in OpenStack Compute (Nova):
> Triaged
>
> Bug description:
> Because of #885165, it maybe possible for a remote attacker who can perform a man in the middle attack to provide a bucket with an image file-name which includes "/" and or "..". The path for the image file which is taken from the desired destination directory joined with the filename found in the bucket. This occurs in the static method \_download\_file. The \_download\_file method, as the name indicates also downloads the image to the respective file path.
> The actual downloading of the image occurs via the key.get\_contents\_to\_filename call. The get\_contents\_to\_filename method will open a file at the 'local\_filename' location through the following code( as found in boto/s3/key.py):
>
> def get\_contents\_to\_filename(self, filename, headers=None,
> ...
> fp = open(filename, 'wb')
>
>
> Which opens a new file object at the location provided. The \_download\_file method should ensure that the file-name is safe to use before calling the get\_contents\_to\_filename method.
>
>
>
> [0]
> @staticmethod
> def \_download\_file(bucket, filename, local\_dir):
> key = bucket.get\_key(filename)
> local\_filename = os.path.join(local\_dir, filename)
> key.get\_contents\_to\_filename(local\_filename)
> return local\_filename
>
> To manage notifications about this bug go to:
> https://bugs.launchpad.net/nova/+bug/885167/+subscriptions

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-01: |  |  | [#13](/nova/%2Bbug/885167/comments/13) |
| --- | --- | --- | --- |

* [patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2614837/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2614837)
  (513 bytes,
  text/plain)

Proposed fix, nova-core please pre-review before we make it public.

Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

Proposed fix, nova-core please pre-review before we make it public.
Adding stable maintainers. Once this is pre-approved we'll coordinate disclosure.

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-01

| Changed in nova: | |
| --- | --- |
| **assignee**: | Vish Ishaya (vishvananda) → Thierry Carrez (ttx) |
| **status**: | Triaged → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-06: |  |  | [#14](/nova/%2Bbug/885167/comments/14) |
| --- | --- | --- | --- |

Patch lgtm.

Patch lgtm.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-06: |  |  | [#15](/nova/%2Bbug/885167/comments/15) |
| --- | --- | --- | --- |

Proposed advisory (merged with [bug 894755](/bugs/894755)):

Title: Path traversal issues registering malicious images using EC2 API

Impact: High

Announced: ...

Reporter: David Black

Products: Nova

Description:

David Black reported two issues in OpenStack Nova's support for EC2 RegisterImage action. By registering images from malicious tarballs or manifests, an attacker could potentially traverse directories and overwrite files with the rights of the user Nova runs under. Only setups allowing the EC2 API and the S3/RegisterImage method for registering images are affected.

Proposed advisory (merged with bug 894755):
Title: Path traversal issues registering malicious images using EC2 API
Impact: High
Announced: ...
Reporter: David Black
Products: Nova
Description:
David Black reported two issues in OpenStack Nova's support for EC2 RegisterImage action. By registering images from malicious tarballs or manifests, an attacker could potentially traverse directories and overwrite files with the rights of the user Nova runs under. Only setups allowing the EC2 API and the S3/RegisterImage method for registering images are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark McLoughlin (markmc)](https://launchpad.net/~markmc) wrote on 2011-12-06: |  |  | [#16](/nova/%2Bbug/885167/comments/16) |
| --- | --- | --- | --- |

* [Untested patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2621840/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2621840)
  (1.4 KiB,
  text/plain)

Issue looks valid here too - user-uploaded image manifest can't be trusted

The patch is fine, I think. But it might be worth considering an even safer option - use image.part.N as the filename, since we're downloading to a temporary directory we've just created

Issue looks valid here too - user-uploaded image manifest can't be trusted
The patch is fine, I think. But it might be worth considering an even safer option - use image.part.N as the filename, since we're downloading to a temporary directory we've just created

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-06: |  |  | [#17](/nova/%2Bbug/885167/comments/17) |
| --- | --- | --- | --- |

markmc: Your patch is better -- though for security patches the idea is to simplify the fix as much as you can (here you don't just weed out malicious filenames, you also change filenames for non-malicious files, which I suppose is OK, but maybe not).

markmc: Your patch is better -- though for security patches the idea is to simplify the fix as much as you can (here you don't just weed out malicious filenames, you also change filenames for non-malicious files, which I suppose is OK, but maybe not).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Vish Ishaya (vishvananda)](https://launchpad.net/~vishvananda) wrote on 2011-12-07: |  |  | [#18](/nova/%2Bbug/885167/comments/18) |
| --- | --- | --- | --- |

I think marks patch is fine. It is a little bigger, but I do like ignoring the passed in name completely.

I think marks patch is fine. It is a little bigger, but I do like ignoring the passed in name completely.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-08: |  |  | [#19](/nova/%2Bbug/885167/comments/19) |
| --- | --- | --- | --- |

I don't have any particular preference about either approach, but only Thierry's patch comes with unit tests proving that it actually fixes the problem, so that has my vote so far.

I don't have any particular preference about either approach, but only Thierry's patch comes with unit tests proving that it actually fixes the problem, so that has my vote so far.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark McLoughlin (markmc)](https://launchpad.net/~markmc) wrote on 2011-12-08: |  |  | [#20](/nova/%2Bbug/885167/comments/20) |
| --- | --- | --- | --- |

Hmm, I don't see unit tests? Am I missing something? I expect any unit test for this would work with my variant too anyway

I don't mind either way - we can go with the one-liner patch and add my version later

Hmm, I don't see unit tests? Am I missing something? I expect any unit test for this would work with my variant too anyway
I don't mind either way - we can go with the one-liner patch and add my version later

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Soren Hansen (soren)](https://launchpad.net/~soren) wrote on 2011-12-08: |  |  | [#21](/nova/%2Bbug/885167/comments/21) |
| --- | --- | --- | --- |

Mark, sorry, I was confused. I was thinking of Thierry's patch for [bug 894755](/bugs/894755).

I think I prefer ttx's approach for the quick fix, and then we can go with yours from Essex and onwards.

Mark, sorry, I was confused. I was thinking of Thierry's patch for bug 894755.
I think I prefer ttx's approach for the quick fix, and then we can go with yours from Essex and onwards.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-08: |  |  | [#22](/nova/%2Bbug/885167/comments/22) |
| --- | --- | --- | --- |

Notification sent to downstream distros / public users.

Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Notification sent to downstream distros / public users.
Proposed disclosure date set to Tuesday, December 13, 2011, 1500UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-09: |  |  | [#23](/nova/%2Bbug/885167/comments/23) |
| --- | --- | --- | --- |

Assigned CVE-2011-4596

Assigned CVE-2011-4596

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-13

| **visibility**: | private → public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (master)**](/nova/%2Bbug/885167/comments/24) |  |  | [#24](/nova/%2Bbug/885167/comments/24) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2283>

Committed: <http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e>

Submitter: Jenkins

Branch: master

status fixcommitted

 done

commit ad3241929ea00569c74505ed002208ce360c667e

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2283
Committed: http://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e
Submitter: Jenkins
Branch: master
status fixcommitted
done
commit ad3241929ea00569c74505ed002208ce360c667e
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Openstack Gerrit (openstack-gerrit)](https://launchpad.net/~openstack-gerrit) wrote on 2011-12-13:  [**Fix merged to nova (stable/diablo)**](/nova/%2Bbug/885167/comments/25) |  |  | [#25](/nova/%2Bbug/885167/comments/25) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/2284>

Committed: <http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6>

Submitter: James E. Blair (<email address hidden>)

Branch: stable/diablo

tag in-stable-diablo

 done

commit 76363226bd8533256f7795bba358d7f4b8a6c9e6

Author: Thierry Carrez <email address hidden>

Date: Thu Dec 1 17:54:16 2011 +0100

Sanitize EC2 manifests and image tarballs

Prevent potential directory traversal with malicious EC2 image tarballs,

    by making sure the tarfile is safe before unpacking it. Fixes [bug 894755](/bugs/894755)

Prevent potential directory traversal with malicious file names in

    EC2 image manifests. Fixes [bug 885167](/bugs/885167)

(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Reviewed: https://review.openstack.org/2284
Committed: http://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6
Submitter: James E. Blair (corvus@inaugust.com)
Branch: stable/diablo
tag in-stable-diablo
done
commit 76363226bd8533256f7795bba358d7f4b8a6c9e6
Author: Thierry Carrez <thierry@openstack.org>
Date: Thu Dec 1 17:54:16 2011 +0100
Sanitize EC2 manifests and image tarballs
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755
Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167
(cherry picked from commit ad3241929ea00569c74505ed002208ce360c667e)
Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2011-12-13: |  |  | [#26](/nova/%2Bbug/885167/comments/26) |
| --- | --- | --- | --- |

Released as OSSA 2011-001

Released as OSSA 2011-001

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2011-12-14

| Changed in nova: | |
| --- | --- |
| **milestone**: | none → essex-2 |
| **status**: | Fix Committed → Fix Released |

[Thierry Carrez (ttx)](https://launchpad.net/~ttx)
on 2012-04-05

| Changed in nova: | |
| --- | --- |
| **milestone**: | essex-2 → 2012.1 |

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/885167/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2614837/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2614837 "Change patch details")

* [Add patch](/nova/%2Bbug/885167/%2Baddcomment?field.patch=on)

## Bug attachments

* [Untested patch](https://bugs.launchpad.net/nova/%2Bbug/885167/%2Battachment/2621840/%2Bfiles/patch)
  [Edit](/nova/%2Bbug/885167/%2Battachment/2621840 "Change attachment details")

* [Add attachment](/nova/%2Bbug/885167/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from lists.launchpad.net_33408aeb_20250124_131800.html ===

[←
Back to team overview](https://launchpad.net/~openstack)
# openstack team mailing list archive

* [Thread](maillist.html)
* [Date](date.html)

1. ![](https://launchpad.net/@@/team)
   [openstack team](https://launchpad.net/~openstack)
2. [Mailing list archive](maillist.html)
3. Message #06105

## [OSSA 2011-001] Path traversal issues registering malicious images using EC2 API (CVE-2011-4596)

|  | [Thread Previous](msg06104.html) • [Date Previous](msg06104.html) • [Date Next](msg06106.html) • [Thread Next](msg06106.html) |
| --- | --- |

* ****To****:
  "openstack@xxxxxxxxxxxxxxxxxxx" <openstack@xxxxxxxxxxxxxxxxxxx>
* ****From****:
  Thierry Carrez <thierry@xxxxxxxxxxxxx>
* ****Date****:
  Tue, 13 Dec 2011 16:38:40 +0100
* ****Organization****:
  OpenStack
* ****User-agent****:
  Mozilla/5.0 (X11; Linux x86\_64; rv:8.0) Gecko/20111124 Thunderbird/8.0

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

OpenStack Security Advisory: 2011-001
CVE: CVE-2011-4596
Title: Path traversal issues registering malicious images using EC2 API
Date: December 13, 2011
Impact: High
Reporter: David Black
Products: Nova
Affects: All versions

Description:
David Black reported two issues in OpenStack Nova's support for EC2
RegisterImage action. By registering images from malicious tarballs or
manifests, an attacker could potentially traverse directories and
overwrite files with the rights of the user Nova runs under. Only setups
allowing the EC2 API and the S3/RegisterImage method for registering
images are affected.

Fixes:
Essex:
<https://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e>
2011.3:
<https://github.com/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6>

References:
<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-4596>
[https://bugs.launchpad.net/nova/+bug/885167](https://bugs.launchpad.net/nova/%2Bbug/885167)
[https://bugs.launchpad.net/nova/+bug/894755](https://bugs.launchpad.net/nova/%2Bbug/894755)

Notes:
This fix will be included in the Essex-2 development milestone and in
a future 2011.3.1 release.

- --
Thierry Carrez (ttx)
OpenStack Vulnerability Management Team
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.11 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <http://enigmail.mozdev.org/>

iQIcBAEBCAAGBQJO53F7AAoJEFB6+JAlsQQjOrgQAJ6m1J0eBZbZt+2v76jQmXqz
HBaSmvtMpI3G+dIqnIzb3S7YKYVLTJgYo1dVmDw2+31vGwqhb+THBExlXeMOG4Gd
qEafKTeATvZD/OkMzBCqmbAXMB6sDxnvOCNxTssW8YjRCCn3/yUxPpjITz3QJWcK
ThI+4KyHfQB2S40Z9aSBCRtnC9HDJYzQwskA20YBuOqMMybpXhMYYPUD3w/AxbOU
pXpQbwuRbilfeFMNHjBZyWvnHH8jE2yGtT7FHX9CXVRDf/Exqc5B+1b1p0YCdha9
x+v+C339pIdB9/Qfhd+QRg3rKNMs+bYYwyM3vBUaYRTagvztU34Ou/rnGcyW+MWe
CroBatxbNgOpaKrAV39by+z+pVUVjIKO4npj9foxw/esbh5ISszVr9B0xDeNYNvf
EWTddpA4ksXdLLaBDqJLzv2KaDpoquZu1lmgMPoWPuv7PdYGrDYWklRuFDPO0IFg
LIBDtdjIEDU9eUoYpDQv1XcoGKf25Kr4xOOm0BEaWkjC1xYT5VbIh/dGJBq+kZcP
9ipawSM1uIlvIrQsLutZuHKGoLUxRJzIQhGutw+BRRKl6mqvVFkMibi09qqc0sTR
Wa+Si9/ldhaugHBUvyDRQZoPLrTxVHOvSwLtFRygulTqz5SQR17rpZ1nftz5nKVf
PBCrs5rx0hb9BcgMyPGS
=2SQs
-----END PGP SIGNATURE-----

```

---

|  | [Thread Previous](msg06104.html) • [Date Previous](msg06104.html) • [Date Next](msg06106.html) • [Thread Next](msg06106.html) |
| --- | --- |

[![Launchpad](https://launchpad.net/@@/launchpad-logo-and-name-hierarchy.png)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)
 •
[Help for mailing lists](https://help.launchpad.net/Teams/MailingLists)

© 2004-2011
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Contact Launchpad Support](/support)
 •
[System status](http://identi.ca/launchpadstatus)



=== Content from github.com_ac34b1bc_20250126_011730.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenstack%2Fnova%2Fcommit%2F76363226bd8533256f7795bba358d7f4b8a6c9e6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenstack%2Fnova%2Fcommit%2F76363226bd8533256f7795bba358d7f4b8a6c9e6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=openstack%2Fnova)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openstack](/openstack)
/
**[nova](/openstack/nova)**
Public

* [Notifications](/login?return_to=%2Fopenstack%2Fnova) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fopenstack%2Fnova)
* [Star
   3.1k](/login?return_to=%2Fopenstack%2Fnova)

* [Code](/openstack/nova)
* [Pull requests
  0](/openstack/nova/pulls)
* [Actions](/openstack/nova/actions)
* [Security](/openstack/nova/security)
* [Insights](/openstack/nova/pulse)

Additional navigation options

* [Code](/openstack/nova)
* [Pull requests](/openstack/nova/pulls)
* [Actions](/openstack/nova/actions)
* [Security](/openstack/nova/security)
* [Insights](/openstack/nova/pulse)

## Commit

[Permalink](/openstack/nova/commit/76363226bd8533256f7795bba358d7f4b8a6c9e6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Sanitize EC2 manifests and image tarballs

[Browse files](/openstack/nova/tree/76363226bd8533256f7795bba358d7f4b8a6c9e6)
Browse the repository at this point in the history

```
Prevent potential directory traversal with malicious EC2 image tarballs,
by making sure the tarfile is safe before unpacking it. Fixes bug 894755

Prevent potential directory traversal with malicious file names in
EC2 image manifests. Fixes bug 885167

(cherry picked from commit [ad32419](https://github.com/openstack/nova/commit/ad3241929ea00569c74505ed002208ce360c667e))

Change-Id: If6109047307bd6e654ee9d1254f0d7f31cf741c1
```

* Loading branch information

[![@ttx](https://avatars.githubusercontent.com/u/712511?s=40&v=4)](/ttx) [![@markmc](https://avatars.githubusercontent.com/u/15288?s=40&v=4)](/markmc)

[ttx](/openstack/nova/commits?author=ttx "View all commits by ttx")
authored and
[markmc](/openstack/nova/commits?author=markmc "View all commits by markmc")
committed
Dec 13, 2011

1 parent
[8992773](/openstack/nova/commit/899277303450d1d96dd835e80c0a076ad5e89c18)

commit 7636322

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**23 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* MANIFEST.in
  [MANIFEST.in](#diff-41d5a52589e0480be9c099d2bba7a8135b8b0d71bcbb8df3582a8df1c2295003)
* nova

  + image

    - nova/image/s3.py
      [s3.py](#diff-8d7b82dbb34648676417f6d4de3a2b0cd629ec4b4511473aec943273ac460798)
  + tests/image

    - nova/tests/image/abs.tar.gz
      [abs.tar.gz](#diff-36f0cb37540c98217551bf38cc16ff8fc1d6a2dc8bb4101c1e390d3d0f855b36)
    - nova/tests/image/rel.tar.gz
      [rel.tar.gz](#diff-a354cccf0f5a5a685b5e17eaf9d6a500b5569e44484ae9ef7c34b565558548e0)
    - nova/tests/image/test\_s3.py
      [test\_s3.py](#diff-0287cf899944cb22993ccc2ad3198b824d34c7215d3bbc43515af2fe9994701f)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[MANIFEST.in](#diff-41d5a52589e0480be9c099d2bba7a8135b8b0d71bcbb8df3582a8df1c2295003 "MANIFEST.in")

Show comments

[View file](/openstack/nova/blob/76363226bd8533256f7795bba358d7f4b8a6c9e6/MANIFEST.in)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -39,6 +39,7 @@ include nova/tests/bundle/1mb.part.0 |
|  |  | include nova/tests/bundle/1mb.part.1 |
|  |  | include nova/tests/public\_key/\* |
|  |  | include nova/tests/db/nova.austin.sqlite |
|  |  | include nova/tests/image/\*.tar.gz |
|  |  | include plugins/xenapi/README |
|  |  | include plugins/xenapi/etc/xapi.d/plugins/objectstore |
|  |  | include plugins/xenapi/etc/xapi.d/plugins/pluginlib\_nova.py |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[nova/image/s3.py](#diff-8d7b82dbb34648676417f6d4de3a2b0cd629ec4b4511473aec943273ac460798 "nova/image/s3.py")

Show comments

[View file](/openstack/nova/blob/76363226bd8533256f7795bba358d7f4b8a6c9e6/nova/image/s3.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -100,7 +100,7 @@ def \_conn(context): |
|  |  | @staticmethod |
|  |  | def \_download\_file(bucket, filename, local\_dir): |
|  |  | key = bucket.get\_key(filename) |
|  |  | local\_filename = os.path.join(local\_dir, filename) |
|  |  | local\_filename = os.path.join(local\_dir, os.path.basename(filename)) |
|  |  | key.get\_contents\_to\_filename(local\_filename) |
|  |  | return local\_filename |
|  |  |  |
| Expand Down  Expand Up | | @@ -315,8 +315,19 @@ def \_decrypt\_image(encrypted\_filename, encrypted\_key, encrypted\_iv, |
|  |  | {'image\_file': encrypted\_filename, |
|  |  | 'err': err}) |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_test\_for\_malicious\_tarball(path, filename): |
|  |  | """Raises exception if extracting tarball would escape extract path""" |
|  |  | tar\_file = tarfile.open(filename, 'r|gz') |
|  |  | for n in tar\_file.getnames(): |
|  |  | if not os.path.abspath(os.path.join(path, n)).startswith(path): |
|  |  | tar\_file.close() |
|  |  | raise exception.Error(\_('Unsafe filenames in image')) |
|  |  | tar\_file.close() |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_untarzip\_image(path, filename): |
|  |  | S3ImageService.\_test\_for\_malicious\_tarball(path, filename) |
|  |  | tar\_file = tarfile.open(filename, 'r|gz') |
|  |  | tar\_file.extractall(path) |
|  |  | image\_file = tar\_file.getnames()[0] |
| Expand Down | |  |

Binary file added
BIN
+153 Bytes

[nova/tests/image/abs.tar.gz](#diff-36f0cb37540c98217551bf38cc16ff8fc1d6a2dc8bb4101c1e390d3d0f855b36 "nova/tests/image/abs.tar.gz")

Show comments

[View file](/openstack/nova/blob/76363226bd8533256f7795bba358d7f4b8a6c9e6/nova/tests/image/abs.tar.gz)
Edit file

Delete file

Binary file not shown.

Binary file added
BIN
+165 Bytes

[nova/tests/image/rel.tar.gz](#diff-a354cccf0f5a5a685b5e17eaf9d6a500b5569e44484ae9ef7c34b565558548e0 "nova/tests/image/rel.tar.gz")

Show comments

[View file](/openstack/nova/blob/76363226bd8533256f7795bba358d7f4b8a6c9e6/nova/tests/image/rel.tar.gz)
Edit file

Delete file

Binary file not shown.

10 changes: 10 additions & 0 deletions

10
[nova/tests/image/test\_s3.py](#diff-0287cf899944cb22993ccc2ad3198b824d34c7215d3bbc43515af2fe9994701f "nova/tests/image/test_s3.py")

Show comments

[View file](/openstack/nova/blob/76363226bd8533256f7795bba358d7f4b8a6c9e6/nova/tests/image/test_s3.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,6 +15,8 @@ |
|  |  | # License for the specific language governing permissions and limitations |
|  |  | # under the License. |
|  |  |  |
|  |  | import os |
|  |  |  |
|  |  | from nova import context |
|  |  | from nova import test |
|  |  | from nova.image import s3 |
| Expand Down  Expand Up | | @@ -112,3 +114,11 @@ def test\_s3\_create(self): |
|  |  | {'device\_name': '/dev/sdb0', |
|  |  | 'no\_device': True}] |
|  |  | self.assertEqual(block\_device\_mapping, expected\_bdm) |
|  |  |  |
|  |  | def test\_s3\_malicious\_tarballs(self): |
|  |  | self.assertRaises(exception.Error, |
|  |  | self.image\_service.\_test\_for\_malicious\_tarball, |
|  |  | "/unused", os.path.join(os.path.dirname(\_\_file\_\_), 'abs.tar.gz')) |
|  |  | self.assertRaises(exception.Error, |
|  |  | self.image\_service.\_test\_for\_malicious\_tarball, |
|  |  | "/unused", os.path.join(os.path.dirname(\_\_file\_\_), 'rel.tar.gz')) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7636322`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenstack%2Fnova%2Fcommit%2F76363226bd8533256f7795bba358d7f4b8a6c9e6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from launchpad.net_8e309b4f_20250126_011728.html ===

[Log in / Register](https://launchpad.net/~openstack/%2Blogin)

[![](https://launchpadlibrarian.net/52313053/os64.png)](https://launchpad.net/~openstack)

## [“OpenStack Team” team](https://launchpad.net/~openstack)

* Overview
* [Code](https://code.launchpad.net/~openstack)
* [Bugs](https://bugs.launchpad.net/~openstack)
* [Blueprints](https://blueprints.launchpad.net/~openstack)
* [Translations](https://translations.launchpad.net/~openstack)
* [Answers](https://answers.launchpad.net/~openstack)

------------------------------------------------

OLD TEAM - NOT USED ANYMORE

------------------------------------------------

INTERESTED IN OPENSTACK PLEASE GO TO <http://openstack.org/start>

MAILING LIST: <http://lists.openstack.org/cgi-bin/mailman/listinfo/openstack>

- searchable archives for the mailing list are on <http://openstack.markmail.org/>

* [Related packages](https://launchpad.net/~openstack/%2Brelated-packages)
* [Related projects](https://launchpad.net/~openstack/%2Brelated-projects)

## Team details

Email:
[Log in](%2Blogin) for email information.

Owner:
[OpenStack Administrators](/~openstack-admins)

Created on:
2010-07-22

Languages:
English

Membership policy:
Delegated Team

## [All members](https://launchpad.net/~openstack/%2Bmembers)

**7582**
[active
members](/~openstack/%2Bmembers#active),
**1**
[invited
member](/~openstack/%2Bmembers#invited),
**344**
[proposed
members](/~openstack/%2Bmembers#proposed)

You must [log in](%2Blogin)
to join or leave this team.

* [Show member photos](https://launchpad.net/~openstack/%2Bmugshots)

| Latest members  * [Augustina Ragwitz](/~auggy) * [chengsheng](/~chengsheng) * [Liang Wang](/~hiliang) * [GM](/~mazmanoglu) * [Ta Ba Tuan](/~tuantaba) | Pending approval  * [Johnfrandes s](/~johnfrandes12) * [Shanjiayi](/~odeshen520) * [HelaBasa Group (shared)](/~nawala) * [Yukti Sharma](/~s-yukti) * [Mark Rosenbaum](/~markrosenbaum) |
| --- | --- |

### Latest invited

* [healthnmon-core](/~healthnmon-core)

* [View snap packages](https://launchpad.net/~openstack/%2Bsnaps)

## Mailing list

![mail](/@@/mail)
openstack@lists.launchpad.net

**Policy:**
You must be a team member to subscribe to the team mailing list.

![email](/@@/mail)
[View public archive](https://lists.launchpad.net/openstack)

![team](/@@/team) [View subscribers](/~openstack/%2Bmailing-list-subscribers)

## [Show related projects](%2Bprojects) Related projects

Public team

* [Join the team](https://launchpad.net/~openstack/%2Bjoin)
* [Add one of my teams](https://launchpad.net/~openstack/%2Badd-my-teams)

## Polls

No current polls.

[Show polls](https://launchpad.net/~openstack/%2Bpolls)

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))


