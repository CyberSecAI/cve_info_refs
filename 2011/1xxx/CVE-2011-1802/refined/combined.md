=== Content from trac.webkit.org_6952467b_20250125_180721.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/86357/webkit "Changeset 86357")
* [Next Changeset](/changeset/86359/webkit "Changeset 86359") →

---

# Changeset 86358 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
May 12, 2011, 10:56:30 AM
([14 years](/timeline?from=2011-05-12T10%3A56%3A30-07%3A00&precision=second "See timeline at May 12, 2011, 10:56:30 AM") ago)
Author:
inferno@chromium.org
Message:

2011-05-12 Carol Szabo <​carol@webkit.org>

> Reviewed by David Hyatt.

> Fix reparenting and destruction of counter nodes.
>
> [​https://bugs.webkit.org/show\_bug.cgi?id=57929](https://bugs.webkit.org/show_bug.cgi?id=57929)

> Fixed several issues related to not met assertions.
>
> See below in the per file description.

> Test: fast/css/counters/element-removal-crash.xhtml

* dom/ContainerNode.cpp:
  (WebCore::ContainerNode::removeChildren):
  Fixed the fact that Node::detach() used to be called
  while the DOM tree was in an inconsistent state.
* rendering/RenderCounter.cpp:
  (WebCore::RenderCounter::rendererRemovedFromTree):
  Introduced this function to remove counters from
  descendents of renderers removed from the renderer
  tree not only from the removed renderers themselves.
* rendering/RenderCounter.h:
* rendering/RenderObjectChildList.cpp:
  (WebCore::RenderObjectChildList::removeChildNode):
  Changed to call RenderCounter::rendererRemovedFromTree
  instead of RenderCounter::destroyCounters.

2011-05-08 Abhishek Arya <​inferno@chromium.org> and Carol Szabo <​carol@webkit.org>

> Reviewed by David Hyatt.

> Fix reparenting and destruction of counter nodes.
>
> [​https://bugs.webkit.org/show\_bug.cgi?id=57929](https://bugs.webkit.org/show_bug.cgi?id=57929)

* fast/css/counters/element-removal-crash-expected.txt: Added.
* fast/css/counters/element-removal-crash.xhtml: Added.

Location:
[trunk](/browser/webkit/trunk?rev=86358)
Files:

2 added
6 edited

* [LayoutTests/ChangeLog](/browser/webkit/trunk/LayoutTests/ChangeLog?rev=86358 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [LayoutTests/fast/css/counters/element-removal-crash-expected.txt](/browser/webkit/trunk/LayoutTests/fast/css/counters/element-removal-crash-expected.txt?rev=86358 "Show entry in browser")
  (added)
* [LayoutTests/fast/css/counters/element-removal-crash.xhtml](/browser/webkit/trunk/LayoutTests/fast/css/counters/element-removal-crash.xhtml?rev=86358 "Show entry in browser")
  (added)
* [Source/WebCore/ChangeLog](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=86358 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [Source/WebCore/dom/ContainerNode.cpp](/browser/webkit/trunk/Source/WebCore/dom/ContainerNode.cpp?rev=86358 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [Source/WebCore/rendering/RenderCounter.cpp](/browser/webkit/trunk/Source/WebCore/rendering/RenderCounter.cpp?rev=86358 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [Source/WebCore/rendering/RenderCounter.h](/browser/webkit/trunk/Source/WebCore/rendering/RenderCounter.h?rev=86358 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [Source/WebCore/rendering/RenderObjectChildList.cpp](/browser/webkit/trunk/Source/WebCore/rendering/RenderObjectChildList.cpp?rev=86358 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/LayoutTests/ChangeLog](/changeset/86358/webkit/trunk/LayoutTests/ChangeLog "Show the changeset 86358 restricted to trunk/LayoutTests/ChangeLog")

  | [r86357](/browser/webkit/trunk/LayoutTests/ChangeLog?rev=86357#L1 "Show revision 86357 of this file in browser") | [r86358](/browser/webkit/trunk/LayoutTests/ChangeLog?rev=86358#L1 "Show revision 86358 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2011-05-08 Abhishek Arya <inferno@chromium.org> and Carol Szabo  <carol@webkit.org> |
  |  | 2 |  |
  |  | 3 | Reviewed by David Hyatt. |
  |  | 4 |  |
  |  | 5 | Fix reparenting and destruction of counter nodes. |
  |  | 6 | https://bugs.webkit.org/show\_bug.cgi?id=57929 |
  |  | 7 |  |
  |  | 8 | \* fast/css/counters/element-removal-crash-expected.txt: Added. |
  |  | 9 | \* fast/css/counters/element-removal-crash.xhtml: Added. |
  |  | 10 |  |
  | 1 | 11 | 2011-05-12  Chang Shu  <cshu@webkit.org> |
  | 2 | 12 |  |
* ## [trunk/Source/WebCore/ChangeLog](/changeset/86358/webkit/trunk/Source/WebCore/ChangeLog "Show the changeset 86358 restricted to trunk/Source/WebCore/ChangeLog")

  | [r86355](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=86355#L1 "Show revision 86355 of this file in browser") | [r86358](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=86358#L1 "Show revision 86358 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2011-05-12  Carol Szabo  <carol@webkit.org> |
  |  | 2 |  |
  |  | 3 | Reviewed by David Hyatt. |
  |  | 4 |  |
  |  | 5 | Fix reparenting and destruction of counter nodes. |
  |  | 6 | https://bugs.webkit.org/show\_bug.cgi?id=57929 |
  |  | 7 |  |
  |  | 8 | Fixed several issues related to not met assertions. |
  |  | 9 | See below in the per file description. |
  |  | 10 |  |
  |  | 11 | Test: fast/css/counters/element-removal-crash.xhtml |
  |  | 12 |  |
  |  | 13 | \* dom/ContainerNode.cpp: |
  |  | 14 | (WebCore::ContainerNode::removeChildren): |
  |  | 15 | Fixed the fact that Node::detach() used to be called |
  |  | 16 | while the DOM tree was in an inconsistent state. |
  |  | 17 | \* rendering/RenderCounter.cpp: |
  |  | 18 | (WebCore::RenderCounter::rendererRemovedFromTree): |
  |  | 19 | Introduced this function to remove counters from |
  |  | 20 | descendents of renderers removed from the renderer |
  |  | 21 | tree not only from the removed renderers themselves. |
  |  | 22 | \* rendering/RenderCounter.h: |
  |  | 23 | \* rendering/RenderObjectChildList.cpp: |
  |  | 24 | (WebCore::RenderObjectChildList::removeChildNode): |
  |  | 25 | Changed to call RenderCounter::rendererRemovedFromTree |
  |  | 26 | instead of RenderCounter::destroyCounters. |
  |  | 27 |  |
  | 1 | 28 | 2011-05-12  Luke Macpherson   <macpherson@chromium.org> |
  | 2 | 29 |  |
* ## [trunk/Source/WebCore/dom/ContainerNode.cpp](/changeset/86358/webkit/trunk/Source/WebCore/dom/ContainerNode.cpp "Show the changeset 86358 restricted to trunk/Source/WebCore/dom/ContainerNode.cpp")

  | [r86248](/browser/webkit/trunk/Source/WebCore/dom/ContainerNode.cpp?rev=86248#L552 "Show revision 86248 of this file in browser") | [r86358](/browser/webkit/trunk/Source/WebCore/dom/ContainerNode.cpp?rev=86358#L552 "Show revision 86358 of this file in browser") |  |
  | --- | --- | --- |
  | 552 | 552 | if (n == m\_lastChild) |
  | 553 | 553 | m\_lastChild = 0; |
  | 554 |  |  |
  | 555 |  | ~~if (n->attached())~~ |
  | 556 |  | ~~n->detach();~~ |
  | 557 |  |  |
  | 558 | 554 | removedChildren.append(n.release()); |
  | 559 | 555 | } |
  |  | 556 |  |
  |  | 557 | size\_t removedChildrenCount = removedChildren.size(); |
  |  | 558 | size\_t i; |
  |  | 559 |  |
  |  | 560 | // Detach the nodes only after properly removed from the tree because |
  |  | 561 | // a. detaching requires a proper DOM tree (for counters and quotes for |
  |  | 562 | // example) and during the previous loop the next sibling still points to |
  |  | 563 | // the node being removed while the node being removed does not point back |
  |  | 564 | // and does not point to the same parent as its next sibling. |
  |  | 565 | // b. destroying Renderers of standalone nodes is sometimes faster. |
  |  | 566 | for (i = 0; i < removedChildrenCount; ++i) { |
  |  | 567 | Node\* removedChild = removedChildren[i].get(); |
  |  | 568 | if (removedChild->attached()) |
  |  | 569 | removedChild->detach(); |
  |  | 570 | } |
  |  | 571 |  |
  | 560 | 572 | allowEventDispatch(); |
  | 561 |  |  |
  | 562 |  | ~~size\_t removedChildrenCount = removedChildren.size();~~ |
  | 563 | 573 |  |
  | 564 | 574 | // Dispatch a single post-removal mutation event denoting a modified subtree. |
  | […](/browser/webkit/trunk/Source/WebCore/dom/ContainerNode.cpp?rev=86248#L566) | […](/browser/webkit/trunk/Source/WebCore/dom/ContainerNode.cpp?rev=86358#L576) |  |
  | 566 | 576 | dispatchSubtreeModifiedEvent(); |
  | 567 | 577 |  |
  | 568 |  | for (~~size\_t~~ i = 0; i < removedChildrenCount; ++i) { |
  |  | 578 | for (i = 0; i < removedChildrenCount; ++i) { |
  | 569 | 579 | Node\* removedChild = removedChildren[i].get(); |
  | 570 | 580 | if (removedChild->inDocument()) |
* ## [trunk/Source/WebCore/rendering/RenderCounter.cpp](/changeset/86358/webkit/trunk/Source/WebCore/rendering/RenderCounter.cpp "Show the changeset 86358 restricted to trunk/Source/WebCore/rendering/RenderCounter.cpp")

  | [r81844](/browser/webkit/trunk/Source/WebCore/rendering/RenderCounter.cpp?rev=81844#L576 "Show revision 81844 of this file in browser") | [r86358](/browser/webkit/trunk/Source/WebCore/rendering/RenderCounter.cpp?rev=86358#L576 "Show revision 86358 of this file in browser") |  |
  | --- | --- | --- |
  | 576 | 576 | } |
  | 577 | 577 |  |
  |  | 578 | void RenderCounter::rendererRemovedFromTree(RenderObject\* removedRenderer) |
  |  | 579 | { |
  |  | 580 | RenderObject\* currentRenderer = removedRenderer->lastLeafChild(); |
  |  | 581 | if (!currentRenderer) |
  |  | 582 | currentRenderer = removedRenderer; |
  |  | 583 | while (true) { |
  |  | 584 | destroyCounterNodes(currentRenderer); |
  |  | 585 | if (currentRenderer == removedRenderer) |
  |  | 586 | break; |
  |  | 587 | currentRenderer = currentRenderer->previousInPreOrder(); |
  |  | 588 | } |
  |  | 589 | } |
  |  | 590 |  |
  | 578 | 591 | static void updateCounters(RenderObject\* renderer) |
  | 579 | 592 | { |
* ## [trunk/Source/WebCore/rendering/RenderCounter.h](/changeset/86358/webkit/trunk/Source/WebCore/rendering/RenderCounter.h "Show the changeset 86358 restricted to trunk/Source/WebCore/rendering/RenderCounter.h")

  | [r81724](/browser/webkit/trunk/Source/WebCore/rendering/RenderCounter.h?rev=81724#L38 "Show revision 81724 of this file in browser") | [r86358](/browser/webkit/trunk/Source/WebCore/rendering/RenderCounter.h?rev=86358#L38 "Show revision 86358 of this file in browser") |  |
  | --- | --- | --- |
  | 38 | 38 | static void destroyCounterNode(RenderObject\*, const AtomicString& identifier); |
  | 39 | 39 | static void rendererSubtreeAttached(RenderObject\*); |
  |  | 40 | static void rendererRemovedFromTree(RenderObject\*); |
  | 40 | 41 | static void rendererStyleChanged(RenderObject\*, const RenderStyle\* oldStyle, const RenderStyle\* newStyle); |
  | 41 | 42 |  |
* ## [trunk/Source/WebCore/rendering/RenderObjectChildList.cpp](/changeset/86358/webkit/trunk/Source/WebCore/rendering/RenderObjectChildList.cpp "Show the changeset 86358 restricted to trunk/Source/WebCore/rendering/RenderObjectChildList.cpp")

  | [r85864](/browser/webkit/trunk/Source/WebCore/rendering/RenderObjectChildList.cpp?rev=85864#L130 "Show revision 85864 of this file in browser") | [r86358](/browser/webkit/trunk/Source/WebCore/rendering/RenderObjectChildList.cpp?rev=86358#L130 "Show revision 86358 of this file in browser") |  |
  | --- | --- | --- |
  | 130 | 130 | oldChild->setParent(0); |
  | 131 | 131 |  |
  | 132 |  | if (oldChild->m\_hasCounterNodeMap) |
  | 133 |  | RenderCounter::destroyCounterNodes(oldChild); |
  |  | 132 | RenderCounter::rendererRemovedFromTree(oldChild); |
  | 134 | 133 | RenderQuote::rendererRemovedFromTree(oldChild); |
  | 135 | 134 |  |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=86358)
* [Zip Archive](?format=zip&new=86358)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from bugs.chromium.org_395cffa9_20250125_180722.html ===


