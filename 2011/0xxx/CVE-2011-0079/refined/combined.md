=== Content from bugzilla.mozilla.org_0b027914_20250125_051021.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/601102)
* [XML](/show_bug.cgi?ctype=xml&id=601102)

Closed
[Bug 601102](/show_bug.cgi?id=601102)

Opened 14 years ago
Closed 14 years ago

# Crash in exn\_trace [@ js::Shape::trace(JSTracer\*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash in exn\_trace [@ js::Shape::trace(JSTracer\*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |
| status1.9.1 | --- | [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| status1.9.1 |  | unaffected |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: scoobidiver, Assigned: luke)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](extensions/Gravatar/web/default.jpg)  [luke](/user_profile?user_id=347312)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/43a258096978fdc5ca10d5b423b0c178?d=mm&size=40)  [scoobidiver](/user_profile?user_id=386758)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

14 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[653081](/show_bug.cgi?id=653081 "RESOLVED WORKSFORME - [meta] Crash [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ]")

Dependency [tree](/showdependencytree.cgi?id=601102&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=601102)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: crash, regression, topcrash, Whiteboard: [sg:critical?][fx4-rc-ridealong])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[crash](/buglist.cgi?keywords=crash&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[topcrash](/buglist.cgi?keywords=topcrash&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical?][fx4-rc-ridealong]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ js::Shape::trace(JSTracer\*) ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3AShape%3A%3Atrace%28JSTracer%2A%29)

[[@ js::Shape::trace ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3AShape%3A%3Atrace)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [patch](/attachment.cgi?id=521956)  [14 years ago](#c17)  [Luke Wagner [:luke]](/user_profile?user_id=347312)   1.61 KB, patch | gal : [review+](#c21 "14 years ago")  dveditz : [approval2.0+](#c28 "14 years ago") | [Details](/attachment.cgi?id=521956&action=edit) | [Diff](/attachment.cgi?id=521956&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=601102&attachment=521956) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=601102#c0)• 14 years ago |
|  | |

Build : Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0b7pre) Gecko/20100930 Firefox/4.0b7pre
This is a new crash signature that was introduced by b7pre/20100929 build.
It happens only under Windows XP.
It is #20 top crasher for b7pre/20100930 build.
Signature js::Shape::trace(JSTracer\*)
UUID 61d6d1b5-c6bf-4cff-be12-4c65d2100930
Time 2010-09-30 22:43:46.779302
Uptime 30
Last Crash 36 seconds before submission
Install Age 52464 seconds (14.6 hours) since version was first installed.
Product Firefox
Version 4.0b7pre
Build ID 20100930041305
Branch 2.0
OS Windows NT
OS Version 5.1.2600 Service Pack 2
CPU x86
CPU Info GenuineIntel family 15 model 6 stepping 4
Crash Reason EXCEPTION\_ACCESS\_VIOLATION\_WRITE
Crash Address 0x1e
App Notes AdapterVendorID: 8086, AdapterDeviceID: 29c2
Frame Module Signature [Expand] Source
0 mozjs.dll js::Shape::trace js/src/jsscope.cpp:1358
1 mozjs.dll fun\_trace js/src/jsfun.cpp:2075
2 mozjs.dll js\_TraceObject js/src/jsobj.cpp:6168
3 mozjs.dll js::gc::MarkChildren js/src/jsgcinlines.h:199
4 mozjs.dll js::gc::MarkObject js/src/jsgcinlines.h:179
5 mozjs.dll fun\_trace js/src/jsfun.cpp:2060
6 mozjs.dll js\_TraceObject js/src/jsobj.cpp:6168
The regression range is :
<http://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=c257bfb8cad0&tochange=a60414d076b5>
More reports at :
[http://crash-stats.mozilla.com/report/list?product=Firefox&query\_search=signature&query\_type=exact&query=&range\_value=4&range\_unit=weeks&hang\_type=any&process\_type=any&plugin\_field=&plugin\_query\_type=&plugin\_query=&do\_query=1&admin=&signature=js%3A%3AShape%3A%3Atrace%28JSTracer\*%29](http://crash-stats.mozilla.com/report/list?product=Firefox&query_search=signature&query_type=exact&query=&range_value=4&range_unit=weeks&hang_type=any&process_type=any&plugin_field=&plugin_query_type=&plugin_query=&do_query=1&admin=&signature=js%3A%3AShape%3A%3Atrace%28JSTracer*%29)

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=601102#c1)• 14 years ago |
|  | |

It is #23 top crasher on 4.0b8pre for the last 3 days.blocking2.0: --- → ?

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a6343141_180188)• 14 years ago |

blocking2.0: ? → -
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=601102#c2)• 14 years ago |
|  | |

It is #12 top crasher in 4.0b8 for the last week.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=601102#c3)• 14 years ago |
|  | |

It is #21 top crasher in 4.0b11.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=601102#c4)• 14 years ago |
|  | |

It is #11 top crasher in 4.0b12.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=601102#c5)• 14 years ago |
|  | |

Here are some comments:
"playing universal war( 3 tabs required ) and blood wars"
"i don't know. i have closed the monitor and went to sleep. this morning found the crash report window."
"Escrevendo um e-mail no gmail.com"Keywords: [topcrash](/buglist.cgi?keywords=topcrash&resolution=---)Summary: crash on Windows XP [@ js::Shape::trace(JSTracer\*) ] → Crash [@ js::Shape::trace(JSTracer\*) ]

|  | [Sheila Mooney](/user_profile?user_id=395208) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=601102#c6)• 14 years ago |
|  | |

Interesting that this signature seems to have climbed in early FF4 returns. It has been the #2 browser crash for the past couple of days. We will watch this one and see what happens as the # of users climb.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=601102#c7)• 14 years ago |
|  | |

This spiked very significantly on FF4 release day (yesterday), together with [bug 615098](/show_bug.cgi?id=615098 "RESOLVED WORKSFORME - crash [@ js::gc::MarkId ] with TestPilot (Mac, Windows) or Firebug or AdBlock plus (Mac) or Kikin (Windows)") and [bug 643746](/show_bug.cgi?id=643746 "RESOLVED FIXED - Firefox 4.0 Crash Report [@ JSObject::shrinkSlots(JSContext*, unsigned int) ] mainly with TestPilot 1.1 and below") (all three are in JS and started spiking on 4.0\* the day before, so at least the spike cause might be related), which together account for 2800 crashes in a million 4.0\* ADU on that day or about 7.4% of all 4.0\* crashes on that day, all three are in the top ten top crashers for 4.0\* for this day.

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=601102#c8)• 14 years ago |
|  | |

93% of these crashes have testpilot installed, while the average is at 32%, not sure if this correlation is coincidence or not.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a15035947_386758)• 14 years ago |

Summary: Crash [@ js::Shape::trace(JSTracer\*) ] → Crash [@ js::Shape::trace(JSTracer\*) ] mainly with TestPilot 1.1 and below

|  | [Michael Kraft [:morac]](/user_profile?user_id=142910) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=601102#c9)• 14 years ago |
|  | |

I just got hit by this today when clicking check boxes on a survey page.
Isn't Test Pilot installed in Firefox 4 by default so wouldn't most people have Test Pilot installed after upgrading to Firefox 4?

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=601102#c10)• 14 years ago |
|  | |

(In reply to [comment #9](/show_bug.cgi?id=601102#c9 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below"))
> Isn't Test Pilot installed in Firefox 4 by default so wouldn't most people have
> Test Pilot installed after upgrading to Firefox 4?
It was part of the product in betas, but not in final. So everyone that had the beta will have it installed but everyone who only got final hasn't (unless they installed it manually).

|  | [Michael Kraft [:morac]](/user_profile?user_id=142910) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=601102#c11)• 14 years ago |
|  | |

(In reply to [comment #10](/show_bug.cgi?id=601102#c10 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below"))
> It was part of the product in betas, but not in final. So everyone that had the
> beta will have it installed but everyone who only got final hasn't (unless they
> installed it manually).
Ah okay. Strangely enough I got another of these crashes. That's two in one day, when I've never seen it before today.
[bp-92beee74-1e16-4f34-8c47-04aca2110324](https://crash-stats.mozilla.org/report/index/92beee74-1e16-4f34-8c47-04aca2110324)

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=601102#c12)• 14 years ago |
|  | |

(In reply to [comment #11](/show_bug.cgi?id=601102#c11 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below"))
> Ah okay. Strangely enough I got another of these crashes. That's two in one
> day, when I've never seen it before today.
>
> [bp-92beee74-1e16-4f34-8c47-04aca2110324](https://crash-stats.mozilla.org/report/index/92beee74-1e16-4f34-8c47-04aca2110324)
We are currently unsure what causes this, but we need to get some tracking on it. You also appear to have testpilot activated, which right now is our only (weak) clue.

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=601102#c13)• 14 years ago |
|  | |

jono, any updates or thoughts from looking at test pilot side?
dmaindelin, any ideas on how to mitigate the crash on the JS side, or help in understanding what addons might be doing?

|  | [David Mandelin [:dmandelin]](/user_profile?user_id=294323) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=601102#c14)• 14 years ago |
|  | |

Bill, Luke, and I were talking about this morning. We think it may be due to a compartment mismatch. An exception object keeps a list of argument values from the JS stack frames live at the point of the exception. The argument values may belong to different compartments from the exception, but they are not wrapped, which seems like a bug.

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=601102#c16)• 14 years ago |
|  | |

Woohoo, the assert hits, only when I install test pilot, and then the offending frame's script is indeed resource://testpilot/modules/lib/securable-module.js -> resource://testpilot/modules/lib/memory.js.Group: core-security

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=601102#c17)• 14 years ago |
|  | |

Attached patch

[patch](attachment.cgi?id=521956&action=diff)
— [Details](attachment.cgi?id=521956&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=601102&attachment=521956)

The fix is simple.Assignee: general → lukeStatus: NEW → ASSIGNED
[Attachment #521956](/attachment.cgi?id=521956&action=edit "patch") -
Flags: review?(gal)

|  | [Jono Xia](/user_profile?user_id=298259) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=601102#c18)• 14 years ago |
|  | |

Wow, sounds like that was some impressive detective work figuring out the cause of the crash.
Judging by Luke's patch, it seems like this has to be fixed in the core, and so there isn't anything that needs to change in Test Pilot, is that correct?

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=601102#c19)• 14 years ago |
|  | |

Correct; Test Pilot just tickled the dragon.

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=601102#c20)• 14 years ago |
|  | |

topcrash + security risk? means it really needs to get out in 4.0.1
marked this as ride-along to get on the radar since I'm not quite sure how to mark this kinds of thinks that should have blocked RC if we had known about them earlier.
what's the sg: rating?blocking2.0: - → ?Whiteboard: [fx4-rc-ridealong]

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=601102#c21)• 14 years ago |
|  | |

Comment on [attachment 521956](/attachment.cgi?id=521956 "patch") [[details]](/attachment.cgi?id=521956&action=edit "patch") [[diff]](/attachment.cgi?id=521956&action=diff "patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=601102&attachment=521956)
patch
If the current compartment is privileged (chrome), it might be allow to see the content frame. Maybe we should do a follow-up and copy data into the destination compartment in that case.
[Attachment #521956](/attachment.cgi?id=521956&action=edit "patch") -
Flags: review?(gal) → review+

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=601102#c22)• 14 years ago |
|  | |

<http://hg.mozilla.org/mozilla-central/rev/9be05c62b6ce>
If nightlies show a good reduction in this crash (and/or [bug 615098](/show_bug.cgi?id=615098 "RESOLVED WORKSFORME - crash [@ js::gc::MarkId ] with TestPilot (Mac, Windows) or Firebug or AdBlock plus (Mac) or Kikin (Windows)"), [bug 615098](/show_bug.cgi?id=615098 "RESOLVED WORKSFORME - crash [@ js::gc::MarkId ] with TestPilot (Mac, Windows) or Firebug or AdBlock plus (Mac) or Kikin (Windows)")), should this land on the 2.0?Status: ASSIGNED → RESOLVEDClosed: 14 years agoResolution: --- → FIXED

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=601102#c23)• 14 years ago |
|  | |

looks like the volume on mozilla-central / 4.0 "pre" releases is extremely low (like 0-2 crashes per day). so we might need a beta or final release to really know how much impact the fix might have.
for example, here is the volume of crashes per release version in crash data that we got yesterday.
20110324 9309 total crashes
date total breakdown by build
count build, count build, ...
8487 4.02011031805,
412 4.0b122011022221, 331 4.02011030319,
20 4.0b102011012116, 14 4.0b112011020314,
8 4.2a1pre2011032316, 7 4.0b92011011019,
7 4.0b13pre2011032203, 6 4.0b82010121417,
3 4.0b72010110414, 3 4.0b13pre2011032103,
3 4.02011031716, 2 4.2a1pre2011032314,
2 4.2a1pre2011032307, 2 4.0b13pre2011032303,
1 4.2a1pre2011032403, 1 4.0b13pre2011032003,

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=601102#c24)• 14 years ago |
|  | |

Oops, [comment 22](/show_bug.cgi?id=601102#c22 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below") clearly did not see [comment 20](/show_bug.cgi?id=601102#c20 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below").

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a15192394_386758)• 14 years ago |

OS: Windows XP → AllHardware: x86 → AllSummary: Crash [@ js::Shape::trace(JSTracer\*) ] mainly with TestPilot 1.1 and below → Crash [@ js::Shape::trace(JSTracer\*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a15402427_1689)• 14 years ago |

blocking2.0: ? → .x+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=601102#c25)• 14 years ago |
|  | |

Guessing a missing compartment check might be sg:high, but that's just a guess. Would it allow content/chrome mixing?blocking2.0: .x+ → MacawWhiteboard: [fx4-rc-ridealong] → [sg:high][fx4-rc-ridealong]

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=601102#c26)• 14 years ago |
|  | |

The pre-existing security check in stack walking should prevent cross-origin mixing from happening directly. However, we are still accessing trash memory, so it seems to be in the theoretically-possible-to-exploit category.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=601102#c27)• 14 years ago |
|  | |

because it's completely unclear, "blocking2.0: Macaw" means we want this fix on the mozilla2.0 repository for the 4.0.1 release. Consider that repo equivalent to the end-game Fx4 release and request explicit approval2.0 on the appropriate patch.Whiteboard: [sg:high][fx4-rc-ridealong] → [sg:critical?][fx4-rc-ridealong]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=601102#c28)• 14 years ago |
|  | |

Comment on [attachment 521956](/attachment.cgi?id=521956 "patch") [[details]](/attachment.cgi?id=521956&action=edit "patch") [[diff]](/attachment.cgi?id=521956&action=diff "patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=601102&attachment=521956)
patch
Approved for landing on mozilla2.0, a=dveditz for release-drivers
forgive the previous boilerplate comment
[Attachment #521956](/attachment.cgi?id=521956&action=edit "patch") -
Flags: approval2.0+

|  | [Luke Wagner [:luke]](/user_profile?user_id=347312)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=601102#c29)• 14 years ago |
|  | |

<http://hg.mozilla.org/releases/mozilla-2.0/rev/cbda245a805d>

|  | [LegNeato](/user_profile?user_id=482154) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a16625262_482154)• 14 years ago |

[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [LegNeato](/user_profile?user_id=482154) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=601102#c30)• 14 years ago |
|  | |

We don't see this signature on branches, marking unaffected for now.
[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected)
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=601102#c31)• 14 years ago |
|  | |

It is #9 top crasher in 4.0.1, so I reopen this bug.Status: RESOLVED → REOPENEDResolution: FIXED → ---

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=601102#c32)• 14 years ago |
|  | |

I think it might be better to file another one for the remaining things, unless you know that the patch in here doesn't fix any of the crashes we've been seeing with this. Real work has been done here, and the cause supposed to be fixed by the patches in here was deemed a security risk. This bug should cover that class of crashes fixed by this patch. A new bug should be filed for any other class of crashes that might result in the same signature.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=601102#c33)• 14 years ago |
|  | |

As it became from #2 to #9 top crasher, the patch has fixed some causes. They should be written in the summary, so that the bug isn't confused with the meta bug.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a17312292_386758)• 14 years ago |

Status: REOPENED → RESOLVEDClosed: 14 years ago → 14 years agoResolution: --- → FIXEDSummary: Crash [@ js::Shape::trace(JSTracer\*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below → Crash in exn\_trace [@ js::Shape::trace(JSTracer\*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below

|  | [John J. Barton](/user_profile?user_id=223726) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=601102#c34)• 14 years ago |
|  | |

When is this fix going to be available? These crashes are tedious.

|  | [Bill McCloskey [inactive unless it's an emergency] (:billm)](/user_profile?user_id=389993) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=601102#c35)• 14 years ago |
|  | |

(In reply to [comment #34](/show_bug.cgi?id=601102#c34 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below"))
> When is this fix going to be available? These crashes are tedious.
It should be fixed in 4.0.1. The fix is only for crashes with exn\_trace in the stack trace.

|  | [John J. Barton](/user_profile?user_id=223726) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=601102#c36)• 14 years ago |
|  | |

Fine. When is 4.0.1 going to be available. I crashed again.

|  | [Scoobidiver (away)](/user_profile?user_id=386758)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a17963848_386758)• 14 years ago |

Blocks: [653081](/show_bug.cgi?id=653081 "RESOLVED WORKSFORME - [meta] Crash [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ]")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a20370201_1689)• 14 years ago |

Group: core-security

|  | [Nobody; OK to take it and work on it](/user_profile?user_id=1) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=601102#a22049434_1)• 14 years ago |

Crash Signature: [@ js::Shape::trace(JSTracer\*) ]
[@ js::Shape::trace ]
You need to [log in](/show_bug.cgi?id=601102&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Luke Wagner [:luke]](/user_profile?user_id=347312)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_3c79080d_20250125_051025.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/639885)
* [XML](/show_bug.cgi?ctype=xml&id=639885)

Closed
[Bug 639885](/show_bug.cgi?id=639885)

Opened 14 years ago
Closed 14 years ago

# Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks

## Categories

### (Core :: Graphics, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics#Graphics)

Graphics
▾

Core :: Graphics
Mapping of cross platform rendering interfaces to various 2D graphics APIs
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Windows 7

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: ted, Assigned: bas.schouten)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/b8738cf17a8d158995d4d60a2490853f?d=mm&size=40)  [bas.schouten](/user_profile?user_id=272464)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/30fa9f928422bef2f98dd5f564def686?d=mm&size=40)  [ted](/user_profile?user_id=39022)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/17436ade8da1b23d42b3df05b9c4fc77?d=mm&size=40)  [bhood](/user_profile?user_id=697075)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

19 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[637331](/show_bug.cgi?id=637331 "VERIFIED DUPLICATE - Two copies of Firefox can crash each other"), [641293](/show_bug.cgi?id=641293 "VERIFIED DUPLICATE - Two simultaneous Profiles cause's first opened profile to Crash")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: relnote, Whiteboard: [sg:moderate][fx4-rc-ridealong] requires two instances of Firefox)

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[relnote](/buglist.cgi?keywords=relnote&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:moderate][fx4-rc-ridealong] requires two instances of Firefox

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files, 3 obsolete files)

| [Fix potential access-after-free](/attachment.cgi?id=517848)  [14 years ago](#c7)  [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)   6.81 KB, patch |  | [Details](/attachment.cgi?id=517848&action=edit) | [Diff](/attachment.cgi?id=517848&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517848) |
| --- | --- | --- |
| [Fix potential access-after-free v2](/attachment.cgi?id=517877)  [14 years ago](#c12)  [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)   6.64 KB, patch | cjones : [review+](#c13 "14 years ago") | [Details](/attachment.cgi?id=517877&action=edit) | [Diff](/attachment.cgi?id=517877&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517877) |
| [Abort in case of unsafe program state (for Gecko 2.0)](/attachment.cgi?id=517941)  [14 years ago](#c21)  [(no longer active)](/user_profile?user_id=251051)   1.96 KB, patch | jrmuizel : [review+](#a33991_309398 "14 years ago")  cjones : [review+](#a39117_336288 "14 years ago")  bas.schouten : [review+](#c34 "14 years ago") | [Details](/attachment.cgi?id=517941&action=edit) | [Diff](/attachment.cgi?id=517941&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517941) |
| [Part 2: Stop using named objects [checkin: comment 58]](/attachment.cgi?id=517958)  [14 years ago](#c32)  [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)   1.11 KB, patch | jrmuizel : [review+](#c52 "14 years ago")  dveditz : [approval2.0+](#c65 "14 years ago") | [Details](/attachment.cgi?id=517958&action=edit) | [Diff](/attachment.cgi?id=517958&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958) |
| [Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]](/attachment.cgi?id=517979)  [14 years ago](#c35)  [(no longer active)](/user_profile?user_id=251051)   1.99 KB, patch | beltzner : [review+](#c36 "14 years ago")  beltzner : [approval2.0+](#c36 "14 years ago") | [Details](/attachment.cgi?id=517979&action=edit) | [Diff](/attachment.cgi?id=517979&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517979) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [(not currently active) Ted Mielczarek](/user_profile?user_id=39022)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=639885#c0)• 14 years ago |
|  | |

I hit this crash three times in the past two days:
mozcrt19.dll!memmove(unsigned char \* dst=0x67e23fa0, unsigned char \* src=0x67e23fa4, unsigned long count=4294967292) Line 188 Asm
xul.dll!nsTArray\_base<nsTArrayDefaultAllocator>::ShiftData(unsigned int start=0, unsigned int oldLen=0, unsigned int newLen=0, unsigned int elemSize=4) Line 180 + 0xd bytes C++
xul.dll!nsTArray<nsAutoPtr<mozilla::layers::ReadbackTask>,nsTArrayDefaultAllocator>::RemoveElementsAt(unsigned int start=1736935553, unsigned int count=1) Line 836 C++
xul.dll!nsTArray<nsAutoPtr<mozilla::layers::ReadbackTask>,nsTArrayDefaultAllocator>::RemoveElementAt(unsigned int index=1736935646) Line 841 C++
> xul.dll!mozilla::layers::ReadbackManagerD3D10::ProcessTasks() Line 232 C++
xul.dll!mozilla::layers::StartTaskThread(void \* aManager=0x124f7730) Line 135 C++
kernel32.dll!@BaseThreadInitThunk@12() + 0x12 bytes
ntdll.dll!\_\_\_RtlUserThreadStart@8() + 0x27 bytes
ntdll.dll!\_\_RtlUserThreadStart@8() + 0x1b bytes
The worst part is that before we crash, the memmove manages to overwrite a static member variable that Breakpad needs to function properly, so the exception handler crashes, so you just get a Windows crash dialog instead of our crash reporter.
All three times I managed to reproduce this I had another instance of Firefox running (with -no-remote). I hit it twice today under those circumstances. (The second time I attached a debugger and set a data breakpoint, which is how I determined that the member variable was being overwritten here.)

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a3609_7044)• 14 years ago |

blocking2.0: --- → ?

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a5826_310943)• 14 years ago |

Group: core-security

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=639885#c1)• 14 years ago |
|  | |

Hidden until further analysis.

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=639885#c2)• 14 years ago |
|  | |

Need more data on whether we have a frequent crash. Leaving the nomination now.Group: core-security

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a6166_94)• 14 years ago |

Assignee: nobody → bas.schouten

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a6203_180188)• 14 years ago |

Group: core-security

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=639885#c3)• 14 years ago |
|  | |

This crash is very strange, I've got a theory on what might cause something like this, but it should only occur on a device driver hang/reset or some 10-20 seconds after startup.
I will write a fix for that issue and hope it takes care of this. Sadly considering this shows a weakness in our crash reporter, we have no idea how often this happens in the wild.
I can see no way this can be exploited.

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=639885#c4)• 14 years ago |
|  | |

Given the codepath here, this is probably only related to windowless plugins on D3D10, which is most commonly testable on hulu and blip... most youtube videos are windowed.

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=639885#c5)• 14 years ago |
|  | |

> Need more data on whether we have a frequent crash.
I don't get any matches for a stack or signature looking like this when trying to find this in reports in socorro, or searching the top ten lines of all the stacks in the top 300 for beta 12 or 3.6.14
<http://people.mozilla.org/crash_stacks/stack-summary-4.0b12.txt>
<http://people.mozilla.org/crash_stacks/stack-summary-3.6.14.txt>

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=639885#c6)• 14 years ago |
|  | |

Yes, that's because the bug here causes no crash reporter to come up.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=639885#c7)• 14 years ago |
|  | |

Attached patch

[Fix potential access-after-free](attachment.cgi?id=517848&action=diff) (obsolete)
— [Details](attachment.cgi?id=517848&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517848)

This fixes the potential access-after-free bug here. We call terminate before releasing our last external reference inside the DeviceAttachments.
Terminate signals the task thread to stop after checking whether it has grabbed a reference to the ReadbackManager yet. That reference will be released when the task thread terminates.
This should fix the only cause I can think of for this crash, outside of someone else corrupting the readbackmanager.
[Attachment #517848](/attachment.cgi?id=517848&action=edit "Fix potential access-after-free") -
Flags: review?(jmuizelaar)

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a12478_94)• 14 years ago |

[Attachment #517848](/attachment.cgi?id=517848&action=edit "Fix potential access-after-free") -
Flags: review?(jones.chris.g)

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=639885#c8)• 14 years ago |
|  | |

Is this read or write after free? Write after free is almost always exploitable in a multi-threaded system with user control over background threads.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=639885#c9)• 14 years ago |
|  | |

This is a write after free. But I don't see how anyone could affect what's being written to from JS or HTML or anything like that.

|  | [Chris Jones [:cjones] inactive; ni?/f?/r? if you need me](/user_profile?user_id=336288) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=639885#c10)• 14 years ago |
|  | |

Comment on [attachment 517848](/attachment.cgi?id=517848 "Fix potential access-after-free") [[details]](/attachment.cgi?id=517848&action=edit "Fix potential access-after-free") [[diff]](/attachment.cgi?id=517848&action=diff "Fix potential access-after-free") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517848)
Fix potential access-after-free
This looks mostly OK, comments follow.
> struct DeviceAttachments
> {
>+ ~DeviceAttachments() {
>+ if (mReadbackManager) {
>+ mReadbackManager->Terminate();
>+ }
I would remove this ...
>+ mMayTerminate = ::CreateEventA(NULL, TRUE, FALSE, "MayTerminateEvent");
... rename this to mReadbackThreadHasRef ...
>+void
>+ReadbackManagerD3D10::Terminate()
>+{
>+ // Practically always this event should have been set by the time we reach
>+ // this, we need to do this to prevent the rare race condition where we'd
>+ // get terminated and released on the main thread before we take a reference
>+ // to ourselves.
>+ ::WaitForSingleObject(mMayTerminate, INFINITE);
... remove this ...
... and in ReadbackManagerD3D10::ReadbackManagerD3D10(), after
creating the readback thread, block on
::WaitForSingleObject(mReadbackThreadHasRef, INFINITE);
Your impl here looks OK, but I don't like distributing the invariant
that the readback thread has a reference around this code. This will
mean that we block on startup of the readback thread, but I would hope
that's not too slow on windows.

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=639885#c11)• 14 years ago |
|  | |

It looks like this is:
memmove(base, base+4, 4294967292);
where base is a heap address.
So move everything on the heap forward 4 bytes until we reach the end of the heap.
I'm sort of surprised that the static member variables for crash reporter are in memory contiguous with the heap.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=639885#c12)• 14 years ago |
|  | |

Attached patch

[Fix potential access-after-free v2](attachment.cgi?id=517877&action=diff) (obsolete)
— [Details](attachment.cgi?id=517877&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517877)

Addressed cjones' comments as per IRC discussion.
[Attachment #517848](/attachment.cgi?id=517848&action=edit "Fix potential access-after-free") -
Attachment is obsolete: true
[Attachment #517848](/attachment.cgi?id=517848&action=edit "Fix potential access-after-free") -
Flags: review?(jones.chris.g)
[Attachment #517848](/attachment.cgi?id=517848&action=edit "Fix potential access-after-free") -
Flags: review?(jmuizelaar)
[Attachment #517877](/attachment.cgi?id=517877&action=edit "Fix potential access-after-free v2") -
Flags: review?(jones.chris.g)
[Attachment #517877](/attachment.cgi?id=517877&action=edit "Fix potential access-after-free v2") -
Flags: review?(jmuizelaar)

|  | [Chris Jones [:cjones] inactive; ni?/f?/r? if you need me](/user_profile?user_id=336288) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=639885#c13)• 14 years ago |
|  | |

Comment on [attachment 517877](/attachment.cgi?id=517877 "Fix potential access-after-free v2") [[details]](/attachment.cgi?id=517877&action=edit "Fix potential access-after-free v2") [[diff]](/attachment.cgi?id=517877&action=diff "Fix potential access-after-free v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517877)
Fix potential access-after-free v2
I still think the "mMayTerminate" name is ambiguous and confusing, but don't need to hold an sg on that.
>+void
>+ReadbackManagerD3D10::Terminate()
>+{
Assert main-thread here.
[Attachment #517877](/attachment.cgi?id=517877&action=edit "Fix potential access-after-free v2") -
Flags: review?(jones.chris.g) → review+

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=639885#c14)• 14 years ago |
|  | |

In order to make a judgement on blocking status, the following questions need to be answered:
- is this a recent regression?
- do we see any secondary indicators that the crash is common?
- can it be trivially reproduced on Windows systems running common plugins on common websites?

|  | [JP Rosevear [:jpr]](/user_profile?user_id=407310) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=639885#c15)• 14 years ago |
|  | |

(In reply to [comment #14](/show_bug.cgi?id=639885#c14 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> In order to make a judgement on blocking status, the following questions need
> to be answered:
>
> - is this a recent regression?
Probably since this code landed only in b12.
> - do we see any secondary indicators that the crash is common?
MS crash data will hopefully provide the answer. Asa found nothing concrete in the input database (see release-drivers).
> - can it be trivially reproduced on Windows systems running common plugins on
> common websites?
Not yet at least.

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=639885#c16)• 14 years ago |
|  | |

Bas, can you give a step-by-step walk through about your what happens with the current code, provided your theory about the problem is true?

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=639885#c17)• 14 years ago |
|  | |

Also, this patch seems to assume that DeviceAttachments will be the last thing to hold the reference. This stack seems to suggest otherwise:
xul.dll!mozilla::layers::ReadbackManagerD3D10::~ReadbackManagerD3D10() Line 148 C++
xul.dll!mozilla::layers::ReadbackManagerD3D10::`scalar deleting destructor'() + 0xf bytes C++
xul.dll!mozilla::layers::ReadbackManagerD3D10::Release() Line 213 + 0x1c bytes C++
xul.dll!nsRefPtr<mozilla::layers::ReadbackManagerD3D10>::~nsRefPtr<mozilla::layers::ReadbackManagerD3D10>() Line 970 C++
xul.dll!mozilla::layers::LayerManagerD3D10::~LayerManagerD3D10() Line 117 + 0x37 bytes C++
xul.dll!mozilla::layers::LayerManagerD3D10::`vector deleting destructor'() + 0x4d bytes C++
xul.dll!mozilla::layers::LayerManager::Release() Line 256 + 0x141 bytes C++
xul.dll!nsRefPtr<mozilla::layers::LayerManager>::assign\_assuming\_AddRef(mozilla::layers::LayerManager \* newPtr=0x00000000) Line 958 C++
xul.dll!nsRefPtr<mozilla::layers::LayerManager>::assign\_with\_AddRef(mozilla::layers::LayerManager \* rawPtr=0x00000000) Line 942 C++
xul.dll!nsRefPtr<mozilla::layers::LayerManager>::operator=(mozilla::layers::LayerManager \* rhs=0x00000000) Line 1026 C++
xul.dll!nsWindow::Destroy() Line 760 C++
xul.dll!nsXULWindow::Destroy() Line 556 C++

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=639885#c18)• 14 years ago |
|  | |

Ehsan and I have artificially reproduced the crash by changing the CreateSemaphore initial count to be one less than the maximum and visiting hulu.com

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=639885#c19)• 14 years ago |
|  | |

(In reply to [comment #18](/show_bug.cgi?id=639885#c18 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Ehsan and I have artificially reproduced the crash by changing the
> CreateSemaphore initial count to be one less than the maximum and visiting
> hulu.com
However, the reproduction may be a red herring...

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=639885#c20)• 14 years ago |
|  | |

Ted, did you notice a browser hang of about 5 seconds before the crash?

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=639885#c21)• 14 years ago |
|  | |

Attached patch

[Abort in case of unsafe program state (for Gecko 2.0)](attachment.cgi?id=517941&action=diff) (obsolete)
— [Details](attachment.cgi?id=517941&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517941)

One possible failure scenario here is if the thread takes more than 5 seconds to shut down. <<http://mxr.mozilla.org/mozilla-central/source/gfx/layers/d3d10/ReadbackManagerD3D10.cpp#160>>
In this case we end up with a running thread touching the ReadbackManagerD3D10 object. Note that the destructor for nsTArray calls Clear on it, which sets mLength to 0, which might lead to the exact crash in [comment 0](/show_bug.cgi?id=639885#c0 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks").
I think it's best for us to change things so that we do a runtime abort if this happens. This enables us to get crash data from our users who hit this, and might help us in debugging this bug further and fixing it in a future release. This is what this patch does.
This code is really hard to reason about. Jeff and I discussed this code and Bas patch for several hours today, and in the end neither of us seemed comfortable with taking Bas' patch here. I highly recommend against taking that patch for Firefox 4, unless a safe fix which has been tested on the nightlies for some time can be backported to the 2.0 branch in a future dot-release.
[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Flags: review?(jones.chris.g)
[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Flags: review?(jmuizelaar)
[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Flags: review?(bas.schouten)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=639885#c22)• 14 years ago |
|  | |

(In reply to [comment #21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> One possible failure scenario here is if the thread takes more than 5 seconds
> to shut down.
Possible examples of the cases where this might happen is having lots of windowless plugins on a page (pages with ads?), or an extremely busy system (possibly thrashing stuff to disk). Basically either a large number of jobs to process, or the starvation of the background thread.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=639885#c23)• 14 years ago |
|  | |

And let me also add that this code has a lot of other problems as well (such as using named objects, not doing enough error checking, using a semaphore as a means of tracking the number of objects in the queue, using CreateThread directly, etc). I think those problems should be dealt with in other bugs though.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=639885#c24)• 14 years ago |
|  | |

Note that if the scenario in [comment 21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") is correct, this might be exploitable, because we'd be accessing |this| after the object has gone away, and it would be possible to cause the memmove to overwrite a vtable, which means that we're owned. Determining if this can really happen requires understanding the code way better than I do.

|  | [(not currently active) Ted Mielczarek](/user_profile?user_id=39022)  Reporter |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=639885#c25)• 14 years ago |
|  | |

(In reply to [comment #20](/show_bug.cgi?id=639885#c20 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Ted, did you notice a browser hang of about 5 seconds before the crash?
Can't say that I did, but I'm not a reliable observer, I don't think. This is on a Core i7 machine running Windows 7 x64, FWIW. The machine is not otherwise under heavy load, just browsing.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=639885#c26)• 14 years ago |
|  | |

I've setup a reporting structure for Ted that keeps reporting how many tasks are in the task queue. If it happens for him again, or maybe even if it doesn't, if we see a rising trend on the amount of tasks in the queue this could be responsible. It sounds very unlikely though. Even if this was the cause we'd simply start leaking tasks (the semaphore will refuse to increment while the queue grows).
It will be interesting debug information anyway, so let's hope it crashes and let's see what comes out of it.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=639885#c27)• 14 years ago |
|  | |

(In reply to [comment #24](/show_bug.cgi?id=639885#c24 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Note that if the scenario in [comment 21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") is correct, this might be exploitable,
> because we'd be accessing |this| after the object has gone away, and it would
> be possible to cause the memmove to overwrite a vtable, which means that we're
> owned. Determining if this can really happen requires understanding the code
> way better than I do.
I agree with all this, I don't see a reasonable way for anyone to control what memory the memmove moves where though. But I don't see any attack vectors to inject anything into the vtable. Nor a way to get this vtable to be called after object destruction (the task function itself makes no virtual function calls, i.e. there's no vtable access after free).
So yes, memory can be moved into an area that once was a vtable, but not a vtable that's going to be used for anything.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=639885#c28)• 14 years ago |
|  | |

(In reply to [comment #21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> This code is really hard to reason about. Jeff and I discussed this code and
> Bas patch for several hours today, and in the end neither of us seemed
> comfortable with taking Bas' patch here. I highly recommend against taking
> that patch for Firefox 4, unless a safe fix which has been tested on the
> nightlies for some time can be backported to the 2.0 branch in a future
> dot-release.
Although any lifecycle management changes in a multithreaded environment are risky. I personally think this is a pretty safe patch (yes, it would require a QA cycle). If we do have any future RC I'd certainly recommend taking it as this is a pretty nasty bug, even though I can't imagine the prevalence being high.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=639885#c29)• 14 years ago |
|  | |

(In reply to [comment #27](/show_bug.cgi?id=639885#c27 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> (In reply to [comment #24](/show_bug.cgi?id=639885#c24 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> > Note that if the scenario in [comment 21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") is correct, this might be exploitable,
> > because we'd be accessing |this| after the object has gone away, and it would
> > be possible to cause the memmove to overwrite a vtable, which means that we're
> > owned. Determining if this can really happen requires understanding the code
> > way better than I do.
>
> I agree with all this, I don't see a reasonable way for anyone to control what
> memory the memmove moves where though. But I don't see any attack vectors to
> inject anything into the vtable. Nor a way to get this vtable to be called
> after object destruction (the task function itself makes no virtual function
> calls, i.e. there's no vtable access after free).
>
> So yes, memory can be moved into an area that once was a vtable, but not a
> vtable that's going to be used for anything.
I was not merely talking about the vtables for these objects. The fault memmove call goes ahead and corrupts a large portion of the heap this way, so a value which is stored adjacent to an object pointer can be replaced with the pointer, for example, and that value could be constructed to point to the attacker's favorite vtable coming from an image, etc. :-)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=639885#c30)• 14 years ago |
|  | |

(In reply to [comment #28](/show_bug.cgi?id=639885#c28 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> (In reply to [comment #21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> > This code is really hard to reason about. Jeff and I discussed this code and
> > Bas patch for several hours today, and in the end neither of us seemed
> > comfortable with taking Bas' patch here. I highly recommend against taking
> > that patch for Firefox 4, unless a safe fix which has been tested on the
> > nightlies for some time can be backported to the 2.0 branch in a future
> > dot-release.
>
> Although any lifecycle management changes in a multithreaded environment are
> risky. I personally think this is a pretty safe patch (yes, it would require a
> QA cycle). If we do have any future RC I'd certainly recommend taking it as
> this is a pretty nasty bug, even though I can't imagine the prevalence being
> high.
Can you reply to [comment 16](/show_bug.cgi?id=639885#c16 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"), please?

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=639885#c31)• 14 years ago |
|  | |

Try server push: <http://tbpl.mozilla.org/?tree=MozillaTry&rev=0ff4f7282a24>

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=639885#c32)• 14 years ago |
|  | |

Attached patch

[Part 2: Stop using named objects [checkin: comment 58]](attachment.cgi?id=517958&action=diff)
— [Details](attachment.cgi?id=517958&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958)

I don't agree with all of Ehsan's problems with the code, however he's certainly right that the use of named objects here is a -very- bad thing here! Let's stop doing it now.
I wrote this with in my mind that this was a singleton class, where it would've been benign, but not really that informative anyway. However under some conditions (driver crashes/etc.), it's not, if the shutdown then also takes longer than 5 seconds (I'll detail this situation as requested by Jeff in a separate comment), this will linger the old objects. This means that if the semaphore lingers, our new semaphore will share its state with the old one! This is a big problem since this could make the worker thread on one object process an event that was posted on the other. It would access the wrong array and not find any task there, and crash. This situation should also be extremely rare, and indeed if it does occur we're already stuck with an access-after-free without my other patch.
However it is very bad, as such I'm posting this here as we certainly want to fix this, quickly, as well.
[Attachment #517958](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") -
Flags: review?(jmuizelaar)

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=639885#c33)• 14 years ago |
|  | |

(In reply to [comment #16](/show_bug.cgi?id=639885#c16 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Bas, can you give a step-by-step walk through about your what happens with the
> current code, provided your theory about the problem is true?
Ehsan gives a pretty good description in [comment 21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks").
Essentially what happens is this:
1) The destructor is called, this tells the thread to shutdown when it unblocks
2) The destructor waits for 5 seconds, and in order not to freeze the browser if the video driver is acting up, it continues execution, it finalizes and deallocates the object out under the task thread
3) The taskthread unblocks, and accesses the freed member variables

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=639885#c34)• 14 years ago |
|  | |

Comment on [attachment 517941](/attachment.cgi?id=517941 "Abort in case of unsafe program state (for Gecko 2.0)") [[details]](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") [[diff]](/attachment.cgi?id=517941&action=diff "Abort in case of unsafe program state (for Gecko 2.0)") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517941)
Abort in case of unsafe program state (for Gecko 2.0)
As a measurement device this is a fine solution. I'm r+'ing this so we can go forward with it if this approach is the consensus.
[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Flags: review?(bas.schouten) → review+

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a33991_309398)• 14 years ago |

[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Flags: review?(jmuizelaar) → review+

|  | [Chris Jones [:cjones] inactive; ni?/f?/r? if you need me](/user_profile?user_id=336288) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a39117_336288)• 14 years ago |

[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Flags: review?(jones.chris.g) → review+

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=639885#c35)• 14 years ago |
|  | |

Attached patch

[Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]](attachment.cgi?id=517979&action=diff)
— [Details](attachment.cgi?id=517979&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517979)

This version changes the patch header so that if we decide to land it, it's hg import'able.
[Attachment #517941](/attachment.cgi?id=517941&action=edit "Abort in case of unsafe program state (for Gecko 2.0)") -
Attachment is obsolete: true

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=639885#c36)• 14 years ago |
|  | |

Comment on [attachment 517979](/attachment.cgi?id=517979 "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") [[details]](/attachment.cgi?id=517979&action=edit "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") [[diff]](/attachment.cgi?id=517979&action=diff "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517979)
Abort in case of unsafe program state (for Gecko 2.0) [check-in: [comment 51](/show_bug.cgi?id=639885#c51 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks")]
r+a=beltzner for landing on mozilla-central to get nightly feedback
[Attachment #517979](/attachment.cgi?id=517979&action=edit "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") -
Flags: review+
[Attachment #517979](/attachment.cgi?id=517979&action=edit "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") -
Flags: approval2.0+

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=639885#c37)• 14 years ago |
|  | |

(the r+ is carried over from Bas, whoops)

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a68733_137548)• 14 years ago |

Whiteboard: [needs to land on mozilla-central]

|  | [(not currently active) Ted Mielczarek](/user_profile?user_id=39022)  Reporter |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=639885#c38)• 14 years ago |
|  | |

Okay, so, I found STR thanks to Bas:
1) Run Firefox, load Hulu
2) Run another Firefox -no-remote, load Hulu
3) The first browser will crash

|  | [(not currently active) Ted Mielczarek](/user_profile?user_id=39022)  Reporter |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=639885#c39)• 14 years ago |
|  | |

I think this means that it's only reproducible when running two instances of Firefox, so this shouldn't be an issue that most people run into.

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=639885#c40)• 14 years ago |
|  | |

(In reply to [comment #39](/show_bug.cgi?id=639885#c39 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> I think this means that it's only reproducible when running two instances of
> Firefox, so this shouldn't be an issue that most people run into.
And also suggests that this has to do with the named synchronization primitives.

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=639885#c41)• 14 years ago |
|  | |

So, the second hunk of Ehsan's patch will catch what the actual bug is here. I've figured it out after thinking about it more.
The evil here is the named objects (indirectly: Nice catch Ehsan!), if you have two browser sessions open (i.e. two instances of firefox.exe) open in a single user login, the second will open the semaphore of the first (after all the name already exists within that Desktop Session). Then when one process gets a task processed, either one of the two can get released, if the wrong one is released mPendingReadbackTasks will be empty, and everything will fall apart. The fix for this is trivial, safe, and already part 2 on this bug.
This particular bug will only ever occur for users running -two or more- instances of firefox.exe (i.e. starting one with -no-remote), and having used windowless plugins in both of them.

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=639885#c42)• 14 years ago |
|  | |

Not a blocker.blocking2.0: ? → .x+Whiteboard: [needs to land on mozilla-central] → [needs to land on mozilla-central][fx4-rc-ridealong]

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a71978_7044)• 14 years ago |

Keywords: [relnote](/buglist.cgi?keywords=relnote&resolution=---)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=639885#c43)• 14 years ago |
|  | |

(In reply to [comment #41](/show_bug.cgi?id=639885#c41 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> So, the second hunk of Ehsan's patch will catch what the actual bug is here.
> I've figured it out after thinking about it more.
>
> The evil here is the named objects (indirectly: Nice catch Ehsan!), if you have
> two browser sessions open (i.e. two instances of firefox.exe) open in a single
> user login, the second will open the semaphore of the first (after all the name
> already exists within that Desktop Session). Then when one process gets a task
> processed, either one of the two can get released, if the wrong one is released
> mPendingReadbackTasks will be empty, and everything will fall apart. The fix
> for this is trivial, safe, and already part 2 on this bug.
>
> This particular bug will only ever occur for users running -two or more-
> instances of firefox.exe (i.e. starting one with -no-remote), and having used
> windowless plugins in both of them.
Is there any other scenario under which we allocate a second instance of ReadbackManagerD3D10 without the first instance's dtor being called? For example, what happens if the graphics driver crashes/gets reset?
And BTW, does this mean that my abort patch is no longer needed?

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=639885#c44)• 14 years ago |
|  | |

And I still think that a scenario such as [comment 21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") needs to be addressed too. In fact, I don't think why we're waiting 5 seconds for the thread to finish. Why can't that be INFINITE? I think whatever we do here, we need to address this case too, and my patch may help to see if [comment 21](/show_bug.cgi?id=639885#c21 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") happens in practice, even with [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958).

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=639885#c45)• 14 years ago |
|  | |

I am not particularly confident in the patch, based on the discussion in the bug. We don't seem to understand at all still how this really triggers.

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=639885#c46)• 14 years ago |
|  | |

Comment on [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958)
Part 2: Stop using named objects [checkin: [comment 58](/show_bug.cgi?id=639885#c58 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks")]
This seems to be the patch we really want to take instead.

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=639885#c47)• 14 years ago |
|  | |

Also if [comment 39](/show_bug.cgi?id=639885#c39 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") is correct, then this is most definitely not a blocker.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=639885#c48)• 14 years ago |
|  | |

(In reply to [comment #45](/show_bug.cgi?id=639885#c45 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> I am not particularly confident in the patch, based on the discussion in the
> bug. We don't seem to understand at all still how this really triggers.
Which patch do you mean?

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=639885#c49)• 14 years ago |
|  | |

The one that is ready to land and got approval. Thats not going to fix anything. The unreviewed ones are the ones we need, right?

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=639885#c50)• 14 years ago |
|  | |

(In reply to [comment #49](/show_bug.cgi?id=639885#c49 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> The one that is ready to land and got approval. Thats not going to fix
> anything. The unreviewed ones are the ones we need, right?
The purpose of that patch is not to fix anything. Its purpose is to make the crashes visible in our crash data. Please see the release-drivers thread which discusses why we need this patch at length.
The "part 2" patch fixes at least one manifestation of this problem, but I'm not convinced that it's all that we need to do in this bug yet.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=639885#c51)• 14 years ago |
|  | |

[Attachment 517979](/attachment.cgi?id=517979 "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") [[details]](/attachment.cgi?id=517979&action=edit "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") [[diff]](/attachment.cgi?id=517979&action=diff "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") landed on mozilla-central as <<http://hg.mozilla.org/mozilla-central/rev/cae1cd4aae73>>.
(I initially landed it on the relbranch by mistake: <<http://hg.mozilla.org/mozilla-central/rev/30a98bd29e53>> and immediately backed it out: <<http://hg.mozilla.org/mozilla-central/rev/864d3507de6e>>)Whiteboard: [needs to land on mozilla-central][fx4-rc-ridealong] → [fx4-rc-ridealong]

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a78972_251051)• 14 years ago |

[Attachment #517979](/attachment.cgi?id=517979&action=edit "Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]") -
Attachment description: Abort in case of unsafe program state (for Gecko 2.0) → Abort in case of unsafe program state (for Gecko 2.0) [check-in: comment 51]

|  | [Jeff Muizelaar [:jrmuizel]](/user_profile?user_id=309398) |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=639885#c52)• 14 years ago |
|  | |

Comment on [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958)
Part 2: Stop using named objects [checkin: [comment 58](/show_bug.cgi?id=639885#c58 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks")]
This is certainly an improvement, but why do we use win32 primitives instead of nspr here?
[Attachment #517958](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") -
Flags: review?(jmuizelaar) → review+

|  | [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)  Assignee |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=639885#c53)• 14 years ago |
|  | |

(In reply to [comment #52](/show_bug.cgi?id=639885#c52 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Comment on [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958)
> Part 2: Stop using named objects
>
> This is certainly an improvement, but why do we use win32 primitives instead of
> nspr here?
This is platform specific code, roc told me it was fine to use platform primitives directly in these cases.
NSPR only offers us condition variables for use here, these (particularly our implementation), have a not-insignificant overhead. Implementing this using condition variables is also slightly less elegant. Semaphores are better suited for the Producer/Consumer problem and are, at least at this point, not available in an efficient mapping to Win32 APIs.
The main reason was to make the code as thin and light-weight as possible.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=639885#c54)• 14 years ago |
|  | |

The memory corruption memmove/memcpy can cause is usually exploitable, but getting your victim to run two copies of Firefox at the same time is a pretty big hurdle. Guessing [sg:low] severity in practice.
Probably don't need to keep this hidden.Group: core-securityWhiteboard: [fx4-rc-ridealong] → [sg:low][fx4-rc-ridealong]

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a266189_94)• 14 years ago |

Whiteboard: [sg:low][fx4-rc-ridealong] → [sg:low][fx4-rc-ridealong][approved-patches-landed]

|  | [Stuart Parmenter](/user_profile?user_id=5756) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a277025_5756)• 14 years ago |

[Attachment #517958](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") -
Flags: approval2.0+

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94) |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=639885#c56)• 14 years ago |
|  | |

Stuart has given us the go-ahead to land [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958) on mozilla-central. Bas, can you do so? (Or anyone else - adding checkin-needed.)Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)Whiteboard: [sg:low][fx4-rc-ridealong][approved-patches-landed] → [sg:low][fx4-rc-ridealong]

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=639885#c57)• 14 years ago |
|  | |

If there was ever another product using Gecko 2.0, users who ran those programs at the same time as Firefox could potentially run into the same issue as well!

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=639885#c58)• 14 years ago |
|  | |

<http://hg.mozilla.org/mozilla-central/rev/4173c1b88642>
After landing I realized that I had committed this under my name. Going through bash log shows why:
hg qref -U 'Bas Schouten <bas.schouten@live.nl>'
(Note the uppercase U).
Sorry about that. And in the future, please add a From header to the patches that you attach so that this won't happen again. Thanks!Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a289809_251051)• 14 years ago |

[Attachment #517958](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") -
Attachment description: Part 2: Stop using named objects → Part 2: Stop using named objects [checkin: comment 58]

|  | [Joel](/user_profile?user_id=409298) |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=639885#c59)• 14 years ago |
|  | |

Hi I Just had my first bug marked a dup of this one (sorry)
I can reproduce it is every time in 5 min or less if that helps.
Here's my dup [https://bugzilla.mozilla.org/show\_bug.cgi?id=641293](/show_bug.cgi?id=641293 "VERIFIED DUPLICATE - Two simultaneous Profiles cause's first opened profile to Crash")
Let me know if there is anything a non-coding nOOb can do...

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=639885#c60)• 14 years ago |
|  | |

This bug in its original form has been fixed. Further patches should move to their own bugs.Status: NEW → RESOLVEDClosed: 14 years agoResolution: --- → FIXED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=639885#c61)• 14 years ago |
|  | |

Ehsan: what are the risks in taking the two approved patches on the mozilla2.0 repo?blocking2.0: .x+ → ?Whiteboard: [sg:low][fx4-rc-ridealong] → [sg:moderate][fx4-rc-ridealong] requires two instances of Firefox

|  | [Benjamin Smedberg](/user_profile?user_id=7044) |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=639885#c62)• 14 years ago |
|  | |

I believe it is absolutely essential to take these on the branch if there are going to be any other apps such as tbird running at the same time. Otherwise, this is going to end up as a guaranteed crash.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=639885#c63)• 14 years ago |
|  | |

(In reply to [comment #61](/show_bug.cgi?id=639885#c61 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Ehsan: what are the risks in taking the two approved patches on the mozilla2.0
> repo?
The \*only\* patch needed to fix this bug is [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958). It is as safe as a patch could get. We basically create unnamed event objects, which is how event objects should be created by default, so I think this patch is a very safe change to take on a stable branch, and as Benjamin points out in [comment 62](/show_bug.cgi?id=639885#c62 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"), we should definitely take it.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a2010300_251051)• 14 years ago |

[Attachment #517877](/attachment.cgi?id=517877&action=edit "Fix potential access-after-free v2") -
Attachment is obsolete: true
[Attachment #517877](/attachment.cgi?id=517877&action=edit "Fix potential access-after-free v2") -
Flags: review?(jmuizelaar)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=639885#c64)• 14 years ago |
|  | |

Comment on [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958)
Part 2: Stop using named objects [checkin: [comment 58](/show_bug.cgi?id=639885#c58 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks")]
Asking for approval to take this patch on mozilla-2.0.
[Attachment #517958](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") -
Flags: approval2.0+ → approval2.0?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639885#a2076346_1689)• 14 years ago |

blocking2.0: ? → Macaw
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=639885#c65)• 14 years ago |
|  | |

Comment on [attachment 517958](/attachment.cgi?id=517958 "Part 2: Stop using named objects [checkin: comment 58]") [[details]](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") [[diff]](/attachment.cgi?id=517958&action=diff "Part 2: Stop using named objects [checkin: comment 58]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639885&attachment=517958)
Part 2: Stop using named objects [checkin: [comment 58](/show_bug.cgi?id=639885#c58 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks")]
Approved for the mozilla2.0 repository, a=dveditz for release-drivers
[Attachment #517958](/attachment.cgi?id=517958&action=edit "Part 2: Stop using named objects [checkin: comment 58]") -
Flags: approval2.0? → approval2.0+

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=639885#c66)• 14 years ago |
|  | |

<http://hg.mozilla.org/releases/mozilla-2.0/rev/d4b16b847d92>
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [Joel](/user_profile?user_id=409298) |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=639885#c67)• 14 years ago |
|  | |

Not fixed for me. went away for a week or so. now it's back. Forcing me back to Chrome, opera and safari.
Could someone please change the status or un-dup my bug.

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=639885#c68)• 14 years ago |
|  | |

(In reply to [comment #67](/show_bug.cgi?id=639885#c67 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks"))
> Not fixed for me. went away for a week or so. now it's back. Forcing me back to
> Chrome, opera and safari.
Ca you please go to about:crashes, and paste the contents of that page here?

|  | [Ryan Pertusio](/user_profile?user_id=32277) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=639885#c69)• 14 years ago |
|  | |

Verifying that crash no longer occurs for the following sites: Hulu, Pogo, Blip (which were 3 easy sites to test the crash).
CRASHES with 4.0pre (2011-04-01) (20110401030210)or earlier
NO CRASH with 4.0pre (2011-04-02) (20110402030209)
Good job!

|  | [Joel](/user_profile?user_id=409298) |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=639885#c70)• 14 years ago |
|  | |

No new reports in About:crashes. Ie, it's not leaving a crash report. The only crashes there have the wrong time/date.... It's in the but I lodged that was marked as a dupe (I'm not clever enough to confirm the dupe, Everything on this page goes straight over my head.)
It was fixed in RC2 yet since final release (and I don't think I updated?) it's crashing again.
When it crashes, its really fast, the window just closes (sometime as I type) with no warning and no crash report.
I'm mostly on Facebook and Mafia Wars (with both windows/profiles) when it happens. But it can happen with the Firefox start page as the only tab in two profiles. I don't think it's site related....
about:crashes copy/paste:
Report ID
Date Submitted
bp-84f2e4a9-0e5b-47f9-8faf-9b23021104012/04/20118:41 AM10340c57-8d37-4baf-bb76-ea5d44fac63331/03/20118:16 AM96ca20bc-26d8-4091-9fc5-464d2e65cd555/03/20115:19 PM22e9683e-15df-4426-9f5d-e2cfac2a13a327/01/20114:42 PMc5156629-7bbf-48f8-992b-3b69721ac0392/01/201112:02 PMa2e23d5f-7566-4be2-8381-9ae5538932192/01/20119:28 AMbp-b4cc27c8-d36e-4875-b649-7a0ae210122930/12/201011:22 AMbp-1cfb0957-1991-4e2c-92e1-be444210122727/12/201010:03 PMbp-ad475ca0-4a9d-4237-9500-794d5210122727/12/20109:58 PM9a812b12-70d5-458a-be1c-04b3032884c626/12/20101:57 PM77126794-b2ec-4d92-b538-2724394144ac26/12/201012:19 PMbp-2e0fe8e4-f330-43c7-b01c-fb422210122324/12/201012:34 PMbp-180b52eb-c175-48aa-b4de-c8f6c210122323/12/20108:00 PM
as you can see these crashes go back months, yet I have encountered multiple profile crashes at least daily for the last few weeks (except for a few days between RC2 and final FF4, when it worked fine).... The last one was on 31/3/11 just after 9pm, it was the third in under an hour (I went back to chrome for second profile after that). There should be strings of crash reports 5-10 min apart......
Hope this helps.
You need to [log in](/show_bug.cgi?id=639885&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Bas Schouten (:bas.schouten)](/user_profile?user_id=272464)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_9a64da5a_20250125_051022.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/639343)
* [XML](/show_bug.cgi?ctype=xml&id=639343)

Closed
[Bug 639343](/show_bug.cgi?id=639343)

Opened 14 years ago
Closed 14 years ago

# TM: Crash [@ js::DefaultValue] or "Assertion failure: obj,"

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

TM: Crash [@ js::DefaultValue] or "Assertion failure: obj,"

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |
| status1.9.1 | --- | [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| status1.9.1 |  | unaffected |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: gkw, Assigned: Waldo)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/d26a0ca7ae1134e0e1dbdddf82e28929?d=mm&size=40)  [Waldo](/user_profile?user_id=83595)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [gkw](/user_profile?user_id=132034)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

11 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[590672](/show_bug.cgi?id=590672 "RESOLVED FIXED - treat ArrayBuffer() and SomeArrayType() as (0)"), [630996](/show_bug.cgi?id=630996 "RESOLVED FIXED - A tool for stress testing objects and PIC's")

Dependency [tree](/showdependencytree.cgi?id=639343&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=639343)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[639412](/show_bug.cgi?id=639412 "RESOLVED DUPLICATE - TM/JM: \"Assertion failure: v_ins->isD(),\""), [643234](/show_bug.cgi?id=643234 "RESOLVED DUPLICATE - JM: Crash [@ JSString::isAtomized]")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [sg:critical?][ccbr][fixed-in-tracemonkey])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical?][ccbr][fixed-in-tracemonkey]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [gkw](/user_profile?user_id=132034) | [in-testsuite](#c25 "13 years ago") | + |
| --- | --- | --- |
| [gkw](/user_profile?user_id=132034) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ js::DefaultValue ]](https://crash-stats.mozilla.org/signature/?signature=js%3A%3ADefaultValue)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files, 1 obsolete file)

| [stacks](/attachment.cgi?id=517282)  [14 years ago](#c0)  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)   4.74 KB, text/plain |  | [Details](/attachment.cgi?id=517282&action=edit) |
| --- | --- | --- |
| [Patch for tracing JIT, with test](/attachment.cgi?id=517319)  [14 years ago](#c3)  [Jeff Walden [:Waldo]](/user_profile?user_id=83595)   1.52 KB, patch | gal : [review-](#a94149_310943 "14 years ago") | [Details](/attachment.cgi?id=517319&action=edit) | [Diff](/attachment.cgi?id=517319&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=517319) |
| [Full patch and test](/attachment.cgi?id=520368)  [14 years ago](#c13)  [Jeff Walden [:Waldo]](/user_profile?user_id=83595)   2.54 KB, patch | dvander : [review+](#a1066724_309316 "14 years ago")  dveditz : [approval2.0+](#c23 "14 years ago") | [Details](/attachment.cgi?id=520368&action=edit) | [Diff](/attachment.cgi?id=520368&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=520368) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=639343#c0)• 14 years ago |
|  | |

Attached file
[stacks](attachment.cgi?id=517282)
— [Details](attachment.cgi?id=517282&action=edit)

(Array.prototype.\_\_proto\_\_)[0] = /a/
function f() {
eval("\
(function(){\
for(t in [,0,0,0,0,0,0,0,0,0]) {\
a = new Int8Array;\
print(a[0])\
}\
})\
")()
}
f()
crashes js opt shell on TM changeset ae418087b4da with -j at js::DefaultValue and asserts js debug shell with -j at Assertion failure: obj
Seems to be a null deref but locking s-s just-in-case.
This was found using a combination of jsfunfuzz and jandem's method fuzzer.
autoBisect shows this is probably related to the following changeset:
The first bad revision is:
changeset: 51690:c497469955fa
user: Vladimir Vukicevic
date: Fri Aug 27 12:06:34 2010 -0400
summary: b=590672; treat ArrayBuffer() and SomeArrayType() as (0); r=shaver

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=639343#c1)• 14 years ago |
|  | |

 /\* for out-of-range, do the same thing that the interpreter does, which is return undefined \*/
if ((jsuint) idx >= tarray->length) {
CHECK\_STATUS\_A(guard(false,
w.ltui(idx\_ins, w.ldiConstTypedArrayLength(priv\_ins)),
BRANCH\_EXIT,
/\* abortIfAlwaysExits = \*/true));
v\_ins = w.immiUndefined();
return ARECORD\_CONTINUE;
}
J'accuse!Assignee: general → jwalden+bmoStatus: NEW → ASSIGNEDOS: Mac OS X → AllHardware: x86 → All

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=639343#c2)• 14 years ago |
|  | |

Looks like methodjit might be affected as well, if my guesses at the meaning of this from GetElementIC::attachTypedArray are correct (although very brief testing isn't demonstrating problems, so who knows):
outOfBounds.linkTo(masm.label(), &masm);
masm.loadValueAsComponents(UndefinedValue(), typeReg, objReg);
So. Just to be sure, should it be the case that |new Int8Array()[0]| looks up the prototype chain at |Int8Array.prototype| and at |Object.prototype|? I assume yes, but I could imagine some sort of index-specific algorithm just returning |undefined| here to short-circuit. The typed array spec seems to just say there's an index getter, but I don't believe it says anything about what behavior is for out-of-range indexes. (Or is that implicit in the index-getterness in some way I don't know?)

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=639343#c3)• 14 years ago |
|  | |

Attached patch

[Patch for tracing JIT, with test](attachment.cgi?id=517319&action=diff) (obsolete)
— [Details](attachment.cgi?id=517319&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=517319)

For some reason my build doesn't have typed array ICs enabled, so that's why I can't reproduce the typed array failure, if there is one. I'll get to that soon, or perhaps someone more in-tune with ICs should, but this patch at least fixes the tracer in the meantime. Probably everything should be fixed at once, tho, since I suspect just this would cause failures from the IC stuff not being updated, hence no r? yet.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=639343#c4)• 14 years ago |
|  | |

[Bug 639412](/show_bug.cgi?id=639412 "RESOLVED DUPLICATE - TM/JM: \"Assertion failure: v_ins->isD(),\"") may be related.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=639343#c5)• 14 years ago |
|  | |

(In reply to [comment #3](/show_bug.cgi?id=639343#c3 "VERIFIED FIXED - TM: Crash [@ js::DefaultValue] or \"Assertion failure: obj,\""))
> Created [attachment 517319](/attachment.cgi?id=517319 "Patch for tracing JIT, with test") [[details]](/attachment.cgi?id=517319&action=edit "Patch for tracing JIT, with test") [[diff]](/attachment.cgi?id=517319&action=diff "Patch for tracing JIT, with test") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=517319)
> Patch for tracing JIT, with test
After a quick test, this patch fixes the testcase in this bug as well as the testcases in [bug 639412](/show_bug.cgi?id=639412 "RESOLVED DUPLICATE - TM/JM: \"Assertion failure: v_ins->isD(),\""). I'm not sure if other issues will pop up or not...

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=639343#c6)• 14 years ago |
|  | |

fwiw, the test in [comment #0](/show_bug.cgi?id=639343#c0 "VERIFIED FIXED - TM: Crash [@ js::DefaultValue] or \"Assertion failure: obj,\"") causes an LIR type error in 64-bit debug shell with -j:
Assertion failure: LIR type error (start of writer pipeline): arg 1 of 'orq' is 'immi' which has type int (expected quad): 0
Sounds bad enough to warrant at least .x+ in blocking2.0..blocking2.0: --- → ?

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a94149_310943)• 14 years ago |

[Attachment #517319](/attachment.cgi?id=517319&action=edit "Patch for tracing JIT, with test") -
Flags: review-

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a94263_310943)• 14 years ago |

blocking2.0: ? → ---

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=639343#c8)• 14 years ago |
|  | |

Please renom for .x with a reviewed patch.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=639343#c9)• 14 years ago |
|  | |

Um, Andreas, why'd you r- that if I hadn't even requested review on it? (Not disagreeing with the 2.0-, to be sure.)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=639343#c10)• 14 years ago |
|  | |

Guessing sg:critical given the LIR error. Please clear if that's wrong.Whiteboard: [ccbr] → [sg:critical?][ccbr]

|  | [Andreas Gal :gal](/user_profile?user_id=310943) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=639343#c11)• 14 years ago |
|  | |

Hey waldo, just wanted to make sure that you know that I don't think its a good fix. An r- was quicker than typing that up, I was sitting in the triage meeting trying to keep up. Sorry. Happy to discuss a fix.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=639343#c12)• 14 years ago |
|  | |

With the patch on the 32-bit buildmonkey-right system:
~/jwalden/tracemonkey/js/src$ dbg/js -j
js> var ta = new Uint8Array(0)
js> Object.prototype[0] = Math
Math
js> for (var i = 0; i < 25; i++) assertEq(ta[0], Math)
js> options()
"anonfunfix,tracejit"
js> options("methodjit")
"anonfunfix,tracejit"
js> for (var i = 0; i < 25; i++) assertEq(ta[0], Math)
typein:6: Error: Assertion failed: got (void 0), expected Math
So I was definitely right, the tracer and methodjit both need to be fixed.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=639343#c13)• 14 years ago |
|  | |

Attached patch

[Full patch and test](attachment.cgi?id=520368&action=diff)
— [Details](attachment.cgi?id=520368&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=520368)

[Attachment #517319](/attachment.cgi?id=517319&action=edit "Patch for tracing JIT, with test") -
Attachment is obsolete: true
[Attachment #520368](/attachment.cgi?id=520368&action=edit "Full patch and test") -
Flags: review?(dvander)

|  | [David Anderson [:dvander] - inactive, e-mail if emergency](/user_profile?user_id=309316) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=639343#c14)• 14 years ago |
|  | |

Hrm, what exactly is supposed to happen if you read an out-of-bounds typed array index? I vaguely recall someone saying that it should return undefined and that typed arrays are pretty much magic objects that don't behave like the ES5 spec would want. And the only reason I recall that is because, that tracer code was added to make some typed array demo fast.
That was [bug 550351](/show_bug.cgi?id=550351 "RESOLVED FIXED - don't abort recording when accessing out of range typed array element"), but I don't see anything about performance there, so I don't know. The patch looks good anyway.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=639343#c15)• 14 years ago |
|  | |

I think ES5 gives you enough rope to implement any semantics you want here, actually.
But no, I don't particularly know what those semantics should be. It's worth noting that at least Chrome implements what this patch does, and what interpreter currently does, of looking for out-of-bounds indexes up the prototype chain.

|  | [David Anderson [:dvander] - inactive, e-mail if emergency](/user_profile?user_id=309316) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a1066724_309316)• 14 years ago |

[Attachment #520368](/attachment.cgi?id=520368&action=edit "Full patch and test") -
Flags: review?(dvander) → review+

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=639343#c17)• 14 years ago |
|  | |

<http://hg.mozilla.org/tracemonkey/rev/5cbe7fd88614>Whiteboard: [sg:critical?][ccbr] → [sg:critical?][ccbr][fixed-in-tracemonkey]

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=639343#c18)• 14 years ago |
|  | |

Comment on [attachment 520368](/attachment.cgi?id=520368 "Full patch and test") [[details]](/attachment.cgi?id=520368&action=edit "Full patch and test") [[diff]](/attachment.cgi?id=520368&action=diff "Full patch and test") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=520368)
Full patch and test
It's LIR/tracer typing error, that's bad. And since there's a methodjit component here, it is at least conceivable that methodjit might rely on the type of the value returned when getting this property. (I don't know if there is any such dependence.) So it's off into the weeds, in ways which might be security hazards. Clear point-release material in my book.
[Attachment #520368](/attachment.cgi?id=520368&action=edit "Full patch and test") -
Flags: approval2.0?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a2025619_1689)• 14 years ago |

blocking2.0: --- → ?
[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected)
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a2069204_132034)• 14 years ago |

blocking-fx: --- → ?

|  | [Chris Leary [:cdleary] (not checking bugmail)](/user_profile?user_id=374575) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=639343#c19)• 14 years ago |
|  | |

<http://hg.mozilla.org/mozilla-central/rev/5cbe7fd88614>Status: ASSIGNED → RESOLVEDClosed: 14 years agoResolution: --- → FIXED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=639343#c20)• 14 years ago |
|  | |

Want in "macaw" but not approving yet until we get some verification of the trunk fix.blocking2.0: ? → Macaw
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=639343#c21)• 14 years ago |
|  | |

The patch has tests. They failed before the patch, they pass after. Do you need more verification than that? And if so, what kind of verification?

|  | [David Anderson [:dvander] - inactive, e-mail if emergency](/user_profile?user_id=309316) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=639343#c22)• 14 years ago |
|  | |

(In reply to [comment #20](/show_bug.cgi?id=639343#c20 "VERIFIED FIXED - TM: Crash [@ js::DefaultValue] or \"Assertion failure: obj,\""))
> Want in "macaw" but not approving yet until we get some verification of the
> trunk fix.
The patch looks safe. Does verification refer to bake time?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=639343#c23)• 14 years ago |
|  | |

Comment on [attachment 520368](/attachment.cgi?id=520368 "Full patch and test") [[details]](/attachment.cgi?id=520368&action=edit "Full patch and test") [[diff]](/attachment.cgi?id=520368&action=diff "Full patch and test") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639343&attachment=520368)
Full patch and test
Approved for the mozilla2.0 repository, a=dveditz for release-drivers
[Attachment #520368](/attachment.cgi?id=520368&action=edit "Full patch and test") -
Flags: approval2.0? → approval2.0+

|  | [LegNeato](/user_profile?user_id=482154) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=639343#c24)• 14 years ago |
|  | |

Transplanted from mozilla-central onto releases/mozilla2.0:
<http://hg.mozilla.org/releases/mozilla-2.0/rev/7c42835e2341>blocking-fx: ? → ---
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a6870899_1689)• 14 years ago |

Group: core-security

|  | [Nobody; OK to take it and work on it](/user_profile?user_id=1) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639343#a8550124_1)• 14 years ago |

Crash Signature: [@ js::DefaultValue]

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=639343#c25)• 13 years ago |
|  | |

A test was landed.
-> VERIFIED.Status: RESOLVED → VERIFIEDFlags: in-testsuite+
You need to [log in](/show_bug.cgi?id=639343&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_4089d6ee_20250126_061212.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Sat Jan 25 2025 22:12:11 PST

* **Bug ID:**
  642717,
  639343,
  639728,
  643649,
  641388,
  601102,
  639885

---

| [ID](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=bug_id%20DESC&query_based_on=) | [Type](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=bug_type%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Summary](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=short_desc%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Product](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=product%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Comp](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=component%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Assignee▲](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=assigned_to%20DESC%2Cbug_status%2Cpriority%2Cbug_id&query_based_on=) | [Status▲](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=bug_status%20DESC%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Resolution](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=resolution%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) | [Updated](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&order=changeddate%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [642717](/show_bug.cgi?id=642717 "RESOLVED FIXED - Refresh driver needs to hold strong refs to |targets| in Notify") |  | [Refresh driver needs to hold strong refs to |targets| in Notify](/show_bug.cgi?id=642717) | Core | Layout | bzbarsky | RESO | FIXE | 2015-10-16 |
| [639885](/show_bug.cgi?id=639885 "RESOLVED FIXED - Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks") |  | [Crash [@ memmove ] via mozilla::layers::ReadbackManagerD3D10::ProcessTasks](/show_bug.cgi?id=639885) | Core | Graphics | bas | RESO | FIXE | 2013-12-27 |
| [639728](/show_bug.cgi?id=639728 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC") |  | [Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC](/show_bug.cgi?id=639728) | Core | SVG | dholbert | RESO | FIXE | 2011-07-06 |
| [641388](/show_bug.cgi?id=641388 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor") |  | [Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor](/show_bug.cgi?id=641388) | Core | General | dholbert | RESO | FIXE | 2013-05-18 |
| [643649](/show_bug.cgi?id=643649 "RESOLVED FIXED - Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes") |  | [Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes](/show_bug.cgi?id=643649) | Core | Graphics | jd.bugzilla | RESO | FIXE | 2011-05-24 |
| [601102](/show_bug.cgi?id=601102 "RESOLVED FIXED - Crash in exn_trace [@ js::Shape::trace(JSTracer*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below") |  | [Crash in exn\_trace [@ js::Shape::trace(JSTracer\*) ][@ js::Shape::trace ] mainly with TestPilot 1.1 and below](/show_bug.cgi?id=601102) | Core | JavaScript Engine | mail | RESO | FIXE | 2011-06-13 |
| [639343](/show_bug.cgi?id=639343 "VERIFIED FIXED - TM: Crash [@ js::DefaultValue] or \"Assertion failure: obj,\"") |  | [TM: Crash [@ js::DefaultValue] or "Assertion failure: obj,"](/show_bug.cgi?id=639343) | Core | JavaScript Engine | jwalden | VERI | FIXE | 2012-03-23 |

7 bugs found.

|  |  | [REST](/rest/bug?include_fields=id,summary,status&bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885 "Query as a REST API request") | [CSV](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&ctype=csv&human=1) | [Feed](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&title=Bug%20List&ctype=atom) | [iCalendar](/buglist.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&ctype=ics)  [Change Columns](/colchange.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced&query_based_on=) | [Edit Search](/query.cgi?bug_id=642717%2C639343%2C639728%2C643649%2C641388%2C601102%2C639885&query_format=advanced) |  | as |
| --- | --- | --- | --- | --- | --- |

[File
a new bug
in the "Core" product](/enter_bug.cgi?product=Core)



=== Content from bugzilla.mozilla.org_8d970e1b_20250125_051029.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/643649)
* [XML](/show_bug.cgi?ctype=xml&id=643649)

Closed
[Bug 643649](/show_bug.cgi?id=643649)

Opened 14 years ago
Closed 14 years ago

# Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes

## Categories

### (Core :: Graphics, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics#Graphics)

Graphics
▾

Core :: Graphics
Mapping of cross platform rendering interfaces to various 2D graphics APIs
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |
| status1.9.1 | --- | [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| status1.9.1 |  | unaffected |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: mwu, Assigned: jtd)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/574c3df3e7f7c790e412292ab6a070fd?d=mm&size=40)  [jtd](/user_profile?user_id=280585)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/078be4e327f31b60d8240979565af85f?d=mm&size=40)  [mwu](/user_profile?user_id=246518)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/17436ade8da1b23d42b3df05b9c4fc77?d=mm&size=40)  [bhood](/user_profile?user_id=697075)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

6 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Whiteboard: [sg:moderate])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

---

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:moderate]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 1 obsolete file)

| [Patch (v1)](/attachment.cgi?id=522252)  [14 years ago](#c4)  [(no longer active)](/user_profile?user_id=251051)   5.32 KB, patch | jtd : [review-](#a546151_280585 "14 years ago") | [Details](/attachment.cgi?id=522252&action=edit) | [Diff](/attachment.cgi?id=522252&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522252) |
| --- | --- | --- |
| [patch, use array length instead of sizeof](/attachment.cgi?id=522317)  [14 years ago](#c7)  [John Daggett (:jtd)](/user_profile?user_id=280585)   1.14 KB, patch | joe : [review+](#c13 "14 years ago")  dveditz : [approval2.0+](#c15 "14 years ago") | [Details](/attachment.cgi?id=522317&action=edit) | [Diff](/attachment.cgi?id=522317&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522317) |
| [process monitor font substitutes profiling, patch](/attachment.cgi?id=522320)  [14 years ago](#c8)  [John Daggett (:jtd)](/user_profile?user_id=280585)   25.58 KB, text/plain |  | [Details](/attachment.cgi?id=522320&action=edit) |
| [process monitor font substitutes profiling, trunk](/attachment.cgi?id=522321)  [14 years ago](#c9)  [John Daggett (:jtd)](/user_profile?user_id=280585)   9.72 KB, text/plain |  | [Details](/attachment.cgi?id=522321&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Michael Wu [:mwu]](/user_profile?user_id=246518)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=643649#c0)• 14 years ago |
|  | |

<http://hg.mozilla.org/mozilla-central/file/a7346f028fd6/gfx/thebes/gfxGDIFontList.cpp#l629>
lenAlias is passed to RegEnumValueW to specify the length of aliasName. RegEnumValueW expects the length in characters, not bytes AIUI, so using sizeof makes us say the buffer is twice as big as it actually is.
From MSDN [http://msdn.microsoft.com/en-us/library/ms724865%28v=vs.85%29.aspx](http://msdn.microsoft.com/en-us/library/ms724865%28v%3Dvs.85%29.aspx) :
lpcchValueName [in, out]
A pointer to a variable that specifies the size of the buffer pointed to by the lpValueName parameter, in characters.
Not sure if overrunning this buffer is an actual security problem so I'm marking it as one.

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=643649#c1)• 14 years ago |
|  | |

The same issue is present in the gfxDWriteFontList.cpp version of GetFontSubstitutes, too.
To actually encounter an overrun here would require a the registry to contain a FontSubstitutes name of at least 512 characters, which seems pretty far-fetched; and if a potential attacker is able to insert such malicious entries into the registry, I suspect things are already in a bad state.
Nevertheless, this does look like a bug and we should definitely fix it!

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=643649#c2)• 14 years ago |
|  | |

On the assumption that no one's stuffing malicious font names into the registry we're probably OK. We don't save names we find in downloadable fonts, right? In general, though, having windows calls overwrite buffers is exploitable.Whiteboard: [sg:moderate]

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=643649#c3)• 14 years ago |
|  | |

A better solution would be switching to the nsIWindowsRegKey API. Calling the registry APIs directly is a bad choice, because of bugs like this.Assignee: nobody → ehsan

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=643649#c4)• 14 years ago |
|  | |

Attached patch

[Patch (v1)](attachment.cgi?id=522252&action=diff) (obsolete)
— [Details](attachment.cgi?id=522252&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522252)

[Attachment #522252](/attachment.cgi?id=522252&action=edit "Patch (v1)") -
Flags: review?(joe)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=643649#c5)• 14 years ago |
|  | |

<http://tbpl.mozilla.org/?tree=MozillaTry&rev=8aae8f26aae7>

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=643649#c6)• 14 years ago |
|  | |

Try run was successful.

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=643649#c7)• 14 years ago |
|  | |

Attached patch

[patch, use array length instead of sizeof](attachment.cgi?id=522317&action=diff)
— [Details](attachment.cgi?id=522317&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522317)

simple fix for my screwup
[Attachment #522317](/attachment.cgi?id=522317&action=edit "patch, use array length instead of sizeof") -
Flags: review?(joe)

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=643649#c8)• 14 years ago |
|  | |

Attached file
[process monitor font substitutes profiling, patch](attachment.cgi?id=522320)
— [Details](attachment.cgi?id=522320&action=edit)

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=643649#a546056_280585)• 14 years ago |

[Attachment #522320](/attachment.cgi?id=522320&action=edit "process monitor font substitutes profiling, patch") -
Attachment description: process monitor font substitutes profiling, trunk → process monitor font substitutes profiling, patch

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=643649#c9)• 14 years ago |
|  | |

Attached file
[process monitor font substitutes profiling, trunk](attachment.cgi?id=522321)
— [Details](attachment.cgi?id=522321&action=edit)

(In reply to [comment #3](/show_bug.cgi?id=643649#c3 "RESOLVED FIXED - Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes"))
> A better solution would be switching to the nsIWindowsRegKey API. Calling the
> registry APIs directly is a bad choice, because of bugs like this.
In fact, I would argue precisely the opposite because using an API like
nsIWindowsRegKey obscures how the underlying APIs function and wastes time
because the code isn't structured optimally. If you look back at the
previous versions of this code you'll see that it was using
nsIWindowsRegKey. I rewrote the code to not use it because when profiling
registry calls on cold startup, the previous code was calling RegQueryValue
many more times than is necessary. Your build reflects that inefficiency,
it takes 1.3ms on cold startup to run through this loop as opposed to 0.5ms
with the current trunk code. The MSDN docs explicitly state "While using
RegEnumValue, an application should not call any registry functions that
might change the key being queried."
Attached are the Process Manager event logs for trunk vs. the try build
with nsIWindowsRegKey. Note all the extra RegQueryValue calls in the try
build case.

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=643649#a546151_280585)• 14 years ago |

[Attachment #522252](/attachment.cgi?id=522252&action=edit "Patch (v1)") -
Flags: review-

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=643649#c10)• 14 years ago |
|  | |

(In reply to [comment #2](/show_bug.cgi?id=643649#c2 "RESOLVED FIXED - Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes"))
> On the assumption that no one's stuffing malicious font names into the registry
> we're probably OK. We don't save names we find in downloadable fonts, right? In
> general, though, having windows calls overwrite buffers is exploitable.
This code is reading from specific registry entries, downloadable fonts have no impact at all on this code.

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=643649#c11)• 14 years ago |
|  | |

> Attached are the Process Manager event logs...
s/Process Manager/Process Monitor/
<http://technet.microsoft.com/en-us/sysinternals/bb896645>

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=643649#c12)• 14 years ago |
|  | |

Comment on [attachment 522252](/attachment.cgi?id=522252 "Patch (v1)") [[details]](/attachment.cgi?id=522252&action=edit "Patch (v1)") [[diff]](/attachment.cgi?id=522252&action=diff "Patch (v1)") [[review]](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522252)
Patch (v1)
OK, fair enough.
[Attachment #522252](/attachment.cgi?id=522252&action=edit "Patch (v1)") -
Attachment is obsolete: true
[Attachment #522252](/attachment.cgi?id=522252&action=edit "Patch (v1)") -
Flags: review?(joe)

|  | [(no longer active)](/user_profile?user_id=251051) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=643649#a587211_251051)• 14 years ago |

Assignee: ehsan → jdaggett

|  | [Joe Drew (not getting mail)](/user_profile?user_id=94) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=643649#c13)• 14 years ago |
|  | |

Comment on [attachment 522317](/attachment.cgi?id=522317 "patch, use array length instead of sizeof") [[details]](/attachment.cgi?id=522317&action=edit "patch, use array length instead of sizeof") [[diff]](/attachment.cgi?id=522317&action=diff "patch, use array length instead of sizeof") [[review]](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522317)
patch, use array length instead of sizeof
diff -U 8 would have been better :)
[Attachment #522317](/attachment.cgi?id=522317&action=edit "patch, use array length instead of sizeof") -
Flags: review?(joe) → review+

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=643649#c14)• 14 years ago |
|  | |

Landed on trunk
<http://hg.mozilla.org/mozilla-central/rev/5e69b22218e9>Status: NEW → RESOLVEDClosed: 14 years agoResolution: --- → FIXED

|  | [John Daggett (:jtd)](/user_profile?user_id=280585)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=643649#a614839_280585)• 14 years ago |

blocking2.0: --- → ?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=643649#a1531043_1689)• 14 years ago |

blocking2.0: ? → Macaw+
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=643649#c15)• 14 years ago |
|  | |

Comment on [attachment 522317](/attachment.cgi?id=522317 "patch, use array length instead of sizeof") [[details]](/attachment.cgi?id=522317&action=edit "patch, use array length instead of sizeof") [[diff]](/attachment.cgi?id=522317&action=diff "patch, use array length instead of sizeof") [[review]](/page.cgi?id=splinter.html&ignore=&bug=643649&attachment=522317)
patch, use array length instead of sizeof
Approved for the mozilla2.0 repository, a=dveditz for release-drivers
Please land this for the Tumucumaque Macaw release.
[Attachment #522317](/attachment.cgi?id=522317&action=edit "patch, use array length instead of sizeof") -
Flags: approval2.0+

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=643649#c16)• 14 years ago |
|  | |

I pushed this to mozilla-2.0:
<http://hg.mozilla.org/releases/mozilla-2.0/rev/087fc58e6622>
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [LegNeato](/user_profile?user_id=482154) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=643649#c17)• 14 years ago |
|  | |

Marking as unaffected for branches as the file doesn't exist and it doesn't look to appear elsewhere. Please double check.
[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected)
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=643649#c18)• 14 years ago |
|  | |

Correct; the equivalent code used to be in gfxWindowsPlatform.cpp, but this issue was not present in the old (1.9.2 and earlier) version. It was rewritten for 2.0 (see [comment #9](/show_bug.cgi?id=643649#c9 "RESOLVED FIXED - Incorrect length passed to RegEnumValueW for value name buffer size in gfxGDIFontList::GetFontSubstitutes")) and the bug dates from then.OS: Windows XP → All

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=643649#a5551122_1689)• 14 years ago |

Group: core-security
You need to [log in](/show_bug.cgi?id=643649&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [(no longer active)](/user_profile?user_id=251051)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_226ba026_20250125_051026.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/641388)
* [XML](/show_bug.cgi?ctype=xml&id=641388)

Closed
[Bug 641388](/show_bug.cgi?id=641388)

Opened 14 years ago
Closed 14 years ago

# Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor

## Categories

### (Core :: General, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=General#General)

General
▾

Core :: General
For bugs in Core which do not fit into other more specific Core components
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=General&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=General&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=General)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |
| status1.9.1 | --- | [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| status1.9.1 |  | unaffected |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: nils, Assigned: dholbert)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/cd9b85b2e112bd7941b21ad03f42604e?d=mm&size=40)  [dholbert](/user_profile?user_id=278074)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/1ac8e01cc88bca015e51fbd49a0b2df5?d=mm&size=40)  [nils](/user_profile?user_id=344130)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/819fa8210bf0480993fed2d597565a52?d=mm&size=40)  [plawless](/user_profile?user_id=628136)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

9 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[590425](/show_bug.cgi?id=590425 "VERIFIED FIXED - \"ASSERTION: Starting sampling but controller is paused\" with <svg:animate> in removed iframe"), [647044](/show_bug.cgi?id=647044 "RESOLVED WORKSFORME - Firefox 4.0 Crash Report [@ nsRefreshDriver::Notify(nsITimer*) ] (Turbo Tax online?)")

Dependency [tree](/showdependencytree.cgi?id=641388&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=641388)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [sg:critical?])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical?]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [MatsPalmgren\_bugz](/user_profile?user_id=5168) | [in-testsuite](#c32 "14 years ago") | + |
| --- | --- | --- |
| [MatsPalmgren\_bugz](/user_profile?user_id=5168) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 1 obsolete file)

| [testcase (crashes browser)](/attachment.cgi?id=519052)  [14 years ago](#c1)  [Nils](/user_profile?user_id=344130)   4.54 KB, text/html |  | [Details](/attachment.cgi?id=519052&action=edit) |
| --- | --- | --- |
| [second testcase (crashes browser)](/attachment.cgi?id=519054)  [14 years ago](#c2)  [Nils](/user_profile?user_id=344130)   3.52 KB, text/html |  | [Details](/attachment.cgi?id=519054&action=edit) |
| [fix v1](/attachment.cgi?id=522464)  [14 years ago](#c13)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   996 bytes, patch |  | [Details](/attachment.cgi?id=522464&action=edit) | [Diff](/attachment.cgi?id=522464&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522464) |
| [fix v2: create wrapper MaybeStartSampling](/attachment.cgi?id=522768)  [14 years ago](#c16)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   4.58 KB, patch | bzbarsky : [review+](#c18 "14 years ago")  dveditz : [approval2.0+](#c29 "14 years ago") | [Details](/attachment.cgi?id=522768&action=edit) | [Diff](/attachment.cgi?id=522768&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522768) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Nils](/user_profile?user_id=344130)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=641388#c0)• 14 years ago |
|  | |

User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0) Gecko/20100101 Firefox/4.0
Build Identifier: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0) Gecko/20100101 Firefox/4.0
Description:
The attached testcase has been reduced from a very large testcase (~3 Megs). The resulting testcase is still quite large (~80 lines of JavaScript), however further reduction made were not possible or made it very hard to reproduce. The reason for
the crash is not obvious from the testcase.
Following assertion can be observed on a Linux debug build:
ASSERTION: Dying in the middle of our own update?: mUpdateCount == 0, file ../../../layout/base/nsCSSFrameConstructor.h, line 89
Affected Versions:
Firefox 4.0 RC1
Testcase:
The testcase is attached as an HTML file. It will crash the browser on opening after several reloads.
Testcase Notes:
The testcase implements two function to improve the reproducability of the testcase. gc() triggers garbage collection. It requires Jesse's quitter extension (<https://www.squarefree.com/extensions/quitter.xpi>).
fill() works similar to a heap spray and fills the memory with a byte pattern.
Stack Backtrace:
Following crash has been observed on Windows. This indicates that code exection is possible. Similar behaviour has been seen on linux as well.
Windows:
(e5c.1360): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
xul!nsRefreshDriver::Notify+0x5b9:
625fa199 8b08 mov ecx,dword ptr [eax] ds:002b:fafafafb=????????
625fa19b 57 push edi
625fa19c ffd1 call ecx
xul!nsRefreshDriver::Notify+0x5b9
xul!nsTimerImpl::Fire+0x103
xul!nsTimerEvent::Run+0x20
xul!nsThread::ProcessNextEvent+0x2d7
xul!mozilla::ipc::MessagePump::Run+0x6e
xul!MessageLoop::RunInternal+0x11
xul!MessageLoop::RunHandler+0x1d
nspr4!PR\_GetThreadPrivate+0x20
xul!nsBaseAppShell::Run+0x34
xul!nsAppShell::Run+0x42
xul!nsAppStartup::Run+0x1e
xul!XRE\_main+0xdec
firefox!wmain+0x34c
firefox!\_\_tmainCRTStartup+0x152
kernel32!BaseThreadInitThunk+0xe
ntdll32!\_\_RtlUserThreadStart+0x70
ntdll32!\_RtlUserThreadStart+0x1b
VulnDev reference : vd11002
reported by nils of vulndev ltd.
Reproducible: Always

|  | [Nils](/user_profile?user_id=344130)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=641388#c1)• 14 years ago |
|  | |

Attached file
[testcase (crashes browser)](attachment.cgi?id=519052)
— [Details](attachment.cgi?id=519052&action=edit)

|  | [Nils](/user_profile?user_id=344130)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=641388#c2)• 14 years ago |
|  | |

Attached file
[second testcase (crashes browser)](attachment.cgi?id=519054)
— [Details](attachment.cgi?id=519054&action=edit)

This testcase looks quite different from the first testcase and it does not trigger the same assertion in a debug build. However it triggers the same crash (stack backtrace) on windows.
It still might be a separate issue, hard to tell until we know more about the reasons for the crashes.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=641388#c3)• 14 years ago |
|  | |

With the second testcase, I get an abort when a refresh driver is destroyed before its observers have been unregistered.
The observer that's still around is an nsSMILTimeContainer.
The testcase does use some <svg:animate> stuff.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=641388#c4)• 14 years ago |
|  | |

To be clear, that abort is a debug abort due to an NS\_ABORT\_IF\_FALSE. But it indicates that something is not unregistering correctly here.
For the first testcase, I don't see why mUpdateCount is 1 there. The stack shows us removing an element which has an iframe as a descendant from the DOM. The frame constructor with mUpdateCount == 1 is the frame constructor for that iframe's document.
And then eventually I do crash when reloading the page, because one of the refresh observers in the refresh driver is a dead pointer....

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=641388#c5)• 14 years ago |
|  | |

Note that the mUpdateCount being nonzero is pretty weird, since it's maintaned by stack objects.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=641388#c6)• 14 years ago |
|  | |

(In reply to [comment #3](/show_bug.cgi?id=641388#c3 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor"))
> With the second testcase, I get an abort when a refresh driver is destroyed
> before its observers have been unregistered.
[...]
> that abort is a debug abort due to an NS\_ABORT\_IF\_FALSE.
With both attached testcases, my debug build crashes about 10 seconds after loading. It's a real crash -- not an abort -- in both cases. (I did also see one instance of the abort that bz mentioned, though, when I loaded the second testcase and then reloaded a few times.)
The crashes are from trying to create a new nsRefPtr, which calls the virtual function "AddRef", on a nsARefreshObserver\* whose vtable pointer is garbage:
> #5 0x00007f097cdcdb9d in nsRefPtr<nsARefreshObserver>::nsRefPtr (this=0x7fff6692d1b0, aRawPtr=0x7f09613867e0) at nsAutoPtr.h:993
> (gdb) p \*mRawPtr
> $2 = {
> \_vptr.nsARefreshObserver = 0x5a5a5a5a5a5a5a5a
> }
This is scary - flagging as [sg:critical?]Status: UNCONFIRMED → NEWEver confirmed: trueHardware: x86 → AllWhiteboard: [sg:critical?]Version: unspecified → Trunk

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=641388#c7)• 14 years ago |
|  | |

I don't have a 1.9.2 build handy, but I think it's reasonable to assume this is a regression, since the crash seems to depend on SMIL which we didn't have in 1.9.2Keywords: [assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)Summary: Crash in nsRefreshDriver::Notify with assertition in CSSFrameConstructor → Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=641388#c8)• 14 years ago |
|  | |

Daniel, your crash sounds about the same as what I saw at the end of [comment 4](/show_bug.cgi?id=641388#c4 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor").
I tried using gdb to dump out the stacks to all the nsCSSFrameConstructor::BeginUpdate calls, hoping that this would catch the errant call for me, but the bug doesn't show up if I do that. Presumably because it makes things run too slow and the SMIL finishes "too early" or something?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=641388#c9)• 14 years ago |
|  | |

Guessing at an assignee if SMIL is involved?Assignee: nobody → dholbert

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=641388#c10)• 14 years ago |
|  | |

Sure, I can take this.Status: NEW → ASSIGNED

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=641388#c11)• 14 years ago |
|  | |

So at least in the second case, what's happening is this:
1) Our nsSMILAnimationController gets a call to 'NotifyRefreshDriverCreated', and it registers as a refresh-observer (via StartSampling())
2) Our nsSMILAnimationController gets a new time-container child, which gets us to nsSMILAnimationController::AddChild. This takes the branch that sets
> mDeferredStartSampling = PR\_TRUE;
(The idea there is that we don't have any registered animations, so we're trying to hold off on actively sampling until we get some. However, unbeknownst to us, we've actually already called StartSampling, in (1) above...)
3) When the document gets torn down, our nsSMILAnimationController gets a call to "NotifyRefreshDriverDestroying", but that call does nothing, because 'mDeferredStartSampling' is set. So we never unregister as a refresh observer.
This means we the nsRefreshDriver stays alive longer than our animation controller does, and so it later ends up Notify()ing us after our animation controller is already destroyed.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=641388#c12)• 14 years ago |
|  | |

My first instinct is that we want to copy the
> if (mAnimationElementTable.Count())
check in nsSMILAnimationController::AddChild() over to NotifyRefreshDriverCreated(). That should keep us from registering as a Refresh Observer in part (1) of [comment 11](/show_bug.cgi?id=641388#c11 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor"). (We don't want to be a refresh observer at that point, if this proposed check fails, because we don't have any registered animations yet.)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=641388#c13)• 14 years ago |
|  | |

Attached patch

[fix v1](attachment.cgi?id=522464&action=diff) (obsolete)
— [Details](attachment.cgi?id=522464&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522464)

This patch makes the "StartSampling" call in nsSMILAnimationController::NotifyRefreshDriverCreated consistent with all our other calls to "StartSampling". The idea is to only \*actually\* start sampling if we have registered animation elements -- and if we don't, we defer starting sampling until such an element is added.
Without the patch, my debug build (w/ jesse's dom-fuzz-lite) crashes within 10 seconds after loading either attached testcase.
With the patch, I can't get either testcase to crash. (I do still see the assertion from [comment 0](/show_bug.cgi?id=641388#c0 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor") in the first testcase, though -- I think that might be unrelated.)
I'm running this through mochitests + reftests, and then will request review.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=641388#c14)• 14 years ago |
|  | |

Comment on [attachment 522464](/attachment.cgi?id=522464 "fix v1") [[details]](/attachment.cgi?id=522464&action=edit "fix v1") [[diff]](/attachment.cgi?id=522464&action=diff "fix v1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522464)
fix v1
Passed SVG + SMIL reftests & mochitests. Requesting review.
[Attachment #522464](/attachment.cgi?id=522464&action=edit "fix v1") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=641388#c15)• 14 years ago |
|  | |

Comment on [attachment 522464](/attachment.cgi?id=522464 "fix v1") [[details]](/attachment.cgi?id=522464&action=edit "fix v1") [[diff]](/attachment.cgi?id=522464&action=diff "fix v1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522464)
fix v1
Is there a reason not to push this logic down into StartSampling, since now every callsite has it?

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=641388#c16)• 14 years ago |
|  | |

Attached patch

[fix v2: create wrapper MaybeStartSampling](attachment.cgi?id=522768&action=diff)
— [Details](attachment.cgi?id=522768&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522768)

Good call. This patch shifts that logic into a wrapper function, actually, which performs the check & then the actual StartSampling call.
We need to keep one 'raw' StartSampling call, though -- that's why I didn't push the logic directly into StartSampling as you'd suggested. We need to directly call StartSampling (and clear mDeferredStartSampling) in the one place where we say "ok, actually start sampling now" -- in nsSMILAnimationController::RegisterAnimationElement. (That's the place where we stop deferring, if we were deferring.)
So now, with this patch, RegisterAnimationElement and MaybeStartSampling are the only methods that call StartSampling. Everywhere else uses MaybeStartSampling.
[Attachment #522464](/attachment.cgi?id=522464&action=edit "fix v1") -
Attachment is obsolete: true
[Attachment #522464](/attachment.cgi?id=522464&action=edit "fix v1") -
Flags: review?(bzbarsky)
[Attachment #522768](/attachment.cgi?id=522768&action=edit "fix v2: create wrapper MaybeStartSampling") -
Flags: review?(bzbarsky)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=641388#c17)• 14 years ago |
|  | |

> nsSMILAnimationController::RegisterAnimationElement
So say RegisterAnimationElement looked like this:
mDeferredStartSampling = PR\_FALSE;
if (mChildContainerTable.Count()) {
// mAnimationElementTable was empty, but now we've added its 1st element
MaybeStartSampling(GetRefreshDriverForDoc(mDocument));
}
We'd land in MaybeStartSampling. mDeferredStartSampling is false, so we don't take the early return. All of the above code is after a mAnimationElementTable.PutEntry call, so I'd think mAnimationElementTable.Count() is nonzero, and MaybeStartSampling calls StartSampling. I agree that it may be conceptually cleaner to have the separate MaybeStartSampling, and that we'd have an extra pair of branches in the above code, but the behavior would be the same. Up to you whether you want to keep the MaybeStartSampling function.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=641388#c18)• 14 years ago |
|  | |

Comment on [attachment 522768](/attachment.cgi?id=522768 "fix v2: create wrapper MaybeStartSampling") [[details]](/attachment.cgi?id=522768&action=edit "fix v2: create wrapper MaybeStartSampling") [[diff]](/attachment.cgi?id=522768&action=diff "fix v2: create wrapper MaybeStartSampling") [[review]](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522768)
fix v2: create wrapper MaybeStartSampling
r=me with the above caveat.
[Attachment #522768](/attachment.cgi?id=522768&action=edit "fix v2: create wrapper MaybeStartSampling") -
Flags: review?(bzbarsky) → review+

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=641388#c19)• 14 years ago |
|  | |

(In reply to [comment #17](/show_bug.cgi?id=641388#c17 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor"))
> I agree that it may be conceptually cleaner to have the
> separate MaybeStartSampling, and that we'd have an extra pair of branches in
> the above code, but the behavior would be the same.
Mm, true -- so we could effectively merge MaybeStartSampling into StartSampling and just call that function everywhere, and still get the same behavior as in the attached patch.
Still, I think I like the conceptual separation (& I'd prefer to avoid adding unnecessary checks to RegisterAnimationElement), so I think I'd opt for keeping MaybeStartSampling & StartSampling separate, the way they are in the attached patch.
Thanks for the review!

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=641388#a1378270_278074)• 14 years ago |

Blocks: [590425](/show_bug.cgi?id=590425 "VERIFIED FIXED - \"ASSERTION: Starting sampling but controller is paused\" with <svg:animate> in removed iframe")

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=641388#a1626860_20209)• 14 years ago |

Blocks: [647044](/show_bug.cgi?id=647044 "RESOLVED WORKSFORME - Firefox 4.0 Crash Report [@ nsRefreshDriver::Notify(nsITimer*) ] (Turbo Tax online?)")

|  | [chris hofmann](/user_profile?user_id=2687) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=641388#c20)• 14 years ago |
|  | |

if this fixes 647044 as expected we should try and get it out before US tax season if possible.blocking2.0: --- → ?

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=641388#c21)• 14 years ago |
|  | |

Running it through TryServer right now.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=641388#c22)• 14 years ago |
|  | |

TryServer liked it. Pushed to m-c:
<http://hg.mozilla.org/mozilla-central/rev/b71e50bf9afc>Status: ASSIGNED → RESOLVEDClosed: 14 years agoFlags: in-testsuite?Resolution: --- → FIXED

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=641388#a1636169_278074)• 14 years ago |

[Attachment #522768](/attachment.cgi?id=522768&action=edit "fix v2: create wrapper MaybeStartSampling") -
Flags: approval2.0?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=641388#c23)• 14 years ago |
|  | |

(In reply to [comment #20](/show_bug.cgi?id=641388#c20 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor"))
> if this fixes 647044 as expected we should try and get it out before US tax
> season if possible.
We think TurboTax is using SMIL? Really?
[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected)
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=641388#c24)• 14 years ago |
|  | |

It's feasible that they might be using SMIL-animated SVG for a throbber between steps or something...

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=641388#c25)• 14 years ago |
|  | |

Probably not, though. I just clicked through a the first part of a "Try It Out" TurboTax session, and it seems to use a .gif throbber and a lot of Flash. I didn't see anything that was obviously SVG (nor did I see any mention of SVG in 'view source').
So I think [bug 641388](/show_bug.cgi?id=641388 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor") isn't this, but it may end up being a \*similar\* bug to this one, in our plugin code rather than our SVG code.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=641388#c26)• 14 years ago |
|  | |

Plugins don't use refresh driver for anything, to my knowledge.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=641388#c27)• 14 years ago |
|  | |

Darn - you're right, they don't seem to, based on
<http://mxr.mozilla.org/mozilla-central/search?string=AddRefreshObserver>

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=641388#a2230376_1689)• 14 years ago |

blocking2.0: ? → Macaw+
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Robert Kaiser](/user_profile?user_id=5189) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=641388#c28)• 14 years ago |
|  | |

Should this fix both <https://crash-stats.mozilla.com/report/list?signature=nsRefreshDriver%3A%3ANotify%28nsITimer%2A%29> ([bug 647044](/show_bug.cgi?id=647044 "RESOLVED WORKSFORME - Firefox 4.0 Crash Report [@ nsRefreshDriver::Notify(nsITimer*) ] (Turbo Tax online?)")) and <https://crash-stats.mozilla.com/report/list?signature=nsTimerImpl%3A%3AFire%28%29> that seem to be rising in the last days?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=641388#c29)• 14 years ago |
|  | |

Comment on [attachment 522768](/attachment.cgi?id=522768 "fix v2: create wrapper MaybeStartSampling") [[details]](/attachment.cgi?id=522768&action=edit "fix v2: create wrapper MaybeStartSampling") [[diff]](/attachment.cgi?id=522768&action=diff "fix v2: create wrapper MaybeStartSampling") [[review]](/page.cgi?id=splinter.html&ignore=&bug=641388&attachment=522768)
fix v2: create wrapper MaybeStartSampling
Approved for the mozilla2.0 repository, a=dveditz for release-drivers
[Attachment #522768](/attachment.cgi?id=522768&action=edit "fix v2: create wrapper MaybeStartSampling") -
Flags: approval2.0? → approval2.0+

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=641388#c30)• 14 years ago |
|  | |

(In reply to [comment #28](/show_bug.cgi?id=641388#c28 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor"))
> Should this fix both [signatures omitted for brevity]
> that seem to be rising in the last days?
That's the question that was discussed in [Comment 20](/show_bug.cgi?id=641388#c20 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor") & [Comment 23](/show_bug.cgi?id=641388#c23 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor")-[Comment 27](/show_bug.cgi?id=641388#c27 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor").
To sum up: this patch only affects sites with SMIL animation (and subdocuments being created/destroyed on the fly). So if e.g. TurboTax (or other high-profile sites that hit these crash signatures) uses SVG with SMIL animation, then this would help -- but as dveditz implied in [Comment 23](/show_bug.cgi?id=641388#c23 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor") (and I semi-confirmed in [comment 25](/show_bug.cgi?id=641388#c25 "RESOLVED FIXED - Crash in nsRefreshDriver::Notify with assertion in CSSFrameConstructor")), it's pretty unlikely that that's the case.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=641388#c31)• 14 years ago |
|  | |

That is to say: I don't have a lot of confidence that it'll fix those signatures.
Still a scary bug, though,, & still worth fixing on 2.0 branch.
Pushed to mozilla-2.0:
<http://hg.mozilla.org/releases/mozilla-2.0/rev/c94d64a0d540>
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=641388#a6251108_1689)• 14 years ago |

Group: core-security

|  | [Mats Palmgren (inactive)](/user_profile?user_id=5168) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=641388#c32)• 12 years ago |
|  | |

Crash tests:
<https://hg.mozilla.org/integration/mozilla-inbound/rev/88e4547bdbcf>Flags: in-testsuite? → in-testsuite+

|  | [Phil Ringnalda (:philor)](/user_profile?user_id=135518) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=641388#c33)• 12 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/84d36bef6b96>
You need to [log in](/show_bug.cgi?id=641388&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Nils](/user_profile?user_id=344130)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.mozilla.org_cf9b2341_20250125_051019.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2011-12

## Miscellaneous memory safety hazards (rv:2.0.1/ 1.9.2.17/ 1.9.1.19)

Announced
April 28, 2011
Impact
Critical
Products
Firefox, SeaMonkey, Thunderbird
Fixed in

* Firefox 3.5.19
* Firefox 3.6.17
* Firefox 4.0.1
* SeaMonkey 2.0.14
* Thunderbird 3.1.10

### Description

Mozilla developers identified and fixed several memory safety bugs
in the browser engine used in Firefox and other Mozilla-based
products. Some of these bugs showed evidence of memory corruption
under certain circumstances, and we presume that with enough effort at
least some of these could be exploited to run arbitrary code.

### Credits

Mozilla developers Boris Zbarsky, Gary Kwong, Jesse Ruderman, Michael Wu,
Nils, Scoobidiver, and Ted Mielczarek reported memory safety issues which
affected Firefox 4.

* [Memory safety bugs affecting Firefox 4](https://bugzilla.mozilla.org/buglist.cgi?bug_id=642717,639343,639728,643649,641388,601102,639885)
* [CVE-2011-0079](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0079)

Mozilla developer Scoobidiver reported a memory safety issue which
affected Firefox 4 and Firefox 3.6

* [Memory safety bugs affecting Firefox 4 and Firefox 3.6](https://bugzilla.mozilla.org/buglist.cgi?bug_id=645289)
* [CVE-2011-0081](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0081)

**The web development team of Alcidion** reported
a crash that affected Firefox 4, Firefox 3.6 and Firefox 3.5.

* <https://bugzilla.mozilla.org/show_bug.cgi?id=644069>
* [CVE-2011-0069](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0069)

**Ian Beer** reported a crash that affected Firefox 4,
Firefox 3.6 and Firefox 3.5.

* <https://bugzilla.mozilla.org/show_bug.cgi?id=645565>
* [CVE-2011-0070](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0070)

Mozilla developers Bob Clary, Henri Sivonen, Marco Bonardo, Mats Palmgren and Jesse
Ruderman reported memory safety issues which affected Firefox 3.6 and
Firefox 3.5

* [Memory safety bugs - Firefox 3.6, Firefox 3.5](https://bugzilla.mozilla.org/buglist.cgi?bug_id=638236,634257,637621,637957,615147)
* [CVE-2011-0080](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0080)

Aki Helin reported memory safety issues which affected Firefox 3.6
and Firefox 3.5

* <https://bugzilla.mozilla.org/show_bug.cgi?id=619021>
* [CVE-2011-0074](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0074)
* <https://bugzilla.mozilla.org/show_bug.cgi?id=635977>
* [CVE-2011-0075](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0075)

Ian Beer reported memory safety issues which affected Firefox 3.6
and Firefox 3.5

* <https://bugzilla.mozilla.org/show_bug.cgi?id=623998>
* [CVE-2011-0077](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0077)
* <https://bugzilla.mozilla.org/show_bug.cgi?id=635705>
* [CVE-2011-0078](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0078)

Martin Barbella reported a memory safety issue which affected
Firefox 3.6 and Firefox 3.5.

* <https://bugzilla.mozilla.org/show_bug.cgi?id=624187>
* [CVE-2011-0072](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0072)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.2/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_b93ab0e1_20250125_051027.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/642717)
* [XML](/show_bug.cgi?ctype=xml&id=642717)

Closed
[Bug 642717](/show_bug.cgi?id=642717)

Opened 14 years ago
Closed 14 years ago

# Refresh driver needs to hold strong refs to |targets| in Notify

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Refresh driver needs to hold strong refs to |targets| in Notify

## Categories

### (Core :: Layout, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Layout#Layout)

Layout
▾

Core :: Layout

Issues in Layout that do not fit into any other Layout component or which span multiple Layout components.

Bugs related to the top level presentation objects (pres shell, pres context, and document viewer), the frame constructor, and the base frame classes, as well as general issues with alignment and sizing, all belong here.

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Layout&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Layout&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Layout)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla5

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Priority | --- |
| a11y-review | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |
| status1.9.1 | --- | [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected) |
| fennec | [-](/buglist.cgi?f1=cf_blocking_fennec&o1=equals&v1=-) | --- |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| status1.9.1 |  | unaffected |
| fennec | - |  |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: bzbarsky, Assigned: bzbarsky)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](extensions/Gravatar/web/default.jpg)  [bzbarsky](/user_profile?user_id=20209)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [bzbarsky](/user_profile?user_id=20209)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/cd9b85b2e112bd7941b21ad03f42604e?d=mm&size=40)  [dholbert](/user_profile?user_id=278074)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

8 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Whiteboard: [sg:critical?])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

---

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical?]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [bzbarsky](/user_profile?user_id=20209) | [in-testsuite](#c7 "14 years ago") | ? |
| --- | --- | --- |
| [bzbarsky](/user_profile?user_id=20209) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [Hold strong references to our MozBeforePaint event targets.](/attachment.cgi?id=520121)  [14 years ago](#c1)  [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)   1.90 KB, patch | roc : [review+](#a309_5038 "14 years ago")  dveditz : [approval2.0+](#c9 "14 years ago") | [Details](/attachment.cgi?id=520121&action=edit) | [Diff](/attachment.cgi?id=520121&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=642717&attachment=520121) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=642717#c0)• 14 years ago |
|  | |

I came across this while working on [bug 607529](/show_bug.cgi?id=607529 "RESOLVED FIXED - mozRequestAnimationFrame callbacks can be called after document has gone away") (and the patch for that bug includes a fix for this one, but that bug is not landing in fx4).
I believe that the current code in Notify is unsafe. |targets| holds weak references, and since they're on the stack they can't be removed when the documents go away. So if one of the events triggers script that ends up collecting some of the other documents, then we could end up doing event dispatch to a dead event target, which seems bad.
I'll attach a minimal fix here. I don't think this is worth respinning for, but I do think we should take this ASAP once we start taking .x fixes.

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=642717#c1)• 14 years ago |
|  | |

Attached patch

[Hold strong references to our MozBeforePaint event targets.](attachment.cgi?id=520121&action=diff)
— [Details](attachment.cgi?id=520121&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=642717&attachment=520121)

[Attachment #520121](/attachment.cgi?id=520121&action=edit "Hold strong references to our MozBeforePaint event targets.") -
Flags: review?(roc)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a125_20209)• 14 years ago |

Whiteboard: [need review]

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a173_20209)• 14 years ago |

Priority: -- → P1

|  | [Robert O'Callahan (:roc) (email my personal email if necessary)](/user_profile?user_id=5038) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a309_5038)• 14 years ago |

[Attachment #520121](/attachment.cgi?id=520121&action=edit "Hold strong references to our MozBeforePaint event targets.") -
Flags: review?(roc) → review+

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=642717#c2)• 14 years ago |
|  | |

Comment on [attachment 520121](/attachment.cgi?id=520121 "Hold strong references to our MozBeforePaint event targets.") [[details]](/attachment.cgi?id=520121&action=edit "Hold strong references to our MozBeforePaint event targets.") [[diff]](/attachment.cgi?id=520121&action=diff "Hold strong references to our MozBeforePaint event targets.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=642717&attachment=520121)
Hold strong references to our MozBeforePaint event targets.
Requesting approval, in case we want to fix this for mobile even without fixing it for desktop...
[Attachment #520121](/attachment.cgi?id=520121&action=edit "Hold strong references to our MozBeforePaint event targets.") -
Flags: approval2.0?

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a41512_20209)• 14 years ago |

Whiteboard: [need review] → [need approval]

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a42781_137548)• 14 years ago |

blocking2.0: ? → -tracking-fennec: --- → ?

|  | [Doug Turner (:dougt)](/user_profile?user_id=302291) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=642717#c3)• 14 years ago |
|  | |

we can pick this up whenever it lands for desktop. not holding mobile4.0 for this.tracking-fennec: ? → 2.0-

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=642717#c4)• 14 years ago |
|  | |

It sounds bad in theory, but do we know if this happens in practice (for example, is there a testcase that demonstrates the problem)?Keywords: [testcase-wanted](/buglist.cgi?keywords=testcase-wanted&resolution=---)Whiteboard: [need approval] → [sg:critical?][need approval]

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=642717#c5)• 14 years ago |
|  | |

I haven't tried writing one, but I could do that if you want...

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=642717#c6)• 14 years ago |
|  | |

Daniel, see [comment 5](/show_bug.cgi?id=642717#c5 "RESOLVED FIXED - Refresh driver needs to hold strong refs to |targets| in Notify").

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a852419_20209)• 14 years ago |

Whiteboard: [sg:critical?][need approval] → [sg:critical?][need landing]

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a904242_20209)• 14 years ago |

[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected)
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_20&o1=equals&v1=%3F)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=642717#c7)• 14 years ago |
|  | |

Pushed <http://hg.mozilla.org/mozilla-central/rev/ced2b9373c5f>Status: NEW → RESOLVEDClosed: 14 years agoFlags: in-testsuite?Resolution: --- → FIXEDWhiteboard: [sg:critical?][need landing] → [sg:critical?]Target Milestone: --- → mozilla2.2

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=642717#c8)• 14 years ago |
|  | |

I really think we need to take this for any security-update releases we do for 2.0. Renominating accordingly.blocking2.0: - → ?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a1261590_1689)• 14 years ago |

blocking2.0: ? → Macaw
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_20&o1=equals&v1=%3F) → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=642717#c9)• 14 years ago |
|  | |

Comment on [attachment 520121](/attachment.cgi?id=520121 "Hold strong references to our MozBeforePaint event targets.") [[details]](/attachment.cgi?id=520121&action=edit "Hold strong references to our MozBeforePaint event targets.") [[diff]](/attachment.cgi?id=520121&action=diff "Hold strong references to our MozBeforePaint event targets.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=642717&attachment=520121)
Hold strong references to our MozBeforePaint event targets.
Approved for the mozilla2.0 repository, a=dveditz for release-drivers
[Attachment #520121](/attachment.cgi?id=520121&action=edit "Hold strong references to our MozBeforePaint event targets.") -
Flags: approval2.0? → approval2.0+

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=642717#c10)• 14 years ago |
|  | |

<http://hg.mozilla.org/releases/mozilla-2.0/rev/7bf6e15028ed>
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a5885885_1689)• 14 years ago |

Group: core-security

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=642717#a144601447_75935)• 9 years ago |

Keywords: [testcase-wanted](/buglist.cgi?keywords=testcase-wanted&resolution=---)
You need to [log in](/show_bug.cgi?id=642717&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_08de7e52_20250125_051023.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/639728)
* [XML](/show_bug.cgi?ctype=xml&id=639728)

Closed
[Bug 639728](/show_bug.cgi?id=639728)

Opened 14 years ago
Closed 14 years ago

# Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC

## Categories

### (Core :: SVG, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=SVG#SVG)

SVG
▾

Core :: SVG

Issues with the layout or rendering of SVG content and interacting with the SVG DOM.

Example bugs:

* SVG marker can not be clipped with clip-path
* x position adjustments of SVG vertical text on a path moves in the wrong direction

Specifications covered:

* SVG

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=SVG&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=SVG&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=SVG)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 | --- | [Macaw+](/buglist.cgi?f1=cf_blocking_20&o1=equals&v1=Macaw%2B) |
| status2.0 | --- | [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed) |
| status1.9.2 | --- | [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected) |
| status1.9.1 | --- | [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| blocking2.0 |  | Macaw+ |
| status2.0 |  | .1-fixed |
| status1.9.2 |  | unaffected |
| relnote-firefox |  | --- |
| status1.9.1 |  | unaffected |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jruderman, Assigned: dholbert)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/cd9b85b2e112bd7941b21ad03f42604e?d=mm&size=40)  [dholbert](/user_profile?user_id=278074)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/d2dc9227eafcd0ec5ba3712ee4f19b75?d=mm&size=40)  [jruderman](/user_profile?user_id=11608)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](extensions/Gravatar/web/default.jpg)  [jwatt](/user_profile?user_id=32767)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

4 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[669584](/show_bug.cgi?id=669584 "RESOLVED FIXED - The fix for bug 639728 forgot that items are created lazily")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[344905](/show_bug.cgi?id=344905 "RESOLVED FIXED - [meta] SVG Element and Attribute fuzzer")

Dependency [tree](/showdependencytree.cgi?id=639728&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=639728)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: crash, testcase, Whiteboard: [sg:critical?])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[crash](/buglist.cgi?keywords=crash&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:critical?]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dholbert](/user_profile?user_id=278074) | [in-testsuite](#a1860529_278074 "14 years ago") | ? |
| --- | --- | --- |
| [dholbert](/user_profile?user_id=278074) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ mozilla::DOMSVGPathSegList::ItemAt ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3ADOMSVGPathSegList%3A%3AItemAt)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (6 files, 1 obsolete file)

| [testcase (crashes Firefox when loaded) (requires extension for GC)](/attachment.cgi?id=517633)  [14 years ago](#c0)  [Jesse Ruderman](/user_profile?user_id=11608)   361 bytes, image/svg+xml |  | [Details](/attachment.cgi?id=517633&action=edit) |
| --- | --- | --- |
| [stack trace](/attachment.cgi?id=517634)  [14 years ago](#c1)  [Jesse Ruderman](/user_profile?user_id=11608)   7.93 KB, text/plain |  | [Details](/attachment.cgi?id=517634&action=edit) |
| [fix v1 (just for DOMSVGPathSegList)](/attachment.cgi?id=518564)  [14 years ago](#c9)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   1.17 KB, patch |  | [Details](/attachment.cgi?id=518564&action=edit) | [Diff](/attachment.cgi?id=518564&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=518564) |
| [testcase 2a (LengthList)](/attachment.cgi?id=518597)  [14 years ago](#c10)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   467 bytes, image/svg+xml |  | [Details](/attachment.cgi?id=518597&action=edit) |
| [testcase 2b](/attachment.cgi?id=518601)  [14 years ago](#c11)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   379 bytes, image/svg+xml |  | [Details](/attachment.cgi?id=518601&action=edit) |
| [fix v2](/attachment.cgi?id=521889)  [14 years ago](#c14)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   9.90 KB, patch | jwatt : [review+](#c18 "14 years ago")  dveditz : [approval2.0+](#c21 "14 years ago") | [Details](/attachment.cgi?id=521889&action=edit) | [Diff](/attachment.cgi?id=521889&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521889) |
| [test patch (using netscape.security.PrivilegeManager.enablePrivilege for now)](/attachment.cgi?id=521912)  [14 years ago](#c17)  [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)   3.71 KB, patch |  | [Details](/attachment.cgi?id=521912&action=edit) | [Diff](/attachment.cgi?id=521912&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521912) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=639728#c0)• 14 years ago |
|  | |

Attached image
[testcase (crashes Firefox when loaded) (requires extension for GC)](attachment.cgi?id=517633)
— [Details](attachment.cgi?id=517633&action=edit)

1. Install 'DOM Fuzz Lite' from
<https://www.squarefree.com/extensions/domFuzzLite.xpi>
2. Load the testcase.
Result: crash [@ mozilla::DOMSVGPathSegList::ItemAt]
Security-sensitive because anything that involves GC scares me.

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=639728#c1)• 14 years ago |
|  | |

Attached file
[stack trace](attachment.cgi?id=517634)
— [Details](attachment.cgi?id=517634&action=edit)

|  | [Jesse Ruderman](/user_profile?user_id=11608)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=639728#c2)• 14 years ago |
|  | |

Debug builds crash.
Something really weird happens when I load the testcase in opt. I wish it would crash :(

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=639728#c3)• 14 years ago |
|  | |

<https://crash-stats.mozilla.com/report/index/bp-f5c8a064-4f76-4b31-969f-a590a2110310> is my report.

|  | [Johnny Stenback (:jst)](/user_profile?user_id=12352) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=639728#c4)• 14 years ago |
|  | |

Blake, care to have a look?Assignee: nobody → mrbkapWhiteboard: [sg:critical?]

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=639728#c5)• 14 years ago |
|  | |

I just took a look in GDB, and it looks like basically we're never calling the ~DOMSVGPathSegList() destructor (which is responsible for removing the DOMSVGPathSegList from an internal table).
So during GC, Release() decrements the DOMSVGPathSegList's refcount (to 0), and then calls delete(), which fills the DOMSVGPathSegList with 0x5a5a5a5a -- and in the meantime, we \*\*never touch the destructor.\*\*
This leaves the pointer around in the table, just waiting for us to use it and explode.
I'm not sure why delete() isn't triggering the destructor, but I think that's the main thing that's broken here.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=639728#c6)• 14 years ago |
|  | |

(In reply to [comment #5](/show_bug.cgi?id=639728#c5 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC"))
> I'm not sure why delete() isn't triggering the destructor, but I think that's
> the main thing that's broken here.
Gah, so it \*did\* trigger the destructor this time, so [Comment 5](/show_bug.cgi?id=639728#c5 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC") might be bogus. (sorry)
Investigating more thoroughly. Stealing bug from mrbkap, per IRC discussion.Assignee: mrbkap → dholbertOS: Mac OS X → AllHardware: x86 → All

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=639728#c7)• 14 years ago |
|  | |

So even though the destructor seems to be triggered, the problem is still that the DOMSVGPathSegList is remaining in the table somehow -- so the call
> DOMSVGPathSegList \*baseValWrapper =
> DOMSVGPathSegList::GetDOMWrapperIfExists(GetBaseValKey());
in SVGAnimatedPathSegList::ClearBaseValue() is returning non-null\* when it should be returning null...
\* (the deleted DOMSVGPathSegList that used to be associated with that key)
(I've verified that the key we use to do the removal in the destructor matches the key we use for the lookup in the quoted lines above.)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=639728#c8)• 14 years ago |
|  | |

Ah, ok - so it turns out the table-removal happens \*after\* the table-lookup. (but we continue to use the value that we looked up earlier).
Specifically, we've got these lines in DOMSVGPathSegList::InternalListWillChangeTo:
> ItemAt(index)->RemovingFromList();
> ItemAt(index) = nsnull;
The first line there removes the last nsRefPtr that points to |this|, so it \*\*deletes |this|\*\*. And after that, we're hosed, and we crash almost immediately (within the second line above).
So, we probably need a nsRefPtr "kung-fu death-grip" on |this|, for the duration of InternalListWillChangeTo.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=639728#c9)• 14 years ago |
|  | |

Attached patch

[fix v1 (just for DOMSVGPathSegList)](attachment.cgi?id=518564&action=diff) (obsolete)
— [Details](attachment.cgi?id=518564&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=518564)

(In reply to [comment #8](/show_bug.cgi?id=639728#c8 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC"))
> So, we probably need a nsRefPtr "kung-fu death-grip" on |this|, for the
> duration of InternalListWillChangeTo.
Here's that as a patch. Confirmed that it fixes this locally. We might need something like this for other SVG list classes, too.
(The "if (length)" check is necessary because the DOMSVGPathSegList constructor calls "InternalListWillChangeTo", at which point we have a refcount of 0. So if we were to add & remove the deathgrip at that point, then we get deleted (as soon as we're constructed).

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a253180_278074)• 14 years ago |

[Attachment #518564](/attachment.cgi?id=518564&action=edit "fix v1 (just for DOMSVGPathSegList)") -
Attachment description: fix v1 → fix v1 (just for DOMSVGPathSegList)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=639728#c10)• 14 years ago |
|  | |

Attached image
[testcase 2a (LengthList)](attachment.cgi?id=518597)
— [Details](attachment.cgi?id=518597&action=edit)

Here's a testcase that uses a length list instead. It crashes in DOMSVGLengthList::InternalListLengthWillChange, on the line right after
> mItems[i]->RemovingFromList();
(essentially the same as with the original testcase)
At that point, the DOMSVGLengthList (|this|) and its DOMSVGAnimatedLengthList (|this| up one stack-level) have both just been deleted.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a253880_278074)• 14 years ago |

[Attachment #518597](/attachment.cgi?id=518597&action=edit "testcase 2a (LengthList)") -
Attachment description: testcase 2 (LengthList) → testcase 2a (LengthList)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=639728#c11)• 14 years ago |
|  | |

Attached image
[testcase 2b](attachment.cgi?id=518601)
— [Details](attachment.cgi?id=518601&action=edit)

This testcase also crashes using a length-list (like testcase 2a).
In this new version, we simply retain a reference to an item in the list, rather than creating & inserting an item -- and we set the attribute to an invalid value, rather than clearing it.
So, it seems like we're vulnerable to this whenever some chunk of script retains a reference to a list-item past the time when the list gets cleared. ("cleared" = unset, or set to be empty, or set to an invalid value)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=639728#c12)• 14 years ago |
|  | |

Just ran through this with jwatt, and he agrees we just need to add some death-grip nsRefPtrs.
FWIW, we were able to trigger this \*without\* Jesse's fuzzer extension -- just needed to replace his "fuzzPrivGC()" call with a setTimeout, to allow time for a GC. (Presumably, the crucial object that gets GC'd is a reference to |text.x| or |text.x.baseVal|).
This SVG item-list code was all rewritten for Gecko 2.0, so this is unlikely to affect Gecko 1.9.x. This bug should probably block an early 2.0.x release, though. (I'm not sure if there's a way to request that yet, though -- I think blocking2.0 still means "blocking the Firefox 4 release"...?)Whiteboard: [sg:critical?] → [sg:critical?][dholbert: should block some Gecko 2.0.x release]

|  | [Johnny Stenback (:jst)](/user_profile?user_id=12352) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=639728#c13)• 14 years ago |
|  | |

blocking2.0 .x+ means blocking a security/stability release, so marking as such.blocking2.0: --- → .x+

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=639728#c14)• 14 years ago |
|  | |

Attached patch

[fix v2](attachment.cgi?id=521889&action=diff)
— [Details](attachment.cgi?id=521889&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521889)

Here's a more comprehensive fix.
I've audited the code for this sort of problem, and I think this catches all of the areas affected by this issue. (more detail coming up.)
[Attachment #518564](/attachment.cgi?id=518564&action=edit "fix v1 (just for DOMSVGPathSegList)") -
Attachment is obsolete: true
[Attachment #521889](/attachment.cgi?id=521889&action=edit "fix v2") -
Flags: review?

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=639728#c15)• 14 years ago |
|  | |

THINGS WE NEED TO AVOID:
SITUATION A: DOMSVGXxxList::Foo() calls Bar() on its only remaining Item. Inside Bar(), we clear the last strong reference to the list, deleting it.
SITUATION B: DOMSVGAnimatedXxxList::Foo() calls DOMSVGXxxList::Bar() on one of its "child" lists. Inside Bar(), we clear the last strong reference to the "parent" animated list, deleting it.
In both cases, when control returns to Foo(), we've got a deleted |this| pointer, so we'll crash as soon as we touch any member variables or methods.
NOTE: This is only a problem when it's possible for there to be no references to the "parent" object in script. So if Foo() is a DOM method called by script, then script necessarily holds an owning reference to the object, and it won't be deleted before Foo() completes. (I've flagged these cases below as "OK; DOM method".)
AUDIT FOR PLACES WE COULD HIT SITUATIONS A & B IN LENGTH LISTS:
- Places where DOMSVGLength drops its nsRefPtr "mList" (Situation A):
\* DOMSVGLength::RemovingFromList (sets "mList = nsnull;")
Called from:
- DOMSVGLengthList::InternalListLengthWillChange --> FIXED IN PATCH
- DOMSVGLengthList::ReplaceItem --> OK; DOM method
- DOMSVGLengthList::RemoveItem --> OK; DOM method
- DOMSVGLengthList::MaybeRemoveItemFromAnimValListAt --> FIXED IN PATCH
\* DOMSVGLength::InsertingIntoList (sets "mList = aList;")
- OK -- called by the \*new\* list, not by the old one.
(old list may be deleted, and that's ok)
\* DOMSVGLength destructor (implicit)
Automatically called when we clear last strong ref to a DOMSVGLength.
In DOMSVGLengthList, this only happens when a local nsCOMPtr<DOMSVGLength>
goes out of scope, which happens in:
- DOMSVGLengthList::Initialize --> OK; DOM method
- DOMSVGLengthList::InsertItemBefore --> OK; DOM method
- DOMSVGLengthList::ReplaceItem --> OK; DOM method
- Places where DOMSVGLengthList drops its nsRefPtr "mAList" (Situation B):
\* DOMSVGLengthList destructor
Automatically called when we clear last strong ref to a DOMSVGLengthList.
That now happens when DOMSVGLengthList::InternalListLengthWillChange
returns, becuase our newly-added kungFuDeathGrip goes out of scope.
- And that method is called by:
DOMSVGAnimatedLengthList::InternalBaseValListWillChangeTo
--> FIXED IN PATCH (kungFuDeathGrip added)
Other list types are basically the same, or safer (due to not having "AnimatedList" forms, in the case of points-list & path-seg-list).
More detail on these other list-types coming soon.

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=639728#c16)• 14 years ago |
|  | |

NUMBER LISTS:
- Exactly the same as "length lists" case. (DOMSVG\*Number\* and DOMSVG\*Length\* files are essentially identical) So, just see [Comment 15](/show_bug.cgi?id=639728#c15 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC").
PATH SEG LISTS:
- Places where DOMSVGPathSeg drops its nsRefPtr "mList" (Situation A):
\* Exact same methods as for DOMSVGLength. Those methods have same callers as described in [Comment 15](/show_bug.cgi?id=639728#c15 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC"), so that all applies here.
- No threat of Situation B, since there's no animated list type for PathSegLists
POINT LISTS:
- Places where DOMSVGPoint drops its nsRefPtr "mList" (Situation A):
\* Exact same methods as for DOMSVGLength. Those methods have same callers as described in [Comment 15](/show_bug.cgi?id=639728#c15 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC"), so that all applies here.
- No threat of Situation B, since there's no animated list type for PointLists

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a1527277_278074)• 14 years ago |

[Attachment #521889](/attachment.cgi?id=521889&action=edit "fix v2") -
Flags: review? → review?(jwatt)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=639728#c17)• 14 years ago |
|  | |

Attached patch

[test patch (using netscape.security.PrivilegeManager.enablePrivilege for now)](attachment.cgi?id=521912&action=diff)
— [Details](attachment.cgi?id=521912&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521912)

This patch adds some mochitests for this bug, but it shouldn't land for a little while yet because:
(a) we want to wait until the patch has landed on all affected branches (nightlies and 4.x)
(b) the test currently relies on a
netscape.security.PrivilegeManager.enablePrivilege
to force GC, but enablePrivilege is no longer kosher in mochitests. I've tried to work around this using SpecialPowers, but haven't been successful yet -- see [bug 642993](/show_bug.cgi?id=642993 "RESOLVED WORKSFORME - Create SpecialPowers version of \"Components.utils.forceGC()\" and/or \"nsIDOMWindowUtils::garbageCollect()\""). (That bug is talking about my test-writing for this bug, but I've tried to use generic language over there to avoid giving anything away.)

|  | [Jonathan Watt [:jwatt]](/user_profile?user_id=32767) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=639728#c18)• 14 years ago |
|  | |

Comment on [attachment 521889](/attachment.cgi?id=521889 "fix v2") [[details]](/attachment.cgi?id=521889&action=edit "fix v2") [[diff]](/attachment.cgi?id=521889&action=diff "fix v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521889)
fix v2
Good job. r=jwatt
[Attachment #521889](/attachment.cgi?id=521889&action=edit "fix v2") -
Flags: review?(jwatt) → review+

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=639728#c19)• 14 years ago |
|  | |

Landed fix on m-c: <http://hg.mozilla.org/mozilla-central/rev/43467a3a651d>
(Still needs to land on Firefox 4.0 branch, though.)Status: NEW → RESOLVEDClosed: 14 years agoResolution: --- → FIXED

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a1860529_278074)• 14 years ago |

Flags: in-testsuite?

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=639728#c20)• 14 years ago |
|  | |

Comment on [attachment 521889](/attachment.cgi?id=521889 "fix v2") [[details]](/attachment.cgi?id=521889&action=edit "fix v2") [[diff]](/attachment.cgi?id=521889&action=diff "fix v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521889)
fix v2
At dveditz's suggestion, I'm requesting approval2.0, to land this security fix for some 4.0 security release.
This has zero expected behavior-change, aside from fixing crashes. It just adds an extra kungFuDeathGrip to a few (non-recursive) functions, to keep something alive until the function returns.
[Attachment #521889](/attachment.cgi?id=521889&action=edit "fix v2") -
Flags: approval2.0?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a1958663_1689)• 14 years ago |

blocking2.0: .x+ → Macaw
[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_191&o1=equals&v1=unaffected)
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_192&o1=equals&v1=unaffected)
[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
--- → [wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=639728#c21)• 14 years ago |
|  | |

Comment on [attachment 521889](/attachment.cgi?id=521889 "fix v2") [[details]](/attachment.cgi?id=521889&action=edit "fix v2") [[diff]](/attachment.cgi?id=521889&action=diff "fix v2") [[review]](/page.cgi?id=splinter.html&ignore=&bug=639728&attachment=521889)
fix v2
Approved for the mozilla2.0 repository, a=dveditz for release-drivers
[Attachment #521889](/attachment.cgi?id=521889&action=edit "fix v2") -
Flags: approval2.0? → approval2.0+

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=639728#c22)• 14 years ago |
|  | |

<http://hg.mozilla.org/releases/mozilla-2.0/rev/caa938935590>Whiteboard: [sg:critical?][dholbert: should block some Gecko 2.0.x release] → [sg:critical?]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a3013949_1689)• 14 years ago |

[status2.0](/buglist.cgi?f1=cf_status_20&o1=isnotempty):
[wanted](/buglist.cgi?f1=cf_status_20&o1=equals&v1=wanted) → [.1-fixed](/buglist.cgi?f1=cf_status_20&o1=equals&v1=.1-fixed)

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=639728#c23)• 14 years ago |
|  | |

The test for this is now clear to land, safety-wise, but it still can't land due to part (b) of [Comment 17](/show_bug.cgi?id=639728#c17 "RESOLVED FIXED - Crash [@ mozilla::DOMSVGPathSegList::ItemAt] with GC") still being unresolved. (The test for this relies on enablePrivilege instead of SpecialPowers, for triggering a GC at exactly the right time, and last I checked, the straightforward method of extending SpecialPowers didn't work.)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a6750168_1689)• 14 years ago |

Group: core-security

|  | [Nobody; OK to take it and work on it](/user_profile?user_id=1) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a8429366_1)• 14 years ago |

Crash Signature: [@ mozilla::DOMSVGPathSegList::ItemAt]

|  | [Jonathan Watt [:jwatt]](/user_profile?user_id=32767) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=639728#a10394796_32767)• 14 years ago |

Depends on: [669584](/show_bug.cgi?id=669584 "RESOLVED FIXED - The fix for bug 639728 forgot that items are created lazily")

|  | [Daniel Holbert [:dholbert]](/user_profile?user_id=278074)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=639728#c24)• 14 years ago |
|  | |

[bug 642993 comment 2](/show_bug.cgi?id=642993#c2 "RESOLVED WORKSFORME - Create SpecialPowers version of \"Components.utils.forceGC()\" and/or \"nsIDOMWindowUtils::garbageCollect()\"") suggests that the testcase here may be workable with SpecialPowers now...
You need to [log in](/show_bug.cgi?id=639728&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jesse Ruderman](/user_profile?user_id=11608)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


