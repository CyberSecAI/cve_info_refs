=== Content from hg.prosody.im_f51ab6f9_20250124_183313.html ===

[Toggle navigation](#navbar)
[Prosody IM](/)

* [Download](//prosody.im/download)
* [Documentation](//prosody.im/doc)
* [Support](//prosody.im/discuss)
* [Issues](//prosody.im/bugs)
* [Source](//prosody.im/source)
* [Dev docs](//prosody.im/doc/developers)

üîç
[?](/0.8/help/revsets)

# Prosody IM 0.8

* [summary](/0.8/)
* [browse](/0.8/file/c806a599224a)
* [changes](/0.8/shortlog/c806a599224a)
* [graph](/0.8/graph/c806a599224a)

### changeset c806a599224a

mod\_storage\_sql: Switch to MEDIUMTEXT for the 'value' column when using MySQL, as it imposes a 64K limit otherwise, potentially truncating data. Automatically upgrades existing tables.

author
Matthew Wild
date
2011-06-02
parents
[20979f124ad9](/0.8/rev/20979f124ad9)
children
 [1e68721c02f2](/0.8/rev/1e68721c02f2)
topic
[?](https://bz.mercurial-scm.org/show_bug.cgi?id=6826)
files

* [plugins/mod\_storage\_sql.lua](/0.8/file/c806a599224a/plugins/mod_storage_sql.lua)

#### 1 files changed, 18 insertions(+), 0 deletions(-)

[‚Üì Download patch](/0.8/raw-rev/c806a599224a)

| [plugins/mod\_storage\_sql.lua](#l1.1) | 18 |  |
| --- | --- | --- |

```

--- a/plugins/mod_storage_sql.lua	Thu Jun 02 05:36:15 2011 +0500
+++ b/plugins/mod_storage_sql.lua	Thu Jun 02 02:30:26 2011 +0100
@@ -68,6 +68,8 @@
 	local create_sql = "CREATE TABLE `prosody` (`host` TEXT, `user` TEXT, `store` TEXT, `key` TEXT, `type` TEXT, `value` TEXT);";
 	if params.driver == "PostgreSQL" then
 		create_sql = create_sql:gsub("`", "\"");
+	elseif params.driver == "MySQL" then
+		create_sql = create_sql:gsub("`value` TEXT", "`value` MEDIUMTEXT");
 	end

 	local stmt = connection:prepare(create_sql);
@@ -91,6 +93,22 @@
 			if not(ok and commit_ok) then
 				module:log("warn", "Failed to create index (%s), lookups may not be optimised", err or commit_err);
 			end
+		else -- COMPAT: Upgrade tables from 0.8.0
+			-- Failed to create, but check existing MySQL table here
+			local stmt = connection:prepare("SHOW COLUMNS FROM prosody WHERE Field='value' and Type='text'");
+			local ok = stmt:execute();
+			local commit_ok = connection:commit();
+			if ok and commit_ok then
+				if stmt:rowcount() > 0 then
+					local stmt = connection:prepare("ALTER TABLE prosody MODIFY COLUMN `value` MEDIUMTEXT");
+					local ok = stmt:execute();
+					local commit_ok = connection:commit();
+					if ok and commit_ok then
+						module:log("info", "Database table automatically upgraded");
+					end
+				end
+				repeat until not stmt:fetch();
+			end
 		end
 	end
 end
```



=== Content from hg.prosody.im_813970fb_20250124_183314.html ===

[Toggle navigation](#navbar)
[Prosody IM](/)

* [Download](//prosody.im/download)
* [Documentation](//prosody.im/doc)
* [Support](//prosody.im/discuss)
* [Issues](//prosody.im/bugs)
* [Source](//prosody.im/source)
* [Dev docs](//prosody.im/doc/developers)

üîç
[?](/0.8/help/revsets)

# Prosody IM 0.8

* [summary](/0.8/)
* [browse](/0.8/file/d2406f0ce8a5)
* [changes](/0.8/shortlog/d2406f0ce8a5)
* [graph](/0.8/graph/d2406f0ce8a5)

### changeset d2406f0ce8a5

migrator/prosody\_sql.lua: Create (and upgrade) MySQL tables to use MEDIUMTEXT for the 'value' column to avoid truncation

author
Matthew Wild
date
2011-06-03
parents
[419354c47c28](/0.8/rev/419354c47c28)
children
 [3421dfaa8188](/0.8/rev/3421dfaa8188)
topic
[?](https://bz.mercurial-scm.org/show_bug.cgi?id=6826)
files

* [tools/migration/migrator/prosody\_sql.lua](/0.8/file/d2406f0ce8a5/tools/migration/migrator/prosody_sql.lua)

#### 1 files changed, 18 insertions(+), 0 deletions(-)

[‚Üì Download patch](/0.8/raw-rev/d2406f0ce8a5)

| [tools/migration/migrator/prosody\_sql.lua](#l1.1) | 18 |  |
| --- | --- | --- |

```

--- a/tools/migration/migrator/prosody_sql.lua	Thu Jun 02 17:18:23 2011 +0100
+++ b/tools/migration/migrator/prosody_sql.lua	Fri Jun 03 00:57:25 2011 +0100
@@ -21,6 +21,8 @@
 	local create_sql = "CREATE TABLE `prosody` (`host` TEXT, `user` TEXT, `store` TEXT, `key` TEXT, `type` TEXT, `value` TEXT);";
 	if params.driver == "PostgreSQL" then
 		create_sql = create_sql:gsub("`", "\"");
+	elseif params.driver == "MySQL" then
+		create_sql = create_sql:gsub("`value` TEXT", "`value` MEDIUMTEXT");
 	end

 	local stmt = connection:prepare(create_sql);
@@ -40,6 +42,22 @@
 				ok, err = assert(stmt:execute());
 				commit_ok, commit_err = assert(connection:commit());
 			end
+		else -- COMPAT: Upgrade tables from 0.8.0
+			-- Failed to create, but check existing MySQL table here
+			local stmt = connection:prepare("SHOW COLUMNS FROM prosody WHERE Field='value' and Type='text'");
+			local ok = stmt:execute();
+			local commit_ok = connection:commit();
+			if ok and commit_ok then
+				if stmt:rowcount() > 0 then
+					local stmt = connection:prepare("ALTER TABLE prosody MODIFY COLUMN `value` MEDIUMTEXT");
+					local ok = stmt:execute();
+					local commit_ok = connection:commit();
+					if ok and commit_ok then
+						print("Database table automatically upgraded");
+					end
+				end
+				repeat until not stmt:fetch();
+			end
 		end
 	end
 end
```



=== Content from prosody.im_7c745707_20250124_183314.html ===

[Toggle navigation](#navbar)
[Prosody IM](/)

* [Download](//prosody.im/download)
* [Documentation](//prosody.im/doc)
* [Support](//prosody.im/discuss)
* [Issues](//prosody.im/bugs)
* [Source](//prosody.im/source)
* [Dev docs](//prosody.im/doc/developers)
* [@prosodyim](https://fosstodon.org/%40prosodyim)
* [Table of contents](#TOC)

# 0.8.1 Release Notes

*Released 2011-06-03*

This is a security and bugfix release for the 0.8 branch. This
release contains fixes for a couple of major issues, and it is strongly
recommended that you upgrade.

Some of you may already be aware of the "billion laughs"
denial-of-service attack which was discovered to work against a number
of XMPP servers recently. Due to accidental oversight the Prosody team
was not notified ahead of the issue being made public, so we have worked
hard the past couple of days to prepare this release as soon as we
could.

In addition to upgrading Prosody, you **MUST** also
upgrade the LuaExpat library to 1.2.0 to prevent the attack - this
should hopefully be arriving in your distribution shortly, alternatively
it can be installed using [luarocks](https://luarocks.org/).
See [here](/doc/depends#luaexpat) for details.

A summary of changes in this release:

* Reject XML DTDs, comments and processing instructions, preventing
  the "billion laughs" attack
* Switch to MEDIUMTEXT in the schema for MySQL to avoid truncating
  large data (such as large avatars)
* Prosody automatically upgrades the table in-place if possible, see:
  <http://prosody.im/doc/mysql>
* Fix for endless loop when parsing certain invalid JSON
* Fix PostgreSQL compatibility in prosody-migrator
* Fix timestamp parsing for DST (affecting MUC scrollback
  retrieval)
* mod\_legacyauth now correctly disabled for unencrypted connections by
  default
* Components properly inherit SSL settings and certificates from their
  'parent' hosts
* Prevent startup with no VirtualHost entries in the config file

# Backporting

We have selected all of the changes in 0.8.1 to be only those
important enough to be distributed to all users of 0.8.0. However if you
are a packager looking to backport **only** the urgent
security fixes, these are the patches you need:

## 0.8

* Billion laughs: [5305a665bdd4](https://hg.prosody.im/0.8/rev/5305a665bdd4), [65e2c089d138](https://hg.prosody.im/0.8/rev/65e2c089d138), [ee6a18f10a8d](https://hg.prosody.im/0.8/rev/ee6a18f10a8d)
* MySQL truncation: [c806a599224a](https://hg.prosody.im/0.8/rev/c806a599224a), [d2406f0ce8a5](https://hg.prosody.im/0.8/rev/d2406f0ce8a5)
* JSON parsing: [20979f124ad9](https://hg.prosody.im/0.8/rev/20979f124ad9)

The last 2 issues above are specific to 0.8 and potentially allow
remote DoS when combined.

## 0.7

* Billion laughs: <http://prosody.im/patches/prosody-0.7.0-billion-laughs.patch>

## 0.6

* Billion laughs: <http://prosody.im/patches/prosody-0.6.2-billion-laughs.patch>

## Table of contents

* [Backporting](#backporting)
  + [0.8](#section08)
  + [0.7](#section07)
  + [0.6](#section06)

License
[cc-by-sa](http://creativecommons.org/licenses/by-sa/4.0/ "Creative Commons Attribution-ShareAlike 4.0 International License.")

Last change
2022-03-29

Page source
[doc/release/0.8.1.md](//hg.prosody.im/site/file/ade91c53d99c/doc/release/0.8.1.md)



=== Content from blog.prosody.im_df5cbfa7_20250124_183313.html ===


* [Prosodical Thoughts](https://blog.prosody.im/)
* [Main site](https://prosody.im/)
* [Documentation](https://prosody.im/doc)
* [Support](https://prosody.im/discuss)
* [Issues](https://prosody.im/bugs)
* [Source](https://prosody.im/source)
* [Dev docs](https://prosody.im/doc/developers)
* [Download](https://prosody.im/download)

# [Prosodical Thoughts](https://blog.prosody.im/)

News, announcements and thoughts from the Prosody IM team

# [Prosody 0.8.1 released](https://blog.prosody.im/prosody-0-8-1-released/)

2011-06-04
 by The Prosody Team

**Tags:**
[release](/tags/release)
,
[security](/tags/security)

This is a security and bugfix release for the 0.8 branch. This release contains fixes for a
couple of major issues, and it is strongly recommended that you upgrade.

![](/files/drama.jpg)

Some of you may already be aware of the ‚Äúbillion laughs‚Äù denial-of-service attack which was
discovered to work against a number of XMPP servers recently. Due to accidental oversight the
Prosody team was not notified ahead of the issue being made public, so we have worked hard the
past few days to prepare this release as soon as we could.

In addition to upgrading Prosody, you MUST also upgrade the [LuaExpat](http://www.keplerproject.org/luaexpat/)
library to [1.2.0](http://article.gmane.org/gmane.comp.lang.lua.general/79336) to prevent
the attack - this should hopefully be arriving in your distribution shortly, alternatively it can
be installed using [luarocks](http://luarocks.org/). See our
[dependencies page](http://prosody.im/doc/depends#luaexpat) for details.

If you are a packager and are looking for backported patches to older Prosody versions, please
see the [0.8.1 release notes](http://prosody.im/doc/release/0.8.1#backporting).

A summary of changes in this release:

* Reject XML DTDs, comments and processing instructions, preventing the ‚Äúbillion laughs‚Äù attack
* Switch to MEDIUMTEXT in the schema for MySQL to avoid truncating large data (such as large avatars)
  Prosody automatically upgrades the table in-place if possible, see our [MySQL documentation](http://prosody.im/doc/mysql)
  for more information.
* Fix for endless loop when parsing certain invalid JSON
* Fix PostgreSQL compatibility in prosody-migrator
* Fix timestamp parsing for DST (affecting MUC scrollback retrieval)
* mod\_legacyauth now correctly disabled for unencrypted connections by default
* Components properly inherit SSL settings and certificates from their ‚Äòparent‚Äô hosts
* Prevent startup with no VirtualHost entries in the config file

As usual if you need help or have any questions about installing/upgrading, feel
free to [ask](http://prosody.im/discuss).

## Download

**Windows**: [Installer](http://prosody.im/downloads/windows/ProsodySetup-0.8.1.exe) | [Zip](http://prosody.im/downloads/windows/Prosody-0.8.1.zip)

**Debian/Ubuntu**: [32-bit](http://prosody.im/downloads/debian/prosody_0.8.1-1_i386.deb) | [64-bit](http://prosody.im/downloads/debian/prosody_0.8.1-1_amd64.deb)

**Source tarball**: [prosody-0.8.1.tar.gz](http://prosody.im/downloads/source/prosody-0.8.1.tar.gz)

---

#### About

Prosody is a lightweight and flexible XMPP server designed with ease-of-use and extensibility in mind.

[‚öõÔ∏è Atom feed](/index.xml "Atom feed for Prosodical Thoughts: Prosody Team Blog")

#### Recent Posts

* [Prosody 0.12.5 released](/prosody-0.12.5-released/)
* [New server, new sponsor](/new-server-new-sponsor/)
* [Prosody 0.12.4 released](/prosody-0.12.4-released/)
* [Prosody 0.12.3 released](/prosody-0.12.3-released/)
* [Prosody 0.12.2 released](/prosody-0.12.2-released/)

Except where otherwise noted, content on this site is licensed under a [Creative Commons Attribution Share Alike 4.0 International license](https://creativecommons.org/licenses/by-sa/4.0/).

[Back to top](https://blog.prosody.im/prosody-0-8-1-released/)


