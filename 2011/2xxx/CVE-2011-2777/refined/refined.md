The content is related to CVE-2011-2777.

**Root cause of vulnerability:**
The vulnerability lies in the `powerbtn.sh` script, which is part of the `acpid` package. The script uses command substitution and `eval` to execute commands as the user logged into the current X session (`$XUSER`). It reads the environment variables of a process named `kded4` using `cat /proc/$(pidof kded4)/environ`. This allows a malicious user to inject arbitrary shell commands by creating a fake `kded4` process with a malicious `DBUS_SESSION_BUS_ADDRESS` environment variable.

**Weaknesses/vulnerabilities present:**
- Command injection through `eval` and improperly sanitized environment variables.
- Use of `pidof` which can return multiple process IDs.
- Reading environment variables from `/proc/<pid>/environ` of an arbitrary process.

**Impact of exploitation:**
An attacker can execute arbitrary code as the user logged into the current X session. This allows privilege escalation from a standard user to a user with an active X session.

**Attack vectors:**
- The attacker must be able to run an application on the system.
- The system must not have a power management daemon running.
- The `powerbtn.sh` script must be triggered, typically by pressing a power button or through a `virsh shutdown` command.
- The attacker needs to run a "fake" kded4 binary with a malicious DBUS\_SESSION\_BUS\_ADDRESS environment variable.

**Required attacker capabilities/position:**
- Ability to run an application on the system.
- The attacker does not need root privileges, but must be able to create and run a process on the system.
- The attacker needs to be able to trigger the `powerbtn.sh` script (e.g., by pressing the power button, or issuing a shutdown command via virsh.)

The vulnerability is addressed by ensuring that the `DBUS_SESSION_BUS_ADDRESS` environment variable is only read from a process owned by the user evaluating the variable, and by using `pgrep -u` instead of `pidof` to get a single pid for the correct user.