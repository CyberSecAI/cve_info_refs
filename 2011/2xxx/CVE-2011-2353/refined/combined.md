=== Content from trac.webkit.org_05f59afe_20250125_153043.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/88196/webkit "Changeset 88196")
* [Next Changeset](/changeset/88198/webkit "Changeset 88198") →

---

# Changeset 88197 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Jun 6, 2011, 3:28:33 PM
([14 years](/timeline?from=2011-06-06T15%3A28%3A33-07%3A00&precision=second "See timeline at Jun 6, 2011, 3:28:33 PM") ago)
Author:
Nate Chapin
Message:

Merge [r87959](/changeset/87959/webkit "<rdar://problem/9539920> and ...") to chromium/782.

< rdar://problem/9539920> and [​https://bugs.webkit.org/show\_bug.cgi?id=61950](https://bugs.webkit.org/show_bug.cgi?id=61950)

Repro crash loading certain webarchives after [r87566](/changeset/87566/webkit "First swipe at resolving <rdar://problem/9125145> and ...").

Reviewed by Oliver Hunt.

Source/WebCore:

Test: webarchive/loading/javascript-url-iframe-crash.html

* bindings/ScriptControllerBase.cpp:

(WebCore::ScriptController::executeIfJavaScriptURL): DocumentWriter::replaceDocument can

cause the DocumentLoader to be destroyed, so protect it with a Ref here.

LayoutTests:

* webarchive/loading/javascript-url-iframe-crash-expected.txt: Added.
* webarchive/loading/javascript-url-iframe-crash.html: Added.
* webarchive/loading/resources/javascript-url-iframe-crash.webarchive: Added.

Location:
[branches/chromium/782](/browser/webkit/branches/chromium/782?rev=88197)
Files:

1 edited
3 copied

* [LayoutTests/webarchive/loading/javascript-url-iframe-crash-expected.txt](/browser/webkit/branches/chromium/782/LayoutTests/webarchive/loading/javascript-url-iframe-crash-expected.txt?rev=88197 "Show entry in browser")
  (copied)
  *(copied from [trunk/LayoutTests/webarchive/loading/javascript-url-iframe-crash-expected.txt](/browser/webkit/trunk/LayoutTests/webarchive/loading/javascript-url-iframe-crash-expected.txt?rev=87959 "Show original file (revision 87959)")
  )*
* [LayoutTests/webarchive/loading/javascript-url-iframe-crash.html](/browser/webkit/branches/chromium/782/LayoutTests/webarchive/loading/javascript-url-iframe-crash.html?rev=88197 "Show entry in browser")
  (copied)
  *(copied from [trunk/LayoutTests/webarchive/loading/javascript-url-iframe-crash.html](/browser/webkit/trunk/LayoutTests/webarchive/loading/javascript-url-iframe-crash.html?rev=87959 "Show original file (revision 87959)")
  )*
* [LayoutTests/webarchive/loading/resources/javascript-url-iframe-crash.webarchive](/browser/webkit/branches/chromium/782/LayoutTests/webarchive/loading/resources/javascript-url-iframe-crash.webarchive?rev=88197 "Show entry in browser")
  (copied)
  *(copied from [trunk/LayoutTests/webarchive/loading/resources/javascript-url-iframe-crash.webarchive](/browser/webkit/trunk/LayoutTests/webarchive/loading/resources/javascript-url-iframe-crash.webarchive?rev=87959 "Show original file (revision 87959)")
  )*
* [Source/WebCore/bindings/ScriptControllerBase.cpp](/browser/webkit/branches/chromium/782/Source/WebCore/bindings/ScriptControllerBase.cpp?rev=88197 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [branches/chromium/782/Source/WebCore/bindings/ScriptControllerBase.cpp](/changeset/88197/webkit/branches/chromium/782/Source/WebCore/bindings/ScriptControllerBase.cpp "Show the changeset 88197 restricted to branches/chromium/782/Source/WebCore/bindings/ScriptControllerBase.cpp")

  | [r87756](/browser/webkit/trunk/Source/WebCore/bindings/ScriptControllerBase.cpp?rev=87756#L118 "Show revision 87756 of this file in browser") | [r88197](/browser/webkit/branches/chromium/782/Source/WebCore/bindings/ScriptControllerBase.cpp?rev=88197#L118 "Show revision 88197 of this file in browser") |  |
  | --- | --- | --- |
  | 118 | 118 | // We're still in a frame, so there should be a DocumentLoader. |
  | 119 | 119 | ASSERT(m\_frame->document()->loader()); |
  | 120 |  | if (DocumentLoader\* loader = m\_frame->document()->loader()) |
  |  | 120 |  |
  |  | 121 | // DocumentWriter::replaceDocument can cause the DocumentLoader to get deref'ed and possible destroyed, |
  |  | 122 | // so protect it with a RefPtr. |
  |  | 123 | if (RefPtr<DocumentLoader> loader = m\_frame->document()->loader()) |
  | 121 | 124 | loader->writer()->replaceDocument(scriptResult); |
  | 122 | 125 | } |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=88197)
* [Zip Archive](?format=zip&new=88197)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from trac.webkit.org_719162ed_20250125_153102.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/88812/webkit "Changeset 88812")
* [Next Changeset](/changeset/88814/webkit "Changeset 88814") →

---

# Changeset 88813 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Jun 14, 2011, 9:48:13 AM
([14 years](/timeline?from=2011-06-14T09%3A48%3A13-07%3A00&precision=second "See timeline at Jun 14, 2011, 9:48:13 AM") ago)
Author:
cevans@google.com
Message:

Merge 87756

BUG=84946

Review URL: [​http://codereview.chromium.org/7147018](http://codereview.chromium.org/7147018)

Location:
[branches/chromium/742/Source/WebCore](/browser/webkit/branches/chromium/742/Source/WebCore?rev=88813)
Files:

7 edited

* [WebCore.exp.in](/browser/webkit/branches/chromium/742/Source/WebCore/WebCore.exp.in?rev=88813 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [bindings/ScriptControllerBase.cpp](/browser/webkit/branches/chromium/742/Source/WebCore/bindings/ScriptControllerBase.cpp?rev=88813 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [dom/Document.cpp](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88813 "Show entry in browser")
  (modified)
  ([5 diffs](#file2 "Show differences"))
* [dom/Document.h](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.h?rev=88813 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [html/MediaDocument.cpp](/browser/webkit/branches/chromium/742/Source/WebCore/html/MediaDocument.cpp?rev=88813 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [html/PluginDocument.cpp](/browser/webkit/branches/chromium/742/Source/WebCore/html/PluginDocument.cpp?rev=88813 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [platform/mac/HTMLConverter.mm](/browser/webkit/branches/chromium/742/Source/WebCore/platform/mac/HTMLConverter.mm?rev=88813 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [branches/chromium/742/Source/WebCore/WebCore.exp.in](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/WebCore.exp.in "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/WebCore.exp.in")

  | [r84194](/browser/webkit/trunk/Source/WebCore/WebCore.exp.in?rev=84194#L1275 "Show revision 84194 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/WebCore.exp.in?rev=88813#L1275 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 1275 | 1275 | \_\_ZNK7WebCore8Document4bodyEv |
  | 1276 | 1276 | \_\_ZNK7WebCore8Document6domainEv |
  |  | 1277 | \_\_ZNK7WebCore8Document6loaderEv |
  | 1277 | 1278 | \_\_ZNK7WebCore8IntPointcv7CGPointEv |
  | 1278 | 1279 | \_\_ZNK7WebCore8IntPointcv8\_NSPointEv |
* ## [branches/chromium/742/Source/WebCore/bindings/ScriptControllerBase.cpp](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/bindings/ScriptControllerBase.cpp "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/bindings/ScriptControllerBase.cpp")

  | [r82028](/browser/webkit/trunk/Source/WebCore/bindings/ScriptControllerBase.cpp?rev=82028#L108 "Show revision 82028 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/bindings/ScriptControllerBase.cpp?rev=88813#L108 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 108 | 108 | //        synchronously can cause crashes: |
  | 109 | 109 | //        http://bugs.webkit.org/show\_bug.cgi?id=16782 |
  | 110 |  | if (shouldReplaceDocumentIfJavaScriptURL == ReplaceDocumentIfJavaScriptURL) |
  | 111 |  | m\_frame->document()->loader()->writer()->replaceDocument(scriptResult); |
  | 112 |  |  |
  |  | 110 | if (shouldReplaceDocumentIfJavaScriptURL == ReplaceDocumentIfJavaScriptURL) { |
  |  | 111 | // We're still in a frame, so there should be a DocumentLoader. |
  |  | 112 | ASSERT(m\_frame->document()->loader()); |
  |  | 113 | if (DocumentLoader\* loader = m\_frame->document()->loader()) |
  |  | 114 | loader->writer()->replaceDocument(scriptResult); |
  |  | 115 | } |
  | 113 | 116 | return true; |
  | 114 | 117 | } |
* ## [branches/chromium/742/Source/WebCore/dom/Document.cpp](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/dom/Document.cpp")

  | [r88810](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88810#L444 "Show revision 88810 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88813#L444 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 444 | 444 |  |
  | 445 | 445 | m\_frame = frame; |
  | 446 |  | ~~m\_documentLoader = frame ? frame->loader()->activeDocumentLoader() : 0;~~ |
  | 447 | 446 |  |
  | 448 | 447 | // We depend on the url getting immediately set in subframes, but we |
  | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88810#L3734) | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88813#L3733) |  |
  | 3734 | 3733 | bool foundDate = false; |
  | 3735 | 3734 | if (m\_frame) { |
  | 3736 |  | String httpLastModified = m\_documentLoader->response().httpHeaderField("Last-Modified"); |
  |  | 3735 | String httpLastModified; |
  |  | 3736 | if (DocumentLoader\* documentLoader = loader()) |
  |  | 3737 | httpLastModified = documentLoader->response().httpHeaderField("Last-Modified"); |
  | 3737 | 3738 | if (!httpLastModified.isEmpty()) { |
  | 3738 | 3739 | date.setMillisecondsSinceEpochForDateTime(parseDate(httpLastModified)); |
  | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88810#L4442) | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88813#L4443) |  |
  | 4442 | 4443 | // and https://bugs.webkit.org/show\_bug.cgi?id=19760 for further |
  | 4443 | 4444 | // discussion. |
  | 4444 |  | if (m\_documentLoader->substituteData().isValid()) |
  |  | 4445 |  |
  |  | 4446 | DocumentLoader\* documentLoader = loader(); |
  |  | 4447 | if (documentLoader && documentLoader->substituteData().isValid()) |
  | 4445 | 4448 | securityOrigin()->grantLoadLocalResources(); |
  | 4446 | 4449 | } |
  | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88810#L4523) | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88813#L4526) |  |
  | 4523 | 4526 | setURL(url); |
  | 4524 | 4527 | f->loader()->setOutgoingReferrer(url); |
  | 4525 |  | m\_documentLoader->replaceRequestURLForSameDocumentNavigation(url); |
  |  | 4528 |  |
  |  | 4529 | if (DocumentLoader\* documentLoader = loader()) |
  |  | 4530 | documentLoader->replaceRequestURLForSameDocumentNavigation(url); |
  | 4526 | 4531 | } |
  | 4527 | 4532 |  |
  | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88810#L4989) | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.cpp?rev=88813#L4994) |  |
  | 4989 | 4994 | #endif |
  | 4990 | 4995 |  |
  |  | 4996 | DocumentLoader\* Document::loader() const |
  |  | 4997 | { |
  |  | 4998 | if (!m\_frame) |
  |  | 4999 | return 0; |
  |  | 5000 |  |
  |  | 5001 | DocumentLoader\* loader = m\_frame->loader()->activeDocumentLoader(); |
  |  | 5002 | if (!loader) |
  |  | 5003 | return 0; |
  |  | 5004 |  |
  |  | 5005 | if (m\_frame->document() != this) |
  |  | 5006 | return 0; |
  |  | 5007 |  |
  |  | 5008 | return loader; |
  |  | 5009 | } |
  |  | 5010 |  |
  | 4991 | 5011 | } // namespace WebCore |
* ## [branches/chromium/742/Source/WebCore/dom/Document.h](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/dom/Document.h "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/dom/Document.h")

  | [r84169](/browser/webkit/trunk/Source/WebCore/dom/Document.h?rev=84169#L554 "Show revision 84169 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.h?rev=88813#L554 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 554 | 554 | bool visuallyOrdered() const { return m\_visuallyOrdered; } |
  | 555 | 555 |  |
  | 556 |  | void setDocumentLoader(DocumentLoader\* documentLoader) { m\_documentLoader = documentLoader; } |
  | 557 |  | DocumentLoader\* loader() const { return m\_documentLoader; } |
  |  | 556 | DocumentLoader\* loader() const; |
  | 558 | 557 |  |
  | 559 | 558 | void open(Document\* ownerDocument = 0); |
  | […](/browser/webkit/trunk/Source/WebCore/dom/Document.h?rev=84169#L1144) | […](/browser/webkit/branches/chromium/742/Source/WebCore/dom/Document.h?rev=88813#L1143) |  |
  | 1144 | 1143 |  |
  | 1145 | 1144 | Frame\* m\_frame; |
  | 1146 |  | ~~DocumentLoader\* m\_documentLoader;~~ |
  | 1147 | 1145 | OwnPtr<CachedResourceLoader> m\_cachedResourceLoader; |
  | 1148 | 1146 | RefPtr<DocumentParser> m\_parser; |
* ## [branches/chromium/742/Source/WebCore/html/MediaDocument.cpp](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/html/MediaDocument.cpp "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/html/MediaDocument.cpp")

  | [r78342](/browser/webkit/trunk/Source/WebCore/html/MediaDocument.cpp?rev=78342#L210 "Show revision 78342 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/html/MediaDocument.cpp?rev=88813#L210 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 210 | 210 | embedElement->setAttribute(nameAttr, "plugin"); |
  | 211 | 211 | embedElement->setAttribute(srcAttr, url().string()); |
  | 212 |  | embedElement->setAttribute(typeAttr, loader()->writer()->mimeType()); |
  |  | 212 |  |
  |  | 213 | DocumentLoader\* documentLoader = loader(); |
  |  | 214 | ASSERT(documentLoader); |
  |  | 215 | if (documentLoader) |
  |  | 216 | embedElement->setAttribute(typeAttr, documentLoader->writer()->mimeType()); |
  | 213 | 217 |  |
  | 214 | 218 | ExceptionCode ec; |
* ## [branches/chromium/742/Source/WebCore/html/PluginDocument.cpp](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/html/PluginDocument.cpp "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/html/PluginDocument.cpp")

  | [r78342](/browser/webkit/trunk/Source/WebCore/html/PluginDocument.cpp?rev=78342#L93 "Show revision 78342 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/html/PluginDocument.cpp?rev=88813#L93 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 93 | 93 | m\_embedElement->setAttribute(nameAttr, "plugin"); |
  | 94 | 94 | m\_embedElement->setAttribute(srcAttr, document()->url().string()); |
  | 95 |  | m\_embedElement->setAttribute(typeAttr, document()->loader()->writer()->mimeType()); |
  |  | 95 |  |
  |  | 96 | DocumentLoader\* loader = document()->loader(); |
  |  | 97 | ASSERT(loader); |
  |  | 98 | if (loader) |
  |  | 99 | m\_embedElement->setAttribute(typeAttr, loader->writer()->mimeType()); |
  | 96 | 100 |  |
  | 97 | 101 | static\_cast<PluginDocument\*>(document())->setPluginNode(m\_embedElement); |
* ## [branches/chromium/742/Source/WebCore/platform/mac/HTMLConverter.mm](/changeset/88813/webkit/branches/chromium/742/Source/WebCore/platform/mac/HTMLConverter.mm "Show the changeset 88813 restricted to branches/chromium/742/Source/WebCore/platform/mac/HTMLConverter.mm")

  | [r83204](/browser/webkit/trunk/Source/WebCore/platform/mac/HTMLConverter.mm?rev=83204#L1754 "Show revision 83204 of this file in browser") | [r88813](/browser/webkit/branches/chromium/742/Source/WebCore/platform/mac/HTMLConverter.mm?rev=88813#L1754 "Show revision 88813 of this file in browser") |  |
  | --- | --- | --- |
  | 1754 | 1754 | if (!attr.isEmpty()) { |
  | 1755 | 1755 | NSURL \*URL = element->document()->completeURL(attr); |
  | 1756 |  | wrapper = fileWrapperForURL(element->document()->loader(), URL); |
  |  | 1756 | if (DocumentLoader\* loader = element->document()->loader()) |
  |  | 1757 | wrapper = fileWrapperForURL(loader, URL); |
  | 1757 | 1758 | } |
  | 1758 | 1759 | if (!wrapper) { |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=88813)
* [Zip Archive](?format=zip&new=88813)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from bugs.chromium.org_0dd3c1fd_20250125_153102.html ===


