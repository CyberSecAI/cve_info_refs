```
Message-Id: <E1nzGx8-0006Rg-9q@xenbits.xenproject.org>
Date: Thu, 09 Jun 2022 12:07:54 +0000
From: Xen.org security team <security@....org>
To: xen-announce@...ts.xen.org, xen-devel@...ts.xen.org,
 xen-users@...ts.xen.org, oss-security@...ts.openwall.com
CC: Xen.org security team <security-team-members@....org>
Subject: Xen Security Advisory 401 v2 (CVE-2022-26362) - x86 pv: Race
 condition in typeref acquisition

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

            Xen Security Advisory CVE-2022-26362 / XSA-401
                               version 2

             x86 pv: Race condition in typeref acquisition

UPDATES IN VERSION 2
====================

Update 4.16 and 4.15 baselines.

Public release.

ISSUE DESCRIPTION
=================

Xen maintains a type reference count for pages, in addition to a regular
reference count.  This scheme is used to maintain invariants required
for Xen's safety, e.g. PV guests may not have direct writeable access to
pagetables; updates need auditing by Xen.

Unfortunately, the logic for acquiring a type reference has a race
condition, whereby a safely TLB flush is issued too early and creates a
window where the guest can re-establish the read/write mapping before
writeability is prohibited.

IMPACT
======

Malicious x86 PV guest administrators may be able to escalate privilege
so as to control the whole system.

VULNERABLE SYSTEMS
==================

All versions of Xen are vulnerable.

Only x86 PV guests can trigger this vulnerability.

To exploit the vulnerability, there needs to be an undue delay at just
the wrong moment in _get_page_type().  The degree to which an x86 PV
guest can practically control this race condition is unknown.

MITIGATION
==========

Not running x86 PV guests will avoid the vulnerability.

CREDITS
=======

This issue was discovered by Jann Horn of Google Project Zero.

RESOLUTION
==========

Applying the appropriate attached patches resolves this issue.

Note that patches for released versions are generally prepared to
apply to the stable branches, and may not apply cleanly to the most
recent release tarball.  Downstreams are encouraged to update to the
tip of the stable branch before applying these patches.

xsa401/xsa401-?.patch           xen-unstable
xsa401/xsa401-4.16-?.patch      Xen 4.16.x - Xen 4.14.x
xsa401/xsa401-4.13-?.patch      Xen 4.13.x
```
- **Root cause of vulnerability**: A race condition exists in the logic for acquiring a type reference for pages in Xen. A TLB flush is issued too early, creating a window where a PV guest can re-establish read/write mapping before writeability is prohibited.
- **Weaknesses/vulnerabilities present**: Race condition in type reference acquisition, specifically related to TLB flushing.
- **Impact of exploitation**: Malicious x86 PV guest administrators can escalate privileges to gain control of the whole system.
- **Attack vectors**: The vulnerability can be triggered by an x86 PV guest.
- **Required attacker capabilities/position**: The attacker needs to be a malicious administrator of an x86 PV guest. The attacker needs to create an undue delay at a specific moment in the `_get_page_type()` function. The practical ability of a guest to control this delay is unknown.