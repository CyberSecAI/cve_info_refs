=== Content from github.com_070746da_20250115_100403.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkkent030315%2FCVE-2022-42046)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkkent030315%2FCVE-2022-42046)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=kkent030315%2FCVE-2022-42046)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[kkent030315](/kkent030315)
/
**[CVE-2022-42046](/kkent030315/CVE-2022-42046)**
Public

* [Notifications](/login?return_to=%2Fkkent030315%2FCVE-2022-42046) You must be signed in to change notification settings
* [Fork
  26](/login?return_to=%2Fkkent030315%2FCVE-2022-42046)
* [Star
   163](/login?return_to=%2Fkkent030315%2FCVE-2022-42046)

CVE-2022-42046 Proof of Concept of wfshbr64.sys local privilege escalation via DKOM

### License

[MIT license](/kkent030315/CVE-2022-42046/blob/main/LICENSE)

[163
stars](/kkent030315/CVE-2022-42046/stargazers) [26
forks](/kkent030315/CVE-2022-42046/forks) [Branches](/kkent030315/CVE-2022-42046/branches) [Tags](/kkent030315/CVE-2022-42046/tags) [Activity](/kkent030315/CVE-2022-42046/activity)
 [Star](/login?return_to=%2Fkkent030315%2FCVE-2022-42046)

 [Notifications](/login?return_to=%2Fkkent030315%2FCVE-2022-42046) You must be signed in to change notification settings

* [Code](/kkent030315/CVE-2022-42046)
* [Issues
  0](/kkent030315/CVE-2022-42046/issues)
* [Pull requests
  0](/kkent030315/CVE-2022-42046/pulls)
* [Discussions](/kkent030315/CVE-2022-42046/discussions)
* [Actions](/kkent030315/CVE-2022-42046/actions)
* [Security](/kkent030315/CVE-2022-42046/security)
* [Insights](/kkent030315/CVE-2022-42046/pulse)

Additional navigation options

* [Code](/kkent030315/CVE-2022-42046)
* [Issues](/kkent030315/CVE-2022-42046/issues)
* [Pull requests](/kkent030315/CVE-2022-42046/pulls)
* [Discussions](/kkent030315/CVE-2022-42046/discussions)
* [Actions](/kkent030315/CVE-2022-42046/actions)
* [Security](/kkent030315/CVE-2022-42046/security)
* [Insights](/kkent030315/CVE-2022-42046/pulse)

# kkent030315/CVE-2022-42046

    main[Branches](/kkent030315/CVE-2022-42046/branches)[Tags](/kkent030315/CVE-2022-42046/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[23 Commits](/kkent030315/CVE-2022-42046/commits/main/) | | |
| [.vscode](/kkent030315/CVE-2022-42046/tree/main/.vscode ".vscode") | | [.vscode](/kkent030315/CVE-2022-42046/tree/main/.vscode ".vscode") |  |  |
| [EvilWfshbr](/kkent030315/CVE-2022-42046/tree/main/EvilWfshbr "EvilWfshbr") | | [EvilWfshbr](/kkent030315/CVE-2022-42046/tree/main/EvilWfshbr "EvilWfshbr") |  |  |
| [wfsexploit](/kkent030315/CVE-2022-42046/tree/main/wfsexploit "wfsexploit") | | [wfsexploit](/kkent030315/CVE-2022-42046/tree/main/wfsexploit "wfsexploit") |  |  |
| [.clang-format](/kkent030315/CVE-2022-42046/blob/main/.clang-format ".clang-format") | | [.clang-format](/kkent030315/CVE-2022-42046/blob/main/.clang-format ".clang-format") |  |  |
| [.gitignore](/kkent030315/CVE-2022-42046/blob/main/.gitignore ".gitignore") | | [.gitignore](/kkent030315/CVE-2022-42046/blob/main/.gitignore ".gitignore") |  |  |
| [EvilWfshbr.sln](/kkent030315/CVE-2022-42046/blob/main/EvilWfshbr.sln "EvilWfshbr.sln") | | [EvilWfshbr.sln](/kkent030315/CVE-2022-42046/blob/main/EvilWfshbr.sln "EvilWfshbr.sln") |  |  |
| [LICENSE](/kkent030315/CVE-2022-42046/blob/main/LICENSE "LICENSE") | | [LICENSE](/kkent030315/CVE-2022-42046/blob/main/LICENSE "LICENSE") |  |  |
| [README.md](/kkent030315/CVE-2022-42046/blob/main/README.md "README.md") | | [README.md](/kkent030315/CVE-2022-42046/blob/main/README.md "README.md") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# EvilWfshbr

[CVE-2022-42046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-42046) Proof of Concept of wfshbr64.sys local privilege escalation

wfshbr64.sys and wfshbr32.sys specially crafted payload allows arbitrary user to perform bitwise operation with arbitrary EPROCESS offset and flags value to purposely elevate the game process to CodeGen Full protection by manipulating `EPROCESS.Protection` and `EPROCESS.SignatureLevel` flags (security hole as a feature).

The driver is signed by Microsoft hardware compatibility publisher that is submitted via Microsoft Hardware Program.

This project was co-researched with [@DoranekoSystems](https://github.com/DoranekoSystems)

### **There is a rich Rust CLI version available [here](/kkent030315/CVE-2022-42046/blob/main/wfsexploit)**

* <https://www.virustotal.com/gui/file/b8807e365be2813b7eccd2e4c49afb0d1e131086715638b7a6307cd7d7e9556c>
* <https://www.virustotal.com/gui/file/89698cad598a56f9e45efffd15d1841e494a2409cc12279150a03842cd6bb7f3>

# License

MIT. See [LICENSE](/kkent030315/CVE-2022-42046/blob/main/LICENSE)

# Suggestion (For Developer)

1. Use [`ObRegisterCallbacks`](https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-obregistercallbacks) instead of forcefully elevating process protection by performing direct kernel object manipulation. There is a good example in [here](https://github.com/microsoft/Windows-driver-samples/tree/main/general/obcallback).

## 2. IRP

Do not reference IRP after completion. if you have driver verifier enabled you will get caught.

```
IofCompleteRequest(Irp, IO_NO_INCREMENT); // IRP is freed here
return Irp->IoStatus.Status;
```

Instead you should use local variable.

```
NTSTATUS status = STATUS_SUCCESS;
Irp->IoStatus.Status = status;
IofCompleteRequest(Irp, IO_NO_INCREMENT); // IRP is freed here
return status;
```

## 3. Context Process

It looks like you're checking null pointer against return value of `IoGetCurrentProcess`, but it never return null pointer by design so you do not have to check it.

```
PEPROCESS CurrentProcess = IoGetCurrentProcess();
  if ( !CurrentProcess ) // no need to check for null pointer
    break;
```

# The Trick

A while after the report, the developer implemented sneaky "additional verification" to defeat our first PoC instead of stepping down from making security holes as a feature.

Checks added to:

* `IOCTL_WFSHBR_REMOVE_FLAG`
* `IOCTL_WFSHBR_ADD_FLAG`
* `IOCTL_WFSHBR_AND_FLAG`

```
case IOCTL_WFSHBR_ADD_FLAG: // 0xAA013884
      if ( !KwfsVerifyCaller(Buffer) ) // verify caller
        break;
-     if ( Buffer->ArbitraryEProcessOffset >= 0x1000 ) // offset limitation check
+     if ( !KwfsVerifyOffsetAndFlags(Buffer->ArbitraryEProcessOffset,
+                                    Buffer->DesiredFlags) ) // verify the offset and flags
        break;
      *(ULONG*)(IoGetCurrentProcess() + Buffer->ArbitraryEProcessOffset) |= Buffer->DesiredFlags;
```

## KwfsVerifyOffsetAndFlags

This routine is designed to be called every time the client requests modification of EPROCESS, and performs verification of `Offset` provided by `ArbitraryEProcessOffset` field in this PoC ― and also `Flags` provided by `DesiredFlags` field in this PoC.

The verification is quite simple as it counts `1` bits in every bits field of provided flags and if the count greater than eight it will fail.

Possible flags pattern map is just four:

* `22 00 00 00`
* `00 22 00 00`
* `00 00 22 00`
* `00 00 00 22`

That said, performing following operations 4 times can guarantee that the at least one of attempt should be successfull:

* Subtract the `ArbitraryEProcessOffset` field by index: `offset - index`,
* And adjust bits in `DesiredFlags` field by index: `flag << (index * 8)`.

The offset is decremented, so the bitfield adjustment would cause offset to adjust in the bitwise operators.

```
*(ULONG*)(IoGetCurrentProcess() + offset) |= flags;
*(ULONG*)(IoGetCurrentProcess() + offset) &= ~flags;
```

We have added `WfsProtectProcessSupreme` and `WfsUnprotectProcessSupreme` functions which performs the attempt and defeated the new trick.

```
enum KwfsState {
  KwfsStateOnceCall = 0,
  KwfsStateNeedsValueEquality = 1,
  KwfsStateValueHasBeenSet = 2,
};

bool KwfsVerifyOffsetAndFlags(_In_ ULONG offset, _In_ ULONG offset flags)
{
  if (KwfsState::KwfsState == KwfsState::KwfsStateOnceCall) {
    g_KwfsVerifyState = KwfsState::KwfsStateValueHasBeenSet;
    g_KwfsVerifyStateOffset = offset;
    g_KwfsVerifyStateFlags = flags;
    if (offset < 0x1000) { // offset limitation check moved here
      auto bitcount = 0;
      for (auto i = 0; i < 32; ++i) { // count `1` bits in flags
        if (flags & (1 << i)) {
          ++bitcount;
        }
      }
      if (bitcount <= 8) { // count must less than nine
        g_KwfsVerifyState = 1;
        return true;
      }
    }
  }
  else
  {
    if (g_KwfsVerifyState != KwfsState::KwfsStateValueHasBeenSet
     || offset != g_KwfsVerifyStateOffset
     || flags != g_KwfsVerifyStateFlags) {
      return false;
    }
  }
  return false;
}
```

## About

CVE-2022-42046 Proof of Concept of wfshbr64.sys local privilege escalation via DKOM

### Topics

[cve-2022-42046](/topics/cve-2022-42046 "Topic: cve-2022-42046")
[cve-2022-48019](/topics/cve-2022-48019 "Topic: cve-2022-48019")

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/kkent030315/CVE-2022-42046/activity)
### Stars

[**163**
stars](/kkent030315/CVE-2022-42046/stargazers)
### Watchers

[**6**
watching](/kkent030315/CVE-2022-42046/watchers)
### Forks

[**26**
forks](/kkent030315/CVE-2022-42046/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fkkent030315%2FCVE-2022-42046&report=kkent030315+%28user%29)

## [Releases 2](/kkent030315/CVE-2022-42046/releases)

[v2
Latest

Dec 24, 2022](/kkent030315/CVE-2022-42046/releases/tag/v2)
[+ 1 release](/kkent030315/CVE-2022-42046/releases)

## [Contributors 2](/kkent030315/CVE-2022-42046/graphs/contributors)

## Languages

* [C++
  69.9%](/kkent030315/CVE-2022-42046/search?l=c%2B%2B)
* [Rust
  30.1%](/kkent030315/CVE-2022-42046/search?l=rust)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.wfs.games_20d917c3_20250115_100404.html ===


[![æ ªå¼ä¼ç¤¾WFS](/assets/img/rebranding/logo_wfsinc.svg)](/)

* [JP](/)
* [EN](/en-us/)

* [ABOUT](/about/)
* [SERVICE](/service/)
* [RECRUIT](/recruit/)
* [INTERVIEWS](/blog/)
* [NEWS](/news/)

* [![Facebook](/assets/img/icon_SNS_facebook.svg)](https://www.facebook.com/Wright-Flyer-Studios-356453898101755/)
* [![Twitter](/assets/img/icon_SNS_twitter.svg)](https://twitter.com/wfs_info)
* [![YouTube](/assets/img/icon_SNS_youtube.svg)](https://www.youtube.com/user/wrightflyerstudios)
* [![Instagram](/assets/img/icon_SNS_instagram.svg)](https://www.instagram.com/wfs_info)
* [![ãã³ãã³åç»](/assets/img/icon_SNS_nicovideo.svg)](http://ch.nicovideo.jp/wrightflyer)
* [![LINE](/assets/img/icon_SNS_line.svg)](https://line.me/R/ti/p/%40qbt2380y)
* [![WANTEDLY](/assets/img/icon_SNS_wantedly.svg)](https://www.wantedly.com/companies/wfs)
* [![note](/assets/img/rebranding/logo_note.svg)](https://note.com/wfs_blog/)

* [ãåãåãã](/contact/)

* [éå¶æ¹é](/operationpolicy.html)
* [ãã©ã¤ãã·ã¼ããªã·ã¼](/privacypolicy.html)
* [ãµã¤ãããªã·ã¼](/sitepolicy.html)
* [é»å­å¬å](/public-notice/)

[![æ ªå¼ä¼ç¤¾WFS](/assets/img/rebranding/logo_wfsinc.svg)](/)

* [ABOUT](/about/)
* [SERVICE](/service/)
* [RECRUIT](/recruit/)
* [INTERVIEWS](/blog/)
* [NEWS](/news/)

* [![Facebook](/assets/img/icon_SNS_facebook.svg)](https://www.facebook.com/Wright-Flyer-Studios-356453898101755/)
* [![Twitter](/assets/img/icon_SNS_twitter.svg)](https://twitter.com/wfs_info)
* [![YouTube](/assets/img/icon_SNS_youtube.svg)](https://www.youtube.com/user/wrightflyerstudios)
* [![Instagram](/assets/img/icon_SNS_instagram.svg)](https://www.instagram.com/wfs_info)
* [![ãã³ãã³åç»](/assets/img/icon_SNS_nicovideo.svg)](http://ch.nicovideo.jp/wrightflyer)
* [![LINE](/assets/img/icon_SNS_line.svg)](https://line.me/R/ti/p/%40qbt2380y)
* [![WANTEDLY](/assets/img/icon_SNS_wantedly.svg)](https://www.wantedly.com/companies/wfs)
* [![note](/assets/img/rebranding/logo_note.svg)](https://note.com/wfs_blog/)

* [ãåãåãã](/contact/)

* [éå¶æ¹é](/operationpolicy.html)
* [ãã©ã¤ãã·ã¼ããªã·ã¼](/privacypolicy.html)
* [ãµã¤ãããªã·ã¼](/sitepolicy.html)
* [é»å­å¬å](/public-notice/)

[ã·ã§ã¢](https://www.facebook.com/sharer/sharer.php?u&src=sdkpreparse)

[Tweet](https://twitter.com/share?ref_src=twsrc%5Etfw)
# Steamçããã³ãã¼ã³ãºã¬ããã«ãããæ¨©éææ ¼ã®èå¼±æ§

2022å¹´12æ20æ¥
æ ªå¼ä¼ç¤¾WFS

## æ¦è¦

Steamçããã³ãã¼ã³ãºã¬ããã®ãã¼ã¸ã§ã³2.5.0ä»¥åã«æ¨©éææ ¼ã®èå¼±æ§ãå­å¨ãã¾ãã

## å½±é¿ãåããã·ã¹ãã

å½±é¿ãåããè£½åã¯ä»¥ä¸ã®è£½åã§ãã

* è£½ååï¼Steamçããã³ãã¼ã³ãºã¬ãã
* è©²å½ãã¼ã¸ã§ã³ï¼2.5.0ä»¥å

## è©²å½è£½åã®ç¢ºèªæ¹æ³

ä½¿ç¨ãã¦ãããã¼ã¸ã§ã³çªå·ã®ç¢ºèªæ¹æ³ã¯ä»¥ä¸ã®éãã§ãã

1. ããã³ãã¼ã³ãºã¬ãããèµ·åããã
2. ã¿ã¤ãã«ç»é¢å³ä¸ã®ver: â.â.âãèµ·åãã¦ããããã³ãã¼ã³ãºã¬ããã®ãã¼ã¸ã§ã³çªå·ã§ãã
   ![](/news/assets/20221220_01/img_01.png)

## èå¼±æ§ã®èª¬æ

Steamçããã³ãã¼ã³ãºã¬ããã«çµã¿è¾¼ã¾ãã¦ããå¤é¨ãã³ãã¼è£½ã®ã¢ã³ããã¼ãã·ã¹ãã ã«æ¨©éææ ¼ã®èå¼±æ§ãå­å¨ãã¾ãã

## èå¼±æ§ãããããèå¨

å½è©²è£½åãã¤ã³ã¹ãã¼ã«ããã¦ããã³ã³ãã¥ã¼ã¿ä¸ã§ãæªæã®ãããã­ã°ã©ã ãSYSTEMæ¨©éã«ææ ¼ã»åä½ããã·ã¹ãã ã®æä½ãæ¹ç«ãæå ±æ¼æ´©ãªã©ãçºçããå¯è½æ§ãããã¾ãã

## å¯¾ç­æ¹æ³

ã¢ãããã¼ããå®æ½ããã

èå¼±æ§ãä¿®æ­£ãããã¼ã¸ã§ã³2.5.10ããªãªã¼ã¹ããã¦ããã¾ãã

Steamã¢ããªããã¢ãããã¼ããå®æ½ãã¦ãã ããã

## æ´æ°å±¥æ­´

2022/12/20 å¬é

## é£çµ¡å

<https://help.wfs.games/?action=inquiry_form&app_id=248672826512257&official=1>

[ãç¥ãã](/news/info/)

![](/assets/img/logo_main_01.png)

* [![Facebook](/assets/img/icon_SNS_facebook.svg)](https://www.facebook.com/Wright-Flyer-Studios-356453898101755/)
* [![Twitter](/assets/img/icon_SNS_twitter.svg)](https://twitter.com/wfs_info)
* [![YouTube](/assets/img/icon_SNS_youtube.svg)](https://www.youtube.com/user/wrightflyerstudios)
* [![Instagram](/assets/img/icon_SNS_instagram.svg)](https://www.instagram.com/wfs_info)
* [![ãã³ãã³åç»](/assets/img/icon_SNS_nicovideo.svg)](http://ch.nicovideo.jp/wrightflyer)
* [![LINE](/assets/img/icon_SNS_line.svg)](https://line.me/R/ti/p/%40qbt2380y)
* [![WANTEDLY](/assets/img/icon_SNS_wantedly.svg)](https://www.wantedly.com/companies/wfs)
* [![note](/assets/img/rebranding/logo_note.svg)](https://note.com/wfs_blog/)

* [ãåãåãã](/contact/)

* [éå¶æ¹é](/operationpolicy.html)
* [ãã©ã¤ãã·ã¼ããªã·ã¼](/privacypolicy.html)
* [ãµã¤ãããªã·ã¼](/sitepolicy.html)
* [é»å­å¬å](/public-notice/)

©WFS


