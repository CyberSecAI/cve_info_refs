=== Content from bugzilla.redhat.com_268d7bf0_20250114_194329.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D2064604)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D2064604)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D2064604)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 2064604

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 2064604**](show_bug.cgi?id=2064604)
(CVE-2022-1012)
- [CVE-2022-1012](https://access.redhat.com/security/cve/CVE-2022-1012) kernel: Small table perturb size in the TCP source port generation algorithm can lead to information leak

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2022-1012 kernel: Small table perturb size in the TCP source port generat...

| | [Keywords](describekeywords.cgi): | Reopened  Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED ERRATA | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2022-1012 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | Duplicates (1): | [CVE-2022-32296](show_bug.cgi?id=2096901 "CLOSED DUPLICATE - CVE-2022-32296 kernel: insufficient TCP source port randomness leads to client identification")  ([view as bug list](buglist.cgi?bug_id=2096901)) | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [2064867](show_bug.cgi?id=2064867) [2064868](show_bug.cgi?id=2064868) [2064869](show_bug.cgi?id=2064869) [2064870](show_bug.cgi?id=2064870) [2064871](show_bug.cgi?id=2064871) [2064872](show_bug.cgi?id=2064872) [2064873](show_bug.cgi?id=2064873) [2064874](show_bug.cgi?id=2064874) [2064875](show_bug.cgi?id=2064875) [2064876](show_bug.cgi?id=2064876) [2064877](show_bug.cgi?id=2064877) [2064878](show_bug.cgi?id=2064878) [2064879](show_bug.cgi?id=2064879) [2064880](show_bug.cgi?id=2064880) [2064881](show_bug.cgi?id=2064881) [2064883](show_bug.cgi?id=2064883) [2064884](show_bug.cgi?id=2064884) [2064885](show_bug.cgi?id=2064885) [2064886](show_bug.cgi?id=2064886) [2064887](show_bug.cgi?id=2064887) [2070048](show_bug.cgi?id=2070048) [2070049](show_bug.cgi?id=2070049) [2083483](show_bug.cgi?id=2083483) [2083484](show_bug.cgi?id=2083484) [2083598](show_bug.cgi?id=2083598) [2083599](show_bug.cgi?id=2083599) [2083600](show_bug.cgi?id=2083600) [2083601](show_bug.cgi?id=2083601) [2083602](show_bug.cgi?id=2083602) [2083603](show_bug.cgi?id=2083603) [2083604](show_bug.cgi?id=2083604) [2083605](show_bug.cgi?id=2083605) [2083606](show_bug.cgi?id=2083606) [2083607](show_bug.cgi?id=2083607) [2083608](show_bug.cgi?id=2083608) [2083609](show_bug.cgi?id=2083609) [2083630](show_bug.cgi?id=2083630 "CLOSED CURRENTRELEASE - CVE-2022-1012 - kernel: A vulnerability due to small table perturb size in the TCP source port generation algorithm lead to information leak. [ovirt-4.5]") [2087128](show_bug.cgi?id=2087128) [2087129](show_bug.cgi?id=2087129) [2087130](show_bug.cgi?id=2087130) [2087131](show_bug.cgi?id=2087131) [2087132](show_bug.cgi?id=2087132) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [2064600](show_bug.cgi?id=2064600) [2065289](show_bug.cgi?id=2065289) [2096903](show_bug.cgi?id=2096903) | | TreeView+ | [depends on](buglist.cgi?bug_id=2064604&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=2064604&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2022-03-16 09:08 UTC by Rohit Keshri | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-10-27 21:01 UTC ([History](show_activity.cgi?id=2064604)) | | [CC List:](page.cgi?id=fields.html#cclist) | 84 users (show)  acaringi adscvr airlied alciregi allarkin asavkov bhu bskeggs chris.cook chwhite crwood cww cye cyin dbohanno ddepaula debarbos dhoward dvlasenk ezulian fhrbata gnault guillier.anthony hdegoede hkrzesin hpa jarod jarodwilson jburrell jch jdenham jfaracco jferlan jforbes jglisse jlelli joe.lawrence jonathan josef jpoimboe jshortt jstancek jthierry jwboyer jwyatt kcarcia kernel-maint kernel-mgr kpatch-maint kwalker ldoskova lgoncalv linville lzampier masami256 mchehab mfalz michal.skrivanek mmilgram mperina mrehak mstowell nmurray ptalbert qzhao rhandlin rkeshri rparrazo rrobaina rvrbovsk rysulliv scweaver security-response-team steved tglozar tyberry vkumar walters wcosta williams wmealing ycote ykopkova zhijwang | | Fixed In Version: | kernel 5.18-rc6 | | | Doc Type: | If docs needed, set a value | | | Doc Text: | The Linux kernel's TCP source port generation algorithm in the TCP stack contains a flaw due to the small table perturb size. This flaw allows an attacker to positively distinguish a system among devices with identical hardware and software, which lasts until the device restarts. An attacker can guess the evolution of the internal state used for source port generation. This information is used to infer the TCP traffic patterns of the victim, guessing the number of outgoing TCP connections established in a specific time frame, which can lead to a system fingerprinting. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2023-10-23 19:04:15 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | |    Links | System | ID | Private | Priority | Status | Summary | Last Updated | | Red Hat Product Errata | [RHBA-2022:5457](https://access.redhat.com/errata/RHBA-2022%3A5457) | 0 | None | None | None | 2022-06-30 17:42:30 UTC | | Red Hat Product Errata | [RHBA-2022:5744](https://access.redhat.com/errata/RHBA-2022%3A5744) | 0 | None | None | None | 2022-07-27 17:36:57 UTC | | Red Hat Product Errata | [RHBA-2022:5746](https://access.redhat.com/errata/RHBA-2022%3A5746) | 0 | None | None | None | 2022-07-28 05:30:10 UTC | | Red Hat Product Errata | [RHBA-2022:5925](https://access.redhat.com/errata/RHBA-2022%3A5925) | 0 | None | None | None | 2022-08-08 16:24:39 UTC | | Red Hat Product Errata | [RHBA-2022:6189](https://access.redhat.com/errata/RHBA-2022%3A6189) | 0 | None | None | None | 2022-08-25 13:24:52 UTC | | Red Hat Product Errata | [RHBA-2022:6201](https://access.redhat.com/errata/RHBA-2022%3A6201) | 0 | None | None | None | 2022-08-29 12:21:49 UTC | | Red Hat Product Errata | [RHSA-2022:5214](https://access.redhat.com/errata/RHSA-2022%3A5214) | 0 | None | None | None | 2022-06-28 06:55:30 UTC | | Red Hat Product Errata | [RHSA-2022:5220](https://access.redhat.com/errata/RHSA-2022%3A5220) | 0 | None | None | None | 2022-06-28 07:55:29 UTC | | Red Hat Product Errata | [RHSA-2022:5224](https://access.redhat.com/errata/RHSA-2022%3A5224) | 0 | None | None | None | 2022-06-28 07:54:13 UTC | | Red Hat Product Errata | [RHSA-2022:5249](https://access.redhat.com/errata/RHSA-2022%3A5249) | 0 | None | None | None | 2022-06-28 14:59:30 UTC | | Red Hat Product Errata | [RHSA-2022:5267](https://access.redhat.com/errata/RHSA-2022%3A5267) | 0 | None | None | None | 2022-06-28 10:43:14 UTC | | Red Hat Product Errata | [RHSA-2022:5626](https://access.redhat.com/errata/RHSA-2022%3A5626) | 0 | None | None | None | 2022-07-19 21:06:11 UTC | | Red Hat Product Errata | [RHSA-2022:5633](https://access.redhat.com/errata/RHSA-2022%3A5633) | 0 | None | None | None | 2022-07-19 21:07:59 UTC | | Red Hat Product Errata | [RHSA-2022:5636](https://access.redhat.com/errata/RHSA-2022%3A5636) | 0 | None | None | None | 2022-07-19 15:28:44 UTC | | Red Hat Product Errata | [RHSA-2022:5819](https://access.redhat.com/errata/RHSA-2022%3A5819) | 0 | None | None | None | 2022-08-03 13:02:03 UTC | | Red Hat Product Errata | [RHSA-2022:5834](https://access.redhat.com/errata/RHSA-2022%3A5834) | 0 | None | None | None | 2022-08-02 08:15:35 UTC | | Red Hat Product Errata | [RHSA-2022:6551](https://access.redhat.com/errata/RHSA-2022%3A6551) | 0 | None | None | None | 2022-09-19 11:50:26 UTC | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2064604#c0)  Rohit Keshri    2022-03-16 09:08:37 UTC  ``` A flaw was found in the TCP source port generation algorithm in net/ipv4/tcp.c due to the small table perturb size. This flaw may allow an attacker to information leak and cause a denial of service problem.  When the table perturb size is small, an attacker can practically cover all table cells with remote destinations to the attacker server, and the attacker may observe source port information.  Also, Global table perturb is shared across network interfaces and namespaces. This allows information to be leaked between interfaces.  Reference: [https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/+/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/](https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/%2B/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/)   ```  [Comment 18](show_bug.cgi?id=2064604#c18)  chris.cook@baesystems.com    2022-06-20 13:09:21 UTC  ``` (In reply to Rohit Keshri from [comment #0](show_bug.cgi?id=2064604#c0)) > A memory leak problem was found in the TCP source port generation algorithm > in net/ipv4/tcp.c due to the small table perturb size. This flaw may allow > an attacker to information leak and may cause a denial of service problem. >  > Reference: > <https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/> > +/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/  Are the Doc Text and reference misaligned?: The description states that the bug lies within net/ipv4/tcp.c but [https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/+/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/](https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/%2B/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/) contains changes in many kernel source files _other_ than tcp.c.   ```  [Comment 19](show_bug.cgi?id=2064604#c19)  errata-xmlrpc    2022-06-28 06:55:25 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 9  Via RHSA-2022:5214 [https://access.redhat.com/errata/RHSA-2022:5214](https://access.redhat.com/errata/RHSA-2022%3A5214)   ```  [Comment 20](show_bug.cgi?id=2064604#c20)  errata-xmlrpc    2022-06-28 07:54:07 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8.2 Extended Update Support  Via RHSA-2022:5224 [https://access.redhat.com/errata/RHSA-2022:5224](https://access.redhat.com/errata/RHSA-2022%3A5224)   ```  [Comment 21](show_bug.cgi?id=2064604#c21)  errata-xmlrpc    2022-06-28 07:55:23 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8.2 Extended Update Support  Via RHSA-2022:5220 [https://access.redhat.com/errata/RHSA-2022:5220](https://access.redhat.com/errata/RHSA-2022%3A5220)   ```  [Comment 22](show_bug.cgi?id=2064604#c22)  errata-xmlrpc    2022-06-28 10:43:10 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 9  Via RHSA-2022:5267 [https://access.redhat.com/errata/RHSA-2022:5267](https://access.redhat.com/errata/RHSA-2022%3A5267)   ```  [Comment 23](show_bug.cgi?id=2064604#c23)  errata-xmlrpc    2022-06-28 14:59:25 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 9  Via RHSA-2022:5249 [https://access.redhat.com/errata/RHSA-2022:5249](https://access.redhat.com/errata/RHSA-2022%3A5249)   ```  [Comment 24](show_bug.cgi?id=2064604#c24)  John Haxby    2022-06-28 16:35:45 UTC  ``` (In reply to chris.cook from [comment #18](show_bug.cgi?id=2064604#c18)) > (In reply to Rohit Keshri from [comment #0](show_bug.cgi?id=2064604#c0)) > > A memory leak problem was found in the TCP source port generation algorithm > > in net/ipv4/tcp.c due to the small table perturb size. This flaw may allow > > an attacker to information leak and may cause a denial of service problem. > >  > > Reference: > > <https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/> > > +/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/ >  > Are the Doc Text and reference misaligned?: The description states that the > bug lies within net/ipv4/tcp.c but > <https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/> > +/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/ contains changes in many > kernel source files _other_ than tcp.c.  I believe this should actually be 4c2c8f03a5ab ("tcp: increase source port perturb table to 2^16").   ```  [Comment 25](show_bug.cgi?id=2064604#c25)  Guillaume Nault    2022-06-29 19:26:37 UTC  ``` (In reply to John Haxby from [comment #24](show_bug.cgi?id=2064604#c24)) > (In reply to chris.cook from [comment #18](show_bug.cgi?id=2064604#c18)) > > (In reply to Rohit Keshri from [comment #0](show_bug.cgi?id=2064604#c0)) > > > A memory leak problem was found in the TCP source port generation algorithm > > > in net/ipv4/tcp.c due to the small table perturb size. This flaw may allow > > > an attacker to information leak and may cause a denial of service problem. > > >  > > > Reference: > > > <https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/> > > > +/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/ > >  > > Are the Doc Text and reference misaligned?: The description states that the > > bug lies within net/ipv4/tcp.c but > > <https://kernel.googlesource.com/pub/scm/linux/kernel/git/jkirsher/net-queue/> > > +/b2d057560b8107c633b39aabe517ff9d93f285e3%5E%21/ contains changes in many > > kernel source files _other_ than tcp.c.  I understand the reference to tcp.c can be confusing, as it doesn't need to be modified. The core of the source port selection algorithm is actually implemented by __inet_hash_connect(), in net/ipv4/inet_hashtables.c (but its callers and a few helper functions also need to be modified). The commit cited in the description, that is commit b2d057560b81 ("secure_seq: use the 64 bits of the siphash for port offset calculation"), is just the first patch in the series to backport.  > I believe this should actually be 4c2c8f03a5ab ("tcp: increase source port > perturb table to 2^16").  Well, it's the whole ef5624898187 ("Merge branch 'insufficient-tcp-source-port-randomness'") series that needs to be backported (and is being backported). Commits b2d057560b81 ("secure_seq: use the 64 bits of the siphash for port offset calculation") and 4c2c8f03a5ab ("tcp: increase source port perturb table to 2^16") are both part of it.   ```  [Comment 26](show_bug.cgi?id=2064604#c26)  John Haxby    2022-06-29 19:38:43 UTC  ``` Ah.  Thank you.   ```  [Comment 27](show_bug.cgi?id=2064604#c27)  Mauro Matteo Cascella    2022-07-12 12:42:23 UTC  ``` This is the 'insufficient-tcp-source-port-randomness' series Guillaume was talking about: <https://github.com/torvalds/linux/commit/ef5624898187>  Individual upstream commits: <https://github.com/torvalds/linux/commit/b2d057560b81> <https://github.com/torvalds/linux/commit/9e9b70ae923b> <https://github.com/torvalds/linux/commit/4dfa9b438ee3> <https://github.com/torvalds/linux/commit/b2d057560b81> <https://github.com/torvalds/linux/commit/ca7af0402550> <https://github.com/torvalds/linux/commit/e9261476184b> <https://github.com/torvalds/linux/commit/4c2c8f03a5ab> <https://github.com/torvalds/linux/commit/e8161345ddbb>   ```  [Comment 30](show_bug.cgi?id=2064604#c30)  errata-xmlrpc    2022-07-19 15:28:40 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8.1 Update Services for SAP Solutions  Via RHSA-2022:5636 [https://access.redhat.com/errata/RHSA-2022:5636](https://access.redhat.com/errata/RHSA-2022%3A5636)   ```  [Comment 31](show_bug.cgi?id=2064604#c31)  errata-xmlrpc    2022-07-19 21:06:07 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8.4 Extended Update Support  Via RHSA-2022:5626 [https://access.redhat.com/errata/RHSA-2022:5626](https://access.redhat.com/errata/RHSA-2022%3A5626)   ```  [Comment 32](show_bug.cgi?id=2064604#c32)  errata-xmlrpc    2022-07-19 21:07:54 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8.4 Extended Update Support  Via RHSA-2022:5633 [https://access.redhat.com/errata/RHSA-2022:5633](https://access.redhat.com/errata/RHSA-2022%3A5633)   ```  [Comment 33](show_bug.cgi?id=2064604#c33)  guillier.anthony    2022-07-30 09:42:04 UTC  ``` I understand the fact that small table memory size can cause a DoS, but not the information leak. In case of overflow Linux's Kernel TCP source port generation algorithm will crash without leaking any information, in wroste case data will lack integrity but no confidentiality impact.. Did I misunderstood something?   ```  [Comment 34](show_bug.cgi?id=2064604#c34)  Rohit Keshri    2022-08-01 14:44:35 UTC  ``` *** [Bug 2096901](show_bug.cgi?id=2096901 "CLOSED DUPLICATE - CVE-2022-32296 kernel: insufficient TCP source port randomness leads to client identification") has been marked as a duplicate of this bug. ***   ```  [Comment 35](show_bug.cgi?id=2064604#c35)  Rohit Keshri    2022-08-01 18:14:10 UTC  ``` In reply to [comment #33](show_bug.cgi?id=2064604#c33): > I understand the fact that small table memory size can cause a DoS, but not > the information leak. In case of overflow Linux's Kernel TCP source port > generation algorithm will crash without leaking any information, in wroste > case data will lack integrity but no confidentiality impact.. > Did I misunderstood something?  Hello Team,  Observation has shown that this flaw may lead to information leak problems as well.   When the table perturb size is small, an attacker can practically cover all table cells with remote destinations to the attacker server, and the attacker may observe source port information.  Also, Global table perturb is shared across network interfaces and namespaces. This allows information to be leaked between interfaces.      Regards   ```  [Comment 36](show_bug.cgi?id=2064604#c36)  errata-xmlrpc    2022-08-02 08:15:29 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8  Via RHSA-2022:5834 [https://access.redhat.com/errata/RHSA-2022:5834](https://access.redhat.com/errata/RHSA-2022%3A5834)   ```  [Comment 37](show_bug.cgi?id=2064604#c37)  errata-xmlrpc    2022-08-03 13:01:59 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8  Via RHSA-2022:5819 [https://access.redhat.com/errata/RHSA-2022:5819](https://access.redhat.com/errata/RHSA-2022%3A5819)   ```  [Comment 39](show_bug.cgi?id=2064604#c39)  errata-xmlrpc    2022-09-19 11:50:20 UTC  ``` This issue has been addressed in the following products:    Red Hat Virtualization 4 for Red Hat Enterprise Linux 8  Via RHSA-2022:6551 [https://access.redhat.com/errata/RHSA-2022:6551](https://access.redhat.com/errata/RHSA-2022%3A6551)   ```  [Comment 44](show_bug.cgi?id=2064604#c44)  Product Security DevOps Team    2022-12-05 13:03:48 UTC  ``` This bug is now closed. Further updates for individual products will be reflected on the CVE page(s):  <https://access.redhat.com/security/cve/cve-2022-1012>   ```  [Comment 48](show_bug.cgi?id=2064604#c48)  Rodrigo A B Freire    2023-10-27 16:39:48 UTC  ``` The Linux kernel's TCP source port generation algorithm in the TCP stack contains a flaw due to the small table perturb size. This flaw allows an attacker to positively distinguish a system among devices with identical hardware and software, which lasts until the device restarts.  An attacker can guess the evolution of the internal state used for source port generation. This information is used to infer the TCP traffic patterns of the victim, guessing the number of outgoing TCP connections established in a specific time frame, which can lead to a system fingerprinting.  Red Hat Enterprise Linux version 7 (RHEL7) is not affected by this issue. While RHEL7 implements the TCP port randomization algorithm 3 (the Simple Hash-Based Port Selection Algorithm), which knowingly has shortcomings (as per RFC 6056, item 3.3.3), the object of study of this flaw was the TCP port selector algorithm 4, the Double-Hash Por Selection Algorithm, which is not existent in RHEL7.  This flaw is ranked as a Moderate impact due to: * Limited exposure of the data in the TCP stack; * The impact of this vulnerability is limited to a system fingerprinting; * The requirements to carry the attack are elevated, requiring monitoring of the data flow.  This CVE *DOES NOT* give respect to memory leaks or denial of service.  For more information: <https://arxiv.org/abs/2209.12993> <https://datatracker.ietf.org/doc/html/rfc6056#section-3.3.4> [https://lore.kernel.org/lkml/20220428124001.7428-1-w@1wt.eu/](https://lore.kernel.org/lkml/20220428124001.7428-1-w%401wt.eu/) <https://lwn.net/Articles/910435/>   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=2064604&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from access.redhat.com_a743ac1a_20250115_114958.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from lore.kernel.org_fef7edcc_20250114_194329.html ===

```
[linux-kernel.vger.kernel.org archive mirror](../../?t=20220428020050)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e6b131c6781e7de02c7bee40345b6e1d076fe3ec7) [PATCH net 0/7] insufficient TCP source port randomness
@ 2022-04-27  6:52 Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
                   ` [(6 more replies)](#r5c08169125b28c1ab02022b8fd437d57477dc7eb)
  [0 siblings, 7 replies; 20+ messages in thread](#r6b131c6781e7de02c7bee40345b6e1d076fe3ec7)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-1-w%401wt.eu/) / [raw](../../20220427065233.2075-1-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065314)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065314), Willy Tarreau

Hi,

In a not-yet published paper, Moshe Kol, Amit Klein, and Yossi Gilad
report being able to accurately identify a client by forcing it to emit
only 40 times more connections than the number of entries in the
table_perturb[] table, which is indexed by hashing the connection tuple.
The current 2^8 setting allows them to perform that attack with only 10k
connections, which is not hard to achieve in a few seconds.

Eric, Amit and I have been working on this for a few weeks now imagining,
testing and eliminating a number of approaches that Amit and his team were
still able to break or that were found to be too risky or too expensive,
and ended up with the simple improvements in this series that resists to
the attack, doesn't degrade the performance, and preserves a reliable port
selection algorithm to avoid connection failures, including the odd/even
port selection preference that allows bind() to always find a port quickly
even under strong connect() stress.

The approach relies on several factors:
  - resalting the hash secret that's used to choose the table_perturb[]
    entry every 10 seconds to eliminate slow attacks and force the
    attacker to forget everything that was learned after this delay.
    This already eliminates most of the problem because if a client
    stays silent for more than 10 seconds there's no link between the
    previous and the next patterns, and 10s isn't yet frequent enough
    to cause too frequent repetition of a same port that may induce a
    connection failure ;

  - adding small random increments to the source port. Previously, a
    random 0 or 1 was added every 16 ports. Now a random 0 to 7 is
    added after each port. This means that with the default 32768-60999
    range, a worst case rollover happens after 1764 connections, and
    an average of 3137. This doesn't stop statistical attacks but
    requires significantly more iterations of the same attack to
    confirm a guess.

  - increasing the table_perturb[] size from 2^8 to 2^16, which Amit
    says will require 2.6 million connections to be attacked with the
    changes above, making it pointless to get a fingerprint that will
    only last 10 seconds. Due to the size, the table was made dynamic.

  - a few minor improvements on the bits used from the hash, to eliminate
    some unfortunate correlations that may possibly have been exploited
    to design future attack models.

These changes were tested under the most extreme conditions, up to
1.1 million connections per second to one and a few targets, showing no
performance regression, and only 2 connection failures within 13 billion,
which is less than 2^-32 and perfectly within usual values.

The series is split into small reviewable changes and was already reviewed
by Amit and Eric.

Regards,
Willy

---
Eric Dumazet (1):
  tcp: resalt the secret every 10 seconds

Willy Tarreau (6):
  secure_seq: return the full 64-bit of the siphash
  tcp: use different parts of the port_offset for index and offset
  tcp: add small random increments to the source port
  tcp: dynamically allocate the perturb table used by source ports
  tcp: increase source port perturb table to 2^16
  tcp: drop the hash_32() part from the index calculation

 include/net/inet_hashtables.h |  2 +-
 include/net/secure_seq.h      |  2 +-
 net/core/secure_seq.c         | 14 ++++++++----
 net/ipv4/inet_hashtables.c    | 40 ++++++++++++++++++++++-------------
 4 files changed, 37 insertions(+), 21 deletions(-)

--
2.17.5

[^](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) [permalink](../../20220427065233.2075-1-w%401wt.eu/) [raw](../../20220427065233.2075-1-w%401wt.eu/raw) [reply](../../20220427065233.2075-1-w%401wt.eu/#R)	[[flat](../../20220427065233.2075-1-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-1-w%401wt.eu/t/#u)] [20+ messages in thread](#r6b131c6781e7de02c7bee40345b6e1d076fe3ec7)
```

---

```
[*](#e5c08169125b28c1ab02022b8fd437d57477dc7eb) [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  2022-04-27  9:56   ` [kernel test robot](#ma9b3acb17663d5d91fcaf66ab55905bee8260dc9)
                     ` [(2 more replies)](#ra9b3acb17663d5d91fcaf66ab55905bee8260dc9)
  2022-04-27  6:52 ` [[PATCH net 2/7] tcp: use different parts of the port_offset for index and offset](#mde76681c0c6902892966ff40160a2f7f78005a4f) Willy Tarreau
                   ` [(5 subsequent siblings)](#rde76681c0c6902892966ff40160a2f7f78005a4f)
  [6 siblings, 3 replies; 20+ messages in thread](#r5c08169125b28c1ab02022b8fd437d57477dc7eb)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-2-w%401wt.eu/) / [raw](../../20220427065233.2075-2-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065323)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065323), Willy Tarreau,
	Jason A . Donenfeld

SipHash replaced MD5 in secure_ipv4_port_ephemeral() via commit
7cd23e5300c1 ("secure_seq: use SipHash in place of MD5"), but the
output remained truncated to 32-bit only. In order to exploit more
bits from the hash, let's make the function return the full 64-bit
of siphash_3u32().

Cc: Jason A. Donenfeld <Jason@zx2c4.com>
Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
Cc: Amit Klein <aksecurity@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Willy Tarreau <w@1wt.eu>
---
 [include/net/inet_hashtables.h](#Z2e.:..:20220427065233.2075-2-w::401wt.eu:1include:net:inet_hashtables.h) | 2 +-
 [include/net/secure_seq.h](#Z2e.:..:20220427065233.2075-2-w::401wt.eu:1include:net:secure_seq.h)      | 2 +-
 [net/core/secure_seq.c](#Z2e.:..:20220427065233.2075-2-w::401wt.eu:1net:core:secure_seq.c)         | 2 +-
 [net/ipv4/inet_hashtables.c](#Z2e.:..:20220427065233.2075-2-w::401wt.eu:1net:ipv4:inet_hashtables.c)    | 6 +++---
 4 files [changed](#e5c08169125b28c1ab02022b8fd437d57477dc7eb), 6 insertions(+), 6 deletions(-)

[diff](#iZ2e.:..:20220427065233.2075-2-w::401wt.eu:1include:net:inet_hashtables.h) --git a/include/net/inet_hashtables.h b/include/net/inet_hashtables.h
index f72ec113ae56..98e1ec1a14f0 100644
--- a/include/net/inet_hashtables.h
+++ b/include/net/inet_hashtables.h
@@ -425,7 +425,7 @@ static inline void sk_rcv_saddr_set(struct sock *sk, __be32 addr)
 }

 int __inet_hash_connect(struct inet_timewait_death_row *death_row,
-			struct sock *sk, u32 port_offset,
+			struct sock *sk, u64 port_offset,
 			int (*check_established)(struct inet_timewait_death_row *,
 						 struct sock *, __u16,
 						 struct inet_timewait_sock **));
[diff](#iZ2e.:..:20220427065233.2075-2-w::401wt.eu:1include:net:secure_seq.h) --git a/include/net/secure_seq.h b/include/net/secure_seq.h
index d7d2495f83c2..5cea9ed9c773 100644
--- a/include/net/secure_seq.h
+++ b/include/net/secure_seq.h
@@ -4,7 +4,7 @@

 #include <linux/types.h>

-u32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport);
+u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport);
 u32 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,
 			       __be16 dport);
 u32 secure_tcp_seq(__be32 saddr, __be32 daddr,
[diff](#iZ2e.:..:20220427065233.2075-2-w::401wt.eu:1net:core:secure_seq.c) --git a/net/core/secure_seq.c b/net/core/secure_seq.c
index 9b8443774449..2cdd43a63f64 100644
--- a/net/core/secure_seq.c
+++ b/net/core/secure_seq.c
@@ -142,7 +142,7 @@ u32 secure_tcp_seq(__be32 saddr, __be32 daddr,
 }
 EXPORT_SYMBOL_GPL(secure_tcp_seq);

-u32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
+u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
 {
 	net_secret_init();
 	return siphash_3u32((__force u32)saddr, (__force u32)daddr,
[diff](#iZ2e.:..:20220427065233.2075-2-w::401wt.eu:1net:ipv4:inet_hashtables.c) --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
index 17440840a791..09cbad0488ca 100644
--- a/net/ipv4/inet_hashtables.c
+++ b/net/ipv4/inet_hashtables.c
@@ -504,7 +504,7 @@ static int __inet_check_established(struct inet_timewait_death_row *death_row,
 	return -EADDRNOTAVAIL;
 }

-static u32 inet_sk_port_offset(const struct sock *sk)
+static u64 inet_sk_port_offset(const struct sock *sk)
 {
 	const struct inet_sock *inet = inet_sk(sk);

@@ -734,7 +734,7 @@ EXPORT_SYMBOL_GPL(inet_unhash);
 static u32 table_perturb[1 << INET_TABLE_PERTURB_SHIFT];

 int __inet_hash_connect(struct inet_timewait_death_row *death_row,
-		struct sock *sk, u32 port_offset,
+		struct sock *sk, u64 port_offset,
 		int (*check_established)(struct inet_timewait_death_row *,
 			struct sock *, __u16, struct inet_timewait_sock **))
 {
@@ -859,7 +859,7 @@ int __inet_hash_connect(struct inet_timewait_death_row *death_row,
 int inet_hash_connect(struct inet_timewait_death_row *death_row,
 		      struct sock *sk)
 {
-	u32 port_offset = 0;
+	u64 port_offset = 0;

 	if (!inet_sk(sk)->inet_num)
 		port_offset = inet_sk_port_offset(sk);
--
2.17.5

[^](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) [permalink](../../20220427065233.2075-2-w%401wt.eu/) [raw](../../20220427065233.2075-2-w%401wt.eu/raw) [reply](../../20220427065233.2075-2-w%401wt.eu/#R) [related](../../20220427065233.2075-2-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-2-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-2-w%401wt.eu/t/#u)] [20+ messages in thread](#r5c08169125b28c1ab02022b8fd437d57477dc7eb)
```

---

```
[*](#ede76681c0c6902892966ff40160a2f7f78005a4f) [PATCH net 2/7] tcp: use different parts of the port_offset for index and offset
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 3/7] tcp: resalt the secret every 10 seconds](#m235da506563e932bafa39776a9ba05a4eb8850f3) Willy Tarreau
                   ` [(4 subsequent siblings)](#r235da506563e932bafa39776a9ba05a4eb8850f3)
  [6 siblings, 0 replies; 20+ messages in thread](#rde76681c0c6902892966ff40160a2f7f78005a4f)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-3-w%401wt.eu/) / [raw](../../20220427065233.2075-3-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065328)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065328), Willy Tarreau,
	Jason A . Donenfeld

Amit Klein suggests that we use different parts of port_offset for the
table's index and the port offset so that there is no direct relation
between them.

Cc: Jason A. Donenfeld <Jason@zx2c4.com>
Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
Cc: Amit Klein <aksecurity@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Willy Tarreau <w@1wt.eu>
---
 [net/ipv4/inet_hashtables.c](#Z2e.:..:20220427065233.2075-3-w::401wt.eu:1net:ipv4:inet_hashtables.c) | 2 +-
 1 file [changed](#ede76681c0c6902892966ff40160a2f7f78005a4f), 1 insertion(+), 1 deletion(-)

[diff](#iZ2e.:..:20220427065233.2075-3-w::401wt.eu:1net:ipv4:inet_hashtables.c) --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
index 09cbad0488ca..747f272da25b 100644
--- a/net/ipv4/inet_hashtables.c
+++ b/net/ipv4/inet_hashtables.c
@@ -777,7 +777,7 @@ int __inet_hash_connect(struct inet_timewait_death_row *death_row,
 	net_get_random_once(table_perturb, sizeof(table_perturb));
 	index = hash_32(port_offset, INET_TABLE_PERTURB_SHIFT);

-	offset = (READ_ONCE(table_perturb[index]) + port_offset) % remaining;
+	offset = (READ_ONCE(table_perturb[index]) + (port_offset >> 32)) % remaining;
 	/* In first pass we try ports of @low parity.
 	 * inet_csk_get_port() does the opposite choice.
 	 */
--
2.17.5

[^](#mde76681c0c6902892966ff40160a2f7f78005a4f) [permalink](../../20220427065233.2075-3-w%401wt.eu/) [raw](../../20220427065233.2075-3-w%401wt.eu/raw) [reply](../../20220427065233.2075-3-w%401wt.eu/#R) [related](../../20220427065233.2075-3-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-3-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-3-w%401wt.eu/t/#u)] [20+ messages in thread](#rde76681c0c6902892966ff40160a2f7f78005a4f)
```

---

```
[*](#e235da506563e932bafa39776a9ba05a4eb8850f3) [PATCH net 3/7] tcp: resalt the secret every 10 seconds
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 2/7] tcp: use different parts of the port_offset for index and offset](#mde76681c0c6902892966ff40160a2f7f78005a4f) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  2022-04-27 15:56   ` [Stephen Hemminger](#m70227889fcf3763b01f44ffd2661126efe29bdc3)
  2022-04-27  6:52 ` [[PATCH net 4/7] tcp: add small random increments to the source port](#m0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9) Willy Tarreau
                   ` [(3 subsequent siblings)](#r0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9)
  [6 siblings, 1 reply; 20+ messages in thread](#r235da506563e932bafa39776a9ba05a4eb8850f3)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-4-w%401wt.eu/) / [raw](../../20220427065233.2075-4-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065312)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065312)

From: Eric Dumazet <edumazet@google.com>

In order to limit the ability for an observer to recognize the source
ports sequence used to contact a set of destinations, we should
periodically shuffle the secret. 10 seconds looks effective enough
without causing particular issues.

Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
Cc: Amit Klein <aksecurity@gmail.com>
Tested-by: Willy Tarreau <w@1wt.eu>
Signed-off-by: Eric Dumazet <edumazet@google.com>
---
 [net/core/secure_seq.c](#Z2e.:..:20220427065233.2075-4-w::401wt.eu:1net:core:secure_seq.c) | 12 +++++++++---
 1 file [changed](#e235da506563e932bafa39776a9ba05a4eb8850f3), 9 insertions(+), 3 deletions(-)

[diff](#iZ2e.:..:20220427065233.2075-4-w::401wt.eu:1net:core:secure_seq.c) --git a/net/core/secure_seq.c b/net/core/secure_seq.c
index 2cdd43a63f64..200ab4686275 100644
--- a/net/core/secure_seq.c
+++ b/net/core/secure_seq.c
@@ -22,6 +22,8 @@
 static siphash_aligned_key_t net_secret;
 static siphash_aligned_key_t ts_secret;

+#define EPHEMERAL_PORT_SHUFFLE_PERIOD (10 * HZ)
+
 static __always_inline void net_secret_init(void)
 {
 	net_get_random_once(&net_secret, sizeof(net_secret));
@@ -101,10 +103,12 @@ u32 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,
 		struct in6_addr saddr;
 		struct in6_addr daddr;
 		__be16 dport;
+		unsigned int timeseed;
 	} __aligned(SIPHASH_ALIGNMENT) combined = {
 		.saddr = *(struct in6_addr *)saddr,
 		.daddr = *(struct in6_addr *)daddr,
-		.dport = dport
+		.dport = dport,
+		.timeseed = jiffies / EPHEMERAL_PORT_SHUFFLE_PERIOD,
 	};
 	net_secret_init();
 	return siphash(&combined, offsetofend(typeof(combined), dport),
@@ -145,8 +149,10 @@ EXPORT_SYMBOL_GPL(secure_tcp_seq);
 u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
 {
 	net_secret_init();
-	return siphash_3u32((__force u32)saddr, (__force u32)daddr,
-			    (__force u16)dport, &net_secret);
+	return siphash_4u32((__force u32)saddr, (__force u32)daddr,
+			    (__force u16)dport,
+			    jiffies / EPHEMERAL_PORT_SHUFFLE_PERIOD,
+			    &net_secret);
 }
 EXPORT_SYMBOL_GPL(secure_ipv4_port_ephemeral);
 #endif
--
2.17.5

[^](#m235da506563e932bafa39776a9ba05a4eb8850f3) [permalink](../../20220427065233.2075-4-w%401wt.eu/) [raw](../../20220427065233.2075-4-w%401wt.eu/raw) [reply](../../20220427065233.2075-4-w%401wt.eu/#R) [related](../../20220427065233.2075-4-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-4-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-4-w%401wt.eu/t/#u)] [20+ messages in thread](#r235da506563e932bafa39776a9ba05a4eb8850f3)
```

---

```
[*](#e0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9) [PATCH net 4/7] tcp: add small random increments to the source port
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
                   ` [(2 preceding siblings ...)](#r235da506563e932bafa39776a9ba05a4eb8850f3)
  2022-04-27  6:52 ` [[PATCH net 3/7] tcp: resalt the secret every 10 seconds](#m235da506563e932bafa39776a9ba05a4eb8850f3) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 5/7] tcp: dynamically allocate the perturb table used by source ports](#m55fdb5ca1511c61c5226e3f1ef629e05a94d38fd) Willy Tarreau
                   ` [(2 subsequent siblings)](#r55fdb5ca1511c61c5226e3f1ef629e05a94d38fd)
  [6 siblings, 0 replies; 20+ messages in thread](#r0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-5-w%401wt.eu/) / [raw](../../20220427065233.2075-5-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065336)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065336), Willy Tarreau

Here we're randomly adding between 0 and 7 random increments to the
selected source port in order to add some noise in the source port
selection that will make the next port less predictable.

With the default port range of 32768-60999 this means a worst case
reuse scenario of 14116/8=1764 connections between two consecutive
uses of the same port, with an average of 14116/4.5=3137. This code
was stressed at more than 800000 connections per second to a fixed
target with all connections closed by the client using RSTs (worst
condition) and only 2 connections failed among 13 billion, despite
the hash being reseeded every 10 seconds, indicating a perfectly
safe situation.

Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
Cc: Amit Klein <aksecurity@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Willy Tarreau <w@1wt.eu>
---
 [net/ipv4/inet_hashtables.c](#Z2e.:..:20220427065233.2075-5-w::401wt.eu:1net:ipv4:inet_hashtables.c) | 9 +++++----
 1 file [changed](#e0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9), 5 insertions(+), 4 deletions(-)

[diff](#iZ2e.:..:20220427065233.2075-5-w::401wt.eu:1net:ipv4:inet_hashtables.c) --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
index 747f272da25b..f58c5caf3130 100644
--- a/net/ipv4/inet_hashtables.c
+++ b/net/ipv4/inet_hashtables.c
@@ -831,11 +831,12 @@ int __inet_hash_connect(struct inet_timewait_death_row *death_row,
 	return -EADDRNOTAVAIL;

 ok:
-	/* If our first attempt found a candidate, skip next candidate
-	 * in 1/16 of cases to add some noise.
+	/* Here we want to add a little bit of randomness to the next source
+	 * port that will be chosen. We use a max() with a random here so that
+	 * on low contention the randomness is maximal and on high contention
+	 * it may be inexistent.
 	 */
-	if (!i && !(prandom_u32() % 16))
-		i = 2;
+	i = max_t(int, i, (prandom_u32() & 7) * 2);
 	WRITE_ONCE(table_perturb[index], READ_ONCE(table_perturb[index]) + i + 2);

 	/* Head lock still held and bh's disabled */
--
2.17.5

[^](#m0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9) [permalink](../../20220427065233.2075-5-w%401wt.eu/) [raw](../../20220427065233.2075-5-w%401wt.eu/raw) [reply](../../20220427065233.2075-5-w%401wt.eu/#R) [related](../../20220427065233.2075-5-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-5-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-5-w%401wt.eu/t/#u)] [20+ messages in thread](#r0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9)
```

---

```
[*](#e55fdb5ca1511c61c5226e3f1ef629e05a94d38fd) [PATCH net 5/7] tcp: dynamically allocate the perturb table used by source ports
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
                   ` [(3 preceding siblings ...)](#r0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9)
  2022-04-27  6:52 ` [[PATCH net 4/7] tcp: add small random increments to the source port](#m0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 6/7] tcp: increase source port perturb table to 2^16](#m0a1620f5272e3fcd9160ed8e0ca99977e40e89d6) Willy Tarreau
  2022-04-27  6:52 ` [[PATCH net 7/7] tcp: drop the hash_32() part from the index calculation](#mafb718195d39dd837247f19cffbe35962a1d6127) Willy Tarreau
  [6 siblings, 0 replies; 20+ messages in thread](#r55fdb5ca1511c61c5226e3f1ef629e05a94d38fd)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-6-w%401wt.eu/) / [raw](../../20220427065233.2075-6-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065354)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065354), Willy Tarreau

We'll need to further increase the size of this table and it's likely
that at some point its size will not be suitable anymore for a static
table. Let's allocate it on boot from inet_hashinfo2_init(), which is
called from tcp_init().

Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
Cc: Amit Klein <aksecurity@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Willy Tarreau <w@1wt.eu>
---
 [net/ipv4/inet_hashtables.c](#Z2e.:..:20220427065233.2075-6-w::401wt.eu:1net:ipv4:inet_hashtables.c) | 12 ++++++++++--
 1 file [changed](#e55fdb5ca1511c61c5226e3f1ef629e05a94d38fd), 10 insertions(+), 2 deletions(-)

[diff](#iZ2e.:..:20220427065233.2075-6-w::401wt.eu:1net:ipv4:inet_hashtables.c) --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
index f58c5caf3130..d746e5656baf 100644
--- a/net/ipv4/inet_hashtables.c
+++ b/net/ipv4/inet_hashtables.c
@@ -731,7 +731,8 @@ EXPORT_SYMBOL_GPL(inet_unhash);
  * privacy, this only consumes 1 KB of kernel memory.
  */
 #define INET_TABLE_PERTURB_SHIFT 8
-static u32 table_perturb[1 << INET_TABLE_PERTURB_SHIFT];
+#define INET_TABLE_PERTURB_SIZE (1 << INET_TABLE_PERTURB_SHIFT)
+static u32 *table_perturb;

 int __inet_hash_connect(struct inet_timewait_death_row *death_row,
 		struct sock *sk, u64 port_offset,
@@ -774,7 +775,8 @@ int __inet_hash_connect(struct inet_timewait_death_row *death_row,
 	if (likely(remaining > 1))
 		remaining &= ~1U;

-	net_get_random_once(table_perturb, sizeof(table_perturb));
+	net_get_random_once(table_perturb,
+			    INET_TABLE_PERTURB_SIZE * sizeof(*table_perturb));
 	index = hash_32(port_offset, INET_TABLE_PERTURB_SHIFT);

 	offset = (READ_ONCE(table_perturb[index]) + (port_offset >> 32)) % remaining;
@@ -910,6 +912,12 @@ void __init inet_hashinfo2_init(struct inet_hashinfo *h, const char *name,
 					    low_limit,
 					    high_limit);
 	init_hashinfo_lhash2(h);
+
+	/* this one is used for source ports of outgoing connections */
+	table_perturb = kmalloc_array(INET_TABLE_PERTURB_SIZE,
+				      sizeof(*table_perturb), GFP_KERNEL);
+	if (!table_perturb)
+		panic("TCP: failed to alloc table_perturb");
 }

 int inet_hashinfo2_init_mod(struct inet_hashinfo *h)
--
2.17.5

[^](#m55fdb5ca1511c61c5226e3f1ef629e05a94d38fd) [permalink](../../20220427065233.2075-6-w%401wt.eu/) [raw](../../20220427065233.2075-6-w%401wt.eu/raw) [reply](../../20220427065233.2075-6-w%401wt.eu/#R) [related](../../20220427065233.2075-6-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-6-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-6-w%401wt.eu/t/#u)] [20+ messages in thread](#r55fdb5ca1511c61c5226e3f1ef629e05a94d38fd)
```

---

```
[*](#e0a1620f5272e3fcd9160ed8e0ca99977e40e89d6) [PATCH net 6/7] tcp: increase source port perturb table to 2^16
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
                   ` [(4 preceding siblings ...)](#r55fdb5ca1511c61c5226e3f1ef629e05a94d38fd)
  2022-04-27  6:52 ` [[PATCH net 5/7] tcp: dynamically allocate the perturb table used by source ports](#m55fdb5ca1511c61c5226e3f1ef629e05a94d38fd) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  2022-04-27  8:07   ` [David Laight](#m877150e242a3cd952183f2e4c0c537ca9cfd1475)
  2022-04-27  6:52 ` [[PATCH net 7/7] tcp: drop the hash_32() part from the index calculation](#mafb718195d39dd837247f19cffbe35962a1d6127) Willy Tarreau
  [6 siblings, 1 reply; 20+ messages in thread](#r0a1620f5272e3fcd9160ed8e0ca99977e40e89d6)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-7-w%401wt.eu/) / [raw](../../20220427065233.2075-7-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065514)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065514), Willy Tarreau

Moshe Kol, Amit Klein, and Yossi Gilad reported being able to accurately
identify a client by forcing it to emit only 40 times more connections
than there are entries in the table_perturb[] table. The previous two
improvements consisting in resalting the secret every 10s and adding
randomness to each port selection only slightly improved the situation,
and the current value of 2^8 was too small as it's not very difficult
to make a client emit 10k connections in less than 10 seconds.

Thus we're increasing the perturb table from 2^8 to 2^16 so that the the
same precision now requires 2.6M connections, which is more difficult in
this time frame and harder to hide as a background activity. The impact
is that the table now uses 256 kB instead of 1 kB, which could mostly
affect devices making frequent outgoing connections. However such
components usually target a small set of destinations (load balancers,
database clients, perf assessment tools), and in practice only a few
entries will be visited, like before.

A live test at 1 million connections per second showed no performance
difference from the previous value.

Reported-by: Moshe Kol <moshe.kol@mail.huji.ac.il>
Reported-by: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
Reported-by: Amit Klein <aksecurity@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Willy Tarreau <w@1wt.eu>
---
 [net/ipv4/inet_hashtables.c](#Z2e.:..:20220427065233.2075-7-w::401wt.eu:1net:ipv4:inet_hashtables.c) | 9 +++++----
 1 file [changed](#e0a1620f5272e3fcd9160ed8e0ca99977e40e89d6), 5 insertions(+), 4 deletions(-)

[diff](#iZ2e.:..:20220427065233.2075-7-w::401wt.eu:1net:ipv4:inet_hashtables.c) --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
index d746e5656baf..f30c50aaf8e2 100644
--- a/net/ipv4/inet_hashtables.c
+++ b/net/ipv4/inet_hashtables.c
@@ -726,11 +726,12 @@ EXPORT_SYMBOL_GPL(inet_unhash);
  * Note that we use 32bit integers (vs RFC 'short integers')
  * because 2^16 is not a multiple of num_ephemeral and this
  * property might be used by clever attacker.
- * RFC claims using TABLE_LENGTH=10 buckets gives an improvement,
- * we use 256 instead to really give more isolation and
- * privacy, this only consumes 1 KB of kernel memory.
+ * RFC claims using TABLE_LENGTH=10 buckets gives an improvement, though
+ * attacks were since demonstrated, thus we use 65536 instead to really
+ * give more isolation and privacy, at the expense of 256kB of kernel
+ * memory.
  */
-#define INET_TABLE_PERTURB_SHIFT 8
+#define INET_TABLE_PERTURB_SHIFT 16
 #define INET_TABLE_PERTURB_SIZE (1 << INET_TABLE_PERTURB_SHIFT)
 static u32 *table_perturb;

--
2.17.5

[^](#m0a1620f5272e3fcd9160ed8e0ca99977e40e89d6) [permalink](../../20220427065233.2075-7-w%401wt.eu/) [raw](../../20220427065233.2075-7-w%401wt.eu/raw) [reply](../../20220427065233.2075-7-w%401wt.eu/#R) [related](../../20220427065233.2075-7-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-7-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-7-w%401wt.eu/t/#u)] [20+ messages in thread](#r0a1620f5272e3fcd9160ed8e0ca99977e40e89d6)
```

---

```
[*](#eafb718195d39dd837247f19cffbe35962a1d6127) [PATCH net 7/7] tcp: drop the hash_32() part from the index calculation
  2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
                   ` [(5 preceding siblings ...)](#r0a1620f5272e3fcd9160ed8e0ca99977e40e89d6)
  2022-04-27  6:52 ` [[PATCH net 6/7] tcp: increase source port perturb table to 2^16](#m0a1620f5272e3fcd9160ed8e0ca99977e40e89d6) Willy Tarreau
@ 2022-04-27  6:52 ` Willy Tarreau
  [6 siblings, 0 replies; 20+ messages in thread](#rafb718195d39dd837247f19cffbe35962a1d6127)
From: Willy Tarreau @ 2022-04-27  6:52 UTC ([permalink](../../20220427065233.2075-8-w%401wt.eu/) / [raw](../../20220427065233.2075-8-w%401wt.eu/raw))
  To: [netdev](../../../netdev/?t=20220427065359)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427065359), Willy Tarreau

In commit 190cc82489f4 ("tcp: change source port randomizarion at
connect() time"), the table_perturb[] array was introduced and an
index was taken from the port_offset via hash_32(). But it turns
out that hash_32() performs a multiplication while the input here
comes from the output of SipHash in secure_seq, that is well
distributed enough to avoid the need for yet another hash.

Suggested-by: Amit Klein <aksecurity@gmail.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Willy Tarreau <w@1wt.eu>
---
 [net/ipv4/inet_hashtables.c](#Z2e.:..:20220427065233.2075-8-w::401wt.eu:1net:ipv4:inet_hashtables.c) | 2 +-
 1 file [changed](#eafb718195d39dd837247f19cffbe35962a1d6127), 1 insertion(+), 1 deletion(-)

[diff](#iZ2e.:..:20220427065233.2075-8-w::401wt.eu:1net:ipv4:inet_hashtables.c) --git a/net/ipv4/inet_hashtables.c b/net/ipv4/inet_hashtables.c
index f30c50aaf8e2..a75e66d7eee6 100644
--- a/net/ipv4/inet_hashtables.c
+++ b/net/ipv4/inet_hashtables.c
@@ -778,7 +778,7 @@ int __inet_hash_connect(struct inet_timewait_death_row *death_row,

 	net_get_random_once(table_perturb,
 			    INET_TABLE_PERTURB_SIZE * sizeof(*table_perturb));
-	index = hash_32(port_offset, INET_TABLE_PERTURB_SHIFT);
+	index = port_offset & (INET_TABLE_PERTURB_SIZE - 1);

 	offset = (READ_ONCE(table_perturb[index]) + (port_offset >> 32)) % remaining;
 	/* In first pass we try ports of @low parity.
--
2.17.5

[^](#mafb718195d39dd837247f19cffbe35962a1d6127) [permalink](../../20220427065233.2075-8-w%401wt.eu/) [raw](../../20220427065233.2075-8-w%401wt.eu/raw) [reply](../../20220427065233.2075-8-w%401wt.eu/#R) [related](../../20220427065233.2075-8-w%401wt.eu/#related)	[[flat](../../20220427065233.2075-8-w%401wt.eu/T/#u)|[nested](../../20220427065233.2075-8-w%401wt.eu/t/#u)] [20+ messages in thread](#rafb718195d39dd837247f19cffbe35962a1d6127)
```

---

```
[*](#e877150e242a3cd952183f2e4c0c537ca9cfd1475) RE: [PATCH net 6/7] tcp: increase source port perturb table to 2^16
  2022-04-27  6:52 ` [[PATCH net 6/7] tcp: increase source port perturb table to 2^16](#m0a1620f5272e3fcd9160ed8e0ca99977e40e89d6) Willy Tarreau
@ 2022-04-27  8:07   ` David Laight
  2022-04-27  8:19     ` [Willy Tarreau](#m963658be32971fff98485ce053a4eef61b2a7360)
  [0 siblings, 1 reply; 20+ messages in thread](#r877150e242a3cd952183f2e4c0c537ca9cfd1475)
From: David Laight @ 2022-04-27  8:07 UTC ([permalink](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/) / [raw](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/raw))
  To: 'Willy Tarreau', [netdev@vger.kernel.org](../../../netdev/?t=20220427080740)
  Cc: David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel@vger.kernel.org](../../../lkml/?t=20220427080740)

From: Willy Tarreau
> Sent: 27 April 2022 07:53
>
> Moshe Kol, Amit Klein, and Yossi Gilad reported being able to accurately
> identify a client by forcing it to emit only 40 times more connections
> than there are entries in the table_perturb[] table. The previous two
> improvements consisting in resalting the secret every 10s and adding
> randomness to each port selection only slightly improved the situation,
> and the current value of 2^8 was too small as it's not very difficult
> to make a client emit 10k connections in less than 10 seconds.
>
> Thus we're increasing the perturb table from 2^8 to 2^16 so that the the
> same precision now requires 2.6M connections, which is more difficult in
> this time frame and harder to hide as a background activity. The impact
> is that the table now uses 256 kB instead of 1 kB, which could mostly
> affect devices making frequent outgoing connections. However such
> components usually target a small set of destinations (load balancers,
> database clients, perf assessment tools), and in practice only a few
> entries will be visited, like before.

Increasing the table size has a bigger impact on anyone trying
to get the kernel to run in a limited memory footprint.

All these large tables (often hash tables) soon add up.

	David

-
Registered Address Lakeside, Bramley Road, Mount Farm, Milton Keynes, MK1 1PT, UK
Registration No: 1397386 (Wales)

[^](#m877150e242a3cd952183f2e4c0c537ca9cfd1475) [permalink](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/) [raw](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/raw) [reply](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/#R)	[[flat](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/T/#u)|[nested](../../7372f788762140d496c157813b0173e5%40AcuMS.aculab.com/t/#u)] [20+ messages in thread](#r877150e242a3cd952183f2e4c0c537ca9cfd1475)
```

---

```
[*](#e963658be32971fff98485ce053a4eef61b2a7360) Re: [PATCH net 6/7] tcp: increase source port perturb table to 2^16
  2022-04-27  8:07   ` [David Laight](#m877150e242a3cd952183f2e4c0c537ca9cfd1475)
@ 2022-04-27  8:19     ` Willy Tarreau
  [0 siblings, 0 replies; 20+ messages in thread](#r963658be32971fff98485ce053a4eef61b2a7360)
From: Willy Tarreau @ 2022-04-27  8:19 UTC ([permalink](../../20220427081914.GA1724%401wt.eu/) / [raw](../../20220427081914.GA1724%401wt.eu/raw))
  To: David Laight
  Cc: [netdev@vger.kernel.org](../../../netdev/?t=20220427081939), David Miller, Jakub Kicinski,
	Eric Dumazet, Moshe Kol, Yossi Gilad, Amit Klein,
	[linux-kernel@vger.kernel.org](../../../lkml/?t=20220427081939)

On Wed, Apr 27, 2022 at 08:07:29AM +0000, David Laight wrote:
> From: Willy Tarreau
> > Sent: 27 April 2022 07:53
> >
> > Moshe Kol, Amit Klein, and Yossi Gilad reported being able to accurately
> > identify a client by forcing it to emit only 40 times more connections
> > than there are entries in the table_perturb[] table. The previous two
> > improvements consisting in resalting the secret every 10s and adding
> > randomness to each port selection only slightly improved the situation,
> > and the current value of 2^8 was too small as it's not very difficult
> > to make a client emit 10k connections in less than 10 seconds.
> >
> > Thus we're increasing the perturb table from 2^8 to 2^16 so that the the
> > same precision now requires 2.6M connections, which is more difficult in
> > this time frame and harder to hide as a background activity. The impact
> > is that the table now uses 256 kB instead of 1 kB, which could mostly
> > affect devices making frequent outgoing connections. However such
> > components usually target a small set of destinations (load balancers,
> > database clients, perf assessment tools), and in practice only a few
> > entries will be visited, like before.
>
> Increasing the table size has a bigger impact on anyone trying
> to get the kernel to run in a limited memory footprint.
>
> All these large tables (often hash tables) soon add up.

We know, and the initial approach that required a significantly larger
table and an extra table per namespace was a no-go. All these are part
of the reasons for the effort it took to refine the solution in order
to avoid such unacceptable costs. The way it was made here makes it easy
to patch the value for small systems if needed and leaves the door open
for a configurable setting in the future if that was estimated necessary
for certain environments.

Willy

[^](#m963658be32971fff98485ce053a4eef61b2a7360) [permalink](../../20220427081914.GA1724%401wt.eu/) [raw](../../20220427081914.GA1724%401wt.eu/raw) [reply](../../20220427081914.GA1724%401wt.eu/#R)	[[flat](../../20220427081914.GA1724%401wt.eu/T/#u)|[nested](../../20220427081914.GA1724%401wt.eu/t/#u)] [20+ messages in thread](#r963658be32971fff98485ce053a4eef61b2a7360)
```

---

```
[*](#ea9b3acb17663d5d91fcaf66ab55905bee8260dc9) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
@ 2022-04-27  9:56   ` kernel test robot
  2022-04-27 10:07     ` [Willy Tarreau](#m8a13f7358792fc66c42f6e629545db2b19114d6c)
  2022-04-27 17:18   ` [Jason A. Donenfeld](#m8103536b6c7a58b87d69b06366182c7d1d989634)
  2022-04-28  1:59   ` [kernel test robot](#md85250d580ac95cfcf7914e1fd3130fa0932d18c)
  [2 siblings, 1 reply; 20+ messages in thread](#ra9b3acb17663d5d91fcaf66ab55905bee8260dc9)
From: kernel test robot @ 2022-04-27  9:56 UTC ([permalink](../../202204271705.VrWNPv7n-lkp%40intel.com/) / [raw](../../202204271705.VrWNPv7n-lkp%40intel.com/raw))
  To: Willy Tarreau, [netdev](../../../netdev/?t=20220427104750)
  Cc: kbuild-all, Jakub Kicinski, Eric Dumazet, Moshe Kol, Yossi Gilad,
	Amit Klein, [linux-kernel](../../../lkml/?t=20220427104750), Willy Tarreau, Jason A . Donenfeld

Hi Willy,

I love your patch! Yet something to improve:

[auto build test ERROR on net/master]

url:    <https://github.com/intel-lab-lkp/linux/commits/Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651>
base:   <https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git> 71cffebf6358a7f5031f5b208bbdc1cb4db6e539
config: i386-randconfig-r026-20220425 ([https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp@intel.com/config](https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp%40intel.com/config))
compiler: gcc-11 (Debian 11.2.0-20) 11.2.0
reproduce (this is a W=1 build):
        # <https://github.com/intel-lab-lkp/linux/commit/01b26e522b598adf346b809075880feab3dcdc08>
        git remote add linux-review <https://github.com/intel-lab-lkp/linux>
        git fetch --no-tags linux-review Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651
        git checkout 01b26e522b598adf346b809075880feab3dcdc08
        # save the config file
        mkdir build_dir && cp config build_dir/.config
        make W=1 O=build_dir ARCH=i386 SHELL=/bin/bash

If you fix the issue, kindly add following tag as appropriate
Reported-by: kernel test robot <lkp@intel.com>

All errors (new ones prefixed by >>):

   ld: net/ipv4/inet_hashtables.o: in function `__inet_hash_connect':
>> inet_hashtables.c:(.text+0x187d): undefined reference to `__umoddi3'

--
0-DAY CI Kernel Test Service
<https://01.org/lkp>

[^](#ma9b3acb17663d5d91fcaf66ab55905bee8260dc9) [permalink](../../202204271705.VrWNPv7n-lkp%40intel.com/) [raw](../../202204271705.VrWNPv7n-lkp%40intel.com/raw) [reply](../../202204271705.VrWNPv7n-lkp%40intel.com/#R)	[[flat](../../202204271705.VrWNPv7n-lkp%40intel.com/T/#u)|[nested](../../202204271705.VrWNPv7n-lkp%40intel.com/t/#u)] [20+ messages in thread](#ra9b3acb17663d5d91fcaf66ab55905bee8260dc9)
```

---

```
[*](#e8a13f7358792fc66c42f6e629545db2b19114d6c) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27  9:56   ` [kernel test robot](#ma9b3acb17663d5d91fcaf66ab55905bee8260dc9)
@ 2022-04-27 10:07     ` Willy Tarreau
  2022-04-27 16:35       ` [Willy Tarreau](#ma88ce902e8fbadb0b2dee35a59f15bc50dc0ee31)
  [0 siblings, 1 reply; 20+ messages in thread](#r8a13f7358792fc66c42f6e629545db2b19114d6c)
From: Willy Tarreau @ 2022-04-27 10:07 UTC ([permalink](../../20220427100714.GC1724%401wt.eu/) / [raw](../../20220427100714.GC1724%401wt.eu/raw))
  To: kernel test robot
  Cc: [netdev](../../../netdev/?t=20220427104110), kbuild-all, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427104110), Jason A . Donenfeld

On Wed, Apr 27, 2022 at 05:56:41PM +0800, kernel test robot wrote:
> Hi Willy,
>
> I love your patch! Yet something to improve:
>
> [auto build test ERROR on net/master]
>
> url:    <https://github.com/intel-lab-lkp/linux/commits/Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651>
> base:   <https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git> 71cffebf6358a7f5031f5b208bbdc1cb4db6e539
> config: i386-randconfig-r026-20220425 ([https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp@intel.com/config](https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp%40intel.com/config))
> compiler: gcc-11 (Debian 11.2.0-20) 11.2.0
> reproduce (this is a W=1 build):
>         # <https://github.com/intel-lab-lkp/linux/commit/01b26e522b598adf346b809075880feab3dcdc08>
>         git remote add linux-review <https://github.com/intel-lab-lkp/linux>
>         git fetch --no-tags linux-review Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651
>         git checkout 01b26e522b598adf346b809075880feab3dcdc08
>         # save the config file
>         mkdir build_dir && cp config build_dir/.config
>         make W=1 O=build_dir ARCH=i386 SHELL=/bin/bash
>
> If you fix the issue, kindly add following tag as appropriate
> Reported-by: kernel test robot <lkp@intel.com>
>
> All errors (new ones prefixed by >>):
>
>    ld: net/ipv4/inet_hashtables.o: in function `__inet_hash_connect':
> >> inet_hashtables.c:(.text+0x187d): undefined reference to `__umoddi3'

Argh! indeed, we spoke about using div_u64_rem() at the beginning and
that one vanished over time. Will respin it.

Thanks,
Willy

[^](#m8a13f7358792fc66c42f6e629545db2b19114d6c) [permalink](../../20220427100714.GC1724%401wt.eu/) [raw](../../20220427100714.GC1724%401wt.eu/raw) [reply](../../20220427100714.GC1724%401wt.eu/#R)	[[flat](../../20220427100714.GC1724%401wt.eu/T/#u)|[nested](../../20220427100714.GC1724%401wt.eu/t/#u)] [20+ messages in thread](#r8a13f7358792fc66c42f6e629545db2b19114d6c)
```

---

```
[*](#e70227889fcf3763b01f44ffd2661126efe29bdc3) Re: [PATCH net 3/7] tcp: resalt the secret every 10 seconds
  2022-04-27  6:52 ` [[PATCH net 3/7] tcp: resalt the secret every 10 seconds](#m235da506563e932bafa39776a9ba05a4eb8850f3) Willy Tarreau
@ 2022-04-27 15:56   ` Stephen Hemminger
  2022-04-27 16:21     ` [Willy Tarreau](#m280cd267b7b8251daf13ca9a689279ba42c5eea0)
  [0 siblings, 1 reply; 20+ messages in thread](#r70227889fcf3763b01f44ffd2661126efe29bdc3)
From: Stephen Hemminger @ 2022-04-27 15:56 UTC ([permalink](../../20220427085621.5f2d1759%40hermes.local/) / [raw](../../20220427085621.5f2d1759%40hermes.local/raw))
  To: Willy Tarreau
  Cc: [netdev](../../../netdev/?t=20220427155720), David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427155720)

On Wed, 27 Apr 2022 08:52:29 +0200
Willy Tarreau <w@1wt.eu> wrote:

> From: Eric Dumazet <edumazet@google.com>
>
> In order to limit the ability for an observer to recognize the source
> ports sequence used to contact a set of destinations, we should
> periodically shuffle the secret. 10 seconds looks effective enough
> without causing particular issues.
>
> Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
> Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
> Cc: Amit Klein <aksecurity@gmail.com>
> Tested-by: Willy Tarreau <w@1wt.eu>
> Signed-off-by: Eric Dumazet <edumazet@google.com>
> ---
>  net/core/secure_seq.c | 12 +++++++++---
>  1 file changed, 9 insertions(+), 3 deletions(-)
>
> diff --git a/net/core/secure_seq.c b/net/core/secure_seq.c
> index 2cdd43a63f64..200ab4686275 100644
> --- a/net/core/secure_seq.c
> +++ b/net/core/secure_seq.c
> @@ -22,6 +22,8 @@
>  static siphash_aligned_key_t net_secret;
>  static siphash_aligned_key_t ts_secret;
>

Rather than hard coding, why not have a sysctl knob for this?
That way the tinfoil types can set it smaller.

[^](#m70227889fcf3763b01f44ffd2661126efe29bdc3) [permalink](../../20220427085621.5f2d1759%40hermes.local/) [raw](../../20220427085621.5f2d1759%40hermes.local/raw) [reply](../../20220427085621.5f2d1759%40hermes.local/#R)	[[flat](../../20220427085621.5f2d1759%40hermes.local/T/#u)|[nested](../../20220427085621.5f2d1759%40hermes.local/t/#u)] [20+ messages in thread](#r70227889fcf3763b01f44ffd2661126efe29bdc3)
```

---

```
[*](#e280cd267b7b8251daf13ca9a689279ba42c5eea0) Re: [PATCH net 3/7] tcp: resalt the secret every 10 seconds
  2022-04-27 15:56   ` [Stephen Hemminger](#m70227889fcf3763b01f44ffd2661126efe29bdc3)
@ 2022-04-27 16:21     ` Willy Tarreau
  [0 siblings, 0 replies; 20+ messages in thread](#r280cd267b7b8251daf13ca9a689279ba42c5eea0)
From: Willy Tarreau @ 2022-04-27 16:21 UTC ([permalink](../../20220427162158.GC3488%401wt.eu/) / [raw](../../20220427162158.GC3488%401wt.eu/raw))
  To: Stephen Hemminger
  Cc: [netdev](../../../netdev/?t=20220427162518), David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427162518)

Hi Stephen,

On Wed, Apr 27, 2022 at 08:56:21AM -0700, Stephen Hemminger wrote:
> On Wed, 27 Apr 2022 08:52:29 +0200
> Willy Tarreau <w@1wt.eu> wrote:
>
> > From: Eric Dumazet <edumazet@google.com>
> >
> > In order to limit the ability for an observer to recognize the source
> > ports sequence used to contact a set of destinations, we should
> > periodically shuffle the secret. 10 seconds looks effective enough
> > without causing particular issues.
> >
> > Cc: Moshe Kol <moshe.kol@mail.huji.ac.il>
> > Cc: Yossi Gilad <yossi.gilad@mail.huji.ac.il>
> > Cc: Amit Klein <aksecurity@gmail.com>
> > Tested-by: Willy Tarreau <w@1wt.eu>
> > Signed-off-by: Eric Dumazet <edumazet@google.com>
> > ---
> >  net/core/secure_seq.c | 12 +++++++++---
> >  1 file changed, 9 insertions(+), 3 deletions(-)
> >
> > diff --git a/net/core/secure_seq.c b/net/core/secure_seq.c
> > index 2cdd43a63f64..200ab4686275 100644
> > --- a/net/core/secure_seq.c
> > +++ b/net/core/secure_seq.c
> > @@ -22,6 +22,8 @@
> >  static siphash_aligned_key_t net_secret;
> >  static siphash_aligned_key_t ts_secret;
> >
>
> Rather than hard coding, why not have a sysctl knob for this?
> That way the tinfoil types can set it smaller.

It's a legit question. First I think that there's no good value; before
it used to be infinite, and now we're trying to figure a reasonable value
that make the attack impractical without going too close to the risk of
occasionally failing to establish a connection. I'm really not convinced
that there's any benefit in fiddling with that, except for breaking one's
stack by resalting too often and complaining about stupid network issues
with ACK or RST being sent in response to a SYN.

And stupidly, dividing jiffies by a constant known at build time is
slightly cheaper than dividing by a variable. I know it's a detail but
we tried hard to limit the accumulation of details here :-/

Just my two cents,
Willy

[^](#m280cd267b7b8251daf13ca9a689279ba42c5eea0) [permalink](../../20220427162158.GC3488%401wt.eu/) [raw](../../20220427162158.GC3488%401wt.eu/raw) [reply](../../20220427162158.GC3488%401wt.eu/#R)	[[flat](../../20220427162158.GC3488%401wt.eu/T/#u)|[nested](../../20220427162158.GC3488%401wt.eu/t/#u)] [20+ messages in thread](#r280cd267b7b8251daf13ca9a689279ba42c5eea0)
```

---

```
[*](#ea88ce902e8fbadb0b2dee35a59f15bc50dc0ee31) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27 10:07     ` [Willy Tarreau](#m8a13f7358792fc66c42f6e629545db2b19114d6c)
@ 2022-04-27 16:35       ` Willy Tarreau
  2022-04-27 16:50         ` [Eric Dumazet](#m74c404893bd00309b10eb6bd5d9d83b1800e4167)
  [0 siblings, 1 reply; 20+ messages in thread](#ra88ce902e8fbadb0b2dee35a59f15bc50dc0ee31)
From: Willy Tarreau @ 2022-04-27 16:35 UTC ([permalink](../../20220427163554.GA3746%401wt.eu/) / [raw](../../20220427163554.GA3746%401wt.eu/raw))
  To: kernel test robot
  Cc: [netdev](../../../netdev/?t=20220427163626), kbuild-all, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427163626), Jason A . Donenfeld

On Wed, Apr 27, 2022 at 12:07:14PM +0200, Willy Tarreau wrote:
> On Wed, Apr 27, 2022 at 05:56:41PM +0800, kernel test robot wrote:
> > Hi Willy,
> >
> > I love your patch! Yet something to improve:
> >
> > [auto build test ERROR on net/master]
> >
> > url:    <https://github.com/intel-lab-lkp/linux/commits/Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651>
> > base:   <https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git> 71cffebf6358a7f5031f5b208bbdc1cb4db6e539
> > config: i386-randconfig-r026-20220425 ([https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp@intel.com/config](https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp%40intel.com/config))
> > compiler: gcc-11 (Debian 11.2.0-20) 11.2.0
> > reproduce (this is a W=1 build):
> >         # <https://github.com/intel-lab-lkp/linux/commit/01b26e522b598adf346b809075880feab3dcdc08>
> >         git remote add linux-review <https://github.com/intel-lab-lkp/linux>
> >         git fetch --no-tags linux-review Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651
> >         git checkout 01b26e522b598adf346b809075880feab3dcdc08
> >         # save the config file
> >         mkdir build_dir && cp config build_dir/.config
> >         make W=1 O=build_dir ARCH=i386 SHELL=/bin/bash
> >
> > If you fix the issue, kindly add following tag as appropriate
> > Reported-by: kernel test robot <lkp@intel.com>
> >
> > All errors (new ones prefixed by >>):
> >
> >    ld: net/ipv4/inet_hashtables.o: in function `__inet_hash_connect':
> > >> inet_hashtables.c:(.text+0x187d): undefined reference to `__umoddi3'
>
> Argh! indeed, we spoke about using div_u64_rem() at the beginning and
> that one vanished over time. Will respin it.

I fixed it, built it for i386 and x86_64, tested it on x86_64 and confirmed
that it still does what I need. The change is only this:

-       offset = (READ_ONCE(table_perturb[index]) + (port_offset >> 32)) % remaining;
+       div_u64_rem(READ_ONCE(table_perturb[index]) + (port_offset >> 32), remaining, &offset);

I'll send a v2 series in a few hours if there are no more comments.

Willy

[^](#ma88ce902e8fbadb0b2dee35a59f15bc50dc0ee31) [permalink](../../20220427163554.GA3746%401wt.eu/) [raw](../../20220427163554.GA3746%401wt.eu/raw) [reply](../../20220427163554.GA3746%401wt.eu/#R)	[[flat](../../20220427163554.GA3746%401wt.eu/T/#u)|[nested](../../20220427163554.GA3746%401wt.eu/t/#u)] [20+ messages in thread](#ra88ce902e8fbadb0b2dee35a59f15bc50dc0ee31)
```

---

```
[*](#e74c404893bd00309b10eb6bd5d9d83b1800e4167) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27 16:35       ` [Willy Tarreau](#ma88ce902e8fbadb0b2dee35a59f15bc50dc0ee31)
@ 2022-04-27 16:50         ` Eric Dumazet
  2022-04-27 16:56           ` [Willy Tarreau](#m0bb46d7ab7c2a1f49c9c25d831c2114e4ded88fc)
  [0 siblings, 1 reply; 20+ messages in thread](#r74c404893bd00309b10eb6bd5d9d83b1800e4167)
From: Eric Dumazet @ 2022-04-27 16:50 UTC ([permalink](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/) / [raw](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/raw))
  To: Willy Tarreau
  Cc: kernel test robot, [netdev](../../../netdev/?t=20220427165026), kbuild-all, Jakub Kicinski, Moshe Kol,
	Yossi Gilad, Amit Klein, [LKML](../../../lkml/?t=20220427165026), Jason A . Donenfeld

On Wed, Apr 27, 2022 at 9:35 AM Willy Tarreau <w@1wt.eu> wrote:
>
> On Wed, Apr 27, 2022 at 12:07:14PM +0200, Willy Tarreau wrote:
> > On Wed, Apr 27, 2022 at 05:56:41PM +0800, kernel test robot wrote:
> > > Hi Willy,
> > >
> > > I love your patch! Yet something to improve:
> > >
> > > [auto build test ERROR on net/master]
> > >
> > > url:    <https://github.com/intel-lab-lkp/linux/commits/Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651>
> > > base:   <https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git> 71cffebf6358a7f5031f5b208bbdc1cb4db6e539
> > > config: i386-randconfig-r026-20220425 ([https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp@intel.com/config](https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp%40intel.com/config))
> > > compiler: gcc-11 (Debian 11.2.0-20) 11.2.0
> > > reproduce (this is a W=1 build):
> > >         # <https://github.com/intel-lab-lkp/linux/commit/01b26e522b598adf346b809075880feab3dcdc08>
> > >         git remote add linux-review <https://github.com/intel-lab-lkp/linux>
> > >         git fetch --no-tags linux-review Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651
> > >         git checkout 01b26e522b598adf346b809075880feab3dcdc08
> > >         # save the config file
> > >         mkdir build_dir && cp config build_dir/.config
> > >         make W=1 O=build_dir ARCH=i386 SHELL=/bin/bash
> > >
> > > If you fix the issue, kindly add following tag as appropriate
> > > Reported-by: kernel test robot <lkp@intel.com>
> > >
> > > All errors (new ones prefixed by >>):
> > >
> > >    ld: net/ipv4/inet_hashtables.o: in function `__inet_hash_connect':
> > > >> inet_hashtables.c:(.text+0x187d): undefined reference to `__umoddi3'
> >
> > Argh! indeed, we spoke about using div_u64_rem() at the beginning and
> > that one vanished over time. Will respin it.
>
> I fixed it, built it for i386 and x86_64, tested it on x86_64 and confirmed
> that it still does what I need. The change is only this:
>
> -       offset = (READ_ONCE(table_perturb[index]) + (port_offset >> 32)) % remaining;
> +       div_u64_rem(READ_ONCE(table_perturb[index]) + (port_offset >> 32), remaining, &offset);
>
> I'll send a v2 series in a few hours if there are no more comments.

We really do not need 33 bits here.

I would suggest using a 32bit divide.

offset = READ_ONCE(table_perturb[index]) + (port_offset >> 32));
offset %= remaining;

[^](#m74c404893bd00309b10eb6bd5d9d83b1800e4167) [permalink](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/) [raw](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/raw) [reply](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/#R)	[[flat](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/T/#u)|[nested](../../CANn89iJTg8KZvDQ2wY%3DpsThvS5eFzv0N15FF3CTf3i6qui%3DwsQ%40mail.gmail.com/t/#u)] [20+ messages in thread](#r74c404893bd00309b10eb6bd5d9d83b1800e4167)
```

---

```
[*](#e0bb46d7ab7c2a1f49c9c25d831c2114e4ded88fc) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27 16:50         ` [Eric Dumazet](#m74c404893bd00309b10eb6bd5d9d83b1800e4167)
@ 2022-04-27 16:56           ` Willy Tarreau
  [0 siblings, 0 replies; 20+ messages in thread](#r0bb46d7ab7c2a1f49c9c25d831c2114e4ded88fc)
From: Willy Tarreau @ 2022-04-27 16:56 UTC ([permalink](../../20220427165649.GA3756%401wt.eu/) / [raw](../../20220427165649.GA3756%401wt.eu/raw))
  To: Eric Dumazet
  Cc: kernel test robot, [netdev](../../../netdev/?t=20220427165837), kbuild-all, Jakub Kicinski, Moshe Kol,
	Yossi Gilad, Amit Klein, [LKML](../../../lkml/?t=20220427165837), Jason A . Donenfeld

On Wed, Apr 27, 2022 at 09:50:06AM -0700, Eric Dumazet wrote:
> On Wed, Apr 27, 2022 at 9:35 AM Willy Tarreau <w@1wt.eu> wrote:
> >
> > On Wed, Apr 27, 2022 at 12:07:14PM +0200, Willy Tarreau wrote:
> > > On Wed, Apr 27, 2022 at 05:56:41PM +0800, kernel test robot wrote:
> > > > Hi Willy,
> > > >
> > > > I love your patch! Yet something to improve:
> > > >
> > > > [auto build test ERROR on net/master]
> > > >
> > > > url:    <https://github.com/intel-lab-lkp/linux/commits/Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651>
> > > > base:   <https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git> 71cffebf6358a7f5031f5b208bbdc1cb4db6e539
> > > > config: i386-randconfig-r026-20220425 ([https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp@intel.com/config](https://download.01.org/0day-ci/archive/20220427/202204271705.VrWNPv7n-lkp%40intel.com/config))
> > > > compiler: gcc-11 (Debian 11.2.0-20) 11.2.0
> > > > reproduce (this is a W=1 build):
> > > >         # <https://github.com/intel-lab-lkp/linux/commit/01b26e522b598adf346b809075880feab3dcdc08>
> > > >         git remote add linux-review <https://github.com/intel-lab-lkp/linux>
> > > >         git fetch --no-tags linux-review Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651
> > > >         git checkout 01b26e522b598adf346b809075880feab3dcdc08
> > > >         # save the config file
> > > >         mkdir build_dir && cp config build_dir/.config
> > > >         make W=1 O=build_dir ARCH=i386 SHELL=/bin/bash
> > > >
> > > > If you fix the issue, kindly add following tag as appropriate
> > > > Reported-by: kernel test robot <lkp@intel.com>
> > > >
> > > > All errors (new ones prefixed by >>):
> > > >
> > > >    ld: net/ipv4/inet_hashtables.o: in function `__inet_hash_connect':
> > > > >> inet_hashtables.c:(.text+0x187d): undefined reference to `__umoddi3'
> > >
> > > Argh! indeed, we spoke about using div_u64_rem() at the beginning and
> > > that one vanished over time. Will respin it.
> >
> > I fixed it, built it for i386 and x86_64, tested it on x86_64 and confirmed
> > that it still does what I need. The change is only this:
> >
> > -       offset = (READ_ONCE(table_perturb[index]) + (port_offset >> 32)) % remaining;
> > +       div_u64_rem(READ_ONCE(table_perturb[index]) + (port_offset >> 32), remaining, &offset);
> >
> > I'll send a v2 series in a few hours if there are no more comments.
>
> We really do not need 33 bits here.
>
> I would suggest using a 32bit divide.
>
> offset = READ_ONCE(table_perturb[index]) + (port_offset >> 32));
> offset %= remaining;

Yeah much better indeed, I'll do that. Thanks Eric!

Willy

[^](#m0bb46d7ab7c2a1f49c9c25d831c2114e4ded88fc) [permalink](../../20220427165649.GA3756%401wt.eu/) [raw](../../20220427165649.GA3756%401wt.eu/raw) [reply](../../20220427165649.GA3756%401wt.eu/#R)	[[flat](../../20220427165649.GA3756%401wt.eu/T/#u)|[nested](../../20220427165649.GA3756%401wt.eu/t/#u)] [20+ messages in thread](#r0bb46d7ab7c2a1f49c9c25d831c2114e4ded88fc)
```

---

```
[*](#e8103536b6c7a58b87d69b06366182c7d1d989634) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
  2022-04-27  9:56   ` [kernel test robot](#ma9b3acb17663d5d91fcaf66ab55905bee8260dc9)
@ 2022-04-27 17:18   ` Jason A. Donenfeld
  2022-04-27 20:19     ` [Willy Tarreau](#m48ffeb2eefcb403d2175d30fd3ba48618546ac32)
  2022-04-28  1:59   ` [kernel test robot](#md85250d580ac95cfcf7914e1fd3130fa0932d18c)
  [2 siblings, 1 reply; 20+ messages in thread](#r8103536b6c7a58b87d69b06366182c7d1d989634)
From: Jason A. Donenfeld @ 2022-04-27 17:18 UTC ([permalink](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/) / [raw](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/raw))
  To: Willy Tarreau
  Cc: [netdev](../../../netdev/?t=20220427171907), David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427171907)

Hi Willy,

On Wed, Apr 27, 2022 at 08:52:27AM +0200, Willy Tarreau wrote:
> diff --git a/include/net/secure_seq.h b/include/net/secure_seq.h
> index d7d2495f83c2..5cea9ed9c773 100644
> --- a/include/net/secure_seq.h
> +++ b/include/net/secure_seq.h
> @@ -4,7 +4,7 @@
>
>  #include <linux/types.h>
>
> -u32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport);
> +u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport);
>  u32 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,
>  			       __be16 dport);
>  u32 secure_tcp_seq(__be32 saddr, __be32 daddr,
> diff --git a/net/core/secure_seq.c b/net/core/secure_seq.c
> index 9b8443774449..2cdd43a63f64 100644
> --- a/net/core/secure_seq.c
> +++ b/net/core/secure_seq.c
> @@ -142,7 +142,7 @@ u32 secure_tcp_seq(__be32 saddr, __be32 daddr,
>  }
>  EXPORT_SYMBOL_GPL(secure_tcp_seq);
>
> -u32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
> +u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
>  {
>  	net_secret_init();
>  	return siphash_3u32((__force u32)saddr, (__force u32)daddr,

Should you be doing the same with secure_ipv6_port_ephemeral() too? Why
the asymmetry?

Jason

[^](#m8103536b6c7a58b87d69b06366182c7d1d989634) [permalink](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/) [raw](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/raw) [reply](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/#R)	[[flat](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/T/#u)|[nested](../../Yml6%2BPKmxW7VSHch%40zx2c4.com/t/#u)] [20+ messages in thread](#r8103536b6c7a58b87d69b06366182c7d1d989634)
```

---

```
[*](#e48ffeb2eefcb403d2175d30fd3ba48618546ac32) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27 17:18   ` [Jason A. Donenfeld](#m8103536b6c7a58b87d69b06366182c7d1d989634)
@ 2022-04-27 20:19     ` Willy Tarreau
  [0 siblings, 0 replies; 20+ messages in thread](#r48ffeb2eefcb403d2175d30fd3ba48618546ac32)
From: Willy Tarreau @ 2022-04-27 20:19 UTC ([permalink](../../20220427201938.GC4326%401wt.eu/) / [raw](../../20220427201938.GC4326%401wt.eu/raw))
  To: Jason A. Donenfeld
  Cc: [netdev](../../../netdev/?t=20220427202003), David Miller, Jakub Kicinski, Eric Dumazet, Moshe Kol,
	Yossi Gilad, Amit Klein, [linux-kernel](../../../lkml/?t=20220427202003)

Hi Jason,

On Wed, Apr 27, 2022 at 07:18:48PM +0200, Jason A. Donenfeld wrote:
> Hi Willy,
>
> On Wed, Apr 27, 2022 at 08:52:27AM +0200, Willy Tarreau wrote:
> > diff --git a/include/net/secure_seq.h b/include/net/secure_seq.h
> > index d7d2495f83c2..5cea9ed9c773 100644
> > --- a/include/net/secure_seq.h
> > +++ b/include/net/secure_seq.h
> > @@ -4,7 +4,7 @@
> >
> >  #include <linux/types.h>
> >
> > -u32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport);
> > +u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport);
> >  u32 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,
> >  			       __be16 dport);
> >  u32 secure_tcp_seq(__be32 saddr, __be32 daddr,
> > diff --git a/net/core/secure_seq.c b/net/core/secure_seq.c
> > index 9b8443774449..2cdd43a63f64 100644
> > --- a/net/core/secure_seq.c
> > +++ b/net/core/secure_seq.c
> > @@ -142,7 +142,7 @@ u32 secure_tcp_seq(__be32 saddr, __be32 daddr,
> >  }
> >  EXPORT_SYMBOL_GPL(secure_tcp_seq);
> >
> > -u32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
> > +u64 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)
> >  {
> >  	net_secret_init();
> >  	return siphash_3u32((__force u32)saddr, (__force u32)daddr,
>
> Should you be doing the same with secure_ipv6_port_ephemeral() too? Why
> the asymmetry?

I remember not finding it in the similar code path, but maybe I missed
something. It's used by inet6_sk_port_offset() which also returns a u32,
itself used by inet6_hash_connect() and passed to __inet_hash_connect().

Hmmm the loop is now closed, I don't know how I missed it. So yes I
agree that it would definitely be needed. I'll update the patch, many
thanks!

Willy

[^](#m48ffeb2eefcb403d2175d30fd3ba48618546ac32) [permalink](../../20220427201938.GC4326%401wt.eu/) [raw](../../20220427201938.GC4326%401wt.eu/raw) [reply](../../20220427201938.GC4326%401wt.eu/#R)	[[flat](../../20220427201938.GC4326%401wt.eu/T/#u)|[nested](../../20220427201938.GC4326%401wt.eu/t/#u)] [20+ messages in thread](#r48ffeb2eefcb403d2175d30fd3ba48618546ac32)
```

---

```
[*](#ed85250d580ac95cfcf7914e1fd3130fa0932d18c) Re: [PATCH net 1/7] secure_seq: return the full 64-bit of the siphash
  2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
  2022-04-27  9:56   ` [kernel test robot](#ma9b3acb17663d5d91fcaf66ab55905bee8260dc9)
  2022-04-27 17:18   ` [Jason A. Donenfeld](#m8103536b6c7a58b87d69b06366182c7d1d989634)
@ 2022-04-28  1:59   ` kernel test robot
  [2 siblings, 0 replies; 20+ messages in thread](#rd85250d580ac95cfcf7914e1fd3130fa0932d18c)
From: kernel test robot @ 2022-04-28  1:59 UTC ([permalink](../../202204280348.UBtfnU6Q-lkp%40intel.com/) / [raw](../../202204280348.UBtfnU6Q-lkp%40intel.com/raw))
  To: Willy Tarreau, [netdev](../../../netdev/?t=20220428020050)
  Cc: kbuild-all, Jakub Kicinski, Eric Dumazet, Moshe Kol, Yossi Gilad,
	Amit Klein, [linux-kernel](../../../lkml/?t=20220428020050), Willy Tarreau, Jason A . Donenfeld

Hi Willy,

I love your patch! Yet something to improve:

[auto build test ERROR on net/master]

url:    <https://github.com/intel-lab-lkp/linux/commits/Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651>
base:   <https://git.kernel.org/pub/scm/linux/kernel/git/davem/net.git> 71cffebf6358a7f5031f5b208bbdc1cb4db6e539
config: i386-randconfig-a011-20220425 ([https://download.01.org/0day-ci/archive/20220428/202204280348.UBtfnU6Q-lkp@intel.com/config](https://download.01.org/0day-ci/archive/20220428/202204280348.UBtfnU6Q-lkp%40intel.com/config))
compiler: gcc-11 (Debian 11.2.0-20) 11.2.0
reproduce (this is a W=1 build):
        # <https://github.com/intel-lab-lkp/linux/commit/01b26e522b598adf346b809075880feab3dcdc08>
        git remote add linux-review <https://github.com/intel-lab-lkp/linux>
        git fetch --no-tags linux-review Willy-Tarreau/insufficient-TCP-source-port-randomness/20220427-145651
        git checkout 01b26e522b598adf346b809075880feab3dcdc08
        # save the config file
        mkdir build_dir && cp config build_dir/.config
        make W=1 O=build_dir ARCH=i386 SHELL=/bin/bash

If you fix the issue, kindly add following tag as appropriate
Reported-by: kernel test robot <lkp@intel.com>

All errors (new ones prefixed by >>):

   ld: net/ipv4/inet_hashtables.o: in function `__inet_hash_connect':
>> net/ipv4/inet_hashtables.c:780: undefined reference to `__umoddi3'

vim +780 net/ipv4/inet_hashtables.c

190cc82489f46f Eric Dumazet             2021-02-09  735
5ee31fc1ecdcbc Pavel Emelyanov          2008-01-31  736  int __inet_hash_connect(struct inet_timewait_death_row *death_row,
01b26e522b598a Willy Tarreau            2022-04-27  737  		struct sock *sk, u64 port_offset,
5ee31fc1ecdcbc Pavel Emelyanov          2008-01-31  738  		int (*check_established)(struct inet_timewait_death_row *,
b4d6444ea3b50b Eric Dumazet             2015-03-18  739  			struct sock *, __u16, struct inet_timewait_sock **))
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  740  {
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  741  	struct inet_hashinfo *hinfo = death_row->hashinfo;
1580ab63fc9a03 Eric Dumazet             2016-02-11  742  	struct inet_timewait_sock *tw = NULL;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  743  	struct inet_bind_hashbucket *head;
1580ab63fc9a03 Eric Dumazet             2016-02-11  744  	int port = inet_sk(sk)->inet_num;
3b1e0a655f8eba YOSHIFUJI Hideaki        2008-03-26  745  	struct net *net = sock_net(sk);
1580ab63fc9a03 Eric Dumazet             2016-02-11  746  	struct inet_bind_bucket *tb;
1580ab63fc9a03 Eric Dumazet             2016-02-11  747  	u32 remaining, offset;
1580ab63fc9a03 Eric Dumazet             2016-02-11  748  	int ret, i, low, high;
3c82a21f4320c8 Robert Shearman          2018-11-07  749  	int l3mdev;
190cc82489f46f Eric Dumazet             2021-02-09  750  	u32 index;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  751
1580ab63fc9a03 Eric Dumazet             2016-02-11  752  	if (port) {
1580ab63fc9a03 Eric Dumazet             2016-02-11  753  		head = &hinfo->bhash[inet_bhashfn(net, port,
1580ab63fc9a03 Eric Dumazet             2016-02-11  754  						  hinfo->bhash_size)];
1580ab63fc9a03 Eric Dumazet             2016-02-11  755  		tb = inet_csk(sk)->icsk_bind_hash;
1580ab63fc9a03 Eric Dumazet             2016-02-11  756  		spin_lock_bh(&head->lock);
1580ab63fc9a03 Eric Dumazet             2016-02-11  757  		if (sk_head(&tb->owners) == sk && !sk->sk_bind_node.next) {
01770a16616573 Ricardo Dias             2020-11-20  758  			inet_ehash_nolisten(sk, NULL, NULL);
1580ab63fc9a03 Eric Dumazet             2016-02-11  759  			spin_unlock_bh(&head->lock);
1580ab63fc9a03 Eric Dumazet             2016-02-11  760  			return 0;
1580ab63fc9a03 Eric Dumazet             2016-02-11  761  		}
1580ab63fc9a03 Eric Dumazet             2016-02-11  762  		spin_unlock(&head->lock);
1580ab63fc9a03 Eric Dumazet             2016-02-11  763  		/* No definite answer... Walk to established hash table */
1580ab63fc9a03 Eric Dumazet             2016-02-11  764  		ret = check_established(death_row, sk, port, NULL);
1580ab63fc9a03 Eric Dumazet             2016-02-11  765  		local_bh_enable();
1580ab63fc9a03 Eric Dumazet             2016-02-11  766  		return ret;
1580ab63fc9a03 Eric Dumazet             2016-02-11  767  	}
227b60f5102cda Stephen Hemminger        2007-10-10  768
3c82a21f4320c8 Robert Shearman          2018-11-07  769  	l3mdev = inet_sk_bound_l3mdev(sk);
3c82a21f4320c8 Robert Shearman          2018-11-07  770
1580ab63fc9a03 Eric Dumazet             2016-02-11  771  	inet_get_local_port_range(net, &low, &high);
1580ab63fc9a03 Eric Dumazet             2016-02-11  772  	high++; /* [32768, 60999] -> [32768, 61000[ */
1580ab63fc9a03 Eric Dumazet             2016-02-11  773  	remaining = high - low;
1580ab63fc9a03 Eric Dumazet             2016-02-11  774  	if (likely(remaining > 1))
1580ab63fc9a03 Eric Dumazet             2016-02-11  775  		remaining &= ~1U;
1580ab63fc9a03 Eric Dumazet             2016-02-11  776
190cc82489f46f Eric Dumazet             2021-02-09  777  	net_get_random_once(table_perturb, sizeof(table_perturb));
190cc82489f46f Eric Dumazet             2021-02-09  778  	index = hash_32(port_offset, INET_TABLE_PERTURB_SHIFT);
190cc82489f46f Eric Dumazet             2021-02-09  779
190cc82489f46f Eric Dumazet             2021-02-09 @780  	offset = (READ_ONCE(table_perturb[index]) + port_offset) % remaining;
1580ab63fc9a03 Eric Dumazet             2016-02-11  781  	/* In first pass we try ports of @low parity.
1580ab63fc9a03 Eric Dumazet             2016-02-11  782  	 * inet_csk_get_port() does the opposite choice.
07f4c90062f8fc Eric Dumazet             2015-05-24  783  	 */
1580ab63fc9a03 Eric Dumazet             2016-02-11  784  	offset &= ~1U;
1580ab63fc9a03 Eric Dumazet             2016-02-11  785  other_parity_scan:
1580ab63fc9a03 Eric Dumazet             2016-02-11  786  	port = low + offset;
1580ab63fc9a03 Eric Dumazet             2016-02-11  787  	for (i = 0; i < remaining; i += 2, port += 2) {
1580ab63fc9a03 Eric Dumazet             2016-02-11  788  		if (unlikely(port >= high))
1580ab63fc9a03 Eric Dumazet             2016-02-11  789  			port -= remaining;
122ff243f5f104 WANG Cong                2014-05-12  790  		if (inet_is_local_reserved_port(net, port))
e3826f1e946e7d Amerigo Wang             2010-05-05  791  			continue;
7f635ab71eef8d Pavel Emelyanov          2008-06-16  792  		head = &hinfo->bhash[inet_bhashfn(net, port,
7f635ab71eef8d Pavel Emelyanov          2008-06-16  793  						  hinfo->bhash_size)];
1580ab63fc9a03 Eric Dumazet             2016-02-11  794  		spin_lock_bh(&head->lock);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  795
1580ab63fc9a03 Eric Dumazet             2016-02-11  796  		/* Does not bother with rcv_saddr checks, because
1580ab63fc9a03 Eric Dumazet             2016-02-11  797  		 * the established check is already unique enough.
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  798  		 */
b67bfe0d42cac5 Sasha Levin              2013-02-27  799  		inet_bind_bucket_for_each(tb, &head->chain) {
3c82a21f4320c8 Robert Shearman          2018-11-07  800  			if (net_eq(ib_net(tb), net) && tb->l3mdev == l3mdev &&
3c82a21f4320c8 Robert Shearman          2018-11-07  801  			    tb->port == port) {
da5e36308d9f71 Tom Herbert              2013-01-22  802  				if (tb->fastreuse >= 0 ||
da5e36308d9f71 Tom Herbert              2013-01-22  803  				    tb->fastreuseport >= 0)
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  804  					goto next_port;
a9d8f9110d7e95 Evgeniy Polyakov         2009-01-19  805  				WARN_ON(hlist_empty(&tb->owners));
5ee31fc1ecdcbc Pavel Emelyanov          2008-01-31  806  				if (!check_established(death_row, sk,
5ee31fc1ecdcbc Pavel Emelyanov          2008-01-31  807  						       port, &tw))
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  808  					goto ok;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  809  				goto next_port;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  810  			}
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  811  		}
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  812
941b1d22cc035a Pavel Emelyanov          2008-01-31  813  		tb = inet_bind_bucket_create(hinfo->bind_bucket_cachep,
3c82a21f4320c8 Robert Shearman          2018-11-07  814  					     net, head, port, l3mdev);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  815  		if (!tb) {
1580ab63fc9a03 Eric Dumazet             2016-02-11  816  			spin_unlock_bh(&head->lock);
1580ab63fc9a03 Eric Dumazet             2016-02-11  817  			return -ENOMEM;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  818  		}
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  819  		tb->fastreuse = -1;
da5e36308d9f71 Tom Herbert              2013-01-22  820  		tb->fastreuseport = -1;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  821  		goto ok;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  822  next_port:
1580ab63fc9a03 Eric Dumazet             2016-02-11  823  		spin_unlock_bh(&head->lock);
1580ab63fc9a03 Eric Dumazet             2016-02-11  824  		cond_resched();
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  825  	}
1580ab63fc9a03 Eric Dumazet             2016-02-11  826
1580ab63fc9a03 Eric Dumazet             2016-02-11  827  	offset++;
1580ab63fc9a03 Eric Dumazet             2016-02-11  828  	if ((offset & 1) && remaining > 1)
1580ab63fc9a03 Eric Dumazet             2016-02-11  829  		goto other_parity_scan;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  830
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  831  	return -EADDRNOTAVAIL;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  832
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  833  ok:
c579bd1b4021c4 Eric Dumazet             2021-02-09  834  	/* If our first attempt found a candidate, skip next candidate
c579bd1b4021c4 Eric Dumazet             2021-02-09  835  	 * in 1/16 of cases to add some noise.
c579bd1b4021c4 Eric Dumazet             2021-02-09  836  	 */
c579bd1b4021c4 Eric Dumazet             2021-02-09  837  	if (!i && !(prandom_u32() % 16))
c579bd1b4021c4 Eric Dumazet             2021-02-09  838  		i = 2;
190cc82489f46f Eric Dumazet             2021-02-09  839  	WRITE_ONCE(table_perturb[index], READ_ONCE(table_perturb[index]) + i + 2);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  840
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  841  	/* Head lock still held and bh's disabled */
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  842  	inet_bind_hash(sk, tb, port);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  843  	if (sk_unhashed(sk)) {
c720c7e8383aff Eric Dumazet             2009-10-15  844  		inet_sk(sk)->inet_sport = htons(port);
01770a16616573 Ricardo Dias             2020-11-20  845  		inet_ehash_nolisten(sk, (struct sock *)tw, NULL);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  846  	}
3cdaedae635b17 Eric Dumazet             2009-12-04  847  	if (tw)
fc01538f9fb755 Eric Dumazet             2015-07-08  848  		inet_twsk_bind_unhash(tw, hinfo);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  849  	spin_unlock(&head->lock);
dbe7faa4045ea8 Eric Dumazet             2015-07-08  850  	if (tw)
dbe7faa4045ea8 Eric Dumazet             2015-07-08  851  		inet_twsk_deschedule_put(tw);
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  852  	local_bh_enable();
1580ab63fc9a03 Eric Dumazet             2016-02-11  853  	return 0;
a7f5e7f164788a Arnaldo Carvalho de Melo 2005-12-13  854  }
5ee31fc1ecdcbc Pavel Emelyanov          2008-01-31  855

--
0-DAY CI Kernel Test Service
<https://01.org/lkp>

[^](#md85250d580ac95cfcf7914e1fd3130fa0932d18c) [permalink](../../202204280348.UBtfnU6Q-lkp%40intel.com/) [raw](../../202204280348.UBtfnU6Q-lkp%40intel.com/raw) [reply](../../202204280348.UBtfnU6Q-lkp%40intel.com/#R)	[[flat](../../202204280348.UBtfnU6Q-lkp%40intel.com/T/#u)|[nested](../../202204280348.UBtfnU6Q-lkp%40intel.com/t/#u)] [20+ messages in thread](#rd85250d580ac95cfcf7914e1fd3130fa0932d18c)
```

---

```
end of thread, other threads:[[~2022-04-28  2:00 UTC](../../?t=20220428020050) | [newest](../../)]

Thread overview: 20+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-04-27  6:52 [[PATCH net 0/7] insufficient TCP source port randomness](#m6b131c6781e7de02c7bee40345b6e1d076fe3ec7) Willy Tarreau
2022-04-27  6:52 ` [[PATCH net 1/7] secure_seq: return the full 64-bit of the siphash](#m5c08169125b28c1ab02022b8fd437d57477dc7eb) Willy Tarreau
2022-04-27  9:56   ` [kernel test robot](#ma9b3acb17663d5d91fcaf66ab55905bee8260dc9)
2022-04-27 10:07     ` [Willy Tarreau](#m8a13f7358792fc66c42f6e629545db2b19114d6c)
2022-04-27 16:35       ` [Willy Tarreau](#ma88ce902e8fbadb0b2dee35a59f15bc50dc0ee31)
2022-04-27 16:50         ` [Eric Dumazet](#m74c404893bd00309b10eb6bd5d9d83b1800e4167)
2022-04-27 16:56           ` [Willy Tarreau](#m0bb46d7ab7c2a1f49c9c25d831c2114e4ded88fc)
2022-04-27 17:18   ` [Jason A. Donenfeld](#m8103536b6c7a58b87d69b06366182c7d1d989634)
2022-04-27 20:19     ` [Willy Tarreau](#m48ffeb2eefcb403d2175d30fd3ba48618546ac32)
2022-04-28  1:59   ` [kernel test robot](#md85250d580ac95cfcf7914e1fd3130fa0932d18c)
2022-04-27  6:52 ` [[PATCH net 2/7] tcp: use different parts of the port_offset for index and offset](#mde76681c0c6902892966ff40160a2f7f78005a4f) Willy Tarreau
2022-04-27  6:52 ` [[PATCH net 3/7] tcp: resalt the secret every 10 seconds](#m235da506563e932bafa39776a9ba05a4eb8850f3) Willy Tarreau
2022-04-27 15:56   ` [Stephen Hemminger](#m70227889fcf3763b01f44ffd2661126efe29bdc3)
2022-04-27 16:21     ` [Willy Tarreau](#m280cd267b7b8251daf13ca9a689279ba42c5eea0)
2022-04-27  6:52 ` [[PATCH net 4/7] tcp: add small random increments to the source port](#m0e353d3bfc1d5805cd617f26a3443d7e7c0c12e9) Willy Tarreau
2022-04-27  6:52 ` [[PATCH net 5/7] tcp: dynamically allocate the perturb table used by source ports](#m55fdb5ca1511c61c5226e3f1ef629e05a94d38fd) Willy Tarreau
2022-04-27  6:52 ` [[PATCH net 6/7] tcp: increase source port perturb table to 2^16](#m0a1620f5272e3fcd9160ed8e0ca99977e40e89d6) Willy Tarreau
2022-04-27  8:07   ` [David Laight](#m877150e242a3cd952183f2e4c0c537ca9cfd1475)
2022-04-27  8:19     ` [Willy Tarreau](#m963658be32971fff98485ce053a4eef61b2a7360)
2022-04-27  6:52 ` [[PATCH net 7/7] tcp: drop the hash_32() part from the index calculation](#mafb718195d39dd837247f19cffbe35962a1d6127) Willy Tarreau

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```


=== Content from security.netapp.com_09e9e445_20250114_194330.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [CVE-2022-1012 Linux Kernel Vulnerability in NetApp Products](https://security.netapp.com/advisory/ntap-20221020-0006)

## CVE-2022-1012 Linux Kernel Vulnerability in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20221020-0006 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20221020-0006 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20221020-0006 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20221020-0006 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20221020-0006
**Version:**
13.0

**Last updated:**
05/05/2023

**Status:**
Interim.

**CVEs:** CVE-2022-1012

Overview
#### Summary

Multiple NetApp products incorporate Linux Kernel. Linux Kernel versions prior to 5.18 are susceptible to a vulnerability which when successfully exploited could lead to disclosure of sensitive information or Denial of Service (DoS).

#### Impact

Successful exploitation of this vulnerability could lead to disclosure of sensitive information or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2022-1012](https://nvd.nist.gov/vuln/detail/CVE-2022-1012) | 8.2 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* Active IQ Unified Manager for VMware vSphere
* E-Series SANtricity OS Controller Software 11.x
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)

#### Products Not Affected

* 7-Mode Transition Tool
* AFF Baseboard Management Controller (BMC) - A700s
* ATTO FibreBridge - 7500N
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Trident
* Astra Trident Autosupport
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Data Sense
* Cloud Insights Acquisition Unit
* Cloud Insights Storage Workload Security Agent
* Cloud Insights Telegraf Agent
* Cloud Volumes ONTAP Mediator
* E-Series BIOS
* E-Series SANtricity Storage Manager
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700s
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250
* FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800/C800/A150
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Service Processor - 2554/2552/2520
* FAS/AFF Service Processor - 8080/8060/8040/8020
* FAS/AFF Service Processor - A300/8200/A200/2650/2620
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM6 SAS Disk Shelf Firmware
* Interoperability Matrix Tool
* Inventory Collect Tool
* Management Services for Element Software and NetApp HCI
* MetroCluster Tiebreaker for clustered Data ONTAP
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Cloud Backup OST Plug-in (formerly AltaVault OST Plug-in)
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SMI-S Provider
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp Virtual Desktop Service (VDS)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* ONTAP tools for VMware vSphere
* OnCommand Insight
* OnCommand Workflow Automation
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* Spot PC
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG6060/SGF6024
* StorageGRID Baseboard Management Controller (BMC)
* System Manager 9.x

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **Active IQ Unified Manager for VMware vSphere** | <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/downloads-tab/download/62791/9.12> |
| **E-Series SANtricity OS Controller Software 11.x** | <https://mysupport.netapp.com/site/products/all/details/eseries-santricityos/downloads-tab/download/62735/11.70.4R1> |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2884466.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20221020-0006>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20221020 | Initial Public Release |
| 2.0 | 20221021 | Cloud Volumes ONTAP Mediator moved to Products Not Affected |
| 3.0 | 20221025 | FAS/AFF Baseboard Management Controller (BMC) - A250/500f moved to Products Not Affected |
| 4.0 | 20221028 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 5.0 | 20221028 | FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800, FAS/AFF Baseboard Management Controller (BMC) - A900/9500, FAS/AFF Service Processor - 2554/2552/2520, FAS/AFF Service Processor - 8080/8060/8040/8020, FAS/AFF Service Processor - A300/8200/A200/2650/2620, and FAS/AFF Service Processor - A700/9000 moved to Products Not Affected |
| 6.0 | 20221104 | FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 moved to Products Not Affected, NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S moved to Won't Fix status, NetApp HCI Compute Node (Bootstrap OS), NetApp SolidFire & HCI Storage Node (Element Software) and NetApp SolidFire & HCI Management Node moved to Affected Products |
| 7.0 | 20221110 | SnapCenter Plug-in for VMware vSphere moved to Products Not Affected |
| 8.0 | 20221115 | ONTAP tools for VMware vSphere moved to Products Not Affected, Active IQ Unified Manager for VMware vSphere moved to Affected Products |
| 9.0 | 20221201 | NetApp Converged Systems Advisor Agent moved to Products Not Affected |
| 10.0 | 20221221 | NetApp HCI Baseboard Management Controller (BMC) - H610C, NetApp HCI Baseboard Management Controller (BMC) - H610S and NetApp HCI Baseboard Management Controller (BMC) - H615C moved to Affected Products |
| 11.0 | 20230207 | Active IQ Unified Manager for VMware vSphere added to Software Versions and Fixes |
| 12.0 | 20230407 | NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 13.0 | 20230505 | E-Series SANtricity OS Controller Software 11.x added to Software Versions and Fixes |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from security.netapp.com_1800b48e_20250115_114959.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [CVE-2022-1012 Linux Kernel Vulnerability in NetApp Products](https://security.netapp.com/advisory/ntap-20221020-0006)

## CVE-2022-1012 Linux Kernel Vulnerability in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20221020-0006 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20221020-0006 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20221020-0006 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20221020-0006 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20221020-0006
**Version:**
13.0

**Last updated:**
05/05/2023

**Status:**
Interim.

**CVEs:** CVE-2022-1012

Overview
#### Summary

Multiple NetApp products incorporate Linux Kernel. Linux Kernel versions prior to 5.18 are susceptible to a vulnerability which when successfully exploited could lead to disclosure of sensitive information or Denial of Service (DoS).

#### Impact

Successful exploitation of this vulnerability could lead to disclosure of sensitive information or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2022-1012](https://nvd.nist.gov/vuln/detail/CVE-2022-1012) | 8.2 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* Active IQ Unified Manager for VMware vSphere
* E-Series SANtricity OS Controller Software 11.x
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)

#### Products Not Affected

* 7-Mode Transition Tool
* AFF Baseboard Management Controller (BMC) - A700s
* ATTO FibreBridge - 7500N
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Trident
* Astra Trident Autosupport
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Data Sense
* Cloud Insights Acquisition Unit
* Cloud Insights Storage Workload Security Agent
* Cloud Insights Telegraf Agent
* Cloud Volumes ONTAP Mediator
* E-Series BIOS
* E-Series SANtricity Storage Manager
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700s
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250
* FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800/C800/A150
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Service Processor - 2554/2552/2520
* FAS/AFF Service Processor - 8080/8060/8040/8020
* FAS/AFF Service Processor - A300/8200/A200/2650/2620
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM6 SAS Disk Shelf Firmware
* Interoperability Matrix Tool
* Inventory Collect Tool
* Management Services for Element Software and NetApp HCI
* MetroCluster Tiebreaker for clustered Data ONTAP
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Cloud Backup OST Plug-in (formerly AltaVault OST Plug-in)
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SMI-S Provider
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp Virtual Desktop Service (VDS)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* ONTAP tools for VMware vSphere
* OnCommand Insight
* OnCommand Workflow Automation
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* Spot PC
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG6060/SGF6024
* StorageGRID Baseboard Management Controller (BMC)
* System Manager 9.x

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **Active IQ Unified Manager for VMware vSphere** | <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/downloads-tab/download/62791/9.12> |
| **E-Series SANtricity OS Controller Software 11.x** | <https://mysupport.netapp.com/site/products/all/details/eseries-santricityos/downloads-tab/download/62735/11.70.4R1> |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2884466.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20221020-0006>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20221020 | Initial Public Release |
| 2.0 | 20221021 | Cloud Volumes ONTAP Mediator moved to Products Not Affected |
| 3.0 | 20221025 | FAS/AFF Baseboard Management Controller (BMC) - A250/500f moved to Products Not Affected |
| 4.0 | 20221028 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 5.0 | 20221028 | FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800, FAS/AFF Baseboard Management Controller (BMC) - A900/9500, FAS/AFF Service Processor - 2554/2552/2520, FAS/AFF Service Processor - 8080/8060/8040/8020, FAS/AFF Service Processor - A300/8200/A200/2650/2620, and FAS/AFF Service Processor - A700/9000 moved to Products Not Affected |
| 6.0 | 20221104 | FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 moved to Products Not Affected, NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S moved to Won't Fix status, NetApp HCI Compute Node (Bootstrap OS), NetApp SolidFire & HCI Storage Node (Element Software) and NetApp SolidFire & HCI Management Node moved to Affected Products |
| 7.0 | 20221110 | SnapCenter Plug-in for VMware vSphere moved to Products Not Affected |
| 8.0 | 20221115 | ONTAP tools for VMware vSphere moved to Products Not Affected, Active IQ Unified Manager for VMware vSphere moved to Affected Products |
| 9.0 | 20221201 | NetApp Converged Systems Advisor Agent moved to Products Not Affected |
| 10.0 | 20221221 | NetApp HCI Baseboard Management Controller (BMC) - H610C, NetApp HCI Baseboard Management Controller (BMC) - H610S and NetApp HCI Baseboard Management Controller (BMC) - H615C moved to Affected Products |
| 11.0 | 20230207 | Active IQ Unified Manager for VMware vSphere added to Software Versions and Fixes |
| 12.0 | 20230407 | NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 13.0 | 20230505 | E-Series SANtricity OS Controller Software 11.x added to Software Versions and Fixes |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)


