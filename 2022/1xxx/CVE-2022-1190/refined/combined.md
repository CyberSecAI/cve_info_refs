=== Content from gitlab.com_f5488c5e_20250115_093131.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-1190.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-1190.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-1190.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-1190.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Apr 04, 2022

  [211fea04](/gitlab-org/cves/-/commit/211fea044dd6da866515c20d82d848a5da24cf58)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/211fea044dd6da866515c20d82d848a5da24cf58)
  ·
  211fea04

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Apr 04, 2022

  211fea04

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/211fea044dd6da866515c20d82d848a5da24cf58)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Apr 04, 2022

Loading



=== Content from gitlab.com_b09050e6_20250115_093132.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Stored XSS on Multi-word milestone reference leads to Admin-privilege escalation in certain conditions

**[HackerOne report #1455036](https://hackerone.com/reports/1455036)** by `ryhmnlfj` on 2022-01-20, assigned to [@mhenriksen](/mhenriksen "Michael Henriksen"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

I found Stored XSS on Multi-word milestone reference in Markdown field.

Admin-privilege escalation can also be achieved by combining this XSS and [CSP-bypass at CVE-2021-22242](https://hackerone.com/reports/1212822) under certain conditions.

However, **the reproduction steps has become too long, so I submit the procedure that does not bypass CSP as the first report** for convenience of confirmation and mitigation.

After submitting this first report, **I will add the additional report with CSP-bypass and Admin-privilege escalation scenario `as comments`**.

#### Steps to reproduce (Non-CSP-bypass)

##### Victim-side 1st steps

1. Sign in to GitLab instance as victim-user.
2. Create a new **public** project that everyone can create issue.
3. After creating the new issue, log out of this victim's account and start Attacker-side steps.

##### Attacker-side steps

1. Sign in to GitLab instance as attacker-user.
2. Create a new **private** project.
3. After creating a private project, make a note of the `[FULL_NAMESPACE]` from the URL displayed in the address bar of browser.

[![Full-namespace-of-private-project.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/3f5ac61fa8b7da938502cfcc037931a9cee8f474/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32323263393237652d326438612d346639382d616564622d3066393938333738643137302f46756c6c2d6e616d6573706163652d6f662d707269766174652d70726f6a6563742e706e67)

4. Go to "Issues > Milestones" page and click "New milestone" button.
5. Create a new milestone with the following Title:

```
New Milestone &lt;script&gt;alert(document.domain)&lt;/script&gt;
```

[![Create-new-milestone.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d534b1b762692779285c6146269eb33cab64b9d4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34663633623535362d636663612d343932352d396263652d6235343337303861643766642f4372656174652d6e65772d6d696c6573746f6e652e706e67)

6. Go to the "Issue" page in the **victim's public project** prepared at **Victim-side 1st step 2**.
7. Prepare the description of new issue by replacing the string below.

   Replace `[FULL_NAMESPACE]` with the values you got in **Attacker-side step 3**.

```
[FULL_NAMESPACE]%"New Milestone &lt;script&gt;alert(document.domain)&lt;/script&gt;"
```

After replacing, create a new issue with this description.

[![Create-new-issue_milestone.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0a75cd5928afc89018b1a59f0ad38ae410e1f807/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36366235353738322d363538302d346433652d396331362d3535333333616265333730392f4372656174652d6e65772d69737375655f6d696c6573746f6e652e706e67)

8. Log out of this attacker's account and start Victim-side 2nd steps.

##### Victim-side 2nd steps

1. Sign in to GitLab as victim-user.
2. Go to the issue page created at **Attacker-side step 7**. The XSS will be executed automatically.

[![XSS-result_milestone.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/5f4748fee2140e3c84c347eb4b028d26e84e344f/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64613432303939352d393462342d346335612d613532332d3263383137336662323838642f5853532d726573756c745f6d696c6573746f6e652e706e67)

#### What is the current bug behavior?

There are almost no restrictions on the regular expression that extract **String-based multi-word milestone**.

<https://gitlab.com/gitlab-org/gitlab/-/blob/v14.6.3-ee/app/models/milestone.rb#L63-80>

```
  def self.reference_pattern
    # NOTE: The iid pattern only matches when all characters on the expression
    # are digits, so it will match %2 but not %2.1 because that's probably a
    # milestone name and we want it to be matched as such.
    [@]reference_pattern ||= %r{
      (#{Project.reference_pattern})?
      #{Regexp.escape(reference_prefix)}
      (?:
        (?<milestone_iid>
          \d+(?!\S\w)\b # Integer-based milestone iid, or
        ) |
        (?<milestone_name>
          [^"\s\<]+\b |  # String-based single-word milestone title, or
          "[^"]+"      # String-based multi-word milestone surrounded in quotes
        )
      )
    }x
  end
```

This regex means that injection is possible with a similar approach to [CVE-2020-13338](https://hackerone.com/reports/836649).

```
          "[^"]+"      # String-based multi-word milestone surrounded in quotes
```

#### What is the expected correct behavior?

I recommend limiting the regular expression that extract **Multi-word milestone** to the same extent as **Single-word milestone**.

#### Relevant logs and/or screenshots

I put references to the screenshots at the appropriate places in this report.

#### Output of checks

This bug happens on the official Docker installation of GitLab Enterprise Edition `14.6.3-ee`.

I used `Chromium 96` and `Firefox 91` on Xubuntu 20.04 LTS to verify XSS.

I think it can be reproduced on `gitlab.com` by using CSP-bypassable vector, but I haven't tried it to prevent unexpected accidents.

###### Results of GitLab environment info

Output of `sudo gitlab-rake gitlab:env:info`:

```
System information
System:
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.7.5p203
Gem Version:	3.1.4
Bundler Version:2.1.4
Rake Version:	13.0.6
Redis Version:	6.0.16
Git Version:	2.33.1.
Sidekiq Version:6.3.1
Go Version:	unknown

GitLab information
Version:	14.6.3-ee
Revision:	6360adc49de
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	12.7
URL:		http://mygitlab.local
HTTP Clone URL:	http://mygitlab.local/some-group/some-project.git
SSH Clone URL:	git@mygitlab.local:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	13.22.1
Repository storage paths:
- default: 	/var/opt/gitlab/git-data/repositories
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
Git:		/opt/gitlab/embedded/bin/git
```

#### Impact

This Stored XSS can be placed in the various Markdown field, and by using **cross-project reference** and **Multi-word milestone** in combination,

the attack target can be easily spread to public project owners and maintainers.

A [trial calculation of CVSS in this standard scenario](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#vector=CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:L&range=new) is as follows:

```
CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:L
8.9 (High)
```

After researching for scenarios that extend the attack to `admin`, I have found that it is possible to attack the **`admin` in impersonation mode**.

Admin-Privilege escalation can be achieved by combining a request to stop impersonation mode with a request to [User modification API](https://docs.gitlab.com/ee/api/users.html#user-modification).

Let's assume a scenario where this impersonation mode is often used by `admin` of GitLab instance and the attack is successful.

[Another trial calculation of CVSS](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#vector=CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H&range=new) is as follows:

```
CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H
9.0 (Critical)
```

Though I think the impersonation mode is an interesting feature, I'm not sure if it's commonly used.

If it doesn't seem to be used much, please evaluate it as a standard scenario.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Full-namespace-of-private-project.png](https://h1.sec.gitlab.net/a/222c927e-2d8a-4f98-aedb-0f998378d170/Full-namespace-of-private-project.png)
* [Create-new-milestone.png](https://h1.sec.gitlab.net/a/4f63b556-cfca-4925-9bce-b543708ad7fd/Create-new-milestone.png)
* [Create-new-issue\_milestone.png](https://h1.sec.gitlab.net/a/66b55782-6580-4d3e-9c16-55333abe3709/Create-new-issue_milestone.png)
* [XSS-result\_milestone.png](https://h1.sec.gitlab.net/a/da420995-94b4-4c5a-a523-2c8173fb288d/XSS-result_milestone.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


