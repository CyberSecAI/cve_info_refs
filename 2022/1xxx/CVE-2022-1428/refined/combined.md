=== Content from gitlab.com_173c47e4_20250114_190800.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Improper rack-attack discriminator for `authenticated\_packages\_api` with a deploy token

### ðŸ”¥ Problem

We currently have several [rack-attack throttles](https://github.com/rack/rack-attack#throttlename-options-block) configured. One of them is `throttle_authenticated_packages_api`. When this throttle is triggered, the discriminator is the [`user_id`](https://gitlab.com/gitlab-org/gitlab/-/blob/542ca3dcfd56e9e5581af62ff16b939c895ae097/lib/gitlab/rack_attack.rb#L98).

That `user_id` comes from <https://gitlab.com/gitlab-org/gitlab/-/blob/542ca3dcfd56e9e5581af62ff16b939c895ae097/lib/gitlab/rack_attack/request.rb#L14> which in turn will use <https://gitlab.com/gitlab-org/gitlab/-/blob/542ca3dcfd56e9e5581af62ff16b939c895ae097/lib/gitlab/auth/request_authenticator.rb#L32>.

The problem is that this function doesn't read deploy token objects.

The discriminator will thus be `nil` = the throttle evluation will be [aborted](https://gitlab.com/gitlab-org/gitlab/-/issues/342481#note_696360176 "Improper rack-attack discriminator for `authenticated_packages_api` with a deploy token") = all packages api with deploy token will not be throttled.

The same problem was discovered for the dependency proxy routes in [!71532 (merged)](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/71532 "Update request auhenticator for the dependency proxy routes")

### ðŸš’ Solution

The straightforward solution would be to update `#find_sessionless_user` so that it returns deploy tokens. Unfortunately, that function is used in rack-attack throttles *and* here: <https://gitlab.com/gitlab-org/gitlab/-/blob/542ca3dcfd56e9e5581af62ff16b939c895ae097/app/controllers/concerns/sessionless_authentication.rb>. That concern is used in several rails controller.

Given that impacting several rails controller at once is not a great idea, we will need an alternative.

Introduce `#find_sessionless_user_or_deploy_token` which uses `#find_sessionless_user` and upgrade it with finders for deploy tokens. Once we have that, the discriminator could be the object type + id. For example: `user.23` or `deploy_token.23`. Using only the id will not work as we can have clashes between user ids and deploy token ids.

Edited Oct 07, 2021 by [David Fernandez](/10io)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_35bd7113_20250114_190759.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-1428.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-1428.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-1428.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-1428.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ðŸ¤– GitLab Bot ðŸ¤–'s avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "ðŸ¤– GitLab Bot ðŸ¤–")](/gitlab-bot)

  May 09, 2022

  [b0ecc098](/gitlab-org/cves/-/commit/b0ecc098f9c9e8ab45f2cae546623171643a8b2b)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/b0ecc098f9c9e8ab45f2cae546623171643a8b2b)
  Â·
  b0ecc098

  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored May 09, 2022

  b0ecc098

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/b0ecc098f9c9e8ab45f2cae546623171643a8b2b)
  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored May 09, 2022

Loading


