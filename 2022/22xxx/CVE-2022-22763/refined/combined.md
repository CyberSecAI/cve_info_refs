=== Content from www.mozilla.org_000817b2_20250115_085410.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-06

## Security Vulnerabilities fixed in Thunderbird 91.6

Announced
February 8, 2022
Impact
high
Products
Thunderbird
Fixed in

* Thunderbird 91.6

*In general, these flaws cannot be exploited through email in the Thunderbird product because scripting is disabled when reading mail, but are potentially risks in browser or browser-like contexts.*

#### [#CVE-2022-22753: Privilege Escalation to SYSTEM on Windows via Maintenance Service](#CVE-2022-22753)

Reporter
Seb Patane
Impact
high
##### Description

A Time-of-Check Time-of-Use bug existed in the Maintenance (Updater) Service that could be abused to grant Users write access to an arbitrary directory. This could have been used to escalate to SYSTEM access.
*This bug only affects Thunderbird on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1732435](https://bugzilla.mozilla.org/show_bug.cgi?id=1732435)

#### [#CVE-2022-22754: Extensions could have bypassed permission confirmation during update](#CVE-2022-22754)

Reporter
Rob Wu
Impact
high
##### Description

If a user installed an extension of a particular type, the extension could have auto-updated itself and while doing so, bypass the prompt which grants the new version the new requested permissions.

##### References

* [Bug 1750565](https://bugzilla.mozilla.org/show_bug.cgi?id=1750565)

#### [#CVE-2022-22756: Drag and dropping an image could have resulted in the dropped object being an executable](#CVE-2022-22756)

Reporter
Abdulrahman Alqabandi
Impact
moderate
##### Description

If a user was convinced to drag and drop an image to their desktop or other folder, the resulting object could have been changed into an executable script which would have run arbitrary code after the user clicked on it.

##### References

* [Bug 1317873](https://bugzilla.mozilla.org/show_bug.cgi?id=1317873)

#### [#CVE-2022-22759: Sandboxed iframes could have executed script if the parent appended elements](#CVE-2022-22759)

Reporter
Johan Carlsson
Impact
moderate
##### Description

If a document created a sandboxed iframe without `allow-scripts`, and subsequently appended an element to the iframe's document that e.g. had a JavaScript event handler - the event handler would have run despite the iframe's sandbox.

##### References

* [Bug 1739957](https://bugzilla.mozilla.org/show_bug.cgi?id=1739957)

#### [#CVE-2022-22760: Cross-Origin responses could be distinguished between script and non-script content-types](#CVE-2022-22760)

Reporter
Luan Herrera
Impact
moderate
##### Description

When importing resources using Web Workers, error messages would distinguish the difference between `application/javascript` responses and non-script responses. This could have been abused to learn information cross-origin.

##### References

* [Bug 1740985](https://bugzilla.mozilla.org/show_bug.cgi?id=1740985)
* [Bug 1748503](https://bugzilla.mozilla.org/show_bug.cgi?id=1748503)

#### [#CVE-2022-22761: frame-ancestors Content Security Policy directive was not enforced for framed extension pages](#CVE-2022-22761)

Reporter
Mart Gil Robles (Mart at FlowCrypt)
Impact
moderate
##### Description

Web-accessible extension pages (pages with a moz-extension:// scheme) were not correctly enforcing the frame-ancestors directive when it was used in the Web Extension's Content Security Policy.

##### References

* [Bug 1745566](https://bugzilla.mozilla.org/show_bug.cgi?id=1745566)

#### [#CVE-2022-22763: Script Execution during invalid object state](#CVE-2022-22763)

Reporter
Mozilla Fuzzing Team
Impact
moderate
##### Description

When a worker is shutdown, it was possible to cause script to run late in the lifecycle, at a point after where it should not be possible.

##### References

* [Bug 1740534](https://bugzilla.mozilla.org/show_bug.cgi?id=1740534)

#### [#CVE-2022-22764: Memory safety bugs fixed in Thunderbird 91.6](#CVE-2022-22764)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers and community members Paul Adenot and the Mozilla Fuzzing Team reported memory safety bugs present in Thunderbird 91.5. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Thunderbird 91.6](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1742682%2C1744165%2C1746545%2C1748210%2C1748279)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from www.mozilla.org_458331a4_20250115_085409.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-01

## Security Vulnerabilities fixed in Firefox 96

Announced
January 11, 2022
Impact
high
Products
Firefox
Fixed in

* Firefox 96

#### [#CVE-2022-22746: Calling into reportValidity could have lead to fullscreen window spoof](#CVE-2022-22746)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A race condition could have allowed bypassing the fullscreen notification which could have lead to a fullscreen window spoof being unnoticed.
*This bug only affects Firefox for Windows. Other operating systems are unaffected.*

##### References

* [Bug 1735071](https://bugzilla.mozilla.org/show_bug.cgi?id=1735071)

#### [#CVE-2022-22743: Browser window spoof using fullscreen mode](#CVE-2022-22743)

Reporter
Irvan Kurniawan
Impact
high
##### Description

When navigating from inside an iframe while requesting fullscreen access, an attacker-controlled tab could have made the browser unable to leave fullscreen mode.

##### References

* [Bug 1739220](https://bugzilla.mozilla.org/show_bug.cgi?id=1739220)

#### [#CVE-2022-22742: Out-of-bounds memory access when inserting text in edit mode](#CVE-2022-22742)

Reporter
Irvan Kurniawan
Impact
high
##### Description

When inserting text while in edit mode, some characters might have lead to out-of-bounds memory access causing a potentially exploitable crash.

##### References

* [Bug 1739923](https://bugzilla.mozilla.org/show_bug.cgi?id=1739923)

#### [#CVE-2022-22741: Browser window spoof using fullscreen mode](#CVE-2022-22741)

Reporter
Irvan Kurniawan
Impact
high
##### Description

When resizing a popup while requesting fullscreen access, the popup would have become unable to leave fullscreen mode.

##### References

* [Bug 1740389](https://bugzilla.mozilla.org/show_bug.cgi?id=1740389)

#### [#CVE-2022-22740: Use-after-free of ChannelEventQueue::mOwner](#CVE-2022-22740)

Reporter
bo13oy of Cyber Kunlun Lab
Impact
high
##### Description

Certain network request objects were freed too early when releasing a network request handle. This could have lead to a use-after-free causing a potentially exploitable crash.

##### References

* [Bug 1742334](https://bugzilla.mozilla.org/show_bug.cgi?id=1742334)

#### [#CVE-2022-22738: Heap-buffer-overflow in blendGaussianBlur](#CVE-2022-22738)

Reporter
Atte Kettunen
Impact
high
##### Description

Applying a CSS filter effect could have accessed out of bounds memory. This could have lead to a heap-buffer-overflow causing a potentially exploitable crash.

##### References

* [Bug 1742382](https://bugzilla.mozilla.org/show_bug.cgi?id=1742382)

#### [#CVE-2022-22737: Race condition when playing audio files](#CVE-2022-22737)

Reporter
bo13oy of Cyber Kunlun Lab
Impact
high
##### Description

Constructing audio sinks could have lead to a race condition when playing audio files and closing windows. This could have lead to a use-after-free causing a potentially exploitable crash.

##### References

* [Bug 1745874](https://bugzilla.mozilla.org/show_bug.cgi?id=1745874)

#### [#CVE-2021-4140: Iframe sandbox bypass with XSLT](#CVE-2021-4140)

Reporter
Peter Van der Beken
Impact
high
##### Description

It was possible to construct specific XSLT markup that would be able to bypass an iframe sandbox.

##### References

* [Bug 1746720](https://bugzilla.mozilla.org/show_bug.cgi?id=1746720)

#### [#CVE-2022-22750: IPC passing of resource handles could have lead to sandbox bypass](#CVE-2022-22750)

Reporter
Jed Davis
Impact
moderate
##### Description

By generally accepting and passing resource handles across processes, a compromised content process might have confused higher privileged processes to interact with handles that the unprivileged process should not have access to.
*This bug only affects Firefox for Windows and MacOS. Other operating systems are unaffected.*

##### References

* [Bug 1566608](https://bugzilla.mozilla.org/show_bug.cgi?id=1566608)

#### [#CVE-2022-22749: Lack of URL restrictions when scanning QR codes](#CVE-2022-22749)

Reporter
Wladimir Palant working with Include Security
Impact
moderate
##### Description

When scanning QR codes, Firefox for Android would have allowed navigation to some URLs that do not point to web content.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1705094](https://bugzilla.mozilla.org/show_bug.cgi?id=1705094)

#### [#CVE-2022-22748: Spoofed origin on external protocol launch dialog](#CVE-2022-22748)

Reporter
Alesandro Ortiz
Impact
moderate
##### Description

Malicious websites could have confused Firefox into showing the wrong origin when asking to launch a program and handling an external URL protocol.

##### References

* [Bug 1705211](https://bugzilla.mozilla.org/show_bug.cgi?id=1705211)

#### [#CVE-2022-22745: Leaking cross-origin URLs through securitypolicyviolation event](#CVE-2022-22745)

Reporter
Jannis Rautenstrauch
Impact
moderate
##### Description

Securitypolicyviolation events could have leaked cross-origin information for frame-ancestors violations

##### References

* [Bug 1735856](https://bugzilla.mozilla.org/show_bug.cgi?id=1735856)

#### [#CVE-2022-22744: The 'Copy as curl' feature in DevTools did not fully escape website-controlled data, potentially leading to command injection](#CVE-2022-22744)

Reporter
Mattias Jacobsson
Impact
moderate
##### Description

The constructed curl command from the "Copy as curl" feature in DevTools was not properly escaped for PowerShell. This could have lead to command injection if pasted into a Powershell prompt.
*This bug only affects Firefox for Windows. Other operating systems are unaffected.*

##### References

* [Bug 1737252](https://bugzilla.mozilla.org/show_bug.cgi?id=1737252)

#### [#CVE-2022-22763: Script Execution during invalid object state](#CVE-2022-22763)

Reporter
Mozilla Fuzzing Team
Impact
moderate
##### Description

When a worker is shutdown, it was possible to cause script to run late in the lifecycle, at a point after where it should not be possible.

##### References

* [Bug 1740534](https://bugzilla.mozilla.org/show_bug.cgi?id=1740534)

#### [#CVE-2022-22747: Crash when handling empty pkcs7 sequence](#CVE-2022-22747)

Reporter
Tavis Ormandy
Impact
low
##### Description

After accepting an untrusted certificate, handling an empty pkcs7 sequence as part of the certificate data could have lead to a crash. This crash is believed to be unexploitable.

##### References

* [Bug 1735028](https://bugzilla.mozilla.org/show_bug.cgi?id=1735028)

#### [#CVE-2022-22736: Potential local privilege escalation when loading modules from the install directory.](#CVE-2022-22736)

Reporter
Kirtikumar Anandrao Ramchandani, Toshihito Kikuchi
Impact
low
##### Description

If Firefox was installed to a world-writable directory, a local privilege escalation could occur when Firefox searched the current directory for system libraries. However the install directory is not world-writable by default.
*This bug only affects Firefox for Windows in a non-default installation. Other operating systems are unaffected.*

##### References

* [Bug 1742692](https://bugzilla.mozilla.org/show_bug.cgi?id=1742692)

#### [#CVE-2022-22739: Missing throttling on external protocol launch dialog](#CVE-2022-22739)

Reporter
Alesandro Ortiz
Impact
low
##### Description

Malicious websites could have tricked users into accepting launching a program to handle an external URL protocol.

##### References

* [Bug 1744158](https://bugzilla.mozilla.org/show_bug.cgi?id=1744158)

#### [#CVE-2022-22751: Memory safety bugs fixed in Firefox 96 and Firefox ESR 91.5](#CVE-2022-22751)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Calixte Denizet, Kershaw Chang, Christian Holler, Jason Kratzer, Gabriele Svelto, Tyson Smith, Simon Giesecke, and Steve Fink reported memory safety bugs present in Firefox 95 and Firefox ESR 91.4. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 96 and Firefox ESR 91.5](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1664149%2C1737816%2C1739366%2C1740274%2C1740797%2C1741201%2C1741869%2C1743221%2C1743515%2C1745373%2C1746011)

#### [#CVE-2022-22752: Memory safety bugs fixed in Firefox 96](#CVE-2022-22752)

Reporter
Mozilla developers and community
Impact
moderate
##### Description

Mozilla developers Christian Holler and Jason Kratzer reported memory safety bugs present in Firefox 95. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 96](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1741210%2C1742770)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_634c93d9_20250115_085408.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1740534)
* [XML](/show_bug.cgi?ctype=xml&id=1740534)

Closed
[Bug 1740534](/show_bug.cgi?id=1740534)
(CVE-2022-22763)

Opened 3 years ago
Closed 3 years ago

# Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54

## Categories

### (Core :: DOM: Workers, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Workers#DOM%3A%20Workers)

DOM: Workers
▾

Core :: DOM: Workers
This component covers the [Web Workers](https://developer.mozilla.org/En/DOM/Worker) implementation in Gecko.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Workers&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Workers&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Workers)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S3

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

97 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr91 | [97+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=97%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed) |
| firefox95 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox95&o1=equals&v1=wontfix) |
| firefox96 | [+](/buglist.cgi?f1=cf_tracking_firefox96&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox96&o1=equals&v1=fixed) |
| firefox97 | [+](/buglist.cgi?f1=cf_tracking_firefox97&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox97&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr91 | 97+ | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox95 |  | wontfix |
| firefox96 | + | fixed |
| firefox97 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jkratzer, Assigned: asuth)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/75b1e0d00a677e73b24efe34917fa1e9?d=mm&size=40)  [asuth](/user_profile?user_id=151407)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/5c25f7e70acfdf0e73a58871a52f95b2?d=mm&size=40)  [jkratzer](/user_profile?user_id=586683)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/056757eff6ed7c8ec26f61e3bf7695fe?d=mm&size=40)  [smaug](/user_profile?user_id=39966)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

18 people

## References

### (Blocks 1 open bug)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[domino](/show_bug.cgi?id=1340565 "NEW - [meta] (domino) Bugs found while fuzzing with domino")

Dependency [tree](/showdependencytree.cgi?id=1740534&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1740534)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: sec-moderate, testcase, Whiteboard: [bugmon:confirm][adv-main96+r][adv-esr91.6+r])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2022-22763

[Keywords:](/describekeywords.cgi)

[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[bugmon:confirm][adv-main96+r][adv-esr91.6+r]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [mboldan](/user_profile?user_id=551058) | [qe-verify](#a4637291_551058 "3 years ago") | - |
| --- | --- | --- |
| [mboldan](/user_profile?user_id=551058) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files, 2 obsolete files)

| [Testcase](/attachment.cgi?id=9250210)  [3 years ago](#c1)  [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)   5.14 KB, application/octet-stream |  | [Details](/attachment.cgi?id=9250210&action=edit) |
| --- | --- | --- |
| [Testcase](/attachment.cgi?id=9252865)  [3 years ago](#c5)  [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)   5.54 KB, application/zip |  | [Details](/attachment.cgi?id=9252865&action=edit) |
| [testcase.zip](/attachment.cgi?id=9252871)  [3 years ago](#c6)  [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)   5.49 KB, application/zip |  | [Details](/attachment.cgi?id=9252871&action=edit) |
| [Bug 1740534 - Improve global consistency. r=smaug](/attachment.cgi?id=9254570)  [3 years ago](#c19)  [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#c33 "3 years ago")  RyanVM : [approval-mozilla-esr91+](#c36 "3 years ago") | [Details](/attachment.cgi?id=9254570&action=edit) | [Review](/attachment.cgi?id=9254570) |
| [modified version of mochitest test\_bug986542.html for investigation](/attachment.cgi?id=9254800)  [3 years ago](#c25)  [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)   2.64 KB, text/html |  | [Details](/attachment.cgi?id=9254800&action=edit) |
| [advisory.txt](/attachment.cgi?id=9262303)  [3 years ago](#c38)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   208 bytes, text/plain |  | [Details](/attachment.cgi?id=9262303&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1740534#c0)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1740534&comment_id=15651630 "2 revisions") |
|  | |

Testcase found while fuzzing mozilla-central rev 333f08065c8c (built with: --enable-debug --enable-fuzzing).

Testcase can be reproduced using the following commands:

```
$ pip install fuzzfetch grizzly-framework
$ python -m fuzzfetch --build 333f08065c8c --debug --fuzzing -n firefox
$ python -m grizzly.replay ./firefox/firefox testcase.zip --repeat 10

```
```
Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54

    ==721216==ERROR: UndefinedBehaviorSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7f4a52b40f70 bp 0x7f4a484db430 sp 0x7f4a484db3f0 T721294)
    ==721216==The signal is caused by a WRITE memory access.
    ==721216==Hint: address points to the zero page.
        #0 0x7f4a52b40f70 in ForgetBodyStream /dom/base/BodyStream.cpp:54:3
        #1 0x7f4a52b40f70 in mozilla::dom::BodyStream::ReleaseObjects(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /dom/base/BodyStream.cpp:545:18
        #2 0x7f4a52b41916 in mozilla::dom::BodyStream::Close() /dom/base/BodyStream.cpp
        #3 0x7f4a52b3f4eb in operator() /dom/base/BodyStream.cpp:98:51
        #4 0x7f4a52b3f4eb in ~ScopeExit /builds/worker/workspace/obj-build/dist/include/mozilla/ScopeExit.h:106:7
        #5 0x7f4a52b3f4eb in mozilla::dom::BodyStream::Create(JSContext*, mozilla::dom::BodyStreamHolder*, nsIGlobalObject*, nsIInputStream*, mozilla::ErrorResult&) /dom/base/BodyStream.cpp:151:1
        #6 0x7f4a544a322d in mozilla::dom::FetchBody<mozilla::dom::Response>::GetBody(JSContext*, JS::MutableHandle<JSObject*>, mozilla::ErrorResult&) /dom/fetch/Fetch.cpp:1394:3
        #7 0x7f4a53492eed in mozilla::dom::Response_Binding::get_body(JSContext*, JS::Handle<JSObject*>, void*, JSJitGetterCallArgs) /builds/worker/workspace/obj-build/dom/bindings/ResponseBinding.cpp:1295:24
        #8 0x7f4a54053fdf in bool mozilla::dom::binding_detail::GenericGetter<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /dom/bindings/BindingUtils.cpp:3182:13
        #9 0x7f4a5795e5bf in CallJSNative(JSContext*, bool (*)(JSContext*, unsigned int, JS::Value*), js::CallReason, JS::CallArgs const&) /js/src/vm/Interpreter.cpp:385:13
        #10 0x7f4a5795dcbb in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /js/src/vm/Interpreter.cpp:472:12
        #11 0x7f4a5795f79e in InternalCall(JSContext*, js::AnyInvokeArgs const&, js::CallReason) /js/src/vm/Interpreter.cpp:532:10
        #12 0x7f4a5796082f in Call /js/src/vm/Interpreter.cpp:549:8
        #13 0x7f4a5796082f in js::CallGetter(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::MutableHandle<JS::Value>) /js/src/vm/Interpreter.cpp:675:10
        #14 0x7f4a57ccda0f in CallGetter /js/src/vm/NativeObject.cpp:1942:12
        #15 0x7f4a57ccda0f in bool GetExistingProperty<(js::AllowGC)1>(JSContext*, js::MaybeRooted<JS::Value, (js::AllowGC)1>::HandleType, js::MaybeRooted<js::NativeObject*, (js::AllowGC)1>::HandleType, js::MaybeRooted<JS::PropertyKey, (js::AllowGC)1>::HandleType, js::PropertyInfoBase<unsigned int>, js::MaybeRooted<JS::Value, (js::AllowGC)1>::MutableHandleType) /js/src/vm/NativeObject.cpp:1970:12
        #16 0x7f4a57cce0a3 in bool NativeGetPropertyInline<(js::AllowGC)1>(JSContext*, js::MaybeRooted<js::NativeObject*, (js::AllowGC)1>::HandleType, js::MaybeRooted<JS::Value, (js::AllowGC)1>::HandleType, js::MaybeRooted<JS::PropertyKey, (js::AllowGC)1>::HandleType, IsNameLookup, js::MaybeRooted<JS::Value, (js::AllowGC)1>::MutableHandleType) /js/src/vm/NativeObject.cpp:2116:14
        #17 0x7f4a579647ef in GetProperty /js/src/vm/ObjectOperations-inl.h:115:10
        #18 0x7f4a579647ef in js::GetProperty(JSContext*, JS::Handle<JSObject*>, JS::Handle<JS::Value>, js::PropertyName*, JS::MutableHandle<JS::Value>) /js/src/vm/ObjectOperations-inl.h:122:10
        #19 0x7f4a57963ca0 in js::GetProperty(JSContext*, JS::Handle<JS::Value>, JS::Handle<js::PropertyName*>, JS::MutableHandle<JS::Value>) /js/src/vm/Interpreter.cpp:4548:10
        #20 0x7f4a579529bb in GetPropertyOperation /js/src/vm/Interpreter.cpp:203:10
        #21 0x7f4a579529bb in Interpret(JSContext*, js::RunState&) /js/src/vm/Interpreter.cpp:2904:12
        #22 0x7f4a5794bbe5 in js::RunScript(JSContext*, js::RunState&) /js/src/vm/Interpreter.cpp:354:13
        #23 0x7f4a5795dbb6 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /js/src/vm/Interpreter.cpp:504:13
        #24 0x7f4a5795f79e in InternalCall(JSContext*, js::AnyInvokeArgs const&, js::CallReason) /js/src/vm/Interpreter.cpp:532:10
        #25 0x7f4a5795f9a1 in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /js/src/vm/Interpreter.cpp:549:8
        #26 0x7f4a57b17c21 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /js/src/vm/CallAndConstruct.cpp:117:10
        #27 0x7f4a53df182c in mozilla::dom::VoidFunction::Call(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/FunctionBinding.cpp:81:8
        #28 0x7f4a52d81e25 in mozilla::dom::VoidFunction::Call(mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/FunctionBinding.h:172:12
        #29 0x7f4a52d81c0e in QueuedMicrotask::Run(mozilla::AutoSlowOperation&) /dom/base/nsIGlobalObject.cpp:271:31
        #30 0x7f4a50dcec18 in mozilla::CycleCollectedJSContext::PerformMicroTaskCheckPoint(bool) /xpcom/base/CycleCollectedJSContext.cpp:674:17
        #31 0x7f4a50dcfa3c in mozilla::CycleCollectedJSContext::AfterProcessTask(unsigned int) /xpcom/base/CycleCollectedJSContext.cpp:463:3
        #32 0x7f4a50efa45a in nsThread::ProcessNextEvent(bool, bool*) /xpcom/threads/nsThread.cpp:1212:24
        #33 0x7f4a50f0126a in NS_ProcessNextEvent(nsIThread*, bool) /xpcom/threads/nsThreadUtils.cpp:467:10
        #34 0x7f4a554243d8 in mozilla::dom::WorkerPrivate::DoRunLoop(JSContext*) /dom/workers/WorkerPrivate.cpp:3105:7
        #35 0x7f4a554047a7 in mozilla::dom::workerinternals::(anonymous namespace)::WorkerThreadPrimaryRunnable::Run() /dom/workers/RuntimeService.cpp:2244:42
        #36 0x7f4a50efa149 in nsThread::ProcessNextEvent(bool, bool*) /xpcom/threads/nsThread.cpp:1169:16
        #37 0x7f4a50f0126a in NS_ProcessNextEvent(nsIThread*, bool) /xpcom/threads/nsThreadUtils.cpp:467:10
        #38 0x7f4a5198e624 in mozilla::ipc::MessagePumpForNonMainThreads::Run(base::MessagePump::Delegate*) /ipc/glue/MessagePump.cpp:330:5
        #39 0x7f4a518ac9f7 in MessageLoop::RunInternal() /ipc/chromium/src/base/message_loop.cc:331:10
        #40 0x7f4a518ac902 in RunHandler /ipc/chromium/src/base/message_loop.cc:324:3
        #41 0x7f4a518ac902 in MessageLoop::Run() /ipc/chromium/src/base/message_loop.cc:306:3
        #42 0x7f4a50ef5dbb in nsThread::ThreadFunc(void*) /xpcom/threads/nsThread.cpp:391:10
        #43 0x7f4a67a98a07 in _pt_root /nsprpub/pr/src/pthreads/ptthread.c:201:5
        #44 0x7f4a6880c608 in start_thread /build/glibc-eX1tMB/glibc-2.31/nptl/pthread_create.c:477:8
        #45 0x7f4a683d4292 in __clone /build/glibc-eX1tMB/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95

    UndefinedBehaviorSanitizer can not provide additional info.
    SUMMARY: UndefinedBehaviorSanitizer: SEGV /dom/base/BodyStream.cpp:54:3 in ForgetBodyStream
    ==721216==ABORTING

```

|  | [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1740534#c1)• 3 years ago |
|  | |

Attached file
[Testcase](attachment.cgi?id=9250210) (obsolete)
— [Details](attachment.cgi?id=9250210&action=edit)

|  | [Bugmon [:jkratzer for issues]](/user_profile?user_id=676404) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1740534#c2)• 3 years ago |
|  | |

**Bugmon Analysis**

Unable to reproduce [bug 1740534](/show_bug.cgi?id=1740534 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54") using build mozilla-central 20211110092453-333f08065c8c. Without a baseline, bugmon is unable to analyze this bug.

Removing bugmon keyword as no further action possible. Please review the bug and re-add the keyword for further analysis.

Keywords: [bugmon](/buglist.cgi?keywords=bugmon&resolution=---)

|  | [Hsin-Yi Tsai (she/her) [:hsinyi]](/user_profile?user_id=434964) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a73299_434964)• 3 years ago |

Component: DOM: Core & HTML → DOM: Streams

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1740534#c3)• 3 years ago |
|  | |

The severity field is not set for this bug.

:mgaudet, could you have a look please?

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#workflow.2Fno_severity.py).

Flags: needinfo?(mgaudet)

|  | [Matthew Gaudet (he/him) [:mgaudet]](/user_profile?user_id=607045) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1740534#c4)• 3 years ago |
|  | |

So: I could not reproduce this failure. (I do wonder if the testcase.zip is a bit incomplete? I looked at the test case and it expects a `worker.js`, but there's no `worker.js` packaged?)

The stack trace is definitely peculiar: We are in the middle of firing the [`ScopeExit` cleanup method](https://searchfox.org/mozilla-central/rev/65d4d3399afa79c8de5a0cc11752d2ba7c31edc1/dom/base/BodyStream.cpp#98). This means that we are taking an early exit from this method. There are [four possible paths](https://searchfox.org/mozilla-central/rev/65d4d3399afa79c8de5a0cc11752d2ba7c31edc1/dom/base/BodyStream.cpp#104,109,121,135).

Given [the stack and crash](https://searchfox.org/mozilla-central/rev/65d4d3399afa79c8de5a0cc11752d2ba7c31edc1/dom/base/BodyStream.cpp#545), we can guess that somehow this `BodyStream` has ended up with a null `mStreamHolder` member; mStreamHolder is initialized as part of the `BodyStream` constructor, and there's a diagnostic assert to guarantee it's non-null at that point. The other place where it is modified is part of `ReleaseObjects`, where it is `null`ed out. However, before then, [there's a state guard...](https://searchfox.org/mozilla-central/rev/65d4d3399afa79c8de5a0cc11752d2ba7c31edc1/dom/base/BodyStream.cpp#503-506,527,547).

So I'm not sure what to make of this one. For now, I'm going to mark as P3/S3.

Severity: -- → S3Flags: needinfo?(mgaudet)Priority: -- → P3

|  | [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1740534#c5)• 3 years ago |
|  | |

Attached file
[Testcase](attachment.cgi?id=9252865) (obsolete)
— [Details](attachment.cgi?id=9252865&action=edit)

My apologies. It looks like I had uploaded an incomplete testcase. The newly attached testcase can be reproduced using the following commands:

$ pip install fuzzfetch grizzly-framework

$ python -m fuzzfetch --build d03f87555639 --debug --fuzzing -n firefox

$ python -m grizzly.replay ./firefox/firefox testcase.zip --repeat 10

[Attachment #9250210](/attachment.cgi?id=9250210&action=edit "Testcase") -
Attachment is obsolete: true

|  | [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1740534#c6)• 3 years ago |
|  | |

Attached file
[testcase.zip](attachment.cgi?id=9252871)
— [Details](attachment.cgi?id=9252871&action=edit)

[Attachment #9252865](/attachment.cgi?id=9252865&action=edit "Testcase") -
Attachment is obsolete: true

|  | [Matthew Gaudet (he/him) [:mgaudet]](/user_profile?user_id=607045) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1740534#c7)• 3 years ago |
|  | |

Hmm.

OK; so with the updated test case, I can successfully reproduce the failure now. However, I cannot get it to reproduce under `rr`, which makes me wonder if there's something racy...; still, just reproducing isn't a *huge* help, unless I can get more information.

Jason: For me this test case reproduces first try with `python3 -m grizzly.replay ./firefox/firefox testcase.zip --repeat 10 --xvfb`; I wonder, is it possible to get grizzly.replay to run firefox under a regular debugger? Or is it possible to have your automation try to get a pernosco reproduction automatically?

Flags: needinfo?(jkratzer)

|  | [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1740534#c8)• 3 years ago |
|  | |

:mgaudet, unfortunately I've also been trying to get a pernosco session of this bug without any luck so far. As for running under a regular debugger, grizzly.replay does not have that capability. However, I can confirm that the crash triggers on a default debug build without any special prefs set. Just unzip the testcase, start a local webserver and point Firefox to testcase.html.

Flags: needinfo?(jkratzer)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1740534#c9)• 3 years ago |
|  | |

A Pernosco session is available here: <https://pernos.co/debug/paeqwbX6GxYe8l4H0PZdGQ/index.html>

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a2346635_486634)• 3 years ago |

Flags: needinfo?(mgaudet)

|  | [Matthew Gaudet (he/him) [:mgaudet]](/user_profile?user_id=607045) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1740534#c10)• 3 years ago |
|  | |

🤩 Thanks so much Tyson! I'm excited to dig in!

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1740534#c11)• 3 years ago |
|  | |

(In reply to Matthew Gaudet (he/him) [:mgaudet] from [comment #10](/show_bug.cgi?id=1740534#c10 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54"))

> 🤩 Thanks so much Tyson! I'm excited to dig in!

Happy to help! That one was one of the most stubborn to reproduce (under rr) I've seen :)

|  | [Matthew Gaudet (he/him) [:mgaudet]](/user_profile?user_id=607045) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1740534#c12)• 3 years ago |
|  | |

Ok. There's some more detailed notes in the pernosco trace. Given the trace, I suspect I understand more about why this was so hard to reproduce.

This assertion failure is the combination of two factors playing together:

1. Worker Shutdown. As I understand it, [Workers can go away at any time](https://searchfox.org/mozilla-central/source/dom/workers/WorkerRef.h#19-21) but as near as I can tell, during shutdown there is still some (JS) code execution that happens once shutdown has started.
2. Fetch Bodies try to lazily create their body streams. Note, a FetchBody is also a BodyStreamHolder

My read of the Pernosco trace (this bug is a huge huge argument in favour of the productivity benefit it brings) is this:

1. We have a fetch inside a worker, and we request the stream.
2. As part of this, We create a `WeakWorkerRef`, and as a shutdown callback we tell it to call `stream->Close()`
3. The worker begins to shutdown. At this point the `WeakWorkerRef` is notified, and `stream->Close()` is called. This nulls out the stream in the `BodyStreamHolder` (FetchBody)
4. *This is the part that is most unclear to me*: Some more JS runs, and we yet-again try to get a Stream for the `FetchBody`. The Lazy stream creation code kicks in *again*, so we start to create a different BodyStream.
5. Because we're in a worker, we try to create a `WeakWorkerRef`, again, but this time the system declines, as we're already cancelling; so we side exit from `BodyStream::Create`. Now, to ensure cleanup, there's a `ScopeExit` on the stack inside of `BodyStream::Create`, which calls `stream->Close()` on any side-exits from the create function, so this is invoked. This stream knows that it has `FetchBody` as a stream holder, and tries to disconnect that edge... but here's where the assertion fires, as `FetchBody` already had a stream created and nulled out, but `mStreamCreated` was never set to false.

So: the fix for this bug isn't immediately clear to me. It seems to me that we probably don't want to be trying to create a BodyStream for a `FetchBody` in a worker if the worker is already terminating... but I don't entirely understand what JS code should be continuing to run and under what circumstances during worker shutdown.

Andrew: is there a pattern for this kind of thing that is established elsewhere?

Flags: needinfo?(mgaudet) → needinfo?(bugmail)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1740534#c13)• 3 years ago |
|  | |

Marking this as a secbug as this now gets into territory of pointing out interesting things for security researchers; it might be reasonable to relax this.

The situation:

* We're running a content Promise during a microtask queue drain during worker shutdown and we should not be.
  + The pernosco trace is missing the generated Unified\_cpp\_dom\_base8.cpp and UnifiedBindings6.cpp, presumably due to omitting the objdir from the command-line passed to pernosco-submit? But it seems likely these frames are in CallbackObject and are inlined.
* The [check if we can run script](https://html.spec.whatwg.org/multipage/webappapis.html#check-if-we-can-run-script) algorithm is generally responsible for making sure we don't call into content too late. It's sorta window-specific in the spec. Specific spec call-sites are:
  + [In run a classic script](https://html.spec.whatwg.org/multipage/webappapis.html#calling-scripts:check-if-we-can-run-script).
  + [In run a module script](https://html.spec.whatwg.org/multipage/webappapis.html#calling-scripts:check-if-we-can-run-script-2).
  + [In HostEnqueuePromiseJob](https://html.spec.whatwg.org/multipage/webappapis.html#hostenqueuepromisejob:check-if-we-can-run-script) which notably enqueues a microtask that runs the check at runtime (not enqueue time).
* Our implementation of "check if we can run script" is [this logic in CallbackObject::CallSetup::CallSetup](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/bindings/CallbackObject.cpp#227-261). This combines:
  + For windows, the spec [window active document check](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/bindings/CallbackObject.cpp#240)
  + In [nsIGlobalObject::IsScriptForbidden](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsIGlobalObject.h#84-90):
    - A failsafe back-stop for workers to avoid calling into content during ClearMainEventQueue that I added in [bug 1545345](/show_bug.cgi?id=1545345 "RESOLVED FIXED - Web Workers - Use After Free with XMLHttpRequest") (and made some supporting changes).
    - A [Scriptability check](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsIGlobalObject.cpp#50-57). This allows:
      * Blocking at creation time by: [determination via nsIPrincipal::IsScriptAllowedByPolicy](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/js/xpconnect/src/XPCJSRuntime.cpp#472)
      * Blocking dynamically via [Scriptability::SetWindowAllowsScript](https://searchfox.org/mozilla-central/search?q=symbol:_ZN3xpc13Scriptability21SetWindowAllowsScriptEb&redirect=false) which can be altered by [getting disabled by going into the bfcache in WindowStateHolder](https://searchfox.org/mozilla-central/search?q=symbol:_ZN3xpc13Scriptability21SetWindowAllowsScriptEb&redirect=false), and BrowserContext/WindowContext [propagation](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsGlobalWindowOuter.cpp#2361) and [recomputation](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/docshell/base/WindowContext.cpp#297-298,300-301,313) when the synced [AllowJavascript field](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/docshell/base/WindowContext.h#93-95) changes.
      * Blocking dynamically with paired allow/block via: [Cu.blockScriptForGlobal](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/js/xpconnect/idl/xpccomponents.idl#507-519), the [slow script dialog disabling script](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/js/xpconnect/src/XPCJSContext.cpp#747), an additional [action taken in NukeAllWrappersForRealm](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/js/xpconnect/src/XPCJSRuntime.cpp#654).
* Notably we don't check [nsIGlobalObject::IsDying](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsIGlobalObject.h#68-82) which is our closest approximation to appropriate logic for "check if we can run script" for a worker.
  + This method is used [in a number of spots](https://searchfox.org/mozilla-central/search?q=symbol:_ZNK15nsIGlobalObject7IsDyingEv&redirect=false)
  + A notable other helper API in this area is [DOMEventTargetHelper::CheckCurrentGlobalCorrectness which uses IsDying](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsIGlobalObject.cpp#44)
* **The lack of this check to IsDying is the problem.**
  + Interestingly, while [QueuedMicrotask::Run](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsIGlobalObject.cpp#271) does not check IsDying(), [PromiseJobRunnable does check IsDying.](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/xpcom/base/CycleCollectedJSContext.cpp#203).
* This conservative approach here was taken by me in [bug 1545345](/show_bug.cgi?id=1545345 "RESOLVED FIXED - Web Workers - Use After Free with XMLHttpRequest") because there was a security bug that needed to be backported and I was more concerned about regressions for a backport and less confident/in-the-know about spec related things for this. (Also, the spec and consensus around global lifetimes has improved a lot.)

As a solution I would propose:

* nsIGlobalObject should gain a method that more directly corresponds to [check if we can run script](https://html.spec.whatwg.org/multipage/webappapis.html#check-if-we-can-run-script) like `CanRunScript`.
  + If `mIsDying` or `mIsScriptForbidden`, we return false. This covers the normal global-is-dying case plus the worker paranoia case where ClearMainEventQueue is happening.
  + For windows, this maintains the `HasActiveDocument` check, returning false if it's not active.
  + The [Scriptability Allowed check from IsScriptForbidden](https://searchfox.org/mozilla-central/rev/1674b86019a96f076e0f98f1d0f5f3ab9d4e9020/dom/base/nsIGlobalObject.cpp#50-57) can be in there or can move back out to CallbackObject.
* We haveCallbackObject use CanRunScript. It's already the case that we are doing virtual dispatch to call `IsScriptForbidden`, so as long as we don't get crazy with the virtual dispatch, performance isn't likely to be a problem.

:smaug, does this seem reasonable from an implementation perspective?

:annevk, does it make sense that the can run script spec should perhaps gain some more discussion of workers? (Maybe there's existing issues/PR's on this?)

Group: core-securityFlags: needinfo?(bugs)Flags: needinfo?(bugmail)Flags: needinfo?(annevk)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a2455976_406194)• 3 years ago |

Group: core-security → dom-core-security

|  | [Anne (:annevk)](/user_profile?user_id=102998) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1740534#c14)• 3 years ago |
|  | |

Yeah, it would make sense for that to check <https://html.spec.whatwg.org/#dom-workerglobalscope-closing> I think. Should be an easy PR, but maybe we want to wait until a fix is in?

Flags: needinfo?(annevk)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1740534#c15)• 3 years ago |
|  | |

I don't think QueuedMicrotask::Run should check anything, but Callsetup should. And it does. So IsScriptForbidden could check mIsDying

Flags: needinfo?(bugs)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1740534#c16)• 3 years ago |
|  | |

(In reply to Olli Pettay [:smaug] from [comment #15](/show_bug.cgi?id=1740534#c15 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54"))

> I don't think QueuedMicrotask::Run should check anything, but Callsetup should. And it does. So IsScriptForbidden could check mIsDying

Agreed on QueuedMicrotask. And yeah, just altering IsScriptForbidden sounds like a great minimal fix, thanks! We can potentially rename things in the future (and not near as a security bug) to look more like spec terminology.

Assignee: nobody → bugmailStatus: NEW → ASSIGNED

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1740534#c17)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1740534&comment_id=15690266 "1 revision") |
|  | |

I'm categorizing this as sec-moderate from <https://wiki.mozilla.org/Security_Severity_Ratings/Client> with a rationale of:

* I don't believe this is directly exploitable. I also don't believe this is indirectly exploitable.
  + This only allows a single draining of the microtask queue after a task where content was already running.
  + We will not have run any shutdown-related GC's or any other specialized shutdown logic on the way out of the primary runnable because we have not yet begun to unwind that loop.
    - The scope and JS context are all still valid. The dying global is a DOM construct, not a JS construct.
  + WorkerRefs will correctly fail to be created at this time which code should handle.
* However this is still definitely an invariant violation and there's no need to point people directly at it, so this still gets to be a security bug. (It's of course plausible that this could be chained with other, more serious bugs.)
* Because there is an invariant being violated here, as in this bug, code can get upset as its invariants get violated as code runs after WorkerRefs had their callbacks invoked and their DETHs disconnected. So we do expect assertion violations and potentially nullptr dereferences.
  + DOMEventTargetHelper instance will bind to parents even though CheckCurrentGlobalCorrectness would return false, however, the DETH instances will properly be detached again [on our way out of the primary run loop](https://searchfox.org/mozilla-central/rev/4ca2f73ae9346709d39de2c8fe33874e4203b9e6/dom/workers/RuntimeService.cpp#2245) (and actually would be done again in nsIGlobalObject's destructor where the scope closes in the next line, but no new DETHs should be added during that interval; if they are, that would be a different, serious bug).

I think it's worth fixing and landing this bug now with a target of uplifting into beta here early in the cycle, especially as it is likely that this will likely help eliminate a number of fuzzing errors that could otherwise be distracting. It could also make sense to let this be uplifted to release if there are dot releases but I don't believe this would necessarily be urgent for security reasons, but could be desirable as there could reasonably be non-exploitable crashes that could be eliminated.

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1740534#c18)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1740534&comment_id=15690304 "1 revision") |
|  | |

(In reply to Anne (:annevk) from [comment #14](/show_bug.cgi?id=1740534#c14 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54"))

> Yeah, it would make sense for that to check <https://html.spec.whatwg.org/#dom-workerglobalscope-closing> I think. Should be an easy PR, but maybe we want to wait until a fix is in?

Yes, agreed on waiting. There may also be some edge cases here around the difference between a `self.close()` and a `Worker.terminate()` to deal with.

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1740534#c19)• 3 years ago |
|  | |

Attached file
[Bug 1740534 - Improve global consistency. r=smaug](attachment.cgi?id=9254570)
— [Details](attachment.cgi?id=9254570&action=edit)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1740534#c20)• 3 years ago |
|  | |

Try run at <https://treeherder.mozilla.org/jobs?repo=try&revision=9d3527ff3b0662fa892d67c8fbbef97d147420a0> shows that tests that are explicitly about things still working in detached iframes get angry when things do not work in detached iframes! I feel like we've been talking about being more strict for detached iframes in general and it seems like there are somehow maybe only 2 of these[1], so maybe this is all okay?

Specific things:

1. [Bug 986542](/show_bug.cgi?id=986542 "VERIFIED FIXED - .onClick event handler function not firing if defined in a document that was in a now-removed iframe") (in 2014) gave us <https://searchfox.org/mozilla-central/source/js/xpconnect/tests/mochitest/test_bug986542.html> that wants onclick to work in a detached iframe. This decision seems to have been made on the basis of the site in question breaking between Firefox 27 and Firefox 28.
2. <https://searchfox.org/mozilla-central/source/testing/web-platform/tests/dom/traversal/TreeWalker-acceptNode-filter-cross-realm-null-browsing-context.html> fails with: `TEST-UNEXPECTED-FAIL | /dom/traversal/TreeWalker-acceptNode-filter-cross-realm-null-browsing-context.html | TreeWalker: NodeFilter from detached iframe works as expected - NodeIterator.nextNode: Refusing to execute function from global in which script is disabled.`

* Chrome (and of course therefore Edge) [fail this per wpt.fyi](https://wpt.fyi/results/dom/traversal/TreeWalker-acceptNode-filter-cross-realm-null-browsing-context.html?label=experimental&label=master&aligned) which seems like they're probably right about this? The error they report is `FAIL message: Failed to execute 'acceptNode' on 'NodeFilter': The provided callback is no longer runnable.` but presumably these differences are our platform specific strings?

:smaug / :annevk, does it seem reasonable for us to be treating detached iframes properly as dead globals or is this the tip of a compat nightmare for now and only workers need to care about dead globals?

1: Of course, as soon as a test fails in a dir, it's basically game over, so I've revised my patch to delete the mochitest for the first failure and altered our expectation to failure for the 2nd (with the expectation that we can fix the test in the future when we do the spec-y stuff) and have pushed that with another try push at <https://treeherder.mozilla.org/#/jobs?repo=try&revision=c412faec7468fa13cbebc7aa63f0cc34e4d085bf>

Flags: needinfo?(bugs)Flags: needinfo?(annevk)

|  | [Anne (:annevk)](/user_profile?user_id=102998) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1740534#c21)• 3 years ago |
|  | |

A detached `iframe` does not result in a "dead" global. You can still have a hold on it and do things with it. This is different from the worker scenario. In the worker scenario it's really the agent that goes down and in the detached `iframe` case the agent is still very much there (except I suppose if it was cross-site). A detached `iframe` does result in a document that is no longer fully active, so it can no longer queue tasks and such.

I think it's known that Chromium has bugs here.

So my recommendation would be to limit this to workers.

Flags: needinfo?(annevk)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1740534#c22)• 3 years ago |
|  | |

(In reply to Andrew Sutherland [:asuth] (he/him) from [comment #20](/show_bug.cgi?id=1740534#c20 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54"))

> Specific things:
>
> 1. [Bug 986542](/show_bug.cgi?id=986542 "VERIFIED FIXED - .onClick event handler function not firing if defined in a document that was in a now-removed iframe") (in 2014) gave us <https://searchfox.org/mozilla-central/source/js/xpconnect/tests/mochitest/test_bug986542.html> that wants onclick to work in a detached iframe. This decision seems to have been made on the basis of the site in question breaking between Firefox 27 and Firefox 28.

The pernosco robot gave me a [pernosco trace](https://pernos.co/debug/Dex3YWGYbioRodrOPWVUTw/index.html#f%7Bm%5BAWId,EReD_,t%5Bjw,CM4_,f%7Be%5BAWId,CO49_,s%7Baf1YFh6AA,bARk,uCBlcCA,oCCObBQ___/) for this automatically.

Copying some limited analysis I did into here: <https://searchfox.org/mozilla-central/source/js/xpconnect/tests/mochitest/test_bug986542.html> is doing an intentionally weird thing with target.onclick = ifr.contentWindow.f; where it's trying to have the parent window's click handler be a reference to JS code that's explicitly in the iframe's global. (Like the function it's referencing was created by a dynamically generated script tag string, so it's not accidentally creating the function in the parent window's global.)

I think our change in behavior here may be appropriate, as I believe [Can Run Script](https://html.spec.whatwg.org/multipage/webappapis.html#check-if-we-can-run-script) is saying we shouldn't run script if the detached iframe isn't fully active, which would be the situation in this case unless there's a wrapper bug where the environment settings object that should be considered as used is the parent window?

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1740534#c23)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1740534&comment_id=15691781 "1 revision") |
|  | |

Replicating some of my comments to :annevk in slack here too, but I think the key thing is that I mis-characterized these failures as indicating this would be a major regression in our behavior, when the reality is that there are two tests that seem to be broken per spec.

(In reply to Andrew Sutherland [:asuth] (he/him) from [comment #20](/show_bug.cgi?id=1740534#c20 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54"))

> 2. <https://searchfox.org/mozilla-central/source/testing/web-platform/tests/dom/traversal/TreeWalker-acceptNode-filter-cross-realm-null-browsing-context.html> fails with: `TEST-UNEXPECTED-FAIL | /dom/traversal/TreeWalker-acceptNode-filter-cross-realm-null-browsing-context.html | TreeWalker: NodeFilter from detached iframe works as expected - NodeIterator.nextNode: Refusing to execute function from global in which script is disabled.`

For the TreeWalker case, it seems like the situation is that the NodeIterator is created in the iframe, which is then immediately removed, then a test is done to use the NodeIterator which is very definitely created inside the iframe's global (via a helper in the iframe's source file). That's [these lines](https://searchfox.org/mozilla-pine/rev/180c581b0f823473f7681d1a6c73aaf7f9d048cf/browser/components/companion/services/workshop/src/clientapi/mail_folder.js#49-50).

And it seems like maybe the NodeIterator actually wants to try and work in that case, but because the node iterator takes the [filter function that's definitely created in the iframe global and definitely executed in the iframe global](https://searchfox.org/mozilla-central/rev/9028b0458cc1f432870d2996b186b0938dda734a/testing/web-platform/tests/dom/traversal/support/TreeWalker-acceptNode-filter-cross-realm-null-browsing-context-subframe.html#5-8) we need to run code in the not fully active document, and we fail there. This also seems like the fix is likely correctly forbidding that.

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1740534#c24)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1740534&comment_id=15691945 "1 revision") |
|  | |

:annevk and I reached clarity/consensus on the failing tests above. The conclusions as I understand them are:

* Spec-wise, there is a gap in WebIDL's [Invoking Callback Functions](https://webidl.spec.whatwg.org/#es-invoking-callback-functions) and this should be rectified after our fix here sufficiently lands.
  + Step 5 and 6 are appropriately retrieving the settings object from the callback, but the WebIDL spec is not calling [check if we can run script](https://html.spec.whatwg.org/multipage/webappapis.html#check-if-we-can-run-script) as part of/prelude to step 11, even though [prepare to run script](https://html.spec.whatwg.org/multipage/webappapis.html#prepare-to-run-script) is correctly being called with the right settings object in step 8.
* Both of the tests that failed above are in fact depending on the ability to call into script when [check if we can run a script](https://html.spec.whatwg.org/multipage/webappapis.html#check-if-we-can-run-script) would return "do not run" because the detached iframe is not fully active. And so it's reasonable for us to appropriately disable the tests, in this case removing the incorrect mochitest and marking the WPT test as an expected failure, with plans to correct the WPT test as part of the spec-work.
* When addressing the spec issues, we'll also make sure to ensure WPT coverage for these changes, with both of these tests providing good insight to examples of how this might be tested!

I'm clearing the needinfo on :smaug because I think I have all the answers necessary here.

I'll post an attachment in a second that's a revised version of the mochitest that I used for exploration when talking to Anne.

Flags: needinfo?(bugs)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1740534#c25)• 3 years ago |
|  | |

Attached file
[modified version of mochitest test\_bug986542.html for investigation](attachment.cgi?id=9254800)
— [Details](attachment.cgi?id=9254800&action=edit)

My explanations about results/what's under tests:

* Only the third case passes. The first case is the original check of the original test. The second case is when the handler was defined in the iframe global, the third case is when the handler was defined in the parent window global.
* The 2nd and 3rd tests are checking whether the window global's DOM under-pinnings are still happy to run dispatchEvent on the dead global.
* The 1st and 2nd tests are checking whether can run script returns true for a not fully active document (as enforced by our isDying check, and not previously enforced). I guess normally this check would depend on the inner window not being the current inner window for the outer window. But for a detached iframe, the inner window is still the current inner window.

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1740534#c26)• 3 years ago |
|  | |

My attempt to land this on Friday ran into some variation of [bug 1714646](/show_bug.cgi?id=1714646 "RESOLVED FIXED - moz-phab submits to the wrong branch if you switch between branches in the same local repository") (which has been fixed for a while) where it picked pine as upstream when it should not have picked pine as upstream. (This likely has to do with me switching to using git after a number of very bad experiences with the "evolution" extension creating worst-case scenarios on rebases/histedits gone wrong. git obviously presents additional edge-cases for moz-phab.)

I'm not sure this is easily salvageable from within the existing diff and may just end up resubmitting as a fresh patch and overriding all the things that get upset about patches not being officially reviewed.

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1740534#c27)• 3 years ago |
|  | |

Improve global consistency. r=smaug

<https://hg.mozilla.org/integration/autoland/rev/ebbf05cd3be0f7bb664407e53e03ab47c7da7928>

<https://hg.mozilla.org/mozilla-central/rev/ebbf05cd3be0>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 3 years ago
[status-firefox97](/buglist.cgi?f1=cf_status_firefox97&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox97&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 97 Branch

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1740534#c28)• 3 years ago |
|  | |

(Moving this into workers for clarity about where the fix was.)

Component: DOM: Streams → DOM: Workers

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1740534#c29)• 3 years ago |
|  | |

Reading through this bug, it's not clear to me how much bake time this fix needs to identify what (if any) webcompat fallout there will be from it. Are we still thinking we want to uplift this cycle or do want to have it ride 97 instead?

[status-firefox95](/buglist.cgi?f1=cf_status_firefox95&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox95&o1=equals&v1=wontfix)
[status-firefox96](/buglist.cgi?f1=cf_status_firefox96&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox96&o1=equals&v1=affected)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected)Flags: needinfo?(bugmail)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1740534#c30)• 3 years ago |
|  | |

Comment on [attachment 9254570](/attachment.cgi?id=9254570 "Bug 1740534 - Improve global consistency. r=smaug") [[details]](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug")

[Bug 1740534](/show_bug.cgi?id=1740534 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54") - Improve global consistency. r=smaug

### Beta/Release Uplift Approval Request

* **User impact if declined**: There should be no usable-visible impacts from this fix as it concerns edge-cases that would primarily occur when a browser tab is being closed and there is no potential for the page to do anything that would have meaningful impact. (Storage can no longer be written to, etc.)

This fix eliminates an edge-case that, while we are not aware of any security exploits, seems like the type of thing where it would be better to eliminate the edge-case rather than discover later on that security experts are exceedingly clever in ways we could not foresee.

* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Our initial fears of potential web-compat issues on this bug and the patch were overblown. The removed mochitest is a single example of a site doing something very sketchy and where we intentionally maintained behavior for compatibility reasons in the absence of clear semantics at a spec level. The web platform has advanced to a point where we have specs for these things and clarity about what is and is not appropriate; there is a gap in our spec text in WebIDL, but it's clear that our test was wrong and contradicts the authoritative "can run script" check that should be run.

That said, it's possible there could be breakage out there somewhere on the web, but this needs to be weighed against the reality that to maintain that behavior would be to intentionally poke holes in our invariants in a way that could lead to serious security bugs.

* **String changes made/needed**:
Flags: needinfo?(bugmail)
[Attachment #9254570](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug") -
Flags: approval-mozilla-beta?

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1740534#c31)• 3 years ago |
|  | |

(In reply to Ryan VanderMeulen [:RyanVM] from [comment #29](/show_bug.cgi?id=1740534#c29 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54"))

> Reading through this bug, it's not clear to me how much bake time this fix needs to identify what (if any) webcompat fallout there will be from it. Are we still thinking we want to uplift this cycle or do want to have it ride 97 instead?

We should definitely uplift this to beta and I've requested that above. I would wait on ESR uplift until after this hits release, however, given that ESR users seem more likely to be running sites that do sketchy and/or Firefox-specific things and where sites are unlikely to be updated in a timely fashion.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a3122524_75935)• 3 years ago |

[tracking-firefox96](/buglist.cgi?f1=cf_tracking_firefox96&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox96&o1=equals&v1=%2B)
[tracking-firefox97](/buglist.cgi?f1=cf_tracking_firefox97&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox97&o1=equals&v1=%2B)
[tracking-firefox-esr91](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=isnotempty):
--- → [97+](/buglist.cgi?f1=cf_tracking_firefox_esr91&o1=equals&v1=97%2B)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1740534#c32)• 3 years ago |
|  | |

Changing the priority to p1 as the bug is tracked by a release manager for the current beta.

See [What Do You Triage](https://firefox-source-docs.mozilla.org/bug-mgmt/guides/priority.html) for more information

Priority: P3 → P1

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1740534#c33)• 3 years ago |
|  | |

Comment on [attachment 9254570](/attachment.cgi?id=9254570 "Bug 1740534 - Improve global consistency. r=smaug") [[details]](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug")

[Bug 1740534](/show_bug.cgi?id=1740534 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54") - Improve global consistency. r=smaug

Approved for 96.0b7

[Attachment #9254570](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1740534#c34)• 3 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/4946d7aa99f9>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a3202433_690067)• 3 years ago |

[status-firefox96](/buglist.cgi?f1=cf_status_firefox96&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox96&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox96&o1=equals&v1=fixed)

|  | [Mihai Boldan, Desktop QA [:mboldan]](/user_profile?user_id=551058) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a4637291_551058)• 3 years ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a4748082_428608)• 3 years ago |

Whiteboard: [bugmon:confirm] → [bugmon:confirm][adv-main96+r]

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407)  Assignee |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1740534#c35)• 3 years ago |
|  | |

Comment on [attachment 9254570](/attachment.cgi?id=9254570 "Bug 1740534 - Improve global consistency. r=smaug") [[details]](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug")

[Bug 1740534](/show_bug.cgi?id=1740534 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54") - Improve global consistency. r=smaug

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: This helps rule out eliminate a class of worker shutdown related potential crashes and security bugs.
* **User impact if declined**: (copied from beta request, where beta has now reached release without incident that we know of): There should be no usable-visible impacts from this fix as it concerns edge-cases that would primarily occur when a browser tab is being closed and there is no potential for the page to do anything that would have meaningful impact. (Storage can no longer be written to, etc.)

This fix eliminates an edge-case that, while we are not aware of any security exploits, seems like the type of thing where it would be better to eliminate the edge-case rather than discover later on that security experts are exceedingly clever in ways we could not foresee.

* **Fix Landed on Version**: 96
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: (from the beta request): Our initial fears of potential web-compat issues on this bug and the patch were overblown. The removed mochitest is a single example of a site doing something very sketchy and where we intentionally maintained behavior for compatibility reasons in the absence of clear semantics at a spec level. The web platform has advanced to a point where we have specs for these things and clarity about what is and is not appropriate; there is a gap in our spec text in WebIDL, but it's clear that our test was wrong and contradicts the authoritative "can run script" check that should be run.

That said, it's possible there could be breakage out there somewhere on the web, but this needs to be weighed against the reality that to maintain that behavior would be to intentionally poke holes in our invariants in a way that could lead to serious security bugs.

[Attachment #9254570](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug") -
Flags: approval-mozilla-esr91?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1740534#c36)• 3 years ago |
|  | |

Comment on [attachment 9254570](/attachment.cgi?id=9254570 "Bug 1740534 - Improve global consistency. r=smaug") [[details]](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug")

[Bug 1740534](/show_bug.cgi?id=1740534 "RESOLVED FIXED - Assertion failure: mBodyStream, at /dom/base/BodyStream.cpp:54") - Improve global consistency. r=smaug

Approved for 91.6esr. Thanks for the detailed approval request.

[Attachment #9254570](/attachment.cgi?id=9254570&action=edit "Bug 1740534 - Improve global consistency. r=smaug") -
Flags: approval-mozilla-esr91? → approval-mozilla-esr91+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1740534#c37)• 3 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr91/rev/977ec107a58a>

[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=fixed)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a7413872_578488)• 3 years ago |

Whiteboard: [bugmon:confirm][adv-main96+r] → [bugmon:confirm][adv-main96+r][adv-esr91.6+r]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1740534#c38)• 3 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9262303)
— [Details](attachment.cgi?id=9262303&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a7688243_578488)• 3 years ago |

Alias: CVE-2022-22763

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1740534#c39)• 3 years ago |
|  | |

:asuth, since this bug contains a bisection range, could you fill (if possible) the regressed\_by field?

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#fuzzing_bisection_without_regressed_by.py).

Flags: needinfo?(bugmail)

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1740534#c40)• 3 years ago |
|  | |

There's no range, just a bot issue. <https://github.com/mozilla/relman-auto-nag/pull/1476>

Flags: needinfo?(bugmail)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1740534#a25022744_1689)• 2 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1740534&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.mozilla.org_0e94bf8d_20250115_085410.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-05

## Security Vulnerabilities fixed in Firefox ESR 91.6

Announced
February 8, 2022
Impact
high
Products
Firefox ESR
Fixed in

* Firefox ESR 91.6

#### [#CVE-2022-22753: Privilege Escalation to SYSTEM on Windows via Maintenance Service](#CVE-2022-22753)

Reporter
Seb Patane
Impact
high
##### Description

A Time-of-Check Time-of-Use bug existed in the Maintenance (Updater) Service that could be abused to grant Users write access to an arbitrary directory. This could have been used to escalate to SYSTEM access.
*This bug only affects Firefox on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1732435](https://bugzilla.mozilla.org/show_bug.cgi?id=1732435)

#### [#CVE-2022-22754: Extensions could have bypassed permission confirmation during update](#CVE-2022-22754)

Reporter
Rob Wu
Impact
high
##### Description

If a user installed an extension of a particular type, the extension could have auto-updated itself and while doing so, bypass the prompt which grants the new version the new requested permissions.

##### References

* [Bug 1750565](https://bugzilla.mozilla.org/show_bug.cgi?id=1750565)

#### [#CVE-2022-22756: Drag and dropping an image could have resulted in the dropped object being an executable](#CVE-2022-22756)

Reporter
Abdulrahman Alqabandi
Impact
moderate
##### Description

If a user was convinced to drag and drop an image to their desktop or other folder, the resulting object could have been changed into an executable script which would have run arbitrary code after the user clicked on it.

##### References

* [Bug 1317873](https://bugzilla.mozilla.org/show_bug.cgi?id=1317873)

#### [#CVE-2022-22759: Sandboxed iframes could have executed script if the parent appended elements](#CVE-2022-22759)

Reporter
Johan Carlsson
Impact
moderate
##### Description

If a document created a sandboxed iframe without `allow-scripts`, and subsequently appended an element to the iframe's document that e.g. had a JavaScript event handler - the event handler would have run despite the iframe's sandbox.

##### References

* [Bug 1739957](https://bugzilla.mozilla.org/show_bug.cgi?id=1739957)

#### [#CVE-2022-22760: Cross-Origin responses could be distinguished between script and non-script content-types](#CVE-2022-22760)

Reporter
Luan Herrera
Impact
moderate
##### Description

When importing resources using Web Workers, error messages would distinguish the difference between `application/javascript` responses and non-script responses. This could have been abused to learn information cross-origin.

##### References

* [Bug 1740985](https://bugzilla.mozilla.org/show_bug.cgi?id=1740985)
* [Bug 1748503](https://bugzilla.mozilla.org/show_bug.cgi?id=1748503)

#### [#CVE-2022-22761: frame-ancestors Content Security Policy directive was not enforced for framed extension pages](#CVE-2022-22761)

Reporter
Mart Gil Robles (Mart at FlowCrypt)
Impact
moderate
##### Description

Web-accessible extension pages (pages with a moz-extension:// scheme) were not correctly enforcing the frame-ancestors directive when it was used in the Web Extension's Content Security Policy.

##### References

* [Bug 1745566](https://bugzilla.mozilla.org/show_bug.cgi?id=1745566)

#### [#CVE-2022-22763: Script Execution during invalid object state](#CVE-2022-22763)

Reporter
Mozilla Fuzzing Team
Impact
moderate
##### Description

When a worker is shutdown, it was possible to cause script to run late in the lifecycle, at a point after where it should not be possible.

##### References

* [Bug 1740534](https://bugzilla.mozilla.org/show_bug.cgi?id=1740534)

#### [#CVE-2022-22764: Memory safety bugs fixed in Firefox 97 and Firefox ESR 91.6](#CVE-2022-22764)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers and community members Paul Adenot and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 96 and Firefox ESR 91.5. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 97 and Firefox ESR 91.6](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1742682%2C1744165%2C1746545%2C1748210%2C1748279)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)


