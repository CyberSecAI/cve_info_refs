=== Content from redmine.lighttpd.net_aeb8b622_20250114_225606.html ===


Search

### Project

### General

### Profile

* [Sign in](/login)
* [Register](/account/register)

* [Home](/)
* [Projects](/projects)
* [Donate](/paypal_donation)
* [Help](https://www.redmine.org/guide)

[Search](/projects/lighttpd/search?scope=subprojects):

 Lighttpd[All Projects](/projects?jump=issues)
# Lighttpd

* [Overview](/projects/lighttpd)
* [Activity](/projects/lighttpd/activity)
* [Roadmap](/projects/lighttpd/roadmap)
* [Issues](/projects/lighttpd/issues)
* [News](/projects/lighttpd/news)
* [Wiki](/projects/lighttpd/wiki)
* [Forums](/projects/lighttpd/boards)
* [Repository](/projects/lighttpd/repository)
* [Blog](https://www.lighttpd.net)
* [Developer Blog](https://blog.lighttpd.net)

### Custom queries

* [lighttpd 1.4 open issues](/projects/lighttpd/issues?query_id=15)
* [Open issues without target version](/projects/lighttpd/issues?query_id=16)

Actions
Copy link
## Bug #3134

closed

### mod\_extforward plugin has out-of-bounds (OOB) write of 4-byte -1

Added by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 05:12") ago.
Updated [about 3 years](/projects/lighttpd/activity?from=2022-01-09 "2022-01-09 06:08") ago.

Status:FixedPriority:NormalCategory:mod\_extforwardTarget version:[1.4.64](/versions/66 "2022-01-19")
ASK QUESTIONS IN Forums:No

---

**Description**

## 1. OOB write reproduce(lighttpd-1.4.46-1.4.63)[Â¶](#1-OOB-write-reproducelighttpd-1446-1463)

> The OOB write covers lighttpd-1.4.46-1.4.63

### 1.1 lighttpd configuration[Â¶](#11-lighttpd-configuration)

```
server.document-root = "/var/www/html/"
server.port = 8080

server.modules += ("mod_extforward")
extforward.headers = ("Forwarded")
extforward.forwarder = ("all" => "trust")

mimetype.assign = (
  ".html" => "text/html",
  ".txt" => "text/plain",
  ".jpg" => "image/jpeg",
  ".png" => "image/png"
)

```
### 1.2 compilation[Â¶](#12-compilation)

```
wget https://download.lighttpd.net/lighttpd/releases-1.4.x/lighttpd-1.4.63.tar.gz
./configure CFLAGS="-m32"
make
make install

```
### 1.3 remote denial of service[Â¶](#13-remote-denial-of-service)

![](/attachments/download/2156/1.png)

## 2. analysis of the causes of vulnerabilities[Â¶](#2-analysis-of-the-causes-of-vulnerabilities)

The mod\_extforward\_Forwarded() function of the mod\_extforward plugin has a four-byte stack overflow

```
static handler_t mod_extforward_Forwarded (server *srv, connection *con, plugin_data *p, buffer *forwarded) {

    int offsets[256];/*(~50 params is more than reasonably expected to handle)*/
    ...
    while (i < used) {
        ...
        // When "j = 255", "offsets[++j] = -1" means "offsets[256] = -1", causing a stack overflow

        if (s[i] == ',') {
            if (j >= (int)(sizeof(offsets)/sizeof(int))) break;
            offsets[++j] = -1; /*("offset" separating params from next proxy)*/
            ++i;
            continue;
        }

```
## 3. patch[Â¶](#3-patch)

```
diff --git a/mod_extforward.c b/mod_extforward-patch.c
index ba957e0..f0a38d4 100644
--- a/mod_extforward.c
+++ b/mod_extforward-patch.c
@@ -715,7 +715,7 @@ static handler_t mod_extforward_Forwarded (request_st * const r, plugin_data * c
         while (s[i] == ' ' || s[i] == '\t') ++i;
         if (s[i] == ';') { ++i; continue; }
         if (s[i] == ',') {
-            if (j >= (int)(sizeof(offsets)/sizeof(int))) break;
+            if (j >= (int)((sizeof(offsets)/sizeof(int)) - 1)) break;
             offsets[++j] = -1; /*("offset" separating params from next proxy)*/
             ++i;
             continue;

```

---

**Files**

[Download all files](/attachments/issues/3134/download "Download all files")

| [1.png](/attachments/2156) (227 KB) [1.png](/attachments/download/2156/1.png "Download") |  | povcfe-bug, 2022-01-05 05:01 |  |
| --- | --- | --- | --- |
| [lighttpd.conf](/attachments/2157) (314 Bytes) [lighttpd.conf](/attachments/download/2157/lighttpd.conf "Download") |  | povcfe-bug, 2022-01-05 05:09 |  |
| [header.png](/attachments/2160) (105 KB) [header.png](/attachments/download/2160/header.png "Download") |  | povcfe-bug, 2022-01-05 09:00 |  |
| [0001-mod\_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch](/attachments/2161) (937 Bytes) [0001-mod\_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch](/attachments/download/2161/0001-mod_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch "Download") |  | povcfe-bug, 2022-01-05 11:14 |  |

[![](/attachments/thumbnail/2156/200 "1.png")](/attachments/2156)
[![](/attachments/thumbnail/2160/200 "header.png")](/attachments/2160)

* [History](/issues/3134?tab=history)
* [Notes](/issues/3134?tab=notes)
* [Property changes](/issues/3134?tab=properties)
* [Associated revisions](/issues/3134?tab=changesets)

ActionsCopy link
[#1](#note-1)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 05:40") ago

I uploaded the exp by mistake, please delete it in time

ActionsCopy link
[#2](#note-2)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 06:04") ago

* **File** deleted (~~*exp.py*~~)

ActionsCopy link
[#3](#note-3)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:14") ago

* **Subject** changed from *Security - lighttpd mod\_extforward plugin has stack overflow vulnerability* to *lighttpd mod\_extforward plugin has out-of-bounds (OOB) write of 4-byte -1*
* **Description** updated ([diff](/journals/13005/diff?detail_id=10783 "View differences"))
* **Status** changed from *New* to *Patch Pending*
* **Target version** changed from *1.4.xx* to *1.4.64*

You are correct that there is an out-of-bounds write on the stack.
However, this out-of-bounds write is not controlled by the attacker.
The value that is written out-of-bounds after the end of offsets[] is -1

However, with the default lighttpd build with `gcc -O2`, I was unable to
trigger a crash in lighttpd on amd64 (64-bit) or on i686 (32-bit).

As with your prior posts, I think your test toolchain is configured
with a stack canary which crashes when an out-of-bounds read or write
is detected, which is fine for your research, but not necessarily a
reflection of real-world impact. When mod\_extforward.c is compiled with
`-fstack-protector-all -fstack-protector-strong`, I was able to trigger
a crash in lighttpd on i686 (32-bit), but not amd64 (64-bit), using the
reproducer (exp.py) you had provided.

Also, the scenario in which this occurs is not enabled by default in lighttpd.

* First, the user must be using mod\_extforward. (not default)
* Second, the user must explicitly configure `extforward.headers`
   to contain "Forwarded" (not default)
* Third, the user must have configured mod\_extforward to trust the
   upstream proxy server which proxied the request to lighttpd,
   and from which lighttpd is receiving the "Forwarded" header.
   This upstream proxy must allow and use this unusual "Forwarded"
   header.

Your statement that this issue affects lighttpd 1.4.41-1.4.63 is incorrect.
Support for the "Forwarded" header was added in lighttpd 1.4.46.
<https://redmine.lighttpd.net/issues/2703>
I have updated your original post.

Given this initial assessment (not yet complete), I have changed the
the wording of this issue to tone it down from vulnerability to OOB write.
There is a bug that will be fixed, but unless further information comes to
light, this does not appear to have security implications for default usage
of lighttpd. Please help me determine in which scenarios and platforms
this might have an impact.

ActionsCopy link
[#4](#note-4)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:18") ago

* **Subject** changed from *lighttpd mod\_extforward plugin has out-of-bounds (OOB) write of 4-byte -1* to *mod\_extforward plugin has out-of-bounds (OOB) write of 4-byte -1*

ActionsCopy link
[#5](#note-5)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:19") ago

gstrauss wrote in <#note-3>:

> You are correct that there is an out-of-bounds write on the stack.
> However, this out-of-bounds write is not controlled by the attacker.
> The value that is written out-of-bounds after the end of offsets[] is -1
>
> However, with the default lighttpd build with `gcc -O2`, I was unable to
> trigger a crash in lighttpd on amd64 (64-bit) or on i686 (32-bit).
>
> As with your prior posts, I think your test toolchain is configured
> with a stack canary which crashes when an out-of-bounds read or write
> is detected, which is fine for your research, but not necessarily a
> reflection of real-world impact. When mod\_extforward.c is compiled with
> `-fstack-protector-all -fstack-protector-strong`, I was able to trigger
> a crash in lighttpd on i686 (32-bit), but not amd64 (64-bit), using the
> reproducer (exp.py) you had provided.
>
> Also, the scenario in which this occurs is not enabled by default in lighttpd.
>
> * First, the user must be using mod\_extforward. (not default)
> * Second, the user must explicitly configure `extforward.headers`
>   to contain "Forwarded" (not default)
> * Third, the user must have configured mod\_extforward to trust the
>   upstream proxy server which proxied the request to lighttpd,
>   and from which lighttpd is receiving the "Forwarded" header.
>   This upstream proxy must allow and use this unusual "Forwarded"
>   header.
>
> Your statement that this issue affects lighttpd 1.4.41-1.4.63 is incorrect.
> Support for the "Forwarded" header was added in lighttpd 1.4.46.
> <https://redmine.lighttpd.net/issues/2703>
> I have updated your original post.
>
> Given this initial assessment (not yet complete), I have changed the
> the wording of this issue to tone it down from vulnerability to OOB write.
> There is a bug that will be fixed, but unless further information comes to
> light, this does not appear to have security implications for default usage
> of lighttpd. Please help me determine in which scenarios and platforms
> this might have an impact.

I'm using the ubuntu 20.04 default configuration, where canary is turned on by default

ActionsCopy link
[#6](#note-6)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:25") ago

povcfe-bug wrote in <#note-5>:

> gstrauss wrote in <#note-3>:
>
> > You are correct that there is an out-of-bounds write on the stack.
> > However, this out-of-bounds write is not controlled by the attacker.
> > The value that is written out-of-bounds after the end of offsets[] is -1
> >
> > However, with the default lighttpd build with `gcc -O2`, I was unable to
> > trigger a crash in lighttpd on amd64 (64-bit) or on i686 (32-bit).
> >
> > As with your prior posts, I think your test toolchain is configured
> > with a stack canary which crashes when an out-of-bounds read or write
> > is detected, which is fine for your research, but not necessarily a
> > reflection of real-world impact. When mod\_extforward.c is compiled with
> > `-fstack-protector-all -fstack-protector-strong`, I was able to trigger
> > a crash in lighttpd on i686 (32-bit), but not amd64 (64-bit), using the
> > reproducer (exp.py) you had provided.
> >
> > Also, the scenario in which this occurs is not enabled by default in lighttpd.
> >
> > * First, the user must be using mod\_extforward. (not default)
> > * Second, the user must explicitly configure `extforward.headers`
> >   to contain "Forwarded" (not default)
> > * Third, the user must have configured mod\_extforward to trust the
> >   upstream proxy server which proxied the request to lighttpd,
> >   and from which lighttpd is receiving the "Forwarded" header.
> >   This upstream proxy must allow and use this unusual "Forwarded"
> >   header.
> >
> > Your statement that this issue affects lighttpd 1.4.41-1.4.63 is incorrect.
> > Support for the "Forwarded" header was added in lighttpd 1.4.46.
> > <https://redmine.lighttpd.net/issues/2703>
> > I have updated your original post.
> >
> > Given this initial assessment (not yet complete), I have changed the
> > the wording of this issue to tone it down from vulnerability to OOB write.
> > There is a bug that will be fixed, but unless further information comes to
> > light, this does not appear to have security implications for default usage
> > of lighttpd. Please help me determine in which scenarios and platforms
> > this might have an impact.
>
> I'm using the ubuntu 20.04 default configuration, where canary is turned on by default

The reason why 64-bit programs can't crash is that sse 16-bit alignment, when closing intel sse, 64-bit programs will also crash, so please make sure that mips, arm and other architecture programs will not trigger a crash.

ActionsCopy link
[#7](#note-7)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:29") ago

So compiling 32-bit lighttpd within an operating system with a higher gcc version, or compiling and using lighttpd with an architecture that does not support sse 16-bit byte alignment, will result in a denial of service

ActionsCopy link
[#8](#note-8)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:50") ago

> So compiling 32-bit lighttpd within an operating system with a higher gcc version, or compiling and using lighttpd with an architecture that does not support sse 16-bit byte alignment, will result in a denial of service

You seem to be overlooking the prerequisites to reaching the bug. Case in point, I wrote:

> > * Third, the user must have configured mod\_extforward to trust the
> >   upstream proxy server which proxied the request to lighttpd,
> >   and from which lighttpd is receiving the "Forwarded" header.
> >   This upstream proxy must allow and use this unusual "Forwarded"
> >   header.

For someone to want to configure lighttpd this way, they must be using a proxy which supports "Forwarded". Do you know of real-world use in popular CDNs? Most CDNs and cloud providers have their own custom fields for X-Forwarded-For.

I took a quick look and Cloudflare does not currently support Forwarded.
<https://community.cloudflare.com/t/support-for-http-forwarded-header-as-a-replacement-for-x-forwarded-for/320943>
Nor does HAProxy (where the HAProxy "PROXY" protocol is often preferred)
<https://github.com/haproxy/haproxy/issues/575>

I did find that "Forwarded" is implemented in
<https://microsoft.github.io/reverse-proxy/articles/transforms.html#forwarded>
though a developer noted it is not enabled by default
(<https://github.com/dotnet/aspnetcore/issues/5978#issuecomment-668013246>)
and "Forwarded" is implemented in
<https://github.com/gorilla/handlers/blob/master/proxy_headers.go>

Please keep in mind that my questions here and above are to help gauge potential impact of the bug.

Thus far, based on what I have posted here and above, I am confident that the bug is not reachable in **common** use scenarios of lighttpd mod\_extforward.

ActionsCopy link
[#9](#note-9)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 08:57") ago

gstrauss wrote in <#note-8>:

> > So compiling 32-bit lighttpd within an operating system with a higher gcc version, or compiling and using lighttpd with an architecture that does not support sse 16-bit byte alignment, will result in a denial of service
>
> You seem to be overlooking the prerequisites to reaching the bug. Case in point, I wrote:
>
> > > * Third, the user must have configured mod\_extforward to trust the
> > >   upstream proxy server which proxied the request to lighttpd,
> > >   and from which lighttpd is receiving the "Forwarded" header.
> > >   This upstream proxy must allow and use this unusual "Forwarded"
> > >   header.
>
> For someone to want to configure lighttpd this way, they must be using a proxy which supports "Forwarded". Do you know of real-world use in popular CDNs? Most CDNs and cloud providers have their own custom fields for X-Forwarded-For.
>
> I took a quick look and Cloudflare does not currently support Forwarded.
> <https://community.cloudflare.com/t/support-for-http-forwarded-header-as-a-replacement-for-x-forwarded-for/320943>
> Nor does HAProxy (where the HAProxy "PROXY" protocol is often preferred)
> <https://github.com/haproxy/haproxy/issues/575>
>
> I did find that "Forwarded" is implemented in
> <https://microsoft.github.io/reverse-proxy/articles/transforms.html#forwarded>
> though a developer noted it is not enabled by default
> (<https://github.com/dotnet/aspnetcore/issues/5978#issuecomment-668013246>)
> and "Forwarded" is implemented in
> <https://github.com/gorilla/handlers/blob/master/proxy_headers.go>
>
> Please keep in mind that my questions here and above are to help gauge potential impact of the bug.
>
> Thus far, based on what I have posted here and above, I am confident that the bug is not reachable in **common** use scenarios of lighttpd mod\_extforward.

I noticed that "https://redmine.lighttpd.net/projects/lighttpd/wiki/Docs\_ModExtForward" mentions a custom setting for "Forwarded", which is not really the default configuration, but I mean that for users with such a configuration, remote denial of service is possible.

ActionsCopy link
[#10](#note-10)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:00") ago

* **File** [header.png](/attachments/2160) [header.png](/attachments/download/2160/header.png "Download") added

[![](/attachments/thumbnail/2160/200 "header.png")](/attachments/2160)

![](/attachments/download/2160/header.png)

ActionsCopy link
[#11](#note-11)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:13") ago

This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.

My posts have repeatedly stated that I am trying to gauge the potential impact, and thus far the potential impact in the real world appears to be very low.

ActionsCopy link
[#12](#note-12)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:16") ago

gstrauss wrote in <#note-11>:

> This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.
>
> My posts have repeatedly stated that I am trying to gauge the potential impact, and thus far the potential impact in the real world appears to be very low.

I agree with you in the comment above that he will not be triggered by default

ActionsCopy link
[#13](#note-13)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:19") ago

gstrauss wrote in <#note-11>:

> This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.
>
> My posts have repeatedly stated that I am trying to gauge the potential impact, and thus far the potential impact in the real world appears to be very low.

I hope you will listen to me carefully, you said he will not be triggered by default, I agree. Also you said that canary must be turned on to trigger a crash, I told you that canary is turned on by default in higher versions of gcc, and that crashes are possible for system architectures that do not have SSE turned on.

ActionsCopy link
[#14](#note-14)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:21") ago

povcfe-bug wrote in <#note-12>:

> gstrauss wrote in <#note-11>:
>
> > This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.
> >
> > My posts have repeatedly stated that I am trying to gauge the potential impact, and thus far the potential impact in the real world appears to be very low.
>
> I agree with you in the comment above that he will not be triggered by default

Please respect contributors who find problems and submit patches

ActionsCopy link
[#15](#note-15)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:35") ago

> Please respect contributors who find problems and submit patches

I appreciate that you have taken the time to find this and to post it so that it can be fixed. Thank you.

Above, I wrote:

> > This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.
> >
> > My posts have repeatedly stated that I am trying to gauge the potential impact, and thus far the potential impact in the real world appears to be very low.

Please help me to understand why you feel disrespected by these grounded statements. Impact analysis is an important part of bug and security triage.

ActionsCopy link
[#16](#note-16)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 09:45") ago

gstrauss wrote in <#note-15>:

> > Please respect contributors who find problems and submit patches
>
> I appreciate that you have taken the time to find this and to post it so that it can be fixed. Thank you.
>
> Above, I wrote:
>
> > > This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.
> > >
> > > My posts have repeatedly stated that I am trying to gauge the potential impact, and thus far the potential impact in the real world appears to be very low.
>
> Please help me to understand why you feel disrespected by these grounded statements. Impact analysis is an important part of bug and security triage.

I don't think you've just listened carefully to my analysis, and there are differences between our two concerns. Impact exclusion is indeed a very important aspect, and I agree with your analysis above

ActionsCopy link
[#17](#note-17)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 10:07") ago

> > This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.

> I don't think you've just listened carefully to my analysis, and there are differences between our two concerns.

Would you please describe your concerns in more detail?

Your post is less than 5 hours old and I have spent a considerable amount of time reviewing, reproducing, and analyzing the potential impact, and have tried to be explicit in my posts that these are the steps I am taking. If you feel that I am giving it short thrift, then please describe your expectations in more detail.

ActionsCopy link
[#18](#note-18)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 10:13") ago

gstrauss wrote in <#note-17>:

> > > This is a bug and the bug has been acknowledged. I am not sure what your posts are trying to say beyond that.
>
> > I don't think you've just listened carefully to my analysis, and there are differences between our two concerns.
>
> Would you please describe your concerns in more detail?
>
> Your post is less than 5 hours old and I have spent a considerable amount of time reviewing, reproducing, and analyzing the potential impact, and have tried to be explicit in my posts that these are the steps I am taking. If you feel that I am giving it short thrift, then please describe your expectations in more detail.

Sorry, my narrative above was just to show you that users using this non-default configuration can trigger crashes with the default compile option. I appreciate your work, and your attention to this issue, and I apologize.

ActionsCopy link
[#19](#note-19)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 10:47") ago

Yes, for systems and distros which enable the canary by default, and if the prerequisites to reach the bug are met, then the bug will trigger a crash.

Please attach a patch (e.g. output from `git format-patch`) with the patch in your original post and how you'd like to be credited. The patch looks good, and I'll need to edit the commit message a bit, but will try to preserve what you'd like to include.

It's late here and I'll return to this tomorrow.

ActionsCopy link
[#20](#note-20)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 11:31") ago

* **File** [0001-mod\_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch](/attachments/2161) [0001-mod\_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch](/attachments/download/2161/0001-mod_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch "Download") added

patch: "0001-mod\_extforward-fix-out-of-bounds-OOB-write-of-4-byte.patch"
you can call me "povcfe" and I would like the commit message to include a personal thx to me

ActionsCopy link
[#21](#note-21)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 11:34") ago

I have applied for a cve id, please trace

ActionsCopy link
[#22](#note-22)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 11:44") ago

You did not include a commit message in the attachment. Please see the lighttpd git history for how I credit contributors and let me know if you would like any different.

> I have applied for a cve id, please trace

What do you mean by "please trace"? Is that an incomplete sentence?

I have a feeling that you are disappointed that my analysis indicates that this bug is low severity, as its prevalence in production is likely to be rare and specialized. Even when the bug is reachable, I do not believe it exploitable beyond triggering a crash. I will dispute the CVE if you represent the bug otherwise.

ActionsCopy link
[#23](#note-23)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 12:07") ago

gstrauss wrote in <#note-22>:

> You did not include a commit message in the attachment. Please see the lighttpd git history for how I credit contributors and let me know if you would like any different.
>
> > I have applied for a cve id, please trace
>
> What do you mean by "please trace"? Is that an incomplete sentence?
>
> I have a feeling that you are disappointed that my analysis indicates that this bug is low severity, as its prevalence in production is likely to be rare and specialized. Even when the bug is reachable, I do not believe it exploitable beyond triggering a crash. I will dispute the CVE if you represent the bug otherwise.

I applied for cve with a remote denial of service error type, which I think is reasonable, emm. I would like to know if you agree.

ActionsCopy link
[#24](#note-24)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-05 "2022-01-05 12:50") ago

this is the new patch
```
From 8a91fd45f7f31707a876492b13c0f46845626727 Mon Sep 17 00:00:00 2001
From: povcfe <povcfe@qq.com>
Date: Wed, 5 Jan 2022 12:44:34 +0000
Subject: [PATCH] [mod_extforward] fix out-of-bounds (OOB) write of 4-byte -1

(thx povcfe)
---
 src/mod_extforward.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/mod_extforward.c b/src/mod_extforward.c
index 733231fd..8dbdfad9 100644
--- a/src/mod_extforward.c
+++ b/src/mod_extforward.c
@@ -715,7 +715,7 @@ static handler_t mod_extforward_Forwarded (request_st * const r, plugin_data * c
         while (s[i] == ' ' || s[i] == '\t') ++i;
         if (s[i] == ';') { ++i; continue; }
         if (s[i] == ',') {
-            if (j >= (int)(sizeof(offsets)/sizeof(int))) break;
+            if (j >= (int)((sizeof(offsets)/sizeof(int)) - 1)) break;
             offsets[++j] = -1; /*("offset" separating params from next proxy)*/
             ++i;
             continue;
--
2.25.1

```

ActionsCopy link
[#25](#note-25)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-06 "2022-01-06 06:39") ago

> > I have applied for a cve id, please trace

> What do you mean by "please trace"? Is that an incomplete sentence?

What do you mean by "please trace"? Is that an incomplete sentence?

> I applied for cve with a remote denial of service error type, which I think is reasonable, emm. I would like to know if you agree.

I do not understand your slang. What is "emm"?

---

**On to the more important issue: context.**

> I applied for cve with a remote denial of service error type [...]. I would like to know if you agree.

The CVE should be specific, not vague.
The CVE should not be worded in an inflammatory or click-bait manner.

You have found a bug in lighttpd mod\_extforward when "Forwarded" is configured.
(Thank you for reporting the bug.)

lighttpd is a modular web server. The distinction between the lighttpd core
and lighttpd modules is important, as is the popularity of any given lighttpd
module.

---

DRAFT:

**There is a potential remote denial of service in lighttpd mod\_extforward under
specific, non-default and uncommon 32-bit lighttpd mod\_extforward configurations.**

Under specific, non-default and uncommon lighttpd mod\_extforward configurations,
a remote attacker can trigger a 4-byte out-of-bounds write of value '-1' to the
stack. This is not believed to be exploitable in any way beyond triggering a
crash of the lighttpd server on systems where the lighttpd server has been built
32-bit and with compiler flags which enable a stack canary --
gcc/clang -fstack-protector-strong or -fstack-protector-all, but bug not visible
with only -fstack-protector.

With standard lighttpd builds using -O2 optimization on 64-bit x86\_64,
this bug has not been observed to cause adverse behavior, even with
gcc/clang -fstack-protector-strong.

For the bug to be reachable, the user must be using a non-default lighttpd
configuration which enables mod\_extforward and configures mod\_extforward
to accept and parse the "Forwarded" header from a trusted proxy. At this
time, support for RFC7239 Forwarded is not common in CDN providers or
popular web server reverse proxies. It bears repeating that for the user
to desire to configure lighttpd mod\_extforward to accept "Forwarded", the
user must also be using a trusted proxy (in front of lighttpd) which
understands and actively modifies the "Forwarded" header sent to lighttpd.

lighttpd natively supports RFC7239 "Forwarded"
hiawatha natively supports RFC7239 "Forwarded"

nginx can be manually configured to add a "Forwarded" header
 <https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/>

A 64-bit build of lighttpd on x86\_64 (not known to be affected by this bug)
in front of another lighttpd will detect and reject a malicious "Forwarded"
request header, thereby thwarting an attempt to trigger this bug.

The following servers currently *do not* natively support RFC7239 Forwarded:
 nginx
 apache2
 caddy
 node.js
 haproxy
 squid
 varnish-cache
 litespeed

Given the general dearth of support for RFC7239 Forwarded in popular CDNs
and web server reverse proxies, and given the prerequisites in lighttpd
mod\_extforward needed to reach this bug, the number of lighttpd servers
vulnerable to this bug is estimated to be vanishingly small. Large systems
using reverse proxies are likely running 64-bit lighttpd, which is not known
to be adversely affected by this bug.

In the future, it is desirable for more servers to implement RFC7239 Forwarded.
lighttpd developers would like to thank povcfe for reporting this bug so that
it can be fixed before more CDNs and web servers implement RFC7239 Forwarded.

[Edit: above has been updated to incorporate some of the additional info below]

ActionsCopy link
[#26](#note-26)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-06 "2022-01-06 07:08") ago

"emm." is a slang word for friendly

Thank you for the detailed analysis of this bug

ActionsCopy link
[#27](#note-27)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-07 "2022-01-07 20:25") ago

My testing on 32-bit ARM and on 64-bit ARM appears to have the same behavior as i686 (32-bit) and x86\_64 (64-bit)

My builds use gcc and the default build settings in lighttpd configure.ac, which include `-O2`

When built from source, lighttpd does not crash on 32-bit or 64-bit, on ARM or i686 or x86\_64.
When built from source with `--enable-extra-warnings` (which enables `-fstack-protector` in lighttpd configure.ac), lighttpd does not crash on 32-bit or 64-bit, on ARM or i686 or x86\_64.

When built with `-fstack-protector-strong` or `-fstack-protector-all`, then I am able to trigger a crash in lighttpd built **32-bit** on ARM and i686, but 64-bit on ARM or x86\_64 builds do not crash.

As expected, the behavior appears to be the same if clang is used with these flags instead of gcc.

Conclusion: in addition to the prerequisites already noted, it appears that to trigger a crash in lighttpd, lighttpd must be built 32-bit and with `-fstack-protector-strong` or `-fstack-protector-all`. Of course, other platforms may differ. However, the majority of lighttpd usage in production is expected to be on platforms using gcc or clang compilers.

ActionsCopy link
[#28](#note-28)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-08 "2022-01-08 06:39") ago

`-fstack-protector-strong` was introduced in gcc 4.9.0.
`-fstack-protector-strong` is present in clang 5.0.0 documentation, and I found references (unverified) to clang 3.8.

As an aside, I tested OpenWRT 32-bit build of lighttpd and it did not appear to be adversely affected by this bug -- it did not crash. The lighttpd OpenWRT package appears to be built with `-fstack-protector`, possibly due to the prevalence of older compilers for some of openwrt-supported hardware platforms.

---

Note: this bug will automatically be marked fixed once the commit fixing it is pushed to lighttpd git master branch. I am still subscribed and you can still add comments here.

When assigned, please post the CVE number here.

ActionsCopy link
[#29](#note-29)
#### Updated by [povcfe-bug](/users/13732) [about 3 years](/projects/lighttpd/activity?from=2022-01-08 "2022-01-08 08:31") ago

gstrauss wrote in <#note-28>:

> `-fstack-protector-strong` was introduced in gcc 4.9.0.
> `-fstack-protector-strong` is present in clang 5.0.0 documentation, and I found references (unverified) to clang 3.8.
>
> As an aside, I tested OpenWRT 32-bit build of lighttpd and it did not appear to be adversely affected by this bug -- it did not crash. The lighttpd OpenWRT package appears to be built with `-fstack-protector`, possibly due to the prevalence of older compilers for some of openwrt-supported hardware platforms.
>
> ---
>
> Note: this bug will automatically be marked fixed once the commit fixing it is pushed to lighttpd git master branch. I am still subscribed and you can still add comments here.
>
> When assigned, please post the CVE number here.

the CVE number is CVE-2022-22707

Looking forward to the next collaboration

ActionsCopy link
[#30](#note-30)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-08 "2022-01-08 18:09") ago

I have lightly edited the draft I posted above. Please coordinate with lighttpd developers (me included) before submitting the CVE to be published.

ActionsCopy link
[#31](#note-31)
#### Updated by [about 3 years](/projects/lighttpd/activity?from=2022-01-08 "2022-01-08 18:20") ago

* **Status** changed from *Patch Pending* to *Fixed*

Applied in changeset [8c62a890e23f5853b1a562b03fe3e1bccc6e7664](/projects/lighttpd/repository/14/revisions/8c62a890e23f5853b1a562b03fe3e1bccc6e7664 "[mod_extforward] fix out-of-bounds (OOB) write (fixes #3134) (thx povcfe) (edited: gstrauss) T...").

ActionsCopy link
[#32](#note-32)
#### Updated by [gstrauss](/users/10519) [about 3 years](/projects/lighttpd/activity?from=2022-01-09 "2022-01-09 06:08") ago

> Looking forward to the next collaboration

@povcfe

* You did not "collaborate" with lighttpd developers; you merely reported a bug.
   I question your understanding of the meaning of the word "collaborate".
* You did not participate in any research to assess the potential impact.
* **You did not coordinate the CVE release with lighttpd developers.**
   Instead, the CVE was published barely 25 hours after reporting the bug here.
   That is an astounding lack of professionalism, especially considering that
   within a few hours of your report I had responded acknowledging the bug and
   provided an initial assessment. (Also, since you had assumed that this bug
   was a security issue, the bug should have been reported to the security email
   address at lighttpd.net, instead of publicly here.)
* The CVE was published before the proposed fix was committed to the official
   lighttpd git repo.
* The CVE does not clearly state that the impact is limited to 32-bit lighttpd
   and to specific lighttpd mod\_extforward configurations expected to be rare.
   The CVE contains very little information, even though it was published
   (unbeknownst to me at the time) more than 4 hours after my DRAFT post above.

Actions
Copy link

Also available in: [Atom](/issues/3134.atom)

Powered by [Redmine](https://www.redmine.org/) Â© 2006-2024 Jean-Philippe Lang

Loading...



=== Content from www.debian.org_38264f60_20250114_225607.html ===


---

[[Date Prev](msg00005.html)][[Date Next](msg00007.html)]
[[Thread Prev](msg00005.html)][[Thread Next](msg00007.html)]
[[Date Index](maillist.html#00006)]
[[Thread Index](threads.html#00006)]

# [SECURITY] [DSA 5040-1] lighttpd security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 5040-1] lighttpd security update
* *From*: Moritz Muehlenhoff <jmm@debian.org>
* *Date*: Tue, 11 Jan 2022 19:42:26 +0000
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/20220111194226.GA28621%40seger.debian.org)Â [20220111194226.GA28621@seger.debian.org](msg00006.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-5040-1                   security@debian.org
<https://www.debian.org/security/>                       Moritz Muehlenhoff
January 11, 2022                      <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : lighttpd
CVE ID         : CVE-2022-22707

An out-of-bounds memory access was discovered in the mod_extforward plugin of
the lighttpd web server, which may result in denial of service.

For the oldstable distribution (buster), this problem has been fixed
in version 1.4.53-4+deb10u2.

For the stable distribution (bullseye), this problem has been fixed in
version 1.4.59-1+deb11u1.

We recommend that you upgrade your lighttpd packages.

For the detailed security status of lighttpd please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/lighttpd>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEtuYvPRKsOElcDakFEMKTtsN8TjYFAmHd3UUACgkQEMKTtsN8
TjZdSQ/+Jiod4ncNyWTJKFmdLtiZiUl0Ut2e/lh0T2gq5o4SE8jsLF56rTIR3PX7
yFubLM31G0z51+bvBGaciLygJICRadN1pJPxdlD8SfuNV6Osj4G9SQOM7A4euth8
MjBXou1HdamFZRW8mJHBld4mdXgyrZHdxcuksW+5Q1ZJ7pLrB9lqsG0OEVTcMrIA
iH/pdpstprpLe61Sa6v5HyyKRDNH1n5m0H5JJ/GrF/aVomy8sQoUBcHg+6f9cr67
QXpT//7XP1hcq3XOWXFnvZvvx6LjR3wKdctBtKFI7B/Gfo4+NjFJ+lNwr+PCbLfY
cvVE5PDNULMZ3q3DpwkOLv3WL9J84bfXQwJrbdD33+PoJmb6ePIdB1VTjsILKQGP
XC1I9K/QPXDgfAHuT5qPIHHqfj4ebDbfzNr0iZWtPW+ow8AAajbEMgoHTVmnMpPc
JekVtUacVvBCTJR2o/5LpOPYhlmn9sCNf43HT8CEe8IUjxuhdXHiLhKN3HgiW0Y3
KCdXdCqMcyUp2V10ZpcxNqNVrEtTThpwKpEhO9pBsjlCEh+ewS8DxXvgpyS0qeGE
Zl6y9G6+oYFgVMWaBZWcq3vpdtTBFZSTka74RSZCuEprQLwzwqeuyM9ypeOgaW7I
wfwl5Tp5CZ5MtuvKBJqkMCIx8xo+1SABpkLkutNxOXsNf/9ffZ0=
=Fuu5
-----END PGP SIGNATURE-----

```

---


