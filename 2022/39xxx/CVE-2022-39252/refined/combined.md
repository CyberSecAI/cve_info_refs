=== Content from github.com_ca19f4c4_20250115_081746.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Freleases%2Ftag%2Fmatrix-sdk-0.6.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Freleases%2Ftag%2Fmatrix-sdk-0.6.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=matrix-org%2Fmatrix-rust-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-rust-sdk](/matrix-org/matrix-rust-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk) You must be signed in to change notification settings
* [Fork
  267](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)
* [Star
   1.3k](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)

* [Code](/matrix-org/matrix-rust-sdk/tree/matrix-sdk-0.6.0)
* [Issues
  211](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests
  10](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects
  0](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-rust-sdk/tree/matrix-sdk-0.6.0)
* [Issues](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

1. [Releases](/matrix-org/matrix-rust-sdk/releases)
2. [matrix-sdk-0.6.0](/matrix-org/matrix-rust-sdk/releases/tag/matrix-sdk-0.6.0)

# 2022-09-28 - Matrix SDK 0.6.0

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/matrix-org/matrix-rust-sdk/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...matrix-sdk-0.6.0)

 Loading

[View all tags](/matrix-org/matrix-rust-sdk/tags)

![@gnunicorn](https://avatars.githubusercontent.com/u/40496?s=40&v=4)
[gnunicorn](/gnunicorn)
released this
28 Sep 15:45

·
[6547 commits](/matrix-org/matrix-rust-sdk/compare/matrix-sdk-0.6.0...main)
to main
since this release

[matrix-sdk-0.6.0](/matrix-org/matrix-rust-sdk/tree/matrix-sdk-0.6.0)

[`fefd2a6`](/matrix-org/matrix-rust-sdk/commit/fefd2a6b6851e4e3479a267a92241079b53931a0)

We are proud to announce the release of the next major milestone of matrix development in rust: `matrix-sdk 0.6.0` (and `matrix-sdk-base`, `matrix-sdk-crypto`, `matrix-sdk-common`, `matrix-sdk-test` `@0.6.0`, `matrix-sdk-test-macros@0.3.0`, `matrix-sdk-qrcode@0.4.0` , `matrix-sdk-store-encryption@0.2.0`, `matrix-sdk-indexeddb@0.2.0` and `matrix-sdk-sled@0.2.0` respectively), available on crates.io for your convenience.

There are a few major API changes since the 0.5.0 release, listed below. You can find the full list and another troubleshooting section helping you fix common errors you will see when upgrading from 0.5.x to this release in the `UPGRADING-0.5-to-0.6.md` in the root of the tarball.

# Upgrades 0.5 ➜ 0.6

This is a rough migration guide to help you upgrade your code using matrix-sdk 0.5 to the newly released matrix-sdk 0.6 . While it won't cover all edge cases and problems, we are trying to get the most common issues covered. If you experience any other difficulties in upgrade or need support with using the matrix-sdk in general, please approach us in our [matrix-sdk channel on matrix.org](https://matrix.to/#/#matrix-rust-sdk:matrix.org).

## Minimum Supported Rust Version Update: `1.60`

We have updated the minimal rust version you need in order to build `matrix-sdk`, as we require some new dependency resolving features from it:

> These crates are built with the Rust language version 2021 and require a minimum compiler version of 1.60

## Dependencies

Many dependencies have been upgraded. Most notably, we are using `ruma` at version `0.7.0` now. It has seen some renamings and restructurings since our last release, so you might find that some Types have new names now.

## Repo Structure Updates

If you are looking at the repository itself, you will find we've rearranged the code quite a bit: we have split out any bindings-specific and testing related crates (and other things) into respective folders, and we've moved all `examples` into its own top-level-folder with each example as their own crate (rendering them easier to find and copy as starting points), all in all slimming down the `crates` folder to the core aspects.

## Architecture Changes / API overall

### Builder Pattern

We are moving to the [builder pattern](https://doc.rust-lang.org/1.0.0/style/ownership/builders.html) (familiar from e.g. `std::io:process:Command`) as the main configurable path for many aspects of the API, including to construct Matrix-Requests and workflows. This has been and is an on-going effort, and this release sees a lot of APIs transitioning to this pattern, you should already be familiar with from the `matrix_sdk::Client::builder()` in `0.5`. This pattern been extended onto:

* the [login configuration](https://docs.rs/matrix-sdk/latest/matrix_sdk/struct.LoginBuilder.html) and [login with sso](https://docs.rs/matrix-sdk/latest/matrix_sdk/struct.SsoLoginBuilder.html),
* [`SledStore` configuratiion](https://docs.rs/matrix-sdk-sled/latest/matrix_sdk_sled/struct.SledStateStoreBuilder.html)
* [`Indexeddb` configuration](https://docs.rs/matrix-sdk-indexeddb/latest/matrix_sdk_indexeddb/struct.IndexeddbStateStoreBuilder.html)

Most have fallback (though maybe with deprecation warning) support for an existing code path, but these are likely to be removed in upcoming releases.

### Splitting of concerns: Media

In an effort to declutter the `Client` API dedicated types have been created dealing with specific concerns in one place. In `0.5` we introduced `client.account()`, and `client.encryption()`, we are doing the same with `client.media()` to manage media and attachments in one place with the [`media::Media` type][media typ] now.

The signatures of media uploads, have also changed slightly: rather than expecting a reader `R: Read + Seek`, it now is a simple `&[u8]`. Which also means no more unnecessary `seek(0)` to reset the cursor, as we are just taking an immutable reference now.

### Event Handling & sync updaes

If you are using the `client.register_event_handler` function to receive updates on incoming sync events, you'll find yourself with a deprecation warning now. That is because we've refactored and redesigned the event handler logic to allowing `removing` of event handlers on the fly, too. For that the new `add_event_handler()` (and `add_room_event_handler`) will hand you an `EventHandlerHandle` (pardon the pun), which you can pass to `remove_event_handler`, or by using the convenient `client.event_handler_drop_guard` to create a `DropGuard` that will remove the handler when the guard is dropped. While the code still works, we recommend you switch to the new one, as we will be removing the `register_event_handler` and `register_event_handler_context` in a coming release.

Secondly, you will find a new [`sync_with_result_callback` sync function](https://docs.rs/matrix-sdk/latest/matrix_sdk/struct.Client.html#method.sync_with_result_callback). Other than the previous sync functions, this will pass the entire `Result` to your callback, allowing you to handle errors or even raise some yourself to stop the loop. Further more, it will propagate any unhandled errors (it still handles retries as before) to the outer caller, allowing the higher level to decide how to handle that (e.g. in case of a network failure). This result-returning-behavior also punshes through the existing `sync` and `sync_with_callback`-API, allowing you to handle them on a higher level now (rather than the futures just resolving). If you find that warning, just adding a `?` to the `.await` of the call is probably the quickest way to move forward.

### Refresh Tokens

This release now [supports `refresh_token`s](https://github.com/matrix-org/matrix-rust-sdk/pull/892) as part of the [`Session`](https://docs.rs/matrix-sdk/latest/matrix_sdk/struct.Session.html). It is implemented with a default-flag in serde so deserializing a previously serialized Session (e.g. in a store) will work as before. As part of `refresh_token` support, you can now configure the client via `ClientBuilder.request_refresh_token()` to refresh the access token automagically on certain failures or do it manually by calling `client.refresh_access_token()` yourself. Auto-refresh is *off* by default.

You can stay informed about updates on the access token by listening to `client.session_tokens_signal()`.

### Further changes

* [`MessageOptions`](https://docs.rs/matrix-sdk/latest/matrix_sdk/room/struct.MessagesOptions.html) has been updated to Matrix 1.3 by making the `from` parameter optional (and function signatures have been updated, too). You can now request the server sends you messages from the first one you are allowed to have received.
* `client.user_id()` is not a `future` anymore. Remove any `.await` you had behind it.
* `verified()`, `blacklisted()` and `deleted()` on `matrix_sdk::encryption::identities::Device` have been renamed with a `is_` prefix.
* `verified()` on `matrix_sdk::encryption::identities::UserIdentity`, too has been prefixed with `is_` and thus is onw called `is_verified()`.
* The top-level crypto and state-store types of Indexeddb and Sled have been renamed to unique types>
* `state_store` and `crypto_store` do not need to be boxed anymore when passed to the [`StoreConfig`](https://docs.rs/matrix-sdk-base/latest/matrix_sdk_base/store/struct.StoreConfig.html)
* Indexeddb's `SerializationError` is now `IndexedDBStoreError`
* Javascript specific features are now behind the `js` feature-gate
* The new experimental next generation of sync ("sliding sync"), with a totally revamped api, can be found behind the optional `sliding-sync`-feature-gate

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_730830c5_20250115_081745.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fcommit%2F41449d2cc360e347f5d4e1c154ec1e3185f11acd)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fcommit%2F41449d2cc360e347f5d4e1c154ec1e3185f11acd)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fmatrix-rust-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-rust-sdk](/matrix-org/matrix-rust-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk) You must be signed in to change notification settings
* [Fork
  267](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)
* [Star
   1.3k](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)

* [Code](/matrix-org/matrix-rust-sdk)
* [Issues
  211](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests
  10](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects
  0](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-rust-sdk)
* [Issues](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

## Commit

[Permalink](/matrix-org/matrix-rust-sdk/commit/41449d2cc360e347f5d4e1c154ec1e3185f11acd)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

test(crypto): Test that we reject forwarded room keys from other users

[Browse files](/matrix-org/matrix-rust-sdk/tree/41449d2cc360e347f5d4e1c154ec1e3185f11acd)
Browse the repository at this point in the history

* Loading branch information

[![@poljar](https://avatars.githubusercontent.com/u/552026?s=40&v=4)](/poljar)

[poljar](/matrix-org/matrix-rust-sdk/commits?author=poljar "View all commits by poljar")
committed
Sep 28, 2022

1 parent
[093fb5d](/matrix-org/matrix-rust-sdk/commit/093fb5d0aa21c0b5eaea6ec96b477f1075271cbb)

commit 41449d2

Showing
**1 changed file**
with
**60 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

64 changes: 60 additions & 4 deletions

64
[crates/matrix-sdk-crypto/src/gossiping/machine.rs](#diff-723b3a87aa508f41a037f9c4222c6c2e125abca051e3d60c43cb99e275ebcfe7 "crates/matrix-sdk-crypto/src/gossiping/machine.rs")

Show comments

[View file](/matrix-org/matrix-rust-sdk/blob/41449d2cc360e347f5d4e1c154ec1e3185f11acd/crates/matrix-sdk-crypto/src/gossiping/machine.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1148,6 +1148,7 @@ mod tests { |
|  |  | } |
|  |  |  |
|  |  | async fn machines\_for\_key\_share( |
|  |  | other\_machine\_owner: &UserId, |
|  |  | create\_sessions: bool, |
|  |  | ) -> (GossipMachine, Account, OutboundGroupSession, GossipMachine) { |
|  |  | let alice\_machine = get\_machine().await; |
| Expand All | | @@ -1157,12 +1158,14 @@ mod tests { |
|  |  | }; |
|  |  | let alice\_device = ReadOnlyDevice::from\_account(alice\_machine.store.account()).await; |
|  |  |  |
|  |  | let bob\_machine = test\_gossip\_machine(alice\_id()); |
|  |  | let bob\_machine = test\_gossip\_machine(other\_machine\_owner); |
|  |  | let bob\_device = ReadOnlyDevice::from\_account(bob\_machine.store.account()).await; |
|  |  |  |
|  |  | // We need a trusted device, otherwise we won't request keys |
|  |  | let second\_device = ReadOnlyDevice::from\_account(&alice\_2\_account()).await; |
|  |  | second\_device.set\_trust\_state(LocalTrust::Verified); |
|  |  | bob\_device.set\_trust\_state(LocalTrust::Verified); |
|  |  | alice\_machine.store.save\_devices(&[bob\_device]).await.unwrap(); |
|  |  | alice\_machine.store.save\_devices(&[bob\_device, second\_device]).await.unwrap(); |
|  |  | bob\_machine.store.save\_devices(&[alice\_device.clone()]).await.unwrap(); |
|  |  |  |
|  |  | if create\_sessions { |
| Expand Down  Expand Up | | @@ -1535,7 +1538,7 @@ mod tests { |
|  |  | #[async\_test] |
|  |  | async fn key\_share\_cycle() { |
|  |  | let (alice\_machine, alice\_account, group\_session, bob\_machine) = |
|  |  | machines\_for\_key\_share(true).await; |
|  |  | machines\_for\_key\_share(alice\_id(), true).await; |
|  |  |  |
|  |  | // Get the request and convert it into a event. |
|  |  | let requests = alice\_machine.outgoing\_to\_device\_requests().await.unwrap(); |
| Expand Down  Expand Up | | @@ -1599,6 +1602,59 @@ mod tests { |
|  |  | assert\_eq!(session.session\_id(), group\_session.session\_id()) |
|  |  | } |
|  |  |  |
|  |  | #[async\_test] |
|  |  | async fn reject\_forward\_from\_another\_user() { |
|  |  | let (alice\_machine, alice\_account, group\_session, bob\_machine) = |
|  |  | machines\_for\_key\_share(bob\_id(), true).await; |
|  |  |  |
|  |  | // Get the request and convert it into a event. |
|  |  | let requests = alice\_machine.outgoing\_to\_device\_requests().await.unwrap(); |
|  |  | let request = &requests[0]; |
|  |  | let event = request\_to\_event(alice\_id(), alice\_id(), request); |
|  |  |  |
|  |  | alice\_machine.mark\_outgoing\_request\_as\_sent(&request.request\_id).await.unwrap(); |
|  |  |  |
|  |  | // Bob doesn't have any outgoing requests. |
|  |  | assert!(bob\_machine.outgoing\_requests.is\_empty()); |
|  |  |  |
|  |  | // Receive the room key request from alice. |
|  |  | bob\_machine.receive\_incoming\_key\_request(&event); |
|  |  | bob\_machine.collect\_incoming\_key\_requests().await.unwrap(); |
|  |  | // Now bob does have an outgoing request. |
|  |  | assert!(!bob\_machine.outgoing\_requests.is\_empty()); |
|  |  |  |
|  |  | // Get the request and convert it to a encrypted to-device event. |
|  |  | let requests = bob\_machine.outgoing\_to\_device\_requests().await.unwrap(); |
|  |  | let request = &requests[0]; |
|  |  |  |
|  |  | let event: EncryptedToDeviceEvent = request\_to\_event(alice\_id(), bob\_id(), request); |
|  |  | bob\_machine.mark\_outgoing\_request\_as\_sent(&request.request\_id).await.unwrap(); |
|  |  |  |
|  |  | // Check that alice doesn't have the session. |
|  |  | assert!(alice\_machine |
|  |  | .store |
|  |  | .get\_inbound\_group\_session( |
|  |  | room\_id(), |
|  |  | &bob\_machine.store.account().identity\_keys().curve25519.to\_base64(), |
|  |  | group\_session.session\_id() |
|  |  | ) |
|  |  | .await |
|  |  | .unwrap() |
|  |  | .is\_none()); |
|  |  |  |
|  |  | let decrypted = alice\_account.decrypt\_to\_device\_event(&event).await.unwrap(); |
|  |  | if let AnyDecryptedOlmEvent::ForwardedRoomKey(e) = decrypted.result.event { |
|  |  | let session = alice\_machine |
|  |  | .receive\_forwarded\_room\_key(decrypted.result.sender\_key, &e) |
|  |  | .await |
|  |  | .unwrap(); |
|  |  |  |
|  |  | assert!(session.is\_none(), "We should not receive a room key from another user"); |
|  |  | } else { |
|  |  | panic!("Invalid decrypted event type"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | #[async\_test] |
|  |  | async fn secret\_share\_cycle() { |
|  |  | let alice\_machine = get\_machine().await; |
| Expand Down  Expand Up | | @@ -1672,7 +1728,7 @@ mod tests { |
|  |  | #[async\_test] |
|  |  | async fn key\_share\_cycle\_without\_session() { |
|  |  | let (alice\_machine, alice\_account, group\_session, bob\_machine) = |
|  |  | machines\_for\_key\_share(false).await; |
|  |  | machines\_for\_key\_share(alice\_id(), false).await; |
|  |  |  |
|  |  | // Get the request and convert it into a event. |
|  |  | let requests = alice\_machine.outgoing\_to\_device\_requests().await.unwrap(); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `41449d2`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fcommit%2F41449d2cc360e347f5d4e1c154ec1e3185f11acd) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_14fa2ede_20250115_081747.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fsecurity%2Fadvisories%2FGHSA-vp68-2wrm-69qm)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fsecurity%2Fadvisories%2FGHSA-vp68-2wrm-69qm)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=matrix-org%2Fmatrix-rust-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-rust-sdk](/matrix-org/matrix-rust-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk) You must be signed in to change notification settings
* [Fork
  267](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)
* [Star
   1.3k](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)

* [Code](/matrix-org/matrix-rust-sdk)
* [Issues
  211](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests
  10](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects
  0](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-rust-sdk)
* [Issues](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

# When receiving forwarded room keys, we don't check that the forwarder device matches the device we requested from

Low

[poljar](/poljar)
published
GHSA-vp68-2wrm-69qm
Sep 29, 2022

## Package

cargo

matrix-sdk-crypto
([Rust](/advisories?query=ecosystem%3Arust))

## Affected versions

< 0.5

## Patched versions

0.6

## Description

### Impact

When matrix-rust-sdk before 0.6 requests a room key from our devices, it correctly accepts key forwards only if they are a response to a previous request. However, it doesn't check that the device that responded matches the device the key was requested from.

This allows a malicious homeserver to insert room keys of questionable validity into the key store in some situations, potentially assisting in an impersonation attack. Note that even if key injection succeeds in this way, all forwarded keys have the `imported` flag set, which is used as an indicator that such keys have lesser authentication properties (and should be marked as such in clients, e.g. with a grey shield besides the message).

### For more information

If you have any questions or comments about this advisory, e-mail us at security@matrix.org.

### Severity

Low

2.7

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
High

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
Low

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:N/I:L/A:N

### CVE ID

CVE-2022-39252

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4e845bc9_20250115_081744.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fcommit%2F093fb5d0aa21c0b5eaea6ec96b477f1075271cbb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fcommit%2F093fb5d0aa21c0b5eaea6ec96b477f1075271cbb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fmatrix-rust-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-rust-sdk](/matrix-org/matrix-rust-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk) You must be signed in to change notification settings
* [Fork
  267](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)
* [Star
   1.3k](/login?return_to=%2Fmatrix-org%2Fmatrix-rust-sdk)

* [Code](/matrix-org/matrix-rust-sdk)
* [Issues
  211](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests
  10](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects
  0](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-rust-sdk)
* [Issues](/matrix-org/matrix-rust-sdk/issues)
* [Pull requests](/matrix-org/matrix-rust-sdk/pulls)
* [Actions](/matrix-org/matrix-rust-sdk/actions)
* [Projects](/matrix-org/matrix-rust-sdk/projects)
* [Security](/matrix-org/matrix-rust-sdk/security)
* [Insights](/matrix-org/matrix-rust-sdk/pulse)

## Commit

[Permalink](/matrix-org/matrix-rust-sdk/commit/093fb5d0aa21c0b5eaea6ec96b477f1075271cbb)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(crypto): Only accept forwarded room keys from our own trusted dev…

[Browse files](/matrix-org/matrix-rust-sdk/tree/093fb5d0aa21c0b5eaea6ec96b477f1075271cbb)
Browse the repository at this point in the history

```
…ices
```

* Loading branch information

[![@poljar](https://avatars.githubusercontent.com/u/552026?s=40&v=4)](/poljar)

[poljar](/matrix-org/matrix-rust-sdk/commits?author=poljar "View all commits by poljar")
committed
Sep 28, 2022

1 parent
[513afa5](/matrix-org/matrix-rust-sdk/commit/513afa57ef19a0c42317b36a1f5629ea3167c69d)

commit 093fb5d

Showing
**1 changed file**
with
**31 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

33 changes: 31 additions & 2 deletions

33
[crates/matrix-sdk-crypto/src/gossiping/machine.rs](#diff-723b3a87aa508f41a037f9c4222c6c2e125abca051e3d60c43cb99e275ebcfe7 "crates/matrix-sdk-crypto/src/gossiping/machine.rs")

Show comments

[View file](/matrix-org/matrix-rust-sdk/blob/093fb5d0aa21c0b5eaea6ec96b477f1075271cbb/crates/matrix-sdk-crypto/src/gossiping/machine.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -945,6 +945,21 @@ impl GossipMachine { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | async fn should\_accept\_forward( |
|  |  | &self, |
|  |  | info: &GossipRequest, |
|  |  | sender\_key: Curve25519PublicKey, |
|  |  | ) -> Result<bool, CryptoStoreError> { |
|  |  | let device = |
|  |  | self.store.get\_device\_from\_curve\_key(&info.request\_recipient, sender\_key).await?; |
|  |  |  |
|  |  | if let Some(device) = device { |
|  |  | Ok(device.user\_id() == self.user\_id() && device.is\_verified()) |
|  |  | } else { |
|  |  | Ok(false) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Receive a forwarded room key event that was sent using any of our |
|  |  | /// supported content types. |
|  |  | async fn receive\_supported\_keys( |
| Expand All | | @@ -956,8 +971,22 @@ impl GossipMachine { |
|  |  | let algorithm = event.content.algorithm(); |
|  |  |  |
|  |  | if let Some(info) = self.get\_key\_info(event).await? { |
|  |  | self.accept\_forwarded\_room\_key(&info, &event.sender, sender\_key, algorithm, content) |
|  |  | .await |
|  |  | if self.should\_accept\_forward(&info, sender\_key).await? { |
|  |  | self.accept\_forwarded\_room\_key(&info, &event.sender, sender\_key, algorithm, content) |
|  |  | .await |
|  |  | } else { |
|  |  | warn!( |
|  |  | sender = %event.sender, |
|  |  | %sender\_key, |
|  |  | room\_id = %content.room\_id, |
|  |  | session\_id = content.session\_id.as\_str(), |
|  |  | claimed\_sender\_key = %content.claimed\_sender\_key, |
|  |  | "Received a forwarded room key from an unknown device, or \ |
|  |  | from a device that the key request recipient doesn't own", |
|  |  | ); |
|  |  |  |
|  |  | Ok(None) |
|  |  | } |
|  |  | } else { |
|  |  | warn!( |
|  |  | sender = %event.sender, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `093fb5d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-rust-sdk%2Fcommit%2F093fb5d0aa21c0b5eaea6ec96b477f1075271cbb) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


