=== Content from github.com_03658d4d_20250114_233446.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse%2Fsecurity%2Fadvisories%2FGHSA-gh5r-j595-qx48)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse%2Fsecurity%2Fadvisories%2FGHSA-gh5r-j595-qx48)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=discourse%2Fdiscourse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[discourse](/discourse)
/
**[discourse](/discourse/discourse)**
Public

* [Notifications](/login?return_to=%2Fdiscourse%2Fdiscourse) You must be signed in to change notification settings
* [Fork
  8.4k](/login?return_to=%2Fdiscourse%2Fdiscourse)
* [Star
   42.9k](/login?return_to=%2Fdiscourse%2Fdiscourse)

* [Code](/discourse/discourse)
* [Pull requests
  68](/discourse/discourse/pulls)
* [Actions](/discourse/discourse/actions)
* [Security](/discourse/discourse/security)
* [Insights](/discourse/discourse/pulse)

Additional navigation options

* [Code](/discourse/discourse)
* [Pull requests](/discourse/discourse/pulls)
* [Actions](/discourse/discourse/actions)
* [Security](/discourse/discourse/security)
* [Insights](/discourse/discourse/pulse)

# Invitation can cause users to be erroneously and transparently added to private message

High

[jomaxro](/jomaxro)
published
GHSA-gh5r-j595-qx48
Nov 14, 2022

## Package

Discourse
(Discourse)

## Affected versions

stable <= 2.8.10; beta <= 2.9.0.beta11; tests-passed <= 2.9.0.beta11

## Patched versions

stable > 2.8.10; beta > 2.9.0.beta11; tests-passed > 2.9.0.beta11

## Description

### Impact

In some rare cases users redeeming an invitation can be added as a participant to several private message topics that they should not be added to. They are not notified of this, it happens transparently in the background.

### Patches

Patched in the latest version.

### Workarounds

Set `SiteSetting.max_invites_per_day` to 0 until the patch is installed.

### Severity

High

8.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
None

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:H

### CVE ID

CVE-2022-39385

### Weaknesses

[CWE-200](/advisories?query=cwe%3A200)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d848ac06_20250114_233445.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse%2Fcommit%2Fa414520742da8dc9dc976d4fb7b72dbd445813bb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse%2Fcommit%2Fa414520742da8dc9dc976d4fb7b72dbd445813bb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=discourse%2Fdiscourse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[discourse](/discourse)
/
**[discourse](/discourse/discourse)**
Public

* [Notifications](/login?return_to=%2Fdiscourse%2Fdiscourse) You must be signed in to change notification settings
* [Fork
  8.4k](/login?return_to=%2Fdiscourse%2Fdiscourse)
* [Star
   42.9k](/login?return_to=%2Fdiscourse%2Fdiscourse)

* [Code](/discourse/discourse)
* [Pull requests
  68](/discourse/discourse/pulls)
* [Actions](/discourse/discourse/actions)
* [Security](/discourse/discourse/security)
* [Insights](/discourse/discourse/pulse)

Additional navigation options

* [Code](/discourse/discourse)
* [Pull requests](/discourse/discourse/pulls)
* [Actions](/discourse/discourse/actions)
* [Security](/discourse/discourse/security)
* [Insights](/discourse/discourse/pulse)

## Commit

[Permalink](/discourse/discourse/commit/a414520742da8dc9dc976d4fb7b72dbd445813bb)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

SECURITY: Prevent email from being nil in InviteRedeemer ([#19004](https://github.com/discourse/discourse/pull/19004))

[Browse files](/discourse/discourse/tree/a414520742da8dc9dc976d4fb7b72dbd445813bb)
Browse the repository at this point in the history

```
This commit adds some protections in InviteRedeemer to ensure that email
can never be nil, which could cause issues with inviting the invited
person to private topics since there was an incorrect inner join.

If the email is nil and the invite is scoped to an email, we just use
that invite.email unconditionally.  If a redeeming_user (an existing
user) is passed in when redeeming an email, we use their email to
override the passed in email.  Otherwise we just use the passed in
email.  We now raise an error after all this if the email is still nil.
This commit also adds some tests to catch the private topic fix, and
some general improvements and comments around the invite code.

This commit also includes a migration to delete TopicAllowedUser records
for users who were mistakenly added to topics as part of the invite
redemption process.
```

* Loading branch information

[![@martin-brennan](https://avatars.githubusercontent.com/u/920448?s=40&v=4)](/martin-brennan)

[martin-brennan](/discourse/discourse/commits?author=martin-brennan "View all commits by martin-brennan")
authored
Nov 14, 2022

1 parent
[78157b4](/discourse/discourse/commit/78157b43edab1a22e3ec1a8a823b40ff38f96631)

commit a414520

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**506 additions**
and
**213 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + controllers

    - app/controllers/session\_controller.rb
      [session\_controller.rb](#diff-b955d5e07bb336431ce5d25acd60fe8f87e3a31c4b33a167a069f3b76bf3ef64)
  + models

    - app/models/invite.rb
      [invite.rb](#diff-94835916996982fe55b5a4e0a60628f2d84c223ee8a6f0873be3aad7a997871d)
    - app/models/invite\_redeemer.rb
      [invite\_redeemer.rb](#diff-576330bb5d796fe0e877fb7db891ab4dbb01d12843f2c9c5a5e66b291cd616f2)
* db/migrate

  + db/migrate/20221103051248\_remove\_invalid\_topic\_allowed\_users\_from\_invites.rb
    [20221103051248\_remove\_invalid\_topic\_allowed\_users\_from\_invites.rb](#diff-f73f1e85e9f0b89f6def987ab5efaeac7a473890cc6cfa03ddb0e474480a6e26)
* spec

  + models

    - spec/models/invite\_redeemer\_spec.rb
      [invite\_redeemer\_spec.rb](#diff-8f45fe8db0d62a441fd00a5769e95ff7eeab3dc5c18e37a0cfe9fd609bd672cb)
  + requests

    - spec/requests/invites\_controller\_spec.rb
      [invites\_controller\_spec.rb](#diff-9bd1b6e02686616de8ded5fc3e02abc63c40c0bdd62d22f412c8857e48cf3926)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[app/controllers/session\_controller.rb](#diff-b955d5e07bb336431ce5d25acd60fe8f87e3a31c4b33a167a069f3b76bf3ef64 "app/controllers/session_controller.rb")

Show comments

[View file](/discourse/discourse/blob/a414520742da8dc9dc976d4fb7b72dbd445813bb/app/controllers/session_controller.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -760,7 +760,7 @@ def validate\_invitiation!(sso) |
|  |  | end |
|  |  |  |
|  |  | if invite.redeemable? |
|  |  | if !invite.is\_invite\_link? && sso.email != invite.email |
|  |  | if invite.is\_email\_invite? && sso.email != invite.email |
|  |  | raise Invite::ValidationFailed.new(I18n.t("invite.not\_matching\_email")) |
|  |  | end |
|  |  | elsif invite.expired? |
| Expand Down | |  |

12 changes: 9 additions & 3 deletions

12
[app/models/invite.rb](#diff-94835916996982fe55b5a4e0a60628f2d84c223ee8a6f0873be3aad7a997871d "app/models/invite.rb")

Show comments

[View file](/discourse/discourse/blob/a414520742da8dc9dc976d4fb7b72dbd445813bb/app/models/invite.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -74,8 +74,16 @@ def email\_xor\_domain |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | # Even if a domain is specified on the invite, it still counts as |
|  |  | # an invite link. |
|  |  | def is\_invite\_link? |
|  |  | email.blank? |
|  |  | self.email.blank? |
|  |  | end |
|  |  |  |
|  |  | # Email invites have specific behaviour and it's easier to visually |
|  |  | # parse is\_email\_invite? than !is\_invite\_link? |
|  |  | def is\_email\_invite? |
|  |  | self.email.present? |
|  |  | end |
|  |  |  |
|  |  | def redeemable? |
| Expand Down  Expand Up | | @@ -201,8 +209,6 @@ def redeem( |
|  |  | ) |
|  |  | return if !redeemable? |
|  |  |  |
|  |  | email = self.email if email.blank? && !is\_invite\_link? |
|  |  |  |
|  |  | InviteRedeemer.new( |
|  |  | invite: self, |
|  |  | email: email, |
| Expand Down | |  |

105 changes: 80 additions & 25 deletions

105
[app/models/invite\_redeemer.rb](#diff-576330bb5d796fe0e877fb7db891ab4dbb01d12843f2c9c5a5e66b291cd616f2 "app/models/invite_redeemer.rb")

Show comments

[View file](/discourse/discourse/blob/a414520742da8dc9dc976d4fb7b72dbd445813bb/app/models/invite_redeemer.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,18 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  |  |
|  |  | # NOTE: There are a \_lot\_ of complicated rules and conditions for our |
|  |  | # invite system, and the code is spread out through a lot of places. |
|  |  | # Tread lightly and read carefully when modifying this code. You may |
|  |  | # also want to look at: |
|  |  | # |
|  |  | # \* InvitesController |
|  |  | # \* SessionController |
|  |  | # \* Invite model |
|  |  | # \* User model |
|  |  | # |
|  |  | # Invites that are scoped to a specific email (email IS NOT NULL on the Invite |
|  |  | # model) have different rules to invites that are considered an "invite link", |
|  |  | # (email IS NULL) on the Invite model. |
|  |  | class InviteRedeemer |
|  |  | attr\_reader :invite, |
|  |  | :email, |
| Expand All | | @@ -13,7 +26,7 @@ class InviteRedeemer |
|  |  | :redeeming\_user |
|  |  |  |
|  |  | def initialize( |
|  |  | invite: nil, |
|  |  | invite:, |
|  |  | email: nil, |
|  |  | username: nil, |
|  |  | name: nil, |
| Expand All | | @@ -23,9 +36,7 @@ def initialize( |
|  |  | session: nil, |
|  |  | email\_token: nil, |
|  |  | redeeming\_user: nil) |
|  |  |  |
|  |  | @invite = invite |
|  |  | @email = email |
|  |  | @username = username |
|  |  | @name = name |
|  |  | @password = password |
| Expand All | | @@ -34,6 +45,8 @@ def initialize( |
|  |  | @session = session |
|  |  | @email\_token = email\_token |
|  |  | @redeeming\_user = redeeming\_user |
|  |  |  |
|  |  | ensure\_email\_is\_present!(email) |
|  |  | end |
|  |  |  |
|  |  | def redeem |
| Expand All | | @@ -45,7 +58,29 @@ def redeem |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | # extracted from User cause it is very specific to invites |
|  |  | # The email must be present in some form since many of the methods |
|  |  | # for processing + redemption rely on it. If it's still nil after |
|  |  | # these checks then we have hit an edge case and should not proceed! |
|  |  | def ensure\_email\_is\_present!(email) |
|  |  | if email.blank? |
|  |  | Rails.logger.warn( |
|  |  | "email param was blank in InviteRedeemer for invite ID #{@invite.id}. The `redeeming\_user` was #{@redeeming\_user.present? ? "(ID: #{@redeeming\_user.id})" : "not"} present.", |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | if email.blank? && @invite.is\_email\_invite? |
|  |  | @email = @invite.email |
|  |  | elsif @redeeming\_user.present? |
|  |  | @email = @redeeming\_user.email |
|  |  | else |
|  |  | @email = email |
|  |  | end |
|  |  |  |
|  |  | raise Discourse::InvalidParameters if @email.blank? |
|  |  | end |
|  |  |  |
|  |  | # This will \_never\_ be called if there is a redeeming\_user being passed |
|  |  | # in to InviteRedeemer -- see invited\_user below. |
|  |  | def self.create\_user\_from\_invite(email:, invite:, username: nil, name: nil, password: nil, user\_custom\_fields: nil, ip\_address: nil, session: nil, email\_token: nil) |
|  |  | if username && UsernameValidator.new(username).valid\_format? && User.username\_available?(username, email) |
|  |  | available\_username = username |
| Expand Down  Expand Up | | @@ -107,7 +142,10 @@ def self.create\_user\_from\_invite(email:, invite:, username: nil, name: nil, pass |
|  |  | user.save! |
|  |  | authenticator.finish |
|  |  |  |
|  |  | if invite.emailed\_status != Invite.emailed\_status\_types[:not\_required] && email == invite.email && invite.email\_token.present? && email\_token == invite.email\_token |
|  |  | if invite.emailed\_status != Invite.emailed\_status\_types[:not\_required] && |
|  |  | email == invite.email && |
|  |  | invite.email\_token.present? && |
|  |  | email\_token == invite.email\_token |
|  |  | user.activate |
|  |  | end |
|  |  |  |
| Expand All | | @@ -118,24 +156,26 @@ def self.create\_user\_from\_invite(email:, invite:, username: nil, name: nil, pass |
|  |  |  |
|  |  | def can\_redeem\_invite? |
|  |  | return false if !invite.redeemable? |
|  |  | return false if email.blank? |
|  |  |  |
|  |  | # Invite has already been redeemed by anyone. |
|  |  | if !invite.is\_invite\_link? && InvitedUser.exists?(invite\_id: invite.id) |
|  |  | # Invite scoped to email has already been redeemed by anyone. |
|  |  | if invite.is\_email\_invite? && InvitedUser.exists?(invite\_id: invite.id) |
|  |  | return false |
|  |  | end |
|  |  |  |
|  |  | # Email will not be present if we are claiming an invite link, which |
|  |  | # does not have an email or domain scope on the invitation. |
|  |  | if email.present? || redeeming\_user.present? |
|  |  | email\_to\_check = redeeming\_user&.email || email |
|  |  | # The email will be present for either an invite link (where the user provides |
|  |  | # us the email manually) or for an invite scoped to an email, where we |
|  |  | # prefill the email and do not let the user modify it. |
|  |  | # |
|  |  | # Note that an invite link can also have a domain scope which must be checked. |
|  |  | email\_to\_check = redeeming\_user&.email || email |
|  |  |  |
|  |  | if invite.email.present? && !invite.email\_matches?(email\_to\_check) |
|  |  | raise ActiveRecord::RecordNotSaved.new(I18n.t('invite.not\_matching\_email')) |
|  |  | end |
|  |  | if invite.email.present? && !invite.email\_matches?(email\_to\_check) |
|  |  | raise ActiveRecord::RecordNotSaved.new(I18n.t('invite.not\_matching\_email')) |
|  |  | end |
|  |  |  |
|  |  | if invite.domain.present? && !invite.domain\_matches?(email\_to\_check) |
|  |  | raise ActiveRecord::RecordNotSaved.new(I18n.t('invite.domain\_not\_allowed')) |
|  |  | end |
|  |  | if invite.domain.present? && !invite.domain\_matches?(email\_to\_check) |
|  |  | raise ActiveRecord::RecordNotSaved.new(I18n.t('invite.domain\_not\_allowed')) |
|  |  | end |
|  |  |  |
|  |  | # Anon user is trying to redeem an invitation, if an existing user already |
| Expand All | | @@ -148,6 +188,10 @@ def can\_redeem\_invite? |
|  |  | true |
|  |  | end |
|  |  |  |
|  |  | # Note that the invited\_user is returned by #redeemed, so other places |
|  |  | # (e.g. the InvitesController) can perform further actions on it, this |
|  |  | # is why things like send\_welcome\_message are set without being saved |
|  |  | # on the model. |
|  |  | def invited\_user |
|  |  | return @invited\_user if defined?(@invited\_user) |
|  |  |  |
| Expand Down  Expand Up | | @@ -196,9 +240,18 @@ def mark\_invite\_redeemed |
|  |  | end |
|  |  |  |
|  |  | def add\_to\_private\_topics\_if\_invited |
|  |  | topic\_ids = Topic.where(archetype: Archetype::private\_message).includes(:invites).where(invites: { email: email }).pluck(:id) |
|  |  | # Should not happen because of ensure\_email\_is\_present!, but better to cover bases. |
|  |  | return if email.blank? |
|  |  |  |
|  |  | topic\_ids = TopicInvite.joins(:invite) |
|  |  | .joins(:topic) |
|  |  | .where("topics.archetype = ?", Archetype::private\_message) |
|  |  | .where("invites.email = ?", email) |
|  |  | .pluck(:topic\_id) |
|  |  | topic\_ids.each do |id| |
|  |  | TopicAllowedUser.create!(user\_id: invited\_user.id, topic\_id: id) unless TopicAllowedUser.exists?(user\_id: invited\_user.id, topic\_id: id) |
|  |  | if !TopicAllowedUser.exists?(user\_id: invited\_user.id, topic\_id: id) |
|  |  | TopicAllowedUser.create!(user\_id: invited\_user.id, topic\_id: id) |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  |  |
| Expand All | | @@ -221,15 +274,17 @@ def send\_welcome\_message |
|  |  | end |
|  |  |  |
|  |  | def notify\_invitee |
|  |  | if inviter = invite.invited\_by |
|  |  | inviter.notifications.create!( |
|  |  | notification\_type: Notification.types[:invitee\_accepted], |
|  |  | data: { display\_username: invited\_user.username }.to\_json |
|  |  | ) |
|  |  | end |
|  |  | return if invite.invited\_by.blank? |
|  |  | invite.invited\_by.notifications.create!( |
|  |  | notification\_type: Notification.types[:invitee\_accepted], |
|  |  | data: { display\_username: invited\_user.username }.to\_json |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | def delete\_duplicate\_invites |
|  |  | # Should not happen because of ensure\_email\_is\_present!, but better to cover bases. |
|  |  | return if email.blank? |
|  |  |  |
|  |  | Invite |
|  |  | .where('invites.max\_redemptions\_allowed = 1') |
|  |  | .joins("LEFT JOIN invited\_users ON invites.id = invited\_users.invite\_id") |
| Expand Down | |  |

60 changes: 60 additions & 0 deletions

60
[db/migrate/20221103051248\_remove\_invalid\_topic\_allowed\_users\_from\_invites.rb](#diff-f73f1e85e9f0b89f6def987ab5efaeac7a473890cc6cfa03ddb0e474480a6e26 "db/migrate/20221103051248_remove_invalid_topic_allowed_users_from_invites.rb")

Show comments

[View file](/discourse/discourse/blob/a414520742da8dc9dc976d4fb7b72dbd445813bb/db/migrate/20221103051248_remove_invalid_topic_allowed_users_from_invites.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,60 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  |  |
|  |  | class RemoveInvalidTopicAllowedUsersFromInvites < ActiveRecord::Migration[7.0] |
|  |  | def up |
|  |  | # We are getting all the topic\_allowed\_users records that |
|  |  | # match an invited user, which is created as part of the invite |
|  |  | # redemption flow. The original invite would \_not\_ have had a topic\_invite |
|  |  | # record, and the user should have been added to the topic in the brief |
|  |  | # period between creation of the invited\_users record and the update of |
|  |  | # that record. |
|  |  | # |
|  |  | # Having > 2 topic allowed users disqualifies messages sent only |
|  |  | # by the system or an admin to the user. |
|  |  | subquery\_sql = <<~SQL |
|  |  | SELECT DISTINCT id |
|  |  | FROM ( |
|  |  | SELECT tau.id, tau.user\_id, COUNT(\*) OVER (PARTITION BY tau.user\_id) |
|  |  | FROM topic\_allowed\_users tau |
|  |  | JOIN invited\_users iu ON iu.user\_id = tau.user\_id |
|  |  | LEFT JOIN topic\_invites ti ON ti.invite\_id = iu.invite\_id AND tau.topic\_id = ti.topic\_id |
|  |  | WHERE ti.id IS NULL |
|  |  | AND tau.created\_at BETWEEN iu.created\_at AND iu.updated\_at |
|  |  | AND iu.redeemed\_at > '2022-10-27' |
|  |  | ) AS matching\_topic\_allowed\_users |
|  |  | WHERE matching\_topic\_allowed\_users.count > 2 |
|  |  | SQL |
|  |  |  |
|  |  | # Back up the records we are going to change in case we are too |
|  |  | # brutal, and for further inspection. |
|  |  | # |
|  |  | # TODO DROP this table (topic\_allowed\_users\_backup\_nov\_2022) in a later migration. |
|  |  | DB.exec(<<~SQL) |
|  |  | CREATE TABLE topic\_allowed\_users\_backup\_nov\_2022 |
|  |  | ( |
|  |  | id INT NOT NULL, |
|  |  | user\_id INT NOT NULL, |
|  |  | topic\_id INT NOT NULL |
|  |  | ); |
|  |  | INSERT INTO topic\_allowed\_users\_backup\_nov\_2022(id, user\_id, topic\_id) |
|  |  | SELECT id, user\_id, topic\_id |
|  |  | FROM topic\_allowed\_users |
|  |  | WHERE id IN ( |
|  |  | #{subquery\_sql} |
|  |  | ) |
|  |  | SQL |
|  |  |  |
|  |  | # Delete the invalid topic allowed users that should not be there. |
|  |  | DB.query(<<~SQL) |
|  |  | DELETE |
|  |  | FROM topic\_allowed\_users |
|  |  | WHERE id IN ( |
|  |  | #{subquery\_sql} |
|  |  | ) |
|  |  | SQL |
|  |  | end |
|  |  |  |
|  |  | def down |
|  |  | raise ActiveRecord::IrreversibleMigration |
|  |  | end |
|  |  | end |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a414520`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiscourse%2Fdiscourse%2Fcommit%2Fa414520742da8dc9dc976d4fb7b72dbd445813bb) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


