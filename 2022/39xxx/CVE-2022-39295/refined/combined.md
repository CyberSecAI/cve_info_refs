=== Content from github.com_5c87fbb1_20250114_195650.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FKnowageLabs%2FKnowage-Server%2Fsecurity%2Fadvisories%2FGHSA-f2gr-6h9j-rwcw)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FKnowageLabs%2FKnowage-Server%2Fsecurity%2Fadvisories%2FGHSA-f2gr-6h9j-rwcw)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=KnowageLabs%2FKnowage-Server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[KnowageLabs](/KnowageLabs)
/
**[Knowage-Server](/KnowageLabs/Knowage-Server)**
Public

* [Notifications](/login?return_to=%2FKnowageLabs%2FKnowage-Server) You must be signed in to change notification settings
* [Fork
  225](/login?return_to=%2FKnowageLabs%2FKnowage-Server)
* [Star
   413](/login?return_to=%2FKnowageLabs%2FKnowage-Server)

* [Code](/KnowageLabs/Knowage-Server)
* [Issues
  1](/KnowageLabs/Knowage-Server/issues)
* [Pull requests
  31](/KnowageLabs/Knowage-Server/pulls)
* [Actions](/KnowageLabs/Knowage-Server/actions)
* [Security](/KnowageLabs/Knowage-Server/security)
* [Insights](/KnowageLabs/Knowage-Server/pulse)

Additional navigation options

* [Code](/KnowageLabs/Knowage-Server)
* [Issues](/KnowageLabs/Knowage-Server/issues)
* [Pull requests](/KnowageLabs/Knowage-Server/pulls)
* [Actions](/KnowageLabs/Knowage-Server/actions)
* [Security](/KnowageLabs/Knowage-Server/security)
* [Insights](/KnowageLabs/Knowage-Server/pulse)

# Improper Neutralization of Alternate XSS Syntax in KnowageLabs / Knowage-Server

Moderate

[kerny3d](/kerny3d)
published
GHSA-f2gr-6h9j-rwcw
Oct 11, 2022

## Package

KnowageLabs / Knowage-Server
(Knowage)

## Affected versions

6.x.x, <7.4.22, <8.0.9, <8.1.0

## Patched versions

7.4.22, 8.0.9, 8.1.0

## Description

### Impact

Cross Site Scripting in KnowageLabs / Knowage-Server

### Root Cause

The `XSSRequestWrapper::stripXSS` method can be bypassed.

[Knowage-Server/knowageutils/src/main/java/it/eng/spagobi/utilities/filters/XSSRequestWrapper.java](https://github.com/KnowageLabs/Knowage-Server/blob/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities/filters/XSSRequestWrapper.java#L82-L206)

Lines 82 to 206
in
[b079a65](/KnowageLabs/Knowage-Server/commit/b079a654c1708f82f6914c55be6715ad621d9edd)

|  | public static String stripXSS(String value) { |
| --- | --- |
|  | logger.debug("IN"); |
|  | String initialValue = value; |
|  |  |
|  | if (value != null) { |
|  | // NOTE: It's highly recommended to use the ESAPI library and uncomment the following line to |
|  | // avoid encoded attacks. |
|  | // value = ESAPI.encoder().canonicalize(value); |
|  |  |
|  | // Avoid null characters |
|  | value = value.replaceAll("", ""); |
|  |  |
|  | // Avoid anything between script tags |
|  | Pattern scriptPattern = Pattern.compile("<script>(.\*?)</script>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | scriptPattern = Pattern.compile("&lt;script&gt;(.\*?)&lt;/script&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid anything in a src='...' type of expression |
|  | // Pattern.compile("src[\r\n]\*=[\r\n]\*\\\'(.\*?)\\\'", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | // value = scriptPattern.matcher(value).replaceAll(""); |
|  | // |
|  | // scriptPattern = Pattern.compile("src[\r\n]\*=[\r\n]\*\\\"(.\*?)\\\"", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | // value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | value = checkImgTags(value); |
|  | value = checkIframeTags(value); |
|  | value = checkAnchorTags(value); |
|  | value = checkVideoTags(value); |
|  | value = checkCSS(value); |
|  |  |
|  | // Remove any lonesome </script> tag |
|  | scriptPattern = Pattern.compile("</script>", Pattern.CASE\_INSENSITIVE); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | scriptPattern = Pattern.compile("&lt;/script&gt;", Pattern.CASE\_INSENSITIVE); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Remove any lonesome <script ...> tag |
|  | scriptPattern = Pattern.compile("<script(.\*?)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | scriptPattern = Pattern.compile("&lt;script(.\*?)&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid eval(...) expressions |
|  | scriptPattern = Pattern.compile("eval\\((.\*?)\\)", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid expression(...) expressions |
|  | scriptPattern = Pattern.compile("expression\\((.\*?)\\)", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid javascript:... expressions |
|  | scriptPattern = Pattern.compile("javascript:", Pattern.CASE\_INSENSITIVE); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid vbscript:... expressions |
|  | scriptPattern = Pattern.compile("vbscript:", Pattern.CASE\_INSENSITIVE); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid onload= expressions |
|  | scriptPattern = Pattern.compile("onload(.\*?)=", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid onClick= expressions |
|  | scriptPattern = Pattern.compile("onClick(.\*?)=", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = scriptPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid anything between form tags |
|  | Pattern formPattern = Pattern.compile("<form(.\*?)</form>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = formPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid anything between a tags |
|  | // Pattern aPattern = Pattern.compile("<a(.\*?)</a>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | // value = aPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // aPattern = Pattern.compile("<a(.\*?/)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | // value = aPattern.matcher(value).replaceAll(""); |
|  |  |
|  | Pattern aPattern = Pattern.compile("&lt;a(.\*?)&lt;/a&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = aPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Avoid anything between button tags |
|  | Pattern buttonPattern = Pattern.compile("<button(.\*?)</button>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = buttonPattern.matcher(value).replaceAll(""); |
|  |  |
|  | buttonPattern = Pattern.compile("<button(.\*?/)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = buttonPattern.matcher(value).replaceAll(""); |
|  |  |
|  | buttonPattern = Pattern.compile("&lt;button(.\*?)&lt;/button&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = buttonPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Example value ="<object data=\"javascript:alert('XSS')\"></object>" |
|  | // Avoid anything between script tags |
|  | Pattern objectPattern = Pattern.compile("<object(.\*?)</object>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = objectPattern.matcher(value).replaceAll(""); |
|  |  |
|  | objectPattern = Pattern.compile("&lt;object(.\*?)&lt;/object&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = objectPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Remove any lonesome </object> tag |
|  | objectPattern = Pattern.compile("</object>", Pattern.CASE\_INSENSITIVE); |
|  | value = objectPattern.matcher(value).replaceAll(""); |
|  |  |
|  | objectPattern = Pattern.compile("&lt;/object&gt;", Pattern.CASE\_INSENSITIVE); |
|  | value = objectPattern.matcher(value).replaceAll(""); |
|  |  |
|  | // Remove any lonesome <object ...> tag |
|  | objectPattern = Pattern.compile("<object(.\*?/)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = objectPattern.matcher(value).replaceAll(""); |
|  |  |
|  | objectPattern = Pattern.compile("&lt;object(.\*?/)&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); |
|  | value = objectPattern.matcher(value).replaceAll(""); |
|  |  |
|  | if (!value.equalsIgnoreCase(initialValue)) { |
|  | logger.warn("Message: detected a web attack through injection"); |
|  | } |
|  |  |
|  | } |
|  |  |
|  | logger.debug("OUT"); |
|  | return value; |
|  | } |

The following payloads can bypass this filter:

* `<scrivbscript:pt>alert(1)</scrivbscript:pt>` -> `<script>alert(1)</script>`
* `javavbscript:script:` -> `javascript:`
* ect...

Fundamentally, attempting to filter for XSS payloads uniformly, as this logic attempts to do is, a fundamentally flawed protection strategy. The way that user-input strings need to be used (for example HTML escaped, or URL encoded) is context dependent and varies heavily depending upon where they are being rendered/used. This issue needs to be fixed closer to where the content is being rendered, instead of attempting to prevent XXS in the manner this method attempts.

### Patches

*Has the problem been patched? What versions should users upgrade to?*

### Workarounds

*Is there a way for users to fix or remediate the vulnerability without upgrading?*

### References

*Are there any links users can visit to find out more?*

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [example link to repo](http://example.com)
* Email us at example email address

### Severity

Moderate

### CVE ID

CVE-2022-39295

### Weaknesses

[CWE-87](/advisories?query=cwe%3A87)

### Credits

* [![@JLLeitschuh](https://avatars.githubusercontent.com/u/1323708?s=40&v=4)](/JLLeitschuh)
  [JLLeitschuh](/JLLeitschuh)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_6f9cdf22_20250114_195647.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FKnowageLabs%2FKnowage-Server%2Fblob%2Fb079a654c1708f82f6914c55be6715ad621d9edd%2Fknowageutils%2Fsrc%2Fmain%2Fjava%2Fit%2Feng%2Fspagobi%2Futilities%2Ffilters%2FXSSRequestWrapper.java)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FKnowageLabs%2FKnowage-Server%2Fblob%2Fb079a654c1708f82f6914c55be6715ad621d9edd%2Fknowageutils%2Fsrc%2Fmain%2Fjava%2Fit%2Feng%2Fspagobi%2Futilities%2Ffilters%2FXSSRequestWrapper.java)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=KnowageLabs%2FKnowage-Server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[KnowageLabs](/KnowageLabs)
/
**[Knowage-Server](/KnowageLabs/Knowage-Server)**
Public

* [Notifications](/login?return_to=%2FKnowageLabs%2FKnowage-Server) You must be signed in to change notification settings
* [Fork
  225](/login?return_to=%2FKnowageLabs%2FKnowage-Server)
* [Star
   413](/login?return_to=%2FKnowageLabs%2FKnowage-Server)

* [Code](/KnowageLabs/Knowage-Server)
* [Issues
  1](/KnowageLabs/Knowage-Server/issues)
* [Pull requests
  31](/KnowageLabs/Knowage-Server/pulls)
* [Actions](/KnowageLabs/Knowage-Server/actions)
* [Security](/KnowageLabs/Knowage-Server/security)
* [Insights](/KnowageLabs/Knowage-Server/pulse)

Additional navigation options

* [Code](/KnowageLabs/Knowage-Server)
* [Issues](/KnowageLabs/Knowage-Server/issues)
* [Pull requests](/KnowageLabs/Knowage-Server/pulls)
* [Actions](/KnowageLabs/Knowage-Server/actions)
* [Security](/KnowageLabs/Knowage-Server/security)
* [Insights](/KnowageLabs/Knowage-Server/pulse)

## Files

 b079a65
## Breadcrumbs

1. [Knowage-Server](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd)
2. /[knowageutils](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils)
3. /[src](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src)
4. /[main](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main)
5. /[java](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java)
6. /[it](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it)
7. /[eng](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng)
8. /[spagobi](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi)
9. /[utilities](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities)
10. /[filters](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities/filters)
/
# XSSRequestWrapper.java

Copy path Blame  Blame
## Latest commit

## History

[History](/KnowageLabs/Knowage-Server/commits/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities/filters/XSSRequestWrapper.java)453 lines (353 loc) · 16.8 KB b079a65
## Breadcrumbs

1. [Knowage-Server](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd)
2. /[knowageutils](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils)
3. /[src](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src)
4. /[main](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main)
5. /[java](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java)
6. /[it](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it)
7. /[eng](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng)
8. /[spagobi](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi)
9. /[utilities](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities)
10. /[filters](/KnowageLabs/Knowage-Server/tree/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities/filters)
/
# XSSRequestWrapper.java

Top
## File metadata and controls

* Code
* Blame

453 lines (353 loc) · 16.8 KB[Raw](https://github.com/KnowageLabs/Knowage-Server/raw/b079a654c1708f82f6914c55be6715ad621d9edd/knowageutils/src/main/java/it/eng/spagobi/utilities/filters/XSSRequestWrapper.java)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453/\* \* Knowage, Open Source Business Intelligence suite \* Copyright (C) 2016 Engineering Ingegneria Informatica S.p.A. \* \* Knowage is free software: you can redistribute it and/or modify \* it under the terms of the GNU Affero General Public License as published by \* the Free Software Foundation, either version 3 of the License, or \* (at your option) any later version. \* \* Knowage is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \* GNU Affero General Public License for more details. \* \* You should have received a copy of the GNU Affero General Public License \* along with this program. If not, see <http://www.gnu.org/licenses/>. \*/package it.eng.spagobi.utilities.filters;
import java.io.IOException;import java.net.MalformedURLException;import java.net.URL;import java.util.Iterator;import java.util.List;import java.util.regex.Matcher;import java.util.regex.Pattern;
import javax.servlet.ServletInputStream;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletRequestWrapper;
import org.apache.commons.validator.UrlValidator;import org.apache.log4j.Logger;
import it.eng.spagobi.utilities.whitelist.WhiteList;
public class XSSRequestWrapper extends HttpServletRequestWrapper {
 private static transient Logger logger = Logger.getLogger(XSSRequestWrapper.class); private static WhiteList whitelist = WhiteList.INSTANCE;
 public XSSRequestWrapper(HttpServletRequest servletRequest) { super(servletRequest); }
 @Override public String[] getParameterValues(String parameter) { String[] values = super.getParameterValues(parameter);
 if (values == null) { return null; }
 int count = values.length; String[] encodedValues = new String[count]; for (int i = 0; i < count; i++) { encodedValues[i] = stripXSS(values[i]); }
 return encodedValues; }
 @Override public String getParameter(String parameter) { String value = super.getParameter(parameter);
 return stripXSS(value); }
 @Override public String getHeader(String name) { String value = super.getHeader(name); return stripXSS(value); }
 @Override public ServletInputStream getInputStream() throws IOException {
 return super.getInputStream(); }
 public static String stripXSS(String value) { logger.debug("IN"); String initialValue = value;
 if (value != null) { // NOTE: It's highly recommended to use the ESAPI library and uncomment the following line to // avoid encoded attacks. // value = ESAPI.encoder().canonicalize(value);
 // Avoid null characters value = value.replaceAll("", "");
 // Avoid anything between script tags Pattern scriptPattern = Pattern.compile("<script>(.\*?)</script>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 scriptPattern = Pattern.compile("&lt;script&gt;(.\*?)&lt;/script&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid anything in a src='...' type of expression // Pattern.compile("src[\r\n]\*=[\r\n]\*\\\'(.\*?)\\\'", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); // value = scriptPattern.matcher(value).replaceAll(""); // // scriptPattern = Pattern.compile("src[\r\n]\*=[\r\n]\*\\\"(.\*?)\\\"", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); // value = scriptPattern.matcher(value).replaceAll("");
 value = checkImgTags(value); value = checkIframeTags(value); value = checkAnchorTags(value); value = checkVideoTags(value); value = checkCSS(value);
 // Remove any lonesome </script> tag scriptPattern = Pattern.compile("</script>", Pattern.CASE\_INSENSITIVE); value = scriptPattern.matcher(value).replaceAll("");
 scriptPattern = Pattern.compile("&lt;/script&gt;", Pattern.CASE\_INSENSITIVE); value = scriptPattern.matcher(value).replaceAll("");
 // Remove any lonesome <script ...> tag scriptPattern = Pattern.compile("<script(.\*?)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 scriptPattern = Pattern.compile("&lt;script(.\*?)&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid eval(...) expressions scriptPattern = Pattern.compile("eval\\((.\*?)\\)", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid expression(...) expressions scriptPattern = Pattern.compile("expression\\((.\*?)\\)", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid javascript:... expressions scriptPattern = Pattern.compile("javascript:", Pattern.CASE\_INSENSITIVE); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid vbscript:... expressions scriptPattern = Pattern.compile("vbscript:", Pattern.CASE\_INSENSITIVE); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid onload= expressions scriptPattern = Pattern.compile("onload(.\*?)=", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid onClick= expressions scriptPattern = Pattern.compile("onClick(.\*?)=", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = scriptPattern.matcher(value).replaceAll("");
 // Avoid anything between form tags Pattern formPattern = Pattern.compile("<form(.\*?)</form>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = formPattern.matcher(value).replaceAll("");
 // Avoid anything between a tags // Pattern aPattern = Pattern.compile("<a(.\*?)</a>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); // value = aPattern.matcher(value).replaceAll("");
 // aPattern = Pattern.compile("<a(.\*?/)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); // value = aPattern.matcher(value).replaceAll("");
 Pattern aPattern = Pattern.compile("&lt;a(.\*?)&lt;/a&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = aPattern.matcher(value).replaceAll("");
 // Avoid anything between button tags Pattern buttonPattern = Pattern.compile("<button(.\*?)</button>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = buttonPattern.matcher(value).replaceAll("");
 buttonPattern = Pattern.compile("<button(.\*?/)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = buttonPattern.matcher(value).replaceAll("");
 buttonPattern = Pattern.compile("&lt;button(.\*?)&lt;/button&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = buttonPattern.matcher(value).replaceAll("");
 // Example value ="<object data=\"javascript:alert('XSS')\"></object>" // Avoid anything between script tags Pattern objectPattern = Pattern.compile("<object(.\*?)</object>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = objectPattern.matcher(value).replaceAll("");
 objectPattern = Pattern.compile("&lt;object(.\*?)&lt;/object&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = objectPattern.matcher(value).replaceAll("");
 // Remove any lonesome </object> tag objectPattern = Pattern.compile("</object>", Pattern.CASE\_INSENSITIVE); value = objectPattern.matcher(value).replaceAll("");
 objectPattern = Pattern.compile("&lt;/object&gt;", Pattern.CASE\_INSENSITIVE); value = objectPattern.matcher(value).replaceAll("");
 // Remove any lonesome <object ...> tag objectPattern = Pattern.compile("<object(.\*?/)>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = objectPattern.matcher(value).replaceAll("");
 objectPattern = Pattern.compile("&lt;object(.\*?/)&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = objectPattern.matcher(value).replaceAll("");
 if (!value.equalsIgnoreCase(initialValue)) { logger.warn("Message: detected a web attack through injection"); }
 }
 logger.debug("OUT"); return value; }
 private static String checkImgTags(String value) { logger.debug("IN"); Pattern maliciousImgPattern = Pattern.compile("&lt;img(.\*?)&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = maliciousImgPattern.matcher(value).replaceAll("");
 Pattern scriptPattern = Pattern.compile("<img[^>]+(src\\s\*=\\s\*['\"]([^'\"]+)['\"])[^>]\*>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Pattern dataPattern = Pattern.compile("data:image\\/(gif|jpeg|pjpeg|png|svg\\+xml|tiff|vnd\\.microsoft\\.icon);(utf-8;|utf8;)?base64", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Matcher scriptMatcher = scriptPattern.matcher(value);
 while (scriptMatcher.find()) { String img = scriptMatcher.group(); String link = scriptMatcher.group(2);
 Matcher dataMatcher = dataPattern.matcher(link);
 if (!dataMatcher.find()) { try { URL url = new URL(link); String baseUrl = url.getProtocol() + "://" + url.getHost();
 if (!whitelist.getExternalServices().contains(baseUrl)) { logger.warn("Provided image's src is: " + url + ". Image base url is not in Whitelist and therefore Image will be deleted"); value = value.replace(img, ""); }
 } catch (MalformedURLException e) { logger.debug("URL [" + link + "] is malformed. Trying to see if it is a valid relative URL..."); if (isValidRelativeURL(link) && isTrustedRelativePath(link)) { logger.debug("URL " + link + " is recognized to be a valid URL"); } else { logger.error("Malformed URL [" + link + "]", e); value = value.replace(img, ""); } }
 }
 }
 logger.debug("OUT"); return value; }
 private static String checkIframeTags(String value) { logger.debug("IN"); Pattern maliciousTagPattern = Pattern.compile("&lt;iframe(.\*?)iframe\\s\*&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = maliciousTagPattern.matcher(value).replaceAll("");
 Pattern scriptPattern = Pattern.compile("<iframe[^>]+(src\\s\*=\\s\*['\"]([^'\"]+)['\"])[^>](.+?)</iframe\\s\*>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Matcher scriptMatcher = scriptPattern.matcher(value);
 while (scriptMatcher.find()) { String iframe = scriptMatcher.group(); String link = scriptMatcher.group(2);
 try { URL url = new URL(link); String baseUrl = url.getProtocol() + "://" + url.getHost();
 if (!whitelist.getExternalServices().contains(baseUrl)) { logger.warn("Provided iframe's src is: " + url + ". Iframe base url is not in Whitelist and therefore iframe will be deleted"); value = value.replace(iframe, ""); }
 } catch (MalformedURLException e) { logger.debug("URL [" + link + "] is malformed. Trying to see if it is a valid relative URL..."); if (isValidRelativeURL(link) && isTrustedRelativePath(link)) { logger.debug("URL " + link + " is recognized to be a valid URL"); } else { logger.error("Malformed URL [" + link + "]", e); value = value.replace(iframe, ""); } }
 }
 logger.debug("OUT"); return value; }
 private static String checkAnchorTags(String value) { logger.debug("IN"); Pattern aPattern = Pattern.compile("<a([^>]+)>(.+?)</a>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Pattern hrefPattern = Pattern.compile("\\s\*href\\s\*=\\s\*['\"]([^'\"]+)['\"]", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL);
 Matcher aTagMatcher = aPattern.matcher(value);
 while (aTagMatcher.find()) { String aTag = aTagMatcher.group(); String href = aTagMatcher.group(1);
 // In <a> tag find href attribute Matcher hrefMatcher = hrefPattern.matcher(href);
 while (hrefMatcher.find()) { String link = hrefMatcher.group(1);
 try { URL url = new URL(link); String baseUrl = url.getProtocol() + "://" + url.getHost();
 if (!whitelist.getExternalServices().contains(baseUrl)) { logger.warn("Provided anchor's href is: " + url + ". Anchor base url is not in Whitelist and therefore anchor will be deleted"); value = value.replace(aTag, ""); }
 } catch (MalformedURLException e) { logger.debug("URL [" + link + "] is malformed. Trying to see if it is a valid relative URL..."); if (isValidRelativeURL(link) && isTrustedRelativePath(link)) { logger.debug("URL " + link + " is recognized to be a valid URL"); } else { logger.error("Malformed URL [" + link + "]", e); value = value.replace(aTag, ""); } } }
 }
 logger.debug("OUT"); return value; }
 private static String checkVideoTags(String value) { logger.debug("IN"); Pattern maliciousPattern = Pattern.compile("&lt;video(.\*?)video&gt;", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); value = maliciousPattern.matcher(value).replaceAll("");
 Pattern scriptPattern = Pattern.compile("<video(.+?)</video\\s\*>", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Pattern srcAttributePattern = Pattern.compile("\\s\*src\\s\*=\\s\*['\"]([^'\"]+)['\"]", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Matcher matcher = scriptPattern.matcher(value);
 while (matcher.find()) { String video = matcher.group(); String betweenVideoTags = matcher.group(1);
 Matcher srcMatcher = srcAttributePattern.matcher(betweenVideoTags);
 while (srcMatcher.find()) { String link = srcMatcher.group(1);
 try { URL url = new URL(link); String baseUrl = url.getProtocol() + "://" + url.getHost();
 if (!whitelist.getExternalServices().contains(baseUrl)) { logger.warn("Provided anchor's href is: " + url + ". Anchor base url is not in Whitelist and therefore anchor will be deleted"); value = value.replace(video, ""); }
 } catch (MalformedURLException e) { logger.debug("URL [" + link + "] is malformed. Trying to see if it is a valid relative URL..."); if (isValidRelativeURL(link) && isTrustedRelativePath(link)) { logger.debug("URL " + link + " is recognized to be a valid URL"); } else { logger.error("Malformed or untrusted URL [" + link + "]", e); value = value.replace(video, ""); } } }
 }
 logger.debug("OUT"); return value; }
 private static String checkCSS(String value) { logger.debug("IN"); Pattern cssUrlPattern = Pattern.compile("url\\s\*\\(['\"]?([^'\"\\)]+)['\"]?\\)", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Pattern cssUrlDataPattern = Pattern.compile("data:image\\/(gif|jpeg|pjpeg|png|svg\\+xml|tiff|vnd\\.microsoft\\.icon);(utf-8;)?base64", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); Pattern domElementID = Pattern.compile("(#[a-zA-Z0-9\\\_\\-]+)", Pattern.CASE\_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL); String domId = "";
 Matcher urlMatcher = cssUrlPattern.matcher(value);
 while (urlMatcher.find()) { String cssUrl = urlMatcher.group(); String link = urlMatcher.group(1);
 Matcher dataMatcher = cssUrlDataPattern.matcher(link); Matcher domIdMatcher = domElementID.matcher(link);
 if (domIdMatcher.find()) { domId = domIdMatcher.group(); if (domId.length() > 50) { logger.warn("Provided url attribute with Id is: " + domId + ". Its lenght is grater than 50 characters and therefore it will be delete"); value = value.replace(cssUrl, ""); } }
 if (!dataMatcher.find()) { try { URL url = new URL(link); String baseUrl = url.getProtocol() + "://" + url.getHost();
 if (!whitelist.getExternalServices().contains(baseUrl)) { logger.warn("Provided CSS url attribute is: " + url + ". Base url is not in Whitelist and therefore it will be deleted"); value = value.replace(cssUrl, ""); } } catch (MalformedURLException e) { logger.debug("URL [" + link + "] is malformed. Trying to see if it is a valid relative URL..."); if (isValidRelativeURL(link) && isTrustedRelativePath(link)) { logger.debug("URL " + link + " is recognized to be a valid URL"); } else if (link.equals(domId)) { return value; } else { logger.error("Malformed or untrusted URL [" + link + "]", e); value = value.replace(cssUrl, ""); } } }
 }
 logger.debug("OUT"); return value; }
 private static boolean isValidRelativeURL(String url) { String absoluteUrl = "http://mynonexistingserver.something.smt:99999" + url; UrlValidator urlValidator = new UrlValidator(); if (urlValidator.isValid(absoluteUrl)) { return true; } else { return false; } }
 private static boolean isTrustedRelativePath(String url) { List<String> relativePaths = whitelist.getRelativePaths(); Iterator<String> it = relativePaths.iterator();
 while (it.hasNext()) { if (url.startsWith(it.next())) { return true; } } return false; }
}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


