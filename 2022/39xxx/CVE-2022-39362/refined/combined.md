=== Content from github.com_7bd9f32f_20250114_230702.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetabase%2Fmetabase%2Fcommit%2Fb7c6bb905a9187347cfc9035443b514713027a5c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetabase%2Fmetabase%2Fcommit%2Fb7c6bb905a9187347cfc9035443b514713027a5c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=metabase%2Fmetabase)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[metabase](/metabase)
/
**[metabase](/metabase/metabase)**
Public

* [Notifications](/login?return_to=%2Fmetabase%2Fmetabase) You must be signed in to change notification settings
* [Fork
  5.2k](/login?return_to=%2Fmetabase%2Fmetabase)
* [Star
   39.4k](/login?return_to=%2Fmetabase%2Fmetabase)

* [Code](/metabase/metabase)
* [Issues
  4k](/metabase/metabase/issues)
* [Pull requests
  375](/metabase/metabase/pulls)
* [Actions](/metabase/metabase/actions)
* [Projects
  0](/metabase/metabase/projects)
* [Wiki](/metabase/metabase/wiki)
* [Security](/metabase/metabase/security)
* [Insights](/metabase/metabase/pulse)

Additional navigation options

* [Code](/metabase/metabase)
* [Issues](/metabase/metabase/issues)
* [Pull requests](/metabase/metabase/pulls)
* [Actions](/metabase/metabase/actions)
* [Projects](/metabase/metabase/projects)
* [Wiki](/metabase/metabase/wiki)
* [Security](/metabase/metabase/security)
* [Insights](/metabase/metabase/pulse)

## Commit

[Permalink](/metabase/metabase/commit/b7c6bb905a9187347cfc9035443b514713027a5c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Do not autorun ad-hoc native queries ([#25675](https://github.com/metabase/metabase/pull/25675)) ([#25732](https://github.com/metabase/metabase/pull/25732))

[Browse files](/metabase/metabase/tree/b7c6bb905a9187347cfc9035443b514713027a5c)
Browse the repository at this point in the history

* Loading branch information

[![@ranquild](https://avatars.githubusercontent.com/u/8542534?s=40&v=4)](/ranquild)

[ranquild](/metabase/metabase/commits?author=ranquild "View all commits by ranquild")
authored
Oct 3, 2022

1 parent
[9bcc704](/metabase/metabase/commit/9bcc704a34cbfe4f671700d66181014498970ff3)

commit b7c6bb9

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**121 additions**
and
**34 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* frontend

  + src/metabase/query\_builder/actions/core

    - frontend/src/metabase/query\_builder/actions/core/initializeQB.ts
      [initializeQB.ts](#diff-19880c5baad1b4f45b5c4bfe18f199882566ca35dfcbe3d545bb7924701e5e16)
    - frontend/src/metabase/query\_builder/actions/core/initializeQB.unit.spec.ts
      [initializeQB.unit.spec.ts](#diff-1fbc143e28c2515683572a56859b53bb47a7ef8f78bda32fe663f5a0574a17ed)
  + test

    - \_\_support\_\_/e2e/helpers

      * frontend/test/\_\_support\_\_/e2e/helpers/e2e-ad-hoc-question-helpers.js
        [e2e-ad-hoc-question-helpers.js](#diff-297f82a7472c5d85e6e1448601add09406a8a1359b4c288ddb534911ae4ce28a)
      * frontend/test/\_\_support\_\_/e2e/helpers/e2e-misc-helpers.js
        [e2e-misc-helpers.js](#diff-592a02dc2cb12e8d36d4c38052fb4b61336d164ebe6cffa85af3fcf9fba2b26a)
    - metabase/scenarios

      * native

        + frontend/test/metabase/scenarios/native/native.cy.spec.js
          [native.cy.spec.js](#diff-d9fbde4a4b582c9ebfca5bccfa37bfeaeedaaef802f29dc934c9dc622198156d)
      * permissions

        + frontend/test/metabase/scenarios/permissions/permissions-baseline.cy.spec.js
          [permissions-baseline.cy.spec.js](#diff-129f25e0ee9e2346b1b6d5974f13077c2c2c57ad5ea4279732830ae949ade16f)
      * visualizations/reproductions

        + frontend/test/metabase/scenarios/visualizations/reproductions/11727-cancel-native-query-shortcut.cy.spec.js
          [11727-cancel-native-query-shortcut.cy.spec.js](#diff-1d087793387d5d8978bccb350d8c4eb7057e83e12c437013142dbbc17a2d920a)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[frontend/src/metabase/query\_builder/actions/core/initializeQB.ts](#diff-19880c5baad1b4f45b5c4bfe18f199882566ca35dfcbe3d545bb7924701e5e16 "frontend/src/metabase/query_builder/actions/core/initializeQB.ts")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/src/metabase/query_builder/actions/core/initializeQB.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -306,7 +306,7 @@ async function handleQBInit( |
|  |  | }); |
|  |  |  |
|  |  | if (uiControls.queryBuilderMode !== "notebook") { |
|  |  | if (question.canRun()) { |
|  |  | if (question.canRun() && (question.isSaved() || question.isStructured())) { |
|  |  | // Timeout to allow Parameters widget to set parameterValues |
|  |  | setTimeout( |
|  |  | () => dispatch(runQuestionQuery({ shouldUpdateUrl: false })), |
| Expand Down | |  |

33 changes: 26 additions & 7 deletions

33
[frontend/src/metabase/query\_builder/actions/core/initializeQB.unit.spec.ts](#diff-1fbc143e28c2515683572a56859b53bb47a7ef8f78bda32fe663f5a0574a17ed "frontend/src/metabase/query_builder/actions/core/initializeQB.unit.spec.ts")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/src/metabase/query_builder/actions/core/initializeQB.unit.spec.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,4 @@ |
|  |  | import { LocationDescriptorObject } from "history"; |
|  |  | import \_ from "underscore"; |
|  |  | import xhrMock from "xhr-mock"; |
|  |  |  |
|  |  | import \* as CardLib from "metabase/lib/card"; |
| Expand Down  Expand Up | | @@ -248,12 +247,6 @@ describe("QB Actions > initializeQB", () => { |
|  |  | ); |
|  |  | }); |
|  |  |  |
|  |  | it("runs question query in view mode", async () => { |
|  |  | const runQuestionQuerySpy = jest.spyOn(querying, "runQuestionQuery"); |
|  |  | await setup({ question }); |
|  |  | expect(runQuestionQuerySpy).toHaveBeenCalledTimes(1); |
|  |  | }); |
|  |  |  |
|  |  | it("does not run non-runnable question queries", async () => { |
|  |  | const runQuestionQuerySpy = jest.spyOn(querying, "runQuestionQuery"); |
|  |  | jest.spyOn(Question.prototype, "canRun").mockReturnValue(false); |
| Expand Down  Expand Up | | @@ -405,6 +398,12 @@ describe("QB Actions > initializeQB", () => { |
|  |  | ), |
|  |  | ); |
|  |  | }); |
|  |  |  |
|  |  | it("runs question query in view mode", async () => { |
|  |  | const runQuestionQuerySpy = jest.spyOn(querying, "runQuestionQuery"); |
|  |  | await setup({ question }); |
|  |  | expect(runQuestionQuerySpy).toHaveBeenCalledTimes(1); |
|  |  | }); |
|  |  | }); |
|  |  | }); |
|  |  | }); |
| Expand Down  Expand Up | | @@ -506,6 +505,26 @@ describe("QB Actions > initializeQB", () => { |
|  |  | }); |
|  |  | }); |
|  |  |  |
|  |  | describe("unsaved structured questions", () => { |
|  |  | const { question } = TEST\_CASE.SAVED\_STRUCTURED\_QUESTION; |
|  |  |  |
|  |  | it("runs question query in view mode", async () => { |
|  |  | const runQuestionQuerySpy = jest.spyOn(querying, "runQuestionQuery"); |
|  |  | await setup({ question }); |
|  |  | expect(runQuestionQuerySpy).toHaveBeenCalledTimes(1); |
|  |  | }); |
|  |  | }); |
|  |  |  |
|  |  | describe("unsaved native questions", () => { |
|  |  | const { question } = TEST\_CASE.UNSAVED\_NATIVE\_QUESTION; |
|  |  |  |
|  |  | it("doesn't run an ad-hoc native question in view mode automatically", async () => { |
|  |  | const runQuestionQuerySpy = jest.spyOn(querying, "runQuestionQuery"); |
|  |  | await setup({ question }); |
|  |  | expect(runQuestionQuerySpy).not.toHaveBeenCalled(); |
|  |  | }); |
|  |  | }); |
|  |  |  |
|  |  | describe("models", () => { |
|  |  | MODEL\_TEST\_CASES.forEach(testCase => { |
|  |  | const { question, questionType } = testCase; |
| Expand Down | |  |

41 changes: 31 additions & 10 deletions

41
[frontend/test/\_\_support\_\_/e2e/helpers/e2e-ad-hoc-question-helpers.js](#diff-297f82a7472c5d85e6e1448601add09406a8a1359b4c288ddb534911ae4ce28a "frontend/test/__support__/e2e/helpers/e2e-ad-hoc-question-helpers.js")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/test/__support__/e2e/helpers/e2e-ad-hoc-question-helpers.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,5 @@ |
|  |  | import { SAMPLE\_DB\_ID, SAMPLE\_DB\_TABLES } from "\_\_support\_\_/e2e/cypress\_data"; |
|  |  | import { runNativeQuery } from "\_\_support\_\_/e2e/helpers/e2e-misc-helpers"; |
|  |  |  |
|  |  | const { |
|  |  | STATIC\_ORDERS\_ID, |
| Expand Down  Expand Up | | @@ -41,18 +42,21 @@ export function startNewQuestion() { |
|  |  | \* @param {object} question |
|  |  | \* @param {{callback: function, mode: (undefined|"notebook")}} config |
|  |  | \*/ |
|  |  | export function visitQuestionAdhoc(question, { callback, mode } = {}) { |
|  |  | export function visitQuestionAdhoc( |
|  |  | question, |
|  |  | { callback, mode, autorun = true } = {}, |
|  |  | ) { |
|  |  | const questionMode = mode === "notebook" ? "/notebook" : ""; |
|  |  |  |
|  |  | const [url, alias] = getInterceptDetails(question, mode); |
|  |  | const [url, alias] = getInterceptDetails(question, mode, autorun); |
|  |  |  |
|  |  | cy.intercept(url).as(alias); |
|  |  |  |
|  |  | cy.visit(`/question${questionMode}#` + adhocQuestionHash(question)); |
|  |  |  |
|  |  | cy.wait("@" + alias).then(xhr => { |
|  |  | callback && callback(xhr); |
|  |  | }); |
|  |  | runQueryIfNeeded(question, autorun); |
|  |  |  |
|  |  | cy.wait("@" + alias).then(xhr => callback && callback(xhr)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -98,18 +102,25 @@ export function openReviewsTable({ mode, limit, callback } = {}) { |
|  |  | return openTable({ table: STATIC\_REVIEWS\_ID, mode, limit, callback }); |
|  |  | } |
|  |  |  |
|  |  | function getInterceptDetails(question, mode) { |
|  |  | function getInterceptDetails(question, mode, autorun) { |
|  |  | const { |
|  |  | display, |
|  |  | dataset\_query: { type }, |
|  |  | } = question; |
|  |  |  |
|  |  | // When visiting notebook mode directly, we don't render any results to the page. |
|  |  | // Therefore, there is no `dataset` to wait for. |
|  |  | // But we need to make sure the schema for our database is loaded before we can proceed. |
|  |  | if (mode === "notebook") { |
|  |  | return [`/api/database/${SAMPLE\_DB\_ID}/schema/PUBLIC`, "publicSchema"]; |
|  |  | } |
|  |  |  |
|  |  | const { |
|  |  | display, |
|  |  | dataset\_query: { type }, |
|  |  | } = question; |
|  |  | // Ad-hoc native queries are not autorun by default. |
|  |  | // Therefore, there is no `dataset` to wait for. |
|  |  | // We need to make sure data for the native query builder has loaded before we can proceed. |
|  |  | if (type === "native" && !autorun) { |
|  |  | return ["/api/native-query-snippet", "snippets"]; |
|  |  | } |
|  |  |  |
|  |  | // native queries should use the normal dataset endpoint even when set to pivot |
|  |  | const isPivotEndpoint = display === "pivot" && type === "query"; |
| Expand All | | @@ -119,3 +130,13 @@ function getInterceptDetails(question, mode) { |
|  |  |  |
|  |  | return [url, alias]; |
|  |  | } |
|  |  |  |
|  |  | function runQueryIfNeeded(question, autorun) { |
|  |  | const { |
|  |  | dataset\_query: { type }, |
|  |  | } = question; |
|  |  |  |
|  |  | if (type === "native" && autorun) { |
|  |  | runNativeQuery({ wait: false }); |
|  |  | } |
|  |  | } |

10 changes: 7 additions & 3 deletions

10
[frontend/test/\_\_support\_\_/e2e/helpers/e2e-misc-helpers.js](#diff-592a02dc2cb12e8d36d4c38052fb4b61336d164ebe6cffa85af3fcf9fba2b26a "frontend/test/__support__/e2e/helpers/e2e-misc-helpers.js")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/test/__support__/e2e/helpers/e2e-misc-helpers.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -40,11 +40,15 @@ export function openNativeEditor({ |
|  |  | /\*\* |
|  |  | \* Executes native query and waits for the results to load. |
|  |  | \* Makes sure that the question is not "dirty" after the query successfully ran. |
|  |  | \* @param {string} [xhrAlias ="dataset"] |
|  |  | \*/ |
|  |  | export function runNativeQuery(xhrAlias = "dataset") { |
|  |  | export function runNativeQuery({ wait = true } = {}) { |
|  |  | cy.intercept("POST", "api/dataset").as("dataset"); |
|  |  | cy.get(".NativeQueryEditor .Icon-play").click(); |
|  |  | cy.wait("@" + xhrAlias); |
|  |  |  |
|  |  | if (wait) { |
|  |  | cy.wait("@dataset"); |
|  |  | } |
|  |  |  |
|  |  | cy.icon("play").should("not.exist"); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[frontend/test/metabase/scenarios/native/native.cy.spec.js](#diff-d9fbde4a4b582c9ebfca5bccfa37bfeaeedaaef802f29dc934c9dc622198156d "frontend/test/metabase/scenarios/native/native.cy.spec.js")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/test/metabase/scenarios/native/native.cy.spec.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -262,4 +262,22 @@ describe("scenarios > question > native", () => { |
|  |  | .and("eq", `/question/${questionId}-test-question`); |
|  |  | }); |
|  |  | }); |
|  |  |  |
|  |  | it("should not autorun ad-hoc native queries by default", () => { |
|  |  | visitQuestionAdhoc( |
|  |  | { |
|  |  | display: "scalar", |
|  |  | dataset\_query: { |
|  |  | type: "native", |
|  |  | native: { |
|  |  | query: "SELECT 1", |
|  |  | }, |
|  |  | database: SAMPLE\_DB\_ID, |
|  |  | }, |
|  |  | }, |
|  |  | { autorun: false }, |
|  |  | ); |
|  |  |  |
|  |  | cy.findByText("Here's where your results will appear").should("be.visible"); |
|  |  | }); |
|  |  | }); |

49 changes: 36 additions & 13 deletions

49
[frontend/test/metabase/scenarios/permissions/permissions-baseline.cy.spec.js](#diff-129f25e0ee9e2346b1b6d5974f13077c2c2c57ad5ea4279732830ae949ade16f "frontend/test/metabase/scenarios/permissions/permissions-baseline.cy.spec.js")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/test/metabase/scenarios/permissions/permissions-baseline.cy.spec.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,35 +1,51 @@ |
|  |  | import { restore, visitQuestion } from "\_\_support\_\_/e2e/helpers"; |
|  |  | import { |
|  |  | restore, |
|  |  | visitQuestion, |
|  |  | visitQuestionAdhoc, |
|  |  | } from "\_\_support\_\_/e2e/helpers"; |
|  |  | import { SAMPLE\_DB\_ID } from "\_\_support\_\_/e2e/cypress\_data"; |
|  |  |  |
|  |  | describe("scenarios > permissions", () => { |
|  |  | beforeEach(restore); |
|  |  |  |
|  |  | const PATHS = [ |
|  |  | "/dashboard/1", |
|  |  | "/question/1", |
|  |  | "/collection/1", |
|  |  | "/admin", |
|  |  | // this url is a native query pointing at the sample db |
|  |  | "/question#eyJkYXRhc2V0X3F1ZXJ5Ijp7InR5cGUiOiJuYXRpdmUiLCJuYXRpdmUiOnsicXVlcnkiOiJzZWxlY3QgMSIsInRlbXBsYXRlLXRhZ3MiOnt9fSwiZGF0YWJhc2UiOjF9LCJkaXNwbGF5IjoidGFibGUiLCJ2aXN1YWxpemF0aW9uX3NldHRpbmdzIjp7fX0=", |
|  |  | ]; |
|  |  | const PATHS = ["/dashboard/1", "/question/1", "/collection/1", "/admin"]; |
|  |  |  |
|  |  | for (const path of PATHS) { |
|  |  | it(`should display the permissions screen on ${path}`, () => { |
|  |  | cy.signIn("none"); |
|  |  | cy.visit(path); |
|  |  | cy.icon("key"); |
|  |  | cy.contains("Sorry, you don’t have permission to see that."); |
|  |  | checkUnauthorized(); |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | it("should not allow to run adhoc native questions without permissions", () => { |
|  |  | cy.signIn("none"); |
|  |  |  |
|  |  | visitQuestionAdhoc( |
|  |  | { |
|  |  | display: "scalar", |
|  |  | dataset\_query: { |
|  |  | type: "native", |
|  |  | native: { |
|  |  | query: "SELECT 1", |
|  |  | }, |
|  |  | database: SAMPLE\_DB\_ID, |
|  |  | }, |
|  |  | }, |
|  |  | { autorun: false }, |
|  |  | ); |
|  |  |  |
|  |  | cy.findAllByRole("button", { name: "refresh icon" }).should("be.disabled"); |
|  |  | }); |
|  |  |  |
|  |  | // There's no pulse in the fixture data, so we stub out the api call to |
|  |  | // replace the 404 with a 403. |
|  |  | it("should display the permissions screen for pulses", () => { |
|  |  | cy.signIn("none"); |
|  |  | cy.server(); |
|  |  | cy.route({ url: /\/api\/pulse\/1/, status: 403, response: {} }); |
|  |  | cy.visit("/pulse/1"); |
|  |  | cy.icon("key"); |
|  |  | cy.contains("Sorry, you don’t have permission to see that."); |
|  |  | checkUnauthorized(); |
|  |  | }); |
|  |  |  |
|  |  | it("should let a user with no data permissions view questions", () => { |
| Expand All | | @@ -38,3 +54,10 @@ describe("scenarios > permissions", () => { |
|  |  | cy.contains("February 11, 2019, 9:40 PM"); // check that the data loads |
|  |  | }); |
|  |  | }); |
|  |  |  |
|  |  | const checkUnauthorized = () => { |
|  |  | cy.icon("key").should("be.visible"); |
|  |  | cy.findByText("Sorry, you don’t have permission to see that.").should( |
|  |  | "be.visible", |
|  |  | ); |
|  |  | }; |

2 changes: 2 additions & 0 deletions

2
[...base/scenarios/visualizations/reproductions/11727-cancel-native-query-shortcut.cy.spec.js](#diff-1d087793387d5d8978bccb350d8c4eb7057e83e12c437013142dbbc17a2d920a "frontend/test/metabase/scenarios/visualizations/reproductions/11727-cancel-native-query-shortcut.cy.spec.js")

Show comments

[View file](/metabase/metabase/blob/b7c6bb905a9187347cfc9035443b514713027a5c/frontend/test/metabase/scenarios/visualizations/reproductions/11727-cancel-native-query-shortcut.cy.spec.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ import { |
|  |  | restore, |
|  |  | withDatabase, |
|  |  | adhocQuestionHash, |
|  |  | runNativeQuery, |
|  |  | } from "\_\_support\_\_/e2e/helpers"; |
|  |  |  |
|  |  | const PG\_DB\_ID = 2; |
| Expand All | | @@ -28,6 +29,7 @@ describe("issue 11727", () => { |
|  |  | cy.visit(`/question#` + adhocQuestionHash(questionDetails)); |
|  |  | cy.wait("@getDatabases"); |
|  |  |  |
|  |  | runNativeQuery({ wait: false }); |
|  |  | cy.findByText("Doing science...").should("be.visible"); |
|  |  | cy.get("body").type("{cmd}{enter}"); |
|  |  | cy.findByText("Here's where your results will appear").should( |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b7c6bb9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetabase%2Fmetabase%2Fcommit%2Fb7c6bb905a9187347cfc9035443b514713027a5c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_08f0d7cd_20250114_230703.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetabase%2Fmetabase%2Fsecurity%2Fadvisories%2FGHSA-93wj-fgjg-r238)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetabase%2Fmetabase%2Fsecurity%2Fadvisories%2FGHSA-93wj-fgjg-r238)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=metabase%2Fmetabase)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[metabase](/metabase)
/
**[metabase](/metabase/metabase)**
Public

* [Notifications](/login?return_to=%2Fmetabase%2Fmetabase) You must be signed in to change notification settings
* [Fork
  5.2k](/login?return_to=%2Fmetabase%2Fmetabase)
* [Star
   39.4k](/login?return_to=%2Fmetabase%2Fmetabase)

* [Code](/metabase/metabase)
* [Issues
  4k](/metabase/metabase/issues)
* [Pull requests
  375](/metabase/metabase/pulls)
* [Actions](/metabase/metabase/actions)
* [Projects
  0](/metabase/metabase/projects)
* [Wiki](/metabase/metabase/wiki)
* [Security](/metabase/metabase/security)
* [Insights](/metabase/metabase/pulse)

Additional navigation options

* [Code](/metabase/metabase)
* [Issues](/metabase/metabase/issues)
* [Pull requests](/metabase/metabase/pulls)
* [Actions](/metabase/metabase/actions)
* [Projects](/metabase/metabase/projects)
* [Wiki](/metabase/metabase/wiki)
* [Security](/metabase/metabase/security)
* [Insights](/metabase/metabase/pulse)

# Arbitrary SQL execution from queryhash

High

[ranquild](/ranquild)
published
GHSA-93wj-fgjg-r238
Oct 24, 2022

## Package

Metabase OSS and Enterprise
(Metabase)

## Affected versions

<x.44.5,<x.43.7,<x.42.6,<x.41.9

## Patched versions

0.44.5,1.44.5,0.43.7,1.43.7,0.42.6,1.42.6,0.41.9,1.41.9

## Description

### Impact

Unsaved SQL queries are auto-executed, which could pose a possible attack vector.

### Patches

The following patches (or greater versions) are available:

* 0.44.5 and 1.44.5,
* 0.43.7 and 1.43.7,
* 0.42.6 and 1.42.6,
* 0.41.9 and 1.41.9

All releases are available on <https://github.com/metabase/metabase/releases>.

### Mitigation

Metabase no longer automatically execute ad-hoc native queries. Now the native editor is showing the query and giving the user the option to manually run the query if they want.

### Credits

Reported by <https://github.com/abrahack> via security@ email.

### Severity

High

### CVE ID

CVE-2022-39362

### Weaknesses

[CWE-356](/advisories?query=cwe%3A356)

### Credits

* [![@abrahack](https://avatars.githubusercontent.com/u/60686536?s=40&v=4)](/abrahack)
  [abrahack](/abrahack)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


