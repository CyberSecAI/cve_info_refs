=== Content from github.com_ee1ce46b_20250114_191350.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Fcommit%2F5ca86c328a5faaab429c240551cb9ca8f0f6262c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Fcommit%2F5ca86c328a5faaab429c240551cb9ca8f0f6262c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fmatrix-ios-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-ios-sdk](/matrix-org/matrix-ios-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk) You must be signed in to change notification settings
* [Fork
  216](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk)
* [Star
   453](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk)

* [Code](/matrix-org/matrix-ios-sdk)
* [Issues
  143](/matrix-org/matrix-ios-sdk/issues)
* [Pull requests
  25](/matrix-org/matrix-ios-sdk/pulls)
* [Actions](/matrix-org/matrix-ios-sdk/actions)
* [Projects
  0](/matrix-org/matrix-ios-sdk/projects)
* [Security](/matrix-org/matrix-ios-sdk/security)
* [Insights](/matrix-org/matrix-ios-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-ios-sdk)
* [Issues](/matrix-org/matrix-ios-sdk/issues)
* [Pull requests](/matrix-org/matrix-ios-sdk/pulls)
* [Actions](/matrix-org/matrix-ios-sdk/actions)
* [Projects](/matrix-org/matrix-ios-sdk/projects)
* [Security](/matrix-org/matrix-ios-sdk/security)
* [Insights](/matrix-org/matrix-ios-sdk/pulse)

## Commit

[Permalink](/matrix-org/matrix-ios-sdk/commit/5ca86c328a5faaab429c240551cb9ca8f0f6262c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Resolve multiple CVEs

[Browse files](/matrix-org/matrix-ios-sdk/tree/5ca86c328a5faaab429c240551cb9ca8f0f6262c)
Browse the repository at this point in the history

```
CVE-2022-39255
CVE-2022-39257
```

* Loading branch information

[![@Anderas](https://avatars.githubusercontent.com/u/3922159?s=40&v=4)](/Anderas)

[Anderas](/matrix-org/matrix-ios-sdk/commits?author=Anderas "View all commits by Anderas")
committed
Sep 28, 2022

1 parent
[bacba64](/matrix-org/matrix-ios-sdk/commit/bacba649c06a2085fde019692ec1d687828c4df6)

commit 5ca86c3

 Show file tree

 Hide file tree

Showing
**44 changed files**
with
**2,396 additions**
and
**199 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGES.md
  [CHANGES.md](#diff-d975bf659606195d2165918f93e1cf680ef68ea3c9cab994f033705fea8238b2)
* MatrixSDK.xcodeproj

  + MatrixSDK.xcodeproj/project.pbxproj
    [project.pbxproj](#diff-22fcddf1be6d1df30fb6844581132691b0334c4df91c6f8f7236d76e922eae6b)
* MatrixSDK

  + Background

    - MatrixSDK/Background/MXBackgroundSyncService.swift
      [MXBackgroundSyncService.swift](#diff-3b283cda7d4e8f4f3c7494f029411e54ccf1f61d2dc5beeb59bec7ffd7b2eff3)
  + Contrib/Swift/JSONModels

    - MatrixSDK/Contrib/Swift/JSONModels/MXEvent.swift
      [MXEvent.swift](#diff-b6639e4e37c5f97c0c45a1b2b813501d5ba9a608e35ad878ef7cb76add7b3d1b)
  + Crypto

    - Algorithms

      * MatrixSDK/Crypto/Algorithms/MXDecrypting.h
        [MXDecrypting.h](#diff-ebee111891e9feb28dca2264da8e436d3535f57901ca9b858c13c82cbd7e85ca)
      * Megolm

        + MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmDecryption.m
          [MXMegolmDecryption.m](#diff-b240f4b5bb84038e17247600bbba3add55b57d7ea0a2281c752f19049675ac38)
        + MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmEncryption.m
          [MXMegolmEncryption.m](#diff-b012b6eda02e8b3b6cd09f6956cbb49be875c1e596cd34b85038dce53990952f)
      * Olm

        + MatrixSDK/Crypto/Algorithms/Olm/MXOlmDecryption.m
          [MXOlmDecryption.m](#diff-6d14da6249c47ec3e2dee6d17d339c3263c45ec649b4292b944bdc476c71e547)
    - KeyBackup

      * Data

        + MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.h
          [MXKeyBackupVersionTrust.h](#diff-f4be22a7e259a51aaad751b48d53895e918e055d5b8c1adc6ade79666c01183c)
        + MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.m
          [MXKeyBackupVersionTrust.m](#diff-a340dab1b82c80bcd265587d213d323cccfe3194d975f54d81b0e1fc7a432cc2)
      * MatrixSDK/Crypto/KeyBackup/MXKeyBackup.m
        [MXKeyBackup.m](#diff-203f8cad1d6f376311c83844c1a547eed31b23e1e7a37afe3b168ca617369c22)
    - KeySharing

      * Data

        + MatrixSDK/Crypto/KeySharing/Data/MXForwardedRoomKeyEventContent.h
          [MXForwardedRoomKeyEventContent.h](#diff-bfd2c9b7e249e612803522bd9385ced258484ccf136dfa90a65507ddf9e708b6)
        + MatrixSDK/Crypto/KeySharing/Data/MXForwardedRoomKeyEventContent.m
          [MXForwardedRoomKeyEventContent.m](#diff-e79949fc5a52b77428ebd85637d4d32b490dc63c89d100183c874aee938a5545)
        + MatrixSDK/Crypto/KeySharing/Data/MXRoomKeyEventContent.h
          [MXRoomKeyEventContent.h](#diff-74ea7aeeb4d126d0385a6356a48b2573a648e8a73cc566f228645c7bb3988722)
        + MatrixSDK/Crypto/KeySharing/Data/MXRoomKeyEventContent.m
          [MXRoomKeyEventContent.m](#diff-aa9669ecdc2be1e0e57a65415caaa43eef3fd664458f973c1d4ba96b490b5eb7)
      * MatrixSDK/Crypto/KeySharing/MXUnrequestedForwardedRoomKeyManager.swift
        [MXUnrequestedForwardedRoomKeyManager.swift](#diff-8b15baa911afa7d07640446483219110bea24275dede81849fb6ab163c336cec)
      * Secret

        + MatrixSDK/Crypto/KeySharing/Secret/MXSecretShareManager.m
          [MXSecretShareManager.m](#diff-36ca6c371fd6bdbba90742718cf075120aff5727d7c8f8747ad7d41ff5225bd0)
    - MatrixSDK/Crypto/MXCrypto.m
      [MXCrypto.m](#diff-759d2c0d623acdce7b33931354bea30236e50885de05f3625aa1a9f6796a3505)
    - MatrixSDK/Crypto/MXCrypto\_Private.h
      [MXCrypto\_Private.h](#diff-8b66acf350c1dd70e3c28c7160cd443661e7ae628ed659e84854ba1d52c643d5)
    - MatrixSDK/Crypto/MXOlmDevice.h
      [MXOlmDevice.h](#diff-aa93ffaa796c2e6eabf034ce638024aebb7bcdd1d928bc3e189cecb27b7cd845)
    - MatrixSDK/Crypto/MXOlmDevice.m
      [MXOlmDevice.m](#diff-f944bde955c509f37f9c5fa41820825d11ebf3910ae9d05d0cea663e924b4d48)
    - RoomKeys

      * MatrixSDK/Crypto/RoomKeys/MXRoomKeyInfo.swift
        [MXRoomKeyInfo.swift](#diff-cba3020c3213de31b4cf6ceb8795c6a8ed777920b73992a9cfea069a435926aa)
      * MatrixSDK/Crypto/RoomKeys/MXRoomKeyInfoFactory.swift
        [MXRoomKeyInfoFactory.swift](#diff-a055cbc45b73097608146b9b8e85dd381cfe757f3bc6e17b6be30d8027975552)
      * MatrixSDK/Crypto/RoomKeys/MXRoomKeyResult.swift
        [MXRoomKeyResult.swift](#diff-2947e9351d845fe12c8f06df9fab75b13bb32cee7dd2eb1aa9235d1348493b17)
    - Verification/Transactions/SAS

      * MatrixSDK/Crypto/Verification/Transactions/SAS/MXSASTransaction.m
        [MXSASTransaction.m](#diff-63ff3bd3d824311774ad5e546352f67bc86a342d568fd63e275d6bd79712a409)
  + MatrixSDK/MXSession.m
    [MXSession.m](#diff-480363b404ebe0778edd253e1f353db5b0476b367fc5f986440f7814ec79912e)
  + MatrixSDK/MatrixSDK.h
    [MatrixSDK.h](#diff-fd801882a929fe238a2c7410cb02abdb8e30fbb9c23df01153f4490be1cf0a2b)
  + Utils

    - Categories

      * MatrixSDK/Utils/Categories/Dictionary.swift
        [Dictionary.swift](#diff-7210e6f508ddb5ac4dfd8c25cf99d07fc578f0be128794741647f3759a117273)
    - MatrixSDK/Utils/MXDateProvider.swift
      [MXDateProvider.swift](#diff-518df0ced8b8276ed215473a1b111d071a0874c567d70aa8f9dafa715174fab2)
    - MatrixSDK/Utils/MXLRUCache.m
      [MXLRUCache.m](#diff-1e886845d1e3ffa48c9b2e2c1aab80478e6be14d97422afce50b8af982223dc7)
    - MatrixSDK/Utils/MXTools.swift
      [MXTools.swift](#diff-ec38bcd2396203f8756352c6a2472848a23f578cc17de2b4173e996c9345e12e)
* MatrixSDKTests

  + Crypto

    - Algorithms/Megolm

      * MatrixSDKTests/Crypto/Algorithms/Megolm/MXMegolmDecryptionUnitTests.swift
        [MXMegolmDecryptionUnitTests.swift](#diff-15454743b196b9454459bae931055404ee1913cfe219eb8aba42d6cf95fd558a)
    - Data/Store

      * MatrixSDKTests/Crypto/Data/Store/MXMemoryCryptoStore.swift
        [MXMemoryCryptoStore.swift](#diff-c79796953aecf6614bfa8227c00d4ceb86a3157e00f46bba5993c994a51037b7)
    - KeySharing

      * Data

        + MatrixSDKTests/Crypto/KeySharing/Data/MXForwardedRoomKeyEventContentUnitTests.swift
          [MXForwardedRoomKeyEventContentUnitTests.swift](#diff-20f251e32e327a6ac2c3f77427004b2470292eb42ce27621fa01b1a644cd831f)
        + MatrixSDKTests/Crypto/KeySharing/Data/MXRoomKeyEventContentUnitTests.swift
          [MXRoomKeyEventContentUnitTests.swift](#diff-6de0a49b33e13a1ac2d6e511e3d9673a7d86d2a12c965748ca0d5323cc78df63)
      * MatrixSDKTests/Crypto/KeySharing/MXUnrequestedForwardedRoomKeyManagerUnitTests.swift
        [MXUnrequestedForwardedRoomKeyManagerUnitTests.swift](#diff-128558502fafaa588cf63bbc8c4a4fdb8872f171bb5c00a9ca69714a70524a40)
    - MatrixSDKTests/Crypto/MXOlmDeviceUnitTests.swift
      [MXOlmDeviceUnitTests.swift](#diff-ec2c3307ca591e1d147e76778a6ecb531b966d9a099c6caa2cf646954705ae3d)
    - RoomKeys

      * MatrixSDKTests/Crypto/RoomKeys/MXRoomKeyInfoFactoryUnitTests.swift
        [MXRoomKeyInfoFactoryUnitTests.swift](#diff-281ee01f5f9c02c71402d4ab99b750bfc15ed688ed91bd6d1a6de5d6d8a4540b)
  + JSONModels

    - MatrixSDKTests/JSONModels/MXEventFixtures.swift
      [MXEventFixtures.swift](#diff-f905b9faabe012897569bac8cb84bb68743520acea42569d0aa2a579f469d322)
  + MatrixSDKTests/MXCryptoSecretShareTests.m
    [MXCryptoSecretShareTests.m](#diff-d31b03ccf54c8ad773faed65b4c9d8385ca9040365c9c0583754bfb39617291d)
  + MatrixSDKTests/MXCryptoTests.m
    [MXCryptoTests.m](#diff-c68a0a04ecb089a9fb727895d9bd9e85899d3c26f2fb321783b4ce30474d2129)
  + MatrixSDKTests/MXToolsUnitTests.m
    [MXToolsUnitTests.m](#diff-285f300e54c9c075c198b8b037213f1a28bdb89bcaa114faac1cfa6fd06a4022)
  + TestPlans

    - MatrixSDKTests/TestPlans/UnitTests.xctestplan
      [UnitTests.xctestplan](#diff-1e6a7c76fe72353953f97f373f575caeee0ca50bd6cc8da9fa68e937890f6ffb)
    - MatrixSDKTests/TestPlans/UnitTestsWithSanitizers.xctestplan
      [UnitTestsWithSanitizers.xctestplan](#diff-0ee8b68a4ea8fce14d305ab0cd677aa60e2f9f92d5f917abca1274c1fbe53ffd)

## There are no files selected for viewing

7 changes: 7 additions & 0 deletions

7
[CHANGES.md](#diff-d975bf659606195d2165918f93e1cf680ef68ea3c9cab994f033705fea8238b2 "CHANGES.md")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/CHANGES.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -1,3 +1,10 @@ |
|  |  | ## Changes in 0.23.19 (2022-09-28) |
|  |  |  |
|  |  | 🐛 Bugfixes |
|  |  |  |
|  |  | - CVE-2022-39255: Olm/Megolm protocol confusion ([Security advisory](https://github.com/matrix-org/matrix-ios-sdk/security/advisories/GHSA-hw6g-j8v6-9hcm)) |
|  |  | - CVE-2022-39257: Impersonation via forwarded Megolm sessions ([Security advisory](https://github.com/matrix-org/matrix-ios-sdk/security/advisories/GHSA-qxr3-5jmq-xcf4)) |
|  |  |  |
|  |  | ## Changes in 0.23.18 (2022-09-07) |
|  |  |  |
|  |  | ✨ Features |
| Expand Down | |  |

122 changes: 122 additions & 0 deletions

122
[MatrixSDK.xcodeproj/project.pbxproj](#diff-22fcddf1be6d1df30fb6844581132691b0334c4df91c6f8f7236d76e922eae6b "MatrixSDK.xcodeproj/project.pbxproj")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK.xcodeproj/project.pbxproj)
Edit file

Delete file

Load diff

Large diffs are not rendered by default.

Oops, something went wrong.

Retry

76 changes: 28 additions & 48 deletions

76
[MatrixSDK/Background/MXBackgroundSyncService.swift](#diff-3b283cda7d4e8f4f3c7494f029411e54ccf1f61d2dc5beeb59bec7ffd7b2eff3 "MatrixSDK/Background/MXBackgroundSyncService.swift")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Background/MXBackgroundSyncService.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -564,6 +564,12 @@ public enum MXBackgroundSyncServiceError: Error { |
|  |  | } |
|  |  |  |
|  |  | private func handleToDeviceEvent(\_ event: MXEvent) { |
|  |  | // only handle supported events |
|  |  | guard MXTools.isSupportedToDeviceEvent(event) else { |
|  |  | MXLog.debug("[MXBackgroundSyncService] handleToDeviceEvent: ignore unsupported event") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | if event.isEncrypted { |
|  |  | do { |
|  |  | try decryptEvent(event) |
| Expand All | | @@ -573,61 +579,35 @@ public enum MXBackgroundSyncServiceError: Error { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | guard let content = event.content else { |
|  |  | MXLog.debug("[MXBackgroundSyncService] handleToDeviceEvent: ERROR: incomplete event content: \(String(describing: event.jsonDictionary()))") |
|  |  | guard let userId = credentials.userId else { |
|  |  | MXLog.error("[MXBackgroundSyncService] handleToDeviceEvent: Cannot get userId") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | guard let roomId = content["room\_id"] as? String, |
|  |  | let sessionId = content["session\_id"] as? String, |
|  |  | let sessionKey = content["session\_key"] as? String, |
|  |  | var senderKey = event.senderKey else { |
|  |  | MXLog.debug("[MXBackgroundSyncService] handleToDeviceEvent: ERROR: incomplete event: \(String(describing: event.jsonDictionary()))") |
|  |  | let factory = MXRoomKeyInfoFactory(myUserId: userId, store: cryptoStore) |
|  |  | guard let key = factory.roomKey(for: event) else { |
|  |  | MXLog.error("[MXBackgroundSyncService] handleToDeviceEvent: Cannot create megolm key from event") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | var forwardingKeyChain: [String] = [] |
|  |  | var exportFormat: Bool = false |
|  |  | var keysClaimed: [String: String] = [:] |
|  |  |  |
|  |  | switch event.eventType { |
|  |  | case .roomKey: |
|  |  | keysClaimed = event.keysClaimed as! [String: String] |
|  |  | case .roomForwardedKey: |
|  |  | exportFormat = true |
|  |  |  |
|  |  | if let array = content["forwarding\_curve25519\_key\_chain"] as? [String] { |
|  |  | forwardingKeyChain = array |
|  |  | } |
|  |  | forwardingKeyChain.append(senderKey) |
|  |  |  |
|  |  | if let senderKeyInContent = content["sender\_key"] as? String { |
|  |  | senderKey = senderKeyInContent |
|  |  | } else { |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | guard let ed25519Key = event.content["sender\_claimed\_ed25519\_key"] as? String else { |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | keysClaimed = [ |
|  |  | "ed25519": ed25519Key |
|  |  | ] |
|  |  | default: |
|  |  | MXLog.debug("[MXBackgroundSyncService] handleToDeviceEvent: ERROR: Not supported type: \(event.eventType)") |
|  |  | return |
|  |  | switch key.type { |
|  |  | case .safe: |
|  |  | olmDevice.addInboundGroupSession( |
|  |  | key.info.sessionId, |
|  |  | sessionKey: key.info.sessionKey, |
|  |  | roomId: key.info.roomId, |
|  |  | senderKey: key.info.senderKey, |
|  |  | forwardingCurve25519KeyChain: key.info.forwardingKeyChain, |
|  |  | keysClaimed: key.info.keysClaimed, |
|  |  | exportFormat: key.info.exportFormat, |
|  |  | sharedHistory: key.info.sharedHistory, |
|  |  | untrusted: key.type != .safe |
|  |  | ) |
|  |  | case .unsafe: |
|  |  | MXLog.warning("[MXBackgroundSyncService] handleToDeviceEvent: Ignoring unsafe keys") |
|  |  | case .unrequested: |
|  |  | MXLog.warning("[MXBackgroundSyncService] handleToDeviceEvent: Ignoring unrequested keys") |
|  |  | } |
|  |  |  |
|  |  | let sharedHistory = (content[kMXSharedHistoryKeyName] as? Bool) ?? false |
|  |  | olmDevice.addInboundGroupSession(sessionId, |
|  |  | sessionKey: sessionKey, |
|  |  | roomId: roomId, |
|  |  | senderKey: senderKey, |
|  |  | forwardingCurve25519KeyChain: forwardingKeyChain, |
|  |  | keysClaimed: keysClaimed, |
|  |  | exportFormat: exportFormat, |
|  |  | sharedHistory: sharedHistory) |
|  |  | } |
|  |  |  |
|  |  | private func updateBackgroundServiceStoresIfNeeded() { |
| Expand Down | |  |

8 changes: 7 additions & 1 deletion

8
[MatrixSDK/Contrib/Swift/JSONModels/MXEvent.swift](#diff-b6639e4e37c5f97c0c45a1b2b813501d5ba9a608e35ad878ef7cb76add7b3d1b "MatrixSDK/Contrib/Swift/JSONModels/MXEvent.swift")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Contrib/Swift/JSONModels/MXEvent.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -73,6 +73,9 @@ public enum MXEventType: Equatable, Hashable { |
|  |  | case keyVerificationMac |
|  |  | case keyVerificationCancel |
|  |  | case keyVerificationDone |
|  |  | case secretRequest |
|  |  | case secretSend |
|  |  | case secretStorageDefaultKey |
|  |  | case taggedEvents |
|  |  | case spaceChild |
|  |  | case spaceOrder |
| Expand Down  Expand Up | | @@ -132,6 +135,9 @@ public enum MXEventType: Equatable, Hashable { |
|  |  | case .keyVerificationMac: return kMXEventTypeStringKeyVerificationMac |
|  |  | case .keyVerificationCancel: return kMXEventTypeStringKeyVerificationCancel |
|  |  | case .keyVerificationDone: return kMXEventTypeStringKeyVerificationDone |
|  |  | case .secretRequest: return kMXEventTypeStringSecretRequest |
|  |  | case .secretSend: return kMXEventTypeStringSecretSend |
|  |  | case .secretStorageDefaultKey: return kMXEventTypeStringSecretStorageDefaultKey |
|  |  | case .taggedEvents: return kMXEventTypeStringTaggedEvents |
|  |  | case .spaceChild: return kMXEventTypeStringSpaceChild |
|  |  | case .spaceOrder: return kMXEventTypeStringSpaceOrderMSC3230 |
| Expand All | | @@ -151,7 +157,7 @@ public enum MXEventType: Equatable, Hashable { |
|  |  | } |
|  |  |  |
|  |  | public init(identifier: String) { |
|  |  | let events: [MXEventType] = [.roomName, .roomTopic, .roomAvatar, .roomMember, .roomCreate, .roomJoinRules, .roomPowerLevels, .roomAliases, .roomCanonicalAlias, .roomEncrypted, .roomEncryption, .roomGuestAccess, .roomHistoryVisibility, .roomKey, .roomForwardedKey, .roomKeyRequest, .roomMessage, .roomMessageFeedback, .roomRedaction, .roomThirdPartyInvite, .roomTag, .presence, .typing, .callInvite, .callCandidates, .callAnswer, .callSelectAnswer, .callHangup, .callReject, .callNegotiate, .callReplaces, .callRejectReplacement, .callAssertedIdentity, .callAssertedIdentityUnstable, .reaction, .receipt, .roomTombStone, .keyVerificationStart, .keyVerificationAccept, .keyVerificationKey, .keyVerificationMac, .keyVerificationCancel, .keyVerificationDone, .taggedEvents, .spaceChild, .spaceOrder, .pollStart, .pollResponse, .pollEnd, .beaconInfo, .beacon] |
|  |  | let events: [MXEventType] = [.roomName, .roomTopic, .roomAvatar, .roomMember, .roomCreate, .roomJoinRules, .roomPowerLevels, .roomAliases, .roomCanonicalAlias, .roomEncrypted, .roomEncryption, .roomGuestAccess, .roomHistoryVisibility, .roomKey, .roomForwardedKey, .roomKeyRequest, .roomMessage, .roomMessageFeedback, .roomRedaction, .roomThirdPartyInvite, .roomTag, .presence, .typing, .callInvite, .callCandidates, .callAnswer, .callSelectAnswer, .callHangup, .callReject, .callNegotiate, .callReplaces, .callRejectReplacement, .callAssertedIdentity, .callAssertedIdentityUnstable, .reaction, .receipt, .roomTombStone, .keyVerificationStart, .keyVerificationAccept, .keyVerificationKey, .keyVerificationMac, .keyVerificationCancel, .keyVerificationDone, .secretRequest, .secretSend, .secretStorageDefaultKey, .taggedEvents, .spaceChild, .spaceOrder, .pollStart, .pollResponse, .pollEnd, .beaconInfo, .beacon] |
|  |  |  |
|  |  | if let type = events.first(where: { $0.identifier == identifier }) { |
|  |  | self = type |
| Expand Down | |  |

15 changes: 11 additions & 4 deletions

15
[MatrixSDK/Crypto/Algorithms/MXDecrypting.h](#diff-ebee111891e9feb28dca2264da8e436d3535f57901ca9b858c13c82cbd7e85ca "MatrixSDK/Crypto/Algorithms/MXDecrypting.h")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/Algorithms/MXDecrypting.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,7 +23,7 @@ |
|  |  | #import "MXEventDecryptionResult.h" |
|  |  | #import "MXIncomingRoomKeyRequest.h" |
|  |  |  |
|  |  | @class MXCrypto, MXOlmInboundGroupSession; |
|  |  | @class MXCrypto, MXOlmInboundGroupSession, MXRoomKeyResult; |
|  |  |  |
|  |  |  |
|  |  | @protocol MXDecrypting <NSObject> |
| Expand Down  Expand Up | | @@ -56,12 +56,19 @@ |
|  |  | - (MXEventDecryptionResult \*)decryptEvent:(MXEvent\*)event inTimeline:(NSString\*)timeline; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Handle a key event. |
|  |  | \* |
|  |  | \* @param event the key event. |
|  |  | Handle a key event. |
|  |  |  |
|  |  | @param event the key event. |
|  |  | \*/ |
|  |  | - (void)onRoomKeyEvent:(MXEvent\*)event; |
|  |  |  |
|  |  | /\*\* |
|  |  | Handle new room key |
|  |  |  |
|  |  | @param key the domain object with key details and safety |
|  |  | \*/ |
|  |  | - (void)onRoomKey:(MXRoomKeyResult\*)key; |
|  |  |  |
|  |  | /\*\* |
|  |  | Notification that a room key has been imported. |
|  |  |  |
| Expand Down | |  |

121 changes: 44 additions & 77 deletions

121
[MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmDecryption.m](#diff-b240f4b5bb84038e17247600bbba3add55b57d7ea0a2281c752f19049675ac38 "MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmDecryption.m")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmDecryption.m)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ |
|  |  | #import "MXTools.h" |
|  |  | #import "MatrixSDKSwiftHeader.h" |
|  |  | #import "MXSharedHistoryKeyService.h" |
|  |  | #import "MXForwardedRoomKeyEventContent.h" |
|  |  |  |
|  |  | @interface MXMegolmDecryption () |
|  |  | { |
| Expand All | | @@ -41,6 +42,10 @@ @interface MXMegolmDecryption () |
|  |  | NSMutableDictionary<NSString\* /\* timelineId \*/, |
|  |  | NSMutableDictionary<NSString\* /\* eventId \*/, MXEvent\*>\*>\*> \*pendingEvents; |
|  |  | } |
|  |  |  |
|  |  | // Factory to create room key info |
|  |  | @property (nonatomic, strong) MXRoomKeyInfoFactory \*roomKeyInfoFactory; |
|  |  |  |
|  |  | @end |
|  |  |  |
|  |  | @implementation MXMegolmDecryption |
| Expand All | | @@ -59,6 +64,7 @@ - (instancetype)initWithCrypto:(MXCrypto \*)theCrypto |
|  |  | { |
|  |  | crypto = theCrypto; |
|  |  | olmDevice = theCrypto.olmDevice; |
|  |  | \_roomKeyInfoFactory = [[MXRoomKeyInfoFactory alloc] initWithMyUserId:crypto.mxSession.credentials.userId store:crypto.store]; |
|  |  | pendingEvents = [NSMutableDictionary dictionary]; |
|  |  | } |
|  |  | return self; |
| Expand Down  Expand Up | | @@ -191,98 +197,59 @@ - (void)addEventToPendingList:(MXEvent\*)event inTimeline:(NSString\*)timelineId |
|  |  |  |
|  |  | - (void)onRoomKeyEvent:(MXEvent \*)event |
|  |  | { |
|  |  | NSDictionary \*content = event.content; |
|  |  | NSString \*roomId, \*sessionId, \*sessionKey; |
|  |  |  |
|  |  | MXJSONModelSetString(roomId, content[@"room\_id"]); |
|  |  | MXJSONModelSetString(sessionId, content[@"session\_id"]); |
|  |  | MXJSONModelSetString(sessionKey, content[@"session\_key"]); |
|  |  |  |
|  |  | if (!roomId || !sessionId || !sessionKey) |
|  |  | MXRoomKeyResult \*key = [self.roomKeyInfoFactory roomKeyFor:event]; |
|  |  | if (!key) |
|  |  | { |
|  |  | MXLogDebug(@"[MXMegolmDecryption] onRoomKeyEvent: ERROR: Key event is missing fields"); |
|  |  | MXLogError(@"[MXMegolmDecryption] onRoomKeyEvent: Cannot create megolm key from event"); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | NSString \*senderKey = event.senderKey; |
|  |  | if (!senderKey) |
|  |  | { |
|  |  | MXLogDebug(@"[MXMegolmDecryption] onRoomKeyEvent: ERROR: Key event has no sender key (not encrypted?)"); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | NSArray<NSString\*> \*forwardingKeyChain; |
|  |  | BOOL exportFormat = NO; |
|  |  | NSDictionary \*keysClaimed; |
|  |  | BOOL sharedHistory = NO; |
|  |  | if (content[kMXSharedHistoryKeyName] != nil) |
|  |  | { |
|  |  | MXJSONModelSetBoolean(sharedHistory, content[kMXSharedHistoryKeyName]); |
|  |  | } |
|  |  |  |
|  |  | if (event.eventType == MXEventTypeRoomForwardedKey) |
|  |  | { |
|  |  | exportFormat = YES; |
|  |  | MXJSONModelSetArray(forwardingKeyChain, content[@"forwarding\_curve25519\_key\_chain"]); |
|  |  | if (!forwardingKeyChain) |
|  |  | { |
|  |  | forwardingKeyChain = @[]; |
|  |  | } |
|  |  |  |
|  |  | // copy content before we modify it |
|  |  | NSMutableArray \*forwardingKeyChain2 = [NSMutableArray arrayWithArray:forwardingKeyChain]; |
|  |  | [forwardingKeyChain2 addObject:senderKey]; |
|  |  | forwardingKeyChain = forwardingKeyChain2; |
|  |  |  |
|  |  | MXJSONModelSetString(senderKey, content[@"sender\_key"]); |
|  |  | if (!senderKey) |
|  |  | { |
|  |  | MXLogDebug(@"[MXMegolmDecryption] onRoomKeyEvent: ERROR: forwarded\_room\_key event is missing sender\_key field"); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | NSString \*ed25519Key; |
|  |  | MXJSONModelSetString(ed25519Key, content[@"sender\_claimed\_ed25519\_key"]); |
|  |  | if (!ed25519Key) |
|  |  | { |
|  |  | MXLogDebug(@"[MXMegolmDecryption] onRoomKeyEvent: ERROR: forwarded\_room\_key\_event is missing sender\_claimed\_ed25519\_key field"); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | keysClaimed = @{ |
|  |  | @"ed25519": ed25519Key |
|  |  | }; |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | keysClaimed = event.keysClaimed; |
|  |  |  |
|  |  | switch (key.type) { |
|  |  | case MXRoomKeyTypeSafe: |
|  |  | MXLogDebug(@"[MXMegolmDecryption] onRoomKeyEvent: Adding key for megolm session %@|%@ from %@ event", key.info.senderKey, key.info.sessionId, event.type); |
|  |  | [self onRoomKey:key]; |
|  |  | break; |
|  |  | case MXRoomKeyTypeUnsafe: |
|  |  | MXLogWarning(@"[MXMegolmDecryption] onRoomKeyEvent: Ignoring unsafe key"); |
|  |  | break; |
|  |  | case MXRoomKeyTypeUnrequested: |
|  |  | [crypto handleUnrequestedRoomKeyInfo:key.info senderId:event.sender senderKey:event.senderKey]; |
|  |  | break; |
|  |  | default: |
|  |  | MXLogFailureDetails(@"[MXMegolmDecryption] onRoomKeyEvent: Unknown key type", @{ |
|  |  | @"key\_type": @(key.type) |
|  |  | }); |
|  |  | break; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | MXLogDebug(@"[MXMegolmDecryption] onRoomKeyEvent: Adding key for megolm session %@|%@ from %@ event", senderKey, sessionId, event.type); |
|  |  |  |
|  |  | [olmDevice addInboundGroupSession:sessionId |
|  |  | sessionKey:sessionKey |
|  |  | roomId:roomId |
|  |  | senderKey:senderKey |
|  |  | forwardingCurve25519KeyChain:forwardingKeyChain |
|  |  | keysClaimed:keysClaimed |
|  |  | exportFormat:exportFormat |
|  |  | sharedHistory:sharedHistory]; |
|  |  | - (void)onRoomKey:(MXRoomKeyResult \*)key |
|  |  | { |
|  |  | MXRoomKeyInfo \*keyInfo = key.info; |
|  |  | [olmDevice addInboundGroupSession:keyInfo.sessionId |
|  |  | sessionKey:keyInfo.sessionKey |
|  |  | roomId:keyInfo.roomId |
|  |  | senderKey:keyInfo.senderKey |
|  |  | forwardingCurve25519KeyChain:keyInfo.forwardingKeyChain |
|  |  | keysClaimed:keyInfo.keysClaimed |
|  |  | exportFormat:keyInfo.exportFormat |
|  |  | sharedHistory:keyInfo.sharedHistory |
|  |  | untrusted:key.type != MXRoomKeyTypeSafe]; |
|  |  |  |
|  |  | [crypto.backup maybeSendKeyBackup]; |
|  |  |  |
|  |  | MXWeakify(self); |
|  |  | [self retryDecryption:senderKey sessionId:content[@"session\_id"] complete:^(BOOL allDecrypted) { |
|  |  | [self retryDecryption:keyInfo.senderKey sessionId:keyInfo.sessionId complete:^(BOOL allDecrypted) { |
|  |  | MXStrongifyAndReturnIfNil(self); |
|  |  |  |
|  |  | if (allDecrypted) |
|  |  | { |
|  |  | // cancel any outstanding room key requests for this session |
|  |  | [self->crypto cancelRoomKeyRequest:@{ |
|  |  | @"algorithm": content[@"algorithm"], |
|  |  | @"room\_id": content[@"room\_id"], |
|  |  | @"session\_id": content[@"session\_id"], |
|  |  | @"sender\_key": senderKey |
|  |  | @"algorithm": keyInfo.algorithm, |
|  |  | @"room\_id": keyInfo.roomId, |
|  |  | @"session\_id": keyInfo.sessionId, |
|  |  | @"sender\_key": keyInfo.senderKey |
|  |  | }]; |
|  |  | } |
|  |  | }]; |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmEncryption.m](#diff-b012b6eda02e8b3b6cd09f6956cbb49be875c1e596cd34b85038dce53990952f "MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmEncryption.m")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/Algorithms/Megolm/MXMegolmEncryption.m)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -340,6 +340,7 @@ - (MXOutboundSessionInfo\*)prepareNewSession |
|  |  | } |
|  |  | exportFormat:NO |
|  |  | sharedHistory:sharedHistory |
|  |  | untrusted:NO |
|  |  | ]; |
|  |  |  |
|  |  | [crypto.backup maybeSendKeyBackup]; |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[MatrixSDK/Crypto/Algorithms/Olm/MXOlmDecryption.m](#diff-6d14da6249c47ec3e2dee6d17d339c3263c45ec649b4292b944bdc476c71e547 "MatrixSDK/Crypto/Algorithms/Olm/MXOlmDecryption.m")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/Algorithms/Olm/MXOlmDecryption.m)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -223,6 +223,11 @@ - (void)onRoomKeyEvent:(MXEvent \*)event |
|  |  | // No impact for olm |
|  |  | } |
|  |  |  |
|  |  | - (void)onRoomKeyInfo:(MXRoomKeyInfo \*)keyInfo |
|  |  | { |
|  |  | // No impact for olm |
|  |  | } |
|  |  |  |
|  |  | - (void)didImportRoomKey:(MXOlmInboundGroupSession \*)session |
|  |  | { |
|  |  | // No impact for olm |
| Expand Down | |  |

5 changes: 0 additions & 5 deletions

5
[MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.h](#diff-f4be22a7e259a51aaad751b48d53895e918e055d5b8c1adc6ade79666c01183c "MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.h")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -39,11 +39,6 @@ NS\_ASSUME\_NONNULL\_BEGIN |
|  |  | \*/ |
|  |  | @property (nonatomic) NSArray<MXKeyBackupVersionTrustSignature\*> \*signatures; |
|  |  |  |
|  |  | /\*\* |
|  |  | Flag indicating the backup trusted locally. |
|  |  | \*/ |
|  |  | @property (nonatomic, getter=isTrustedLocally) BOOL trustedLocally; |
|  |  |  |
|  |  | @end |
|  |  |  |
|  |  |  |
| Expand Down | |  |

1 change: 0 additions & 1 deletion

1
[MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.m](#diff-a340dab1b82c80bcd265587d213d323cccfe3194d975f54d81b0e1fc7a432cc2 "MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.m")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/KeyBackup/Data/MXKeyBackupVersionTrust.m)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -25,7 +25,6 @@ - (instancetype)init |
|  |  | { |
|  |  | \_usable = NO; |
|  |  | \_signatures = [NSArray new]; |
|  |  | \_trustedLocally = NO; |
|  |  | } |
|  |  | return self; |
|  |  | } |
| Expand Down | |  |

12 changes: 0 additions & 12 deletions

12
[MatrixSDK/Crypto/KeyBackup/MXKeyBackup.m](#diff-203f8cad1d6f376311c83844c1a547eed31b23e1e7a37afe3b168ca617369c22 "MatrixSDK/Crypto/KeyBackup/MXKeyBackup.m")

Show comments

[View file](/matrix-org/matrix-ios-sdk/blob/5ca86c328a5faaab429c240551cb9ca8f0f6262c/MatrixSDK/Crypto/KeyBackup/MXKeyBackup.m)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1123,17 +1123,6 @@ - (MXKeyBackupVersionTrust \*)trustForKeyBackupVersionFromCryptoQueue:(MXKeyBacku |
|  |  | return keyBackupVersionTrust; |
|  |  | } |
|  |  |  |
|  |  | NSData \*privateKey = self.privateKeyFromCryptoStore; |
|  |  | if (privateKey) |
|  |  | { |
|  |  | id<MXKeyBackupAlgorithm> algorithm = [self getOrCreateKeyBackupAlgorithmFor:keyBackupVersion privateKey:privateKey]; |
|  |  | if ([algorithm keyMatches:privateKey error:nil]) |
|  |  | { |
|  |  | MXLogDebug(@"[MXKeyBackup] trustForKeyBackupVersionFromCryptoQueue: Backup is trusted locally"); |
|  |  | keyBackupVersionTrust.trustedLocally = YES; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | NSDictionary \*mySigs = authData.signatures[myUserId]; |
|  |  | NSMutableArray<MXKeyBackupVersionTrustSignature\*> \*signatures = [NSMutableArray array]; |
|  |  | for (NSString \*keyId in mySigs) |
| Expand Down  Expand Up | | @@ -1196,7 +1185,6 @@ - (MXKeyBackupVersionTrust \*)trustForKeyBackupVersionFromCryptoQueue:(MXKeyBacku |
|  |  | keyBackupVersionTrust.usable = YES; |
|  |  | } |
|  |  | } |
|  |  | keyBackupVersionTrust.usable = keyBackupVersionTrust.usable || keyBackupVersionTrust.isTrustedLocally; |
|  |  |  |
|  |  | return keyBackupVersionTrust; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5ca86c3`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Fcommit%2F5ca86c328a5faaab429c240551cb9ca8f0f6262c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_48cc17b8_20250115_114101.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Fsecurity%2Fadvisories%2FGHSA-hw6g-j8v6-9hcm)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Fsecurity%2Fadvisories%2FGHSA-hw6g-j8v6-9hcm)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=matrix-org%2Fmatrix-ios-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-ios-sdk](/matrix-org/matrix-ios-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk) You must be signed in to change notification settings
* [Fork
  216](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk)
* [Star
   453](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk)

* [Code](/matrix-org/matrix-ios-sdk)
* [Issues
  143](/matrix-org/matrix-ios-sdk/issues)
* [Pull requests
  25](/matrix-org/matrix-ios-sdk/pulls)
* [Actions](/matrix-org/matrix-ios-sdk/actions)
* [Projects
  0](/matrix-org/matrix-ios-sdk/projects)
* [Security](/matrix-org/matrix-ios-sdk/security)
* [Insights](/matrix-org/matrix-ios-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-ios-sdk)
* [Issues](/matrix-org/matrix-ios-sdk/issues)
* [Pull requests](/matrix-org/matrix-ios-sdk/pulls)
* [Actions](/matrix-org/matrix-ios-sdk/actions)
* [Projects](/matrix-org/matrix-ios-sdk/projects)
* [Security](/matrix-org/matrix-ios-sdk/security)
* [Insights](/matrix-org/matrix-ios-sdk/pulse)

# Olm/Megolm protocol confusion

Critical

[dkasak](/dkasak)
published
GHSA-hw6g-j8v6-9hcm
Sep 28, 2022

## Package

swift

org.matrix.MatrixSDK
([Swift](/advisories?query=ecosystem%3Aswift))

## Affected versions

<=0.23.18

## Patched versions

0.23.19

## Description

### Impact

An attacker cooperating with a malicious homeserver can construct messages that legitimately appear to have come from another person, without any indication such as a grey shield.

Additionally, a sophisticated attacker cooperating with a malicious homeserver could employ this vulnerability to perform a targeted attack in order to send fake to-device messages appearing to originate from another user. This can allow, for example, to inject the key backup secret during a self-verification, to make a targeted device start using a malicious key backup spoofed by the homeserver.

These attacks are possible due to a protocol confusion vulnerability that accepts to-device messages encrypted with Megolm instead of Olm.

### Patches

matrix-ios-sdk has been modified to only accept Olm-encrypted to-device messages.

Out of caution, several other checks have been audited or added:

* Cleartext `m.room_key`, `m.forwarded_room_key` and `m.secret.send` to\_device messages are discarded.
* Secrets received from untrusted devices are discarded.
* Key backups are only usable if they have a valid signature from a trusted device (no more local trust, or trust-on-decrypt).
* The origin of a to-device message should only be determined by observing the Olm session which managed to decrypt the message, and not by using claimed sender\_key, user\_id, or any other fields controllable by the homeserver.

### Workarounds

As this attack requires coordination between a malicious home server and an attacker, if you trust your home server no particular workaround is needed. Notice that the backup spoofing attack is a particularly sophisticated targeted attack.

We are not aware of this attack being used in the wild, though specifying a false positive-free way of checking whether your key backup is malicious is challenging.

As an abundance of caution, to avoid malicious backup attacks, you should not verify your new logins using emoji/QR verifications methods until patched. Prefer using verify with passphrase.

### References

Blog post: <https://matrix.org/blog/2022/09/28/upgrade-now-to-address-encryption-vulns-in-matrix-sdks-and-clients>

### For more information

If you have any questions or comments about this advisory, e-mail us at security@matrix.org.

### Severity

Critical

### CVE ID

CVE-2022-39255

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b2a23537_20250114_191350.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Freleases%2Ftag%2Fv0.23.19)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-ios-sdk%2Freleases%2Ftag%2Fv0.23.19)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=matrix-org%2Fmatrix-ios-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-ios-sdk](/matrix-org/matrix-ios-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk) You must be signed in to change notification settings
* [Fork
  216](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk)
* [Star
   453](/login?return_to=%2Fmatrix-org%2Fmatrix-ios-sdk)

* [Code](/matrix-org/matrix-ios-sdk/tree/v0.23.19)
* [Issues
  143](/matrix-org/matrix-ios-sdk/issues)
* [Pull requests
  25](/matrix-org/matrix-ios-sdk/pulls)
* [Actions](/matrix-org/matrix-ios-sdk/actions)
* [Projects
  0](/matrix-org/matrix-ios-sdk/projects)
* [Security](/matrix-org/matrix-ios-sdk/security)
* [Insights](/matrix-org/matrix-ios-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-ios-sdk/tree/v0.23.19)
* [Issues](/matrix-org/matrix-ios-sdk/issues)
* [Pull requests](/matrix-org/matrix-ios-sdk/pulls)
* [Actions](/matrix-org/matrix-ios-sdk/actions)
* [Projects](/matrix-org/matrix-ios-sdk/projects)
* [Security](/matrix-org/matrix-ios-sdk/security)
* [Insights](/matrix-org/matrix-ios-sdk/pulse)

1. [Releases](/matrix-org/matrix-ios-sdk/releases)
2. [v0.23.19](/matrix-org/matrix-ios-sdk/releases/tag/v0.23.19)

# v0.23.19

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/matrix-org/matrix-ios-sdk/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v0.23.19)

 Loading

[View all tags](/matrix-org/matrix-ios-sdk/tags)

![@Anderas](https://avatars.githubusercontent.com/u/3922159?s=40&v=4)
[Anderas](/Anderas)
released this
28 Sep 15:29

·
[867 commits](/matrix-org/matrix-ios-sdk/compare/v0.23.19...develop)
to develop
since this release

[v0.23.19](/matrix-org/matrix-ios-sdk/tree/v0.23.19)

[`4442142`](/matrix-org/matrix-ios-sdk/commit/4442142c7111cf051d30d9015de7266a515bfc95)

## Changes in 0.23.19 (2022-09-28)

🐛 Bugfixes

* CVE-2022-39255: Olm/Megolm protocol confusion ([Security advisory](https://github.com/matrix-org/matrix-ios-sdk/security/advisories/GHSA-hw6g-j8v6-9hcm))
* CVE-2022-39257: Impersonation via forwarded Megolm sessions ([Security advisory](https://github.com/matrix-org/matrix-ios-sdk/security/advisories/GHSA-qxr3-5jmq-xcf4))

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from matrix.org_b745038c_20250114_191351.html ===

[![Matrix logo](/images/matrix-logo-white.svg)](/)



[Spec](https://spec.matrix.org)

Foundation

[About Matrix](/foundation/about/)
[Governing Board Elections 2024](/foundation/governing-board-elections/)

[Blog](/blog/)
[Docs](/docs/)

Ecosystem

[Clients](/ecosystem/clients/)
[Bridges](/ecosystem/bridges/)
[Servers](/ecosystem/servers/)
[Integrations](/ecosystem/integrations/)
[SDKs](/ecosystem/sdks/)
[Hosting](/ecosystem/hosting/)

[Donate](/support)
[Try Matrix](/try-matrix/)

# Upgrade now to address E2EE vulnerabilities in matrix-js-sdk, matrix-ios-sdk and matrix-android-sdk2

28.09.2022 17:41
—
[Security](/category/security)
—
[Matthew Hodgson](/author/matthew-hodgson),
[Denis Kasak](/author/denis-kasak),
[Matrix Cryptography Team](/author/matrix-cryptography-team),
[Matrix Security Team](/author/matrix-security-team)

**TL;DR:**

* Two critical severity vulnerabilities in end-to-end encryption were found in
  the SDKs which power Element, Beeper, Cinny, SchildiChat, Circuli, Synod.im
  and any other clients based on matrix-js-sdk, matrix-ios-sdk or
  matrix-android-sdk2.
* These have now been fixed, and we have not seen evidence of them being
  exploited in the wild. All of the critical vulnerabilities require
  cooperation from a malicious homeserver to be exploited.
* **Please upgrade immediately in order to be protected against these
  vulnerabilities.**
* Clients with other encryption implementations (including Hydrogen, ElementX,
  Nheko, FluffyChat, Syphon, Timmy, Gomuks and Pantalaimon) are not affected;
  **this is not a protocol bug**.
* We take the security of our end-to-end encryption extremely seriously, and we
  have an ongoing series of public independent audits booked to help guard
  against future vulnerabilities. We will also be making some protocol changes
  in the future to provide additional layers of protection.
* This resolves the [pre-disclosure](https://matrix.org/blog/2022/09/23/pre-disclosure-upcoming-critical-security-release-of-matrix-sd-ks-and-clients) issued on September 23rd.

Hi all,

Recently we have been hard at work investigating some subtle security
vulnerabilities in certain implementations of Matrix's end-to-end encryption
which were responsibly disclosed to us by researchers at Royal Holloway
University London, University of Sheffield and Brave Software. Two of these
vulnerabilities are critical severity, in that they could allow malicious
server admins to attack their users, and are implementation bugs in clients
using matrix-js-sdk (e.g. Element Web) or implementations derived from
matrix-js-sdk, rather than protocol flaws. matrix-rust-sdk (and other 2nd/3rd
generation SDKs) are not affected by these. These vulnerabilities are fixed in
today's release, and we are not aware of them having been exploited in the
wild.

**If you're using Element or an application that shares the same SDKs (Beeper,
Cinny, SchildiChat, Circuli, Synod.im) then please upgrade now. Do not perform
verification with new devices until you have upgraded.**

We'd like to thank the security researchers for investing significant time and
effort into doing a deep dive to find these issues, and thus contributing
materially to making Matrix more secure for the whole ecosystem. Despite our
best efforts, there is always a risk of security issues in software, and we're
very glad to have identified and fixed these issues while also taking the
opportunity to improve our vulnerability disclosure and coordinated upgrade
process.

Please note that the critical severity issues are implementation issues in
matrix-js-sdk and derivatives, and are **not** protocol issues in Matrix. The
latest version of the researchers' paper that we've seen incorrectly presents
Element as 'the reference Matrix client', and confuses the higher severity
implementation bugs with lower severity protocol critique. This is very
unfortunate, given Hydrogen, ElementX, Nheko, FluffyChat, Syphon, Timmy, Gomuks
and Pantalaimon and other independent implementations are not affected. In
fact, every client independently implemented using the Matrix spec seems to
have got it right, which speaks well of the protocol. It's only the first
generation SDK (predating the spec) and its derivatives which had these bugs.

The two critical severity issues lead to three attack scenarios, all of which
are prevented by today's releases:

* "*Key/Device Identifier Confusion in SAS Verification*" – A bug existed in
  matrix-js-sdk where it confused together device IDs and cross-signing keys
  (given under the hood, cross-signing keys are represented as devices). This
  could be exploited by a malicious server admin to break emoji-based
  verification when cross-signing is in use, authenticating themselves rather
  than the target user being verified. This bug is only present in
  matrix-js-sdk (not iOS or Android SDKs), tracked as a critical severity CVE:
  CVE-2022-39250.
* "*Trusted Impersonation*" – matrix-js-sdk (and derived SDKs) suffered from
  a protocol-confusion bug where it would incorrectly accept to-device messages
  encrypted by Megolm rather than Olm, attributing them to the Megolm sender
  rather than the actual sender. As a result, an attacker could fake the
  trusted sender of to-device messages, allowing them to send fake to-device
  messages to devices - e.g. fake keys to spoof historical messages from other
  users. This bug is tracked as a critical severity CVE: CVE-2022-39251
  (matrix-js-sdk), CVE-2022-39255 (matrix-ios-sdk) and CVE-2022-39248
  (matrix-android-sdk2).
* "*Malicious key backup*" – the above 'trusted impersonation' bug in
  matrix-js-sdk (and derived SDKs) could be used by a malicious homeserver
  admin to add a malicious key backup to the user's account under certain
  unusual conditions in order to exfiltrate message keys. While we are not
  aware of this being exploited in the wild, out of an abundance of caution we
  recommend checking your key backup settings. If you are particularly paranoid
  you may wish to reset your online key backup. This doesn't have a separate
  CVE, as the root cause is the same as "Trusted Impersonation".

Three lower priority issues were also identified by the researchers:

* "*Semi-trusted Impersonation*" – matrix-js-sdk (and derived SDKs) accepted keys
  forwarded by other users, even if your client didn't request them. As
  a result, a malicious server admin could fake an encrypted message to look as
  if it was sent from a given user on that server. However, impersonated
  messages like this are clearly marked by clients like Element with a clear
  "The authenticity of this encrypted message can't be guaranteed" warning
  – which is why we consider this low severity. That said, it's an avoidable
  attack, and we've fixed this by ensuring that clients don't accept 'unsafe'
  keys (with the exception of keys forwarded when you invite a user to an
  existing conversation). In future, in Olm/Megolm v2 we're also linking
  key-sending events to the underlying recipient Olm identity to ensure that
  keys cannot be misappropriated. This issue is tracked as a moderate severity
  CVE: CVE-2022-39249 (matrix-js-sdk), CVE-2022-39257 (matrix-ios-sdk) and
  CVE-2022-39246 (matrix-android-sdk2).
* "*Homeserver Control of Room Membership*" – A malicious homeserver can fake
  invites on behalf of its users to invite malicious users into their
  conversations, or add malicious devices into its users accounts. However,
  when this happens, we clearly warn the user: if you have verified the users
  you are talking to, the room and user will be shown with a big red cross to
  mark if malicious devices have been added. Similarly, if an unexpected user
  is invited to a conversation, all users can clearly see and take evasive
  action. Therefore we consider this a low severity issue. That said, this
  behaviour can be improved, and we've started work on switching our trust
  model to trust-on-first-use (so that new untrusted devices are proactively
  excluded from conversations, even if you haven't explicitly verified their
  owner) - and we're also looking to add cryptographic signatures to membership
  events in E2EE rooms to stop impersonated invites. These fixes will land
  over the coming months.
* "*IND-CCA break*" – Matrix's usage of AES-CTR to encrypt attachments, secrets
  and symmetric key backups is not "IND-CCA2 secure", because it does not
  include the AES initialisation vector within the hash used to secure the
  payload from tampering. As a result, if an attacker could observe the result
  of both a given encryption and a given decryption operation, it would be
  possible to extract the encryption private key. However, this is a purely
  theoretical attack as Matrix does not provide a way to mount the attack. In
  the future, we will fix our use of AES-CTR to include the IV within the hash.

We'd like to again thank Martin R. Albrecht and Dan Jones from the Information
Security Group at Royal Holloway University London, Benjamin Dowling from
Security of Advanced Systems Group, University of Sheffield and Sofía Celi from
Brave Software for discovering these issues and responsibly disclosing them to
us, and then working with us to agree on an extended disclosure window given
the amount of work needed to verify and ship fixes throughout Matrix over the
course of the summer period. We welcome any further formal security analysis
work, and hope that it will distinguish clearly between Matrix-the-protocol and
Matrix implementations like matrix-js-sdk, rather than conflating them. You can
read their full paper [here](https://nebuchadnezzar-megolm.github.io/).

We'd also like to thank all the downstream Element package maintainers,
downstream forks and other affected clients for working together under time
constraints for this coordinated release - your patience and understanding is
very much appreciated indeed.

Meanwhile, we are taking extreme measures to avoid future E2EE vulnerabilities.
You will notice that matrix-rust-sdk, hydrogen-sdk and other 2nd and 3rd
generation SDKs were not affected by the bugs at the root cause of the critical
issues here. This is **precisely** why we have been working on replacing the
first generation SDKs with a clean, carefully written Rust implementation in
the form of matrix-rust-sdk, complete with an ongoing independent public audit.

We started the process of auditing matrix-rust-sdk with the [Least Authority
vodozemac audit in May](https://matrix.org/blog/2022/05/16/independent-public-audit-of-vodozemac-a-native-rust-reference-implementation-of-matrix-end-to-end-encryption), and we have three more audits agreed
– covering matrix-rust-sdk-crypto, matrix-rust-sdk, and a whole reference
Matrix stack. Ironically, the mitigation work for these vulnerabilities in the
legacy SDKs has severely impacted our timelines for finishing
matrix-rust-sdk-crypto work (in fact, we had to push back the Least Authority
audit of matrix-rust-sdk-crypto given the
[burndown](https://github.com/matrix-org/matrix-rust-sdk/milestone/1) has not
progressed), but we will be shifting to the new audited codebase as rapidly as
we possibly can.

Over the coming months we will also introduce our first ever major version
update of Olm and Megolm, in order to fix the MAC truncation issue highlighted
in the [vodozemac audit](https://matrix.org/media/Least%20Authority%20-%20Matrix%20vodozemac%20Final%20Audit%20Report.pdf) (Issue J), and reduce the risk of further
key-forwarding issues (as per the "Semi-trusted Impersonation" vulnerability
above). New conversations will default to using v2 of Olm/Megolm for security,
and existing conversations can be optionally upgraded (similar to a 'room
version' upgrade in Matrix today). We are also adding extensive end-to-end
testing using [Polyjuice](https://gitlab.com/polyjuice) and [Traffic
Light](https://github.com/matrix-org/trafficlight) to stress-test encryption
and improve reliability.

Finally, we will continue our research into layering Matrix over Messaging
Layer Security (MLS) - the IETF proposed standard for interoperable end-to-end
encrypted group messaging. This work has been delayed by the mitigation
activity above, but otherwise it's making good progress and we're excited to
see how Decentralised MLS performs in reality against Olm+Megolm v2.

We'd like to apologise to the wider Matrix community for the inconvenience and
disruption of these issues, and thank you for your patience while we've
resolved them.

Matthew, Denis and the Matrix cryptography & security teams.

## The Foundation needs you

The Matrix.org Foundation is a non-profit and only relies
on donations to operate. Its core mission is to maintain
the Matrix Specification, but it does much more than that.

It maintains the matrix.org homeserver and hosts several
bridges for free. It fights for our collective rights to
digital privacy and dignity.

[Support us](/support)

[Donate](/support)
[Shop](https://shop.matrix.org)
[Security Disclosure Policy](/security-disclosure-policy)
[Security Hall of Fame](/security-hall-of-fame)
[Code of Conduct](/legal/code-of-conduct)
[Legal](/legal)
[Contact](/contact)
[Site Source](https://github.com/matrix-org/matrix.org/)

[![GitHub](/assets/github.svg)](https://github.com/matrix-org)
[![GitLab](/assets/gitlab.svg)](https://gitlab.matrix.org/)
[![Mastodon](/assets/mastodon.svg)](https://mastodon.matrix.org/%40matrix)
[![Twitter](/assets/twitter.svg)](https://twitter.com/matrixdotorg)
[![YouTube](/assets/youtube.svg)](https://www.youtube.com/channel/UCVFkW-chclhuyYRbmmfwt6w)
[![RSS](/assets/rss.svg)](/atom.xml)

[Copyright Notice](/legal/copyright-notice)


