=== Content from github.com_f943d45c_20250114_230908.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fissues%2F13288)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fissues%2F13288)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

# Faster joins: incoming federation requests during resync may be incorrectly rejected #13288

[Jump to bottom](#comment-composer-heading)Copy link[Jump to bottom](#comment-composer-heading)Copy linkClosed[#13823](https://github.com/matrix-org/synapse/pull/13823)Closed[Faster joins: incoming federation requests during resync may be incorrectly rejected](#top)#13288[#13823](https://github.com/matrix-org/synapse/pull/13823)Copy linkAssignees [![reivilibre](https://avatars.githubusercontent.com/u/38398653?s=64&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)Labels[A-Federated-Joinjoins over federation generally suck](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22A-Federated-Join%22)joins over federation generally suck[A-Federation](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22A-Federation%22)[T-DefectBugs, crashes, hangs, security vulnerabilities, or other reported issues.](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22T-Defect%22)Bugs, crashes, hangs, security vulnerabilities, or other reported issues.Milestone[Q3 2022: Faster joins: fix major known bugs for monoliths](https://github.com/matrix-org/synapse/milestone/8)![@richvdh](https://avatars.githubusercontent.com/u/1389908?v=4&size=80)
## Description

![@richvdh](https://avatars.githubusercontent.com/u/1389908?v=4&size=48)[richvdh](https://github.com/richvdh)opened [on Jul 15, 2022](https://github.com/matrix-org/synapse/issues/13288#issue-1306022984)

If a remote server sends us a federation request (such as `get_missing_events`, or requesting a space summary) during a state resync, we may well reject that request due to not thinking the remote server is in the room.

Possibly we need to define some return code to say "sorry, can't auth you right now".

## Metadata

### Assignees

* [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=64&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)reivilibre](/reivilibre)
### Labels

[A-Federated-Joinjoins over federation generally suck](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22A-Federated-Join%22)joins over federation generally suck[A-Federation](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22A-Federation%22)[T-DefectBugs, crashes, hangs, security vulnerabilities, or other reported issues.](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22T-Defect%22)Bugs, crashes, hangs, security vulnerabilities, or other reported issues.
### Type

No type
### Projects

No projects
### Milestone

* [Q3 2022: Faster joins: fix major known bugs for monoliths](https://github.com/matrix-org/synapse/milestone/8)
### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.fedoraproject.org_e68c218c_20250114_230915.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS.mbox.gz?message=T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS/#T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS)

# [SECURITY] Fedora 37 Update: matrix-synapse-1.63.1-3.fc37

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

11 Jun
2023

11 Jun
'23

2:59 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2023-eb65439ec0
2023-06-11 01:58:02.674323
--------------------------------------------------------------------------------

Name : matrix-synapse
Product : Fedora 37
Version : 1.63.1
Release : 3.fc37
URL : <https://github.com/matrix-org/synapse>
Summary : A Matrix reference homeserver written in Python using Twisted
Description :
Matrix is an ambitious new ecosystem for open federated Instant Messaging and
VoIP. Synapse is a reference "homeserver" implementation of Matrix from the
core development team at matrix.org, written in Python/Twisted. It is intended
to showcase the concept of Matrix and let folks see the spec in the context of
a coded base and let you run your own homeserver and generally help bootstrap
the ecosystem.

--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2022-39335
--------------------------------------------------------------------------------
ChangeLog:

--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2209961 - CVE-2022-39335 matrix-synapse: Synapse does not apply enough checks to servers requesting auth events of events in a room [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2209961>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2023-eb65439ec0' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS/#T2MBNMZAFY4RCZL2VGBGAPKGB4JUPZVS)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from github.com_8eb26444_20250114_230914.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fsecurity%2Fadvisories%2FGHSA-45cj-f97f-ggwv)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fsecurity%2Fadvisories%2FGHSA-45cj-f97f-ggwv)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

# Synapse does not apply enough checks to servers requesting auth events of events in a room

Moderate

[dkasak](/dkasak)
published
GHSA-45cj-f97f-ggwv
May 24, 2023

## Package

pip

matrix-synapse
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<=1.68.0

## Patched versions

1.69.0

## Description

### Impact

The Matrix Federation API allows remote homeservers to request the *authorisation events* of events in a room. This is necessary so that a homeserver receiving some events can validate that those events are legitimate and permitted in their room.

However, in versions of Synapse up to and including 1.68.0, a Synapse homeserver answering a query for authorisation events does not sufficiently check that the requesting server should be able to access them.

Authorisation events include power level events (the list of user IDs and their power levels at the time) and relevant membership events (including the display name of the sender of that event), as well as events like `m.room.create`, `m.room.third_party_invite` and `m.room.join_rules`. Non-authorisation events are unaffected, so it isn't possible to e.g. extract message contents this way.

This issue is only exploitable when a malicious actor knows the ID of a target room and the ID of an event from that room. In most cases, this makes exploitation infeasible. This issue is of negligible consequence for public rooms given that any server can easily join the room in order to be allowed to view authorisation events. Further, deployments in a closed federation where all homeservers are trustworthy are not affected.

### Patches

The issue was patched in Synapse 1.69.0. Homeserver administrators are advised to upgrade.

### Workarounds

Synapse can be configured with a list of servers that it is allowed to federate with [`federation_domain_whitelist`](https://matrix-org.github.io/synapse/v1.68/usage/configuration/config_documentation.html#federation_domain_whitelist). If this list is in use and all the servers on the list are trusted not to exploit this issue, then this issue is of no consequence.

This workaround is not practical for homeservers participating in open federation as interaction with any server not on the list would have to happen indirectly through servers that are, leading to inconsistent delays in message delivery.

### References

Fixed in [#13823](https://github.com/matrix-org/synapse/pull/13823).

### For more information

If you have any questions or comments about this advisory, e-mail us at security@matrix.org.

### Severity

Moderate

### CVE ID

CVE-2022-39335

### Weaknesses

[CWE-200](/advisories?query=cwe%3A200)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_37b0e3ac_20250114_230913.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F13823)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F13823)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

# Faster Remote Room Joins: tell remote homeservers that we are unable to authorise them if they query a room which has partial state on our server. #13823

 Merged

[reivilibre](/reivilibre)
merged 10 commits into
[develop](/matrix-org/synapse/tree/develop "matrix-org/synapse:develop")
from
[rei/frj\_unable\_ps](/matrix-org/synapse/tree/rei/frj_unable_ps "matrix-org/synapse:rei/frj_unable_ps")

Sep 23, 2022

 Merged

# [Faster Remote Room Joins: tell remote homeservers that we are unable to authorise them if they query a room which has partial state on our server.](#top) #13823

[reivilibre](/reivilibre)
merged 10 commits into
[develop](/matrix-org/synapse/tree/develop "matrix-org/synapse:develop")
from
[rei/frj\_unable\_ps](/matrix-org/synapse/tree/rei/frj_unable_ps "matrix-org/synapse:rei/frj_unable_ps")

Sep 23, 2022

[Conversation
16](/matrix-org/synapse/pull/13823)
[Commits
10](/matrix-org/synapse/pull/13823/commits)
[Checks
0](/matrix-org/synapse/pull/13823/checks)
[Files changed](/matrix-org/synapse/pull/13823/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![reivilibre](https://avatars.githubusercontent.com/u/38398653?s=60&v=4)](/reivilibre)

Copy link

Contributor

### @reivilibre **[reivilibre](/reivilibre)** commented [Sep 15, 2022](#issue-1374667117) • edited Loading

Fixes [#13288](https://github.com/matrix-org/synapse/issues/13288).

Instead of trying to perform authorisation checks on the requesting server, we tell them that we're not able to authorise them right now. (This uses a small appendix to [MSC3706](https://github.com/matrix-org/matrix-spec-proposals/pull/3706) to define an error code.)

The requesting server should already have failover logic to query another resident server, so this shouldn't harm them.

The main concern comes about when sending an event ([#12997](https://github.com/matrix-org/synapse/issues/12997)), where we may need to answer some queries so that the server receiving our event can accept it. This PR leaves that as future work for [#12997](https://github.com/matrix-org/synapse/issues/12997)...

An alternative suggestion is to accept servers that are on the list given to us from the server we `/make_join`ed against (and possibly keep this up to date), but this seems error-prone and it's not as though we can't do that at a later date if we reason through it and decide that it's sound.

One notable reason that it's difficult to make it sound is that, during a partial join, we may accept (or reject) events that we later find out we should reject (or accept), so tracking the set of servers in the room doesn't seem trivial. See [#13288](https://github.com/matrix-org/synapse/issues/13288) for info.

Leaking room contents to servers is a notable enough risk that it seems better to play it safe.

In any case, if we're partially joined to the room then it holds that there must be a fully-joined resident server online OR our join will ultimately fail anyway (at which point we're as good as not resident in the room).

The requesting homeserver should therefore be able to request from that server OR our view of the room is likely insufficient to answer queries anyway.

Commit-by-commit reviewable.

The error code is defined in [MSC3895](https://github.com/matrix-org/matrix-spec-proposals/pull/3895) ([matrix-org/matrix-spec-proposals#3895](https://github.com/matrix-org/matrix-spec-proposals/pull/3895); draft).

Sorry, something went wrong.

All reactions

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
self-assigned this
[Sep 15, 2022](#event-7396400107)

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
marked this pull request as ready for review
[September 16, 2022 11:17](#event-7402379750)

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
requested a review
from a team
as a [code owner](/matrix-org/synapse/blob/6986bcbf3950ef6fdd19eed27130dd2be3c74cb6/.github/CODEOWNERS#L2)
[September 16, 2022 11:17](#event-7402379772)

[![DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=60&v=4)](/DMRobertson)

**[DMRobertson](/DMRobertson)**
reviewed
[Sep 16, 2022](#pullrequestreview-1110886910)

 [View reviewed changes](/matrix-org/synapse/pull/13823/files)

Copy link

Contributor

### @DMRobertson **[DMRobertson](/DMRobertson)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Looks sane, but I've not been following the FRRJ stuff at all and I could use some reassurance to compensate for my ignorance!

Sorry, something went wrong.

All reactions

[synapse/api/errors.py](/matrix-org/synapse/pull/13823/files#diff-c067ec99d4920f5ed1652a4a1bbb1eaabc2218d7c3c0f18bd465ff3fd26d69bd)
Outdated

Show resolved

Hide resolved

[synapse/handlers/event\_auth.py](/matrix-org/synapse/pull/13823/files#diff-19075ba7a24341970c8d89b4d28d51594dfcfcf54f66ecf3209ba4d07f07e728)
Outdated

Show resolved

Hide resolved

[synapse/handlers/event\_auth.py](/matrix-org/synapse/pull/13823/files#diff-19075ba7a24341970c8d89b4d28d51594dfcfcf54f66ecf3209ba4d07f07e728)

Show resolved

Hide resolved

[synapse/handlers/event\_auth.py](/matrix-org/synapse/pull/13823/files#diff-19075ba7a24341970c8d89b4d28d51594dfcfcf54f66ecf3209ba4d07f07e728)
Outdated

Show resolved

Hide resolved

[synapse/handlers/event\_auth.py](/matrix-org/synapse/pull/13823/files#diff-19075ba7a24341970c8d89b4d28d51594dfcfcf54f66ecf3209ba4d07f07e728)
Outdated

|  |  | @@ -156,7 +156,7 @@ async def get\_user\_which\_could\_invite( | |
| --- | --- | --- | --- |
|  |  | Codes.UNABLE\_TO\_GRANT\_JOIN, |
|  |  | ) |
|  |  |  |
|  |  | async def check\_host\_in\_room(self, room\_id: str, host: str) -> bool: |
|  |  | async def is\_host\_in\_room(self, room\_id: str, host: str) -> bool: |
|  |  | with Measure(self.\_clock, "check\_host\_in\_room"): |

Copy link

Contributor

### @DMRobertson **[DMRobertson](/DMRobertson)** [Sep 16, 2022](#discussion_r973167899)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Should the measure name be updated too?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @reivilibre **[reivilibre](/reivilibre)** [Sep 22, 2022](#discussion_r977639604)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I'm tempted to remove the measure block. All the time goes into a database call which should already be measured.. Does that sound reasonable?

Sorry, something went wrong.

All reactions

Copy link

Contributor

### @DMRobertson **[DMRobertson](/DMRobertson)** [Sep 22, 2022](#discussion_r977645108)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Err, remind me what measures are used for. Is it just an opentracing span?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @reivilibre **[reivilibre](/reivilibre)** [Sep 22, 2022](#discussion_r977671548)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It's for the 'Per-block Metrics' section in Grafana

Sorry, something went wrong.

All reactions

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=80&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)

Copy link

Contributor

### **[DMRobertson](/DMRobertson)** commented [Sep 16, 2022](#issuecomment-1249532221)

| Sytest seems unhappy; unsure if it's a test oversight or a logic bug.  The trial failure looked like it was unhappy about 404 != 403, but I haven't dug deeper. |
| --- |

All reactions

Sorry, something went wrong.

[![@matrix-org](https://avatars.githubusercontent.com/u/8418310?s=40&v=4)](/matrix-org)
[matrix-org](/matrix-org)
deleted a comment from
[DMRobertson](/DMRobertson)
[Sep 16, 2022](#event-7404448003)

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Define an error code](/matrix-org/synapse/pull/13823/commits/1dbf57a2b54559521c57fa9ef2307f5206ddce2e "Define an error code")`

`[1dbf57a](/matrix-org/synapse/pull/13823/commits/1dbf57a2b54559521c57fa9ef2307f5206ddce2e)`

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
[force-pushed](/matrix-org/synapse/compare/4be61a681caa514c141e59ee9a8afd68c60cbf82..3cb0345328ad581740d73faf2f90348b9ae53266)
the
rei/frj\_unable\_ps

branch
from
[`4be61a6`](/matrix-org/synapse/commit/4be61a681caa514c141e59ee9a8afd68c60cbf82) to
[`3cb0345`](/matrix-org/synapse/commit/3cb0345328ad581740d73faf2f90348b9ae53266)  [Compare](/matrix-org/synapse/compare/4be61a681caa514c141e59ee9a8afd68c60cbf82..3cb0345328ad581740d73faf2f90348b9ae53266)
[September 22, 2022 12:46](#event-7439284032)

 [reivilibre](/reivilibre)
added 5 commits
[September 22, 2022 14:10](#commits-pushed-5bd2c5d)

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Add assert_host_in_room](/matrix-org/synapse/pull/13823/commits/5bd2c5dbf3e494175526917f248dd708f55f6438 "Add `assert_host_in_room`")`

`[5bd2c5d](/matrix-org/synapse/pull/13823/commits/5bd2c5dbf3e494175526917f248dd708f55f6438)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Use assert_host_in_room](/matrix-org/synapse/pull/13823/commits/261c4bf94737896278fe145ee567dec89cf9104e "Use assert_host_in_room")`

`[261c4bf](/matrix-org/synapse/pull/13823/commits/261c4bf94737896278fe145ee567dec89cf9104e)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Simplify control flow of get_persisted_pdu (drive-by cleanup)](/matrix-org/synapse/pull/13823/commits/58a2ca158a6d8f0c66b8f612d94f3bf5065a9866 "Simplify control flow of get_persisted_pdu (drive-by cleanup)")`

`[58a2ca1](/matrix-org/synapse/pull/13823/commits/58a2ca158a6d8f0c66b8f612d94f3bf5065a9866)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Rename check_ to is_ to more accurately describe it](/matrix-org/synapse/pull/13823/commits/66d7230c4e2621b5897e9aa39cc614c83b72e906 "Rename check_ to is_ to more accurately describe it")`

`[66d7230](/matrix-org/synapse/pull/13823/commits/66d7230c4e2621b5897e9aa39cc614c83b72e906)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Newsfile](/matrix-org/synapse/pull/13823/commits/cfb8b315a814b287d9a5b9d5fe806b658eea22e2 "Newsfile

Signed-off-by: Olivier Wilkinson (reivilibre) <oliverw@matrix.org>")`
 …

`[cfb8b31](/matrix-org/synapse/pull/13823/commits/cfb8b315a814b287d9a5b9d5fe806b658eea22e2)`

```
Signed-off-by: Olivier Wilkinson (reivilibre) <oliverw@matrix.org>
```

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
[force-pushed](/matrix-org/synapse/compare/3cb0345328ad581740d73faf2f90348b9ae53266..cfb8b315a814b287d9a5b9d5fe806b658eea22e2)
the
rei/frj\_unable\_ps

branch
from
[`3cb0345`](/matrix-org/synapse/commit/3cb0345328ad581740d73faf2f90348b9ae53266) to
[`cfb8b31`](/matrix-org/synapse/commit/cfb8b315a814b287d9a5b9d5fe806b658eea22e2)  [Compare](/matrix-org/synapse/compare/3cb0345328ad581740d73faf2f90348b9ae53266..cfb8b315a814b287d9a5b9d5fe806b658eea22e2)
[September 22, 2022 13:10](#event-7439488238)

 [reivilibre](/reivilibre)
added 4 commits
[September 22, 2022 14:14](#commits-pushed-9ac8b45)

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[flag -> error code](/matrix-org/synapse/pull/13823/commits/9ac8b45589e5e6c2a28672cc83cbb2718ec35c2d "flag -> error code")`

`[9ac8b45](/matrix-org/synapse/pull/13823/commits/9ac8b45589e5e6c2a28672cc83cbb2718ec35c2d)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Add warning about incorrect results in partial stated rooms](/matrix-org/synapse/pull/13823/commits/89fdb723fe8bf3ac0c68d0918194bdbe6200f4f4 "Add warning about incorrect results in partial stated rooms")`

`[89fdb72](/matrix-org/synapse/pull/13823/commits/89fdb723fe8bf3ac0c68d0918194bdbe6200f4f4)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Change error code to](/matrix-org/synapse/pull/13823/commits/41fcf5c40b6ade35335edb6e4f36d56388b0f2d5 "Change error code to MSC3895") [MSC3895](https://github.com/matrix-org/matrix-spec-proposals/pull/3895)`

`[41fcf5c](/matrix-org/synapse/pull/13823/commits/41fcf5c40b6ade35335edb6e4f36d56388b0f2d5)`

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre)

`[Remove redundant Measure block](/matrix-org/synapse/pull/13823/commits/d613f098a8495d8c4b058f0b875da6c82c9240a6 "Remove redundant Measure block")`

`[d613f09](/matrix-org/synapse/pull/13823/commits/d613f098a8495d8c4b058f0b875da6c82c9240a6)`

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
[force-pushed](/matrix-org/synapse/compare/c248a979d14fa38d1edcea1c3f2272b8f8ffccbe..d613f098a8495d8c4b058f0b875da6c82c9240a6)
the
rei/frj\_unable\_ps

branch
from
[`c248a97`](/matrix-org/synapse/commit/c248a979d14fa38d1edcea1c3f2272b8f8ffccbe) to
[`d613f09`](/matrix-org/synapse/commit/d613f098a8495d8c4b058f0b875da6c82c9240a6)  [Compare](/matrix-org/synapse/compare/c248a979d14fa38d1edcea1c3f2272b8f8ffccbe..d613f098a8495d8c4b058f0b875da6c82c9240a6)
[September 22, 2022 17:33](#event-7441659805)

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
requested a review
from [DMRobertson](/DMRobertson)
[September 22, 2022 17:34](#event-7441668278)

[![DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=60&v=4)](/DMRobertson)

**[DMRobertson](/DMRobertson)**
approved these changes
[Sep 22, 2022](#pullrequestreview-1117517531)

 [View reviewed changes](/matrix-org/synapse/pull/13823/files/d613f098a8495d8c4b058f0b875da6c82c9240a6)

Copy link

Contributor

### @DMRobertson **[DMRobertson](/DMRobertson)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thanks, LGTM!

Sorry, something went wrong.

All reactions

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
merged commit [`c06b2b7`](/matrix-org/synapse/commit/c06b2b714262825e1d2510b62c38fdeda339f6dc)
into
develop

[Sep 23, 2022](https://github.com/matrix-org/synapse/pull/13823#event-7446331373)

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
deleted the
rei/frj\_unable\_ps

branch
[September 23, 2022 10:47](#event-7446331466)

[squahtx](/squahtx)
pushed a commit
that referenced
this pull request
[Oct 4, 2022](#ref-commit-f0019f3)

`[Merge tag 'v1.69.0rc1' into develop](/matrix-org/synapse/commit/f0019f3f3bd98d7d2aeae8db66c5f55231c8cd93 "Merge tag 'v1.69.0rc1' into develop

Synapse 1.69.0rc1 (2022-10-04)
==============================

Please note that legacy Prometheus metric names are now deprecated and will be removed in Synapse 1.73.0.
Server administrators should update their dashboards and alerting rules to avoid using the deprecated metric names.
See the [upgrade notes](https://matrix-org.github.io/synapse/v1.69/upgrade.html#upgrading-to-v1690) for more details.

Features
--------

- Allow application services to set the `origin_server_ts` of a state event by providing the query parameter `ts` in [`PUT /_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}`](https://spec.matrix.org/v1.4/client-server-api/#put_matrixclientv3roomsroomidstateeventtypestatekey), per [MSC3316](https://github.com/matrix-org/matrix-doc/pull/3316). Contributed by @lukasdenk. ([\#11866](https://github.com/matrix-org/synapse/issues/11866))
- Allow server admins to require a manual approval process before new accounts can be used (using [MSC3866](https://github.com/matrix-org/matrix-spec-proposals/pull/3866)). ([\#13556](https://github.com/matrix-org/synapse/issues/13556))
- Exponentially backoff from backfilling the same event over and over. ([\#13635](https://github.com/matrix-org/synapse/issues/13635), [\#13936](https://github.com/matrix-org/synapse/issues/13936))
- Add cache invalidation across workers to module API. ([\#13667](https://github.com/matrix-org/synapse/issues/13667), [\#13947](https://github.com/matrix-org/synapse/issues/13947))
- Experimental implementation of [MSC3882](https://github.com/matrix-org/matrix-spec-proposals/pull/3882) to allow an existing device/session to generate a login token for use on a new device/session. ([\#13722](https://github.com/matrix-org/synapse/issues/13722), [\#13868](https://github.com/matrix-org/synapse/issues/13868))
- Experimental support for thread-specific receipts ([MSC3771](https://github.com/matrix-org/matrix-spec-proposals/pull/3771)). ([\#13782](https://github.com/matrix-org/synapse/issues/13782), [\#13893](https://github.com/matrix-org/synapse/issues/13893), [\#13932](https://github.com/matrix-org/synapse/issues/13932), [\#13937](https://github.com/matrix-org/synapse/issues/13937), [\#13939](https://github.com/matrix-org/synapse/issues/13939))
- Add experimental support for [MSC3881: Remotely toggle push notifications for another client](https://github.com/matrix-org/matrix-spec-proposals/pull/3881). ([\#13799](https://github.com/matrix-org/synapse/issues/13799), [\#13831](https://github.com/matrix-org/synapse/issues/13831), [\#13860](https://github.com/matrix-org/synapse/issues/13860))
- Keep track when an event pulled over federation fails its signature check so we can intelligently back-off in the future. ([\#13815](https://github.com/matrix-org/synapse/issues/13815))
- Improve validation for the unspecced, internal-only `_matrix/client/unstable/add_threepid/msisdn/submit_token` endpoint. ([\#13832](https://github.com/matrix-org/synapse/issues/13832))
- Faster remote room joins: record _when_ we first partial-join to a room. ([\#13892](https://github.com/matrix-org/synapse/issues/13892))
- Support a `dir` parameter on the `/relations` endpoint per [MSC3715](https://github.com/matrix-org/matrix-doc/pull/3715). ([\#13920](https://github.com/matrix-org/synapse/issues/13920))
- Ask mail servers receiving emails from Synapse to not send automatic replies (e.g. out-of-office responses). ([\#13957](https://github.com/matrix-org/synapse/issues/13957))

Bugfixes
--------

- Send push notifications for invites received over federation. ([\#13719](https://github.com/matrix-org/synapse/issues/13719), [\#14014](https://github.com/matrix-org/synapse/issues/14014))
- Fix a long-standing bug where typing events would be accepted from remote servers not present in a room. Also fix a bug where incoming typing events would cause other incoming events to get stuck during a fast join. ([\#13830](https://github.com/matrix-org/synapse/issues/13830))
- Fix a bug introduced in Synapse v1.53.0 where the experimental implementation of [MSC3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715) would give incorrect results when paginating forward. ([\#13840](https://github.com/matrix-org/synapse/issues/13840))
- Fix access token leak to logs from proxy agent. ([\#13855](https://github.com/matrix-org/synapse/issues/13855))
- Fix `have_seen_event` cache not being invalidated after we persist an event which causes inefficiency effects like extra `/state` federation calls. ([\#13863](https://github.com/matrix-org/synapse/issues/13863))
- Faster room joins: Fix a bug introduced in 1.66.0 where an error would be logged when syncing after joining a room. ([\#13872](https://github.com/matrix-org/synapse/issues/13872))
- Fix a bug introduced in 1.66.0 where some required fields in the pushrules sent to clients were not present anymore. Contributed by Nico. ([\#13904](https://github.com/matrix-org/synapse/issues/13904))
- Fix packaging to include `Cargo.lock` in `sdist`. ([\#13909](https://github.com/matrix-org/synapse/issues/13909))
- Fix a long-standing bug where device updates could cause delays sending out to-device messages over federation. ([\#13922](https://github.com/matrix-org/synapse/issues/13922))
- Fix a bug introduced in v1.68.0 where Synapse would require `setuptools_rust` at runtime, even though the package is only required at build time. ([\#13952](https://github.com/matrix-org/synapse/issues/13952))
- Fix a long-standing bug where `POST /_matrix/client/v3/keys/query` requests could result in excessively large SQL queries. ([\#13956](https://github.com/matrix-org/synapse/issues/13956))
- Fix a performance regression in the `get_users_in_room` database query. Introduced in v1.67.0. ([\#13972](https://github.com/matrix-org/synapse/issues/13972))
- Fix a bug introduced in v1.68.0 bug where Rust extension wasn't built in `release` mode when using `poetry install`. ([\#14009](https://github.com/matrix-org/synapse/issues/14009))
- Do not return an unspecified `original_event` field when using the stable `/relations` endpoint. Introduced in Synapse v1.57.0. ([\#14025](https://github.com/matrix-org/synapse/issues/14025))
- Correctly handle a race with device lists when a remote user leaves during a partial join. ([\#13885](https://github.com/matrix-org/synapse/issues/13885))
- Correctly handle sending local device list updates to remote servers during a partial join. ([\#13934](https://github.com/matrix-org/synapse/issues/13934))

Improved Documentation
----------------------

- Add `worker_main_http_uri` for the worker generator bash script. ([\#13772](https://github.com/matrix-org/synapse/issues/13772))
- Update URL for the NixOS module for Synapse. ([\#13818](https://github.com/matrix-org/synapse/issues/13818))
- Fix a mistake in sso_mapping_providers.md: `map_user_attributes` is expected to return `display_name`, not `displayname`. ([\#13836](https://github.com/matrix-org/synapse/issues/13836))
- Fix a cross-link from the registration admin API to the `registration_shared_secret` configuration documentation. ([\#13870](https://github.com/matrix-org/synapse/issues/13870))
- Update the man page for the `hash_password` script to correct the default number of bcrypt rounds performed. ([\#13911](https://github.com/matrix-org/synapse/issues/13911), [\#13930](https://github.com/matrix-org/synapse/issues/13930))
- Emphasize the right reasons when to use `(room_id, event_id)` in a database schema. ([\#13915](https://github.com/matrix-org/synapse/issues/13915))
- Add instruction to contributing guide for running unit tests in parallel. Contributed by @ashfame. ([\#13928](https://github.com/matrix-org/synapse/issues/13928))
- Clarify that the `auto_join_rooms` config option can also be used with Space aliases. ([\#13931](https://github.com/matrix-org/synapse/issues/13931))
- Add some cross references to worker documentation. ([\#13974](https://github.com/matrix-org/synapse/issues/13974))
- Linkify urls in config documentation. ([\#14003](https://github.com/matrix-org/synapse/issues/14003))

Deprecations and Removals
-------------------------

- Remove the `complete_sso_login` method from the Module API which was deprecated in Synapse 1.13.0. ([\#13843](https://github.com/matrix-org/synapse/issues/13843))
- Announce that legacy metric names are deprecated, will be turned off by default in Synapse v1.71.0 and removed altogether in Synapse v1.73.0. See the upgrade notes for more information. ([\#14024](https://github.com/matrix-org/synapse/issues/14024))

Internal Changes
----------------

- Speed up creation of DM rooms. ([\#13487](https://github.com/matrix-org/synapse/issues/13487), [\#13800](https://github.com/matrix-org/synapse/issues/13800))
- Port push rules to using Rust. ([\#13768](https://github.com/matrix-org/synapse/issues/13768), [\#13838](https://github.com/matrix-org/synapse/issues/13838), [\#13889](https://github.com/matrix-org/synapse/issues/13889))
- Optimise get rooms for user calls. Contributed by Nick @ Beeper (@fizzadar). ([\#13787](https://github.com/matrix-org/synapse/issues/13787))
- Update the script which makes full schema dumps. ([\#13792](https://github.com/matrix-org/synapse/issues/13792))
- Use shared methods for cache invalidation when persisting events, remove duplicate codepaths. Contributed by Nick @ Beeper (@fizzadar). ([\#13796](https://github.com/matrix-org/synapse/issues/13796))
- Improve the `synapse.api.auth.Auth` mock used in unit tests. ([\#13809](https://github.com/matrix-org/synapse/issues/13809))
- Faster Remote Room Joins: tell remote homeservers that we are unable to authorise them if they query a room which has partial state on our server. ([\#13823](https://github.com/matrix-org/synapse/issues/13823))
- Carry IdP Session IDs through user-mapping sessions. ([\#13839](https://github.com/matrix-org/synapse/issues/13839))
- Fix the release script not publishing binary wheels. ([\#13850](https://github.com/matrix-org/synapse/issues/13850))
- Raise issue if complement fails with latest deps. ([\#13859](https://github.com/matrix-org/synapse/issues/13859))
- Correct the comments in the complement dockerfile. ([\#13867](https://github.com/matrix-org/synapse/issues/13867))
- Create a new snapshot of the database schema. ([\#13873](https://github.com/matrix-org/synapse/issues/13873))
- Faster room joins: Send device list updates to most servers in rooms with partial state. ([\#13874](https://github.com/matrix-org/synapse/issues/13874), [\#14013](https://github.com/matrix-org/synapse/issues/14013))
- Add comments to the Prometheus recording rules to make it clear which set of rules you need for Grafana or Prometheus Console. ([\#13876](https://github.com/matrix-org/synapse/issues/13876))
- Only pull relevant backfill points from the database based on the current depth and limit (instead of all) every time we want to `/backfill`. ([\#13879](https://github.com/matrix-org/synapse/issues/13879))
- Faster room joins: Avoid waiting for full state when processing `/keys/changes` requests. ([\#13888](https://github.com/matrix-org/synapse/issues/13888))
- Improve backfill robustness by trying more servers when we get a `4xx` error back. ([\#13890](https://github.com/matrix-org/synapse/issues/13890))
- Fix mypy errors with canonicaljson 1.6.3. ([\#13905](https://github.com/matrix-org/synapse/issues/13905))
- Faster remote room joins: correctly handle remote device list updates during a partial join. ([\#13913](https://github.com/matrix-org/synapse/issues/13913))
- Complement image: propagate SIGTERM to all workers. ([\#13914](https://github.com/matrix-org/synapse/issues/13914))
- Update an innaccurate comment in Synapse's upsert database helper. ([\#13924](https://github.com/matrix-org/synapse/issues/13924))
- Update mypy (0.950 -> 0.981) and mypy-zope (0.3.7 -> 0.3.11). ([\#13925](https://github.com/matrix-org/synapse/issues/13925), [\#13993](https://github.com/matrix-org/synapse/issues/13993))
- Use dedicated `get_local_users_in_room(room_id)` function to find local users when calculating users to copy over during a room upgrade. ([\#13960](https://github.com/matrix-org/synapse/issues/13960))
- Refactor language in user directory `_track_user_joined_room` code to make it more clear that we use both local and remote users. ([\#13966](https://github.com/matrix-org/synapse/issues/13966))
- Revert catch-all exceptions being recorded as event pull attempt failures (only handle what we know about). ([\#13969](https://github.com/matrix-org/synapse/issues/13969))
- Speed up calculating push actions in large rooms. ([\#13973](https://github.com/matrix-org/synapse/issues/13973), [\#13992](https://github.com/matrix-org/synapse/issues/13992))
- Enable update notifications from Github's dependabot. ([\#13976](https://github.com/matrix-org/synapse/issues/13976))
- Prototype a workflow to automatically add changelogs to dependabot PRs. ([\#13998](https://github.com/matrix-org/synapse/issues/13998), [\#14011](https://github.com/matrix-org/synapse/issues/14011), [\#14017](https://github.com/matrix-org/synapse/issues/14017), [\#14021](https://github.com/matrix-org/synapse/issues/14021), [\#14027](https://github.com/matrix-org/synapse/issues/14027))
- Fix type annotations to be compatible with new annotations in development versions of twisted. ([\#14012](https://github.com/matrix-org/synapse/issues/14012))
- Clear out stale entries in `event_push_actions_staging` table. ([\#14020](https://github.com/matrix-org/synapse/issues/14020))
- Bump versions of GitHub actions. ([\#13978](https://github.com/matrix-org/synapse/issues/13978), [\#13979](https://github.com/matrix-org/synapse/issues/13979), [\#13980](https://github.com/matrix-org/synapse/issues/13980), [\#13982](https://github.com/matrix-org/synapse/issues/13982), [\#14015](https://github.com/matrix-org/synapse/issues/14015), [\#14019](https://github.com/matrix-org/synapse/issues/14019), [\#14022](https://github.com/matrix-org/synapse/issues/14022), [\#14023](https://github.com/matrix-org/synapse/issues/14023))")`
…

`[f0019f3](/matrix-org/synapse/commit/f0019f3f3bd98d7d2aeae8db66c5f55231c8cd93)`

```
Synapse 1.69.0rc1 (2022-10-04)
==============================

Please note that legacy Prometheus metric names are now deprecated and will be removed in Synapse 1.73.0.
Server administrators should update their dashboards and alerting rules to avoid using the deprecated metric names.
See the [upgrade notes](<https://matrix-org.github.io/synapse/v1.69/upgrade.html#upgrading-to-v1690>) for more details.

Features
--------

- Allow application services to set the `origin_server_ts` of a state event by providing the query parameter `ts` in [`PUT /_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}`](<https://spec.matrix.org/v1.4/client-server-api/#put_matrixclientv3roomsroomidstateeventtypestatekey>), per [[MSC3316](https://github.com/matrix-org/matrix-spec-proposals/pull/3316)]([matrix-org/matrix-spec-proposals#3316](https://github.com/matrix-org/matrix-spec-proposals/pull/3316)). Contributed by [@lukasdenk](https://github.com/lukasdenk). ([\[#11866](https://github.com/matrix-org/synapse/pull/11866)]([#11866](https://github.com/matrix-org/synapse/pull/11866)))
- Allow server admins to require a manual approval process before new accounts can be used (using [[MSC3866](https://github.com/matrix-org/matrix-spec-proposals/pull/3866)]([matrix-org/matrix-spec-proposals#3866](https://github.com/matrix-org/matrix-spec-proposals/pull/3866))). ([\[#13556](https://github.com/matrix-org/synapse/pull/13556)]([#13556](https://github.com/matrix-org/synapse/pull/13556)))
- Exponentially backoff from backfilling the same event over and over. ([\[#13635](https://github.com/matrix-org/synapse/pull/13635)]([#13635](https://github.com/matrix-org/synapse/pull/13635)), [\[#13936](https://github.com/matrix-org/synapse/pull/13936)]([#13936](https://github.com/matrix-org/synapse/pull/13936)))
- Add cache invalidation across workers to module API. ([\[#13667](https://github.com/matrix-org/synapse/pull/13667)]([#13667](https://github.com/matrix-org/synapse/pull/13667)), [\[#13947](https://github.com/matrix-org/synapse/pull/13947)]([#13947](https://github.com/matrix-org/synapse/pull/13947)))
- Experimental implementation of [[MSC3882](https://github.com/matrix-org/matrix-spec-proposals/pull/3882)]([matrix-org/matrix-spec-proposals#3882](https://github.com/matrix-org/matrix-spec-proposals/pull/3882)) to allow an existing device/session to generate a login token for use on a new device/session. ([\[#13722](https://github.com/matrix-org/synapse/pull/13722)]([#13722](https://github.com/matrix-org/synapse/pull/13722)), [\[#13868](https://github.com/matrix-org/synapse/pull/13868)]([#13868](https://github.com/matrix-org/synapse/pull/13868)))
- Experimental support for thread-specific receipts ([[MSC3771](https://github.com/matrix-org/matrix-spec-proposals/pull/3771)]([matrix-org/matrix-spec-proposals#3771](https://github.com/matrix-org/matrix-spec-proposals/pull/3771))). ([\[#13782](https://github.com/matrix-org/synapse/pull/13782)]([#13782](https://github.com/matrix-org/synapse/pull/13782)), [\[#13893](https://github.com/matrix-org/synapse/pull/13893)]([#13893](https://github.com/matrix-org/synapse/pull/13893)), [\[#13932](https://github.com/matrix-org/synapse/pull/13932)]([#13932](https://github.com/matrix-org/synapse/pull/13932)), [\[#13937](https://github.com/matrix-org/synapse/pull/13937)]([#13937](https://github.com/matrix-org/synapse/pull/13937)), [\[#13939](https://github.com/matrix-org/synapse/pull/13939)]([#13939](https://github.com/matrix-org/synapse/pull/13939)))
- Add experimental support for [[MSC3881](https://github.com/matrix-org/matrix-spec-proposals/pull/3881): Remotely toggle push notifications for another client]([matrix-org/matrix-spec-proposals#3881](https://github.com/matrix-org/matrix-spec-proposals/pull/3881)). ([\[#13799](https://github.com/matrix-org/synapse/pull/13799)]([#13799](https://github.com/matrix-org/synapse/pull/13799)), [\[#13831](https://github.com/matrix-org/synapse/pull/13831)]([#13831](https://github.com/matrix-org/synapse/pull/13831)), [\[#13860](https://github.com/matrix-org/synapse/pull/13860)]([#13860](https://github.com/matrix-org/synapse/pull/13860)))
- Keep track when an event pulled over federation fails its signature check so we can intelligently back-off in the future. ([\[#13815](https://github.com/matrix-org/synapse/pull/13815)]([#13815](https://github.com/matrix-org/synapse/pull/13815)))
- Improve validation for the unspecced, internal-only `_matrix/client/unstable/add_threepid/msisdn/submit_token` endpoint. ([\[#13832](https://github.com/matrix-org/synapse/pull/13832)]([#13832](https://github.com/matrix-org/synapse/pull/13832)))
- Faster remote room joins: record _when_ we first partial-join to a room. ([\[#13892](https://github.com/matrix-org/synapse/pull/13892)]([#13892](https://github.com/matrix-org/synapse/pull/13892)))
- Support a `dir` parameter on the `/relations` endpoint per [[MSC3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715)]([matrix-org/matrix-spec-proposals#3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715)). ([\[#13920](https://github.com/matrix-org/synapse/pull/13920)]([#13920](https://github.com/matrix-org/synapse/pull/13920)))
- Ask mail servers receiving emails from Synapse to not send automatic replies (e.g. out-of-office responses). ([\[#13957](https://github.com/matrix-org/synapse/pull/13957)]([#13957](https://github.com/matrix-org/synapse/pull/13957)))

Bugfixes
--------

- Send push notifications for invites received over federation. ([\[#13719](https://github.com/matrix-org/synapse/pull/13719)]([#13719](https://github.com/matrix-org/synapse/pull/13719)), [\[#14014](https://github.com/matrix-org/synapse/pull/14014)]([#14014](https://github.com/matrix-org/synapse/pull/14014)))
- Fix a long-standing bug where typing events would be accepted from remote servers not present in a room. Also fix a bug where incoming typing events would cause other incoming events to get stuck during a fast join. ([\[#13830](https://github.com/matrix-org/synapse/pull/13830)]([#13830](https://github.com/matrix-org/synapse/pull/13830)))
- Fix a bug introduced in Synapse v1.53.0 where the experimental implementation of [[MSC3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715)]([matrix-org/matrix-spec-proposals#3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715)) would give incorrect results when paginating forward. ([\[#13840](https://github.com/matrix-org/synapse/pull/13840)]([#13840](https://github.com/matrix-org/synapse/pull/13840)))
- Fix access token leak to logs from proxy agent. ([\[#13855](https://github.com/matrix-org/synapse/pull/13855)]([#13855](https://github.com/matrix-org/synapse/pull/13855)))
- Fix `have_seen_event` cache not being invalidated after we persist an event which causes inefficiency effects like extra `/state` federation calls. ([\[#13863](https://github.com/matrix-org/synapse/pull/13863)]([#13863](https://github.com/matrix-org/synapse/pull/13863)))
- Faster room joins: Fix a bug introduced in 1.66.0 where an error would be logged when syncing after joining a room. ([\[#13872](https://github.com/matrix-org/synapse/pull/13872)]([#13872](https://github.com/matrix-org/synapse/pull/13872)))
- Fix a bug introduced in 1.66.0 where some required fields in the pushrules sent to clients were not present anymore. Contributed by Nico. ([\[#13904](https://github.com/matrix-org/synapse/pull/13904)]([#13904](https://github.com/matrix-org/synapse/pull/13904)))
- Fix packaging to include `Cargo.lock` in `sdist`. ([\[#13909](https://github.com/matrix-org/synapse/pull/13909)]([#13909](https://github.com/matrix-org/synapse/pull/13909)))
- Fix a long-standing bug where device updates could cause delays sending out to-device messages over federation. ([\[#13922](https://github.com/matrix-org/synapse/pull/13922)]([#13922](https://github.com/matrix-org/synapse/pull/13922)))
- Fix a bug introduced in v1.68.0 where Synapse would require `setuptools_rust` at runtime, even though the package is only required at build time. ([\[#13952](https://github.com/matrix-org/synapse/pull/13952)]([#13952](https://github.com/matrix-org/synapse/pull/13952)))
- Fix a long-standing bug where `POST /_matrix/client/v3/keys/query` requests could result in excessively large SQL queries. ([\[#13956](https://github.com/matrix-org/synapse/pull/13956)]([#13956](https://github.com/matrix-org/synapse/pull/13956)))
- Fix a performance regression in the `get_users_in_room` database query. Introduced in v1.67.0. ([\[#13972](https://github.com/matrix-org/synapse/pull/13972)]([#13972](https://github.com/matrix-org/synapse/pull/13972)))
- Fix a bug introduced in v1.68.0 bug where Rust extension wasn't built in `release` mode when using `poetry install`. ([\[#14009](https://github.com/matrix-org/synapse/pull/14009)]([#14009](https://github.com/matrix-org/synapse/pull/14009)))
- Do not return an unspecified `original_event` field when using the stable `/relations` endpoint. Introduced in Synapse v1.57.0. ([\[#14025](https://github.com/matrix-org/synapse/pull/14025)]([#14025](https://github.com/matrix-org/synapse/pull/14025)))
- Correctly handle a race with device lists when a remote user leaves during a partial join. ([\[#13885](https://github.com/matrix-org/synapse/pull/13885)]([#13885](https://github.com/matrix-org/synapse/pull/13885)))
- Correctly handle sending local device list updates to remote servers during a partial join. ([\[#13934](https://github.com/matrix-org/synapse/pull/13934)]([#13934](https://github.com/matrix-org/synapse/pull/13934)))

Improved Documentation
----------------------

- Add `worker_main_http_uri` for the worker generator bash script. ([\[#13772](https://github.com/matrix-org/synapse/pull/13772)]([#13772](https://github.com/matrix-org/synapse/pull/13772)))
- Update URL for the NixOS module for Synapse. ([\[#13818](https://github.com/matrix-org/synapse/pull/13818)]([#13818](https://github.com/matrix-org/synapse/pull/13818)))
- Fix a mistake in sso_mapping_providers.md: `map_user_attributes` is expected to return `display_name`, not `displayname`. ([\[#13836](https://github.com/matrix-org/synapse/pull/13836)]([#13836](https://github.com/matrix-org/synapse/pull/13836)))
- Fix a cross-link from the registration admin API to the `registration_shared_secret` configuration documentation. ([\[#13870](https://github.com/matrix-org/synapse/pull/13870)]([#13870](https://github.com/matrix-org/synapse/pull/13870)))
- Update the man page for the `hash_password` script to correct the default number of bcrypt rounds performed. ([\[#13911](https://github.com/matrix-org/synapse/pull/13911)]([#13911](https://github.com/matrix-org/synapse/pull/13911)), [\[#13930](https://github.com/matrix-org/synapse/pull/13930)]([#13930](https://github.com/matrix-org/synapse/pull/13930)))
- Emphasize the right reasons when to use `(room_id, event_id)` in a database schema. ([\[#13915](https://github.com/matrix-org/synapse/pull/13915)]([#13915](https://github.com/matrix-org/synapse/pull/13915)))
- Add instruction to contributing guide for running unit tests in parallel. Contributed by [@ashfame](https://github.com/ashfame). ([\[#13928](https://github.com/matrix-org/synapse/pull/13928)]([#13928](https://github.com/matrix-org/synapse/pull/13928)))
- Clarify that the `auto_join_rooms` config option can also be used with Space aliases. ([\[#13931](https://github.com/matrix-org/synapse/pull/13931)]([#13931](https://github.com/matrix-org/synapse/pull/13931)))
- Add some cross references to worker documentation. ([\[#13974](https://github.com/matrix-org/synapse/pull/13974)]([#13974](https://github.com/matrix-org/synapse/pull/13974)))
- Linkify urls in config documentation. ([\[#14003](https://github.com/matrix-org/synapse/pull/14003)]([#14003](https://github.com/matrix-org/synapse/pull/14003)))

Deprecations and Removals
-------------------------

- Remove the `complete_sso_login` method from the Module API which was deprecated in Synapse 1.13.0. ([\[#13843](https://github.com/matrix-org/synapse/pull/13843)]([#13843](https://github.com/matrix-org/synapse/pull/13843)))
- Announce that legacy metric names are deprecated, will be turned off by default in Synapse v1.71.0 and removed altogether in Synapse v1.73.0. See the upgrade notes for more information. ([\[#14024](https://github.com/matrix-org/synapse/pull/14024)]([#14024](https://github.com/matrix-org/synapse/pull/14024)))

Internal Changes
----------------

- Speed up creation of DM rooms. ([\[#13487](https://github.com/matrix-org/synapse/pull/13487)]([#13487](https://github.com/matrix-org/synapse/pull/13487)), [\[#13800](https://github.com/matrix-org/synapse/pull/13800)]([#13800](https://github.com/matrix-org/synapse/pull/13800)))
- Port push rules to using Rust. ([\[#13768](https://github.com/matrix-org/synapse/pull/13768)]([#13768](https://github.com/matrix-org/synapse/pull/13768)), [\[#13838](https://github.com/matrix-org/synapse/pull/13838)]([#13838](https://github.com/matrix-org/synapse/pull/13838)), [\[#13889](https://github.com/matrix-org/synapse/pull/13889)]([#13889](https://github.com/matrix-org/synapse/pull/13889)))
- Optimise get rooms for user calls. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[#13787](https://github.com/matrix-org/synapse/pull/13787)]([#13787](https://github.com/matrix-org/synapse/pull/13787)))
- Update the script which makes full schema dumps. ([\[#13792](https://github.com/matrix-org/synapse/pull/13792)]([#13792](https://github.com/matrix-org/synapse/pull/13792)))
- Use shared methods for cache invalidation when persisting events, remove duplicate codepaths. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[#13796](https://github.com/matrix-org/synapse/pull/13796)]([#13796](https://github.com/matrix-org/synapse/pull/13796)))
- Improve the `synapse.api.auth.Auth` mock used in unit tests. ([\[#13809](https://github.com/matrix-org/synapse/pull/13809)]([#13809](https://github.com/matrix-org/synapse/pull/13809)))
- Faster Remote Room Joins: tell remote homeservers that we are unable to authorise them if they query a room which has partial state on our server. ([\[#13823](https://github.com/matrix-org/synapse/pull/13823)]([#13823](https://github.com/matrix-org/synapse/pull/13823)))
- Carry IdP Session IDs through user-mapping sessions. ([\[#13839](https://github.com/matrix-org/synapse/pull/13839)]([#13839](https://github.com/matrix-org/synapse/pull/13839)))
- Fix the release script not publishing binary wheels. ([\[#13850](https://github.com/matrix-org/synapse/pull/13850)]([#13850](https://github.com/matrix-org/synapse/pull/13850)))
- Raise issue if complement fails with latest deps. ([\[#13859](https://github.com/matrix-org/synapse/pull/13859)]([#13859](https://github.com/matrix-org/synapse/pull/13859)))
- Correct the comments in the complement dockerfile. ([\[#13867](https://github.com/matrix-org/synapse/pull/13867)]([#13867](https://github.com/matrix-org/synapse/pull/13867)))
- Create a new snapshot of the database schema. ([\[#13873](https://github.com/matrix-org/synapse/pull/13873)]([#13873](https://github.com/matrix-org/synapse/pull/13873)))
- Faster room joins: Send device list updates to most servers in rooms with partial state. ([\[#13874](https://github.com/matrix-org/synapse/pull/13874)]([#13874](https://github.com/matrix-org/synapse/pull/13874)), [\[#14013](https://github.com/matrix-org/synapse/pull/14013)]([#14013](https://github.com/matrix-org/synapse/pull/14013)))
- Add comments to the Prometheus recording rules to make it clear which set of rules you need for Grafana or Prometheus Console. ([\[#13876](https://github.com/matrix-org/synapse/pull/13876)]([#13876](https://github.com/matrix-org/synapse/pull/13876)))
- Only pull relevant backfill points from the database based on the current depth and limit (instead of all) every time we want to `/backfill`. ([\[#13879](https://github.com/matrix-org/synapse/pull/13879)]([#13879](https://github.com/matrix-org/synapse/pull/13879)))
- Faster room joins: Avoid waiting for full state when processing `/keys/changes` requests. ([\[#13888](https://github.com/matrix-org/synapse/pull/13888)]([#13888](https://github.com/matrix-org/synapse/pull/13888)))
- Improve backfill robustness by trying more servers when we get a `4xx` error back. ([\[#13890](https://github.com/matrix-org/synapse/pull/13890)]([#13890](https://github.com/matrix-org/synapse/pull/13890)))
- Fix mypy errors with canonicaljson 1.6.3. ([\[#13905](https://github.com/matrix-org/synapse/pull/13905)]([#13905](https://github.com/matrix-org/synapse/pull/13905)))
- Faster remote room joins: correctly handle remote device list updates during a partial join. ([\[#13913](https://github.com/matrix-org/synapse/pull/13913)]([#13913](https://github.com/matrix-org/synapse/pull/13913)))
- Complement image: propagate SIGTERM to all workers. ([\[#13914](https://github.com/matrix-org/synapse/pull/13914)]([#13914](https://github.com/matrix-org/synapse/pull/13914)))
- Update an innaccurate comment in Synapse's upsert database helper. ([\[#13924](https://github.com/matrix-org/synapse/pull/13924)]([#13924](https://github.com/matrix-org/synapse/pull/13924)))
- Update mypy (0.950 -> 0.981) and mypy-zope (0.3.7 -> 0.3.11). ([\[#13925](https://github.com/matrix-org/synapse/pull/13925)]([#13925](https://github.com/matrix-org/synapse/pull/13925)), [\[#13993](https://github.com/matrix-org/synapse/pull/13993)]([#13993](https://github.com/matrix-org/synapse/pull/13993)))
- Use dedicated `get_local_users_in_room(room_id)` function to find local users when calculating users to copy over during a room upgrade. ([\[#13960](https://github.com/matrix-org/synapse/pull/13960)]([#13960](https://github.com/matrix-org/synapse/pull/13960)))
- Refactor language in user directory `_track_user_joined_room` code to make it more clear that we use both local and remote users. ([\[#13966](https://github.com/matrix-org/synapse/pull/13966)]([#13966](https://github.com/matrix-org/synapse/pull/13966)))
- Revert catch-all exceptions being recorded as event pull attempt failures (only handle what we know about). ([\[#13969](https://github.com/matrix-org/synapse/pull/13969)]([#13969](https://github.com/matrix-org/synapse/pull/13969)))
- Speed up calculating push actions in large rooms. ([\[#13973](https://github.com/matrix-org/synapse/pull/13973)]([#13973](https://github.com/matrix-org/synapse/pull/13973)), [\[#13992](https://github.com/matrix-org/synapse/pull/13992)]([#13992](https://github.com/matrix-org/synapse/pull/13992)))
- Enable update notifications from Github's dependabot. ([\[#13976](https://github.com/matrix-org/synapse/pull/13976)]([#13976](https://github.com/matrix-org/synapse/pull/13976)))
- Prototype a workflow to automatically add changelogs to dependabot PRs. ([\[#13998](https://github.com/matrix-org/synapse/pull/13998)]([#13998](https://github.com/matrix-org/synapse/pull/13998)), [\[#14011](https://github.com/matrix-org/synapse/pull/14011)]([#14011](https://github.com/matrix-org/synapse/pull/14011)), [\[#14017](https://github.com/matrix-org/synapse/pull/14017)]([#14017](https://github.com/matrix-org/synapse/pull/14017)), [\[#14021](https://github.com/matrix-org/synapse/pull/14021)]([#14021](https://github.com/matrix-org/synapse/pull/14021)), [\[#14027](https://github.com/matrix-org/synapse/pull/14027)]([#14027](https://github.com/matrix-org/synapse/pull/14027)))
- Fix type annotations to be compatible with new annotations in development versions of twisted. ([\[#14012](https://github.com/matrix-org/synapse/pull/14012)]([#14012](https://github.com/matrix-org/synapse/pull/14012)))
- Clear out stale entries in `event_push_actions_staging` table. ([\[#14020](https://github.com/matrix-org/synapse/pull/14020)]([#14020](https://github.com/matrix-org/synapse/pull/14020)))
- Bump versions of GitHub actions. ([\[#13978](https://github.com/matrix-org/synapse/pull/13978)]([#13978](https://github.com/matrix-org/synapse/pull/13978)), [\[#13979](https://github.com/matrix-org/synapse/pull/13979)]([#13979](https://github.com/matrix-org/synapse/pull/13979)), [\[#13980](https://github.com/matrix-org/synapse/pull/13980)]([#13980](https://github.com/matrix-org/synapse/pull/13980)), [\[#13982](https://github.com/matrix-org/synapse/pull/13982)]([#13982](https://github.com/matrix-org/synapse/pull/13982)), [\[#14015](https://github.com/matrix-org/synapse/pull/14015)]([#14015](https://github.com/matrix-org/synapse/pull/14015)), [\[#14019](https://github.com/matrix-org/synapse/pull/14019)]([#14019](https://github.com/matrix-org/synapse/pull/14019)), [\[#14022](https://github.com/matrix-org/synapse/pull/14022)]([#14022](https://github.com/matrix-org/synapse/pull/14022)), [\[#14023](https://github.com/matrix-org/synapse/pull/14023)]([#14023](https://github.com/matrix-org/synapse/pull/14023)))
```

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
mentioned this pull request
[Oct 5, 2022](#ref-issue-1397622455)

[Faster joins: Creating events from local users: Answer queries over federation where we are obligated to answer
#14059](/matrix-org/synapse/issues/14059)

Closed

6 tasks

[Fizzadar](/Fizzadar)
added a commit
to beeper/synapse-legacy-fork
that referenced
this pull request
[Oct 18, 2022](#ref-commit-a5616fb)
[![@Fizzadar](https://avatars.githubusercontent.com/u/1026154?s=40&u=cf88c4d140704f56347ca70c0812610b99a3365b&v=4)](/Fizzadar)

`[Merge tag 'v1.69.0' into merge-1.69.0](/beeper/synapse-legacy-fork/commit/a5616fbf2dc4cb918672c57660a2c08193477e40 "Merge tag 'v1.69.0' into merge-1.69.0

NOTE: this is absolutely *not* safe for Beeper usage as-is. I have merged
all of the Python code in but all our customizations to the base rules
and push rule evaluator are not yet present in the new Rust module. This
will fail tests as-is and future commits will re-apply our changes in
Rust.

Synapse 1.69.0 (2022-10-17)
===========================

Please note that legacy Prometheus metric names are now deprecated and will be removed in Synapse 1.73.0.
Server administrators should update their dashboards and alerting rules to avoid using the deprecated metric names.
See the [upgrade notes](https://matrix-org.github.io/synapse/v1.69/upgrade.html#upgrading-to-v1690) for more details.

No significant changes since 1.69.0rc4.

Synapse 1.69.0rc4 (2022-10-14)
==============================

Bugfixes
--------

- Fix poor performance of the `event_push_backfill_thread_id` background update, which was introduced in Synapse 1.68.0rc1. ([\#14172](https://github.com/matrix-org/synapse/issues/14172), [\#14181](https://github.com/matrix-org/synapse/issues/14181))

Updates to the Docker image
---------------------------

- Fix docker build OOMing in CI for arm64 builds. ([\#14173](https://github.com/matrix-org/synapse/issues/14173))

Synapse 1.69.0rc3 (2022-10-12)
==============================

Bugfixes
--------

- Fix an issue with Docker images causing the Rust dependencies to not be pinned correctly. Introduced in v1.68.0 ([\#14129](https://github.com/matrix-org/synapse/issues/14129))
- Fix a bug introduced in Synapse 1.69.0rc1 which would cause registration replication requests to fail if the worker sending the request is not running Synapse 1.69. ([\#14135](https://github.com/matrix-org/synapse/issues/14135))
- Fix error in background update when rotating existing notifications. Introduced in v1.69.0rc2. ([\#14138](https://github.com/matrix-org/synapse/issues/14138))

Internal Changes
----------------

- Rename the `url_preview` extra to `url-preview`, for compatability with poetry-core 1.3.0 and [PEP 685](https://peps.python.org/pep-0685/). From-source installations using this extra will need to install using the new name. ([\#14085](https://github.com/matrix-org/synapse/issues/14085))

Synapse 1.69.0rc2 (2022-10-06)
==============================

Deprecations and Removals
-------------------------

- Deprecate the `generate_short_term_login_token` method in favor of an async `create_login_token` method in the Module API. ([\#13842](https://github.com/matrix-org/synapse/issues/13842))

Internal Changes
----------------

- Ensure Synapse v1.69 works with upcoming database changes in v1.70. ([\#14045](https://github.com/matrix-org/synapse/issues/14045))
- Fix a bug introduced in Synapse v1.68.0 where messages could not be sent in rooms with non-integer `notifications` power level. ([\#14073](https://github.com/matrix-org/synapse/issues/14073))
- Temporarily pin build-system requirements to workaround an incompatibility with poetry-core 1.3.0. This will be reverted before the v1.69.0 release proper, see [\#14079](https://github.com/matrix-org/synapse/issues/14079). ([\#14080](https://github.com/matrix-org/synapse/issues/14080))

Synapse 1.69.0rc1 (2022-10-04)
==============================

Features
--------

- Allow application services to set the `origin_server_ts` of a state event by providing the query parameter `ts` in [`PUT /_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}`](https://spec.matrix.org/v1.4/client-server-api/#put_matrixclientv3roomsroomidstateeventtypestatekey), per [MSC3316](https://github.com/matrix-org/matrix-doc/pull/3316). Contributed by @lukasdenk. ([\#11866](https://github.com/matrix-org/synapse/issues/11866))
- Allow server admins to require a manual approval process before new accounts can be used (using [MSC3866](https://github.com/matrix-org/matrix-spec-proposals/pull/3866)). ([\#13556](https://github.com/matrix-org/synapse/issues/13556))
- Exponentially backoff from backfilling the same event over and over. ([\#13635](https://github.com/matrix-org/synapse/issues/13635), [\#13936](https://github.com/matrix-org/synapse/issues/13936))
- Add cache invalidation across workers to module API. ([\#13667](https://github.com/matrix-org/synapse/issues/13667), [\#13947](https://github.com/matrix-org/synapse/issues/13947))
- Experimental implementation of [MSC3882](https://github.com/matrix-org/matrix-spec-proposals/pull/3882) to allow an existing device/session to generate a login token for use on a new device/session. ([\#13722](https://github.com/matrix-org/synapse/issues/13722), [\#13868](https://github.com/matrix-org/synapse/issues/13868))
- Experimental support for thread-specific receipts ([MSC3771](https://github.com/matrix-org/matrix-spec-proposals/pull/3771)). ([\#13782](https://github.com/matrix-org/synapse/issues/13782), [\#13893](https://github.com/matrix-org/synapse/issues/13893), [\#13932](https://github.com/matrix-org/synapse/issues/13932), [\#13937](https://github.com/matrix-org/synapse/issues/13937), [\#13939](https://github.com/matrix-org/synapse/issues/13939))
- Add experimental support for [MSC3881: Remotely toggle push notifications for another client](https://github.com/matrix-org/matrix-spec-proposals/pull/3881). ([\#13799](https://github.com/matrix-org/synapse/issues/13799), [\#13831](https://github.com/matrix-org/synapse/issues/13831), [\#13860](https://github.com/matrix-org/synapse/issues/13860))
- Keep track when an event pulled over federation fails its signature check so we can intelligently back-off in the future. ([\#13815](https://github.com/matrix-org/synapse/issues/13815))
- Improve validation for the unspecced, internal-only `_matrix/client/unstable/add_threepid/msisdn/submit_token` endpoint. ([\#13832](https://github.com/matrix-org/synapse/issues/13832))
- Faster remote room joins: record _when_ we first partial-join to a room. ([\#13892](https://github.com/matrix-org/synapse/issues/13892))
- Support a `dir` parameter on the `/relations` endpoint per [MSC3715](https://github.com/matrix-org/matrix-doc/pull/3715). ([\#13920](https://github.com/matrix-org/synapse/issues/13920))
- Ask mail servers receiving emails from Synapse to not send automatic replies (e.g. out-of-office responses). ([\#13957](https://github.com/matrix-org/synapse/issues/13957))

Bugfixes
--------

- Send push notifications for invites received over federation. ([\#13719](https://github.com/matrix-org/synapse/issues/13719), [\#14014](https://github.com/matrix-org/synapse/issues/14014))
- Fix a long-standing bug where typing events would be accepted from remote servers not present in a room. Also fix a bug where incoming typing events would cause other incoming events to get stuck during a fast join. ([\#13830](https://github.com/matrix-org/synapse/issues/13830))
- Fix a bug introduced in Synapse v1.53.0 where the experimental implementation of [MSC3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715) would give incorrect results when paginating forward. ([\#13840](https://github.com/matrix-org/synapse/issues/13840))
- Fix access token leak to logs from proxy agent. ([\#13855](https://github.com/matrix-org/synapse/issues/13855))
- Fix `have_seen_event` cache not being invalidated after we persist an event which causes inefficiency effects like extra `/state` federation calls. ([\#13863](https://github.com/matrix-org/synapse/issues/13863))
- Faster room joins: Fix a bug introduced in 1.66.0 where an error would be logged when syncing after joining a room. ([\#13872](https://github.com/matrix-org/synapse/issues/13872))
- Fix a bug introduced in 1.66.0 where some required fields in the pushrules sent to clients were not present anymore. Contributed by Nico. ([\#13904](https://github.com/matrix-org/synapse/issues/13904))
- Fix packaging to include `Cargo.lock` in `sdist`. ([\#13909](https://github.com/matrix-org/synapse/issues/13909))
- Fix a long-standing bug where device updates could cause delays sending out to-device messages over federation. ([\#13922](https://github.com/matrix-org/synapse/issues/13922))
- Fix a bug introduced in v1.68.0 where Synapse would require `setuptools_rust` at runtime, even though the package is only required at build time. ([\#13952](https://github.com/matrix-org/synapse/issues/13952))
- Fix a long-standing bug where `POST /_matrix/client/v3/keys/query` requests could result in excessively large SQL queries. ([\#13956](https://github.com/matrix-org/synapse/issues/13956))
- Fix a performance regression in the `get_users_in_room` database query. Introduced in v1.67.0. ([\#13972](https://github.com/matrix-org/synapse/issues/13972))
- Fix a bug introduced in v1.68.0 bug where Rust extension wasn't built in `release` mode when using `poetry install`. ([\#14009](https://github.com/matrix-org/synapse/issues/14009))
- Do not return an unspecified `original_event` field when using the stable `/relations` endpoint. Introduced in Synapse v1.57.0. ([\#14025](https://github.com/matrix-org/synapse/issues/14025))
- Correctly handle a race with device lists when a remote user leaves during a partial join. ([\#13885](https://github.com/matrix-org/synapse/issues/13885))
- Correctly handle sending local device list updates to remote servers during a partial join. ([\#13934](https://github.com/matrix-org/synapse/issues/13934))

Improved Documentation
----------------------

- Add `worker_main_http_uri` for the worker generator bash script. ([\#13772](https://github.com/matrix-org/synapse/issues/13772))
- Update URL for the NixOS module for Synapse. ([\#13818](https://github.com/matrix-org/synapse/issues/13818))
- Fix a mistake in sso_mapping_providers.md: `map_user_attributes` is expected to return `display_name`, not `displayname`. ([\#13836](https://github.com/matrix-org/synapse/issues/13836))
- Fix a cross-link from the registration admin API to the `registration_shared_secret` configuration documentation. ([\#13870](https://github.com/matrix-org/synapse/issues/13870))
- Update the man page for the `hash_password` script to correct the default number of bcrypt rounds performed. ([\#13911](https://github.com/matrix-org/synapse/issues/13911), [\#13930](https://github.com/matrix-org/synapse/issues/13930))
- Emphasize the right reasons when to use `(room_id, event_id)` in a database schema. ([\#13915](https://github.com/matrix-org/synapse/issues/13915))
- Add instruction to contributing guide for running unit tests in parallel. Contributed by @ashfame. ([\#13928](https://github.com/matrix-org/synapse/issues/13928))
- Clarify that the `auto_join_rooms` config option can also be used with Space aliases. ([\#13931](https://github.com/matrix-org/synapse/issues/13931))
- Add some cross references to worker documentation. ([\#13974](https://github.com/matrix-org/synapse/issues/13974))
- Linkify urls in config documentation. ([\#14003](https://github.com/matrix-org/synapse/issues/14003))

Deprecations and Removals
-------------------------

- Remove the `complete_sso_login` method from the Module API which was deprecated in Synapse 1.13.0. ([\#13843](https://github.com/matrix-org/synapse/issues/13843))
- Announce that legacy metric names are deprecated, will be turned off by default in Synapse v1.71.0 and removed altogether in Synapse v1.73.0. See the upgrade notes for more information. ([\#14024](https://github.com/matrix-org/synapse/issues/14024))

Internal Changes
----------------

- Speed up creation of DM rooms. ([\#13487](https://github.com/matrix-org/synapse/issues/13487), [\#13800](https://github.com/matrix-org/synapse/issues/13800))
- Port push rules to using Rust. ([\#13768](https://github.com/matrix-org/synapse/issues/13768), [\#13838](https://github.com/matrix-org/synapse/issues/13838), [\#13889](https://github.com/matrix-org/synapse/issues/13889))
- Optimise get rooms for user calls. Contributed by Nick @ Beeper (@fizzadar). ([\#13787](https://github.com/matrix-org/synapse/issues/13787))
- Update the script which makes full schema dumps. ([\#13792](https://github.com/matrix-org/synapse/issues/13792))
- Use shared methods for cache invalidation when persisting events, remove duplicate codepaths. Contributed by Nick @ Beeper (@fizzadar). ([\#13796](https://github.com/matrix-org/synapse/issues/13796))
- Improve the `synapse.api.auth.Auth` mock used in unit tests. ([\#13809](https://github.com/matrix-org/synapse/issues/13809))
- Faster Remote Room Joins: tell remote homeservers that we are unable to authorise them if they query a room which has partial state on our server. ([\#13823](https://github.com/matrix-org/synapse/issues/13823))
- Carry IdP Session IDs through user-mapping sessions. ([\#13839](https://github.com/matrix-org/synapse/issues/13839))
- Fix the release script not publishing binary wheels. ([\#13850](https://github.com/matrix-org/synapse/issues/13850))
- Raise issue if complement fails with latest deps. ([\#13859](https://github.com/matrix-org/synapse/issues/13859))
- Correct the comments in the complement dockerfile. ([\#13867](https://github.com/matrix-org/synapse/issues/13867))
- Create a new snapshot of the database schema. ([\#13873](https://github.com/matrix-org/synapse/issues/13873))
- Faster room joins: Send device list updates to most servers in rooms with partial state. ([\#13874](https://github.com/matrix-org/synapse/issues/13874), [\#14013](https://github.com/matrix-org/synapse/issues/14013))
- Add comments to the Prometheus recording rules to make it clear which set of rules you need for Grafana or Prometheus Console. ([\#13876](https://github.com/matrix-org/synapse/issues/13876))
- Only pull relevant backfill points from the database based on the current depth and limit (instead of all) every time we want to `/backfill`. ([\#13879](https://github.com/matrix-org/synapse/issues/13879))
- Faster room joins: Avoid waiting for full state when processing `/keys/changes` requests. ([\#13888](https://github.com/matrix-org/synapse/issues/13888))
- Improve backfill robustness by trying more servers when we get a `4xx` error back. ([\#13890](https://github.com/matrix-org/synapse/issues/13890))
- Fix mypy errors with canonicaljson 1.6.3. ([\#13905](https://github.com/matrix-org/synapse/issues/13905))
- Faster remote room joins: correctly handle remote device list updates during a partial join. ([\#13913](https://github.com/matrix-org/synapse/issues/13913))
- Complement image: propagate SIGTERM to all workers. ([\#13914](https://github.com/matrix-org/synapse/issues/13914))
- Update an innaccurate comment in Synapse's upsert database helper. ([\#13924](https://github.com/matrix-org/synapse/issues/13924))
- Update mypy (0.950 -> 0.981) and mypy-zope (0.3.7 -> 0.3.11). ([\#13925](https://github.com/matrix-org/synapse/issues/13925), [\#13993](https://github.com/matrix-org/synapse/issues/13993))
- Use dedicated `get_local_users_in_room(room_id)` function to find local users when calculating users to copy over during a room upgrade. ([\#13960](https://github.com/matrix-org/synapse/issues/13960))
- Refactor language in user directory `_track_user_joined_room` code to make it more clear that we use both local and remote users. ([\#13966](https://github.com/matrix-org/synapse/issues/13966))
- Revert catch-all exceptions being recorded as event pull attempt failures (only handle what we know about). ([\#13969](https://github.com/matrix-org/synapse/issues/13969))
- Speed up calculating push actions in large rooms. ([\#13973](https://github.com/matrix-org/synapse/issues/13973), [\#13992](https://github.com/matrix-org/synapse/issues/13992))
- Enable update notifications from Github's dependabot. ([\#13976](https://github.com/matrix-org/synapse/issues/13976))
- Prototype a workflow to automatically add changelogs to dependabot PRs. ([\#13998](https://github.com/matrix-org/synapse/issues/13998), [\#14011](https://github.com/matrix-org/synapse/issues/14011), [\#14017](https://github.com/matrix-org/synapse/issues/14017), [\#14021](https://github.com/matrix-org/synapse/issues/14021), [\#14027](https://github.com/matrix-org/synapse/issues/14027))
- Fix type annotations to be compatible with new annotations in development versions of twisted. ([\#14012](https://github.com/matrix-org/synapse/issues/14012))
- Clear out stale entries in `event_push_actions_staging` table. ([\#14020](https://github.com/matrix-org/synapse/issues/14020))
- Bump versions of GitHub actions. ([\#13978](https://github.com/matrix-org/synapse/issues/13978), [\#13979](https://github.com/matrix-org/synapse/issues/13979), [\#13980](https://github.com/matrix-org/synapse/issues/13980), [\#13982](https://github.com/matrix-org/synapse/issues/13982), [\#14015](https://github.com/matrix-org/synapse/issues/14015), [\#14019](https://github.com/matrix-org/synapse/issues/14019), [\#14022](https://github.com/matrix-org/synapse/issues/14022), [\#14023](https://github.com/matrix-org/synapse/issues/14023))

# -----BEGIN PGP SIGNATURE-----
#
# iQFEBAABCgAuFiEEBTGR3/RnAzBGUif3pULk7RsPrAkFAmNNMOMQHGVyaWtAbWF0
# cml4Lm9yZwAKCRClQuTtGw+sCVnjB/9jpJRVnicteEpDfVX9iLo2qfIfcO/GhUJK
# pJhv4yuY9whAldvJpmNw2f9tfUbAMcvrjlFvNrjihWmXcAGFazC6i3fNBjPgZW2e
# Sxsuuy8xc9X/OqH2EUpHtNZQX3FfSbdBS93Z62ZO3R8tEbCQvjw6FXBdjjjf5uLO
# y5Lsx94+41FJYOhs1Kt4fN92B9WMACR6e/O1YcsDjIXsoZI3uqO1h8filbQIZee7
# DTATE7eIPtShs2Ezaaeuc7tZGVDyPvgWIbuxuT6OGx20zmuChYJgIcVaD1me4UzJ
# i9bVigtpYN0eUxuWnjLf7YC6Ys/Y9wZ7/lhdgaBwdbQKEJdpi+S4
# =JWaO
# -----END PGP SIGNATURE-----
# gpg: Signature made Mon Oct 17 11:39:31 2022 BST
# gpg:                using RSA key 053191DFF4670330465227F7A542E4ED1B0FAC09
# gpg:                issuer \"erik@matrix.org\"
# gpg: Can't check signature: No public key

# Conflicts:
#	docker/Dockerfile
#	pyproject.toml
#	synapse/_scripts/update_synapse_database.py
#	synapse/handlers/message.py
#	synapse/handlers/receipts.py
#	synapse/logging/context.py
#	synapse/push/baserules.py
#	synapse/push/bulk_push_rule_evaluator.py
#	synapse/push/push_rule_evaluator.py
#	synapse/replication/http/send_event.py
#	synapse/rest/admin/users.py
#	synapse/rest/client/read_marker.py
#	synapse/rest/client/receipts.py
#	synapse/rest/client/room.py
#	synapse/storage/_base.py
#	synapse/storage/databases/main/__init__.py
#	synapse/storage/databases/main/cache.py
#	synapse/storage/databases/main/events.py
#	synapse/storage/databases/main/receipts.py
#	tests/push/test_push_rule_evaluator.py")`
…

`[a5616fb](/beeper/synapse-legacy-fork/commit/a5616fbf2dc4cb918672c57660a2c08193477e40)`

```
NOTE: this is absolutely *not* safe for Beeper usage as-is. I have merged
all of the Python code in but all our customizations to the base rules
and push rule evaluator are not yet present in the new Rust module. This
will fail tests as-is and future commits will re-apply our changes in
Rust.

Synapse 1.69.0 (2022-10-17)
===========================

Please note that legacy Prometheus metric names are now deprecated and will be removed in Synapse 1.73.0.
Server administrators should update their dashboards and alerting rules to avoid using the deprecated metric names.
See the [upgrade notes](<https://matrix-org.github.io/synapse/v1.69/upgrade.html#upgrading-to-v1690>) for more details.

No significant changes since 1.69.0rc4.

Synapse 1.69.0rc4 (2022-10-14)
==============================

Bugfixes
--------

- Fix poor performance of the `event_push_backfill_thread_id` background update, which was introduced in Synapse 1.68.0rc1. ([\[matrix-org#14172](https://github.com/matrix-org/synapse/pull/14172)]([matrix-org#14172](https://github.com/matrix-org/synapse/pull/14172)), [\[matrix-org#14181](https://github.com/matrix-org/synapse/pull/14181)]([matrix-org#14181](https://github.com/matrix-org/synapse/pull/14181)))

Updates to the Docker image
---------------------------

- Fix docker build OOMing in CI for arm64 builds. ([\[matrix-org#14173](https://github.com/matrix-org/synapse/pull/14173)]([matrix-org#14173](https://github.com/matrix-org/synapse/pull/14173)))

Synapse 1.69.0rc3 (2022-10-12)
==============================

Bugfixes
--------

- Fix an issue with Docker images causing the Rust dependencies to not be pinned correctly. Introduced in v1.68.0 ([\[matrix-org#14129](https://github.com/matrix-org/synapse/pull/14129)]([matrix-org#14129](https://github.com/matrix-org/synapse/pull/14129)))
- Fix a bug introduced in Synapse 1.69.0rc1 which would cause registration replication requests to fail if the worker sending the request is not running Synapse 1.69. ([\[matrix-org#14135](https://github.com/matrix-org/synapse/pull/14135)]([matrix-org#14135](https://github.com/matrix-org/synapse/pull/14135)))
- Fix error in background update when rotating existing notifications. Introduced in v1.69.0rc2. ([\[matrix-org#14138](https://github.com/matrix-org/synapse/pull/14138)]([matrix-org#14138](https://github.com/matrix-org/synapse/pull/14138)))

Internal Changes
----------------

- Rename the `url_preview` extra to `url-preview`, for compatability with poetry-core 1.3.0 and [PEP 685](<https://peps.python.org/pep-0685/>). From-source installations using this extra will need to install using the new name. ([\[matrix-org#14085](https://github.com/matrix-org/synapse/pull/14085)]([matrix-org#14085](https://github.com/matrix-org/synapse/pull/14085)))

Synapse 1.69.0rc2 (2022-10-06)
==============================

Deprecations and Removals
-------------------------

- Deprecate the `generate_short_term_login_token` method in favor of an async `create_login_token` method in the Module API. ([\[matrix-org#13842](https://github.com/matrix-org/synapse/pull/13842)]([matrix-org#13842](https://github.com/matrix-org/synapse/pull/13842)))

Internal Changes
----------------

- Ensure Synapse v1.69 works with upcoming database changes in v1.70. ([\[matrix-org#14045](https://github.com/matrix-org/synapse/pull/14045)]([matrix-org#14045](https://github.com/matrix-org/synapse/pull/14045)))
- Fix a bug introduced in Synapse v1.68.0 where messages could not be sent in rooms with non-integer `notifications` power level. ([\[matrix-org#14073](https://github.com/matrix-org/synapse/pull/14073)]([matrix-org#14073](https://github.com/matrix-org/synapse/pull/14073)))
- Temporarily pin build-system requirements to workaround an incompatibility with poetry-core 1.3.0. This will be reverted before the v1.69.0 release proper, see [\[matrix-org#14079](https://github.com/matrix-org/synapse/issues/14079)]([matrix-org#14079](https://github.com/matrix-org/synapse/issues/14079)). ([\[matrix-org#14080](https://github.com/matrix-org/synapse/pull/14080)]([matrix-org#14080](https://github.com/matrix-org/synapse/pull/14080)))

Synapse 1.69.0rc1 (2022-10-04)
==============================

Features
--------

- Allow application services to set the `origin_server_ts` of a state event by providing the query parameter `ts` in [`PUT /_matrix/client/r0/rooms/{roomId}/state/{eventType}/{stateKey}`](<https://spec.matrix.org/v1.4/client-server-api/#put_matrixclientv3roomsroomidstateeventtypestatekey>), per [MSC3316]([matrix-org/matrix-spec-proposals#3316](https://github.com/matrix-org/matrix-spec-proposals/pull/3316)). Contributed by [@lukasdenk](https://github.com/lukasdenk). ([\[matrix-org#11866](https://github.com/matrix-org/synapse/pull/11866)]([matrix-org#11866](https://github.com/matrix-org/synapse/pull/11866)))
- Allow server admins to require a manual approval process before new accounts can be used (using [MSC3866]([matrix-org/matrix-spec-proposals#3866](https://github.com/matrix-org/matrix-spec-proposals/pull/3866))). ([\[matrix-org#13556](https://github.com/matrix-org/synapse/pull/13556)]([matrix-org#13556](https://github.com/matrix-org/synapse/pull/13556)))
- Exponentially backoff from backfilling the same event over and over. ([\[matrix-org#13635](https://github.com/matrix-org/synapse/pull/13635)]([matrix-org#13635](https://github.com/matrix-org/synapse/pull/13635)), [\[matrix-org#13936](https://github.com/matrix-org/synapse/pull/13936)]([matrix-org#13936](https://github.com/matrix-org/synapse/pull/13936)))
- Add cache invalidation across workers to module API. ([\[matrix-org#13667](https://github.com/matrix-org/synapse/pull/13667)]([matrix-org#13667](https://github.com/matrix-org/synapse/pull/13667)), [\[matrix-org#13947](https://github.com/matrix-org/synapse/pull/13947)]([matrix-org#13947](https://github.com/matrix-org/synapse/pull/13947)))
- Experimental implementation of [MSC3882]([matrix-org/matrix-spec-proposals#3882](https://github.com/matrix-org/matrix-spec-proposals/pull/3882)) to allow an existing device/session to generate a login token for use on a new device/session. ([\[matrix-org#13722](https://github.com/matrix-org/synapse/pull/13722)]([matrix-org#13722](https://github.com/matrix-org/synapse/pull/13722)), [\[matrix-org#13868](https://github.com/matrix-org/synapse/pull/13868)]([matrix-org#13868](https://github.com/matrix-org/synapse/pull/13868)))
- Experimental support for thread-specific receipts ([MSC3771]([matrix-org/matrix-spec-proposals#3771](https://github.com/matrix-org/matrix-spec-proposals/pull/3771))). ([\[matrix-org#13782](https://github.com/matrix-org/synapse/pull/13782)]([matrix-org#13782](https://github.com/matrix-org/synapse/pull/13782)), [\[matrix-org#13893](https://github.com/matrix-org/synapse/pull/13893)]([matrix-org#13893](https://github.com/matrix-org/synapse/pull/13893)), [\[matrix-org#13932](https://github.com/matrix-org/synapse/pull/13932)]([matrix-org#13932](https://github.com/matrix-org/synapse/pull/13932)), [\[matrix-org#13937](https://github.com/matrix-org/synapse/pull/13937)]([matrix-org#13937](https://github.com/matrix-org/synapse/pull/13937)), [\[matrix-org#13939](https://github.com/matrix-org/synapse/pull/13939)]([matrix-org#13939](https://github.com/matrix-org/synapse/pull/13939)))
- Add experimental support for [MSC3881: Remotely toggle push notifications for another client]([matrix-org/matrix-spec-proposals#3881](https://github.com/matrix-org/matrix-spec-proposals/pull/3881)). ([\[matrix-org#13799](https://github.com/matrix-org/synapse/pull/13799)]([matrix-org#13799](https://github.com/matrix-org/synapse/pull/13799)), [\[matrix-org#13831](https://github.com/matrix-org/synapse/pull/13831)]([matrix-org#13831](https://github.com/matrix-org/synapse/pull/13831)), [\[matrix-org#13860](https://github.com/matrix-org/synapse/pull/13860)]([matrix-org#13860](https://github.com/matrix-org/synapse/pull/13860)))
- Keep track when an event pulled over federation fails its signature check so we can intelligently back-off in the future. ([\[matrix-org#13815](https://github.com/matrix-org/synapse/pull/13815)]([matrix-org#13815](https://github.com/matrix-org/synapse/pull/13815)))
- Improve validation for the unspecced, internal-only `_matrix/client/unstable/add_threepid/msisdn/submit_token` endpoint. ([\[matrix-org#13832](https://github.com/matrix-org/synapse/pull/13832)]([matrix-org#13832](https://github.com/matrix-org/synapse/pull/13832)))
- Faster remote room joins: record _when_ we first partial-join to a room. ([\[matrix-org#13892](https://github.com/matrix-org/synapse/pull/13892)]([matrix-org#13892](https://github.com/matrix-org/synapse/pull/13892)))
- Support a `dir` parameter on the `/relations` endpoint per [MSC3715]([matrix-org/matrix-spec-proposals#3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715)). ([\[matrix-org#13920](https://github.com/matrix-org/synapse/pull/13920)]([matrix-org#13920](https://github.com/matrix-org/synapse/pull/13920)))
- Ask mail servers receiving emails from Synapse to not send automatic replies (e.g. out-of-office responses). ([\[matrix-org#13957](https://github.com/matrix-org/synapse/pull/13957)]([matrix-org#13957](https://github.com/matrix-org/synapse/pull/13957)))

Bugfixes
--------

- Send push notifications for invites received over federation. ([\[matrix-org#13719](https://github.com/matrix-org/synapse/pull/13719)]([matrix-org#13719](https://github.com/matrix-org/synapse/pull/13719)), [\[matrix-org#14014](https://github.com/matrix-org/synapse/pull/14014)]([matrix-org#14014](https://github.com/matrix-org/synapse/pull/14014)))
- Fix a long-standing bug where typing events would be accepted from remote servers not present in a room. Also fix a bug where incoming typing events would cause other incoming events to get stuck during a fast join. ([\[matrix-org#13830](https://github.com/matrix-org/synapse/pull/13830)]([matrix-org#13830](https://github.com/matrix-org/synapse/pull/13830)))
- Fix a bug introduced in Synapse v1.53.0 where the experimental implementation of [MSC3715]([matrix-org/matrix-spec-proposals#3715](https://github.com/matrix-org/matrix-spec-proposals/pull/3715)) would give incorrect results when paginating forward. ([\[matrix-org#13840](https://github.com/matrix-org/synapse/pull/13840)]([matrix-org#13840](https://github.com/matrix-org/synapse/pull/13840)))
- Fix access token leak to logs from proxy agent. ([\[matrix-org#13855](https://github.com/matrix-org/synapse/pull/13855)]([matrix-org#13855](https://github.com/matrix-org/synapse/pull/13855)))
- Fix `have_seen_event` cache not being invalidated after we persist an event which causes inefficiency effects like extra `/state` federation calls. ([\[matrix-org#13863](https://github.com/matrix-org/synapse/pull/13863)]([matrix-org#13863](https://github.com/matrix-org/synapse/pull/13863)))
- Faster room joins: Fix a bug introduced in 1.66.0 where an error would be logged when syncing after joining a room. ([\[matrix-org#13872](https://github.com/matrix-org/synapse/pull/13872)]([matrix-org#13872](https://github.com/matrix-org/synapse/pull/13872)))
- Fix a bug introduced in 1.66.0 where some required fields in the pushrules sent to clients were not present anymore. Contributed by Nico. ([\[matrix-org#13904](https://github.com/matrix-org/synapse/pull/13904)]([matrix-org#13904](https://github.com/matrix-org/synapse/pull/13904)))
- Fix packaging to include `Cargo.lock` in `sdist`. ([\[matrix-org#13909](https://github.com/matrix-org/synapse/pull/13909)]([matrix-org#13909](https://github.com/matrix-org/synapse/pull/13909)))
- Fix a long-standing bug where device updates could cause delays sending out to-device messages over federation. ([\[matrix-org#13922](https://github.com/matrix-org/synapse/pull/13922)]([matrix-org#13922](https://github.com/matrix-org/synapse/pull/13922)))
- Fix a bug introduced in v1.68.0 where Synapse would require `setuptools_rust` at runtime, even though the package is only required at build time. ([\[matrix-org#13952](https://github.com/matrix-org/synapse/pull/13952)]([matrix-org#13952](https://github.com/matrix-org/synapse/pull/13952)))
- Fix a long-standing bug where `POST /_matrix/client/v3/keys/query` requests could result in excessively large SQL queries. ([\[matrix-org#13956](https://github.com/matrix-org/synapse/pull/13956)]([matrix-org#13956](https://github.com/matrix-org/synapse/pull/13956)))
- Fix a performance regression in the `get_users_in_room` database query. Introduced in v1.67.0. ([\[matrix-org#13972](https://github.com/matrix-org/synapse/pull/13972)]([matrix-org#13972](https://github.com/matrix-org/synapse/pull/13972)))
- Fix a bug introduced in v1.68.0 bug where Rust extension wasn't built in `release` mode when using `poetry install`. ([\[matrix-org#14009](https://github.com/matrix-org/synapse/pull/14009)]([matrix-org#14009](https://github.com/matrix-org/synapse/pull/14009)))
- Do not return an unspecified `original_event` field when using the stable `/relations` endpoint. Introduced in Synapse v1.57.0. ([\[matrix-org#14025](https://github.com/matrix-org/synapse/pull/14025)]([matrix-org#14025](https://github.com/matrix-org/synapse/pull/14025)))
- Correctly handle a race with device lists when a remote user leaves during a partial join. ([\[matrix-org#13885](https://github.com/matrix-org/synapse/pull/13885)]([matrix-org#13885](https://github.com/matrix-org/synapse/pull/13885)))
- Correctly handle sending local device list updates to remote servers during a partial join. ([\[matrix-org#13934](https://github.com/matrix-org/synapse/pull/13934)]([matrix-org#13934](https://github.com/matrix-org/synapse/pull/13934)))

Improved Documentation
----------------------

- Add `worker_main_http_uri` for the worker generator bash script. ([\[matrix-org#13772](https://github.com/matrix-org/synapse/pull/13772)]([matrix-org#13772](https://github.com/matrix-org/synapse/pull/13772)))
- Update URL for the NixOS module for Synapse. ([\[matrix-org#13818](https://github.com/matrix-org/synapse/pull/13818)]([matrix-org#13818](https://github.com/matrix-org/synapse/pull/13818)))
- Fix a mistake in sso_mapping_providers.md: `map_user_attributes` is expected to return `display_name`, not `displayname`. ([\[matrix-org#13836](https://github.com/matrix-org/synapse/pull/13836)]([matrix-org#13836](https://github.com/matrix-org/synapse/pull/13836)))
- Fix a cross-link from the registration admin API to the `registration_shared_secret` configuration documentation. ([\[matrix-org#13870](https://github.com/matrix-org/synapse/pull/13870)]([matrix-org#13870](https://github.com/matrix-org/synapse/pull/13870)))
- Update the man page for the `hash_password` script to correct the default number of bcrypt rounds performed. ([\[matrix-org#13911](https://github.com/matrix-org/synapse/pull/13911)]([matrix-org#13911](https://github.com/matrix-org/synapse/pull/13911)), [\[matrix-org#13930](https://github.com/matrix-org/synapse/pull/13930)]([matrix-org#13930](https://github.com/matrix-org/synapse/pull/13930)))
- Emphasize the right reasons when to use `(room_id, event_id)` in a database schema. ([\[matrix-org#13915](https://github.com/matrix-org/synapse/pull/13915)]([matrix-org#13915](https://github.com/matrix-org/synapse/pull/13915)))
- Add instruction to contributing guide for running unit tests in parallel. Contributed by [@ashfame](https://github.com/ashfame). ([\[matrix-org#13928](https://github.com/matrix-org/synapse/pull/13928)]([matrix-org#13928](https://github.com/matrix-org/synapse/pull/13928)))
- Clarify that the `auto_join_rooms` config option can also be used with Space aliases. ([\[matrix-org#13931](https://github.com/matrix-org/synapse/pull/13931)]([matrix-org#13931](https://github.com/matrix-org/synapse/pull/13931)))
- Add some cross references to worker documentation. ([\[matrix-org#13974](https://github.com/matrix-org/synapse/pull/13974)]([matrix-org#13974](https://github.com/matrix-org/synapse/pull/13974)))
- Linkify urls in config documentation. ([\[matrix-org#14003](https://github.com/matrix-org/synapse/pull/14003)]([matrix-org#14003](https://github.com/matrix-org/synapse/pull/14003)))

Deprecations and Removals
-------------------------

- Remove the `complete_sso_login` method from the Module API which was deprecated in Synapse 1.13.0. ([\[matrix-org#13843](https://github.com/matrix-org/synapse/pull/13843)]([matrix-org#13843](https://github.com/matrix-org/synapse/pull/13843)))
- Announce that legacy metric names are deprecated, will be turned off by default in Synapse v1.71.0 and removed altogether in Synapse v1.73.0. See the upgrade notes for more information. ([\[matrix-org#14024](https://github.com/matrix-org/synapse/pull/14024)]([matrix-org#14024](https://github.com/matrix-org/synapse/pull/14024)))

Internal Changes
----------------

- Speed up creation of DM rooms. ([\[matrix-org#13487](https://github.com/matrix-org/synapse/pull/13487)]([matrix-org#13487](https://github.com/matrix-org/synapse/pull/13487)), [\[matrix-org#13800](https://github.com/matrix-org/synapse/pull/13800)]([matrix-org#13800](https://github.com/matrix-org/synapse/pull/13800)))
- Port push rules to using Rust. ([\[matrix-org#13768](https://github.com/matrix-org/synapse/pull/13768)]([matrix-org#13768](https://github.com/matrix-org/synapse/pull/13768)), [\[matrix-org#13838](https://github.com/matrix-org/synapse/pull/13838)]([matrix-org#13838](https://github.com/matrix-org/synapse/pull/13838)), [\[matrix-org#13889](https://github.com/matrix-org/synapse/pull/13889)]([matrix-org#13889](https://github.com/matrix-org/synapse/pull/13889)))
- Optimise get rooms for user calls. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[matrix-org#13787](https://github.com/matrix-org/synapse/pull/13787)]([matrix-org#13787](https://github.com/matrix-org/synapse/pull/13787)))
- Update the script which makes full schema dumps. ([\[matrix-org#13792](https://github.com/matrix-org/synapse/pull/13792)]([matrix-org#13792](https://github.com/matrix-org/synapse/pull/13792)))
- Use shared methods for cache invalidation when persisting events, remove duplicate codepaths. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[matrix-org#13796](https://github.com/matrix-org/synapse/pull/13796)]([matrix-org#13796](https://github.com/matrix-org/synapse/pull/13796)))
- Improve the `synapse.api.auth.Auth` mock used in unit tests. ([\[matrix-org#13809](https://github.com/matrix-org/synapse/pull/13809)]([matrix-org#13809](https://github.com/matrix-org/synapse/pull/13809)))
- Faster Remote Room Joins: tell remote homeservers that we are unable to authorise them if they query a room which has partial state on our server. ([\[matrix-org#13823](https://github.com/matrix-org/synapse/pull/13823)]([matrix-org#13823](https://github.com/matrix-org/synapse/pull/13823)))
- Carry IdP Session IDs through user-mapping sessions. ([\[matrix-org#13839](https://github.com/matrix-org/synapse/pull/13839)]([matrix-org#13839](https://github.com/matrix-org/synapse/pull/13839)))
- Fix the release script not publishing binary wheels. ([\[matrix-org#13850](https://github.com/matrix-org/synapse/pull/13850)]([matrix-org#13850](https://github.com/matrix-org/synapse/pull/13850)))
- Raise issue if complement fails with latest deps. ([\[matrix-org#13859](https://github.com/matrix-org/synapse/pull/13859)]([matrix-org#13859](https://github.com/matrix-org/synapse/pull/13859)))
- Correct the comments in the complement dockerfile. ([\[matrix-org#13867](https://github.com/matrix-org/synapse/pull/13867)]([matrix-org#13867](https://github.com/matrix-org/synapse/pull/13867)))
- Create a new snapshot of the database schema. ([\[matrix-org#13873](https://github.com/matrix-org/synapse/pull/13873)]([matrix-org#13873](https://github.com/matrix-org/synapse/pull/13873)))
- Faster room joins: Send device list updates to most servers in rooms with partial state. ([\[matrix-org#13874](https://github.com/matrix-org/synapse/pull/13874)]([matrix-org#13874](https://github.com/matrix-org/synapse/pull/13874)), [\[matrix-org#14013](https://github.com/matrix-org/synapse/pull/14013)]([matrix-org#14013](https://github.com/matrix-org/synapse/pull/14013)))
- Add comments to the Prometheus recording rules to make it clear which set of rules you need for Grafana or Prometheus Console. ([\[matrix-org#13876](https://github.com/matrix-org/synapse/pull/13876)]([matrix-org#13876](https://github.com/matrix-org/synapse/pull/13876)))
- Only pull relevant backfill points from the database based on the current depth and limit (instead of all) every time we want to `/backfill`. ([\[matrix-org#13879](https://github.com/matrix-org/synapse/pull/13879)]([matrix-org#13879](https://github.com/matrix-org/synapse/pull/13879)))
- Faster room joins: Avoid waiting for full state when processing `/keys/changes` requests. ([\[matrix-org#13888](https://github.com/matrix-org/synapse/pull/13888)]([matrix-org#13888](https://github.com/matrix-org/synapse/pull/13888)))
- Improve backfill robustness by trying more servers when we get a `4xx` error back. ([\[matrix-org#13890](https://github.com/matrix-org/synapse/pull/13890)]([matrix-org#13890](https://github.com/matrix-org/synapse/pull/13890)))
- Fix mypy errors with canonicaljson 1.6.3. ([\[matrix-org#13905](https://github.com/matrix-org/synapse/pull/13905)]([matrix-org#13905](https://github.com/matrix-org/synapse/pull/13905)))
- Faster remote room joins: correctly handle remote device list updates during a partial join. ([\[matrix-org#13913](https://github.com/matrix-org/synapse/pull/13913)]([matrix-org#13913](https://github.com/matrix-org/synapse/pull/13913)))
- Complement image: propagate SIGTERM to all workers. ([\[matrix-org#13914](https://github.com/matrix-org/synapse/pull/13914)]([matrix-org#13914](https://github.com/matrix-org/synapse/pull/13914)))
- Update an innaccurate comment in Synapse's upsert database helper. ([\[matrix-org#13924](https://github.com/matrix-org/synapse/pull/13924)]([matrix-org#13924](https://github.com/matrix-org/synapse/pull/13924)))
- Update mypy (0.950 -> 0.981) and mypy-zope (0.3.7 -> 0.3.11). ([\[matrix-org#13925](https://github.com/matrix-org/synapse/pull/13925)]([matrix-org#13925](https://github.com/matrix-org/synapse/pull/13925)), [\[matrix-org#13993](https://github.com/matrix-org/synapse/pull/13993)]([matrix-org#13993](https://github.com/matrix-org/synapse/pull/13993)))
- Use dedicated `get_local_users_in_room(room_id)` function to find local users when calculating users to copy over during a room upgrade. ([\[matrix-org#13960](https://github.com/matrix-org/synapse/pull/13960)]([matrix-org#13960](https://github.com/matrix-org/synapse/pull/13960)))
- Refactor language in user directory `_track_user_joined_room` code to make it more clear that we use both local and remote users. ([\[matrix-org#13966](https://github.com/matrix-org/synapse/pull/13966)]([matrix-org#13966](https://github.com/matrix-org/synapse/pull/13966)))
- Revert catch-all exceptions being recorded as event pull attempt failures (only handle what we know about). ([\[matrix-org#13969](https://github.com/matrix-org/synapse/pull/13969)]([matrix-org#13969](https://github.com/matrix-org/synapse/pull/13969)))
- Speed up calculating push actions in large rooms. ([\[matrix-org#13973](https://github.com/matrix-org/synapse/pull/13973)]([matrix-org#13973](https://github.com/matrix-org/synapse/pull/13973)), [\[matrix-org#13992](https://github.com/matrix-org/synapse/pull/13992)]([matrix-org#13992](https://github.com/matrix-org/synapse/pull/13992)))
- Enable update notifications from Github's dependabot. ([\[matrix-org#13976](https://github.com/matrix-org/synapse/pull/13976)]([matrix-org#13976](https://github.com/matrix-org/synapse/pull/13976)))
- Prototype a workflow to automatically add changelogs to dependabot PRs. ([\[matrix-org#13998](https://github.com/matrix-org/synapse/pull/13998)]([matrix-org#13998](https://github.com/matrix-org/synapse/pull/13998)), [\[matrix-org#14011](https://github.com/matrix-org/synapse/pull/14011)]([matrix-org#14011](https://github.com/matrix-org/synapse/pull/14011)), [\[matrix-org#14017](https://github.com/matrix-org/synapse/pull/14017)]([matrix-org#14017](https://github.com/matrix-org/synapse/pull/14017)), [\[matrix-org#14021](https://github.com/matrix-org/synapse/pull/14021)]([matrix-org#14021](https://github.com/matrix-org/synapse/pull/14021)), [\[matrix-org#14027](https://github.com/matrix-org/synapse/pull/14027)]([matrix-org#14027](https://github.com/matrix-org/synapse/pull/14027)))
- Fix type annotations to be compatible with new annotations in development versions of twisted. ([\[matrix-org#14012](https://github.com/matrix-org/synapse/pull/14012)]([matrix-org#14012](https://github.com/matrix-org/synapse/pull/14012)))
- Clear out stale entries in `event_push_actions_staging` table. ([\[matrix-org#14020](https://github.com/matrix-org/synapse/pull/14020)]([matrix-org#14020](https://github.com/matrix-org/synapse/pull/14020)))
- Bump versions of GitHub actions. ([\[matrix-org#13978](https://github.com/matrix-org/synapse/pull/13978)]([matrix-org#13978](https://github.com/matrix-org/synapse/pull/13978)), [\[matrix-org#13979](https://github.com/matrix-org/synapse/pull/13979)]([matrix-org#13979](https://github.com/matrix-org/synapse/pull/13979)), [\[matrix-org#13980](https://github.com/matrix-org/synapse/pull/13980)]([matrix-org#13980](https://github.com/matrix-org/synapse/pull/13980)), [\[matrix-org#13982](https://github.com/matrix-org/synapse/pull/13982)]([matrix-org#13982](https://github.com/matrix-org/synapse/pull/13982)), [\[matrix-org#14015](https://github.com/matrix-org/synapse/pull/14015)]([matrix-org#14015](https://github.com/matrix-org/synapse/pull/14015)), [\[matrix-org#14019](https://github.com/matrix-org/synapse/pull/14019)]([matrix-org#14019](https://github.com/matrix-org/synapse/pull/14019)), [\[matrix-org#14022](https://github.com/matrix-org/synapse/pull/14022)]([matrix-org#14022](https://github.com/matrix-org/synapse/pull/14022)), [\[matrix-org#14023](https://github.com/matrix-org/synapse/pull/14023)]([matrix-org#14023](https://github.com/matrix-org/synapse/pull/14023)))

# -----BEGIN PGP SIGNATURE-----
#
# iQFEBAABCgAuFiEEBTGR3/RnAzBGUif3pULk7RsPrAkFAmNNMOMQHGVyaWtAbWF0
# cml4Lm9yZwAKCRClQuTtGw+sCVnjB/9jpJRVnicteEpDfVX9iLo2qfIfcO/GhUJK
# pJhv4yuY9whAldvJpmNw2f9tfUbAMcvrjlFvNrjihWmXcAGFazC6i3fNBjPgZW2e
# Sxsuuy8xc9X/OqH2EUpHtNZQX3FfSbdBS93Z62ZO3R8tEbCQvjw6FXBdjjjf5uLO
# y5Lsx94+41FJYOhs1Kt4fN92B9WMACR6e/O1YcsDjIXsoZI3uqO1h8filbQIZee7
# DTATE7eIPtShs2Ezaaeuc7tZGVDyPvgWIbuxuT6OGx20zmuChYJgIcVaD1me4UzJ
# i9bVigtpYN0eUxuWnjLf7YC6Ys/Y9wZ7/lhdgaBwdbQKEJdpi+S4
# =JWaO
# -----END PGP SIGNATURE-----
# gpg: Signature made Mon Oct 17 11:39:31 2022 BST
# gpg:                using RSA key 053191DFF4670330465227F7A542E4ED1B0FAC09
# gpg:                issuer "erik@matrix.org"
# gpg: Can't check signature: No public key

# Conflicts:
#	docker/Dockerfile
#	pyproject.toml
#	synapse/_scripts/update_synapse_database.py
#	synapse/handlers/message.py
#	synapse/handlers/receipts.py
#	synapse/logging/context.py
#	synapse/push/baserules.py
#	synapse/push/bulk_push_rule_evaluator.py
#	synapse/push/push_rule_evaluator.py
#	synapse/replication/http/send_event.py
#	synapse/rest/admin/users.py
#	synapse/rest/client/read_marker.py
#	synapse/rest/client/receipts.py
#	synapse/rest/client/room.py
#	synapse/storage/_base.py
#	synapse/storage/databases/main/__init__.py
#	synapse/storage/databases/main/cache.py
#	synapse/storage/databases/main/events.py
#	synapse/storage/databases/main/receipts.py
#	tests/push/test_push_rule_evaluator.py
```

[![@MatMaul](https://avatars.githubusercontent.com/u/1643573?s=40&v=4)](/MatMaul)
[MatMaul](/MatMaul)
mentioned this pull request
[Nov 10, 2022](#ref-pullrequest-1443704980)

[Faster joins: filter out non local events when a room doesn't have its full state
#14404](/matrix-org/synapse/pull/14404)
 Merged

4 tasks

[jevolk](/jevolk)
added a commit
to jevolk/charybdis
that referenced
this pull request
[Jan 14, 2023](#ref-commit-d5c0e60)
[![@jevolk](https://avatars.githubusercontent.com/u/4682706?s=40&u=027a3dd36931ebe01d7a030a8c86751db09dca5a&v=4)](/jevolk)

`[modules/federation/invite: Workaround](/jevolk/charybdis/commit/d5c0e6063340746a4c49ae6c81a125d86bcde893 "modules/federation/invite: Workaround matrix-org/synapse@c06b2b7142 matrix-org/synapse#13823") [matrix-org/synapse@c06b2b7142](https://github.com/matrix-org/synapse/commit/c06b2b7142) [m…](https://github.com/matrix-org/synapse/pull/13823)`
…

`[d5c0e60](/jevolk/charybdis/commit/d5c0e6063340746a4c49ae6c81a125d86bcde893)`

```
[…atrix-org/synapse#13823](https://github.com/matrix-org/synapse/pull/13823)
```

[Sign up for free](/join?source=comment-repo)
**to subscribe to this conversation on GitHub**.
Already have an account?
[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F13823).

Reviewers

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&v=4)](/DMRobertson) [DMRobertson](/DMRobertson)

DMRobertson approved these changes

Assignees

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&v=4)](/DMRobertson) [DMRobertson](/DMRobertson)

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Faster joins: incoming federation requests during resync may be incorrectly rejected](https://github.com/matrix-org/synapse/issues/13288)

2 participants

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=52&v=4)](/reivilibre) [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=52&v=4)](/DMRobertson)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


