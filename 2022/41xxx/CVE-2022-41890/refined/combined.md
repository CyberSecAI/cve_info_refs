=== Content from github.com_7b789df4_20250115_090320.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F8310bf8dd188ff780e7fc53245058215a05bdbe5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F8310bf8dd188ff780e7fc53245058215a05bdbe5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/8310bf8dd188ff780e7fc53245058215a05bdbe5)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix crash caused by large broadcasting error. There was an int32 over…

[Browse files](/tensorflow/tensorflow/tree/8310bf8dd188ff780e7fc53245058215a05bdbe5)
Browse the repository at this point in the history

```
…flow.

PiperOrigin-RevId: 475677838
```

* Loading branch information

[![@cantonios](https://avatars.githubusercontent.com/u/2538739?s=40&v=4)](/cantonios) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[cantonios](/tensorflow/tensorflow/commits?author=cantonios "View all commits by cantonios")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Sep 20, 2022

1 parent
[d328ffb](/tensorflow/tensorflow/commit/d328ffb31d06ebbb229b3782e9f964003a29c7d8)

commit 8310bf8

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**9 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/core/util

  + tensorflow/core/util/bcast.h
    [bcast.h](#diff-1f7dc728921f1591e45d8853df7ca74257008a46fb8c81832f284de4445429f9)
  + tensorflow/core/util/bcast\_test.cc
    [bcast\_test.cc](#diff-541219f77d37224c88b842285c9cfa06ea3e2900c3ba751141e4393802c41a24)

## There are no files selected for viewing

4 changes: 2 additions & 2 deletions

4
[tensorflow/core/util/bcast.h](#diff-1f7dc728921f1591e45d8853df7ca74257008a46fb8c81832f284de4445429f9 "tensorflow/core/util/bcast.h")

Show comments

[View file](/tensorflow/tensorflow/blob/8310bf8dd188ff780e7fc53245058215a05bdbe5/tensorflow/core/util/bcast.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -134,7 +134,7 @@ BCastList<N>::BCastList(const BCastList::Vec (&x)[N], |
|  |  | typedef BCastList::Vec Vec; |
|  |  |  |
|  |  | // Safely multiplies dimensions taking into account symbolic shapes. |
|  |  | auto mul\_dims = [](int64\_t dim1, int64\_t dim2) -> int64 { |
|  |  | auto mul\_dims = [](int64\_t dim1, int64\_t dim2) -> int64\_t { |
|  |  | return dim1 != 0 && dim2 != 0 && (dim1 < 0 || dim2 < 0) ? -1 : dim1 \* dim2; |
|  |  | }; |
|  |  |  |
| Expand Down  Expand Up | | @@ -199,7 +199,7 @@ BCastList<N>::BCastList(const BCastList::Vec (&x)[N], |
|  |  | } |
|  |  | Vec output; |
|  |  | bool output\_dim\_set = false; |
|  |  | int output\_dim = -1; |
|  |  | int64\_t output\_dim = -1; |
|  |  | bool none\_is\_one = true; |
|  |  | bool set\_one = false; |
|  |  | for (int j = 0; j < largest\_rank; ++j) { |
| Expand Down | |  |

7 changes: 7 additions & 0 deletions

7
[tensorflow/core/util/bcast\_test.cc](#diff-541219f77d37224c88b842285c9cfa06ea3e2900c3ba751141e4393802c41a24 "tensorflow/core/util/bcast_test.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/8310bf8dd188ff780e7fc53245058215a05bdbe5/tensorflow/core/util/bcast_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -375,6 +375,13 @@ TEST(BCastTest, Basic\_Tensor\_Scalar) { |
|  |  | "[11,7,5,3,2]" |
|  |  | "[11,7,5,3,2]" |
|  |  | "[0,1,2,3,4][]"); |
|  |  |  |
|  |  | // int32 edge-case: |
|  |  | EXPECT\_EQ(BCast({1, 2147483648}, {1}), |
|  |  | "[2147483648][1][1][2147483648]" |
|  |  | "[2147483648]" |
|  |  | "[1,2147483648]" |
|  |  | "[0][0,1]"); |
|  |  | } |
|  |  |  |
|  |  | TEST(BCastTest, Basic\_Tensor\_With\_DimSize\_1\_Scalar) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8310bf8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F8310bf8dd188ff780e7fc53245058215a05bdbe5) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ccdb360a_20250115_090321.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-h246-cgh4-7475)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-h246-cgh4-7475)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# `CHECK` fail in `BCast` overflow

Low

[pak-laura](/pak-laura)
published
GHSA-h246-cgh4-7475
Nov 18, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.11.0

## Patched versions

2.8.4, 2.9.3, 2.10.1, 2.11.0

## Description

### Impact

If [`BCast::ToShape`](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/util/bcast.h) is given input larger than an `int32`, it will crash, despite being supposed to handle up to an `int64`. An example can be seen in [`tf.experimental.numpy.outer`](https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/util/bcast.h) by passing in large input to the input `b`.

```
import tensorflow as tf
value = tf.constant(shape=[2, 1024, 1024, 1024], value=False)
tf.experimental.numpy.outer(a=6,b=value)
```
### Patches

We have patched the issue in GitHub commit [8310bf8dd188ff780e7fc53245058215a05bdbe5](https://github.com/tensorflow/tensorflow/commit/8310bf8dd188ff780e7fc53245058215a05bdbe5).

The fix will be included in TensorFlow 2.11. We will also cherrypick this commit on TensorFlow 2.10.1, 2.9.3, and TensorFlow 2.8.4, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Attribution

This vulnerability has been reported by Pattarakrit Rattankul.

### Severity

Low

### CVE ID

CVE-2022-41890

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_af9eef75_20250115_090319.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fmaster%2Ftensorflow%2Fcore%2Futil%2Fbcast.h)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fmaster%2Ftensorflow%2Fcore%2Futil%2Fbcast.h)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 master
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/master)
2. /[tensorflow](/tensorflow/tensorflow/tree/master/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/master/tensorflow/core)
4. /[util](/tensorflow/tensorflow/tree/master/tensorflow/core/util)
/
# bcast.h

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/master/tensorflow/core/util/bcast.h)427 lines (392 loc) · 15.9 KB master
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/master)
2. /[tensorflow](/tensorflow/tensorflow/tree/master/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/master/tensorflow/core)
4. /[util](/tensorflow/tensorflow/tree/master/tensorflow/core/util)
/
# bcast.h

Top
## File metadata and controls

* Code
* Blame

427 lines (392 loc) · 15.9 KB[Raw](https://github.com/tensorflow/tensorflow/raw/refs/heads/master/tensorflow/core/util/bcast.h)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427/\* Copyright 2015 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
#ifndef TENSORFLOW\_CORE\_UTIL\_BCAST\_H\_#define TENSORFLOW\_CORE\_UTIL\_BCAST\_H\_
#include <algorithm>#include <vector>
#include "tensorflow/core/framework/tensor\_shape.h"#include "tensorflow/core/lib/gtl/inlined\_vector.h"#include "tensorflow/core/platform/macros.h"#include "tensorflow/core/platform/types.h"
namespace tensorflow {
// Returns the mapping from the output batch indices to the corresponding// input's batch indices, given the input's "reshape" and "bcast" shapes as// returned by the BCastList helper class. The i'th element denotes the// (flattened) batch index of the input that must be used to compute the i'th// batch output.//inline void ComputeBatchIndices( const int64\_t output\_batch\_size, const absl::InlinedVector<int64\_t, 4UL>& reshape, const absl::InlinedVector<int64\_t, 4UL>& bcast, std::vector<int64\_t>\* out\_indices) { // Populates the mapping in out\_indices. This algorithm is identical to // the following steps: // - Reshape {0, 1, ..., input\_batch\_size - 1} to the input shape. // - Broadcast to the output shape. // - Reshape back to a flat 1D vector. out\_indices->resize(output\_batch\_size); int64\_t num\_output\_elements = 1; int64\_t num\_input\_elements = 1; for (int64\_t i = reshape.size() - 1; i >= 0; --i) { // Replicate the already populated mapping an additional (dim - 1) times. // If we are broadcasting, just copy the existing mapping. // Otherwise, add another dimension from the input shape. const int64\_t dim = std::max(reshape[i], bcast[i]); const int64\_t incr = bcast[i] > 1 ? 0 : num\_input\_elements; for (int64\_t k = 0; k < (dim - 1) \* num\_output\_elements; ++k) { (\*out\_indices)[num\_output\_elements + k] = (\*out\_indices)[k] + incr; } num\_output\_elements \*= dim; num\_input\_elements \*= reshape[i]; }}
template <int N>class BCastList { public: // A vector of int64 representing the shape of tensor. The 0-th // element is the outer-most dimension and the last element is the // inner-most dimension. Note that we do not use TensorShape since // it's more convenient to manipulate Vec directly for this module. typedef absl::InlinedVector<int64\_t, 4UL> Vec;
 // Constructs all helper shapes, following the aforementioned rules. // // If "fewer\_dims\_optimization" is set to true (the default), the // implementation tries to reduce intermediate dimensions needed to be more // efficient. This is transparent to the caller. // // If false, all intermediate shapes (except for grad\_{x,y}\_reduce\_idx()) have // the same number of dimensions as the larger of the two inputs. // // If return\_flattened\_batch\_indices is true, the implementation will compute // for each output member of the flattened output, which batch indices of // each input correspond to it. This is disabled by default. explicit BCastList(const Vec (&x)[N], bool fewer\_dims\_optimization = true, bool return\_flattened\_batch\_indices = false); ~BCastList() = default;
 // Returns true iff two operands are compatible according to the // broadcasting rule. bool IsValid() const { return valid\_; } bool IsBroadcastingRequired() const { return broadcasting\_required\_; }
 // If and only if IsValid(), the following fields can be used in // implementing a broadcasted binary tensor operation according to // the broadcasting rule. const Vec& reshape(int i) const { return reshape\_[i]; } const Vec& bcast(int i) const { return bcast\_[i]; } const Vec& result\_shape() const { return result\_; } const Vec& output\_shape() const { return output\_; } const Vec& grad\_reduce\_idx(int i) const { return grad\_reduce\_idx\_[i]; } int64\_t output\_batch\_size() const { return output\_batch\_size\_; }
 // Returns the mapping from the flattened output batch indices to x's // flattened batch indices. The result is a vector of length // output\_batch\_size(). To compute the i'th batch output, a binary matmul-like // operation should use the `x\_batch\_indices()[i]`th batch index of `x`. // Note: Returns an empty vector if broadcasting is not required. Callers // should only use this when IsBroadcastingRequired() returns true. const std::vector<int64\_t>& batch\_indices(int i) const { return batch\_indices\_[i]; }
 protected: bool valid\_ = true; bool broadcasting\_required\_ = true; Vec reshape\_[N]; Vec bcast\_[N]; Vec result\_; Vec output\_; Vec grad\_reduce\_idx\_[N];
 int64\_t output\_batch\_size\_; std::vector<int64\_t> batch\_indices\_[N];
 static void Reverse(Vec\* shape) { std::reverse(shape->begin(), shape->end()); }
 BCastList(const BCastList&) = delete; void operator=(const BCastList&) = delete;};
template <int N>BCastList<N>::BCastList(const BCastList::Vec (&x)[N], const bool fewer\_dims\_optimization, const bool return\_flattened\_batch\_indices) { typedef BCastList::Vec Vec;
 // Safely multiplies dimensions taking into account symbolic shapes. auto mul\_dims = [](int64\_t dim1, int64\_t dim2) -> int64\_t { return dim1 != 0 && dim2 != 0 && (dim1 < 0 || dim2 < 0) ? -1 : dim1 \* dim2; };
 bool all\_equal = true; size\_t largest\_rank = 0; output\_batch\_size\_ = 1; for (int i = 0; i < N; ++i) { if (x[i] != x[0]) { all\_equal = false; } if (x[i].size() > largest\_rank) { largest\_rank = x[i].size(); } } if (all\_equal) { broadcasting\_required\_ = false; } if (all\_equal && TF\_PREDICT\_TRUE(fewer\_dims\_optimization)) { // Fast path for common case of identical shapes. int64\_t elements = 1; const int rank = x[0].size(); output\_.resize(rank); for (int i = 0; i < rank; i++) { const int64\_t dim = x[0][i]; elements = mul\_dims(elements, dim); output\_[i] = dim; } result\_.push\_back(elements); output\_batch\_size\_ = elements; for (int i = 0; i < N; ++i) { reshape\_[i].push\_back(elements); bcast\_[i].push\_back(1); } // grad\_reduce\_ is left as empty return; }
 // Reverse all the shapes for convenience // After the reverse, 0-th is the inner-most dimension. Vec copy[N]; for (int i = 0; i < N; ++i) { copy[i] = x[i]; Reverse(&copy[i]); }
 // 1-extend and align all vectors. for (int i = 0; i < N; ++i) { if (copy[i].size() < largest\_rank) { copy[i].resize(largest\_rank, 1); } } // Going through each dimension starting from the inner-most // dimension, compares dimension of x and y. They are compatible if // they are equal or either is 1.
 // indices of j-th component of each input. bool prev\_is\_one[N]; bool current\_is\_one[N]; for (int i = 0; i < N; ++i) { prev\_is\_one[i] = false; current\_is\_one[i] = false; } bool output\_dim\_set = false; int64\_t output\_dim = -1; bool none\_is\_one = true; bool set\_one = false; for (int j = 0; j < largest\_rank; ++j) { output\_dim = -1; output\_dim\_set = false; none\_is\_one = true; // Find which indices are 1. for (int i = 0; i < N; ++i) { // Keep track of which indices are 1. if (copy[i][j] == 1) { current\_is\_one[i] = true; none\_is\_one = false; } else { current\_is\_one[i] = false; if (!output\_dim\_set || copy[i][j] == output\_dim) { output\_dim = copy[i][j]; output\_dim\_set = true; } else { valid\_ = false; return; } } } output\_.push\_back(output\_dim\_set ? output\_dim : 1); output\_batch\_size\_ = mul\_dims(output\_batch\_size\_, output\_.back()); // All dimensions are 1. if (!output\_dim\_set) { if (!TF\_PREDICT\_TRUE(fewer\_dims\_optimization)) { for (int i = 0; i < N; ++i) { bcast\_[i].push\_back(1); reshape\_[i].push\_back(1); } result\_.push\_back(1); } for (int i = 0; i < N; ++i) { grad\_reduce\_idx\_[i].push\_back(largest\_rank - 1 - j); } // This will skip updating the previous state to the current one. We'll // explain why this is safe below. // Consider the previous state P, current state C and the next state N. // In the case where N also is all ones (N == C), we'll do the same // optimization here (push back one dimensions if we need to), which is // safe and is expected. // // When N != C, we'll continue as usual. However, we might trigger the // next block if N == P (because we didn't update the previous state). // We trigger the next block if `fewer\_dims\_optimization` is true. // This means that we did not modify and broadcast / reshapes in this // block (we skipped updating, since the one dimensions can be ignored). // In essence, we only need to check whether the previous non-one state is // equal to the current non-one state.
 continue; } else if (TF\_PREDICT\_TRUE(fewer\_dims\_optimization) && std::equal(current\_is\_one, current\_is\_one + N, prev\_is\_one) && set\_one) { // It is a run of the same broadcasting case as last time. // We can reshape the input so that fewer dimensions // are involved in the intermediate computation. result\_.back() = mul\_dims(result\_.back(), output\_dim); for (int i = 0; i < N; ++i) { reshape\_[i].back() = mul\_dims(reshape\_[i].back(), copy[i][j]); bcast\_[i].back() = mul\_dims(bcast\_[i].back(), current\_is\_one[i] ? output\_dim : 1); if (current\_is\_one[i] && !none\_is\_one) { grad\_reduce\_idx\_[i].push\_back(largest\_rank - 1 - j); } } } else { result\_.push\_back(output\_dim); for (int i = 0; i < N; ++i) { reshape\_[i].push\_back(copy[i][j]); bcast\_[i].push\_back(current\_is\_one[i] ? output\_dim : 1); if (current\_is\_one[i] && !none\_is\_one) { grad\_reduce\_idx\_[i].push\_back(largest\_rank - 1 - j); } } } set\_one = true; for (int i = 0; i < N; ++i) { prev\_is\_one[i] = current\_is\_one[i]; } } if (result\_.empty()) { result\_.push\_back(1); for (int i = 0; i < N; ++i) { reshape\_[i].push\_back(1); bcast\_[i].push\_back(1); } } // Do something about batches. for (int i = 0; i < N; ++i) { Reverse(&reshape\_[i]); Reverse(&bcast\_[i]); Reverse(&grad\_reduce\_idx\_[i]); } Reverse(&result\_); Reverse(&output\_); // Only compute batch indices when we need broadcasting, and we aren't doing // needless work (when the output size is 0 or the // return\_flattened\_batch\_indices isn't enabled). if (return\_flattened\_batch\_indices && broadcasting\_required\_ && output\_batch\_size\_ > 0) { for (int i = 0; i < N; ++i) { ComputeBatchIndices(output\_batch\_size\_, reshape\_[i], bcast\_[i], &batch\_indices\_[i]); } }}
// BCast is a helper for broadcasting binary tensor operation.// TensorFlow's broadcasting rule follows that of numpy (See// http://docs.scipy.org/doc/numpy/user/basics.broadcasting.html).//// The rule has the following properties://// 1. suffix matching: the rule starts with the right-most// dimension, and works towards the left-most dimension. Since// TensorFlow is row-major, the right-most dimension (the last// element in the shape of a tensor) is the inner-most, a.k.a.// the fastest changing, dimension.//// 2. Two dimensions are compatible for broadcasting if both are the// same or either is 1.//// BCast takes the shape of two tensors and computes a few vectors of// int32 that are useful for the caller to reshape the tensors, apply// the right broadcasts to them, compute the broadcasted operation,// and possibly the gradients. In a nutshell, the caller is expected// to compute the broadcasted operation as following://// BCast b(x.shape(), y.shape());// output = x.reshape(b.x\_reshape()).broadcast(b.x\_bcast())// \_op\_// y.reshape(b.y\_reshape()).broadcast(b.y\_bcast())//// For the gradient computation,// grad\_x = sum(grad \* backprop\_x(x, y), grad\_x\_reduce\_idx)// .reshape(x.shape())// grad\_y = sum(grad \* backprop\_y(x, y), grad\_y\_reduce\_idx)// .reshape(y.shape())// backprop\_x and backprop\_y are functionals of the binary function "op",// e.g.,// for +, backprop\_x(x, y) = backprop\_y(x, y) = 1;// for \*, backprop\_x(x, y) = y, backprop\_y(x, y) = x;// for /, backprop\_x(x, y) = 1/y, backprop\_y(x, y) = -x/y^2;//// The multiplication in the grad \* backprop\_x itself is also// broadcasting following the same rule.class BCast : public BCastList<2> { public: // Constructs all helper shapes, following the aforementioned rules. // // If "fewer\_dims\_optimization" is set to true (the default), the // implementation tries to reduce intermediate dimensions needed to be more // efficient. This is transparent to the caller. // // If false, all intermediate shapes (except for grad\_{x,y}\_reduce\_idx()) have // the same number of dimensions as the larger of the two inputs. typedef absl::InlinedVector<int64\_t, 4UL> Vec;
 BCast(const Vec& x, const Vec& y, const bool fewer\_dims\_optimization = true, const bool return\_flattened\_batch\_indices = false) : BCastList<2>({x, y}, fewer\_dims\_optimization, return\_flattened\_batch\_indices) {}
 ~BCast() = default;
 // If and only if IsValid(), the following fields can be used in // implementing a broadcasted binary tensor operation according to // the broadcasting rule. const Vec& x\_reshape() const { return reshape\_[0]; } const Vec& x\_bcast() const { return bcast\_[0]; } const Vec& y\_reshape() const { return reshape\_[1]; } const Vec& y\_bcast() const { return bcast\_[1]; } const Vec& result\_shape() const { return result\_; } const Vec& output\_shape() const { return output\_; } const Vec& grad\_x\_reduce\_idx() const { return grad\_reduce\_idx\_[0]; } const Vec& grad\_y\_reduce\_idx() const { return grad\_reduce\_idx\_[1]; }
 // Returns the mapping from the flattened output batch indices to x's // flattened batch indices. The result is a vector of length // output\_batch\_size(). To compute the i'th batch output, a binary matmul-like // operation should use the `x\_batch\_indices()[i]`th batch index of `x`. // Note: Returns an empty vector if broadcasting is not required. Callers // should only use this when IsBroadcastingRequired() returns true. const std::vector<int64\_t>& x\_batch\_indices() const { return batch\_indices\_[0]; } // Returns the mapping from the flattened output batch indices to y's // flattened batch indices. Similar to x\_batch\_indices(). // Note: Returns an empty vector if broadcasting is not required. Callers // should only use this when IsBroadcastingRequired() returns true. const std::vector<int64\_t>& y\_batch\_indices() const { return batch\_indices\_[1]; }
 template <typename IndexType, int NDIMS> static Eigen::array<IndexType, NDIMS> ToIndexArrayType( const BCast::Vec& vec) { CHECK\_EQ(vec.size(), NDIMS); Eigen::array<IndexType, NDIMS> ret; for (int i = 0; i < NDIMS; ++i) ret[i] = vec[i]; return ret; }
 template <int NDIMS> static Eigen::array<Eigen::DenseIndex, NDIMS> ToIndexArray( const BCast::Vec& vec) { return ToIndexArrayType<Eigen::DenseIndex, NDIMS>(vec); }
 // Static helpers. static Vec FromShape(const TensorShape& shape); static TensorShape ToShape(const Vec& vec);
 private: BCast(const BCast&) = delete; void operator=(const BCast&) = delete;};
} // end namespace tensorflow
#endif // TENSORFLOW\_CORE\_UTIL\_BCAST\_H\_

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


