=== Content from phabricator.wikimedia.org_507e19e4_20250114_233615.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT307278)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T307278
# CVE-2022-41766: On action=rollback the message "alreadyrolled" can leak revision deleted user nameClosed, Resolved[Public](/policy/explain/PHID-TASK-kh5iziinxtpp2h7fgmzk/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/307278/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/307278/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* [Protect as security issue](/wmf/escalate-task/307278/)
* [Award Token](/token/give/PHID-TASK-kh5iziinxtpp2h7fgmzk/)
* [Flag For Later](/flag/edit/PHID-TASK-kh5iziinxtpp2h7fgmzk/)

Assigned To

|  | [mmartorana](/p/mmartorana/) |
| --- | --- |

Authored By

|  | [Umherirrender](/p/Umherirrender/) |
| --- | --- |
| Apr 30 2022, 7:28 PM2022-04-30 19:28:29 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Watching)](/project/board/1179/)
* [Security](/tag/security/)
* [MediaWiki-Revision-deletion](/tag/mediawiki-revision-deletion/) [(Backlog)](/project/board/337/)
* [MediaWiki-User-Interface (actions)](/project/view/5151/)
* [Vuln-Infoleak](/tag/vuln-infoleak/)
* [MW-1.39-release](/tag/mw-1.39-release/) [(Blocker)](/project/board/5694/)
* [MW-1.35-release](/tag/mw-1.35-release/) [(Blocker)](/project/board/4035/)
* [MW-1.37-release](/tag/mw-1.37-release/) [(Blocker)](/project/board/4928/)
* [MW-1.38-release](/tag/mw-1.38-release/) [(Blocker)](/project/board/5407/)
* [Patch-For-Review](/tag/patch-for-review/)
* [MW-1.40-notes (1.40.0-wmf.4; 2022-10-03)](/project/view/6051/)
Referenced Files

|  | [F35538751: Screenshot 2022-09-28 at 20-53-34 Action complete - Trunk Test.png](/F35538751) |
| --- | --- |
| Sep 29 2022, 12:54 AM2022-09-29 00:54:59 (UTC+0) |

|  | [F35538605: T307278-master.patch](/F35538605) |
| --- | --- |
| Sep 28 2022, 10:52 PM2022-09-28 22:52:12 (UTC+0) |

|  | [F35538604: T307278-REL1\_38.patch](/F35538604) |
| --- | --- |
| Sep 28 2022, 10:52 PM2022-09-28 22:52:12 (UTC+0) |

|  | [F35485641: 02-T307278.patch](/F35485641) |
| --- | --- |
| Aug 23 2022, 5:06 PM2022-08-23 17:06:04 (UTC+0) |

|  | [F35474504: T307278.patch](/F35474504) |
| --- | --- |
| Aug 18 2022, 3:56 PM2022-08-18 15:56:36 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Krinkle](/p/Krinkle/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [Reedy](/p/Reedy/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

|  | [Umherirrender](/p/Umherirrender/) |
| --- | --- |

# Description

* Create a page with an Rollbacker (but Rollbacker is not Admin)
* Move the page with MalicousUser (to create a null revision)
* Revision delete/suppress the user of the null revision
* Use the rollback from action=history with Rollbacker and the "alreadyrolled" message shows "last edit of MalicousUser" and leak the revdeled user name of the null revision

Good points: The link to action=rollback contains a empty from and does not leak the name.

Bad points: The rollback link is useless, but provided (thats [T6433](/T6433) for move, but the link is also provided for other null revisions like import or protection) and should not be part of this task

Possible a regression from the refactor in [https://gerrit.wikimedia.org/r/c/mediawiki/core/+/675236](https://gerrit.wikimedia.org/r/c/mediawiki/core/%2B/675236)

# Details

Risk Rating Low

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Hide suppressed users from rollback page error messages](https://gerrit.wikimedia.org/r/c/836910) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +8 -1 |
|  | [SECURITY: Hide suppressed users from rollback page error messages](https://gerrit.wikimedia.org/r/c/836900) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_38](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_38) | +7 -1 |
|  | [SECURITY: Hide suppressed users from rollback page error messages](https://gerrit.wikimedia.org/r/c/836905) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_39](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_39) | +8 -1 |
|  | [SECURITY: Hide suppressed users from rollback page error messages](https://gerrit.wikimedia.org/r/c/836896) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_37](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_37) | +7 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T307278)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T311775 [Release MediaWiki 1.35.8/1.37.5/1.38.3](/T311775) |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T311776 [Tracking bug for MediaWiki 1.35.8/1.37.5/1.38.3](/T311776) |
|  |  | Resolved | Security | [mmartorana](/p/mmartorana/) | T307278 [CVE-2022-41766: On action=rollback the message "alreadyrolled" can leak revision deleted user name](/T307278) |

Mentioned In [T311777: Obtain CVEs for 1.35.8/1.37.5/1.38.3 security releases](/T311777)
[T311776: Tracking bug for MediaWiki 1.35.8/1.37.5/1.38.3](/T311776) Mentioned Here [T311776: Tracking bug for MediaWiki 1.35.8/1.37.5/1.38.3](/T311776)
[T6433: rollback/undo link for a page move should revert the move](/T6433)
### Event Timeline

[Umherirrender](/p/Umherirrender/) created this task.[Apr 30 2022, 7:28 PM2022-04-30 19:28:29 (UTC+0)](#7893543)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/4744953/)[Apr 30 2022, 7:28 PM2022-04-30 19:28:30 (UTC+0)](#7893555)[Umherirrender](/p/Umherirrender/) added projects: [MediaWiki-Revision-deletion](/tag/mediawiki-revision-deletion/), [MediaWiki-User-Interface (actions)](/project/view/5151/).[Apr 30 2022, 7:29 PM2022-04-30 19:29:06 (UTC+0)](#7893556)[mmartorana](/p/mmartorana/) claimed this task.[May 4 2022, 7:52 PM2022-05-04 19:52:17 (UTC+0)](#7904744)[mmartorana](/p/mmartorana/) added a project: [Vuln-Infoleak](/tag/vuln-infoleak/).[mmartorana](/p/mmartorana/) changed Risk Rating from N/A to Low.Comment Actions

Hi,

I am working on a patch to fix this issue.

[mmartorana](/p/mmartorana/) changed the task status from Open to In Progress.[May 9 2022, 4:11 PM2022-05-09 16:11:57 (UTC+0)](#7914501)[mmartorana](/p/mmartorana/) triaged this task as Low priority.[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [In Progress](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[May 16 2022, 4:26 PM2022-05-16 16:26:23 (UTC+0)](#7931437)[mmartorana](/p/mmartorana/) added a comment.[Aug 18 2022, 3:56 PM2022-08-18 15:56:36 (UTC+0)](#8166003)Comment Actions

I am proposing this patch to fix this issue:

T307278.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/cvar6uht4y26d5npvub6/PHID-FILE-wyn5xbbu45lozzjuh76f/T307278.patch)

[sbassett](/p/sbassett/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Aug 18 2022, 7:19 PM2022-08-18 19:19:58 (UTC+0)](#8166849)[sbassett](/p/sbassett/) subscribed.[Aug 19 2022, 8:45 PM2022-08-19 20:45:25 (UTC+0)](#8170006)Comment Actions
> In [T307278#8166003](/T307278#8166003), [@mmartorana](/p/mmartorana/) wrote:
>
> I am proposing this patch to fix this issue:
>
> T307278.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/cvar6uht4y26d5npvub6/PHID-FILE-wyn5xbbu45lozzjuh76f/T307278.patch)

+1 just based upon the logic alone. I think we'd want to test this a bit more to see if $userFactory->newFromName( $this->context->msg( 'rev-deleted-user' )->escaped() ); has any unintended consequences. At the very least, MediaWiki doesn't seem to have a problem creating a User object that should work fine:

shell.php
```
>>> $userFactory = \MediaWiki\MediaWikiServices::getInstance()->getUserFactory();
=> MediaWiki\User\UserFactory {#3362}

>>> $revUser = $userFactory->newFromName( RequestContext::getMain()->msg( 'rev-deleted-user' )->escaped() );
=> User {#5855
     +mId: null,
     +mName: "(Username or IP removed)",
     +mActorId: null,
     +mRealName: null,
     +mEmail: null,
     +mTouched: null,
     +mEmailAuthenticated: null,
     +mFrom: "name",
   }
```
[sbassett](/p/sbassett/) moved this task from [In Progress](/project/board/1179/) to [Security Patch To Deploy](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Aug 22 2022, 9:35 PM2022-08-22 21:35:08 (UTC+0)](#8176192)

[Legoktm](/p/Legoktm/) subscribed.[Aug 23 2022, 3:06 PM2022-08-23 15:06:53 (UTC+0)](#8178587)Comment Actions
> In [T307278#8166003](/T307278#8166003), [@mmartorana](/p/mmartorana/) wrote:
>
> I am proposing this patch to fix this issue:
>
> T307278.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/cvar6uht4y26d5npvub6/PHID-FILE-wyn5xbbu45lozzjuh76f/T307278.patch)

It seems weird to squeeze a message into a User object like that. If the issue is the alreadyrolled message leaking the username, we should have a separate message like alreadyrolled-deleted that doesn't output the username, and use that when necessary. Probably that needs to be done in RollbackPage though.

[sbassett](/p/sbassett/) added a parent task: [T311776: Tracking bug for MediaWiki 1.35.8/1.37.5/1.38.3](/T311776).[Aug 23 2022, 3:39 PM2022-08-23 15:39:17 (UTC+0)](#8178692)[sbassett](/p/sbassett/) added a subscriber: [Krinkle](/p/Krinkle/).[Aug 23 2022, 4:06 PM2022-08-23 16:06:07 (UTC+0)](#8178757)Comment Actions

The above patch was deployed to [wmf.25](https://sal.toolforge.org/log/GEtTy4IB8Fs0LHO5w7aY) and [wmf.26](https://sal.toolforge.org/log/5MtPy4IBa_6PSCT9JJR2) this morning. The patch applied fine and didn't seem to cause any issues within the logs, but likely wouldn't anyways, given the scope of the patch and likely affected users. That being said - if anyone has user-suppress rights on a project and would like to further test, that would be great. This is now being tracked as a deployed patch at T276237 and for the next security release at [T311776](/T311776).

Thanks to [@Legoktm](/p/Legoktm/) and [@Krinkle](/p/Krinkle/) for real-time help with the patch prior to deployment. There are a few cleanup items (spacing, message function, patch subject) that need to be cleaned up prior to release - I'll try to get a refactored patch posted soon. And then as [@Legoktm](/p/Legoktm/) notes above, it might make sense to create a more optimal follow-up patch with a new message, etc.

[sbassett](/p/sbassett/) moved this task from [Security Patch To Deploy](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Aug 23 2022, 4:06 PM2022-08-23 16:06:20 (UTC+0)](#8178762)[sbassett](/p/sbassett/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[sbassett](/p/sbassett/) added a comment.[Aug 23 2022, 5:06 PM2022-08-23 17:06:04 (UTC+0)](#8178974)Comment Actions

Refactored patch:

02-T307278.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/3xq3apwjlih4osgaimkq/PHID-FILE-a4ui6x7qb3sdmwbl7xkg/02-T307278.patch)

Changelog:

1. Fixed whitespace issues
2. Condensed comments, changed to // style
3. Use plain() instead of escaped() for rev-deleted-user message
4. Added SECURITY: to patch subject line, removed bug id
5. Slightly changed patch subject text
6. Added Bug: to commit message

Should now pass gerrit at the very least.

[Reedy](/p/Reedy/) added a project: [MW-1.39-release](/tag/mw-1.39-release/).[Sep 25 2022, 6:45 PM2022-09-25 18:45:00 (UTC+0)](#8258232)[Reedy](/p/Reedy/) added projects: [MW-1.35-release](/tag/mw-1.35-release/), [MW-1.37-release](/tag/mw-1.37-release/), [MW-1.38-release](/tag/mw-1.38-release/).[Sep 25 2022, 6:56 PM2022-09-25 18:56:04 (UTC+0)](#8258234)[Reedy](/p/Reedy/) mentioned this in [T311776: Tracking bug for MediaWiki 1.35.8/1.37.5/1.38.3](/T311776).[Sep 25 2022, 7:05 PM2022-09-25 19:05:16 (UTC+0)](#8258240)[Reedy](/p/Reedy/) mentioned this in [T311777: Obtain CVEs for 1.35.8/1.37.5/1.38.3 security releases](/T311777).[Sep 25 2022, 7:11 PM2022-09-25 19:11:18 (UTC+0)](#8258249)

[Reedy](/p/Reedy/) subscribed.[Sep 25 2022, 7:21 PM2022-09-25 19:21:24 (UTC+0)](#8258262)Comment Actions

Patch should be good for REL1\_39 and master, but for REL1\_35, REL1\_37 and REL1\_38, an adjusted patch will be needed due to lack of getAuthority().

[Legoktm](/p/Legoktm/) added a comment.Edited · [Sep 28 2022, 10:52 PM2022-09-28 22:52:12 (UTC+0)](#8270709)Comment Actions

master / REL1\_39 (same, just added Change-Id)

T307278-master.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/k2g2rwj2zktmgkqqexq5/PHID-FILE-hqkssjmjbgoaos66zugo/T307278-master.patch)

REL1\_38 / REL1\_37 (swapped getAuthority() for $user->isAllowedAny(...))

T307278-REL1\_38.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/3zsenogc4jzn3g6jx53w/PHID-FILE-y56v7wjx6gkmtit72jnx/T307278-REL1_38.patch)

for REL1\_35 I need to test, but I \*think\* it's not present. I think it was introduced in [https://gerrit.wikimedia.org/r/c/mediawiki/core/+/675236](https://gerrit.wikimedia.org/r/c/mediawiki/core/%2B/675236) which is 1.37+

[Legoktm](/p/Legoktm/) added a comment.[Sep 29 2022, 12:54 AM2022-09-29 00:54:59 (UTC+0)](#8270843)Comment Actions

Confirmed that REL1\_35 (with no patch) is fine.

[![Screenshot 2022-09-28 at 20-53-34 Action complete - Trunk Test.png (429×1 px, 85 KB)](https://phab.wmfusercontent.org/file/data/gg2wwtmhhz6u7u4yqth4/PHID-FILE-uzxibgxmkaxsjvyrf6z2/preview-Screenshot_2022-09-28_at_20-53-34_Action_complete_-_Trunk_Test.png)](https://phab.wmfusercontent.org/file/data/u73waep6tt2aisbwknw2/PHID-FILE-h35yfroff5hjf4kvk2xc/Screenshot_2022-09-28_at_20-53-34_Action_complete_-_Trunk_Test.png)

[Reedy](/p/Reedy/) renamed this task from On action=rollback the message "alreadyrolled" can leak revision deleted user name to CVE-2022-41766: On action=rollback the message "alreadyrolled" can leak revision deleted user name.[Sep 29 2022, 5:29 PM2022-09-29 17:29:13 (UTC+0)](#8273426)[Reedy](/p/Reedy/) added a subscriber: [gerritbot](/p/gerritbot/).[Reedy](/p/Reedy/) closed this task as Resolved.[Sep 29 2022, 5:38 PM2022-09-29 17:38:58 (UTC+0)](#8273502)[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 6:58 PM2022-09-29 18:58:01 (UTC+0)](#8273743)Comment Actions

Change 836896 had a related patch set uploaded (by Reedy; author: Mmartorana):

[mediawiki/core@REL1\_37] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836896>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Sep 29 2022, 6:58 PM2022-09-29 18:58:03 (UTC+0)](#8273744)Comment Actions

Change 836900 had a related patch set uploaded (by Reedy; author: Mmartorana):

[mediawiki/core@REL1\_38] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836900>

[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 6:59 PM2022-09-29 18:59:03 (UTC+0)](#8273753)Comment Actions

Change 836905 had a related patch set uploaded (by Reedy; author: Mmartorana):

[mediawiki/core@REL1\_39] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836905>

[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 7:00 PM2022-09-29 19:00:34 (UTC+0)](#8273757)Comment Actions

Change 836910 had a related patch set uploaded (by Reedy; author: Mmartorana):

[mediawiki/core@master] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836910>

[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 7:28 PM2022-09-29 19:28:08 (UTC+0)](#8273849)Comment Actions

Change 836896 **merged** by Reedy:

[mediawiki/core@REL1\_37] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836896>

[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 7:35 PM2022-09-29 19:35:31 (UTC+0)](#8273879)Comment Actions

Change 836905 **merged** by jenkins-bot:

[mediawiki/core@REL1\_39] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836905>

[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 7:36 PM2022-09-29 19:36:43 (UTC+0)](#8273883)Comment Actions

Change 836900 **merged** by Reedy:

[mediawiki/core@REL1\_38] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836900>

[gerritbot](/p/gerritbot/) added a comment.[Sep 29 2022, 7:58 PM2022-09-29 19:58:14 (UTC+0)](#8273919)Comment Actions

Change 836910 **merged** by jenkins-bot:

[mediawiki/core@master] SECURITY: Hide suppressed users from rollback page error messages

<https://gerrit.wikimedia.org/r/836910>

[Jdforrester-WMF](/p/Jdforrester-WMF/) added a project: [MW-1.40-notes (1.40.0-wmf.4; 2022-10-03)](/project/view/6051/).[Sep 29 2022, 8:05 PM2022-09-29 20:05:53 (UTC+0)](#8273929)[Reedy](/p/Reedy/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-ia35dhtdg6hzk3v/)" to "Public (No Login Required)".[Nov 1 2022, 6:07 PM2022-11-01 18:07:06 (UTC+0)](#8360771)[Reedy](/p/Reedy/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-tisxxxk2mo5gl76/)" to "All Users".Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
