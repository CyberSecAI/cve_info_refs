=== Content from github.com_b0678ce2_20250114_200954.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fpull%2F630)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fpull%2F630)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  126](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fenvoyproxy%2Fenvoy%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fenvoyproxy%2Fenvoy%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# http: config options for adding custom request headers #630

 Merged

[mattklein123](/mattklein123)
merged 12 commits into
[envoyproxy:master](/envoyproxy/envoy/tree/master "envoyproxy/envoy:master")
from
[amalgam8:add\_request\_headers](/amalgam8/envoy/tree/add_request_headers "amalgam8/envoy:add_request_headers")

Apr 4, 2017

 Merged

# [http: config options for adding custom request headers](#top) #630

[mattklein123](/mattklein123)
merged 12 commits into
[envoyproxy:master](/envoyproxy/envoy/tree/master "envoyproxy/envoy:master")
from
[amalgam8:add\_request\_headers](/amalgam8/envoy/tree/add_request_headers "amalgam8/envoy:add_request_headers")

Apr 4, 2017

[Conversation
25](/envoyproxy/envoy/pull/630)
[Commits
12](/envoyproxy/envoy/pull/630/commits)
[Checks
0](/envoyproxy/envoy/pull/630/checks)
[Files changed](/envoyproxy/envoy/pull/630/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![rshriram](https://avatars.githubusercontent.com/u/8202871?s=60&v=4)](/rshriram)

Copy link

Member

### @rshriram **[rshriram](/rshriram)** commented [Mar 27, 2017](#issue-217303838) • edited Loading

This PR allows the user to insert additional request headers into the HTTP request before it is forwarded by Envoy to the upstream cluster.

There are three levels at which this can be done:

1. At http connection manager level (across virtual hosts)
2. At a single virtual host level (across routes)
3. On a per route basis

These roughly correspond to Nginx's proxy\_set\_headers directive that can be applied at http/server/location block granularities.

Note that headers cannot be overridden. If duplicate headers are provided in Connection Manager, Virtual host and the route, only the first occurrence of the header (i.e. in the connection manager level) is taken into account.

Sorry, something went wrong.

All reactions

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
changed the title
~~Config options for setting custom request headers before forwarding (global)~~
Global config options for adding custom request headers
[Mar 27, 2017](#event-1017018538)

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=80&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)

Copy link

Member

### **[mattklein123](/mattklein123)** commented [Mar 27, 2017](#issuecomment-289509896)

| [@ccaraman](https://github.com/ccaraman) please do first pass review. |
| --- |

All reactions

Sorry, something went wrong.

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 27, 2017](#pullrequestreview-29294182)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[source/common/http/conn\_manager\_utility.cc](/envoyproxy/envoy/pull/630/files#diff-03ebc558c95a058c0563535a9624a50261893ac80f88d6ad247a7a0c9dc05e57)
Outdated

|  |  | @@ -28,6 +28,12 @@ void ConnectionManagerUtility::mutateRequestHeaders(Http::HeaderMap& request\_hea | |
| --- | --- | --- | --- |
|  |  | const Router::Config& route\_config, |
|  |  | Runtime::RandomGenerator& random, |
|  |  | Runtime::Loader& runtime) { |
|  |  | // Add user-specified headers to the request before scrubbing the request headers. |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 27, 2017](#discussion_r108272888)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

General question: Why do we want to add these before scrubbing the headers?

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @rshriram **[rshriram](/rshriram)** [Mar 27, 2017](#discussion_r108285178)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I was chatting with Matt in Gitter. I am going to rework this a bit. I initially thought we could enforce some sort of rules on what headers the user can/cannot add. But the enforcement logic was messy. So, the decision was to have the code be simple. If users add bad configs (e.g., override authority/connection headers, etc.), the behavior will be undefined. We will mention this in the docs.

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 27, 2017](#pullrequestreview-29294351)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[test/common/router/config\_impl\_test.cc](/envoyproxy/envoy/pull/630/files#diff-546f801a2d2ea64fd2bf06c043801ebe5920e94744be6298f923d3e2e145141d)
Outdated

|  |  | @@ -279,6 +284,23 @@ TEST(RouteMatcherTest, TestRoutes) { | |
| --- | --- | --- | --- |
|  |  | Http::LowerCaseString("x-envoy-virtual-cluster")}), |
|  |  | ContainerEq(config.responseHeadersToRemove())); |
|  |  |  |
|  |  | // Request header manipulation testing |
|  |  | { |
|  |  | // At route\_config level |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 27, 2017](#discussion_r108273042)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

nit: incomplete sentence(this line and the next)

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 27, 2017](#pullrequestreview-29297629)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[test/common/router/config\_impl\_test.cc](/envoyproxy/envoy/pull/630/files#diff-546f801a2d2ea64fd2bf06c043801ebe5920e94744be6298f923d3e2e145141d)
Outdated

|  |  | @@ -279,6 +284,23 @@ TEST(RouteMatcherTest, TestRoutes) { | |
| --- | --- | --- | --- |
|  |  | Http::LowerCaseString("x-envoy-virtual-cluster")}), |
|  |  | ContainerEq(config.responseHeadersToRemove())); |
|  |  |  |
|  |  | // Request header manipulation testing |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 27, 2017](#discussion_r108276014)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

nit: full stop at the end of the sentence.

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 27, 2017](#pullrequestreview-29301554)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[test/common/router/config\_impl\_test.cc](/envoyproxy/envoy/pull/630/files#diff-546f801a2d2ea64fd2bf06c043801ebe5920e94744be6298f923d3e2e145141d)
Outdated

|  |  | {Http::LowerCaseString("Connection"), "Keep-Alive"}})), |
| --- | --- | --- |
|  |  | ContainerEq(config.requestHeadersToAdd())); |
|  |  |  |
|  |  | Http::TestHeaderMapImpl headers = genHeaders("api.lyft.com", "/host/rewrite/me", "GET"); |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 27, 2017](#discussion_r108279725) • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

finalizeRequestHeaders doesn't invoke the added logic for `request_headers_to_add`. Please add a test to <https://github.com/lyft/envoy/blob/master/test/common/http/conn_manager_utility_test.cc>

Sorry, something went wrong.

All reactions

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
changed the title
~~Global config options for adding custom request headers~~
config options for adding custom request headers
[Mar 28, 2017](#event-1018651263)

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
changed the title
~~config options for adding custom request headers~~
http: config options for adding custom request headers
[Mar 28, 2017](#event-1018653801)

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=80&v=4)](/rshriram)

Copy link

Member

Author

### **[rshriram](/rshriram)** commented [Mar 28, 2017](#issuecomment-289787958)

| fixes [#539](https://github.com/envoyproxy/envoy/issues/539) |
| --- |

All reactions

Sorry, something went wrong.

[![mattklein123](https://avatars.githubusercontent.com/u/6305260?s=60&v=4)](/mattklein123)

**[mattklein123](/mattklein123)**
reviewed
[Mar 28, 2017](#pullrequestreview-29588418)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[source/common/router/config\_impl.cc](/envoyproxy/envoy/pull/630/files#diff-2663fc9624b6710b28f768baef19fe0d321f541c74be11a492735ae90bd681cd)
Outdated

|  |  | @@ -154,6 +161,17 @@ bool RouteEntryImplBase::matchRoute(const Http::HeaderMap& headers, uint64\_t ran | |
| --- | --- | --- | --- |
|  |  | const std::string& RouteEntryImplBase::clusterName() const { return cluster\_name\_; } |
|  |  |  |
|  |  | void RouteEntryImplBase::finalizeRequestHeaders(Http::HeaderMap& headers) const { |
|  |  | // Add user-specified request headers from the vhost and then from the route. |

Copy link

Member

### @mattklein123 **[mattklein123](/mattklein123)** [Mar 28, 2017](#discussion_r108549845)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I'm not super thrilled that we do one thing in the connection manager and two things here. I'm wondering if we should move at least adding request headers for the global route level here. (We can leave munging response headers in the connection manager). Thoughts?

Sorry, something went wrong.

All reactions

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=80&v=4)](/rshriram)

Copy link

Member

Author

### **[rshriram](/rshriram)** commented [Mar 28, 2017](#issuecomment-289926090) via email

| I agree. I was looking for a way to get a handle on the global config object so that I can add all three headers here. But I couldn't go beyond the virtual host. If there is already a way to do so, let me know. Otherwise, I can look into adding an interface accordingly. On Tue, Mar 28, 2017 at 6:10 PM Matt Klein \*\*\*@\*\*\*.\*\*\*> wrote: \*\*\*@\*\*\*.\*\*\*\* commented on this pull request. ------------------------------ In source/common/router/config\_impl.cc <[#630 (comment)](https://github.com/envoyproxy/envoy/pull/630#discussion_r108549845)>: > @@ -154,6 +161,17 @@ bool RouteEntryImplBase::matchRoute(const Http::HeaderMap& headers, uint64\_t ran const std::string& RouteEntryImplBase::clusterName() const { return cluster\_name\_; } void RouteEntryImplBase::finalizeRequestHeaders(Http::HeaderMap& headers) const { + // Add user-specified request headers from the vhost and then from the route. I'm not super thrilled that we do one thing in the connection manager and two things here. I'm wondering if we should move at least adding request headers for the global route level here. (We can leave munging response headers in the connection manager). Thoughts? — You are receiving this because you authored the thread. Reply to this email directly, view it on GitHub <[#630 (review)](https://github.com/envoyproxy/envoy/pull/630#pullrequestreview-29588418)>, or mute the thread <<https://github.com/notifications/unsubscribe-auth/AH0qd2xhMjV6WtSgINHkLtMP0pH5DWuXks5rqYVngaJpZM4MqhCS>> .  -- ~shriram |
| --- |

All reactions

Sorry, something went wrong.

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=80&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)

Copy link

Member

### **[mattklein123](/mattklein123)** commented [Mar 28, 2017](#issuecomment-289930044)

| You don't need any interface changes as you are inside config\_impl. Just have a reference chain that leads back to the ConfigImpl root (via virtual host impl). |
| --- |

All reactions

Sorry, something went wrong.

 [![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
[force-pushed](/envoyproxy/envoy/compare/a10a6ce7e5e99a3bd5962b18872bbe9bec21730a..0b06326074a5b34d4991ac64d0bd7f8650ff269e)
the
add\_request\_headers

branch
from
[`a10a6ce`](/envoyproxy/envoy/commit/a10a6ce7e5e99a3bd5962b18872bbe9bec21730a) to
[`0b06326`](/envoyproxy/envoy/commit/0b06326074a5b34d4991ac64d0bd7f8650ff269e)  [Compare](/envoyproxy/envoy/compare/a10a6ce7e5e99a3bd5962b18872bbe9bec21730a..0b06326074a5b34d4991ac64d0bd7f8650ff269e)
[March 29, 2017 20:50](#event-1021200151)

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=80&v=4)](/rshriram)

Copy link

Member

Author

### **[rshriram](/rshriram)** commented [Mar 30, 2017](#issuecomment-290296554)

| [@mattklein123](https://github.com/mattklein123) [@ccaraman](https://github.com/ccaraman) I have moved the request header addition functionality completely into Config Impl (and removed all public interfaces as well). The hash map semantics of Http::HeaderMap are still unclear. It seems that the class refuses to overwrite headers that are already set -- this causes the test to fail. Any pointers? |
| --- |

All reactions

Sorry, something went wrong.

 [![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
[force-pushed](/envoyproxy/envoy/compare/96605f308ab66adf186528577dee99333ac05f97..47cc0888bca6fd66f52b0b308dc3f1549c88ecd4)
the
add\_request\_headers

branch
from
[`96605f3`](/envoyproxy/envoy/commit/96605f308ab66adf186528577dee99333ac05f97) to
[`47cc088`](/envoyproxy/envoy/commit/47cc0888bca6fd66f52b0b308dc3f1549c88ecd4)  [Compare](/envoyproxy/envoy/compare/96605f308ab66adf186528577dee99333ac05f97..47cc0888bca6fd66f52b0b308dc3f1549c88ecd4)
[March 31, 2017 03:54](#event-1023452580)

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30352260)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[docs/configuration/http\_conn\_man/route\_config/route.rst](/envoyproxy/envoy/pull/630/files#diff-f651d7c9c6e2d6559327f225d4ffd0fa36bd2b12af954ddb0583cce57ec578ec)

|  |  | Adding custom request headers |
| --- | --- | --- |
|  |  | ----------------------------- |
|  |  |  |
|  |  | Custom request headers can be added to a request that matches a specific route. The headers are |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109255663) • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Can there only be one place that describes this order of precedence? That way you don't have to duplicate the wording.

Sorry, something went wrong.

 👍
1
 rshriram reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30353673)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[docs/configuration/http\_conn\_man/route\_config/route.rst](/envoyproxy/envoy/pull/630/files#diff-f651d7c9c6e2d6559327f225d4ffd0fa36bd2b12af954ddb0583cce57ec578ec)
Outdated

|  |  | {"key": "header2", "value": "value2"} |
| --- | --- | --- |
|  |  | ] |
|  |  |  |
|  |  | \*Note:\* In the presence of duplicate header keys, headers specified at the global |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109256952)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I don't agree with the ordering of precedence. The most specific rules (routes) should take precendence over the less specific rules virtual host and vh over HTTP Conn Man route configurations.

The order of

1. Route
2. Virtual Host
3. Route configuration within the HTTP Conn Man Filter.

I believe this to be better because at the HTTP Conn Man layer we have request headers to be added for all requests then particular vhs or routes can set particular more specific header values.

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30353982)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[docs/configuration/http\_conn\_man/route\_config/route\_config.rst](/envoyproxy/envoy/pull/630/files#diff-2cafc5c7570e04db6352b89fc1d73d9946a997e61a8d7b37a71602da0de250f5)
Outdated

|  |  | {"key": "header2", "value": "value2"} |
| --- | --- | --- |
|  |  | ] |
|  |  |  |
|  |  | \*Note:\* In the presence of duplicate header keys, only the first header is taken into |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109257238)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Please add link to documentation that mentions the order of precedence.

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30354503)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[source/common/router/config\_impl.cc](/envoyproxy/envoy/pull/630/files#diff-2663fc9624b6710b28f768baef19fe0d321f541c74be11a492735ae90bd681cd)

|  |  | @@ -533,8 +564,6 @@ VirtualHostImpl::virtualClusterFromEntries(const Http::HeaderMap& headers) const | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | ConfigImpl::ConfigImpl(const Json::Object& config, Runtime::Loader& runtime, |
|  |  | Upstream::ClusterManager& cm, bool validate\_clusters) { |
|  |  | route\_matcher\_.reset(new RouteMatcher(config, runtime, cm, validate\_clusters)); |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109257780)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

does this need to be moved?

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30359796)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[source/common/router/config\_impl.cc](/envoyproxy/envoy/pull/630/files#diff-2663fc9624b6710b28f768baef19fe0d321f541c74be11a492735ae90bd681cd)
Outdated

|  |  | @@ -154,6 +161,20 @@ bool RouteEntryImplBase::matchRoute(const Http::HeaderMap& headers, uint64\_t ran | |
| --- | --- | --- | --- |
|  |  | const std::string& RouteEntryImplBase::clusterName() const { return cluster\_name\_; } |
|  |  |  |
|  |  | void RouteEntryImplBase::finalizeRequestHeaders(Http::HeaderMap& headers) const { |
|  |  | // Add route-level headers first, followed by virtual host level headers |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109262552)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

incomplete sentence and missing full stop on the next line before the If.

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30359829)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[source/common/router/config\_impl.cc](/envoyproxy/envoy/pull/630/files#diff-2663fc9624b6710b28f768baef19fe0d321f541c74be11a492735ae90bd681cd)
Outdated

|  |  | @@ -154,6 +161,20 @@ bool RouteEntryImplBase::matchRoute(const Http::HeaderMap& headers, uint64\_t ran | |
| --- | --- | --- | --- |
|  |  | const std::string& RouteEntryImplBase::clusterName() const { return cluster\_name\_; } |
|  |  |  |
|  |  | void RouteEntryImplBase::finalizeRequestHeaders(Http::HeaderMap& headers) const { |
|  |  | // Add route-level headers first, followed by virtual host level headers |
|  |  | // and finally connection manager level headers If there are two headers with same |
|  |  | // name, we consider only the first one, and ignore the rest. |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109262583)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

nit remove the comma before the and.

Sorry, something went wrong.

All reactions

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
reviewed
[Mar 31, 2017](#pullrequestreview-30360031)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files)

[test/common/router/config\_impl\_test.cc](/envoyproxy/envoy/pull/630/files#diff-546f801a2d2ea64fd2bf06c043801ebe5920e94744be6298f923d3e2e145141d)
Outdated

|  |  | "prefix": "/", |
| --- | --- | --- |
|  |  | "cluster": "instant-server", |
|  |  | "timeout\_ms": 30000 |
|  |  | }] |

Copy link

Contributor

### @ccaraman **[ccaraman](/ccaraman)** [Mar 31, 2017](#discussion_r109262779)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

new line for `]`

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @rshriram **[rshriram](/rshriram)** [Apr 3, 2017](#discussion_r109331166)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

done & done. Sorry, I rebased and it ended showing up as bunch of new commits.

Sorry, something went wrong.

All reactions

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=40&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)
[mattklein123](/mattklein123)
closed this
[Apr 1, 2017](#event-1025031193)

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=40&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)
[mattklein123](/mattklein123)
reopened this
[Apr 1, 2017](#event-1025031205)

 Shriram Rajagopalan
added 6 commits
[April 2, 2017 22:14](#commits-pushed-c9bd281)

`[request_headers_to_add in global route_config](/envoyproxy/envoy/pull/630/commits/c9bd2815ece62a79ea50cdd635392a7e1f8bb55d "request_headers_to_add in global route_config")`

`[c9bd281](/envoyproxy/envoy/pull/630/commits/c9bd2815ece62a79ea50cdd635392a7e1f8bb55d)`

`[allow adding request headers in vhosts and routes](/envoyproxy/envoy/pull/630/commits/2fda10a5d82ca885fa273cf4c24c28c417f89817 "allow adding request headers in vhosts and routes")`

`[2fda10a](/envoyproxy/envoy/pull/630/commits/2fda10a5d82ca885fa273cf4c24c28c417f89817)`

`[docs](/envoyproxy/envoy/pull/630/commits/60c883069a1713cbf8b60173141a4e380551b293 "docs")`

`[60c8830](/envoyproxy/envoy/pull/630/commits/60c883069a1713cbf8b60173141a4e380551b293)`

`[request_headers_to_add in async_client](/envoyproxy/envoy/pull/630/commits/7066968f02ceaa0704d8245c7d8b694e64907ca7 "request_headers_to_add in async_client")`

`[7066968](/envoyproxy/envoy/pull/630/commits/7066968f02ceaa0704d8245c7d8b694e64907ca7)`

`[bug fixes in test](/envoyproxy/envoy/pull/630/commits/94663a0deb486389be428f7a4530b1e785670604 "bug fixes in test")`

`[94663a0](/envoyproxy/envoy/pull/630/commits/94663a0deb486389be428f7a4530b1e785670604)`

`[remove public interfaces for request_headers_to_add](/envoyproxy/envoy/pull/630/commits/5b162131eb20697cde541e52660bcef2a0faa5ad "remove public interfaces for request_headers_to_add")`

`[5b16213](/envoyproxy/envoy/pull/630/commits/5b162131eb20697cde541e52660bcef2a0faa5ad)`

 Shriram Rajagopalan
added 5 commits
[April 2, 2017 22:14](#commits-pushed-43df9d1)

`[move global req header addition into ConfigImpl](/envoyproxy/envoy/pull/630/commits/43df9d1105e307fef90d5967f9190e8edc0f8dbc "move global req header addition into ConfigImpl")`

`[43df9d1](/envoyproxy/envoy/pull/630/commits/43df9d1105e307fef90d5967f9190e8edc0f8dbc)`

`[rework header manipulation tests](/envoyproxy/envoy/pull/630/commits/79b941b516ab79d2281436e6ae27b10fb72a0df5 "rework header manipulation tests")`

`[79b941b](/envoyproxy/envoy/pull/630/commits/79b941b516ab79d2281436e6ae27b10fb72a0df5)`

`[remove ability to overwrite request headers](/envoyproxy/envoy/pull/630/commits/acc56df6edd1b4072999ef01e18c527ed3908300 "remove ability to overwrite request headers")`

`[acc56df](/envoyproxy/envoy/pull/630/commits/acc56df6edd1b4072999ef01e18c527ed3908300)`

`[addressing PR comments](/envoyproxy/envoy/pull/630/commits/41c87150069350767aca84a9fa76c8dc3f55d1a9 "addressing PR comments")`

`[41c8715](/envoyproxy/envoy/pull/630/commits/41c87150069350767aca84a9fa76c8dc3f55d1a9)`

`[addressing nits on comments](/envoyproxy/envoy/pull/630/commits/1f3876431c7a597072b58d11874c37de6df5e706 "addressing nits on comments")`

`[1f38764](/envoyproxy/envoy/pull/630/commits/1f3876431c7a597072b58d11874c37de6df5e706)`

 [![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
[force-pushed](/envoyproxy/envoy/compare/1f0c986b906bcfca12aba33e92ad5ce68beeec91..1f3876431c7a597072b58d11874c37de6df5e706)
the
add\_request\_headers

branch
from
[`1f0c986`](/envoyproxy/envoy/commit/1f0c986b906bcfca12aba33e92ad5ce68beeec91) to
[`1f38764`](/envoyproxy/envoy/commit/1f3876431c7a597072b58d11874c37de6df5e706)  [Compare](/envoyproxy/envoy/compare/1f0c986b906bcfca12aba33e92ad5ce68beeec91..1f3876431c7a597072b58d11874c37de6df5e706)
[April 3, 2017 02:21](#event-1025762287)

[![mattklein123](https://avatars.githubusercontent.com/u/6305260?s=60&v=4)](/mattklein123)

**[mattklein123](/mattklein123)**
reviewed
[Apr 3, 2017](#pullrequestreview-30553215)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files/1f3876431c7a597072b58d11874c37de6df5e706)

[docs/configuration/http\_conn\_man/route\_config/route.rst](/envoyproxy/envoy/pull/630/files/1f3876431c7a597072b58d11874c37de6df5e706#diff-f651d7c9c6e2d6559327f225d4ffd0fa36bd2b12af954ddb0583cce57ec578ec)
Outdated

|  |  | ] |
| --- | --- | --- |
|  |  |  |
|  |  | \*Note:\* In the presence of duplicate header keys, headers specified at the |
|  |  | individual route-level take precedence over those specified at |

Copy link

Member

### @mattklein123 **[mattklein123](/mattklein123)** [Apr 3, 2017](#discussion_r109450563)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This is not exactly clear: For headers that are not in the O(1) set, the header *will* get appended multiple times. So there is precedent, but only in the ordering. This is kind of complicated, and not sure whether you want to try to describe this in the docs, or just rephrase to talk about the order of addition.

Sorry, something went wrong.

All reactions

[source/common/router/config\_impl.cc](/envoyproxy/envoy/pull/630/files/1f3876431c7a597072b58d11874c37de6df5e706#diff-2663fc9624b6710b28f768baef19fe0d321f541c74be11a492735ae90bd681cd)
Outdated

|  |  | @@ -154,6 +161,20 @@ bool RouteEntryImplBase::matchRoute(const Http::HeaderMap& headers, uint64\_t ran | |
| --- | --- | --- | --- |
|  |  | const std::string& RouteEntryImplBase::clusterName() const { return cluster\_name\_; } |
|  |  |  |
|  |  | void RouteEntryImplBase::finalizeRequestHeaders(Http::HeaderMap& headers) const { |
|  |  | // For user-specified request headers, route-level headers of take precedence over |

Copy link

Member

### @mattklein123 **[mattklein123](/mattklein123)** [Apr 3, 2017](#discussion_r109450930)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

typo "of"

Sorry, something went wrong.

All reactions

[source/common/router/config\_impl.cc](/envoyproxy/envoy/pull/630/files/1f3876431c7a597072b58d11874c37de6df5e706#diff-2663fc9624b6710b28f768baef19fe0d321f541c74be11a492735ae90bd681cd)
Outdated

|  |  | VirtualHostSharedPtr virtual\_host( |
| --- | --- | --- |
|  |  | new VirtualHostImpl(\*virtual\_host\_config, runtime, cm, validate\_clusters)); |
|  |  | for (const Json::ObjectPtr& virtual\_host\_config : json\_config.getObjectArray("virtual\_hosts")) { |
|  |  | VirtualHostSharedPtr virtual\_host(new VirtualHostImpl(\*virtual\_host\_config, global\_http\_config, |

Copy link

Member

### @mattklein123 **[mattklein123](/mattklein123)** [Apr 3, 2017](#discussion_r109451313)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

s/global\_http\_config/global\_route\_config

Sorry, something went wrong.

All reactions

[source/common/router/config\_impl.h](/envoyproxy/envoy/pull/630/files/1f3876431c7a597072b58d11874c37de6df5e706#diff-caa28d598c49a80fee49bb96c71783c953c6840fb72821cebfc2faff22d49563)
Outdated

|  |  | const std::list<std::pair<Http::LowerCaseString, std::string>>& requestHeadersToAdd() const { |
| --- | --- | --- |
|  |  | return request\_headers\_to\_add\_; |
|  |  | } |
|  |  | const ConfigImpl& globalHttpConfig() const { return global\_http\_config\_; } |

Copy link

Member

### @mattklein123 **[mattklein123](/mattklein123)** [Apr 3, 2017](#discussion_r109451448)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

globalRouteConfig() (just rename this similarly everywhere)

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @rshriram **[rshriram](/rshriram)** [Apr 3, 2017](#discussion_r109513181)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

done

Sorry, something went wrong.

All reactions

`[renaming and doc fixes for http req_headers_to_add](/envoyproxy/envoy/pull/630/commits/dad30f638f329a56a4a9c801bf31e4a99bf9ea46 "renaming and doc fixes for http req_headers_to_add")`

`[dad30f6](/envoyproxy/envoy/pull/630/commits/dad30f638f329a56a4a9c801bf31e4a99bf9ea46)`

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=80&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)

Copy link

Member

### **[mattklein123](/mattklein123)** commented [Apr 3, 2017](#issuecomment-291266097)

| This change LGTM. I will let [@ccaraman](https://github.com/ccaraman) give you final review/approve/merge. |
| --- |

All reactions

Sorry, something went wrong.

[![ccaraman](https://avatars.githubusercontent.com/u/19931185?s=60&v=4)](/ccaraman)

**[ccaraman](/ccaraman)**
approved these changes
[Apr 4, 2017](#pullrequestreview-30850589)

 [View reviewed changes](/envoyproxy/envoy/pull/630/files/dad30f638f329a56a4a9c801bf31e4a99bf9ea46)

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=40&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)
[mattklein123](/mattklein123)
merged commit [`f6c9e95`](/envoyproxy/envoy/commit/f6c9e95593282befdc51473a082aa2589d2ce3bf)
into
envoyproxy:master

[Apr 4, 2017](https://github.com/envoyproxy/envoy/pull/630#event-1028874551)

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=40&u=4439d9f238b748a46914242b963e63ec9539960a&v=4)](/mattklein123)
[mattklein123](/mattklein123)
mentioned this pull request
[Apr 5, 2017](#ref-issue-212195358)

[Support adding/overwriting request headers before forwarding request
#539](/envoyproxy/envoy/issues/539)

Closed

 [![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=40&v=4)](/rshriram)
[rshriram](/rshriram)
deleted the
add\_request\_headers

branch
[August 14, 2017 18:11](#event-1205257225)

[wolfguoliang](/wolfguoliang)
pushed a commit
to wolfguoliang/envoy
that referenced
this pull request
[Jan 23, 2021](#ref-commit-a332fe3)
[![@wujie1993](https://avatars.githubusercontent.com/u/13548195?s=40&u=c0a3f31ce93991a17dde25141c8658d8d85784bf&v=4)](/wujie1993)

`[zh-translation: docs/root/api-v3/config/filter/http/http.rst(](/wolfguoliang/envoy/commit/a332fe39239a4542ac0d5927bf29a45af20ba615 "zh-translation: docs/root/api-v3/config/filter/http/http.rst(#630) (#630)

Signed-off-by: wujie1993 <qq594jj@gmail.com>")[envoypro…](https://github.com/envoyproxy/envoy/pull/630)`
…

`[a332fe3](/wolfguoliang/envoy/commit/a332fe39239a4542ac0d5927bf29a45af20ba615)`

```
[…xy#630](https://github.com/envoyproxy/envoy/pull/630)) ([envoyproxy#630](https://github.com/envoyproxy/envoy/pull/630))

Signed-off-by: wujie1993 <qq594jj@gmail.com>
```

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Feb 22, 2022](#ref-issue-1147453804)

[x/vulndb: potential Go vuln in github.com/envoyproxy/envoy: CVE-2022-21657
golang/vulndb#336](/golang/vulndb/issues/336)

Closed

[![@jba](https://avatars.githubusercontent.com/u/18483045?s=40&v=4)](/jba)
[jba](/jba)
mentioned this pull request
[Feb 28, 2022](#ref-issue-1154642408)

[x/vulndb: potential Go vuln in github.com/envoyproxy/envoy: CVE-2022-21657
jba/nested-modules#186](/jba/nested-modules/issues/186)

Open

[jpsim](/jpsim)
pushed a commit
that referenced
this pull request
[Nov 28, 2022](#ref-commit-4f84609)
[![@junr03](https://avatars.githubusercontent.com/u/6007532?s=40&u=c4c5b506df258befc42d77da77f88595b823810f&v=4)](/junr03) [![@jpsim](https://avatars.githubusercontent.com/u/474794?s=40&v=4)](/jpsim)

`[envoy: update envoy ref and update config to v3 supported schema (](/envoyproxy/envoy/commit/4f846091dbdf443aab91b972b1c8b0a00b86bd59 "envoy: update envoy ref and update config to v3 supported schema (#626)

Description: this PR updates Envoy Mobile's Envoy ref past the point where Envoy internally uses v3 config. I took the chance to update Envoy Mobile's config and delete deprecated fields. Note that SAN verification changes, and thus it was removed here. I opened an issue tracking #630. Further note that this ref update significantly increased the binary size. It is a priority for the team to investigate and trim the binary ahead of the v0.3 release (noted in #447)
Risk Level: med boost to v3 config and deleted deprecated fields.
Testing: passing liveliness in CI and locally.

Signed-off-by: Jose Nino <jnino@lyft.com>
Signed-off-by: JP Simard <jp@jpsim.com>")[#626](https://github.com/envoyproxy/envoy/pull/626)[)](/envoyproxy/envoy/commit/4f846091dbdf443aab91b972b1c8b0a00b86bd59 "envoy: update envoy ref and update config to v3 supported schema (#626)

Description: this PR updates Envoy Mobile's Envoy ref past the point where Envoy internally uses v3 config. I took the chance to update Envoy Mobile's config and delete deprecated fields. Note that SAN verification changes, and thus it was removed here. I opened an issue tracking #630. Further note that this ref update significantly increased the binary size. It is a priority for the team to investigate and trim the binary ahead of the v0.3 release (noted in #447)
Risk Level: med boost to v3 config and deleted deprecated fields.
Testing: passing liveliness in CI and locally.

Signed-off-by: Jose Nino <jnino@lyft.com>
Signed-off-by: JP Simard <jp@jpsim.com>")`
…

`[4f84609](/envoyproxy/envoy/commit/4f846091dbdf443aab91b972b1c8b0a00b86bd59)`

```
Description: this PR updates Envoy Mobile's Envoy ref past the point where Envoy internally uses v3 config. I took the chance to update Envoy Mobile's config and delete deprecated fields. Note that SAN verification changes, and thus it was removed here. I opened an issue tracking [#630](https://github.com/envoyproxy/envoy/pull/630). Further note that this ref update significantly increased the binary size. It is a priority for the team to investigate and trim the binary ahead of the v0.3 release (noted in [#447](https://github.com/envoyproxy/envoy/pull/447))
Risk Level: med boost to v3 config and deleted deprecated fields.
Testing: passing liveliness in CI and locally.

Signed-off-by: Jose Nino <jnino@lyft.com>
Signed-off-by: JP Simard <jp@jpsim.com>
```

[jpsim](/jpsim)
pushed a commit
that referenced
this pull request
[Nov 29, 2022](#ref-commit-f1006d7)
[![@junr03](https://avatars.githubusercontent.com/u/6007532?s=40&u=c4c5b506df258befc42d77da77f88595b823810f&v=4)](/junr03) [![@jpsim](https://avatars.githubusercontent.com/u/474794?s=40&v=4)](/jpsim)

`[envoy: update envoy ref and update config to v3 supported schema (](/envoyproxy/envoy/commit/f1006d7d672469cb249559dbdaf201285386b2c7 "envoy: update envoy ref and update config to v3 supported schema (#626)

Description: this PR updates Envoy Mobile's Envoy ref past the point where Envoy internally uses v3 config. I took the chance to update Envoy Mobile's config and delete deprecated fields. Note that SAN verification changes, and thus it was removed here. I opened an issue tracking #630. Further note that this ref update significantly increased the binary size. It is a priority for the team to investigate and trim the binary ahead of the v0.3 release (noted in #447)
Risk Level: med boost to v3 config and deleted deprecated fields.
Testing: passing liveliness in CI and locally.

Signed-off-by: Jose Nino <jnino@lyft.com>
Signed-off-by: JP Simard <jp@jpsim.com>")[#626](https://github.com/envoyproxy/envoy/pull/626)[)](/envoyproxy/envoy/commit/f1006d7d672469cb249559dbdaf201285386b2c7 "envoy: update envoy ref and update config to v3 supported schema (#626)

Description: this PR updates Envoy Mobile's Envoy ref past the point where Envoy internally uses v3 config. I took the chance to update Envoy Mobile's config and delete deprecated fields. Note that SAN verification changes, and thus it was removed here. I opened an issue tracking #630. Further note that this ref update significantly increased the binary size. It is a priority for the team to investigate and trim the binary ahead of the v0.3 release (noted in #447)
Risk Level: med boost to v3 config and deleted deprecated fields.
Testing: passing liveliness in CI and locally.

Signed-off-by: Jose Nino <jnino@lyft.com>
Signed-off-by: JP Simard <jp@jpsim.com>")`
…

`[f1006d7](/envoyproxy/envoy/commit/f1006d7d672469cb249559dbdaf201285386b2c7)`

```
Description: this PR updates Envoy Mobile's Envoy ref past the point where Envoy internally uses v3 config. I took the chance to update Envoy Mobile's config and delete deprecated fields. Note that SAN verification changes, and thus it was removed here. I opened an issue tracking [#630](https://github.com/envoyproxy/envoy/pull/630). Further note that this ref update significantly increased the binary size. It is a priority for the team to investigate and trim the binary ahead of the v0.3 release (noted in [#447](https://github.com/envoyproxy/envoy/pull/447))
Risk Level: med boost to v3 config and deleted deprecated fields.
Testing: passing liveliness in CI and locally.

Signed-off-by: Jose Nino <jnino@lyft.com>
Signed-off-by: JP Simard <jp@jpsim.com>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fpull%2F630)

Reviewers

[![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=40&v=4)](/mattklein123) [mattklein123](/mattklein123)

mattklein123 left review comments

[![@ccaraman](https://avatars.githubusercontent.com/u/19931185?s=40&v=4)](/ccaraman) [ccaraman](/ccaraman)

ccaraman approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@rshriram](https://avatars.githubusercontent.com/u/8202871?s=52&v=4)](/rshriram) [![@mattklein123](https://avatars.githubusercontent.com/u/6305260?s=52&v=4)](/mattklein123) [![@ccaraman](https://avatars.githubusercontent.com/u/19931185?s=52&v=4)](/ccaraman)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3ffe1f5e_20250114_200956.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fsecurity%2Fadvisories%2FGHSA-837m-wjrv-vm5g)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fsecurity%2Fadvisories%2FGHSA-837m-wjrv-vm5g)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  126](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

# X.509 Extended Key Usage and Trust Purposes bypass

Low

[mattklein123](/mattklein123)
published
GHSA-837m-wjrv-vm5g
Feb 22, 2022

## Package

envoy
(c++)

## Affected versions

1.20.1 and earlier

## Patched versions

1.18.6, 1.19.3, 1.20.2

## Description

CVSS Score 3.1 AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N, Low

Envoy does not restrict the set of certificates it accepts from the peer, either as a TLS client or a TLS server, to only those certificates that contain the necessary extendedKeyUsage (id-kp-serverAuth and id-kp-clientAuth, respectively)

This means that a peer may present an e-mail certificate (e.g. id-kp-emailProtection), either as a leaf certificate or as a CA in the chain, and it will be accepted for TLS. This is particularly bad when combined with [#630](https://github.com/envoyproxy/envoy/pull/630) , in that it allows a Web PKI CA that is intended only for use with S/MIME, and thus exempted from audit or supervision, to issue TLS certificates that will be accepted by Envoy.

### Impact

Envoy will trust upstream certificates that should not be trusted.

### Patches

### Workarounds

None.

### References

<https://blog.envoyproxy.io>

<https://github.com/envoyproxy/envoy/releases>

### For more information

Open an issue in [Envoy repo](https://github.com/envoyproxy/envoy/issues)

Email us at [envoy-security](https://github.com/envoyproxy/envoy/security/advisories/envoy-security%40googlegroups.com)

### Severity

Low

3.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
Low

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N

### CVE ID

CVE-2022-21657

### Weaknesses

[CWE-295](/advisories?query=cwe%3A295)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


