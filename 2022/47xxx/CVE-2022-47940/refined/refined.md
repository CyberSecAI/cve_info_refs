```
Message-ID: <20221223162128.GD4524@suse.de>
Date: Fri, 23 Dec 2022 17:21:29 +0100
From: Marcus Meissner <meissner@...e.de>
To: oss-security@...ts.openwall.com
Subject: Re: Details on this supposed Linux Kernel ksmbd RCE

Hi,

Mitre has assigned following CVEs, also torvalds mainline commits:

ZDI-22-1687 - CVE-2022-47941
        aa7253c2393f6dcd6a1468b0792f6da76edad917
ZDI-22-1688 - CVE-2022-47942
        8f0541186e9ad1b62accc9519cc2b7a7240272a7
ZDI-22-1689 - CVE-2022-47938
        824d4f64c20093275f72fc8101394d75ff6a249e
ZDI-22-1690 - CVE-2022-47939
        a54c509c32adba9d136f2b9d6a075e8cae1b6d27
ZDI-22-1691 - CVE-2022-47940
        158a66b245739e15858de42c0ba60fcf3de9b8e6

Mitre assigned also from the stable patch, but was not in ZDI set - CVE-2022-47943
        ac60778b87e45576d7bfdbd6f53df902654e6f09

        (I did not request that in my batch, Mitre seemed to have
        picked this from the stable patch.)

I mistakenly declared 5.13-5.19 affectedness to Mitre in a hurry,
but it is more 5.15 - 5.18.x / 5.19.x

Ciao, Marcus
```

```
commit 158a66b245739e15858de42c0ba60fcf3de9b8e6
Author: Marios Makassikis <mmakassikis@freebox.fr>
Date:   Wed May 4 15:40:10 2022 +0200
Commit: Steve French <stfrench@microsoft.com>
Date:   Mon May 9 22:23:01 2022 -0500

    ksmbd: validate length in smb2_write()

    The SMB2 Write packet contains data that is to be written
    to a file or to a pipe. Depending on the client, there may
    be padding between the header and the data field.
    Currently, the length is validated only in the case padding
    is present.

    Since the DataOffset field always points to the beginning
    of the data, there is no need to have a special case for
    padding. By removing this, the length is validated in both
    cases.

    Signed-off-by: Marios Makassikis <mmakassikis@freebox.fr>
    Acked-by: Namjae Jeon <linkinjeon@kernel.org>
    Signed-off-by: Steve French <stfrench@microsoft.com>
```

```
commit ac60778b87e45576d7bfdbd6f53df902654e6f09
Author: Hyunchul Lee <hyc.lee@gmail.com>
Date:   Thu Jul 28 23:41:51 2022 +0900
Commit: Steve French <stfrench@microsoft.com>
Date:   Mon Aug 1 14:14:09 2022 -0500

    ksmbd: prevent out of bound read for SMB2_WRITE

    OOB read memory can be written to a file,
    if DataOffset is 0 and Length is too large
    in SMB2_WRITE request of compound request.

    To prevent this, when checking the length of
    the data area of SMB2_WRITE in smb2_get_data_area_len(),
    let the minimum of DataOffset be the size of
    SMB2 header + the size of SMB2_WRITE header.

    This bug can lead an oops looking something like:

    [  798.008715] BUG: KASAN: slab-out-of-bounds in copy_page_from_iter_atomic+0xd3d/0x14b0
    [  798.008724] Read of size 252 at addr ffff88800f863e90 by task kworker/0:2/2859
    ...
    [  798.008754] Call Trace:
    [  798.008756]  <TASK>
    [  798.008759]  dump_stack_lvl+0x49/0x5f
    [  798.008764]  print_report.cold+0x5e/0x5cf
    [  798.008768]  ? __filemap_get_folio+0x285/0x6d0
    [  798.008774]  ? copy_page_from_iter_atomic+0xd3d/0x14b0
    [  798.008777]  kasan_report+0xa8/0x130
    [  798.008781]  ? copy_page_from_iter_atomic+0xd3d/0x14b0
    [  798.008784]  kasan_check_range+0x100/0x1e0
    [  798.008788]  memcpy+0x24/0x60
    [  798.008792]  copy_page_from_iter_atomic+0xd3d/0x14b0
    [  798.008795]  ? pagecache_get_page+0x53/0x160
    [  798.008799]  ? iov_iter_get_pages_alloc+0x1590/0x1590
    [  798.008803]  ? ext4_write_begin+0xfc0/0xfc0
    [  798.008807]  ? current_time+0x72/0x210
    [  798.008811]  generic_perform_write+0x2c8/0x530
    [  798.008816]  ? filemap_fdatawrite_wbc+0x180/0x180
    [  798.008820]  ? down_write+0xb4/0x120
    [  798.008824]  ? down_write_killable+0x130/0x130
    [  798.008829]  ext4_buffered_write_iter+0x137/0x2c0
    [  798.008833]  ext4_file_write_iter+0x40b/0x1490
    [  798.008837]  ? __fsnotify_parent+0x275/0xb20
    [  798.008842]  ? __fsnotify_update_child_dentry_flags+0x2c0/0x2c0
    [  798.008846]  ? ext4_buffered_write_iter+0x2c0/0x2c0
    [  798.008851]  __kernel_write+0x3a1/0xa70
    [  798.008855]  ? __x64_sys_preadv2+0x160/0x160
    [  798.008860]  ? security_file_permission+0x4a/0xa0
    [  798.008865]  kernel_write+0xbb/0x360
    [  798.008869]  ksmbd_vfs_write+0x27e/0xb90 [ksmbd]
    [  798.008881]  ? ksmbd_vfs_read+0x830/0x830 [ksmbd]
    [  798.008892]  ? _raw_read_unlock+0x2a/0x50
    [  798.008896]  smb2_write+0xb45/0x14e0 [ksmbd]
    [  798.008909]  ? __kasan_check_write+0x14/0x20
    [  798.008912]  ? _raw_spin_lock_bh+0xd0/0xe0
    [  798.008916]  ? smb2_read+0x15e0/0x15e0 [ksmbd]
    [  798.008927]  ? memcpy+0x4e/0x60
    [  798.008931]  ? _raw_spin_unlock+0x19/0x30
    [  798.008934]  ? ksmbd_smb2_check_message+0x16af/0x2350 [ksmbd]
    [  798.008946]  ? _raw_spin_lock_bh+0xe0/0xe0
    [  798.008950]  handle_ksmbd_work+0x30e/0x1020 [ksmbd]
    [  798.008962]  process_one_work+0x778/0x11c0
    [  798.008966]  ? _raw_spin_lock_irq+0x8e/0xe0
    [  798.008970]  worker_thread+0x544/0x1180
    [  798.008973]  ? __cpuidle_text_end+0x4/0x4
    [  798.008977]  kthread+0x282/0x320
    [  798.008982]  ? process_one_work+0x11c0/0x11c0
    [  798.008985]  ? kthread_complete_and_exit+0x30/0x30
    [  798.008989]  ret_from_fork+0x1f/0x30

    Fixes: e2f34481b24d ("cifsd: add server-side procedures for SMB3")
    Cc: stable@vger.kernel.org
    Reported-by: zdi-disclosures@trendmicro.com # ZDI-CAN-17817
    Signed-off-by: Hyunchul Lee <hyc.lee@gmail.com>
    Acked-by: Namjae Jeon <linkinjeon@kernel.org>
    Signed-off-by: Steve French <stfrench@microsoft.com>
```
Root cause of vulnerability: A vulnerability exists in the `smb2_write` function of the ksmbd module within the Linux Kernel. The function does not properly validate the `DataOffset` and `Length` fields, leading to potential out-of-bounds read.

Weaknesses/vulnerabilities:
- **Out-of-bounds read:** The function `smb2_write` can access memory outside of the allocated buffer due to insufficient validation of `DataOffset` and `Length`.

Impact of exploitation:
- **Memory Corruption:** Exploitation can lead to reading out-of-bounds memory which can then be written to a file, causing a system crash. The provided KASAN output suggests a slab-out-of-bounds read, which can lead to a denial of service.

Attack vectors:
- An attacker sends a crafted SMB2 Write request with an incorrect `DataOffset` and large `Length`.

Required attacker capabilities/position:
- The attacker needs to send crafted SMB2 packets to a vulnerable ksmbd server which suggests the attacker needs to be on the same or accessible network as the vulnerable server.

```
Root cause of vulnerability: An out-of-bounds read vulnerability exists in the `smb2_tree_connect` function within the ksmbd module. This vulnerability can occur if the `Status` is not 0 and `PathLength` is too long, leading `smb_strndup_from_utf16` to read past the allocated memory.

Weaknesses/vulnerabilities:
- **Out-of-bounds read:** The `smb_strndup_from_utf16` function can read past the allocated buffer if the `Status` is not 0 and `PathLength` is too long.

Impact of exploitation:
- **Memory Corruption:** Exploitation can lead to an out-of-bounds read, causing a system crash. The provided KASAN output suggests a slab-out-of-bounds read, which can lead to a denial of service.

Attack vectors:
- An attacker sends a crafted SMB2 Tree Connect request with a non-zero `Status` and a long `PathLength`.

Required attacker capabilities/position:
- The attacker needs to send crafted SMB2 packets to a vulnerable ksmbd server, indicating that the attacker should be on the same or an accessible network as the vulnerable server.
```
Root cause of vulnerability: An out-of-bounds read vulnerability exists in the `copy_page_from_iter_atomic` function when handling a crafted `SMB2_WRITE` request. This is due to insufficient validation of the `DataOffset` field which can be set to 0 while `Length` can be a large value.

Weaknesses/vulnerabilities:
  - **Out-of-bounds read:** The function `copy_page_from_iter_atomic` can read past the allocated buffer due to an invalid `DataOffset`.

Impact of exploitation:
  - **Memory Corruption:** Exploitation can lead to an out-of-bounds read, resulting in a system crash. The provided KASAN output demonstrates a slab-out-of-bounds read, which can cause a denial of service.

Attack vectors:
  - An attacker sends a crafted `SMB2_WRITE` request to a vulnerable ksmbd server. This implies the attacker is on the same network or has access to the network where the ksmbd server is located.

Required attacker capabilities/position:
  - The attacker needs to have the capability to send crafted SMB2 packets to a vulnerable ksmbd server.
```