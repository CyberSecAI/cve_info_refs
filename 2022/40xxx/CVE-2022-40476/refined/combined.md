=== Content from git.kernel.org_61a5c3ba_20250114_181218.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [summary](/pub/scm/linux/kernel/git/stable/linux.git/?h=v5.15.61)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/fs/io_uring.c?h=v5.15.61)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/fs/io_uring.c?h=v5.15.61) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/stable/linux.git/commit/?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)/[fs](/pub/scm/linux/kernel/git/stable/linux.git/commit/fs?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)/[io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/commit/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2022-06-23 11:06:43 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-08-21 15:17:47 +0200 |
| commit | [3746d62ecf1c872a520c4866118edccb121c44fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/fs/io_uring.c?id=3746d62ecf1c872a520c4866118edccb121c44fd)) | |
| tree | [36a5462c6c22207e39ae6f8c17060a38fdb0be52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd) /[fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd) | |
| parent | [374bf3fc1f53c6611c4ad98d11863344d375e2be](/pub/scm/linux/kernel/git/stable/linux.git/commit/fs/io_uring.c?h=v5.15.61&id=374bf3fc1f53c6611c4ad98d11863344d375e2be) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd&id2=374bf3fc1f53c6611c4ad98d11863344d375e2be)) | |
| download | [linux-3746d62ecf1c872a520c4866118edccb121c44fd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3746d62ecf1c872a520c4866118edccb121c44fd.tar.gz) | |

io\_uring: use original request task for inflight trackingcommit 386e4fb6962b9f248a80f8870aea0870ca603e89 upstream.
In prior kernels, we did file assignment always at prep time. This meant
that req->task == current. But after deferring that assignment and then
pushing the inflight tracking back in, we've got the inflight tracking
using current when it should in fact now be using req->task.
Fixup that error introduced by adding the inflight tracking back after
file assignments got modifed.
Fixes: 9cae36a094e7 ("io\_uring: reinstate the inflight tracking")
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd) (limited to 'fs/io\_uring.c')

| -rw-r--r-- | [fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/io\_uring.c b/fs/io\_uring.cindex 0ce1587df43221..89f24b54fe5e8d 100644--- a/[fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?h=v5.15.61&id=374bf3fc1f53c6611c4ad98d11863344d375e2be)+++ b/[fs/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/io_uring.c?h=v5.15.61&id=3746d62ecf1c872a520c4866118edccb121c44fd)@@ -1405,7 +1405,7 @@ static void io\_req\_track\_inflight(struct io\_kiocb \*req) { if (!(req->flags & REQ\_F\_INFLIGHT)) { req->flags |= REQ\_F\_INFLIGHT;- atomic\_inc(&current->io\_uring->inflight\_tracked);+ atomic\_inc(&req->task->io\_uring->inflight\_tracked); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:10:55 +0000



=== Content from mirrors.edge.kernel.org_0abcbbef_20250114_181218.html ===
commit a0a7e0b2b8b22901945ea2aef1b65871d718accf
Author: Greg Kroah-Hartman
Date: Sun Aug 21 15:17:49 2022 +0200
Linux 5.15.62
Link: https://lore.kernel.org/r/20220819153711.658766010@linuxfoundation.org
Tested-by: Shuah Khan
Tested-by: Bagas Sanjaya
Tested-by: Sudip Mukherjee
Tested-by: Ron Economos
Link: https://lore.kernel.org/r/20220820182309.607584465@linuxfoundation.org
Tested-by: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
commit 2a9114b3ec6f9d195e7744e50dc13937a88d48db
Author: Qu Wenruo
Date: Fri Aug 19 16:39:50 2022 +0800
btrfs: raid56: don't trust any cached sector in \_\_raid56\_parity\_recover()
commit f6065f8edeb25f4a9dfe0b446030ad995a84a088 upstream.
[BUG]
There is a small workload which will always fail with recent kernel:
(A simplified version from btrfs/125 test case)
mkfs.btrfs -f -m raid5 -d raid5 -b 1G $dev1 $dev2 $dev3
mount $dev1 $mnt
xfs\_io -f -c "pwrite -S 0xee 0 1M" $mnt/file1
sync
umount $mnt
btrfs dev scan -u $dev3
mount -o degraded $dev1 $mnt
xfs\_io -f -c "pwrite -S 0xff 0 128M" $mnt/file2
umount $mnt
btrfs dev scan
mount $dev1 $mnt
btrfs balance start --full-balance $mnt
umount $mnt
The failure is always failed to read some tree blocks:
BTRFS info (device dm-4): relocating block group 217710592 flags data|raid5
BTRFS error (device dm-4): parent transid verify failed on 38993920 wanted 9 found 7
BTRFS error (device dm-4): parent transid verify failed on 38993920 wanted 9 found 7
...
[CAUSE]
With the recently added debug output, we can see all RAID56 operations
related to full stripe 38928384:
56.1183: raid56\_read\_partial: full\_stripe=38928384 devid=2 type=DATA1 offset=0 opf=0x0 physical=9502720 len=65536
56.1185: raid56\_read\_partial: full\_stripe=38928384 devid=3 type=DATA2 offset=16384 opf=0x0 physical=9519104 len=16384
56.1185: raid56\_read\_partial: full\_stripe=38928384 devid=3 type=DATA2 offset=49152 opf=0x0 physical=9551872 len=16384
56.1187: raid56\_write\_stripe: full\_stripe=38928384 devid=3 type=DATA2 offset=0 opf=0x1 physical=9502720 len=16384
56.1188: raid56\_write\_stripe: full\_stripe=38928384 devid=3 type=DATA2 offset=32768 opf=0x1 physical=9535488 len=16384
56.1188: raid56\_write\_stripe: full\_stripe=38928384 devid=1 type=PQ1 offset=0 opf=0x1 physical=30474240 len=16384
56.1189: raid56\_write\_stripe: full\_stripe=38928384 devid=1 type=PQ1 offset=32768 opf=0x1 physical=30507008 len=16384
56.1218: raid56\_write\_stripe: full\_stripe=38928384 devid=3 type=DATA2 offset=49152 opf=0x1 physical=9551872 len=16384
56.1219: raid56\_write\_stripe: full\_stripe=38928384 devid=1 type=PQ1 offset=49152 opf=0x1 physical=30523392 len=16384
56.2721: raid56\_parity\_recover: full stripe=38928384 eb=39010304 mirror=2
56.2723: raid56\_parity\_recover: full stripe=38928384 eb=39010304 mirror=2
56.2724: raid56\_parity\_recover: full stripe=38928384 eb=39010304 mirror=2
Before we enter raid56\_parity\_recover(), we have triggered some metadata
write for the full stripe 38928384, this leads to us to read all the
sectors from disk.
Furthermore, btrfs raid56 write will cache its calculated P/Q sectors to
avoid unnecessary read.
This means, for that full stripe, after any partial write, we will have
stale data, along with P/Q calculated using that stale data.
Thankfully due to patch "btrfs: only write the sectors in the vertical stripe
which has data stripes" we haven't submitted all the corrupted P/Q to disk.
When we really need to recover certain range, aka in
raid56\_parity\_recover(), we will use the cached rbio, along with its
cached sectors (the full stripe is all cached).
This explains why we have no event raid56\_scrub\_read\_recover()
triggered.
Since we have the cached P/Q which is calculated using the stale data,
the recovered one will just be stale.
In our particular test case, it will always return the same incorrect
metadata, thus causing the same error message "parent transid verify
failed on 39010304 wanted 9 found 7" again and again.
[BTRFS DESTRUCTIVE RMW PROBLEM]
Test case btrfs/125 (and above workload) always has its trouble with
the destructive read-modify-write (RMW) cycle:
0 32K 64K
Data1: | Good | Good |
Data2: | Bad | Bad |
Parity: | Good | Good |
In above case, if we trigger any write into Data1, we will use the bad
data in Data2 to re-generate parity, killing the only chance to recovery
Data2, thus Data2 is lost forever.
This destructive RMW cycle is not specific to btrfs RAID56, but there
are some btrfs specific behaviors making the case even worse:
- Btrfs will cache sectors for unrelated vertical stripes.
In above example, if we're only writing into 0~32K range, btrfs will
still read data range (32K ~ 64K) of Data1, and (64K~128K) of Data2.
This behavior is to cache sectors for later update.
Incidentally commit d4e28d9b5f04 ("btrfs: raid56: make steal\_rbio()
subpage compatible") has a bug which makes RAID56 to never trust the
cached sectors, thus slightly improve the situation for recovery.
Unfortunately, follow up fix "btrfs: update stripe\_sectors::uptodate in
steal\_rbio" will revert the behavior back to the old one.
- Btrfs raid56 partial write will update all P/Q sectors and cache them
This means, even if data at (64K ~ 96K) of Data2 is free space, and
only (96K ~ 128K) of Data2 is really stale data.
And we write into that (96K ~ 128K), we will update all the parity
sectors for the full stripe.
This unnecessary behavior will completely kill the chance of recovery.
Thankfully, an unrelated optimization "btrfs: only write the sectors
in the vertical stripe which has data stripes" will prevent
submitting the write bio for untouched vertical sectors.
That optimization will keep the on-disk P/Q untouched for a chance for
later recovery.
[FIX]
Although we have no good way to completely fix the destructive RMW
(unless we go full scrub for each partial write), we can still limit the
damage.
With patch "btrfs: only write the sectors in the vertical stripe which
has data stripes" now we won't really submit the P/Q of unrelated
vertical stripes, so the on-disk P/Q should still be fine.
Now we really need to do is just drop all the cached sectors when doing
recovery.
By this, we have a chance to read the original P/Q from disk, and have a
chance to recover the stale data, while still keep the cache to speed up
regular write path.
In fact, just dropping all the cache for recovery path is good enough to
allow the test case btrfs/125 along with the small script to pass
reliably.
The lack of metadata write after the degraded mount, and forced metadata
COW is saving us this time.
So this patch will fix the behavior by not trust any cache in
\_\_raid56\_parity\_recover(), to solve the problem while still keep the
cache useful.
But please note that this test pass DOES NOT mean we have solved the
destructive RMW problem, we just do better damage control a little
better.
Related patches:
- btrfs: only write the sectors in the vertical stripe
- d4e28d9b5f04 ("btrfs: raid56: make steal\_rbio() subpage compatible")
- btrfs: update stripe\_sectors::uptodate in steal\_rbio
Acked-by: David Sterba
Signed-off-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 0d9c713cc30f78f5af731afedb91f04b9b6ae70d
Author: Qu Wenruo
Date: Fri Aug 19 16:39:49 2022 +0800
btrfs: only write the sectors in the vertical stripe which has data stripes
commit bd8f7e627703ca5707833d623efcd43f104c7b3f upstream.
If we have only 8K partial write at the beginning of a full RAID56
stripe, we will write the following contents:
0 8K 32K 64K
Disk 1 (data): |XX| | |
Disk 2 (data): | | |
Disk 3 (parity): |XXXXXXXXXXXXXXX|XXXXXXXXXXXXXXX|
|X| means the sector will be written back to disk.
Note that, although we won't write any sectors from disk 2, but we will
write the full 64KiB of parity to disk.
This behavior is fine for now, but not for the future (especially for
RAID56J, as we waste quite some space to journal the unused parity
stripes).
So here we will also utilize the btrfs\_raid\_bio::dbitmap, anytime we
queue a higher level bio into an rbio, we will update rbio::dbitmap to
indicate which vertical stripes we need to writeback.
And at finish\_rmw(), we also check dbitmap to see if we need to write
any sector in the vertical stripe.
So after the patch, above example will only lead to the following
writeback pattern:
0 8K 32K 64K
Disk 1 (data): |XX| | |
Disk 2 (data): | | |
Disk 3 (parity): |XX| | |
Acked-by: David Sterba
Signed-off-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 3eb602ad6a94a76941f93173131a71ad36fa1324
Author: Peter Zijlstra
Date: Tue Aug 16 05:26:58 2022 -0300
x86/ftrace: Use alternative RET encoding
commit 1f001e9da6bbf482311e45e48f53c2bd2179e59c upstream.
Use the return thunk in ftrace trampolines, if needed.
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Borislav Petkov
Reviewed-by: Josh Poimboeuf
Signed-off-by: Borislav Petkov
[cascardo: use memcpy(text\_gen\_insn) as there is no \_\_text\_gen\_insn]
Signed-off-by: Thadeu Lima de Souza Cascardo
Signed-off-by: Greg Kroah-Hartman
commit 543138c555185e5054f9095909761f1bca9096ba
Author: Peter Zijlstra
Date: Tue Aug 16 05:26:57 2022 -0300
x86/ibt,ftrace: Make function-graph play nice
commit e52fc2cf3f662828cc0d51c4b73bed73ad275fce upstream.
Return trampoline must not use indirect branch to return; while this
preserves the RSB, it is fundamentally incompatible with IBT. Instead
use a retpoline like ROP gadget that defeats IBT while not unbalancing
the RSB.
And since ftrace\_stub is no longer a plain RET, don't use it to copy
from. Since RET is a trivial instruction, poke it directly.
Signed-off-by: Peter Zijlstra (Intel)
Acked-by: Josh Poimboeuf
Link: https://lore.kernel.org/r/20220308154318.347296408@infradead.org
[cascardo: remove ENDBR]
Signed-off-by: Thadeu Lima de Souza Cascardo
Signed-off-by: Greg Kroah-Hartman
commit f6632763484c6078f65eff3fd0044cc2bc82fd18
Author: Thadeu Lima de Souza Cascardo
Date: Tue Aug 16 05:26:56 2022 -0300
Revert "x86/ftrace: Use alternative RET encoding"
This reverts commit e54fcb0812faebd147de72bd37ad87cc4951c68c.
This temporarily reverts the backport of upstream commit
1f001e9da6bbf482311e45e48f53c2bd2179e59c. It was not correct to copy the
ftrace stub as it would contain a relative jump to the return thunk which
would not apply to the context where it was being copied to, leading to
ftrace support to be broken.
Signed-off-by: Thadeu Lima de Souza Cascardo
Signed-off-by: Greg Kroah-Hartman
commit cb69d4d6f709f87c94afa28ae64c501576692171
Author: Namjae Jeon
Date: Tue Aug 2 07:28:51 2022 +0900
ksmbd: fix heap-based overflow in set\_ntacl\_dacl()
commit 8f0541186e9ad1b62accc9519cc2b7a7240272a7 upstream.
The testcase use SMB2\_SET\_INFO\_HE command to set a malformed file attribute
under the label `security.NTACL`. SMB2\_QUERY\_INFO\_HE command in testcase
trigger the following overflow.
[ 4712.003781] ==================================================================
[ 4712.003790] BUG: KASAN: slab-out-of-bounds in build\_sec\_desc+0x842/0x1dd0 [ksmbd]
[ 4712.003807] Write of size 1060 at addr ffff88801e34c068 by task kworker/0:0/4190
[ 4712.003813] CPU: 0 PID: 4190 Comm: kworker/0:0 Not tainted 5.19.0-rc5 #1
[ 4712.003850] Workqueue: ksmbd-io handle\_ksmbd\_work [ksmbd]
[ 4712.003867] Call Trace:
[ 4712.003870]
[ 4712.003873] dump\_stack\_lvl+0x49/0x5f
[ 4712.003935] print\_report.cold+0x5e/0x5cf
[ 4712.003972] ? ksmbd\_vfs\_get\_sd\_xattr+0x16d/0x500 [ksmbd]
[ 4712.003984] ? cmp\_map\_id+0x200/0x200
[ 4712.003988] ? build\_sec\_desc+0x842/0x1dd0 [ksmbd]
[ 4712.004000] kasan\_report+0xaa/0x120
[ 4712.004045] ? build\_sec\_desc+0x842/0x1dd0 [ksmbd]
[ 4712.004056] kasan\_check\_range+0x100/0x1e0
[ 4712.004060] memcpy+0x3c/0x60
[ 4712.004064] build\_sec\_desc+0x842/0x1dd0 [ksmbd]
[ 4712.004076] ? parse\_sec\_desc+0x580/0x580 [ksmbd]
[ 4712.004088] ? ksmbd\_acls\_fattr+0x281/0x410 [ksmbd]
[ 4712.004099] smb2\_query\_info+0xa8f/0x6110 [ksmbd]
[ 4712.004111] ? psi\_group\_change+0x856/0xd70
[ 4712.004148] ? update\_load\_avg+0x1c3/0x1af0
[ 4712.004152] ? asym\_cpu\_capacity\_scan+0x5d0/0x5d0
[ 4712.004157] ? xas\_load+0x23/0x300
[ 4712.004162] ? smb2\_query\_dir+0x1530/0x1530 [ksmbd]
[ 4712.004173] ? \_raw\_spin\_lock\_bh+0xe0/0xe0
[ 4712.004179] handle\_ksmbd\_work+0x30e/0x1020 [ksmbd]
[ 4712.004192] process\_one\_work+0x778/0x11c0
[ 4712.004227] ? \_raw\_spin\_lock\_irq+0x8e/0xe0
[ 4712.004231] worker\_thread+0x544/0x1180
[ 4712.004234] ? \_\_cpuidle\_text\_end+0x4/0x4
[ 4712.004239] kthread+0x282/0x320
[ 4712.004243] ? process\_one\_work+0x11c0/0x11c0
[ 4712.004246] ? kthread\_complete\_and\_exit+0x30/0x30
[ 4712.004282] ret\_from\_fork+0x1f/0x30
This patch add the buffer validation for security descriptor that is
stored by malformed SMB2\_SET\_INFO\_HE command. and allocate large
response buffer about SMB2\_O\_INFO\_SECURITY file info class.
Fixes: e2f34481b24d ("cifsd: add server-side procedures for SMB3")
Cc: stable@vger.kernel.org
Reported-by: zdi-disclosures@trendmicro.com # ZDI-CAN-17771
Reviewed-by: Hyunchul Lee
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit c76b216753c9eb2950a091037c9976f389e73529
Author: Hyunchul Lee
Date: Thu Jul 28 23:41:51 2022 +0900
ksmbd: prevent out of bound read for SMB2\_WRITE
commit ac60778b87e45576d7bfdbd6f53df902654e6f09 upstream.
OOB read memory can be written to a file,
if DataOffset is 0 and Length is too large
in SMB2\_WRITE request of compound request.
To prevent this, when checking the length of
the data area of SMB2\_WRITE in smb2\_get\_data\_area\_len(),
let the minimum of DataOffset be the size of
SMB2 header + the size of SMB2\_WRITE header.
This bug can lead an oops looking something like:
[ 798.008715] BUG: KASAN: slab-out-of-bounds in copy\_page\_from\_iter\_atomic+0xd3d/0x14b0
[ 798.008724] Read of size 252 at addr ffff88800f863e90 by task kworker/0:2/2859
...
[ 798.008754] Call Trace:
[ 798.008756]
[ 798.008759] dump\_stack\_lvl+0x49/0x5f
[ 798.008764] print\_report.cold+0x5e/0x5cf
[ 798.008768] ? \_\_filemap\_get\_folio+0x285/0x6d0
[ 798.008774] ? copy\_page\_from\_iter\_atomic+0xd3d/0x14b0
[ 798.008777] kasan\_report+0xaa/0x120
[ 798.008781] ? copy\_page\_from\_iter\_atomic+0xd3d/0x14b0
[ 798.008784] kasan\_check\_range+0x100/0x1e0
[ 798.008788] memcpy+0x24/0x60
[ 798.008792] copy\_page\_from\_iter\_atomic+0xd3d/0x14b0
[ 798.008795] ? pagecache\_get\_page+0x53/0x160
[ 798.008799] ? iov\_iter\_get\_pages\_alloc+0x1590/0x1590
[ 798.008803] ? ext4\_write\_begin+0xfc0/0xfc0
[ 798.008807] ? current\_time+0x72/0x210
[ 798.008811] generic\_perform\_write+0x2c8/0x530
[ 798.008816] ? filemap\_fdatawrite\_wbc+0x180/0x180
[ 798.008820] ? down\_write+0xb4/0x120
[ 798.008824] ? down\_write\_killable+0x130/0x130
[ 798.008829] ext4\_buffered\_write\_iter+0x137/0x2c0
[ 798.008833] ext4\_file\_write\_iter+0x40b/0x1490
[ 798.008837] ? \_\_fsnotify\_parent+0x275/0xb20
[ 798.008842] ? \_\_fsnotify\_update\_child\_dentry\_flags+0x2c0/0x2c0
[ 798.008846] ? ext4\_buffered\_write\_iter+0x2c0/0x2c0
[ 798.008851] \_\_kernel\_write+0x3a1/0xa70
[ 798.008855] ? \_\_x64\_sys\_preadv2+0x160/0x160
[ 798.008860] ? security\_file\_permission+0x4a/0xa0
[ 798.008865] kernel\_write+0xbb/0x360
[ 798.008869] ksmbd\_vfs\_write+0x27e/0xb90 [ksmbd]
[ 798.008881] ? ksmbd\_vfs\_read+0x830/0x830 [ksmbd]
[ 798.008892] ? \_raw\_read\_unlock+0x2a/0x50
[ 798.008896] smb2\_write+0xb45/0x14e0 [ksmbd]
[ 798.008909] ? \_\_kasan\_check\_write+0x14/0x20
[ 798.008912] ? \_raw\_spin\_lock\_bh+0xd0/0xe0
[ 798.008916] ? smb2\_read+0x15e0/0x15e0 [ksmbd]
[ 798.008927] ? memcpy+0x4e/0x60
[ 798.008931] ? \_raw\_spin\_unlock+0x19/0x30
[ 798.008934] ? ksmbd\_smb2\_check\_message+0x16af/0x2350 [ksmbd]
[ 798.008946] ? \_raw\_spin\_lock\_bh+0xe0/0xe0
[ 798.008950] handle\_ksmbd\_work+0x30e/0x1020 [ksmbd]
[ 798.008962] process\_one\_work+0x778/0x11c0
[ 798.008966] ? \_raw\_spin\_lock\_irq+0x8e/0xe0
[ 798.008970] worker\_thread+0x544/0x1180
[ 798.008973] ? \_\_cpuidle\_text\_end+0x4/0x4
[ 798.008977] kthread+0x282/0x320
[ 798.008982] ? process\_one\_work+0x11c0/0x11c0
[ 798.008985] ? kthread\_complete\_and\_exit+0x30/0x30
[ 798.008989] ret\_from\_fork+0x1f/0x30
[ 798.008995]
Fixes: e2f34481b24d ("cifsd: add server-side procedures for SMB3")
Cc: stable@vger.kernel.org
Reported-by: zdi-disclosures@trendmicro.com # ZDI-CAN-17817
Signed-off-by: Hyunchul Lee
Acked-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 5430db94434f9100cbf2284903652c5fb26a5ce1
Author: Jamal Hadi Salim
Date: Sun Aug 14 11:27:58 2022 +0000
net\_sched: cls\_route: disallow handle of 0
commit 02799571714dc5dd6948824b9d080b44a295f695 upstream.
Follows up on:
https://lore.kernel.org/all/20220809170518.164662-1-cascardo@canonical.com/
handle of 0 implies from/to of universe realm which is not very
sensible.
Lets see what this patch will do:
$sudo tc qdisc add dev $DEV root handle 1:0 prio
//lets manufacture a way to insert handle of 0
$sudo tc filter add dev $DEV parent 1:0 protocol ip prio 100 \
route to 0 from 0 classid 1:10 action ok
//gets rejected...
Error: handle of 0 is not valid.
We have an error talking to the kernel, -1
//lets create a legit entry..
sudo tc filter add dev $DEV parent 1:0 protocol ip prio 100 route from 10 \
classid 1:10 action ok
//what did the kernel insert?
$sudo tc filter ls dev $DEV parent 1:0
filter protocol ip pref 100 route chain 0
filter protocol ip pref 100 route chain 0 fh 0x000a8000 flowid 1:10 from 10
action order 1: gact action pass
random type none pass val 0
index 1 ref 1 bind 1
//Lets try to replace that legit entry with a handle of 0
$ sudo tc filter replace dev $DEV parent 1:0 protocol ip prio 100 \
handle 0x000a8000 route to 0 from 0 classid 1:10 action drop
Error: Replacing with handle of 0 is invalid.
We have an error talking to the kernel, -1
And last, lets run Cascardo's POC:
$ ./poc
0
0
-22
-22
-22
Signed-off-by: Jamal Hadi Salim
Acked-by: Stephen Hemminger
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c12f0e6126ad223806a365084e86370511654bf1
Author: Jens Wiklander
Date: Thu Aug 18 13:08:59 2022 +0200
tee: add overflow check in register\_shm\_helper()
commit 573ae4f13f630d6660008f1974c0a8a29c30e18a upstream.
With special lengths supplied by user space, register\_shm\_helper() has
an integer overflow when calculating the number of pages covered by a
supplied user space memory region.
This causes internal\_get\_user\_pages\_fast() a helper function of
pin\_user\_pages\_fast() to do a NULL pointer dereference:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000010
Modules linked in:
CPU: 1 PID: 173 Comm: optee\_example\_a Not tainted 5.19.0 #11
Hardware name: QEMU QEMU Virtual Machine, BIOS 0.0.0 02/06/2015
pc : internal\_get\_user\_pages\_fast+0x474/0xa80
Call trace:
internal\_get\_user\_pages\_fast+0x474/0xa80
pin\_user\_pages\_fast+0x24/0x4c
register\_shm\_helper+0x194/0x330
tee\_shm\_register\_user\_buf+0x78/0x120
tee\_ioctl+0xd0/0x11a0
\_\_arm64\_sys\_ioctl+0xa8/0xec
invoke\_syscall+0x48/0x114
Fix this by adding an an explicit call to access\_ok() in
tee\_shm\_register\_user\_buf() to catch an invalid user space address
early.
Fixes: 033ddf12bcf5 ("tee: add register user memory")
Cc: stable@vger.kernel.org
Reported-by: Nimish Mishra
Reported-by: Anirban Chakraborty
Reported-by: Debdeep Mukhopadhyay
Suggested-by: Jerome Forissier
Signed-off-by: Jens Wiklander
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3746d62ecf1c872a520c4866118edccb121c44fd
Author: Jens Axboe
Date: Thu Jun 23 11:06:43 2022 -0600
io\_uring: use original request task for inflight tracking
commit 386e4fb6962b9f248a80f8870aea0870ca603e89 upstream.
In prior kernels, we did file assignment always at prep time. This meant
that req->task == current. But after deferring that assignment and then
pushing the inflight tracking back in, we've got the inflight tracking
using current when it should in fact now be using req->task.
Fixup that error introduced by adding the inflight tracking back after
file assignments got modifed.
Fixes: 9cae36a094e7 ("io\_uring: reinstate the inflight tracking")
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman


=== Content from lore.kernel.org_62b90b66_20250114_181218.html ===

```
[linux-kernel.vger.kernel.org archive mirror](../?t=20220816161109)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Jiacheng Xu <578001344xu@gmail.com>
To: [linux-kernel@vger.kernel.org](../../lkml/?t=20220816161109), axboe@kernel.dk, asml.silence@gmail.co
Cc: [io-uring@vger.kernel.org](../../io-uring/?t=20220816161109), security@kernel.org
Subject: [KASAN: null-ptr-deref Write in io_file_get_normal](#r)
Date: Wed, 17 Aug 2022 00:10:09 +0800	[[thread overview]](#r)
Message-ID: <CAO4S-mdVW5GkODk0+vbQexNAAJZopwzFJ9ACvRCJ989fQ4A6Ow@mail.gmail.com> (<raw>)

Hello,

When using modified Syzkaller to fuzz the Linux kernel-5.15.58, the
following crash was triggered.

HEAD commit: 568035b01cfb Linux-5.15.58
git tree: upstream

console output:
<https://drive.google.com/file/d/1lW1tGegMXfLgS1gfyWmZShhX7LOx3vFJ/view?usp=sharing>
kernel config: <https://drive.google.com/file/d/1wgIUDwP5ho29AM-K7HhysSTfWFpfXYkG/view?usp=sharing>
syz repro: <https://drive.google.com/file/d/13l2TaalviEK6WBoXjF4tAiYfSUmlzstU/view?usp=sharing>
C reproducer: <https://drive.google.com/file/d/1iHOn1jRiQs4iKxxRTDZcATyJcZlVFQqR/view?usp=sharing>

There is a similar problem: <https://www.spinics.net/lists/io-uring/msg13047.html>

Environment:
Ubuntu 20.04 on Linux 5.4.0
QEMU 4.2.1:
qemu-system-x86_64 \
  -m 2G \
  -smp 2 \
  -kernel /home/workdir/bzImage \
  -append "console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0" \
  -drive file=/home/workdir/stretch.img,format=raw \
  -net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
  -net nic,model=e1000 \
  -enable-kvm \
  -nographic \
  -pidfile vm.pid \
  2>&1 | tee vm.log

If you fix this issue, please add the following tag to the commit:
Reported-by:  Jiacheng Xu<stitch@zju.edu.cn>

==================================================================
BUG: KASAN: null-ptr-deref in instrument_atomic_read_write
include/linux/instrumented.h:101 [inline]
BUG: KASAN: null-ptr-deref in atomic_inc
include/linux/atomic/atomic-instrumented.h:181 [inline]
BUG: KASAN: null-ptr-deref in io_req_track_inflight fs/io_uring.c:1408 [inline]
BUG: KASAN: null-ptr-deref in io_file_get_normal+0x318/0x340 fs/io_uring.c:6934
Write of size 4 at addr 0000000000000118 by task iou-wrk-13680/13681

CPU: 3 PID: 13681 Comm: iou-wrk-13680 Not tainted 5.15.58 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.13.0-1ubuntu1.1 04/01/2014
Call Trace:
 <TASK>
 __dump_stack lib/dump_stack.c:88 [inline]
 dump_stack_lvl+0x8b/0xb3 lib/dump_stack.c:106
 __kasan_report mm/kasan/report.c:446 [inline]
 kasan_report.cold+0x66/0xdf mm/kasan/report.c:459
 check_region_inline mm/kasan/generic.c:183 [inline]
 kasan_check_range+0x14e/0x1b0 mm/kasan/generic.c:189
 instrument_atomic_read_write include/linux/instrumented.h:101 [inline]
 atomic_inc include/linux/atomic/atomic-instrumented.h:181 [inline]
 io_req_track_inflight fs/io_uring.c:1408 [inline]
 io_file_get_normal+0x318/0x340 fs/io_uring.c:6934
 io_file_get fs/io_uring.c:6944 [inline]
 io_tee fs/io_uring.c:4051 [inline]
 io_issue_sqe+0x4ad9/0x7540 fs/io_uring.c:6797
 io_wq_submit_work+0x1bc/0x390 fs/io_uring.c:6863
 io_worker_handle_work+0x97c/0x1710 fs/io-wq.c:576
 io_wqe_worker+0x5b1/0xd30 fs/io-wq.c:630
 ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:298
 </TASK>
==================================================================
Kernel panic - not syncing: panic_on_warn set ...
CPU: 2 PID: 13681 Comm: iou-wrk-13680 Tainted: G    B             5.15.58 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.13.0-1ubuntu1.1 04/01/2014
Call Trace:
 <TASK>
 __dump_stack lib/dump_stack.c:88 [inline]
 dump_stack_lvl+0x8b/0xb3 lib/dump_stack.c:106
 panic+0x2b0/0x6dd kernel/panic.c:232
 end_report mm/kasan/report.c:128 [inline]
 end_report.cold+0x63/0x6f mm/kasan/report.c:113
 __kasan_report mm/kasan/report.c:449 [inline]
 kasan_report.cold+0x71/0xdf mm/kasan/report.c:459
 check_region_inline mm/kasan/generic.c:183 [inline]
 kasan_check_range+0x14e/0x1b0 mm/kasan/generic.c:189
 instrument_atomic_read_write include/linux/instrumented.h:101 [inline]
 atomic_inc include/linux/atomic/atomic-instrumented.h:181 [inline]
 io_req_track_inflight fs/io_uring.c:1408 [inline]
 io_file_get_normal+0x318/0x340 fs/io_uring.c:6934
 io_file_get fs/io_uring.c:6944 [inline]
 io_tee fs/io_uring.c:4051 [inline]
 io_issue_sqe+0x4ad9/0x7540 fs/io_uring.c:6797
 io_wq_submit_work+0x1bc/0x390 fs/io_uring.c:6863
 io_worker_handle_work+0x97c/0x1710 fs/io-wq.c:576
 io_wqe_worker+0x5b1/0xd30 fs/io-wq.c:630
 ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:298
 </TASK>

```

---

```
[next](../YvvD%2BwB64nBSpM3M%40kroah.com/)             [reply](#R)other threads:[[~2022-08-16 16:11 UTC](../?t=20220816161109)|[newest](../)]

Thread overview: 5+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2022-08-16 16:10 [Jiacheng Xu [this message]](#t)
2022-08-16 16:21 ` [KASAN: null-ptr-deref Write in io_file_get_normal](../YvvD%2BwB64nBSpM3M%40kroah.com/) Greg KH
2022-08-16 16:57   ` [Jens Axboe](../5bf54200-5b12-33b0-8bf3-0d1c6718cfba%40kernel.dk/)
2022-08-17  6:49     ` [Greg KH](../YvyPe7cKY2sLzbJt%40kroah.com/)
2022-08-17 14:22       ` [Jens Axboe](../408038f9-654c-611a-2c48-c1b5d660a6a7%40kernel.dk/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=CAO4S-mdVW5GkODk0+vbQexNAAJZopwzFJ9ACvRCJ989fQ4A6Ow@mail.gmail.com \
    --to=578001344xu@gmail.com \
    --cc=asml.silence@gmail.co \
    --cc=axboe@kernel.dk \
    --cc=io-uring@vger.kernel.org \
    --cc=linux-kernel@vger.kernel.org \
    --cc=security@kernel.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

