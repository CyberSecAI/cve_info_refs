=== Content from github.com_1c202d84_20250114_224837.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwazuh%2Fwazuh%2Fpull%2F14801)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fwazuh%2Fwazuh%2Fpull%2F14801)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=wazuh%2Fwazuh)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[wazuh](/wazuh)
/
**[wazuh](/wazuh/wazuh)**
Public

* [Notifications](/login?return_to=%2Fwazuh%2Fwazuh) You must be signed in to change notification settings
* [Fork
  1.7k](/login?return_to=%2Fwazuh%2Fwazuh)
* [Star
   11.4k](/login?return_to=%2Fwazuh%2Fwazuh)

* [Code](/wazuh/wazuh)
* [Issues
  2.4k](/wazuh/wazuh/issues)
* [Pull requests
  310](/wazuh/wazuh/pulls)
* [Discussions](/wazuh/wazuh/discussions)
* [Actions](/wazuh/wazuh/actions)
* [Projects
  0](/wazuh/wazuh/projects)
* [Wiki](/wazuh/wazuh/wiki)
* [Security](/wazuh/wazuh/security)
* [Insights](/wazuh/wazuh/pulse)

Additional navigation options

* [Code](/wazuh/wazuh)
* [Issues](/wazuh/wazuh/issues)
* [Pull requests](/wazuh/wazuh/pulls)
* [Discussions](/wazuh/wazuh/discussions)
* [Actions](/wazuh/wazuh/actions)
* [Projects](/wazuh/wazuh/projects)
* [Wiki](/wazuh/wazuh/wiki)
* [Security](/wazuh/wazuh/security)
* [Insights](/wazuh/wazuh/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fwazuh%2Fwazuh%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fwazuh%2Fwazuh%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fix arbitrary code execution flaw in Active Response #14801

 Merged

[vikman90](/vikman90)
merged 6 commits into
[4.3](/wazuh/wazuh/tree/4.3 "wazuh/wazuh:4.3")
from
[fix-ar-custom-comm](/wazuh/wazuh/tree/fix-ar-custom-comm "wazuh/wazuh:fix-ar-custom-comm")

Sep 9, 2022

 Merged

# [Fix arbitrary code execution flaw in Active Response](#top) #14801

[vikman90](/vikman90)
merged 6 commits into
[4.3](/wazuh/wazuh/tree/4.3 "wazuh/wazuh:4.3")
from
[fix-ar-custom-comm](/wazuh/wazuh/tree/fix-ar-custom-comm "wazuh/wazuh:fix-ar-custom-comm")

Sep 9, 2022

[Conversation
2](/wazuh/wazuh/pull/14801)
[Commits
6](/wazuh/wazuh/pull/14801/commits)
[Checks
0](/wazuh/wazuh/pull/14801/checks)
[Files changed](/wazuh/wazuh/pull/14801/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![vikman90](https://avatars.githubusercontent.com/u/10536251?s=60&v=4)](/vikman90)

Copy link

Member

### @vikman90 **[vikman90](/vikman90)** commented [Sep 5, 2022](#issue-1361909501) • edited by snaow Loading

| Affected versions | Module | Component | Cause | Credits |
| --- | --- | --- | --- | --- |
| 3.6.1 - 3.13.5, 4.0.0 - 4.2.7, 4.3.0 - 4.3.7 | Active Response | Agent & manager | [#1217](https://github.com/wazuh/wazuh/pull/1217) | All credits to Roshan Guragain |

Thanks to **Roshan Guragain** for reporting the flaw and helping us improve the product!

## Flaw

References to a parent folder are possible in a custom AR API request:

| Method | Endpoint | Data |
| --- | --- | --- |
| PUT | /active-response | `{"command":"!../../../../../../bin/ls"}` |

## Impact

A manager administrator with RBAC permissions `active-response:command` might execute a program outside the Active Response binary folder (*/var/ossec/active-response/bin*).

* In versions below 4.2.0, the target command would receive the extra arguments (`extra_args`) as a command-line parameter list.
* In 4.2.0 and higher, the target command receives all data (including the extra arguments) in a JSON string via standard input.

### Agents from 3.6.1 to 4.1.5

Running a custom Active Response with these parameters:

| Command | Custom | Arguments |
| --- | --- | --- |
| `../../../../root/test.sh` | `true` | `[arg1, arg2, arg3]` |

This will cause the agent to run `/root/test.sh` with the following arguments:

```
/var/ossec/active-response/bin/../../../../root/test.sh add arg1 arg2 arg3
```
### Agents from 4.2.0 to 4.3.7

Running a custom Active Response with these parameters:

| Command | Arguments |
| --- | --- |
| `!../../../../root/test.sh` | `[arg1, arg2, arg3]` |

This will cause the agent to run `/root/test.sh` with no extra arguments, but the agent will send the following string via *stdin*:

```
{"version":1,"origin":{"name":null,"module":"wazuh-execd"},"command":"add","parameters":{"extra_args":["arg1","arg2","arg3"],"alert":{},"program":"active-response/bin/../../../../root/test.sh"}}
```
## Proposed fix

We're implementing protection at two levels:

1. Prevent the agent (wazuh-execd) from running a custom AR outside *active-response/bin*.
2. Filter custom Active Response commands by the API and reject those whose member `command` contains any reference to a parent folder (`../`).

## Tests

* Send a custom AR command to Execd containing a reference to the parent folder:

```
echo -n '{"version": 1, "origin": {"name": null, "module": "framework"}, "command": "!../../../../../../bin/ls", "parameters": {"extra_args": [], "alert": {}}}' | nc -w0 -Uu /var/ossec/queue/alerts/execq
```

```
2022/09/05 14:48:51 wazuh-execd[6848] exec.c:163 at GetCommandbyName(): WARNING: Active response command '../../../../../../bin/ls' vulnerable to directory traversal attack. Ignoring.
2022/09/05 14:48:51 wazuh-execd[6848] execd.c:465 at ExecdStart(): ERROR: (1311): Invalid command name '!../../../../../../bin/ls' provided.

```

* Unit tests to check that `GetCommandbyName` rejects custom commands with path traversal.
* The API rejects custom ARs with commands referring to the parent folder:

```
curl -H "Content-Type: application/json" -X PUT https://localhost:55000/active-response?agents_list=001 --data '{"command":"!../../../../../../bin/ls"}'
```

```
{"title": "Bad Request", "detail": "'!../../../../../../bin/l' is not a 'active_response_command' - 'command'"}

```

Sorry, something went wrong.

All reactions

 [vikman90](/vikman90)
added 3 commits
[September 5, 2022 11:19](#commits-pushed-a57d329)

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&v=4)](/vikman90)

`[Fix path traversal flaw in custom Active response commands](/wazuh/wazuh/pull/14801/commits/a57d3293964e5489bef188f7d424b45c762595fb "Fix path traversal flaw in custom Active response commands")`

`[a57d329](/wazuh/wazuh/pull/14801/commits/a57d3293964e5489bef188f7d424b45c762595fb)`

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&v=4)](/vikman90)

`[Fix typo in the AR directory traversal error](/wazuh/wazuh/pull/14801/commits/065b175952c344d00a4af9cc9f5d28e964ce33fd "Fix typo in the AR directory traversal error")`

`[065b175](/wazuh/wazuh/pull/14801/commits/065b175952c344d00a4af9cc9f5d28e964ce33fd)`

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&v=4)](/vikman90)

`[Add unit tests to check path traversal detection in Active Response](/wazuh/wazuh/pull/14801/commits/22d7f283c9046b7008aa5599883b0b79760df634 "Add unit tests to check path traversal detection in Active Response")`

`[22d7f28](/wazuh/wazuh/pull/14801/commits/22d7f283c9046b7008aa5599883b0b79760df634)`

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&u=237b8fb11417597c6466a46d440d22a89350b98b&v=4)](/vikman90)
[vikman90](/vikman90)
added
[type/bug](/wazuh/wazuh/labels/type/bug)
Something isn't working
[type/bug/vulnerability](/wazuh/wazuh/labels/type/bug/vulnerability)
Exploitable vulnerability
labels
[Sep 5, 2022](#event-7322828433)

 [![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&u=237b8fb11417597c6466a46d440d22a89350b98b&v=4)](/vikman90)
[vikman90](/vikman90)
requested a review
from [chemamartinez](/chemamartinez)
[September 5, 2022 12:52](#event-7322828453)

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&u=237b8fb11417597c6466a46d440d22a89350b98b&v=4)](/vikman90)
[vikman90](/vikman90)
assigned [vikman90](/vikman90) and [davidjiglesias](/davidjiglesias)
[Sep 5, 2022](#event-7322828493)

 [vicferpoy](/vicferpoy)
added 3 commits
[September 5, 2022 16:21](#commits-pushed-96c7834)

[![@vicferpoy](https://avatars.githubusercontent.com/u/37274979?s=40&v=4)](/vicferpoy)

`[Improve command validation on active-response endpoint](/wazuh/wazuh/pull/14801/commits/96c78342e1f4f385f1e62540679ab653513cc6b1 "Improve command validation on active-response endpoint")`

`[96c7834](/wazuh/wazuh/pull/14801/commits/96c78342e1f4f385f1e62540679ab653513cc6b1)`

[![@vicferpoy](https://avatars.githubusercontent.com/u/37274979?s=40&v=4)](/vicferpoy)

`[Add new unit tests](/wazuh/wazuh/pull/14801/commits/474e0a6af44f13cbd5597484c53e5ade35525683 "Add new unit tests")`

`[474e0a6](/wazuh/wazuh/pull/14801/commits/474e0a6af44f13cbd5597484c53e5ade35525683)`

[![@vicferpoy](https://avatars.githubusercontent.com/u/37274979?s=40&v=4)](/vicferpoy)

`[Add new forbidden paths to API active-response command validation](/wazuh/wazuh/pull/14801/commits/ad8ca15f5abf0951f7001adca186faab8a5a00a9 "Add new forbidden paths to API active-response command validation")`

`[ad8ca15](/wazuh/wazuh/pull/14801/commits/ad8ca15f5abf0951f7001adca186faab8a5a00a9)`

[![chemamartinez](https://avatars.githubusercontent.com/u/29475387?s=60&v=4)](/chemamartinez)

**[chemamartinez](/chemamartinez)**
approved these changes
[Sep 5, 2022](#pullrequestreview-1096581442)

 [View reviewed changes](/wazuh/wazuh/pull/14801/files/ad8ca15f5abf0951f7001adca186faab8a5a00a9)

Copy link

Contributor

### @chemamartinez **[chemamartinez](/chemamartinez)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM!

Sorry, something went wrong.

All reactions

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&u=237b8fb11417597c6466a46d440d22a89350b98b&v=4)](/vikman90)
[vikman90](/vikman90)
mentioned this pull request
[Sep 6, 2022](#ref-issue-1362927593)

[QA testing - Fix arbitrary code execution flaw in Active Response
wazuh/wazuh-qa#3257](/wazuh/wazuh-qa/issues/3257)

Closed

2 tasks

[![davidjiglesias](https://avatars.githubusercontent.com/u/48716145?s=60&v=4)](/davidjiglesias)

**[davidjiglesias](/davidjiglesias)**
approved these changes
[Sep 6, 2022](#pullrequestreview-1097196014)

 [View reviewed changes](/wazuh/wazuh/pull/14801/files/ad8ca15f5abf0951f7001adca186faab8a5a00a9)

[![@davidjiglesias](https://avatars.githubusercontent.com/u/48716145?s=40&u=04b899fc140d95736acfc74a175c0540246b1756&v=4)](/davidjiglesias)
[davidjiglesias](/davidjiglesias)
assigned [vicferpoy](/vicferpoy) and unassigned [davidjiglesias](/davidjiglesias)
[Sep 6, 2022](#event-7328319796)

This was referenced Sep 7, 2022

[Fix arbitrary code execution in Active Response (backport to 3.13)
#14823](/wazuh/wazuh/pull/14823)
 Merged

[QA testing - Fix arbitrary code execution in Active Response (backport to 3.13)
wazuh/wazuh-qa#3264](/wazuh/wazuh-qa/issues/3264)

Closed

[![@jmv74211](https://avatars.githubusercontent.com/u/23462183?s=80&u=6af0a137cea8beeffcb41cab090b2782560fd1c2&v=4)](/jmv74211)

Copy link

Contributor

### **[jmv74211](/jmv74211)** commented [Sep 8, 2022](#issuecomment-1240873077)

| QA review  * **Type**: Manual testing. * **Status**: Approved but proposed improvements 🟡 * **Testing issue**: [QA testing - Fix arbitrary code execution flaw in Active Response wazuh-qa#3257](https://github.com/wazuh/wazuh-qa/issues/3257) * **Comments**: Everything seems to be working properly. The following issue [Improve consistency between API response messages and the active response socket #14831](https://github.com/wazuh/wazuh/issues/14831) has been opened for:   + Improve consistency between AR socket response and API when entering a custom command. Some commands are accepted in the socket but not through the API.   + Delete duplicate WARNING message. |
| --- |

All reactions

Sorry, something went wrong.

[![@davidjiglesias](https://avatars.githubusercontent.com/u/48716145?s=40&u=04b899fc140d95736acfc74a175c0540246b1756&v=4)](/davidjiglesias)
[davidjiglesias](/davidjiglesias)
mentioned this pull request
[Sep 9, 2022](#ref-pullrequest-1361848770)

[Improve command validation for `PUT /active-response`
#14800](/wazuh/wazuh/pull/14800)
 Closed

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&u=237b8fb11417597c6466a46d440d22a89350b98b&v=4)](/vikman90)
[vikman90](/vikman90)
merged commit [`b59855d`](/wazuh/wazuh/commit/b59855dbb29d9cfda06dbaff79b114becdc28444)
into
4.3

[Sep 9, 2022](https://github.com/wazuh/wazuh/pull/14801#event-7355545190)

 [![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&u=237b8fb11417597c6466a46d440d22a89350b98b&v=4)](/vikman90)
[vikman90](/vikman90)
deleted the
fix-ar-custom-comm

branch
[September 9, 2022 11:20](#event-7355545293)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fwazuh%2Fwazuh%2Fpull%2F14801)

Reviewers

[![@davidjiglesias](https://avatars.githubusercontent.com/u/48716145?s=40&v=4)](/davidjiglesias) [davidjiglesias](/davidjiglesias)

davidjiglesias approved these changes

[![@chemamartinez](https://avatars.githubusercontent.com/u/29475387?s=40&v=4)](/chemamartinez) [chemamartinez](/chemamartinez)

chemamartinez approved these changes

Assignees

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=40&v=4)](/vikman90) [vikman90](/vikman90)

[![@vicferpoy](https://avatars.githubusercontent.com/u/37274979?s=40&v=4)](/vicferpoy) [vicferpoy](/vicferpoy)

Labels

[type/bug/vulnerability](/wazuh/wazuh/labels/type/bug/vulnerability)
Exploitable vulnerability
[type/bug](/wazuh/wazuh/labels/type/bug)
Something isn't working

Projects

No open projects
1 closed project

[Release 4.3.8](/orgs/wazuh/projects/20)

Status: Done

 +2 more

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

5 participants

[![@vikman90](https://avatars.githubusercontent.com/u/10536251?s=52&v=4)](/vikman90) [![@jmv74211](https://avatars.githubusercontent.com/u/23462183?s=52&v=4)](/jmv74211) [![@chemamartinez](https://avatars.githubusercontent.com/u/29475387?s=52&v=4)](/chemamartinez) [![@davidjiglesias](https://avatars.githubusercontent.com/u/48716145?s=52&v=4)](/davidjiglesias) [![@vicferpoy](https://avatars.githubusercontent.com/u/37274979?s=52&v=4)](/vicferpoy)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


