=== Content from bugzilla.mozilla.org_ac963100_20250114_223313.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1777604)
* [XML](/show_bug.cgi?ctype=xml&id=1777604)

Closed
[Bug 1777604](/show_bug.cgi?id=1777604)
(CVE-2022-40957)

Opened 3 years ago
Closed 2 years ago

# Assertion failure: instCache\_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: instCache\_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77

## Categories

### (Core :: JavaScript: WebAssembly, defect, P2)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%3A%20WebAssembly#JavaScript%3A%20WebAssembly)

JavaScript: WebAssembly
▾

Core :: JavaScript: WebAssembly
Implementation of the WebAssembly (wasm) standard, including compilation and runtime support.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%3A%20WebAssembly&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%3A%20WebAssembly&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%3A%20WebAssembly)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

ARM64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P2

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S4

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

105 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr91 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=wontfix) |
| firefox-esr102 | [105+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=105%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed) |
| firefox103 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox103&o1=equals&v1=wontfix) |
| firefox104 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=wontfix) |
| firefox105 | [+](/buglist.cgi?f1=cf_tracking_firefox105&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox105&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr91 |  | wontfix |
| firefox-esr102 | 105+ | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox103 |  | wontfix |
| firefox104 |  | wontfix |
| firefox105 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: gkw, Assigned: rhunt)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/8db6b22eadf9c098ae78e6d0d0615e29?d=mm&size=40)  [rhunt](/user_profile?user_id=573202)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [gkw](/user_profile?user_id=132034)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/8db6b22eadf9c098ae78e6d0d0615e29?d=mm&size=40)  [rhunt](/user_profile?user_id=573202)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

### (Blocks 3 open bugs)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[sm-security](/show_bug.cgi?id=1729513 "NEW - [meta] SpiderMonkey Fuzzing & Instrumentation & Security"), [sm-jits](/show_bug.cgi?id=1729516 "NEW - [meta] Just-In-Time Compilers"), [gkw-js-fuzzing](/show_bug.cgi?id=1890610 "NEW - [meta] Gary JavaScript engine Fuzzing")

Dependency [tree](/showdependencytree.cgi?id=1777604&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1777604)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

[1779839](/show_bug.cgi?id=1779839 "RESOLVED FIXED - Perma [tier 2] tests/jit-test/jit-test/tests/asm.js/bug1565301.js | (code 138, args \"\") [0.2 s]"), [1779840](/show_bug.cgi?id=1779840 "RESOLVED FIXED - Perma [tier 2] tests/jit-test/jit-test/tests/debug/onNewScript-wasm-01.js | (code 138, args \"\") [0.1 s]"), [1779844](/show_bug.cgi?id=1779844 "RESOLVED FIXED - perma [tier2] tests/jit-test/jit-test/tests/wasm/async-instantiate.js | (code 138, args \"\") [0.3 s]"), [1779968](/show_bug.cgi?id=1779968 "RESOLVED FIXED - Startup Crash in [@ vixl::CPU::EnsureIAndDCacheCoherency]")

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: reporter-external, sec-low, testcase, Whiteboard: [adv-main105+][adv-esr102.3+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2022-40957

[Keywords:](/describekeywords.cgi)

[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-low](/buglist.cgi?keywords=sec-low&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main105+][adv-esr102.3+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a2843352_1689 "3 years ago") | - |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | - |
| --- | --- | --- |
| [tjr](/user_profile?user_id=578488) | [sec-bounty-hof](#a10967548_578488 "2 years ago") | + |
| --- | --- | --- |
| [tjr](/user_profile?user_id=578488) | sec-bounty-hof | + |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | [in-testsuite](#c20 "3 years ago") | ? |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | in-testsuite | ? |
| --- | --- | --- |
| [mboldan](/user_profile?user_id=551058) | [qe-verify](#a1510539_551058 "2 years ago") | - |
| --- | --- | --- |
| [mboldan](/user_profile?user_id=551058) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | in-qa-testsuite |  | | |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (5 files, 2 obsolete files)

| [Possible regression range](/attachment.cgi?id=9283784)  [3 years ago](#c2)  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)   1.75 MB, text/plain |  | [Details](/attachment.cgi?id=9283784&action=edit) |
| --- | --- | --- |
| [Bug 1777604 - wasm: Conservatively flush icache for all threads when compiling a module on ARM64. r?nbp](/attachment.cgi?id=9285227)  [3 years ago](#c12)  [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9285227&action=edit) | [Review](/attachment.cgi?id=9285227) |
| [Bug 1777604 - wasm: Add test. r?nbp](/attachment.cgi?id=9285694)  [3 years ago](#c18)  [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9285694&action=edit) | [Review](/attachment.cgi?id=9285694) |
| [Bug 1777604 - Flush simulated icache for all simulators when any thread flushes the icache. r?nbp](/attachment.cgi?id=9286144)  [2 years ago](#c27)  [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9286144&action=edit) | [Review](/attachment.cgi?id=9286144) |
| [Bug 1777604 - wasm: Perform a pipeline flush while creating a module object. r?nbp](/attachment.cgi?id=9286298)  [2 years ago](#c28)  [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-esr102+](#c37 "2 years ago") | [Details](/attachment.cgi?id=9286298&action=edit) | [Review](/attachment.cgi?id=9286298) |
| [Bug 1777604 - wasm: Move membarrier call to separate functions. r?nbp](/attachment.cgi?id=9286299)  [2 years ago](#c29)  [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-esr102+](#a5500513_75935 "2 years ago") | [Details](/attachment.cgi?id=9286299&action=edit) | [Review](/attachment.cgi?id=9286299) |
| [advisory.txt](/attachment.cgi?id=9294820)  [2 years ago](#c39)  [Frederik Braun [:freddy]](/user_profile?user_id=428608)   244 bytes, text/plain |  | [Details](/attachment.cgi?id=9294820&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1777604#c0)• 3 years ago |
|  | |

```
for (let i = 0; i < 99; i++) {
    relazifyFunctions();
    const { Instance, compileStreaming } = WebAssembly;
    function f(x, g) {
        var cache = streamCacheEntry(wasmTextToBinary(x));
        compileStreaming(cache).then(function (m) {
            g(new Instance(m, undefined));
            return compileStreaming(cache);
        }).then(function (m) {
            g(new Instance(m, undefined));
        });
        drainJobQueue();
    }
    f('(module \
        (func $test (param i64) (result f64) local.get 0 f64.convert_u/i64 )\
        (func (export "run") (result i32) i64.const 1 call $test f64.const 1 f64.eq )\
    )', function (i) {});
    f('(module \
        (func (export "run") (result i64) (i64.const 1))\
    )', function (i) {
        i.exports.run();
    });
}

```
```
Thread 1 "js-dbg-64-armsi" received signal SIGSEGV, Segmentation fault.
0x00005555578cbe0d in vixl::CachingDecoder::Decode (this=0x7ffff6a03df0, instr=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozCachingDecoder.h:76
76	    MOZ_ASSERT_IF(val != InstDecodedKind::NotDecodedYet,
(gdb) bt
#0  0x00005555578cbe0d in vixl::CachingDecoder::Decode (this=0x7ffff6a03df0, instr=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozCachingDecoder.h:76
#1  0x00005555578cbbfc in vixl::Simulator::ExecuteInstruction (this=this@entry=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:239
#2  0x00005555578cf5c3 in vixl::Simulator::Run (this=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:70
#3  0x00005555578ccde0 in vixl::Simulator::RunFrom (this=0x7ffff6a35100, first=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:78
#4  vixl::Simulator::call (this=0x7ffff6a35100, entry=<optimized out>, argument_count=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:327
#5  0x0000555557d4b6bf in js::wasm::Instance::callExport (this=0x7ffff5583300, cx=0x7ffff6a2d000, funcIndex=0, args=..., level=js::wasm::CoercionLevel::Spec) at /home/skygentoo/trees/mozilla-central/js/src/wasm/WasmInstance.cpp:2197
#6  0x0000555557d8c945 in WasmCall (cx=cx@entry=0x7ffff6a2d000, argc=<optimized out>, vp=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/wasm/WasmJS.cpp:2176
#7  0x0000555556c4edc0 in CallJSNative (cx=cx@entry=0x7ffff6a2d000, native=native@entry=0x555557d8c7e0 <WasmCall(JSContext*, unsigned int, JS::Value*)>, reason=<optimized out>, reason@entry=js::CallReason::Call, args=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:421
#8  0x0000555556c40bd8 in js::InternalCallOrConstruct (cx=0x7ffff6a2d000, cx@entry=0x7ffff6af8e98, args=..., construct=construct@entry=js::NO_CONSTRUCT, reason=(js::CallReason::Getter | js::CallReason::Setter | unknown: 0xf7c86720), reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:508
#9  0x0000555556c4181e in InternalCall (cx=<optimized out>, args=..., reason=reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:575
#10 0x0000555556c41789 in js::CallFromStack (cx=0x7ffff7c87a60 <_IO_stdfile_2_lock>, args=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:579
#11 0x0000555557668199 in js::jit::DoCallFallback (cx=0x7ffff7c87a60 <_IO_stdfile_2_lock>, frame=<optimized out>, stub=0x7ffff6af8e98, argc=<optimized out>, vp=0x7ffff687fa08, res=...) at /home/skygentoo/trees/mozilla-central/js/src/jit/BaselineIC.cpp:1580
#12 0x00005555578ce4d4 in vixl::Simulator::VisitCallRedirection (this=this@entry=0x7ffff6a35100, instr=<optimized out>, instr@entry=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:739
#13 0x00005555578cd090 in vixl::Simulator::VisitException (this=0x7ffff6a35100, instr=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:447
#14 0x000055555787ae2d in vixl::Decoder::VisitException (this=<optimized out>, instr=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Decoder-vixl.cpp:876
#15 0x00005555578cc192 in vixl::CachingDecoder::Decode (this=0x7ffff6a03df0, instr=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:1127
#16 0x00005555578cbbfc in vixl::Simulator::ExecuteInstruction (this=this@entry=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:239
#17 0x00005555578cf5c3 in vixl::Simulator::Run (this=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:70
#18 0x00005555578ccde0 in vixl::Simulator::RunFrom (this=0x7ffff6a35100, first=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:78
#19 vixl::Simulator::call (this=0x7ffff6a35100, entry=<optimized out>, argument_count=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:327
#20 0x0000555557b0e009 in EnterJit (cx=0x7ffff6a2d000, state=..., code=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/Jit.cpp:107
#21 js::jit::MaybeEnterJit (cx=cx@entry=0x7ffff6a2d000, state=...) at /home/skygentoo/trees/mozilla-central/js/src/jit/Jit.cpp:205
#22 0x0000555556c2dc81 in js::RunScript (cx=cx@entry=0x7ffff6a2d000, state=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:380
#23 0x0000555556c40b14 in js::InternalCallOrConstruct (cx=0x7ffff6a2d000, cx@entry=0x7ffff6af8d48, args=..., construct=construct@entry=js::NO_CONSTRUCT, reason=<optimized out>, reason@entry=js::CallReason::Getter) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:540
#24 0x0000555556c4181e in InternalCall (cx=<optimized out>, args=..., reason=reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:575
#25 0x0000555556c41789 in js::CallFromStack (cx=0x7ffff7c87a60 <_IO_stdfile_2_lock>, args=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:579
#26 0x0000555557668199 in js::jit::DoCallFallback (cx=0x7ffff7c87a60 <_IO_stdfile_2_lock>, frame=<optimized out>, stub=0x7ffff6af8d48, argc=<optimized out>, vp=0x7ffff687fbe8, res=...) at /home/skygentoo/trees/mozilla-central/js/src/jit/BaselineIC.cpp:1580
#27 0x00005555578ce4d4 in vixl::Simulator::VisitCallRedirection (this=this@entry=0x7ffff6a35100, instr=<optimized out>, instr@entry=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:739
#28 0x00005555578cd090 in vixl::Simulator::VisitException (this=0x7ffff6a35100, instr=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:447
#29 0x000055555787ae2d in vixl::Decoder::VisitException (this=<optimized out>, instr=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Decoder-vixl.cpp:876
#30 0x00005555578cc192 in vixl::CachingDecoder::Decode (this=0x7ffff6a03df0, instr=0x7ffff6a42c68) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:1127
#31 0x00005555578cbbfc in vixl::Simulator::ExecuteInstruction (this=this@entry=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:239
#32 0x00005555578cf5c3 in vixl::Simulator::Run (this=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:70
#33 0x00005555578ccde0 in vixl::Simulator::RunFrom (this=0x7ffff6a35100, first=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:78
#34 vixl::Simulator::call (this=0x7ffff6a35100, entry=<optimized out>, argument_count=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:327
#35 0x0000555557b0e009 in EnterJit (cx=0x7ffff6a2d000, state=..., code=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/Jit.cpp:107
#36 js::jit::MaybeEnterJit (cx=cx@entry=0x7ffff6a2d000, state=...) at /home/skygentoo/trees/mozilla-central/js/src/jit/Jit.cpp:205
#37 0x0000555556c2dc81 in js::RunScript (cx=cx@entry=0x7ffff6a2d000, state=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:380
#38 0x0000555556c40b14 in js::InternalCallOrConstruct (cx=0x7ffff6a2d000, cx@entry=0x0, args=..., construct=construct@entry=js::NO_CONSTRUCT, reason=<optimized out>, reason@entry=(unknown: 0xffffb058)) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:540
#39 0x0000555556c4181e in InternalCall (cx=cx@entry=0x7ffff6a2d000, args=..., reason=reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:575
#40 0x0000555556c41a13 in js::Call (cx=cx@entry=0x7ffff6a2d000, fval=..., fval@entry=..., thisv=..., thisv@entry=..., args=..., rval=rval@entry=..., reason=reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:606
#41 0x0000555556d071dd in js::Call (cx=0x7ffff6a2d000, fval=..., thisv=..., arg0=..., rval=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.h:105
#42 0x0000555556f0a491 in PromiseReactionJob (cx=0x7ffff7c87a60 <_IO_stdfile_2_lock>, cx@entry=0x7ffff6a2d000, argc=<optimized out>, vp=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/builtin/Promise.cpp:2241
#43 0x0000555556c4edc0 in CallJSNative (cx=cx@entry=0x7ffff6a2d000, native=native@entry=0x555556f09330 <PromiseReactionJob(JSContext*, unsigned int, JS::Value*)>, reason=<optimized out>, reason@entry=js::CallReason::Call, args=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:421
#44 0x0000555556c40bd8 in js::InternalCallOrConstruct (cx=0x7ffff6a2d000, cx@entry=0x0, args=..., construct=construct@entry=js::NO_CONSTRUCT, reason=(js::CallReason::Getter | js::CallReason::Setter | unknown: 0xf7c86720), reason@entry=(unknown: 0xffffb438)) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:508
#45 0x0000555556c4181e in InternalCall (cx=cx@entry=0x7ffff6a2d000, args=..., reason=reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:575
#46 0x0000555556c41a13 in js::Call (cx=cx@entry=0x7ffff6a2d000, fval=..., thisv=..., args=..., rval=rval@entry=..., reason=reason@entry=js::CallReason::Call) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:606
#47 0x0000555556d9bdb2 in JS::Call (cx=0x7ffff7c87a60 <_IO_stdfile_2_lock>, cx@entry=0x7ffff6a2d000, thisv=..., fval=..., args=..., rval=..., rval@entry=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/CallAndConstruct.cpp:117
#48 0x0000555556e62c0e in JS::Call (cx=0x7ffff6a2d000, thisv=..., funObj=..., args=..., rval=...) at /home/skygentoo/shell-cache/js-dbg-64-armsim64-linux-x86_64-65e579f52525/objdir-js/dist/include/js/CallAndConstruct.h:110
#49 js::InternalJobQueue::runJobs (this=0x7ffff6a40d00, cx=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/vm/JSContext.cpp:849
#50 0x0000555556e62666 in js::RunJobs (cx=cx@entry=0x7ffff6a2d000) at /home/skygentoo/trees/mozilla-central/js/src/vm/JSContext.cpp:786
#51 0x0000555556b44ff8 in RunShellJobs (cx=cx@entry=0x7ffff6a2d000) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:1166
#52 0x0000555556b5ebc2 in DrainJobQueue (cx=0x7ffff6a2d000, argc=<optimized out>, vp=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:1188
#53 0x00005555578ce2f5 in vixl::Simulator::VisitCallRedirection (this=this@entry=0x7ffff6a35100, instr=<optimized out>, instr@entry=0x7ffff553b588) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:724
#54 0x00005555578cd090 in vixl::Simulator::VisitException (this=0x7ffff6a35100, instr=0x7ffff553b588) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:447
#55 0x000055555787ae2d in vixl::Decoder::VisitException (this=<optimized out>, instr=0x7ffff553b588) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Decoder-vixl.cpp:876
#56 0x00005555578cc192 in vixl::CachingDecoder::Decode (this=0x7ffff6a03df0, instr=0x7ffff553b588) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:1127
#57 0x00005555578cbbfc in vixl::Simulator::ExecuteInstruction (this=this@entry=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:239
#58 0x00005555578cf5c3 in vixl::Simulator::Run (this=0x7ffff6a35100) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:70
#59 0x00005555578ccde0 in vixl::Simulator::RunFrom (this=0x7ffff6a35100, first=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/Simulator-vixl.cpp:78
#60 vixl::Simulator::call (this=0x7ffff6a35100, entry=<optimized out>, argument_count=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/arm64/vixl/MozSimulator-vixl.cpp:327
#61 0x0000555557b0e009 in EnterJit (cx=0x7ffff6a2d000, state=..., code=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/jit/Jit.cpp:107
#62 js::jit::MaybeEnterJit (cx=cx@entry=0x7ffff6a2d000, state=...) at /home/skygentoo/trees/mozilla-central/js/src/jit/Jit.cpp:205
#63 0x0000555556c2dc81 in js::RunScript (cx=cx@entry=0x7ffff6a2d000, state=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:380
#64 0x0000555556c43324 in js::ExecuteKernel (cx=cx@entry=0x7ffff6a2d000, script=script@entry=..., envChainArg=envChainArg@entry=..., evalInFrame=evalInFrame@entry=..., result=result@entry=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:782
#65 0x0000555556c4370c in js::Execute (cx=cx@entry=0x7ffff6a2d000, script=..., envChain=..., rval=..., rval@entry=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/Interpreter.cpp:814
#66 0x0000555556dbfe6f in ExecuteScript (cx=cx@entry=0x7ffff6a2d000, envChain=..., script=..., rval=rval@entry=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/CompilationAndEvaluation.cpp:509
#67 0x0000555556dc0098 in JS_ExecuteScript (cx=cx@entry=0x7ffff6a2d000, scriptArg=scriptArg@entry=...) at /home/skygentoo/trees/mozilla-central/js/src/vm/CompilationAndEvaluation.cpp:533
#68 0x0000555556b7348a in RunFile (cx=cx@entry=0x7ffff6a2d000, filename=0x7fffffffde57 "114.js", filename@entry=0x7ffff7864020 "\230$\255\373\344\344\344", <incomplete sequence \344>, file=file@entry=0x7ffff7864020, compileMethod=<optimized out>, compileMethod@entry=CompileUtf8::DontInflate, compileOnly=false) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:1069
#69 0x0000555556b72b4f in Process (cx=cx@entry=0x7ffff6a2d000, filename=<optimized out>, forceTTY=false, kind=kind@entry=FileScript) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:1659
#70 0x0000555556b38e97 in ProcessArgs (cx=0x7ffff6a2d000, op=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:10964
#71 Shell (cx=0x7ffff6a2d000, op=op@entry=0x7fffffffd6d8) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:11703
#72 0x0000555556b31d6a in main (argc=<optimized out>, argv=<optimized out>) at /home/skygentoo/trees/mozilla-central/js/src/shell/js.cpp:12825
(gdb)

```

Run with `--fuzzing-safe --ion-offthread-compile=off --ion-eager`, compile with `AR=ar sh ./configure --enable-simulator=arm64 --enable-debug --with-ccache --enable-gczeal --enable-debug-symbols --disable-bootstrap --disable-tests`, tested on m-c rev 65e579f52525.

Bisection result coming up...

Note that this may be slightly intermittent. Not sure if this is s-s.

Flags: sec-bounty?

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1777604#c1)• 3 years ago |
|  | |

It seems to go back prior to <https://hg.mozilla.org/mozilla-central/rev/4c2a5ad9f027181be19879ad7ac853db2ff520a6> but I'm still digging at it.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1777604#c2)• 3 years ago |
|  | |

Attached file
[Possible regression range](attachment.cgi?id=9283784)
— [Details](attachment.cgi?id=9283784&action=edit)

Might any of the following regressions (due to build failures), or possibly [bug 1661016](/show_bug.cgi?id=1661016 "RESOLVED FIXED - Cranelift: test failures when tiering on aarch64 simulator"), be the potential cause?

Unsure who to needinfo specifically, so setting Jan as a start.

Flags: needinfo?(jdemooij)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a98090_406194)• 3 years ago |

Group: core-security → javascript-core-security

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1777604#c3)• 3 years ago |
|  | |

This fails in the instruction cache coherency verifier that's part of the ARM64 simulator (added in [bug 1441436](/show_bug.cgi?id=1441436 "RESOLVED FIXED - ARM64: Simulator should incorporate icache checking")). It could be an actual bug or an issue with the verification code. Looking at the test, I wonder if this is related to Wasm machine code serialization.

Flags: needinfo?(jdemooij) → needinfo?(rhunt)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a416010_422187)• 3 years ago |

Blocks: [sm-jits](/show_bug.cgi?id=1729516 "NEW - [meta] Just-In-Time Compilers"), [sm-security](/show_bug.cgi?id=1729513 "NEW - [meta] SpiderMonkey Fuzzing & Instrumentation & Security")Severity: -- → S4Flags: needinfo?(nicolas.b.pierron)Priority: -- → P2

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1777604#c4)• 3 years ago |
|  | |

We're not flushing the icache correctly when deserializing code on a different thread from the one we'll be executing on.

Assignee: nobody → rhuntFlags: needinfo?(rhunt)Flags: needinfo?(nicolas.b.pierron)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1777604#c5)• 3 years ago |
|  | |

(In reply to Ryan Hunt [:rhunt] from [comment #4](/show_bug.cgi?id=1777604#c4 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> We're not flushing the icache correctly when deserializing code on a different thread from the one we'll be executing on.

Yes, this is a requirement that this should be done on the core which is executing the code, as ARM64 can have big/small cores which are not in-sync in terms of icache invalidation. The executing core should refresh the memory which is mapped as executable, such that the icache does not pick the previously mapped executable content.

The Simulator is extra pessimistic in this case, due to inability to fully emulate the icache, but this only make this issue unlikely instead of impossible.

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1777604#c6)• 3 years ago |
|  | |

Fixing this is simple for the serialized module case, but I'm not really sure why this works for the case where we compile a module on one thread and then postMessage the module to another thread.

As far as I can see, we do FlushIcache::LocalThreadOnly for the first tier of a module. If that's the only tier (or the race is won) and the module is posted to another thread, I don't see any synchronization that would prevent this issue. Unless there's some other mechanism to guarantee correctness here.

There are some WPT's for this situation that theoretically should be hit, I wonder if we just don't run them or run them with the ARM64 simulator.

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1777604#c7)• 3 years ago |
|  | |

When compiling, we do the following:

<https://searchfox.org/mozilla-central/source/js/src/wasm/WasmCode.cpp#342-346>

```
  // Optimized compilation finishes on a background thread, so we must make sure
  // to flush the icaches of all the executing threads.
  FlushICacheSpec flushIcacheSpec = isTier2 == IsTier2::Tier2
                                        ? FlushICacheSpec::AllThreads
                                        : FlushICacheSpec::LocalThreadOnly;

```

Which set the `codeIsThreadLocal` argument to `true` in [CPU::EnsureIAndDCacheCoherency](https://searchfox.org/mozilla-central/source/js/src/jit/arm64/vixl/MozCpu-vixl.cpp#156), which calls a membarrier with the intent of flushing all instruction caches.

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1777604#c8)• 3 years ago |
|  | |

(In reply to Ryan Hunt [:rhunt] from [comment #6](/show_bug.cgi?id=1777604#c6 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> Fixing this is simple for the serialized module case, but I'm not really sure why this works for the case where we compile a module on one thread and then postMessage the module to another thread.

The case where we share modules across workers might not exists in the JS shell, and thus we might not have caught it before.

> There are some WPT's for this situation that theoretically should be hit, I wonder if we just don't run them or run them with the ARM64 simulator.

Probably not, the simulator has a huge cost and we limit our usage of it to JS shell test cases.

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1777604#c9)• 3 years ago |
|  | |

Okay, I was able to modify the test case to confirm that this is not related to just code caching. I can also trigger it using our normal background thread compiling code. I'm experimenting with using the evalInWorker builtin to trigger this, but it's tricky.

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1777604#c10)• 3 years ago |
|  | |

Nicolas, do you know the relative difference in cost for FlushICacheSpec::AllThreads, versus LocalThreadOnly?

I can write a fix for this that flushes the local thread's icache when it receives a module from another thread (either from a background compile, or via postMessage), but I want to make sure it's worth it versus just always performing an all threads flush when a module is finished compiling.

Flags: needinfo?(nicolas.b.pierron)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1777604#c11)• 3 years ago |
|  | |

(In reply to Ryan Hunt [:rhunt] from [comment #10](/show_bug.cgi?id=1777604#c10 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> Nicolas, do you know the relative difference in cost for FlushICacheSpec::AllThreads, versus LocalThreadOnly?
>
> I can write a fix for this that flushes the local thread's icache when it receives a module from another thread (either from a background compile, or via postMessage), but I want to make sure it's worth it versus just always performing an all threads flush when a module is finished compiling.

So far, I've never saw any bug report mentioning the FlushICacheSpec::AllThreads as being an issue.

On the other hand detecting it might be hard without system-wide profiling tools to detect these kind of effects.

I would not worry much about flushing all threads i-cache today, knowing that spidermonkey alone does not fit in the instruction cache.

Flags: needinfo?(nicolas.b.pierron)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1777604#c12)• 3 years ago |
|  | |

Attached file
[Bug 1777604 - wasm: Conservatively flush icache for all threads when compiling a module on ARM64. r?nbp](attachment.cgi?id=9285227) (obsolete)
— [Details](attachment.cgi?id=9285227&action=edit)

Wasm code may be used from multiple threads in several ways:

1. Tier2 code is committed from a background thread
2. Modules may be compiled/deserialized on a background thread
3. Modules may be postMessage'ed to different threads

The ARM64 I&D-cache is not coherent and requires us to perform

synchronization when creating new code.

There has been previous discussion about how to handle

this in wasm:

* <https://bugzilla.mozilla.org/show_bug.cgi?id=1529933>
* <https://bugzilla.mozilla.org/show_bug.cgi?id=1661016>

Lars/Luke originally discussed this with someone at ARM

and decided that our existing cache synchronization for

compiling, our allocating of fresh code pages, and use

of mprotect was sufficient.

Later, Benjamin ran into a cache simulator failure and

researched this again and came to the conclusion that

we need to force synchronization on all threads when

tiering.

We now have a test case that can cause the cache simulator

to fail again, and it's not clear if this is a real bug

or the simulator being pessimistic compared to real

hardware.

This commit changes all module compilations to trigger

the membarrier on all threads, instead of just the local

thread. This is very conservative and to be extra safe

in the presence of poor documentation and possible

hardware errata.

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1777604#c13)• 3 years ago |
|  | |

I am conservatively rating this sec-low. The commit message above explains the issue in some detail. I'm removing that from the commit and just letting it live in this bug.

The gist is that on ARM64 we need to keep the instruction cache coherent with the data cache when creating wasm code. If we don't do this correctly, previously compiled wasm code that exists in a stale I-cache may execute. When we are simulating ARM64 code we have a cache coherence simulation that attempts to catch issues here, but it's not a perfect simulator of 'real hardware' as there are potential synchronization points that exist in real hardware, but not the simulator. So a failure in the simulator doesn't necessarily mean we're failing on real hardware. At the same time, real hardware has been known to have errata and so it's good to be conservative if the performance penalty is not extreme.

The above linked two bugs show the reasons we have for thinking that our existing synchronization is sufficient for real hardware, and AFAICS are still valid. But just in the case that we are missing something, this commit adds an extra sync point to work around this debug assertion and to conservatively cover misbehaving hardware.

Keywords: [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1777604#c14)• 3 years ago |
|  | |

Landed: <https://hg.mozilla.org/integration/autoland/rev/9d028d37a9dbc1e24f5c4f314519b2df84dab342>

Backed out for failing own test:

<https://hg.mozilla.org/integration/autoland/rev/9d028d37a9dbc1e24f5c4f314519b2df84dab342>

[Push with failures](https://treeherder.mozilla.org/jobs?repo=autoland&resultStatus=testfailed%2Cbusted%2Cexception%2Crunnable&revision=9d028d37a9dbc1e24f5c4f314519b2df84dab342&searchStr=sm&group_state=expanded&selectedTaskRun=OCU7tOBdRKyHVmrrQ4OJQg.0)

[Failure log](https://treeherder.mozilla.org/logviewer?job_id=384235461&repo=autoland)

> TEST-UNEXPECTED-FAIL | js/src/jit-test/tests/wasm/regress/[bug1777604](/show_bug.cgi?id=1777604 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77")/test.js | /builds/worker/checkouts/gecko/js/src/jit-test/tests/wasm/regress/[bug1777604](/show_bug.cgi?id=1777604 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77")/test.js:11:25 Error: WebAssembly.compileStreaming not supported with --no-threads (code 3, args "--ion-offthread-compile=off --ion-eager --ion-eager --ion-offthread-compile=off --ion-check-range-analysis --ion-extra-checks --no-sse3 --no-threads") [0.1 s]

Flags: needinfo?(rhunt)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1777604#c15)• 3 years ago |
|  | |

Needs an extra guard for when streaming compilation is disabled.

Flags: needinfo?(rhunt)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1777604#c16)• 3 years ago |
|  | |

(In reply to Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout) from [comment #14](/show_bug.cgi?id=1777604#c14 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> Landed: <https://hg.mozilla.org/integration/autoland/rev/9d028d37a9dbc1e24f5c4f314519b2df84dab342>
>
> Backed out for failing own test:

Whoa …!!!

Daniel, what is the procedure in this case? I do not think the test case would help much in creating an exploit, as it is relying on the simulator instrumentation. However this is definitely a spot light on the issue.

The issue is that the instruction cache might be stale, and that one attacker might use the stale content of the instruction cache as a mean to do random code execution, as the new code provide potentially a new entry point into a random position of code which was properly freed. However, being able to make use of this attack implies that the instruction cache was not trashed by all the code present in the rest of SpiderMonkey/Firefox which sounds very unliekly.

Flags: needinfo?(dveditz)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1777604#c17)• 3 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1777604&comment_id=15984053 "1 revision") |
|  | |

(In reply to Nicolas B. Pierron [:nbp] from [comment #16](/show_bug.cgi?id=1777604#c16 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> The issue is that the instruction cache might be stale, and that one attacker might use the stale content of the instruction cache as a mean to do random code execution, as the new code provide potentially a new entry point into a random position of code which was properly freed. However, being able to make use of this attack implies that the instruction cache was not trashed by all the code present in the rest of SpiderMonkey/Firefox which sounds very unliekly.

In addition to the i-cache needing to not be trashed, as stated above we have other reasons to think that our synchronization is sufficient for real hardware and this commit is just trying to be conservative for if there is something we have missed and to workaround the simulator. So the sec-low rating is to just be extra careful. The test was included so that we didn't have to circle back. It only triggers an assertion failure in the simulator, no failure happens on real hardware.

> The above linked two bugs show the reasons we have for thinking that our existing synchronization is sufficient for real hardware, and AFAICS are still valid. But just in the case that we are missing something, this commit adds an extra sync point to work around this debug assertion and to conservatively cover misbehaving hardware.

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1777604#c18)• 3 years ago |
|  | |

Attached file
[Bug 1777604 - wasm: Add test. r?nbp](attachment.cgi?id=9285694)
— [Details](attachment.cgi?id=9285694&action=edit)

Depends on D151677

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1777604#c19)• 3 years ago |
|  | |

Split the test out, will land it separately.

|  | [Atila Butkovits](/user_profile?user_id=661920) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1295583_661920)• 3 years ago |

Regressions: [1779844](/show_bug.cgi?id=1779844 "RESOLVED FIXED - perma [tier2] tests/jit-test/jit-test/tests/wasm/async-instantiate.js | (code 138, args \"\") [0.3 s]")

|  | [Atila Butkovits](/user_profile?user_id=661920) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1295607_661920)• 3 years ago |

Regressions: [1779840](/show_bug.cgi?id=1779840 "RESOLVED FIXED - Perma [tier 2] tests/jit-test/jit-test/tests/debug/onNewScript-wasm-01.js | (code 138, args \"\") [0.1 s]")

|  | [Atila Butkovits](/user_profile?user_id=661920) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1295626_661920)• 3 years ago |

Regressions: [1779839](/show_bug.cgi?id=1779839 "RESOLVED FIXED - Perma [tier 2] tests/jit-test/jit-test/tests/asm.js/bug1565301.js | (code 138, args \"\") [0.2 s]")

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1777604#c20)• 3 years ago |
|  | |

wasm: Conservatively flush icache for all threads when compiling a module on ARM64. r=nbp

<https://hg.mozilla.org/integration/autoland/rev/491e6ce8da1547923e113051e4a4774e9cb34e2e>

<https://hg.mozilla.org/mozilla-central/rev/491e6ce8da15>

Group: javascript-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 3 years ago
[status-firefox104](/buglist.cgi?f1=cf_status_firefox104&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=fixed)Flags: in-testsuite?Resolution: --- → FIXEDTarget Milestone: --- → 104 Branch

|  | [Mihai Boldan, Desktop QA [:mboldan]](/user_profile?user_id=551058) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1510539_551058)• 2 years ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1527595_75935)• 2 years ago |

Regressions: [1779968](/show_bug.cgi?id=1779968 "RESOLVED FIXED - Startup Crash in [@ vixl::CPU::EnsureIAndDCacheCoherency]")

|  | [Sandor Molnar[:smolnar]](/user_profile?user_id=670045) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1777604#c21)• 2 years ago |
|  | |

Backed out for causing [bug 1779968](/show_bug.cgi?id=1779968 "RESOLVED FIXED - Startup Crash in [@ vixl::CPU::EnsureIAndDCacheCoherency]")

Backout link: <https://hg.mozilla.org/mozilla-central/rev/674d4b94e8b3de795c1f51e1f20d88ef363cff58>

Status: RESOLVED → REOPENED
[status-firefox104](/buglist.cgi?f1=cf_status_firefox104&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=fixed) → [affected](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=affected)Flags: needinfo?(rhunt)Resolution: FIXED → ---Target Milestone: 104 Branch → ---

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1777604#c22)• 2 years ago |
|  | |

Hmm. Looking at the crash notes for the linked bug, it looks like the linux version is below the minimum required for membarrier syscall support. What's odd, is that the patch that landed here just caused us to try to call membarrier more frequently. Before we would only do it when tiering wasm code. So I'm surprised we haven't run into this before. Looking into this more.

Flags: needinfo?(rhunt)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1777604#c23)• 2 years ago |
|  | |

It looks like we need to support android devices that don't have membarrier (MEMBARRIER\_CMD\_PRIVATE\_EXPEDITED\_SYNC\_CORE?) support. This is likely a pre-existing bug made more frequent. Although I haven't found any crash reports to confirm this.

|  | [Kevin Brosnan [Ex-Mozilla]](/user_profile?user_id=406670) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1777604#c24)• 2 years ago |
|  | |

There are a three crashes on Android 102 possibly all from the same install which would not have this fix. <https://crash-stats.mozilla.org/signature/?major_version=%3C%3D103&signature=vixl%3A%3ACPU%3A%3AEnsureIAndDCacheCoherency&_columns=date&_columns=product&_columns=version&_columns=build_id&_columns=platform&_columns=reason&_columns=address&_columns=install_time&_columns=startup_crash&_sort=-date&page=1>

There are 8k crashes on Nightly Android.

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1777604#c25)• 2 years ago |
|  | |

(In reply to Kevin Brosnan [:kbrosnan] from [comment #24](/show_bug.cgi?id=1777604#c24 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> There are a three crashes on Android 102 possibly all from the same install which would not have this fix. <https://crash-stats.mozilla.org/signature/?major_version=%3C%3D103&signature=vixl%3A%3ACPU%3A%3AEnsureIAndDCacheCoherency&_columns=date&_columns=product&_columns=version&_columns=build_id&_columns=platform&_columns=reason&_columns=address&_columns=install_time&_columns=startup_crash&_sort=-date&page=1>
>
> There are 8k crashes on Nightly Android.

Taking a look at those three, it looks like they are all unrelated.

Looking into this deeper it turns out this was not a pre-existing issue as the previous code relied on a [IsICacheSafe](https://searchfox.org/mozilla-central/source/js/src/wasm/WasmCompile.cpp#596) check to gate this. This would turn off tiering on linux kernels below 4.16, avoiding this issue.

Now if we start trying to use membarrier on *all* wasm compilations (not just tiering), we either have to find an alternative to membarrier or disable wasm on these kernel versions (likely not this option).

Looking at other VM's I can get the source code for (V8, dart, dotnetcore/mono) I don't see any of them using the membarrier syscall for this purpose. They all 'flush the icache', but I can't find any synchronization beyond that.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1777604#c26)• 2 years ago |
|  | |

(In reply to Nicolas B. Pierron [:nbp] from [comment #16](/show_bug.cgi?id=1777604#c16 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77"))

> > Backed out for failing own test:
>
> Daniel, what is the procedure in this case? I do not think the test case would help much in creating an exploit, as it is relying on the simulator instrumentation. However this is definitely a spot light on the issue.

That's a good reason to keep pushing to fix this somewhat quickly, but if the sec-low rating is accurate it's not too troubling. There's no well-defined "procedure", but we do need to ask ourselves whether we just zero-day'd ourselves and if so how badly. In this case it doesn't seem terrible.

Flags: needinfo?(dveditz)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1777604#c27)• 2 years ago |
|  | |

Attached file
[Bug 1777604 - Flush simulated icache for all simulators when any thread flushes the icache. r?nbp](attachment.cgi?id=9286144) (obsolete)
— [Details](attachment.cgi?id=9286144&action=edit)

The `ic ivau` instruction performs a broadcasted invalidation of

the instruction cache for the address range provided. The simulator

should perform this flush for all active simulators to emulate this

behavior. Currently this is only done when a membarrier is called,

which is too conservative.

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1709678_600971)• 2 years ago |

[Attachment #9285227](/attachment.cgi?id=9285227&action=edit "Bug 1777604 - wasm: Conservatively flush icache for all threads when compiling a module on ARM64. r?nbp") -
Attachment is obsolete: true

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1777604#c28)• 2 years ago |
|  | |

Attached file
[Bug 1777604 - wasm: Perform a pipeline flush while creating a module object. r?nbp](attachment.cgi?id=9286298)
— [Details](attachment.cgi?id=9286298&action=edit)

ARM and ARM64 require a 'context synchronization operation' to occur before

running JIT'ed code. This operation forces any stale data in the execution

pipeline to be reloaded. As we globally flush the icache after compiling code,

the reload will get the newly JIT'ed code.

A 'context synchronization operation' can be performed several ways. Interrupts

and processor exceptions are the most common events. Executing an `isb`

instruction can also accomplish this. There is no instruction that will broadcast

context synchronization to all cores.

Newly compiled wasm code can be used on a different thread in several ways:

1. Compiled on helper thread and received on JS thread
2. Passed from one JS thread to another JS thread
3. Patched into the jump table while finishing tier2 code

We currently don't do anything special for (1)/(2) and rely on non-specified

behavior (or luck) to avoid this issue. As far as I can tell, no other VM

(V8, Dart, Mono) does anything for this situation, so we're likely not

vulnerable. We should still fix this though.

For (3), we rely on the inter-processor-interrupt performed by the membarrier

syscall to achieve this when tiering.

This commit adds a manually placed `isb` instruction to conservatively

handle (1) and (2). The most convenient place for this is when we are

constructing a WasmModuleObject, as that is used on all paths where a

module may be received from another thread.

JS does not require this, as while it may be compiled on another thread,

it will be linked on the thread it will run on, which will trigger an

icache flush which will flush the execution context.

Depends on D152230

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1777604#c29)• 2 years ago |
|  | |

Attached file
[Bug 1777604 - wasm: Move membarrier call to separate functions. r?nbp](attachment.cgi?id=9286299)
— [Details](attachment.cgi?id=9286299&action=edit)

The membarrier is really used for a 'FlushExecutionContextForAllThreads`

operation, it doesn't flush the icache for all threads. Moving it to a

separate function makes this clear and allows wasm to call it just once

before we commit our tier2 code.

Depends on D152304

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1777604#c30)• 2 years ago |
|  | |

Okay, I believe we've figured this out now. Here's the important points:

1. We have a mismatch between our ARM64 cache simulator and real hardware that causes the original testcase to fail in an assertion

   - The issue is that the simulator will only flush the icache of all threads when flags = AllThreads. But real hardware will in-fact clear the icache for all threads even if flags = AllThreads.

   - Fixing this mismatch, fixes the original test case.
2. flags = AllThreads triggered a membarrier call which was described as flushing the icache for all threads. It's actually more subtle in triggering a 'context synchronization' on all threads, which will clear out any stale data in in-progress instruction pipelines. The `ic ivau` instruction we execute before the membarrier will flush the icache of all threads. We should make this clear in the code.
3. We currently just use the membarrier to do the global 'context sync' when we're patching in tier2 code. This makes sense as we don't have any other good way to interrupt code to perform this otherwise.
4. From discussion with ARM engineer, Anton Kirilov, we should probably execute a 'context sync' using an `isb` instruction when we receive a module from another thread. It's possible this is not required due to some other operation consistently triggering a 'context sync', but it's fragile if we don't explicitly do it. I checked V8, Dart, Mono and couldn't find this being done in other VM's so we're not far afield in this regard.

In summary, I think we should still keep this sec-low due to (4), although I think we're very likely to not be vulnerable to a code UAF through this due to the very small window of the instruction pipeline, and the likelyhood that something else in the architecture keeps this safe enough that other VM's don't worry about it.

I'm linking to past discussions of interest for future reference, because digging this all up was challenging.

1. <https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/Code.20generation.20and.20CPU.20cache.20maintenance>
2. <https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime/topic/Using.20membarrier.20when.20finalizing.20code>
3. <https://github.com/bytecodealliance/wasmtime/pull/3426>
4. <https://bugzilla.mozilla.org/show_bug.cgi?id=1529933>
5. <https://bugzilla.mozilla.org/show_bug.cgi?id=1661016>

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a1892133_600971)• 2 years ago |

[Attachment #9286144](/attachment.cgi?id=9286144&action=edit "Bug 1777604 - Flush simulated icache for all simulators when any thread flushes the icache. r?nbp") -
Attachment is obsolete: true

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1777604#c31)• 2 years ago |
|  | |

The delay in landing was caused by difficulty getting the platform ifdef's and includes exactly right. The two commits are queued up now. I've removed their commit descriptions, so I'm posting them here for posterity.

[Bug 1777604](/show_bug.cgi?id=1777604 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77") - wasm: Perform a pipeline flush while creating a module object. r?nbp

ARM and ARM64 require a 'context synchronization operation' to occur before

running JIT'ed code. This operation forces any stale data in the execution

pipeline to be reloaded. As we globally flush the icache after compiling code,

the reload will get the newly JIT'ed code.

A 'context synchronization operation' can be performed several ways. Interrupts

and processor exceptions are the most common events. Executing an `isb`

instruction can also accomplish this. There is no instruction that will broadcast

context synchronization to all cores.

Newly compiled wasm code can be used on a different thread in several ways:

1. Compiled on helper thread and received on JS thread
2. Passed from one JS thread to another JS thread
3. Patched into the jump table while finishing tier2 code

We currently don't do anything special for (1)/(2) and rely on non-specified

behavior (or luck) to avoid this issue. As far as I can tell, no other VM

(V8, Dart, Mono) does anything for this situation, so we're likely not

vulnerable. We should still fix this though.

For (3), we rely on the inter-processor-interrupt performed by the membarrier

syscall to achieve this when tiering.

This commit adds a manually placed `isb` instruction to conservatively

handle (1) and (2). The most convenient place for this is when we are

constructing a WasmModuleObject, as that is used on all paths where a

module may be received from another thread.

JS does not require this, as while it may be compiled on another thread,

it will be linked on the thread it will run on, which will trigger an

icache flush which will flush the execution context.

Differential Revision: <https://phabricator.services.mozilla.com/D152304>

[Bug 1777604](/show_bug.cgi?id=1777604 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77") - wasm: Move membarrier call to separate functions. r?nbp

The membarrier is really used for a 'FlushExecutionContextForAllThreads`

operation, it doesn't flush the icache for all threads. Moving it to a

separate function makes this clear and allows wasm to call it just once

before we commit our tier2 code.

Differential Revision: <https://phabricator.services.mozilla.com/D152305>

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1777604#c32)• 2 years ago |
|  | |

wasm: Perform a pipeline flush while creating a module object. r=nbp

<https://hg.mozilla.org/integration/autoland/rev/522b10f1d794af696a73a2d16f7324a26420742b>

<https://hg.mozilla.org/mozilla-central/rev/522b10f1d794>

wasm: Move membarrier call to separate functions. r=nbp

<https://hg.mozilla.org/integration/autoland/rev/144424af40cd4743dacf0b6201a9a46589a446dc>

<https://hg.mozilla.org/mozilla-central/rev/144424af40cd>

Status: REOPENED → RESOLVEDClosed: 3 years ago → 2 years ago
[status-firefox105](/buglist.cgi?f1=cf_status_firefox105&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox105&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 105 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a2417706_75935)• 2 years ago |

[status-firefox103](/buglist.cgi?f1=cf_status_firefox103&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox103&o1=equals&v1=wontfix)
[status-firefox104](/buglist.cgi?f1=cf_status_firefox104&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox104&o1=equals&v1=wontfix)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected)
[status-firefox-esr91](/buglist.cgi?f1=cf_status_firefox_esr91&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr91&o1=equals&v1=wontfix)
[tracking-firefox105](/buglist.cgi?f1=cf_tracking_firefox105&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox105&o1=equals&v1=%2B)
[tracking-firefox-esr102](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=isnotempty):
--- → [105+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=105%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a2843352_1689)• 2 years ago |

Flags: sec-bounty? → sec-bounty-

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1777604#c33)• 2 years ago |
|  | |

Hi Ryan, are we feeling good about an ESR102 uplift on this now? It's baked for about a month with no known regressions.

Flags: needinfo?(rhunt)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1777604#c34)• 2 years ago |
|  | |

I think this should be okay to uplift as long as it rebases and builds cleanly. Let me know if you need help resolving conflicts.

Flags: needinfo?(rhunt)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1777604#c35)• 2 years ago |
|  | |

It grafts fine, I just need the approval request :)

Flags: needinfo?(rhunt)

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1777604#c36)• 2 years ago |
|  | |

Comment on [attachment 9286299](/attachment.cgi?id=9286299 "Bug 1777604 - wasm: Move membarrier call to separate functions. r?nbp") [[details]](/attachment.cgi?id=9286299&action=edit "Bug 1777604 - wasm: Move membarrier call to separate functions. r?nbp")

[Bug 1777604](/show_bug.cgi?id=1777604 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77") - wasm: Move membarrier call to separate functions. r?nbp

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: These patches fix a potential corner case that could result in crashes on ARM64 hardware when running WebAssembly code.
* **User impact if declined**: Slightly increased chance of crashes when using WebAssembly code.
* **Fix Landed on Version**: 105
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: These patches increase the frequency we call a clearing instruction on ARM64, but doesn't introduce a new operation. They have been in nightly for a month with no regressions identified.
Flags: needinfo?(rhunt)
[Attachment #9286299](/attachment.cgi?id=9286299&action=edit "Bug 1777604 - wasm: Move membarrier call to separate functions. r?nbp") -
Flags: approval-mozilla-esr102?

|  | [Ryan Hunt [:rhunt]](/user_profile?user_id=573202)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a5441539_573202)• 2 years ago |

[Attachment #9286298](/attachment.cgi?id=9286298&action=edit "Bug 1777604 - wasm: Perform a pipeline flush while creating a module object. r?nbp") -
Flags: approval-mozilla-esr102?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1777604#c37)• 2 years ago |
|  | |

Comment on [attachment 9286298](/attachment.cgi?id=9286298 "Bug 1777604 - wasm: Perform a pipeline flush while creating a module object. r?nbp") [[details]](/attachment.cgi?id=9286298&action=edit "Bug 1777604 - wasm: Perform a pipeline flush while creating a module object. r?nbp")

[Bug 1777604](/show_bug.cgi?id=1777604 "RESOLVED FIXED - Assertion failure: instCache_[offset] == instValue, at jit/arm64/vixl/MozCachingDecoder.h:77") - wasm: Perform a pipeline flush while creating a module object. r?nbp

Approved for 102.3esr.

[Attachment #9286298](/attachment.cgi?id=9286298&action=edit "Bug 1777604 - wasm: Perform a pipeline flush while creating a module object. r?nbp") -
Flags: approval-mozilla-esr102? → approval-mozilla-esr102+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a5500513_75935)• 2 years ago |

[Attachment #9286299](/attachment.cgi?id=9286299&action=edit "Bug 1777604 - wasm: Move membarrier call to separate functions. r?nbp") -
Flags: approval-mozilla-esr102? → approval-mozilla-esr102+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1777604#c38)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr102/rev/aa292e0b176b>

<https://hg.mozilla.org/releases/mozilla-esr102/rev/e84c033070c9>

[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a6531814_428608)• 2 years ago |

Whiteboard: [adv-main105+][adv-esr102.3+]

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1777604#c39)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9294820)
— [Details](attachment.cgi?id=9294820&action=edit)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a6976957_428608)• 2 years ago |

Alias: CVE-2022-40957

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a10967548_578488)• 2 years ago |

Flags: sec-bounty-hof+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a17308246_1689)• 2 years ago |

Group: core-security-release

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1777604#c40)• 1 year ago |
|  | |

Pushed by rhunt@eqrion.net:
<https://hg.mozilla.org/integration/autoland/rev/3ca619a5b66e>
wasm: Add test. r=nbp

|  | [Sandor Molnar[:smolnar]](/user_profile?user_id=670045) |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=1777604#c41)• 1 year ago |
| bugherder | |

<https://hg.mozilla.org/mozilla-central/rev/3ca619a5b66e>

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a56062632_132034)• 9 months ago |

Blocks: [gkw-js-fuzzing](/show_bug.cgi?id=1890610 "NEW - [meta] Gary JavaScript engine Fuzzing")

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1777604#a60469053_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1777604&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.mozilla.org_3921f6bb_20250114_223314.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-40

## Security Vulnerabilities fixed in Firefox 105

Announced
September 20, 2022
Impact
high
Products
Firefox
Fixed in

* Firefox 105

This advisory was updated December 13, 2022 to add CVE-2022-46880. This fix was included in the original release of Firefox 105, but did not appear in the advisory published at that time.

#### [#CVE-2022-3266: Out of bounds read when decoding H264](#CVE-2022-3266)

Reporter
Willy R. Vasquez at UT Austin
Impact
high
##### Description

An out-of-bounds read can occur when decoding H264 video. This results in a potentially exploitable crash.

##### References

* [Bug 1767360](https://bugzilla.mozilla.org/show_bug.cgi?id=1767360)

#### [#CVE-2022-40959: Bypassing FeaturePolicy restrictions on transient pages](#CVE-2022-40959)

Reporter
Armin Ebert
Impact
high
##### Description

During iframe navigation, certain pages did not have their FeaturePolicy fully initialized leading to a bypass that leaked device permissions into untrusted subdocuments.

##### References

* [Bug 1782211](https://bugzilla.mozilla.org/show_bug.cgi?id=1782211)

#### [#CVE-2022-40960: Data-race when parsing non-UTF-8 URLs in threads](#CVE-2022-40960)

Reporter
Armin Ebert
Impact
high
##### Description

Concurrent use of the URL parser with non-UTF-8 data was not thread-safe. This could lead to a use-after-free causing a potentially exploitable crash.

##### References

* [Bug 1787633](https://bugzilla.mozilla.org/show_bug.cgi?id=1787633)

#### [#CVE-2022-46880: Use-after-free in WebGL](#CVE-2022-46880)

Reporter
Atte Kettunen
Impact
high
##### Description

A missing check related to tex units could have led to a use-after-free and potentially exploitable crash.
*Note*: This advisory was added on December 13th, 2022 after we better understood the impact of the issue. The fix was included in the original release of Firefox 105.

##### References

* [Bug 1749292](https://bugzilla.mozilla.org/show_bug.cgi?id=1749292)

#### [#CVE-2022-40958: Bypassing Secure Context restriction for cookies with \_\_Host and \_\_Secure prefix](#CVE-2022-40958)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

By injecting a cookie with certain special characters, an attacker on a shared subdomain which is not a secure context could set and thus overwrite cookies from a secure context, leading to session fixation and other attacks.

##### References

* [Bug 1779993](https://bugzilla.mozilla.org/show_bug.cgi?id=1779993)

#### [#CVE-2022-40961: Stack-buffer overflow when initializing Graphics](#CVE-2022-40961)

Reporter
Mozilla Fuzzing Team
Impact
moderate
##### Description

During startup, a graphics driver with an unexpected name could lead to a stack-buffer overflow causing a potentially exploitable crash.
*This issue only affects Firefox for Android. Other operating systems are not affected.*

##### References

* [Bug 1784588](https://bugzilla.mozilla.org/show_bug.cgi?id=1784588)

#### [#CVE-2022-40956: Content-Security-Policy base-uri bypass](#CVE-2022-40956)

Reporter
Satoki Tsuji
Impact
low
##### Description

When injecting an HTML base element, some requests would ignore the CSP's base-uri settings and accept the injected element's base instead.

##### References

* [Bug 1770094](https://bugzilla.mozilla.org/show_bug.cgi?id=1770094)

#### [#CVE-2022-40957: Incoherent instruction cache when building WASM on ARM64](#CVE-2022-40957)

Reporter
Gary Kwong
Impact
low
##### Description

Inconsistent data in instruction and data cache when creating wasm code could lead to a potentially exploitable crash.
*This bug only affects Firefox on ARM64 platforms.*

##### References

* [Bug 1777604](https://bugzilla.mozilla.org/show_bug.cgi?id=1777604)

#### [#CVE-2022-40962: Memory safety bugs fixed in Firefox 105 and Firefox ESR 102.3](#CVE-2022-40962)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Nika Layzell, Timothy Nikkel, Sebastian Hengst, Andreas Pehrson, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 104 and Firefox ESR 102.2. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 105 and Firefox ESR 102.3](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1776655%2C1777574%2C1784835%2C1785109%2C1786502%2C1789440)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from www.mozilla.org_f0a3d189_20250114_223317.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-42

## Security Vulnerabilities fixed in Thunderbird 102.3

Announced
September 20, 2022
Impact
high
Products
Thunderbird
Fixed in

* Thunderbird 102.3

*In general, these flaws cannot be exploited through email in the Thunderbird product because scripting is disabled when reading mail, but are potentially risks in browser or browser-like contexts.*

#### [#CVE-2022-3266: Out of bounds read when decoding H264](#CVE-2022-3266)

Reporter
Willy R. Vasquez at UT Austin
Impact
high
##### Description

An out-of-bounds read can occur when decoding H264 video. This results in a potentially exploitable crash.

##### References

* [Bug 1767360](https://bugzilla.mozilla.org/show_bug.cgi?id=1767360)

#### [#CVE-2022-40959: Bypassing FeaturePolicy restrictions on transient pages](#CVE-2022-40959)

Reporter
Armin Ebert
Impact
high
##### Description

During iframe navigation, certain pages did not have their FeaturePolicy fully initialized leading to a bypass that leaked device permissions into untrusted subdocuments.

##### References

* [Bug 1782211](https://bugzilla.mozilla.org/show_bug.cgi?id=1782211)

#### [#CVE-2022-40960: Data-race when parsing non-UTF-8 URLs in threads](#CVE-2022-40960)

Reporter
Armin Ebert
Impact
high
##### Description

Concurrent use of the URL parser with non-UTF-8 data was not thread-safe. This could lead to a use-after-free causing a potentially exploitable crash.

##### References

* [Bug 1787633](https://bugzilla.mozilla.org/show_bug.cgi?id=1787633)

#### [#CVE-2022-40958: Bypassing Secure Context restriction for cookies with \_\_Host and \_\_Secure prefix](#CVE-2022-40958)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

By injecting a cookie with certain special characters, an attacker on a shared subdomain which is not a secure context could set and thus overwrite cookies from a secure context, leading to session fixation and other attacks.

##### References

* [Bug 1779993](https://bugzilla.mozilla.org/show_bug.cgi?id=1779993)

#### [#CVE-2022-40956: Content-Security-Policy base-uri bypass](#CVE-2022-40956)

Reporter
Satoki Tsuji
Impact
low
##### Description

When injecting an HTML base element, some requests would ignore the CSP's base-uri settings and accept the injected element's base instead.

##### References

* [Bug 1770094](https://bugzilla.mozilla.org/show_bug.cgi?id=1770094)

#### [#CVE-2022-40957: Incoherent instruction cache when building WASM on ARM64](#CVE-2022-40957)

Reporter
Gary Kwong
Impact
low
##### Description

Inconsistent data in instruction and data cache when creating wasm code could lead to a potentially exploitable crash.
*This bug only affects Thunderbird on ARM64 platforms.*

##### References

* [Bug 1777604](https://bugzilla.mozilla.org/show_bug.cgi?id=1777604)

#### [#CVE-2022-3155: Attachment files saved to disk on macOS could be executed without warning](#CVE-2022-3155)

Reporter
Koh M. Nakagawa
Impact
low
##### Description

When saving or opening an email attachment on macOS, Thunderbird did not set attribute com.apple.quarantine on the received file. If the received file was an application and the user attempted to open it, then the application was started immediately without asking the user to confirm.

##### References

* [Bug 1789061](https://bugzilla.mozilla.org/show_bug.cgi?id=1789061)

#### [#CVE-2022-40962: Memory safety bugs fixed in Thunderbird 102.3](#CVE-2022-40962)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Nika Layzell, Timothy Nikkel, Sebastian Hengst, Andreas Pehrson, and the Mozilla Fuzzing Team reported memory safety bugs present in Thunderbird 102.2. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Thunderbird 102.3](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1776655%2C1777574%2C1784835%2C1785109%2C1786502%2C1789440)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from www.mozilla.org_65e15361_20250114_223315.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2022-41

## Security Vulnerabilities fixed in Firefox ESR 102.3

Announced
September 20, 2022
Impact
high
Products
Firefox ESR
Fixed in

* Firefox ESR 102.3

#### [#CVE-2022-3266: Out of bounds read when decoding H264](#CVE-2022-3266)

Reporter
Willy R. Vasquez at UT Austin
Impact
high
##### Description

An out-of-bounds read can occur when decoding H264 video. This results in a potentially exploitable crash.

##### References

* [Bug 1767360](https://bugzilla.mozilla.org/show_bug.cgi?id=1767360)

#### [#CVE-2022-40959: Bypassing FeaturePolicy restrictions on transient pages](#CVE-2022-40959)

Reporter
Armin Ebert
Impact
high
##### Description

During iframe navigation, certain pages did not have their FeaturePolicy fully initialized leading to a bypass that leaked device permissions into untrusted subdocuments.

##### References

* [Bug 1782211](https://bugzilla.mozilla.org/show_bug.cgi?id=1782211)

#### [#CVE-2022-40960: Data-race when parsing non-UTF-8 URLs in threads](#CVE-2022-40960)

Reporter
Armin Ebert
Impact
high
##### Description

Concurrent use of the URL parser with non-UTF-8 data was not thread-safe. This could lead to a use-after-free causing a potentially exploitable crash.

##### References

* [Bug 1787633](https://bugzilla.mozilla.org/show_bug.cgi?id=1787633)

#### [#CVE-2022-40958: Bypassing Secure Context restriction for cookies with \_\_Host and \_\_Secure prefix](#CVE-2022-40958)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

By injecting a cookie with certain special characters, an attacker on a shared subdomain which is not a secure context could set and thus overwrite cookies from a secure context, leading to session fixation and other attacks.

##### References

* [Bug 1779993](https://bugzilla.mozilla.org/show_bug.cgi?id=1779993)

#### [#CVE-2022-40956: Content-Security-Policy base-uri bypass](#CVE-2022-40956)

Reporter
Satoki Tsuji
Impact
low
##### Description

When injecting an HTML base element, some requests would ignore the CSP's base-uri settings and accept the injected element's base instead.

##### References

* [Bug 1770094](https://bugzilla.mozilla.org/show_bug.cgi?id=1770094)

#### [#CVE-2022-40957: Incoherent instruction cache when building WASM on ARM64](#CVE-2022-40957)

Reporter
Gary Kwong
Impact
low
##### Description

Inconsistent data in instruction and data cache when creating wasm code could lead to a potentially exploitable crash.
*This bug only affects Firefox on ARM64 platforms.*

##### References

* [Bug 1777604](https://bugzilla.mozilla.org/show_bug.cgi?id=1777604)

#### [#CVE-2022-40962: Memory safety bugs fixed in Firefox 105 and Firefox ESR 102.3](#CVE-2022-40962)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Nika Layzell, Timothy Nikkel, Sebastian Hengst, Andreas Pehrson, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 104 and Firefox ESR 102.2. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 105 and Firefox ESR 102.3](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1776655%2C1777574%2C1784835%2C1785109%2C1786502%2C1789440)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)


