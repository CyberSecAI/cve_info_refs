=== Content from github.com_a1336d2f_20250115_101806.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fsecurity%2Fadvisories%2FGHSA-gwc9-348x-qwv2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fsecurity%2Fadvisories%2FGHSA-gwc9-348x-qwv2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=bytecodealliance%2Fwasmtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bytecodealliance](/bytecodealliance)
/
**[wasmtime](/bytecodealliance/wasmtime)**
Public

* [Notifications](/login?return_to=%2Fbytecodealliance%2Fwasmtime) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)
* [Star
   15.7k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)

* [Code](/bytecodealliance/wasmtime)
* [Issues
  707](/bytecodealliance/wasmtime/issues)
* [Pull requests
  79](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

Additional navigation options

* [Code](/bytecodealliance/wasmtime)
* [Issues](/bytecodealliance/wasmtime/issues)
* [Pull requests](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

# Use after free with `externref`s and epoch interruption in Wasmtime

High

[fitzgen](/fitzgen)
published
GHSA-gwc9-348x-qwv2
Mar 31, 2022

## Package

cargo

wasmtime
([Rust](/advisories?query=ecosystem%3Arust))

## Affected versions

0.34.0, 0.34.1, 0.35.0, and 0.35.1

## Patched versions

0.34.2 and 0.35.2

## Description

### Impact

There is a use after free vulnerability in Wasmtime when both running Wasm that uses `externref`s and enabling [epoch interruption](https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.epoch_interruption) in Wasmtime. If you are not explicitly enabling epoch interruption (it is disabled by default) then you are not affected. If you are explicitly disabling the Wasm reference types proposal (it is enabled by default) then you are also not affected.

The use after free is caused by Cranelift failing to emit stack maps when there are safepoints inside cold blocks. Cold blocks occur when epoch interruption is enabled. Cold blocks are emitted at the end of compiled functions, and change the order blocks are emitted versus defined. This reordering accidentally caused Cranelift to skip emitting some stack maps because it expected to emit the stack maps in block definition order, rather than block emission order. When Wasmtime would eventually collect garbage, it would fail to find live references on the stack because of the missing stack maps, think that they were unreferenced garbage, and therefore reclaim them. Then after the collection ended, the Wasm code could use the reclaimed-too-early references, which is a use after free.

This bug was discovered while extending our fuzz targets for `externref`s and GC in Wasmtime. The updated fuzz target thoroughly exercises these code paths and feature combinations now. We have also added a regression test for this bug.

### Patches

We have released versions 0.34.2 and 0.35.2, which fix the vulnerability. We recommend all Wasmtime users upgrade to these patched versions.

### Workarounds

If upgrading is not an option for you at this time, you can avoid the vulnerability by either

* [disabling the Wasm reference types proposal](https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.wasm_reference_types)

  ```
  config.wasm_reference_types(false);
  ```
* or by [disabling epoch interruption](https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.epoch_interruption) if you were previously enabling it.

  ```
  config.epoch_interruption(false);
  ```

### References

* [The WebAssembly reference types proposal, which introduces `externref`s](https://github.com/WebAssembly/reference-types)
* [Documentation about epoch interruption in Wasmtime](https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.epoch_interruption)

### For more information

If you have any questions or comments about this advisory:

* Reach out to us on [the Bytecode Alliance Zulip chat](https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime)
* Open an issue in [the `bytecodealliance/wasmtime` repository](https://github.com/bytecodealliance/wasmtime/)

### Severity

High

### CVE ID

CVE-2022-24791

### Weaknesses

[CWE-416](/advisories?query=cwe%3A416)

### Credits

* [![@cfallin](https://avatars.githubusercontent.com/u/216148?s=40&v=4)](/cfallin)
  [cfallin](/cfallin)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c2ee2b0e_20250115_101803.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F666c2554ea0e1728c35aa41178cf235920db888a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F666c2554ea0e1728c35aa41178cf235920db888a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=bytecodealliance%2Fwasmtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bytecodealliance](/bytecodealliance)
/
**[wasmtime](/bytecodealliance/wasmtime)**
Public

* [Notifications](/login?return_to=%2Fbytecodealliance%2Fwasmtime) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)
* [Star
   15.7k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)

* [Code](/bytecodealliance/wasmtime)
* [Issues
  707](/bytecodealliance/wasmtime/issues)
* [Pull requests
  79](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

Additional navigation options

* [Code](/bytecodealliance/wasmtime)
* [Issues](/bytecodealliance/wasmtime/issues)
* [Pull requests](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

## Commit

[Permalink](/bytecodealliance/wasmtime/commit/666c2554ea0e1728c35aa41178cf235920db888a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-gwc9-348x-qwv2](https://github.com/advisories/GHSA-gwc9-348x-qwv2 "GHSA-gwc9-348x-qwv2")

[Browse files](/bytecodealliance/wasmtime/tree/666c2554ea0e1728c35aa41178cf235920db888a)
Browse the repository at this point in the history

```
* Run the GC smoketest with epoch support enabled as well.

* Handle safepoints in cold blocks properly.

Currently, the way that we find safepoint slots for a given instruction
relies on the instruction index order in the safepoint list matching the
order of instruction emission.

Previous to the introduction of cold-block support, this was trivially
satisfied by sorting the safepoint list: we emit instructions 0, 1, 2,
3, 4, ..., and so if we have safepoints at instructions 1 and 4, we will
encounter them in that order.

However, cold blocks are supported by swizzling the emission order at
the last moment (to avoid having to renumber instructions partway
through the compilation pipeline), so we actually emit instructions out
of index order when cold blocks are present.

Reference-type support in Wasm in particular uses cold blocks for
slowpaths, and has live refs and safepoints in these slowpaths, so we
can reliably "skip" a safepoint (not emit any metadata for it) in the
presence of reftype usage.

This PR fixes the emission code by building a map from instruction index
to safepoint index first, then doing lookups through this map, rather
than following along in-order as it emits instructions.
```

* Loading branch information

[![@cfallin](https://avatars.githubusercontent.com/u/216148?s=40&v=4)](/cfallin)

[cfallin](/bytecodealliance/wasmtime/commits?author=cfallin "View all commits by cfallin")
authored
Mar 31, 2022

1 parent
[353f1b4](/bytecodealliance/wasmtime/commit/353f1b48ab73aab92e014b214a7770cbbf99c2ab)

commit 666c255

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**46 additions**
and
**15 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* cranelift/codegen/src/machinst

  + cranelift/codegen/src/machinst/vcode.rs
    [vcode.rs](#diff-38f8d4578f52741c32e4ff196abc6a8a89e0530fb3578b920aedb2213a1f8f53)
* tests/all

  + tests/all/funcref.rs
    [funcref.rs](#diff-62ea5698a5ba4a95f3e6c59f13948eb13a7396df08f26be84f3fb0517ea04b2c)
  + tests/all/gc.rs
    [gc.rs](#diff-6b36d002732e70a7e2c41f77a16e4c8cd355f91e69ddbe2bc2444698d8a32aa4)
  + tests/all/main.rs
    [main.rs](#diff-dca7f2074653ef47b64b122517d2c6a2c65a5d20f9393b06530620323d4411bd)

## There are no files selected for viewing

31 changes: 19 additions & 12 deletions

31
[cranelift/codegen/src/machinst/vcode.rs](#diff-38f8d4578f52741c32e4ff196abc6a8a89e0530fb3578b920aedb2213a1f8f53 "cranelift/codegen/src/machinst/vcode.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/666c2554ea0e1728c35aa41178cf235920db888a/cranelift/codegen/src/machinst/vcode.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,7 @@ |
|  |  | //! See the main module comment in `mod.rs` for more details on the VCode-based |
|  |  | //! backend pipeline. |
|  |  |  |
|  |  | use crate::fx::FxHashMap; |
|  |  | use crate::ir::{self, types, Constant, ConstantData, SourceLoc}; |
|  |  | use crate::machinst::\*; |
|  |  | use crate::settings; |
| Expand Down  Expand Up | | @@ -478,6 +479,19 @@ impl<I: VCodeInst> VCode<I> { |
|  |  | let mut inst\_end\_offsets = vec![0; self.insts.len()]; |
|  |  | let mut label\_inst\_indices = vec![0; self.num\_blocks()]; |
|  |  |  |
|  |  | // Map from instruction index to index in |
|  |  | // `safepoint\_slots`. We need this because we emit |
|  |  | // instructions out-of-order, while the safepoint\_insns / |
|  |  | // safepoint\_slots data structures are sorted in instruction |
|  |  | // order. |
|  |  | let mut safepoint\_indices: FxHashMap<u32, usize> = FxHashMap::default(); |
|  |  | for (safepoint\_idx, iix) in self.safepoint\_insns.iter().enumerate() { |
|  |  | // Disregard safepoints that ended up having no live refs. |
|  |  | if self.safepoint\_slots[safepoint\_idx].len() > 0 { |
|  |  | safepoint\_indices.insert(\*iix, safepoint\_idx); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Construct the final order we emit code in: cold blocks at the end. |
|  |  | let mut final\_order: SmallVec<[BlockIndex; 16]> = smallvec![]; |
|  |  | let mut cold\_blocks: SmallVec<[BlockIndex; 16]> = smallvec![]; |
| Expand All | | @@ -493,7 +507,6 @@ impl<I: VCodeInst> VCode<I> { |
|  |  | final\_order.extend(cold\_blocks.clone()); |
|  |  |  |
|  |  | // Emit blocks. |
|  |  | let mut safepoint\_idx = 0; |
|  |  | let mut cur\_srcloc = None; |
|  |  | let mut last\_offset = None; |
|  |  | let mut start\_of\_cold\_code = None; |
| Expand Down  Expand Up | | @@ -541,17 +554,11 @@ impl<I: VCodeInst> VCode<I> { |
|  |  | } |
|  |  | state.pre\_sourceloc(cur\_srcloc.unwrap\_or(SourceLoc::default())); |
|  |  |  |
|  |  | if safepoint\_idx < self.safepoint\_insns.len() |
|  |  | && self.safepoint\_insns[safepoint\_idx] == iix |
|  |  | { |
|  |  | if self.safepoint\_slots[safepoint\_idx].len() > 0 { |
|  |  | let stack\_map = self.abi.spillslots\_to\_stack\_map( |
|  |  | &self.safepoint\_slots[safepoint\_idx][..], |
|  |  | &state, |
|  |  | ); |
|  |  | state.pre\_safepoint(stack\_map); |
|  |  | } |
|  |  | safepoint\_idx += 1; |
|  |  | if let Some(safepoint\_idx) = safepoint\_indices.get(&iix) { |
|  |  | let stack\_map = self |
|  |  | .abi |
|  |  | .spillslots\_to\_stack\_map(&self.safepoint\_slots[\*safepoint\_idx][..], &state); |
|  |  | state.pre\_safepoint(stack\_map); |
|  |  | } |
|  |  |  |
|  |  | self.insts[iix as usize].emit(&mut buffer, &self.emit\_info, &mut state); |
| Expand Down | |  |

5 changes: 4 additions & 1 deletion

5
[tests/all/funcref.rs](#diff-62ea5698a5ba4a95f3e6c59f13948eb13a7396df08f26be84f3fb0517ea04b2c "tests/all/funcref.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/666c2554ea0e1728c35aa41178cf235920db888a/tests/all/funcref.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ use wasmtime::\*; |
|  |  | #[test] |
|  |  | fn pass\_funcref\_in\_and\_out\_of\_wasm() -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | false, |
|  |  | r#" |
|  |  | (module |
|  |  | (func (export "func") (param funcref) (result funcref) |
| Expand Down  Expand Up | | @@ -60,7 +61,8 @@ fn pass\_funcref\_in\_and\_out\_of\_wasm() -> anyhow::Result<()> { |
|  |  |  |
|  |  | // Passing in a `funcref` from another store fails. |
|  |  | { |
|  |  | let (mut other\_store, other\_module) = ref\_types\_module(r#"(module (func (export "f")))"#)?; |
|  |  | let (mut other\_store, other\_module) = |
|  |  | ref\_types\_module(false, r#"(module (func (export "f")))"#)?; |
|  |  | let other\_store\_instance = Instance::new(&mut other\_store, &other\_module, &[])?; |
|  |  | let f = other\_store\_instance |
|  |  | .get\_func(&mut other\_store, "f") |
| Expand All | | @@ -77,6 +79,7 @@ fn pass\_funcref\_in\_and\_out\_of\_wasm() -> anyhow::Result<()> { |
|  |  | #[test] |
|  |  | fn receive\_null\_funcref\_from\_wasm() -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | false, |
|  |  | r#" |
|  |  | (module |
|  |  | (func (export "get-null") (result funcref) |
| Expand Down | |  |

16 changes: 15 additions & 1 deletion

16
[tests/all/gc.rs](#diff-6b36d002732e70a7e2c41f77a16e4c8cd355f91e69ddbe2bc2444698d8a32aa4 "tests/all/gc.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/666c2554ea0e1728c35aa41178cf235920db888a/tests/all/gc.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,7 +14,17 @@ impl Drop for SetFlagOnDrop { |
|  |  |  |
|  |  | #[test] |
|  |  | fn smoke\_test\_gc() -> anyhow::Result<()> { |
|  |  | smoke\_test\_gc\_impl(false) |
|  |  | } |
|  |  |  |
|  |  | #[test] |
|  |  | fn smoke\_test\_gc\_epochs() -> anyhow::Result<()> { |
|  |  | smoke\_test\_gc\_impl(true) |
|  |  | } |
|  |  |  |
|  |  | fn smoke\_test\_gc\_impl(use\_epochs: bool) -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | use\_epochs, |
|  |  | r#" |
|  |  | (module |
|  |  | (import "" "" (func $do\_gc)) |
| Expand Down  Expand Up | | @@ -69,6 +79,7 @@ fn smoke\_test\_gc() -> anyhow::Result<()> { |
|  |  | #[test] |
|  |  | fn wasm\_dropping\_refs() -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | false, |
|  |  | r#" |
|  |  | (module |
|  |  | (func (export "drop\_ref") (param externref) |
| Expand Down  Expand Up | | @@ -145,7 +156,7 @@ fn many\_live\_refs() -> anyhow::Result<()> { |
|  |  | ", |
|  |  | ); |
|  |  |  |
|  |  | let (mut store, module) = ref\_types\_module(&wat)?; |
|  |  | let (mut store, module) = ref\_types\_module(false, &wat)?; |
|  |  |  |
|  |  | let live\_refs = Arc::new(AtomicUsize::new(0)); |
|  |  |  |
| Expand Down  Expand Up | | @@ -191,6 +202,7 @@ fn many\_live\_refs() -> anyhow::Result<()> { |
|  |  | #[test] |
|  |  | fn drop\_externref\_via\_table\_set() -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | false, |
|  |  | r#" |
|  |  | (module |
|  |  | (table $t 1 externref) |
| Expand Down  Expand Up | | @@ -400,6 +412,7 @@ fn gee\_i\_sure\_hope\_refcounting\_is\_atomic() -> anyhow::Result<()> { |
|  |  | #[test] |
|  |  | fn global\_init\_no\_leak() -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | false, |
|  |  | r#" |
|  |  | (module |
|  |  | (import "" "" (global externref)) |
| Expand All | | @@ -424,6 +437,7 @@ fn global\_init\_no\_leak() -> anyhow::Result<()> { |
|  |  | #[test] |
|  |  | fn no\_gc\_middle\_of\_args() -> anyhow::Result<()> { |
|  |  | let (mut store, module) = ref\_types\_module( |
|  |  | false, |
|  |  | r#" |
|  |  | (module |
|  |  | (import "" "return\_some" (func $return (result externref externref externref))) |
| Expand Down | |  |

9 changes: 8 additions & 1 deletion

9
[tests/all/main.rs](#diff-dca7f2074653ef47b64b122517d2c6a2c65a5d20f9393b06530620323d4411bd "tests/all/main.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/666c2554ea0e1728c35aa41178cf235920db888a/tests/all/main.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -33,6 +33,7 @@ mod wast; |
|  |  |  |
|  |  | /// A helper to compile a module in a new store with reference types enabled. |
|  |  | pub(crate) fn ref\_types\_module( |
|  |  | use\_epochs: bool, |
|  |  | source: &str, |
|  |  | ) -> anyhow::Result<(wasmtime::Store<()>, wasmtime::Module)> { |
|  |  | use wasmtime::\*; |
| Expand All | | @@ -41,9 +42,15 @@ pub(crate) fn ref\_types\_module( |
|  |  |  |
|  |  | let mut config = Config::new(); |
|  |  | config.wasm\_reference\_types(true); |
|  |  | if use\_epochs { |
|  |  | config.epoch\_interruption(true); |
|  |  | } |
|  |  |  |
|  |  | let engine = Engine::new(&config)?; |
|  |  | let store = Store::new(&engine, ()); |
|  |  | let mut store = Store::new(&engine, ()); |
|  |  | if use\_epochs { |
|  |  | store.set\_epoch\_deadline(1); |
|  |  | } |
|  |  |  |
|  |  | let module = Module::new(&engine, source)?; |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `666c255`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F666c2554ea0e1728c35aa41178cf235920db888a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


