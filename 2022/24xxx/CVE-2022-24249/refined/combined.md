=== Content from github.com_1a07055d_20250114_211741.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgpac%2Fgpac%2Fissues%2F2081)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgpac%2Fgpac%2Fissues%2F2081)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=gpac%2Fgpac)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[gpac](/gpac)
/
**[gpac](/gpac/gpac)**
Public

* [Notifications](/login?return_to=%2Fgpac%2Fgpac) You must be signed in to change notification settings
* [Fork
  539](/login?return_to=%2Fgpac%2Fgpac)
* [Star
   2.9k](/login?return_to=%2Fgpac%2Fgpac)

* [Code](/gpac/gpac)
* [Issues
  73](/gpac/gpac/issues)
* [Pull requests
  11](/gpac/gpac/pulls)
* [Actions](/gpac/gpac/actions)
* [Wiki](/gpac/gpac/wiki)
* [Security](/gpac/gpac/security)
* [Insights](/gpac/gpac/pulse)

Additional navigation options

* [Code](/gpac/gpac)
* [Issues](/gpac/gpac/issues)
* [Pull requests](/gpac/gpac/pulls)
* [Actions](/gpac/gpac/actions)
* [Wiki](/gpac/gpac/wiki)
* [Security](/gpac/gpac/security)
* [Insights](/gpac/gpac/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fgpac%2Fgpac%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fgpac%2Fgpac%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Null Pointer Dereference when dealing with XtraBox #2081

Closed

[0xdd96](/0xdd96) opened this issue
Jan 28, 2022
· 0 comments

Closed

# [Null Pointer Dereference when dealing with XtraBox](#top) #2081

[0xdd96](/0xdd96) opened this issue
Jan 28, 2022
· 0 comments

## Comments

[![@0xdd96](https://avatars.githubusercontent.com/u/24778335?s=80&v=4)](/0xdd96)

Copy link

### **[0xdd96](/0xdd96)** commented [Jan 28, 2022](#issue-1117248312)

| **version info**:  ``` MP4Box - GPAC version 1.1.0-DEV-rev1678-g92faba3-master   GPAC: https://doi.org/10.1145/1291233.1291452  GPAC Configuration: --prefix=/path_to_gpac/build --enable-debug --enable-sanitizer Features: GPAC_CONFIG_LINUX GPAC_64_BITS GPAC_HAS_IPV6 GPAC_HAS_SSL GPAC_HAS_SOCK_UN GPAC_MINIMAL_ODF GPAC_HAS_QJS GPAC_HAS_FAAD GPAC_HAS_MAD GPAC_HAS_LIBA52 GPAC_HAS_JPEG GPAC_HAS_PNG GPAC_HAS_FFMPEG GPAC_HAS_JP2 GPAC_HAS_THEORA GPAC_HAS_VORBIS GPAC_HAS_XVID GPAC_HAS_LINUX_DVB  ```  **poc**: [poc](https://github.com/dandanxu96/PoC/raw/main/gpac/gpac-xtra_box_write-null-pointer-dereference-poc) **command**: MP4Box -hint -out /dev/null $poc$ **crash**:  ``` root@d8a714203f6e:/path_to_gpac/build/bin# ./MP4Box -hint -out /dev/null poc [iso file] Unknown box type t8Aak in parent moov [iso file] Box "UNKN" is larger than container box [iso file] Box "moov" size 211 (start 20) invalid (read 2209) [iso file] Box "nmhd" (start 359) has 8 extra bytes [iso file] Unknown box type dreu in parent dinf [iso file] Box "UNKN" is larger than container box [iso file] Missing dref box in dinf [iso file] Box "dinf" size 36 (start 379) invalid (read 64) [iso file] Unknown box type url  in parent srpp [iso file] Unknown box type srpp in parent srpp [iso file] Box "UNKN" is larger than container box [iso file] Box "srpp" size 1814 (start 415) invalid (read 1854) [iso file] Unknown box type dre- in parent dinf [iso file] Box "UNKN" is larger than container box [iso file] Missing dref box in dinf [iso file] Box "dinf" size 36 (start 2229) invalid (read 64) [isom] invalid tag size in Xtra ! [isom] invalid tag size in Xtra ! [isom] not enough bytes in box Xtra: 46 left, reading 1836070003 (file isomedia/box_code_base.c, line 12754), skipping box [iso file] Box "Xtra" (start 2265) has 60 extra bytes [iso file] Unknown top-level box type 00000001 0.500 secs Interleaving utils/bitstream.c:1053:6: runtime error: null pointer passed as argument 2, which is declared to never be null  ```  Here is the trace reported by debugging. We can see that the `memcpy` function is called on line 1053 of `utils/bitstream.c`, which will copy the contents of the second parameter `data` to the buffer pointed to by the first parameter. Unfortunately, in this trace the `data` is 0 (NULL), causing the program to crash.  ``` In file: /path_to_gpac/src/utils/bitstream.c    1048                 case GF_BITSTREAM_FILE_READ:    1049                 case GF_BITSTREAM_FILE_WRITE:    1050                         if (bs->cache_write) {    1051                                 //if block fits in our write cache, write it    1052                                 if (bs->buffer_written + nbBytes < bs->cache_write_size) {  ► 1053                                       memcpy(bs->cache_write+bs->buffer_written, data, nbBytes);    1054                                         bs->buffer_written+=nbBytes;    1055                                         return nbBytes;    1056                                 }    1057                                 //otherwise flush cache and use file write    1058                                 bs_flush_write_cache(bs);  pwndbg> backtrace #0  gf_bs_write_data (bs=0x60f00000dc90, data=0x0, nbBytes=1) at utils/bitstream.c:1053 #1  0x00007ff9797a8f82 in xtra_box_write (s=0x60400000d590, bs=0x60f00000dc90) at isomedia/box_code_base.c:12814 #2  0x00007ff979816fb8 in gf_isom_box_write_listing (a=0x60400000d590, bs=0x60f00000dc90) at isomedia/box_funcs.c:1834 #3  0x00007ff979817737 in gf_isom_box_write (a=0x60400000d590, bs=0x60f00000dc90) at isomedia/box_funcs.c:1883 #4  0x00007ff9798b432c in WriteInterleaved (mw=0x7ffd2b3ab870, bs=0x60f00000dc90, drift_inter=GF_TRUE) at isomedia/isom_store.c:1963 #5  0x00007ff9798bb1ca in WriteToFile (movie=0x616000009c80, for_fragments=GF_FALSE) at isomedia/isom_store.c:2549 #6  0x00007ff9798574d1 in gf_isom_write (movie=0x616000009c80) at isomedia/isom_read.c:600 #7  0x00007ff979857a3f in gf_isom_close (movie=0x616000009c80) at isomedia/isom_read.c:624 #8  0x00000000004413cc in mp4boxMain (argc=5, argv=0x7ffd2b3b0478) at main.c:6547 #9  0x00000000004416f2 in main (argc=5, argv=0x7ffd2b3b0478) at main.c:6601 #10 0x00007ff975d2e840 in __libc_start_main (main=0x4416d2 <main>, argc=5, argv=0x7ffd2b3b0478, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7ffd2b3b0468) at ../csu/libc-start.c:291 #11 0x000000000040fd09 in _start ()  ```  I tracked the null assignment of `data` in `isomedia/box_code_base.c`. `data2` is initialized to NULL in line 12743. When the value of `prop_size` is greater than 4 ( line 12764 ), the program will allocate a memory chunk to `data2` ( line 12769 ). Otherwise, `data2` will remain NULL and will be assigned to `tag->prop_value` in line 12777.  In my crash, `prop_size` was set to 1 causing `tag->prop_value` to be NULL. The `tag` is then added to `ptr->tags` for subsequent access ( line 12779).     [gpac/src/isomedia/box\_code\_base.c](https://github.com/gpac/gpac/blob/5d68ccd1fa4a5a76cf8db31a33cfb4a2fe2bd4ad/src/isomedia/box_code_base.c#L12736-L12786)  Lines 12736 to 12786 in [5d68ccd](/gpac/gpac/commit/5d68ccd1fa4a5a76cf8db31a33cfb4a2fe2bd4ad)   |  | GF\_Err xtra\_box\_read(GF\_Box \*s, GF\_BitStream \*bs) | | --- | --- | |  | { | |  | GF\_XtraBox \*ptr = (GF\_XtraBox \*)s; | |  | while (ptr->size) { | |  | GF\_XtraTag \*tag; | |  | u32 prop\_type = 0; | |  |  | |  | char \*data=NULL, \*data2=NULL; | |  | ISOM\_DECREASE\_SIZE\_NO\_ERR(ptr, 18) | |  | s32 tag\_size = gf\_bs\_read\_u32(bs); | |  | u32 name\_size = gf\_bs\_read\_u32(bs); | |  | tag\_size -= 8; | |  |  | |  | if (name\_size >= (u32)0xFFFFFFFF) { | |  | GF\_LOG(GF\_LOG\_ERROR, GF\_LOG\_CONTAINER, ("[iso file] Invalid name\_size %lu in xtra\n", name\_size)); | |  | return GF\_ISOM\_INVALID\_FILE; | |  | } | |  |  | |  | ISOM\_DECREASE\_SIZE\_NO\_ERR(ptr, name\_size) | |  | data = gf\_malloc(sizeof(char) \* (name\_size+1)); | |  | gf\_bs\_read\_data(bs, data, name\_size); | |  | data[name\_size] = 0; | |  | tag\_size-=name\_size; | |  |  | |  | u32 flags = gf\_bs\_read\_u32(bs); | |  | u32 prop\_size = gf\_bs\_read\_u32(bs); | |  | tag\_size-=8; | |  |  | |  | if (prop\_size>4) { | |  | tag\_size-=2; | |  | prop\_type = gf\_bs\_read\_u16(bs); | |  | prop\_size -= 6; | |  | ISOM\_DECREASE\_SIZE\_NO\_ERR(ptr, prop\_size) | |  | data2 = gf\_malloc(sizeof(char) \* (prop\_size)); | |  | gf\_bs\_read\_data(bs, data2, prop\_size); | |  | tag\_size-=prop\_size; | |  | } | |  | GF\_SAFEALLOC(tag, GF\_XtraTag) | |  | tag->flags = flags; | |  | tag->name = data; | |  | tag->prop\_size = prop\_size; | |  | tag->prop\_value = data2; | |  | tag->prop\_type = prop\_type; | |  | gf\_list\_add(ptr->tags, tag); | |  |  | |  | if (tag\_size) { | |  | GF\_LOG(GF\_LOG\_WARNING, GF\_LOG\_CONTAINER, ("[isom] invalid tag size in Xtra !\n")); | |  | } | |  | } | |  | return GF\_OK; | |  | } |      When the program executes to `xtra_box_write`, it will get a `tag` from `ptr->tags` ( line 12801 ), and pass `tag->prop_value` to the second parameter of `gf_bs_write_data` ( line 12814 ), which eventually results in `data` being NULL.  Although the program judges whether `tag->prop_value` is 0 in line 12805, it does not change the execution flow of the program and the value of `tag->prop_value`.     [gpac/src/isomedia/box\_code\_base.c](https://github.com/gpac/gpac/blob/5d68ccd1fa4a5a76cf8db31a33cfb4a2fe2bd4ad/src/isomedia/box_code_base.c#L12791-L12817)  Lines 12791 to 12817 in [5d68ccd](/gpac/gpac/commit/5d68ccd1fa4a5a76cf8db31a33cfb4a2fe2bd4ad)   |  | GF\_Err xtra\_box\_write(GF\_Box \*s, GF\_BitStream \*bs) | | --- | --- | |  | { | |  | GF\_Err e; | |  | GF\_XtraBox \*ptr = (GF\_XtraBox \*)s; | |  | u32 i, count = gf\_list\_count(ptr->tags); | |  |  | |  | e = gf\_isom\_box\_write\_header(s, bs); | |  | if (e) return e; | |  |  | |  | for (i=0; i<count; i++) { | |  | GF\_XtraTag \*tag = gf\_list\_get(ptr->tags, i); | |  | u32 tag\_size = 16; | |  | u32 name\_len = tag->name ? (u32) strlen(tag->name) : 0; | |  | tag\_size += name\_len; | |  | if (tag->prop\_value) { | |  | tag\_size += 2 + tag->prop\_size; | |  | } | |  | gf\_bs\_write\_u32(bs, tag\_size); | |  | gf\_bs\_write\_u32(bs, name\_len); | |  | gf\_bs\_write\_data(bs, tag->name, name\_len); | |  | gf\_bs\_write\_u32(bs, tag->flags); | |  | gf\_bs\_write\_u32(bs, 6 + tag->prop\_size); | |  | gf\_bs\_write\_u16(bs, tag->prop\_type); | |  | gf\_bs\_write\_data(bs, tag->prop\_value, tag->prop\_size); | |  | } | |  | return GF\_OK; | |  | } |      Hope my analysis will help. |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@jeanlf](https://avatars.githubusercontent.com/u/7303785?s=40&u=ce6412ab09b4167cc0f18fd9617d6c17a5d3ce22&v=4)](/jeanlf)
[jeanlf](/jeanlf)
closed this as [completed](/gpac/gpac/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
`[71f9871](/gpac/gpac/commit/71f9871fc210e60df041b58c84572782b4849de9)`
[Jan 28, 2022](#event-5971745847)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fgpac%2Fgpac%2Fissues%2F2081)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

1 participant

[![@0xdd96](https://avatars.githubusercontent.com/u/24778335?s=52&v=4)](/0xdd96)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


