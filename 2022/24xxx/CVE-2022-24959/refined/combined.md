=== Content from cdn.kernel.org_bdd06401_20250114_220031.html ===
commit 92b4b5943ca68e4849f809e4a14b3168aba3fe4d
Author: Greg Kroah-Hartman
Date: Tue Feb 1 17:29:20 2022 +0100
Linux 5.16.5
Link: https://lore.kernel.org/r/20220131105233.561926043@linuxfoundation.org
Tested-by: Jon Hunter
Tested-by: Linux Kernel Functional Testing
Tested-by: Ronald Warsow
Tested-by: Shuah Khan
Tested-by: Florian Fainelli
Tested-by: Zan Aziz
Tested-by: Guenter Roeck
Tested-by: Ron Economos
Tested-By: Scott Bruce
Tested-by: Bagas Sanjaya
Tested-by: Rudi Heitbaum
Signed-off-by: Greg Kroah-Hartman
commit 36c3017551dbeecbbc1dafe7a56cf07e7a159972
Author: Geert Uytterhoeven
Date: Mon Nov 22 14:21:38 2021 +0100
mtd: rawnand: mpc5121: Remove unused variable in ads5121\_select\_chip()
commit 33a0da68fb073360d36ce1a0e852f75fede7c21e upstream.
drivers/mtd/nand/raw/mpc5121\_nfc.c: In function ‘ads5121\_select\_chip’:
drivers/mtd/nand/raw/mpc5121\_nfc.c:294:19: warning: unused variable ‘mtd’ [-Wunused-variable]
294 | struct mtd\_info \*mtd = nand\_to\_mtd(nand);
| ^~~
Fixes: 758b56f58b66bebc ("mtd: rawnand: Pass a nand\_chip object to chip->select\_chip()")
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20211122132138.3899138-1-geert@linux-m68k.org
Cc: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
commit 941d5180c430ce5b0f7a3622ef9b76077bfa3d82
Author: OGAWA Hirofumi
Date: Sun Jan 9 18:36:43 2022 +0900
block: Fix wrong offset in bio\_truncate()
commit 3ee859e384d453d6ac68bfd5971f630d9fa46ad3 upstream.
bio\_truncate() clears the buffer outside of last block of bdev, however
current bio\_truncate() is using the wrong offset of page. So it can
return the uninitialized data.
This happened when both of truncated/corrupted FS and userspace (via
bdev) are trying to read the last of bdev.
Reported-by: syzbot+ac94ae5f68b84197f41c@syzkaller.appspotmail.com
Signed-off-by: OGAWA Hirofumi
Reviewed-by: Ming Lei
Link: https://lore.kernel.org/r/875yqt1c9g.fsf@mail.parknet.co.jp
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit b8d19063e700c20d91821c4c827cd6c51a6baebb
Author: Vitaly Kuznetsov
Date: Wed Jan 12 18:01:34 2022 +0100
KVM: nVMX: Allow VMREAD when Enlightened VMCS is in use
commit 6cbbaab60ff33f59355492c241318046befd9ffc upstream.
Hyper-V TLFS explicitly forbids VMREAD and VMWRITE instructions when
Enlightened VMCS interface is in use:
"Any VMREAD or VMWRITE instructions while an enlightened VMCS is
active is unsupported and can result in unexpected behavior.""
Windows 11 + WSL2 seems to ignore this, attempts to VMREAD VMCS field
0x4404 ("VM-exit interruption information") are observed. Failing
these attempts with nested\_vmx\_failInvalid() makes such guests
unbootable.
Microsoft confirms this is a Hyper-V bug and claims that it'll get fixed
eventually but for the time being we need a workaround. (Temporary) allow
VMREAD to get data from the currently loaded Enlightened VMCS.
Note: VMWRITE instructions remain forbidden, it is not clear how to
handle them properly and hopefully won't ever be needed.
Reviewed-by: Sean Christopherson
Signed-off-by: Vitaly Kuznetsov
Message-Id: <20220112170134.1904308-6-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 01a15e36b1fb209a0cd589a1ce007e11776b640b
Author: Vitaly Kuznetsov
Date: Wed Jan 12 18:01:33 2022 +0100
KVM: nVMX: Implement evmcs\_field\_offset() suitable for handle\_vmread()
commit 892a42c10ddb945d3a4dcf07dccdf9cb98b21548 upstream.
In preparation to allowing reads from Enlightened VMCS from
handle\_vmread(), implement evmcs\_field\_offset() to get the correct
read offset. get\_evmcs\_offset(), which is being used by KVM-on-Hyper-V,
is almost what's needed but a few things need to be adjusted. First,
WARN\_ON() is unacceptable for handle\_vmread() as any field can (in
theory) be supplied by the guest and not all fields are defined in
eVMCS v1. Second, we need to handle 'holes' in eVMCS (missing fields).
It also sounds like a good idea to WARN\_ON() if such fields are ever
accessed by KVM-on-Hyper-V.
Implement dedicated evmcs\_field\_offset() helper.
No functional change intended.
Signed-off-by: Vitaly Kuznetsov
Message-Id: <20220112170134.1904308-5-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit ea30a90df837a3442f15e6b171fba390674227fe
Author: Vitaly Kuznetsov
Date: Wed Jan 12 18:01:32 2022 +0100
KVM: nVMX: Rename vmcs\_to\_field\_offset{,\_table}
commit 2423a4c0d17418eca1ba1e3f48684cb2ab7523d5 upstream.
vmcs\_to\_field\_offset{,\_table} may sound misleading as VMCS is an opaque
blob which is not supposed to be accessed directly. In fact,
vmcs\_to\_field\_offset{,\_table} are related to KVM defined VMCS12 structure.
Rename vmcs\_field\_to\_offset() to get\_vmcs12\_field\_offset() for clarity.
No functional change intended.
Reviewed-by: Sean Christopherson
Signed-off-by: Vitaly Kuznetsov
Message-Id: <20220112170134.1904308-4-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit d9ee5d1f377b3671036d78ec3608c8ceb632c9d2
Author: Maor Gottlieb
Date: Sat Jan 29 13:41:07 2022 -0800
tools/testing/scatterlist: add missing defines
[ Upstream commit 0226bd64da52aa23120d1450c37a424387827a21 ]
The cited commits replaced preemptible with pagefault\_disabled and
flush\_kernel\_dcache\_page with flush\_dcache\_page respectively, hence need
to update the corresponding defines in the test.
scatterlist.c: In function ‘sg\_miter\_stop’:
scatterlist.c:919:4: warning: implicit declaration of function ‘flush\_dcache\_page’ [-Wimplicit-function-declaration]
flush\_dcache\_page(miter->page);
^~~~~~~~~~~~~~~~~
In file included from linux/scatterlist.h:8:0,
from scatterlist.c:9:
scatterlist.c:922:18: warning: implicit declaration of function ‘pagefault\_disabled’ [-Wimplicit-function-declaration]
WARN\_ON\_ONCE(!pagefault\_disabled());
^
linux/mm.h:23:25: note: in definition of macro ‘WARN\_ON\_ONCE’
int \_\_ret\_warn\_on = !!(condition); \
^~~~~~~~~
Link: https://lkml.kernel.org/r/20220118082105.1737320-1-maorg@nvidia.com
Fixes: 723aca208516 ("mm/scatterlist: replace the !preemptible warning in sg\_miter\_stop()")
Fixes: 0e84f5dbf8d6 ("scatterlist: replace flush\_kernel\_dcache\_page with flush\_dcache\_page")
Signed-off-by: Maor Gottlieb
Tested-by: Sebastian Andrzej Siewior
Cc: Thomas Gleixner
Cc: Christoph Hellwig
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit e35b0264f706fb9e05191485ce50bc9b79eb52a7
Author: Dmitry V. Levin
Date: Mon Jan 3 04:24:02 2022 +0300
usr/include/Makefile: add linux/nfc.h to the compile-test coverage
commit 10756dc5b02bff370ddd351d7744bc99ada659c2 upstream.
As linux/nfc.h userspace compilation was finally fixed by commits
79b69a83705e ("nfc: uapi: use kernel size\_t to fix user-space builds")
and 7175f02c4e5f ("uapi: fix linux/nfc.h userspace compilation errors"),
there is no need to keep the compile-test exception for it in
usr/include/Makefile.
Signed-off-by: Dmitry V. Levin
Signed-off-by: Masahiro Yamada
Signed-off-by: Greg Kroah-Hartman
commit b7a266a79ec5467dbf7fddffb0da5c8c06d2db75
Author: Robert Hancock
Date: Thu Jan 27 16:15:00 2022 -0600
usb: dwc3: xilinx: fix uninitialized return value
commit b470947c3672f7eb7c4c271d510383d896831cc2 upstream.
A previous patch to skip part of the initialization when a USB3 PHY was
not present could result in the return value being uninitialized in that
case, causing spurious probe failures. Initialize ret to 0 to avoid this.
Fixes: 9678f3361afc ("usb: dwc3: xilinx: Skip resets and USB3 register settings for USB2.0 mode")
Cc:
Reviewed-by: Nathan Chancellor
Signed-off-by: Robert Hancock
Link: https://lore.kernel.org/r/20220127221500.177021-1-robert.hancock@calian.com
Signed-off-by: Greg Kroah-Hartman
commit fea51b4799141ea3ec827a087ae4331bd1406e2d
Author: Suren Baghdasaryan
Date: Sat Jan 29 13:41:20 2022 -0800
psi: fix "defined but not used" warnings when CONFIG\_PROC\_FS=n
commit 44585f7bc0cb01095bc2ad4258049c02bbad21ef upstream.
When CONFIG\_PROC\_FS is disabled psi code generates the following
warnings:
kernel/sched/psi.c:1364:30: warning: 'psi\_cpu\_proc\_ops' defined but not used [-Wunused-const-variable=]
1364 | static const struct proc\_ops psi\_cpu\_proc\_ops = {
| ^~~~~~~~~~~~~~~~
kernel/sched/psi.c:1355:30: warning: 'psi\_memory\_proc\_ops' defined but not used [-Wunused-const-variable=]
1355 | static const struct proc\_ops psi\_memory\_proc\_ops = {
| ^~~~~~~~~~~~~~~~~~~
kernel/sched/psi.c:1346:30: warning: 'psi\_io\_proc\_ops' defined but not used [-Wunused-const-variable=]
1346 | static const struct proc\_ops psi\_io\_proc\_ops = {
| ^~~~~~~~~~~~~~~
Make definitions of these structures and related functions conditional
on CONFIG\_PROC\_FS config.
Link: https://lkml.kernel.org/r/20220119223940.787748-3-surenb@google.com
Fixes: 0e94682b73bf ("psi: introduce psi monitor")
Signed-off-by: Suren Baghdasaryan
Reported-by: kernel test robot
Acked-by: Johannes Weiner
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit fb5b2f46f15e7c7c240de5c4a3c1fa822e5acb47
Author: Suren Baghdasaryan
Date: Sat Jan 29 13:41:17 2022 -0800
psi: fix "no previous prototype" warnings when CONFIG\_CGROUPS=n
commit 51e50fbd3efc6064c30ed73a5e009018b36e290a upstream.
When CONFIG\_CGROUPS is disabled psi code generates the following
warnings:
kernel/sched/psi.c:1112:21: warning: no previous prototype for 'psi\_trigger\_create' [-Wmissing-prototypes]
1112 | struct psi\_trigger \*psi\_trigger\_create(struct psi\_group \*group,
| ^~~~~~~~~~~~~~~~~~
kernel/sched/psi.c:1182:6: warning: no previous prototype for 'psi\_trigger\_destroy' [-Wmissing-prototypes]
1182 | void psi\_trigger\_destroy(struct psi\_trigger \*t)
| ^~~~~~~~~~~~~~~~~~~
kernel/sched/psi.c:1249:10: warning: no previous prototype for 'psi\_trigger\_poll' [-Wmissing-prototypes]
1249 | \_\_poll\_t psi\_trigger\_poll(void \*\*trigger\_ptr,
| ^~~~~~~~~~~~~~~~
Change the declarations of these functions in the header to provide the
prototypes even when they are unused.
Link: https://lkml.kernel.org/r/20220119223940.787748-2-surenb@google.com
Fixes: 0e94682b73bf ("psi: introduce psi monitor")
Signed-off-by: Suren Baghdasaryan
Reported-by: kernel test robot
Acked-by: Johannes Weiner
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit bbfe488a622a64d74fec76bdd47f7571f5e537d3
Author: Namhyung Kim
Date: Mon Jan 24 11:58:08 2022 -0800
perf/core: Fix cgroup event list management
commit c5de60cd622a2607c043ba65e25a6e9998a369f9 upstream.
The active cgroup events are managed in the per-cpu cgrp\_cpuctx\_list.
This list is only accessed from current cpu and not protected by any
locks. But from the commit ef54c1a476ae ("perf: Rework
perf\_event\_exit\_event()"), it's possible to access (actually modify)
the list from another cpu.
In the perf\_remove\_from\_context(), it can remove an event from the
context without an IPI when the context is not active. This is not
safe with cgroup events which can have some active events in the
context even if ctx->is\_active is 0 at the moment. The target cpu
might be in the middle of list iteration at the same time.
If the event is enabled when it's about to be closed, it might call
perf\_cgroup\_event\_disable() and list\_del() with the cgrp\_cpuctx\_list
on a different cpu.
This resulted in a crash due to an invalid list pointer access during
the cgroup list traversal on the cpu which the event belongs to.
Let's fallback to IPI to access the cgrp\_cpuctx\_list from that cpu.
Similarly, perf\_install\_in\_context() should use IPI for the cgroup
events too.
Fixes: ef54c1a476ae ("perf: Rework perf\_event\_exit\_event()")
Signed-off-by: Namhyung Kim
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/20220124195808.2252071-1-namhyung@kernel.org
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit e2a9068e95cca944ce3c109e10c852b853549474
Author: Sergio Paracuellos
Date: Mon Jan 24 12:30:03 2022 +0100
PCI: mt7621: Remove unused function pcie\_rmw()
commit c035366d9c9fe48d947ee6c43465ab43d42e20f2 upstream.
Function pcie\_rmw() is not being used at all and can be deleted. Hence get
rid of it, which fixes this warning:
drivers/pci/controller/pcie-mt7621.c:112:20: warning: unused function 'pcie\_rmw' [-Wunused-function]
Fixes: 2bdd5238e756 ("PCI: mt7621: Add MediaTek MT7621 PCIe host controller driver")
Link: https://lore.kernel.org/r/20220124113003.406224-3-sergio.paracuellos@gmail.com
Link: https://lore.kernel.org/all/202201241754.igtHzgHv-lkp@intel.com/
Reported-by: kernel test robot
Signed-off-by: Sergio Paracuellos
Signed-off-by: Bjorn Helgaas
Signed-off-by: Greg Kroah-Hartman
commit 974a83241e211680017ff794dc40b29dad33d4fc
Author: Marc Kleine-Budde
Date: Fri Jan 14 18:47:41 2022 +0100
dt-bindings: can: tcan4x5x: fix mram-cfg RX FIFO config
commit 17a30422621c0e04cb6060d20d7edcefd7463347 upstream.
This tcan4x5x only comes with 2K of MRAM, a RX FIFO with a dept of 32
doesn't fit into the MRAM. Use a depth of 16 instead.
Fixes: 4edd396a1911 ("dt-bindings: can: tcan4x5x: Add DT bindings for TCAN4x5X driver")
Link: https://lore.kernel.org/all/20220119062951.2939851-1-mkl@pengutronix.de
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 087b892441aedfda7400bd3d3af3193a23d01af3
Author: Sander Vanheule
Date: Sun Jan 9 15:54:33 2022 +0100
irqchip/realtek-rtl: Fix off-by-one in routing
commit 91351b5dd0fd494eb2d85e1bb6aca77b067447e0 upstream.
There is an offset between routing values (1..6) and the connected MIPS
CPU interrupts (2..7), but no distinction was made between these two
values.
This issue was previously hidden during testing, because an interrupt
mapping was used where for each required interrupt another (unused)
routing was configured, with an offset of +1.
Offset the CPU IRQ numbers by -1 to retrieve the correct routing value.
Fixes: 9f3a0f34b84a ("irqchip: Add support for Realtek RTL838x/RTL839x interrupt controller")
Signed-off-by: Sander Vanheule
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/177b920aa8d8610615692d0e657e509f363c85ca.1641739718.git.sander@svanheule.net
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit bc9de85a9e2dc6b2e1ef57652e895ca0c09a9b9e
Author: Sander Vanheule
Date: Sun Jan 9 15:54:32 2022 +0100
irqchip/realtek-rtl: Map control data to virq
commit 291e79c7e2eb6fdc016453597b78482e06199d0f upstream.
The driver assigned the irqchip and irq handler to the hardware irq,
instead of the virq. This is incorrect, and only worked because these
irq numbers happened to be the same on the devices used for testing the
original driver.
Fixes: 9f3a0f34b84a ("irqchip: Add support for Realtek RTL838x/RTL839x interrupt controller")
Signed-off-by: Sander Vanheule
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/4b4936606480265db47df152f00bc2ed46340599.1641739718.git.sander@svanheule.net
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 14be8d448fca6fe7b2a413831eedd55aef6c6511
Author: Tim Yi
Date: Thu Jan 27 15:49:53 2022 +0800
net: bridge: vlan: fix memory leak in \_\_allowed\_ingress
[ Upstream commit fd20d9738395cf8e27d0a17eba34169699fccdff ]
When using per-vlan state, if vlan snooping and stats are disabled,
untagged or priority-tagged ingress frame will go to check pvid state.
If the port state is forwarding and the pvid state is not
learning/forwarding, untagged or priority-tagged frame will be dropped
but skb memory is not freed.
Should free skb when \_\_allowed\_ingress returns false.
Fixes: a580c76d534c ("net: bridge: vlan: add per-vlan state")
Signed-off-by: Tim Yi
Acked-by: Nikolay Aleksandrov
Link: https://lore.kernel.org/r/20220127074953.12632-1-tim.yi@pica8.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 64e59e5f55532c672b9d0598d7081c6ff9fbc90e
Author: Eric Dumazet
Date: Wed Jan 26 17:34:04 2022 -0800
ipv4: remove sparse error in ip\_neigh\_gw4()
[ Upstream commit 3c42b2019863b327caa233072c50739d4144dd16 ]
./include/net/route.h:373:48: warning: incorrect type in argument 2 (different base types)
./include/net/route.h:373:48: expected unsigned int [usertype] key
./include/net/route.h:373:48: got restricted \_\_be32 [usertype] daddr
Fixes: 5c9f7c1dfc2e ("ipv4: Add helpers for neigh lookup for nexthop")
Signed-off-by: Eric Dumazet
Reviewed-by: David Ahern
Link: https://lore.kernel.org/r/20220127013404.1279313-1-eric.dumazet@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit d14713b68adb9c85fe32571bc3fecd01cc5b9057
Author: Eric Dumazet
Date: Wed Jan 26 17:10:21 2022 -0800
ipv4: tcp: send zero IPID in SYNACK messages
[ Upstream commit 970a5a3ea86da637471d3cd04d513a0755aba4bf ]
In commit 431280eebed9 ("ipv4: tcp: send zero IPID for RST and
ACK sent in SYN-RECV and TIME-WAIT state") we took care of some
ctl packets sent by TCP.
It turns out we need to use a similar strategy for SYNACK packets.
By default, they carry IP\_DF and IPID==0, but there are ways
to ask them to use the hashed IP ident generator and thus
be used to build off-path attacks.
(Ref: Off-Path TCP Exploits of the Mixed IPID Assignment)
One of this way is to force (before listener is started)
echo 1 >/proc/sys/net/ipv4/ip\_no\_pmtu\_disc
Another way is using forged ICMP ICMP\_FRAG\_NEEDED
with a very small MTU (like 68) to force a false return from
ip\_dont\_fragment()
In this patch, ip\_build\_and\_send\_pkt() uses the following
heuristics.
1) Most SYNACK packets are smaller than IPV4\_MIN\_MTU and therefore
can use IP\_DF regardless of the listener or route pmtu setting.
2) In case the SYNACK packet is bigger than IPV4\_MIN\_MTU,
we use prandom\_u32() generator instead of the IPv4 hashed ident one.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Reported-by: Ray Che
Reviewed-by: David Ahern
Cc: Geoff Alexander
Cc: Willy Tarreau
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9543145c93d89a1a83d339e2deb50b4b861ac796
Author: Eric Dumazet
Date: Wed Jan 26 16:51:16 2022 -0800
ipv4: raw: lock the socket in raw\_bind()
[ Upstream commit 153a0d187e767c68733b8e9f46218eb1f41ab902 ]
For some reason, raw\_bind() forgot to lock the socket.
BUG: KCSAN: data-race in \_\_ip4\_datagram\_connect / raw\_bind
write to 0xffff8881170d4308 of 4 bytes by task 5466 on cpu 0:
raw\_bind+0x1b0/0x250 net/ipv4/raw.c:739
inet\_bind+0x56/0xa0 net/ipv4/af\_inet.c:443
\_\_sys\_bind+0x14b/0x1b0 net/socket.c:1697
\_\_do\_sys\_bind net/socket.c:1708 [inline]
\_\_se\_sys\_bind net/socket.c:1706 [inline]
\_\_x64\_sys\_bind+0x3d/0x50 net/socket.c:1706
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
read to 0xffff8881170d4308 of 4 bytes by task 5468 on cpu 1:
\_\_ip4\_datagram\_connect+0xb7/0x7b0 net/ipv4/datagram.c:39
ip4\_datagram\_connect+0x2a/0x40 net/ipv4/datagram.c:89
inet\_dgram\_connect+0x107/0x190 net/ipv4/af\_inet.c:576
\_\_sys\_connect\_file net/socket.c:1900 [inline]
\_\_sys\_connect+0x197/0x1b0 net/socket.c:1917
\_\_do\_sys\_connect net/socket.c:1927 [inline]
\_\_se\_sys\_connect net/socket.c:1924 [inline]
\_\_x64\_sys\_connect+0x3d/0x50 net/socket.c:1924
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
value changed: 0x00000000 -> 0x0003007f
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 5468 Comm: syz-executor.5 Not tainted 5.17.0-rc1-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a91b51d5b85da05e21ba68631f4093104b4c97ed
Author: Nikolay Aleksandrov
Date: Wed Jan 26 15:10:25 2022 +0200
net: bridge: vlan: fix single net device option dumping
[ Upstream commit dcb2c5c6ca9b9177f04abaf76e5a983d177c9414 ]
When dumping vlan options for a single net device we send the same
entries infinitely because user-space expects a 0 return at the end but
we keep returning skb->len and restarting the dump on retry. Fix it by
returning the value from br\_vlan\_dump\_dev() if it completed or there was
an error. The only case that must return skb->len is when the dump was
incomplete and needs to continue (-EMSGSIZE).
Reported-by: Benjamin Poirier
Fixes: 8dcea187088b ("net: bridge: vlan: add rtm definitions and dump support")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8d6f16130aadc4f5e9334ef1cd6aef0a4ec6db11
Author: Guillaume Nault
Date: Wed Jan 26 16:38:52 2022 +0100
Revert "ipv6: Honor all IPv6 PIO Valid Lifetime values"
[ Upstream commit 36268983e90316b37000a005642af42234dabb36 ]
This reverts commit b75326c201242de9495ff98e5d5cff41d7fc0d9d.
This commit breaks Linux compatibility with USGv6 tests. The RFC this
commit was based on is actually an expired draft: no published RFC
currently allows the new behaviour it introduced.
Without full IETF endorsement, the flash renumbering scenario this
patch was supposed to enable is never going to work, as other IPv6
equipements on the same LAN will keep the 2 hours limit.
Fixes: b75326c20124 ("ipv6: Honor all IPv6 PIO Valid Lifetime values")
Signed-off-by: Guillaume Nault
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7811229f02b1ddee56b45faffbb6c54963587e80
Author: Catherine Sullivan
Date: Tue Jan 25 16:38:43 2022 -0800
gve: Fix GFP flags when allocing pages
[ Upstream commit a92f7a6feeb3884c69c1c7c1f13bccecb2228ad0 ]
Use GFP\_ATOMIC when allocating pages out of the hotpath,
continue to use GFP\_KERNEL when allocating pages during setup.
GFP\_KERNEL will allow blocking which allows it to succeed
more often in a low memory enviornment but in the hotpath we do
not want to allow the allocation to block.
Fixes: f5cedc84a30d2 ("gve: Add transmit and receive support")
Signed-off-by: Catherine Sullivan
Signed-off-by: David Awogbemila
Link: https://lore.kernel.org/r/20220126003843.3584521-1-awogbemila@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 4305a3bf6efc7b96e2b638b9ea258c6ab903fcc7
Author: Xiubo Li
Date: Wed Jan 12 12:29:04 2022 +0800
ceph: put the requests/sessions when it fails to alloc memory
[ Upstream commit 89d43d0551a848e70e63d9ba11534aaeabc82443 ]
When failing to allocate the sessions memory we should make sure
the req1 and req2 and the sessions get put. And also in case the
max\_sessions decreased so when kreallocate the new memory some
sessions maybe missed being put.
And if the max\_sessions is 0 krealloc will return ZERO\_SIZE\_PTR,
which will lead to a distinct access fault.
URL: https://tracker.ceph.com/issues/53819
Fixes: e1a4541ec0b9 ("ceph: flush the mdlog before waiting on unsafe reqs")
Signed-off-by: Xiubo Li
Reviewed-by: Venky Shankar
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Sasha Levin
commit b3ae9767c7e1590ef4a0b3ae48fe9239039ac614
Author: Sean Christopherson
Date: Tue Jan 25 22:17:25 2022 +0000
KVM: selftests: Don't skip L2's VMCALL in SMM test for SVM guest
[ Upstream commit 4cf3d3ebe8794c449af3e0e8c1d790c97e461d20 ]
Don't skip the vmcall() in l2\_guest\_code() prior to re-entering L2, doing
so will result in L2 running to completion, popping '0' off the stack for
RET, jumping to address '0', and ultimately dying with a triple fault
shutdown.
It's not at all obvious why the test re-enters L2 and re-executes VMCALL,
but presumably it serves a purpose. The VMX path doesn't skip vmcall(),
and the test can't possibly have passed on SVM, so just do what VMX does.
Fixes: d951b2210c1a ("KVM: selftests: smm\_test: Test SMM enter from L2")
Cc: Maxim Levitsky
Signed-off-by: Sean Christopherson
Message-Id: <20220125221725.2101126-1-seanjc@google.com>
Reviewed-by: Vitaly Kuznetsov
Tested-by: Vitaly Kuznetsov
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 75ad6eb6481608deb9997b7260077d6392163164
Author: Dave Airlie
Date: Thu Jan 20 14:05:27 2022 +1000
Revert "drm/ast: Support 1600x900 with 108MHz PCLK"
[ Upstream commit 76cea3d95513fe40000d06a3719c4bb6b53275e2 ]
This reverts commit 9bb7b689274b67ecb3641e399e76f84adc627df1.
This caused a regression reported to Red Hat.
Fixes: 9bb7b689274b ("drm/ast: Support 1600x900 with 108MHz PCLK")
Signed-off-by: Dave Airlie
Signed-off-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20220120040527.552068-1-airlied@gmail.com
Signed-off-by: Sasha Levin
commit 42986f43685a9ca19b5cbed0d0a4ee591cf08f75
Author: Maxim Mikityanskiy
Date: Tue Jan 25 12:06:54 2022 +0200
sch\_htb: Fail on unsupported parameters when offload is requested
[ Upstream commit 429c3be8a5e2695b5b92a6a12361eb89eb185495 ]
The current implementation of HTB offload doesn't support some
parameters. Instead of ignoring them, actively return the EINVAL error
when they are set to non-defaults.
As this patch goes to stable, the driver API is not changed here. If
future drivers support more offload parameters, the checks can be moved
to the driver side.
Note that the buffer and cbuffer parameters are also not supported, but
the tc userspace tool assigns some default values derived from rate and
ceil, and identifying these defaults in sch\_htb would be unreliable, so
they are still ignored.
Fixes: d03b195b5aa0 ("sch\_htb: Hierarchical QoS hardware offload")
Reported-by: Jakub Kicinski
Signed-off-by: Maxim Mikityanskiy
Reviewed-by: Tariq Toukan
Link: https://lore.kernel.org/r/20220125100654.424570-1-maximmi@nvidia.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit a7fce09f160e21f82906ec1effe6105541855d72
Author: David Matlack
Date: Thu Jan 20 00:38:26 2022 +0000
KVM: selftests: Re-enable access\_tracking\_perf\_test
[ Upstream commit de1956f48543e90f94b1194395f33140898b39b2 ]
This selftest was accidentally removed by commit 6a58150859fd
("selftest: KVM: Add intra host migration tests"). Add it back.
Fixes: 6a58150859fd ("selftest: KVM: Add intra host migration tests")
Signed-off-by: David Matlack
Message-Id: <20220120003826.2805036-1-dmatlack@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit dc66881387e6f761b16adb5e67735d00d63cb4fc
Author: Yufeng Mo
Date: Tue Jan 25 15:03:12 2022 +0800
net: hns3: handle empty unknown interrupt for VF
[ Upstream commit 2f61353cd2f789a4229b6f5c1c24a40a613357bb ]
Since some interrupt states may be cleared by hardware, the driver
may receive an empty interrupt. Currently, the VF driver directly
disables the vector0 interrupt in this case. As a result, the VF
is unavailable. Therefore, the vector0 interrupt should be enabled
in this case.
Fixes: b90fcc5bd904 ("net: hns3: add reset handling for VF when doing Core/Global/IMP reset")
Signed-off-by: Yufeng Mo
Signed-off-by: Guangbin Huang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e41ea0ebf87e204e0723c2d091fadbe407fd7ee3
Author: Toke Høiland-Jørgensen
Date: Mon Jan 24 15:35:29 2022 +0100
net: cpsw: Properly initialise struct page\_pool\_params
[ Upstream commit c63003e3d99761afb280add3b30de1cf30fa522b ]
The cpsw driver didn't properly initialise the struct page\_pool\_params
before calling page\_pool\_create(), which leads to crashes after the struct
has been expanded with new parameters.
The second Fixes tag below is where the buggy code was introduced, but
because the code was moved around this patch will only apply on top of the
commit in the first Fixes tag.
Fixes: c5013ac1dd0e ("net: ethernet: ti: cpsw: move set of common functions in cpsw\_priv")
Fixes: 9ed4050c0d75 ("net: ethernet: ti: cpsw: add XDP support")
Reported-by: Colin Foster
Signed-off-by: Toke Høiland-Jørgensen
Tested-by: Colin Foster
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit deb0f02d08276d87212c1f19d9d919b13dc4c033
Author: Hangyu Hua
Date: Mon Jan 24 11:29:54 2022 +0800
yam: fix a memory leak in yam\_siocdevprivate()
[ Upstream commit 29eb31542787e1019208a2e1047bb7c76c069536 ]
ym needs to be free when ym->cmd != SIOCYAMSMCS.
Fixes: 0781168e23a2 ("yam: fix a missing-check bug")
Signed-off-by: Hangyu Hua
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 36f9629b96082c3a1fb845bc45e6ba41e1d46746
Author: Rob Clark
Date: Thu Jan 13 08:32:13 2022 -0800
drm/msm/a6xx: Add missing suspend\_count increment
[ Upstream commit 860a7b2a87b7c743154824d0597b6c3eb3b53154 ]
Reported-by: Danylo Piliaiev
Fixes: 3ab1c5cc3939 ("drm/msm: Add param for userspace to query suspend count")
Signed-off-by: Rob Clark
Reviewed-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20220113163215.215367-1-robdclark@gmail.com
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Sasha Levin
commit 1ebc18836d5df09061657f8c548e594cbb519476
Author: José Expósito
Date: Sun Jan 9 20:24:31 2022 +0100
drm/msm/dpu: invalid parameter check in dpu\_setup\_dspp\_pcc
[ Upstream commit 170b22234d5495f5e0844246e23f004639ee89ba ]
The function performs a check on the "ctx" input parameter, however, it
is used before the check.
Initialize the "base" variable after the sanity check to avoid a
possible NULL pointer dereference.
Fixes: 4259ff7ae509e ("drm/msm/dpu: add support for pcc color block in dpu driver")
Addresses-Coverity-ID: 1493866 ("Null pointer dereference")
Signed-off-by: José Expósito
Link: https://lore.kernel.org/r/20220109192431.135949-1-jose.exposito89@gmail.com
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Sasha Levin
commit 502fc7dd748643d0d75577687fa07f4812ba3061
Author: Miaoqian Lin
Date: Fri Jan 7 08:50:22 2022 +0000
drm/msm/hdmi: Fix missing put\_device() call in msm\_hdmi\_get\_phy
[ Upstream commit 774fe0cd838d1b1419d41ab4ea0613c80d4ecbd7 ]
The reference taken by 'of\_find\_device\_by\_node()' must be released when
not needed anymore.
Add the corresponding 'put\_device()' in the error handling path.
Fixes: e00012b256d4 ("drm/msm/hdmi: Make HDMI core get its PHY")
Signed-off-by: Miaoqian Lin
Reviewed-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20220107085026.23831-1-linmq006@gmail.com
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Sasha Levin
commit cfb7d12f2e4a4d694f49e9b4ebb352f7b67cdfbb
Author: Guenter Roeck
Date: Sun Jan 23 18:23:22 2022 -0800
hwmon: (nct6775) Fix crash in clear\_caseopen
[ Upstream commit 79da533d3cc717ccc05ddbd3190da8a72bc2408b ]
Paweł Marciniak reports the following crash, observed when clearing
the chassis intrusion alarm.
BUG: kernel NULL pointer dereference, address: 0000000000000028
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 3 PID: 4815 Comm: bash Tainted: G S 5.16.2-200.fc35.x86\_64 #1
Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z97 Extreme4, BIOS P2.60A 05/03/2018
RIP: 0010:clear\_caseopen+0x5a/0x120 [nct6775]
Code: 68 70 e8 e9 32 b1 e3 85 c0 0f 85 d2 00 00 00 48 83 7c 24 ...
RSP: 0018:ffffabcb02803dd8 EFLAGS: 00010246
RAX: 0000000000000000 RBX: 0000000000000002 RCX: 0000000000000000
RDX: ffff8e8808192880 RSI: 0000000000000000 RDI: ffff8e87c7509a68
RBP: 0000000000000000 R08: 0000000000000001 R09: 000000000000000a
R10: 000000000000000a R11: f000000000000000 R12: 000000000000001f
R13: ffff8e87c7509828 R14: ffff8e87c7509a68 R15: ffff8e88494527a0
FS: 00007f4db9151740(0000) GS:ffff8e8ebfec0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000028 CR3: 0000000166b66001 CR4: 00000000001706e0
Call Trace:
kernfs\_fop\_write\_iter+0x11c/0x1b0
new\_sync\_write+0x10b/0x180
vfs\_write+0x209/0x2a0
ksys\_write+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
The problem is that the device passed to clear\_caseopen() is the hwmon
device, not the platform device, and the platform data is not set in the
hwmon device. Store the pointer to sio\_data in struct nct6775\_data and
get if from there if needed.
Fixes: 2e7b9886968b ("hwmon: (nct6775) Use superio\_\*() function pointers in sio\_data.")
Cc: Denis Pauk
Cc: Bernhard Seibold
Reported-by: Paweł Marciniak
Tested-by: Denis Pauk
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit 64c3f1e08e33c9b96ec493037ee47e0b95d73d40
Author: Marc Kleine-Budde
Date: Fri Jan 14 18:50:54 2022 +0100
can: tcan4x5x: regmap: fix max register value
[ Upstream commit e59986de5ff701494e14c722b78b6e6d513e0ab5 ]
The MRAM of the tcan4x5x has a size of 2K and starts at 0x8000. There
are no further registers in the tcan4x5x making 0x87fc the biggest
addressable register.
This patch fixes the max register value of the regmap config from
0x8ffc to 0x87fc.
Fixes: 6e1caaf8ed22 ("can: tcan4x5x: fix max register value")
Link: https://lore.kernel.org/all/20220119064011.2943292-1-mkl@pengutronix.de
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 83f8dafcdc43a64217d20ac6da72bb66ee5bf659
Author: Michael Kelley
Date: Sun Jan 16 11:18:31 2022 -0800
video: hyperv\_fb: Fix validation of screen resolution
[ Upstream commit 9ff5549b1d1d3c3a9d71220d44bd246586160f1d ]
In the WIN10 version of the Synthetic Video protocol with Hyper-V,
Hyper-V reports a list of supported resolutions as part of the protocol
negotiation. The driver calculates the maximum width and height from
the list of resolutions, and uses those maximums to validate any screen
resolution specified in the video= option on the kernel boot line.
This method of validation is incorrect. For example, the list of
supported resolutions could contain 1600x1200 and 1920x1080, both of
which fit in an 8 Mbyte frame buffer. But calculating the max width
and height yields 1920 and 1200, and 1920x1200 resolution does not fit
in an 8 Mbyte frame buffer. Unfortunately, this resolution is accepted,
causing a kernel fault when the driver accesses memory outside the
frame buffer.
Instead, validate the specified screen resolution by calculating
its size, and comparing against the frame buffer size. Delete the
code for calculating the max width and height from the list of
resolutions, since these max values have no use. Also add the
frame buffer size to the info message to aid in understanding why
a resolution might be rejected.
Fixes: 67e7cdb4829d ("video: hyperv: hyperv\_fb: Obtain screen resolution from Hyper-V host")
Signed-off-by: Michael Kelley
Reviewed-by: Haiyang Zhang
Acked-by: Helge Deller
Link: https://lore.kernel.org/r/1642360711-2335-1-git-send-email-mikelley@microsoft.com
Signed-off-by: Wei Liu
Signed-off-by: Sasha Levin
commit 4284225cd8001e134f5cf533a7cd244bbb654d0f
Author: Wen Gu
Date: Sat Jan 22 17:43:09 2022 +0800
net/smc: Transitional solution for clcsock race issue
[ Upstream commit c0bf3d8a943b6f2e912b7c1de03e2ef28e76f760 ]
We encountered a crash in smc\_setsockopt() and it is caused by
accessing smc->clcsock after clcsock was released.
BUG: kernel NULL pointer dereference, address: 0000000000000020
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 1 PID: 50309 Comm: nginx Kdump: loaded Tainted: G E 5.16.0-rc4+ #53
RIP: 0010:smc\_setsockopt+0x59/0x280 [smc]
Call Trace:
\_\_sys\_setsockopt+0xfc/0x190
\_\_x64\_sys\_setsockopt+0x20/0x30
do\_syscall\_64+0x34/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f16ba83918e

This patch tries to fix it by holding clcsock\_release\_lock and
checking whether clcsock has already been released before access.
In case that a crash of the same reason happens in smc\_getsockopt()
or smc\_switch\_to\_fallback(), this patch also checkes smc->clcsock
in them too. And the caller of smc\_switch\_to\_fallback() will identify
whether fallback succeeds according to the return value.
Fixes: fd57770dd198 ("net/smc: wait for pending work before clcsock release\_sock")
Link: https://lore.kernel.org/lkml/5dd7ffd1-28e2-24cc-9442-1defec27375e@linux.ibm.com/T/
Signed-off-by: Wen Gu
Acked-by: Karsten Graul
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e3496f8127f1b97ded5fa1ace04210c2de0eace8
Author: Sukadev Bhattiprolu
Date: Fri Jan 21 18:59:20 2022 -0800
ibmvnic: don't spin in tasklet
[ Upstream commit 48079e7fdd0269d66b1d7d66ae88bd03162464ad ]
ibmvnic\_tasklet() continuously spins waiting for responses to all
capability requests. It does this to avoid encountering an error
during initialization of the vnic. However if there is a bug in the
VIOS and we do not receive a response to one or more queries the
tasklet ends up spinning continuously leading to hard lock ups.
If we fail to receive a message from the VIOS it is reasonable to
timeout the login attempt rather than spin indefinitely in the tasklet.
Fixes: 249168ad07cd ("ibmvnic: Make CRQ interrupt tasklet wait for all capabilities crqs")
Signed-off-by: Sukadev Bhattiprolu
Reviewed-by: Dany Madden
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e6b36dec482ed35514573e97f0c4822c8e103314
Author: Sukadev Bhattiprolu
Date: Fri Jan 21 18:59:19 2022 -0800
ibmvnic: init ->running\_cap\_crqs early
[ Upstream commit 151b6a5c06b678687f64f2d9a99fd04d5cd32b72 ]
We use ->running\_cap\_crqs to determine when the ibmvnic\_tasklet() should
send out the next protocol message type. i.e when we get back responses
to all our QUERY\_CAPABILITY CRQs we send out REQUEST\_CAPABILITY crqs.
Similiary, when we get responses to all the REQUEST\_CAPABILITY crqs, we
send out the QUERY\_IP\_OFFLOAD CRQ.
We currently increment ->running\_cap\_crqs as we send out each CRQ and
have the ibmvnic\_tasklet() send out the next message type, when this
running\_cap\_crqs count drops to 0.
This assumes that all the CRQs of the current type were sent out before
the count drops to 0. However it is possible that we send out say 6 CRQs,
get preempted and receive all the 6 responses before we send out the
remaining CRQs. This can result in ->running\_cap\_crqs count dropping to
zero before all messages of the current type were sent and we end up
sending the next protocol message too early.
Instead initialize the ->running\_cap\_crqs upfront so the tasklet will
only send the next protocol message after all responses are received.
Use the cap\_reqs local variable to also detect any discrepancy (either
now or in future) in the number of capability requests we actually send.
Currently only send\_query\_cap() is affected by this behavior (of sending
next message early) since it is called from the worker thread (during
reset) and from application thread (during ->ndo\_open()) and they can be
preempted. send\_request\_cap() is only called from the tasklet which
processes CRQ responses sequentially, is not be affected. But to
maintain the existing symmtery with send\_query\_capability() we update
send\_request\_capability() also.
Fixes: 249168ad07cd ("ibmvnic: Make CRQ interrupt tasklet wait for all capabilities crqs")
Signed-off-by: Sukadev Bhattiprolu
Reviewed-by: Dany Madden
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b521a4e1a8ef15f6130e6df0cc3ae37e658512ba
Author: Sukadev Bhattiprolu
Date: Fri Jan 21 18:59:18 2022 -0800
ibmvnic: Allow extra failures before disabling
[ Upstream commit db9f0e8bf79e6da7068b5818fea0ffd9d0d4b4da ]
If auto-priority-failover (APF) is enabled and there are at least two
backing devices of different priorities, some resets like fail-over,
change-param etc can cause at least two back to back failovers. (Failover
from high priority backing device to lower priority one and then back
to the higher priority one if that is still functional).
Depending on the timimg of the two failovers it is possible to trigger
a "hard" reset and for the hard reset to fail due to failovers. When this
occurs, the driver assumes that the network is unstable and disables the
VNIC for a 60-second "settling time". This in turn can cause the ethtool
command to fail with "No such device" while the vnic automatically recovers
a little while later.
Given that it's possible to have two back to back failures, allow for extra
failures before disabling the vnic for the settling time.
Fixes: f15fde9d47b8 ("ibmvnic: delay next reset if hard reset fails")
Signed-off-by: Sukadev Bhattiprolu
Reviewed-by: Dany Madden
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d501d0535309577d0412e9266879893eeaea09aa
Author: Jakub Kicinski
Date: Fri Jan 21 16:57:31 2022 -0800
ipv4: fix ip option filtering for locally generated fragments
[ Upstream commit 27a8caa59babb96c5890569e131bc0eb6d45daee ]
During IP fragmentation we sanitize IP options. This means overwriting
options which should not be copied with NOPs. Only the first fragment
has the original, full options.
ip\_fraglist\_prepare() copies the IP header and options from previous
fragment to the next one. Commit 19c3401a917b ("net: ipv4: place control
buffer handling away from fragmentation iterators") moved sanitizing
options before ip\_fraglist\_prepare() which means options are sanitized
and then overwritten again with the old values.
Fixing this is not enough, however, nor did the sanitization work
prior to aforementioned commit.
ip\_options\_fragment() (which does the sanitization) uses ipcb->opt.optlen
for the length of the options. ipcb->opt of fragments is not populated
(it's 0), only the head skb has the state properly built. So even when
called at the right time ip\_options\_fragment() does nothing. This seems
to date back all the way to v2.5.44 when the fast path for pre-fragmented
skbs had been introduced. Prior to that ip\_options\_build() would have been
called for every fragment (in fact ever since v2.5.44 the fragmentation
handing in ip\_options\_build() has been dead code, I'll clean it up in
-next).
In the original patch (see Link) caixf mentions fixing the handling
for fragments other than the second one, but I'm not sure how \_any\_
fragment could have had their options sanitized with the code
as it stood.
Tested with python (MTU on lo lowered to 1000 to force fragmentation):
import socket
s = socket.socket(socket.AF\_INET, socket.SOCK\_DGRAM)
s.setsockopt(socket.IPPROTO\_IP, socket.IP\_OPTIONS,
bytearray([7,4,5,192, 20|0x80,4,1,0]))
s.sendto(b'1'\*2000, ('127.0.0.1', 1234))
Before:
IP (tos 0x0, ttl 64, id 1053, offset 0, flags [+], proto UDP (17), length 996, options (RR [bad length 4] [bad ptr 5] 192.148.4.1,,RA value 256))
localhost.36500 > localhost.search-agent: UDP, length 2000
IP (tos 0x0, ttl 64, id 1053, offset 968, flags [+], proto UDP (17), length 996, options (RR [bad length 4] [bad ptr 5] 192.148.4.1,,RA value 256))
localhost > localhost: udp
IP (tos 0x0, ttl 64, id 1053, offset 1936, flags [none], proto UDP (17), length 100, options (RR [bad length 4] [bad ptr 5] 192.148.4.1,,RA value 256))
localhost > localhost: udp
After:
IP (tos 0x0, ttl 96, id 42549, offset 0, flags [+], proto UDP (17), length 996, options (RR [bad length 4] [bad ptr 5] 192.148.4.1,,RA value 256))
localhost.51607 > localhost.search-agent: UDP, bad length 2000 > 960
IP (tos 0x0, ttl 96, id 42549, offset 968, flags [+], proto UDP (17), length 996, options (NOP,NOP,NOP,NOP,RA value 256))
localhost > localhost: udp
IP (tos 0x0, ttl 96, id 42549, offset 1936, flags [none], proto UDP (17), length 100, options (NOP,NOP,NOP,NOP,RA value 256))
localhost > localhost: udp
RA (20 | 0x80) is now copied as expected, RR (7) is "NOPed out".
Link: https://lore.kernel.org/netdev/20220107080559.122713-1-ooppublic@163.com/
Fixes: 19c3401a917b ("net: ipv4: place control buffer handling away from fragmentation iterators")
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: caixf
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fa4ad064a6bd49208221df5e62adf27b426d1720
Author: Athira Rajeev
Date: Sat Jan 22 09:04:29 2022 +0530
powerpc/perf: Fix power\_pmu\_disable to call clear\_pmi\_irq\_pending only if PMI is pending
[ Upstream commit fb6433b48a178d4672cb26632454ee0b21056eaa ]
Running selftest with CONFIG\_PPC\_IRQ\_SOFT\_MASK\_DEBUG enabled in kernel
triggered below warning:
[ 172.851380] ------------[ cut here ]------------
[ 172.851391] WARNING: CPU: 8 PID: 2901 at arch/powerpc/include/asm/hw\_irq.h:246 power\_pmu\_disable+0x270/0x280
[ 172.851402] Modules linked in: dm\_mod bonding nft\_ct nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables rfkill nfnetlink sunrpc xfs libcrc32c pseries\_rng xts vmx\_crypto uio\_pdrv\_genirq uio sch\_fq\_codel ip\_tables ext4 mbcache jbd2 sd\_mod t10\_pi sg ibmvscsi ibmveth scsi\_transport\_srp fuse
[ 172.851442] CPU: 8 PID: 2901 Comm: lost\_exception\_ Not tainted 5.16.0-rc5-03218-g798527287598 #2
[ 172.851451] NIP: c00000000013d600 LR: c00000000013d5a4 CTR: c00000000013b180
[ 172.851458] REGS: c000000017687860 TRAP: 0700 Not tainted (5.16.0-rc5-03218-g798527287598)
[ 172.851465] MSR: 8000000000029033  CR: 48004884 XER: 20040000
[ 172.851482] CFAR: c00000000013d5b4 IRQMASK: 1
[ 172.851482] GPR00: c00000000013d5a4 c000000017687b00 c000000002a10600 0000000000000004
[ 172.851482] GPR04: 0000000082004000 c0000008ba08f0a8 0000000000000000 00000008b7ed0000
[ 172.851482] GPR08: 00000000446194f6 0000000000008000 c00000000013b118 c000000000d58e68
[ 172.851482] GPR12: c00000000013d390 c00000001ec54a80 0000000000000000 0000000000000000
[ 172.851482] GPR16: 0000000000000000 0000000000000000 c000000015d5c708 c0000000025396d0
[ 172.851482] GPR20: 0000000000000000 0000000000000000 c00000000a3bbf40 0000000000000003
[ 172.851482] GPR24: 0000000000000000 c0000008ba097400 c0000000161e0d00 c00000000a3bb600
[ 172.851482] GPR28: c000000015d5c700 0000000000000001 0000000082384090 c0000008ba0020d8
[ 172.851549] NIP [c00000000013d600] power\_pmu\_disable+0x270/0x280
[ 172.851557] LR [c00000000013d5a4] power\_pmu\_disable+0x214/0x280
[ 172.851565] Call Trace:
[ 172.851568] [c000000017687b00] [c00000000013d5a4] power\_pmu\_disable+0x214/0x280 (unreliable)
[ 172.851579] [c000000017687b40] [c0000000003403ac] perf\_pmu\_disable+0x4c/0x60
[ 172.851588] [c000000017687b60] [c0000000003445e4] \_\_perf\_event\_task\_sched\_out+0x1d4/0x660
[ 172.851596] [c000000017687c50] [c000000000d1175c] \_\_schedule+0xbcc/0x12a0
[ 172.851602] [c000000017687d60] [c000000000d11ea8] schedule+0x78/0x140
[ 172.851608] [c000000017687d90] [c0000000001a8080] sys\_sched\_yield+0x20/0x40
[ 172.851615] [c000000017687db0] [c0000000000334dc] system\_call\_exception+0x18c/0x380
[ 172.851622] [c000000017687e10] [c00000000000c74c] system\_call\_common+0xec/0x268
The warning indicates that MSR\_EE being set(interrupt enabled) when
there was an overflown PMC detected. This could happen in
power\_pmu\_disable since it runs under interrupt soft disable
condition ( local\_irq\_save ) and not with interrupts hard disabled.
commit 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear
pending PMI before resetting an overflown PMC") intended to clear
PMI pending bit in Paca when disabling the PMU. It could happen
that PMC gets overflown while code is in power\_pmu\_disable
callback function. Hence add a check to see if PMI pending bit
is set in Paca before clearing it via clear\_pmi\_pending.
Fixes: 2c9ac51b850d ("powerpc/perf: Fix PMU callbacks to clear pending PMI before resetting an overflown PMC")
Reported-by: Sachin Sant
Signed-off-by: Athira Rajeev
Tested-by: Sachin Sant
Reviewed-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20220122033429.25395-1-atrajeev@linux.vnet.ibm.com
Signed-off-by: Sasha Levin
commit 1f679a6e19727dc57f528639db423abbdb9348b6
Author: Dan Carpenter
Date: Fri Jan 21 14:55:43 2022 +0300
hwmon: (adt7470) Prevent divide by zero in adt7470\_fan\_write()
[ Upstream commit c1ec0cabc36718efc7fe8b4157d41b82d08ec1d2 ]
The "val" variable is controlled by the user and comes from
hwmon\_attr\_store(). The FAN\_RPM\_TO\_PERIOD() macro divides by "val"
so a zero will crash the system. Check for that and return -EINVAL.
Negatives are also invalid so return -EINVAL for those too.
Fixes: fc958a61ff6d ("hwmon: (adt7470) Convert to devm\_hwmon\_device\_register\_with\_info API")
Signed-off-by: Dan Carpenter
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit a7d3b89a7095b167ab2c49fd534dc69be38549ae
Author: Guenter Roeck
Date: Mon Jan 10 23:23:31 2022 -0800
hwmon: (lm90) Fix sysfs and udev notifications
[ Upstream commit d379880d9adb9f1ada3f1266aa49ea2561328e08 ]
sysfs and udev notifications need to be sent to the \_alarm
attributes, not to the value attributes.
Fixes: 94dbd23ed88c ("hwmon: (lm90) Use hwmon\_notify\_event()")
Cc: Dmitry Osipenko
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit 52e143f68fcb2252113ae3b5936b2ac7d4303a5d
Author: Guenter Roeck
Date: Fri Jan 7 11:05:23 2022 -0800
hwmon: (lm90) Mark alert as broken for MAX6654
[ Upstream commit a53fff96f35763d132a36c620b183fdf11022d7a ]
Experiments with MAX6654 show that its alert function is broken,
similar to other chips supported by the lm90 driver. Mark it accordingly.
Fixes: 229d495d8189 ("hwmon: (lm90) Add max6654 support to lm90 driver")
Cc: Josh Lehan
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit 6d1e32218578ea6314c874b602235bb178896354
Author: Guenter Roeck
Date: Sat Jan 8 11:37:19 2022 -0800
hwmon: (lm90) Re-enable interrupts after alert clears
[ Upstream commit bc341a1a98827925082e95db174734fc8bd68af6 ]
If alert handling is broken, interrupts are disabled after an alert and
re-enabled after the alert clears. However, if there is an interrupt
handler, this does not apply if alerts were originally disabled and enabled
when the driver was loaded. In that case, interrupts will stay disabled
after an alert was handled though the alert handler even after the alert
condition clears. Address the situation by always re-enabling interrupts
after the alert condition clears if there is an interrupt handler.
Fixes: 2abdc357c55d9 ("hwmon: (lm90) Unmask hardware interrupt")
Cc: Dmitry Osipenko
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit 72f50424b0a1806d81a30110a3809655374b8277
Author: Yanming Liu
Date: Thu Jan 20 04:20:52 2022 +0800
Drivers: hv: balloon: account for vmbus packet header in max\_pkt\_size
[ Upstream commit 96d9d1fa5cd505078534113308ced0aa56d8da58 ]
Commit adae1e931acd ("Drivers: hv: vmbus: Copy packets sent by Hyper-V
out of the ring buffer") introduced a notion of maximum packet size in
vmbus channel and used that size to initialize a buffer holding all
incoming packet along with their vmbus packet header. hv\_balloon uses
the default maximum packet size VMBUS\_DEFAULT\_MAX\_PKT\_SIZE which matches
its maximum message size, however vmbus\_open expects this size to also
include vmbus packet header. This leads to 4096 bytes
dm\_unballoon\_request messages being truncated to 4080 bytes. When the
driver tries to read next packet it starts from a wrong read\_index,
receives garbage and prints a lot of "Unhandled message: type:
" in dmesg.
Allocate the buffer with HV\_HYP\_PAGE\_SIZE more bytes to make room for
the header.
Fixes: adae1e931acd ("Drivers: hv: vmbus: Copy packets sent by Hyper-V out of the ring buffer")
Suggested-by: Michael Kelley (LINUX)
Suggested-by: Andrea Parri (Microsoft)
Signed-off-by: Yanming Liu
Reviewed-by: Michael Kelley
Reviewed-by: Andrea Parri (Microsoft)
Link: https://lore.kernel.org/r/20220119202052.3006981-1-yanminglr@gmail.com
Signed-off-by: Wei Liu
Signed-off-by: Sasha Levin
commit fe4214a07e0b53d2af711f57519e33739c5df23f
Author: Miaoqian Lin
Date: Thu Jan 20 10:10:25 2022 +0000
block: fix memory leak in disk\_register\_independent\_access\_ranges
[ Upstream commit 83114df32ae779df57e0af99a8ba6c3968b2ba3d ]
kobject\_init\_and\_add() takes reference even when it fails.
According to the doc of kobject\_init\_and\_add()
If this function returns an error, kobject\_put() must be called to
properly clean up the memory associated with the object.
Fix this issue by adding kobject\_put().
Callback function blk\_ia\_ranges\_sysfs\_release() in kobject\_put()
can handle the pointer "iars" properly.
Fixes: a2247f19ee1c ("block: Add independent access ranges support")
Signed-off-by: Miaoqian Lin
Reviewed-by: Damien Le Moal
Link: https://lore.kernel.org/r/20220120101025.22411-1-linmq006@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit d7462bf68b187f1d27482d52c214d23bc386cd7a
Author: Dylan Yudaken
Date: Fri Jan 21 04:38:56 2022 -0800
io\_uring: fix bug in slow unregistering of nodes
[ Upstream commit b36a2050040b2d839bdc044007cdd57101d7f881 ]
In some cases io\_rsrc\_ref\_quiesce will call io\_rsrc\_node\_switch\_start,
and then immediately flush the delayed work queue &ctx->rsrc\_put\_work.
However the percpu\_ref\_put does not immediately destroy the node, it
will be called asynchronously via RCU. That ends up with
io\_rsrc\_node\_ref\_zero only being called after rsrc\_put\_work has been
flushed, and so the process ends up sleeping for 1 second unnecessarily.
This patch executes the put code immediately if we are busy
quiescing.
Fixes: 4a38aed2a0a7 ("io\_uring: batch reap of dead file registrations")
Signed-off-by: Dylan Yudaken
Link: https://lore.kernel.org/r/20220121123856.3557884-1-dylany@fb.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 6ef46e116965657d0fa76e0a6fbd0f8532d9fbff
Author: Mihai Carabas
Date: Wed Jan 19 18:14:27 2022 +0200
efi/libstub: arm64: Fix image check alignment at entry
[ Upstream commit e9b7c3a4263bdcfd31bc3d03d48ce0ded7a94635 ]
The kernel is aligned at SEGMENT\_SIZE and this is the size populated in the PE
headers:
arch/arm64/kernel/efi-header.S: .long SEGMENT\_ALIGN // SectionAlignment
EFI\_KIMG\_ALIGN is defined as: (SEGMENT\_ALIGN > THREAD\_ALIGN ? SEGMENT\_ALIGN :
THREAD\_ALIGN)
So it depends on THREAD\_ALIGN. On newer builds this message started to appear
even though the loader is taking into account the PE header (which is stating
SEGMENT\_ALIGN).
Fixes: c32ac11da3f8 ("efi/libstub: arm64: Double check image alignment at entry")
Signed-off-by: Mihai Carabas
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
commit db3d197219139c6804d2625331dc9a0aedcb9aa5
Author: David Howells
Date: Fri Jan 21 23:12:58 2022 +0000
rxrpc: Adjust retransmission backoff
[ Upstream commit 2c13c05c5ff4b9fc907b07f7311821910ebaaf8a ]
Improve retransmission backoff by only backing off when we retransmit data
packets rather than when we set the lost ack timer.
To this end:
(1) In rxrpc\_resend(), use rxrpc\_get\_rto\_backoff() when setting the
retransmission timer and only tell it that we are retransmitting if we
actually have things to retransmit.
Note that it's possible for the retransmission algorithm to race with
the processing of a received ACK, so we may see no packets needing
retransmission.
(2) In rxrpc\_send\_data\_packet(), don't bump the backoff when setting the
ack\_lost\_at timer, as it may then get bumped twice.
With this, when looking at one particular packet, the retransmission
intervals were seen to be 1.5ms, 2ms, 3ms, 5ms, 9ms, 17ms, 33ms, 71ms,
136ms, 264ms, 544ms, 1.088s, 2.1s, 4.2s and 8.3s.
Fixes: c410bf01933e ("rxrpc: Fix the excessive initial retransmission timeout")
Suggested-by: Marc Dionne
Signed-off-by: David Howells
Reviewed-by: Marc Dionne
Tested-by: Marc Dionne
cc: linux-afs@lists.infradead.org
Link: https://lore.kernel.org/r/164138117069.2023386.17446904856843997127.stgit@warthog.procyon.org.uk/
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 52599359c0dab74a72de9ebb05f1a78453df3d84
Author: Kiran Kumar K
Date: Fri Jan 21 12:04:47 2022 +0530
octeontx2-af: Add KPU changes to parse NGIO as separate layer
[ Upstream commit 745166fcf01cecc4f5ff3defc6586868349a43f9 ]
With current KPU profile NGIO is being parsed along with CTAG as
a single layer. Because of this MCAM/ntuple rules installed with
ethertype as 0x8842 are not being hit. Adding KPU profile changes
to parse NGIO in separate ltype and CTAG in separate ltype.
Fixes: f9c49be90c05 ("octeontx2-af: Update the default KPU profile and fixes")
Signed-off-by: Kiran Kumar K
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ecf6ec4076ae7199bd846c9bf8bbf09757709f62
Author: Subbaraya Sundeep
Date: Fri Jan 21 12:04:46 2022 +0530
octeontx2-pf: Forward error codes to VF
[ Upstream commit a8db854be28622a2477cb21cdf7f829adbb2c42d ]
PF forwards its VF messages to AF and corresponding
replies from AF to VF. AF sets proper error code in the
replies after processing message requests. Currently PF
checks the error codes in replies and sends invalid
message to VF. This way VF lacks the information of
error code set by AF for its messages. This patch
changes that such that PF simply forwards AF replies
so that VF can handle error codes.
Fixes: d424b6c02415 ("octeontx2-pf: Enable SRIOV and added VF mbox handling")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a7e3a731dfbaffe4328430682f44429c70d5610c
Author: Geetha sowjanya
Date: Fri Jan 21 12:04:45 2022 +0530
octeontx2-af: cn10k: Do not enable RPM loopback for LPC interfaces
[ Upstream commit df66b6ebc5dcf7253e35a640b9ec4add54195c25 ]
Internal looback is not supported to low rate LPCS interface like
SGMII/QSGMII. Hence don't allow to enable for such interfaces.
Fixes: 3ad3f8f93c81 ("octeontx2-af: cn10k: MAC internal loopback support")
Signed-off-by: Geetha sowjanya
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 97008a3a8622e58fbfa7ddf681cd417010e4885b
Author: Geetha sowjanya
Date: Fri Jan 21 12:04:44 2022 +0530
octeontx2-af: Increase link credit restore polling timeout
[ Upstream commit 1581d61b42d985cefe7b71eea67ab3bfcbf34d0f ]
It's been observed that sometimes link credit restore takes
a lot of time than the current timeout. This patch increases
the default timeout value and return the proper error value
on failure.
Fixes: 1c74b89171c3 ("octeontx2-af: Wait for TX link idle for credits change")
Signed-off-by: Geetha sowjanya
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 97d7446c1612d7dcd194bb0d1ef5e3ce5b89c3b8
Author: Geetha sowjanya
Date: Fri Jan 21 12:04:43 2022 +0530
octeontx2-pf: cn10k: Ensure valid pointers are freed to aura
[ Upstream commit c5d731c54a17677939bd59ee8be4ed74d7485ba4 ]
While freeing SQB pointers to aura, driver first memcpy to
target address and then triggers lmtst operation to free pointer
to the aura. We need to ensure(by adding dmb barrier)that memcpy
is finished before pointers are freed to the aura. This patch also
adds the missing sq context structure entry in debugfs.
Fixes: ef6c8da71eaf ("octeontx2-pf: cn10K: Reserve LMTST lines per core")
Signed-off-by: Geetha sowjanya
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 59a3393f74665fdf3ab942af7a5937128b7ef394
Author: Geetha sowjanya
Date: Fri Jan 21 12:04:42 2022 +0530
octeontx2-af: cn10k: Use appropriate register for LMAC enable
[ Upstream commit fae80edeafbbba5ef9a0423aa5e5515518626433 ]
CN10K platforms uses RPM(0..2)\_MTI\_MAC100(0..3)\_COMMAND\_CONFIG
register for lmac TX/RX enable whereas CN9xxx platforms use
CGX\_CMRX\_CONFIG register. This config change was missed when
adding support for CN10K RPM.
Fixes: 91c6945ea1f9 ("octeontx2-af: cn10k: Add RPM MAC support")
Signed-off-by: Geetha sowjanya
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7c1f8357870ea711364896c71abba7ac0554d977
Author: Geetha sowjanya
Date: Fri Jan 21 12:04:41 2022 +0530
octeontx2-af: Retry until RVU block reset complete
[ Upstream commit 03ffbc9914bd1130fba464f0a41c01372e5fc359 ]
Few RVU blocks like SSO require more time for reset on some
silicons. Hence retrying the block reset until success.
Fixes: c0fa2cff8822c ("octeontx2-af: Handle return value in block reset")
Signed-off-by: Geetha sowjanya
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7e32f747248db26aad6fed4b59a86e89fbb8395a
Author: Sunil Goutham
Date: Fri Jan 21 12:04:40 2022 +0530
octeontx2-af: Fix LBK backpressure id count
[ Upstream commit 00bfe94e388fe12bfd0d4f6361b1b1343374ff5b ]
In rvu\_nix\_get\_bpid() lbk\_bpid\_cnt is being read from
wrong register. Due to this backpressure enable is failing
for LBK VF32 onwards. This patch fixes that.
Fixes: fe1939bb2340 ("octeontx2-af: Add SDP interface support")
Signed-off-by: Sunil Goutham
Signed-off-by: Subbaraya Sundeep
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4d22bc49ffd39a6a498d7a84aa70158effe56570
Author: Subbaraya Sundeep
Date: Fri Jan 21 12:04:39 2022 +0530
octeontx2-af: Do not fixup all VF action entries
[ Upstream commit d225c449ab2be25273a3674f476c6c0b57c50254 ]
AF modifies all the rules destined for VF to use
the action same as default RSS action. This fixup
was needed because AF only installs default rules with
RSS action. But the action in rules installed by a PF
for its VFs should not be changed by this fixup.
This is because action can be drop or direct to
queue as specified by user(ntuple filters).
This patch fixes that problem.
Fixes: 967db3529eca ("octeontx2-af: add support for multicast/promisc packet")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Naveen Mamindlapalli
Signed-off-by: Sunil Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cb2fab10fc5e7a3aa1bb0a68a3abdcf3e37852af
Author: Marek Behún
Date: Wed Jan 19 17:27:48 2022 +0100
phylib: fix potential use-after-free
[ Upstream commit cbda1b16687580d5beee38273f6241ae3725960c ]
Commit bafbdd527d56 ("phylib: Add device reset GPIO support") added call
to phy\_device\_reset(phydev) after the put\_device() call in phy\_detach().
The comment before the put\_device() call says that the phydev might go
away with put\_device().
Fix potential use-after-free by calling phy\_device\_reset() before
put\_device().
Fixes: bafbdd527d56 ("phylib: Add device reset GPIO support")
Signed-off-by: Marek Behún
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20220119162748.32418-1-kabel@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit d217c3248219f1070c6e9c69617831cb6bcc3885
Author: Yuji Ishikawa
Date: Wed Jan 19 13:46:48 2022 +0900
net: stmmac: dwmac-visconti: Fix clock configuration for RMII mode
[ Upstream commit 0959bc4bd4206433ed101a1332a23e93ad16ec77 ]
Bit pattern of the ETHER\_CLOCK\_SEL register for RMII/MII mode should be fixed.
Also, some control bits should be modified with a specific sequence.
Fixes: b38dd98ff8d0 ("net: stmmac: Add Toshiba Visconti SoCs glue driver")
Signed-off-by: Yuji Ishikawa
Reviewed-by: Nobuhiro Iwamatsu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1b5bf52e20deb168cfc9a7599c6d8f8edf884b65
Author: Yuji Ishikawa
Date: Wed Jan 19 13:46:47 2022 +0900
net: stmmac: dwmac-visconti: Fix bit definitions for ETHER\_CLK\_SEL
[ Upstream commit 1ba1a4a90fa416a6f389206416c5f488cf8b1543 ]
just 0 should be used to represent cleared bits
\* ETHER\_CLK\_SEL\_DIV\_SEL\_20
\* ETHER\_CLK\_SEL\_TX\_CLK\_EXT\_SEL\_IN
\* ETHER\_CLK\_SEL\_RX\_CLK\_EXT\_SEL\_IN
\* ETHER\_CLK\_SEL\_TX\_CLK\_O\_TX\_I
\* ETHER\_CLK\_SEL\_RMII\_CLK\_SEL\_IN
Fixes: b38dd98ff8d0 ("net: stmmac: Add Toshiba Visconti SoCs glue driver")
Signed-off-by: Yuji Ishikawa
Reviewed-by: Nobuhiro Iwamatsu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 529daf17749043eda74195ff72e72e040b76a7e9
Author: Moshe Tal
Date: Thu Jan 20 11:55:50 2022 +0200
ethtool: Fix link extended state for big endian
[ Upstream commit e2f08207c558bc0bc8abaa557cdb29bad776ac7b ]
The link extended sub-states are assigned as enum that is an integer
size but read from a union as u8, this is working for small values on
little endian systems but for big endian this always give 0. Fix the
variable in the union to match the enum size.
Fixes: ecc31c60240b ("ethtool: Add link extended state")
Signed-off-by: Moshe Tal
Reviewed-by: Ido Schimmel
Tested-by: Ido Schimmel
Reviewed-by: Gal Pressman
Reviewed-by: Amit Cohen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e61fe7d113625838fecdb6cd1b4599018947d2b6
Author: Robert Hancock
Date: Tue Jan 18 15:52:43 2022 -0600
net: phy: broadcom: hook up soft\_reset for BCM54616S
[ Upstream commit d15c7e875d44367005370e6a82e8f3a382a04f9b ]
A problem was encountered with the Bel-Fuse 1GBT-SFP05 SFP module (which
is a 1 Gbps copper module operating in SGMII mode with an internal
BCM54616S PHY device) using the Xilinx AXI Ethernet MAC core, where the
module would work properly on the initial insertion or boot of the
device, but after the device was rebooted, the link would either only
come up at 100 Mbps speeds or go up and down erratically.
I found no meaningful changes in the PHY configuration registers between
the working and non-working boots, but the status registers seemed to
have a lot of error indications set on the SERDES side of the device on
the non-working boot. I suspect the problem is that whatever happens on
the SGMII link when the device is rebooted and the FPGA logic gets
reloaded ends up putting the module's onboard PHY into a bad state.
Since commit 6e2d85ec0559 ("net: phy: Stop with excessive soft reset")
the genphy\_soft\_reset call is not made automatically by the PHY core
unless the callback is explicitly specified in the driver structure. For
most of these Broadcom devices, there is probably a hardware reset that
gets asserted to reset the PHY during boot, however for SFP modules
(where the BCM54616S is commonly found) no such reset line exists, so if
the board keeps the SFP cage powered up across a reboot, it will end up
with no reset occurring during reboots.
Hook up the genphy\_soft\_reset callback for BCM54616S to ensure that a
PHY reset is performed before the device is initialized. This appears to
fix the issue with erratic operation after a reboot with this SFP
module.
Fixes: 6e2d85ec0559 ("net: phy: Stop with excessive soft reset")
Signed-off-by: Robert Hancock
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 12fc88eb756dc3d15b23a1c641758cff3260a9c5
Author: Vincent Guittot
Date: Tue Jan 11 14:46:56 2022 +0100
sched/pelt: Relax the sync of util\_sum with util\_avg
[ Upstream commit 98b0d890220d45418cfbc5157b3382e6da5a12ab ]
Rick reported performance regressions in bugzilla because of cpu frequency
being lower than before:
https://bugzilla.kernel.org/show\_bug.cgi?id=215045
He bisected the problem to:
commit 1c35b07e6d39 ("sched/fair: Ensure \_sum and \_avg values stay consistent")
This commit forces util\_sum to be synced with the new util\_avg after
removing the contribution of a task and before the next periodic sync. By
doing so util\_sum is rounded to its lower bound and might lost up to
LOAD\_AVG\_MAX-1 of accumulated contribution which has not yet been
reflected in util\_avg.
Instead of always setting util\_sum to the low bound of util\_avg, which can
significantly lower the utilization of root cfs\_rq after propagating the
change down into the hierarchy, we revert the change of util\_sum and
propagate the difference.
In addition, we also check that cfs's util\_sum always stays above the
lower bound for a given util\_avg as it has been observed that
sched\_entity's util\_sum is sometimes above cfs one.
Fixes: 1c35b07e6d39 ("sched/fair: Ensure \_sum and \_avg values stay consistent")
Reported-by: Rick Yiu
Signed-off-by: Vincent Guittot
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Dietmar Eggemann
Tested-by: Sachin Sant
Link: https://lkml.kernel.org/r/20220111134659.24961-2-vincent.guittot@linaro.org
Signed-off-by: Sasha Levin
commit 04ae6dc63a6ab06f8c1d6bc398d5227ce476db8f
Author: Peter Zijlstra
Date: Mon Dec 20 13:19:52 2021 +0100
perf: Fix perf\_event\_read\_local() time
[ Upstream commit 09f5e7dc7ad705289e1b1ec065439aa3c42951c4 ]
Time readers that cannot take locks (due to NMI etc..) currently make
use of perf\_event::shadow\_ctx\_time, which, for that event gives:
time' = now + (time - timestamp)
or, alternatively arranged:
time' = time + (now - timestamp)
IOW, the progression of time since the last time the shadow\_ctx\_time
was updated.
There's problems with this:
A) the shadow\_ctx\_time is per-event, even though the ctx\_time it
reflects is obviously per context. The direct concequence of this
is that the context needs to iterate all events all the time to
keep the shadow\_ctx\_time in sync.
B) even with the prior point, the context itself might not be active
meaning its time should not advance to begin with.
C) shadow\_ctx\_time isn't consistently updated when ctx\_time is
There are 3 users of this stuff, that suffer differently from this:
- calc\_timer\_values()
- perf\_output\_read()
- perf\_event\_update\_userpage() /\* A \*/
- perf\_event\_read\_local() /\* A,B \*/
In particular, perf\_output\_read() doesn't suffer at all, because it's
sample driven and hence only relevant when the event is actually
running.
This same was supposed to be true for perf\_event\_update\_userpage(),
after all self-monitoring implies the context is active \*HOWEVER\*, as
per commit f79256532682 ("perf/core: fix userpage->time\_enabled of
inactive events") this goes wrong when combined with counter
overcommit, in that case those events that do not get scheduled when
the context becomes active (task events typically) miss out on the
EVENT\_TIME update and ENABLED time is inflated (for a little while)
with the time the context was inactive. Once the event gets rotated
in, this gets corrected, leading to a non-monotonic timeflow.
perf\_event\_read\_local() made things even worse, it can request time at
any point, suffering all the problems perf\_event\_update\_userpage()
does and more. Because while perf\_event\_update\_userpage() is limited
by the context being active, perf\_event\_read\_local() users have no
such constraint.
Therefore, completely overhaul things and do away with
perf\_event::shadow\_ctx\_time. Instead have regular context time updates
keep track of this offset directly and provide perf\_event\_time\_now()
to complement perf\_event\_time().
perf\_event\_time\_now() will, in adition to being context wide, also
take into account if the context is active. For inactive context, it
will not advance time.
This latter property means the cgroup perf\_cgroup\_info context needs
to grow addition state to track this.
Additionally, since all this is strictly per-cpu, we can use barrier()
to order context activity vs context time.
Fixes: 7d9285e82db5 ("perf/bpf: Extend the perf\_event\_read\_local() interface, a.k.a. "bpf: perf event change needed for subsequent bpf helpers"")
Signed-off-by: Peter Zijlstra (Intel)
Tested-by: Song Liu
Tested-by: Namhyung Kim
Link: https://lkml.kernel.org/r/YcB06DasOBtU0b00@hirez.programming.kicks-ass.net
Signed-off-by: Sasha Levin
commit d8cd36a108fa7ee31fee9d61c30cbf5a9965f640
Author: Nicholas Piggin
Date: Mon Jan 17 23:44:03 2022 +1000
powerpc/64s: Mask SRR0 before checking against the masked NIP
[ Upstream commit aee101d7b95a03078945681dd7f7ea5e4a1e7686 ]
Commit 314f6c23dd8d ("powerpc/64s: Mask NIP before checking against
SRR0") masked off the low 2 bits of the NIP value in the interrupt
stack frame in case they are non-zero and mis-compare against a SRR0
register value of a CPU which always reads back 0 from the 2 low bits
which are reserved.
This now causes the opposite problem that an implementation which does
implement those bits in SRR0 will mis-compare against the masked NIP
value in which they have been cleared. QEMU is one such implementation,
and this is allowed by the architecture.
This can be triggered by sigfuz by setting low bits of PT\_NIP in the
signal context.
Fix this for now by masking the SRR0 bits as well. Cleaner is probably
to sanitise these values before putting them in registers or stack, but
this is the quick and backportable fix.
Fixes: 314f6c23dd8d ("powerpc/64s: Mask NIP before checking against SRR0")
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20220117134403.2995059-1-npiggin@gmail.com
Signed-off-by: Sasha Levin
commit d21caf9023bb2d1d74afa24e17d4edd3480ccd1a
Author: Randy Dunlap
Date: Fri Jan 14 17:13:38 2022 -0800
remoteproc: qcom: q6v5: fix service routines build errors
[ Upstream commit eee412e968f7b950564880bc6a7a9f00f49034da ]
When CONFIG\_QCOM\_AOSS\_QMP=m and CONFIG\_QCOM\_Q6V5\_MSS=y, the builtin
driver cannot call into the loadable module's low-level service
functions. Trying to build with that config combo causes linker errors.
There are two problems here. First, drivers/remoteproc/qcom\_q6v5.c
should #include  for the definitions of
the service functions, depending on whether CONFIG\_QCOM\_AOSS\_QMP is
set/enabled or not. Second, the qcom remoteproc drivers should depend
on QCOM\_AOSS\_QMP iff it is enabled (=y or =m) so that the qcom
remoteproc drivers can be built properly.
This prevents these build errors:
aarch64-linux-ld: drivers/remoteproc/qcom\_q6v5.o: in function `q6v5\_load\_state\_toggle':
qcom\_q6v5.c:(.text+0xc4): undefined reference to `qmp\_send'
aarch64-linux-ld: drivers/remoteproc/qcom\_q6v5.o: in function `qcom\_q6v5\_deinit':
(.text+0x2e4): undefined reference to `qmp\_put'
aarch64-linux-ld: drivers/remoteproc/qcom\_q6v5.o: in function `qcom\_q6v5\_init':
(.text+0x778): undefined reference to `qmp\_get'
aarch64-linux-ld: (.text+0x7d8): undefined reference to `qmp\_put'
Fixes: c1fe10d238c0 ("remoteproc: qcom: q6v5: Use qmp\_send to update co-processor load state")
Signed-off-by: Randy Dunlap
Reported-by: kernel test robot
Cc: Bjorn Andersson
Cc: Mathieu Poirier
Cc: linux-remoteproc@vger.kernel.org
Cc: Sibi Sankar
Cc: Stephen Boyd
Reviewed-by: Stephen Boyd
Reviewed-by: Bjorn Andersson
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20220115011338.2973-1-rdunlap@infradead.org
Signed-off-by: Sasha Levin
commit 47cf5bfa8d2ba569bd988c31266893d6b4503ff2
Author: Florian Westphal
Date: Thu Jan 13 21:37:58 2022 +0100
netfilter: conntrack: don't increment invalid counter on NF\_REPEAT
[ Upstream commit 830af2eba40327abec64325a5b08b1e85c37a2e0 ]
The packet isn't invalid, REPEAT means we're trying again after cleaning
out a stale connection, e.g. via tcp tracker.
This caused increases of invalid stat counter in a test case involving
frequent connection reuse, even though no packet is actually invalid.
Fixes: 56a62e2218f5 ("netfilter: conntrack: fix NF\_REPEAT handling")
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit aaccfeeee1630b155e8ff0d6c449d3de1ef86e73
Author: Naveen N. Rao
Date: Thu Jan 6 17:15:12 2022 +0530
powerpc64/bpf: Limit 'ldbrx' to processors compliant with ISA v2.06
[ Upstream commit 3f5f766d5f7f95a69a630da3544a1a0cee1cdddf ]
Johan reported the below crash with test\_bpf on ppc64 e5500:
test\_bpf: #296 ALU\_END\_FROM\_LE 64: 0x0123456789abcdef -> 0x67452301 jited:1
Oops: Exception in kernel mode, sig: 4 [#1]
BE PAGE\_SIZE=4K SMP NR\_CPUS=24 QEMU e500
Modules linked in: test\_bpf(+)
CPU: 0 PID: 76 Comm: insmod Not tainted 5.14.0-03771-g98c2059e008a-dirty #1
NIP: 8000000000061c3c LR: 80000000006dea64 CTR: 8000000000061c18
REGS: c0000000032d3420 TRAP: 0700 Not tainted (5.14.0-03771-g98c2059e008a-dirty)
MSR: 0000000080089000  CR: 88002822 XER: 20000000 IRQMASK: 0
<...>
NIP [8000000000061c3c] 0x8000000000061c3c
LR [80000000006dea64] .\_\_run\_one+0x104/0x17c [test\_bpf]
Call Trace:
.\_\_run\_one+0x60/0x17c [test\_bpf] (unreliable)
.test\_bpf\_init+0x6a8/0xdc8 [test\_bpf]
.do\_one\_initcall+0x6c/0x28c
.do\_init\_module+0x68/0x28c
.load\_module+0x2460/0x2abc
.\_\_do\_sys\_init\_module+0x120/0x18c
.system\_call\_exception+0x110/0x1b8
system\_call\_common+0xf0/0x210
--- interrupt: c00 at 0x101d0acc
<...>
---[ end trace 47b2bf19090bb3d0 ]---
Illegal instruction
The illegal instruction turned out to be 'ldbrx' emitted for
BPF\_FROM\_[L|B]E, which was only introduced in ISA v2.06. Guard use of
the same and implement an alternative approach for older processors.
Fixes: 156d0e290e969c ("powerpc/ebpf/jit: Implement JIT compiler for extended BPF")
Reported-by: Johan Almbladh
Signed-off-by: Naveen N. Rao
Tested-by: Johan Almbladh
Acked-by: Johan Almbladh
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/d1e51c6fdf572062cf3009a751c3406bda01b832.1641468127.git.naveen.n.rao@linux.vnet.ibm.com
Signed-off-by: Sasha Levin
commit ca23c9d6e2f4aa072b69544112f63c2428ed1c56
Author: Chuck Lever
Date: Thu Jan 13 12:20:36 2022 -0500
SUNRPC: Don't dereference xprt->snd\_task if it's a cookie
[ Upstream commit aed28b7a2d620cb5cd0c554cb889075c02e25e8e ]
Fixes: e26d9972720e ("SUNRPC: Clean up scheduling of autoclose")
Signed-off-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 14c9086ea246b84e0d35e8a0b7f706202bd72f0a
Author: Marc Zyngier
Date: Fri Jan 14 08:57:58 2022 +0000
KVM: arm64: pkvm: Use the mm\_ops indirection for cache maintenance
[ Upstream commit 094d00f8ca58c5d29b25e23b4daaed1ff1f13b41 ]
CMOs issued from EL2 cannot directly use the kernel helpers,
as EL2 doesn't have a mapping of the guest pages. Oops.
Instead, use the mm\_ops indirection to use helpers that will
perform a mapping at EL2 and allow the CMO to be effective.
Fixes: 25aa28691bb9 ("KVM: arm64: Move guest CMOs to the fault handlers")
Reviewed-by: Quentin Perret
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20220114125038.1336965-1-maz@kernel.org
Signed-off-by: Sasha Levin
commit e2d4111a2c0be7d6a3493d143a68622b4947a4a6
Author: Trond Myklebust
Date: Wed Dec 15 16:38:16 2021 -0500
NFS: Ensure the server has an up to date ctime before renaming
[ Upstream commit 6ff9d99bb88faebf134ca668842349d9718e5464 ]
Renaming a file is required by POSIX to update the file ctime, so
ensure that the file data is synced to disk so that we don't clobber the
updated ctime by writing back after creating the hard link.
Fixes: f2c2c552f119 ("NFS: Move delegation recall into the NFSv4 callback for rename\_setup()")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 498286ab591ffee4bc788acd5b94dfb23050d0eb
Author: Trond Myklebust
Date: Wed Dec 15 16:38:15 2021 -0500
NFS: Ensure the server has an up to date ctime before hardlinking
[ Upstream commit 204975036b34f55237bc44c8a302a88468ef21b5 ]
Creating a hard link is required by POSIX to update the file ctime, so
ensure that the file data is synced to disk so that we don't clobber the
updated ctime by writing back after creating the hard link.
Fixes: 9f7682728728 ("NFS: Move the delegation return down into nfs4\_proc\_link()")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 930767717902381d5362d69d7d0436514c576e46
Author: Eric Dumazet
Date: Thu Jan 20 09:41:12 2022 -0800
ipv6: annotate accesses to fn->fn\_sernum
commit aafc2e3285c2d7a79b7ee15221c19fbeca7b1509 upstream.
struct fib6\_node's fn\_sernum field can be
read while other threads change it.
Add READ\_ONCE()/WRITE\_ONCE() annotations.
Do not change existing smp barriers in fib6\_get\_cookie\_safe()
and \_\_fib6\_update\_sernum\_upto\_root()
syzbot reported:
BUG: KCSAN: data-race in fib6\_clean\_node / inet6\_csk\_route\_socket
write to 0xffff88813df62e2c of 4 bytes by task 1920 on cpu 1:
fib6\_clean\_node+0xc2/0x260 net/ipv6/ip6\_fib.c:2178
fib6\_walk\_continue+0x38e/0x430 net/ipv6/ip6\_fib.c:2112
fib6\_walk net/ipv6/ip6\_fib.c:2160 [inline]
fib6\_clean\_tree net/ipv6/ip6\_fib.c:2240 [inline]
\_\_fib6\_clean\_all+0x1a9/0x2e0 net/ipv6/ip6\_fib.c:2256
fib6\_flush\_trees+0x6c/0x80 net/ipv6/ip6\_fib.c:2281
rt\_genid\_bump\_ipv6 include/net/net\_namespace.h:488 [inline]
addrconf\_dad\_completed+0x57f/0x870 net/ipv6/addrconf.c:4230
addrconf\_dad\_work+0x908/0x1170
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
worker\_thread+0x616/0xa70 kernel/workqueue.c:2454
kthread+0x1bf/0x1e0 kernel/kthread.c:359
ret\_from\_fork+0x1f/0x30
read to 0xffff88813df62e2c of 4 bytes by task 15701 on cpu 0:
fib6\_get\_cookie\_safe include/net/ip6\_fib.h:285 [inline]
rt6\_get\_cookie include/net/ip6\_fib.h:306 [inline]
ip6\_dst\_store include/net/ip6\_route.h:234 [inline]
inet6\_csk\_route\_socket+0x352/0x3c0 net/ipv6/inet6\_connection\_sock.c:109
inet6\_csk\_xmit+0x91/0x1e0 net/ipv6/inet6\_connection\_sock.c:121
\_\_tcp\_transmit\_skb+0x1323/0x1840 net/ipv4/tcp\_output.c:1402
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1420 [inline]
tcp\_write\_xmit+0x1450/0x4460 net/ipv4/tcp\_output.c:2680
\_\_tcp\_push\_pending\_frames+0x68/0x1c0 net/ipv4/tcp\_output.c:2864
tcp\_push+0x2d9/0x2f0 net/ipv4/tcp.c:725
mptcp\_push\_release net/mptcp/protocol.c:1491 [inline]
\_\_mptcp\_push\_pending+0x46c/0x490 net/mptcp/protocol.c:1578
mptcp\_sendmsg+0x9ec/0xa50 net/mptcp/protocol.c:1764
inet6\_sendmsg+0x5f/0x80 net/ipv6/af\_inet6.c:643
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg net/socket.c:725 [inline]
kernel\_sendmsg+0x97/0xd0 net/socket.c:745
sock\_no\_sendpage+0x84/0xb0 net/core/sock.c:3086
inet\_sendpage+0x9d/0xc0 net/ipv4/af\_inet.c:834
kernel\_sendpage+0x187/0x200 net/socket.c:3492
sock\_sendpage+0x5a/0x70 net/socket.c:1007
pipe\_to\_sendpage+0x128/0x160 fs/splice.c:364
splice\_from\_pipe\_feed fs/splice.c:418 [inline]
\_\_splice\_from\_pipe+0x207/0x500 fs/splice.c:562
splice\_from\_pipe fs/splice.c:597 [inline]
generic\_splice\_sendpage+0x94/0xd0 fs/splice.c:746
do\_splice\_from fs/splice.c:767 [inline]
direct\_splice\_actor+0x80/0xa0 fs/splice.c:936
splice\_direct\_to\_actor+0x345/0x650 fs/splice.c:891
do\_splice\_direct+0x106/0x190 fs/splice.c:979
do\_sendfile+0x675/0xc40 fs/read\_write.c:1245
\_\_do\_sys\_sendfile64 fs/read\_write.c:1310 [inline]
\_\_se\_sys\_sendfile64 fs/read\_write.c:1296 [inline]
\_\_x64\_sys\_sendfile64+0x102/0x140 fs/read\_write.c:1296
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
value changed: 0x0000026f -> 0x00000271
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 15701 Comm: syz-executor.2 Not tainted 5.16.0-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
The Fixes tag I chose is probably arbitrary, I do not think
we need to backport this patch to older kernels.
Fixes: c5cff8561d2d ("ipv6: add rcu grace period before freeing fib6\_node")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Link: https://lore.kernel.org/r/20220120174112.1126644-1-eric.dumazet@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 2b7e7df1eacd280e561ede3e977853606871c951
Author: José Expósito
Date: Sun Jan 16 19:18:44 2022 +0100
drm/msm/dsi: invalid parameter check in msm\_dsi\_phy\_enable
commit 5e761a2287234bc402ba7ef07129f5103bcd775c upstream.
The function performs a check on the "phy" input parameter, however, it
is used before the check.
Initialize the "dev" variable after the sanity check to avoid a possible
NULL pointer dereference.
Fixes: 5c8290284402b ("drm/msm/dsi: Split PHY drivers to separate files")
Addresses-Coverity-ID: 1493860 ("Null pointer dereference")
Signed-off-by: José Expósito
Reviewed-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20220116181844.7400-1-jose.exposito89@gmail.com
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 1c7c675f63e0140c76c440408d0f2445c705165f
Author: Miaoqian Lin
Date: Thu Dec 30 07:09:40 2021 +0000
drm/msm/dsi: Fix missing put\_device() call in dsi\_get\_phy
commit c04c3148ca12227d92f91b355b4538cc333c9922 upstream.
If of\_find\_device\_by\_node() succeeds, dsi\_get\_phy() doesn't
a corresponding put\_device(). Thus add put\_device() to fix the exception
handling.
Fixes: ec31abf ("drm/msm/dsi: Separate PHY to another platform device")
Signed-off-by: Miaoqian Lin
Reviewed-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20211230070943.18116-1-linmq006@gmail.com
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 4c55f12ed31fd1defa87fdfb3a12c5cbca4dd8ee
Author: Xianting Tian
Date: Wed Jan 12 20:33:34 2022 +0800
drm/msm: Fix wrong size calculation
commit 0a727b459ee39bd4c5ced19d6024258ac87b6b2e upstream.
For example, memory-region in .dts as below,
reg = <0x0 0x50000000 0x0 0x20000000>
We can get below values,
struct resource r;
r.start = 0x50000000;
r.end = 0x6fffffff;
So the size should be:
size = r.end - r.start + 1 = 0x20000000
Signed-off-by: Xianting Tian
Fixes: 072f1f9168ed ("drm/msm: add support for "stolen" mem")
Reviewed-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20220112123334.749776-1-xianting.tian@linux.alibaba.com
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 671ebb36709506d22b43e949ae1f7d448538dd0b
Author: Jianguo Wu
Date: Fri Jan 21 17:15:31 2022 +0800
net-procfs: show net devices bound packet types
commit 1d10f8a1f40b965d449e8f2d5ed7b96a7c138b77 upstream.
After commit:7866a621043f ("dev: add per net\_device packet type chains"),
we can not get packet types that are bound to a specified net device by
/proc/net/ptype, this patch fix the regression.
Run "tcpdump -i ens192 udp -nns0" Before and after apply this patch:
Before:
[root@localhost ~]# cat /proc/net/ptype
Type Device Function
0800 ip\_rcv
0806 arp\_rcv
86dd ipv6\_rcv
After:
[root@localhost ~]# cat /proc/net/ptype
Type Device Function
ALL ens192 tpacket\_rcv
0800 ip\_rcv
0806 arp\_rcv
86dd ipv6\_rcv
v1 -> v2:
- fix the regression rather than adding new /proc API as
suggested by Stephen Hemminger.
Fixes: 7866a621043f ("dev: add per net\_device packet type chains")
Signed-off-by: Jianguo Wu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 36a07159e335cd900946293bd5acb7b79f74235f
Author: Trond Myklebust
Date: Thu Jan 6 18:24:03 2022 -0500
NFSv4: nfs\_atomic\_open() can race when looking up a non-regular file
commit 1751fc1db36f6f411709e143d5393f92d12137a9 upstream.
If the file type changes back to being a regular file on the server
between the failed OPEN and our LOOKUP, then we need to re-run the OPEN.
Fixes: 0dd2b474d0b6 ("nfs: implement i\_op->atomic\_open()")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit f0583af88e7dd413229ea5e670a0db36fdf34ba2
Author: Trond Myklebust
Date: Thu Jan 6 18:24:02 2022 -0500
NFSv4: Handle case where the lookup of a directory fails
commit ac795161c93699d600db16c1a8cc23a65a1eceaf upstream.
If the application sets the O\_DIRECTORY flag, and tries to open a
regular file, nfs\_atomic\_open() will punt to doing a regular lookup.
If the server then returns a regular file, we will happily return a
file descriptor with uninitialised open state.
The fix is to return the expected ENOTDIR error in these cases.
Reported-by: Lyu Tao
Fixes: 0dd2b474d0b6 ("nfs: implement i\_op->atomic\_open()")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 06c6378f9d0015bbb4d443b5fd46bca36042099d
Author: Guenter Roeck
Date: Thu Jan 6 11:48:52 2022 -0800
hwmon: (lm90) Reduce maximum conversion rate for G781
[ Upstream commit a66c5ed539277b9f2363bbace0dba88b85b36c26 ]
According to its datasheet, G781 supports a maximum conversion rate value
of 8 (62.5 ms). However, chips labeled G781 and G780 were found to only
support a maximum conversion rate value of 7 (125 ms). On the other side,
chips labeled G781-1 and G784 were found to support a conversion rate value
of 8. There is no known means to distinguish G780 from G781 or G784; all
chips report the same manufacturer ID and chip revision.
Setting the conversion rate register value to 8 on chips not supporting
it causes unexpected behavior since the real conversion rate is set to 0
(16 seconds) if a value of 8 is written into the conversion rate register.
Limit the conversion rate register value to 7 for all G78x chips to avoid
the problem.
Fixes: ae544f64cc7b ("hwmon: (lm90) Add support for GMT G781")
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit 32ac95e4478f7aeb1d9f9539430361737eec8459
Author: Eric Dumazet
Date: Wed Jan 26 17:10:22 2022 -0800
ipv4: avoid using shared IP generator for connected sockets
commit 23f57406b82de51809d5812afd96f210f8b627f3 upstream.
ip\_select\_ident\_segs() has been very conservative about using
the connected socket private generator only for packets with IP\_DF
set, claiming it was needed for some VJ compression implementations.
As mentioned in this referenced document, this can be abused.
(Ref: Off-Path TCP Exploits of the Mixed IPID Assignment)
Before switching to pure random IPID generation and possibly hurt
some workloads, lets use the private inet socket generator.
Not only this will remove one vulnerability, this will also
improve performance of TCP flows using pmtudisc==IP\_PMTUDISC\_DONT
Fixes: 73f156a6e8c1 ("inetpeer: get rid of ip\_id\_count")
Signed-off-by: Eric Dumazet
Reviewed-by: David Ahern
Reported-by: Ray Che
Cc: Willy Tarreau
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 177770672a088a76ad62479900be6d7c0446b6bb
Author: Xin Long
Date: Sat Jan 22 06:40:56 2022 -0500
ping: fix the sk\_bound\_dev\_if match in ping\_lookup
commit 2afc3b5a31f9edf3ef0f374f5d70610c79c93a42 upstream.
When 'ping' changes to use PING socket instead of RAW socket by:
# sysctl -w net.ipv4.ping\_group\_range="0 100"
the selftests 'router\_broadcast.sh' will fail, as such command
# ip vrf exec vrf-h1 ping -I veth0 198.51.100.255 -b
can't receive the response skb by the PING socket. It's caused by mismatch
of sk\_bound\_dev\_if and dif in ping\_rcv() when looking up the PING socket,
as dif is vrf-h1 if dif's master was set to vrf-h1.
This patch is to fix this regression by also checking the sk\_bound\_dev\_if
against sdif so that the packets can stil be received even if the socket
is not bound to the vrf device but to the real iif.
Fixes: c319b4d76b9e ("net: ipv4: add IPPROTO\_ICMP socket kind")
Reported-by: Hangbin Liu
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 0ccc24fc1b25ceeb3d554f3aa7a2d9b0eb86c2ef
Author: Guenter Roeck
Date: Fri Jan 7 11:11:00 2022 -0800
hwmon: (lm90) Mark alert as broken for MAX6680
commit 94746b0ba479743355e0d3cc1cb9cfe3011fb8be upstream.
Experiments with MAX6680 and MAX6681 show that the alert function of those
chips is broken, similar to other chips supported by the lm90 driver.
Mark it accordingly.
Fixes: 4667bcb8d8fc ("hwmon: (lm90) Introduce chip parameter structure")
Signed-off-by: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 6724214a7bbff26b515041c8193d084149d85df4
Author: Guenter Roeck
Date: Fri Jan 7 12:36:41 2022 -0800
hwmon: (lm90) Mark alert as broken for MAX6646/6647/6649
commit f614629f9c1080dcc844a8430e3fb4c37ebbf05d upstream.
Experiments with MAX6646 and MAX6648 show that the alert function of those
chips is broken, similar to other chips supported by the lm90 driver.
Mark it accordingly.
Fixes: 4667bcb8d8fc ("hwmon: (lm90) Introduce chip parameter structure")
Signed-off-by: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
commit 839ec7039513a4f84bfbaff953a9393471176bee
Author: Congyu Liu
Date: Tue Jan 18 14:20:13 2022 -0500
net: fix information leakage in /proc/net/ptype
commit 47934e06b65637c88a762d9c98329ae6e3238888 upstream.
In one net namespace, after creating a packet socket without binding
it to a device, users in other net namespaces can observe the new
`packet\_type` added by this packet socket by reading `/proc/net/ptype`
file. This is minor information leakage as packet socket is
namespace aware.
Add a net pointer in `packet\_type` to keep the net namespace of
of corresponding packet socket. In `ptype\_seq\_show`, this net pointer
must be checked when it is not NULL.
Fixes: 2feb27dbe00c ("[NETNS]: Minor information leak via /proc/net/ptype file.")
Signed-off-by: Congyu Liu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit ba1863be105b06e10d0e2f6b1b8a0570801cfc71
Author: sparkhuang
Date: Wed Dec 15 10:08:23 2021 +0100
ARM: 9170/1: fix panic when kasan and kprobe are enabled
commit 8b59b0a53c840921b625378f137e88adfa87647e upstream.
arm32 uses software to simulate the instruction replaced
by kprobe. some instructions may be simulated by constructing
assembly functions. therefore, before executing instruction
simulation, it is necessary to construct assembly function
execution environment in C language through binding registers.
after kasan is enabled, the register binding relationship will
be destroyed, resulting in instruction simulation errors and
causing kernel panic.
the kprobe emulate instruction function is distributed in three
files: actions-common.c actions-arm.c actions-thumb.c, so disable
KASAN when compiling these files.
for example, use kprobe insert on cap\_capable+20 after kasan
enabled, the cap\_capable assembly code is as follows:
:
e92d47f0 push {r4, r5, r6, r7, r8, r9, sl, lr}
e1a05000 mov r5, r0
e280006c add r0, r0, #108 ; 0x6c
e1a04001 mov r4, r1
e1a06002 mov r6, r2
e59fa090 ldr sl, [pc, #144] ;
ebfc7bf8 bl c03aa4b4 <\_\_asan\_load4>
e595706c ldr r7, [r5, #108] ; 0x6c
e2859014 add r9, r5, #20
......
The emulate\_ldr assembly code after enabling kasan is as follows:
c06f1384 :
e92d47f0 push {r4, r5, r6, r7, r8, r9, sl, lr}
e282803c add r8, r2, #60 ; 0x3c
e1a05000 mov r5, r0
e7e37855 ubfx r7, r5, #16, #4
e1a00008 mov r0, r8
e1a09001 mov r9, r1
e1a04002 mov r4, r2
ebf35462 bl c03c6530 <\_\_asan\_load4>
e357000f cmp r7, #15
e7e36655 ubfx r6, r5, #12, #4
e205a00f and sl, r5, #15
0a000001 beq c06f13bc
e0840107 add r0, r4, r7, lsl #2
ebf3545c bl c03c6530 <\_\_asan\_load4>
e084010a add r0, r4, sl, lsl #2
ebf3545a bl c03c6530 <\_\_asan\_load4>
e2890010 add r0, r9, #16
ebf35458 bl c03c6530 <\_\_asan\_load4>
e5990010 ldr r0, [r9, #16]
e12fff30 blx r0
e356000f cm r6, #15
1a000014 bne c06f1430
e1a06000 mov r6, r0
e2840040 add r0, r4, #64 ; 0x40
......
when running in emulate\_ldr to simulate the ldr instruction, panic
occurred, and the log is as follows:
Unable to handle kernel NULL pointer dereference at virtual address
00000090
pgd = ecb46400
[00000090] \*pgd=2e0fa003, \*pmd=00000000
Internal error: Oops: 206 [#1] SMP ARM
PC is at cap\_capable+0x14/0xb0
LR is at emulate\_ldr+0x50/0xc0
psr: 600d0293 sp : ecd63af8 ip : 00000004 fp : c0a7c30c
r10: 00000000 r9 : c30897f4 r8 : ecd63cd4
r7 : 0000000f r6 : 0000000a r5 : e59fa090 r4 : ecd63c98
r3 : c06ae294 r2 : 00000000 r1 : b7611300 r0 : bf4ec008
Flags: nZCv IRQs off FIQs on Mode SVC\_32 ISA ARM Segment user
Control: 32c5387d Table: 2d546400 DAC: 55555555
Process bash (pid: 1643, stack limit = 0xecd60190)
(cap\_capable) from (kprobe\_handler+0x218/0x340)
(kprobe\_handler) from (kprobe\_trap\_handler+0x24/0x48)
(kprobe\_trap\_handler) from (do\_undefinstr+0x13c/0x364)
(do\_undefinstr) from (\_\_und\_svc\_finish+0x0/0x30)
(\_\_und\_svc\_finish) from (cap\_capable+0x18/0xb0)
(cap\_capable) from (cap\_vm\_enough\_memory+0x38/0x48)
(cap\_vm\_enough\_memory) from
(security\_vm\_enough\_memory\_mm+0x48/0x6c)
(security\_vm\_enough\_memory\_mm) from
(copy\_process.constprop.5+0x16b4/0x25c8)
(copy\_process.constprop.5) from (\_do\_fork+0xe8/0x55c)
(\_do\_fork) from (SyS\_clone+0x1c/0x24)
(SyS\_clone) from (\_\_sys\_trace\_return+0x0/0x10)
Code: 0050a0e1 6c0080e2 0140a0e1 0260a0e1 (f801f0e7)
Fixes: 35aa1df43283 ("ARM kprobes: instruction single-stepping support")
Fixes: 421015713b30 ("ARM: 9017/2: Enable KASan for ARM")
Signed-off-by: huangshaobo
Acked-by: Ard Biesheuvel
Signed-off-by: Russell King (Oracle)
Signed-off-by: Greg Kroah-Hartman
commit 184c4dc878b9355c21ea0641fd409f8587c09b09
Author: Ido Schimmel
Date: Thu Jan 20 10:05:46 2022 +0200
ipv6\_tunnel: Rate limit warning messages
commit 6cee105e7f2ced596373951d9ea08dacc3883c68 upstream.
The warning messages can be invoked from the data path for every packet
transmitted through an ip6gre netdev, leading to high CPU utilization.
Fix that by rate limiting the messages.
Fixes: 09c6bbf090ec ("[IPV6]: Do mandatory IPv6 tunnel endpoint checks in realtime")
Reported-by: Maksym Yaremchuk
Tested-by: Maksym Yaremchuk
Signed-off-by: Ido Schimmel
Reviewed-by: Amit Cohen
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit ace7b6ef41251c5fe47f629a9a922382fb7b0a6b
Author: John Meneghini
Date: Fri Jan 14 23:00:44 2022 -0500
scsi: bnx2fc: Flush destroy\_work queue before calling bnx2fc\_interface\_put()
commit 847f9ea4c5186fdb7b84297e3eeed9e340e83fce upstream.
The bnx2fc\_destroy() functions are removing the interface before calling
destroy\_work. This results multiple WARNings from sysfs\_remove\_group() as
the controller rport device attributes are removed too early.
Replace the fcoe\_port's destroy\_work queue. It's not needed.
The problem is easily reproducible with the following steps.
Example:
$ dmesg -w &
$ systemctl enable --now fcoe
$ fipvlan -s -c ens2f1
$ fcoeadm -d ens2f1.802
[ 583.464488] host2: libfc: Link down on port (7500a1)
[ 583.472651] bnx2fc: 7500a1 - rport not created Yet!!
[ 583.490468] ------------[ cut here ]------------
[ 583.538725] sysfs group 'power' not found for kobject 'rport-2:0-0'
[ 583.568814] WARNING: CPU: 3 PID: 192 at fs/sysfs/group.c:279 sysfs\_remove\_group+0x6f/0x80
[ 583.607130] Modules linked in: dm\_service\_time 8021q garp mrp stp llc bnx2fc cnic uio rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 ...
[ 583.942994] CPU: 3 PID: 192 Comm: kworker/3:2 Kdump: loaded Not tainted 5.14.0-39.el9.x86\_64 #1
[ 583.984105] Hardware name: HP ProLiant DL120 G7, BIOS J01 07/01/2013
[ 584.016535] Workqueue: fc\_wq\_2 fc\_rport\_final\_delete [scsi\_transport\_fc]
[ 584.050691] RIP: 0010:sysfs\_remove\_group+0x6f/0x80
[ 584.074725] Code: ff 5b 48 89 ef 5d 41 5c e9 ee c0 ff ff 48 89 ef e8 f6 b8 ff ff eb d1 49 8b 14 24 48 8b 33 48 c7 c7 ...
[ 584.162586] RSP: 0018:ffffb567c15afdc0 EFLAGS: 00010282
[ 584.188225] RAX: 0000000000000000 RBX: ffffffff8eec4220 RCX: 0000000000000000
[ 584.221053] RDX: ffff8c1586ce84c0 RSI: ffff8c1586cd7cc0 RDI: ffff8c1586cd7cc0
[ 584.255089] RBP: 0000000000000000 R08: 0000000000000000 R09: ffffb567c15afc00
[ 584.287954] R10: ffffb567c15afbf8 R11: ffffffff8fbe7f28 R12: ffff8c1486326400
[ 584.322356] R13: ffff8c1486326480 R14: ffff8c1483a4a000 R15: 0000000000000004
[ 584.355379] FS: 0000000000000000(0000) GS:ffff8c1586cc0000(0000) knlGS:0000000000000000
[ 584.394419] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 584.421123] CR2: 00007fe95a6f7840 CR3: 0000000107674002 CR4: 00000000000606e0
[ 584.454888] Call Trace:
[ 584.466108] device\_del+0xb2/0x3e0
[ 584.481701] device\_unregister+0x13/0x60
[ 584.501306] bsg\_unregister\_queue+0x5b/0x80
[ 584.522029] bsg\_remove\_queue+0x1c/0x40
[ 584.541884] fc\_rport\_final\_delete+0xf3/0x1d0 [scsi\_transport\_fc]
[ 584.573823] process\_one\_work+0x1e3/0x3b0
[ 584.592396] worker\_thread+0x50/0x3b0
[ 584.609256] ? rescuer\_thread+0x370/0x370
[ 584.628877] kthread+0x149/0x170
[ 584.643673] ? set\_kthread\_struct+0x40/0x40
[ 584.662909] ret\_from\_fork+0x22/0x30
[ 584.680002] ---[ end trace 53575ecefa942ece ]---
Link: https://lore.kernel.org/r/20220115040044.1013475-1-jmeneghi@redhat.com
Fixes: 0cbf32e1681d ("[SCSI] bnx2fc: Avoid calling bnx2fc\_if\_destroy with unnecessary locks")
Tested-by: Guangwu Zhang
Co-developed-by: Maurizio Lombardi
Signed-off-by: Maurizio Lombardi
Signed-off-by: John Meneghini
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 960f0584ddc15b5c2fce2f91b7e1b2f820d4382f
Author: Yang Yingliang
Date: Tue Jan 11 09:24:41 2022 +0800
scsi: elx: efct: Don't use GFP\_KERNEL under spin lock
commit 61263b3a11a2594b4e898f166c31162236182b5c upstream.
GFP\_KERNEL/GFP\_DMA can't be used under a spin lock. According the comment,
els\_ios\_lock is used to protect els ios list so we can move down the spin
lock to avoid using this flag under the lock.
Link: https://lore.kernel.org/r/20220111012441.3232527-1-yangyingliang@huawei.com
Fixes: 8f406ef72859 ("scsi: elx: libefc: Extended link Service I/O handling")
Reported-by: Hulk Robot
Reviewed-by: James Smart
Signed-off-by: Yang Yingliang
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 36e3b3ff1b4f07c20e2b064f43df0fb5b7785688
Author: Matthias Kaehlcke
Date: Mon Jan 10 10:47:37 2022 -0800
rpmsg: char: Fix race between the release of rpmsg\_eptdev and cdev
commit 7a534ae89e34e9b51acb5a63dd0f88308178b46a upstream.
struct rpmsg\_eptdev contains a struct cdev. The current code frees
the rpmsg\_eptdev struct in rpmsg\_eptdev\_destroy(), but the cdev is
a managed object, therefore its release is not predictable and the
rpmsg\_eptdev could be freed before the cdev is entirely released.
The cdev\_device\_add/del() API was created to address this issue
(see commit '233ed09d7fda ("chardev: add helper function to register
char devs with a struct device")'), use it instead of cdev add/del().
Fixes: c0cdc19f84a4 ("rpmsg: Driver for user space endpoint interface")
Suggested-by: Bjorn Andersson
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Mathieu Poirier
Reviewed-by: Stephen Boyd
Reviewed-by: Bjorn Andersson
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20220110104706.v6.2.Idde68b05b88d4a2e6e54766c653f3a6d9e419ce6@changeid
Signed-off-by: Greg Kroah-Hartman
commit d6cdc6ae542845d4d0ac8b6d99362bde7042a3c7
Author: Sujit Kautkar
Date: Mon Jan 10 10:47:36 2022 -0800
rpmsg: char: Fix race between the release of rpmsg\_ctrldev and cdev
commit b7fb2dad571d1e21173c06cef0bced77b323990a upstream.
struct rpmsg\_ctrldev contains a struct cdev. The current code frees
the rpmsg\_ctrldev struct in rpmsg\_ctrldev\_release\_device(), but the
cdev is a managed object, therefore its release is not predictable
and the rpmsg\_ctrldev could be freed before the cdev is entirely
released, as in the backtrace below.
[ 93.625603] ODEBUG: free active (active state 0) object type: timer\_list hint: delayed\_work\_timer\_fn+0x0/0x7c
[ 93.636115] WARNING: CPU: 0 PID: 12 at lib/debugobjects.c:488 debug\_print\_object+0x13c/0x1b0
[ 93.644799] Modules linked in: veth xt\_cgroup xt\_MASQUERADE rfcomm algif\_hash algif\_skcipher af\_alg uinput ip6table\_nat fuse uvcvideo videobuf2\_vmalloc venus\_enc venus\_dec videobuf2\_dma\_contig hci\_uart btandroid btqca snd\_soc\_rt5682\_i2c bluetooth qcom\_spmi\_temp\_alarm snd\_soc\_rt5682v
[ 93.715175] CPU: 0 PID: 12 Comm: kworker/0:1 Tainted: G B 5.4.163-lockdep #26
[ 93.723855] Hardware name: Google Lazor (rev3 - 8) with LTE (DT)
[ 93.730055] Workqueue: events kobject\_delayed\_cleanup
[ 93.735271] pstate: 60c00009 (nZCv daif +PAN +UAO)
[ 93.740216] pc : debug\_print\_object+0x13c/0x1b0
[ 93.744890] lr : debug\_print\_object+0x13c/0x1b0
[ 93.749555] sp : ffffffacf5bc7940
[ 93.752978] x29: ffffffacf5bc7940 x28: dfffffd000000000
[ 93.758448] x27: ffffffacdb11a800 x26: dfffffd000000000
[ 93.763916] x25: ffffffd0734f856c x24: dfffffd000000000
[ 93.769389] x23: 0000000000000000 x22: ffffffd0733c35b0
[ 93.774860] x21: ffffffd0751994a0 x20: ffffffd075ec27c0
[ 93.780338] x19: ffffffd075199100 x18: 00000000000276e0
[ 93.785814] x17: 0000000000000000 x16: dfffffd000000000
[ 93.791291] x15: ffffffffffffffff x14: 6e6968207473696c
[ 93.796768] x13: 0000000000000000 x12: ffffffd075e2b000
[ 93.802244] x11: 0000000000000001 x10: 0000000000000000
[ 93.807723] x9 : d13400dff1921900 x8 : d13400dff1921900
[ 93.813200] x7 : 0000000000000000 x6 : 0000000000000000
[ 93.818676] x5 : 0000000000000080 x4 : 0000000000000000
[ 93.824152] x3 : ffffffd0732a0fa4 x2 : 0000000000000001
[ 93.829628] x1 : ffffffacf5bc7580 x0 : 0000000000000061
[ 93.835104] Call trace:
[ 93.837644] debug\_print\_object+0x13c/0x1b0
[ 93.841963] \_\_debug\_check\_no\_obj\_freed+0x25c/0x3c0
[ 93.846987] debug\_check\_no\_obj\_freed+0x18/0x20
[ 93.851669] slab\_free\_freelist\_hook+0xbc/0x1e4
[ 93.856346] kfree+0xfc/0x2f4
[ 93.859416] rpmsg\_ctrldev\_release\_device+0x78/0xb8
[ 93.864445] device\_release+0x84/0x168
[ 93.868310] kobject\_cleanup+0x12c/0x298
[ 93.872356] kobject\_delayed\_cleanup+0x10/0x18
[ 93.876948] process\_one\_work+0x578/0x92c
[ 93.881086] worker\_thread+0x804/0xcf8
[ 93.884963] kthread+0x2a8/0x314
[ 93.888303] ret\_from\_fork+0x10/0x18
The cdev\_device\_add/del() API was created to address this issue (see
commit '233ed09d7fda ("chardev: add helper function to register char
devs with a struct device")'), use it instead of cdev add/del().
Fixes: c0cdc19f84a4 ("rpmsg: Driver for user space endpoint interface")
Signed-off-by: Sujit Kautkar
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Mathieu Poirier
Reviewed-by: Bjorn Andersson
Reviewed-by: Stephen Boyd
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20220110104706.v6.1.Iaac908f3e3149a89190ce006ba166e2d3fd247a3@changeid
Signed-off-by: Greg Kroah-Hartman
commit bad4b11b8e01d4e97b38aa742c26e7ad0ea962a9
Author: Linyu Yuan
Date: Mon Jan 10 20:43:28 2022 +0800
usb: roles: fix include/linux/usb/role.h compile issue
commit 945c37ed564770c78dfe6b9f08bed57a1b4e60ef upstream.
when CONFIG\_USB\_ROLE\_SWITCH is not defined,
add usb\_role\_switch\_find\_by\_fwnode() definition which return NULL.
Fixes: c6919d5e0cd1 ("usb: roles: Add usb\_role\_switch\_find\_by\_fwnode()")
Signed-off-by: Linyu Yuan
Link: https://lore.kernel.org/r/1641818608-25039-1-git-send-email-quic\_linyyuan@quicinc.com
Signed-off-by: Greg Kroah-Hartman
commit 3d8e5859639b6f6371a17b94c99b8640fbeefa94
Author: Joe Damato
Date: Wed Dec 8 17:56:33 2021 -0800
i40e: fix unsigned stat widths
commit 3b8428b84539c78fdc8006c17ebd25afd4722d51 upstream.
Change i40e\_update\_vsi\_stats and struct i40e\_vsi to use u64 fields to match
the width of the stats counters in struct i40e\_rx\_queue\_stats.
Update debugfs code to use the correct format specifier for u64.
Fixes: 41c445ff0f48 ("i40e: main driver core")
Signed-off-by: Joe Damato
Reported-by: kernel test robot
Tested-by: Gurucharan G
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit fff687f44c7aae70117c54774ea531cb8daaf476
Author: Karen Sornek
Date: Thu Dec 2 12:52:01 2021 +0100
i40e: Fix for failed to init adminq while VF reset
commit 0f344c8129a5337dae50e31b817dd50a60ff238c upstream.
Fix for failed to init adminq: -53 while VF is resetting via MAC
address changing procedure.
Added sync module to avoid reading deadbeef value in reinit adminq
during software reset.
Without this patch it is possible to trigger VF reset procedure
during reinit adminq. This resulted in an incorrect reading of
value from the AQP registers and generated the -53 error.
Fixes: 5c3c48ac6bf5 ("i40e: implement virtual device interface")
Signed-off-by: Grzegorz Szczurek
Signed-off-by: Karen Sornek
Tested-by: Konrad Jankowski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 4b3aa858268b7b9aeef02e5f9c4cd8f8fac101c8
Author: Sylwester Dziedziuch
Date: Fri Nov 26 11:11:22 2021 +0100
i40e: Fix queues reservation for XDP
commit 92947844b8beee988c0ce17082b705c2f75f0742 upstream.
When XDP was configured on a system with large number of CPUs
and X722 NIC there was a call trace with NULL pointer dereference.
i40e 0000:87:00.0: failed to get tracking for 256 queues for VSI 0 err -12
i40e 0000:87:00.0: setup of MAIN VSI failed
BUG: kernel NULL pointer dereference, address: 0000000000000000
RIP: 0010:i40e\_xdp+0xea/0x1b0 [i40e]
Call Trace:
? i40e\_reconfig\_rss\_queues+0x130/0x130 [i40e]
dev\_xdp\_install+0x61/0xe0
dev\_xdp\_attach+0x18a/0x4c0
dev\_change\_xdp\_fd+0x1e6/0x220
do\_setlink+0x616/0x1030
? ahci\_port\_stop+0x80/0x80
? ata\_qc\_issue+0x107/0x1e0
? lock\_timer\_base+0x61/0x80
? \_\_mod\_timer+0x202/0x380
rtnl\_setlink+0xe5/0x170
? bpf\_lsm\_binder\_transaction+0x10/0x10
? security\_capable+0x36/0x50
rtnetlink\_rcv\_msg+0x121/0x350
? rtnl\_calcit.isra.0+0x100/0x100
netlink\_rcv\_skb+0x50/0xf0
netlink\_unicast+0x1d3/0x2a0
netlink\_sendmsg+0x22a/0x440
sock\_sendmsg+0x5e/0x60
\_\_sys\_sendto+0xf0/0x160
? \_\_sys\_getsockname+0x7e/0xc0
? \_copy\_from\_user+0x3c/0x80
? \_\_sys\_setsockopt+0xc8/0x1a0
\_\_x64\_sys\_sendto+0x20/0x30
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f83fa7a39e0
This was caused by PF queue pile fragmentation due to
flow director VSI queue being placed right after main VSI.
Because of this main VSI was not able to resize its
queue allocation for XDP resulting in no queues allocated
for main VSI when XDP was turned on.
Fix this by always allocating last queue in PF queue pile
for a flow director VSI.
Fixes: 41c445ff0f48 ("i40e: main driver core")
Fixes: 74608d17fe29 ("i40e: add support for XDP\_TX action")
Signed-off-by: Sylwester Dziedziuch
Signed-off-by: Mateusz Palczewski
Reviewed-by: Maciej Fijalkowski
Tested-by: Kiran Bhandare
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 987aca1c7914e11c126dfdf095f8c53b78549f4e
Author: Jedrzej Jagielski
Date: Fri Nov 5 11:17:00 2021 +0000
i40e: Fix issue when maximum queues is exceeded
commit d701658a50a471591094b3eb3961b4926cc8f104 upstream.
Before this patch VF interface vanished when
maximum queue number was exceeded. Driver tried
to add next queues even if there was not enough
space. PF sent incorrect number of queues to
the VF when there were not enough of them.
Add an additional condition introduced to check
available space in 'qp\_pile' before proceeding.
This condition makes it impossible to add queues
if they number is greater than the number resulting
from available space.
Also add the search for free space in PF queue
pair piles.
Without this patch VF interfaces are not seen
when available space for queues has been
exceeded and following logs appears permanently
in dmesg:
"Unable to get VF config (-32)".
"VF 62 failed opcode 3, retval: -5"
"Unable to get VF config due to PF error condition, not retrying"
Fixes: 7daa6bf3294e ("i40e: driver core headers")
Fixes: 41c445ff0f48 ("i40e: main driver core")
Signed-off-by: Jaroslaw Gawin
Signed-off-by: Slawomir Laba
Signed-off-by: Jedrzej Jagielski
Tested-by: Konrad Jankowski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 70889ca040f5caacb16053de5c4ab7d7f466a360
Author: Jedrzej Jagielski
Date: Thu Oct 28 13:51:14 2021 +0000
i40e: Increase delay to 1 s after global EMP reset
commit 9b13bd53134c9ddd544a790125199fdbdb505e67 upstream.
Recently simplified i40e\_rebuild causes that FW sometimes
is not ready after NVM update, the ping does not return.
Increase the delay in case of EMP reset.
Old delay of 300 ms was introduced for specific cards for 710 series.
Now it works for all the cards and delay was increased.
Fixes: 1fa51a650e1d ("i40e: Add delay after EMP reset for firmware to recover")
Signed-off-by: Arkadiusz Kubalewski
Signed-off-by: Jedrzej Jagielski
Tested-by: Gurucharan G
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit edc4c8f18592451b97cc55e99010ef0d6a6b80a4
Author: Christophe Leroy
Date: Wed Dec 22 13:07:31 2021 +0000
powerpc/32: Fix boot failure with GCC latent entropy plugin
commit bba496656a73fc1d1330b49c7f82843836e9feb1 upstream.
Boot fails with GCC latent entropy plugin enabled.
This is due to early boot functions trying to access 'latent\_entropy'
global data while the kernel is not relocated at its final
destination yet.
As there is no way to tell GCC to use PTRRELOC() to access it,
disable latent entropy plugin in early\_32.o and feature-fixups.o and
code-patching.o
Fixes: 38addce8b600 ("gcc-plugins: Add latent\_entropy plugin")
Cc: stable@vger.kernel.org # v4.9+
Reported-by: Erhard Furtner
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215217
Link: https://lore.kernel.org/r/2bac55483b8daf5b1caa163a45fa5f9cdbe18be4.1640178426.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit d324727b0e5ae74cd5cd097cff37de627423a264
Author: Christophe Leroy
Date: Mon Jan 10 15:29:25 2022 +0000
powerpc/32s: Fix kasan\_init\_region() for KASAN
commit d37823c3528e5e0705fc7746bcbc2afffb619259 upstream.
It has been reported some configuration where the kernel doesn't
boot with KASAN enabled.
This is due to wrong BAT allocation for the KASAN area:
---[ Data Block Address Translation ]---
0: 0xc0000000-0xcfffffff 0x00000000 256M Kernel rw m
1: 0xd0000000-0xdfffffff 0x10000000 256M Kernel rw m
2: 0xe0000000-0xefffffff 0x20000000 256M Kernel rw m
3: 0xf8000000-0xf9ffffff 0x2a000000 32M Kernel rw m
4: 0xfa000000-0xfdffffff 0x2c000000 64M Kernel rw m
A BAT must have both virtual and physical addresses alignment matching
the size of the BAT. This is not the case for BAT 4 above.
Fix kasan\_init\_region() by using block\_size() function that is in
book3s32/mmu.c. To be able to reuse it here, make it non static and
change its name to bat\_block\_size() in order to avoid name conflict
with block\_size() defined in
Also reuse find\_free\_bat() to avoid an error message from setbat()
when no BAT is available.
And allocate memory outside of linear memory mapping to avoid
wasting that precious space.
With this change we get correct alignment for BATs and KASAN shadow
memory is allocated outside the linear memory space.
---[ Data Block Address Translation ]---
0: 0xc0000000-0xcfffffff 0x00000000 256M Kernel rw
1: 0xd0000000-0xdfffffff 0x10000000 256M Kernel rw
2: 0xe0000000-0xefffffff 0x20000000 256M Kernel rw
3: 0xf8000000-0xfbffffff 0x7c000000 64M Kernel rw
4: 0xfc000000-0xfdffffff 0x7a000000 32M Kernel rw
Fixes: 7974c4732642 ("powerpc/32s: Implement dedicated kasan\_init\_region()")
Cc: stable@vger.kernel.org
Reported-by: Maxime Bizon
Signed-off-by: Christophe Leroy
Tested-by: Maxime Bizon
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/7a50ef902494d1325227d47d33dada01e52e5518.1641818726.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 2910254ad596a2e0815f7093d6df8d25d23a2e18
Author: Christophe Leroy
Date: Fri Nov 26 13:40:35 2021 +0100
powerpc/32s: Allocate one 256k IBAT instead of two consecutives 128k IBATs
commit 37eb7ca91b692e8e49e7dd50158349a6c8fb5b09 upstream.
Today we have the following IBATs allocated:
---[ Instruction Block Address Translation ]---
0: 0xc0000000-0xc03fffff 0x00000000 4M Kernel x m
1: 0xc0400000-0xc05fffff 0x00400000 2M Kernel x m
2: 0xc0600000-0xc06fffff 0x00600000 1M Kernel x m
3: 0xc0700000-0xc077ffff 0x00700000 512K Kernel x m
4: 0xc0780000-0xc079ffff 0x00780000 128K Kernel x m
5: 0xc07a0000-0xc07bffff 0x007a0000 128K Kernel x m
6: -
7: -
The two 128K should be a single 256K instead.
When \_etext is not aligned to 128Kbytes, the system will allocate
all necessary BATs to the lower 128Kbytes boundary, then allocate
an additional 128Kbytes BAT for the remaining block.
Instead, align the top to 128Kbytes so that the function directly
allocates a 256Kbytes last block:
---[ Instruction Block Address Translation ]---
0: 0xc0000000-0xc03fffff 0x00000000 4M Kernel x m
1: 0xc0400000-0xc05fffff 0x00400000 2M Kernel x m
2: 0xc0600000-0xc06fffff 0x00600000 1M Kernel x m
3: 0xc0700000-0xc077ffff 0x00700000 512K Kernel x m
4: 0xc0780000-0xc07bffff 0x00780000 256K Kernel x m
5: -
6: -
7: -
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/ab58b296832b0ec650e2203200e060adbcb2677d.1637930421.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 865c08c6a55e548b1c39a58330be176f44383cde
Author: Tony Luck
Date: Fri Jan 21 09:47:38 2022 -0800
x86/cpu: Add Xeon Icelake-D to list of CPUs that support PPIN
commit e464121f2d40eabc7d11823fb26db807ce945df4 upstream.
Missed adding the Icelake-D CPU to the list. It uses the same MSRs
to control and read the inventory number as all the other models.
Fixes: dc6b025de95b ("x86/mce: Add Xeon Icelake to list of CPUs that support PPIN")
Reported-by: Ailin Xu
Signed-off-by: Tony Luck
Signed-off-by: Borislav Petkov
Cc:
Link: https://lore.kernel.org/r/20220121174743.1875294-2-tony.luck@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 757c8da2b3592da48d43ff0abea4cd759133afc3
Author: Yazen Ghannam
Date: Mon Jan 17 16:13:28 2022 +0000
x86/MCE/AMD: Allow thresholding interface updates after init
commit 1f52b0aba6fd37653416375cb8a1ca673acf8d5f upstream.
Changes to the AMD Thresholding sysfs code prevents sysfs writes from
updating the underlying registers once CPU init is completed, i.e.
"threshold\_banks" is set.
Allow the registers to be updated if the thresholding interface is
already initialized or if in the init path. Use the "set\_lvt\_off" value
to indicate if running in the init path, since this value is only set
during init.
Fixes: a037f3ca0ea0 ("x86/mce/amd: Make threshold bank setting hotplug robust")
Signed-off-by: Yazen Ghannam
Signed-off-by: Borislav Petkov
Cc:
Link: https://lore.kernel.org/r/20220117161328.19148-1-yazen.ghannam@amd.com
Signed-off-by: Greg Kroah-Hartman
commit 0b8ec4e942f38d1934447b9d6ae373a0261f7e9e
Author: Bjorn Helgaas
Date: Wed Jan 26 09:40:01 2022 -0600
PCI/sysfs: Find shadow ROM before static attribute initialization
commit 66d28b21fe6b3da8d1e9f0a7ba38bc61b6c547e1 upstream.
Ville reported that the sysfs "rom" file for VGA devices disappeared after
527139d738d7 ("PCI/sysfs: Convert "rom" to static attribute").
Prior to 527139d738d7, FINAL fixups, including pci\_fixup\_video() where we
find shadow ROMs, were run before pci\_create\_sysfs\_dev\_files() created the
sysfs "rom" file.
After 527139d738d7, "rom" is a static attribute and is created before FINAL
fixups are run, so we didn't create "rom" files for shadow ROMs:
acpi\_pci\_root\_add
...
pci\_scan\_single\_device
pci\_device\_add
pci\_fixup\_video # <-- new HEADER fixup
device\_add
...
if (grp->is\_visible())
pci\_dev\_rom\_attr\_is\_visible # after 527139d738d7
pci\_bus\_add\_devices
pci\_bus\_add\_device
pci\_fixup\_device(pci\_fixup\_final)
pci\_fixup\_video # <-- previous FINAL fixup
pci\_create\_sysfs\_dev\_files
if (pci\_resource\_len(pdev, PCI\_ROM\_RESOURCE))
sysfs\_create\_bin\_file("rom") # before 527139d738d7
Change pci\_fixup\_video() to be a HEADER fixup so it runs before sysfs
static attributes are initialized.
Rename the Loongson pci\_fixup\_radeon() to pci\_fixup\_video() and make its
dmesg logging identical to the others since it is doing the same job.
Link: https://lore.kernel.org/r/YbxqIyrkv3GhZVxx@intel.com
Fixes: 527139d738d7 ("PCI/sysfs: Convert "rom" to static attribute")
Link: https://lore.kernel.org/r/20220126154001.16895-1-helgaas@kernel.org
Reported-by: Ville Syrjälä
Tested-by: Ville Syrjälä
Signed-off-by: Bjorn Helgaas
Cc: stable@vger.kernel.org # v5.13+
Cc: Huacai Chen
Cc: Jiaxun Yang
Cc: Thomas Bogendoerfer
Cc: Thomas Gleixner
Cc: Ingo Molnar
Cc: Borislav Petkov
Cc: Dave Hansen
Cc: Krzysztof Wilczyński
Signed-off-by: Greg Kroah-Hartman
commit 9d2245815b4abc1a7b255fc472ac91b48d470088
Author: Mathieu Desnoyers
Date: Mon Jan 17 15:30:10 2022 -0500
sched/membarrier: Fix membarrier-rseq fence command missing from query bitmask
commit 809232619f5b15e31fb3563985e705454f32621f upstream.
The membarrier command MEMBARRIER\_CMD\_QUERY allows querying the
available membarrier commands. When the membarrier-rseq fence commands
were added, a new MEMBARRIER\_CMD\_PRIVATE\_EXPEDITED\_RSEQ\_BITMASK was
introduced with the intent to expose them with the MEMBARRIER\_CMD\_QUERY
command, the but it was never added to MEMBARRIER\_CMD\_BITMASK.
The membarrier-rseq fence commands are therefore not wired up with the
query command.
Rename MEMBARRIER\_CMD\_PRIVATE\_EXPEDITED\_RSEQ\_BITMASK to
MEMBARRIER\_PRIVATE\_EXPEDITED\_RSEQ\_BITMASK (the bitmask is not a command
per-se), and change the erroneous
MEMBARRIER\_CMD\_REGISTER\_PRIVATE\_EXPEDITED\_RSEQ\_BITMASK (which does not
actually exist) to MEMBARRIER\_CMD\_REGISTER\_PRIVATE\_EXPEDITED\_RSEQ.
Wire up MEMBARRIER\_PRIVATE\_EXPEDITED\_RSEQ\_BITMASK in
MEMBARRIER\_CMD\_BITMASK. Fixing this allows discovering availability of
the membarrier-rseq fence feature.
Fixes: 2a36ab717e8f ("rseq/membarrier: Add MEMBARRIER\_CMD\_PRIVATE\_EXPEDITED\_RSEQ")
Signed-off-by: Mathieu Desnoyers
Signed-off-by: Peter Zijlstra (Intel)
Cc:  # 5.10+
Link: https://lkml.kernel.org/r/20220117203010.30129-1-mathieu.desnoyers@efficios.com
Signed-off-by: Greg Kroah-Hartman
commit ca2dafd4cb6fbe7b796011301eae1827040f39f0
Author: Joseph Qi
Date: Sat Jan 29 13:41:27 2022 -0800
ocfs2: fix a deadlock when commit trans
commit ddf4b773aa40790dfa936bd845c18e735a49c61c upstream.
commit 6f1b228529ae introduces a regression which can deadlock as
follows:
Task1: Task2:
jbd2\_journal\_commit\_transaction ocfs2\_test\_bg\_bit\_allocatable
spin\_lock(&jh->b\_state\_lock) jbd\_lock\_bh\_journal\_head
\_\_jbd2\_journal\_remove\_checkpoint spin\_lock(&jh->b\_state\_lock)
jbd2\_journal\_put\_journal\_head
jbd\_lock\_bh\_journal\_head
Task1 and Task2 lock bh->b\_state and jh->b\_state\_lock in different
order, which finally result in a deadlock.
So use jbd2\_journal\_[grab|put]\_journal\_head instead in
ocfs2\_test\_bg\_bit\_allocatable() to fix it.
Link: https://lkml.kernel.org/r/20220121071205.100648-3-joseph.qi@linux.alibaba.com
Fixes: 6f1b228529ae ("ocfs2: fix race between searching chunks and release journal\_head from buffer\_head")
Signed-off-by: Joseph Qi
Reported-by: Gautham Ananthakrishna
Tested-by: Gautham Ananthakrishna
Reported-by: Saeed Mirzamohammadi
Cc: "Theodore Ts'o"
Cc: Andreas Dilger
Cc: Changwei Ge
Cc: Gang He
Cc: Joel Becker
Cc: Jun Piao
Cc: Junxiao Bi
Cc: Mark Fasheh
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 8cfdaaa4d6d166cfbfa5fd9cde6942e0ea4b25ba
Author: Joseph Qi
Date: Sat Jan 29 13:41:23 2022 -0800
jbd2: export jbd2\_journal\_[grab|put]\_journal\_head
commit 4cd1103d8c66b2cdb7e64385c274edb0ac5e8887 upstream.
Patch series "ocfs2: fix a deadlock case".
This fixes a deadlock case in ocfs2. We firstly export jbd2 symbols
jbd2\_journal\_[grab|put]\_journal\_head as preparation and later use them
in ocfs2 insread of jbd\_[lock|unlock]\_bh\_journal\_head to fix the
deadlock.
This patch (of 2):
This exports symbols jbd2\_journal\_[grab|put]\_journal\_head, which will be
used outside modules, e.g. ocfs2.
Link: https://lkml.kernel.org/r/20220121071205.100648-2-joseph.qi@linux.alibaba.com
Signed-off-by: Joseph Qi
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Junxiao Bi
Cc: Changwei Ge
Cc: Gang He
Cc: Jun Piao
Cc: Andreas Dilger
Cc: Gautham Ananthakrishna
Cc: Saeed Mirzamohammadi
Cc: "Theodore Ts'o"
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit dd22253c13d2795c566f52c30f1dba48d51c482d
Author: Peter Collingbourne
Date: Sat Jan 29 13:41:14 2022 -0800
mm, kasan: use compare-exchange operation to set KASAN page tag
commit 27fe73394a1c6d0b07fa4d95f1bca116d1cc66e9 upstream.
It has been reported that the tag setting operation on newly-allocated
pages can cause the page flags to be corrupted when performed
concurrently with other flag updates as a result of the use of
non-atomic operations.
Fix the problem by using a compare-exchange loop to update the tag.
Link: https://lkml.kernel.org/r/20220120020148.1632253-1-pcc@google.com
Link: https://linux-review.googlesource.com/id/I456b24a2b9067d93968d43b4bb3351c0cec63101
Fixes: 2813b9c02962 ("kasan, mm, arm64: tag non slab memory allocated via pagealloc")
Signed-off-by: Peter Collingbourne
Reviewed-by: Andrey Konovalov
Cc: Peter Zijlstra
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 1cd8a5d24477c308c9e6f3bb1a8ce61fca1ed411
Author: Lorenzo Bianconi
Date: Thu Dec 9 14:06:27 2021 +0100
mt76: connac: introduce MCU\_CE\_CMD macro
commit 680a2ead741ad9b479a53adf154ed5eee74d2b9a upstream.
Similar to MCU\_EXT\_CMD, introduce MCU\_CE\_CMD for CE commands
Stable kernel notes:
Upstream commit 547224024579 (mt76: connac: introduce MCU\_UNI\_CMD macro,
2021-12-09) introduced a bug by removing MCU\_UNI\_PREFIX, but not
updating MCU\_CMD\_MASK accordingly, so when commands are compared in
mt7921\_mcu\_parse\_response() one has the extra bit \_\_MCU\_CMD\_FIELD\_UNI
set and the comparison fails:
if (mcu\_cmd != event->cid)
if (20001 != 1)
The fix was sneaked by in the next commit 680a2ead741a (mt76: connac:
introduce MCU\_CE\_CMD macro, 2021-12-09):
- int mcu\_cmd = cmd & MCU\_CMD\_MASK;
+ int mcu\_cmd = FIELD\_GET(\_\_MCU\_CMD\_FIELD\_ID, cmd);
But it was never merged into linux-stable.
We need either both commits, or none.
Signed-off-by: Lorenzo Bianconi
Signed-off-by: Felix Fietkau
Signed-off-by: Felipe Contreras
Signed-off-by: Greg Kroah-Hartman
commit 45809ba049fb35949483580d497ab65c521d3223
Author: Sing-Han Chen
Date: Wed Jan 12 17:41:43 2022 +0800
ucsi\_ccg: Check DEV\_INT bit only when starting CCG4
commit 825911492eb15bf8bb7fb94bc0c0421fe7a6327d upstream.
CCGx clears Bit 0:Device Interrupt in the INTR\_REG
if CCGx is reset successfully. However, there might
be a chance that other bits in INTR\_REG are not
cleared due to internal data queued in PPM. This case
misleads the driver that CCGx reset failed.
The commit checks bit 0 in INTR\_REG and ignores other
bits. The ucsi driver would reset PPM later.
Fixes: 247c554a14aa ("usb: typec: ucsi: add support for Cypress CCGx")
Cc: stable@vger.kernel.org
Reviewed-by: Heikki Krogerus
Signed-off-by: Sing-Han Chen
Signed-off-by: Wayne Chang
Link: https://lore.kernel.org/r/20220112094143.628610-1-waynec@nvidia.com
Signed-off-by: Greg Kroah-Hartman
commit 93f9cd5d6eafd2ffa971f8fe25d85a152f1c567f
Author: Badhri Jagan Sridharan
Date: Fri Jan 21 17:55:20 2022 -0800
usb: typec: tcpm: Do not disconnect when receiving VSAFE0V
commit 746f96e7d6f7a276726860f696671766bfb24cf0 upstream.
With some chargers, vbus might momentarily raise above VSAFE5V and fall
back to 0V causing VSAFE0V to be triggered. This will
will report a VBUS off event causing TCPM to transition to
SNK\_UNATTACHED state where it should be waiting in either SNK\_ATTACH\_WAIT
or SNK\_DEBOUNCED state. This patch makes TCPM avoid VSAFE0V events
while in SNK\_ATTACH\_WAIT or SNK\_DEBOUNCED state.
Stub from the spec:
"4.5.2.2.4.2 Exiting from AttachWait.SNK State
A Sink shall transition to Unattached.SNK when the state of both
the CC1 and CC2 pins is SNK.Open for at least tPDDebounce.
A DRP shall transition to Unattached.SRC when the state of both
the CC1 and CC2 pins is SNK.Open for at least tPDDebounce."
[23.194131] CC1: 0 -> 0, CC2: 0 -> 5 [state SNK\_UNATTACHED, polarity 0, connected]
[23.201777] state change SNK\_UNATTACHED -> SNK\_ATTACH\_WAIT [rev3 NONE\_AMS]
[23.209949] pending state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED @ 170 ms [rev3 NONE\_AMS]
[23.300579] VBUS off
[23.300668] state change SNK\_ATTACH\_WAIT -> SNK\_UNATTACHED [rev3 NONE\_AMS]
[23.301014] VBUS VSAFE0V
[23.301111] Start toggling
Fixes: 28b43d3d746b8 ("usb: typec: tcpm: Introduce vsafe0v for vbus")
Cc: stable@vger.kernel.org
Acked-by: Heikki Krogerus
Signed-off-by: Badhri Jagan Sridharan
Link: https://lore.kernel.org/r/20220122015520.332507-2-badhri@google.com
Signed-off-by: Greg Kroah-Hartman
commit 941ee15e16d05e98bbc330307ba2975080a94034
Author: Badhri Jagan Sridharan
Date: Fri Jan 21 17:55:19 2022 -0800
usb: typec: tcpm: Do not disconnect while receiving VBUS off
commit 90b8aa9f5b09edae6928c0561f933fec9f7a9987 upstream.
With some chargers, vbus might momentarily raise above VSAFE5V and fall
back to 0V before tcpm gets to read port->tcpc->get\_vbus. This will
will report a VBUS off event causing TCPM to transition to
SNK\_UNATTACHED where it should be waiting in either SNK\_ATTACH\_WAIT
or SNK\_DEBOUNCED state. This patch makes TCPM avoid vbus off events
while in SNK\_ATTACH\_WAIT or SNK\_DEBOUNCED state.
Stub from the spec:
"4.5.2.2.4.2 Exiting from AttachWait.SNK State
A Sink shall transition to Unattached.SNK when the state of both
the CC1 and CC2 pins is SNK.Open for at least tPDDebounce.
A DRP shall transition to Unattached.SRC when the state of both
the CC1 and CC2 pins is SNK.Open for at least tPDDebounce."
[23.194131] CC1: 0 -> 0, CC2: 0 -> 5 [state SNK\_UNATTACHED, polarity 0, connected]
[23.201777] state change SNK\_UNATTACHED -> SNK\_ATTACH\_WAIT [rev3 NONE\_AMS]
[23.209949] pending state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED @ 170 ms [rev3 NONE\_AMS]
[23.300579] VBUS off
[23.300668] state change SNK\_ATTACH\_WAIT -> SNK\_UNATTACHED [rev3 NONE\_AMS]
[23.301014] VBUS VSAFE0V
[23.301111] Start toggling
Fixes: f0690a25a140b8 ("staging: typec: USB Type-C Port Manager (tcpm)")
Cc: stable@vger.kernel.org
Acked-by: Heikki Krogerus
Signed-off-by: Badhri Jagan Sridharan
Link: https://lore.kernel.org/r/20220122015520.332507-1-badhri@google.com
Signed-off-by: Greg Kroah-Hartman
commit bfc1412cb1220367a94fc8f6a961526be8a4d1d7
Author: Xu Yang
Date: Thu Jan 13 17:29:43 2022 +0800
usb: typec: tcpci: don't touch CC line if it's Vconn source
commit 5638b0dfb6921f69943c705383ff40fb64b987f2 upstream.
With the AMS and Collision Avoidance, tcpm often needs to change the CC's
termination. When one CC line is sourcing Vconn, if we still change its
termination, the voltage of the another CC line is likely to be fluctuant
and unstable.
Therefore, we should verify whether a CC line is sourcing Vconn before
changing its termination and only change the termination that is not
a Vconn line. This can be done by reading the Vconn Present bit of
POWER\_ STATUS register. To determine the polarity, we can read the
Plug Orientation bit of TCPC\_CONTROL register. Since Vconn can only be
sourced if Plug Orientation is set.
Fixes: 0908c5aca31e ("usb: typec: tcpm: AMS and Collision Avoidance")
cc:
Reviewed-by: Guenter Roeck
Acked-by: Heikki Krogerus
Signed-off-by: Xu Yang
Link: https://lore.kernel.org/r/20220113092943.752372-1-xu.yang\_2@nxp.com
Signed-off-by: Greg Kroah-Hartman
commit c9a18f7c5b071dce5e6939568829d40994866ab0
Author: Alan Stern
Date: Mon Jan 24 15:23:45 2022 -0500
USB: core: Fix hang in usb\_kill\_urb by adding memory barriers
commit 26fbe9772b8c459687930511444ce443011f86bf upstream.
The syzbot fuzzer has identified a bug in which processes hang waiting
for usb\_kill\_urb() to return. It turns out the issue is not unlinking
the URB; that works just fine. Rather, the problem arises when the
wakeup notification that the URB has completed is not received.
The reason is memory-access ordering on SMP systems. In outline form,
usb\_kill\_urb() and \_\_usb\_hcd\_giveback\_urb() operating concurrently on
different CPUs perform the following actions:
CPU 0 CPU 1
---------------------------- ---------------------------------
usb\_kill\_urb(): \_\_usb\_hcd\_giveback\_urb():
... ...
atomic\_inc(&urb->reject); atomic\_dec(&urb->use\_count);
... ...
wait\_event(usb\_kill\_urb\_queue,
atomic\_read(&urb->use\_count) == 0);
if (atomic\_read(&urb->reject))
wake\_up(&usb\_kill\_urb\_queue);
Confining your attention to urb->reject and urb->use\_count, you can
see that the overall pattern of accesses on CPU 0 is:
write urb->reject, then read urb->use\_count;
whereas the overall pattern of accesses on CPU 1 is:
write urb->use\_count, then read urb->reject.
This pattern is referred to in memory-model circles as SB (for "Store
Buffering"), and it is well known that without suitable enforcement of
the desired order of accesses -- in the form of memory barriers -- it
is entirely possible for one or both CPUs to execute their reads ahead
of their writes. The end result will be that sometimes CPU 0 sees the
old un-decremented value of urb->use\_count while CPU 1 sees the old
un-incremented value of urb->reject. Consequently CPU 0 ends up on
the wait queue and never gets woken up, leading to the observed hang
in usb\_kill\_urb().
The same pattern of accesses occurs in usb\_poison\_urb() and the
failure pathway of usb\_hcd\_submit\_urb().
The problem is fixed by adding suitable memory barriers. To provide
proper memory-access ordering in the SB pattern, a full barrier is
required on both CPUs. The atomic\_inc() and atomic\_dec() accesses
themselves don't provide any memory ordering, but since they are
present, we can use the optimized smp\_mb\_\_after\_atomic() memory
barrier in the various routines to obtain the desired effect.
This patch adds the necessary memory barriers.
CC:
Reported-and-tested-by: syzbot+76629376e06e2c2ad626@syzkaller.appspotmail.com
Signed-off-by: Alan Stern
Link: https://lore.kernel.org/r/Ye8K0QYee0Q0Nna2@rowland.harvard.edu
Signed-off-by: Greg Kroah-Hartman
commit 3095502581ca3822c1cec10ca5897de1a3945959
Author: Robert Hancock
Date: Tue Jan 25 18:02:51 2022 -0600
usb: dwc3: xilinx: Fix error handling when getting USB3 PHY
commit 2cc9b1c93b1c4caa2d971856c0780fb5f7d04692 upstream.
The code that looked up the USB3 PHY was ignoring all errors other than
EPROBE\_DEFER in an attempt to handle the PHY not being present. Fix and
simplify the code by using devm\_phy\_optional\_get and dev\_err\_probe so
that a missing PHY is not treated as an error and unexpected errors
are handled properly.
Fixes: 84770f028fab ("usb: dwc3: Add driver for Xilinx platforms")
Cc: stable
Signed-off-by: Robert Hancock
Link: https://lore.kernel.org/r/20220126000253.1586760-3-robert.hancock@calian.com
Signed-off-by: Greg Kroah-Hartman
commit 5d4f90bd9131b16e1df1e828aaed2e694215bd32
Author: Robert Hancock
Date: Tue Jan 25 18:02:50 2022 -0600
usb: dwc3: xilinx: Skip resets and USB3 register settings for USB2.0 mode
commit 9678f3361afc27a3124cd2824aec0227739986fb upstream.
It appears that the PIPE clock should not be selected when only USB 2.0
is being used in the design and no USB 3.0 reference clock is used.
Also, the core resets are not required if a USB3 PHY is not in use, and
will break things if USB3 is actually used but the PHY entry is not
listed in the device tree.
Skip core resets and register settings that are only required for
USB3 mode when no USB3 PHY is specified in the device tree.
Fixes: 84770f028fab ("usb: dwc3: Add driver for Xilinx platforms")
Cc: stable
Signed-off-by: Robert Hancock
Link: https://lore.kernel.org/r/20220126000253.1586760-2-robert.hancock@calian.com
Signed-off-by: Greg Kroah-Hartman
commit 315f8a59fe1a57e09c3d471d29fbe70aaf9cd988
Author: Pawel Laszczak
Date: Tue Jan 11 10:07:37 2022 +0100
usb: cdnsp: Fix segmentation fault in cdns\_lost\_power function
commit 79aa3e19fe8f5be30e846df8a436bfe306e8b1a6 upstream.
CDNSP driver read not initialized cdns->otg\_v0\_regs
which lead to segmentation fault. Patch fixes this issue.
Fixes: 2cf2581cd229 ("usb: cdns3: add power lost support for system resume")
cc:
Signed-off-by: Pawel Laszczak
Link: https://lore.kernel.org/r/20220111090737.10345-1-pawell@gli-login.cadence.com
Signed-off-by: Greg Kroah-Hartman
commit 103938dd5798e150689362290274b87af54e3a52
Author: Pavankumar Kondeti
Date: Sat Jan 22 08:33:22 2022 +0530
usb: gadget: f\_sourcesink: Fix isoc transfer for USB\_SPEED\_SUPER\_PLUS
commit 904edf8aeb459697129be5fde847e2a502f41fd9 upstream.
Currently when gadget enumerates in super speed plus, the isoc
endpoint request buffer size is not calculated correctly. Fix
this by checking the gadget speed against USB\_SPEED\_SUPER\_PLUS
and update the request buffer size.
Fixes: 90c4d05780d4 ("usb: fix various gadgets null ptr deref on 10gbps cabling.")
Cc: stable
Signed-off-by: Pavankumar Kondeti
Link: https://lore.kernel.org/r/1642820602-20619-1-git-send-email-quic\_pkondeti@quicinc.com
Signed-off-by: Greg Kroah-Hartman
commit 284ef44a8b233b15b5fe29e049cdf6218ccee15d
Author: Jon Hunter
Date: Mon Jan 17 15:00:39 2022 +0000
usb: common: ulpi: Fix crash in ulpi\_match()
commit 2e3dd4a6246945bf84ea6f478365d116e661554c upstream.
Commit 7495af930835 ("ARM: multi\_v7\_defconfig: Enable drivers for
DragonBoard 410c") enables the CONFIG\_PHY\_QCOM\_USB\_HS for the ARM
multi\_v7\_defconfig. Enabling this Kconfig is causing the kernel to crash
on the Tegra20 Ventana platform in the ulpi\_match() function.
The Qualcomm USB HS PHY driver that is enabled by CONFIG\_PHY\_QCOM\_USB\_HS,
registers a ulpi\_driver but this driver does not provide an 'id\_table',
so when ulpi\_match() is called on the Tegra20 Ventana platform, it
crashes when attempting to deference the id\_table pointer which is not
valid. The Qualcomm USB HS PHY driver uses device-tree for matching the
ULPI driver with the device and so fix this crash by using device-tree
for matching if the id\_table is not valid.
Fixes: ef6a7bcfb01c ("usb: ulpi: Support device discovery via DT")
Cc: stable
Signed-off-by: Jon Hunter
Link: https://lore.kernel.org/r/20220117150039.44058-1-jonathanh@nvidia.com
Signed-off-by: Greg Kroah-Hartman
commit 8b05ad29acb972850ad795fa850e814b2e758b83
Author: Frank Li
Date: Mon Jan 10 11:27:38 2022 -0600
usb: xhci-plat: fix crash when suspend if remote wake enable
commit 9df478463d9feb90dae24f183383961cf123a0ec upstream.
Crashed at i.mx8qm platform when suspend if enable remote wakeup
Internal error: synchronous external abort: 96000210 [#1] PREEMPT SMP
Modules linked in:
CPU: 2 PID: 244 Comm: kworker/u12:6 Not tainted 5.15.5-dirty #12
Hardware name: Freescale i.MX8QM MEK (DT)
Workqueue: events\_unbound async\_run\_entry\_fn
pstate: 600000c5 (nZCv daIF -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : xhci\_disable\_hub\_port\_wake.isra.62+0x60/0xf8
lr : xhci\_disable\_hub\_port\_wake.isra.62+0x34/0xf8
sp : ffff80001394bbf0
x29: ffff80001394bbf0 x28: 0000000000000000 x27: ffff00081193b578
x26: ffff00081193b570 x25: 0000000000000000 x24: 0000000000000000
x23: ffff00081193a29c x22: 0000000000020001 x21: 0000000000000001
x20: 0000000000000000 x19: ffff800014e90490 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000002 x12: 0000000000000000
x11: 0000000000000000 x10: 0000000000000960 x9 : ffff80001394baa0
x8 : ffff0008145d1780 x7 : ffff0008f95b8e80 x6 : 000000001853b453
x5 : 0000000000000496 x4 : 0000000000000000 x3 : ffff00081193a29c
x2 : 0000000000000001 x1 : 0000000000000000 x0 : ffff000814591620
Call trace:
xhci\_disable\_hub\_port\_wake.isra.62+0x60/0xf8
xhci\_suspend+0x58/0x510
xhci\_plat\_suspend+0x50/0x78
platform\_pm\_suspend+0x2c/0x78
dpm\_run\_callback.isra.25+0x50/0xe8
\_\_device\_suspend+0x108/0x3c0
The basic flow:
1. run time suspend call xhci\_suspend, xhci parent devices gate the clock.
2. echo mem >/sys/power/state, system \_device\_suspend call xhci\_suspend
3. xhci\_suspend call xhci\_disable\_hub\_port\_wake, which access register,
but clock already gated by run time suspend.
This problem was hidden by power domain driver, which call run time resume before it.
But the below commit remove it and make this issue happen.
commit c1df456d0f06e ("PM: domains: Don't runtime resume devices at genpd\_prepare()")
This patch call run time resume before suspend to make sure clock is on
before access register.
Reviewed-by: Peter Chen
Cc: stable
Signed-off-by: Frank Li
Testeb-by: Abel Vesa
Link: https://lore.kernel.org/r/20220110172738.31686-1-Frank.Li@nxp.com
Signed-off-by: Greg Kroah-Hartman
commit e813a5e6c14a86e3957dc7b3b9b22c0d803d9df5
Author: Alan Stern
Date: Mon Jan 24 15:14:40 2022 -0500
usb-storage: Add unusual-devs entry for VL817 USB-SATA bridge
commit 5b67b315037250a61861119683e7fcb509deea25 upstream.
Two people have reported (and mentioned numerous other reports on the
web) that VIA's VL817 USB-SATA bridge does not work with the uas
driver. Typical log messages are:
[ 3606.232149] sd 14:0:0:0: [sdg] tag#2 uas\_zap\_pending 0 uas-tag 1 inflight: CMD
[ 3606.232154] sd 14:0:0:0: [sdg] tag#2 CDB: Write(16) 8a 00 00 00 00 00 18 0c c9 80 00 00 00 80 00 00
[ 3606.306257] usb 4-4.4: reset SuperSpeed Plus Gen 2x1 USB device number 11 using xhci\_hcd
[ 3606.328584] scsi host14: uas\_eh\_device\_reset\_handler success
Surprisingly, the devices do seem to work okay for some other people.
The cause of the differing behaviors is not known.
In the hope of getting the devices to work for the most users, even at
the possible cost of degraded performance for some, this patch adds an
unusual\_devs entry for the VL817 to block it from binding to the uas
driver by default. Users will be able to override this entry by means
of a module parameter, if they want.
CC:
Reported-by: DocMAX
Reported-and-tested-by: Thomas Weißschuh
Signed-off-by: Alan Stern
Link: https://lore.kernel.org/r/Ye8IsK2sjlEv1rqU@rowland.harvard.edu
Signed-off-by: Greg Kroah-Hartman
commit 820a55c1f87b26ffe11895b3586e4fd80fd14161
Author: Greg Kroah-Hartman
Date: Thu Jan 27 08:33:04 2022 +0100
kbuild: remove include/linux/cyclades.h from header file check
commit d1ad2721b1eb05d54e81393a7ebc332d4a35c68f upstream.
The file now rightfully throws up a big warning that it should never be
included, so remove it from the header\_check test.
Fixes: f23653fe6447 ("tty: Partially revert the removal of the Cyclades public API")
Cc: stable
Cc: Masahiro Yamada
Cc: "Maciej W. Rozycki"
Reported-by: Stephen Rothwell
Reported-by: kernel test robot
Link: https://lore.kernel.org/r/20220127073304.42399-1-gregkh@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 9155ccf72afceb4714c4eaed1dcbcc9d6f964131
Author: Cameron Williams
Date: Mon Jan 24 09:42:23 2022 +0000
tty: Add support for Brainboxes UC cards.
commit 152d1afa834c84530828ee031cf07a00e0fc0b8c upstream.
This commit adds support for the some of the Brainboxes PCI range of
cards, including the UC-101, UC-235/246, UC-257, UC-268, UC-275/279,
UC-302, UC-310, UC-313, UC-320/324, UC-346, UC-357, UC-368
and UC-420/431.
Signed-off-by: Cameron Williams
Cc: stable
Link: https://lore.kernel.org/r/AM5PR0202MB2564688493F7DD9B9C610827C45E9@AM5PR0202MB2564.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 820f5c4af492aca9e9a989004a4b1b31426ce816
Author: Maciej W. Rozycki
Date: Wed Jan 26 09:22:54 2022 +0000
tty: Partially revert the removal of the Cyclades public API
commit f23653fe64479d96910bfda2b700b1af17c991ac upstream.
Fix a user API regression introduced with commit f76edd8f7ce0 ("tty:
cyclades, remove this orphan"), which removed a part of the API and
caused compilation errors for user programs using said part, such as
GCC 9 in its libsanitizer component[1]:
.../libsanitizer/sanitizer\_common/sanitizer\_platform\_limits\_posix.cc:160:10: fatal error: linux/cyclades.h: No such file or directory
160 | #include
| ^~~~~~~~~~~~~~~~~~
compilation terminated.
make[4]: \*\*\* [Makefile:664: sanitizer\_platform\_limits\_posix.lo] Error 1
As the absolute minimum required bring `struct cyclades\_monitor' and
ioctl numbers back then so as to make the library build again. Add a
preprocessor warning as to the obsolescence of the features provided.
References:
[1] GCC PR sanitizer/100379, "cyclades.h is removed from linux kernel
header files",
Fixes: f76edd8f7ce0 ("tty: cyclades, remove this orphan")
Cc: stable@vger.kernel.org # v5.13+
Reviewed-by: Christoph Hellwig
Signed-off-by: Maciej W. Rozycki
Link: https://lore.kernel.org/r/alpine.DEB.2.20.2201260733430.11348@tpp.orcam.me.uk
Signed-off-by: Greg Kroah-Hartman
commit e1ed8832264689c24d49c9a84759b4229c9f23b7
Author: daniel.starke@siemens.com
Date: Thu Jan 20 02:18:57 2022 -0800
tty: n\_gsm: fix SW flow control encoding/handling
commit 8838b2af23caf1ff0610caef2795d6668a013b2d upstream.
n\_gsm is based on the 3GPP 07.010 and its newer version is the 3GPP 27.010.
See https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=1516
The changes from 07.010 to 27.010 are non-functional. Therefore, I refer to
the newer 27.010 here. Chapter 5.2.7.3 states that DC1 (XON) and DC3 (XOFF)
are the control characters defined in ISO/IEC 646. These shall be quoted if
seen in the data stream to avoid interpretation as flow control characters.
ISO/IEC 646 refers to the set of ISO standards described as the ISO
7-bit coded character set for information interchange. Its final version
is also known as ITU T.50.
See https://www.itu.int/rec/T-REC-T.50-199209-I/en
To abide the standard it is needed to quote DC1 and DC3 correctly if these
are seen as data bytes and not as control characters. The current
implementation already tries to enforce this but fails to catch all
defined cases. 3GPP 27.010 chapter 5.2.7.3 clearly states that the most
significant bit shall be ignored for DC1 and DC3 handling. The current
implementation handles only the case with the most significant bit set 0.
Cases in which DC1 and DC3 have the most significant bit set 1 are left
unhandled.
This patch fixes this by masking the data bytes with ISO\_IEC\_646\_MASK (only
the 7 least significant bits set 1) before comparing them with XON
(a.k.a. DC1) and XOFF (a.k.a. DC3) when testing which byte values need
quotation via byte stuffing.
Fixes: e1eaea46bb40 ("tty: n\_gsm line discipline")
Cc: stable@vger.kernel.org
Signed-off-by: Daniel Starke
Link: https://lore.kernel.org/r/20220120101857.2509-1-daniel.starke@siemens.com
Signed-off-by: Greg Kroah-Hartman
commit eefd8f6e0ae9e631d102f6f289c54ef2f1294bee
Author: Arnaud Pouliquen
Date: Tue Jan 4 17:35:45 2022 +0100
tty: rpmsg: Fix race condition releasing tty port
commit db7f19c0aa0abcb751ff0ed694a071363f702b1d upstream.
The tty\_port struct is part of the rpmsg\_tty\_port structure.
The issue is that the rpmsg\_tty\_port structure is freed on
rpmsg\_tty\_remove while it is still referenced in the tty\_struct.
Its release is not predictable due to workqueues.
For instance following ftrace shows that rpmsg\_tty\_close is called after
rpmsg\_tty\_release\_cport:
nr\_test.sh-389 [000] ..... 212.093752: rpmsg\_tty\_remove <-rpmsg\_dev\_
remove
cat-1191 [001] ..... 212.095697: tty\_release <-\_\_fput
nr\_test.sh-389 [000] ..... 212.099166: rpmsg\_tty\_release\_cport <-rpm
sg\_tty\_remove
cat-1191 [001] ..... 212.115352: rpmsg\_tty\_close <-tty\_release
cat-1191 [001] ..... 212.115371: release\_tty <-tty\_release\_str
As consequence, the port must be free only when user has released the TTY
interface.
This path :
- Introduce the .destruct port tty ops function to release the allocated
rpmsg\_tty\_port structure.
- Introduce the .hangup tty ops function to call tty\_port\_hangup.
- Manages the tty port refcounting to trig the .destruct port ops,
- Introduces the rpmsg\_tty\_cleanup function to ensure that the TTY is
removed before decreasing the port refcount.
Fixes: 7c0408d80579 ("tty: add rpmsg driver")
Cc: stable
Signed-off-by: Arnaud Pouliquen
Link: https://lore.kernel.org/r/20220104163545.34710-1-arnaud.pouliquen@foss.st.com
Signed-off-by: Greg Kroah-Hartman
commit 1b8b83b8fa221c74e9aae76a2d50308a32c98302
Author: Valentin Caron
Date: Tue Jan 11 17:44:41 2022 +0100
serial: stm32: fix software flow control transfer
commit 037b91ec7729524107982e36ec4b40f9b174f7a2 upstream.
x\_char is ignored by stm32\_usart\_start\_tx() when xmit buffer is empty.
Fix start\_tx condition to allow x\_char to be sent.
Fixes: 48a6092fb41f ("serial: stm32-usart: Add STM32 USART Driver")
Cc: stable
Signed-off-by: Erwan Le Ray
Signed-off-by: Valentin Caron
Link: https://lore.kernel.org/r/20220111164441.6178-3-valentin.caron@foss.st.com
Signed-off-by: Greg Kroah-Hartman
commit 2cfc85132bfa1d704fec3d2aa77c6ca0fda2b772
Author: Robert Hancock
Date: Wed Jan 12 13:42:14 2022 -0600
serial: 8250: of: Fix mapped region size when using reg-offset property
commit d06b1cf28297e27127d3da54753a3a01a2fa2f28 upstream.
8250\_of supports a reg-offset property which is intended to handle
cases where the device registers start at an offset inside the region
of memory allocated to the device. The Xilinx 16550 UART, for which this
support was initially added, requires this. However, the code did not
adjust the overall size of the mapped region accordingly, causing the
driver to request an area of memory past the end of the device's
allocation. For example, if the UART was allocated an address of
0xb0130000, size of 0x10000 and reg-offset of 0x1000 in the device
tree, the region of memory reserved was b0131000-b0140fff, which caused
the driver for the region starting at b0140000 to fail to probe.
Fix this by subtracting reg-offset from the mapped region size.
Fixes: b912b5e2cfb3 ([POWERPC] Xilinx: of\_serial support for Xilinx uart 16550.)
Cc: stable
Signed-off-by: Robert Hancock
Link: https://lore.kernel.org/r/20220112194214.881844-1-robert.hancock@calian.com
Signed-off-by: Greg Kroah-Hartman
commit 15c513baf4ae229f4f36e13716043a52c44e7748
Author: Jochen Mades
Date: Sat Jan 23 05:10:14 2021 +0100
serial: pl011: Fix incorrect rs485 RTS polarity on set\_mctrl
commit 62f676ff7898f6c1bd26ce014564773a3dc00601 upstream.
Commit 8d479237727c ("serial: amba-pl011: add RS485 support") sought to
keep RTS deasserted on set\_mctrl if rs485 is enabled. However it did so
only if deasserted RTS polarity is high. Fix it in case it's low.
Fixes: 8d479237727c ("serial: amba-pl011: add RS485 support")
Cc: stable@vger.kernel.org # v5.15+
Cc: Lino Sanfilippo
Signed-off-by: Jochen Mades
[lukas: copyedit commit message, add stable designation]
Signed-off-by: Lukas Wunner
Link: https://lore.kernel.org/r/85fa3323ba8c307943969b7343e23f34c3e652ba.1642909284.git.lukas@wunner.de
Signed-off-by: Greg Kroah-Hartman
commit 59274a00b13ef4352dc2e54438cddedff67c2f3e
Author: Mike Snitzer
Date: Fri Jan 28 10:58:41 2022 -0500
dm: properly fix redundant bio-based IO accounting
commit b879f915bc48a18d4f4462729192435bb0f17052 upstream.
Record the start\_time for a bio but defer the starting block core's IO
accounting until after IO is submitted using bio\_start\_io\_acct\_time().
This approach avoids the need to mess around with any of the
individual IO stats in response to a bio\_split() that follows bio
submission.
Reported-by: Bud Brown
Reviewed-by: Christoph Hellwig
Cc: stable@vger.kernel.org
Depends-on: e45c47d1f94e ("block: add bio\_start\_io\_acct\_time() to control start\_time")
Signed-off-by: Mike Snitzer
Link: https://lore.kernel.org/r/20220128155841.39644-4-snitzer@redhat.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit a7f5b1a95fc7245bfa40e07907e8b5ac0878a709
Author: Mike Snitzer
Date: Fri Jan 28 10:58:39 2022 -0500
block: add bio\_start\_io\_acct\_time() to control start\_time
commit e45c47d1f94e0cc7b6b079fdb4bcce2995e2adc4 upstream.
bio\_start\_io\_acct\_time() interface is like bio\_start\_io\_acct() that
allows start\_time to be passed in. This gives drivers the ability to
defer starting accounting until after IO is issued (but possibily not
entirely due to bio splitting).
Reviewed-by: Christoph Hellwig
Signed-off-by: Mike Snitzer
Link: https://lore.kernel.org/r/20220128155841.39644-2-snitzer@redhat.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit dc93c7ad7092329a54d99f2ccb797a76908a0739
Author: Mike Snitzer
Date: Fri Jan 28 10:58:40 2022 -0500
dm: revert partial fix for redundant bio-based IO accounting
commit f524d9c95fab54783d0038f7a3e8c014d5b56857 upstream.
Reverts a1e1cb72d9649 ("dm: fix redundant IO accounting for bios that
need splitting") because it was too narrow in scope (only addressed
redundant 'sectors[]' accounting and not ios, nsecs[], etc).
Cc: stable@vger.kernel.org
Signed-off-by: Mike Snitzer
Link: https://lore.kernel.org/r/20220128155841.39644-3-snitzer@redhat.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 47fe7a1c5e3e011eeb4ab79f2d54a794fdd1c3eb
Author: Evgenii Stepanov
Date: Tue Jan 25 10:22:17 2022 -0800
arm64: extable: fix load\_unaligned\_zeropad() reg indices
commit 3758a6c74e08bdc15ccccd6872a6ad37d165239a upstream.
In ex\_handler\_load\_unaligned\_zeropad() we erroneously extract the data and
addr register indices from ex->type rather than ex->data. As ex->type will
contain EX\_TYPE\_LOAD\_UNALIGNED\_ZEROPAD (i.e. 4):
\* We'll always treat X0 as the address register, since EX\_DATA\_REG\_ADDR is
extracted from bits [9:5]. Thus, we may attempt to dereference an
arbitrary address as X0 may hold an arbitrary value.
\* We'll always treat X4 as the data register, since EX\_DATA\_REG\_DATA is
extracted from bits [4:0]. Thus we will corrupt X4 and cause arbitrary
behaviour within load\_unaligned\_zeropad() and its caller.
Fix this by extracting both values from ex->data as originally intended.
On an MTE-enabled QEMU image we are hitting the following crash:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
Call trace:
fixup\_exception+0xc4/0x108
\_\_do\_kernel\_fault+0x3c/0x268
do\_tag\_check\_fault+0x3c/0x104
do\_mem\_abort+0x44/0xf4
el1\_abort+0x40/0x64
el1h\_64\_sync\_handler+0x60/0xa0
el1h\_64\_sync+0x7c/0x80
link\_path\_walk+0x150/0x344
path\_openat+0xa0/0x7dc
do\_filp\_open+0xb8/0x168
do\_sys\_openat2+0x88/0x17c
\_\_arm64\_sys\_openat+0x74/0xa0
invoke\_syscall+0x48/0x148
el0\_svc\_common+0xb8/0xf8
do\_el0\_svc+0x28/0x88
el0\_svc+0x24/0x84
el0t\_64\_sync\_handler+0x88/0xec
el0t\_64\_sync+0x1b4/0x1b8
Code: f8695a69 71007d1f 540000e0 927df12a (f940014a)
Fixes: 753b32368705 ("arm64: extable: add load\_unaligned\_zeropad() handler")
Cc:  # 5.16.x
Reviewed-by: Mark Rutland
Signed-off-by: Evgenii Stepanov
Link: https://lore.kernel.org/r/20220125182217.2605202-1-eugenis@google.com
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit b830fd118fddf4af0a41027dfc2a3dfb85b62e25
Author: Vivek Goyal
Date: Wed Jan 26 15:35:14 2022 -0500
security, lsm: dentry\_init\_security() Handle multi LSM registration
commit 7f5056b9e7b71149bf11073f00a57fa1ac2921a9 upstream.
A ceph user has reported that ceph is crashing with kernel NULL pointer
dereference. Following is the backtrace.
/proc/version: Linux version 5.16.2-arch1-1 (linux@archlinux) (gcc (GCC)
11.1.0, GNU ld (GNU Binutils) 2.36.1) #1 SMP PREEMPT Thu, 20 Jan 2022
16:18:29 +0000
distro / arch: Arch Linux / x86\_64
SELinux is not enabled
ceph cluster version: 16.2.7 (dd0603118f56ab514f133c8d2e3adfc983942503)
relevant dmesg output:
[ 30.947129] BUG: kernel NULL pointer dereference, address:
0000000000000000
[ 30.947206] #PF: supervisor read access in kernel mode
[ 30.947258] #PF: error\_code(0x0000) - not-present page
[ 30.947310] PGD 0 P4D 0
[ 30.947342] Oops: 0000 [#1] PREEMPT SMP PTI
[ 30.947388] CPU: 5 PID: 778 Comm: touch Not tainted 5.16.2-arch1-1 #1
86fbf2c313cc37a553d65deb81d98e9dcc2a3659
[ 30.947486] Hardware name: Gigabyte Technology Co., Ltd. B365M
DS3H/B365M DS3H, BIOS F5 08/13/2019
[ 30.947569] RIP: 0010:strlen+0x0/0x20
[ 30.947616] Code: b6 07 38 d0 74 16 48 83 c7 01 84 c0 74 05 48 39 f7 75
ec 31 c0 31 d2 89 d6 89 d7 c3 48 89 f8 31 d2 89 d6 89 d7 c3 0
f 1f 40 00 <80> 3f 00 74 12 48 89 f8 48 83 c0 01 80 38 00 75 f7 48 29 f8 31
ff
[ 30.947782] RSP: 0018:ffffa4ed80ffbbb8 EFLAGS: 00010246
[ 30.947836] RAX: 0000000000000000 RBX: ffffa4ed80ffbc60 RCX:
0000000000000000
[ 30.947904] RDX: 0000000000000000 RSI: 0000000000000000 RDI:
0000000000000000
[ 30.947971] RBP: ffff94b0d15c0ae0 R08: 0000000000000000 R09:
0000000000000000
[ 30.948040] R10: 0000000000000000 R11: 0000000000000000 R12:
0000000000000000
[ 30.948106] R13: 0000000000000001 R14: ffffa4ed80ffbc60 R15:
0000000000000000
[ 30.948174] FS: 00007fc7520f0740(0000) GS:ffff94b7ced40000(0000)
knlGS:0000000000000000
[ 30.948252] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 30.948308] CR2: 0000000000000000 CR3: 0000000104a40001 CR4:
00000000003706e0
[ 30.948376] Call Trace:
[ 30.948404]
[ 30.948431] ceph\_security\_init\_secctx+0x7b/0x240 [ceph
49f9c4b9bf5be8760f19f1747e26da33920bce4b]
[ 30.948582] ceph\_atomic\_open+0x51e/0x8a0 [ceph
49f9c4b9bf5be8760f19f1747e26da33920bce4b]
[ 30.948708] ? get\_cached\_acl+0x4d/0xa0
[ 30.948759] path\_openat+0x60d/0x1030
[ 30.948809] do\_filp\_open+0xa5/0x150
[ 30.948859] do\_sys\_openat2+0xc4/0x190
[ 30.948904] \_\_x64\_sys\_openat+0x53/0xa0
[ 30.948948] do\_syscall\_64+0x5c/0x90
[ 30.948989] ? exc\_page\_fault+0x72/0x180
[ 30.949034] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 30.949091] RIP: 0033:0x7fc7521e25bb
[ 30.950849] Code: 25 00 00 41 00 3d 00 00 41 00 74 4b 64 8b 04 25 18 00
00 00 85 c0 75 67 44 89 e2 48 89 ee bf 9c ff ff ff b8 01 01 0
0 00 0f 05 <48> 3d 00 f0 ff ff 0f 87 91 00 00 00 48 8b 54 24 28 64 48 2b 14
25
Core of the problem is that ceph checks for return code from
security\_dentry\_init\_security() and if return code is 0, it assumes
everything is fine and continues to call strlen(name), which crashes.
Typically SELinux LSM returns 0 and sets name to "security.selinux" and
it is not a problem. Or if selinux is not compiled in or disabled, it
returns -EOPNOTSUP and ceph deals with it.
But somehow in this configuration, 0 is being returned and "name" is
not being initialized and that's creating the problem.
Our suspicion is that BPF LSM is registering a hook for
dentry\_init\_security() and returns hook default of 0.
LSM\_HOOK(int, 0, dentry\_init\_security, struct dentry \*dentry,...)
I have not been able to reproduce it just by doing CONFIG\_BPF\_LSM=y.
Stephen has tested the patch though and confirms it solves the problem
for him.
dentry\_init\_security() is written in such a way that it expects only one
LSM to register the hook. Atleast that's the expectation with current code.
If another LSM returns a hook and returns default, it will simply return
0 as of now and that will break ceph.
Hence, suggestion is that change semantics of this hook a bit. If there
are no LSMs or no LSM is taking ownership and initializing security context,
then return -EOPNOTSUP. Also allow at max one LSM to initialize security
context. This hook can't deal with multiple LSMs trying to init security
context. This patch implements this new behavior.
Reported-by: Stephen Muth
Tested-by: Stephen Muth
Suggested-by: Casey Schaufler
Acked-by: Casey Schaufler
Reviewed-by: Serge Hallyn
Cc: Jeff Layton
Cc: Christian Brauner
Cc: Paul Moore
Cc:  # 5.16.0
Signed-off-by: Vivek Goyal
Reviewed-by: Jeff Layton
Acked-by: Paul Moore
Acked-by: Christian Brauner
Signed-off-by: James Morris
Signed-off-by: Greg Kroah-Hartman
commit 1699bd143077c6de1dd314fa1ff231a6173cf8fe
Author: Nicholas Piggin
Date: Sat Jan 22 20:55:30 2022 +1000
KVM: PPC: Book3S HV Nested: Fix nested HFSCR being clobbered with multiple vCPUs
commit 22f7ff0dea9491e90b6fe808ed40c30bd791e5c2 upstream.
The L0 is storing HFSCR requested by the L1 for the L2 in struct
kvm\_nested\_guest when the L1 requests a vCPU enter L2. kvm\_nested\_guest
is not a per-vCPU structure. Hilarity ensues.
Fix it by moving the nested hfscr into the vCPU structure together with
the other per-vCPU nested fields.
Fixes: 8b210a880b35 ("KVM: PPC: Book3S HV Nested: Make nested HFSCR state accessible")
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Nicholas Piggin
Reviewed-by: Fabiano Rosas
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20220122105530.3477250-1-npiggin@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit e9bf4e129d8b78886c88a6a94200bc401c72b7ab
Author: Like Xu
Date: Wed Jan 26 17:22:26 2022 +0000
KVM: x86: Sync the states size with the XCR0/IA32\_XSS at, any time
commit 05a9e065059e566f218f8778c4d17ee75db56c55 upstream.
XCR0 is reset to 1 by RESET but not INIT and IA32\_XSS is zeroed by
both RESET and INIT. The kvm\_set\_msr\_common()'s handling of MSR\_IA32\_XSS
also needs to update kvm\_update\_cpuid\_runtime(). In the above cases, the
size in bytes of the XSAVE area containing all states enabled by XCR0 or
(XCRO | IA32\_XSS) needs to be updated.
For simplicity and consistency, existing helpers are used to write values
and call kvm\_update\_cpuid\_runtime(), and it's not exactly a fast path.
Fixes: a554d207dc46 ("KVM: X86: Processor States following Reset or INIT")
Cc: stable@vger.kernel.org
Signed-off-by: Like Xu
Signed-off-by: Sean Christopherson
Message-Id: <20220126172226.2298529-4-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 0c5130cccf4a420a44820463ac8168b32cab6d47
Author: Like Xu
Date: Wed Jan 26 17:22:25 2022 +0000
KVM: x86: Update vCPU's runtime CPUID on write to MSR\_IA32\_XSS
commit 4c282e51e4450b94680d6ca3b10f830483b1f243 upstream.
Do a runtime CPUID update for a vCPU if MSR\_IA32\_XSS is written, as the
size in bytes of the XSAVE area is affected by the states enabled in XSS.
Fixes: 203000993de5 ("kvm: vmx: add MSR logic for XSAVES")
Cc: stable@vger.kernel.org
Signed-off-by: Like Xu
[sean: split out as a separate patch, adjust Fixes tag]
Signed-off-by: Sean Christopherson
Message-Id: <20220126172226.2298529-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit b9a33734fb79292972cc8933e99a24ab9a2420fa
Author: Xiaoyao Li
Date: Wed Jan 26 17:22:24 2022 +0000
KVM: x86: Keep MSR\_IA32\_XSS unchanged for INIT
commit be4f3b3f82271c3193ce200a996dc70682c8e622 upstream.
It has been corrected from SDM version 075 that MSR\_IA32\_XSS is reset to
zero on Power up and Reset but keeps unchanged on INIT.
Fixes: a554d207dc46 ("KVM: X86: Processor States following Reset or INIT")
Cc: stable@vger.kernel.org
Signed-off-by: Xiaoyao Li
Signed-off-by: Sean Christopherson
Message-Id: <20220126172226.2298529-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit b7d0597c69096be963c4a22449697e90467f6b2a
Author: Vitaly Kuznetsov
Date: Wed Jan 26 14:18:04 2022 +0100
KVM: x86: Check .flags in kvm\_cpuid\_check\_equal() too
commit 033a3ea59a19df63edb4db6bfdbb357cd028258a upstream.
kvm\_cpuid\_check\_equal() checks for the (full) equality of the supplied
CPUID data so .flags need to be checked too.
Reported-by: Sean Christopherson
Fixes: c6617c61e8fe ("KVM: x86: Partially allow KVM\_SET\_CPUID{,2} after KVM\_RUN")
Signed-off-by: Vitaly Kuznetsov
Message-Id: <20220126131804.2839410-1-vkuznets@redhat.com>
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit b4c0d89c92e957ecccce12e66b63875d0cc7af7e
Author: Sean Christopherson
Date: Tue Jan 25 22:03:58 2022 +0000
KVM: x86: Forcibly leave nested virt when SMM state is toggled
commit f7e570780efc5cec9b2ed1e0472a7da14e864fdb upstream.
Forcibly leave nested virtualization operation if userspace toggles SMM
state via KVM\_SET\_VCPU\_EVENTS or KVM\_SYNC\_X86\_EVENTS. If userspace
forces the vCPU out of SMM while it's post-VMXON and then injects an SMI,
vmx\_enter\_smm() will overwrite vmx->nested.smm.vmxon and end up with both
vmxon=false and smm.vmxon=false, but all other nVMX state allocated.
Don't attempt to gracefully handle the transition as (a) most transitions
are nonsencial, e.g. forcing SMM while L2 is running, (b) there isn't
sufficient information to handle all transitions, e.g. SVM wants access
to the SMRAM save state, and (c) KVM\_SET\_VCPU\_EVENTS must precede
KVM\_SET\_NESTED\_STATE during state restore as the latter disallows putting
the vCPU into L2 if SMM is active, and disallows tagging the vCPU as
being post-VMXON in SMM if SMM is not active.
Abuse of KVM\_SET\_VCPU\_EVENTS manifests as a WARN and memory leak in nVMX
due to failure to free vmcs01's shadow VMCS, but the bug goes far beyond
just a memory leak, e.g. toggling SMM on while L2 is active puts the vCPU
in an architecturally impossible state.
WARNING: CPU: 0 PID: 3606 at free\_loaded\_vmcs arch/x86/kvm/vmx/vmx.c:2665 [inline]
WARNING: CPU: 0 PID: 3606 at free\_loaded\_vmcs+0x158/0x1a0 arch/x86/kvm/vmx/vmx.c:2656
Modules linked in:
CPU: 1 PID: 3606 Comm: syz-executor725 Not tainted 5.17.0-rc1-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:free\_loaded\_vmcs arch/x86/kvm/vmx/vmx.c:2665 [inline]
RIP: 0010:free\_loaded\_vmcs+0x158/0x1a0 arch/x86/kvm/vmx/vmx.c:2656
Code: <0f> 0b eb b3 e8 8f 4d 9f 00 e9 f7 fe ff ff 48 89 df e8 92 4d 9f 00
Call Trace:
kvm\_arch\_vcpu\_destroy+0x72/0x2f0 arch/x86/kvm/x86.c:11123
kvm\_vcpu\_destroy arch/x86/kvm/../../../virt/kvm/kvm\_main.c:441 [inline]
kvm\_destroy\_vcpus+0x11f/0x290 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:460
kvm\_free\_vcpus arch/x86/kvm/x86.c:11564 [inline]
kvm\_arch\_destroy\_vm+0x2e8/0x470 arch/x86/kvm/x86.c:11676
kvm\_destroy\_vm arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1217 [inline]
kvm\_put\_kvm+0x4fa/0xb00 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1250
kvm\_vm\_release+0x3f/0x50 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1273
\_\_fput+0x286/0x9f0 fs/file\_table.c:311
task\_work\_run+0xdd/0x1a0 kernel/task\_work.c:164
exit\_task\_work include/linux/task\_work.h:32 [inline]
do\_exit+0xb29/0x2a30 kernel/exit.c:806
do\_group\_exit+0xd2/0x2f0 kernel/exit.c:935
get\_signal+0x4b0/0x28c0 kernel/signal.c:2862
arch\_do\_signal\_or\_restart+0x2a9/0x1c40 arch/x86/kernel/signal.c:868
handle\_signal\_work kernel/entry/common.c:148 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:172 [inline]
exit\_to\_user\_mode\_prepare+0x17d/0x290 kernel/entry/common.c:207
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:289 [inline]
syscall\_exit\_to\_user\_mode+0x19/0x60 kernel/entry/common.c:300
do\_syscall\_64+0x42/0xb0 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae

Cc: stable@vger.kernel.org
Reported-by: syzbot+8112db3ab20e70d50c31@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson
Message-Id: <20220125220358.2091737-1-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit b9ee734a14bb685b2088f2176d82b34cb4e30dbc
Author: Sean Christopherson
Date: Tue Jan 25 21:04:45 2022 +0000
KVM: x86: Free kvm\_cpuid\_entry2 array on post-KVM\_RUN KVM\_SET\_CPUID{,2}
commit 811f95ff95270e6048197821434d9301e3d7f07c upstream.
Free the "struct kvm\_cpuid\_entry2" array on successful post-KVM\_RUN
KVM\_SET\_CPUID{,2} to fix a memory leak, the callers of kvm\_set\_cpuid()
free the array only on failure.
BUG: memory leak
unreferenced object 0xffff88810963a800 (size 2048):
comm "syz-executor025", pid 3610, jiffies 4294944928 (age 8.080s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 0d 00 00 00 ................
47 65 6e 75 6e 74 65 6c 69 6e 65 49 00 00 00 00 GenuntelineI....
backtrace:
[] kmalloc\_node include/linux/slab.h:604 [inline]
[] kvmalloc\_node+0x3e/0x100 mm/util.c:580
[] kvmalloc include/linux/slab.h:732 [inline]
[] vmemdup\_user+0x22/0x100 mm/util.c:199
[] kvm\_vcpu\_ioctl\_set\_cpuid2+0x8f/0xf0 arch/x86/kvm/cpuid.c:423
[] kvm\_arch\_vcpu\_ioctl+0xb99/0x1e60 arch/x86/kvm/x86.c:5251
[] kvm\_vcpu\_ioctl+0x4ad/0x950 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:4066
[] vfs\_ioctl fs/ioctl.c:51 [inline]
[] \_\_do\_sys\_ioctl fs/ioctl.c:874 [inline]
[] \_\_se\_sys\_ioctl fs/ioctl.c:860 [inline]
[] \_\_x64\_sys\_ioctl+0xfc/0x140 fs/ioctl.c:860
[] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[] do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
[] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Fixes: c6617c61e8fe ("KVM: x86: Partially allow KVM\_SET\_CPUID{,2} after KVM\_RUN")
Cc: stable@vger.kernel.org
Reported-by: syzbot+be576ad7655690586eec@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson
Message-Id: <20220125210445.2053429-1-seanjc@google.com>
Reviewed-by: Vitaly Kuznetsov
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit ab54b789cb075f67b20d8c3b58192a2f0e428687
Author: Vitaly Kuznetsov
Date: Mon Jan 24 11:36:05 2022 +0100
KVM: x86: Move CPUID.(EAX=0x12,ECX=1) mangling to \_\_kvm\_update\_cpuid\_runtime()
commit 5c89be1dd5cfb697614bc13626ba3bd0781aa160 upstream.
Full equality check of CPUID data on update (kvm\_cpuid\_check\_equal()) may
fail for SGX enabled CPUs as CPUID.(EAX=0x12,ECX=1) is currently being
mangled in kvm\_vcpu\_after\_set\_cpuid(). Move it to
\_\_kvm\_update\_cpuid\_runtime() and split off cpuid\_get\_supported\_xcr0()
helper as 'vcpu->arch.guest\_supported\_xcr0' update needs (logically)
to stay in kvm\_vcpu\_after\_set\_cpuid().
Cc: stable@vger.kernel.org
Fixes: feb627e8d6f6 ("KVM: x86: Forbid KVM\_SET\_CPUID{,2} after KVM\_RUN")
Signed-off-by: Vitaly Kuznetsov
Message-Id: <20220124103606.2630588-2-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit f0c4ba4d5e11e0ae6d3f061b49bacc6a398f0a5a
Author: Denis Valeev
Date: Sat Jan 22 23:13:57 2022 +0300
KVM: x86: nSVM: skip eax alignment check for non-SVM instructions
commit 47c28d436f409f5b009dc82bd82d4971088aa391 upstream.
The bug occurs on #GP triggered by VMware backdoor when eax value is
unaligned. eax alignment check should not be applied to non-SVM
instructions because it leads to incorrect omission of the instructions
emulation.
Apply the alignment check only to SVM instructions to fix.
Fixes: d1cba6c92237 ("KVM: x86: nSVM: test eax for 4K alignment for GP errata workaround")
Signed-off-by: Denis Valeev
Message-Id:
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit c209aa816fb4590408e50ba735d9eb040e7be32d
Author: Sean Christopherson
Date: Thu Jan 20 01:07:13 2022 +0000
KVM: SVM: Don't intercept #GP for SEV guests
commit 0b0be065b7563ac708aaa9f69dd4941c80b3446d upstream.
Never intercept #GP for SEV guests as reading SEV guest private memory
will return cyphertext, i.e. emulating on #GP can't work as intended.
Cc: stable@vger.kernel.org
Cc: Tom Lendacky
Cc: Brijesh Singh
Signed-off-by: Sean Christopherson
Reviewed-by: Liam Merwick
Message-Id: <20220120010719.711476-4-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 0b0dd3ef2d3586cc6518fe2430aa29a208ded295
Author: Sean Christopherson
Date: Thu Jan 20 01:07:11 2022 +0000
KVM: SVM: Never reject emulation due to SMAP errata for !SEV guests
commit 55467fcd55b89c622e62b4afe60ac0eb2fae91f2 upstream.
Always signal that emulation is possible for !SEV guests regardless of
whether or not the CPU provided a valid instruction byte stream. KVM can
read all guest state (memory and registers) for !SEV guests, i.e. can
fetch the code stream from memory even if the CPU failed to do so because
of the SMAP errata.
Fixes: 05d5a4863525 ("KVM: SVM: Workaround errata#1096 (insn\_len maybe zero on SMAP violation)")
Cc: stable@vger.kernel.org
Cc: Tom Lendacky
Cc: Brijesh Singh
Signed-off-by: Sean Christopherson
Reviewed-by: Liam Merwick
Message-Id: <20220120010719.711476-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit ce55f63f6cea4cab8ae9212f73285648a5baa30d
Author: Wanpeng Li
Date: Tue Jan 25 01:17:00 2022 -0800
KVM: LAPIC: Also cancel preemption timer during SET\_LAPIC
commit 35fe7cfbab2e81f1afb23fc4212210b1de6d9633 upstream.
The below warning is splatting during guest reboot.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 1931 at arch/x86/kvm/x86.c:10322 kvm\_arch\_vcpu\_ioctl\_run+0x874/0x880 [kvm]
CPU: 0 PID: 1931 Comm: qemu-system-x86 Tainted: G I 5.17.0-rc1+ #5
RIP: 0010:kvm\_arch\_vcpu\_ioctl\_run+0x874/0x880 [kvm]
Call Trace:
kvm\_vcpu\_ioctl+0x279/0x710 [kvm]
\_\_x64\_sys\_ioctl+0x83/0xb0
do\_syscall\_64+0x3b/0xc0
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fd39797350b
This can be triggered by not exposing tsc-deadline mode and doing a reboot in
the guest. The lapic\_shutdown() function which is called in sys\_reboot path
will not disarm the flying timer, it just masks LVTT. lapic\_shutdown() clears
APIC state w/ LVT\_MASKED and timer-mode bit is 0, this can trigger timer-mode
switch between tsc-deadline and oneshot/periodic, which can result in preemption
timer be cancelled in apic\_update\_lvtt(). However, We can't depend on this when
not exposing tsc-deadline mode and oneshot/periodic modes emulated by preemption
timer. Qemu will synchronise states around reset, let's cancel preemption timer
under KVM\_SET\_LAPIC.
Signed-off-by: Wanpeng Li
Message-Id: <1643102220-35667-1-git-send-email-wanpengli@tencent.com>
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 456ba2433844a6483cc4c933aa8f43d24575e341
Author: Bas Nieuwenhuizen
Date: Mon Jan 24 01:23:36 2022 +0100
drm/amd/display: Wrap dcn301\_calculate\_wm\_and\_dlg for FPU.
commit 25f1488bdbba63415239ff301fe61a8546140d9f upstream.
Mirrors the logic for dcn30. Cue lots of WARNs and some
kernel panics without this fix.
Cc: stable@vger.kernel.org
Signed-off-by: Bas Nieuwenhuizen
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 88298b87cb81311cd21304ff3e028f34fcee2b8b
Author: Bas Nieuwenhuizen
Date: Mon Jan 24 01:23:35 2022 +0100
drm/amd/display: Fix FP start/end for dcn30\_internal\_validate\_bw.
commit 72a8d87b87270bff0c0b2fed4d59c48d0dd840d7 upstream.
It calls populate\_dml\_pipes which uses doubles to initialize the
scale\_ratio\_depth params. Mirrors the dcn20 logic.
Cc: stable@vger.kernel.org
Signed-off-by: Bas Nieuwenhuizen
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit ae368125b6acbb1ec67d11b77c43d2c30d661d62
Author: Bas Nieuwenhuizen
Date: Sun Jan 23 03:38:28 2022 +0100
drm/amdgpu/display: Remove t\_srx\_delay\_us.
commit 2a807341ed1074ab83638f2fab08dffaa373f6b8 upstream.
Unused. Convert the divisions into asserts on the divisor, to
debug why it is zero. The divide by zero is suspected of causing
kernel panics.
While I have no idea where the zero is coming from I think this
patch is a positive either way.
Cc: stable@vger.kernel.org
Reviewed-by: Harry Wentland
Signed-off-by: Bas Nieuwenhuizen
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 4e6652edcdc82684ccd90699f595d428c1123fc2
Author: Alex Deucher
Date: Thu Jan 20 12:17:07 2022 -0500
drm/amdgpu: filter out radeon secondary ids as well
commit 9e5a14bce2402e84251a10269df0235cd7ce9234 upstream.
Older radeon boards (r2xx-r5xx) had secondary PCI functions
which we solely there for supporting multi-head on OSs with
special requirements. Add them to the unsupported list
as well so we don't attempt to bind to them. The driver
would fail to bind to them anyway, but this does so
in a cleaner way that should not confuse the user.
Cc: stable@vger.kernel.org
Acked-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 4e3d0e95275b73a139be172c2a157ba4a8411c6e
Author: Manasi Navare
Date: Mon Oct 4 04:59:13 2021 -0700
drm/atomic: Add the crtc to affected crtc only if uapi.enable = true
commit 5ec1cebd59300ddd26dbaa96c17c508764eef911 upstream.
In case of a modeset where a mode gets split across multiple CRTCs
in the driver specific implementation (bigjoiner in i915) we wrongly count
the affected CRTCs based on the drm\_crtc\_mask and indicate the stolen CRTC as
an affected CRTC in atomic\_check\_only().
This triggers a warning since affected CRTCs doent match requested CRTC.
To fix this in such bigjoiner configurations, we should only
increment affected crtcs if that CRTC is enabled in UAPI not
if it is just used internally in the driver to split the mode.
v3: Add the same uapi crtc\_state->enable check in requested
crtc calc (Ville)
Cc: Ville Syrjälä
Cc: Simon Ser
Cc: Pekka Paalanen
Cc: Daniel Stone
Cc: Daniel Vetter
Cc: dri-devel@lists.freedesktop.org
Cc:  # v5.11+
Fixes: 919c2299a893 ("drm/i915: Enable bigjoiner")
Signed-off-by: Manasi Navare
Reviewed-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20211004115913.23889-1-manasi.d.navare@intel.com
Signed-off-by: Greg Kroah-Hartman
commit b91c447b68b16e4c1cf263897119021968635391
Author: Lucas Stach
Date: Thu Jan 6 19:10:21 2022 +0100
drm/etnaviv: relax submit size limits
commit e3d26528e083e612314d4dcd713f3d5a26143ddc upstream.
While all userspace tried to limit commandstreams to 64K in size,
a bug in the Mesa driver lead to command streams of up to 128K
being submitted. Allow those to avoid breaking existing userspace.
Fixes: 6dfa2fab8ddd ("drm/etnaviv: limit submit sizes")
Cc: stable@vger.kernel.org
Signed-off-by: Lucas Stach
Reviewed-by: Christian Gmeiner
Signed-off-by: Greg Kroah-Hartman
commit 722897397121c621e685ad58e20af21d144e1d94
Author: Kan Liang
Date: Tue Jan 11 10:20:38 2022 -0800
perf/x86/intel: Add a quirk for the calculation of the number of counters on Alder Lake
commit 7fa981cad216e9f64f49e22112f610c0bfed91bc upstream.
For some Alder Lake machine with all E-cores disabled in a BIOS, the
below warning may be triggered.
[ 2.010766] hw perf events fixed 5 > max(4), clipping!
Current perf code relies on the CPUID leaf 0xA and leaf 7.EDX[15] to
calculate the number of the counters and follow the below assumption.
For a hybrid configuration, the leaf 7.EDX[15] (X86\_FEATURE\_HYBRID\_CPU)
is set. The leaf 0xA only enumerate the common counters. Linux perf has
to manually add the extra GP counters and fixed counters for P-cores.
For a non-hybrid configuration, the X86\_FEATURE\_HYBRID\_CPU should not
be set. The leaf 0xA enumerates all counters.
However, that's not the case when all E-cores are disabled in a BIOS.
Although there are only P-cores in the system, the leaf 7.EDX[15]
(X86\_FEATURE\_HYBRID\_CPU) is still set. But the leaf 0xA is updated
to enumerate all counters of P-cores. The inconsistency triggers the
warning.
Several software ways were considered to handle the inconsistency.
- Drop the leaf 0xA and leaf 7.EDX[15] CPUID enumeration support.
Hardcode the number of counters. This solution may be a problem for
virtualization. A hypervisor cannot control the number of counters
in a Linux guest via changing the guest CPUID enumeration anymore.
- Find another CPUID bit that is also updated with E-cores disabled.
There may be a problem in the virtualization environment too. Because
a hypervisor may disable the feature/CPUID bit.
- The P-cores have a maximum of 8 GP counters and 4 fixed counters on
ADL. The maximum number can be used to detect the case.
This solution is implemented in this patch.
Fixes: ee72a94ea4a6 ("perf/x86/intel: Fix fixed counter check warning for some Alder Lake")
Reported-by: Damjan Marion (damarion)
Reported-by: Chan Edison
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Tested-by: Damjan Marion (damarion)
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/1641925238-149288-1-git-send-email-kan.liang@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 308f30ec092d7a351c770ab33152689342d63835
Author: Zhengjun Xing
Date: Thu Dec 23 22:48:26 2021 +0800
perf/x86/intel/uncore: Fix CAS\_COUNT\_WRITE issue for ICX
commit 96fd2e89fba1aaada6f4b1e5d25a9d9ecbe1943d upstream.
The user recently report a perf issue in the ICX platform, when test by
perf event “uncore\_imc\_x/cas\_count\_write”,the write bandwidth is always
very small (only 0.38MB/s), it is caused by the wrong "umask" for the
"cas\_count\_write" event. When double-checking, find "cas\_count\_read"
also is wrong.
The public document for ICX uncore:
3rd Gen Intel® Xeon® Processor Scalable Family, Codename Ice Lake,Uncore
Performance Monitoring Reference Manual, Revision 1.00, May 2021
On 2.4.7, it defines Unit Masks for CAS\_COUNT:
RD b00001111
WR b00110000
So corrected both "cas\_count\_read" and "cas\_count\_write" for ICX.
Old settings:
hswep\_uncore\_imc\_events
INTEL\_UNCORE\_EVENT\_DESC(cas\_count\_read, "event=0x04,umask=0x03")
INTEL\_UNCORE\_EVENT\_DESC(cas\_count\_write, "event=0x04,umask=0x0c")
New settings:
snr\_uncore\_imc\_events
INTEL\_UNCORE\_EVENT\_DESC(cas\_count\_read, "event=0x04,umask=0x0f")
INTEL\_UNCORE\_EVENT\_DESC(cas\_count\_write, "event=0x04,umask=0x30")
Fixes: 2b3b76b5ec67 ("perf/x86/intel/uncore: Add Ice Lake server uncore support")
Signed-off-by: Zhengjun Xing
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Adrian Hunter
Reviewed-by: Kan Liang
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20211223144826.841267-1-zhengjun.xing@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 4910080471e9d8a292b20d463896ac670565765b
Author: Christophe Leroy
Date: Fri Jan 14 11:26:25 2022 +0000
powerpc/audit: Fix syscall\_get\_arch()
commit 252745240ba0ae774d2f80c5e185ed59fbc4fb41 upstream.
Commit 770cec16cdc9 ("powerpc/audit: Simplify syscall\_get\_arch()")
and commit 898a1ef06ad4 ("powerpc/audit: Avoid unneccessary #ifdef
in syscall\_get\_arguments()")
replaced test\_tsk\_thread\_flag(task, TIF\_32BIT)) by is\_32bit\_task().
But is\_32bit\_task() applies on current task while be want the test
done on task 'task'
So add a new macro is\_tsk\_32bit\_task() to check any task.
Fixes: 770cec16cdc9 ("powerpc/audit: Simplify syscall\_get\_arch()")
Fixes: 898a1ef06ad4 ("powerpc/audit: Avoid unneccessary #ifdef in syscall\_get\_arguments()")
Cc: stable@vger.kernel.org
Reported-by: Dmitry V. Levin
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/c55cddb8f65713bf5859ed675d75a50cb37d5995.1642159570.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 991ced6a3a926e58df1f446819b9f2790e1c0daa
Author: Suren Baghdasaryan
Date: Tue Jan 11 15:23:09 2022 -0800
psi: Fix uaf issue when psi trigger is destroyed while being polled
commit a06247c6804f1a7c86a2e5398a4c1f1db1471848 upstream.
With write operation on psi files replacing old trigger with a new one,
the lifetime of its waitqueue is totally arbitrary. Overwriting an
existing trigger causes its waitqueue to be freed and pending poll()
will stumble on trigger->event\_wait which was destroyed.
Fix this by disallowing to redefine an existing psi trigger. If a write
operation is used on a file descriptor with an already existing psi
trigger, the operation will fail with EBUSY error.
Also bypass a check for psi\_disabled in the psi\_trigger\_destroy as the
flag can be flipped after the trigger is created, leading to a memory
leak.
Fixes: 0e94682b73bf ("psi: introduce psi monitor")
Reported-by: syzbot+cdb5dd11c97cc532efad@syzkaller.appspotmail.com
Suggested-by: Linus Torvalds
Analyzed-by: Eric Biggers
Signed-off-by: Suren Baghdasaryan
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Eric Biggers
Acked-by: Johannes Weiner
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220111232309.1786347-1-surenb@google.com
Signed-off-by: Greg Kroah-Hartman
commit 1e28e6c2c3709684178277616bb64f5be1c3ba9a
Author: Sean Christopherson
Date: Thu Jan 20 01:07:12 2022 +0000
Revert "KVM: SVM: avoid infinite loop on NPF from bad address"
commit 31c25585695abdf03d6160aa6d829e855b256329 upstream.
Revert a completely broken check on an "invalid" RIP in SVM's workaround
for the DecodeAssists SMAP errata. kvm\_vcpu\_gfn\_to\_memslot() obviously
expects a gfn, i.e. operates in the guest physical address space, whereas
RIP is a virtual (not even linear) address. The "fix" worked for the
problematic KVM selftest because the test identity mapped RIP.
Fully revert the hack instead of trying to translate RIP to a GPA, as the
non-SEV case is now handled earlier, and KVM cannot access guest page
tables to translate RIP.
This reverts commit e72436bc3a5206f95bb384e741154166ddb3202e.
Fixes: e72436bc3a52 ("KVM: SVM: avoid infinite loop on NPF from bad address")
Reported-by: Liam Merwick
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Reviewed-by: Liam Merwick
Message-Id: <20220120010719.711476-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit b15f86c8481996e5fb14b7373341754668e13ac8
Author: Amir Goldstein
Date: Thu Jan 20 23:53:05 2022 +0200
fsnotify: fix fsnotify hooks in pseudo filesystems
commit 29044dae2e746949ad4b9cbdbfb248994d1dcdb4 upstream.
Commit 49246466a989 ("fsnotify: move fsnotify\_nameremove() hook out of
d\_delete()") moved the fsnotify delete hook before d\_delete() so fsnotify
will have access to a positive dentry.
This allowed a race where opening the deleted file via cached dentry
is now possible after receiving the IN\_DELETE event.
To fix the regression in pseudo filesystems, convert d\_delete() calls
to d\_drop() (see commit 46c46f8df9aa ("devpts\_pty\_kill(): don't bother
with d\_delete()") and move the fsnotify hook after d\_drop().
Add a missing fsnotify\_unlink() hook in nfsdfs that was found during
the audit of fsnotify hooks in pseudo filesystems.
Note that the fsnotify hooks in simple\_recursive\_removal() follow
d\_invalidate(), so they require no change.
Link: https://lore.kernel.org/r/20220120215305.282577-2-amir73il@gmail.com
Reported-by: Ivan Delalande
Link: https://lore.kernel.org/linux-fsdevel/YeNyzoDM5hP5LtGW@visor/
Fixes: 49246466a989 ("fsnotify: move fsnotify\_nameremove() hook out of d\_delete()")
Cc: stable@vger.kernel.org # v5.3+
Signed-off-by: Amir Goldstein
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 753a1d633cb0ca3a1a71681421054209918fab54
Author: Amir Goldstein
Date: Thu Jan 20 23:53:04 2022 +0200
fsnotify: invalidate dcache before IN\_DELETE event
commit a37d9a17f099072fe4d3a9048b0321978707a918 upstream.
Apparently, there are some applications that use IN\_DELETE event as an
invalidation mechanism and expect that if they try to open a file with
the name reported with the delete event, that it should not contain the
content of the deleted file.
Commit 49246466a989 ("fsnotify: move fsnotify\_nameremove() hook out of
d\_delete()") moved the fsnotify delete hook before d\_delete() so fsnotify
will have access to a positive dentry.
This allowed a race where opening the deleted file via cached dentry
is now possible after receiving the IN\_DELETE event.
To fix the regression, create a new hook fsnotify\_delete() that takes
the unlinked inode as an argument and use a helper d\_delete\_notify() to
pin the inode, so we can pass it to fsnotify\_delete() after d\_delete().
Backporting hint: this regression is from v5.3. Although patch will
apply with only trivial conflicts to v5.4 and v5.10, it won't build,
because fsnotify\_delete() implementation is different in each of those
versions (see fsnotify\_link()).
A follow up patch will fix the fsnotify\_unlink/rmdir() calls in pseudo
filesystem that do not need to call d\_delete().
Link: https://lore.kernel.org/r/20220120215305.282577-1-amir73il@gmail.com
Reported-by: Ivan Delalande
Link: https://lore.kernel.org/linux-fsdevel/YeNyzoDM5hP5LtGW@visor/
Fixes: 49246466a989 ("fsnotify: move fsnotify\_nameremove() hook out of d\_delete()")
Cc: stable@vger.kernel.org # v5.3+
Signed-off-by: Amir Goldstein
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 1a99fb430ed672668e54875674497af6e38652b9
Author: Jeff Layton
Date: Wed Jan 26 12:36:49 2022 -0500
ceph: set pool\_ns in new inode layout for async creates
commit 4584a768f22b7669cdebabc911543621ac661341 upstream.
Dan reported that he was unable to write to files that had been
asynchronously created when the client's OSD caps are restricted to a
particular namespace.
The issue is that the layout for the new inode is only partially being
filled. Ensure that we populate the pool\_ns\_data and pool\_ns\_len in the
iinfo before calling ceph\_fill\_inode.
Cc: stable@vger.kernel.org
URL: https://tracker.ceph.com/issues/54013
Fixes: 9a8d03ca2e2c ("ceph: attempt to do async create when possible")
Reported-by: Dan van der Ster
Signed-off-by: Jeff Layton
Reviewed-by: Ilya Dryomov
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit a0c22e970cd78b81c94691e6cb09713e8074d580
Author: Jeff Layton
Date: Tue Jan 25 15:39:16 2022 -0500
ceph: properly put ceph\_string reference after async create attempt
commit 932a9b5870d38b87ba0a9923c804b1af7d3605b9 upstream.
The reference acquired by try\_prep\_async\_create is currently leaked.
Ensure we put it.
Cc: stable@vger.kernel.org
Fixes: 9a8d03ca2e2c ("ceph: attempt to do async create when possible")
Signed-off-by: Jeff Layton
Reviewed-by: Ilya Dryomov
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 6dc771e98b79a7ddda3a6266f9f3e05067800096
Author: Tom Zanussi
Date: Thu Jan 27 15:44:18 2022 -0600
tracing: Don't inc err\_log entry count if entry allocation fails
commit 67ab5eb71b37b55f7c5522d080a1b42823351776 upstream.
tr->n\_err\_log\_entries should only be increased if entry allocation
succeeds.
Doing it when it fails won't cause any problems other than wasting an
entry, but should be fixed anyway.
Link: https://lkml.kernel.org/r/cad1ab28f75968db0f466925e7cba5970cec6c29.1643319703.git.zanussi@kernel.org
Cc: stable@vger.kernel.org
Fixes: 2f754e771b1a6 ("tracing: Don't inc err\_log entry count if entry allocation fails")
Signed-off-by: Tom Zanussi
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 71443fe2ac1561d4f575412241c914d92c3b7c2b
Author: Tom Zanussi
Date: Thu Jan 27 15:44:17 2022 -0600
tracing: Propagate is\_signed to expression
commit 097f1eefedeab528cecbd35586dfe293853ffb17 upstream.
During expression parsing, a new expression field is created which
should inherit the properties of the operands, such as size and
is\_signed.
is\_signed propagation was missing, causing spurious errors with signed
operands. Add it in parse\_expr() and parse\_unary() to fix the problem.
Link: https://lkml.kernel.org/r/f4dac08742fd7a0920bf80a73c6c44042f5eaa40.1643319703.git.zanussi@kernel.org
Cc: stable@vger.kernel.org
Fixes: 100719dcef447 ("tracing: Add simple expression support to hist triggers")
Reported-by: Yordan Karadzhov
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=215513
Signed-off-by: Tom Zanussi
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit df86e2fe808c3536a9dba353cc2bebdfea00d0cf
Author: Xiaoke Wang
Date: Tue Jan 25 12:07:15 2022 +0800
tracing/histogram: Fix a potential memory leak for kstrdup()
commit e629e7b525a179e29d53463d992bdee759c950fb upstream.
kfree() is missing on an error path to free the memory allocated by
kstrdup():
p = param = kstrdup(data->params[i], GFP\_KERNEL);
So it is better to free it via kfree(p).
Link: https://lkml.kernel.org/r/tencent\_C52895FD37802832A3E5B272D05008866F0A@qq.com
Cc: stable@vger.kernel.org
Fixes: d380dcde9a07c ("tracing: Fix now invalid var\_ref\_vals assumption in trace action")
Signed-off-by: Xiaoke Wang
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Greg Kroah-Hartman
commit 1ef81cd002079443dae37060d1d5867077db1dca
Author: Greg Kroah-Hartman
Date: Thu Jan 13 19:44:20 2022 +0100
PM: wakeup: simplify the output logic of pm\_show\_wakelocks()
commit c9d967b2ce40d71e968eb839f36c936b8a9cf1ea upstream.
The buffer handling in pm\_show\_wakelocks() is tricky, and hopefully
correct. Ensure it really is correct by using sysfs\_emit\_at() which
handles all of the tricky string handling logic in a PAGE\_SIZE buffer
for us automatically as this is a sysfs file being read from.
Reviewed-by: Lee Jones
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit a4085859411c825c321c9b55b8a9dc5a128a6684
Author: Ard Biesheuvel
Date: Wed Jan 12 11:14:13 2022 +0100
efi: runtime: avoid EFIv2 runtime services on Apple x86 machines
commit f5390cd0b43c2e54c7cf5506c7da4a37c5cef746 upstream.
Aditya reports [0] that his recent MacbookPro crashes in the firmware
when using the variable services at runtime. The culprit appears to be a
call to QueryVariableInfo(), which we did not use to call on Apple x86
machines in the past as they only upgraded from EFI v1.10 to EFI v2.40
firmware fairly recently, and QueryVariableInfo() (along with
UpdateCapsule() et al) was added in EFI v2.00.
The only runtime service introduced in EFI v2.00 that we actually use in
Linux is QueryVariableInfo(), as the capsule based ones are optional,
generally not used at runtime (all the LVFS/fwupd firmware update
infrastructure uses helper EFI programs that invoke capsule update at
boot time, not runtime), and not implemented by Apple machines in the
first place. QueryVariableInfo() is used to 'safely' set variables,
i.e., only when there is enough space. This prevents machines with buggy
firmwares from corrupting their NVRAMs when they run out of space.
Given that Apple machines have been using EFI v1.10 services only for
the longest time (the EFI v2.0 spec was released in 2006, and Linux
support for the newly introduced runtime services was added in 2011, but
the MacbookPro12,1 released in 2015 still claims to be EFI v1.10 only),
let's avoid the EFI v2.0 ones on all Apple x86 machines.
[0] https://lore.kernel.org/all/6D757C75-65B1-468B-842D-10410081A8E4@live.com/
Cc:
Cc: Jeremy Kerr
Cc: Matthew Garrett
Reported-by: Aditya Garg
Tested-by: Orlando Chamberlain
Signed-off-by: Ard Biesheuvel
Tested-by: Aditya Garg
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215277
Signed-off-by: Greg Kroah-Hartman
commit 620e8243cf5389e706c1c8f66ffacb3c84308a9e
Author: Jan Kara
Date: Mon Jan 17 18:22:13 2022 +0100
udf: Fix NULL ptr deref when converting from inline format
commit 7fc3b7c2981bbd1047916ade327beccb90994eee upstream.
udf\_expand\_file\_adinicb() calls directly ->writepage to write data
expanded into a page. This however misses to setup inode for writeback
properly and so we can crash on inode->i\_wb dereference when submitting
page for IO like:
BUG: kernel NULL pointer dereference, address: 0000000000000158
#PF: supervisor read access in kernel mode
...
\_\_folio\_start\_writeback+0x2ac/0x350
\_\_block\_write\_full\_page+0x37d/0x490
udf\_expand\_file\_adinicb+0x255/0x400 [udf]
udf\_file\_write\_iter+0xbe/0x1b0 [udf]
new\_sync\_write+0x125/0x1c0
vfs\_write+0x28e/0x400
Fix the problem by marking the page dirty and going through the standard
writeback path to write the page. Strictly speaking we would not even
have to write the page but we want to catch e.g. ENOSPC errors early.
Reported-by: butt3rflyh4ck
CC: stable@vger.kernel.org
Fixes: 52ebea749aae ("writeback: make backing\_dev\_info host cgroup-specific bdi\_writebacks")
Reviewed-by: Christoph Hellwig
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 8baf0dbef73e1d1ad41f5db77bf20234fb7a7773
Author: Jan Kara
Date: Tue Jan 18 09:57:25 2022 +0100
udf: Restore i\_lenAlloc when inode expansion fails
commit ea8569194b43f0f01f0a84c689388542c7254a1f upstream.
When we fail to expand inode from inline format to a normal format, we
restore inode to contain the original inline formatting but we forgot to
set i\_lenAlloc back. The mismatch between i\_lenAlloc and i\_size was then
causing further problems such as warnings and lost data down the line.
Reported-by: butt3rflyh4ck
CC: stable@vger.kernel.org
Fixes: 7e49b6f2480c ("udf: Convert UDF to new truncate calling sequence")
Reviewed-by: Christoph Hellwig
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit aa2b81857b6fcfd4662acd16f6f5777088058ad7
Author: Steffen Maier
Date: Tue Jan 18 17:58:03 2022 +0100
scsi: zfcp: Fix failed recovery on gone remote port with non-NPIV FCP devices
commit 8c9db6679be4348b8aae108e11d4be2f83976e30 upstream.
Suppose we have an environment with a number of non-NPIV FCP devices
(virtual HBAs / FCP devices / zfcp "adapter"s) sharing the same physical
FCP channel (HBA port) and its I\_T nexus. Plus a number of storage target
ports zoned to such shared channel. Now one target port logs out of the
fabric causing an RSCN. Zfcp reacts with an ADISC ELS and subsequent port
recovery depending on the ADISC result. This happens on all such FCP
devices (in different Linux images) concurrently as they all receive a copy
of this RSCN. In the following we look at one of those FCP devices.
Requests other than FSF\_QTCB\_FCP\_CMND can be slow until they get a
response.
Depending on which requests are affected by slow responses, there are
different recovery outcomes. Here we want to fix failed recoveries on port
or adapter level by avoiding recovery requests that can be slow.
We need the cached N\_Port\_ID for the remote port "link" test with ADISC.
Just before sending the ADISC, we now intentionally forget the old cached
N\_Port\_ID. The idea is that on receiving an RSCN for a port, we have to
assume that any cached information about this port is stale. This forces a
fresh new GID\_PN [FC-GS] nameserver lookup on any subsequent recovery for
the same port. Since we typically can still communicate with the nameserver
efficiently, we now reach steady state quicker: Either the nameserver still
does not know about the port so we stop recovery, or the nameserver already
knows the port potentially with a new N\_Port\_ID and we can successfully and
quickly perform open port recovery. For the one case, where ADISC returns
successfully, we re-initialize port->d\_id because that case does not
involve any port recovery.
This also solves a problem if the storage WWPN quickly logs into the fabric
again but with a different N\_Port\_ID. Such as on virtual WWPN takeover
during target NPIV failover.
[https://www.redbooks.ibm.com/abstracts/redp5477.html] In that case the
RSCN from the storage FDISC was ignored by zfcp and we could not
successfully recover the failover. On some later failback on the storage,
we could have been lucky if the virtual WWPN got the same old N\_Port\_ID
from the SAN switch as we still had cached. Then the related RSCN
triggered a successful port reopen recovery. However, there is no
guarantee to get the same N\_Port\_ID on NPIV FDISC.
Even though NPIV-enabled FCP devices are not affected by this problem, this
code change optimizes recovery time for gone remote ports as a side effect.
The timely drop of cached N\_Port\_IDs prevents unnecessary slow open port
attempts.
While the problem might have been in code before v2.6.32 commit
799b76d09aee ("[SCSI] zfcp: Decouple gid\_pn requests from erp") this fix
depends on the gid\_pn\_work introduced with that commit, so we mark it as
culprit to satisfy fix dependencies.
Note: Point-to-point remote port is already handled separately and gets its
N\_Port\_ID from the cached peer\_d\_id. So resetting port->d\_id in general
does not affect PtP.
Link: https://lore.kernel.org/r/20220118165803.3667947-1-maier@linux.ibm.com
Fixes: 799b76d09aee ("[SCSI] zfcp: Decouple gid\_pn requests from erp")
Cc:  #2.6.32+
Suggested-by: Benjamin Block
Reviewed-by: Benjamin Block
Signed-off-by: Steffen Maier
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit aec8904396dc6c34a104f42b02d50ca9de58ab13
Author: Eric W. Biederman
Date: Mon Jan 24 12:46:50 2022 -0600
ucount: Make get\_ucount a safe get\_user replacement
commit f9d87929d451d3e649699d0f1d74f71f77ad38f5 upstream.
When the ucount code was refactored to create get\_ucount it was missed
that some of the contexts in which a rlimit is kept elevated can be
the only reference to the user/ucount in the system.
Ordinary ucount references exist in places that also have a reference
to the user namspace, but in POSIX message queues, the SysV shm code,
and the SIGPENDING code there is no independent user namespace
reference.
Inspection of the the user\_namespace show no instance of circular
references between struct ucounts and the user\_namespace. So
hold a reference from struct ucount to i's user\_namespace to
resolve this problem.
Link: https://lore.kernel.org/lkml/YZV7Z+yXbsx9p3JN@fixkernel.com/
Reported-by: Qian Cai
Reported-by: Mathias Krause
Tested-by: Mathias Krause
Reviewed-by: Mathias Krause
Reviewed-by: Alexey Gladkov
Fixes: d64696905554 ("Reimplement RLIMIT\_SIGPENDING on top of ucounts")
Fixes: 6e52a9f0532f ("Reimplement RLIMIT\_MSGQUEUE on top of ucounts")
Fixes: d7c9e99aee48 ("Reimplement RLIMIT\_MEMLOCK on top of ucounts")
Cc: stable@vger.kernel.org
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit f96590a8fb0455c690517190b69703f9332dee17
Author: Naveen N. Rao
Date: Thu Jan 6 17:15:07 2022 +0530
powerpc/bpf: Update ldimm64 instructions during extra pass
commit f9320c49993ca3c0ec0f9a7026b313735306bb8b upstream.
These instructions are updated after the initial JIT, so redo codegen
during the extra pass. Rename bpf\_jit\_fixup\_subprog\_calls() to clarify
that this is more than just subprog calls.
Fixes: 69c087ba6225b5 ("bpf: Add bpf\_for\_each\_map\_elem() helper")
Cc: stable@vger.kernel.org # v5.15
Signed-off-by: Naveen N. Rao
Tested-by: Jiri Olsa
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/7cc162af77ba918eb3ecd26ec9e7824bc44b1fae.1641468127.git.naveen.n.rao@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 80e6e5ca97adf383d35a66379f42673b85a722b1
Author: Naveen N. Rao
Date: Thu Jan 6 17:15:06 2022 +0530
powerpc32/bpf: Fix codegen for bpf-to-bpf calls
commit fab07611fb2e6a15fac05c4583045ca5582fd826 upstream.
Pad instructions emitted for BPF\_CALL so that the number of instructions
generated does not change for different function addresses. This is
especially important for calls to other bpf functions, whose address
will only be known during extra pass.
Fixes: 51c66ad849a703 ("powerpc/bpf: Implement extended BPF on PPC32")
Cc: stable@vger.kernel.org # v5.13+
Signed-off-by: Naveen N. Rao
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/52d8fe51f7620a6f27f377791564d79d75463576.1641468127.git.naveen.n.rao@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit b82ef4985a6d05e80f604624332430351df7b79a
Author: Naveen N. Rao
Date: Thu Jan 6 17:15:05 2022 +0530
bpf: Guard against accessing NULL pt\_regs in bpf\_get\_task\_stack()
commit b992f01e66150fc5e90be4a96f5eb8e634c8249e upstream.
task\_pt\_regs() can return NULL on powerpc for kernel threads. This is
then used in \_\_bpf\_get\_stack() to check for user mode, resulting in a
kernel oops. Guard against this by checking return value of
task\_pt\_regs() before trying to obtain the call chain.
Fixes: fa28dcb82a38f8 ("bpf: Introduce helper bpf\_get\_task\_stack()")
Cc: stable@vger.kernel.org # v5.9+
Signed-off-by: Naveen N. Rao
Acked-by: Daniel Borkmann
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/d5ef83c361cc255494afd15ff1b4fb02a36e1dcf.1641468127.git.naveen.n.rao@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 25d3459948f60720209038a24778e9ac3a997623
Author: Christian Borntraeger
Date: Mon Jan 17 18:40:32 2022 +0100
s390/nmi: handle vector validity failures for KVM guests
commit f094a39c6ba168f2df1edfd1731cca377af5f442 upstream.
The machine check validity bit tells about the context. If a KVM guest
was running the bit tells about the guest validity and the host state is
not affected. As a guest can disable the guest validity this might
result in unwanted host errors on machine checks.
Cc: stable@vger.kernel.org
Fixes: c929500d7a5a ("s390/nmi: s390: New low level handling for machine check happening in guest")
Signed-off-by: Christian Borntraeger
Reviewed-by: Heiko Carstens
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 6820a30bd7d9e204255c8515fffc708c1d97e1ec
Author: Christian Borntraeger
Date: Thu Jan 13 11:44:19 2022 +0100
s390/nmi: handle guarded storage validity failures for KVM guests
commit 1ea1d6a847d2b1d17fefd9196664b95f052a0775 upstream.
machine check validity bits reflect the state of the machine check. If a
guest does not make use of guarded storage, the validity bit might be
off. We can not use the host CR bit to decide if the validity bit must
be on. So ignore "invalid" guarded storage controls for KVM guests in
the host and rely on the machine check being forwarded to the guest. If
no other errors happen from a host perspective everything is fine and no
process must be killed and the host can continue to run.
Cc: stable@vger.kernel.org
Fixes: c929500d7a5a ("s390/nmi: s390: New low level handling for machine check happening in guest")
Reported-by: Carsten Otte
Signed-off-by: Christian Borntraeger
Tested-by: Carsten Otte
Reviewed-by: Heiko Carstens
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 62c368d137f97adc94c812b16b0c42373e7d34c7
Author: Vasily Gorbik
Date: Thu Jan 20 16:23:19 2022 +0100
s390/hypfs: include z/VM guests with access control group set
commit 663d34c8df98740f1e90241e78e456d00b3c6cad upstream.
Currently if z/VM guest is allowed to retrieve hypervisor performance
data globally for all guests (privilege class B) the query is formed in a
way to include all guests but the group name is left empty. This leads to
that z/VM guests which have access control group set not being included
in the results (even local vm).
Change the query group identifier from empty to "any" to retrieve
information about all guests from any groups (or without a group set).
Cc: stable@vger.kernel.org
Fixes: 31cb4bd31a48 ("[S390] Hypervisor filesystem (s390\_hypfs) for z/VM")
Reviewed-by: Gerald Schaefer
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit 529afef7357a5021c0ee7c0c4c417217b6adfc5e
Author: Ilya Leoshkevich
Date: Wed Jan 19 19:26:37 2022 +0100
s390/module: fix loading modules with a lot of relocations
commit f3b7e73b2c6619884351a3a0a7468642f852b8a2 upstream.
If the size of the PLT entries generated by apply\_rela() exceeds
64KiB, the first ones can no longer reach \_\_jump\_r1 with brc. Fix by
using brcl. An alternative solution is to add a \_\_jump\_r1 copy after
every 64KiB, however, the space savings are quite small and do not
justify the additional complexity.
Fixes: f19fbd5ed642 ("s390: introduce execute-trampolines for branches")
Cc: stable@vger.kernel.org
Reported-by: Andrea Righi
Signed-off-by: Ilya Leoshkevich
Reviewed-by: Heiko Carstens
Cc: Vasily Gorbik
Cc: Christian Borntraeger
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 6ef3c08edf062e8f7270c381308793c413a70c78
Author: Marc Zyngier
Date: Fri Jan 21 21:07:47 2022 +0000
KVM: arm64: vgic-v3: Restrict SEIS workaround to known broken systems
commit d11a327ed95dbec756b99cbfef2a7fd85c9eeb09 upstream.
Contrary to what df652bcf1136 ("KVM: arm64: vgic-v3: Work around GICv3
locally generated SErrors") was asserting, there is at least one other
system out there (Cavium ThunderX2) implementing SEIS, and not in
an obviously broken way.
So instead of imposing the M1 workaround on an innocent bystander,
let's limit it to the two known broken Apple implementations.
Fixes: df652bcf1136 ("KVM: arm64: vgic-v3: Work around GICv3 locally generated SErrors")
Reported-by: Ard Biesheuvel
Tested-by: Ard Biesheuvel
Acked-by: Ard Biesheuvel
Signed-off-by: Marc Zyngier
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220122103912.795026-1-maz@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 4b7740ab9fe97867201ea3a5850104402c0cb0bf
Author: Marc Zyngier
Date: Fri Jan 21 18:42:07 2022 +0000
KVM: arm64: Use shadow SPSR\_EL1 when injecting exceptions on !VHE
commit 278583055a237270fac70518275ba877bf9e4013 upstream.
Injecting an exception into a guest with non-VHE is risky business.
Instead of writing in the shadow register for the switch code to
restore it, we override the CPU register instead. Which gets
overriden a few instructions later by said restore code.
The result is that although the guest correctly gets the exception,
it will return to the original context in some random state,
depending on what was there the first place... Boo.
Fix the issue by writing to the shadow register. The original code
is absolutely fine on VHE, as the state is already loaded, and writing
to the shadow register in that case would actually be a bug.
Fixes: bb666c472ca2 ("KVM: arm64: Inject AArch64 exceptions from HYP")
Cc: stable@vger.kernel.org
Signed-off-by: Marc Zyngier
Reviewed-by: Fuad Tabba
Link: https://lore.kernel.org/r/20220121184207.423426-1-maz@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 7bb2b4df4cf9273b135f9a4b9e332bb4dbfecdcf
Author: Ard Biesheuvel
Date: Tue Jan 18 19:32:17 2022 +0100
ARM: 9180/1: Thumb2: align ALT\_UP() sections in modules sufficiently
commit 9f80ccda53b9417236945bc7ece4b519037df74d upstream.
When building for Thumb2, the .alt.smp.init sections that are emitted by
the ALT\_UP() patching code may not be 32-bit aligned, even though the
fixup\_smp\_on\_up() routine expects that. This results in alignment faults
at module load time, which need to be fixed up by the fault handler.
So let's align those sections explicitly, and prevent this from occurring.
Cc:
Signed-off-by: Ard Biesheuvel
Signed-off-by: Russell King (Oracle)
Signed-off-by: Greg Kroah-Hartman
commit 9d4190234e48dc1a764f85c95b381336ece7038c
Author: Ard Biesheuvel
Date: Tue Jan 18 13:45:09 2022 +0100
ARM: 9179/1: uaccess: avoid alignment faults in copy\_[from|to]\_kernel\_nofault
commit 15420269b02a63ed8c1841905d8b8b2403246004 upstream.
The helpers that are used to implement copy\_from\_kernel\_nofault() and
copy\_to\_kernel\_nofault() cast a void\* to a pointer to a wider type,
which may result in alignment faults on ARM if the compiler decides to
use double-word or multiple-word load/store instructions.
Only configurations that define CONFIG\_HAVE\_EFFICIENT\_UNALIGNED\_ACCESS=y
are affected, given that commit 2423de2e6f4d ("ARM: 9115/1: mm/maccess:
fix unaligned copy\_{from,to}\_kernel\_nofault") ensures that dst and src
are sufficiently aligned otherwise.
So use the unaligned accessors for accessing dst and src in cases where
they may be misaligned.
Cc:  # depends on 2423de2e6f4d
Fixes: 2df4c9a741a0 ("ARM: 9112/1: uaccess: add \_\_{get,put}\_kernel\_nofault")
Reviewed-by: Arnd Bergmann
Signed-off-by: Ard Biesheuvel
Signed-off-by: Russell King (Oracle)
Signed-off-by: Greg Kroah-Hartman
commit 2d9ccdb92d29851d20cac76ddf51e5d9e7d9478c
Author: Mohammad Athari Bin Ismail
Date: Wed Jan 26 17:47:23 2022 +0800
net: stmmac: skip only stmmac\_ptp\_register when resume from suspend
commit 0735e639f129dff455aeb91da291f5c578cc33db upstream.
When resume from suspend, besides skipping PTP registration, it also
skipping PTP HW initialization. This could cause PTP clock not able to
operate properly when resume from suspend.
To fix this, only stmmac\_ptp\_register() is skipped when resume from
suspend.
Fixes: fe1319291150 ("stmmac: Don't init ptp again when resume from suspend/hibernation")
Cc:  # 5.15.x
Signed-off-by: Mohammad Athari Bin Ismail
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 99ecb18ce2e0b563dac567212c87bf9c6d3d43c3
Author: Mohammad Athari Bin Ismail
Date: Wed Jan 26 17:47:22 2022 +0800
net: stmmac: configure PTP clock source prior to PTP initialization
commit 94c82de43e01ef5747a95e4a590880de863fe423 upstream.
For Intel platform, it is required to configure PTP clock source prior PTP
initialization in MAC. So, need to move ptp\_clk\_freq\_config execution from
stmmac\_ptp\_register() to stmmac\_init\_ptp().
Fixes: 76da35dc99af ("stmmac: intel: Add PSE and PCH PTP clock source selection")
Cc:  # 5.15.x
Signed-off-by: Mohammad Athari Bin Ismail
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f4d8610a92d6dc9f12cdbb34f2f28f33093a0c27
Author: Marek Behún
Date: Wed Jan 19 17:44:55 2022 +0100
net: sfp: ignore disabled SFP node
commit 2148927e6ed43a1667baf7c2ae3e0e05a44b51a0 upstream.
Commit ce0aa27ff3f6 ("sfp: add sfp-bus to bridge between network devices
and sfp cages") added code which finds SFP bus DT node even if the node
is disabled with status = "disabled". Because of this, when phylink is
created, it ends with non-null .sfp\_bus member, even though the SFP
module is not probed (because the node is disabled).
We need to ignore disabled SFP bus node.
Fixes: ce0aa27ff3f6 ("sfp: add sfp-bus to bridge between network devices and sfp cages")
Signed-off-by: Marek Behún
Cc: stable@vger.kernel.org # 2203cbf2c8b5 ("net: sfp: move fwnode parsing into sfp-bus layer")
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6f75f8ecd51f22e4505ace721373d473022a4c5b
Author: Marc Kleine-Budde
Date: Fri Jan 14 15:35:01 2022 +0100
can: m\_can: m\_can\_fifo\_{read,write}: don't read or write from/to FIFO if length is 0
commit db72589c49fd260bfc99c7160c079675bc7417af upstream.
In order to optimize FIFO access, especially on m\_can cores attached
to slow busses like SPI, in patch
| e39381770ec9 ("can: m\_can: Disable IRQs on FIFO bus errors")
bulk read/write support has been added to the m\_can\_fifo\_{read,write}
functions.
That change leads to the tcan driver to call
regmap\_bulk\_{read,write}() with a length of 0 (for CAN frames with 0
data length). regmap treats this as an error:
| tcan4x5x spi1.0 tcan4x5x0: FIFO write returned -22
This patch fixes the problem by not calling the
cdev->ops->{read,write)\_fifo() in case of a 0 length read/write.
Fixes: e39381770ec9 ("can: m\_can: Disable IRQs on FIFO bus errors")
Link: https://lore.kernel.org/all/20220114155751.2651888-1-mkl@pengutronix.de
Cc: stable@vger.kernel.org
Cc: Matt Kline
Cc: Chandrasekar Ramakrishnan
Reported-by: Michael Anochin
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 7a8b052a254b5334a3845ea7db0f22576503787d
Author: Filipe Manana
Date: Thu Jan 20 17:41:17 2022 +0000
btrfs: update writeback index when starting defrag
commit 27cdfde181bcacd226c230b2fd831f6f5b8c215f upstream.
When starting a defrag, we should update the writeback index of the
inode's mapping in case it currently has a value beyond the start of the
range we are defragging. This can help performance and often result in
getting less extents after writeback - for e.g., if the current value
of the writeback index sits somewhere in the middle of a range that
gets dirty by the defrag, then after writeback we can get two smaller
extents instead of a single, larger extent.
We used to have this before the refactoring in 5.16, but it was removed
without any reason to do so. Originally it was added in kernel 3.1, by
commit 2a0f7f5769992b ("Btrfs: fix recursive auto-defrag"), in order to
fix a loop with autodefrag resulting in dirtying and writing pages over
and over, but some testing on current code did not show that happening,
at least with the test described in that commit.
So add back the behaviour, as at the very least it is a nice to have
optimization.
Fixes: 7b508037d4cac3 ("btrfs: defrag: use defrag\_one\_cluster() to implement btrfs\_defrag\_file()")
CC: stable@vger.kernel.org # 5.16
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 895da68803b87347a0dec6710f932fa7bd1210ca
Author: Filipe Manana
Date: Thu Jan 20 17:11:52 2022 +0000
btrfs: add back missing dirty page rate limiting to defrag
commit 3c9d31c715948aaff0ee6d322a91a2dec07770bf upstream.
A defrag operation can dirty a lot of pages, specially if operating on
the entire file or a large file range. Any task dirtying pages should
periodically call balance\_dirty\_pages\_ratelimited(), as stated in that
function's comments, otherwise they can leave too many dirty pages in
the system. This is what we did before the refactoring in 5.16, and
it should have remained, just like in the buffered write path and
relocation. So restore that behaviour.
Fixes: 7b508037d4cac3 ("btrfs: defrag: use defrag\_one\_cluster() to implement btrfs\_defrag\_file()")
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Qu Wenruo
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit f56722d60db0661defd2d6fc83a559ee340f3084
Author: Filipe Manana
Date: Thu Jan 20 14:27:56 2022 +0000
btrfs: fix deadlock when reserving space during defrag
commit 0cb5950f3f3b51a4e8657d106f897f2b913e0586 upstream.
When defragging we can end up collecting a range for defrag that has
already pages under delalloc (dirty), as long as the respective extent
map for their range is not mapped to a hole, a prealloc extent or
the extent map is from an old generation.
Most of the time that is harmless from a functional perspective at
least, however it can result in a deadlock:
1) At defrag\_collect\_targets() we find an extent map that meets all
requirements but there's delalloc for the range it covers, and we add
its range to list of ranges to defrag;
2) The defrag\_collect\_targets() function is called at defrag\_one\_range(),
after it locked a range that overlaps the range of the extent map;
3) At defrag\_one\_range(), while the range is still locked, we call
defrag\_one\_locked\_target() for the range associated to the extent
map we collected at step 1);
4) Then finally at defrag\_one\_locked\_target() we do a call to
btrfs\_delalloc\_reserve\_space(), which will reserve data and metadata
space. If the space reservations can not be satisfied right away, the
flusher might be kicked in and start flushing delalloc and wait for
the respective ordered extents to complete. If this happens we will
deadlock, because both flushing delalloc and finishing an ordered
extent, requires locking the range in the inode's io tree, which was
already locked at defrag\_collect\_targets().
So fix this by skipping extent maps for which there's already delalloc.
Fixes: eb793cf857828d ("btrfs: defrag: introduce helper to collect target file extents")
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Qu Wenruo
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 6f32d917ee16fb597597df0c3f5beb015999738c
Author: Qu Wenruo
Date: Tue Jan 18 19:53:52 2022 +0800
btrfs: defrag: properly update range->start for autodefrag
commit c080b4144b9dd3b7af838a194ffad3204ca15166 upstream.
[BUG]
After commit 7b508037d4ca ("btrfs: defrag: use defrag\_one\_cluster() to
implement btrfs\_defrag\_file()") autodefrag no longer properly re-defrag
the file from previously finished location.
[CAUSE]
The recent refactoring of defrag only focuses on defrag ioctl subpage
support, doesn't take autodefrag into consideration.
There are two problems involved which prevents autodefrag to restart its
scan:
- No range.start update
Previously when one defrag target is found, range->start will be
updated to indicate where next search should start from.
But now btrfs\_defrag\_file() doesn't update it anymore, making all
autodefrag to rescan from file offset 0.
This would also make autodefrag to mark the same range dirty again and
again, causing extra IO.
- No proper quick exit for defrag\_one\_cluster()
Currently if we reached or exceed @max\_sectors limit, we just exit
defrag\_one\_cluster(), and let next defrag\_one\_cluster() call to do a
quick exit.
This makes @cur increase, thus no way to properly know which range is
defragged and which range is skipped.
[FIX]
The fix involves two modifications:
- Update range->start to next cluster start
This is a little different from the old behavior.
Previously range->start is updated to the next defrag target.
But in the end, the behavior should still be pretty much the same,
as now we skip to next defrag target inside btrfs\_defrag\_file().
Thus if auto-defrag determines to re-scan, then we still do the skip,
just at a different timing.
- Make defrag\_one\_cluster() to return >0 to indicate a quick exit
So that btrfs\_defrag\_file() can also do a quick exit, without
increasing @cur to the range end, and re-use @cur to update
@range->start.
- Add comment for btrfs\_defrag\_file() to mention the range->start update
Currently only autodefrag utilize this behavior, as defrag ioctl won't
set @max\_to\_defrag parameter, thus unless interrupted it will always
try to defrag the whole range.
Reported-by: Filipe Manana
Fixes: 7b508037d4ca ("btrfs: defrag: use defrag\_one\_cluster() to implement btrfs\_defrag\_file()")
Link: https://lore.kernel.org/linux-btrfs/0a269612-e43f-da22-c5bc-b34b1b56ebe8@mailbox.org/
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Filipe Manana
Signed-off-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 8923f11810889165717501813dc54fb7b3e2dcae
Author: Qu Wenruo
Date: Tue Jan 18 15:19:04 2022 +0800
btrfs: defrag: fix wrong number of defragged sectors
commit 484167da77739a8d0e225008c48e697fd3f781ae upstream.
[BUG]
There are users using autodefrag mount option reporting obvious increase
in IO:
> If I compare the write average (in total, I don't have it per process)
> when taking idle periods on the same machine:
> Linux 5.16:
> without autodefrag: ~ 10KiB/s
> with autodefrag: between 1 and 2MiB/s.
>
> Linux 5.15:
> with autodefrag:~ 10KiB/s (around the same as without
> autodefrag on 5.16)
[CAUSE]
When autodefrag mount option is enabled, btrfs\_defrag\_file() will be
called with @max\_sectors = BTRFS\_DEFRAG\_BATCH (1024) to limit how many
sectors we can defrag in one try.
And then use the number of sectors defragged to determine if we need to
re-defrag.
But commit b18c3ab2343d ("btrfs: defrag: introduce helper to defrag one
cluster") uses wrong unit to increase @sectors\_defragged, which should
be in unit of sector, not byte.
This means, if we have defragged any sector, then @sectors\_defragged
will be >= sectorsize (normally 4096), which is larger than
BTRFS\_DEFRAG\_BATCH.
This makes the @max\_sectors check in defrag\_one\_cluster() to underflow,
rendering the whole @max\_sectors check useless.
Thus causing way more IO for autodefrag mount options, as now there is
no limit on how many sectors can really be defragged.
[FIX]
Fix the problems by:
- Use sector as unit when increasing @sectors\_defragged
- Include @sectors\_defragged > @max\_sectors case to break the loop
- Add extra comment on the return value of btrfs\_defrag\_file()
Reported-by: Anthony Ruhier
Fixes: b18c3ab2343d ("btrfs: defrag: introduce helper to defrag one cluster")
Link: https://lore.kernel.org/linux-btrfs/0a269612-e43f-da22-c5bc-b34b1b56ebe8@mailbox.org/
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Filipe Manana
Signed-off-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 1ad0917c8cde6bddc0d3289762350ea4feeaf228
Author: Filipe Manana
Date: Tue Jan 18 13:43:31 2022 +0000
btrfs: allow defrag to be interruptible
commit b767c2fc787e992daeadfff40d61c05f66c82da0 upstream.
During defrag, at btrfs\_defrag\_file(), we have this loop that iterates
over a file range in steps no larger than 256K subranges. If the range
is too long, there's no way to interrupt it. So make the loop check in
each iteration if there's signal pending, and if there is, break and
return -AGAIN to userspace.
Before kernel 5.16, we used to allow defrag to be cancelled through a
signal, but that was lost with commit 7b508037d4cac3 ("btrfs: defrag:
use defrag\_one\_cluster() to implement btrfs\_defrag\_file()").
This change adds back the possibility to cancel a defrag with a signal
and keeps the same semantics, returning -EAGAIN to user space (and not
the usually more expected -EINTR).
This is also motivated by a recent bug on 5.16 where defragging a 1 byte
file resulted in iterating from file range 0 to (u64)-1, as hitting the
bug triggered a too long loop, basically requiring one to reboot the
machine, as it was not possible to cancel defrag.
Fixes: 7b508037d4cac3 ("btrfs: defrag: use defrag\_one\_cluster() to implement btrfs\_defrag\_file()")
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Qu Wenruo
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit bac3babdabdc53f8f47b513cff805b3b98c467bb
Author: Filipe Manana
Date: Mon Jan 17 16:28:29 2022 +0000
btrfs: fix too long loop when defragging a 1 byte file
commit 6b34cd8e175bfbf4f3f01b6d19eae18245e1a8cc upstream.
When attempting to defrag a file with a single byte, we can end up in a
too long loop, which is nearly infinite because at btrfs\_defrag\_file()
we end up with the variable last\_byte assigned with a value of
18446744073709551615 (which is (u64)-1). The problem comes from the fact
we end up doing:
last\_byte = round\_up(last\_byte, fs\_info->sectorsize) - 1;
So if last\_byte was assigned 0, which is i\_size - 1, we underflow and
end up with the value 18446744073709551615.
This is trivial to reproduce and the following script triggers it:
$ cat test.sh
#!/bin/bash
DEV=/dev/sdj
MNT=/mnt/sdj
mkfs.btrfs -f $DEV
mount $DEV $MNT
echo -n "X" > $MNT/foobar
btrfs filesystem defragment $MNT/foobar
umount $MNT
So fix this by not decrementing last\_byte by 1 before doing the sector
size round up. Also, to make it easier to follow, make the round up right
after computing last\_byte.
Reported-by: Anthony Ruhier
Fixes: 7b508037d4cac3 ("btrfs: defrag: use defrag\_one\_cluster() to implement btrfs\_defrag\_file()")
Link: https://lore.kernel.org/linux-btrfs/0a269612-e43f-da22-c5bc-b34b1b56ebe8@mailbox.org/
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Qu Wenruo
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 5c968affa804ba98c3c603f37ffea6fba618025e
Author: Brian Gix
Date: Wed Nov 24 12:16:28 2021 -0800
Bluetooth: refactor malicious adv data check
commit 899663be5e75dc0174dc8bda0b5e6826edf0b29a upstream.
Check for out-of-bound read was being performed at the end of while
num\_reports loop, and would fill journal with false positives. Added
check to beginning of loop processing so that it doesn't get checked
after ptr has been advanced.
Signed-off-by: Brian Gix
Signed-off-by: Marcel Holtmann
Cc: syphyr
Signed-off-by: Greg Kroah-Hartman


=== Content from www.debian.org_9dfdb833_20250114_220036.html ===


---

[[Date Prev](msg00062.html)][[Date Next](msg00064.html)]
[[Thread Prev](msg00062.html)][[Thread Next](msg00064.html)]
[[Date Index](maillist.html#00063)]
[[Thread Index](threads.html#00063)]

# [SECURITY] [DSA 5096-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 5096-1] linux security update
* *From*: Salvatore Bonaccorso <carnil@debian.org>
* *Date*: Wed, 09 Mar 2022 15:30:58 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1nRyHC-0004Le-Lx%40seger.debian.org) [E1nRyHC-0004Le-Lx@seger.debian.org](msg00063.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-5096-1                   security@debian.org
<https://www.debian.org/security/>                     Salvatore Bonaccorso
March 09, 2022                        <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2020-29374 CVE-2020-36322 CVE-2021-3640 CVE-2021-3744
                 CVE-2021-3752 CVE-2021-3760 CVE-2021-3764 CVE-2021-3772
                 CVE-2021-4002 CVE-2021-4083 CVE-2021-4135 CVE-2021-4155
                 CVE-2021-4203 CVE-2021-20317 CVE-2021-20321 CVE-2021-20322
                 CVE-2021-22600 CVE-2021-28711 CVE-2021-28712 CVE-2021-28713
                 CVE-2021-28714 CVE-2021-28715 CVE-2021-28950 CVE-2021-38300
                 CVE-2021-39685 CVE-2021-39686 CVE-2021-39698 CVE-2021-39713
                 CVE-2021-41864 CVE-2021-42739 CVE-2021-43389 CVE-2021-43975
                 CVE-2021-43976 CVE-2021-44733 CVE-2021-45095 CVE-2021-45469
                 CVE-2021-45480 CVE-2022-0001 CVE-2022-0002 CVE-2022-0322
                 CVE-2022-0330 CVE-2022-0435 CVE-2022-0487 CVE-2022-0492
                 CVE-2022-0617 CVE-2022-0644 CVE-2022-22942 CVE-2022-24448
                 CVE-2022-24959 CVE-2022-25258 CVE-2022-25375
Debian Bug     : 988044 989285 990411 994050

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2020-29374

    Jann Horn of Google reported a flaw in Linux's virtual memory
    management.  A parent and child process initially share all their
    memory, but when either writes to a shared page, the page is
    duplicated and unshared (copy-on-write).  However, in case an
    operation such as vmsplice() required the kernel to take an
    additional reference to a shared page, and a copy-on-write occurs
    during this operation, the kernel might have accessed the wrong
    process's memory.  For some programs, this could lead to an
    information leak or data corruption.

    This issue was already fixed for most architectures, but not on
    MIPS and System z.  This update corrects that.

CVE-2020-36322, CVE-2021-28950

    The syzbot tool found that the FUSE (filesystem-in-user-space)
    implementation did not correctly handle a FUSE server returning
    invalid attributes for a file.  A local user permitted to run a
    FUSE server could use this to cause a denial of service (crash).

    The original fix for this introduced a different potential denial
    of service (infinite loop in kernel space), which has also been
    fixed.

CVE-2021-3640

    Lin Ma discovered a race condiiton in the Bluetooth protocol
    implementation that can lead to a use-after-free.  A local
    user could exploit this to cause a denial of service (memory
    corruption or crash) or possibly for privilege escalation.

CVE-2021-3744, CVE-2021-3764

    minihanshen reported bugs in the ccp driver for AMD
    Cryptographic Coprocessors that could lead to a resource leak.
    On systems using this driver, a local user could exploit this to
    cause a denial of service.

CVE-2021-3752

    Likang Luo of NSFOCUS Security Team discovered a flaw in the
    Bluetooth L2CAP implementation that can lead to a user-after-free.
    A local user could exploit this to cause a denial of service
    (memory corruption or crash) or possibly for privilege escalation.

CVE-2021-3760, CVE-2021-4202

    Lin Ma discovered race conditions in the NCI (NFC Controller
    Interface) driver, which could lead to a use-after-free.  A local
    user could exploit this to cause a denial of service (memory
    corruption or crash) or possibly for privilege escalation.

    This driver is not enabled in Debian's official kernel
    configurations.

CVE-2021-3772

    A flaw was found in the SCTP protocol implementation, which would
    allow a networked attacker to break an SCTP association.  The
    attacker would only need to know or guess the IP addresses and
    ports for the association.

CVE-2021-4002

    It was discovered that hugetlbfs, the virtual filesystem used by
    applications to allocate huge pages in RAM, did not flush the
    CPU's TLB in one case where it was necessary.  In some
    circumstances a local user would be able to read and write huge
    pages after they are freed and reallocated to a different process.
    This could lead to privilege escalation, denial of service or
    information leaks.

CVE-2021-4083

    Jann Horn reported a race condition in the local (Unix) sockets
    garbage collector, that can lead to use-after-free.  A local user
    could exploit this to cause a denial of service (memory corruption
    or crash) or possibly for privilege escalation.

CVE-2021-4135

    A flaw was found in the netdevsim driver which would lead to an
    information leak.

    This driver is not enabled in Debian's official kernel
    configurations.

CVE-2021-4155

    Kirill Tkhai discovered a data leak in the way the XFS_IOC_ALLOCSP
    IOCTL in the XFS filesystem allowed for a size increase of files
    with unaligned size. A local attacker can take advantage of this
    flaw to leak data on the XFS filesystem.

CVE-2021-4203

    Jann Horn reported a race condition in the local (Unix) sockets
    implementation that can lead to a use-after-free.  A local user
    could exploit this to leak sensitive information from the kernel.

CVE-2021-20317

    It was discovered that the timer queue structure could become
    corrupt, leading to waiting tasks never being woken up.  A local
    user with certain privileges could exploit this to cause a denial
    of service (system hang).

CVE-2021-20321

    A race condition was discovered in the overlayfs filesystem
    driver.  A local user with access to an overlayfs mount and to its
    underlying upper directory could exploit this for privilege
    escalation.

CVE-2021-20322

    An information leak was discovered in the IPv4 implementation.  A
    remote attacker could exploit this to quickly discover which UDP
    ports a system is using, making it easier for them to carry out a
    DNS poisoning attack against that system.

CVE-2021-22600

    The syzbot tool found a flaw in the packet socket (AF_PACKET)
    implementation which could lead to incorrectly freeing memory.  A
    local user with CAP_NET_RAW capability (in any user namespace)
    could exploit this for denial of service (memory corruption or
    crash) or possibly for privilege escalation.

CVE-2021-28711, CVE-2021-28712, CVE-2021-28713 (XSA-391)

    Juergen Gross reported that malicious PV backends can cause a denial
    of service to guests being serviced by those backends via high
    frequency events, even if those backends are running in a less
    privileged environment.

CVE-2021-28714, CVE-2021-28715 (XSA-392)

    Juergen Gross discovered that Xen guests can force the Linux
    netback driver to hog large amounts of kernel memory, resulting in
    denial of service.

CVE-2021-38300

    Piotr Krysiuk discovered a flaw in the classic BPF (cBPF) JIT
    compiler for MIPS architectures.  A local user could exploit
    this to excute arbitrary code in the kernel.

    This issue is mitigated by setting sysctl
    net.core.bpf_jit_enable=0, which is the default.  It is *not*
    mitigated by disabling unprivileged use of eBPF.

CVE-2021-39685

    Szymon Heidrich discovered a buffer overflow vulnerability in the
    USB gadget subsystem, resulting in information disclosure, denial of
    service or privilege escalation.

CVE-2021-39686

    A race condition was discovered in the Android binder driver, that
    could lead to incorrect security checks.  On systems where the
    binder driver is loaded, a local user could exploit this for
    privilege escalation.

CVE-2021-39698

    Linus Torvalds reported a flaw in the file polling implementation,
    which could lead to a use-after-free.  A local user could exploit
    this for denial of service (memory corruption or crash) or
    possibly for privilege escalation.

CVE-2021-39713

    The syzbot tool found a race condition in the network scheduling
    subsystem which could lead to a use-after-free.  A local user
    could exploit this for denial of service (memory corruption or
    crash) or possibly for privilege escalation.

CVE-2021-41864

    An integer overflow was discovered in the Extended BPF (eBPF)
    subsystem.  A local user could exploit this for denial of service
    (memory corruption or crash), or possibly for privilege
    escalation.

    This can be mitigated by setting sysctl
    kernel.unprivileged_bpf_disabled=1, which disables eBPF use by
    unprivileged users.

CVE-2021-42739

    A heap buffer overflow was discovered in the firedtv driver for
    FireWire-connected DVB receivers.  A local user with access to a
    firedtv device could exploit this for denial of service (memory
    corruption or crash), or possibly for privilege escalation.

CVE-2021-43389

    The Active Defense Lab of Venustech discovered a flaw in the CMTP
    subsystem as used by Bluetooth, which could lead to an
    out-of-bounds read and object type confusion.  A local user with
    CAP_NET_ADMIN capability in the initial user namespace could
    exploit this for denial of service (memory corruption or crash),
    or possibly for privilege escalation.

CVE-2021-43975

    Brendan Dolan-Gavitt reported a flaw in the
    hw_atl_utils_fw_rpc_wait() function in the aQuantia AQtion ethernet
    device driver which can result in denial of service or the execution
    of arbitrary code.

CVE-2021-43976

    Zekun Shen and Brendan Dolan-Gavitt discovered a flaw in the
    mwifiex_usb_recv() function of the Marvell WiFi-Ex USB Driver. An
    attacker able to connect a crafted USB device can take advantage of
    this flaw to cause a denial of service.

CVE-2021-44733

    A race condition was discovered in the Trusted Execution
    Environment (TEE) subsystem for Arm processors, which could lead
    to a use-after-free.  A local user permitted to access a TEE
    device could exploit this for denial of service (memory corruption
    or crash) or possibly for privilege escalation.

CVE-2021-45095

    It was discovered that the Phone Network protocol (PhoNet) driver
    has a reference count leak in the pep_sock_accept() function.

CVE-2021-45469

    Wenqing Liu reported an out-of-bounds memory access in the f2fs
    implementation if an inode has an invalid last xattr entry. An
    attacker able to mount a specially crafted image can take advantage
    of this flaw for denial of service.

CVE-2021-45480

    A memory leak flaw was discovered in the __rds_conn_create()
    function in the RDS (Reliable Datagram Sockets) protocol subsystem.

CVE-2022-0001 (INTEL-SA-00598)

    Researchers at VUSec discovered that the Branch History Buffer in
    Intel processors can be exploited to create information side-
    channels with speculative execution.  This issue is similar to
    Spectre variant 2, but requires additional mitigations on some
    processors.

    This can be exploited to obtain sensitive information from a
    different security context, such as from user-space to the kernel,
    or from a KVM guest to the kernel.

CVE-2022-0002 (INTEL-SA-00598)

    This is a similar issue to CVE-2022-0001, but covers exploitation
    within a security context, such as from JIT-compiled code in a
    sandbox to hosting code in the same process.

    This can be partly mitigated by disabling eBPF for unprivileged
    users with the sysctl: kernel.unprivileged_bpf_disabled=2.  This
    update does that by default.

CVE-2022-0322

    Eiichi Tsukata discovered a flaw in the sctp_make_strreset_req()
    function in the SCTP network protocol implementation which can
    result in denial of service.

CVE-2022-0330

    Sushma Venkatesh Reddy discovered a missing GPU TLB flush in the
    i915 driver, resulting in denial of service or privilege escalation.

CVE-2022-0435

    Samuel Page and Eric Dumazet reported a stack overflow in the
    networking module for the Transparent Inter-Process Communication
    (TIPC) protocol, resulting in denial of service or potentially the
    execution of arbitrary code.

CVE-2022-0487

    A use-after-free was discovered in the MOXART SD/MMC Host Controller
    support driver. This flaw does not impact the Debian binary packages
    as CONFIG_MMC_MOXART is not set.

CVE-2022-0492

    Yiqi Sun and Kevin Wang reported that the cgroup-v1 subsystem does
    not properly restrict access to the release-agent feature. A local
    user can take advantage of this flaw for privilege escalation and
    bypass of namespace isolation.

CVE-2022-0617

    butt3rflyh4ck discovered a NULL pointer dereference in the UDF
    filesystem. A local user that can mount a specially crafted UDF
    image can use this flaw to crash the system.

CVE-2022-0644

    Hao Sun reported a missing check for file read permission in the
    finit_module() and kexec_file_load() system calls.  The security
    impact of this is unclear, since these system calls are usually
    only available to the root user.

CVE-2022-22942

    It was discovered that wrong file file descriptor handling in the
    VMware Virtual GPU driver (vmwgfx) could result in information leak
    or privilege escalation.

CVE-2022-24448

    Lyu Tao reported a flaw in the NFS implementation in the Linux
    kernel when handling requests to open a directory on a regular file,
    which could result in a information leak.

CVE-2022-24959

    A memory leak was discovered in the yam_siocdevprivate() function of
    the YAM driver for AX.25, which could result in denial of service.

CVE-2022-25258

    Szymon Heidrich reported the USB Gadget subsystem lacks certain
    validation of interface OS descriptor requests, resulting in memory
    corruption.

CVE-2022-25375

    Szymon Heidrich reported that the RNDIS USB gadget lacks validation
    of the size of the RNDIS_MSG_SET command, resulting in information
    leak from kernel memory.

For the oldstable distribution (buster), these problems have been
fixed in version 4.19.232-1.  This update additionally includes many
more bug fixes from stable updates 4.19.209-4.19.232 inclusive.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAmIotm1fFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0RcGg//QBgf4RfElxd+11a+BZ9HWJFBjA5Wp2VStf1+inoZ7X/En7W9QBpVvmks
Jum5QFpvA1waEP0zk0/O5MKXHtMbRMFdj0UUYQM7Vi3/vfeP73C10YmXv2yfG2Fw
dTGnVHpvvdJSbNzxMG4jruNY5b0Bf/WEQSqtuOM6V2aBiI7Y2pSI6Ak/dvexiu+0
ycz6PTDkX66e/p7NONw+B33L8yTMj9yu1cCdoYdrDihVlrESgbMLHUWO9JKRQykk
tsI2a79OIEkaj+yQwfkJu9njoPUTn6OZYUYxD8XaN8XtkDpwx1oVsiyqpslJEmgR
vaS1DOEnIZXsq2pscSPeKfFM30uFgqAxkQm/zUpjGGSXib58xaaf/c61LCQoMU2g
cSc+8+N1S2Lbcscdxd9TumvrOGJVuP/q/FqcOl4npcz1WLZRmc9f9IprdqUEy2iJ
+YLSrFFOfhgMMP0El6KJvG/8Jz60UEAiWuYutT508w1jIRrvMRLW4i6V3NXHrNkx
GDofOfPF8jNdt2Www+2sqEY51f+w2kffOSAnHGGPCASvWpuXFOw9ZyxnuyRRKKBE
no9PH0X71a636sZGh8bIU25PSKQlhtlAfCP+0Fef7PeEKTz1MJf8Nvo+vgCIsani
eGWa9jzdkVxHDEjxplX0stsByglCYyud7JSI1ZE9oLtJU1/xDBc=
=5fQT
-----END PGP SIGNATURE-----

```

---



=== Content from lists.debian.org_1447e1a3_20250114_220034.html ===


---

[[Date Prev](msg00011.html)][[Date Next](msg00013.html)]
[[Thread Prev](msg00011.html)][[Thread Next](msg00013.html)]
[[Date Index](maillist.html#00012)]
[[Thread Index](threads.html#00012)]

# [SECURITY] [DLA 2941-1] linux-4.19 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 2941-1] linux-4.19 security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Wed, 9 Mar 2022 13:40:55 +0100
* *Message-id*: <[[🔎]](/msgid-search/YiigV99QQ%2BwYNpB3%40decadent.org.uk) [YiigV99QQ+wYNpB3@decadent.org.uk](msg00012.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-2941-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
March 09, 2022                                <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux-4.19
Version        : 4.19.232-1~deb9u1
CVE ID         : CVE-2020-29374 CVE-2020-36322 CVE-2021-3640 CVE-2021-3744
                 CVE-2021-3752 CVE-2021-3760 CVE-2021-3764 CVE-2021-3772
                 CVE-2021-4002 CVE-2021-4083 CVE-2021-4135 CVE-2021-4155
                 CVE-2021-4203 CVE-2021-20317 CVE-2021-20321 CVE-2021-20322
                 CVE-2021-22600 CVE-2021-28711 CVE-2021-28712 CVE-2021-28713
                 CVE-2021-28714 CVE-2021-28715 CVE-2021-28950 CVE-2021-38300
                 CVE-2021-39685 CVE-2021-39686 CVE-2021-39698 CVE-2021-39713
                 CVE-2021-41864 CVE-2021-42739 CVE-2021-43389 CVE-2021-43975
                 CVE-2021-43976 CVE-2021-44733 CVE-2021-45095 CVE-2021-45469
                 CVE-2021-45480 CVE-2022-0001 CVE-2022-0002 CVE-2022-0322
                 CVE-2022-0330 CVE-2022-0435 CVE-2022-0487 CVE-2022-0492
                 CVE-2022-0617 CVE-2022-0644 CVE-2022-22942 CVE-2022-24448
                 CVE-2022-24959 CVE-2022-25258 CVE-2022-25375
Debian Bug     : 988044 989285 990411 994050

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2020-29374

    Jann Horn of Google reported a flaw in Linux's virtual memory
    management.  A parent and child process initially share all their
    memory, but when either writes to a shared page, the page is
    duplicated and unshared (copy-on-write).  However, in case an
    operation such as vmsplice() required the kernel to take an
    additional reference to a shared page, and a copy-on-write occurs
    during this operation, the kernel might have accessed the wrong
    process's memory.  For some programs, this could lead to an
    information leak or data corruption.

    This issue was already fixed for most architectures, but not on
    MIPS and System z.  This update corrects that.

CVE-2020-36322, CVE-2021-28950

    The syzbot tool found that the FUSE (filesystem-in-user-space)
    implementation did not correctly handle a FUSE server returning
    invalid attributes for a file.  A local user permitted to run a
    FUSE server could use this to cause a denial of service (crash).

    The original fix for this introduced a different potential denial
    of service (infinite loop in kernel space), which has also been
    fixed.

CVE-2021-3640

    Lin Ma discovered a race condiiton in the Bluetooth protocol
    implementation that can lead to a use-after-free.  A local
    user could exploit this to cause a denial of service (memory
    corruption or crash) or possibly for privilege escalation.

CVE-2021-3744, CVE-2021-3764

    minihanshen reported bugs in the ccp driver for AMD
    Cryptographic Coprocessors that could lead to a resource leak.
    On systems using this driver, a local user could exploit this to
    cause a denial of service.

CVE-2021-3752

    Likang Luo of NSFOCUS Security Team discovered a flaw in the
    Bluetooth L2CAP implementation that can lead to a user-after-free.
    A local user could exploit this to cause a denial of service
    (memory corruption or crash) or possibly for privilege escalation.

CVE-2021-3760, CVE-2021-4202

    Lin Ma discovered race conditions in the NCI (NFC Controller
    Interface) driver, which could lead to a use-after-free.  A local
    user could exploit this to cause a denial of service (memory
    corruption or crash) or possibly for privilege escalation.

    This driver is not enabled in Debian's official kernel
    configurations.

CVE-2021-3772

    A flaw was found in the SCTP protocol implementation, which would
    allow a networked attacker to break an SCTP association.  The
    attacker would only need to know or guess the IP addresses and
    ports for the association.

CVE-2021-4002

    It was discovered that hugetlbfs, the virtual filesystem used by
    applications to allocate huge pages in RAM, did not flush the
    CPU's TLB in one case where it was necessary.  In some
    circumstances a local user would be able to read and write huge
    pages after they are freed and reallocated to a different process.
    This could lead to privilege escalation, denial of service or
    information leaks.

CVE-2021-4083

    Jann Horn reported a race condition in the local (Unix) sockets
    garbage collector, that can lead to use-after-free.  A local user
    could exploit this to cause a denial of service (memory corruption
    or crash) or possibly for privilege escalation.

CVE-2021-4135

    A flaw was found in the netdevsim driver which would lead to an
    information leak.

    This driver is not enabled in Debian's official kernel
    configurations.

CVE-2021-4155

    Kirill Tkhai discovered a data leak in the way the XFS_IOC_ALLOCSP
    IOCTL in the XFS filesystem allowed for a size increase of files
    with unaligned size. A local attacker can take advantage of this
    flaw to leak data on the XFS filesystem.

CVE-2021-4203

    Jann Horn reported a race condition in the local (Unix) sockets
    implementation that can lead to a use-after-free.  A local user
    could exploit this to leak sensitive information from the kernel.

CVE-2021-20317

    It was discovered that the timer queue structure could become
    corrupt, leading to waiting tasks never being woken up.  A local
    user with certain privileges could exploit this to cause a denial
    of service (system hang).

CVE-2021-20321

    A race condition was discovered in the overlayfs filesystem
    driver.  A local user with access to an overlayfs mount and to its
    underlying upper directory could exploit this for privilege
    escalation.

CVE-2021-20322

    An information leak was discovered in the IPv4 implementation.  A
    remote attacker could exploit this to quickly discover which UDP
    ports a system is using, making it easier for them to carry out a
    DNS poisoning attack against that system.

CVE-2021-22600

    The syzbot tool found a flaw in the packet socket (AF_PACKET)
    implementation which could lead to incorrectly freeing memory.  A
    local user with CAP_NET_RAW capability (in any user namespace)
    could exploit this for denial of service (memory corruption or
    crash) or possibly for privilege escalation.

CVE-2021-28711, CVE-2021-28712, CVE-2021-28713 (XSA-391)

    Juergen Gross reported that malicious PV backends can cause a denial
    of service to guests being serviced by those backends via high
    frequency events, even if those backends are running in a less
    privileged environment.

CVE-2021-28714, CVE-2021-28715 (XSA-392)

    Juergen Gross discovered that Xen guests can force the Linux
    netback driver to hog large amounts of kernel memory, resulting in
    denial of service.

CVE-2021-38300

    Piotr Krysiuk discovered a flaw in the classic BPF (cBPF) JIT
    compiler for MIPS architectures.  A local user could exploit
    this to excute arbitrary code in the kernel.

    This issue is mitigated by setting sysctl
    net.core.bpf_jit_enable=0, which is the default.  It is *not*
    mitigated by disabling unprivileged use of eBPF.

CVE-2021-39685

    Szymon Heidrich discovered a buffer overflow vulnerability in the
    USB gadget subsystem, resulting in information disclosure, denial of
    service or privilege escalation.

CVE-2021-39686

    A race condition was discovered in the Android binder driver, that
    could lead to incorrect security checks.  On systems where the
    binder driver is loaded, a local user could exploit this for
    privilege escalation.

CVE-2021-39698

    Linus Torvalds reported a flaw in the file polling implementation,
    which could lead to a use-after-free.  A local user could exploit
    this for denial of service (memory corruption or crash) or
    possibly for privilege escalation.

CVE-2021-39713

    The syzbot tool found a race condition in the network scheduling
    subsystem which could lead to a use-after-free.  A local user
    could exploit this for denial of service (memory corruption or
    crash) or possibly for privilege escalation.

CVE-2021-41864

    An integer overflow was discovered in the Extended BPF (eBPF)
    subsystem.  A local user could exploit this for denial of service
    (memory corruption or crash), or possibly for privilege
    escalation.

    This can be mitigated by setting sysctl
    kernel.unprivileged_bpf_disabled=1, which disables eBPF use by
    unprivileged users.

CVE-2021-42739

    A heap buffer overflow was discovered in the firedtv driver for
    FireWire-connected DVB receivers.  A local user with access to a
    firedtv device could exploit this for denial of service (memory
    corruption or crash), or possibly for privilege escalation.

CVE-2021-43389

    The Active Defense Lab of Venustech discovered a flaw in the CMTP
    subsystem as used by Bluetooth, which could lead to an
    out-of-bounds read and object type confusion.  A local user with
    CAP_NET_ADMIN capability in the initial user namespace could
    exploit this for denial of service (memory corruption or crash),
    or possibly for privilege escalation.

CVE-2021-43975

    Brendan Dolan-Gavitt reported a flaw in the
    hw_atl_utils_fw_rpc_wait() function in the aQuantia AQtion ethernet
    device driver which can result in denial of service or the execution
    of arbitrary code.

CVE-2021-43976

    Zekun Shen and Brendan Dolan-Gavitt discovered a flaw in the
    mwifiex_usb_recv() function of the Marvell WiFi-Ex USB Driver. An
    attacker able to connect a crafted USB device can take advantage of
    this flaw to cause a denial of service.

CVE-2021-44733

    A race condition was discovered in the Trusted Execution
    Environment (TEE) subsystem for Arm processors, which could lead
    to a use-after-free.  A local user permitted to access a TEE
    device could exploit this for denial of service (memory corruption
    or crash) or possibly for privilege escalation.

CVE-2021-45095

    It was discovered that the Phone Network protocol (PhoNet) driver
    has a reference count leak in the pep_sock_accept() function.

CVE-2021-45469

    Wenqing Liu reported an out-of-bounds memory access in the f2fs
    implementation if an inode has an invalid last xattr entry. An
    attacker able to mount a specially crafted image can take advantage
    of this flaw for denial of service.

CVE-2021-45480

    A memory leak flaw was discovered in the __rds_conn_create()
    function in the RDS (Reliable Datagram Sockets) protocol subsystem.

CVE-2022-0001 (INTEL-SA-00598)

    Researchers at VUSec discovered that the Branch History Buffer in
    Intel processors can be exploited to create information side-
    channels with speculative execution.  This issue is similar to
    Spectre variant 2, but requires additional mitigations on some
    processors.

    This can be exploited to obtain sensitive information from a
    different security context, such as from user-space to the kernel,
    or from a KVM guest to the kernel.

CVE-2022-0002 (INTEL-SA-00598)

    This is a similar issue to CVE-2022-0001, but covers exploitation
    within a security context, such as from JIT-compiled code in a
    sandbox to hosting code in the same process.

    This can be partly mitigated by disabling eBPF for unprivileged
    users with the sysctl: kernel.unprivileged_bpf_disabled=2.  This
    update does that by default.

CVE-2022-0322

    Eiichi Tsukata discovered a flaw in the sctp_make_strreset_req()
    function in the SCTP network protocol implementation which can
    result in denial of service.

CVE-2022-0330

    Sushma Venkatesh Reddy discovered a missing GPU TLB flush in the
    i915 driver, resulting in denial of service or privilege escalation.

CVE-2022-0435

    Samuel Page and Eric Dumazet reported a stack overflow in the
    networking module for the Transparent Inter-Process Communication
    (TIPC) protocol, resulting in denial of service or potentially the
    execution of arbitrary code.

CVE-2022-0487

    A use-after-free was discovered in the MOXART SD/MMC Host Controller
    support driver. This flaw does not impact the Debian binary packages
    as CONFIG_MMC_MOXART is not set.

CVE-2022-0492

    Yiqi Sun and Kevin Wang reported that the cgroup-v1 subsystem does
    not properly restrict access to the release-agent feature. A local
    user can take advantage of this flaw for privilege escalation and
    bypass of namespace isolation.

CVE-2022-0617

    butt3rflyh4ck discovered a NULL pointer dereference in the UDF
    filesystem. A local user that can mount a specially crafted UDF
    image can use this flaw to crash the system.

CVE-2022-0644

    Hao Sun reported a missing check for file read permission in the
    finit_module() and kexec_file_load() system calls.  The security
    impact of this is unclear, since these system calls are usually
    only available to the root user.

CVE-2022-22942

    It was discovered that wrong file file descriptor handling in the
    VMware Virtual GPU driver (vmwgfx) could result in information leak
    or privilege escalation.

CVE-2022-24448

    Lyu Tao reported a flaw in the NFS implementation in the Linux
    kernel when handling requests to open a directory on a regular file,
    which could result in a information leak.

CVE-2022-24959

    A memory leak was discovered in the yam_siocdevprivate() function of
    the YAM driver for AX.25, which could result in denial of service.

CVE-2022-25258

    Szymon Heidrich reported the USB Gadget subsystem lacks certain
    validation of interface OS descriptor requests, resulting in memory
    corruption.

CVE-2022-25375

    Szymon Heidrich reported that the RNDIS USB gadget lacks validation
    of the size of the RNDIS_MSG_SET command, resulting in information
    leak from kernel memory.

For Debian 9 stretch, these problems have been fixed in version
4.19.232-1~deb9u1.  This update additionally includes many more bug
fixes from stable updates 4.19.209-4.19.232 inclusive.

We recommend that you upgrade your linux-4.19 packages.

For the detailed security status of linux-4.19 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux-4.19>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpTZkVodrlDJ.pgp)**

*Description:* PGP signature

---



=== Content from github.com_d2f619e2_20250114_220032.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F29eb31542787e1019208a2e1047bb7c76c069536)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F29eb31542787e1019208a2e1047bb7c76c069536)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/29eb31542787e1019208a2e1047bb7c76c069536)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

yam: fix a memory leak in yam\_siocdevprivate()

[Browse files](/torvalds/linux/tree/29eb31542787e1019208a2e1047bb7c76c069536)
Browse the repository at this point in the history

```
ym needs to be free when ym->cmd != SIOCYAMSMCS.

Fixes: [0781168](https://github.com/torvalds/linux/commit/0781168e23a2fc8dceb989f11fc5b39b3ccacc35) ("yam: fix a missing-check bug")
Signed-off-by: Hangyu Hua <hbh25y@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
```

* Loading branch information

[![@HBh25Y](https://avatars.githubusercontent.com/u/39452870?s=40&v=4)](/HBh25Y) [![@davem330](https://avatars.githubusercontent.com/u/1053866?s=40&v=4)](/davem330)

[HBh25Y](/torvalds/linux/commits?author=HBh25Y "View all commits by HBh25Y")
authored and
[davem330](/torvalds/linux/commits?author=davem330 "View all commits by davem330")
committed
Jan 25, 2022

1 parent
[c74ead2](/torvalds/linux/commit/c74ead223deb88bdf18af8c772d7ca5a9b6c3c2b)

commit 29eb315

Showing
**1 changed file**
with
**1 addition**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

4 changes: 1 addition & 3 deletions

4
[drivers/net/hamradio/yam.c](#diff-7c91a3fca1a28dca72166c1aaf5ae3087779f7c312d520180f465d27cd3ce634 "drivers/net/hamradio/yam.c")

Show comments

[View file](/torvalds/linux/blob/29eb31542787e1019208a2e1047bb7c76c069536/drivers/net/hamradio/yam.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -950,9 +950,7 @@ static int yam\_siocdevprivate(struct net\_device \*dev, struct ifreq \*ifr, void \_\_ |
|  |  | ym = memdup\_user(data, sizeof(struct yamdrv\_ioctl\_mcs)); |
|  |  | if (IS\_ERR(ym)) |
|  |  | return PTR\_ERR(ym); |
|  |  | if (ym->cmd != SIOCYAMSMCS) |
|  |  | return -EINVAL; |
|  |  | if (ym->bitrate > YAM\_MAXBITRATE) { |
|  |  | if (ym->cmd != SIOCYAMSMCS || ym->bitrate > YAM\_MAXBITRATE) { |
|  |  | kfree(ym); |
|  |  | return -EINVAL; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `29eb315`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F29eb31542787e1019208a2e1047bb7c76c069536) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.debian.org_6d4d08f3_20250114_220035.html ===


---

[[Date Prev](msg00058.html)][[Date Next](msg00060.html)]
[[Thread Prev](msg00058.html)][[Thread Next](msg00060.html)]
[[Date Index](maillist.html#00059)]
[[Thread Index](threads.html#00059)]

# [SECURITY] [DSA 5092-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 5092-1] linux security update
* *From*: Salvatore Bonaccorso <carnil@debian.org>
* *Date*: Mon, 07 Mar 2022 12:54:12 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1nRCsO-0007vK-EK%40seger.debian.org) [E1nRCsO-0007vK-EK@seger.debian.org](msg00059.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-5092-1                   security@debian.org
<https://www.debian.org/security/>                     Salvatore Bonaccorso
March 07, 2022                        <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2021-43976 CVE-2022-0330 CVE-2022-0435 CVE-2022-0516
                 CVE-2022-0847 CVE-2022-22942 CVE-2022-24448 CVE-2022-24959
                 CVE-2022-25258 CVE-2022-25375

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2021-43976

    Zekun Shen and Brendan Dolan-Gavitt discovered a flaw in the
    mwifiex_usb_recv() function of the Marvell WiFi-Ex USB Driver. An
    attacker able to connect a crafted USB device can take advantage of
    this flaw to cause a denial of service.

CVE-2022-0330

    Sushma Venkatesh Reddy discovered a missing GPU TLB flush in the
    i915 driver, resulting in denial of service or privilege escalation.

CVE-2022-0435

    Samuel Page and Eric Dumazet reported a stack overflow in the
    networking module for the Transparent Inter-Process Communication
    (TIPC) protocol, resulting in denial of service or potentially the
    execution of arbitrary code.

CVE-2022-0516

    It was discovered that an insufficient check in the KVM subsystem
    for s390x could allow unauthorized memory read or write access.

CVE-2022-0847

    Max Kellermann discovered a flaw in the handling of pipe buffer
    flags. An attacker can take advantage of this flaw for local
    privilege escalation.

CVE-2022-22942

    It was discovered that wrong file file descriptor handling in the
    VMware Virtual GPU driver (vmwgfx) could result in information leak
    or privilege escalation.

CVE-2022-24448

    Lyu Tao reported a flaw in the NFS implementation in the Linux
    kernel when handling requests to open a directory on a regular file,
    which could result in a information leak.

CVE-2022-24959

    A memory leak was discovered in the yam_siocdevprivate() function of
    the YAM driver for AX.25, which could result in denial of service.

CVE-2022-25258

    Szymon Heidrich reported the USB Gadget subsystem lacks certain
    validation of interface OS descriptor requests, resulting in memory
    corruption.

CVE-2022-25375

    Szymon Heidrich reported that the RNDIS USB gadget lacks validation
    of the size of the RNDIS_MSG_SET command, resulting in information
    leak from kernel memory.

For the stable distribution (bullseye), these problems have been fixed in
version 5.10.92-2.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to its security
tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAmImAChfFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0TlAw/+MoL+9zYTlpPOcWp0YMuOkEUJU3WS7udSyTSZLNZsWuQTVmPQ6ed7Fxw/
b0j6OCX9HbrIl4nJdx+7D53ujWC6hS29TLgHCb8d/TEeluXPVI2+4Nt1FcZbSXTJ
6hBNIVVIiDUV9Wco8JUVbvk+y8VCsHxqDEePpEOTZVYLyDUUdti4V7+3ZyO8XQ4/
ePeCX8QQba5FApsz4jG7CkBCxBxyley6YswPV3Zz1FF6L/hGjgluYiKFbO4mLTlX
vqwv/UIAZl2rutHzzxyBE5hIlPGXfgksPI7jTmSMRkWI99cIlJWTlziecYLQUiid
2NwOyu2vrut6ZVbtmI5WbTy64Aa9EKguQLd+SbBMuK790nfTLRySaZnU52/1j1MW
1/3Nwq+pDbZ/yAAeV/TS9oKl3mG3XVOO34EGpr9A5aZzCPetyb1TQj0jR5+mjCxy
RTxYZuCrisnFvVXXRZLPc1vPcZW+ULXrPQFWEEvd2WKRa6iIkDHf5ef8pHRm36mk
9Yt0x6UmmVWLRRZp7UCbD03NB5p3oJKi+i1h3d+19jQGwU2bEhfOEADCADqlZLwc
/6vFZ7TrA/74LXM8MOc5+VQbxL8nGetenPSHuxNwoeXw1ry4+x9KV6YHMqeqQ/qW
jFpIOfWS1HQ9vC9t46V2eE0sfrOu2Jvdm4MixwRbXhjzs/REYTY=
=MIhw
-----END PGP SIGNATURE-----

```

---


