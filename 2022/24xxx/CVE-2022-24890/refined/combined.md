=== Content from github.com_d435611b_20250114_201517.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fpull%2F7092)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fpull%2F7092)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=nextcloud%2Fspreed)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextcloud](/nextcloud)
/
**[spreed](/nextcloud/spreed)**
Public

* [Notifications](/login?return_to=%2Fnextcloud%2Fspreed) You must be signed in to change notification settings
* [Fork
  442](/login?return_to=%2Fnextcloud%2Fspreed)
* [Star
   1.7k](/login?return_to=%2Fnextcloud%2Fspreed)

* [Code](/nextcloud/spreed)
* [Issues
  631](/nextcloud/spreed/issues)
* [Pull requests
  46](/nextcloud/spreed/pulls)
* [Actions](/nextcloud/spreed/actions)
* [Projects
  1](/nextcloud/spreed/projects)
* [Security](/nextcloud/spreed/security)
* [Insights](/nextcloud/spreed/pulse)

Additional navigation options

* [Code](/nextcloud/spreed)
* [Issues](/nextcloud/spreed/issues)
* [Pull requests](/nextcloud/spreed/pulls)
* [Actions](/nextcloud/spreed/actions)
* [Projects](/nextcloud/spreed/projects)
* [Security](/nextcloud/spreed/security)
* [Insights](/nextcloud/spreed/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnextcloud%2Fspreed%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnextcloud%2Fspreed%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# [stable23] Fix reconnections on single media permission changes #7092

 Merged

[nickvergessen](/nickvergessen)
merged 12 commits into
[stable23](/nextcloud/spreed/tree/stable23 "nextcloud/spreed:stable23")
from
[backport/7034/stable23](/nextcloud/spreed/tree/backport/7034/stable23 "nextcloud/spreed:backport/7034/stable23")

Apr 4, 2022

 Merged

# [[stable23] Fix reconnections on single media permission changes](#top) #7092

[nickvergessen](/nickvergessen)
merged 12 commits into
[stable23](/nextcloud/spreed/tree/stable23 "nextcloud/spreed:stable23")
from
[backport/7034/stable23](/nextcloud/spreed/tree/backport/7034/stable23 "nextcloud/spreed:backport/7034/stable23")

Apr 4, 2022

[Conversation
2](/nextcloud/spreed/pull/7092)
[Commits
12](/nextcloud/spreed/pull/7092/commits)
[Checks
0](/nextcloud/spreed/pull/7092/checks)
[Files changed](/nextcloud/spreed/pull/7092/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![backportbot-nextcloud[bot]](https://avatars.githubusercontent.com/in/21012?s=60&v=4)](/apps/backportbot-nextcloud)

Copy link

### @backportbot-nextcloud **[backportbot-nextcloud](/apps/backportbot-nextcloud) bot** commented [Apr 4, 2022](#issue-1191598085)

backport of [#7034](https://github.com/nextcloud/spreed/pull/7034)

Sorry, something went wrong.

All reactions

 [danxuliu](/danxuliu)
added 12 commits
[April 4, 2022 10:48](#commits-pushed-d7f603c)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Remove unused "constraints" parameters from events](/nextcloud/spreed/pull/7092/commits/d7f603c47eb4005480b78b35adffb3bca3e935f8 "Remove unused \"constraints\" parameters from events

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[d7f603c](/nextcloud/spreed/pull/7092/commits/d7f603c47eb4005480b78b35adffb3bca3e935f8)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Add unit tests for MediaDevicesSource](/nextcloud/spreed/pull/7092/commits/ec1ea2c40687996f1e3ed2fd389338625d5cfd28 "Add unit tests for MediaDevicesSource

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[ec1ea2c](/nextcloud/spreed/pull/7092/commits/ec1ea2c40687996f1e3ed2fd389338625d5cfd28)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Generate actual constraints from the available tracks](/nextcloud/spreed/pull/7092/commits/72a05667b546fb6453da42725f40a6284c784a34 "Generate actual constraints from the available tracks

The constraints are used in the caller code for things like setting the
current call flags. The constraints were modified by the
MediaDevicesSource and the MediaDevicesManager depending on the
available devices, but they did not reflect things like a node further
in the pipeline failing to set the track (for example, if the
VirtualBackground failed hard) and causing the final track to be null.
Basing the constraints on the tracks instead should address those
(corner) cases while behaving the same in the general cases.

Besides that, this will make possible to remove the constraints from
\"MediaDevicesSource.start()\" in a following commit.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[72a0566](/nextcloud/spreed/pull/7092/commits/72a05667b546fb6453da42725f40a6284c784a34)`

```
The constraints are used in the caller code for things like setting the
current call flags. The constraints were modified by the
MediaDevicesSource and the MediaDevicesManager depending on the
available devices, but they did not reflect things like a node further
in the pipeline failing to set the track (for example, if the
VirtualBackground failed hard) and causing the final track to be null.
Basing the constraints on the tracks instead should address those
(corner) cases while behaving the same in the general cases.

Besides that, this will make possible to remove the constraints from
"MediaDevicesSource.start()" in a following commit.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Replace constraints when starting the node with "setXXXAllowed" methods](/nextcloud/spreed/pull/7092/commits/88ae04232a9b58af38b969f424382ef66d8f4c97 "Replace constraints when starting the node with \"setXXXAllowed\" methods

The constraints given to \"MediaDevicesSource.start()\" were used to limit
the media to be got. However, this only applied in the initial start; if
a new device from a media kind initially disallowed was selected later
the node got a track from it. Now \"setAudioAllowed(bool)\" and
\"setVideoAllowed(bool)\" are introduced to restrict the media to be got
whenever the node is active.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[88ae042](/nextcloud/spreed/pull/7092/commits/88ae04232a9b58af38b969f424382ef66d8f4c97)`

```
The constraints given to "MediaDevicesSource.start()" were used to limit
the media to be got. However, this only applied in the initial start; if
a new device from a media kind initially disallowed was selected later
the node got a track from it. Now "setAudioAllowed(bool)" and
"setVideoAllowed(bool)" are introduced to restrict the media to be got
whenever the node is active.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Update tracks based on changes in the allowed media](/nextcloud/spreed/pull/7092/commits/b4ea1d28dc0197cd607b7f9b4252002a927a8143 "Update tracks based on changes in the allowed media

If media is allowed the track will be started (if a device is
available), and if media is disallowed the current track of its kind
will be stopped.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[b4ea1d2](/nextcloud/spreed/pull/7092/commits/b4ea1d28dc0197cd607b7f9b4252002a927a8143)`

```
If media is allowed the track will be started (if a device is
available), and if media is disallowed the current track of its kind
will be stopped.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Expose methods to allow or disallow media](/nextcloud/spreed/pull/7092/commits/d85fa308317a1ae1dc5b508b62571734a3d88922 "Expose methods to allow or disallow media

These methods will be used to allow or disallow media based on the
permission changes.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[d85fa30](/nextcloud/spreed/pull/7092/commits/d85fa308317a1ae1dc5b508b62571734a3d88922)`

```
These methods will be used to allow or disallow media based on the
permission changes.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Add getters to check if media is allowed or disallowed](/nextcloud/spreed/pull/7092/commits/5b6f1b6ac52af5b7ff85c4535332405aa592b25e "Add getters to check if media is allowed or disallowed

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[5b6f1b6](/nextcloud/spreed/pull/7092/commits/5b6f1b6ac52af5b7ff85c4535332405aa592b25e)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Fix reconnections on single media permission changes](/nextcloud/spreed/pull/7092/commits/a0ff2c9b650bb63312c74df739412af468c7723d "Fix reconnections on single media permission changes

Until now the audio and video publishing permissions were handled as a
whole; either the local participant was able to publish both audio and
video or not. However, the permissions API is actually finer grained,
and it is possible to have one without the other. Now the allowed state
of local media is updated based on the publishing permissions, which
automatically starts and stops the tracks as needed. Nevertheless, in
some cases forced reconnections need to be explicitly triggered to
remove tracks from the senders, as well as to start and stop the local
media.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[a0ff2c9](/nextcloud/spreed/pull/7092/commits/a0ff2c9b650bb63312c74df739412af468c7723d)`

```
Until now the audio and video publishing permissions were handled as a
whole; either the local participant was able to publish both audio and
video or not. However, the permissions API is actually finer grained,
and it is possible to have one without the other. Now the allowed state
of local media is updated based on the publishing permissions, which
automatically starts and stops the tracks as needed. Nevertheless, in
some cases forced reconnections need to be explicitly triggered to
remove tracks from the senders, as well as to start and stop the local
media.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Disable media when disallowed](/nextcloud/spreed/pull/7092/commits/b1fbc68ec8c574e05987c5051c815042e158634b "Disable media when disallowed

If publishing media is disallowed now the media is also disabled to
ensure that, if the media is then allowed again, it will not be
unexpectedly enabled.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[b1fbc68](/nextcloud/spreed/pull/7092/commits/b1fbc68ec8c574e05987c5051c815042e158634b)`

```
If publishing media is disallowed now the media is also disabled to
ensure that, if the media is then allowed again, it will not be
unexpectedly enabled.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Update call flags if needed after joining a call](/nextcloud/spreed/pull/7092/commits/710bec4f92d1c318457d1743999f181dc20b021b "Update call flags if needed after joining a call

When the local participant joins a call in most cases the call flags
already reflect the current media being published. However, if the
active media changed since the request to join the call was sent (for
example, if a track started during a forced reconnection, which could
happen if audio was disallowed and video allowed at the same time) the
call flags would need to be updated.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[710bec4](/nextcloud/spreed/pull/7092/commits/710bec4f92d1c318457d1743999f181dc20b021b)`

```
When the local participant joins a call in most cases the call flags
already reflect the current media being published. However, if the
active media changed since the request to join the call was sent (for
example, if a track started during a forced reconnection, which could
happen if audio was disallowed and video allowed at the same time) the
call flags would need to be updated.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Fix forced reconnections when replacing tracks](/nextcloud/spreed/pull/7092/commits/2a68bc5bc7a4444eb0323f51a7f4ca28ae457676 "Fix forced reconnections when replacing tracks

When tracks are replaced the forced reconnections were based on whether
the call was started with local media active or not. However, in some
cases a forced reconnection was needed even if the call was started with
local media active. For example, if after joining a call the user
removed the audio and video devices and then added them again, as if
another participant joined the call in the meantime that participant
would not try to establish a connection after the devices were selected
again, as currently the clients only establish a connection if another
participant has media when the list of participants in the call change.

Besides that, when the flags are updated now the flags are based only in
the current tracks rather than on the previous flags, as if the flags
were updated again before the previous request finished the second
update would be based on the original flags.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[2a68bc5](/nextcloud/spreed/pull/7092/commits/2a68bc5bc7a4444eb0323f51a7f4ca28ae457676)`

```
When tracks are replaced the forced reconnections were based on whether
the call was started with local media active or not. However, in some
cases a forced reconnection was needed even if the call was started with
local media active. For example, if after joining a call the user
removed the audio and video devices and then added them again, as if
another participant joined the call in the meantime that participant
would not try to establish a connection after the devices were selected
again, as currently the clients only establish a connection if another
participant has media when the list of participants in the call change.

Besides that, when the flags are updated now the flags are based only in
the current tracks rather than on the previous flags, as if the flags
were updated again before the previous request finished the second
update would be based on the original flags.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [![@backportbot](https://avatars.githubusercontent.com/in/60201?s=40&v=4)](/apps/backportbot)

`[Remove no longer used "startedWithMedia" variable](/nextcloud/spreed/pull/7092/commits/87de72925ef93ee6595c7c5092392d623cc8aecf "Remove no longer used \"startedWithMedia\" variable

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[87de729](/nextcloud/spreed/pull/7092/commits/87de72925ef93ee6595c7c5092392d623cc8aecf)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@backportbot-nextcloud](https://avatars.githubusercontent.com/in/21012?s=40&v=4)](/apps/backportbot-nextcloud)
[backportbot-nextcloud](/apps/backportbot-nextcloud)
bot
added
[bug](/nextcloud/spreed/labels/bug)
[feature: call 📹](/nextcloud/spreed/labels/feature%3A%20call%20%F0%9F%93%B9)
Voice and video calls
[feature: frontend 🖌️](/nextcloud/spreed/labels/feature%3A%20frontend%20%F0%9F%96%8C%EF%B8%8F)
"Web UI" client
labels
[Apr 4, 2022](#event-6361916247)

[![@backportbot-nextcloud](https://avatars.githubusercontent.com/in/21012?s=40&v=4)](/apps/backportbot-nextcloud)
[backportbot-nextcloud](/apps/backportbot-nextcloud)
bot
added this to the [💖 Next Patch (23)](/nextcloud/spreed/milestone/136) milestone
[Apr 4, 2022](#event-6361916378)

 [![@backportbot-nextcloud](https://avatars.githubusercontent.com/in/21012?s=40&v=4)](/apps/backportbot-nextcloud)
[backportbot-nextcloud](/apps/backportbot-nextcloud)
bot
requested review from
[danxuliu](/danxuliu) and
[nickvergessen](/nickvergessen)
[April 4, 2022 10:48](#event-6361916450)

[![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4)](/nickvergessen)
[nickvergessen](/nickvergessen)
added
the
[3. to review](/nextcloud/spreed/labels/3.%20to%20review)
label
[Apr 4, 2022](#event-6361953000)

[![danxuliu](https://avatars.githubusercontent.com/u/26858233?s=60&v=4)](/danxuliu)

**[danxuliu](/danxuliu)**
approved these changes
[Apr 4, 2022](#pullrequestreview-930357101)

 [View reviewed changes](/nextcloud/spreed/pull/7092/files/87de72925ef93ee6595c7c5092392d623cc8aecf)

Copy link

Member

### @danxuliu **[danxuliu](/danxuliu)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Tested (with HPB) and works 👍

Sorry, something went wrong.

All reactions

[![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4)](/nickvergessen)
[nickvergessen](/nickvergessen)
merged commit [`1359d70`](/nextcloud/spreed/commit/1359d7092c0df6ccd075d5cbd8c974ad4a3cd604)
into
stable23

[Apr 4, 2022](https://github.com/nextcloud/spreed/pull/7092#event-6363001121)

 [![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4)](/nickvergessen)
[nickvergessen](/nickvergessen)
deleted the
backport/7034/stable23

branch
[April 4, 2022 13:20](#event-6363001218)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=80&v=4)](/danxuliu)

Copy link

Member

### **[danxuliu](/danxuliu)** commented [Apr 4, 2022](#issuecomment-1088071770)

| Tested also without HPB and works 👍 The tests were done by cherry-picking the fixes in [#7080](https://github.com/nextcloud/spreed/pull/7080) to make forced reconnections more reliable. |
| --- |

All reactions

Sorry, something went wrong.

This was referenced Apr 8, 2022

[Add changelog for 12.2.5 and 13.0.5
#7120](/nextcloud/spreed/pull/7120)
 Merged

[[stable23] Add changelog for 12.2.5 and 13.0.5
#7127](/nextcloud/spreed/pull/7127)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fpull%2F7092)

Reviewers

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu) [danxuliu](/danxuliu)

danxuliu approved these changes

[![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&v=4)](/nickvergessen) [nickvergessen](/nickvergessen)

 Awaiting requested review from nickvergessen

Assignees

No one assigned

Labels

[3. to review](/nextcloud/spreed/labels/3.%20to%20review)
[bug](/nextcloud/spreed/labels/bug)
[feature: call 📹](/nextcloud/spreed/labels/feature%3A%20call%20%F0%9F%93%B9)
Voice and video calls
[feature: frontend 🖌️](/nextcloud/spreed/labels/feature%3A%20frontend%20%F0%9F%96%8C%EF%B8%8F)
"Web UI" client

Projects

None yet

Milestone

 [**v13.0.5**](/nextcloud/spreed/milestone/136 "v13.0.5")

Development

Successfully merging this pull request may close these issues.

2 participants

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=52&v=4)](/danxuliu) [![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=52&v=4)](/nickvergessen)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_06887101_20250114_201509.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fissues%2F7048)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fissues%2F7048)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=nextcloud%2Fspreed)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextcloud](/nextcloud)
/
**[spreed](/nextcloud/spreed)**
Public

* [Notifications](/login?return_to=%2Fnextcloud%2Fspreed) You must be signed in to change notification settings
* [Fork
  442](/login?return_to=%2Fnextcloud%2Fspreed)
* [Star
   1.7k](/login?return_to=%2Fnextcloud%2Fspreed)

* [Code](/nextcloud/spreed)
* [Issues
  631](/nextcloud/spreed/issues)
* [Pull requests
  46](/nextcloud/spreed/pulls)
* [Actions](/nextcloud/spreed/actions)
* [Projects
  1](/nextcloud/spreed/projects)
* [Security](/nextcloud/spreed/security)
* [Insights](/nextcloud/spreed/pulse)

Additional navigation options

* [Code](/nextcloud/spreed)
* [Issues](/nextcloud/spreed/issues)
* [Pull requests](/nextcloud/spreed/pulls)
* [Actions](/nextcloud/spreed/actions)
* [Projects](/nextcloud/spreed/projects)
* [Security](/nextcloud/spreed/security)
* [Insights](/nextcloud/spreed/pulse)

# Connection can not be established without camera permission #7048

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosed[#7034](https://github.com/nextcloud/spreed/pull/7034)Closed[Connection can not be established without camera permission](#top)#7048[#7034](https://github.com/nextcloud/spreed/pull/7034)Copy linkAssignees [![danxuliu](https://avatars.githubusercontent.com/u/26858233?s=64&v=4)](/danxuliu)Labels[1. to develop](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%221.%20to%20develop%22)[bug](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%22bug%22)[feature: call 📹Voice and video calls](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%22feature%3A%20call%20%F0%9F%93%B9%22)Voice and video calls[regression](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%22regression%22)Milestone[v14.0.0-beta.1](https://github.com/nextcloud/spreed/milestone/123)![@nickvergessen](https://avatars.githubusercontent.com/u/213943?u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4&size=80)
## Description

![@nickvergessen](https://avatars.githubusercontent.com/u/213943?u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4&size=48)[nickvergessen](https://github.com/nickvergessen)opened [on Mar 24, 2022](https://github.com/nextcloud/spreed/issues/7048#issue-1179197290)
### How to use GitHub

* Please use the 👍 [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.
* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.
* Subscribe to receive notifications on status change and new comments.

---

## Steps to reproduce

1. As user A create a room with group 1 where user B is a member of
2. As user A set custom permissions for user B only change to remove the camera permission
3. As user A start a call
4. As user B try to join the call

### Expected behaviour

User B can join and talk

### Actual behaviour

User B is disconnecting and connecting all the time

## Talk app

**Talk app version:** master

**Custom Signaling server configured:** no

**Custom TURN server configured:** no

**Custom STUN server configured:** no

## Browser

**Microphone available:** yes - using fake stream

**Camera available:** yes - using fake stream

**Operating system:** Ubuntu

**Browser name:** Firefox

**Browser version:** 96

### Browser log

[![Bildschirmfoto von 2022-03-24 09-51-04](https://user-images.githubusercontent.com/213943/159878444-87e14843-c39b-4afc-b6e9-3f668dd9d432.png)](https://user-images.githubusercontent.com/213943/159878444-87e14843-c39b-4afc-b6e9-3f668dd9d432.png)

## Metadata

### Assignees

* [![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=64&v=4)danxuliu](/danxuliu)
### Labels

[1. to develop](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%221.%20to%20develop%22)[bug](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%22bug%22)[feature: call 📹Voice and video calls](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%22feature%3A%20call%20%F0%9F%93%B9%22)Voice and video calls[regression](https://github.com/nextcloud/spreed/issues?q=state%3Aopen%20label%3A%22regression%22)
### Type

No type
### Projects

No projects
### Milestone

* [v14.0.0-beta.1](https://github.com/nextcloud/spreed/milestone/123)
### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_87653fb5_20250114_201507.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fsecurity-advisories%2Fsecurity%2Fadvisories%2FGHSA-vxpr-hcqq-7fw7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fsecurity-advisories%2Fsecurity%2Fadvisories%2FGHSA-vxpr-hcqq-7fw7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=nextcloud%2Fsecurity-advisories)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextcloud](/nextcloud)
/
**[security-advisories](/nextcloud/security-advisories)**
Public

* [Notifications](/login?return_to=%2Fnextcloud%2Fsecurity-advisories) You must be signed in to change notification settings
* [Fork
  14](/login?return_to=%2Fnextcloud%2Fsecurity-advisories)
* [Star
   61](/login?return_to=%2Fnextcloud%2Fsecurity-advisories)

* [Code](/nextcloud/security-advisories)
* [Pull requests
  0](/nextcloud/security-advisories/pulls)
* [Discussions](/nextcloud/security-advisories/discussions)
* [Actions](/nextcloud/security-advisories/actions)
* [Security](/nextcloud/security-advisories/security)
* [Insights](/nextcloud/security-advisories/pulse)

Additional navigation options

* [Code](/nextcloud/security-advisories)
* [Pull requests](/nextcloud/security-advisories/pulls)
* [Discussions](/nextcloud/security-advisories/discussions)
* [Actions](/nextcloud/security-advisories/actions)
* [Security](/nextcloud/security-advisories/security)
* [Insights](/nextcloud/security-advisories/pulse)

# Moderator can enable cam/mic remotely if cam/mic-permission was disabled while user has activated cam/mic

Low

[julien-nc](/julien-nc)
published
GHSA-vxpr-hcqq-7fw7
May 10, 2022

## Package

Talk
(Nextcloud)

## Affected versions

< 13.0.5

## Patched versions

13.0.5, v14.0.0

## Description

### Impact

A call moderator can indirectly enable user webcams by granting permissions, if they were enabled before removing the permissions.

### Patches

It is recommended that the Nextcloud Talk app is upgraded to 13.0.5 .

### Workarounds

No workaround available

### References

[nextcloud/spreed#7034](https://github.com/nextcloud/spreed/pull/7034)

<https://hackerone.com/reports/1520685>

### For more information

If you have any questions or comments about this advisory:

* Create a post in [nextcloud/security-advisories](https://github.com/nextcloud/security-advisories/discussions)
* Customers: Open a support ticket at [support.nextcloud.com](https://support.nextcloud.com)

### Severity

Low

2.4

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
High

User interaction
Required

Scope
Unchanged

Confidentiality
Low

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:U/C:L/I:N/A:N

### CVE ID

CVE-2022-24890

### Weaknesses

[CWE-359](/advisories?query=cwe%3A359)

### Credits

* [![@michag86](https://avatars.githubusercontent.com/u/6691165?s=40&v=4)](/michag86)
  [michag86](/michag86)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_6b294c96_20250114_201513.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fpull%2F7034)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fpull%2F7034)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=nextcloud%2Fspreed)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextcloud](/nextcloud)
/
**[spreed](/nextcloud/spreed)**
Public

* [Notifications](/login?return_to=%2Fnextcloud%2Fspreed) You must be signed in to change notification settings
* [Fork
  442](/login?return_to=%2Fnextcloud%2Fspreed)
* [Star
   1.7k](/login?return_to=%2Fnextcloud%2Fspreed)

* [Code](/nextcloud/spreed)
* [Issues
  631](/nextcloud/spreed/issues)
* [Pull requests
  46](/nextcloud/spreed/pulls)
* [Actions](/nextcloud/spreed/actions)
* [Projects
  1](/nextcloud/spreed/projects)
* [Security](/nextcloud/spreed/security)
* [Insights](/nextcloud/spreed/pulse)

Additional navigation options

* [Code](/nextcloud/spreed)
* [Issues](/nextcloud/spreed/issues)
* [Pull requests](/nextcloud/spreed/pulls)
* [Actions](/nextcloud/spreed/actions)
* [Projects](/nextcloud/spreed/projects)
* [Security](/nextcloud/spreed/security)
* [Insights](/nextcloud/spreed/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnextcloud%2Fspreed%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnextcloud%2Fspreed%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fix reconnections on single media permission changes #7034

 Merged

[nickvergessen](/nickvergessen)
merged 12 commits into
[master](/nextcloud/spreed/tree/master "nextcloud/spreed:master")
from
[fix-reconnections-on-single-media-permission-changes](/nextcloud/spreed/tree/fix-reconnections-on-single-media-permission-changes "nextcloud/spreed:fix-reconnections-on-single-media-permission-changes")

Apr 4, 2022

 Merged

# [Fix reconnections on single media permission changes](#top) #7034

[nickvergessen](/nickvergessen)
merged 12 commits into
[master](/nextcloud/spreed/tree/master "nextcloud/spreed:master")
from
[fix-reconnections-on-single-media-permission-changes](/nextcloud/spreed/tree/fix-reconnections-on-single-media-permission-changes "nextcloud/spreed:fix-reconnections-on-single-media-permission-changes")

Apr 4, 2022

[Conversation
5](/nextcloud/spreed/pull/7034)
[Commits
12](/nextcloud/spreed/pull/7034/commits)
[Checks
0](/nextcloud/spreed/pull/7034/checks)
[Files changed](/nextcloud/spreed/pull/7034/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![danxuliu](https://avatars.githubusercontent.com/u/26858233?s=60&v=4)](/danxuliu)

Copy link

Member

### @danxuliu **[danxuliu](/danxuliu)** commented [Mar 22, 2022](#issue-1176212466) • edited Loading

Fixes [#7048](https://github.com/nextcloud/spreed/issues/7048)

Until now the WebUI code treated audio and video permissions as a combined permission: either both were enabled or both were disabled. This was inherited from the initial implementation, but it is no longer the case; it is possible to have audio permissions without video permissions and the other way around.

Besides that this pull request also fixes some other related issues.

Unfortunately there are a lot of possible combinations between permissions and devices, as can be seen by the scenarios below (which only include those that currently fail, there are even more 😢).

Pending:

* Call `setAudioAllowed` and `setVideoAllowed` depending on the permission change
* Test without HPB

## How to test (scenario 1a)

* Setup the HPB
* Remove audio and video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with both audio and video (although both will be blocked once joined)
* In the original window, grant video permissions to the guest

### Result with this pull request

In the private window a forced reconnection was triggered, and if the video is enabled it will be visible in the original window

### Result without this pull request

In the private window a forced reconnection was triggered, but the participant is not able to establish the connection again

## How to test (scenario 1b)

* Setup the HPB
* Remove audio and video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with audio but not video (although audio will be blocked once joined)
* In the original window, grant video permissions to the guest

### Result with this pull request

In the private window nothing happened

### Result without this pull request

In the private window a forced reconnection was triggered, but the participant is not able to establish the connection again

## How to test (scenario 1c)

* Setup the HPB
* Remove video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with both audio and video (although the video will be blocked once joined)
* In the original window, grant video permissions to the guest

### Result with this pull request

In the private window a forced reconnection was triggered, and if the video is enabled it will be visible in the original window

### Result without this pull request

In the private window nothing happened

## How to test (scenario 1d)

* Setup the HPB
* Remove video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with video but not audio (although the video will be blocked once joined)
* In the original window, grant video permissions to the guest

### Result with this pull request

In the private window a forced reconnection was triggered, and if the video is enabled it will be visible in the original window

### Result without this pull request

In the private window nothing happened

## How to test (scenario 2)

* Setup the HPB
* Remove video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call without audio nor video devices
* Open the device settings and select a camera

### Result with this pull request

Nothing happens

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection is prevented by the HPB and never finishes

## How to test (scenario 3a)

* Setup the HPB
* Enable audio and video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with both audio and video
* In the original window, revoke video permissions for the guest

### Result with this pull request

In the private window a forced reconnection was triggered and video is no longer sent (`OCA.Talk.SimpleWebRTC.webrtc.peers[0].pc.getSenders()` returns sender only for audio)

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection never finishes; *This track is already set on a sender* error is printed to browser console

## How to test (scenario 3b)

* Setup the HPB
* Enable audio and video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with audio but not video
* In the original window, revoke video permissions for the guest

### Result with this pull request

In the private window nothing happened

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection never finishes; *This track is already set on a sender* error is printed to browser console

## How to test (scenario 3c)

* Setup the HPB
* Enable audio and video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with video but not audio
* In the original window, revoke video permissions for the guest

### Result with this pull request

In the private window a forced reconnection was triggered and video is no longer sent (`OCA.Talk.SimpleWebRTC.webrtc.peers[0].pc.getSenders()` is empty)

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection never finishes; *This track is already set on a sender* error is printed to browser console

## How to test (scenario 4a)

* Setup the HPB
* Disable video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with both audio and video (although the video will be blocked once joined)
* In the original window, revoke audio permissions but grant video permissions for the guest

### Result with this pull request

In the private window a forced reconnection was triggered, audio is no longer sent but video is

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection never finishes; *This track is already set on a sender* error is printed to browser console

## How to test (scenario 4b)

* Setup the HPB
* Disable video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with audio but not video
* In the original window, revoke audio permissions but grant video permissions for the guest

### Result with this pull request

In the private window a forced reconnection was triggered, audio is no longer sent

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection never finishes; *This track is already set on a sender* error is printed to browser console

## How to test (scenario 4c)

* Setup the HPB
* Disable video permissions by default in a conversation
* Start a call as a moderator
* In a private window, open the conversation as a guest
* Join the call with video but not audio (although the video will be blocked once joined)
* In the original window, revoke audio permissions but grant video permissions for the guest

### Result with this pull request

In the private window a forced reconnection was triggered, audio is no longer sent but video is

### Result without this pull request

In the private window a forced reconnection is triggered, although the connection never finishes; *This track is already set on a sender* error is printed to browser console

### How to test (scenario 5)

* Start a call with audio and video
* Open the device settings and select no microphone and no camera
* In a private window, join the call
* In the original window, select a microphone or camera

### Result with this pull request

A forced reconnection is triggered in the original window and the original participant can be heard or seen in the private window

### Result without this pull request

Nothing happens and the original participant can not be heard or seen in the private window

Sorry, something went wrong.

All reactions

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
added
[2. developing](/nextcloud/spreed/labels/2.%20developing)
[bug](/nextcloud/spreed/labels/bug)
[feature: frontend 🖌️](/nextcloud/spreed/labels/feature%3A%20frontend%20%F0%9F%96%8C%EF%B8%8F)
"Web UI" client
[feature: call 📹](/nextcloud/spreed/labels/feature%3A%20call%20%F0%9F%93%B9)
Voice and video calls
labels
[Mar 22, 2022](#event-6280318083)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
added this to the [💛 Next Major (24)](/nextcloud/spreed/milestone/123)  milestone
[Mar 22, 2022](#event-6280318100)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=80&v=4)](/danxuliu)

Copy link

Member

Author

### **[danxuliu](/danxuliu)** commented [Mar 22, 2022](#issuecomment-1074684049)

| /backport to stable23 |
| --- |

 👍
1
 backportbot-nextcloud[bot] reacted with thumbs up emoji
 👀
1
 backportbot-nextcloud[bot] reacted with eyes emoji

All reactions

* 👍
  1 reaction
* 👀
  1 reaction

Sorry, something went wrong.

[![@backportbot-nextcloud](https://avatars.githubusercontent.com/in/21012?s=40&v=4)](/apps/backportbot-nextcloud)
[backportbot-nextcloud](/apps/backportbot-nextcloud)
bot
added
the
[backport-request](/nextcloud/spreed/labels/backport-request)
label
[Mar 22, 2022](#event-6280319220)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
mentioned this pull request
[Mar 30, 2022](#ref-issue-1179197290)

[Connection can not be established without camera permission
#7048](/nextcloud/spreed/issues/7048)

Closed

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Remove unused "constraints" parameters from events](/nextcloud/spreed/pull/7034/commits/97c8703c04640888d854872b71400bb972835eae "Remove unused \"constraints\" parameters from events

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[97c8703](/nextcloud/spreed/pull/7034/commits/97c8703c04640888d854872b71400bb972835eae)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

 [![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
[force-pushed](/nextcloud/spreed/compare/50898c992b487f93b3c1b3cfecbdfe17e893ebf1..650baf0ca9016e428b8b39d44fc909b77d74ea0c)
the
fix-reconnections-on-single-media-permission-changes

branch
from
[`50898c9`](/nextcloud/spreed/commit/50898c992b487f93b3c1b3cfecbdfe17e893ebf1) to
[`650baf0`](/nextcloud/spreed/commit/650baf0ca9016e428b8b39d44fc909b77d74ea0c)  [Compare](/nextcloud/spreed/compare/50898c992b487f93b3c1b3cfecbdfe17e893ebf1..650baf0ca9016e428b8b39d44fc909b77d74ea0c)
[March 31, 2022 07:47](#event-6341513536)

 [![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
requested a review
from [nickvergessen](/nickvergessen)
[March 31, 2022 07:51](#event-6341541817)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
added
[3. to review](/nextcloud/spreed/labels/3.%20to%20review)
and removed
[2. developing](/nextcloud/spreed/labels/2.%20developing)
labels
[Mar 31, 2022](#event-6341543215)

 [![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
marked this pull request as ready for review
[March 31, 2022 07:51](#event-6341544170)

[![nickvergessen](https://avatars.githubusercontent.com/u/213943?s=60&v=4)](/nickvergessen)

**[nickvergessen](/nickvergessen)**
approved these changes
[Mar 31, 2022](#pullrequestreview-927419583)

 [View reviewed changes](/nextcloud/spreed/pull/7034/files)

Copy link

Member

### @nickvergessen **[nickvergessen](/nickvergessen)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Seems to work in general and fix the issues mentioned

Sorry, something went wrong.

All reactions

[![@Ivansss](https://avatars.githubusercontent.com/u/4638605?s=80&u=af2c0673e7bb99c2fb7d202f8da88b7a3daefd97&v=4)](/Ivansss)

Copy link

Member

### **[Ivansss](/Ivansss)** commented [Mar 31, 2022](#issuecomment-1084577631)

| Didn't work for me.  Test I did:   * Create a conversation and set restricted permissions * Start the call with moderator * Join with as a guest * Give microphone permissions to everyone * Guest did not rejoin the call   [Screenshot 2022-03-31 at 15 24 56](https://user-images.githubusercontent.com/4638605/161065860-af7fa17f-e1b8-4602-94c7-e4270d5a8d0f.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=80&u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4)](/nickvergessen)

Copy link

Member

### **[nickvergessen](/nickvergessen)** commented [Mar 31, 2022](#issuecomment-1084578560)

| That was without HPB, might be related |
| --- |

All reactions

Sorry, something went wrong.

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=80&v=4)](/danxuliu)

Copy link

Member

Author

### **[danxuliu](/danxuliu)** commented [Mar 31, 2022](#issuecomment-1084722077)

| Didn't work for me.  I have tested those steps with and without HPB and in both cases it worked as expected.  While working on this pull request I noticed that, sometimes, a guest failed to connect again after a forced reconnection. Apparently it only happened with guests, but I checked and it also happened before this pull request; I am not sure if I saw it only without HPB or also with HPB. I was not able to found yet why it happens, though, but it is very likely that your issue is that one, and therefore unrelated to the changes here.  Independently of that I added a last fixup to add back some code that I was too eager to remove (the event handler still needs to be executed in case of an error to remove the event handler for the successful start). |
| --- |

All reactions

Sorry, something went wrong.

 [danxuliu](/danxuliu)
added 11 commits
[March 31, 2022 17:08](#commits-pushed-ab5b6c9)

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Add unit tests for MediaDevicesSource](/nextcloud/spreed/pull/7034/commits/ab5b6c9270de05824611117e7cfa4b1cf12f9641 "Add unit tests for MediaDevicesSource

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[ab5b6c9](/nextcloud/spreed/pull/7034/commits/ab5b6c9270de05824611117e7cfa4b1cf12f9641)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Generate actual constraints from the available tracks](/nextcloud/spreed/pull/7034/commits/8665c32abc9e5cd85766ab76176d2eaaab4b528e "Generate actual constraints from the available tracks

The constraints are used in the caller code for things like setting the
current call flags. The constraints were modified by the
MediaDevicesSource and the MediaDevicesManager depending on the
available devices, but they did not reflect things like a node further
in the pipeline failing to set the track (for example, if the
VirtualBackground failed hard) and causing the final track to be null.
Basing the constraints on the tracks instead should address those
(corner) cases while behaving the same in the general cases.

Besides that, this will make possible to remove the constraints from
\"MediaDevicesSource.start()\" in a following commit.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[8665c32](/nextcloud/spreed/pull/7034/commits/8665c32abc9e5cd85766ab76176d2eaaab4b528e)`

```
The constraints are used in the caller code for things like setting the
current call flags. The constraints were modified by the
MediaDevicesSource and the MediaDevicesManager depending on the
available devices, but they did not reflect things like a node further
in the pipeline failing to set the track (for example, if the
VirtualBackground failed hard) and causing the final track to be null.
Basing the constraints on the tracks instead should address those
(corner) cases while behaving the same in the general cases.

Besides that, this will make possible to remove the constraints from
"MediaDevicesSource.start()" in a following commit.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Replace constraints when starting the node with "setXXXAllowed" methods](/nextcloud/spreed/pull/7034/commits/ea71724c2b96109dc341b72777dfa4a4f7086468 "Replace constraints when starting the node with \"setXXXAllowed\" methods

The constraints given to \"MediaDevicesSource.start()\" were used to limit
the media to be got. However, this only applied in the initial start; if
a new device from a media kind initially disallowed was selected later
the node got a track from it. Now \"setAudioAllowed(bool)\" and
\"setVideoAllowed(bool)\" are introduced to restrict the media to be got
whenever the node is active.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[ea71724](/nextcloud/spreed/pull/7034/commits/ea71724c2b96109dc341b72777dfa4a4f7086468)`

```
The constraints given to "MediaDevicesSource.start()" were used to limit
the media to be got. However, this only applied in the initial start; if
a new device from a media kind initially disallowed was selected later
the node got a track from it. Now "setAudioAllowed(bool)" and
"setVideoAllowed(bool)" are introduced to restrict the media to be got
whenever the node is active.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Update tracks based on changes in the allowed media](/nextcloud/spreed/pull/7034/commits/0c52760175ab7ca30b34fc80a3b49c55fe383453 "Update tracks based on changes in the allowed media

If media is allowed the track will be started (if a device is
available), and if media is disallowed the current track of its kind
will be stopped.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[0c52760](/nextcloud/spreed/pull/7034/commits/0c52760175ab7ca30b34fc80a3b49c55fe383453)`

```
If media is allowed the track will be started (if a device is
available), and if media is disallowed the current track of its kind
will be stopped.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Expose methods to allow or disallow media](/nextcloud/spreed/pull/7034/commits/c91ebaae58081893a36661d8dc284add027aa617 "Expose methods to allow or disallow media

These methods will be used to allow or disallow media based on the
permission changes.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[c91ebaa](/nextcloud/spreed/pull/7034/commits/c91ebaae58081893a36661d8dc284add027aa617)`

```
These methods will be used to allow or disallow media based on the
permission changes.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Add getters to check if media is allowed or disallowed](/nextcloud/spreed/pull/7034/commits/a7a9e8368a7ac5795a46ab873a55206998dd3c6a "Add getters to check if media is allowed or disallowed

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[a7a9e83](/nextcloud/spreed/pull/7034/commits/a7a9e8368a7ac5795a46ab873a55206998dd3c6a)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Fix reconnections on single media permission changes](/nextcloud/spreed/pull/7034/commits/0cc75c5b0973976f6ba1827c085f8d43d91b6b59 "Fix reconnections on single media permission changes

Until now the audio and video publishing permissions were handled as a
whole; either the local participant was able to publish both audio and
video or not. However, the permissions API is actually finer grained,
and it is possible to have one without the other. Now the allowed state
of local media is updated based on the publishing permissions, which
automatically starts and stops the tracks as needed. Nevertheless, in
some cases forced reconnections need to be explicitly triggered to
remove tracks from the senders, as well as to start and stop the local
media.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[0cc75c5](/nextcloud/spreed/pull/7034/commits/0cc75c5b0973976f6ba1827c085f8d43d91b6b59)`

```
Until now the audio and video publishing permissions were handled as a
whole; either the local participant was able to publish both audio and
video or not. However, the permissions API is actually finer grained,
and it is possible to have one without the other. Now the allowed state
of local media is updated based on the publishing permissions, which
automatically starts and stops the tracks as needed. Nevertheless, in
some cases forced reconnections need to be explicitly triggered to
remove tracks from the senders, as well as to start and stop the local
media.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Disable media when disallowed](/nextcloud/spreed/pull/7034/commits/c39e3a00333da82bdf16c9e5cbed49a06b45baec "Disable media when disallowed

If publishing media is disallowed now the media is also disabled to
ensure that, if the media is then allowed again, it will not be
unexpectedly enabled.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[c39e3a0](/nextcloud/spreed/pull/7034/commits/c39e3a00333da82bdf16c9e5cbed49a06b45baec)`

```
If publishing media is disallowed now the media is also disabled to
ensure that, if the media is then allowed again, it will not be
unexpectedly enabled.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Update call flags if needed after joining a call](/nextcloud/spreed/pull/7034/commits/41c9186ac6b8b0c81ed0348cdc8ce7aadd8f8c13 "Update call flags if needed after joining a call

When the local participant joins a call in most cases the call flags
already reflect the current media being published. However, if the
active media changed since the request to join the call was sent (for
example, if a track started during a forced reconnection, which could
happen if audio was disallowed and video allowed at the same time) the
call flags would need to be updated.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[41c9186](/nextcloud/spreed/pull/7034/commits/41c9186ac6b8b0c81ed0348cdc8ce7aadd8f8c13)`

```
When the local participant joins a call in most cases the call flags
already reflect the current media being published. However, if the
active media changed since the request to join the call was sent (for
example, if a track started during a forced reconnection, which could
happen if audio was disallowed and video allowed at the same time) the
call flags would need to be updated.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Fix forced reconnections when replacing tracks](/nextcloud/spreed/pull/7034/commits/82236e61f8e3bad4e3251a30030cfd3d454f15ee "Fix forced reconnections when replacing tracks

When tracks are replaced the forced reconnections were based on whether
the call was started with local media active or not. However, in some
cases a forced reconnection was needed even if the call was started with
local media active. For example, if after joining a call the user
removed the audio and video devices and then added them again, as if
another participant joined the call in the meantime that participant
would not try to establish a connection after the devices were selected
again, as currently the clients only establish a connection if another
participant has media when the list of participants in the call change.

Besides that, when the flags are updated now the flags are based only in
the current tracks rather than on the previous flags, as if the flags
were updated again before the previous request finished the second
update would be based on the original flags.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[82236e6](/nextcloud/spreed/pull/7034/commits/82236e61f8e3bad4e3251a30030cfd3d454f15ee)`

```
When tracks are replaced the forced reconnections were based on whether
the call was started with local media active or not. However, in some
cases a forced reconnection was needed even if the call was started with
local media active. For example, if after joining a call the user
removed the audio and video devices and then added them again, as if
another participant joined the call in the meantime that participant
would not try to establish a connection after the devices were selected
again, as currently the clients only establish a connection if another
participant has media when the list of participants in the call change.

Besides that, when the flags are updated now the flags are based only in
the current tracks rather than on the previous flags, as if the flags
were updated again before the previous request finished the second
update would be based on the original flags.

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)

`[Remove no longer used "startedWithMedia" variable](/nextcloud/spreed/pull/7034/commits/b5112441b3f69228a1726df2008fd496dfc94152 "Remove no longer used \"startedWithMedia\" variable

Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>")`
 …

`[b511244](/nextcloud/spreed/pull/7034/commits/b5112441b3f69228a1726df2008fd496dfc94152)`

```
Signed-off-by: Daniel Calviño Sánchez <danxuliu@gmail.com>
```

 [![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=40&v=4)](/danxuliu)
[danxuliu](/danxuliu)
[force-pushed](/nextcloud/spreed/compare/495440e18d6cda997bc22de51ff1c6a10dfc6ec9..b5112441b3f69228a1726df2008fd496dfc94152)
the
fix-reconnections-on-single-media-permission-changes

branch
from
[`495440e`](/nextcloud/spreed/commit/495440e18d6cda997bc22de51ff1c6a10dfc6ec9) to
[`b511244`](/nextcloud/spreed/commit/b5112441b3f69228a1726df2008fd496dfc94152)  [Compare](/nextcloud/spreed/compare/495440e18d6cda997bc22de51ff1c6a10dfc6ec9..b5112441b3f69228a1726df2008fd496dfc94152)
[March 31, 2022 15:10](#event-6344880412)

[![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4)](/nickvergessen)
[nickvergessen](/nickvergessen)
merged commit [`a6f26b2`](/nextcloud/spreed/commit/a6f26b2d63601123abbb76830ba18f60917f2156)
into
master

[Apr 4, 2022](https://github.com/nextcloud/spreed/pull/7034#event-6361913754)

 [![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&u=b5d7026e28e23afb43bbccfa67fed63e8da0cc80&v=4)](/nickvergessen)
[nickvergessen](/nickvergessen)
deleted the
fix-reconnections-on-single-media-permission-changes

branch
[April 4, 2022 10:47](#event-6361913860)

[![@backportbot-nextcloud](https://avatars.githubusercontent.com/in/21012?s=40&v=4)](/apps/backportbot-nextcloud)
[backportbot-nextcloud](/apps/backportbot-nextcloud)
bot
mentioned this pull request
[Apr 4, 2022](#ref-pullrequest-1191598085)

[[stable23] Fix reconnections on single media permission changes
#7092](/nextcloud/spreed/pull/7092)
 Merged

[![@backportbot-nextcloud](https://avatars.githubusercontent.com/in/21012?s=40&v=4)](/apps/backportbot-nextcloud)
[backportbot-nextcloud](/apps/backportbot-nextcloud)
bot
removed
the
[backport-request](/nextcloud/spreed/labels/backport-request)
label
[Apr 4, 2022](#event-6361916525)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fspreed%2Fpull%2F7034)

Reviewers

[![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=40&v=4)](/nickvergessen) [nickvergessen](/nickvergessen)

nickvergessen approved these changes

Assignees

No one assigned

Labels

[3. to review](/nextcloud/spreed/labels/3.%20to%20review)
[bug](/nextcloud/spreed/labels/bug)
[feature: call 📹](/nextcloud/spreed/labels/feature%3A%20call%20%F0%9F%93%B9)
Voice and video calls
[feature: frontend 🖌️](/nextcloud/spreed/labels/feature%3A%20frontend%20%F0%9F%96%8C%EF%B8%8F)
"Web UI" client

Projects

None yet

Milestone

 [**v14.0.0-beta.1**](/nextcloud/spreed/milestone/123 "v14.0.0-beta.1")

Development

Successfully merging this pull request may close these issues.

 [Connection can not be established without camera permission](https://github.com/nextcloud/spreed/issues/7048)

3 participants

[![@danxuliu](https://avatars.githubusercontent.com/u/26858233?s=52&v=4)](/danxuliu) [![@Ivansss](https://avatars.githubusercontent.com/u/4638605?s=52&v=4)](/Ivansss) [![@nickvergessen](https://avatars.githubusercontent.com/u/213943?s=52&v=4)](/nickvergessen)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


