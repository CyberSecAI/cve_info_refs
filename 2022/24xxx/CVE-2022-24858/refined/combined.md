=== Content from github.com_4efc9c29_20250114_232053.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-f9wg-5f46-cjmw)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-f9wg-5f46-cjmw)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  99](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

# Default redirect callback vulnerable to open redirects

High

[balazsorban44](/balazsorban44)
published
GHSA-f9wg-5f46-cjmw
Apr 19, 2022

## Package

npm

next-auth
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<3.29.2, <4.3.2

## Patched versions

3.29.2, 4.3.2

## Description

### Impact

`next-auth` v3 users before version `3.29.2` are impacted. (We recommend upgrading to v4 in most cases. See our [migration guide](https://next-auth.js.org/getting-started/upgrade-v4))

`next-auth` v4 users before version `4.3.2` are impacted.

### Patches

Upgrading to `3.29.2` or `4.3.2` will patch this vulnerability.

You can do:

```
npm i next-auth@latest
```

or

```
yarn add next-auth@latest
```

or

```
pnpm add next-auth@latest
```

(This will update to the latest v4 version, but you can change `latest` to `3` if you want to stay on v3.)

### Workarounds

If you are not able to upgrade for any reason, you can add the following configuration to your `callbacks` option:

```
// async redirect(url, baseUrl) { // v3
async redirect({ url, baseUrl }) { // v4
    // Allows relative callback URLs
    if (url.startsWith("/")) return new URL(url, baseUrl).toString()
    // Allows callback URLs on the same origin
    else if (new URL(url).origin === baseUrl) return url
    return baseUrl
}
```

If you already have a `redirect` callback, make sure that you match the incoming `url` origin against the `baseUrl`.

### References

Read more about the `callbacks.redirect` option in the documentation: <https://next-auth.js.org/configuration/callbacks#redirect-callback>

### For more information

If you have any concerns, we request responsible disclosure, outlined here: <https://next-auth.js.org/security#reporting-a-vulnerability>

### Timeline

The issue was reported 2022 April 6th, and a response was sent out to the reporter in less than 30 minutes, and a patch was produced within a few days.

### Severity

High

### CVE ID

CVE-2022-24858

### Weaknesses

[CWE-601](/advisories?query=cwe%3A601)

### Credits

* [![@rustyguts](https://avatars.githubusercontent.com/u/9222118?s=40&v=4)](/rustyguts)
  [rustyguts](/rustyguts)
  Analyst

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from next-auth.js.org_e227f704_20250114_232053.html ===

Skip to main contentNextAuth.js is becoming Auth.js! ðŸŽ‰ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/getting-started/upgrade-v4)
* [v3](/v3/getting-started/introduction)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
* [Providers](/providers/)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk â†’](https://go.clerk.com/DefS1u4)

* Getting Started
* Upgrade Guide (v4)
Version: v4On this page
# Upgrade Guide (v4)

NextAuth.js version 4 includes a few breaking changes from the last major version (3.x). So we're here to help you upgrade your applications as smoothly as possible. It should be possible to upgrade from any version of 3.x to the latest 4 release by following the next few migration steps.

note

Version 4 has been released to GA ðŸš¨

We encourage users to try it out and report any and all issues they come across.

You can upgrade to the new version by running:

* npm
* yarn
* pnpm

```
npm install next-auth
```
```
yarn add next-auth
```
```
pnpm add next-auth
```
## `next-auth/jwt`[â€‹](#next-authjwt "Direct link to heading")

We no longer have a default export in `next-auth/jwt`.
To comply with this, change the following:

```
- import jwt from "next-auth/jwt"
+ import { getToken } from "next-auth/jwt"

```
## `next-auth/react`[â€‹](#next-authreact "Direct link to heading")

We've renamed the client-side import source to `next-auth/react`. To comply with this change, you will simply have to rename anywhere you were using `next-auth/client`.

For example:

```
- import { useSession } from "next-auth/client"
+ import { useSession } from "next-auth/react"

```

We've also made the following changes to the names of the exports:

* `setOptions`: Not exposed anymore, use [`SessionProvider` props](https://next-auth.js.org/getting-started/client#options)
* `options`: Not exposed anymore, [use `SessionProvider` props](https://next-auth.js.org/getting-started/client#options)
* `session`: Renamed to `getSession`
* `providers`: Renamed to `getProviders`
* `csrfToken`: Renamed to `getCsrfToken`
* `signin`: Renamed to `signIn`
* `signout`: Renamed to `signOut`
* `Provider`: Renamed to `SessionProvider`

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.12>

## `SessionProvider`[â€‹](#sessionprovider "Direct link to heading")

Version 4 makes using the `SessionProvider` mandatory. This means that you will have to wrap any part of your application using `useSession` in this provider, if you were not doing so already. The `SessionProvider` has also undergone a few further changes:

* `Provider` is renamed to `SessionProvider`
* The options prop is now flattened as the props of SessionProvider.
* `keepAlive` has been renamed to `refetchInterval`.
* `clientMaxAge` has been removed in favor of `refetchInterval`, as they overlap in functionality, with the difference that `refetchInterval` will keep re-fetching the session periodically in the background.

The best practice for wrapping your app in Providers is to do so in your `pages/_app.jsx` file.

An example use-case with these new changes:

```
import { SessionProvider } from "next-auth/react"

export default function App({
  Component,
  pageProps: { session, ...pageProps },
}) {
  return (
    // `session` comes from `getServerSideProps` or `getInitialProps`.
    // Avoids flickering/session loading on first load.
    <SessionProvider session={session} refetchInterval={5 * 60}>
      <Component {...pageProps} />
    </SessionProvider>
  )
}

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.12>

## Providers[â€‹](#providers "Direct link to heading")

Providers now need to be imported individually.

```
- import Provider from "next-auth/providers"
- Providers.Auth0({...})
- Providers.Google({...})
+ import Auth0Provider from "next-auth/providers/auth0"
+ import GoogleProvider from "next-auth/providers/google"
+ Auth0Provider({...})
+ GoogleProvider({...})

```

1. The `AzureADB2C` provider has been renamed `AzureAD`.
2. The `Basecamp` provider has been removed, see explanation [here](https://github.com/basecamp/api/blob/master/sections/authentication.md#on-authenticating-users-via-oauth).
3. The GitHub provider by default now will not request full write access to user profiles. If you need this scope, please add `user` to the scope option manually.

The following new options are available when defining your Providers in the configuration:

1. `authorization` (replaces `authorizationUrl`, `authorizationParams`, `scope`)
2. `token` replaces (`accessTokenUrl`, `headers`, `params`)
3. `userinfo` (replaces `profileUrl`)
4. `issuer`(replaces `domain`)

For more details on their usage, please see [options](/configuration/providers/oauth#options) section of the OAuth Provider documentation.

When submitting a new OAuth provider to the repository, the `profile` callback is expected to only return these fields from now on: `id`, `name`, `email`, and `image`. If any of these are missing values, they should be set to `null`.

Also worth noting is that `id` is expected to be returned as a `string` type (For example if your provider returns it as a number, you can cast it by using the `.toString()` method). This makes the returned profile object comply across all providers/accounts/adapters, and hopefully cause less confusion in the future.

Implemented in: [#2411](https://github.com/nextauthjs/next-auth/pull/2411)
Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.20>

## `useSession` Hook[â€‹](#usesession-hook "Direct link to heading")

The `useSession` hook has been updated to return an object. This allows you to test states much more cleanly with the new `status` option.

```
- const [ session, loading ] = useSession()
+ const { data: session, status } = useSession()
+ const loading = status === "loading"

```

[Check the docs](https://next-auth.js.org/getting-started/client#usesession) for the possible values of both `session.status` and `session.data`.

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.18>

## Named Parameters[â€‹](#named-parameters "Direct link to heading")

We have changed the arguments to our callbacks to the named parameters pattern. This way you don't have to use dummy `_` placeholders or other tricks.

### Callbacks[â€‹](#callbacks "Direct link to heading")

The signatures for the callback methods now look like this:

```
- signIn(user, account, profileOrEmailOrCredentials)
+ signIn({ user, account, profile, email, credentials })

```
```
- redirect(url, baseUrl)
+ redirect({ url, baseUrl })

```
```
- session(session, tokenOrUser)
+ session({ session, token, user })

```
```
- jwt(token, user, account, OAuthProfile, isNewUser)
+ jwt({ token, user, account, profile, isNewUser })

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.17>

### Events[â€‹](#events "Direct link to heading")

Two event signatures have changed to also use the named parameters pattern, `signOut` and `updateUser`.

```
// [...nextauth].js
...
events: {
- signOut(tokenOrSession),
+ signOut({ token, session }), // token if using JWT, session if DB persisted sessions.
- updateUser(user)
+ updateUser({ user })
}

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.20>

## JWT configuration[â€‹](#jwt-configuration "Direct link to heading")

We have removed some of the [configuration options](/configuration/options) when using JSON Web Tokens, [here's the PR](https://github.com/nextauthjs/next-auth/pull/3039) for more context.

```
export default NextAuth({
  // ...
  jwt: {
    secret,
    maxAge,
-   encryptionKey
-   signingKey
-   encryptionKey
-   verificationOptions
    encode({
        token
        secret
        maxAge
-       signingKey
-       signingOptions
-       encryptionKey
-       encryptionOptions
-       encryption
    }) {},
    decode({
        token
        secret
-       maxAge
-       signingKey
-       verificationKey
-       verificationOptions
-       encryptionKey
-       decryptionKey
-       decryptionOptions
-       encryption
    }) {}
  }
})

```
## Logger API[â€‹](#logger-api "Direct link to heading")

The logger API has been simplified to use at most two parameters, where the second is usually an object (`metadata`) containing an `error` object. If you are not using the logger settings you can ignore this change.

```
// [...nextauth.js]
import log from "some-logger-service"
...
logger: {
- error(code, ...message) {},
+ error(code, metadata) {},
- warn(code, ...message) {},
+ warn(code) {}
- debug(code, ...message) {}
+ debug(code, metadata) {}
}

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.19>

## `nodemailer`[â€‹](#nodemailer "Direct link to heading")

Like `typeorm` and `prisma`, [`nodemailer`](https://npmjs.com/package/nodemailer) is no longer included as a dependency by default. If you are using the Email provider you must install it in your project manually, or use any other Email library in the [`sendVerificationRequest`](/configuration/providers/email#options-1#:~:text=sendVerificationRequest) callback. This reduces bundle size for those not actually using the Email provider. Remember, when using the Email provider, it is mandatory to also use a database adapter due to the fact that verification tokens need to be persisted longer term for the magic link functionality to work.

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.2>

## Theme[â€‹](#theme "Direct link to heading")

We have added some basic customization options to our built-in pages like `signin`, `signout`, etc.

These can be set under the `theme` configuration key. This used to be a string which only controlled the color scheme option. Now it is an object with the following options:

```
theme: {
  colorScheme: "auto", // "auto" | "dark" | "light"
  brandColor: "", // Hex color value
  logo: "" // Absolute URL to logo image
}

```

The hope is that with some minimal configuration / customization options, users won't immediately feel the need to replace the built-in pages with their own.

More details and screenshots of the new theme options can be found under [configuration/pages](https://next-auth.js.org/configuration/pages#theming).

Introduced in [#2788](https://github.com/nextauthjs/next-auth/pull/2788)

## Session[â€‹](#session "Direct link to heading")

The `session.jwt: boolean` option has been renamed to `session.strategy: "jwt" | "database"`. The goal is to make the user's options more intuitive:

1. No adapter, `strategy: "jwt"`: This is the default. The session is saved in a cookie and never persisted anywhere.
2. With Adapter, `strategy: "database"`: If an Adapter is defined, this will be the implicit setting. No user config is needed.
3. With Adapter, `strategy: "jwt"`: The user can explicitly instruct `next-auth` to use JWT even if a database is available. This can result in faster lookups in compromise of lowered security. Read more about: <https://next-auth.js.org/faq#json-web-tokens>

Example:

```
session: {
- jwt: true,
+ strategy: "jwt",
}

```

Introduced in [#3144](https://github.com/nextauthjs/next-auth/pull/3144)

## Adapters[â€‹](#adapters "Direct link to heading")

Most importantly, the core `next-auth` package no longer ships with `typeorm` or any other database adapter by default. This brings the default bundle size down significantly for those not needing to persist user data to a database.

You can find the official Adapters in the `packages` directory in the primary monorepo ([nextauthjs/next-auth](https://github.com/nextauthjs/next-auth)). Although you can still [create your own](/tutorials/creating-a-database-adapter) with a new, [simplified Adapter API](https://github.com/nextauthjs/next-auth/pull/2361).

If you have a database that was created with a `3.x.x` or earlier version of NextAuth.js, you will need to run a migration to update the schema to the new version 4 database model. See the bottom of this migration guide for database specific migration examples.

1. If you use the built-in TypeORM or Prisma adapters, these have been removed from the core `next-auth` package. Thankfully the migration is easy; you just need to install the external packages for your database and change the import in your `[...nextauth].js`.

The `database` option has been removed, you must now do the following instead:

```
// [...nextauth].js
import NextAuth from "next-auth"
+ import { TypeORMLegacyAdapter } from "@next-auth/typeorm-legacy-adapter"

...
export default NextAuth({
-  database: "yourconnectionstring",
+  adapter: TypeORMLegacyAdapter("yourconnectionstring")
})

```

2. The `prisma-legacy` adapter has been removed, please use the [`@next-auth/prisma-adapter`](https://npmjs.com/package/%40next-auth/prisma-adapter) instead.
3. The `typeorm-legacy` adapter has been upgraded to use the newer adapter API, but has retained the `typeorm-legacy` name. We aim to migrate this to individual lighter weight adapters for each database type in the future, or switch out `typeorm`.
4. MongoDB has been moved to its own adapter under `@next-auth/mongodb-adapter`. See the [MongoDB Adapter docs](https://authjs.dev/getting-started/adapters/mongodb).

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.8> and [#2361](https://github.com/nextauthjs/next-auth/pull/2361)

### Adapter API[â€‹](#adapter-api "Direct link to heading")

**This does not require any changes from the user - these are adapter specific changes only**

The Adapter API has been rewritten and significantly simplified in NextAuth.js v4. The adapters now have less work to do as some functionality has been migrated to the core of NextAuth, like hashing the [verification token](https://authjs.dev/concepts/database-models#verificationtoken).

If you are an adapter maintainer or are interested in writing your own adapter, you can find more information about this change in [#2361](https://github.com/nextauthjs/next-auth/pull/2361) and release <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.22>.

### Schema changes[â€‹](#schema-changes "Direct link to heading")

The way we save data with adapters have slightly changed. With the new Adapter API, we wanted to make it easier to extend your database with additional fields. For example if your User needs an extra `phone` field, it should be enough to add that to your database's schema, and no changes will be necessary in your adapter.

* `created_at`/`createdAt` and `updated_at`/`updatedAt` fields are removed from all Models.
* `user_id`/`userId` consistently named `userId`.
* `compound_id`/`compoundId` is removed from Account.
* `access_token`/`accessToken` is removed from Session.
* `email_verified`/`emailVerified` on User is consistently named `emailVerified`.
* `provider_id`/`providerId` renamed to `provider` on Account
* `provider_type`/`providerType` renamed to `type` on Account
* `provider_account_id`/`providerAccountId` on Account is consistently named `providerAccountId`
* `access_token_expires`/`accessTokenExpires` on Account renamed to `expires_at`
* New fields on Account: `token_type`, `scope`, `id_token`, `session_state`
* `verification_requests` table has been renamed to `verification_tokens`

See the changes
```

```
User {
  id
  name
  email
+ emailVerified
- email_verified
  image
-  created_at
-  updated_at
}

Account {
  id
- compound_id
- user_id
+ userId
-  provider_type
+ type
- provider_id
+ provider
- provider_account_id
+ providerAccountId
  refresh_token
  access_token
- access_token_expires
+ expires_in
+ expires_at
+ token_type
+ scope
+ id_token
+ session_state
- created_at
- updated_at
}

Session {
  id
  userId
  expires
  sessionToken
- access_token
- created_at
- updated_at
}

VerificationToken {
  id
  token
  expires
  identifier
-  created_at
-  updated_at
}

```

```

For more info, see the [Models page](https://authjs.dev/concepts/database-models).

### Database migration[â€‹](#database-migration "Direct link to heading")

NextAuth.js v4 has a slightly different database schema compared to v3. If you're using any of our adapters and want to upgrade, you can use on of the below schemas.

They are designed to be run directly against the database itself. So instead of having one in Prisma syntax, one in TypeORM syntax, etc. we've decided to just make one for each underlying database type. i.e. one for Postgres, one for MySQL, one for MongoDB, etc.

#### MySQL[â€‹](#mysql "Direct link to heading")

```
/* ACCOUNT */
ALTER TABLE accounts
CHANGE "access_token_expires" "expires_at" int
CHANGE "user_id" "userId" varchar(255)
ADD CONSTRAINT fk_user_id FOREIGN KEY (userId) REFERENCES users(id)
RENAME COLUMN "provider_id" "provider"
RENAME COLUMN "provider_account_id" "providerAccountId"
DROP COLUMN "provider_type"
DROP COLUMN "compound_id"
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

ADD COLUMN "token_type" varchar(255) NULL
ADD COLUMN "scope" varchar(255) NULL
ADD COLUMN "id_token" varchar(255) NULL
ADD COLUMN "session_state" varchar(255) NULL

/* Note: These are only needed if you're going to be using the old Twitter OAuth 1.0 provider. */
ADD COLUMN "oauth_token_secret" varchar(255) NULL
ADD COLUMN "oauth_token" varchar(255) NULL

/* USER */
ALTER TABLE users
RENAME COLUMN "email_verified" "emailVerified"
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

/* SESSION */
ALTER TABLE sessions
RENAME COLUMN "session_token" "sessionToken"
CHANGE "user_id" "userId" varchar(255)
ADD CONSTRAINT fk_user_id FOREIGN KEY (userId) REFERENCES users(id)
DROP COLUMN "access_token"
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

/* VERIFICATION REQUESTS */
ALTER TABLE verification_requests RENAME verification_tokens
ALTER TABLE verification_tokens
DROP COLUMN id
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

```
#### Postgres[â€‹](#postgres "Direct link to heading")

```
/* ACCOUNT */
ALTER TABLE accounts RENAME COLUMN "user_id" TO "userId";
ALTER TABLE accounts RENAME COLUMN "provider_id" TO "provider";
ALTER TABLE accounts RENAME COLUMN "provider_account_id" TO "providerAccountId";
ALTER TABLE accounts RENAME COLUMN "access_token_expires" TO "expires_at";
ALTER TABLE accounts RENAME COLUMN "provider_type" TO "type";

/* Do conversion of TIMESTAMPTZ to BIGINT */
ALTER TABLE accounts ALTER COLUMN "expires_at" TYPE TEXT USING CAST(extract(epoch FROM "expires_at") AS BIGINT)*1000;

/* Keep id as SERIAL with autoincrement when using ORM. Using new v4 uuid format won't work because of incompatibility */
/* ALTER TABLE accounts ALTER COLUMN "id" TYPE TEXT; */
/* ALTER TABLE accounts ALTER COLUMN "userId" TYPE TEXT; */
ALTER TABLE accounts ALTER COLUMN "type" TYPE TEXT;
ALTER TABLE accounts ALTER COLUMN "provider" TYPE TEXT;
ALTER TABLE accounts ALTER COLUMN "providerAccountId" TYPE TEXT;

ALTER TABLE accounts ADD CONSTRAINT fk_user_id FOREIGN KEY ("userId") REFERENCES users(id);
ALTER TABLE accounts
DROP COLUMN IF EXISTS "compound_id";
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE accounts
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

ALTER TABLE accounts
ADD COLUMN IF NOT EXISTS "token_type" TEXT NULL,
ADD COLUMN IF NOT EXISTS "scope" TEXT NULL,
ADD COLUMN IF NOT EXISTS "id_token" TEXT NULL,
ADD COLUMN IF NOT EXISTS "session_state" TEXT NULL;
/* Note: These are only needed if you're going to be using the old Twitter OAuth 1.0 provider. */
/* ALTER TABLE accounts
ADD COLUMN IF NOT EXISTS "oauth_token_secret" TEXT NULL,
ADD COLUMN IF NOT EXISTS "oauth_token" TEXT NULL; */

/* USER */
ALTER TABLE users RENAME COLUMN "email_verified" TO "emailVerified";

/* Keep id as SERIAL with autoincrement when using ORM. Using new v4 uuid format won't work because of incompatibility */
/* ALTER TABLE users ALTER COLUMN "id" TYPE TEXT; */
ALTER TABLE users ALTER COLUMN "name" TYPE TEXT;
ALTER TABLE users ALTER COLUMN "email" TYPE TEXT;
ALTER TABLE users ALTER COLUMN "image" TYPE TEXT;
/* Do conversion of TIMESTAMPTZ to BIGINT and then TEXT */
ALTER TABLE users ALTER COLUMN "emailVerified" TYPE TEXT USING CAST(CAST(extract(epoch FROM "emailVerified") AS BIGINT)*1000 AS TEXT);
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE users
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

/* SESSION */
ALTER TABLE sessions RENAME COLUMN "session_token" TO "sessionToken";
ALTER TABLE sessions RENAME COLUMN "user_id" TO "userId";

/* Keep id as SERIAL with autoincrement when using ORM. Using new v4 uuid format won't work because of incompatibility */
/* ALTER TABLE sessions ALTER COLUMN "id" TYPE TEXT; */
/* ALTER TABLE sessions ALTER COLUMN "userId" TYPE TEXT; */
ALTER TABLE sessions ALTER COLUMN "sessionToken" TYPE TEXT;
ALTER TABLE sessions ADD CONSTRAINT fk_user_id FOREIGN KEY ("userId") REFERENCES users(id);
/* Do conversion of TIMESTAMPTZ to BIGINT and then TEXT */
ALTER TABLE sessions ALTER COLUMN "expires" TYPE TEXT USING CAST(CAST(extract(epoch FROM "expires") AS BIGINT)*1000 AS TEXT);
ALTER TABLE sessions DROP COLUMN IF EXISTS "access_token";
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE sessions
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

/* VERIFICATION REQUESTS */
ALTER TABLE verification_requests RENAME TO verification_tokens;
/* Keep id as ORM needs it */
/* ALTER TABLE verification_tokens DROP COLUMN IF EXISTS id; */
ALTER TABLE verification_tokens ALTER COLUMN "identifier" TYPE TEXT;
ALTER TABLE verification_tokens ALTER COLUMN "token" TYPE TEXT;
/* Do conversion of TIMESTAMPTZ to BIGINT and then TEXT */
ALTER TABLE verification_tokens ALTER COLUMN "expires" TYPE TEXT USING CAST(CAST(extract(epoch FROM "expires") AS BIGINT)*1000 AS TEXT);
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE verification_tokens
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

```
#### MongoDB[â€‹](#mongodb "Direct link to heading")

MongoDB is a document database and as such new fields will be automatically populated. You do, however, need to update the names of existing fields which are going to be reused.

```
db.getCollection('accounts').updateMany({}, {
  $rename: {
    "provider_id": "provider",
    "provider_account_id": "providerAccountId",
    "user_id": "userId",
    "access_token_expires": "expires_at"
  }
})
db.getCollection('users').updateMany({}, {
  $rename: {
    "email_verified": "emailVerified"
  }
})
db.getCollection('sessions').updateMany({}, {
  $rename: {
    "session_token": "sessionToken",
    "user_id": "userId"
  }
})

```
## Missing `secret`[â€‹](#missing-secret "Direct link to heading")

NextAuth.js used to generate a secret for convenience, when the user did not define one. This might have been useful in development, but can be a concern in production. We have always been clear about that in the docs, but from now on, if you forget to define a `secret` property in production, we will show the user an error page. Read more about this option [here](https://next-auth.js.org/configuration/options#secret)

You can generate a secret to be placed in the `secret` configuration option via the following command:

```
$ openssl rand -base64 32

```

Therefore, your NextAuth.js config should look something like this:

/pages/api/auth/[...nextauth].js
```
...
export default NextAuth({
  ...
  providers: [...],
  secret: "LlKq6ZtYbr+hTC073mAmAh9/h2HwMfsFo4hrfCx5mLg=",
  ...
})

```

Introduced in [#3143](https://github.com/nextauthjs/next-auth/issues/3143)

## Session `strategy`[â€‹](#session-strategy "Direct link to heading")

We have always supported two different session strategies. The first being our most popular and default strategy - the JWT based one. The second is the database adapter persisted session strategy. Both have their advantages/disadvantages, you can learn more about them on the [FAQ](https://next-auth.js.org/faq) page.

Previously, the way you configured this was through the `jwt: boolean` flag in the `session` option. The names `session` and `jwt` might have been a bit overused in the options, and so for a clearer message, we renamed this option to `strategy: "jwt" | "database"`, it is still in the `session` object. This will hopefully better indicate the purpose of this option as well as make very explicit which type of session you are going to use.

See the [`session` option docs](https://next-auth.js.org/configuration/options#session) for more details.

Introduced in [#3144](https://github.com/nextauthjs/next-auth/pull/3144)

## Summary[â€‹](#summary "Direct link to heading")

We hope this migration goes smoothly for each and every one of you! If you have any questions or get stuck anywhere, feel free to create [a new issue](https://github.com/nextauthjs/next-auth/issues/new) on GitHub.

[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/getting-started/upgrade-to-v4.md)Last updated on **Oct 24, 2024** by **BalÃ¡zs OrbÃ¡n**[PreviousTypeScript](/getting-started/typescript)[NextInitialization](/configuration/initialization)

* [`next-auth/jwt`](#next-authjwt)
* [`next-auth/react`](#next-authreact)
* [`SessionProvider`](#sessionprovider)
* [Providers](#providers)
* [`useSession` Hook](#usesession-hook)
* [Named Parameters](#named-parameters)
  + [Callbacks](#callbacks)
  + [Events](#events)
* [JWT configuration](#jwt-configuration)
* [Logger API](#logger-api)
* [`nodemailer`](#nodemailer)
* [Theme](#theme)
* [Session](#session)
* [Adapters](#adapters)
  + [Adapter API](#adapter-api)
  + [Schema changes](#schema-changes)
  + [Database migration](#database-migration)
* [Missing `secret`](#missing-secret)
* [Session `strategy`](#session-strategy)
* [Summary](#summary)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js Â© Iain Collins 2025



=== Content from next-auth.js.org_dd078c24_20250114_232053.html ===

Skip to main contentNextAuth.js is becoming Auth.js! ðŸŽ‰ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/configuration/callbacks)
* [v3](/v3/configuration/callbacks)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
  + [Initialization](/configuration/initialization)
  + [Options](/configuration/options)
  + [Providers](/configuration/providers/oauth)
  + [Databases](/configuration/databases)
  + [Pages](/configuration/pages)
  + [Callbacks](/configuration/callbacks)
  + [Events](/configuration/events)
  + [Next.js](/configuration/nextjs)
* [Providers](/providers/)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk â†’](https://go.clerk.com/DefS1u4)

* Configuration
* Callbacks
Version: v4On this page
# Callbacks

Callbacks are **asynchronous** functions you can use to control what happens when an action is performed.

Callbacks are extremely powerful, especially in scenarios involving JSON Web Tokens as they allow you to implement access controls without a database and to integrate with external databases or APIs.

tip

If you want to pass data such as an Access Token or User ID to the browser when using JSON Web Tokens, you can persist the data in the token when the `jwt` callback is called, then pass the data through to the browser in the `session` callback.

You can specify a handler for any of the callbacks below.

pages/api/auth/[...nextauth].js
```
...
  callbacks: {
    async signIn({ user, account, profile, email, credentials }) {
      return true
    },
    async redirect({ url, baseUrl }) {
      return baseUrl
    },
    async session({ session, user, token }) {
      return session
    },
    async jwt({ token, user, account, profile, isNewUser }) {
      return token
    }
...
}

```

The documentation below shows how to implement each callback, their default behaviour and an example of what the response for each callback should be. Note that configuration options and authentication providers you are using can impact the values passed to the callbacks.

## Sign in callback[â€‹](#sign-in-callback "Direct link to heading")

Use the `signIn()` callback to control if a user is allowed to sign in.

pages/api/auth/[...nextauth].js
```
...
callbacks: {
  async signIn({ user, account, profile, email, credentials }) {
    const isAllowedToSignIn = true
    if (isAllowedToSignIn) {
      return true
    } else {
      // Return false to display a default error message
      return false
      // Or you can return a URL to redirect to:
      // return '/unauthorized'
    }
  }
}
...

```

* When using the **Email Provider** the `signIn()` callback is triggered both when the user makes a **Verification Request** (before they are sent an email with a link that will allow them to sign in) and again *after* they activate the link in the sign-in email.

  Email accounts do not have profiles in the same way OAuth accounts do. On the first call during email sign in the `email` object will include a property `verificationRequest: true` to indicate it is being triggered in the verification request flow. When the callback is invoked *after* a user has clicked on a sign-in link, this property will not be present.

  You can check for the `verificationRequest` property to avoid sending emails to addresses or domains on a blocklist (or to only explicitly generate them for email address in an allow list).

* When using the **Credentials Provider** the `user` object is the response returned from the `authorize` callback and the `profile` object is the raw body of the `HTTP POST` submission.

note

When using NextAuth.js with a database, the User object will be either a user object from the database (including the User ID) if the user has signed in before or a simpler prototype user object (i.e. name, email, image) for users who have not signed in before.

When using NextAuth.js without a database, the user object will always be a prototype user object, with information extracted from the profile.

note

Redirects returned by this callback cancel the authentication flow. Only redirect to error pages that, for example, tell the user why they're not allowed to sign in.

To redirect to a page after a successful sign in, please use [the `callbackUrl` option](/getting-started/client#specifying-a-callbackurl) or [the redirect callback](/configuration/callbacks#redirect-callback).

## Redirect callback[â€‹](#redirect-callback "Direct link to heading")

The redirect callback is called anytime the user is redirected to a callback URL (e.g. on signin or signout).

By default only URLs on the same URL as the site are allowed, you can use the redirect callback to customise that behaviour.

The default redirect callback looks like this:

pages/api/auth/[...nextauth].js
```
...
callbacks: {
  async redirect({ url, baseUrl }) {
    // Allows relative callback URLs
    if (url.startsWith("/")) return `${baseUrl}${url}`
    // Allows callback URLs on the same origin
    else if (new URL(url).origin === baseUrl) return url
    return baseUrl
  }
}
...

```
note

The redirect callback may be invoked more than once in the same flow.

## JWT callback[â€‹](#jwt-callback "Direct link to heading")

This callback is called whenever a JSON Web Token is created (i.e. at sign
in) or updated (i.e whenever a session is accessed in the client). The returned value will be [encrypted](/configuration/options#jwt), and it is stored in a cookie.

Requests to `/api/auth/signin`, `/api/auth/session` and calls to `getSession()`, `getServerSession()`, `useSession()` will invoke this function, but only if you are using a [JWT session](/configuration/options#session). This method is not invoked when you persist sessions in a database.

* As with database persisted session expiry times, token expiry time is extended whenever a session is active.
* The arguments *user*, *account*, *profile* and *isNewUser* are only passed the first time this callback is called on a new session, after the user signs in. In subsequent calls, only `token` will be available.

The contents *user*, *account*, *profile* and *isNewUser* will vary depending on the provider and if you are using a database. You can persist data such as User ID, OAuth Access Token in this token, see the example below for `access_token` and `user.id`. To expose it on the client side, check out the [`session()` callback](#session-callback) as well.

pages/api/auth/[...nextauth].js
```
...
callbacks: {
  async jwt({ token, account, profile }) {
    // Persist the OAuth access_token and or the user id to the token right after signin
    if (account) {
      token.accessToken = account.access_token
      token.id = profile.id
    }
    return token
  }
}
...

```
tip

Use an if branch to check for the existence of parameters (apart from `token`). If they exist, this means that the callback is being invoked for the first time (i.e. the user is being signed in). This is a good place to persist additional data like an `access_token` in the JWT. Subsequent invocations will only contain the `token` parameter.

## Session callback[â€‹](#session-callback "Direct link to heading")

The session callback is called whenever a session is checked. By default, **only a subset of the token is returned for increased security**. If you want to make something available you added to the token (like `access_token` and `user.id` from above) via the `jwt()` callback, you have to explicitly forward it here to make it available to the client.

e.g. `getSession()`, `useSession()`, `/api/auth/session`

* When using database sessions, the User (`user`) object is passed as an argument.
* When using JSON Web Tokens for sessions, the JWT payload (`token`) is provided instead.

pages/api/auth/[...nextauth].js
```
...
callbacks: {
  async session({ session, token, user }) {
    // Send properties to the client, like an access_token and user id from a provider.
    session.accessToken = token.accessToken
    session.user.id = token.id

    return session
  }
}
...

```
tip

When using JSON Web Tokens the `jwt()` callback is invoked before the `session()` callback, so anything you add to the
JSON Web Token will be immediately available in the session callback, like for example an `access_token` or `id` from a provider.

danger

The session object is not persisted server side, even when using database sessions - only data such as the session token, the user, and the expiry time is stored in the session table.

If you need to persist session data server side, you can use the `accessToken` returned for the session as a key - and connect to the database in the `session()` callback to access it. Session `accessToken` values do not rotate and are valid as long as the session is valid.

If using JSON Web Tokens instead of database sessions, you should use the User ID or a unique key stored in the token (you will need to generate a key for this yourself on sign in, as access tokens for sessions are not generated when using JSON Web Tokens).

[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/configuration/callbacks.md)Last updated on **Oct 24, 2024** by **BalÃ¡zs OrbÃ¡n**[PreviousPages](/configuration/pages)[NextEvents](/configuration/events)

* [Sign in callback](#sign-in-callback)
* [Redirect callback](#redirect-callback)
* [JWT callback](#jwt-callback)
* [Session callback](#session-callback)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js Â© Iain Collins 2025


