=== Content from github.com_80387566_20250114_190015.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-swift%2Fcommit%2F858f977f2a51fca2292f384cf7a108dc2e73a3bd)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-swift%2Fcommit%2F858f977f2a51fca2292f384cf7a108dc2e73a3bd)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=grpc%2Fgrpc-swift)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[grpc](/grpc)
/
**[grpc-swift](/grpc/grpc-swift)**
Public

* [Notifications](/login?return_to=%2Fgrpc%2Fgrpc-swift) You must be signed in to change notification settings
* [Fork
  419](/login?return_to=%2Fgrpc%2Fgrpc-swift)
* [Star
   2.1k](/login?return_to=%2Fgrpc%2Fgrpc-swift)

* [Code](/grpc/grpc-swift)
* [Issues
  101](/grpc/grpc-swift/issues)
* [Pull requests
  3](/grpc/grpc-swift/pulls)
* [Actions](/grpc/grpc-swift/actions)
* [Projects
  0](/grpc/grpc-swift/projects)
* [Wiki](/grpc/grpc-swift/wiki)
* [Security](/grpc/grpc-swift/security)
* [Insights](/grpc/grpc-swift/pulse)

Additional navigation options

* [Code](/grpc/grpc-swift)
* [Issues](/grpc/grpc-swift/issues)
* [Pull requests](/grpc/grpc-swift/pulls)
* [Actions](/grpc/grpc-swift/actions)
* [Projects](/grpc/grpc-swift/projects)
* [Wiki](/grpc/grpc-swift/wiki)
* [Security](/grpc/grpc-swift/security)
* [Insights](/grpc/grpc-swift/pulse)

## Commit

[Permalink](/grpc/grpc-swift/commit/858f977f2a51fca2292f384cf7a108dc2e73a3bd)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-r6ww-5963-7r95](https://github.com/advisories/GHSA-r6ww-5963-7r95 "GHSA-r6ww-5963-7r95")

[Browse files](/grpc/grpc-swift/tree/858f977f2a51fca2292f384cf7a108dc2e73a3bd)
Browse the repository at this point in the history

```
Better handle client sending GOAWAY
```

* Loading branch information

[![@glbrntt](https://avatars.githubusercontent.com/u/5047671?s=40&v=4)](/glbrntt)

[glbrntt](/grpc/grpc-swift/commits?author=glbrntt "View all commits by glbrntt")
authored
Mar 23, 2022

2 parents
[7648750](/grpc/grpc-swift/commit/76487507dbbdce3a28c96c3b17a021923f5e097f)
+
[e09cf66](/grpc/grpc-swift/commit/e09cf661a54f9fd39f6ca9693f489c92cd7cf3f8)

commit 858f977

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**139 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* FuzzTesting/FailCases

  + FuzzTesting/FailCases/clusterfuzz-testcase-minimized-ServerFuzzer-release-4739158818553856
    [clusterfuzz-testcase-minimized-ServerFuzzer-release-4739158818553856](#diff-8ee6fd9355fc12c5eb19481966a7ddf8d9bdfe7d0f6c0d8eebbd11f7d92a53c5)
* Sources/GRPC

  + Sources/GRPC/GRPCIdleHandler.swift
    [GRPCIdleHandler.swift](#diff-6b6f2e83ee52754ea90920c265817616153a80fc90d77b231754010b39fa6905)
  + Sources/GRPC/GRPCIdleHandlerStateMachine.swift
    [GRPCIdleHandlerStateMachine.swift](#diff-e20ec214db7770657336ddc122e0bc34b4f9792111888de52a70e17435f3deb2)
  + Sources/GRPC/GRPCKeepaliveHandlers.swift
    [GRPCKeepaliveHandlers.swift](#diff-f1a4a0b9dffa2a2cff6dec3981e53270489ae4f52080b2e24afeb2e82b3d75c4)
* Tests/GRPCTests

  + Tests/GRPCTests/GRPCIdleHandlerStateMachineTests.swift
    [GRPCIdleHandlerStateMachineTests.swift](#diff-323210c80c340064623619deced4017d1176687bb47bfc233c689557ecc25c8d)
  + Tests/GRPCTests/GRPCPingHandlerTests.swift
    [GRPCPingHandlerTests.swift](#diff-be1e60ffdb9b3d2a7668e70122e87f61c07ec9901621e8281944fd02136ac3bd)
  + Tests/GRPCTests/ServerFuzzingRegressionTests.swift
    [ServerFuzzingRegressionTests.swift](#diff-99213e827283fa98802c7f4ebb9337379a8a1a934f9c8a5910b3ea82b41cdcf8)

## There are no files selected for viewing

Binary file added
BIN
+626 Bytes

[FuzzTesting/FailCases/clusterfuzz-testcase-minimized-ServerFuzzer-release-4739158818553856](#diff-8ee6fd9355fc12c5eb19481966a7ddf8d9bdfe7d0f6c0d8eebbd11f7d92a53c5 "FuzzTesting/FailCases/clusterfuzz-testcase-minimized-ServerFuzzer-release-4739158818553856")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/FuzzTesting/FailCases/clusterfuzz-testcase-minimized-ServerFuzzer-release-4739158818553856)
Edit file

Delete file

Binary file not shown.

17 changes: 16 additions & 1 deletion

17
[Sources/GRPC/GRPCIdleHandler.swift](#diff-6b6f2e83ee52754ea90920c265817616153a80fc90d77b231754010b39fa6905 "Sources/GRPC/GRPCIdleHandler.swift")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/Sources/GRPC/GRPCIdleHandler.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -153,7 +153,19 @@ internal final class GRPCIdleHandler: ChannelInboundHandler { |
|  |  | streamID: .rootStream, |
|  |  | payload: .goAway(lastStreamID: streamID, errorCode: .noError, opaqueData: nil) |
|  |  | ) |
|  |  | self.context?.writeAndFlush(self.wrapOutboundOut(goAwayFrame), promise: nil) |
|  |  |  |
|  |  | self.context?.write(self.wrapOutboundOut(goAwayFrame), promise: nil) |
|  |  |  |
|  |  | // We emit a ping after some GOAWAY frames. |
|  |  | if operations.shouldPingAfterGoAway { |
|  |  | let pingFrame = HTTP2Frame( |
|  |  | streamID: .rootStream, |
|  |  | payload: .ping(self.pingHandler.pingDataGoAway, ack: false) |
|  |  | ) |
|  |  | self.context?.write(self.wrapOutboundOut(pingFrame), promise: nil) |
|  |  | } |
|  |  |  |
|  |  | self.context?.flush() |
|  |  | } |
|  |  |  |
|  |  | // Close the channel, if necessary. |
| Expand Down  Expand Up | | @@ -181,6 +193,9 @@ internal final class GRPCIdleHandler: ChannelInboundHandler { |
|  |  | case let .reply(framePayload): |
|  |  | let frame = HTTP2Frame(streamID: .rootStream, payload: framePayload) |
|  |  | self.context?.writeAndFlush(self.wrapOutboundOut(frame), promise: nil) |
|  |  |  |
|  |  | case .ratchetDownLastSeenStreamID: |
|  |  | self.perform(operations: self.stateMachine.ratchetDownGoAwayStreamID()) |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

46 changes: 39 additions & 7 deletions

46
[Sources/GRPC/GRPCIdleHandlerStateMachine.swift](#diff-e20ec214db7770657336ddc122e0bc34b4f9792111888de52a70e17435f3deb2 "Sources/GRPC/GRPCIdleHandlerStateMachine.swift")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/Sources/GRPC/GRPCIdleHandlerStateMachine.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -189,10 +189,17 @@ struct GRPCIdleHandlerStateMachine { |
|  |  | /// Whether the channel should be closed. |
|  |  | private(set) var shouldCloseChannel: Bool |
|  |  |  |
|  |  | /// Whether a ping should be sent after a GOAWAY frame. |
|  |  | private(set) var shouldPingAfterGoAway: Bool |
|  |  |  |
|  |  | fileprivate static let none = Operations() |
|  |  |  |
|  |  | fileprivate mutating func sendGoAwayFrame(lastPeerInitiatedStreamID streamID: HTTP2StreamID) { |
|  |  | fileprivate mutating func sendGoAwayFrame( |
|  |  | lastPeerInitiatedStreamID streamID: HTTP2StreamID, |
|  |  | followWithPing: Bool = false |
|  |  | ) { |
|  |  | self.sendGoAwayWithLastPeerInitiatedStreamID = streamID |
|  |  | self.shouldPingAfterGoAway = followWithPing |
|  |  | } |
|  |  |  |
|  |  | fileprivate mutating func cancelIdleTask(\_ task: Scheduled<Void>) { |
| Expand Down  Expand Up | | @@ -220,6 +227,7 @@ struct GRPCIdleHandlerStateMachine { |
|  |  | self.idleTask = nil |
|  |  | self.sendGoAwayWithLastPeerInitiatedStreamID = nil |
|  |  | self.shouldCloseChannel = false |
|  |  | self.shouldPingAfterGoAway = false |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -267,12 +275,7 @@ struct GRPCIdleHandlerStateMachine { |
|  |  | operations.cancelIdleTask(state.idleTask) |
|  |  |  |
|  |  | case var .quiescing(state): |
|  |  | precondition(state.initiatedByUs) |
|  |  | precondition(state.role == .client) |
|  |  | // If we're a client and we initiated shutdown then it's possible for streams to be created in |
|  |  | // the quiescing state as there's a delay between stream channels (i.e. `HTTP2StreamChannel`) |
|  |  | // being created and us being notified about their creation (via a user event fired by |
|  |  | // the `HTTP2Handler`). |
|  |  | state.lastPeerInitiatedStreamID = streamID |
|  |  | state.openStreams += 1 |
|  |  | self.state = .quiescing(state) |
|  |  |  |
| Expand Down  Expand Up | | @@ -466,6 +469,18 @@ struct GRPCIdleHandlerStateMachine { |
|  |  |  |
|  |  | if state.hasOpenStreams { |
|  |  | operations.notifyConnectionManager(about: .quiescing) |
|  |  | switch state.role { |
|  |  | case .client: |
|  |  | // The server sent us a GOAWAY we'll just stop opening new streams and will send a GOAWAY |
|  |  | // frame before we close later. |
|  |  | () |
|  |  | case .server: |
|  |  | // Client sent us a GOAWAY frame; we'll let the streams drain and then close. We'll tell |
|  |  | // the client that we're going away and send them a ping. When we receive the pong we will |
|  |  | // send another GOAWAY frame with a lower stream ID. In this case, the pong acts as an ack |
|  |  | // for the GOAWAY. |
|  |  | operations.sendGoAwayFrame(lastPeerInitiatedStreamID: .maxID, followWithPing: true) |
|  |  | } |
|  |  | self.state = .quiescing(.init(fromOperating: state, initiatedByUs: false)) |
|  |  | } else { |
|  |  | // No open streams, we can close as well. |
| Expand Down  Expand Up | | @@ -494,6 +509,23 @@ struct GRPCIdleHandlerStateMachine { |
|  |  | return operations |
|  |  | } |
|  |  |  |
|  |  | mutating func ratchetDownGoAwayStreamID() -> Operations { |
|  |  | var operations: Operations = .none |
|  |  |  |
|  |  | switch self.state { |
|  |  | case let .quiescing(state): |
|  |  | let streamID = state.lastPeerInitiatedStreamID |
|  |  | operations.sendGoAwayFrame(lastPeerInitiatedStreamID: streamID) |
|  |  | case .operating, .waitingToIdle: |
|  |  | // We can only ratchet down the stream ID if we're already quiescing. |
|  |  | preconditionFailure() |
|  |  | case .closing, .closed: |
|  |  | () |
|  |  | } |
|  |  |  |
|  |  | return operations |
|  |  | } |
|  |  |  |
|  |  | mutating func receiveSettings(\_ settings: HTTP2Settings) -> Operations { |
|  |  | // Log the change in settings. |
|  |  | self.logger.debug( |
| Expand Down | |  |

30 changes: 21 additions & 9 deletions

30
[Sources/GRPC/GRPCKeepaliveHandlers.swift](#diff-f1a4a0b9dffa2a2cff6dec3981e53270489ae4f52080b2e24afeb2e82b3d75c4 "Sources/GRPC/GRPCKeepaliveHandlers.swift")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/Sources/GRPC/GRPCKeepaliveHandlers.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,8 +17,11 @@ import NIOCore |
|  |  | import NIOHTTP2 |
|  |  |  |
|  |  | struct PingHandler { |
|  |  | /// Code for ping |
|  |  | private let pingCode: UInt64 |
|  |  | /// Opaque ping data used for keep-alive pings. |
|  |  | private let pingData: HTTP2PingData |
|  |  |  |
|  |  | /// Opaque ping data used for a ping sent after a GOAWAY frame. |
|  |  | internal let pingDataGoAway: HTTP2PingData |
|  |  |  |
|  |  | /// The amount of time to wait before sending a keepalive ping. |
|  |  | private let interval: TimeAmount |
| Expand Down  Expand Up | | @@ -90,6 +93,7 @@ struct PingHandler { |
|  |  | case schedulePing(delay: TimeAmount, timeout: TimeAmount) |
|  |  | case cancelScheduledTimeout |
|  |  | case reply(HTTP2Frame.FramePayload) |
|  |  | case ratchetDownLastSeenStreamID |
|  |  | } |
|  |  |  |
|  |  | init( |
| Expand All | | @@ -102,7 +106,8 @@ struct PingHandler { |
|  |  | minimumReceivedPingIntervalWithoutData: TimeAmount? = nil, |
|  |  | maximumPingStrikes: UInt? = nil |
|  |  | ) { |
|  |  | self.pingCode = pingCode |
|  |  | self.pingData = HTTP2PingData(withInteger: pingCode) |
|  |  | self.pingDataGoAway = HTTP2PingData(withInteger: ~pingCode) |
|  |  | self.interval = interval |
|  |  | self.timeout = timeout |
|  |  | self.permitWithoutCalls = permitWithoutCalls |
| Expand Down  Expand Up | | @@ -137,8 +142,12 @@ struct PingHandler { |
|  |  | } |
|  |  |  |
|  |  | private func handlePong(\_ pingData: HTTP2PingData) -> Action { |
|  |  | if pingData.integer == self.pingCode { |
|  |  | if pingData == self.pingData { |
|  |  | return .cancelScheduledTimeout |
|  |  | } else if pingData == self.pingDataGoAway { |
|  |  | // We received a pong for a ping we sent to trail a GOAWAY frame: this means we can now |
|  |  | // send another GOAWAY frame with a (possibly) lower stream ID. |
|  |  | return .ratchetDownLastSeenStreamID |
|  |  | } else { |
|  |  | return .none |
|  |  | } |
| Expand All | | @@ -161,32 +170,35 @@ struct PingHandler { |
|  |  | // This is a valid ping, reset our strike count and reply with a pong. |
|  |  | self.pingStrikes = 0 |
|  |  | self.lastReceivedPingDate = self.now() |
|  |  | return .reply(self.generatePingFrame(code: pingData.integer, ack: true)) |
|  |  | return .reply(self.generatePingFrame(data: pingData, ack: true)) |
|  |  | } |
|  |  | } else { |
|  |  | // We don't support ping strikes. We'll just reply with a pong. |
|  |  | // |
|  |  | // Note: we don't need to update `pingStrikes` or `lastReceivedPingDate` as we don't |
|  |  | // support ping strikes. |
|  |  | return .reply(self.generatePingFrame(code: pingData.integer, ack: true)) |
|  |  | return .reply(self.generatePingFrame(data: pingData, ack: true)) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | mutating func pingFired() -> Action { |
|  |  | if self.shouldBlockPing { |
|  |  | return .none |
|  |  | } else { |
|  |  | return .reply(self.generatePingFrame(code: self.pingCode, ack: false)) |
|  |  | return .reply(self.generatePingFrame(data: self.pingData, ack: false)) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private mutating func generatePingFrame(code: UInt64, ack: Bool) -> HTTP2Frame.FramePayload { |
|  |  | private mutating func generatePingFrame( |
|  |  | data: HTTP2PingData, |
|  |  | ack: Bool |
|  |  | ) -> HTTP2Frame.FramePayload { |
|  |  | if self.activeStreams == 0 { |
|  |  | self.sentPingsWithoutData += 1 |
|  |  | } |
|  |  |  |
|  |  | self.lastSentPingDate = self.now() |
|  |  | return HTTP2Frame.FramePayload.ping(HTTP2PingData(withInteger: code), ack: ack) |
|  |  | return HTTP2Frame.FramePayload.ping(data, ack: ack) |
|  |  | } |
|  |  |  |
|  |  | /// Returns true if, on receipt of a ping, the ping should be regarded as a ping strike. |
| Expand Down | |  |

50 changes: 50 additions & 0 deletions

50
[Tests/GRPCTests/GRPCIdleHandlerStateMachineTests.swift](#diff-323210c80c340064623619deced4017d1176687bb47bfc233c689557ecc25c8d "Tests/GRPCTests/GRPCIdleHandlerStateMachineTests.swift")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/Tests/GRPCTests/GRPCIdleHandlerStateMachineTests.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,6 +24,10 @@ class GRPCIdleHandlerStateMachineTests: GRPCTestCase { |
|  |  | return GRPCIdleHandlerStateMachine(role: .client, logger: self.clientLogger) |
|  |  | } |
|  |  |  |
|  |  | private func makeServerStateMachine() -> GRPCIdleHandlerStateMachine { |
|  |  | return GRPCIdleHandlerStateMachine(role: .server, logger: self.serverLogger) |
|  |  | } |
|  |  |  |
|  |  | private func makeNoOpScheduled() -> Scheduled<Void> { |
|  |  | let loop = EmbeddedEventLoop() |
|  |  | return loop.scheduleTask(deadline: .distantFuture) { return () } |
| Expand Down  Expand Up | | @@ -469,6 +473,43 @@ class GRPCIdleHandlerStateMachineTests: GRPCTestCase { |
|  |  | // The peer initiated shutdown by sending GOAWAY, we'll idle. |
|  |  | op6.assertConnectionManager(.idle) |
|  |  | } |
|  |  |  |
|  |  | func testClientSendsGoAwayAndOpensStream() { |
|  |  | var stateMachine = self.makeServerStateMachine() |
|  |  |  |
|  |  | let op1 = stateMachine.receiveSettings([]) |
|  |  | op1.assertConnectionManager(.ready) |
|  |  | op1.assertScheduleIdleTimeout() |
|  |  |  |
|  |  | // Schedule the idle timeout. |
|  |  | let op2 = stateMachine.scheduledIdleTimeoutTask(self.makeNoOpScheduled()) |
|  |  | op2.assertDoNothing() |
|  |  |  |
|  |  | // Create a stream to cancel the task. |
|  |  | let op3 = stateMachine.streamCreated(withID: 1) |
|  |  | op3.assertCancelIdleTimeout() |
|  |  |  |
|  |  | // Receive a GOAWAY frame from the client. |
|  |  | let op4 = stateMachine.receiveGoAway() |
|  |  | op4.assertGoAway(streamID: .maxID) |
|  |  | op4.assertShouldPingAfterGoAway() |
|  |  |  |
|  |  | // Create another stream. This is fine, the client hasn't ack'd the ping yet. |
|  |  | let op5 = stateMachine.streamCreated(withID: 7) |
|  |  | op5.assertDoNothing() |
|  |  |  |
|  |  | // Receiving the ping is handled by a different state machine which will tell us to ratchet |
|  |  | // down the go away stream ID. |
|  |  | let op6 = stateMachine.ratchetDownGoAwayStreamID() |
|  |  | op6.assertGoAway(streamID: 7) |
|  |  | op6.assertShouldNotPingAfterGoAway() |
|  |  |  |
|  |  | let op7 = stateMachine.streamClosed(withID: 7) |
|  |  | op7.assertDoNothing() |
|  |  |  |
|  |  | let op8 = stateMachine.streamClosed(withID: 1) |
|  |  | op8.assertShouldClose() |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | extension GRPCIdleHandlerStateMachine.Operations { |
| Expand All | | @@ -477,6 +518,7 @@ extension GRPCIdleHandlerStateMachine.Operations { |
|  |  | XCTAssertNil(self.idleTask) |
|  |  | XCTAssertNil(self.sendGoAwayWithLastPeerInitiatedStreamID) |
|  |  | XCTAssertFalse(self.shouldCloseChannel) |
|  |  | XCTAssertFalse(self.shouldPingAfterGoAway) |
|  |  | } |
|  |  |  |
|  |  | func assertGoAway(streamID: HTTP2StreamID) { |
| Expand Down  Expand Up | | @@ -524,4 +566,12 @@ extension GRPCIdleHandlerStateMachine.Operations { |
|  |  | func assertShouldNotClose() { |
|  |  | XCTAssertFalse(self.shouldCloseChannel) |
|  |  | } |
|  |  |  |
|  |  | func assertShouldPingAfterGoAway() { |
|  |  | XCTAssert(self.shouldPingAfterGoAway) |
|  |  | } |
|  |  |  |
|  |  | func assertShouldNotPingAfterGoAway() { |
|  |  | XCTAssertFalse(self.shouldPingAfterGoAway) |
|  |  | } |
|  |  | } |

8 changes: 8 additions & 0 deletions

8
[Tests/GRPCTests/GRPCPingHandlerTests.swift](#diff-be1e60ffdb9b3d2a7668e70122e87f61c07ec9901621e8281944fd02136ac3bd "Tests/GRPCTests/GRPCPingHandlerTests.swift")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/Tests/GRPCTests/GRPCPingHandlerTests.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -347,6 +347,12 @@ class GRPCPingHandlerTests: GRPCTestCase { |
|  |  | ) |
|  |  | } |
|  |  |  |
|  |  | func testPongWithGoAwayPingData() { |
|  |  | self.setupPingHandler() |
|  |  | let response = self.pingHandler.read(pingData: self.pingHandler.pingDataGoAway, ack: true) |
|  |  | XCTAssertEqual(response, .ratchetDownLastSeenStreamID) |
|  |  | } |
|  |  |  |
|  |  | private func setupPingHandler( |
|  |  | pingCode: UInt64 = 1, |
|  |  | interval: TimeAmount = .seconds(15), |
| Expand Down  Expand Up | | @@ -379,6 +385,8 @@ extension PingHandler.Action: Equatable { |
|  |  | return lhsDelay == rhsDelay && lhsTimeout == rhsTimeout |
|  |  | case (.cancelScheduledTimeout, .cancelScheduledTimeout): |
|  |  | return true |
|  |  | case (.ratchetDownLastSeenStreamID, .ratchetDownLastSeenStreamID): |
|  |  | return true |
|  |  | case let (.reply(lhsPayload), .reply(rhsPayload)): |
|  |  | switch (lhsPayload, rhsPayload) { |
|  |  | case (let .ping(lhsData, ack: lhsAck), let .ping(rhsData, ack: rhsAck)): |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Tests/GRPCTests/ServerFuzzingRegressionTests.swift](#diff-99213e827283fa98802c7f4ebb9337379a8a1a934f9c8a5910b3ea82b41cdcf8 "Tests/GRPCTests/ServerFuzzingRegressionTests.swift")

Show comments

[View file](/grpc/grpc-swift/blob/858f977f2a51fca2292f384cf7a108dc2e73a3bd/Tests/GRPCTests/ServerFuzzingRegressionTests.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -83,4 +83,9 @@ final class ServerFuzzingRegressionTests: GRPCTestCase { |
|  |  | let name = "clusterfuzz-testcase-minimized-ServerFuzzer-release-5285159577452544" |
|  |  | XCTAssertNoThrow(try self.runTest(withInputNamed: name)) |
|  |  | } |
|  |  |  |
|  |  | func testFuzzCase\_release\_4739158818553856() { |
|  |  | let name = "clusterfuzz-testcase-minimized-ServerFuzzer-release-4739158818553856" |
|  |  | XCTAssertNoThrow(try self.runTest(withInputNamed: name)) |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `858f977`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-swift%2Fcommit%2F858f977f2a51fca2292f384cf7a108dc2e73a3bd) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8535e145_20250114_190016.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-swift%2Fsecurity%2Fadvisories%2FGHSA-r6ww-5963-7r95)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-swift%2Fsecurity%2Fadvisories%2FGHSA-r6ww-5963-7r95)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=grpc%2Fgrpc-swift)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[grpc](/grpc)
/
**[grpc-swift](/grpc/grpc-swift)**
Public

* [Notifications](/login?return_to=%2Fgrpc%2Fgrpc-swift) You must be signed in to change notification settings
* [Fork
  419](/login?return_to=%2Fgrpc%2Fgrpc-swift)
* [Star
   2.1k](/login?return_to=%2Fgrpc%2Fgrpc-swift)

* [Code](/grpc/grpc-swift)
* [Issues
  101](/grpc/grpc-swift/issues)
* [Pull requests
  3](/grpc/grpc-swift/pulls)
* [Actions](/grpc/grpc-swift/actions)
* [Projects
  0](/grpc/grpc-swift/projects)
* [Wiki](/grpc/grpc-swift/wiki)
* [Security](/grpc/grpc-swift/security)
* [Insights](/grpc/grpc-swift/pulse)

Additional navigation options

* [Code](/grpc/grpc-swift)
* [Issues](/grpc/grpc-swift/issues)
* [Pull requests](/grpc/grpc-swift/pulls)
* [Actions](/grpc/grpc-swift/actions)
* [Projects](/grpc/grpc-swift/projects)
* [Wiki](/grpc/grpc-swift/wiki)
* [Security](/grpc/grpc-swift/security)
* [Insights](/grpc/grpc-swift/pulse)

# Denial of Service via reachable assertion

High

[glbrntt](/glbrntt)
published
GHSA-r6ww-5963-7r95
Mar 23, 2022

## Package

swift

grpc-swift
([Swift](/advisories?query=ecosystem%3Aswift))

## Affected versions

< 1.7.1

## Patched versions

1.7.2

## Description

A grpc-swift server is vulnerable to a denial of service attack via a reachable assertion. This was due to incorrect logic when handling GOAWAY frames.

The attack is low-effort: it takes very little resources to construct and send the required sequence of frames. The impact on availability is high as the server will crash, dropping all in flight connections and requests.

The issue was discovered by automated fuzz testing and is resolved by fixing the relevant state handling code.

### Severity

High

7.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

### CVE ID

CVE-2022-24777

### Weaknesses

[CWE-617](/advisories?query=cwe%3A617)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


