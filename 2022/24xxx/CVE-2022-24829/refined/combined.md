=== Content from github.com_83feb652_20250115_094515.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgarden-io%2Fgarden%2Fcommit%2F56051a5b50409227bc420910da88ed156a6e432b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgarden-io%2Fgarden%2Fcommit%2F56051a5b50409227bc420910da88ed156a6e432b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=garden-io%2Fgarden)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[garden-io](/garden-io)
/
**[garden](/garden-io/garden)**
Public

* [Notifications](/login?return_to=%2Fgarden-io%2Fgarden) You must be signed in to change notification settings
* [Fork
  273](/login?return_to=%2Fgarden-io%2Fgarden)
* [Star
   3.4k](/login?return_to=%2Fgarden-io%2Fgarden)

* [Code](/garden-io/garden)
* [Issues
  197](/garden-io/garden/issues)
* [Pull requests
  23](/garden-io/garden/pulls)
* [Actions](/garden-io/garden/actions)
* [Projects
  0](/garden-io/garden/projects)
* [Security](/garden-io/garden/security)
* [Insights](/garden-io/garden/pulse)

Additional navigation options

* [Code](/garden-io/garden)
* [Issues](/garden-io/garden/issues)
* [Pull requests](/garden-io/garden/pulls)
* [Actions](/garden-io/garden/actions)
* [Projects](/garden-io/garden/projects)
* [Security](/garden-io/garden/security)
* [Insights](/garden-io/garden/pulse)

## Commit

[Permalink](/garden-io/garden/commit/56051a5b50409227bc420910da88ed156a6e432b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(core): require auth key for server endpoints

[Browse files](/garden-io/garden/tree/56051a5b50409227bc420910da88ed156a6e432b)
Browse the repository at this point in the history

* Loading branch information

[![@eysi09](https://avatars.githubusercontent.com/u/5373776?s=40&v=4)](/eysi09)

[eysi09](/garden-io/garden/commits?author=eysi09 "View all commits by eysi09")
committed
Apr 7, 2022

1 parent
[dac340b](/garden-io/garden/commit/dac340b80bd14ea0e957fefd319695e374433e50)

commit 56051a5

 Show file tree

 Hide file tree

Showing
**13 changed files**
with
**179 additions**
and
**43 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* core

  + src

    - cli

      * core/src/cli/cli.ts
        [cli.ts](#diff-287f583ab31930365037718c4f34dc92d5cdbc44e4cb732a1f57dc9bd40e3647)
    - core/src/constants.ts
      [constants.ts](#diff-906af70fd357470d8d66f867bab319fc73de2fccb56e2b8f4b5fb6c67582c338)
    - core/src/events.ts
      [events.ts](#diff-b763f8236fd26b5f22c1ae3db16fe7f0c716547b7b8df3e083a2ca11ee2f40dc)
    - server

      * core/src/server/dashboard-event-stream.ts
        [dashboard-event-stream.ts](#diff-0c9d0fd31f38ed1ba216a5c9c0b7ae817d55266fe81ff6e31a6bdce94c0c326c)
      * core/src/server/server.ts
        [server.ts](#diff-0cf71ee7e23188ad0359a403e27cf47b7dc9f310fa7221c48ba3d94d6049766b)
  + test/unit/src

    - cli

      * core/test/unit/src/cli/cli.ts
        [cli.ts](#diff-45107c6c879c19737894430ed61d600047b95219b93418ce0c6616c1cbf525e3)
    - server

      * core/test/unit/src/server/dashboard-event-stream.ts
        [dashboard-event-stream.ts](#diff-081cb24aa08d7b3d3a13309366878496a8c0f00f0adffddb286ff07671948a5e)
      * core/test/unit/src/server/server.ts
        [server.ts](#diff-51ebcd832892b5b9dc8cb79afa462079eedf716af460e76399747e40a344a023)
* dashboard/src

  + api

    - dashboard/src/api/actions.ts
      [actions.ts](#diff-a843fd61acc78f77503a192ffa1fdd851526b2f5318fde5c5256f19d4e837c15)
    - dashboard/src/api/api.ts
      [api.ts](#diff-f8bd447aae4909f6f2048854034e2b29a30215fb2a994bc229d556de51ff451d)
  + components

    - dashboard/src/components/menu.tsx
      [menu.tsx](#diff-82aa9b9378eb6731f847eef47b68da6da7922a7d02c849b6b34ef0646b50d087)
  + dashboard/src/hooks.ts
    [hooks.ts](#diff-794a93777eb9306730ba7b134545f4b2c312e32726009cb22644032c826b6dd9)
  + util

    - dashboard/src/util/helpers.ts
      [helpers.ts](#diff-53fb12fdb1aa82973248ed5325c3f53b1796a9c887fe30aab71c4d2ebfb56ec1)

## There are no files selected for viewing

6 changes: 5 additions & 1 deletion

6
[core/src/cli/cli.ts](#diff-287f583ab31930365037718c4f34dc92d5cdbc44e4cb732a1f57dc9bd40e3647 "core/src/cli/cli.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/src/cli/cli.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -435,7 +435,11 @@ ${renderCommands(commands)} |
|  |  | namespace: garden.namespace, |
|  |  | }) |
|  |  |  |
|  |  | command.server.showUrl(dashboardProcess?.serverHost || undefined) |
|  |  | let url: string | undefined |
|  |  | if (dashboardProcess) { |
|  |  | url = `${dashboardProcess.serverHost}?key=${dashboardProcess.serverAuthKey}` |
|  |  | } |
|  |  | command.server.showUrl(url) |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[core/src/constants.ts](#diff-906af70fd357470d8d66f867bab319fc73de2fccb56e2b8f4b5fb6c67582c338 "core/src/constants.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/src/constants.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -71,6 +71,7 @@ export const gardenEnv = { |
|  |  | GARDEN\_LOGGER\_TYPE: env.get("GARDEN\_LOGGER\_TYPE").required(false).asString(), |
|  |  | GARDEN\_PROXY\_DEFAULT\_ADDRESS: env.get("GARDEN\_PROXY\_DEFAULT\_ADDRESS").required(false).asString(), |
|  |  | GARDEN\_SERVER\_PORT: env.get("GARDEN\_SERVER\_PORT").required(false).asPortNumber(), |
|  |  | GARDEN\_SERVER\_HOSTNAME: env.get("GARDEN\_SERVER\_HOSTNAME").required(false).asUrlString(), |
|  |  | GARDEN\_SKIP\_TESTS: env.get("GARDEN\_SKIP\_TESTS").required(false).default("").asString(), |
|  |  | GARDEN\_HARD\_CONCURRENCY\_LIMIT: env.get("GARDEN\_HARD\_CONCURRENCY\_LIMIT").required(false).default(50).asInt(), |
|  |  | GARDEN\_TASK\_CONCURRENCY\_LIMIT: env.get("GARDEN\_TASK\_CONCURRENCY\_LIMIT").required(false).default(6).asInt(), |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[core/src/events.ts](#diff-b763f8236fd26b5f22c1ae3db16fe7f0c716547b7b8df3e083a2ca11ee2f40dc "core/src/events.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/src/events.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -98,7 +98,7 @@ export interface Events extends LoggerEvents { |
|  |  |  |
|  |  | // Process events |
|  |  | serversUpdated: { |
|  |  | servers: { host: string; command: string }[] |
|  |  | servers: { host: string; command: string; serverAuthKey: string }[] |
|  |  | } |
|  |  | receivedToken: AuthTokenResponse |
|  |  |  |
| Expand Down | |  |

6 changes: 5 additions & 1 deletion

6
[core/src/server/dashboard-event-stream.ts](#diff-0c9d0fd31f38ed1ba216a5c9c0b7ae817d55266fe81ff6e31a6bdce94c0c326c "core/src/server/dashboard-event-stream.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/src/server/dashboard-event-stream.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -62,7 +62,11 @@ export class DashboardEventStream extends BufferedEventStream { |
|  |  | this.log.debug(`Updated list of running dashboard servers: ${servers.map((p) => p.serverHost).join(", ")}`) |
|  |  |  |
|  |  | this.garden.events.emit("serversUpdated", { |
|  |  | servers: servers.map((p) => ({ command: p.command!, host: p.serverHost! })), |
|  |  | servers: servers.map((p) => ({ |
|  |  | command: p.command!, |
|  |  | host: p.serverHost!, |
|  |  | serverAuthKey: p.serverAuthKey || "", |
|  |  | })), |
|  |  | }) |
|  |  | } |
|  |  |  |
| Expand Down | |  |

49 changes: 31 additions & 18 deletions

49
[core/src/server/server.ts](#diff-0cf71ee7e23188ad0359a403e27cf47b7dc9f310fa7221c48ba3d94d6049766b "core/src/server/server.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/src/server/server.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -79,15 +79,15 @@ export class GardenServer { |
|  |  | this.debugLog = this.log.placeholder({ level: LogLevel.debug, childEntriesInheritLevel: true }) |
|  |  | this.garden = undefined |
|  |  | this.port = port |
|  |  | this.authKey = randomString(64) |
|  |  | this.authKey = randomString(24) |
|  |  | this.incomingEvents = new EventBus() |
|  |  | this.activePersistentRequests = {} |
|  |  |  |
|  |  | this.serversUpdatedListener = ({ servers }) => { |
|  |  | // Update status log line with new `garden dashboard` server, if any |
|  |  | for (const { host, command } of servers) { |
|  |  | for (const { host, command, serverAuthKey } of servers) { |
|  |  | if (command === "dashboard") { |
|  |  | this.showUrl(host) |
|  |  | this.showUrl(`${host}?key=${serverAuthKey}`) |
|  |  | return |
|  |  | } |
|  |  | } |
| Expand All | | @@ -104,13 +104,15 @@ export class GardenServer { |
|  |  |  |
|  |  | this.app = await this.createApp() |
|  |  |  |
|  |  | const hostname = gardenEnv.GARDEN\_SERVER\_HOSTNAME || "localhost" |
|  |  |  |
|  |  | if (this.port) { |
|  |  | this.server = this.app.listen(this.port) |
|  |  | this.server = this.app.listen(this.port, hostname) |
|  |  | } else { |
|  |  | do { |
|  |  | try { |
|  |  | this.port = await getPort({ port: defaultWatchServerPort }) |
|  |  | this.server = this.app.listen(this.port) |
|  |  | this.server = this.app.listen(this.port, hostname) |
|  |  | } catch {} |
|  |  | } while (!this.server) |
|  |  | } |
| Expand All | | @@ -119,10 +121,14 @@ export class GardenServer { |
|  |  | this.statusLog = this.log.placeholder() |
|  |  | } |
|  |  |  |
|  |  | getUrl() { |
|  |  | getBaseUrl() { |
|  |  | return `http://localhost:${this.port}` |
|  |  | } |
|  |  |  |
|  |  | getUrl() { |
|  |  | return `${this.getBaseUrl()}?key=${this.authKey}` |
|  |  | } |
|  |  |  |
|  |  | showUrl(url?: string) { |
|  |  | this.statusLog.setState({ |
|  |  | emoji: "sunflower", |
| Expand Down  Expand Up | | @@ -156,6 +162,16 @@ export class GardenServer { |
|  |  | const app = websockify(new Koa()) |
|  |  | const http = new Router() |
|  |  |  |
|  |  | http.use((ctx, next) => { |
|  |  | const authToken = ctx.header[authTokenHeader] || ctx.query.key |
|  |  |  |
|  |  | if (authToken !== this.authKey) { |
|  |  | ctx.throw(401, `Unauthorized request`) |
|  |  | return |
|  |  | } |
|  |  | return next() |
|  |  | }) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* HTTP API endpoint (POST /api) |
|  |  | \* |
| Expand All | | @@ -164,7 +180,6 @@ export class GardenServer { |
|  |  | \* means we can keep a consistent format across mechanisms. |
|  |  | \*/ |
|  |  | http.post("/api", async (ctx) => { |
|  |  | // TODO: require auth key here from 0.13.0 onwards |
|  |  | if (!this.garden) { |
|  |  | return this.notReady(ctx) |
|  |  | } |
| Expand Down  Expand Up | | @@ -239,15 +254,7 @@ export class GardenServer { |
|  |  | \* The API matches that of the Garden Cloud /events endpoint. |
|  |  | \*/ |
|  |  | http.post("/events", async (ctx) => { |
|  |  | const authHeader = ctx.header[authTokenHeader] |
|  |  |  |
|  |  | if (authHeader !== this.authKey) { |
|  |  | ctx.status = 401 |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // TODO: validate the input |
|  |  |  |
|  |  | const batch = ctx.request.body as ApiEventBatch |
|  |  | this.debugLog.debug(`Received ${batch.events.length} events from session ${batch.sessionId}`) |
|  |  |  |
| Expand All | | @@ -258,6 +265,7 @@ export class GardenServer { |
|  |  | }) |
|  |  |  |
|  |  | app.use(bodyParser()) |
|  |  |  |
|  |  | app.use(http.routes()) |
|  |  | app.use(http.allowedMethods()) |
|  |  |  |
| Expand All | | @@ -277,7 +285,7 @@ export class GardenServer { |
|  |  | return app |
|  |  | } |
|  |  |  |
|  |  | private notReady(ctx: Router.IRouterContext) { |
|  |  | private notReady(ctx: Router.IRouterContext | Koa.ParameterizedContext) { |
|  |  | ctx.status = 503 |
|  |  | ctx.response.body = notReadyMessage |
|  |  | } |
| Expand All | | @@ -297,8 +305,6 @@ export class GardenServer { |
|  |  |  |
|  |  | const connId = uuidv4() |
|  |  |  |
|  |  | // TODO: require auth key on connections here, from 0.13.0 onwards |
|  |  |  |
|  |  | // The typing for koa-websocket isn't working currently |
|  |  | const websocket: Koa.Context["ws"] = ctx["websocket"] |
|  |  |  |
| Expand All | | @@ -318,6 +324,13 @@ export class GardenServer { |
|  |  | return send("error", { message, requestId }) |
|  |  | } |
|  |  |  |
|  |  | // TODO: Only allow auth key authentication |
|  |  | if (ctx.query.sessionId !== `${this.garden.sessionId}` && ctx.query.key !== `${this.authKey}`) { |
|  |  | error(`401 Unauthorized`) |
|  |  | websocket.terminate() |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Set up heartbeat to detect dead connections |
|  |  | let isAlive = true |
|  |  |  |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[core/test/unit/src/cli/cli.ts](#diff-45107c6c879c19737894430ed61d600047b95219b93418ce0c6616c1cbf525e3 "core/test/unit/src/cli/cli.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/test/unit/src/cli/cli.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -420,7 +420,7 @@ describe("cli", () => { |
|  |  | command: "dashboard", |
|  |  | sessionId: serverGarden.sessionId, |
|  |  | persistent: true, |
|  |  | serverHost: server.getUrl(), |
|  |  | serverHost: server.getBaseUrl(), |
|  |  | serverAuthKey: server.authKey, |
|  |  | projectRoot: serverGarden.projectRoot, |
|  |  | projectName: serverGarden.projectName, |
| Expand Down  Expand Up | | @@ -527,7 +527,7 @@ describe("cli", () => { |
|  |  | command: "dashboard", |
|  |  | sessionId: serverGarden.sessionId, |
|  |  | persistent: true, |
|  |  | serverHost: server.getUrl(), |
|  |  | serverHost: server.getBaseUrl(), |
|  |  | serverAuthKey: server.authKey, |
|  |  | projectRoot: serverGarden.projectRoot, |
|  |  | projectName: serverGarden.projectName, |
| Expand Down | |  |

8 changes: 5 additions & 3 deletions

8
[core/test/unit/src/server/dashboard-event-stream.ts](#diff-081cb24aa08d7b3d3a13309366878496a8c0f00f0adffddb286ff07671948a5e "core/test/unit/src/server/dashboard-event-stream.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/test/unit/src/server/dashboard-event-stream.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -70,8 +70,8 @@ describe("DashboardEventStream", () => { |
|  |  | streamEvents: true, |
|  |  | streamLogEntries: true, |
|  |  | targets: [ |
|  |  | { host: serverA.getUrl(), clientAuthToken: serverA.authKey, enterprise: false }, |
|  |  | { host: serverB.getUrl(), clientAuthToken: serverB.authKey, enterprise: false }, |
|  |  | { host: serverA.getBaseUrl(), clientAuthToken: serverA.authKey, enterprise: false }, |
|  |  | { host: serverB.getBaseUrl(), clientAuthToken: serverB.authKey, enterprise: false }, |
|  |  | ], |
|  |  | }) |
|  |  |  |
| Expand Down  Expand Up | | @@ -193,7 +193,9 @@ describe("DashboardEventStream", () => { |
|  |  | await record.setCommand(values) |
|  |  | await streamer.updateTargets() |
|  |  |  |
|  |  | garden.events.expectEvent("serversUpdated", { servers: [{ host: values.serverHost, command: "dashboard" }] }) |
|  |  | garden.events.expectEvent("serversUpdated", { |
|  |  | servers: [{ host: values.serverHost, command: "dashboard", serverAuthKey: "foo" }], |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | it("ignores servers matching ignoreHost", async () => { |
| Expand Down | |  |

99 changes: 89 additions & 10 deletions

99
[core/test/unit/src/server/server.ts](#diff-51ebcd832892b5b9dc8cb79afa462079eedf716af460e76399747e40a344a023 "core/test/unit/src/server/server.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/core/test/unit/src/server/server.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -58,47 +58,83 @@ describe("GardenServer", () => { |
|  |  | it("should update dashboard URL with new one if another is started", async () => { |
|  |  | gardenServer.showUrl("http://foo") |
|  |  | garden.events.emit("serversUpdated", { |
|  |  | servers: [{ host: "http://localhost:9800", command: "dashboard" }], |
|  |  | servers: [{ host: "http://localhost:9800", command: "dashboard", serverAuthKey: "foo" }], |
|  |  | }) |
|  |  | const line = gardenServer["statusLog"] |
|  |  | await sleep(1) // This is enough to let go of the control loop |
|  |  | const status = stripAnsi(line.getLatestMessage().msg || "") |
|  |  | expect(status).to.equal(`Garden dashboard running at http://localhost:9800`) |
|  |  | expect(status).to.equal(`Garden dashboard running at http://localhost:9800?key=foo`) |
|  |  | }) |
|  |  |  |
|  |  | describe("GET /", () => { |
|  |  | it("should return the dashboard index page", async () => { |
|  |  | await request(server).get("/").expect(200) |
|  |  | await request(server) |
|  |  | .get("/") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .expect(200) |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | describe("POST /api", () => { |
|  |  | it("returns 401 if missing auth header", async () => { |
|  |  | await request(server).post("/api").send({}).expect(401) |
|  |  | }) |
|  |  |  |
|  |  | it("returns 401 if auth header doesn't match auth key", async () => { |
|  |  | await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: "foo" }) |
|  |  | .send({}) |
|  |  | .expect(401) |
|  |  | }) |
|  |  |  |
|  |  | it("should 400 on non-JSON body", async () => { |
|  |  | await request(server).post("/api").send("foo").expect(400) |
|  |  | await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .send("foo") |
|  |  | .expect(400) |
|  |  | }) |
|  |  |  |
|  |  | it("should 400 on invalid payload", async () => { |
|  |  | await request(server).post("/api").send({ foo: "bar" }).expect(400) |
|  |  | await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .send({ foo: "bar" }) |
|  |  | .expect(400) |
|  |  | }) |
|  |  |  |
|  |  | it("should 404 on invalid command", async () => { |
|  |  | await request(server).post("/api").send({ command: "foo" }).expect(404) |
|  |  | await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .send({ command: "foo" }) |
|  |  | .expect(404) |
|  |  | }) |
|  |  |  |
|  |  | it("should 503 when Garden instance is not set", async () => { |
|  |  | gardenServer["garden"] = undefined |
|  |  | await request(server).post("/api").send({ command: "get.config" }).expect(503) |
|  |  | await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .send({ command: "get.config" }) |
|  |  | .expect(503) |
|  |  | }) |
|  |  |  |
|  |  | it("should execute a command and return its results", async () => { |
|  |  | const res = await request(server).post("/api").send({ command: "get.config" }).expect(200) |
|  |  | const res = await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .send({ command: "get.config" }) |
|  |  | .expect(200) |
|  |  | const config = await garden.dumpConfig({ log: garden.log }) |
|  |  | expect(res.body.result).to.eql(deepOmitUndefined(config)) |
|  |  | }) |
|  |  |  |
|  |  | it("should correctly map arguments and options to commands", async () => { |
|  |  | const res = await request(server) |
|  |  | .post("/api") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .send({ |
|  |  | command: "build", |
|  |  | parameters: { |
| Expand All | | @@ -119,8 +155,23 @@ describe("GardenServer", () => { |
|  |  | }) |
|  |  |  |
|  |  | describe("/dashboardPages", () => { |
|  |  | it("returns 401 if missing auth header", async () => { |
|  |  | await request(server).get("/dashboardPages/test-plugin/test").expect(401) |
|  |  | }) |
|  |  |  |
|  |  | it("returns 401 if auth header doesn't match auth key", async () => { |
|  |  | await request(server) |
|  |  | .get("/dashboardPages/test-plugin/test") |
|  |  | .set({ [authTokenHeader]: "foo" }) |
|  |  | .send({}) |
|  |  | .expect(401) |
|  |  | }) |
|  |  |  |
|  |  | it("should resolve the URL for the given dashboard page and redirect", async () => { |
|  |  | const res = await request(server).get("/dashboardPages/test-plugin/test").expect(302) |
|  |  | const res = await request(server) |
|  |  | .get("/dashboardPages/test-plugin/test") |
|  |  | .set({ [authTokenHeader]: gardenServer.authKey }) |
|  |  | .expect(302) |
|  |  |  |
|  |  | expect(res.header.location).to.equal("http://localhost:12345/test") |
|  |  | }) |
| Expand Down  Expand Up | | @@ -162,7 +213,7 @@ describe("GardenServer", () => { |
|  |  | let ws: WebSocket |
|  |  |  |
|  |  | beforeEach((done) => { |
|  |  | ws = new WebSocket(`ws://localhost:${port}/ws`) |
|  |  | ws = new WebSocket(`ws://localhost:${port}/ws?sessionId=${garden.sessionId}`) |
|  |  | ws.on("open", () => { |
|  |  | done() |
|  |  | }) |
| Expand All | | @@ -177,6 +228,34 @@ describe("GardenServer", () => { |
|  |  | ws.on("message", (msg) => cb(JSON.parse(msg.toString()))) |
|  |  | } |
|  |  |  |
|  |  | it("terminates the connection if auth query params are missing", (done) => { |
|  |  | const badWs = new WebSocket(`ws://localhost:${port}/ws`) |
|  |  | badWs.on("close", () => { |
|  |  | done() |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | it("terminates the connection if key doesn't match and sessionId is missing", (done) => { |
|  |  | const badWs = new WebSocket(`ws://localhost:${port}/ws?key=foo`) |
|  |  | badWs.on("close", () => { |
|  |  | done() |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | it("terminates the connection if sessionId doesn't match and key is missing", (done) => { |
|  |  | const badWs = new WebSocket(`ws://localhost:${port}/ws?sessionId=foo`) |
|  |  | badWs.on("close", () => { |
|  |  | done() |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | it("terminates the connection if both sessionId and key are bad", (done) => { |
|  |  | const badWs = new WebSocket(`ws://localhost:${port}/ws?sessionId=foo&key=bar`) |
|  |  | badWs.on("close", () => { |
|  |  | done() |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | it("should emit events from the Garden event bus", (done) => { |
|  |  | onMessage((req) => { |
|  |  | expect(req).to.eql({ type: "event", name: "\_test", payload: "foo" }) |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[dashboard/src/api/actions.ts](#diff-a843fd61acc78f77503a192ffa1fdd851526b2f5318fde5c5256f19d4e837c15 "dashboard/src/api/actions.ts")

Show comments

[View file](/garden-io/garden/blob/56051a5b50409227bc420910da88ed156a6e432b/dashboard/src/api/actions.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -36,7 +36,7 @@ import { |
|  |  | FetchTaskResultParams, |
|  |  | FetchTestResultParams, |
|  |  | } from "./api" |
|  |  | import { getTestKey } from "../util/helpers" |
|  |  | import { getAuthKey, getTestKey } from "../util/helpers" |
|  |  | import { ProviderMap } from "@garden-io/core/build/src/config/provider" |
|  |  | import { DashboardPage } from "@garden-io/core/build/src/types/plugin/provider/getDashboardPage" |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,7 +113,7 @@ function processConfigInitResult(entities: Entities, config: ConfigDump) { |
|  |  | path: `/provider/${provider.name}/${page.name}`, |
|  |  | description: page.description + ` (from provider ${provider.name})`, |
|  |  | // Use static URL if provided, otherwise we'll request a redirect from this API endpoint |
|  |  | url: page.url || `/dashboardPages/${provider.name}/${page.name}`, |
|  |  | url: page.url || `/dashboardPages/${provider.name}/${page.name}?key=${getAuthKey()}`, |
|  |  | })) |
|  |  | }) |
|  |  |  |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `56051a5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgarden-io%2Fgarden%2Fcommit%2F56051a5b50409227bc420910da88ed156a6e432b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_e8a6bbe8_20250115_094516.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgarden-io%2Fgarden%2Fsecurity%2Fadvisories%2FGHSA-f5f3-qrqw-2vqf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgarden-io%2Fgarden%2Fsecurity%2Fadvisories%2FGHSA-f5f3-qrqw-2vqf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=garden-io%2Fgarden)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[garden-io](/garden-io)
/
**[garden](/garden-io/garden)**
Public

* [Notifications](/login?return_to=%2Fgarden-io%2Fgarden) You must be signed in to change notification settings
* [Fork
  273](/login?return_to=%2Fgarden-io%2Fgarden)
* [Star
   3.4k](/login?return_to=%2Fgarden-io%2Fgarden)

* [Code](/garden-io/garden)
* [Issues
  197](/garden-io/garden/issues)
* [Pull requests
  23](/garden-io/garden/pulls)
* [Actions](/garden-io/garden/actions)
* [Projects
  0](/garden-io/garden/projects)
* [Security](/garden-io/garden/security)
* [Insights](/garden-io/garden/pulse)

Additional navigation options

* [Code](/garden-io/garden)
* [Issues](/garden-io/garden/issues)
* [Pull requests](/garden-io/garden/pulls)
* [Actions](/garden-io/garden/actions)
* [Projects](/garden-io/garden/projects)
* [Security](/garden-io/garden/security)
* [Insights](/garden-io/garden/pulse)

# Garden configuration exposed via any local network interface in Garden dev mode

High

[eysi09](/eysi09)
published
GHSA-f5f3-qrqw-2vqf
Apr 11, 2022

## Package

garden
(binary)

## Affected versions

< 0.12.39

## Patched versions

0.12.39

## Description

### Impact

There is an information leak when using Garden in [dev mode](https://docs.garden.io/guides/code-synchronization-dev-mode) or [watch mode](https://docs.garden.io/reference/commands#options), including the deprecated [hot-reload mode](https://docs.garden.io/guides/hot-reload).

When in the above mentioned modes, Garden leaks all environment variables within the application and the configurations required to build the application and cloud environment. This may include sensitive information.

The configuration is leaked through the /api endpoint on the local server that is responsible for serving the Garden dashboard.

At the moment, this server is accessible to 0.0.0.0 which makes it accessible to anyone on the same network (or anyone on the internet if they are on a public, static IP).

Impact: Ability to compromise credentials, secrets or environment variables when on the same network as the user.

### Patches

The problem has been patched in version 0.12.39.

### Workarounds

Apply a firewall configuration that blocks access from everywhere except localhost to port 9777.

### For more information

If you have any questions or comments about this advisory:

* Open an issue in <https://github.com/garden-io/garden/issues>
* Send an e-mail to security@garden.io

### Severity

High

### CVE ID

CVE-2022-24829

### Weaknesses

[CWE-202](/advisories?query=cwe%3A202)

### Credits

* [![@h4sh5](https://avatars.githubusercontent.com/u/38898566?s=40&v=4)](/h4sh5)
  [h4sh5](/h4sh5)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


