=== Content from github.com_d86cf1ce_20250114_234049.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCZ-NIC%2Fknot-resolver%2Fcommit%2Fccb9d9794db5eb757c33becf65cb1cf48ecfd968)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCZ-NIC%2Fknot-resolver%2Fcommit%2Fccb9d9794db5eb757c33becf65cb1cf48ecfd968)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=CZ-NIC%2Fknot-resolver)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[CZ-NIC](/CZ-NIC)
/
**[knot-resolver](/CZ-NIC/knot-resolver)**
Public

* [Notifications](/login?return_to=%2FCZ-NIC%2Fknot-resolver) You must be signed in to change notification settings
* [Fork
  59](/login?return_to=%2FCZ-NIC%2Fknot-resolver)
* [Star
   368](/login?return_to=%2FCZ-NIC%2Fknot-resolver)

* [Code](/CZ-NIC/knot-resolver)
* [Issues
  16](/CZ-NIC/knot-resolver/issues)
* [Pull requests
  2](/CZ-NIC/knot-resolver/pulls)
* [Actions](/CZ-NIC/knot-resolver/actions)
* [Security](/CZ-NIC/knot-resolver/security)
* [Insights](/CZ-NIC/knot-resolver/pulse)

Additional navigation options

* [Code](/CZ-NIC/knot-resolver)
* [Issues](/CZ-NIC/knot-resolver/issues)
* [Pull requests](/CZ-NIC/knot-resolver/pulls)
* [Actions](/CZ-NIC/knot-resolver/actions)
* [Security](/CZ-NIC/knot-resolver/security)
* [Insights](/CZ-NIC/knot-resolver/pulse)

## Commit

[Permalink](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

policy docs: warn about filters and forwarding

[Browse files](/CZ-NIC/knot-resolver/tree/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)
Browse the repository at this point in the history

```
We've been notified about possibility of "cache poisoning" this way,
so let's document this drawback to make the expectations clearer.
```

* Loading branch information

[![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=40&v=4)](/vcunat)

[vcunat](/CZ-NIC/knot-resolver/commits?author=vcunat "View all commits by vcunat")
committed
Dec 22, 2021

1 parent
[e862a78](/CZ-NIC/knot-resolver/commit/e862a78dbdae2e401b2429ef9b6421030c7e66b3)

commit ccb9d97

Showing
**1 changed file**
with
**14 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

14 changes: 14 additions & 0 deletions

14
[modules/policy/README.rst](#diff-b128792ec3d166ac813cad1d96f817324c45e4d7222b6035409cadd2effdb302 "modules/policy/README.rst")

Show comments

[View file](/CZ-NIC/knot-resolver/blob/ccb9d9794db5eb757c33becf65cb1cf48ecfd968/modules/policy/README.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -407,6 +407,20 @@ Actions :func:`policy.FORWARD`, :func:`policy.TLS\_FORWARD` and :func:`policy.STU |
|  |  | `0x20 randomization <https://tools.ietf.org/html/draft-vixie-dnsext-dns0x20-00>`\_. |
|  |  | See example in `Replacing part of the DNS tree`\_. |
|  |  |  |
|  |  | .. warning:: |
|  |  | Limiting forwarding actions by filters (e.g. :func:`policy.suffix`) may have unexpected consequences. |
|  |  | Notably, forwarders can inject \*any\* records into your cache |
|  |  | even if you "restrict" them to an insignificant DNS subtree -- |
|  |  | except in cases where DNSSEC validation applies, of course. |
|  |  |  |
|  |  | The behavior is probably best understood through the fact |
|  |  | that filters and actions are completely decoupled. |
|  |  | The forwarding actions have no clue about why they were executed, |
|  |  | e.g. that the user wanted to restrict the forwarder only to some subtree. |
|  |  | The action just selects some set of forwarders to process this whole request from the client, |
|  |  | and during that processing it might need some other "sub-queries" (e.g. for validation). |
|  |  | Some of those might not've passed the intended filter, |
|  |  | but policy rule-set only applies once per client's request. |
|  |  |  |
|  |  | .. \_tls-forwarding: |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 9 comments on commit `ccb9d97`

[![@idealeer](https://avatars.githubusercontent.com/u/29519911?s=80&v=4)](/idealeer)

Copy link

### @idealeer **[idealeer](/idealeer)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jan 11, 2022](#commitcomment-63469673)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It indeed is a potential issue, and we have conducted the actual cache poisoning attack with this issue.

Everyone using the filter `policy.suffix` should notice this issue.

Moreover, we hope Knot will fix the issue in the next major version as soon as possible.

Sorry, something went wrong.

All reactions

[![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=80&v=4)](/vcunat)

Copy link

Member

Author

### @vcunat **[vcunat](/vcunat)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jan 11, 2022](#commitcomment-63472100)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

For reference, we have a huge ticket the policy rewrite, and I believe that the current plans of the design will also mitigate this (incidentally): <https://gitlab.nic.cz/knot/knot-resolver/-/issues/535>

Sorry, something went wrong.

All reactions

[![@idealeer](https://avatars.githubusercontent.com/u/29519911?s=80&v=4)](/idealeer)

Copy link

### @idealeer **[idealeer](/idealeer)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jan 11, 2022](#commitcomment-63530049)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Great! When do you guys plan to implement the new designed policy modules?

Sorry, something went wrong.

All reactions

[![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=80&v=4)](/vcunat)

Copy link

Member

Author

### @vcunat **[vcunat](/vcunat)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jan 11, 2022](#commitcomment-63530764)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

We have an old prototype, and I certainly plan to spend lots of time on this in the following few months.

Sorry, something went wrong.

All reactions

[![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=80&v=4)](/vcunat)

Copy link

Member

Author

### @vcunat **[vcunat](/vcunat)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jan 11, 2022](#commitcomment-63530802)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The docs change was merged, by the way.

Sorry, something went wrong.

All reactions

[![@idealeer](https://avatars.githubusercontent.com/u/29519911?s=80&v=4)](/idealeer)

Copy link

### @idealeer **[idealeer](/idealeer)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jan 11, 2022](#commitcomment-63531489)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Have noticed it in the latest document version. Thanks for your assistance.

Sorry, something went wrong.

 😄
1
 vcunat reacted with laugh emoji

All reactions

* 😄
  1 reaction

[![@idealeer](https://avatars.githubusercontent.com/u/29519911?s=80&v=4)](/idealeer)

Copy link

### @idealeer **[idealeer](/idealeer)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [May 31, 2022](#commitcomment-74970718)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Hi, have you guys started the rewriting process?

Sorry, something went wrong.

All reactions

[![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=80&v=4)](/vcunat)

Copy link

Member

Author

### @vcunat **[vcunat](/vcunat)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [May 31, 2022](#commitcomment-74971474)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Started? Well, yes I could say that. But in the past couple of months it got stalled due to more immediate concerns taking more work.

Anyway, you can follow that branch: <https://gitlab.nic.cz/knot/knot-resolver/-/compare/master...new-policy>

Sorry, something went wrong.

All reactions

[![@idealeer](https://avatars.githubusercontent.com/u/29519911?s=80&v=4)](/idealeer)

Copy link

### @idealeer **[idealeer](/idealeer)** commented on `[ccb9d97](/CZ-NIC/knot-resolver/commit/ccb9d9794db5eb757c33becf65cb1cf48ecfd968)` [Jun 1, 2022](#commitcomment-75056658)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

nice

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCZ-NIC%2Fknot-resolver%2Fcommit%2Fccb9d9794db5eb757c33becf65cb1cf48ecfd968) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from knot-resolver.readthedocs.io_46f66305_20250114_234052.html ===

[![Logo](_static/logo-negativ.svg)](index.html)
stable

Quick Start

* [Installation](quickstart-install.html)
* [Startup](quickstart-startup.html)
  + [First DNS query](quickstart-startup.html#first-dns-query)
* [Configuration](quickstart-config.html)
  + [Listening on network interfaces](quickstart-config.html#listening-on-network-interfaces)
  + [Scenario: Internal Resolver](quickstart-config.html#scenario-internal-resolver)
    - [Internal-only domains](quickstart-config.html#internal-only-domains)
  + [Scenario: ISP Resolver](quickstart-config.html#scenario-isp-resolver)
    - [Limiting client access](quickstart-config.html#limiting-client-access)
    - [TLS server configuration](quickstart-config.html#tls-server-configuration)
    - [Mandatory domain blocking](quickstart-config.html#mandatory-domain-blocking)
  + [Scenario: Personal Resolver](quickstart-config.html#scenario-personal-resolver)
    - [Forwarding over TLS protocol (DNS-over-TLS)](quickstart-config.html#forwarding-over-tls-protocol-dns-over-tls)
    - [Forwarding to multiple targets](quickstart-config.html#forwarding-to-multiple-targets)
    - [Non-persistent cache](quickstart-config.html#non-persistent-cache)

Configuration

* [Configuration Overview](config-overview.html)
  + [Syntax](config-overview.html#syntax)
  + [Documentation Conventions](config-overview.html#documentation-conventions)
  + [Modules](config-overview.html#modules)
    - [`modules.list()`](config-overview.html#modules.list)
    - [`modules.load()`](config-overview.html#modules.load)
    - [`modules.unload()`](config-overview.html#modules.unload)
* [Networking and protocols](config-network.html)
  + [Server (communication with clients)](config-network.html#server-communication-with-clients)
    - [Addresses and services](daemon-bindings-net_server.html)
      * [`net.listen()`](daemon-bindings-net_server.html#net.listen)
      * [PROXYv2 protocol](daemon-bindings-net_server.html#proxyv2-protocol)
      * [Features for scripting](daemon-bindings-net_server.html#features-for-scripting)
    - [DoT and DoH (encrypted DNS)](daemon-bindings-net_tlssrv.html)
      * [DNS-over-TLS (DoT)](daemon-bindings-net_tlssrv.html#dns-over-tls-dot)
      * [DNS-over-HTTPS (DoH)](daemon-bindings-net_tlssrv.html#dns-over-https-doh)
      * [Configuration options for DoT and DoH](daemon-bindings-net_tlssrv.html#configuration-options-for-dot-and-doh)
      * [Configuration options for DoH](daemon-bindings-net_tlssrv.html#configuration-options-for-doh)
    - [Other HTTP services](modules-http.html)
      * [Example configuration](modules-http.html#example-configuration)
      * [HTTPS (TLS for HTTP)](modules-http.html#https-tls-for-http)
      * [Legacy DNS-over-HTTPS (DoH)](modules-http.html#legacy-dns-over-https-doh)
      * [Built-in services](modules-http.html#built-in-services)
      * [Dependencies](modules-http.html#dependencies)
  + [Client (retrieving answers from servers)](config-network.html#client-retrieving-answers-from-servers)
    - [IPv4 and IPv6 usage](daemon-bindings-net_client.html)
      * [`net.outgoing_v4()`](daemon-bindings-net_client.html#net.outgoing_v4)
      * [`net.outgoing_v6()`](daemon-bindings-net_client.html#net.outgoing_v6)
    - [Forwarding](config-network-forwarding.html)
  + [DNS protocol tweaks](config-network.html#dns-protocol-tweaks)
    - [DNS protocol tweaks](daemon-bindings-net_dns_tweaks.html)
      * [`net.bufsize()`](daemon-bindings-net_dns_tweaks.html#net.bufsize)
  + [Buffering tweaks](config-network.html#buffering-tweaks)
    - [Buffering tweaks](daemon-bindings-net_buffering.html)
* [Performance and resiliency](config-performance.html)
  + [Cache](daemon-bindings-cache.html)
    - [Sizing](daemon-bindings-cache.html#sizing)
    - [Persistence](daemon-bindings-cache.html#persistence)
    - [Configuration reference](daemon-bindings-cache.html#configuration-reference)
      * [`cache.open()`](daemon-bindings-cache.html#cache.open)
      * [`cache.backends()`](daemon-bindings-cache.html#cache.backends)
      * [`cache.count()`](daemon-bindings-cache.html#cache.count)
      * [`cache.close()`](daemon-bindings-cache.html#cache.close)
      * [`cache.fssize()`](daemon-bindings-cache.html#cache.fssize)
      * [`cache.stats()`](daemon-bindings-cache.html#cache.stats)
      * [`cache.max_ttl()`](daemon-bindings-cache.html#cache.max_ttl)
      * [`cache.min_ttl()`](daemon-bindings-cache.html#cache.min_ttl)
      * [`cache.ns_tout()`](daemon-bindings-cache.html#cache.ns_tout)
      * [`cache.get()`](daemon-bindings-cache.html#cache.get)
      * [`cache.clear()`](daemon-bindings-cache.html#cache.clear)
  + [Multiple instances](systemd-multiinst.html)
    - [Zero-downtime restarts](systemd-multiinst.html#zero-downtime-restarts)
    - [Instance-specific configuration](systemd-multiinst.html#instance-specific-configuration)
  + [Prefetching records](modules-predict.html)
    - [Expiring records](modules-predict.html#expiring-records)
    - [Prediction](modules-predict.html#prediction)
    - [Example configuration](modules-predict.html#example-configuration)
    - [Exported metrics](modules-predict.html#exported-metrics)
    - [Properties](modules-predict.html#properties)
      * [`predict.config()`](modules-predict.html#predict.config)
  + [Cache prefilling](modules-prefill.html)
    - [Dependencies](modules-prefill.html#dependencies)
  + [Serve stale](modules-serve_stale.html)
    - [Running](modules-serve_stale.html#running)
  + [Root on loopback (RFC 7706)](modules-rfc7706.html)
  + [Priming module](modules-priming.html)
  + [EDNS keepalive](modules-edns_keepalive.html)
  + [XDP for higher UDP performance](daemon-bindings-net_xdpsrv.html)
    - [Prerequisites](daemon-bindings-net_xdpsrv.html#prerequisites)
    - [Set up](daemon-bindings-net_xdpsrv.html#set-up)
    - [Optimizations](daemon-bindings-net_xdpsrv.html#optimizations)
    - [Limitations](daemon-bindings-net_xdpsrv.html#limitations)
* [Policy, access control, data manipulation](config-policy.html)
  + Query policies
    - [Filters](#filters)
      * [`all()`](#policy.all)
      * [`pattern()`](#policy.pattern)
      * [`suffix()`](#policy.suffix)
      * [`domains()`](#policy.domains)
      * [`suffix_common()`](#policy.suffix_common)
      * [`custom_filter()`](#policy.custom_filter)
    - [Actions](#actions)
      * [Non-chain actions](#non-chain-actions)
      * [Chain actions](#chain-actions)
      * [Actions for extra logging](#actions-for-extra-logging)
      * [Custom actions](#custom-actions)
    - [Forwarding](#forwarding)
      * [`FORWARD()`](#policy.FORWARD)
      * [`STUB()`](#policy.STUB)
    - [Forwarding over TLS protocol (DNS-over-TLS)](#forwarding-over-tls-protocol-dns-over-tls)
      * [`TLS_FORWARD()`](#policy.TLS_FORWARD)
      * [CA+hostname authentication](#ca-hostname-authentication)
      * [Key-pinned authentication](#key-pinned-authentication)
      * [TLS Examples](#tls-examples)
      * [Forwarding to multiple targets](#forwarding-to-multiple-targets)
    - [Replacing part of the DNS tree](#replacing-part-of-the-dns-tree)
    - [Response policy zones](#response-policy-zones)
      * [`rpz()`](#policy.rpz)
    - [Additional properties](#additional-properties)
      * [`add()`](#policy.add)
      * [`del()`](#policy.del)
      * [`todnames()`](#policy.todnames)
  + [Views and ACLs](modules-view.html)
    - [Example configuration](modules-view.html#example-configuration)
    - [Rule order](modules-view.html#rule-order)
    - [Properties](modules-view.html#properties)
  + [Static hints](modules-hints.html)
    - [Examples](modules-hints.html#examples)
    - [Properties](modules-hints.html#properties)
      * [`hints.config()`](modules-hints.html#hints.config)
      * [`hints.add_hosts()`](modules-hints.html#hints.add_hosts)
      * [`hints.get()`](modules-hints.html#hints.get)
      * [`hints.set()`](modules-hints.html#hints.set)
      * [`hints.del()`](modules-hints.html#hints.del)
      * [`hints.root_file()`](modules-hints.html#hints.root_file)
      * [`hints.root()`](modules-hints.html#hints.root)
      * [`hints.use_nodata()`](modules-hints.html#hints.use_nodata)
      * [`hints.ttl()`](modules-hints.html#hints.ttl)
  + [DNS64](modules-dns64.html)
    - [Simple example](modules-dns64.html#simple-example)
    - [Advanced options](modules-dns64.html#advanced-options)
  + [IP address renumbering](modules-renumber.html)
    - [Example configuration](modules-renumber.html#example-configuration)
  + [Answer reordering](config-answer-reordering.html)
    - [`reorder_RR()`](config-answer-reordering.html#reorder_RR)
  + [Rebinding protection](modules-rebinding.html)
  + [Refuse queries without RD bit](modules-refuse_nord.html)
  + [DNS Application Firewall](modules-daf.html)
    - [Example configuration](modules-daf.html#example-configuration)
    - [Web interface](modules-daf.html#web-interface)
    - [RESTful interface](modules-daf.html#restful-interface)
* [Logging, monitoring, diagnostics](config-logging-monitoring.html)
  + [`log_level()`](config-logging-monitoring.html#log_level)
    - [`verbose()`](config-logging-monitoring.html#verbose)
  + [`log_target()`](config-logging-monitoring.html#log_target)
  + [`log_groups()`](config-logging-monitoring.html#log_groups)
  + [DNSSEC validation failure logging](modules-bogus_log.html)
  + [Statistics collector](modules-stats.html)
    - [Built-in statistics](modules-stats.html#built-in-statistics)
    - [Module reference](modules-stats.html#module-reference)
      * [`stats.get()`](modules-stats.html#stats.get)
      * [`stats.set()`](modules-stats.html#stats.set)
      * [`stats.list()`](modules-stats.html#stats.list)
      * [`stats.upstreams()`](modules-stats.html#stats.upstreams)
      * [`stats.frequent()`](modules-stats.html#stats.frequent)
      * [`stats.clear_frequent()`](modules-stats.html#stats.clear_frequent)
    - [Graphite/InfluxDB/Metronome](modules-stats.html#graphite-influxdb-metronome)
      * [Dependencies](modules-stats.html#dependencies)
    - [Prometheus metrics endpoint](modules-stats.html#prometheus-metrics-endpoint)
  + [Scripting worker](daemon-bindings-worker.html)
    - [`worker.stats()`](daemon-bindings-worker.html#worker.stats)
  + [Name Server Identifier (NSID)](modules-nsid.html)
  + [Debugging a single request](modules-http-trace.html)
    - [Using query policies](modules-http-trace.html#using-query-policies)
    - [Using HTTP module](modules-http-trace.html#using-http-module)
  + [Watchdog](modules-watchdog.html)
  + [Dnstap (traffic collection)](modules-dnstap.html)
  + [Sentinel for Detecting Trusted Root Keys](modules-ta_sentinel.html)
  + [Signaling Trust Anchor Knowledge in DNSSEC](modules-ta_signal_query.html)
  + [System time skew detector](modules-detect_time_skew.html)
  + [Detect discontinuous jumps in the system time](modules-detect_time_jump.html)
  + [Debugging options](config-debugging.html)
  + [Logging API](config-logging-header.html)
* [DNSSEC, data verification](config-dnssec.html)
  + [`trust_anchors.add_file()`](config-dnssec.html#trust_anchors.add_file)
  + [`trust_anchors.remove()`](config-dnssec.html#trust_anchors.remove)
  + [`trust_anchors.set_insecure()`](config-dnssec.html#trust_anchors.set_insecure)
  + [`trust_anchors.add()`](config-dnssec.html#trust_anchors.add)
  + [`trust_anchors.summary()`](config-dnssec.html#trust_anchors.summary)
  + [`mode()`](config-dnssec.html#mode)
* [Experimental features](config-experimental.html)
  + [Run-time reconfiguration](daemon-scripting.html)
    - [Control sockets](daemon-scripting.html#control-sockets)
      * [`map()`](daemon-scripting.html#map)
    - [Lua scripts](daemon-scripting.html#lua-scripts)
      * [Helper functions](daemon-scripting.html#helper-functions)
    - [Asynchronous events](daemon-scripting.html#asynchronous-events)
      * [Timers and events reference](daemon-scripting.html#timers-and-events-reference)
      * [Asynchronous function execution](daemon-scripting.html#asynchronous-function-execution)
    - [Etcd support](daemon-scripting.html#etcd-support)
      * [Example configuration](daemon-scripting.html#example-configuration)
      * [Dependencies](daemon-scripting.html#dependencies)
  + [Experimental DNS-over-TLS Auto-discovery](modules-experimental_dot_auth.html)
    - [How it works](modules-experimental_dot_auth.html#how-it-works)
    - [Generating NS target names](modules-experimental_dot_auth.html#generating-ns-target-names)
    - [Example configuration](modules-experimental_dot_auth.html#example-configuration)
    - [Caveats](modules-experimental_dot_auth.html#caveats)
    - [Dependencies](modules-experimental_dot_auth.html#dependencies)
* [Usage without systemd](config-no-systemd.html)
  + [Process management](config-no-systemd-processes.html)
    - [Garbage Collector](config-no-systemd-processes.html#garbage-collector)
  + [Privileges and capabilities](config-no-systemd-privileges.html)
    - [Using capabilities](config-no-systemd-privileges.html#using-capabilities)
    - [Running as non-privileged user](config-no-systemd-privileges.html#running-as-non-privileged-user)
      * [`user()`](config-no-systemd-privileges.html#user)
    - [Running as root](config-no-systemd-privileges.html#running-as-root)

Operation

* [Upgrading](upgrading.html)
  + [Upcoming changes](upgrading.html#upcoming-changes)
  + [5.4 to 5.5](upgrading.html#to-5-5)
    - [Packagers & Developers](upgrading.html#packagers-developers)
    - [Module API changes](upgrading.html#module-api-changes)
  + [5.3 to 5.4](upgrading.html#to-5-4)
    - [Configuration file](upgrading.html#configuration-file)
    - [Packagers & Developers](upgrading.html#id2)
    - [Module changes](upgrading.html#module-changes)
  + [5.2 to 5.3](upgrading.html#to-5-3)
    - [Configuration file](upgrading.html#id3)
    - [Packagers & Developers](upgrading.html#id4)
  + [5.1 to 5.2](upgrading.html#to-5-2)
    - [Users](upgrading.html#users)
    - [Configuration file](upgrading.html#id5)
    - [Module changes](upgrading.html#id6)
  + [5.0 to 5.1](upgrading.html#to-5-1)
    - [Module changes](upgrading.html#id7)
  + [4.x to 5.x](upgrading.html#x-to-5-x)
    - [Users](upgrading.html#id8)
    - [Configuration file](upgrading.html#id9)
  + [4.2.2 to 4.3+](upgrading.html#to-4-3)
    - [Module changes](upgrading.html#id11)
  + [4.x to 4.2.1+](upgrading.html#x-to-4-2-1)
    - [Users](upgrading.html#id12)
  + [3.x to 4.x](upgrading.html#x-to-4-x)
    - [Users](upgrading.html#id13)
      * [Configuration file](upgrading.html#id14)
    - [Packagers & Developers](upgrading.html#id15)
      * [Module changes](upgrading.html#id16)
  + [2.x to 3.x](upgrading.html#x-to-3-x)
    - [Users](upgrading.html#id17)
    - [Packagers & Developers](upgrading.html#id18)
      * [Module changes](upgrading.html#id19)
* [Release notes](NEWS.html)
  + [Version numbering](NEWS.html#version-numbering)
  + [Knot Resolver 5.7.4 (2024-07-23)](NEWS.html#knot-resolver-5-7-4-2024-07-23)
    - [Security](NEWS.html#security)
    - [Improvements](NEWS.html#improvements)
    - [Incompatible changes](NEWS.html#incompatible-changes)
  + [Knot Resolver 5.7.3 (2024-05-30)](NEWS.html#knot-resolver-5-7-3-2024-05-30)
    - [Improvements](NEWS.html#id2)
    - [Bugfixes](NEWS.html#bugfixes)
  + [Knot Resolver 5.7.2 (2024-03-27)](NEWS.html#knot-resolver-5-7-2-2024-03-27)
    - [Bugfixes](NEWS.html#id3)
  + [Knot Resolver 5.7.1 (2024-02-13)](NEWS.html#knot-resolver-5-7-1-2024-02-13)
    - [Security](NEWS.html#id4)
    - [Improvements](NEWS.html#id5)
    - [Bugfixes](NEWS.html#id6)
  + [Knot Resolver 5.7.0 (2023-08-22)](NEWS.html#knot-resolver-5-7-0-2023-08-22)
    - [Security](NEWS.html#id7)
    - [Improvements](NEWS.html#id8)
    - [Bugfixes](NEWS.html#id9)
  + [Knot Resolver 5.6.0 (2023-01-26)](NEWS.html#knot-resolver-5-6-0-2023-01-26)
    - [Security](NEWS.html#id10)
    - [Improvements](NEWS.html#id11)
    - [Bugfixes](NEWS.html#id12)
  + [Knot Resolver 5.5.3 (2022-09-21)](NEWS.html#knot-resolver-5-5-3-2022-09-21)
    - [Security](NEWS.html#id13)
    - [Improvements](NEWS.html#id14)
  + [Knot Resolver 5.5.2 (2022-08-16)](NEWS.html#knot-resolver-5-5-2-2022-08-16)
    - [Improvements](NEWS.html#id15)
    - [Bugfixes](NEWS.html#id16)
  + [Knot Resolver 5.5.1 (2022-06-14)](NEWS.html#knot-resolver-5-5-1-2022-06-14)
    - [Improvements](NEWS.html#id17)
    - [Bugfixes](NEWS.html#id18)
  + [Knot Resolver 5.5.0 (2022-03-15)](NEWS.html#knot-resolver-5-5-0-2022-03-15)
    - [Improvements](NEWS.html#id19)
    - [Incompatible changes](NEWS.html#id20)
    - [Bugfixes](NEWS.html#id21)
  + [Knot Resolver 5.4.4 (2022-01-05)](NEWS.html#knot-resolver-5-4-4-2022-01-05)
    - [Bugfixes](NEWS.html#id22)
  + [Knot Resolver 5.4.3 (2021-12-01)](NEWS.html#knot-resolver-5-4-3-2021-12-01)
    - [Improvements](NEWS.html#id23)
    - [Bugfixes](NEWS.html#id24)
  + [Knot Resolver 5.4.2 (2021-10-13)](NEWS.html#knot-resolver-5-4-2-2021-10-13)
    - [Improvements](NEWS.html#id25)
    - [Bugfixes](NEWS.html#id26)
  + [Knot Resolver 5.4.1 (2021-08-19)](NEWS.html#knot-resolver-5-4-1-2021-08-19)
    - [Improvements](NEWS.html#id27)
    - [Bugfixes](NEWS.html#id28)
  + [Knot Resolver 5.4.0 (2021-07-29)](NEWS.html#knot-resolver-5-4-0-2021-07-29)
    - [Improvements](NEWS.html#id29)
    - [Bugfixes](NEWS.html#id30)
    - [Incompatible changes](NEWS.html#id31)
  + [Knot Resolver 5.3.2 (2021-05-05)](NEWS.html#knot-resolver-5-3-2-2021-05-05)
    - [Security](NEWS.html#id32)
    - [Improvements](NEWS.html#id33)
    - [Bugfixes](NEWS.html#id34)
  + [Knot Resolver 5.3.1 (2021-03-31)](NEWS.html#knot-resolver-5-3-1-2021-03-31)
    - [Improvements](NEWS.html#id35)
    - [Bugfixes](NEWS.html#id36)
  + [Knot Resolver 5.3.0 (2021-02-25)](NEWS.html#knot-resolver-5-3-0-2021-02-25)
    - [Improvements](NEWS.html#id37)
    - [Bugfixes](NEWS.html#id38)
    - [Incompatible changes](NEWS.html#id39)
  + [Knot Resolver 5.2.1 (2020-12-09)](NEWS.html#knot-resolver-5-2-1-2020-12-09)
    - [Improvements](NEWS.html#id40)
    - [Bugfixes](NEWS.html#id41)
  + [Knot Resolver 5.2.0 (2020-11-11)](NEWS.html#knot-resolver-5-2-0-2020-11-11)
    - [Improvements](NEWS.html#id42)
    - [Bugfixes](NEWS.html#id43)
    - [Incompatible changes](NEWS.html#id44)
  + [Knot Resolver 5.1.3 (2020-09-08)](NEWS.html#knot-resolver-5-1-3-2020-09-08)
    - [Improvements](NEWS.html#id45)
    - [Bugfixes](NEWS.html#id46)
  + [Knot Resolver 5.1.2 (2020-07-01)](NEWS.html#knot-resolver-5-1-2-2020-07-01)
    - [Bugfixes](NEWS.html#id47)
  + [Knot Resolver 5.1.1 (2020-05-19)](NEWS.html#knot-resolver-5-1-1-2020-05-19)
    - [Security](NEWS.html#id48)
    - [Bugfixes](NEWS.html#id49)
  + [Knot Resolver 5.1.0 (2020-04-29)](NEWS.html#knot-resolver-5-1-0-2020-04-29)
    - [Improvements](NEWS.html#id50)
    - [Bugfixes](NEWS.html#id51)
    - [Incompatible changes](NEWS.html#id52)
  + [Knot Resolver 5.0.1 (2020-02-05)](NEWS.html#knot-resolver-5-0-1-2020-02-05)
    - [Bugfixes](NEWS.html#id53)
    - [Improvements](NEWS.html#id54)
  + [Knot Resolver 5.0.0 (2020-01-27)](NEWS.html#knot-resolver-5-0-0-2020-01-27)
    - [Incompatible changes](NEWS.html#id55)
    - [Improvements](NEWS.html#id56)
    - [Bugfixes](NEWS.html#id57)
  + [Knot Resolver 4.3.0 (2019-12-04)](NEWS.html#knot-resolver-4-3-0-2019-12-04)
    - [Security - CVE-2019-19331](NEWS.html#security-cve-2019-19331)
    - [Bugfixes](NEWS.html#id58)
    - [Improvements](NEWS.html#id59)
  + [Knot Resolver 4.2.2 (2019-10-07)](NEWS.html#knot-resolver-4-2-2-2019-10-07)
    - [Bugfixes](NEWS.html#id60)
  + [Knot Resolver 4.2.1 (2019-09-26)](NEWS.html#knot-resolver-4-2-1-2019-09-26)
    - [Bugfixes](NEWS.html#id61)
    - [Improvements](NEWS.html#id62)
  + [Knot Resolver 4.2.0 (2019-08-05)](NEWS.html#knot-resolver-4-2-0-2019-08-05)
    - [Improvements](NEWS.html#id63)
    - [Bugfixes](NEWS.html#id64)
    - [Module API changes](NEWS.html#module-api-changes)
  + [Knot Resolver 4.1.0 (2019-07-10)](NEWS.html#knot-resolver-4-1-0-2019-07-10)
    - [Security](NEWS.html#id65)
    - [Improvements](NEWS.html#id66)
    - [Bugfixes](NEWS.html#id67)
    - [Module API changes](NEWS.html#id68)
  + [Knot Resolver 4.0.0 (2019-04-18)](NEWS.html#knot-resolver-4-0-0-2019-04-18)
    - [Incompatible changes](NEWS.html#id69)
    - [Improvements](NEWS.html#id70)
    - [Bugfixes](NEWS.html#id71)
    - [Module API changes](NEWS.html#id72)
  + [Knot Resolver 3.2.1 (2019-01-10)](NEWS.html#knot-resolver-3-2-1-2019-01-10)
    - [Bugfixes](NEWS.html#id73)
    - [Improvements](NEWS.html#id74)
  + [Knot Resolver 3.2.0 (2018-12-17)](NEWS.html#knot-resolver-3-2-0-2018-12-17)
    - [New features](NEWS.html#new-features)
    - [Bugfixes](NEWS.html#id75)
    - [Improvements](NEWS.html#id76)
    - [Module API changes](NEWS.html#id77)
  + [Knot Resolver 3.1.0 (2018-11-02)](NEWS.html#knot-resolver-3-1-0-2018-11-02)
    - [Incompatible changes](NEWS.html#id78)
    - [Improvements](NEWS.html#id79)
    - [Bugfixes](NEWS.html#id80)
  + [Knot Resolver 3.0.0 (2018-08-20)](NEWS.html#knot-resolver-3-0-0-2018-08-20)
    - [Incompatible changes](NEWS.html#id81)
    - [Bugfixes](NEWS.html#id82)
    - [Improvements](NEWS.html#id83)
  + [Knot Resolver 2.4.1 (2018-08-02)](NEWS.html#knot-resolver-2-4-1-2018-08-02)
    - [Security](NEWS.html#id84)
    - [Bugfixes](NEWS.html#id85)
  + [Knot Resolver 2.4.0 (2018-07-03)](NEWS.html#knot-resolver-2-4-0-2018-07-03)
    - [Incompatible changes](NEWS.html#id86)
    - [Security](NEWS.html#id87)
    - [New features](NEWS.html#id88)
    - [Bugfixes](NEWS.html#id89)
    - [Improvements](NEWS.html#id90)
  + [Knot Resolver 2.3.0 (2018-04-23)](NEWS.html#knot-resolver-2-3-0-2018-04-23)
    - [Security](NEWS.html#id91)
    - [New features](NEWS.html#id92)
    - [Bugfixes](NEWS.html#id93)
    - [Improvements](NEWS.html#id94)
  + [Knot Resolver 2.2.0 (2018-03-28)](NEWS.html#knot-resolver-2-2-0-2018-03-28)
    - [New features](NEWS.html#id95)
    - [Bugfixes](NEWS.html#id96)
  + [Knot Resolver 2.1.1 (2018-02-23)](NEWS.html#knot-resolver-2-1-1-2018-02-23)
    - [Bugfixes](NEWS.html#id97)
  + [Knot Resolver 2.1.0 (2018-02-16)](NEWS.html#knot-resolver-2-1-0-2018-02-16)
    - [Incompatible changes](NEWS.html#id98)
    - [Bugfixes](NEWS.html#id99)
  + [Knot Resolver 2.0.0 (2018-01-31)](NEWS.html#knot-resolver-2-0-0-2018-01-31)
    - [Incompatible changes](NEWS.html#id100)
    - [New features](NEWS.html#id101)
    - [Bugfixes](NEWS.html#id102)
  + [Knot Resolver 1.5.3 (2018-01-23)](NEWS.html#knot-resolver-1-5-3-2018-01-23)
    - [Bugfixes](NEWS.html#id103)
  + [Knot Resolver 1.5.2 (2018-01-22)](NEWS.html#knot-resolver-1-5-2-2018-01-22)
    - [Security](NEWS.html#id104)
    - [Bugfixes](NEWS.html#id105)
  + [Knot Resolver 1.5.1 (2017-12-12)](NEWS.html#knot-resolver-1-5-1-2017-12-12)
    - [Incompatible changes](NEWS.html#id106)
    - [Bugfixes](NEWS.html#id107)
    - [Improvements](NEWS.html#id108)
  + [Knot Resolver 1.5.0 (2017-11-02)](NEWS.html#knot-resolver-1-5-0-2017-11-02)
    - [Bugfixes](NEWS.html#id109)
    - [Improvements](NEWS.html#id110)
  + [Knot Resolver 1.99.1-alpha (2017-10-26)](NEWS.html#knot-resolver-1-99-1-alpha-2017-10-26)
    - [Improvements](NEWS.html#id111)
    - [Regressions](NEWS.html#regressions)
  + [Knot Resolver 1.4.0 (2017-09-22)](NEWS.html#knot-resolver-1-4-0-2017-09-22)
    - [Incompatible changes](NEWS.html#id112)
    - [Bugfixes](NEWS.html#id113)
    - [Improvements](NEWS.html#id114)
  + [Knot Resolver 1.3.3 (2017-08-09)](NEWS.html#knot-resolver-1-3-3-2017-08-09)
    - [Security](NEWS.html#id115)
    - [Bugfixes](NEWS.html#id116)
    - [Improvements](NEWS.html#id117)
  + [Knot Resolver 1.3.2 (2017-07-28)](NEWS.html#knot-resolver-1-3-2-2017-07-28)
    - [Security](NEWS.html#id118)
    - [Bugfixes](NEWS.html#id119)
    - [Improvements](NEWS.html#id120)
  + [Knot Resolver 1.3.1 (2017-06-23)](NEWS.html#knot-resolver-1-3-1-2017-06-23)
    - [Bugfixes](NEWS.html#id121)
  + [Knot Resolver 1.3.0 (2017-06-13)](NEWS.html#knot-resolver-1-3-0-2017-06-13)
    - [Security](NEWS.html#id122)
    - [Improvements](NEWS.html#id123)
    - [Bugfixes](NEWS.html#id124)
  + [Knot Resolver 1.2.6 (2017-04-24)](NEWS.html#knot-resolver-1-2-6-2017-04-24)
    - [Security](NEWS.html#id125)
    - [Improvements](NEWS.html#id126)
    - [Bugfixes](NEWS.html#id127)
  + [Knot Resolver 1.2.5 (2017-04-05)](NEWS.html#knot-resolver-1-2-5-2017-04-05)
    - [Security](NEWS.html#id128)
    - [Improvements](NEWS.html#id129)
    - [Bugfixes](NEWS.html#id130)
  + [Knot Resolver 1.2.4 (2017-03-09)](NEWS.html#knot-resolver-1-2-4-2017-03-09)
    - [Security](NEWS.html#id131)
    - [Improvements](NEWS.html#id132)
    - [Bugfixes](NEWS.html#id133)
  + [Knot Resolver 1.2.3 (2017-02-23)](NEWS.html#knot-resolver-1-2-3-2017-02-23)
    - [Bugfixes](NEWS.html#id134)
  + [Knot Resolver 1.2.2 (2017-02-10)](NEWS.html#knot-resolver-1-2-2-2017-02-10)
    - [Bugfixes:](NEWS.html#id135)
    - [Testing:](NEWS.html#testing)
  + [Knot Resolver 1.2.1 (2017-02-01)](NEWS.html#knot-resolver-1-2-1-2017-02-01)
    - [Security:](NEWS.html#id136)
    - [Documentation](NEWS.html#documentation)
    - [Bugfixes:](NEWS.html#id137)
  + [Knot Resolver 1.2.0 (2017-01-24)](NEWS.html#knot-resolver-1-2-0-2017-01-24)
    - [Security:](NEWS.html#id138)
    - [Improvements:](NEWS.html#id139)
    - [Bugfixes:](NEWS.html#id140)
    - [Miscellaneous:](NEWS.html#miscellaneous)
  + [Knot Resolver 1.1.1 (2016-08-24)](NEWS.html#knot-resolver-1-1-1-2016-08-24)
    - [Bugfixes:](NEWS.html#id141)
    - [Improvements:](NEWS.html#id142)
  + [Knot Resolver 1.1.0 (2016-08-12)](NEWS.html#knot-resolver-1-1-0-2016-08-12)
    - [Improvements:](NEWS.html#id143)
  + [Knot Resolver 1.0.0 (2016-05-30)](NEWS.html#knot-resolver-1-0-0-2016-05-30)
    - [Initial release:](NEWS.html#initial-release)

Developers

* [Building from sources](build.html)
  + [Dependencies](build.html#dependencies)
    - [Packaged dependencies](build.html#packaged-dependencies)
  + [Compilation](build.html#compilation)
    - [Build options](build.html#build-options)
    - [Customizing compiler flags](build.html#customizing-compiler-flags)
  + [Tests](build.html#tests)
    - [Unit tests](build.html#unit-tests)
    - [Postinstall tests](build.html#postinstall-tests)
    - [Config tests](build.html#config-tests)
    - [Extra tests](build.html#extra-tests)
    - [Useful meson commands](build.html#useful-meson-commands)
  + [Documentation](build.html#documentation)
  + [Tarball](build.html#tarball)
  + [Packaging](build.html#packaging)
    - [Systemd](build.html#systemd)
    - [Trust anchors](build.html#trust-anchors)
  + [Docker image](build.html#docker-image)
* [Custom HTTP services](modules-http-custom-services.html)
  + [Custom RESTful services](modules-http-custom-services.html#custom-restful-services)
* [Knot Resolver library](lib.html)
  + [Requirements](lib.html#requirements)
  + [For users](lib.html#for-users)
  + [For developers](lib.html#for-developers)
  + [Writing layers](lib.html#writing-layers)
  + [APIs in Lua](lib.html#apis-in-lua)
    - [Elementary types and constants](lib.html#elementary-types-and-constants)
    - [Working with domain names](lib.html#working-with-domain-names)
    - [Working with resource records](lib.html#working-with-resource-records)
    - [Working with packets](lib.html#working-with-packets)
    - [Working with requests](lib.html#working-with-requests)
    - [Significant Lua API changes](lib.html#significant-lua-api-changes)
      * [Incompatible changes since 3.0.0](lib.html#incompatible-changes-since-3-0-0)
  + [API reference](lib.html#api-reference)
    - [Name resolution](lib.html#name-resolution)
      * [Example usage of the iterative API:](lib.html#resolve_8h_1autotoc_md2)
    - [Cache](lib.html#cache)
    - [Nameservers](lib.html#nameservers)
    - [Modules](lib.html#modules)
    - [Utilities](lib.html#utilities)
    - [Generics library](lib.html#generics-library)
      * [array](lib.html#array)
      * [queue](lib.html#queue)
      * [pack](lib.html#pack)
      * [lru](lib.html#lru)
      * [trie](lib.html#trie)
* [Modules API reference](modules_api.html)
  + [Supported languages](modules_api.html#supported-languages)
  + [The anatomy of an extension](modules_api.html#the-anatomy-of-an-extension)
  + [Writing a module in Lua](modules_api.html#writing-a-module-in-lua)
  + [Writing a module in C](modules_api.html#writing-a-module-in-c)
  + [Configuring modules](modules_api.html#configuring-modules)
  + [Exposing C module properties](modules_api.html#exposing-c-module-properties)
    - [Special properties](modules_api.html#special-properties)
* [Worker API reference](worker_api.html)

[Knot Resolver](index.html)

* [Policy, access control, data manipulation](config-policy.html)
* Query policies
* [View page source](_sources/modules-policy.rst.txt)

---

# Query policies[¶](#query-policies "Link to this heading")

This module can block, rewrite, or alter inbound queries based on user-defined policies. It does not affect queries generated by the resolver itself, e.g. when following CNAME chains etc.

Each policy *rule* has two parts: a *filter* and an *action*. A *filter* selects which queries will be affected by the policy, and *action* which modifies queries matching the associated filter.

Typically a rule is defined as follows: `filter(action(action parameters), filter parameters)`. For example, a filter can be `suffix` which matches queries whose suffix part is in specified set, and one of possible actions is [`policy.DENY`](#policy.DENY "policy.DENY"), which denies resolution. These are combined together into `policy.suffix(policy.DENY, {todname('badguy.example.')})`. The rule is effective when it is added into rule table using `policy.add()`, please see examples below.

This module is enabled by default because it implements mandatory [**RFC 6761**](https://datatracker.ietf.org/doc/html/rfc6761.html) logic.
When no rule applies to a query, built-in rules for [special-use](https://www.iana.org/assignments/special-use-domain-names/special-use-domain-names.xhtml) and [locally-served](http://www.iana.org/assignments/locally-served-dns-zones) domain names are applied.
These rules can be overridden by action [`policy.PASS`](#policy.PASS "policy.PASS"). For debugging purposes you can also add `modules.unload('policy')` to your config to unload the module.

## Filters[¶](#filters "Link to this heading")

A *filter* selects which queries will be affected by specified [Actions](#actions). There are several policy filters available in the `policy.` table:

policy.all(*action*)[¶](#policy.all "Link to this definition")

Always applies the action.

policy.pattern(*action*, *pattern*)[¶](#policy.pattern "Link to this definition")

Applies the action if query name matches a [Lua regular expression](http://lua-users.org/wiki/PatternsTutorial).

policy.suffix(*action*, *suffix\_table*)[¶](#policy.suffix "Link to this definition")

Applies the action if query name suffix matches one of suffixes in the table (useful for “is domain in zone” rules).

```
policy.add(policy.suffix(policy.DENY, policy.todnames({'example.com', 'example.net'})))

```

Note

For speed this filter requires domain names in DNS wire format, not textual representation, so each label in the name must be prefixed with its length. Always use convenience function [`policy.todnames()`](#policy.todnames "policy.todnames") for automatic conversion from strings! For example:

Note

Non-ASCII is not supported.

Knot Resolver does not provide any convenience support for IDN.
Therefore everywhere (all configuration, logs, RPZ files) you need to deal with the
[xn-- forms](https://en.wikipedia.org/wiki/Internationalized_domain_name#Example_of_IDNA_encoding)
of domain name labels, instead of directly using unicode characters.

policy.domains(*action*, *domain\_table*)[¶](#policy.domains "Link to this definition")

Like [`policy.suffix()`](#policy.suffix "policy.suffix") match, but the queried name must match exactly, not just its suffix.

policy.suffix\_common(*action*, *suffix\_table*[, *common\_suffix*])[¶](#policy.suffix_common "Link to this definition")
Parameters:

* **action** – action if the pattern matches query name
* **suffix\_table** – table of valid suffixes
* **common\_suffix** – common suffix of entries in suffix\_table

Like [`policy.suffix()`](#policy.suffix "policy.suffix") match, but you can also provide a common suffix of all matches for faster processing (nil otherwise).
This function is faster for small suffix tables (in the order of “hundreds”).

It is also possible to define custom filter function with any name.

policy.custom\_filter(*state*, *query*)[¶](#policy.custom_filter "Link to this definition")
Parameters:

* **state** – Request processing state [`kr_layer_state`](lib.html#c.kr_layer_state "kr_layer_state"), typically not used by filter function.
* **query** – Incoming DNS query as [`kr_query`](lib.html#c.kr_query "kr_query") structure.

Returns:

An [action](#actions) function or `nil` if filter did not match.

Typically filter function is generated by another function, which allows easy parametrization - this technique is called [closure](https://www.lua.org/pil/6.1.html). An practical example of such filter generator is:

```
function match_query_type(action, target_qtype)
    return function (state, query)
        if query.stype == target_qtype then
            -- filter matched the query, return action function
            return action
        else
            -- filter did not match, continue with next filter
            return nil
        end
    end
end

```

This custom filter can be used as any other built-in filter.
For example this applies our custom filter and executes action [`policy.DENY`](#policy.DENY "policy.DENY") on all queries of type HINFO:

```
-- custom filter which matches HINFO queries, action is policy.DENY
policy.add(match_query_type(policy.DENY, kres.type.HINFO))

```

## Actions[¶](#actions "Link to this heading")

An *action* is a function which modifies DNS request, and is either of type *chain* or *non-chain*:

> * [Non-chain actions](#non-chain-actions) modify state of the request and stop rule processing. An example of such action is [Forwarding](#forwarding).
> * [Chain actions](#chain-actions) modify state of the request and allow other rules to evaluate and act on the same request. One such example is [`policy.MIRROR()`](#policy.MIRROR "policy.MIRROR").

### Non-chain actions[¶](#non-chain-actions "Link to this heading")

Following actions stop the policy matching on the query, i.e. other rules are not evaluated once rule with following actions matches:

policy.PASS[¶](#policy.PASS "Link to this definition")

Let the query pass through; it’s useful to make exceptions before wider rules. For example:

More specific whitelist rule must precede generic blacklist rule:

```
-- Whitelist 'good.example.com'
policy.add(policy.pattern(policy.PASS, todname('good.example.com.')))
-- Block all names below example.com
policy.add(policy.suffix(policy.DENY, {todname('example.com.')}))

```

policy.DENY[¶](#policy.DENY "Link to this definition")

Deny existence of names matching filter, i.e. reply NXDOMAIN authoritatively.

policy.DENY\_MSG(*message*[, *extended\_error=kres.extended\_error.BLOCKED*])[¶](#policy.DENY_MSG "Link to this definition")

Deny existence of a given domain and add explanatory message. NXDOMAIN reply
contains an additional explanatory message as TXT record in the additional
section.

You may override the extended DNS error to provide the user with more
information. By default, `BLOCKED` is returned to indicate the domain is
blocked due to the internal policy of the operator. Other suitable error
codes are `CENSORED` (for externally imposed policy reasons) or
`FILTERED` (for blocking requested by the client). For more information,
please refer to [**RFC 8914**](https://datatracker.ietf.org/doc/html/rfc8914.html).

policy.DROP[¶](#policy.DROP "Link to this definition")

Terminate query resolution and return SERVFAIL to the requestor.

policy.REFUSE[¶](#policy.REFUSE "Link to this definition")

Terminate query resolution and return REFUSED to the requestor.

policy.NO\_ANSWER[¶](#policy.NO_ANSWER "Link to this definition")

Terminate query resolution and do not return any answer to the requestor.

Warning

During normal operation, an answer should always be returned.
Deliberate query drops are indistinguishable from packet loss and may
cause problems as described in [**RFC 8906**](https://datatracker.ietf.org/doc/html/rfc8906.html). Only use [`NO_ANSWER`](#policy.NO_ANSWER "policy.NO_ANSWER")
on very specific occasions, e.g. as a defense mechanism during an attack,
and prefer other actions (e.g. [`DROP`](#policy.DROP "policy.DROP") or [`REFUSE`](#policy.REFUSE "policy.REFUSE")) for normal
operation.

policy.TC[¶](#policy.TC "Link to this definition")

Force requestor to use TCP. It sets truncated bit (*TC*) in response to true if the request came through UDP, which will force standard-compliant clients to retry the request over TCP.

policy.REROUTE(*{subnet = target*, *...}*)[¶](#policy.REROUTE "Link to this definition")

Reroute IP addresses in response matching given subnet to given target, e.g. `{['192.0.2.0/24'] = '127.0.0.0'}` will rewrite ‘192.0.2.55’ to ‘127.0.0.55’, see [renumber module](modules-renumber.html#mod-renumber) for more information. See [`policy.add()`](#policy.add "policy.add") and do not forget to specify that this is *postrule*. Quick example:

```
-- this policy is enforced on answers
-- therefore we have to use 'postrule'
-- (the "true" at the end of policy.add)
policy.add(policy.all(policy.REROUTE({['192.0.2.0/24'] = '127.0.0.0'})), true)

```

policy.ANSWER(*{ type = { rdata=data, [ttl=1] } }, [nodata=false]*)[¶](#policy.ANSWER "Link to this definition")

Overwrite Resource Records in responses with specified values.

> * type
>   - RR type to be replaced, e.g. `[kres.type.A]` or [numeric value](https://www.iana.org/assignments/dns-parameters/dns-parameters.xhtml#dns-parameters-4).
> * rdata
>   - RR data in DNS wire format, i.e. binary form specific for given RR type. Set of multiple RRs can be specified as table `{ rdata1, rdata2, ... }`. Use helper function `kres.str2ip()` to generate wire format for A and AAAA records. Wire format for other record types can be generated with [`kres.parse_rdata()`](#policy.kres.parse_rdata "policy.kres.parse_rdata").
> * ttl
>   - TTL in seconds. Default: 1 second.
> * nodata
>   - If type requested by client is not configured in this policy:
>
>   > + `true`: Return empty answer (NODATA).
>   > + `false`: Ignore this policy and continue processing other rules.
>   >
>   > Default: `false`.

```
-- policy to change IPv4 address and TTL for example.com
policy.add(
    policy.domains(
        policy.ANSWER(
            { [kres.type.A] = { rdata=kres.str2ip('192.0.2.7'), ttl=300 } }
        ), { todname('example.com') }))
-- policy to generate two TXT records (specified in binary format) for example.net
policy.add(
    policy.domains(
        policy.ANSWER(
            { [kres.type.TXT] = { rdata={'\005first', '\006second'}, ttl=5 } }
        ), { todname('example.net') }))

```

kres.parse\_rdata(*{str*, *...}*)[¶](#policy.kres.parse_rdata "Link to this definition")

Parse string representation of RTYPE and RDATA into RDATA wire format. Expects
a table of string(s) and returns a table of wire data.

```
-- create wire format RDATA that can be passed to policy.ANSWER
kres.parse_rdata({'SVCB 1 resolver.example. alpn=dot'})
kres.parse_rdata({
   'SVCB 1 resolver.example. alpn=dot ipv4hint=192.0.2.1 ipv6hint=2001:db8::1',
   'SVCB 2 resolver.example. mandatory=key65380 alpn=h2 key65380=/dns-query{?dns}',
})

```

More complex non-chain actions are described in their own chapters, namely:

> * [Forwarding](#forwarding)
> * [Response Policy Zones](#response-policy-zones)

### Chain actions[¶](#chain-actions "Link to this heading")

Following actions act on request and then processing continue until first non-chain action (specified in the previous section) is triggered:

policy.MIRROR(*ip\_address*)[¶](#policy.MIRROR "Link to this definition")

Send copy of incoming DNS queries to a given IP address using DNS-over-UDP and continue resolving them as usual. This is useful for sanity testing new versions of DNS resolvers.

```
policy.add(policy.all(policy.MIRROR('127.0.0.2')))

```

policy.FLAGS(*set*, *clear*)[¶](#policy.FLAGS "Link to this definition")

Set and/or clear some flags for the query. There can be multiple flags to set/clear. You can just pass a single flag name (string) or a set of names. Flag names correspond to [`kr_qflags`](lib.html#c.kr_qflags "kr_qflags") structure. Use only if you know what you are doing.

### Actions for extra logging[¶](#actions-for-extra-logging "Link to this heading")

These are also “chain” actions, i.e. they don’t stop processing the policy rule list.
Similarly to other actions, they apply during whole processing of the client’s request,
i.e. including any sub-queries.

The log lines from these policy actions are tagged by extra `[reqdbg]` prefix,
and they are produced regardless of your [`log_level()`](config-logging-monitoring.html#log_level "log_level") setting.
They are marked as `debug` level, so e.g. with journalctl command you can use `-p info` to skip them.

Warning

Beware of producing too much logs.

These actions are not suitable for use on a large fraction of resolver’s requests.
The extra logs have significant performance impact and might also overload your logging system
(or get rate-limited by it).
You can use [Filters](#filters) to further limit on which requests this happens.

policy.DEBUG\_ALWAYS[¶](#policy.DEBUG_ALWAYS "Link to this definition")

Print debug-level logging for this request.
That also includes messages from client ([`REQTRACE`](#policy.REQTRACE "policy.REQTRACE")), upstream servers ([`QTRACE`](#policy.QTRACE "policy.QTRACE")), and stats about interesting records at the end.

```
-- debug requests that ask for flaky.example.net or below
policy.add(policy.suffix(policy.DEBUG_ALWAYS,
    policy.todnames({'flaky.example.net'})))

```

policy.DEBUG\_CACHE\_MISS[¶](#policy.DEBUG_CACHE_MISS "Link to this definition")

Same as [`DEBUG_ALWAYS`](#policy.DEBUG_ALWAYS "policy.DEBUG_ALWAYS") but only if the request required information which was not available locally, i.e. requests which forced resolver to ask upstream server(s).
Intended usage is for debugging problems with remote servers.

policy.DEBUG\_IF(*test\_function*)[¶](#policy.DEBUG_IF "Link to this definition")
Parameters:

**test\_function** – Function with single argument of type [`kr_request`](lib.html#c.kr_request "kr_request") which returns `true` if debug logs for that request should be generated and `false` otherwise.

Same as [`DEBUG_ALWAYS`](#policy.DEBUG_ALWAYS "policy.DEBUG_ALWAYS") but only logs if the test\_function says so.

Note

`test_function` is evaluated only when request is finished.
As a result all debug logs this request must be collected,
and at the end they get either printed or thrown away.

Example usage which gathers verbose logs for all requests in subtree `dnssec-failed.org.` and prints debug logs for those finishing in a different state than `kres.DONE` (most importantly `kres.FAIL`, see [`kr_layer_state`](lib.html#c.kr_layer_state "kr_layer_state")).

```
policy.add(policy.suffix(
    policy.DEBUG_IF(function(req)
                        return (req.state ~= kres.DONE)
                    end),
    policy.todnames({'dnssec-failed.org.'})))

```

policy.QTRACE[¶](#policy.QTRACE "Link to this definition")

Pretty-print DNS responses from upstream servers (or cache) into logs.
It’s useful for debugging weird DNS servers.

If you do not use `QTRACE` in combination with `DEBUG*`,
you additionally need either `log_groups({'iterat'})` (possibly with other groups)
or `log_level('debug')` to see the output in logs.

policy.REQTRACE[¶](#policy.REQTRACE "Link to this definition")

Pretty-print DNS requests from clients into the verbose log. It’s useful for debugging weird DNS clients.
It makes most sense together with [Views and ACLs](modules-view.html#mod-view) (enabling per-client)
and probably with verbose logging those request (e.g. use [`DEBUG_ALWAYS`](#policy.DEBUG_ALWAYS "policy.DEBUG_ALWAYS") instead).

policy.IPTRACE[¶](#policy.IPTRACE "Link to this definition")

Log how the request arrived.
Most notably, this includes the client’s IP address, so beware of privacy implications.

```
-- example usage in configuration
policy.add(policy.all(policy.IPTRACE))
-- you might want to combine it with some other logs, e.g.
policy.add(policy.all(policy.DEBUG_ALWAYS))

```

```
-- example log lines from IPTRACE:
[reqdbg][policy][57517.00] request packet arrived from ::1#37931 to ::1#00853 (TCP + TLS)
[reqdbg][policy][65538.00] request packet arrived internally

```

### Custom actions[¶](#custom-actions "Link to this heading")

policy.custom\_action(*state*, *request*)[¶](#policy.custom_action "Link to this definition")
Parameters:

* **state** – Request processing state [`kr_layer_state`](lib.html#c.kr_layer_state "kr_layer_state").
* **request** – Current DNS request as [`kr_request`](lib.html#c.kr_request "kr_request") structure.

Returns:

Returning a new [`kr_layer_state`](lib.html#c.kr_layer_state "kr_layer_state") prevents evaluating other policy rules. Returning `nil` creates a [chain action](#actions) and allows to continue evaluating other rules.

This is real example of an action function:

```
-- Custom action which generates fake A record
local ffi = require('ffi')
local function fake_A_record(state, req)
    local answer = req:ensure_answer()
    if answer == nil then return nil end
    local qry = req:current()
    if qry.stype ~= kres.type.A then
        return state
    end
    ffi.C.kr_pkt_make_auth_header(answer)
    answer:rcode(kres.rcode.NOERROR)
    answer:begin(kres.section.ANSWER)
    answer:put(qry.sname, 900, answer:qclass(), kres.type.A, '\192\168\1\3')
    return kres.DONE
end

```

This custom action can be used as any other built-in action.
For example this applies our *fake A record action* and executes it on all queries in subtree `example.net`:

```
policy.add(policy.suffix(fake_A_record, policy.todnames({'example.net'})))

```

The action function can implement arbitrary logic so it is possible to implement complex heuristics, e.g. to deflect [Slow drip DNS attacks](https://secure64.com/water-torture-slow-drip-dns-ddos-attack) or gray-list resolution of misbehaving zones.

Warning

The policy module currently only looks at whole DNS requests. The rules won’t be re-applied e.g. when following CNAMEs.

## Forwarding[¶](#forwarding "Link to this heading")

Forwarding action alters behavior for cache-miss events. If an information is missing in the local cache the resolver will *forward* the query to *another DNS resolver* for resolution (instead of contacting authoritative servers directly). DNS answers from the remote resolver are then processed locally and sent back to the original client.

Actions [`policy.FORWARD()`](#policy.FORWARD "policy.FORWARD"), [`policy.TLS_FORWARD()`](#policy.TLS_FORWARD "policy.TLS_FORWARD") and [`policy.STUB()`](#policy.STUB "policy.STUB") accept up to four IP addresses at once and the resolver will automatically select IP address which statistically responds the fastest.

policy.FORWARD(*ip\_address*)[¶](#policy.FORWARD "Link to this definition")
policy.FORWARD(*{ ip\_address, [ip\_address, ...] }*)

Forward cache-miss queries to specified IP addresses (without encryption), DNSSEC validate received answers and cache them. Target IP addresses are expected to be DNS resolvers.

```
-- Forward all queries to public resolvers https://www.nic.cz/odvr
policy.add(policy.all(
   policy.FORWARD(
       {'2001:148f:fffe::1', '2001:148f:ffff::1',
        '185.43.135.1', '193.14.47.1'})))

```

A variant which uses encrypted DNS-over-TLS transport is called [`policy.TLS_FORWARD()`](#policy.TLS_FORWARD "policy.TLS_FORWARD"), please see section [Forwarding over TLS protocol (DNS-over-TLS)](#tls-forwarding).

policy.STUB(*ip\_address*)[¶](#policy.STUB "Link to this definition")
policy.STUB(*{ ip\_address, [ip\_address, ...] }*)

Similar to [`policy.FORWARD()`](#policy.FORWARD "policy.FORWARD") but *without* attempting DNSSEC validation.
Each request may be either answered from cache or simply sent to one of the IPs with proxying back the answer.

This mode does not support encryption and should be used only for [Replacing part of the DNS tree](#replacing-part-of-the-dns-tree).
Use [`policy.FORWARD()`](#policy.FORWARD "policy.FORWARD") mode if possible.

```
-- Answers for reverse queries about the 192.168.1.0/24 subnet
-- are to be obtained from IP address 192.0.2.1 port 5353
-- This disables DNSSEC validation!
policy.add(policy.suffix(
    policy.STUB('192.0.2.1@5353'),
    {todname('1.168.192.in-addr.arpa')}))

```

Note

By default, forwarding targets must support
[EDNS](https://en.wikipedia.org/wiki/Extension_mechanisms_for_DNS) and
[0x20 randomization](https://tools.ietf.org/html/draft-vixie-dnsext-dns0x20-00).
See example in [Replacing part of the DNS tree](#replacing-part-of-the-dns-tree).

Warning

Limiting forwarding actions by filters (e.g. [`policy.suffix()`](#policy.suffix "policy.suffix")) may have unexpected consequences.
Notably, forwarders can inject *any* records into your cache
even if you “restrict” them to an insignificant DNS subtree –
except in cases where DNSSEC validation applies, of course.

The behavior is probably best understood through the fact
that filters and actions are completely decoupled.
The forwarding actions have no clue about why they were executed,
e.g. that the user wanted to restrict the forwarder only to some subtree.
The action just selects some set of forwarders to process this whole request from the client,
and during that processing it might need some other “sub-queries” (e.g. for validation).
Some of those might not’ve passed the intended filter,
but policy rule-set only applies once per client’s request.

## Forwarding over TLS protocol (DNS-over-TLS)[¶](#forwarding-over-tls-protocol-dns-over-tls "Link to this heading")

policy.TLS\_FORWARD(*{ {ip\_address, authentication}, [...] }* )[¶](#policy.TLS_FORWARD "Link to this definition")

Same as [`policy.FORWARD()`](#policy.FORWARD "policy.FORWARD") but send query over DNS-over-TLS protocol (encrypted).
Each target IP address needs explicit configuration how to validate
TLS certificate so each IP address is configured by pair:
`{ip_address, authentication}`. See sections below for more details.

Policy [`policy.TLS_FORWARD()`](#policy.TLS_FORWARD "policy.TLS_FORWARD") allows you to forward queries using [Transport Layer Security](https://en.wikipedia.org/wiki/Transport_Layer_Security) protocol, which hides the content of your queries from an attacker observing the network traffic. Further details about this protocol can be found in [**RFC 7858**](https://datatracker.ietf.org/doc/html/rfc7858.html) and [IETF draft dprive-dtls-and-tls-profiles](https://tools.ietf.org/html/draft-ietf-dprive-dtls-and-tls-profiles).

Queries affected by [`policy.TLS_FORWARD()`](#policy.TLS_FORWARD "policy.TLS_FORWARD") will always be resolved over TLS connection. Knot Resolver does not implement fallback to non-TLS connection, so if TLS connection cannot be established or authenticated according to the configuration, the resolution will fail.

To test this feature you need to either [configure Knot Resolver as DNS-over-TLS server](daemon-bindings-net_tlssrv.html#tls-server-config), or pick some public DNS-over-TLS server. Please see [DNS Privacy Project](https://dnsprivacy.org/) homepage for list of public servers.

Note

Some public DNS-over-TLS providers may apply rate-limiting which
makes their service incompatible with Knot Resolver’s TLS forwarding.
Notably, [Google Public DNS](https://developers.google.com/speed/public-dns/docs/dns-over-tls) doesn’t
work as of 2019-07-10.

When multiple servers are specified, the one with the lowest round-trip time is used.

### CA+hostname authentication[¶](#ca-hostname-authentication "Link to this heading")

Traditional PKI authentication requires server to present certificate with specified hostname, which is issued by one of trusted CAs. Example policy is:

```
policy.TLS_FORWARD({
    {'2001:DB8::d0c', hostname='res.example.com'}})

```

* `hostname` must be a valid domain name matching server’s certificate. It will also be sent to the server as [SNI](https://en.wikipedia.org/wiki/Server_Name_Indication).
* `ca_file` optionally contains a path to a CA certificate (or certificate bundle) in [PEM format](https://en.wikipedia.org/wiki/Privacy-enhanced_Electronic_Mail).
  If you omit that, the system CA certificate store will be used instead (usually sufficient).
  A list of paths is also accepted, but all of them must be valid PEMs.

### Key-pinned authentication[¶](#key-pinned-authentication "Link to this heading")

Instead of CAs, you can specify hashes of accepted certificates in `pin_sha256`.
They are in the usual format – base64 from sha256.
You may still specify `hostname` if you want [SNI](https://en.wikipedia.org/wiki/Server_Name_Indication) to be sent.

### TLS Examples[¶](#tls-examples "Link to this heading")

```
modules = { 'policy' }
-- forward all queries over TLS to the specified server
policy.add(policy.all(policy.TLS_FORWARD({{'192.0.2.1', pin_sha256='YQ=='}})))
-- for brevity, other TLS examples omit policy.add(policy.all())
-- single server authenticated using its certificate pin_sha256
policy.TLS_FORWARD({{'192.0.2.1', pin_sha256='YQ=='}})  -- pin_sha256 is base64-encoded
-- single server authenticated using hostname and system-wide CA certificates
policy.TLS_FORWARD({{'192.0.2.1', hostname='res.example.com'}})
-- single server using non-standard port
policy.TLS_FORWARD({{'192.0.2.1@443', pin_sha256='YQ=='}})  -- use @ or # to specify port
-- single server with multiple valid pins (e.g. anycast)
policy.TLS_FORWARD({{'192.0.2.1', pin_sha256={'YQ==', 'Wg=='}})
-- multiple servers, each with own authenticator
policy.TLS_FORWARD({ -- please note that { here starts list of servers
    {'192.0.2.1', pin_sha256='Wg=='},
    -- server must present certificate issued by specified CA and hostname must match
    {'2001:DB8::d0c', hostname='res.example.com', ca_file='/etc/knot-resolver/tlsca.crt'}
})

```

### Forwarding to multiple targets[¶](#forwarding-to-multiple-targets "Link to this heading")

With the use of [`policy.slice()`](#policy.slice "policy.slice") function, it is possible to split the
entire DNS namespace into distinct slices. When used in conjunction with
[`policy.TLS_FORWARD()`](#policy.TLS_FORWARD "policy.TLS_FORWARD"), it’s possible to forward different queries to
different targets.

policy.slice(*slice\_func, action[, action[, ...]*)[¶](#policy.slice "Link to this definition")
Parameters:

* **slice\_func** – slicing function that returns index based on query
* **action** – action to be performed for the slice

This function splits the entire domain space into multiple slices (determined
by the number of provided `actions`). A `slice_func` is called to determine
which slice a query belongs to. The corresponding `action` is then executed.

policy.slice\_randomize\_psl(*seed=os.time() / 3600 \* 24 \* 7*)[¶](#policy.slice_randomize_psl "Link to this definition")
Parameters:

**seed** – seed for random assignment

The function initializes and returns a slicing function, which
deterministically assigns `query` to a slice based on the query name.

It utilizes the [Public Suffix List](https://publicsuffix.org) to ensure domains under the same
registrable domain end up in a single slice. (see example below)

`seed` can be used to re-shuffle the slicing algorithm when the slicing
function is initialized. By default, the assignment is re-shuffled after one
week (when resolver restart / reloads config). To force a stable
distribution, pass a fixed value. To re-shuffle on every resolver restart,
use `os.time()`.

The following example demonstrates a distribution among 3 slices:

```
slice 1/3:
example.com
a.example.com
b.example.com
x.b.example.com
example3.com

slice 2/3:
example2.co.uk

slice 3/3:
example.co.uk
a.example.co.uk

```

These two functions can be used together to forward queries for names
in different parts of DNS name space to different target servers:

```
policy.add(policy.slice(
    policy.slice_randomize_psl(),
    policy.TLS_FORWARD({{'192.0.2.1', hostname='res.example.com'}}),
    policy.TLS_FORWARD({
        -- multiple servers can be specified for a single slice
        -- the one with lowest round-trip time will be used
        {'193.17.47.1', hostname='odvr.nic.cz'},
        {'185.43.135.1', hostname='odvr.nic.cz'},
    })
))

```

Note

The privacy implications of using this feature aren’t clear. Since
websites often make requests to multiple domains, these might be forwarded
to different targets. This could result in decreased privacy (e.g. when the
remote targets are both logging or otherwise processing your DNS traffic).
The intended use-case is to use this feature with semi-trusted resolvers
which claim to do no logging (such as those listed on [dnsprivacy.org](https://dnsprivacy.org/wiki/display/DP/DNS%2BPrivacy%2BTest%2BServers)), to
decrease the potential exposure of your DNS data to a malicious resolver
operator.

## Replacing part of the DNS tree[¶](#replacing-part-of-the-dns-tree "Link to this heading")

Following procedure applies only to domains which have different content
publicly and internally. For example this applies to “your own” top-level domain
`example.` which does not exist in the public (global) DNS namespace.

Dealing with these internal-only domains requires extra configuration because
DNS was designed as “single namespace” and local modifications like adding
your own TLD break this assumption.

Warning

Use of internal names which are not delegated from the public DNS
*is causing technical problems* with caching and DNSSEC validation
and generally makes DNS operation more costly.
We recommend **against** using these non-delegated names.

To make such internal domain available in your resolver it is necessary to
*graft* your domain onto the public DNS namespace,
but *grafting* creates new issues:

These *grafted* domains will be rejected by DNSSEC validation
because such domains are technically indistinguishable from an spoofing attack
against the public DNS.
Therefore, if you trust the remote resolver which hosts the internal-only domain,
and you trust your link to it, you need to use the [`policy.STUB()`](#policy.STUB "policy.STUB") policy
instead of [`policy.FORWARD()`](#policy.FORWARD "policy.FORWARD") to disable DNSSEC validation for those
*grafted* domains.

Example configuration grafting domains onto public DNS namespace[¶](#id5 "Link to this code")
```
extraTrees = policy.todnames(
    {'faketldtest.',
     'sld.example.',
     'internal.example.com.',
     '2.0.192.in-addr.arpa.'  -- this applies to reverse DNS tree as well
     })
-- Beware: the rule order is important, as policy.STUB is not a chain action.
-- Flags: for "dumb" targets disabling EDNS can help (below) as DNSSEC isn't
-- validated anyway; in some of those cases adding 'NO_0X20' can also help,
-- though it also lowers defenses against off-path attacks on communication
-- between the two servers.
-- With kresd <= 5.5.3 you also needed 'NO_CACHE' flag to avoid unintentional
-- NXDOMAINs that could sometimes happen due to aggressive DNSSEC caching.
policy.add(policy.suffix(policy.FLAGS({'NO_EDNS'}), extraTrees))
policy.add(policy.suffix(policy.STUB({'2001:db8::1'}), extraTrees))

```

## Response policy zones[¶](#response-policy-zones "Link to this heading")

> Warning
>
> There is no published Internet Standard for [RPZ](https://dnsrpz.info/) and implementations vary.
> At the moment Knot Resolver supports limited subset of RPZ format and deviates
> from implementation in BIND. Nevertheless it is good enough
> for blocking large lists of spam or advertising domains.
>
> The RPZ file format is basically a DNS zone file with *very special* semantics.
> For example:
>
> ```
> ; left hand side          ; TTL and class  ; right hand side
> ; encodes RPZ trigger     ; ignored        ; encodes action
> ; (i.e. filter)
> blocked.domain.example    600 IN           CNAME .           ; block main domain
> *.blocked.domain.example  600 IN           CNAME .           ; block subdomains
>
> ```
>
> The only “trigger” supported in Knot Resolver is query name,
> i.e. left hand side must be a domain name which triggers the action specified
> on the right hand side.
>
> Subset of possible RPZ actions is supported, namely:
>
> | RPZ Right Hand Side | Knot Resolver Action | BIND Compatibility |
> | --- | --- | --- |
> | `.` | `action` is used | compatible if `action` is [`policy.DENY`](#policy.DENY "policy.DENY") |
> | `*.` | [`policy.ANSWER()`](#policy.ANSWER "policy.ANSWER") | yes |
> | `rpz-passthru.` | [`policy.PASS`](#policy.PASS "policy.PASS") | yes |
> | `rpz-tcp-only.` | [`policy.TC`](#policy.TC "policy.TC") | yes |
> | `rpz-drop.` | [`policy.DROP`](#policy.DROP "policy.DROP") | no [[1]](#id4) |
> | fake A/AAAA | [`policy.ANSWER()`](#policy.ANSWER "policy.ANSWER") | yes |
> | fake CNAME | not supported | no |
>
> [[1](#id3)]
>
> Our [`policy.DROP`](#policy.DROP "policy.DROP") returns *SERVFAIL* answer (for historical reasons).
>
>
>
> Note
>
> To debug which domains are affected by RPZ (or other policy actions), you can enable the `policy` log group:
>
> ```
> log_groups({'policy'})
>
> ```
>
> See also [non-ASCII support note](#idn).

policy.rpz(*action*, *path*[, *watch = true*])[¶](#policy.rpz "Link to this definition")
Parameters:

* **action** – the default action for match in the zone; typically you want [`policy.DENY`](#policy.DENY "policy.DENY")
* **path** – path to zone file
* **watch** – boolean, if true, the file will be reloaded on file change

Enforce [RPZ](https://dnsrpz.info/) rules. This can be used in conjunction with published blocklist feeds.
The [RPZ](https://dnsrpz.info/) operation is well described in this [Jan-Piet Mens’s post](http://jpmens.net/2011/04/26/how-to-configure-your-bind-resolvers-to-lie-using-response-policy-zones-rpz/),
or the [Pro DNS and BIND](http://www.zytrax.com/books/dns/ch7/rpz.html) book.

For example, we can store the example snippet with domain `blocked.domain.example`
(above) into file `/etc/knot-resolver/blocklist.rpz` and configure resolver to
answer with *NXDOMAIN* plus the specified additional text to queries for this domain:

```
policy.add(
    policy.rpz(policy.DENY_MSG('domain blocked by your resolver operator'),
               '/etc/knot-resolver/blocklist.rpz',
               true))

```

Resolver will reload RPZ file at run-time if the RPZ file changes.
Recommended RPZ update procedure is to store new blocklist in a new file
(*newblocklist.rpz*) and then rename the new file to the original file name
(*blocklist.rpz*). This avoids problems where resolver might attempt
to re-read an incomplete file.

## Additional properties[¶](#additional-properties "Link to this heading")

Most properties (actions, filters) are described above.

policy.add(*rule*, *postrule*)[¶](#policy.add "Link to this definition")
Parameters:

* **rule** – added rule, i.e. `policy.pattern(policy.DENY, '[0-9]+\2cz')`
* **postrule** – boolean, if true the rule will be evaluated on answer instead of query

Returns:

rule description

Add a new policy rule that is executed either or queries or answers, depending on the `postrule` parameter. You can then use the returned rule description to get information and unique identifier for the rule, as well as match count.

```
-- mirror all queries, keep handle so we can retrieve information later
local rule = policy.add(policy.all(policy.MIRROR('127.0.0.2')))
-- we can print statistics about this rule any time later
print(string.format('id: %d, matched queries: %d', rule.id, rule.count)

```

policy.del(*id*)[¶](#policy.del "Link to this definition")
Parameters:

**id** – identifier of a given rule returned by [`policy.add()`](#policy.add "policy.add")

Returns:

boolean `true` if rule was deleted, `false` otherwise

Remove a rule from policy list.

policy.todnames(*{name*, *...}*)[¶](#policy.todnames "Link to this definition")
Param:

names table of domain names in textual format

Returns table of domain names in wire format converted from strings.

```
-- Convert single name
assert(todname('example.com') == '\7example\3com\0')
-- Convert table of names
policy.todnames({'example.com', 'me.cz'})
{ '\7example\3com\0', '\2me\2cz\0' }

```

 [Previous](config-policy.html "Policy, access control, data manipulation")
[Next](modules-view.html "Views and ACLs")

---

© Copyright CZ.NIC labs.
Revision `2a11145c`.

Built with [Sphinx](https://www.sphinx-doc.org/) using a
[theme](https://github.com/readthedocs/sphinx_rtd_theme)
provided by [Read the Docs](https://readthedocs.org).


