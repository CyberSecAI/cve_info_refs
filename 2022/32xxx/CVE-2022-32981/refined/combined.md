=== Content from git.kernel.org_44d426bc_20250114_191308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/powerpc/linux.git](/pub/scm/linux/kernel/git/powerpc/linux.git/) | fixes fixes-test master merge next next-test topic/ppc-kvm topic/vdso |
| --- | --- | --- |
| The powerpc tree | PowerPC group |

| [about](/pub/scm/linux/kernel/git/powerpc/linux.git/about/)[summary](/pub/scm/linux/kernel/git/powerpc/linux.git/)[refs](/pub/scm/linux/kernel/git/powerpc/linux.git/refs/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)[log](/pub/scm/linux/kernel/git/powerpc/linux.git/log/)[tree](/pub/scm/linux/kernel/git/powerpc/linux.git/tree/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)[commit](/pub/scm/linux/kernel/git/powerpc/linux.git/commit/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)[diff](/pub/scm/linux/kernel/git/powerpc/linux.git/diff/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)[stats](/pub/scm/linux/kernel/git/powerpc/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2022-06-07 00:34:56 +1000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2022-06-09 23:32:56 +1000 |
| commit | [8e1278444446fc97778a5e5c99bca1ce0bbc5ec9](/pub/scm/linux/kernel/git/powerpc/linux.git/commit/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9) ([patch](/pub/scm/linux/kernel/git/powerpc/linux.git/patch/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)) | |
| tree | [e4d6eecf9501b7cbddcac0b5e3e658384b97a271](/pub/scm/linux/kernel/git/powerpc/linux.git/tree/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9) | |
| parent | [7ad4bd887d27c6b6ffbef216f19c19f8fe2b8f52](/pub/scm/linux/kernel/git/powerpc/linux.git/commit/?id=7ad4bd887d27c6b6ffbef216f19c19f8fe2b8f52) ([diff](/pub/scm/linux/kernel/git/powerpc/linux.git/diff/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9&id2=7ad4bd887d27c6b6ffbef216f19c19f8fe2b8f52)) | |
| download | [linux-8e1278444446fc97778a5e5c99bca1ce0bbc5ec9.tar.gz](/pub/scm/linux/kernel/git/powerpc/linux.git/snapshot/linux-8e1278444446fc97778a5e5c99bca1ce0bbc5ec9.tar.gz) | |

powerpc/32: Fix overread/overwrite of thread\_struct via ptrace[powerpc-5.19-2](/pub/scm/linux/kernel/git/powerpc/linux.git/tag/?h=powerpc-5.19-2)The ptrace PEEKUSR/POKEUSR (aka PEEKUSER/POKEUSER) API allows a process
to read/write registers of another process.
To get/set a register, the API takes an index into an imaginary address
space called the "USER area", where the registers of the process are
laid out in some fashion.
The kernel then maps that index to a particular register in its own data
structures and gets/sets the value.
The API only allows a single machine-word to be read/written at a time.
So 4 bytes on 32-bit kernels and 8 bytes on 64-bit kernels.
The way floating point registers (FPRs) are addressed is somewhat
complicated, because double precision float values are 64-bit even on
32-bit CPUs. That means on 32-bit kernels each FPR occupies two
word-sized locations in the USER area. On 64-bit kernels each FPR
occupies one word-sized location in the USER area.
Internally the kernel stores the FPRs in an array of u64s, or if VSX is
enabled, an array of pairs of u64s where one half of each pair stores
the FPR. Which half of the pair stores the FPR depends on the kernel's
endianness.
To handle the different layouts of the FPRs depending on VSX/no-VSX and
big/little endian, the TS\_FPR() macro was introduced.
Unfortunately the TS\_FPR() macro does not take into account the fact
that the addressing of each FPR differs between 32-bit and 64-bit
kernels. It just takes the index into the "USER area" passed from
userspace and indexes into the fp\_state.fpr array.
On 32-bit there are 64 indexes that address FPRs, but only 32 entries in
the fp\_state.fpr array, meaning the user can read/write 256 bytes past
the end of the array. Because the fp\_state sits in the middle of the
thread\_struct there are various fields than can be overwritten,
including some pointers. As such it may be exploitable.
It has also been observed to cause systems to hang or otherwise
misbehave when using gdbserver, and is probably the root cause of this
report which could not be easily reproduced:
https://lore.kernel.org/linuxppc-dev/dc38afe9-6b78-f3f5-666b-986939e40fc6@keymile.com/
Rather than trying to make the TS\_FPR() macro even more complicated to
fix the bug, or add more macros, instead add a special-case for 32-bit
kernels. This is more obvious and hopefully avoids a similar bug
happening again in future.
Note that because 32-bit kernels never have VSX enabled the code doesn't
need to consider TS\_FPRWIDTH/OFFSET at all. Add a BUILD\_BUG\_ON() to
ensure that 32-bit && VSX is never enabled.
Fixes: 87fec0514f61 ("powerpc: PTRACE\_PEEKUSR/PTRACE\_POKEUSER of FPR registers in little endian builds")
Cc: stable@vger.kernel.org # v3.13+
Reported-by: Ariel Miculas <ariel.miculas@belden.com>
Tested-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/20220609133245.573565-1-mpe@ellerman.id.au](https://lore.kernel.org/r/20220609133245.573565-1-mpe%40ellerman.id.au)
[Diffstat](/pub/scm/linux/kernel/git/powerpc/linux.git/diff/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)

| -rw-r--r-- | [arch/powerpc/kernel/ptrace/ptrace-fpu.c](/pub/scm/linux/kernel/git/powerpc/linux.git/diff/arch/powerpc/kernel/ptrace/ptrace-fpu.c?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/ptrace/ptrace.c](/pub/scm/linux/kernel/git/powerpc/linux.git/diff/arch/powerpc/kernel/ptrace/ptrace.c?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 17 insertions, 6 deletions

| diff --git a/arch/powerpc/kernel/ptrace/ptrace-fpu.c b/arch/powerpc/kernel/ptrace/ptrace-fpu.cindex 5dca19361316e4..09c49632bfe592 100644--- a/[arch/powerpc/kernel/ptrace/ptrace-fpu.c](/pub/scm/linux/kernel/git/powerpc/linux.git/tree/arch/powerpc/kernel/ptrace/ptrace-fpu.c?id=7ad4bd887d27c6b6ffbef216f19c19f8fe2b8f52)+++ b/[arch/powerpc/kernel/ptrace/ptrace-fpu.c](/pub/scm/linux/kernel/git/powerpc/linux.git/tree/arch/powerpc/kernel/ptrace/ptrace-fpu.c?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)@@ -17,9 +17,13 @@ int ptrace\_get\_fpr(struct task\_struct \*child, int index, unsigned long \*data)  #ifdef CONFIG\_PPC\_FPU\_REGS flush\_fp\_to\_thread(child);- if (fpidx < (PT\_FPSCR - PT\_FPR0))- memcpy(data, &child->thread.TS\_FPR(fpidx), sizeof(long));- else+ if (fpidx < (PT\_FPSCR - PT\_FPR0)) {+ if (IS\_ENABLED(CONFIG\_PPC32))+ // On 32-bit the index we are passed refers to 32-bit words+ \*data = ((u32 \*)child->thread.fp\_state.fpr)[fpidx];+ else+ memcpy(data, &child->thread.TS\_FPR(fpidx), sizeof(long));+ } else \*data = child->thread.fp\_state.fpscr; #else \*data = 0;@@ -39,9 +43,13 @@ int ptrace\_put\_fpr(struct task\_struct \*child, int index, unsigned long data)  #ifdef CONFIG\_PPC\_FPU\_REGS flush\_fp\_to\_thread(child);- if (fpidx < (PT\_FPSCR - PT\_FPR0))- memcpy(&child->thread.TS\_FPR(fpidx), &data, sizeof(long));- else+ if (fpidx < (PT\_FPSCR - PT\_FPR0)) {+ if (IS\_ENABLED(CONFIG\_PPC32))+ // On 32-bit the index we are passed refers to 32-bit words+ ((u32 \*)child->thread.fp\_state.fpr)[fpidx] = data;+ else+ memcpy(&child->thread.TS\_FPR(fpidx), &data, sizeof(long));+ } else child->thread.fp\_state.fpscr = data; #endif diff --git a/arch/powerpc/kernel/ptrace/ptrace.c b/arch/powerpc/kernel/ptrace/ptrace.cindex 4d2dc22d4a2d54..5d7a72b41ae711 100644--- a/[arch/powerpc/kernel/ptrace/ptrace.c](/pub/scm/linux/kernel/git/powerpc/linux.git/tree/arch/powerpc/kernel/ptrace/ptrace.c?id=7ad4bd887d27c6b6ffbef216f19c19f8fe2b8f52)+++ b/[arch/powerpc/kernel/ptrace/ptrace.c](/pub/scm/linux/kernel/git/powerpc/linux.git/tree/arch/powerpc/kernel/ptrace/ptrace.c?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9)@@ -444,4 +444,7 @@ void \_\_init pt\_regs\_check(void) \* real registers. \*/ BUILD\_BUG\_ON(PT\_DSCR < sizeof(struct user\_pt\_regs) / sizeof(unsigned long));++ // ptrace\_get/put\_fpr() rely on PPC32 and VSX being incompatible+ BUILD\_BUG\_ON(IS\_ENABLED(CONFIG\_PPC32) && IS\_ENABLED(CONFIG\_VSX)); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 19:00:09 +0000



=== Content from www.openwall.com_c1604142_20250114_191308.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <87bkuwc5cr.fsf@mpe.ellerman.id.au>
Date: Tue, 14 Jun 2022 13:05:08 +1000
From: Michael Ellerman <mpe@...erman.id.au>
To: oss-security@...ts.openwall.com
Subject: CVE-2022-32981: Linux kernel for powerpc 32-bit, buffer overflow in
 ptrace PEEKUSER/POKEUSER

The Linux kernel for powerpc 32-bit has a buffer overflow in the handling of ptrace
PEEKUSER/POKEUSER when accessing floating point registers.

The fix for mainline is:
  <https://git.kernel.org/pub/scm/linux/kernel/git/powerpc/linux.git/commit/?id=8e1278444446fc97778a5e5c99bca1ce0bbc5ec9>

Which is included in v5.19-rc2.

Stable backports have been posted.

A test case is included below, it will report if the system is correctly
patched, it is safe to run on an unpatched system.

cheers

---
#undef NDEBUG
#include <assert.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>

static double expected = 0.123456L;

static int child(int shm_id)
{
	int *cptr = shmat(shm_id, NULL, 0);

	asm volatile (
		"lfd	 %%f0, 0(%0)	;"
		"lfd	 %%f1, 0(%0)	;"
		"li 	 %%r9, 1	;"
		"stw	 %%r9, 0(%1)	;"
		"1:"
		"lwz	 %%r9, 0(%2)	;"
		"cmpwi	 %%r9, 0	;"
		"beq	   1b		;"
		: // outputs
		: // inputs
		  "b" (&expected), "b" (&cptr[1]), "b" (&cptr[0])
		: // clobbers
		  "memory", "r9", "fr0", "fr1"
	);

	return 0;
}

int start_trace(pid_t child)
{
	int ret;

	ret = ptrace(PTRACE_ATTACH, child, NULL, NULL);
	if (ret) {
		perror("ptrace(PTRACE_ATTACH) failed");
		return -1;
	}
	ret = waitpid(child, NULL, 0);
	if (ret != child) {
		perror("waitpid() failed");
		return -1;
	}
	return 0;
}

int stop_trace(pid_t child)
{
	int ret;

	ret = ptrace(PTRACE_DETACH, child, NULL, NULL);
	if (ret) {
		perror("ptrace(PTRACE_DETACH) failed");
		return -1;
	}
	return 0;
}

long raw_ptrace(enum __ptrace_request request, pid_t pid, unsigned long addr, void *data)
{
	return syscall(__NR_ptrace, request, pid, (void *)addr, data);
}

#define PEEKS_PER_FPR	(sizeof(__u64) / sizeof(unsigned long))

int peek_fpr(pid_t child, int frnum, __u64 *fpr)
{
	unsigned long *p, addr;
	int i, fpindex;
	long ret;

	fpindex = PEEKS_PER_FPR * frnum;

	p = (unsigned long *)fpr;
	for (i = 0; i < PEEKS_PER_FPR; i++, p++) {
		addr = sizeof(unsigned long) * (PT_FPR0 + fpindex + i);
		ret = raw_ptrace(PTRACE_PEEKUSER, child, addr, p);
		if (ret) {
			perror("ptrace(PTRACE_PEEKUSR) failed");
			return -1;
		}
	}

	return 0;
}

int parent(pid_t child)
{
	double f0, f1;

	assert(start_trace(child) == 0);

	assert(peek_fpr(child, 0, (__u64 *)&f0) == 0);
	assert(peek_fpr(child, 1, (__u64 *)&f1) == 0);

	assert(stop_trace(child) == 0);

	printf("expected = %e\n", f0);
	printf("f0       = %e\n", f0);
	printf("f1       = %e\n", f1);

	if (f0 != expected || f1 != expected) {
		printf("FAIL - values don't match! Kernel is buggy.\n");
		return -1;
	}

	printf("OK - values match\n");

	return 0;
}

int main(void)
{
	int shm_id, ret, status, *pptr;
	pid_t pid;

	shm_id = shmget(IPC_PRIVATE, sizeof(int) * 2, 0777|IPC_CREAT);
	assert(shm_id != -1);

	pid = fork();
	assert(pid >= 0);

	if (pid == 0)
		exit(child(shm_id));

	pptr = shmat(shm_id, NULL, 0);

	// Wait for child to signal us to continue
	while (!pptr[1])
		asm volatile("" : : : "memory");

	ret = parent(pid);
	if (ret) {
		kill(pid, SIGTERM);
		shmdt((void *)pptr);
		shmctl(shm_id, IPC_RMID, NULL);
		return -1;
	}

	// Signal child to exit
	pptr[0] = 1;
	shmdt((void *)pptr);

	ret = wait(&status);
	shmctl(shm_id, IPC_RMID, NULL);

	assert(ret != -1 && WIFEXITED(status) && !WEXITSTATUS(status));

	return 0;
}

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


