=== Content from github.com_7733f067_20250114_191342.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fpull%2F346)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fpull%2F346)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=google%2Ffscrypt)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[google](/google)
/
**[fscrypt](/google/fscrypt)**
Public

* [Notifications](/login?return_to=%2Fgoogle%2Ffscrypt) You must be signed in to change notification settings
* [Fork
  98](/login?return_to=%2Fgoogle%2Ffscrypt)
* [Star
   906](/login?return_to=%2Fgoogle%2Ffscrypt)

* [Code](/google/fscrypt)
* [Issues
  39](/google/fscrypt/issues)
* [Pull requests
  2](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

Additional navigation options

* [Code](/google/fscrypt)
* [Issues](/google/fscrypt/issues)
* [Pull requests](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fgoogle%2Ffscrypt%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fgoogle%2Ffscrypt%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Metadata validation and other security improvements #346

 Merged

[ebiggers](/ebiggers)
merged 13 commits into
[master](/google/fscrypt/tree/master "google/fscrypt:master")
from
[fixes](/google/fscrypt/tree/fixes "google/fscrypt:fixes")

Feb 23, 2022

 Merged

# [Metadata validation and other security improvements](#top) #346

[ebiggers](/ebiggers)
merged 13 commits into
[master](/google/fscrypt/tree/master "google/fscrypt:master")
from
[fixes](/google/fscrypt/tree/fixes "google/fscrypt:fixes")

Feb 23, 2022

[Conversation
41](/google/fscrypt/pull/346)
[Commits
13](/google/fscrypt/pull/346/commits)
[Checks
0](/google/fscrypt/pull/346/checks)
[Files changed](/google/fscrypt/pull/346/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![ebiggers](https://avatars.githubusercontent.com/u/2373140?s=60&v=4)](/ebiggers)

Copy link

Collaborator

### @ebiggers **[ebiggers](/ebiggers)** commented [Feb 16, 2022](#issue-1139650174)

This pull request makes a large number of changes (mostly related to the metadata storage) to address some reported security issues, as well as go a bit beyond the specific current issues and reduce the attack surface for the future.

For the immediate security issues, make the following changes:

* Fix `fscrypt status` and the bash completion script to handle maliciously-crafted mountpoint paths.
* Validate the size and type of all metadata files before trying to read them.
* Reject any login protectors that are owned by the wrong user, as they could be maliciously spoofed.
* Make `fscrypt setup` offer the user a choice between world-writable mode (the previous behavior) and single-user-writable mode (which for security reasons is the new default behavior, but most users should be fine with world-writable).

For additional hardening, make the following changes:

* When running as a non-root user, don't read any metadata files owned by, or in a directory owned by, another non-root user. An opt-out flag for this is provided in `/etc/fscrypt.conf` if this particular change causes problems.
* Create all metadata files with mode 0600, rather than the default of 0644. To make this possible, some additional changes are made to prevent files from being owned by root when they should be owned by a regular user.
* Make `pam_fscrypt` ignore system users entirely.

I've split the changes into individual commits. They should be easier to review individually.

Sorry, something went wrong.

All reactions

 [![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)
[ebiggers](/ebiggers)
requested a review
from [josephlr](/josephlr)
[February 16, 2022 07:45](#event-6080637216)

[![@josephlr](https://avatars.githubusercontent.com/u/5506060?s=80&u=39579067ebc4394ebdd253d0aaa603fd880150b0&v=4)](/josephlr)

Copy link

Member

### **[josephlr](/josephlr)** commented [Feb 17, 2022](#issuecomment-1042478672)

| Thank you for splitting this up! Reviewing now |
| --- |

All reactions

Sorry, something went wrong.

[![josephlr](https://avatars.githubusercontent.com/u/5506060?s=60&v=4)](/josephlr)

**[josephlr](/josephlr)**
reviewed
[Feb 17, 2022](#pullrequestreview-885328859)

 [View reviewed changes](/google/fscrypt/pull/346/files)

Copy link

Member

### @josephlr **[josephlr](/josephlr)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Reviews though the first 3 commits, I'll try to have comments on the rest before end-of-week.

Sorry, something went wrong.

All reactions

[filesystem/mountpoint\_test.go](/google/fscrypt/pull/346/files#diff-cc1582165159899bd4f22fc1a0962e0739675dc0dc5c939203bfe5f083f780fa)
Outdated

Show resolved

Hide resolved

[filesystem/mountpoint\_test.go](/google/fscrypt/pull/346/files#diff-cc1582165159899bd4f22fc1a0962e0739675dc0dc5c939203bfe5f083f780fa)
Outdated

Show resolved

Hide resolved

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)
Outdated

Show resolved

Hide resolved

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)

Show resolved

Hide resolved

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)
Outdated

Show resolved

Hide resolved

1 hidden conversation

Load more…

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)
Outdated

Show resolved

Hide resolved

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)
Outdated

Show resolved

Hide resolved

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)
Outdated

Show resolved

Hide resolved

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)
Outdated

Show resolved

Hide resolved

[cmd/fscrypt/fscrypt\_bash\_completion](/google/fscrypt/pull/346/files#diff-7bcb2becc26452fb82986f605e41170d5c8dc3499ccbaefcbb80c6a98b2e550b)

Show resolved

Hide resolved

 [![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)
[ebiggers](/ebiggers)
[force-pushed](/google/fscrypt/compare/616cbd221922649cc896f422dce0a3d8a83931f0..bfdfa8d505c4cdcc1dad5446cb555a850bfc530b)
the
fixes

branch
3 times, most recently
from
[`616cbd2`](/google/fscrypt/commit/616cbd221922649cc896f422dce0a3d8a83931f0) to
[`bfdfa8d`](/google/fscrypt/commit/bfdfa8d505c4cdcc1dad5446cb555a850bfc530b)  [Compare](/google/fscrypt/compare/616cbd221922649cc896f422dce0a3d8a83931f0..bfdfa8d505c4cdcc1dad5446cb555a850bfc530b)
[February 17, 2022 08:44](#event-6088460770)

[![dirkmueller](https://avatars.githubusercontent.com/u/1029152?s=60&v=4)](/dirkmueller)

**[dirkmueller](/dirkmueller)**
reviewed
[Feb 17, 2022](#pullrequestreview-885718732)

 [View reviewed changes](/google/fscrypt/pull/346/files)

[pam\_fscrypt/run\_fscrypt.go](/google/fscrypt/pull/346/files#diff-59de3afa7f6a1022de702335d9e6cf09478b3bd4bae47179bb6274076ab0abff)
Outdated

Show resolved

Hide resolved

[![mgerstner](https://avatars.githubusercontent.com/u/24227799?s=60&v=4)](/mgerstner)

**[mgerstner](/mgerstner)**
reviewed
[Feb 17, 2022](#pullrequestreview-885964229)

 [View reviewed changes](/google/fscrypt/pull/346/files)

[filesystem/filesystem.go](/google/fscrypt/pull/346/files#diff-11a47696192b4602f7e0fea19870d8e2bc3be8065e259df79376c42e27a2a0bf)

Show resolved

Hide resolved

[![@mgerstner](https://avatars.githubusercontent.com/u/24227799?s=80&v=4)](/mgerstner)

Copy link

### **[mgerstner](/mgerstner)** commented [Feb 18, 2022](#issuecomment-1044211928)

| Overall the changes look good to me. Thanks for considering the additional hardenings. |
| --- |

All reactions

Sorry, something went wrong.

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=80&v=4)](/ebiggers)

Copy link

Collaborator

Author

### **[ebiggers](/ebiggers)** commented [Feb 18, 2022](#issuecomment-1045094194)

| One potential issue with mode `0755` metadata directories: as proposed in this pull request currently, it won't be possible for non-root users to **update** policies or protectors they own, since for atomicity reasons `fscrypt` implements updates using a create followed a replace, rather than using a direct overwrite.  Notably, this would break the `pam_fscrypt` functionality that updates a user's login protector when they change their passphrase.  There are two potential solutions to this:  1.) Make the `Chauthtok` function of `pam_fscrypt` not drop privileges to the user. Disadvantage: this would increase the attack surface. 2.) Make updates fall back to direct overwrites if the process lacks permission to create files. Disadvantage: in general, this would make updates non-atomic, i.e. there would be a window where the file would be lost in the event of a system crash. That is obviously an undesirable property, although I'm not sure how much it matters in practice --- it might be a super small window, or perhaps the overwrites would actually still be atomic in most cases due to the files usually being smaller than the disk sector size.  [@josephlr](https://github.com/josephlr), any thoughts about which one of the above two we should choose? |
| --- |

All reactions

Sorry, something went wrong.

[![@josephlr](https://avatars.githubusercontent.com/u/5506060?s=80&u=39579067ebc4394ebdd253d0aaa603fd880150b0&v=4)](/josephlr)

Copy link

Member

### **[josephlr](/josephlr)** commented [Feb 22, 2022](#issuecomment-1048006151) • edited Loading

| [@ebiggers](https://github.com/ebiggers) My preference would be for option (2) if we have to choose. It works better with fscrypt's other commands that modify protectors/policies. It would also only be non-atomic in the following (narrow) cases:   * the user has `/.fscrypt` setup as root-only * root has explicitly given a user ownership of a protector/policy file (which isn't done by default) * that user makes a change to one of their policies or protectors   In addition to option (2), in a follow up PR we could create a dedicated "tmp" file owned by root (with 1777 permissions) that could be used to make things atomic. In that case we would need to worry about data corruption concerns and locking, so it might not be the best choice. But we can discuss that approach later. |
| --- |

All reactions

Sorry, something went wrong.

 [![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)
[ebiggers](/ebiggers)
[force-pushed](/google/fscrypt/compare/0385896081c0780794c47044027a4cbe2f5ec0b1..4a67ecf22ea162c0ae9a452a83dadf9efffd1726)
the
fixes

branch
2 times, most recently
from
[`0385896`](/google/fscrypt/commit/0385896081c0780794c47044027a4cbe2f5ec0b1) to
[`4a67ecf`](/google/fscrypt/commit/4a67ecf22ea162c0ae9a452a83dadf9efffd1726)  [Compare](/google/fscrypt/compare/0385896081c0780794c47044027a4cbe2f5ec0b1..4a67ecf22ea162c0ae9a452a83dadf9efffd1726)
[February 23, 2022 06:52](#event-6122831337)

 [ebiggers](/ebiggers)
added 13 commits
[February 23, 2022 12:35](#commits-pushed-bd38077)

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[Make the output of 'fscrypt status' unambiguous](/google/fscrypt/pull/346/commits/bd380777d68816b55da85a42d4cdf7fb262b4ba2 "Make the output of 'fscrypt status' unambiguous

Following the example of /proc/self/mountinfo, replace the space,
newline, tab, and backslash characters with octal escape sequences so
that the output can be parsed unambiguously.")`
 …

`[bd38077](/google/fscrypt/pull/346/commits/bd380777d68816b55da85a42d4cdf7fb262b4ba2)`

```
Following the example of /proc/self/mountinfo, replace the space,
newline, tab, and backslash characters with octal escape sequences so
that the output can be parsed unambiguously.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[bash_completion: fix command injection and incorrect completions](/google/fscrypt/pull/346/commits/fa1a1fdbdea65829ce24a6b6f86ce2961e465b02 "bash_completion: fix command injection and incorrect completions

Mountpoint paths might be untrusted arbitrary strings; the fscrypt bash
completion script might need to complete to such strings.
Unfortunately, the design of bash completion places some major footguns
in the way of doing this correctly and securely:

   - \"compgen -W\" expands anything passed to it, so the argument to -W
     must be single-quoted to avoid an extra level of expansion.

   - The backslashes needed to escape meta-characters in the completed
     text aren't added automatically; they must be explicitly added.

Note that the completion script for 'umount' used to have these same
bugs (https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=892179,
https://github.com/util-linux/util-linux/issues/539).

Fix these bugs in roughly the same way that 'umount' fixed them.")`
 …

`[fa1a1fd](/google/fscrypt/pull/346/commits/fa1a1fdbdea65829ce24a6b6f86ce2961e465b02)`

```
Mountpoint paths might be untrusted arbitrary strings; the fscrypt bash
completion script might need to complete to such strings.
Unfortunately, the design of bash completion places some major footguns
in the way of doing this correctly and securely:

   - "compgen -W" expands anything passed to it, so the argument to -W
     must be single-quoted to avoid an extra level of expansion.

   - The backslashes needed to escape meta-characters in the completed
     text aren't added automatically; they must be explicitly added.

Note that the completion script for 'umount' used to have these same
bugs (<https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=892179>,
[util-linux/util-linux#539](https://github.com/util-linux/util-linux/issues/539)).

Fix these bugs in roughly the same way that 'umount' fixed them.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[filesystem: validate size and type of metadata files](/google/fscrypt/pull/346/commits/1a47718420317f893831b0223153d56005d5b02b "filesystem: validate size and type of metadata files

Don't allow reading metadata files that are very large, as they can
crash the program due to the memory required.  Similarly, don't allow
reading metadata files that aren't regular files, such as FIFOs, or
symlinks (which could point to a device node like /dev/zero), as that
can hang the program.  Both issues were particularly problematic for
pam_fscrypt, as they could prevent users from being able to log in.

Note: these checks are arguably unneeded if we strictly check the file
ownership too, which a later commit will do.  But there's no reason not
to do these basic checks too.")`
 …

`[1a47718](/google/fscrypt/pull/346/commits/1a47718420317f893831b0223153d56005d5b02b)`

```
Don't allow reading metadata files that are very large, as they can
crash the program due to the memory required.  Similarly, don't allow
reading metadata files that aren't regular files, such as FIFOs, or
symlinks (which could point to a device node like /dev/zero), as that
can hang the program.  Both issues were particularly problematic for
pam_fscrypt, as they could prevent users from being able to log in.

Note: these checks are arguably unneeded if we strictly check the file
ownership too, which a later commit will do.  But there's no reason not
to do these basic checks too.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[filesystem: reject spoofed login protectors](/google/fscrypt/pull/346/commits/b44fbe71e1e93c47050322af51725bac997641e0 "filesystem: reject spoofed login protectors

If a login protector contains a UID that differs from the file owner
(and the file owner is not root), it might be a spoofed file that was
created maliciously, so make sure to consider such files to be invalid.")`
 …

`[b44fbe7](/google/fscrypt/pull/346/commits/b44fbe71e1e93c47050322af51725bac997641e0)`

```
If a login protector contains a UID that differs from the file owner
(and the file owner is not root), it might be a spoofed file that was
created maliciously, so make sure to consider such files to be invalid.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[filesystem: fall back to non-atomic overwrites when required](/google/fscrypt/pull/346/commits/45599bdfad300f1a034c70dd70b4bd180d66f52c "filesystem: fall back to non-atomic overwrites when required

To allow users to update fscrypt metadata they own in
single-user-writable metadata directories (introduced by the next
commit), fall back to non-atomic overwrites when atomic ones can't be
done due to not having write access to the directory.")`
 …

`[45599bd](/google/fscrypt/pull/346/commits/45599bdfad300f1a034c70dd70b4bd180d66f52c)`

```
To allow users to update fscrypt metadata they own in
single-user-writable metadata directories (introduced by the next
commit), fall back to non-atomic overwrites when atomic ones can't be
done due to not having write access to the directory.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[Make 'fscrypt setup' offer a choice of directory modes](/google/fscrypt/pull/346/commits/6e355131670ad014e45f879475ddf800f0080d41 "Make 'fscrypt setup' offer a choice of directory modes

World-writable directories are not appropriate for some systems, so
offer a choice of single-user-writable and world-writable modes, with
single-user-writable being the default.  Add a new documentation section
to help users decide which one to use.")`
 …

`[6e35513](/google/fscrypt/pull/346/commits/6e355131670ad014e45f879475ddf800f0080d41)`

```
World-writable directories are not appropriate for some systems, so
offer a choice of single-user-writable and world-writable modes, with
single-user-writable being the default.  Add a new documentation section
to help users decide which one to use.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[Strictly validate metadata file ownership by default](/google/fscrypt/pull/346/commits/74e870b7bd1585b4b509da47e0e75db66336e576 "Strictly validate metadata file ownership by default

The metadata validation checks introduced by the previous commits are
good, but to reduce the attack surface it would be much better to avoid
reading and parsing files owned by other users in the first place.

There are some possible use cases for users sharing fscrypt metadata
files, but I think that for the vast majority of users it is unneeded
and just opens up attack surface.  Thus, make fscrypt (and pam_fscrypt)
not process policies or protectors owned by other users by default.
Specifically,

   * If fscrypt or pam_fscrypt is running as a non-root user, only
     policies and protectors owned by the user or by root can be used.

   * If fscrypt is running as root, any policy or protector can be used.
     (This is to match user expectations -- starting a sudo session
     should gain rights, not remove rights.)

   * If pam_fscrypt is running as root, only policies and protectors
     owned by root can be used.  Note that this only applies when the
     root user themselves has an fscrypt login protector, which is rare.

Add an option 'allow_cross_user_metadata' to /etc/fscrypt.conf which
allows restoring the old behavior for anyone who really needs it.")`
 …

`[74e870b](/google/fscrypt/pull/346/commits/74e870b7bd1585b4b509da47e0e75db66336e576)`

```
The metadata validation checks introduced by the previous commits are
good, but to reduce the attack surface it would be much better to avoid
reading and parsing files owned by other users in the first place.

There are some possible use cases for users sharing fscrypt metadata
files, but I think that for the vast majority of users it is unneeded
and just opens up attack surface.  Thus, make fscrypt (and pam_fscrypt)
not process policies or protectors owned by other users by default.
Specifically,

   * If fscrypt or pam_fscrypt is running as a non-root user, only
     policies and protectors owned by the user or by root can be used.

   * If fscrypt is running as root, any policy or protector can be used.
     (This is to match user expectations -- starting a sudo session
     should gain rights, not remove rights.)

   * If pam_fscrypt is running as root, only policies and protectors
     owned by root can be used.  Note that this only applies when the
     root user themselves has an fscrypt login protector, which is rare.

Add an option 'allow_cross_user_metadata' to /etc/fscrypt.conf which
allows restoring the old behavior for anyone who really needs it.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[Extend ownership validation to entire directory structure](/google/fscrypt/pull/346/commits/85a747493ff368a72f511619ecd391016ecb933c "Extend ownership validation to entire directory structure

A previous commit extended file ownership validation to policy and
protector files (by default -- there's an opt-out in /etc/fscrypt.conf).

However, that didn't apply to the parent directories:

	MOUNTPOINT
	MOUNTPOINT/.fscrypt
	MOUNTPOINT/.fscrypt/policies
	MOUNTPOINT/.fscrypt/protectors

The problem is that if the parent directories aren't trusted (owned by
another non-root user), then untrusted changes to their contents can be
made at any time, including the introduction of symlinks and so on.

While it's debatable how much of a problem this really is, given the
other validations that are done, it seems to be appropriate to validate
the parent directories too.

Therefore, this commit applies the same ownership validations to the
above four directories as are done on the metadata files themselves.

In addition, it is validated that none of these directories are symlinks
except for \".fscrypt\" where this is explicitly supported.")`
 …

`[85a7474](/google/fscrypt/pull/346/commits/85a747493ff368a72f511619ecd391016ecb933c)`

```
A previous commit extended file ownership validation to policy and
protector files (by default -- there's an opt-out in /etc/fscrypt.conf).

However, that didn't apply to the parent directories:

	MOUNTPOINT
	MOUNTPOINT/.fscrypt
	MOUNTPOINT/.fscrypt/policies
	MOUNTPOINT/.fscrypt/protectors

The problem is that if the parent directories aren't trusted (owned by
another non-root user), then untrusted changes to their contents can be
made at any time, including the introduction of symlinks and so on.

While it's debatable how much of a problem this really is, given the
other validations that are done, it seems to be appropriate to validate
the parent directories too.

Therefore, this commit applies the same ownership validations to the
above four directories as are done on the metadata files themselves.

In addition, it is validated that none of these directories are symlinks
except for ".fscrypt" where this is explicitly supported.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[Make all new metadata files owned by user when needed](/google/fscrypt/pull/346/commits/d4ce0b892cbe68db9f90f4015342e6a9069b079c "Make all new metadata files owned by user when needed

Since commit 4c7c6631cc5a (\"Set owner of login protectors to correct
user\"), login protectors are made owned by the user when root creates
one on a user's behalf.  That's good, but the same isn't true of other
files that get created at the same time:

- The policy protecting the directory
- The protector link file, if the policy is on a different filesystem
- The recovery protector, if the policy is on a different filesystem
- The recovery instructions file

In preparation for setting all metadata files to mode 0600, start making
all these files owned by the user in this scenario as well.")`
 …

`[d4ce0b8](/google/fscrypt/pull/346/commits/d4ce0b892cbe68db9f90f4015342e6a9069b079c)`

```
Since commit [4c7c663](https://github.com/google/fscrypt/commit/4c7c6631cc5a27cc6b4431f5ad3805a2d624c5f5) ("Set owner of login protectors to correct
user"), login protectors are made owned by the user when root creates
one on a user's behalf.  That's good, but the same isn't true of other
files that get created at the same time:

- The policy protecting the directory
- The protector link file, if the policy is on a different filesystem
- The recovery protector, if the policy is on a different filesystem
- The recovery instructions file

In preparation for setting all metadata files to mode 0600, start making
all these files owned by the user in this scenario as well.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[filesystem: preserve metadata file permissions on updates](/google/fscrypt/pull/346/commits/312bc381a3751e397995eeb2e63e66856912fafb "filesystem: preserve metadata file permissions on updates

Since fscrypt replaces metadata files rather than overwrites them (to
get atomicity), their owner will change to root if root makes a change.
That isn't too much of an issue when the files have mode 0644.  However,
it will become a much bigger issue when the files have mode 0600,
especially because existing files with mode 0644 would also get changed
to have mode 0600.

In preparation for this, start preserving the previous owner and mode of
policy and protector files when they are updated.")`
 …

`[312bc38](/google/fscrypt/pull/346/commits/312bc381a3751e397995eeb2e63e66856912fafb)`

```
Since fscrypt replaces metadata files rather than overwrites them (to
get atomicity), their owner will change to root if root makes a change.
That isn't too much of an issue when the files have mode 0644.  However,
it will become a much bigger issue when the files have mode 0600,
especially because existing files with mode 0644 would also get changed
to have mode 0600.

In preparation for this, start preserving the previous owner and mode of
policy and protector files when they are updated.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[filesystem: create metadata files with mode 0600](/google/fscrypt/pull/346/commits/06c989df4e31dd9f172f94fbd6243f49d4dd0b92 "filesystem: create metadata files with mode 0600

Currently, fscrypt policies and protectors are world readable, as they
are created with mode 0644.  While this can be nice for use cases where
users share these files, those use cases seem to be quite rare, and it's
not a great default security-wise since it exposes password hashes to
all users.  While fscrypt uses a very strong password hash algorithm, it
would still be best to follow the lead of /etc/shadow and keep this
information non-world-readable.

Therefore, start creating these files with mode 0600.

Of course, if users do actually want to share these files, they have the
option of simply chmod'ing them to a less restrictive mode.  An option
could also be added to make fscrypt use the old mode 0644; however, the
need for that is currently unclear.")`
 …

`[06c989d](/google/fscrypt/pull/346/commits/06c989df4e31dd9f172f94fbd6243f49d4dd0b92)`

```
Currently, fscrypt policies and protectors are world readable, as they
are created with mode 0644.  While this can be nice for use cases where
users share these files, those use cases seem to be quite rare, and it's
not a great default security-wise since it exposes password hashes to
all users.  While fscrypt uses a very strong password hash algorithm, it
would still be best to follow the lead of /etc/shadow and keep this
information non-world-readable.

Therefore, start creating these files with mode 0600.

Of course, if users do actually want to share these files, they have the
option of simply chmod'ing them to a less restrictive mode.  An option
could also be added to make fscrypt use the old mode 0644; however, the
need for that is currently unclear.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[pam_fscrypt: log errors getting protector in policiesUsingProtector()](/google/fscrypt/pull/346/commits/9871a39409222a80b4c4c22cbaab17bae84f1712 "pam_fscrypt: log errors getting protector in policiesUsingProtector()

If the error is anything other than ErrNotSetup, it might be helpful to
know what is going on.")`
 …

`[9871a39](/google/fscrypt/pull/346/commits/9871a39409222a80b4c4c22cbaab17bae84f1712)`

```
If the error is anything other than ErrNotSetup, it might be helpful to
know what is going on.
```

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)

`[pam_fscrypt: ignore system users](/google/fscrypt/pull/346/commits/97700817e737eabf45033cdb4a42fa5c6e74f877 "pam_fscrypt: ignore system users

pam_fscrypt should never need to do anything for system users, so detect
them early so that we can avoid wasting any resources looking for their
login protector.")`
 …

`[9770081](/google/fscrypt/pull/346/commits/97700817e737eabf45033cdb4a42fa5c6e74f877)`

```
pam_fscrypt should never need to do anything for system users, so detect
them early so that we can avoid wasting any resources looking for their
login protector.
```

 [![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)
[ebiggers](/ebiggers)
[force-pushed](/google/fscrypt/compare/4a67ecf22ea162c0ae9a452a83dadf9efffd1726..97700817e737eabf45033cdb4a42fa5c6e74f877)
the
fixes

branch
from
[`4a67ecf`](/google/fscrypt/commit/4a67ecf22ea162c0ae9a452a83dadf9efffd1726) to
[`9770081`](/google/fscrypt/commit/97700817e737eabf45033cdb4a42fa5c6e74f877)  [Compare](/google/fscrypt/compare/4a67ecf22ea162c0ae9a452a83dadf9efffd1726..97700817e737eabf45033cdb4a42fa5c6e74f877)
[February 23, 2022 20:36](#event-6127826194)

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=80&v=4)](/ebiggers)

Copy link

Collaborator

Author

### **[ebiggers](/ebiggers)** commented [Feb 23, 2022](#issuecomment-1049198223)

| [@ebiggers](https://github.com/ebiggers) My preference would be for option (2) if we have to choose. It works better with fscrypt's other commands that modify protectors/policies. It would also only be non-atomic in the following (narrow) cases:   * the user has `/.fscrypt` setup as root-only * root has explicitly given a user ownership of a protector/policy file (which isn't done by default) * that user makes a change to one of their policies or protectors   In addition to option (2), in a follow up PR we could create a dedicated "tmp" file owned by root (with 1777 permissions) that could be used to make things atomic. In that case we would need to worry about data corruption concerns and locking, so it might not be the best choice. But we can discuss that approach later.  I've implemented option (2) as the "least bad" option. Note that unfortunately it will be used a bit more widely than stated above. Notably, login protectors are owned by the user, and when the user changes their passphrase, `pam_fscrypt` updates the login protector using the user's privileges. That case will use the non-atomic overwrite. |
| --- |

All reactions

Sorry, something went wrong.

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)
[ebiggers](/ebiggers)
merged commit [`91aa3eb`](/google/fscrypt/commit/91aa3ebf42032ca783c41f9ec25d885875f66ddb)
into
master

[Feb 23, 2022](https://github.com/google/fscrypt/pull/346#event-6127869002)

 [![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers)
[ebiggers](/ebiggers)
deleted the
fixes

branch
[February 23, 2022 20:44](#event-6127869384)

This was referenced Feb 25, 2022

[x/vulndb: potential Go vuln in github.com/google/fscrypt: CVE-2022-25326
golang/vulndb#339](/golang/vulndb/issues/339)

Closed

[x/vulndb: potential Go vuln in github.com/google/fscrypt: CVE-2022-25327
golang/vulndb#340](/golang/vulndb/issues/340)

Closed

[x/vulndb: potential Go vuln in github.com/google/fscrypt: CVE-2022-25328
golang/vulndb#341](/golang/vulndb/issues/341)

Closed

This was referenced Mar 1, 2022

[x/vulndb: potential Go vuln in github.com/google/fscrypt: CVE-2022-25326
jba/nested-modules#246](/jba/nested-modules/issues/246)

Open

[x/vulndb: potential Go vuln in github.com/google/fscrypt: CVE-2022-25327
jba/nested-modules#247](/jba/nested-modules/issues/247)

Open

[x/vulndb: potential Go vuln in github.com/google/fscrypt: CVE-2022-25328
jba/nested-modules#248](/jba/nested-modules/issues/248)

Open

[![@tdunlap607](https://avatars.githubusercontent.com/u/16122665?s=40&v=4)](/tdunlap607)
[tdunlap607](/tdunlap607)
mentioned this pull request
[Mar 30, 2023](#ref-pullrequest-1648270353)

[[GHSA-8vwm-8vj8-rqjf] User login denial of service in github.com/google/fscrypt
github/advisory-database#1892](/github/advisory-database/pull/1892)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fpull%2F346)

Reviewers

[![@mgerstner](https://avatars.githubusercontent.com/u/24227799?s=40&v=4)](/mgerstner) [mgerstner](/mgerstner)

mgerstner left review comments

[![@josephlr](https://avatars.githubusercontent.com/u/5506060?s=40&v=4)](/josephlr) [josephlr](/josephlr)

josephlr left review comments

[![@dirkmueller](https://avatars.githubusercontent.com/u/1029152?s=40&v=4)](/dirkmueller) [dirkmueller](/dirkmueller)

dirkmueller left review comments

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=52&v=4)](/ebiggers) [![@josephlr](https://avatars.githubusercontent.com/u/5506060?s=52&v=4)](/josephlr) [![@mgerstner](https://avatars.githubusercontent.com/u/24227799?s=52&v=4)](/mgerstner) [![@dirkmueller](https://avatars.githubusercontent.com/u/1029152?s=52&v=4)](/dirkmueller)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


