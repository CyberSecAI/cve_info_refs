=== Content from github.com_f51e2424_20250114_223939.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fpull%2F4400)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fpull%2F4400)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=onnx%2Fonnx)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[onnx](/onnx)
/
**[onnx](/onnx/onnx)**
Public

* [Notifications](/login?return_to=%2Fonnx%2Fonnx) You must be signed in to change notification settings
* [Fork
  3.7k](/login?return_to=%2Fonnx%2Fonnx)
* [Star
   18.2k](/login?return_to=%2Fonnx%2Fonnx)

* [Code](/onnx/onnx)
* [Issues
  298](/onnx/onnx/issues)
* [Pull requests
  42](/onnx/onnx/pulls)
* [Discussions](/onnx/onnx/discussions)
* [Actions](/onnx/onnx/actions)
* [Projects
  2](/onnx/onnx/projects)
* [Wiki](/onnx/onnx/wiki)
* [Security](/onnx/onnx/security)
* [Insights](/onnx/onnx/pulse)

Additional navigation options

* [Code](/onnx/onnx)
* [Issues](/onnx/onnx/issues)
* [Pull requests](/onnx/onnx/pulls)
* [Discussions](/onnx/onnx/discussions)
* [Actions](/onnx/onnx/actions)
* [Projects](/onnx/onnx/projects)
* [Wiki](/onnx/onnx/wiki)
* [Security](/onnx/onnx/security)
* [Insights](/onnx/onnx/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fonnx%2Fonnx%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fonnx%2Fonnx%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Do not allow to read tensor's external\_data outside the model directory #4400

 Merged

[jcwchen](/jcwchen)
merged 13 commits into
[onnx:main](/onnx/onnx/tree/main "onnx/onnx:main")
from
[jnovikov:main](/jnovikov/onnx/tree/main "jnovikov/onnx:main")

Aug 10, 2022

 Merged

# [Do not allow to read tensor's external\_data outside the model directory](#top) #4400

[jcwchen](/jcwchen)
merged 13 commits into
[onnx:main](/onnx/onnx/tree/main "onnx/onnx:main")
from
[jnovikov:main](/jnovikov/onnx/tree/main "jnovikov/onnx:main")

Aug 10, 2022

+240

−10

[Conversation
10](/onnx/onnx/pull/4400)
[Commits
13](/onnx/onnx/pull/4400/commits)
[Checks
0](/onnx/onnx/pull/4400/checks)
[Files changed
5](/onnx/onnx/pull/4400/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![jnovikov](https://avatars.githubusercontent.com/u/13511922?s=60&v=4)](/jnovikov)

Copy link

Contributor

### @jnovikov **[jnovikov](/jnovikov)** commented [Aug 1, 2022](#issue-1325018901) • edited Loading

Signed-off-by: jnovikov johnnovikov0@gmail.com

This PR fixes the vulnerability that allows to read tensor\_data outside the model directory.

The logic behind the PR is to first normalize the relative\_path inside the tensor and then check that path has no '../' suffix.

Normalization code is based on go-lang path.Clean() but simplified to work correctly with the relative\_paths only.

Provided tests should cover most of the cases.

Please note that 'optimal' solution would be to use boost::filesystem or c++17 filesystem to get the absolute path file and resolve possible symlink problems, but AFAIK the project target is C++11 and the boost is not used at the project.

fixes [#3991](https://github.com/onnx/onnx/issues/3991)

Sorry, something went wrong.

All reactions

 [![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)
[jnovikov](/jnovikov)
requested a review
from a team
as a [code owner](/onnx/onnx/blob/66480ce6ab0f4c56e27bb120f246c3ddd0d1e19e/CODEOWNERS#L1)
[August 1, 2022 21:48](#event-7105118954)

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)
[jnovikov](/jnovikov)
changed the title
~~Not allow to read tensor external\_data outside the model directory~~
Do not allow to read tensor's external\_data outside the model directory
[Aug 2, 2022](#event-7105718003)

 [jnovikov](/jnovikov)
added 6 commits
[August 2, 2022 01:43](#commits-pushed-2b8103c)

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Not allow to read tensor external_data outside the model directory](/onnx/onnx/pull/4400/commits/2b8103c33eba6140b8da80abed1bf2f0f2900371 "Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[2b8103c](/onnx/onnx/pull/4400/commits/2b8103c33eba6140b8da80abed1bf2f0f2900371)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Fix formatting errors](/onnx/onnx/pull/4400/commits/759b41a45ee42feeb1680a01769e969baf85202e "Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[759b41a](/onnx/onnx/pull/4400/commits/759b41a45ee42feeb1680a01769e969baf85202e)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Disable segfaulty test](/onnx/onnx/pull/4400/commits/1eb98908fd1d12b0ba5af94a32ec80f01421f498 "Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[1eb9890](/onnx/onnx/pull/4400/commits/1eb98908fd1d12b0ba5af94a32ec80f01421f498)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Fix cpp tests](/onnx/onnx/pull/4400/commits/de436435f1e6f388358005b97aee939dd8d7af50 "Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[de43643](/onnx/onnx/pull/4400/commits/de436435f1e6f388358005b97aee939dd8d7af50)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Fix UB while removing ../](/onnx/onnx/pull/4400/commits/9fe9660c2051a8e0ae6d8e28f22befafe634f9b3 "Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[9fe9660](/onnx/onnx/pull/4400/commits/9fe9660c2051a8e0ae6d8e28f22befafe634f9b3)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Fix clang-format](/onnx/onnx/pull/4400/commits/ea4f4192c6b01d69c9faee28b1507f13190b20b5 "Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[ea4f419](/onnx/onnx/pull/4400/commits/ea4f4192c6b01d69c9faee28b1507f13190b20b5)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

 [![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)
[jnovikov](/jnovikov)
[force-pushed](/onnx/onnx/compare/6c68087e44907f2e846e36e27d37e39386e100db..ea4f4192c6b01d69c9faee28b1507f13190b20b5)
the
main

branch
from
[`6c68087`](/onnx/onnx/commit/6c68087e44907f2e846e36e27d37e39386e100db) to
[`ea4f419`](/onnx/onnx/commit/ea4f4192c6b01d69c9faee28b1507f13190b20b5)  [Compare](/onnx/onnx/compare/6c68087e44907f2e846e36e27d37e39386e100db..ea4f4192c6b01d69c9faee28b1507f13190b20b5)
[August 2, 2022 00:43](#event-7105777022)

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Check for symlinks only on POSIX systems](/onnx/onnx/pull/4400/commits/7ee52788c353a180cffd73eccbfcf0c5179ec74c "Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[7ee5278](/onnx/onnx/pull/4400/commits/7ee52788c353a180cffd73eccbfcf0c5179ec74c)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen)
[jcwchen](/jcwchen)
added
[run release CIs](/onnx/onnx/labels/run%20release%20CIs)
Use this label to trigger release tests in CI
[module: utility](/onnx/onnx/labels/module%3A%20utility)
Helper modules
[vulnerability](/onnx/onnx/labels/vulnerability)
labels
[Aug 4, 2022](#event-7123637709)

[![jcwchen](https://avatars.githubusercontent.com/u/14194980?s=60&v=4)](/jcwchen)

**[jcwchen](/jcwchen)**
reviewed
[Aug 4, 2022](#pullrequestreview-1061146948)

 [View reviewed changes](/onnx/onnx/pull/4400/files/7ee52788c353a180cffd73eccbfcf0c5179ec74c)

Copy link

Member

### @jcwchen **[jcwchen](/jcwchen)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Nit comments. Thank you for the contribution to make ONNX more secure!

Sorry, something went wrong.

All reactions

[onnx/test/test\_external\_data.py](/onnx/onnx/pull/4400/files/7ee52788c353a180cffd73eccbfcf0c5179ec74c#diff-ae6a20a9bd1464d5c21657806635c9d2a15e9c41eb377847b2c729916ac5ddd5)

Show resolved

Hide resolved

[onnx/test/test\_external\_data.py](/onnx/onnx/pull/4400/files/7ee52788c353a180cffd73eccbfcf0c5179ec74c#diff-ae6a20a9bd1464d5c21657806635c9d2a15e9c41eb377847b2c729916ac5ddd5)

Show resolved

Hide resolved

 [jnovikov](/jnovikov)
added 3 commits
[August 4, 2022 22:52](#commits-pushed-47551b1)

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Add specific to Windows external_data test](/onnx/onnx/pull/4400/commits/47551b1eb0bd22fad6a174ee70a630eb6cc65607 "Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[47551b1](/onnx/onnx/pull/4400/commits/47551b1eb0bd22fad6a174ee70a630eb6cc65607)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Change specific Windows external_data test decorator tofix mypy](/onnx/onnx/pull/4400/commits/f179deb46b1300f11867bfe87d9067dfc108802b "Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[f179deb](/onnx/onnx/pull/4400/commits/f179deb46b1300f11867bfe87d9067dfc108802b)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Merge branch 'main' into main](/onnx/onnx/pull/4400/commits/da70f6a7187346fe9f730770fd0c49a90b564e50 "Merge branch 'main' into main")`

`[da70f6a](/onnx/onnx/pull/4400/commits/da70f6a7187346fe9f730770fd0c49a90b564e50)`

 [![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)
[jnovikov](/jnovikov)
requested a review
from [jcwchen](/jcwchen)
[August 4, 2022 22:13](#event-7131739020)

[![jcwchen](https://avatars.githubusercontent.com/u/14194980?s=60&v=4)](/jcwchen)

**[jcwchen](/jcwchen)**
reviewed
[Aug 8, 2022](#pullrequestreview-1065774856)

 [View reviewed changes](/onnx/onnx/pull/4400/files/da70f6a7187346fe9f730770fd0c49a90b564e50)

[onnx/test/test\_external\_data.py](/onnx/onnx/pull/4400/files/7ee52788c353a180cffd73eccbfcf0c5179ec74c#diff-ae6a20a9bd1464d5c21657806635c9d2a15e9c41eb377847b2c729916ac5ddd5)

Show resolved

Hide resolved

[onnx/test/test\_external\_data.py](/onnx/onnx/pull/4400/files/da70f6a7187346fe9f730770fd0c49a90b564e50#diff-ae6a20a9bd1464d5c21657806635c9d2a15e9c41eb377847b2c729916ac5ddd5)
Outdated

Show resolved

Hide resolved

[![jcwchen](https://avatars.githubusercontent.com/u/14194980?s=60&v=4)](/jcwchen)

**[jcwchen](/jcwchen)**
approved these changes
[Aug 9, 2022](#pullrequestreview-1065940150)

 [View reviewed changes](/onnx/onnx/pull/4400/files/da70f6a7187346fe9f730770fd0c49a90b564e50)

Copy link

Member

### @jcwchen **[jcwchen](/jcwchen)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thank you for making ONNX more secure! Please remove `pathlib` if it is really unused. Otherwise LGTM.

Sorry, something went wrong.

All reactions

[![gramalingam](https://avatars.githubusercontent.com/u/10075881?s=60&v=4)](/gramalingam)

**[gramalingam](/gramalingam)**
approved these changes
[Aug 9, 2022](#pullrequestreview-1067402424)

 [View reviewed changes](/onnx/onnx/pull/4400/files/da70f6a7187346fe9f730770fd0c49a90b564e50)

 [jnovikov](/jnovikov)
added 3 commits
[August 10, 2022 01:22](#commits-pushed-7651b4b)

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Remove unused pathlib](/onnx/onnx/pull/4400/commits/7651b4b56b98e970acfc2b46e75224f32ba8bdd6 "Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[7651b4b](/onnx/onnx/pull/4400/commits/7651b4b56b98e970acfc2b46e75224f32ba8bdd6)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Merge](/onnx/onnx/pull/4400/commits/30288e4cd45c3118b431eaa2bff523760401571b "Merge

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
 …

`[30288e4](/onnx/onnx/pull/4400/commits/30288e4cd45c3118b431eaa2bff523760401571b)`

```
Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

`[Merge branch 'main' into main](/onnx/onnx/pull/4400/commits/40619b54466aafd1bd6a28b25e86fd49f0145be8 "Merge branch 'main' into main")`

`[40619b5](/onnx/onnx/pull/4400/commits/40619b54466aafd1bd6a28b25e86fd49f0145be8)`

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen)
[jcwchen](/jcwchen)
merged commit [`f369b0e`](/onnx/onnx/commit/f369b0e859024095d721f1d1612da5a8fa38988d)
into
onnx:main

[Aug 10, 2022](https://github.com/onnx/onnx/pull/4400#event-7164980168)

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen)
[jcwchen](/jcwchen)
mentioned this pull request
[Aug 25, 2022](#ref-pullrequest-1351042488)

[Use filesystem to load filename to prevent encoding issues on Windows
#4470](/onnx/onnx/pull/4470)
 Merged

[jcwchen](/jcwchen)
pushed a commit
to jcwchen/onnx
that referenced
this pull request
[Sep 9, 2022](#ref-commit-2ecd4b8)
[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov) [![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&v=4)](/jcwchen)

`[Do not allow to read tensor's external_data outside the model directo…](/jcwchen/onnx/commit/2ecd4b8484658dd2e849161c4a0c0c6c6eaefd7f "Do not allow to read tensor's external_data outside the model directory (#4400)

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>")`
…

`[2ecd4b8](/jcwchen/onnx/commit/2ecd4b8484658dd2e849161c4a0c0c6c6eaefd7f)`

```
…ry ([onnx#4400](https://github.com/onnx/onnx/pull/4400))

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>
```

This was referenced Sep 9, 2022

[Consume ONNX 1.12.1 to prevent vulnerability issue while loading external file
microsoft/onnxruntime#12915](/microsoft/onnxruntime/pull/12915)
 Merged

[[1.12.1] Solve vulnerability issue while loading external tensors
#4508](/onnx/onnx/pull/4508)
 Merged

[jcwchen](/jcwchen)
added a commit
that referenced
this pull request
[Sep 14, 2022](#ref-commit-5a5f8a5)
[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen) [![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)

`[[1.12.1] Solve vulnerability issue while loading external tensors (](/onnx/onnx/commit/5a5f8a5935762397aa68429b5493084ff970f774 "[1.12.1] Solve vulnerability issue while loading external tensors (#4508)

* Do not allow to read tensor's external_data outside the model directory (#4400)

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

* cherry pick #4470

Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

* resolve Windows CI issue: use fixed Python 3.10.5

Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

* fix flake8

Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>
Co-authored-by: Ivan Novikov <johnnovikov0@gmail.com>")[#4508](https://github.com/onnx/onnx/pull/4508)`
…

`[5a5f8a5](/onnx/onnx/commit/5a5f8a5935762397aa68429b5493084ff970f774)`

```
)

* Do not allow to read tensor's external_data outside the model directory ([#4400](https://github.com/onnx/onnx/pull/4400))

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

* cherry pick [#4470](https://github.com/onnx/onnx/pull/4470)

Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

* resolve Windows CI issue: use fixed Python 3.10.5

Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

* fix flake8

Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
Signed-off-by: Chun-Wei Chen <jacky82226@gmail.com>
Co-authored-by: Ivan Novikov <johnnovikov0@gmail.com>
```

[broune](/broune)
pushed a commit
to broune/onnx
that referenced
this pull request
[May 6, 2023](#ref-commit-09fafdb)
[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)

`[Do not allow to read tensor's external_data outside the model directo…](/broune/onnx/commit/09fafdbdc82c7296d152394e3a9f3348c0570501 "Do not allow to read tensor's external_data outside the model directory (#4400)

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>")`
…

`[09fafdb](/broune/onnx/commit/09fafdbdc82c7296d152394e3a9f3348c0570501)`

```
…ry ([onnx#4400](https://github.com/onnx/onnx/pull/4400))

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

[![@alexlang74](https://avatars.githubusercontent.com/u/28828289?s=40&v=4)](/alexlang74)
[alexlang74](/alexlang74)
mentioned this pull request
[May 15, 2023](#ref-issue-1709360703)

[OpenCE 1.7: Backport onnx CVE-2022-25882
open-ce/open-ce#818](/open-ce/open-ce/issues/818)

Closed

[![@jywu-msft](https://avatars.githubusercontent.com/u/43355415?s=40&v=4)](/jywu-msft)
[jywu-msft](/jywu-msft)
mentioned this pull request
[Jan 17, 2024](#ref-pullrequest-2085285986)

[Check the ep\_cache\_context and don't allow access outside the directory
microsoft/onnxruntime#19174](/microsoft/onnxruntime/pull/19174)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fpull%2F4400)

Reviewers

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&v=4)](/jcwchen) [jcwchen](/jcwchen)

jcwchen approved these changes

[![@gramalingam](https://avatars.githubusercontent.com/u/10075881?s=40&v=4)](/gramalingam) [gramalingam](/gramalingam)

gramalingam approved these changes

Assignees

No one assigned

Labels

[module: utility](/onnx/onnx/labels/module%3A%20utility)
Helper modules
[run release CIs](/onnx/onnx/labels/run%20release%20CIs)
Use this label to trigger release tests in CI
[vulnerability](/onnx/onnx/labels/vulnerability)

Projects

[PR Tracker](/orgs/onnx/projects/5)
Status: Done

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [The onnx runtime allow to load the external\_data from the file outside the folder](https://github.com/onnx/onnx/issues/3991)

3 participants

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=52&v=4)](/jnovikov) [![@gramalingam](https://avatars.githubusercontent.com/u/10075881?s=52&v=4)](/gramalingam) [![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=52&v=4)](/jcwchen)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from security.snyk.io_03261ef3_20250114_223940.html ===
[![Homepage](/_nuxt/header-logo.Dk_X-iWD.svg)](/)

2. [Snyk Vulnerability Database](/vuln)
3. [pip](/vuln/pip)
4. onnx
# Directory Traversal Affecting [onnx](/package/pip/onnx) package, versions **[,1.13.0)**

---

### Severity

 Recommended 0.0high010

CVSS assessment made by Snyk's Security Team. [Learn more](/vuln/SNYK-PYTHON-ONNX-2395479#cvss)

### Threat Intelligence

Exploit Maturity

Snyk has a proof-of-concept or detailed explanation of how to exploit this vulnerability.

Proof of conceptEPSS

The probability is the direct output of the EPSS model, and conveys an overall sense of the threat of
exploitation in the wild. The percentile measures the EPSS probability relative to all known EPSS scores.
Note: This data is updated daily, relying on the latest available EPSS model version.
Check out the EPSS
[documentation](https://www.first.org/epss/articles/prob_percentile_bins)
for more details.

**0.14% (51st percentile)**
### Do your applications use this vulnerable package?

In a few clicks we can analyze your entire application and see what components are vulnerable in your application, and suggest you quick fixes.

[Test your applications](https://app.snyk.io/login?cta=sign-up&loc=banner&page=vuln-vuln)

* Snyk ID**SNYK-PYTHON-ONNX-2395479**
* published**23 Jan 2023**
* disclosed**7 Feb 2022**
* credit**jnovikov**

[Report a new vulnerability](https://snyk.io/vulnerability-disclosure/) [Found a mistake?](https://support.snyk.io/s/contactsupport)
#### Introduced: 7 Feb 2022

[CVE-2022-25882  (opens in a new tab)](https://www.cve.org/CVERecord?id=CVE-2022-25882) Common Vulnerabilities and Exposures (CVE) are common identifiers for publicly known security vulnerabilities[CWE-22  (opens in a new tab)](https://cwe.mitre.org/data/definitions/22.html) Common Weakness Enumeration (CWE) is a category system for software weaknesses First added by Snyk
## How to fix?

Upgrade `onnx` to version 1.13.0 or higher.

## Overview

[onnx](https://pypi.org/project/onnx) is an Open Neural Network Exchange

Affected versions of this package are vulnerable to Directory Traversal as the `external_data` field of the tensor proto can have a path to the file which is outside the model current directory or user-provided directory, for example "../../../etc/passwd"

## Details

A Directory Traversal attack (also known as path traversal) aims to access files and directories that are stored outside the intended folder. By manipulating files with "dot-dot-slash (../)" sequences and its variations, or by using absolute file paths, it may be possible to access arbitrary files and directories stored on file system, including application source code, configuration, and other critical system files.

Directory Traversal vulnerabilities can be generally divided into two types:

* **Information Disclosure**: Allows the attacker to gain information about the folder structure or read the contents of sensitive files on the system.

`st` is a module for serving static files on web pages, and contains a [vulnerability of this type](https://snyk.io/vuln/npm%3Ast%3A20140206). In our example, we will serve files from the `public` route.

If an attacker requests the following URL from our server, it will in turn leak the sensitive private key of the root user.

```
curl http://localhost:8080/public/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/root/.ssh/id_rsa

```

**Note** `%2e` is the URL encoded version of `.` (dot).

* **Writing arbitrary files**: Allows the attacker to create or replace existing files. This type of vulnerability is also known as `Zip-Slip`.

One way to achieve this is by using a malicious `zip` archive that holds path traversal filenames. When each filename in the zip archive gets concatenated to the target extraction folder, without validation, the final path ends up outside of the target folder. If an executable or a configuration file is overwritten with a file containing malicious code, the problem can turn into an arbitrary code execution issue quite easily.

The following is an example of a `zip` archive with one benign file and one malicious file. Extracting the malicious file will result in traversing out of the target folder, ending up in `/root/.ssh/` overwriting the `authorized_keys` file:

```
2018-04-15 22:04:29 .....           19           19  good.txt
2018-04-15 22:04:42 .....           20           20  ../../../../../../root/.ssh/authorized_keys

```
## References

* [GitHub Commit](https://github.com/onnx/onnx/commit/f369b0e859024095d721f1d1612da5a8fa38988d)
* [GitHub Gist](https://gist.github.com/jnovikov/02a9aff9bf2188033e77bd91ff062856)
* [GitHub Issue](https://github.com/onnx/onnx/issues/3991)
* [GitHub PR](https://github.com/onnx/onnx/pull/4400)
* [Vulnerable Code](https://github.com/onnx/onnx/blob/96516aecd4c110b0ac57eba08ac236ebf7205728/onnx/checker.cc#L129)
### CVSS Scores

version 3.1
### Snyk

7.5 high

* Attack Vector (AV)

  The vulnerable component is bound to the network stack and the set of possible attackers extends beyond the other options listed below, up to and including the entire Internet. Such a vulnerability is often termed “remotely exploitable” and can be thought of as an attack being exploitable *at the protocol level* one or more network hops away (e.g., across one or more routers).

  **Network**
* Attack Complexity (AC)

  Specialized access conditions or extenuating circumstances do not exist. An attacker can expect repeatable success when attacking the vulnerable component.

  **Low**
* Privileges Required (PR)

  The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the vulnerable system to carry out an attack.

  **None**
* User Interaction (UI)

  The vulnerable system can be exploited without interaction from any user.

  **None**

* Scope (S)

  An exploited vulnerability can only affect resources managed by the same security authority. In this case, the vulnerable component and the impacted component are either the same, or both are managed by the same security authority.

  **Unchanged**

* Confidentiality (C)

  There is a total loss of confidentiality, resulting in all resources within the impacted component being divulged to the attacker. Alternatively, access to only some restricted information is obtained, but the disclosed information presents a direct, serious impact. For example, an attacker steals the administrator's password, or private encryption keys of a web server.

  **High**
* Integrity (I)

  There is no loss of integrity within the impacted component.

  **None**
* Availability (A)

  There is no impact to availability within the impacted component.

  **None**
### NVD

7.5 high
### Product

* [Snyk Open Source](https://snyk.io/product/open-source-security-management/)
* [Snyk Code](https://snyk.io/product/snyk-code/)
* [Snyk Container](https://snyk.io/product/container-vulnerability-management/)
* [Snyk Infrastructure as Code](https://snyk.io/product/infrastructure-as-code-security/)
* [Snyk AppRisk](https://snyk.io/product/snyk-apprisk/)
### Resources

* [Vulnerability DB](https://security.snyk.io/)
* [Documentation](https://docs.snyk.io/)
* [Disclosed Vulnerabilities](/disclosed-vulnerabilities)
* [Blog](https://snyk.io/blog/)
* [FAQs](https://support.snyk.io/)
### Company

* [About](https://snyk.io/about)
* [Jobs](https://snyk.io/careers/)
* Contact
* [Policies](https://snyk.io/policies/terms-of-service/)
* [Do Not Sell My Personal Information](https://preferences.snyk.io/dont_sell)
### Contact Us

* Support
* [Report a new vuln](https://snyk.io/vulnerability-disclosure)
* [Events](https://snyk.io/events)
### Find us online

### Track our development

[![DevSecOps Community Podcast](data:image/svg+xml;base64...)](https://www.devseccon.com/the-secure-developer-podcast/)

© 2025 Snyk Limited

Registered in England and Wales. Company number: 09677925

Registered address: Highlands House, Basingstoke Road, Spencers Wood, Reading, Berkshire, RG7 1NT.



=== Content from github.com_996a6b59_20250114_223937.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fissues%2F3991)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fissues%2F3991)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=onnx%2Fonnx)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[onnx](/onnx)
/
**[onnx](/onnx/onnx)**
Public

* [Notifications](/login?return_to=%2Fonnx%2Fonnx) You must be signed in to change notification settings
* [Fork
  3.7k](/login?return_to=%2Fonnx%2Fonnx)
* [Star
   18.2k](/login?return_to=%2Fonnx%2Fonnx)

* [Code](/onnx/onnx)
* [Issues
  298](/onnx/onnx/issues)
* [Pull requests
  42](/onnx/onnx/pulls)
* [Discussions](/onnx/onnx/discussions)
* [Actions](/onnx/onnx/actions)
* [Projects
  2](/onnx/onnx/projects)
* [Wiki](/onnx/onnx/wiki)
* [Security](/onnx/onnx/security)
* [Insights](/onnx/onnx/pulse)

Additional navigation options

* [Code](/onnx/onnx)
* [Issues](/onnx/onnx/issues)
* [Pull requests](/onnx/onnx/pulls)
* [Discussions](/onnx/onnx/discussions)
* [Actions](/onnx/onnx/actions)
* [Projects](/onnx/onnx/projects)
* [Wiki](/onnx/onnx/wiki)
* [Security](/onnx/onnx/security)
* [Insights](/onnx/onnx/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fonnx%2Fonnx%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fonnx%2Fonnx%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# The onnx runtime allow to load the external\_data from the file outside the folder #3991

Closed

[jnovikov](/jnovikov) opened this issue
Feb 6, 2022
· 4 comments
 · Fixed by [#4400](https://github.com/onnx/onnx/pull/4400)

Closed

# [The onnx runtime allow to load the external\_data from the file outside the folder](#top) #3991

[jnovikov](/jnovikov) opened this issue
Feb 6, 2022
· 4 comments
 · Fixed by [#4400](https://github.com/onnx/onnx/pull/4400)

Labels
[topic: enhancement](/onnx/onnx/labels/topic%3A%20enhancement)
Request for new feature or operator
[vulnerability](/onnx/onnx/labels/vulnerability)

## Comments

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=80&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)

Copy link

Contributor

### **[jnovikov](/jnovikov)** commented [Feb 6, 2022](#issue-1125277391)

| The external\_data field of the tensor proto can have a path to the file which is outside the model current directory or user provided directory, for example "../../../etc/passwd".  There is no validation on this in this function:   [onnx/onnx/checker.cc](https://github.com/onnx/onnx/blob/96516aecd4c110b0ac57eba08ac236ebf7205728/onnx/checker.cc#L129)  Line 129 in [96516ae](/onnx/onnx/commit/96516aecd4c110b0ac57eba08ac236ebf7205728)   |  | std::string data\_path = path\_join(ctx.get\_model\_dir(), entry.value()); | | --- | --- |      The python library have the \_sanitize\_path function which has some basic restrictions but it doesn't work when you use the default onnxruntime package to do the model execution.  I can provide POC and create a patch by request. |
| --- | --- | --- |
| The text was updated successfully, but these errors were encountered: |

 👍
1
 jcwchen reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen)
[jcwchen](/jcwchen)
added
the
[topic: enhancement](/onnx/onnx/labels/topic%3A%20enhancement)
Request for new feature or operator
label
[Feb 11, 2022](#event-6052329574)

[![@garymm](https://avatars.githubusercontent.com/u/421339?s=80&v=4)](/garymm)

Copy link

Contributor

### **[garymm](/garymm)** commented [Feb 23, 2022](#issuecomment-1049138014)

| [@jnovikov](https://github.com/jnovikov) please send a PR to fix this. |
| --- |

All reactions

Sorry, something went wrong.

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)
[jnovikov](/jnovikov)
mentioned this issue
[Aug 1, 2022](#ref-pullrequest-1325018901)

[Do not allow to read tensor's external\_data outside the model directory
#4400](/onnx/onnx/pull/4400)
 Merged

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=80&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)

Copy link

Contributor

Author

### **[jnovikov](/jnovikov)** commented [Aug 2, 2022](#issuecomment-1201910871)

| [@garymm](https://github.com/garymm) [@jcwchen](https://github.com/jcwchen) I've sent a PR to fix, pls review. |
| --- |

 👍
1
 jcwchen reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@gramalingam](https://avatars.githubusercontent.com/u/10075881?s=80&v=4)](/gramalingam)

Copy link

Contributor

### **[gramalingam](/gramalingam)** commented [Aug 2, 2022](#issuecomment-1203004167)

| Out of curiosity: are there any pointers to such security practices (documentation)? |
| --- |

All reactions

Sorry, something went wrong.

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=80&u=8b15711518554bccf34410bd9a25cf92b0feac5b&v=4)](/jnovikov)

Copy link

Contributor

Author

### **[jnovikov](/jnovikov)** commented [Aug 2, 2022](#issuecomment-1203115641)

| [@gramalingam](https://github.com/gramalingam) do you mean is there any reason to do the patch ?  My main reason is that it should not be allowed by default [(from the docs)](https://github.com/onnx/onnx/blob/main/docs/ExternalData.md#external_data-field) as it also may affect the security of the some application or user.  About the security practices in patch: <https://owasp.org/www-community/attacks/Path_Traversal>  I would say it would be sure better to have some chrooted env while loading the model, but it would be hard to implement in cross-platform way, so this should be enough as long as the clean\_relative\_path() has no bugs. |
| --- |

All reactions

Sorry, something went wrong.

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen)
[jcwchen](/jcwchen)
added
the
[vulnerability](/onnx/onnx/labels/vulnerability)
label
[Aug 4, 2022](#event-7123638943)

[![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=40&u=2a57929c755afcb5d896c050593adb92b46a6487&v=4)](/jcwchen)
[jcwchen](/jcwchen)
closed this as [completed](/onnx/onnx/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#4400](/onnx/onnx/pull/4400)
[Aug 10, 2022](#event-7164980326)

[![@alexlang74](https://avatars.githubusercontent.com/u/28828289?s=40&v=4)](/alexlang74)
[alexlang74](/alexlang74)
mentioned this issue
[May 15, 2023](#ref-issue-1709360703)

[OpenCE 1.7: Backport onnx CVE-2022-25882
open-ce/open-ce#818](/open-ce/open-ce/issues/818)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fissues%2F3991)

Assignees

No one assigned

Labels

[topic: enhancement](/onnx/onnx/labels/topic%3A%20enhancement)
Request for new feature or operator
[vulnerability](/onnx/onnx/labels/vulnerability)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Do not allow to read tensor's external\_data outside the model directory](/onnx/onnx/pull/4400)
 [jnovikov/onnx](/jnovikov/onnx)

4 participants

[![@garymm](https://avatars.githubusercontent.com/u/421339?s=52&v=4)](/garymm) [![@gramalingam](https://avatars.githubusercontent.com/u/10075881?s=52&v=4)](/gramalingam) [![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=52&v=4)](/jnovikov) [![@jcwchen](https://avatars.githubusercontent.com/u/14194980?s=52&v=4)](/jcwchen)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_ab91cc16_20250114_223932.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=64&v=4)](/jnovikov)

# [jnovikov](/jnovikov)/**[model\_hack.onnx](/jnovikov/02a9aff9bf2188033e77bd91ff062856)** Secret

Created
August 17, 2022 20:08

Show Gist options

* [Download ZIP](/jnovikov/02a9aff9bf2188033e77bd91ff062856/archive/a218a155045df170c49c28cd4f1fb9539b9aa62b.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/jnovikov/02a9aff9bf2188033e77bd91ff062856.js&quot;&gt;&lt;/script&gt;
* Save jnovikov/02a9aff9bf2188033e77bd91ff062856 to your computer and use it in GitHub Desktop.

[Code](/jnovikov/02a9aff9bf2188033e77bd91ff062856)
[Revisions
1](/jnovikov/02a9aff9bf2188033e77bd91ff062856/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/jnovikov/02a9aff9bf2188033e77bd91ff062856.js&quot;&gt;&lt;/script&gt;

Save jnovikov/02a9aff9bf2188033e77bd91ff062856 to your computer and use it in GitHub Desktop.

[Download ZIP](/jnovikov/02a9aff9bf2188033e77bd91ff062856/archive/a218a155045df170c49c28cd4f1fb9539b9aa62b.zip)

Onnx runtime poc

 [Raw](/jnovikov/02a9aff9bf2188033e77bd91ff062856/raw/a218a155045df170c49c28cd4f1fb9539b9aa62b/model_hack.onnx)

[**model\_hack.onnx**](#file-model_hack-onnx)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | Pls download the https://drive.google.com/file/d/17ZzAfb\_VLAAd\_Xto9\_Mb98o-x6\_5YfMv/view?usp=sharing |
| --- | --- |

 [Raw](/jnovikov/02a9aff9bf2188033e77bd91ff062856/raw/a218a155045df170c49c28cd4f1fb9539b9aa62b/onnxruntime_poc.py)

[**onnxruntime\_poc.py**](#file-onnxruntime_poc-py)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | import onnxruntime as rt |
| --- | --- |
|  |  |
|  | sess = rt.InferenceSession('./model\_hack.onnx') |
|  | print(sess.get\_inputs()[0].name) |
|  | print(sess.get\_outputs()[0].name) |
|  | res = sess.run(['t\_output'], {'f\_input': [0]}) |
|  | print(bytes(res[0])) |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fjnovikov%2F02a9aff9bf2188033e77bd91ff062856)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_893f9a65_20250114_223936.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fcommit%2Ff369b0e859024095d721f1d1612da5a8fa38988d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fcommit%2Ff369b0e859024095d721f1d1612da5a8fa38988d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=onnx%2Fonnx)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[onnx](/onnx)
/
**[onnx](/onnx/onnx)**
Public

* [Notifications](/login?return_to=%2Fonnx%2Fonnx) You must be signed in to change notification settings
* [Fork
  3.7k](/login?return_to=%2Fonnx%2Fonnx)
* [Star
   18.2k](/login?return_to=%2Fonnx%2Fonnx)

* [Code](/onnx/onnx)
* [Issues
  298](/onnx/onnx/issues)
* [Pull requests
  42](/onnx/onnx/pulls)
* [Discussions](/onnx/onnx/discussions)
* [Actions](/onnx/onnx/actions)
* [Projects
  2](/onnx/onnx/projects)
* [Wiki](/onnx/onnx/wiki)
* [Security](/onnx/onnx/security)
* [Insights](/onnx/onnx/pulse)

Additional navigation options

* [Code](/onnx/onnx)
* [Issues](/onnx/onnx/issues)
* [Pull requests](/onnx/onnx/pulls)
* [Discussions](/onnx/onnx/discussions)
* [Actions](/onnx/onnx/actions)
* [Projects](/onnx/onnx/projects)
* [Wiki](/onnx/onnx/wiki)
* [Security](/onnx/onnx/security)
* [Insights](/onnx/onnx/pulse)

## Commit

[Permalink](/onnx/onnx/commit/f369b0e859024095d721f1d1612da5a8fa38988d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Do not allow to read tensor's external\_data outside the model directo…

[Browse files](/onnx/onnx/tree/f369b0e859024095d721f1d1612da5a8fa38988d)
Browse the repository at this point in the history

```
…ry ([#4400](https://github.com/onnx/onnx/pull/4400))

* Not allow to read tensor external_data outside the model directory

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix formatting errors

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Disable segfaulty test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix cpp tests

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix UB while removing ../

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Fix clang-format

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Check for symlinks only on POSIX systems

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Add specific to Windows external_data test

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Change specific Windows external_data test decorator tofix mypy

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

* Remove unused pathlib

Signed-off-by: jnovikov <johnnovikov0@gmail.com>

Signed-off-by: jnovikov <johnnovikov0@gmail.com>
```

* Loading branch information

[![@jnovikov](https://avatars.githubusercontent.com/u/13511922?s=40&v=4)](/jnovikov)

[jnovikov](/onnx/onnx/commits?author=jnovikov "View all commits by jnovikov")
authored
Aug 10, 2022

1 parent
[eb634ad](/onnx/onnx/commit/eb634addcbb23ec1baf4d548d826bf3932527533)

commit f369b0e

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**240 additions**
and
**10 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* onnx

  + onnx/checker.cc
    [checker.cc](#diff-27b8667be1a3c2c7ce2a2d324700c2f7bf400916c6b0e3508c8b27f85399ac6a)
  + common

    - onnx/common/path.cc
      [path.cc](#diff-b9c5544cf5f72c3611ad91d847c050be27009caae74424c2b1d173520ce8ad67)
    - onnx/common/path.h
      [path.h](#diff-230b83ce05b64f89da25a78d1482e3756b373d9aaaada93c1a8d77a6aacc544a)
  + test

    - cpp

      * onnx/test/cpp/common\_path\_test.cc
        [common\_path\_test.cc](#diff-9a1899e6bc8ebf64e337ebc384ed395441ea42ba716a906906cb9a2150bb2732)
    - onnx/test/test\_external\_data.py
      [test\_external\_data.py](#diff-ae6a20a9bd1464d5c21657806635c9d2a15e9c41eb377847b2c729916ac5ddd5)

## There are no files selected for viewing

27 changes: 26 additions & 1 deletion

27
[onnx/checker.cc](#diff-27b8667be1a3c2c7ce2a2d324700c2f7bf400916c6b0e3508c8b27f85399ac6a "onnx/checker.cc")

Show comments

[View file](/onnx/onnx/blob/f369b0e859024095d721f1d1612da5a8fa38988d/onnx/checker.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -127,7 +127,20 @@ void check\_tensor(const TensorProto& tensor, const CheckerContext& ctx) { |
|  |  | for (const StringStringEntryProto& entry : tensor.external\_data()) { |
|  |  | if (entry.has\_key() && entry.has\_value() && entry.key() == "location") { |
|  |  | has\_location = true; |
|  |  | std::string data\_path = path\_join(ctx.get\_model\_dir(), entry.value()); |
|  |  | std::string relative\_path = clean\_relative\_path(entry.value()); |
|  |  | // Check that normalized relative path starts with "../" or "..\" on windows. |
|  |  | if (relative\_path.rfind(".." + k\_preferred\_path\_separator, 0) == 0) { |
|  |  | fail\_check( |
|  |  | "Data of TensorProto ( tensor name: ", |
|  |  | tensor.name(), |
|  |  | ") should be file inside the ", |
|  |  | ctx.get\_model\_dir(), |
|  |  | ", but the '", |
|  |  | entry.value(), |
|  |  | "' points outside the directory"); |
|  |  | } |
|  |  |  |
|  |  | std::string data\_path = path\_join(ctx.get\_model\_dir(), relative\_path); |
|  |  | // use stat to check whether the file exists |
|  |  | struct stat buffer; |
|  |  | if (stat((data\_path).c\_str(), &buffer) != 0) { |
| Expand All | | @@ -138,6 +151,18 @@ void check\_tensor(const TensorProto& tensor, const CheckerContext& ctx) { |
|  |  | data\_path, |
|  |  | ", but it doesn't exist or is not accessible."); |
|  |  | } |
|  |  | #ifdef \_WIN32 |
|  |  | #else // POSIX |
|  |  | // Do not allow symlinks or directories. |
|  |  | if (!S\_ISREG(buffer.st\_mode)) { |
|  |  | fail\_check( |
|  |  | "Data of TensorProto ( tensor name: ", |
|  |  | tensor.name(), |
|  |  | ") should be stored in ", |
|  |  | data\_path, |
|  |  | ", but it is not regular file."); |
|  |  | } |
|  |  | #endif |
|  |  | } |
|  |  | } |
|  |  | if (!has\_location) { |
| Expand Down | |  |

88 changes: 88 additions & 0 deletions

88
[onnx/common/path.cc](#diff-b9c5544cf5f72c3611ad91d847c050be27009caae74424c2b1d173520ce8ad67 "onnx/common/path.cc")

Show comments

[View file](/onnx/onnx/blob/f369b0e859024095d721f1d1612da5a8fa38988d/onnx/common/path.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,11 +9,99 @@ |
|  |  |  |
|  |  | namespace ONNX\_NAMESPACE { |
|  |  |  |
|  |  | bool is\_path\_separator(char c) { |
|  |  | // Windows accept / as path separator. |
|  |  | if (k\_preferred\_path\_separator == "\\") { |
|  |  | return c == '\\' || c == '/'; |
|  |  | } |
|  |  |  |
|  |  | return c == k\_preferred\_path\_separator[0]; |
|  |  | } |
|  |  |  |
|  |  | void normalize\_separator(std::string& path) { |
|  |  | char preferred\_sep = k\_preferred\_path\_separator[0]; |
|  |  | if (preferred\_sep == '/') { |
|  |  | // Do nothing on linux. |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | for (size\_t i = 0; i < path.size(); i++) { |
|  |  | if (is\_path\_separator(path[i]) && path[i] != preferred\_sep) { |
|  |  | path[i] = preferred\_sep; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | std::string path\_join(const std::string& origin, const std::string& append) { |
|  |  | if (origin.find\_last\_of(k\_preferred\_path\_separator) != origin.length() - k\_preferred\_path\_separator.length()) { |
|  |  | return origin + k\_preferred\_path\_separator + append; |
|  |  | } |
|  |  | return origin + append; |
|  |  | } |
|  |  |  |
|  |  | std::string clean\_relative\_path(const std::string& path) { |
|  |  | if (path.empty()) { |
|  |  | return "."; |
|  |  | } |
|  |  |  |
|  |  | std::string out; |
|  |  |  |
|  |  | char sep = k\_preferred\_path\_separator[0]; |
|  |  | size\_t n = path.size(); |
|  |  |  |
|  |  | size\_t r = 0; |
|  |  | size\_t dotdot = 0; |
|  |  |  |
|  |  | while (r < n) { |
|  |  | if (is\_path\_separator(path[r])) { |
|  |  | r++; |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (path[r] == '.' && (r + 1 == n || is\_path\_separator(path[r + 1]))) { |
|  |  | r++; |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (path[r] == '.' && path[r + 1] == '.' && (r + 2 == n || is\_path\_separator(path[r + 2]))) { |
|  |  | r += 2; |
|  |  |  |
|  |  | if (out.size() > dotdot) { |
|  |  | while (out.size() > dotdot && !is\_path\_separator(out.back())) { |
|  |  | out.pop\_back(); |
|  |  | } |
|  |  | if (!out.empty()) |
|  |  | out.pop\_back(); |
|  |  | } else { |
|  |  | if (!out.empty()) { |
|  |  | out.push\_back(sep); |
|  |  | } |
|  |  |  |
|  |  | out.push\_back('.'); |
|  |  | out.push\_back('.'); |
|  |  | dotdot = out.size(); |
|  |  | } |
|  |  |  |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (!out.empty() && out.back() != sep) { |
|  |  | out.push\_back(sep); |
|  |  | } |
|  |  |  |
|  |  | for (; r < n && !is\_path\_separator(path[r]); r++) { |
|  |  | out.push\_back(path[r]); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (out.empty()) { |
|  |  | out.push\_back('.'); |
|  |  | } |
|  |  |  |
|  |  | // Use 1 separator in path. |
|  |  | normalize\_separator(out); |
|  |  |  |
|  |  | return out; |
|  |  | } |
|  |  |  |
|  |  | } // namespace ONNX\_NAMESPACE |

2 changes: 2 additions & 0 deletions

2
[onnx/common/path.h](#diff-230b83ce05b64f89da25a78d1482e3756b373d9aaaada93c1a8d77a6aacc544a "onnx/common/path.h")

Show comments

[View file](/onnx/onnx/blob/f369b0e859024095d721f1d1612da5a8fa38988d/onnx/common/path.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,5 +18,7 @@ const std::string k\_preferred\_path\_separator = "/"; |
|  |  | #endif |
|  |  |  |
|  |  | std::string path\_join(const std::string& origin, const std::string& append); |
|  |  | void normalize\_separator(std::string& path); |
|  |  | std::string clean\_relative\_path(const std::string& path); |
|  |  |  |
|  |  | } // namespace ONNX\_NAMESPACE |

70 changes: 70 additions & 0 deletions

70
[onnx/test/cpp/common\_path\_test.cc](#diff-9a1899e6bc8ebf64e337ebc384ed395441ea42ba716a906906cb9a2150bb2732 "onnx/test/cpp/common_path_test.cc")

Show comments

[View file](/onnx/onnx/blob/f369b0e859024095d721f1d1612da5a8fa38988d/onnx/test/cpp/common_path_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,70 @@ |
|  |  | /\* |
|  |  | \* SPDX-License-Identifier: Apache-2.0 |
|  |  | \*/ |
|  |  |  |
|  |  | #include <list> |
|  |  | #include <utility> |
|  |  | #include "gtest/gtest.h" |
|  |  |  |
|  |  | #include "onnx/common/path.h" |
|  |  |  |
|  |  | using namespace ONNX\_NAMESPACE; |
|  |  |  |
|  |  | namespace ONNX\_NAMESPACE { |
|  |  | namespace Test { |
|  |  | namespace { |
|  |  | std::string fix\_sep(std::string path) { |
|  |  | std::string out = path; |
|  |  | normalize\_separator(out); |
|  |  | return out; |
|  |  | } |
|  |  | } // namespace |
|  |  |  |
|  |  | TEST(PathTest, CleanRelativePathTest) { |
|  |  | // Already normal. |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc"), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def"), fix\_sep("abc/def")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("a/b/c"), fix\_sep("a/b/c")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("."), fix\_sep(".")); |
|  |  | EXPECT\_EQ(clean\_relative\_path(".."), fix\_sep("..")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("../.."), fix\_sep("../..")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("../../abc"), fix\_sep("../../abc")); |
|  |  | // Remove leading slash |
|  |  | EXPECT\_EQ(clean\_relative\_path("/abc"), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("/"), fix\_sep(".")); |
|  |  | // Remove trailing slash |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/"), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/"), fix\_sep("abc/def")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("a/b/c/"), fix\_sep("a/b/c")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("./"), fix\_sep(".")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("../"), fix\_sep("..")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("../../"), fix\_sep("../..")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("/abc/"), fix\_sep("abc")); |
|  |  | // Remove doubled slash |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc//def//ghi"), fix\_sep("abc/def/ghi")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("//abc"), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("///abc"), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("//abc//"), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc//"), fix\_sep("abc")); |
|  |  | // Remove . elements |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/./def"), fix\_sep("abc/def")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("/./abc/def"), fix\_sep("abc/def")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/."), fix\_sep("abc")); |
|  |  | // Remove .. elements |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/ghi/../jkl"), fix\_sep("abc/def/jkl")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/../ghi/../jkl"), fix\_sep("abc/jkl")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/.."), fix\_sep("abc")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/../.."), fix\_sep(".")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("/abc/def/../.."), fix\_sep(".")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/../../.."), fix\_sep("..")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("/abc/def/../../.."), fix\_sep("..")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/def/../../../ghi/jkl/../../../mno"), fix\_sep("../../mno")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("/../abc"), fix\_sep("../abc")); |
|  |  | // Combinations |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/./../def"), fix\_sep("def")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc//./../def"), fix\_sep("def")); |
|  |  | EXPECT\_EQ(clean\_relative\_path("abc/../../././../def"), fix\_sep("../../def")); |
|  |  | } |
|  |  |  |
|  |  | } // namespace Test |
|  |  | } // namespace ONNX\_NAMESPACE |

63 changes: 54 additions & 9 deletions

63
[onnx/test/test\_external\_data.py](#diff-ae6a20a9bd1464d5c21657806635c9d2a15e9c41eb377847b2c729916ac5ddd5 "onnx/test/test_external_data.py")

Show comments

[View file](/onnx/onnx/blob/f369b0e859024095d721f1d1612da5a8fa38988d/onnx/test/test_external_data.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -49,7 +49,6 @@ def create\_external\_data\_tensor(self, value: List[Any], tensor\_name: str) -> Ten |
|  |  | return tensor |
|  |  |  |
|  |  | def create\_test\_model(self) -> str: |
|  |  |  |
|  |  | constant\_node = onnx.helper.make\_node( |
|  |  | 'Constant', |
|  |  | inputs=[], |
| Expand Down  Expand Up | | @@ -226,7 +225,8 @@ def test\_convert\_model\_to\_external\_data\_from\_one\_file\_with\_location(self) -> Non |
|  |  | model\_file\_path = self.get\_temp\_model\_filename() |
|  |  | external\_data\_file = str(uuid.uuid4()) |
|  |  |  |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, all\_tensors\_to\_one\_file=True, location=external\_data\_file) |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, all\_tensors\_to\_one\_file=True, |
|  |  | location=external\_data\_file) |
|  |  | onnx.save\_model(self.model, model\_file\_path) |
|  |  |  |
|  |  | self.assertTrue(Path.isfile(os.path.join(self.temp\_dir, external\_data\_file))) |
| Expand Down  Expand Up | | @@ -260,7 +260,8 @@ def test\_convert\_model\_to\_external\_data\_from\_one\_file\_without\_location\_uses\_mode |
|  |  | def test\_convert\_model\_to\_external\_data\_one\_file\_per\_tensor\_without\_attribute(self) -> None: |
|  |  | model\_file\_path = self.get\_temp\_model\_filename() |
|  |  |  |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, all\_tensors\_to\_one\_file=False, convert\_attribute=False) |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, all\_tensors\_to\_one\_file=False, |
|  |  | convert\_attribute=False) |
|  |  | onnx.save\_model(self.model, model\_file\_path) |
|  |  |  |
|  |  | self.assertTrue(Path.isfile(model\_file\_path)) |
| Expand All | | @@ -270,7 +271,8 @@ def test\_convert\_model\_to\_external\_data\_one\_file\_per\_tensor\_without\_attribute(se |
|  |  | def test\_convert\_model\_to\_external\_data\_one\_file\_per\_tensor\_with\_attribute(self) -> None: |
|  |  | model\_file\_path = self.get\_temp\_model\_filename() |
|  |  |  |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, all\_tensors\_to\_one\_file=False, convert\_attribute=True) |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, all\_tensors\_to\_one\_file=False, |
|  |  | convert\_attribute=True) |
|  |  | onnx.save\_model(self.model, model\_file\_path) |
|  |  |  |
|  |  | self.assertTrue(Path.isfile(model\_file\_path)) |
| Expand All | | @@ -280,7 +282,8 @@ def test\_convert\_model\_to\_external\_data\_one\_file\_per\_tensor\_with\_attribute(self) |
|  |  | def test\_convert\_model\_to\_external\_data\_does\_not\_convert\_attribute\_values(self) -> None: |
|  |  | model\_file\_path = self.get\_temp\_model\_filename() |
|  |  |  |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, convert\_attribute=False, all\_tensors\_to\_one\_file=False) |
|  |  | convert\_model\_to\_external\_data(self.model, size\_threshold=0, convert\_attribute=False, |
|  |  | all\_tensors\_to\_one\_file=False) |
|  |  | onnx.save\_model(self.model, model\_file\_path) |
|  |  |  |
|  |  | self.assertTrue(Path.isfile(os.path.join(self.temp\_dir, "input\_value"))) |
| Expand Down  Expand Up | | @@ -399,11 +402,11 @@ def get\_temp\_model\_filename(self) -> str: |
|  |  | def create\_test\_model(self) -> ModelProto: |
|  |  | X = helper.make\_tensor\_value\_info('X', TensorProto.FLOAT, self.large\_data.shape) |
|  |  | input\_init = helper.make\_tensor(name='X', data\_type=TensorProto.FLOAT, |
|  |  | dims=self.large\_data.shape, vals=self.large\_data.tobytes(), raw=True) |
|  |  | dims=self.large\_data.shape, vals=self.large\_data.tobytes(), raw=True) |
|  |  |  |
|  |  | shape\_data = np.array(self.small\_data, np.int64) |
|  |  | shape\_init = helper.make\_tensor(name='Shape', data\_type=TensorProto.INT64, |
|  |  | dims=shape\_data.shape, vals=shape\_data.tobytes(), raw=True) |
|  |  | dims=shape\_data.shape, vals=shape\_data.tobytes(), raw=True) |
|  |  | C = helper.make\_tensor\_value\_info('C', TensorProto.INT64, self.small\_data) |
|  |  |  |
|  |  | reshape = onnx.helper.make\_node( |
| Expand Down  Expand Up | | @@ -432,13 +435,14 @@ def test\_check\_model(self) -> None: |
|  |  | checker.check\_model(self.model) |
|  |  |  |
|  |  | def test\_reshape\_inference\_with\_external\_data\_fail(self) -> None: |
|  |  | onnx.save\_model(self.model, self.model\_file\_path, save\_as\_external\_data=True, all\_tensors\_to\_one\_file=False, size\_threshold=0) |
|  |  | onnx.save\_model(self.model, self.model\_file\_path, save\_as\_external\_data=True, all\_tensors\_to\_one\_file=False, |
|  |  | size\_threshold=0) |
|  |  | model\_without\_external\_data = onnx.load(self.model\_file\_path, load\_external\_data=False) |
|  |  | # Shape inference of Reshape uses ParseData |
|  |  | # ParseData cannot handle external data and should throw the error as follows: |
|  |  | # Cannot parse data from external tensors. Please load external data into raw data for tensor: Shape |
|  |  | self.assertRaises(shape\_inference.InferenceError, shape\_inference.infer\_shapes, |
|  |  | model\_without\_external\_data, strict\_mode=True) |
|  |  | model\_without\_external\_data, strict\_mode=True) |
|  |  |  |
|  |  | def test\_to\_array\_with\_external\_data(self) -> None: |
|  |  | onnx.save\_model(self.model, |
| Expand Down  Expand Up | | @@ -492,5 +496,46 @@ def test\_save\_model\_with\_external\_data\_multiple\_times(self) -> None: |
|  |  | self.assertTrue(np.allclose(to\_array(small\_shape\_tensor, self.temp\_dir), self.small\_data)) |
|  |  |  |
|  |  |  |
|  |  | class TestNotAllowToLoadExternalDataOutsideModelDirectory(TestLoadExternalDataBase): |
|  |  | """Essential test to check that onnx (validate) C++ code will not allow to load external\_data outside the model |
|  |  | directory. """ |
|  |  |  |
|  |  | def create\_external\_data\_tensor(self, value: List[Any], tensor\_name: str) -> TensorProto: |
|  |  | tensor = from\_array(np.array(value)) |
|  |  | tensor.name = tensor\_name |
|  |  |  |
|  |  | set\_external\_data(tensor, location="../../file.bin") |
|  |  |  |
|  |  | tensor.ClearField('raw\_data') |
|  |  | tensor.data\_location = onnx.TensorProto.EXTERNAL |
|  |  | return tensor |
|  |  |  |
|  |  | def test\_check\_model(self) -> None: |
|  |  | """We only test the model validation as onnxruntime uses this to load the model. """ |
|  |  | with self.assertRaises(onnx.checker.ValidationError): |
|  |  | checker.check\_model(self.model\_filename) |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.skipif(os.name != 'nt', reason='Skip Windows test') |
|  |  | class TestNotAllowToLoadExternalDataOutsideModelDirectoryOnWindows(TestLoadExternalDataBase): |
|  |  | """Essential test to check that onnx (validate) C++ code will not allow to load external\_data outside the model |
|  |  | directory. """ |
|  |  |  |
|  |  | def create\_external\_data\_tensor(self, value: List[Any], tensor\_name: str) -> TensorProto: |
|  |  | tensor = from\_array(np.array(value)) |
|  |  | tensor.name = tensor\_name |
|  |  |  |
|  |  | set\_external\_data(tensor, location="..\\..\\file.bin") |
|  |  |  |
|  |  | tensor.ClearField('raw\_data') |
|  |  | tensor.data\_location = onnx.TensorProto.EXTERNAL |
|  |  | return tensor |
|  |  |  |
|  |  | def test\_check\_model(self) -> None: |
|  |  | """We only test the model validation as onnxruntime uses this to load the model. """ |
|  |  | with self.assertRaises(onnx.checker.ValidationError): |
|  |  | checker.check\_model(self.model\_filename) |
|  |  |  |
|  |  |  |
|  |  | if \_\_name\_\_ == '\_\_main\_\_': |
|  |  | unittest.main() |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f369b0e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fonnx%2Fonnx%2Fcommit%2Ff369b0e859024095d721f1d1612da5a8fa38988d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


