```
{
  "CVE-2022-36085": {
    "Description": "The Rego compiler provides a (deprecated) `WithUnsafeBuiltins` function, which allows users to provide a set of built-in functions that should be deemed unsafe — and as such rejected — by the compiler if encountered in the policy compilation stage. A bypass of this protection has been found, where the use of the `with` keyword to mock such a built-in function (a feature introduced in OPA v0.40.0), isn’t taken into account by `WithUnsafeBuiltins`. The same method is exposed via `rego.UnsafeBuiltins` in the `github.com/open-policy-agent/opa/rego` package.",
    "Root cause": "The `WithUnsafeBuiltins` function, intended to prevent the use of certain built-in functions by marking them as unsafe, was not applied when these functions were mocked using the `with` keyword.",
    "Weaknesses": [
      "The vulnerability stems from the compiler not respecting the `WithUnsafeBuiltins` list during `with` keyword replacements.",
      "The `WithUnsafeBuiltins` mechanism is deprecated and was not fully compatible with the new function mocking feature."
    ],
    "Impact": "An attacker could bypass the `WithUnsafeBuiltins` protection by using the `with` keyword to mock unsafe built-in functions, potentially gaining access to sensitive information or executing unauthorized actions (e.g., `http.send` or `opa.runtime` built-ins) via policies provided by untrusted parties.",
    "Attack vectors": [
      "Exploiting the vulnerability requires a user to evaluate policies from untrusted sources using the OPA Go API, while utilizing the `WithUnsafeBuiltins` feature.",
      "If the OPA Query API is exposed publicly, and relies on the unavailability of `http.send` or other unsafe built-ins, this could also be an attack vector."
    ],
    "Required attacker capabilities/position": [
      "The attacker must be able to provide rego policies that use the `with` keyword to mock built-in functions considered unsafe.",
      "The attacker's policies must be evaluated using the Go API and the `WithUnsafeBuiltins` method needs to be active."
    ],
    "Patches": [
       "The vulnerability was addressed in versions v0.43.1 and v0.44.0 of the OPA project.",
       "The fix included ensuring that `WithUnsafeBuiltins` is respected during 'with' keyword replacement operations."
       ],
      "Workarounds": [
      "Use the capabilities feature instead of WithUnsafeBuiltins. Replace the code that uses WithUnsafeBuiltins with the code that utilizes capabilities feature.",
       "If you cannot upgrade, configure OPA using the capabilities feature to remove the unsafe built-in functions."
    ],
      "Additional Notes": [
        "The `WithUnsafeBuiltins` function has been deprecated since the introduction of the capabilities feature in OPA v0.23.0. Users are encouraged to use capabilities feature over the deprecated `WithUnsafeBuiltins` function.",
       "The function mocking feature using the `with` keyword was introduced in OPA v0.40.0."
       ]
  }
}
```