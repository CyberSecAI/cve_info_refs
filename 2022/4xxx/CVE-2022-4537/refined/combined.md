=== Content from plugins.trac.wordpress.org_5907ea24_20250115_082529.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fhide-my-wp%2Ftrunk%2Fmodels%2FBrute.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/hide-my-wp/trunk/models/Brute.php?rev=3164146 "Revision 3164146")
* Next Revision →
* [Blame](/browser/hide-my-wp/trunk/models/Brute.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/hide-my-wp/trunk/models/Brute.php)

---

# [source:](/browser?order=name "Go to repository root") [hide-my-wp](/browser/hide-my-wp?order=name "View hide-my-wp")/[trunk](/browser/hide-my-wp/trunk?order=name "View trunk")/[models](/browser/hide-my-wp/trunk/models?order=name "View models")/[Brute.php](/browser/hide-my-wp/trunk/models/Brute.php?order=name "View Brute.php")

View diff against:

View revision:

| [Last change](/changeset/3184244/hide-my-wp/trunk/models/Brute.php "View differences") on this file was [3184244](/changeset/3184244/ "View changeset 3184244"), checked in by johndarrel, [2 months ago](/timeline?from=2024-11-08T07%3A33%3A09Z&precision=second "See timeline at 11/08/2024 07:33:09 AM") |
| --- |
| Update - Compatibility with WP 6.7 Update - Add Brute Force for comments form in Brute Force Update - Translations Fixed - Issue when changing relative to absolute path in javascript Fixed - Root domain regarding multisite with subdomains Fixed - Compatibility with LiteSpeed CDN domains Fixed - Use [WordPress](/wiki/WordPress) function for all parse url Fixed - Activate firewall by default when Lite mode option is selected Fixed - Compatibility with WP Rocket background CSS loader Fixed - Flush changed to config file when some features are activated in Overview section Fixed - Clear cache for Litespeed plugin when changing is made in the Mapping section Fixed - Activate the Text Mapping in CSS and JS files option for hiding class names like elementor or woocommerce |
| **File size:** 21.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Brute Force Protection Model |
| [4](#L4) | \* Called from Brute Force Class |
| [5](#L5) | \* |
| [6](#L6) | \* @file  The Brute Force Model file |
| [7](#L7) | \* @package HMWP/BruteForce |
| [8](#L8) | \* @since 4.2.0 |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | defined( 'ABSPATH' ) || die( 'Cheatin\' uh?' ); |
| [12](#L12) |  |
| [13](#L13) | class HMWP\_Models\_Brute { |
| [14](#L14) | /\*\* |
| [15](#L15) | \* The user IP address |
| [16](#L16) | \* |
| [17](#L17) | \* @var string |
| [18](#L18) | \*/ |
| [19](#L19) | protected $user\_ip; |
| [20](#L20) | public $response; |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Retrives and sets the ip address the person logging in |
| [24](#L24) | \* |
| [25](#L25) | \* @return string |
| [26](#L26) | \*/ |
| [27](#L27) | public function brute\_get\_ip() { |
| [28](#L28) | if ( isset( $this->user\_ip ) ) { |
| [29](#L29) | return $this->user\_ip; |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | if ( ! isset( $\_SERVER['REMOTE\_ADDR'] ) ) { |
| [33](#L33) | return '127.0.0.1'; |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) | $ip             = $\_SERVER['REMOTE\_ADDR']; |
| [37](#L37) | $trusted\_header = HMWP\_Classes\_Tools::getOption( 'trusted\_ip\_header' ); |
| [38](#L38) |  |
| [39](#L39) | if ( is\_string( $trusted\_header ) && $trusted\_header <> '' ) { |
| [40](#L40) | if ( isset( $\_SERVER[ $trusted\_header ] ) ) { |
| [41](#L41) | $ip = $\_SERVER[ $trusted\_header ]; |
| [42](#L42) | } |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | $ips = array\_reverse( explode( ', ', $ip ) ); |
| [46](#L46) | foreach ( $ips as $ip ) { |
| [47](#L47) | $ip = $this->clean\_ip( $ip ); |
| [48](#L48) |  |
| [49](#L49) | // If the IP is in a private or reserved range, keep looking |
| [50](#L50) | if ( $ip == '127.0.0.1' || $ip == '::1' || $this->ip\_is\_private( $ip ) ) { |
| [51](#L51) | continue; |
| [52](#L52) | } else { |
| [53](#L53) | $this->user\_ip = $ip; |
| [54](#L54) |  |
| [55](#L55) | return $this->user\_ip; |
| [56](#L56) | } |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | $this->user\_ip = $this->clean\_ip( $\_SERVER['REMOTE\_ADDR'] ); |
| [60](#L60) |  |
| [61](#L61) | return $this->user\_ip; |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* Clean the IP address if altered |
| [67](#L67) | \* |
| [68](#L68) | \* @param $ip |
| [69](#L69) | \* |
| [70](#L70) | \* @return mixed|string |
| [71](#L71) | \*/ |
| [72](#L72) | public function clean\_ip( $ip ) { |
| [73](#L73) | $ip = trim( $ip ); |
| [74](#L74) |  |
| [75](#L75) | // Check for IPv4 IP cast as IPv6 |
| [76](#L76) | if ( preg\_match( '/^::ffff:(\d+\.\d+\.\d+\.\d+)$/', $ip, $matches ) ) { |
| [77](#L77) | $ip = $matches[1]; |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | return $ip; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* Checks an IP to see if it is within a private range |
| [86](#L86) | \* |
| [87](#L87) | \* @param  string  $ip |
| [88](#L88) | \* |
| [89](#L89) | \* @return bool |
| [90](#L90) | \*/ |
| [91](#L91) | public function ip\_is\_private( $ip ) { |
| [92](#L92) | $pri\_addrs = array( |
| [93](#L93) | '10.0.0.0|10.255.255.255', // single class A network |
| [94](#L94) | '172.16.0.0|172.31.255.255', // 16 contiguous class B network |
| [95](#L95) | '192.168.0.0|192.168.255.255', // 256 contiguous class C network |
| [96](#L96) | '169.254.0.0|169.254.255.255', // Link-local address also refered to as Automatic Private IP Addressing |
| [97](#L97) | '127.0.0.0|127.255.255.255' // localhost |
| [98](#L98) | ); |
| [99](#L99) |  |
| [100](#L100) | $long\_ip = ip2long( $ip ); |
| [101](#L101) | if ( $long\_ip != - 1 ) { |
| [102](#L102) |  |
| [103](#L103) | foreach ( $pri\_addrs as $pri\_addr ) { |
| [104](#L104) | list ( $start, $end ) = explode( '|', $pri\_addr ); |
| [105](#L105) |  |
| [106](#L106) | // IF IS PRIVATE |
| [107](#L107) | if ( $long\_ip >= ip2long( $start ) && $long\_ip <= ip2long( $end ) ) { |
| [108](#L108) | return true; |
| [109](#L109) | } |
| [110](#L110) | } |
| [111](#L111) | } |
| [112](#L112) |  |
| [113](#L113) | return false; |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | /\*\* |
| [117](#L117) | \* Generate a pivacy key |
| [118](#L118) | \* |
| [119](#L119) | \* @return string |
| [120](#L120) | \*/ |
| [121](#L121) | public function get\_privacy\_key() { |
| [122](#L122) | // Privacy key generation uses the NONCE\_SALT + admin email-- admin email is |
| [123](#L123) | // used to prevent identical privacy keys if NONCE\_SALT is not customized |
| [124](#L124) | return substr( md5( NONCE\_SALT . get\_site\_option( 'admin\_email' ) ), 5, 10 ); |
| [125](#L125) | } |
| [126](#L126) |  |
| [127](#L127) | /\*\* |
| [128](#L128) | \* Checks the status for a given IP. API results are cached as transients in the wp\_options table |
| [129](#L129) | \* |
| [130](#L130) | \* @return array|mixed |
| [131](#L131) | \* @throws Exception |
| [132](#L132) | \*/ |
| [133](#L133) | public function brute\_check\_loginability() { |
| [134](#L134) |  |
| [135](#L135) | $ip              = $this->brute\_get\_ip(); |
| [136](#L136) | $transient\_name  = 'hmwp\_brute\_' . md5( $ip ); |
| [137](#L137) | $transient\_value = $this->get\_transient( $transient\_name ); |
| [138](#L138) |  |
| [139](#L139) | //Never block login from whitelisted IPs |
| [140](#L140) | if ( $this->check\_whitelisted\_ip( $ip ) ) { |
| [141](#L141) | $transient\_value['status'] = 'whitelist'; |
| [142](#L142) |  |
| [143](#L143) | return $transient\_value; |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | //Check out our transients |
| [147](#L147) | if ( isset( $transient\_value['status'] ) && $transient\_value['status'] == 'ok' ) { |
| [148](#L148) | return $transient\_value; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | if ( isset( $transient\_value['status'] ) && $transient\_value['status'] == 'blocked' ) { |
| [152](#L152) | //there is a current block-- prevent login |
| [153](#L153) | $this->brute\_kill\_login(); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | //If we've reached this point, this means that the IP isn't cached. |
| [157](#L157) | //Now we check to see if we should allow login |
| [158](#L158) | $response = $this->brute\_call( 'check\_ip' ); |
| [159](#L159) |  |
| [160](#L160) | if ( $response['status'] == 'blocked' ) { |
| [161](#L161) | $this->brute\_kill\_login(); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | return $response; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | /\*\* |
| [168](#L168) | \* Check if the current IP address is whitelisted by the user |
| [169](#L169) | \* |
| [170](#L170) | \* @param  string  $ip |
| [171](#L171) | \* |
| [172](#L172) | \* @return bool |
| [173](#L173) | \*/ |
| [174](#L174) | public function check\_whitelisted\_ip( $ip ) { |
| [175](#L175) | if ( HMWP\_Classes\_Tools::isWhitelistedIP( $ip ) ) { |
| [176](#L176) | return true; |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | return false; |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | /\*\* |
| [183](#L183) | \* Get the current local host |
| [184](#L184) | \* |
| [185](#L185) | \* @return mixed|string |
| [186](#L186) | \*/ |
| [187](#L187) | public function brute\_get\_local\_host() { |
| [188](#L188) | if ( isset( $this->local\_host ) ) { |
| [189](#L189) | return $this->local\_host; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | $uri = 'http://' . strtolower( $\_SERVER['HTTP\_HOST'] ); |
| [193](#L193) |  |
| [194](#L194) | if ( HMWP\_Classes\_Tools::isMultisites() ) { |
| [195](#L195) | $uri = network\_home\_url(); |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | $uridata = wp\_parse\_url( $uri ); |
| [199](#L199) |  |
| [200](#L200) | $domain = $uridata['host']; |
| [201](#L201) |  |
| [202](#L202) | //if we still don't have it, get the site\_url |
| [203](#L203) | if ( ! $domain ) { |
| [204](#L204) | $uri     = get\_site\_url( 1 ); |
| [205](#L205) | $uridata = wp\_parse\_url( $uri ); |
| [206](#L206) | if ( isset( $uridata['host'] ) ) { |
| [207](#L207) | $domain = $uridata['host']; |
| [208](#L208) | } |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | $this->local\_host = $domain; |
| [212](#L212) |  |
| [213](#L213) | return $this->local\_host; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | /\*\* |
| [217](#L217) | \* Count the number of fail attempts |
| [218](#L218) | \* |
| [219](#L219) | \* @return false|int|mixed |
| [220](#L220) | \*/ |
| [221](#L221) | public function brute\_get\_blocked\_attempts() { |
| [222](#L222) | $blocked\_count = get\_site\_option( 'bruteprotect\_blocked\_attempt\_count' ); |
| [223](#L223) | if ( ! $blocked\_count ) { |
| [224](#L224) | $blocked\_count = 0; |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | return $blocked\_count; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) |  |
| [231](#L231) | /\*\* |
| [232](#L232) | \* Finds out if this site is using http or https |
| [233](#L233) | \* |
| [234](#L234) | \* @return string |
| [235](#L235) | \*/ |
| [236](#L236) | public function brute\_get\_protocol() { |
| [237](#L237) | return ( is\_ssl() ) ? "https://" : "http://"; |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | /\*\* |
| [241](#L241) | \* Get all IP headers so that we can process on our server... |
| [242](#L242) | \* |
| [243](#L243) | \* @return array |
| [244](#L244) | \*/ |
| [245](#L245) | public function brute\_get\_headers() { |
| [246](#L246) | $o = array(); |
| [247](#L247) |  |
| [248](#L248) | $ip\_related\_headers = array( |
| [249](#L249) | 'GD\_PHP\_HANDLER', |
| [250](#L250) | 'HTTP\_AKAMAI\_ORIGIN\_HOP', |
| [251](#L251) | 'HTTP\_CF\_CONNECTING\_IP', |
| [252](#L252) | 'HTTP\_CLIENT\_IP', |
| [253](#L253) | 'HTTP\_FASTLY\_CLIENT\_IP', |
| [254](#L254) | 'HTTP\_FORWARDED', |
| [255](#L255) | 'HTTP\_FORWARDED\_FOR', |
| [256](#L256) | 'HTTP\_INCAP\_CLIENT\_IP', |
| [257](#L257) | 'HTTP\_TRUE\_CLIENT\_IP', |
| [258](#L258) | 'HTTP\_X\_CLIENTIP', |
| [259](#L259) | 'HTTP\_X\_CLUSTER\_CLIENT\_IP', |
| [260](#L260) | 'HTTP\_X\_IP\_TRAIL', |
| [261](#L261) | 'HTTP\_X\_REAL\_IP', |
| [262](#L262) | 'HTTP\_X\_VARNISH', |
| [263](#L263) | 'REMOTE\_ADDR' |
| [264](#L264) |  |
| [265](#L265) | ); |
| [266](#L266) |  |
| [267](#L267) | foreach ( $ip\_related\_headers as $header ) { |
| [268](#L268) | if ( isset( $\_SERVER[ $header ] ) ) { |
| [269](#L269) | $o[ $header ] = $\_SERVER[ $header ]; |
| [270](#L270) | } |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | return $o; |
| [274](#L274) | } |
| [275](#L275) |  |
| [276](#L276) | /\*\* |
| [277](#L277) | \* process the brute call |
| [278](#L278) | \* |
| [279](#L279) | \* @param  string  $action  'check\_ip', 'check\_key', or 'failed\_attempt' |
| [280](#L280) | \* @param  array  $info  Any custom data to post to the api |
| [281](#L281) | \* |
| [282](#L282) | \* @return array|mixed |
| [283](#L283) | \* @throws Exception |
| [284](#L284) | \*/ |
| [285](#L285) | public function brute\_call( $action = 'check\_ip', $info = array() ) { |
| [286](#L286) | $ip             = $this->brute\_get\_ip(); |
| [287](#L287) | $transient\_name = 'hmwp\_brute\_' . md5( $ip ); |
| [288](#L288) | if ( ! $response = $this->get\_transient( $transient\_name ) ) { |
| [289](#L289) | $response = array(); |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | $attempts = ( isset( $response['attempts'] ) ? (int) $response['attempts'] : 0 ); |
| [293](#L293) |  |
| [294](#L294) | if ( $action == 'failed\_attempt' ) { |
| [295](#L295) | if ( $this->check\_whitelisted\_ip( $ip ) ) { |
| [296](#L296) | $response['status'] = 'ok'; |
| [297](#L297) |  |
| [298](#L298) | return $response; |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | $attempts = (int) $attempts + 1; |
| [302](#L302) |  |
| [303](#L303) | if ( $attempts >= HMWP\_Classes\_Tools::getOption( 'brute\_max\_attempts' ) ) { |
| [304](#L304) |  |
| [305](#L305) | //block current IP address |
| [306](#L306) | $this->block\_ip( $ip ); |
| [307](#L307) |  |
| [308](#L308) | if ( ! function\_exists( 'wp\_redirect' ) ) { |
| [309](#L309) | include\_once ABSPATH . WPINC . '/pluggable.php'; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | wp\_redirect( home\_url() ); |
| [313](#L313) | exit(); |
| [314](#L314) | } else { |
| [315](#L315) | $response['attempts'] = $attempts; |
| [316](#L316) | $response['status']   = 'ok'; |
| [317](#L317) |  |
| [318](#L318) | $this->set\_transient( $transient\_name, $response, (int) HMWP\_Classes\_Tools::getOption( 'brute\_max\_timeout' ) ); |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) |  |
| [322](#L322) | } elseif ( $action == 'check\_ip' ) { |
| [323](#L323) | $response['status'] = ( isset( $response['status'] ) ? $response['status'] : 'ok' ); |
| [324](#L324) |  |
| [325](#L325) | //Always block a banned IP |
| [326](#L326) | if ( $this->check\_banned\_ip( $ip ) ) { |
| [327](#L327) | $response['status'] = 'blocked'; |
| [328](#L328) | } |
| [329](#L329) |  |
| [330](#L330) | } elseif ( $action == 'clear\_ip' ) { |
| [331](#L331) | $this->delete\_transient( $transient\_name ); |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | return $response; |
| [335](#L335) | } |
| [336](#L336) |  |
| [337](#L337) | /\*\* |
| [338](#L338) | \* Block current IP address |
| [339](#L339) | \* |
| [340](#L340) | \* @param $ip |
| [341](#L341) | \* |
| [342](#L342) | \* @return void |
| [343](#L343) | \* @throws Exception |
| [344](#L344) | \*/ |
| [345](#L345) | public function block\_ip( $ip ) { |
| [346](#L346) |  |
| [347](#L347) | $transient\_name = 'hmwp\_brute\_' . md5( $ip ); |
| [348](#L348) |  |
| [349](#L349) | if ( ! $response = $this->get\_transient( $transient\_name ) ) { |
| [350](#L350) | $response = array(); |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $attempts = ( isset( $response['attempts'] ) ? (int) $response['attempts'] : 0 ); |
| [354](#L354) |  |
| [355](#L355) | $info['ip']       = $ip; |
| [356](#L356) | $info['host']     = $this->brute\_get\_local\_host(); |
| [357](#L357) | $info['protocol'] = $this->brute\_get\_protocol(); |
| [358](#L358) | $info['headers']  = json\_encode( $this->brute\_get\_headers() ); |
| [359](#L359) |  |
| [360](#L360) | $response             = array\_merge( $response, $info ); |
| [361](#L361) | $response['attempts'] = $attempts; |
| [362](#L362) | $response['status']   = 'blocked'; |
| [363](#L363) |  |
| [364](#L364) | $this->set\_transient( $transient\_name, $response, (int) HMWP\_Classes\_Tools::getOption( 'brute\_max\_timeout' ) ); |
| [365](#L365) |  |
| [366](#L366) | //Log the block IP on the server |
| [367](#L367) | HMWP\_Classes\_ObjController::getClass( 'HMWP\_Models\_Log' )->hmwp\_log\_actions( 'block\_ip', array( 'ip' => $ip ) ); |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Save the transient with the blocked IP in database |
| [372](#L372) | \* |
| [373](#L373) | \* @param $transient |
| [374](#L374) | \* @param $value |
| [375](#L375) | \* @param $expiration |
| [376](#L376) | \* |
| [377](#L377) | \* @return bool |
| [378](#L378) | \*/ |
| [379](#L379) | public function set\_transient( $transient, $value, $expiration ) { |
| [380](#L380) | if ( HMWP\_Classes\_Tools::isMultisites() && ! is\_main\_site() ) { |
| [381](#L381) | switch\_to\_blog( $this->get\_main\_blog\_id() ); |
| [382](#L382) | $return = set\_transient( $transient, $value, $expiration ); |
| [383](#L383) | restore\_current\_blog(); |
| [384](#L384) |  |
| [385](#L385) | return $return; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | return set\_transient( $transient, $value, $expiration ); |
| [389](#L389) | } |
| [390](#L390) |  |
| [391](#L391) | /\*\* |
| [392](#L392) | \* Delete the transient from database |
| [393](#L393) | \* |
| [394](#L394) | \* @param $transient |
| [395](#L395) | \* |
| [396](#L396) | \* @return bool |
| [397](#L397) | \*/ |
| [398](#L398) | public function delete\_transient( $transient ) { |
| [399](#L399) | if ( HMWP\_Classes\_Tools::isMultisites() && ! is\_main\_site() ) { |
| [400](#L400) | switch\_to\_blog( $this->get\_main\_blog\_id() ); |
| [401](#L401) | $return = delete\_transient( $transient ); |
| [402](#L402) | restore\_current\_blog(); |
| [403](#L403) |  |
| [404](#L404) | return $return; |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | return delete\_transient( $transient ); |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | /\*\* |
| [411](#L411) | \* Get the saved transient from database |
| [412](#L412) | \* |
| [413](#L413) | \* @param $transient |
| [414](#L414) | \* |
| [415](#L415) | \* @return mixed |
| [416](#L416) | \*/ |
| [417](#L417) | public function get\_transient( $transient ) { |
| [418](#L418) | if ( HMWP\_Classes\_Tools::isMultisites() && ! is\_main\_site() ) { |
| [419](#L419) | switch\_to\_blog( $this->get\_main\_blog\_id() ); |
| [420](#L420) | $return = get\_transient( $transient ); |
| [421](#L421) | restore\_current\_blog(); |
| [422](#L422) |  |
| [423](#L423) | return $return; |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | return get\_transient( $transient ); |
| [427](#L427) | } |
| [428](#L428) |  |
| [429](#L429) | /\*\* |
| [430](#L430) | \* If we're in a multisite network, return the blog ID of the primary blog |
| [431](#L431) | \* |
| [432](#L432) | \* @return int |
| [433](#L433) | \*/ |
| [434](#L434) | public function get\_main\_blog\_id() { |
| [435](#L435) | if ( defined( 'BLOG\_ID\_CURRENT\_SITE' ) ) { |
| [436](#L436) | return BLOG\_ID\_CURRENT\_SITE; |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | return 1; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) |  |
| [443](#L443) | /\*\* |
| [444](#L444) | \* Get all blocked IPs |
| [445](#L445) | \* |
| [446](#L446) | \* @return array |
| [447](#L447) | \*/ |
| [448](#L448) | public function get\_blocked\_ips() { |
| [449](#L449) | global $wpdb; |
| [450](#L450) | $ips     = array(); |
| [451](#L451) | $pattern = '\_transient\_timeout\_hmwp\_brute\_'; |
| [452](#L452) |  |
| [453](#L453) | //check 20 keyword at one time |
| [454](#L454) | $sql = $wpdb->prepare( "SELECT `option\_name` FROM `{$wpdb->options}` WHERE (`option\_name` LIKE %s) ORDER BY `option\_id` DESC", $pattern . '%' ); |
| [455](#L455) |  |
| [456](#L456) | if ( $rows = $wpdb->get\_results( $sql ) ) { |
| [457](#L457) | foreach ( $rows as $row ) { |
| [458](#L458) | if ( ! $transient\_value = $this->get\_transient( str\_replace( $pattern, 'hmwp\_brute\_', $row->option\_name ) ) ) { |
| [459](#L459) | $this->delete\_transient( str\_replace( $pattern, '', $row->option\_name ) ); |
| [460](#L460) | } elseif ( isset( $transient\_value['status'] ) && $transient\_value['status'] == 'blocked' ) { |
| [461](#L461) | $ips[ str\_replace( $pattern, 'hmwp\_brute\_', $row->option\_name ) ] = $transient\_value; |
| [462](#L462) | } |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) |  |
| [467](#L467) | return $ips; |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | /\*\* |
| [471](#L471) | \* Check if the IP address is already banned by the user |
| [472](#L472) | \* |
| [473](#L473) | \* @param $ip |
| [474](#L474) | \* |
| [475](#L475) | \* @return bool |
| [476](#L476) | \*/ |
| [477](#L477) | public function check\_banned\_ip( $ip ) { |
| [478](#L478) | //Never block login from whitelisted IPs |
| [479](#L479) | $banlist = HMWP\_Classes\_Tools::getOption( 'banlist\_ip' ); |
| [480](#L480) |  |
| [481](#L481) | if ( $banlist <> '' && is\_string( $banlist ) ) { |
| [482](#L482) | $bl\_items = @json\_decode( $banlist, true ); |
| [483](#L483) |  |
| [484](#L484) | //add the hook for users to add IPs in the blacklist |
| [485](#L485) | $bl\_items = apply\_filters( 'hmwp\_blacklisted\_ips', $bl\_items ); |
| [486](#L486) |  |
| [487](#L487) | if ( ! empty( $bl\_items ) ) { |
| [488](#L488) | foreach ( $bl\_items as $item ) { |
| [489](#L489) | $item = trim( $item ); |
| [490](#L490) | if ( $ip == $item ) { |
| [491](#L491) | return true; |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | if ( strpos( $item, '\*' ) === false ) { //no match, no wildcard |
| [495](#L495) | continue; |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | $iplong  = ip2long( $ip ); |
| [499](#L499) | $ip\_low  = ip2long( str\_replace( '\*', '0', $item ) ); |
| [500](#L500) | $ip\_high = ip2long( str\_replace( '\*', '255', $item ) ); |
| [501](#L501) |  |
| [502](#L502) | if ( $iplong >= $ip\_low && $iplong <= $ip\_high ) {//IP is within wildcard range |
| [503](#L503) | return true; |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | } |
| [507](#L507) | } |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | return false; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | /\*\* |
| [514](#L514) | \* Delete the IP address from database |
| [515](#L515) | \* |
| [516](#L516) | \* @param $transient |
| [517](#L517) | \* |
| [518](#L518) | \* @return void |
| [519](#L519) | \*/ |
| [520](#L520) | public function delete\_ip( $transient ) { |
| [521](#L521) | $this->delete\_transient( $transient ); |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) |  |
| [525](#L525) | /\*\* |
| [526](#L526) | \* Verifies that a user answered the math problem correctly while logging in. |
| [527](#L527) | \* |
| [528](#L528) | \* @param  mixed  $user |
| [529](#L529) | \* @param  mixed  $response |
| [530](#L530) | \* |
| [531](#L531) | \* @return mixed $user Returns the user if the math is correct |
| [532](#L532) | \*/ |
| [533](#L533) | public function brute\_math\_authenticate( $user, $response ) { |
| [534](#L534) | $salt        = HMWP\_Classes\_Tools::getOption( 'hmwp\_disable' ) . get\_site\_option( 'admin\_email' ); |
| [535](#L535) | $ans         = (int) HMWP\_Classes\_Tools::getValue( 'brute\_num', 0 ); |
| [536](#L536) | $salted\_ans  = sha1( $salt . $ans ); |
| [537](#L537) | $correct\_ans = HMWP\_Classes\_Tools::getValue( 'brute\_ck' ); |
| [538](#L538) |  |
| [539](#L539) | if ( $correct\_ans === false || $salted\_ans != $correct\_ans ) { |
| [540](#L540) | $user = new WP\_Error( 'authentication\_failed', sprintf( esc\_html\_\_( '%sYou failed to correctly answer the math problem.%s Please try again', 'hide-my-wp' ), '<strong>', '</strong>' ) ); |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | return $user; |
| [544](#L544) | } |
| [545](#L545) |  |
| [546](#L546) | /\*\* |
| [547](#L547) | \* Requires a user to solve a simple equation. Added to any WordPress login form. |
| [548](#L548) | \* |
| [549](#L549) | \* @return void outputs html |
| [550](#L550) | \*/ |
| [551](#L551) | public function brute\_math\_form() { |
| [552](#L552) | if ( ! HMWP\_Classes\_Tools::getOption( 'brute\_use\_math' ) ) { |
| [553](#L553) | return; |
| [554](#L554) | } |
| [555](#L555) | $salt = HMWP\_Classes\_Tools::getOption( 'hmwp\_disable' ) . get\_site\_option( 'admin\_email' ); |
| [556](#L556) | $num1 = rand( 0, 10 ); |
| [557](#L557) | $num2 = rand( 1, 10 ); |
| [558](#L558) | $sum  = $num1 + $num2; |
| [559](#L559) | $ans  = sha1( $salt . $sum ); |
| [560](#L560) | ?> |
| [561](#L561) | <div class="humanity"> |
| [562](#L562) | <strong><?php echo esc\_html\_\_( 'Prove your humanity:', 'hide-my-wp' ) ?> </strong> |
| [563](#L563) | <?php echo esc\_attr( $num1 ) ?> &nbsp; + &nbsp; <?php echo esc\_attr( $num2 ) ?> &nbsp; = &nbsp; |
| [564](#L564) | <input type="input" name="brute\_num" value="" size="2"/> |
| [565](#L565) | <input type="hidden" name="brute\_ck" value="<?php echo esc\_attr( $ans ); ?>" id="brute\_ck"/> |
| [566](#L566) | </div> |
| [567](#L567) | <style> |
| [568](#L568) | div.humanity { |
| [569](#L569) | margin: 5px 0 20px; |
| [570](#L570) | clear: both; |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | input[name=brute\_num] { |
| [574](#L574) | max-width: 60px; |
| [575](#L575) | } |
| [576](#L576) | </style> |
| [577](#L577) | <?php |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [581](#L581) | /\*\* |
| [582](#L582) | \* Verifies the Google Captcha while logging in. |
| [583](#L583) | \* |
| [584](#L584) | \* @param  mixed  $user |
| [585](#L585) | \* @param  mixed  $response |
| [586](#L586) | \* |
| [587](#L587) | \* @return mixed $user Returns the user if the math is correct |
| [588](#L588) | \* @throws WP\_Error message if the math is wrong |
| [589](#L589) | \*/ |
| [590](#L590) | public function brute\_catpcha\_authenticate( $user, $response ) { |
| [591](#L591) | $error\_message = false; |
| [592](#L592) |  |
| [593](#L593) | if ( HMWP\_Classes\_Tools::getOption( 'brute\_use\_captcha' ) ) { |
| [594](#L594) | $error\_message = $this->brute\_catpcha\_call(); |
| [595](#L595) | } elseif ( HMWP\_Classes\_Tools::getOption( 'brute\_use\_captcha\_v3' ) ) { |
| [596](#L596) | $error\_message = $this->brute\_catpcha\_v3\_call(); |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | if ( $error\_message ) { |
| [600](#L600) | $user = new WP\_Error( 'authentication\_failed', $error\_message ); |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | return $user; |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) |  |
| [607](#L607) | /\*\* |
| [608](#L608) | \* Call the reCaptcha V2 from Google |
| [609](#L609) | \*/ |
| [610](#L610) | public function brute\_catpcha\_call() { |
| [611](#L611) | $error\_message = false; |
| [612](#L612) | $error\_codes   = array( |
| [613](#L613) | 'missing-input-secret'   => esc\_html\_\_( 'The secret parameter is missing.', 'hide-my-wp' ), |
| [614](#L614) | 'invalid-input-secret'   => esc\_html\_\_( 'The secret parameter is invalid or malformed.', 'hide-my-wp' ), |
| [615](#L615) | 'missing-input-response' => esc\_html\_\_( 'Empty ReCaptcha. Please complete reCaptcha.', 'hide-my-wp' ), |
| [616](#L616) | 'timeout-or-duplicate'   => esc\_html\_\_( 'The response parameter is invalid or malformed.', 'hide-my-wp' ), |
| [617](#L617) | 'invalid-input-response' => esc\_html\_\_( 'The response parameter is invalid or malformed.', 'hide-my-wp' ) |
| [618](#L618) | ); |
| [619](#L619) |  |
| [620](#L620) | $captcha = HMWP\_Classes\_Tools::getValue( 'g-recaptcha-response', false ); |
| [621](#L621) | $secret  = HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_secret\_key' ); |
| [622](#L622) |  |
| [623](#L623) | if ( $secret <> '' ) { |
| [624](#L624) | $response = json\_decode( HMWP\_Classes\_Tools::hmwp\_remote\_get( "https://www.google.com/recaptcha/api/siteverify?secret=$secret&response=" . $captcha . "&remoteip=" . $\_SERVER['REMOTE\_ADDR'] ), true ); |
| [625](#L625) |  |
| [626](#L626) | if ( isset( $response['success'] ) && ! $response['success'] ) { |
| [627](#L627) | //If captcha errors, let the user login and fix the error |
| [628](#L628) | if ( isset( $response['error-codes'] ) && ! empty( $response['error-codes'] ) ) { |
| [629](#L629) | foreach ( $response['error-codes'] as $error\_code ) { |
| [630](#L630) | if ( isset( $error\_codes[ $error\_code ] ) ) { |
| [631](#L631) | $error\_message = $error\_codes[ $error\_code ]; |
| [632](#L632) | } |
| [633](#L633) | } |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | if ( ! $error\_message ) { |
| [637](#L637) | $error\_message = sprintf( esc\_html\_\_( '%sIncorrect ReCaptcha%s. Please try again', 'hide-my-wp' ), '<strong>', '</strong>' ); |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | return $error\_message; |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* reCAPTCHA head and login form |
| [648](#L648) | \*/ |
| [649](#L649) | public function brute\_recaptcha\_head() { |
| [650](#L650) | ?> |
| [651](#L651) | <script src='https://www.google.com/recaptcha/api.js?hl=<?php echo( HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_language' ) <> '' ? HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_language' ) : get\_locale() ) ?>' async defer></script> |
| [652](#L652) | <style>#login { |
| [653](#L653) | min-width: 354px; |
| [654](#L654) | }</style> |
| [655](#L655) | <?php |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* reCAPTCHA head and login form |
| [660](#L660) | \*/ |
| [661](#L661) | public function brute\_recaptcha\_form() { |
| [662](#L662) | if ( HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_site\_key' ) <> '' && HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_secret\_key' ) <> '' ) { |
| [663](#L663) | ?> |
| [664](#L664) | <div class="g-recaptcha" data-sitekey="<?php echo HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_site\_key' ) ?>" data-theme="<?php echo HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_theme' ) ?>" style="margin: 12px 0 24px 0;"></div> |
| [665](#L665) | <?php |
| [666](#L666) | } |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | /\*\* |
| [670](#L670) | \* Call the reCaptcha V3 from Google |
| [671](#L671) | \*/ |
| [672](#L672) | public function brute\_catpcha\_v3\_call() { |
| [673](#L673) |  |
| [674](#L674) | $error\_message = false; |
| [675](#L675) |  |
| [676](#L676) | if ( ! HMWP\_Classes\_Tools::getOption( 'brute\_use\_captcha\_v3' ) ) { |
| [677](#L677) | return false; |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | $error\_codes = array( |
| [681](#L681) | 'missing-input-secret'   => esc\_html\_\_( 'The secret parameter is missing.', 'hide-my-wp' ), |
| [682](#L682) | 'invalid-input-secret'   => esc\_html\_\_( 'The secret parameter is invalid or malformed.', 'hide-my-wp' ), |
| [683](#L683) | 'missing-input-response' => esc\_html\_\_( 'Empty ReCaptcha. Please complete reCaptcha.', 'hide-my-wp' ), |
| [684](#L684) | 'invalid-input-response' => esc\_html\_\_( 'The response parameter is invalid or malformed.', 'hide-my-wp' ), |
| [685](#L685) | 'timeout-or-duplicate'   => esc\_html\_\_( 'The response parameter is invalid or malformed.', 'hide-my-wp' ), |
| [686](#L686) | 'bad-request'            => esc\_html\_\_( 'The response parameter is invalid or malformed.', 'hide-my-wp' ) |
| [687](#L687) | ); |
| [688](#L688) |  |
| [689](#L689) | $captcha = HMWP\_Classes\_Tools::getValue( 'g-recaptcha-response' ); |
| [690](#L690) | $secret  = HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_secret\_key\_v3' ); |
| [691](#L691) |  |
| [692](#L692) | if ( $secret <> '' ) { |
| [693](#L693) | $response = json\_decode( HMWP\_Classes\_Tools::hmwp\_remote\_get( "https://www.google.com/recaptcha/api/siteverify?secret=$secret&response=" . $captcha . "&remoteip=" . $\_SERVER['REMOTE\_ADDR'] ), true ); |
| [694](#L694) |  |
| [695](#L695) | if ( isset( $response['success'] ) && ! $response['success'] ) { |
| [696](#L696) | //If captcha errors, let the user login and fix the error |
| [697](#L697) | if ( isset( $response['error-codes'] ) && ! empty( $response['error-codes'] ) ) { |
| [698](#L698) | foreach ( $response['error-codes'] as $error\_code ) { |
| [699](#L699) | if ( isset( $error\_codes[ $error\_code ] ) ) { |
| [700](#L700) | $error\_message = $error\_codes[ $error\_code ]; |
| [701](#L701) | } |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) |  |
| [705](#L705) | if ( ! $error\_message ) { |
| [706](#L706) | $error\_message = sprintf( esc\_html\_\_( '%sIncorrect ReCaptcha%s. Please try again', 'hide-my-wp' ), '<strong>', '</strong>' ); |
| [707](#L707) | } |
| [708](#L708) | } |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | return $error\_message; |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) | /\*\* |
| [715](#L715) | \* reCAPTCHA head and login form |
| [716](#L716) | \*/ |
| [717](#L717) | public function brute\_recaptcha\_head\_v3() { |
| [718](#L718) | ?> |
| [719](#L719) | <script src='https://www.google.com/recaptcha/api.js?render=<?php echo HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_site\_key\_v3' ) ?>' async defer></script> |
| [720](#L720) | <style>#login { |
| [721](#L721) | min-width: 354px; |
| [722](#L722) | }</style> |
| [723](#L723) | <?php |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | /\*\* |
| [727](#L727) | \* reCAPTCHA head and login form |
| [728](#L728) | \*/ |
| [729](#L729) | public function brute\_recaptcha\_form\_v3() { |
| [730](#L730) | if ( ! HMWP\_Classes\_Tools::getOption( 'brute\_use\_captcha\_v3' ) ) { |
| [731](#L731) | return; |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) | if ( HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_site\_key\_v3' ) <> '' && HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_secret\_key\_v3' ) <> '' ) { |
| [735](#L735) | ?> |
| [736](#L736) | <script> |
| [737](#L737) | function reCaptchaSubmit(e) { |
| [738](#L738) | var form = this; |
| [739](#L739) |  |
| [740](#L740) | e.preventDefault(); |
| [741](#L741) | grecaptcha.ready(function () { |
| [742](#L742) | grecaptcha.execute('<?php echo HMWP\_Classes\_Tools::getOption( 'brute\_captcha\_site\_key\_v3' ) ?>', {action: 'submit'}).then(function (token) { |
| [743](#L743) | var input = document.createElement("input"); |
| [744](#L744) | input.type = "hidden"; |
| [745](#L745) | input.name = "g-recaptcha-response"; |
| [746](#L746) | input.value = token; |
| [747](#L747) | form.appendChild(input); |
| [748](#L748) | HTMLFormElement.prototype.submit.call(form); |
| [749](#L749) | }); |
| [750](#L750) | }); |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | if (document.getElementsByTagName("form").length > 0) { |
| [754](#L754) | var x = document.getElementsByTagName("form"); |
| [755](#L755) | for (var i = 0; i < x.length; i++) { |
| [756](#L756) | x[i].addEventListener("submit", reCaptchaSubmit); |
| [757](#L757) | } |
| [758](#L758) | } |
| [759](#L759) | </script> |
| [760](#L760) | <?php |
| [761](#L761) | } |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) |  |
| [765](#L765) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [766](#L766) | /\*\* |
| [767](#L767) | \* Show the error message on IP address banned |
| [768](#L768) | \* |
| [769](#L769) | \* @return void |
| [770](#L770) | \*/ |
| [771](#L771) | public function brute\_kill\_login() { |
| [772](#L772) | do\_action( 'hmwp\_kill\_login', $this->brute\_get\_ip() ); |
| [773](#L773) |  |
| [774](#L774) | wp\_ob\_end\_flush\_all(); |
| [775](#L775) | wp\_die( HMWP\_Classes\_Tools::getOption( 'hmwp\_brute\_message' ), esc\_html\_\_( 'Login Blocked by Hide My WordPress', 'hide-my-wp' ), array( 'response' => 403 ) ); |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/hide-my-wp/trunk/models/Brute.php?format=txt)
* [Original Format](/export/3222676/hide-my-wp/trunk/models/Brute.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_9ec25e23_20250115_082530.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Hide My WP Ghost – Security Plugin <= 5.0.18 - IP Address Spoofing to Protection Mechanism Bypass

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Hide My WP Ghost – Security Plugin <= 5.0.18 - IP Address Spoofing to Protection Mechanism Bypass

6.5

**Use of Less Trusted Source**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N)

| CVE | [CVE-2022-4537](https://www.cve.org/CVERecord?id=CVE-2022-4537) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | May 8, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [rezaduty](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/rezaduty-1) |

### Description

The Hide My WP Ghost – Security Plugin plugin for WordPress is vulnerable to IP Address Spoofing in versions up to, and including, 5.0.18. This is due to insufficient restrictions on where the IP Address information is being retrieved for request logging and login restrictions. Attackers can supply the X-Forwarded-For header with with a different IP Address that will be logged and can be used to bypass settings that may have blocked out an IP address from logging in.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/hide-my-wp/tags/5.0.18/models/Brute.php#L131)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/hide-my-wp/trunk/models/Brute.php#L132)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhide-my-wp%2Fhide-my-wp-ghost-security-plugin-5018-ip-address-spoofing-to-protection-mechanism-bypass&t=Hide%20My%20WP%20Ghost%20%E2%80%93%20Security%20Plugin%20%3C%3D%205.0.18%20-%20IP%20Address%20Spoofing%20to%20Protection%20Mechanism%20Bypass "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhide-my-wp%2Fhide-my-wp-ghost-security-plugin-5018-ip-address-spoofing-to-protection-mechanism-bypass&text=Hide%20My%20WP%20Ghost%20%E2%80%93%20Security%20Plugin%20%3C%3D%205.0.18%20-%20IP%20Address%20Spoofing%20to%20Protection%20Mechanism%20Bypass "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhide-my-wp%2Fhide-my-wp-ghost-security-plugin-5018-ip-address-spoofing-to-protection-mechanism-bypass "LinkedIn")
Email

## Vulnerability Details for WP Ghost (Hide My WP Ghost) – Security & Firewall

#### [WP Ghost (Hide My WP Ghost) – Security & Firewall](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/hide-my-wp)

| Software Type | Plugin |
| --- | --- |
| Software Slug | hide-my-wp [(view on wordpress.org)](https://wordpress.org/plugins/hide-my-wp) |
| Patched? | Yes |
| Remediation | Update to version 5.0.20, or a newer patched version |
| Affected Version | * <= 5.0.18 |
| Patched Version | * 5.0.20 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


