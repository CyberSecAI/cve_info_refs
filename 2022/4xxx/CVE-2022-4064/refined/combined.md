=== Content from github.com_354b6511_20250114_223406.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fpull%2F933)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fpull%2F933)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=petergoldstein%2Fdalli)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[petergoldstein](/petergoldstein)
/
**[dalli](/petergoldstein/dalli)**
Public

* [Notifications](/login?return_to=%2Fpetergoldstein%2Fdalli) You must be signed in to change notification settings
* [Fork
  453](/login?return_to=%2Fpetergoldstein%2Fdalli)
* [Star
   3.1k](/login?return_to=%2Fpetergoldstein%2Fdalli)

* [Code](/petergoldstein/dalli)
* [Issues
  15](/petergoldstein/dalli/issues)
* [Pull requests
  7](/petergoldstein/dalli/pulls)
* [Discussions](/petergoldstein/dalli/discussions)
* [Actions](/petergoldstein/dalli/actions)
* [Projects
  0](/petergoldstein/dalli/projects)
* [Wiki](/petergoldstein/dalli/wiki)
* [Security](/petergoldstein/dalli/security)
* [Insights](/petergoldstein/dalli/pulse)

Additional navigation options

* [Code](/petergoldstein/dalli)
* [Issues](/petergoldstein/dalli/issues)
* [Pull requests](/petergoldstein/dalli/pulls)
* [Discussions](/petergoldstein/dalli/discussions)
* [Actions](/petergoldstein/dalli/actions)
* [Projects](/petergoldstein/dalli/projects)
* [Wiki](/petergoldstein/dalli/wiki)
* [Security](/petergoldstein/dalli/security)
* [Insights](/petergoldstein/dalli/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpetergoldstein%2Fdalli%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpetergoldstein%2Fdalli%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fixes #932 #933

 Merged

[petergoldstein](/petergoldstein)
merged 4 commits into
[main](/petergoldstein/dalli/tree/main "petergoldstein/dalli:main")
from
[bugfix/932](/petergoldstein/dalli/tree/bugfix/932 "petergoldstein/dalli:bugfix/932")

Oct 27, 2022

 Merged

# [Fixes #932](#top) #933

[petergoldstein](/petergoldstein)
merged 4 commits into
[main](/petergoldstein/dalli/tree/main "petergoldstein/dalli:main")
from
[bugfix/932](/petergoldstein/dalli/tree/bugfix/932 "petergoldstein/dalli:bugfix/932")

Oct 27, 2022

[Conversation
1](/petergoldstein/dalli/pull/933)
[Commits
4](/petergoldstein/dalli/pull/933/commits)
[Checks
0](/petergoldstein/dalli/pull/933/checks)
[Files changed](/petergoldstein/dalli/pull/933/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![petergoldstein](https://avatars.githubusercontent.com/u/421488?s=60&v=4)](/petergoldstein)

Copy link

Owner

### @petergoldstein **[petergoldstein](/petergoldstein)** commented [Oct 25, 2022](#issue-1422929408) • edited Loading

Do some input sanitization for the meta protocol. Since this protocol uses raw test, it is possible to execute an injection attack against unsanitized inputs.

This PR explicitly sanitizes the CAS arguments and the ttl passed to flush.

I also added some missing tests for `meta_arithmetic` and fixed a few lints.

Sorry, something went wrong.

All reactions

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&v=4)](/petergoldstein)

`[Fixes](/petergoldstein/dalli/pull/933/commits/98d063f3fc26511f6d4b845a3dd1305197dda0b6 "Fixes #932

Sanitizes the flush input for the meta protocol") [#932](https://github.com/petergoldstein/dalli/issues/932)`
 …

`[98d063f](/petergoldstein/dalli/pull/933/commits/98d063f3fc26511f6d4b845a3dd1305197dda0b6)`

```
Sanitizes the flush input for the meta protocol
```

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=80&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)

Copy link

Owner

Author

### **[petergoldstein](/petergoldstein)** commented [Oct 25, 2022](#issuecomment-1291006878)

| [@xhzeem](https://github.com/xhzeem) I believe this will address the issue you raised. Feel free to comment. Thanks again. |
| --- |

 ❤️
1
 xhzeem reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

 [petergoldstein](/petergoldstein)
added 3 commits
[October 26, 2022 08:39](#commits-pushed-97956e3)

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&v=4)](/petergoldstein)

`[Add CHANGELOG entry](/petergoldstein/dalli/pull/933/commits/97956e3dbff032e36a1e158fe86ad709f4325156 "Add CHANGELOG entry")`

`[97956e3](/petergoldstein/dalli/pull/933/commits/97956e3dbff032e36a1e158fe86ad709f4325156)`

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&v=4)](/petergoldstein)

`[Add CAS sanitization and addiitonal tests](/petergoldstein/dalli/pull/933/commits/3671d7e48fbdf0fac26165070469450a789211c4 "Add CAS sanitization and addiitonal tests")`

`[3671d7e](/petergoldstein/dalli/pull/933/commits/3671d7e48fbdf0fac26165070469450a789211c4)`

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&v=4)](/petergoldstein)

`[Do some linting](/petergoldstein/dalli/pull/933/commits/319c3eed72381fcf03ae99c78a8694fcb028872d "Do some linting")`

`[319c3ee](/petergoldstein/dalli/pull/933/commits/319c3eed72381fcf03ae99c78a8694fcb028872d)`

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)
[petergoldstein](/petergoldstein)
merged commit [`48d594d`](/petergoldstein/dalli/commit/48d594dae55934476fec61789e7a7c3700e0f50d)
into
main

[Oct 27, 2022](https://github.com/petergoldstein/dalli/pull/933#event-7686124879)

 [![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)
[petergoldstein](/petergoldstein)
deleted the
bugfix/932

branch
[October 27, 2022 21:58](#event-7686125182)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fpull%2F933)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

1 participant

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=52&v=4)](/petergoldstein)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_cd31497f_20250114_223403.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fissues%2F932)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fissues%2F932)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=petergoldstein%2Fdalli)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[petergoldstein](/petergoldstein)
/
**[dalli](/petergoldstein/dalli)**
Public

* [Notifications](/login?return_to=%2Fpetergoldstein%2Fdalli) You must be signed in to change notification settings
* [Fork
  453](/login?return_to=%2Fpetergoldstein%2Fdalli)
* [Star
   3.1k](/login?return_to=%2Fpetergoldstein%2Fdalli)

* [Code](/petergoldstein/dalli)
* [Issues
  15](/petergoldstein/dalli/issues)
* [Pull requests
  7](/petergoldstein/dalli/pulls)
* [Discussions](/petergoldstein/dalli/discussions)
* [Actions](/petergoldstein/dalli/actions)
* [Projects
  0](/petergoldstein/dalli/projects)
* [Wiki](/petergoldstein/dalli/wiki)
* [Security](/petergoldstein/dalli/security)
* [Insights](/petergoldstein/dalli/pulse)

Additional navigation options

* [Code](/petergoldstein/dalli)
* [Issues](/petergoldstein/dalli/issues)
* [Pull requests](/petergoldstein/dalli/pulls)
* [Discussions](/petergoldstein/dalli/discussions)
* [Actions](/petergoldstein/dalli/actions)
* [Projects](/petergoldstein/dalli/projects)
* [Wiki](/petergoldstein/dalli/wiki)
* [Security](/petergoldstein/dalli/security)
* [Insights](/petergoldstein/dalli/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpetergoldstein%2Fdalli%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpetergoldstein%2Fdalli%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Meta protocol flush\_all method is vulnerable to code injection (Lack of input type check) #932

Closed

[xhzeem](/xhzeem) opened this issue
Oct 25, 2022
· 7 comments

Closed

# [Meta protocol flush\_all method is vulnerable to code injection (Lack of input type check)](#top) #932

[xhzeem](/xhzeem) opened this issue
Oct 25, 2022
· 7 comments

## Comments

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=80&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)

Copy link

### **[xhzeem](/xhzeem)** commented [Oct 25, 2022](#issue-1422799445) • edited Loading

| Hi there, I'm a security researcher currently doing research on Memcached wrappers vulnerabilities. I was doing some source code reviewing on your wrapper and noticed that the `flush_all` method on the meta protocol takes a delay value and passes it to the server without any checks, which can be used to smuggle commands to the Memcached server if an attacker has control over the value passed to the flush\_all method.     [dalli/lib/dalli/protocol/meta.rb](https://github.com/petergoldstein/dalli/blob/5588d98f79eb04a9abcaeeff3263e08f93468b30/lib/dalli/protocol/meta.rb#L137-L140)  Lines 137 to 140 in [5588d98](/petergoldstein/dalli/commit/5588d98f79eb04a9abcaeeff3263e08f93468b30)   |  | def flush(delay = 0) | | --- | --- | |  | write(RequestFormatter.flush(delay: delay)) | |  | response\_processor.flush unless quiet? | |  | end |         [dalli/lib/dalli/protocol/meta/request\_formatter.rb](https://github.com/petergoldstein/dalli/blob/5588d98f79eb04a9abcaeeff3263e08f93468b30/lib/dalli/protocol/meta/request_formatter.rb#L76-L81)  Lines 76 to 81 in [5588d98](/petergoldstein/dalli/commit/5588d98f79eb04a9abcaeeff3263e08f93468b30)   |  | def self.flush(delay: nil, quiet: false) | | --- | --- | |  | cmd = +'flush\_all' | |  | cmd << " #{delay}" if delay | |  | cmd << ' noreply' if quiet | |  | cmd + TERMINATOR | |  | end |     Proof of Concept ``` require 'dalli'  # Proof of Concept by @xhzeem $mcmeta = Dalli::Client.new('localhost:11211', protocol: :meta) $mcmeta.set('xhzeem','meta') $mcmeta.get("xhzeem") # b64_if_reg_match(\s) puts $mcmeta.flush_all("\nset xhzeem 1 1000 8\ninjected") # :D ``` Suggested Fix: You should just add a simple check for the `delay` type and confirm it's a number or keep the 0 value. |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| The text was updated successfully, but these errors were encountered: |

 👍
1
 feliperaul reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=40&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)
[xhzeem](/xhzeem)
changed the title
~~Meta protocol flush\_all function is vulnerable to code injection (Lack of input type check)~~
Meta protocol flush\_all method is vulnerable to code injection (Lack of input type check)
[Oct 25, 2022](#event-7665680428)

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=80&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)

Copy link

Owner

### **[petergoldstein](/petergoldstein)** commented [Oct 25, 2022](#issuecomment-1290960705)

| Thanks [@xhzeem](https://github.com/xhzeem) - very helpful. While I'm not sure that the threat surface here is that large (if you have control over the flush\_all argument you probably have control over the Dalli client), but I agree that this should be sanitized. I'll get a fix in shortly. |
| --- |

All reactions

Sorry, something went wrong.

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=80&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)

Copy link

Author

### **[xhzeem](/xhzeem)** commented [Oct 25, 2022](#issuecomment-1290970560) • edited Loading

| Thanks for your fast response... Indeed the impact isn't very high for this case as the `flush_all` method will not be controlled by the user in most cases, in a case where a user sets a timer to restore or similar.  Anyway, the point here is not about being able to write ruby code, but instead passing unsafe user-controlled data to that method which can be used in some cases by malicious actors to inject more commands into the Memcached server. |
| --- |

All reactions

Sorry, something went wrong.

[petergoldstein](/petergoldstein)
added a commit
that referenced
this issue
[Oct 25, 2022](#ref-commit-98d063f)
[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)

`[Fixes](/petergoldstein/dalli/commit/98d063f3fc26511f6d4b845a3dd1305197dda0b6 "Fixes #932

Sanitizes the flush input for the meta protocol") [#932](https://github.com/petergoldstein/dalli/issues/932)`
…

`[98d063f](/petergoldstein/dalli/commit/98d063f3fc26511f6d4b845a3dd1305197dda0b6)`

```
Sanitizes the flush input for the meta protocol
```

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=80&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)

Copy link

Author

### **[xhzeem](/xhzeem)** commented [Oct 25, 2022](#issuecomment-1291254294)

| I see the fix is sufficient. Nice job |
| --- |

All reactions

Sorry, something went wrong.

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=80&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)

Copy link

Author

### **[xhzeem](/xhzeem)** commented [Oct 26, 2022](#issuecomment-1291277429)

| I’ll do some final checks today and confirm I cannot find any other similar issues |
| --- |

All reactions

Sorry, something went wrong.

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=80&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)

Copy link

Author

### **[xhzeem](/xhzeem)** commented [Oct 26, 2022](#issuecomment-1292029194)

| I'm unable to get some tests done right so if you can help to confirm     [dalli/lib/dalli/protocol/meta.rb](https://github.com/petergoldstein/dalli/blob/5588d98f79eb04a9abcaeeff3263e08f93468b30/lib/dalli/protocol/meta.rb#L111)  Line 111 in [5588d98](/petergoldstein/dalli/commit/5588d98f79eb04a9abcaeeff3263e08f93468b30)   |  | def delete(key, cas) | | --- | --- |     How should I call this method and pass the `cas`?      [dalli/lib/dalli/protocol/meta.rb](https://github.com/petergoldstein/dalli/blob/5588d98f79eb04a9abcaeeff3263e08f93468b30/lib/dalli/protocol/meta.rb#L46)  Line 46 in [5588d98](/petergoldstein/dalli/commit/5588d98f79eb04a9abcaeeff3263e08f93468b30)   |  | def touch(key, ttl) | | --- | --- |     The touch function is lacking the `ttl = TtlSanitizer.sanitize(ttl) if ttl` part, but as far as my tests it is still only accepting numbers in the TTL, I cannot get the flow exactly.   If you can confirm those two methods are safe I think everything else is good so far as of my checks. **delete** => `cas` variable **touch** => `ttl` variable |
| --- | --- | --- | --- | --- |

All reactions

Sorry, something went wrong.

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=80&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)

Copy link

Owner

### **[petergoldstein](/petergoldstein)** commented [Oct 26, 2022](#issuecomment-1292350009)

| [@xhzeem](https://github.com/xhzeem) I'll take a look.  I don't think Dalli does any material checking on the format of the CAS, but memcached does require the CAS to be a 64-bit value. So that's an easy sanitize. I'll add that and a corresponding test.  Regarding touch, the ttl is sanitized at the `Dalli::Client` level I believe. |
| --- |

All reactions

Sorry, something went wrong.

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&u=b7bba737453f0ac9a5ab6d1cefd6a153b1ed3e22&v=4)](/petergoldstein)
[petergoldstein](/petergoldstein)
closed this as [completed](/petergoldstein/dalli/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
`[48d594d](/petergoldstein/dalli/commit/48d594dae55934476fec61789e7a7c3700e0f50d)`
[Oct 27, 2022](#event-7686125019)

[![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=80&u=f955099b4611f5e2b6194c7f2061651b785bad51&v=4)](/xhzeem)

Copy link

Author

### **[xhzeem](/xhzeem)** commented [Oct 29, 2022](#issuecomment-1295838215)

| Good job I've checked the lastest version and to me, everything looks great. |
| --- |

 👍
1
 petergoldstein reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[alexander-cit](/alexander-cit)
added a commit
to CitizenLabDotCo/citizenlab
that referenced
this issue
[Nov 24, 2022](#ref-commit-0b5e692)
[![@alexander-cit](https://avatars.githubusercontent.com/u/91883434?s=40&v=4)](/alexander-cit)

`[Upgrade dalli due to failing bundle-audit check](/CitizenLabDotCo/citizenlab/commit/0b5e6924e7a5ff4a12b6eea5e0f7e6fdbdbf785e "Upgrade dalli due to failing `bundle-audit check`

https://github.com/petergoldstein/dalli/issues/932
https://app.circleci.com/pipelines/github/CitizenLabDotCo/citizenlab/70922/workflows/16c44c8a-c645-40dc-9729-1e7d4e731260/jobs/156153")`
…

`[0b5e692](/CitizenLabDotCo/citizenlab/commit/0b5e6924e7a5ff4a12b6eea5e0f7e6fdbdbf785e)`

```
[petergoldstein/dalli#932](https://github.com/petergoldstein/dalli/issues/932)
<https://app.circleci.com/pipelines/github/CitizenLabDotCo/citizenlab/70922/workflows/16c44c8a-c645-40dc-9729-1e7d4e731260/jobs/156153>
```

[![@alexander-cit](https://avatars.githubusercontent.com/u/91883434?s=40&v=4)](/alexander-cit)
[alexander-cit](/alexander-cit)
mentioned this issue
[Nov 24, 2022](#ref-pullrequest-1463149826)

[Upgrade dalli due to failing `bundle-audit check`
CitizenLabDotCo/citizenlab#3304](/CitizenLabDotCo/citizenlab/pull/3304)
 Merged

[agrare](/agrare)
added a commit
to agrare/manageiq
that referenced
this issue
[Nov 28, 2022](#ref-commit-ad86a15)
[![@agrare](https://avatars.githubusercontent.com/u/12851112?s=40&u=e9efc9f5afabfc2e35b2d06c3d691087e4d3fae7&v=4)](/agrare)

`[Bump dalli gem to 3.2.3](/agrare/manageiq/commit/ad86a15e491ae084373e549292499d1f275e317a "Bump dalli gem to 3.2.3

Security fix for https://github.com/petergoldstein/dalli/issues/932")`
…

`[ad86a15](/agrare/manageiq/commit/ad86a15e491ae084373e549292499d1f275e317a)`

```
Security fix for [petergoldstein/dalli#932](https://github.com/petergoldstein/dalli/issues/932)
```

[![@agrare](https://avatars.githubusercontent.com/u/12851112?s=40&u=e9efc9f5afabfc2e35b2d06c3d691087e4d3fae7&v=4)](/agrare)
[agrare](/agrare)
mentioned this issue
[Nov 28, 2022](#ref-pullrequest-1466633537)

[Bump dalli gem to 3.2.3
ManageIQ/manageiq#22253](/ManageIQ/manageiq/pull/22253)
 Merged

[GilbertCherrie](/GilbertCherrie)
pushed a commit
to GilbertCherrie/manageiq
that referenced
this issue
[Jul 7, 2023](#ref-commit-13b196d)
[![@agrare](https://avatars.githubusercontent.com/u/12851112?s=40&u=e9efc9f5afabfc2e35b2d06c3d691087e4d3fae7&v=4)](/agrare) [![@GilbertCherrie](https://avatars.githubusercontent.com/u/32444791?s=40&v=4)](/GilbertCherrie)

`[Bump dalli gem to 3.2.3](/GilbertCherrie/manageiq/commit/13b196dc1a78b8993997961ed4d372df9c1825e0 "Bump dalli gem to 3.2.3

Security fix for https://github.com/petergoldstein/dalli/issues/932")`
…

`[13b196d](/GilbertCherrie/manageiq/commit/13b196dc1a78b8993997961ed4d372df9c1825e0)`

```
Security fix for [petergoldstein/dalli#932](https://github.com/petergoldstein/dalli/issues/932)
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fissues%2F932)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=52&v=4)](/petergoldstein) [![@xhzeem](https://avatars.githubusercontent.com/u/34074156?s=52&v=4)](/xhzeem)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_47ee3519_20250114_223402.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fcommit%2F48d594dae55934476fec61789e7a7c3700e0f50d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fcommit%2F48d594dae55934476fec61789e7a7c3700e0f50d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=petergoldstein%2Fdalli)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[petergoldstein](/petergoldstein)
/
**[dalli](/petergoldstein/dalli)**
Public

* [Notifications](/login?return_to=%2Fpetergoldstein%2Fdalli) You must be signed in to change notification settings
* [Fork
  453](/login?return_to=%2Fpetergoldstein%2Fdalli)
* [Star
   3.1k](/login?return_to=%2Fpetergoldstein%2Fdalli)

* [Code](/petergoldstein/dalli)
* [Issues
  15](/petergoldstein/dalli/issues)
* [Pull requests
  7](/petergoldstein/dalli/pulls)
* [Discussions](/petergoldstein/dalli/discussions)
* [Actions](/petergoldstein/dalli/actions)
* [Projects
  0](/petergoldstein/dalli/projects)
* [Wiki](/petergoldstein/dalli/wiki)
* [Security](/petergoldstein/dalli/security)
* [Insights](/petergoldstein/dalli/pulse)

Additional navigation options

* [Code](/petergoldstein/dalli)
* [Issues](/petergoldstein/dalli/issues)
* [Pull requests](/petergoldstein/dalli/pulls)
* [Discussions](/petergoldstein/dalli/discussions)
* [Actions](/petergoldstein/dalli/actions)
* [Projects](/petergoldstein/dalli/projects)
* [Wiki](/petergoldstein/dalli/wiki)
* [Security](/petergoldstein/dalli/security)
* [Insights](/petergoldstein/dalli/pulse)

## Commit

[Permalink](/petergoldstein/dalli/commit/48d594dae55934476fec61789e7a7c3700e0f50d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fixes [#932](https://github.com/petergoldstein/dalli/issues/932) ([#933](https://github.com/petergoldstein/dalli/pull/933))

[Browse files](/petergoldstein/dalli/tree/48d594dae55934476fec61789e7a7c3700e0f50d)
Browse the repository at this point in the history

```
Do some input sanitization for the meta protocol. Since this protocol uses raw test, it is possible to execute an injection attack against unsanitized inputs.

This commit explicitly sanitizes the CAS arguments and the ttl passed to flush.

I also added some missing tests for meta_arithmetic and fixed a few lints.
```

* Loading branch information

[![@petergoldstein](https://avatars.githubusercontent.com/u/421488?s=40&v=4)](/petergoldstein)

[petergoldstein](/petergoldstein/dalli/commits?author=petergoldstein "View all commits by petergoldstein")
authored
Oct 27, 2022

1 parent
[a8611e2](/petergoldstein/dalli/commit/a8611e25a0b6b936b79741e41cb4d24ac8d66d0f)

commit 48d594d

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**133 additions**
and
**14 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGELOG.md
  [CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed)
* lib/dalli/protocol

  + lib/dalli/protocol/meta.rb
    [meta.rb](#diff-86a6eb4c874742e1a39df61d9242c495a1e34c08df4081c6b44c8eb62d869cec)
  + meta

    - lib/dalli/protocol/meta/request\_formatter.rb
      [request\_formatter.rb](#diff-5e562803ac2c661730789e3c7f144a0d2c379874722382832b4f851883e871a8)
* test

  + integration

    - test/integration/test\_network.rb
      [test\_network.rb](#diff-fe43ad19c5507a22f889cbc3ff658a511949a466e10ed744ea9d95f56c00af7e)
  + protocol/meta

    - test/protocol/meta/test\_request\_formatter.rb
      [test\_request\_formatter.rb](#diff-59af085589f08d953f8df46bee20c097f76613ba201bc3e2af441a6f6376a140)
  + test/test\_rack\_session.rb
    [test\_rack\_session.rb](#diff-03cbc5a62f9ead31ccd064c1ac27b7953208ebe2e69248887b709dd4fc2dff3e)

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed "CHANGELOG.md")

Show comments

[View file](/petergoldstein/dalli/blob/48d594dae55934476fec61789e7a7c3700e0f50d/CHANGELOG.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -4,6 +4,8 @@ Dalli Changelog |
|  |  | Unreleased |
|  |  | ========== |
|  |  |  |
|  |  | - Sanitize CAS inputs to ensure additional commands are not passed to memcached (xhzeem / petergoldstein) |
|  |  | - Sanitize input to flush command to ensure additional commands are not passed to memcached (xhzeem / petergoldstein) |
|  |  | - Namespaces passed as procs are now evaluated every time, as opposed to just on initialization (nrw505) |
|  |  | - Fix missing require of uri in ServerConfigParser (adam12) |
|  |  | - Fix link to the CHANGELOG.md file in README.md (rud) |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[lib/dalli/protocol/meta.rb](#diff-86a6eb4c874742e1a39df61d9242c495a1e34c08df4081c6b44c8eb62d869cec "lib/dalli/protocol/meta.rb")

Show comments

[View file](/petergoldstein/dalli/blob/48d594dae55934476fec61789e7a7c3700e0f50d/lib/dalli/protocol/meta.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -44,6 +44,7 @@ def gat(key, ttl, options = nil) |
|  |  | end |
|  |  |  |
|  |  | def touch(key, ttl) |
|  |  | ttl = TtlSanitizer.sanitize(ttl) |
|  |  | encoded\_key, base64 = KeyRegularizer.encode(key) |
|  |  | req = RequestFormatter.meta\_get(key: encoded\_key, ttl: ttl, value: false, base64: base64) |
|  |  | write(req) |
| Expand Down | |  |

23 changes: 18 additions & 5 deletions

23
[lib/dalli/protocol/meta/request\_formatter.rb](#diff-5e562803ac2c661730789e3c7f144a0d2c379874722382832b4f851883e871a8 "lib/dalli/protocol/meta/request_formatter.rb")

Show comments

[View file](/petergoldstein/dalli/blob/48d594dae55934476fec61789e7a7c3700e0f50d/lib/dalli/protocol/meta/request_formatter.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,7 +31,7 @@ def self.meta\_set(key:, value:, bitflags: nil, cas: nil, ttl: nil, mode: :set, b |
|  |  | cmd << ' c' unless %i[append prepend].include?(mode) |
|  |  | cmd << ' b' if base64 |
|  |  | cmd << " F#{bitflags}" if bitflags |
|  |  | cmd << " C#{cas}" if cas && !cas.zero? |
|  |  | cmd << cas\_string(cas) |
|  |  | cmd << " T#{ttl}" if ttl |
|  |  | cmd << " M#{mode\_to\_token(mode)}" |
|  |  | cmd << ' q' if quiet |
| Expand All | | @@ -43,7 +43,7 @@ def self.meta\_set(key:, value:, bitflags: nil, cas: nil, ttl: nil, mode: :set, b |
|  |  | def self.meta\_delete(key:, cas: nil, ttl: nil, base64: false, quiet: false) |
|  |  | cmd = "md #{key}" |
|  |  | cmd << ' b' if base64 |
|  |  | cmd << " C#{cas}" if cas && !cas.zero? |
|  |  | cmd << cas\_string(cas) |
|  |  | cmd << " T#{ttl}" if ttl |
|  |  | cmd << ' q' if quiet |
|  |  | cmd + TERMINATOR |
| Expand All | | @@ -54,8 +54,9 @@ def self.meta\_arithmetic(key:, delta:, initial:, incr: true, cas: nil, ttl: nil, |
|  |  | cmd << ' b' if base64 |
|  |  | cmd << " D#{delta}" if delta |
|  |  | cmd << " J#{initial}" if initial |
|  |  | cmd << " C#{cas}" if cas && !cas.zero? |
|  |  | cmd << " N#{ttl}" if ttl |
|  |  | # Always set a TTL if an initial value is specified |
|  |  | cmd << " N#{ttl || 0}" if ttl || initial |
|  |  | cmd << cas\_string(cas) |
|  |  | cmd << ' q' if quiet |
|  |  | cmd << " M#{incr ? 'I' : 'D'}" |
|  |  | cmd + TERMINATOR |
| Expand All | | @@ -75,7 +76,7 @@ def self.version |
|  |  |  |
|  |  | def self.flush(delay: nil, quiet: false) |
|  |  | cmd = +'flush\_all' |
|  |  | cmd << " #{delay}" if delay |
|  |  | cmd << " #{parse\_to\_64\_bit\_int(delay, 0)}" if delay |
|  |  | cmd << ' noreply' if quiet |
|  |  | cmd + TERMINATOR |
|  |  | end |
| Expand All | | @@ -102,6 +103,18 @@ def self.mode\_to\_token(mode) |
|  |  | end |
|  |  | end |
|  |  | # rubocop:enable Metrics/MethodLength |
|  |  |  |
|  |  | def self.cas\_string(cas) |
|  |  | cas = parse\_to\_64\_bit\_int(cas, nil) |
|  |  | cas.nil? || cas.zero? ? '' : " C#{cas}" |
|  |  | end |
|  |  |  |
|  |  | def self.parse\_to\_64\_bit\_int(val, default) |
|  |  | val.nil? ? nil : Integer(val) |
|  |  | rescue ArgumentError |
|  |  | # Sanitize to default if it isn't parsable as an integer |
|  |  | default |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  | end |
| Expand Down | |  |

12 changes: 6 additions & 6 deletions

12
[test/integration/test\_network.rb](#diff-fe43ad19c5507a22f889cbc3ff658a511949a466e10ed744ea9d95f56c00af7e "test/integration/test_network.rb")

Show comments

[View file](/petergoldstein/dalli/blob/48d594dae55934476fec61789e7a7c3700e0f50d/test/integration/test_network.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,17 +7,17 @@ |
|  |  | describe "using the #{p} protocol" do |
|  |  | describe 'assuming a bad network' do |
|  |  | it 'handle no server available' do |
|  |  | dc = Dalli::Client.new 'localhost:19333' |
|  |  | assert\_raises Dalli::RingError, message: 'No server available' do |
|  |  | dc = Dalli::Client.new 'localhost:19333' |
|  |  | dc.get 'foo' |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe 'with a fake server' do |
|  |  | it 'handle connection reset' do |
|  |  | memcached\_mock(->(sock) { sock.close }) do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | assert\_raises Dalli::RingError, message: 'No server available' do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | dc.get('abc') |
|  |  | end |
|  |  | end |
| Expand All | | @@ -26,17 +26,17 @@ |
|  |  | it 'handle connection reset with unix socket' do |
|  |  | socket\_path = MemcachedMock::UNIX\_SOCKET\_PATH |
|  |  | memcached\_mock(->(sock) { sock.close }, :start\_unix, socket\_path) do |
|  |  | dc = Dalli::Client.new(socket\_path) |
|  |  | assert\_raises Dalli::RingError, message: 'No server available' do |
|  |  | dc = Dalli::Client.new(socket\_path) |
|  |  | dc.get('abc') |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | it 'handle malformed response' do |
|  |  | memcached\_mock(->(sock) { sock.write('123') }) do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | assert\_raises Dalli::RingError, message: 'No server available' do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | dc.get('abc') |
|  |  | end |
|  |  | end |
| Expand All | | @@ -47,8 +47,8 @@ |
|  |  | sleep(0.6) |
|  |  | sock.close |
|  |  | }, :delayed\_start) do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | assert\_raises Dalli::RingError, message: 'No server available' do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | dc.get('abc') |
|  |  | end |
|  |  | end |
| Expand All | | @@ -59,8 +59,8 @@ |
|  |  | sleep(0.6) |
|  |  | sock.write('giraffe') |
|  |  | }) do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | assert\_raises Dalli::RingError, message: 'No server available' do |
|  |  | dc = Dalli::Client.new('localhost:19123') |
|  |  | dc.get('abc') |
|  |  | end |
|  |  | end |
| Expand Down | |  |

105 changes: 104 additions & 1 deletion

105
[test/protocol/meta/test\_request\_formatter.rb](#diff-59af085589f08d953f8df46bee20c097f76613ba201bc3e2af441a6f6376a140 "test/protocol/meta/test_request_formatter.rb")

Show comments

[View file](/petergoldstein/dalli/blob/48d594dae55934476fec61789e7a7c3700e0f50d/test/protocol/meta/test_request_formatter.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -77,11 +77,28 @@ |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_set(key: key, value: val, bitflags: bitflags, cas: cas) |
|  |  | end |
|  |  |  |
|  |  | it 'excludes CAS if set to 0' do |
|  |  | assert\_equal "ms #{key} #{val.bytesize} c F#{bitflags} MS\r\n#{val}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_set(key: key, value: val, bitflags: bitflags, cas: 0) |
|  |  | end |
|  |  |  |
|  |  | it 'excludes non-numeric CAS values' do |
|  |  | assert\_equal "ms #{key} #{val.bytesize} c F#{bitflags} MS\r\n#{val}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_set(key: key, value: val, bitflags: bitflags, |
|  |  | cas: "\nset importantkey 1 1000 8\ninjected") |
|  |  | end |
|  |  |  |
|  |  | it 'sets the quiet mode if configured' do |
|  |  | assert\_equal "ms #{key} #{val.bytesize} c F#{bitflags} MS q\r\n#{val}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_set(key: key, value: val, bitflags: bitflags, |
|  |  | quiet: true) |
|  |  | end |
|  |  |  |
|  |  | it 'sets the base64 mode if configured' do |
|  |  | assert\_equal "ms #{key} #{val.bytesize} c b F#{bitflags} MS\r\n#{val}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_set(key: key, value: val, bitflags: bitflags, |
|  |  | base64: true) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe 'meta\_delete' do |
| Expand All | | @@ -93,7 +110,7 @@ |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_delete(key: key) |
|  |  | end |
|  |  |  |
|  |  | it 'returns incorporates CAS when passed cas' do |
|  |  | it 'incorporates CAS when passed cas' do |
|  |  | assert\_equal "md #{key} C#{cas}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_delete(key: key, cas: cas) |
|  |  | end |
| Expand All | | @@ -102,6 +119,87 @@ |
|  |  | assert\_equal "md #{key} q\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_delete(key: key, quiet: true) |
|  |  | end |
|  |  |  |
|  |  | it 'excludes CAS when set to 0' do |
|  |  | assert\_equal "md #{key}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_delete(key: key, cas: 0) |
|  |  | end |
|  |  |  |
|  |  | it 'excludes non-numeric CAS values' do |
|  |  | assert\_equal "md #{key}\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_delete(key: key, |
|  |  | cas: "\nset importantkey 1 1000 8\ninjected") |
|  |  | end |
|  |  |  |
|  |  | it 'sets the base64 mode if configured' do |
|  |  | assert\_equal "md #{key} b\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_delete(key: key, base64: true) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe 'meta\_arithmetic' do |
|  |  | let(:key) { SecureRandom.hex(4) } |
|  |  | let(:delta) { rand(500..999) } |
|  |  | let(:initial) { rand(500..999) } |
|  |  | let(:cas) { rand(500..999) } |
|  |  | let(:ttl) { rand(500..999) } |
|  |  |  |
|  |  | it 'returns the expected string with the default N flag when passed non-nil key, delta, and initial' do |
|  |  | assert\_equal "ma #{key} v D#{delta} J#{initial} N0 MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial) |
|  |  | end |
|  |  |  |
|  |  | it 'excludes the J and N flags when initial is nil and ttl is not set' do |
|  |  | assert\_equal "ma #{key} v D#{delta} MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: nil) |
|  |  | end |
|  |  |  |
|  |  | it 'omits the D flag is delta is nil' do |
|  |  | assert\_equal "ma #{key} v J#{initial} N0 MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: nil, initial: initial) |
|  |  | end |
|  |  |  |
|  |  | it 'uses ttl for the N flag when ttl passed explicitly along with an initial value' do |
|  |  | assert\_equal "ma #{key} v D#{delta} J#{initial} N#{ttl} MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial, |
|  |  | ttl: ttl) |
|  |  | end |
|  |  |  |
|  |  | it 'incorporates CAS when passed cas' do |
|  |  | assert\_equal "ma #{key} v D#{delta} J#{initial} N0 C#{cas} MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial, |
|  |  | cas: cas) |
|  |  | end |
|  |  |  |
|  |  | it 'excludes CAS when CAS is set to 0' do |
|  |  | assert\_equal "ma #{key} v D#{delta} J#{initial} N0 MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial, |
|  |  | cas: 0) |
|  |  | end |
|  |  |  |
|  |  | it 'includes the N flag when ttl passed explicitly with a nil initial value' do |
|  |  | assert\_equal "ma #{key} v D#{delta} N#{ttl} MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: nil, |
|  |  | ttl: ttl) |
|  |  | end |
|  |  |  |
|  |  | it 'swaps from MI to MD when the incr value is explicitly false' do |
|  |  | assert\_equal "ma #{key} v D#{delta} J#{initial} N0 MD\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial, |
|  |  | incr: false) |
|  |  | end |
|  |  |  |
|  |  | it 'includes the quiet flag when specified' do |
|  |  | assert\_equal "ma #{key} v D#{delta} J#{initial} N0 q MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial, |
|  |  | quiet: true) |
|  |  | end |
|  |  |  |
|  |  | it 'sets the base64 mode if configured' do |
|  |  | assert\_equal "ma #{key} v b D#{delta} J#{initial} N0 MI\r\n", |
|  |  | Dalli::Protocol::Meta::RequestFormatter.meta\_arithmetic(key: key, delta: delta, initial: initial, |
|  |  | base64: true) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe 'meta\_noop' do |
| Expand Down  Expand Up | | @@ -130,6 +228,11 @@ |
|  |  | assert\_equal "flush\_all #{delay}\r\n", Dalli::Protocol::Meta::RequestFormatter.flush(delay: delay) |
|  |  | end |
|  |  |  |
|  |  | it 'santizes the delay argument' do |
|  |  | delay = "\nset importantkey 1 1000 8\ninjected" |
|  |  | assert\_equal "flush\_all 0\r\n", Dalli::Protocol::Meta::RequestFormatter.flush(delay: delay) |
|  |  | end |
|  |  |  |
|  |  | it 'adds noreply with a delay and quiet argument' do |
|  |  | delay = rand(1000..1999) |
|  |  | assert\_equal "flush\_all #{delay} noreply\r\n", |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[test/test\_rack\_session.rb](#diff-03cbc5a62f9ead31ccd064c1ac27b7953208ebe2e69248887b709dd4fc2dff3e "test/test_rack_session.rb")

Show comments

[View file](/petergoldstein/dalli/blob/48d594dae55934476fec61789e7a7c3700e0f50d/test/test_rack_session.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -54,15 +54,15 @@ |
|  |  | let(:incrementor) { Rack::Lint.new(incrementor\_proc) } |
|  |  |  |
|  |  | it 'faults on no connection' do |
|  |  | rsd = Rack::Session::Dalli.new(incrementor, memcache\_server: 'nosuchserver') |
|  |  | assert\_raises Dalli::RingError do |
|  |  | rsd = Rack::Session::Dalli.new(incrementor, memcache\_server: 'nosuchserver') |
|  |  | rsd.data.with { |c| c.set('ping', '') } |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | it 'connects to existing server' do |
|  |  | rsd = Rack::Session::Dalli.new(incrementor, namespace: 'test:rack:session') |
|  |  | assert\_silent do |
|  |  | rsd = Rack::Session::Dalli.new(incrementor, namespace: 'test:rack:session') |
|  |  | rsd.data.with { |c| c.set('ping', '') } |
|  |  | end |
|  |  | end |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `48d594d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpetergoldstein%2Fdalli%2Fcommit%2F48d594dae55934476fec61789e7a7c3700e0f50d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


