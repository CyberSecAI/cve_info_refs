=== Content from gitlab.com_d72c864f_20250114_181151.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-4138.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-4138.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-4138.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-4138.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ðŸ¤– GitLab Bot ðŸ¤–'s avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "ðŸ¤– GitLab Bot ðŸ¤–")](/gitlab-bot)

  Feb 13, 2023

  [1bc6107f](/gitlab-org/cves/-/commit/1bc6107ff6d40037f3aeb8a333849cab2178f7eb)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/1bc6107ff6d40037f3aeb8a333849cab2178f7eb)
  Â·
  1bc6107f

  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored Feb 13, 2023

  1bc6107f

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/1bc6107ff6d40037f3aeb8a333849cab2178f7eb)
  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored Feb 13, 2023

Loading



=== Content from gitlab.com_91398475_20250114_181152.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# CSRF via file upload allows an attacker to take over a repository.

**[HackerOne report #1778009](https://hackerone.com/reports/1778009)** by `st4nly0n` on 2022-11-18, assigned to `Ottilia Westerlund`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

# Summary

The default branch name for a group is not being validated correctly, when uploading a file from the web interface, a **POST** request is issued that includes in the request path the default branch name of a group.

```
POST /any_path HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 Firefox/106.0
Accept: application/json, text/plain, */*
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://localhost/user/repo
X-CSRF-Token: REDACTED
X-Requested-With: XMLHttpRequest
Content-Type: multipart/form-data; boundary=---------------------------367269929429674248332090673842
Content-Length: 653
Origin: http://localhost
Connection: close
Cookie: _gitlab_session=REDACTED; event_filter=all

-----------------------------367269929429674248332090673842
Content-Disposition: form-data; name="branch_name"

../../../../../any_path
-----------------------------367269929429674248332090673842
Content-Disposition: form-data; name="create_merge_request"

true
-----------------------------367269929429674248332090673842
Content-Disposition: form-data; name="commit_message"

Upload New File
-----------------------------367269929429674248332090673842
Content-Disposition: form-data; name="file"; filename="anyfile.txt"
Content-Type: text/plain
-----------------------------367269929429674248332090673842--
```

This allows to place in the main branch name a path with traversal path to any api endpoint and issue **POST** requests with the current session.

The endpoint `/api/v4/projects/<ID-VICTIM-PROJECT>/import_project_members/<ID-ATTACKER-PROJECT>`, allows importing members from one project to another, if the victim issues a **POST** request to this endpoint it would be importing the members with the source permissions to the target repository.

An attacker can take over the victim's repository through the use case where a victim decides to use the web interface to upload a file to an empty repository to which he was invited.

# Steps to reproduce:

**â€¢** *Perform the steps below as the victim user:*

**1.** The user `owner` creates a public repository named `project_victim`.

**â€¢** *Perform the following steps as the attacker user:*

**1.** Create two accounts `attacker1` and `attacker2`.

**2.** `attacker1` creates a public group called `attacker_group`

**3.** `attacker1` creates an empty public project *(uninitialized README.md)* named `attacker_project` inside the `attacker_group` group.

**4.** `attacker1` changes the default branch name for the `attacker_group` group to the following value:

```
###  branch name obfuscated
main.182BB2A57D285B692BB93108E937f12bbfe9c15748A8A271dc238B895683B34D2273571f8753cbb9fB466CF4D395da5fe784340150e485f3378f01d2450ff7eed56308c0f6f4ebc364189714C1f74140f97../../../../../../api/v4/projects/<ID-VICTIM-PROJECT>/import_project_members/<ID-ATTACKER-PROJECT>
```

where `ID-VICTIM-PROJECT` is the project id of `project_victim` and `ID-ATTACKER-PROJECT` is the project id of `attacker_project`.

**5.** `attacker1` invites `attacker2` to the `attacker_project` repository, and gives him the role of owner.

**6.** `attacker1` invites user `owner` to the `attacker_project` project and grants him the role of maintainer.

**7.** the `owner` user uses the web interface to upload a file to the `attacker_project`.

As a result of this behavior, user `attacker2` owns the project `project_victim` project.

The attack also succeeds if the `owner` user is replaced by a maintainer user of the project `project_victim` project, since a maintainer can import members from other projects.

# What is the current *bug* behavior?

A victim using the web interface to upload a file to an empty repository to which he was invited would be granting access to any user within the victim's repository.

# What is the expected *correct* behavior?

You must validate the main branch name for a group correctly, git does not allow a branch name like this '../../'.

# Relevant logs and/or screenshots

The following video shows the attack starting from step 7 in the steps to replay, see how the victim decides to use the web interface to upload a file to an empty repository to which he was invited, this allowed an attacker to own a repository of the victim.

[poc.mp4](https://user-content.gitlab-static.net/0edaa598df8855ffcf877f619159927585731613/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f63343465393431612d353563612d346261302d613732372d3563303665626531633336622f706f632e6d7034 "Download 'poc.mp4'")

# Output of checks

This bug happens on GitLab.com

#### Impact

An attacker can take control of any victim's repository, using the use case where a victim decides to use the web interface to upload a file to a repository to which he was invited.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [poc.mp4](https://h1.sec.gitlab.net/a/c44e941a-55ca-4ba0-a727-5c06ebe1c36b/poc.mp4)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Mar 16, 2023 by [Nick Malcolm](/nmalcolm)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


