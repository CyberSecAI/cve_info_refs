=== Content from www.wordfence.com_0935eae7_20250114_192311.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP Cerber Security <= 9.1 - Unauthenticated Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP Cerber Security <= 9.1 - Unauthenticated Stored Cross-Site Scripting

7.2

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2022-4712](https://www.cve.org/CVERecord?id=CVE-2022-4712) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | April 19, 2023 |
| Last Updated | October 20, 2023 |
| Researcher | [Ram - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/ramuel-gall) |

### Description

The WP Cerber Security plugin for WordPress is vulnerable to stored cross-site scripting via the log parameter when logging in to the site in versions up to, and including, 9.1. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-cerber/trunk/admin/cerber-dashboard.php?rev=2721561#L1338)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-cerber%2Fwp-cerber-security-91-unauthenticated-stored-cross-site-scripting&t=WP%20Cerber%20Security%20%3C%3D%209.1%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-cerber%2Fwp-cerber-security-91-unauthenticated-stored-cross-site-scripting&text=WP%20Cerber%20Security%20%3C%3D%209.1%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-cerber%2Fwp-cerber-security-91-unauthenticated-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for WP Cerber Security, Anti-spam & Malware Scan

#### [WP Cerber Security, Anti-spam & Malware Scan](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-cerber)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-cerber [(view on wordpress.org)](https://wordpress.org/plugins/wp-cerber) |
| Patched? | Yes |
| Remediation | Update to version 9.2, or a newer patched version |
| Affected Version | * <= 9.1 |
| Patched Version | * 9.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_1a90c72e_20250114_192309.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-cerber%2Ftrunk%2Fadmin%2Fcerber-dashboard.php%3Frev%3D2721561)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-cerber/trunk/admin/cerber-dashboard.php?rev=2670665 "Revision 2670665")
* [Latest Revision](/browser/wp-cerber/trunk/admin/cerber-dashboard.php)
* [Next Revision](/browser/wp-cerber/trunk/admin/cerber-dashboard.php?rev=2772930 "Revision 2772930") →
* [Blame](/browser/wp-cerber/trunk/admin/cerber-dashboard.php?annotate=blame&rev=2721561 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-cerber/trunk/admin/cerber-dashboard.php?rev=2721561)

---

# [source:](/browser?rev=2721561&order=name "Go to repository root") [wp-cerber](/browser/wp-cerber?rev=2721561&order=name "View wp-cerber")/[trunk](/browser/wp-cerber/trunk?rev=2721561&order=name "View trunk")/[admin](/browser/wp-cerber/trunk/admin?rev=2721561&order=name "View admin")/[cerber-dashboard.php](/browser/wp-cerber/trunk/admin/cerber-dashboard.php?rev=2721561&order=name "View cerber-dashboard.php") @ [2721561](/changeset/2721561/ "View changeset 2721561")

View diff against:

View revision:

| [Last change](/changeset/2721561/wp-cerber/trunk/admin/cerber-dashboard.php "View differences") on this file since 2721561 was [2721561](/changeset/2721561/ "View changeset 2721561"), checked in by Gioni, [3 years ago](/timeline?from=2022-05-10T21%3A32%3A10Z&precision=second "See timeline at 05/10/2022 09:32:10 PM") |
| --- |
| A new 9.0 version of WP Cerber Security |
| **File size:** 200.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Copyright (C) 2015-22 CERBER TECH INC., https://cerber.tech |
| [4](#L4) | Copyright (C) 2015-22 Markov Gregory, https://wpcerber.com |
| [5](#L5) |  |
| [6](#L6) | Licenced under the GNU GPL. |
| [7](#L7) |  |
| [8](#L8) | This program is free software; you can redistribute it and/or modify |
| [9](#L9) | it under the terms of the GNU General Public License as published by |
| [10](#L10) | the Free Software Foundation; either version 3 of the License, or |
| [11](#L11) | (at your option) any later version. |
| [12](#L12) |  |
| [13](#L13) | This program is distributed in the hope that it will be useful, |
| [14](#L14) | but WITHOUT ANY WARRANTY; without even the implied warranty of |
| [15](#L15) | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the |
| [16](#L16) | GNU General Public License for more details. |
| [17](#L17) |  |
| [18](#L18) | You should have received a copy of the GNU General Public License |
| [19](#L19) | along with this program; if not, write to the Free Software |
| [20](#L20) | Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA |
| [21](#L21) | \*/ |
| [22](#L22) |  |
| [23](#L23) | /\* |
| [24](#L24) |  |
| [25](#L25) | \*========================================================================\* |
| [26](#L26) | |                                                                        | |
| [27](#L27) | |              ATTENTION!  Do not change or edit this file!                  | |
| [28](#L28) | |                                                                        | |
| [29](#L29) | \*========================================================================\* |
| [30](#L30) |  |
| [31](#L31) | \*/ |
| [32](#L32) |  |
| [33](#L33) |  |
| [34](#L34) | if ( ! defined( 'WPINC' ) ) { |
| [35](#L35) | exit; |
| [36](#L36) | } |
| [37](#L37) |  |
| [38](#L38) | if ( ! is\_multisite() ) { |
| [39](#L39) | add\_action( 'admin\_menu', 'cerber\_admin\_menu' ); |
| [40](#L40) | define( 'CRB\_ADMIN\_CAP', 'manage\_options' ); |
| [41](#L41) | } |
| [42](#L42) | else { |
| [43](#L43) | add\_action( 'network\_admin\_menu', 'cerber\_admin\_menu' );  // only network wide menu allowed in multisite mode |
| [44](#L44) | define( 'CRB\_ADMIN\_CAP', 'manage\_network' ); |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | function cerber\_admin\_menu() { |
| [48](#L48) |  |
| [49](#L49) | $position = 100; |
| [50](#L50) |  |
| [51](#L51) | if ( cerber\_is\_admin\_page() ) { |
| [52](#L52) | cerber\_check\_environment(); |
| [53](#L53) | if ( crb\_get\_settings( 'top\_admin\_menu' ) ) { |
| [54](#L54) | $position = 1; |
| [55](#L55) | } |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) | $hook = add\_menu\_page( 'WP Cerber Security', 'WP Cerber', CRB\_ADMIN\_CAP, 'cerber-security', 'cerber\_render\_admin\_page', 'dashicons-shield', $position ); |
| [59](#L59) | add\_action( 'load-' . $hook, 'crb\_admin\_screen\_options' ); |
| [60](#L60) | add\_submenu\_page( 'cerber-security', \_\_( 'Cerber Dashboard', 'wp-cerber' ), \_\_( 'Dashboard', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-security', 'cerber\_render\_admin\_page' ); |
| [61](#L61) |  |
| [62](#L62) | $hook = add\_submenu\_page( 'cerber-security', \_\_( 'Cerber Traffic Inspector', 'wp-cerber' ), \_\_( 'Traffic Inspector', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-traffic', 'cerber\_render\_admin\_page' ); |
| [63](#L63) | add\_action( 'load-' . $hook, 'crb\_admin\_screen\_options' ); |
| [64](#L64) |  |
| [65](#L65) | if ( lab\_lab() ) { |
| [66](#L66) | add\_submenu\_page( 'cerber-security', \_\_( 'Cerber Data Shield Policies', 'wp-cerber' ), \_\_( 'Data Shield', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-shield', 'cerber\_render\_admin\_page' ); |
| [67](#L67) | add\_submenu\_page( 'cerber-security', \_\_( 'Cerber Security Rules', 'wp-cerber' ), \_\_( 'Security Rules', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-rules', 'cerber\_render\_admin\_page' ); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | add\_submenu\_page( 'cerber-security', \_\_( 'Cerber User Security', 'wp-cerber' ), \_\_( 'User Policies', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-users', 'cerber\_render\_admin\_page' ); |
| [71](#L71) |  |
| [72](#L72) | if ( cerber\_get\_upload\_dir\_mu() ) { |
| [73](#L73) | $hook = add\_submenu\_page( 'cerber-security', 'Cerber Security: Site Integrity', \_\_( 'Site Integrity', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-integrity', 'cerber\_render\_admin\_page' ); |
| [74](#L74) | add\_action( 'load-' . $hook, 'crb\_admin\_screen\_options' ); |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | add\_submenu\_page( 'cerber-security', \_\_( 'Cerber anti-spam settings', 'wp-cerber' ), \_\_( 'Anti-spam', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-recaptcha', 'cerber\_render\_admin\_page' ); |
| [78](#L78) |  |
| [79](#L79) | $hook = add\_submenu\_page( 'cerber-security', 'Cerber.Hub', 'Cerber.Hub', CRB\_ADMIN\_CAP, 'cerber-nexus', 'nexus\_admin\_page' ); |
| [80](#L80) | if ( nexus\_is\_master() ) { |
| [81](#L81) | add\_action( 'load-' . $hook, 'nexus\_master\_screen' ); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | if ( ! CRB\_Addons::none() ) { |
| [85](#L85) | add\_submenu\_page( 'cerber-security', \_\_( 'Add-ons', 'wp-cerber' ), \_\_( 'Add-ons', 'wp-cerber' ), CRB\_ADMIN\_CAP, CRB\_ADDON\_PAGE, 'cerber\_render\_admin\_page' ); |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | add\_submenu\_page( 'cerber-security', \_\_( 'Cerber tools', 'wp-cerber' ), \_\_( 'Tools', 'wp-cerber' ), CRB\_ADMIN\_CAP, 'cerber-tools', 'cerber\_render\_admin\_page' ); |
| [89](#L89) |  |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | add\_action( 'admin\_bar\_menu', 'cerber\_admin\_bar' ); |
| [93](#L93) | function cerber\_admin\_bar( $wp\_admin\_bar ) { |
| [94](#L94) | if ( ! is\_multisite() ) { |
| [95](#L95) | return; |
| [96](#L96) | } |
| [97](#L97) | $args = array( |
| [98](#L98) | 'parent' => 'network-admin', |
| [99](#L99) | 'id'     => 'cerber\_admin', |
| [100](#L100) | 'title'  => 'WP Cerber', |
| [101](#L101) | 'href'   => cerber\_admin\_link(), |
| [102](#L102) | ); |
| [103](#L103) | $wp\_admin\_bar->add\_node( $args ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | /\*\* |
| [107](#L107) | \* Wrapper for all admin pages |
| [108](#L108) | \* |
| [109](#L109) | \* @param $title string |
| [110](#L110) | \* @param $tabs array |
| [111](#L111) | \* @param $active\_tab string |
| [112](#L112) | \* @param $renderer callable |
| [113](#L113) | \*/ |
| [114](#L114) | function cerber\_show\_admin\_page( $title, $tabs = array(), $active\_tab = null, $renderer = null ) { |
| [115](#L115) |  |
| [116](#L116) | if ( ! $active\_tab ) { |
| [117](#L117) | $active\_tab = crb\_admin\_get\_tab( $tabs ); |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | if ( nexus\_is\_valid\_request() ) { |
| [121](#L121) | $title .= nexus\_request\_data()->at\_site; |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | ?> |
| [125](#L125) | <div id="crb-admin" class="wrap"> |
| [126](#L126) |  |
| [127](#L127) | <h1><?php echo $title; ?></h1> |
| [128](#L128) |  |
| [129](#L129) | <?php |
| [130](#L130) |  |
| [131](#L131) | cerber\_show\_admin\_notice(); |
| [132](#L132) |  |
| [133](#L133) | cerber\_show\_tabs( $active\_tab, $tabs ); |
| [134](#L134) |  |
| [135](#L135) | echo '<div style="display: table; width:100%;">'; |
| [136](#L136) |  |
| [137](#L137) | echo '<div class="crb-main crb-tab-' . $active\_tab . '">'; |
| [138](#L138) |  |
| [139](#L139) | if ( $active\_tab == 'help' ) { |
| [140](#L140) | cerber\_show\_help(); |
| [141](#L141) | } |
| [142](#L142) | elseif ( is\_callable( $renderer ) ) { |
| [143](#L143) | call\_user\_func( $renderer, $active\_tab ); |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | echo '</div>'; |
| [147](#L147) |  |
| [148](#L148) | cerber\_show\_aside( $active\_tab ); |
| [149](#L149) |  |
| [150](#L150) | echo '</div>'; |
| [151](#L151) |  |
| [152](#L152) | ?> |
| [153](#L153) | </div> |
| [154](#L154) | <?php |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | /\* |
| [158](#L158) | Displays lockouts in the Dashboard |
| [159](#L159) | \*/ |
| [160](#L160) | function cerber\_show\_lockouts( $args = array(), $echo = true ) { |
| [161](#L161) |  |
| [162](#L162) | //$wp\_cerber->deleteGarbage(); |
| [163](#L163) |  |
| [164](#L164) | $per\_page = ( ! empty( $args['per\_page'] ) ) ? $args['per\_page'] : crb\_admin\_get\_per\_page(); |
| [165](#L165) | $limit = cerber\_get\_sql\_limit( $per\_page ); |
| [166](#L166) | $controls = empty( $args['no\_navi'] ); |
| [167](#L167) | $table = ''; |
| [168](#L168) | $hint = ''; |
| [169](#L169) |  |
| [170](#L170) | if ( $rows = cerber\_db\_get\_results( 'SELECT \* FROM ' . CERBER\_BLOCKS\_TABLE . ' ORDER BY block\_until DESC ' . $limit, MYSQL\_FETCH\_OBJECT ) ) { |
| [171](#L171) |  |
| [172](#L172) | if ( $controls ) { |
| [173](#L173) | $total = cerber\_blocked\_num(); |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | $table\_rows = array(); |
| [177](#L177) | $base\_url = cerber\_admin\_link( 'activity' ); |
| [178](#L178) |  |
| [179](#L179) | $remove = cerber\_admin\_link( crb\_admin\_get\_tab(), null, true ); |
| [180](#L180) |  |
| [181](#L181) | foreach ( $rows as $row ) { |
| [182](#L182) | $ip = '<a href="' . $base\_url . '&filter\_ip=' . $row->ip . '">' . $row->ip . '</a>'; |
| [183](#L183) |  |
| [184](#L184) | $ip\_info = cerber\_get\_ip\_info( $row->ip, true ); |
| [185](#L185) | if ( isset( $ip\_info['hostname\_html'] ) ) { |
| [186](#L186) | $hostname = $ip\_info['hostname\_html']; |
| [187](#L187) | } |
| [188](#L188) | else { |
| [189](#L189) | $ip\_id = cerber\_get\_id\_ip( $row->ip ); |
| [190](#L190) | $hostname = crb\_get\_ajax\_placeholder( 'hostname', $ip\_id ); |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | if ( lab\_lab() ) { |
| [194](#L194) | $single\_ip = str\_replace( '\*', '1', $row->ip ); |
| [195](#L195) | $country   = '</td><td>' . crb\_country\_html( null, $single\_ip ); |
| [196](#L196) | } |
| [197](#L197) | else { |
| [198](#L198) | $country = ''; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | //$list[] = '<td>' . $ip . '</td><td>' . $hostname . $country . '</td><td>' . cerber\_date( $row->block\_until ) . '</td><td>' . $row->reason . '</td><td><a href="' . $remove . '&cerber\_admin\_do=lockdel&ip=' . esc\_attr( $row->ip ) . '">' . \_\_( 'Remove', 'wp-cerber' ) . '</a></td>'; |
| [202](#L202) | $the\_row = '<td>' . $ip . '</td><td>' . $hostname . $country . '</td><td>' . cerber\_date( $row->block\_until ) . '</td><td>' . $row->reason . '</td>'; |
| [203](#L203) | if ( $controls ) { |
| [204](#L204) | $the\_row .= '<td><a href="' . $remove . '&cerber\_admin\_do=lockdel&ip=' . esc\_attr( $row->ip ) . '">' . \_\_( 'Remove', 'wp-cerber' ) . '</a></td>'; |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | $table\_rows[] = $the\_row; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | $heading = array( |
| [211](#L211) | \_\_( 'IP Address', 'wp-cerber' ), |
| [212](#L212) | \_\_( 'Hostname', 'wp-cerber' ), |
| [213](#L213) | \_\_( 'Country', 'wp-cerber' ), |
| [214](#L214) | \_\_( 'Expires', 'wp-cerber' ), |
| [215](#L215) | \_\_( 'Reason', 'wp-cerber' ), |
| [216](#L216) | \_\_( 'Action', 'wp-cerber' ), |
| [217](#L217) | ); |
| [218](#L218) |  |
| [219](#L219) | if ( ! lab\_lab() ) { |
| [220](#L220) | unset( $heading[2] ); |
| [221](#L221) | } |
| [222](#L222) |  |
| [223](#L223) | if ( $controls ) { |
| [224](#L224) | $navi = cerber\_page\_navi( $total, $per\_page ); |
| [225](#L225) | $hint = '<p>' . \_\_( 'Click the IP address to see its activity', 'wp-cerber' ) . '</p>'; |
| [226](#L226) | } |
| [227](#L227) | else { |
| [228](#L228) | $navi = ''; |
| [229](#L229) | unset( $heading[5] ); |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | $titles = '<tr><th>' . implode( '</th><th>', $heading ) . '</th></tr>'; |
| [233](#L233) |  |
| [234](#L234) | $table = '<table id="crb-locked-out" class="widefat crb-table"><thead>' . $titles . '</thead><tfoot>' . $titles . '</tfoot>' . implode( '</tr><tr>', $table\_rows ) . '</tr></table>' . $navi; |
| [235](#L235) |  |
| [236](#L236) | /\*if ( empty( $args['no\_navi'] ) ) { |
| [237](#L237) | $table .= cerber\_page\_navi( $total, $per\_page ); |
| [238](#L238) | }\*/ |
| [239](#L239) |  |
| [240](#L240) | } |
| [241](#L241) | else { |
| [242](#L242) | $hint  = '<p>' . sprintf( \_\_( 'No lockouts at the moment. The sky is clear.', 'wp-cerber' ) ) . '</p>'; |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | $ret = $table . '<div class="cerber-margin">' . $hint . '</div>'; |
| [246](#L246) |  |
| [247](#L247) | if ( $echo ) { |
| [248](#L248) | echo $ret; |
| [249](#L249) |  |
| [250](#L250) | return; |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | return $ret; |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | function cerber\_block\_delete( $ip ) { |
| [257](#L257) | $result = cerber\_db\_query( 'DELETE FROM ' . CERBER\_BLOCKS\_TABLE . ' WHERE ip = "' . cerber\_real\_escape( $ip ) . '"' ); |
| [258](#L258) |  |
| [259](#L259) | crb\_event\_handler( 'ip\_event', array( |
| [260](#L260) | 'e\_type' => 'unlocked', |
| [261](#L261) | 'ip'     => $ip, |
| [262](#L262) | 'result' => $result |
| [263](#L263) | ) ); |
| [264](#L264) |  |
| [265](#L265) | return $result; |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) |  |
| [269](#L269) | /\*\* |
| [270](#L270) | \* ACL management forms |
| [271](#L271) | \* |
| [272](#L272) | \* @return void |
| [273](#L273) | \*/ |
| [274](#L274) | function cerber\_acl\_form(){ |
| [275](#L275) |  |
| [276](#L276) | echo '<div class="crb-title-plus"><div><h2>' . \_\_( 'White IP Access List', 'wp-cerber' ) . '</h2></div>'; |
| [277](#L277) | echo '<div><span style="opacity: 0.6;">&#x2500;&#x2500; &nbsp; </span><a href="' . cerber\_activity\_link() . '&amp;filter\_status=500">View Activity</a> &nbsp;|&nbsp; <a href="' . cerber\_admin\_link( 'imex' ) . '">Import Entries</a> &nbsp;|&nbsp; <a target="\_blank" href="https://wpcerber.com/using-ip-access-lists-to-protect-wordpress/">How Access Lists work</a></div></div>'; |
| [278](#L278) | echo cerber\_acl\_get\_table( 'W' ); |
| [279](#L279) |  |
| [280](#L280) | echo '<div class="crb-title-plus"><div><h2>' . \_\_( 'Black IP Access List', 'wp-cerber' ) . '</h2></div>'; |
| [281](#L281) | echo '<div><span style="opacity: 0.6;">&#x2500;&#x2500; &nbsp; </span><a href="' . cerber\_activity\_link() . '&amp;filter\_status=14">View Activity</a> &nbsp;|&nbsp; <a href="' . cerber\_admin\_link( 'imex' ) . '">Import Entries</a> &nbsp;|&nbsp; <a target="\_blank" href="https://wpcerber.com/using-ip-access-lists-to-protect-wordpress/">How Access Lists work</a></div></div>'; |
| [282](#L282) | echo cerber\_acl\_get\_table( 'B' ); |
| [283](#L283) |  |
| [284](#L284) | $user\_ip = cerber\_get\_remote\_ip(); |
| [285](#L285) | $link = cerber\_admin\_link( 'activity' ) . '&filter\_ip=' . $user\_ip; |
| [286](#L286) | $name = crb\_country\_html( null, $user\_ip ); |
| [287](#L287) |  |
| [288](#L288) | echo '<p style="margin-bottom: 30px;"><b><span class="dashicons-before dashicons-star-filled"></span> ' . \_\_( 'Your IP', 'wp-cerber' ) . ': </b><a href="' . $link . '">' . $user\_ip . '</a> ' . $name . '</p>'; |
| [289](#L289) |  |
| [290](#L290) | ?> |
| [291](#L291) |  |
| [292](#L292) | <table class="crb-acl-hints"> |
| [293](#L293) | <tr><td colspan="3">Use the following formats to add entries to the access lists</td></tr> |
| [294](#L294) | <tr><td>IPv4</td><td>Single IPv4 address</td><td>192.168.5.22</td></tr> |
| [295](#L295) | <tr><td>IPv4</td><td>Range specified with hyphen (dash)</td><td>192.168.1.45 - 192.168.22.165</td></tr> |
| [296](#L296) | <tr><td>IPv4</td><td>Range specified with CIDR</td><td>192.168.128.0/20</td></tr> |
| [297](#L297) | <tr><td>IPv4</td><td>Subnet Class C specified with CIDR</td><td>192.168.77.0/24</td></tr> |
| [298](#L298) | <tr><td>IPv4</td><td>Any IPv4 address specified with CIDR</td><td>0.0.0.0/0</td></tr> |
| [299](#L299) | <tr><td>IPv4</td><td>Subnet Class C specified with wildcard</td><td>192.168.77.\*</td></tr> |
| [300](#L300) | <tr><td>IPv4</td><td>Subnet Class B specified with wildcard</td><td>192.168.\*.\*</td></tr> |
| [301](#L301) | <tr><td>IPv4</td><td>Subnet Class A specified with wildcard</td><td>192.\*.\*.\*</td></tr> |
| [302](#L302) | <tr><td>IPv4</td><td>Any IPv4 address specified with wildcard</td><td>\*.\*.\*.\*</td></tr> |
| [303](#L303) | <tr><td>IPv6</td><td>Single IPv6 address</td><td>2001:0db8:85a3:0000:0000:8a2e:0370:7334</td></tr> |
| [304](#L304) | <tr><td>IPv6</td><td>Range specified with hyphen (dash)</td><td>2001:db8::ff00:41:0 - 2001:db8::ff00:41:12ff</td></tr> |
| [305](#L305) | <tr><td>IPv6</td><td>Range specified with CIDR</td><td>2001:db8::/46</td></tr> |
| [306](#L306) | <tr><td>IPv6</td><td>Range specified with wildcard</td><td>2001:db8::ff00:41:\*</td></tr> |
| [307](#L307) | <tr><td>IPv6</td><td>Any IPv6 address</td><td>::/0</td></tr> |
| [308](#L308) | </table> |
| [309](#L309) |  |
| [310](#L310) | <?php |
| [311](#L311) | } |
| [312](#L312) | /\* |
| [313](#L313) | Create HTML to display ACL area: table + form |
| [314](#L314) | \*/ |
| [315](#L315) | function cerber\_acl\_get\_table( $tag, $acl\_slice = 0 ) { |
| [316](#L316) | global $wpdb; |
| [317](#L317) |  |
| [318](#L318) | $activity\_url = cerber\_admin\_link( 'activity' ); |
| [319](#L319) | $acl\_slice    = absint( $acl\_slice ); |
| [320](#L320) | $tag          = preg\_replace( '/[^W|B]/', '', $tag ); |
| [321](#L321) |  |
| [322](#L322) | if ( $rows = $wpdb->get\_results( 'SELECT \* FROM ' . CERBER\_ACL\_TABLE . " WHERE acl\_slice = '.$acl\_slice.' AND tag = '" . $tag . "' ORDER BY ip\_long\_begin, ip" ) ) { |
| [323](#L323) | foreach ( $rows as $row ) { |
| [324](#L324) | $links = ''; |
| [325](#L325) | if ( ! $row->ver6 || cerber\_is\_ipv6( $row->ip ) ) { |
| [326](#L326) | $links = '<a class="crb-button-tiny" href="' . $activity\_url . '&filter\_ip=' . urlencode( cerber\_ipv6\_short( $row->ip ) ) . '">' . \_\_( 'Check for activities', 'wp-cerber' ) . '</a> ' . cerber\_traffic\_link( array( 'filter\_ip' => $row->ip ) ); |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | $list[] = '<td>' . $row->ip . '</td><td>' . $row->comments . '</td><td>' . $links . '</td> |
| [330](#L330) | <td><a class="delete\_entry crb-button-tiny" href="javascript:void(0)" data-ip="' . $row->ip . '">' . \_\_( 'Remove', 'wp-cerber' ) . '</a> |
| [331](#L331) | </td>'; |
| [332](#L332) | } |
| [333](#L333) | $ret = '<table id="acl\_' . $tag . '" class="acl-table" data-acl-slice="' . $acl\_slice . '"><tr>' . implode( '</tr><tr>', $list ) . '</tr></table>'; |
| [334](#L334) | } |
| [335](#L335) | else { |
| [336](#L336) | $ret = '<p style="text-align: center;">' . \_\_( 'List is empty', 'wp-cerber' ) . '</p>'; |
| [337](#L337) | } |
| [338](#L338) | $ret = '<div class="acl-wrapper"><div class="acl-items">' |
| [339](#L339) | . $ret . '</div> |
| [340](#L340) | <form action="" method="post"> |
| [341](#L341) | <table> |
| [342](#L342) | <tr><td><input class="crb-monospace" type="text" name="add\_acl" required maxlength="100" placeholder="' . \_\_( 'IP address, range, wildcard, or CIDR', 'wp-cerber' ) . '"> |
| [343](#L343) | </td><td><input type="submit" class="button button-primary" value="' . \_\_( 'Add Entry', 'wp-cerber' ) . '" ></td></tr> |
| [344](#L344) | <tr><td><input class="crb-monospace" type="text" name="add\_acl\_comment" maxlength="250" placeholder="' . \_\_( 'Optional comment for this entry', 'wp-cerber' ) . '"> |
| [345](#L345) | </td><td></td></tr> |
| [346](#L346) | </table> |
| [347](#L347) | <input type="hidden" name="cerber\_admin\_do" value="add2acl"> |
| [348](#L348) | <input type="hidden" name="acl\_tag" value="' . $tag . '">' |
| [349](#L349) | . cerber\_nonce\_field() |
| [350](#L350) | . '</form></div>'; |
| [351](#L351) |  |
| [352](#L352) | return $ret; |
| [353](#L353) | } |
| [354](#L354) | /\* |
| [355](#L355) | Handle actions with items in ACLs in the dashboard |
| [356](#L356) | \*/ |
| [357](#L357) | function cerber\_acl\_form\_process( $post = array() ) { |
| [358](#L358) | $tag = crb\_array\_get( $post, 'acl\_tag', '', 'W|B' ); |
| [359](#L359) | $ip  = trim( crb\_array\_get( $post, 'add\_acl' ) ); |
| [360](#L360) | $ip  = preg\_replace( CRB\_IP\_NET\_RANGE, ' ', $ip ); |
| [361](#L361) | $ip  = preg\_replace( '/\s+/', ' ', $ip ); |
| [362](#L362) | $comment = strip\_tags( stripslashes( crb\_array\_get( $post, 'add\_acl\_comment', '' ) ) ); |
| [363](#L363) |  |
| [364](#L364) | if ( $tag == 'B' ) { |
| [365](#L365) | if ( ! cerber\_can\_be\_listed( $ip ) ) { |
| [366](#L366) | cerber\_admin\_notice( \_\_( "You cannot add your IP address or network", 'wp-cerber' ) ); |
| [367](#L367) |  |
| [368](#L368) | return; |
| [369](#L369) | } |
| [370](#L370) | $ok = sprintf( \_\_( 'IP address %s has been added to Black IP Access List', 'wp-cerber' ), $ip ); |
| [371](#L371) | } |
| [372](#L372) | else { |
| [373](#L373) | $ok = sprintf( \_\_( 'IP address %s has been added to White IP Access List', 'wp-cerber' ), $ip ); |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | $result = cerber\_acl\_add( $ip, $tag, $comment ); |
| [377](#L377) |  |
| [378](#L378) | if ( is\_wp\_error( $result ) ) { |
| [379](#L379) | cerber\_admin\_notice( $result->get\_error\_message() ); |
| [380](#L380) | } |
| [381](#L381) | else { |
| [382](#L382) | cerber\_admin\_message( $ok ); |
| [383](#L383) | } |
| [384](#L384) |  |
| [385](#L385) | return; |
| [386](#L386) |  |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | /\* |
| [390](#L390) | AJAX admin requests is landing here |
| [391](#L391) | \*/ |
| [392](#L392) | add\_action('wp\_ajax\_cerber\_ajax', 'cerber\_admin\_ajax'); |
| [393](#L393) | function cerber\_admin\_ajax() { |
| [394](#L394) |  |
| [395](#L395) | $go = cerber\_check\_ajax\_permissions( false ); |
| [396](#L396) |  |
| [397](#L397) | if ( $go === false ) { |
| [398](#L398) | return false; |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | $admin = ( $go === true ) ? true : false; |
| [402](#L402) |  |
| [403](#L403) | $response = array(); |
| [404](#L404) | $request  = crb\_get\_request\_fields(); |
| [405](#L405) |  |
| [406](#L406) | if ( $admin && ( $ip = crb\_array\_get( $request, 'acl\_delete' ) ) ) { |
| [407](#L407) | if ( cerber\_acl\_remove( $ip, crb\_array\_get( $request, 'slice' )  ) ) { |
| [408](#L408) | $response['deleted\_ip'] = $ip; |
| [409](#L409) | } |
| [410](#L410) | else { |
| [411](#L411) | $response['error'] = 'Unable to delete the entry'; |
| [412](#L412) | } |
| [413](#L413) | } |
| [414](#L414) | elseif ( ( $slug = crb\_array\_get( $request, 'crb\_ajax\_slug' ) ) |
| [415](#L415) | && $list = crb\_array\_get( $request, 'crb\_ajax\_list' ) ) { |
| [416](#L416) |  |
| [417](#L417) | $response['slug'] = $slug; |
| [418](#L418) | $list = array\_unique( $list ); |
| [419](#L419) | $response\_data = array(); |
| [420](#L420) |  |
| [421](#L421) | /\* |
| [422](#L422) | $list = array\_map(function ($ip\_id){ |
| [423](#L423) | return cerber\_get\_ip\_id( $ip\_id ); |
| [424](#L424) | }, $list); |
| [425](#L425) | $list = array\_filter( $list, function ( $ip ) { |
| [426](#L426) | if (filter\_var( $ip, FILTER\_VALIDATE\_IP )){ |
| [427](#L427) | return true; |
| [428](#L428) | } |
| [429](#L429) | });\*/ |
| [430](#L430) |  |
| [431](#L431) | if ( $slug == 'hostname' || $slug == 'country' ) { |
| [432](#L432) | $ip\_list = array(); |
| [433](#L433) | foreach ( $list as $ip\_id ) { |
| [434](#L434) | if ( $ip = filter\_var( cerber\_get\_ip\_id( $ip\_id ), FILTER\_VALIDATE\_IP ) ) { |
| [435](#L435) | $ip\_list[ $ip\_id ] = $ip; |
| [436](#L436) | $response\_data[ $ip\_id ] = ''; |
| [437](#L437) | } |
| [438](#L438) | else { |
| [439](#L439) | $response\_data[ $ip\_id ] = '-'; |
| [440](#L440) | } |
| [441](#L441) | } |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | switch ( $slug ) { |
| [445](#L445) | case 'hostname': |
| [446](#L446) | foreach ( $ip\_list as $ip\_id => $ip ) { |
| [447](#L447) | $ip\_info = cerber\_get\_ip\_info( $ip ); |
| [448](#L448) | $response\_data[ $ip\_id ] = $ip\_info['hostname\_html']; |
| [449](#L449) | } |
| [450](#L450) | break; |
| [451](#L451) | case 'country': |
| [452](#L452) | if ( $country\_list = lab\_get\_country( $ip\_list, false ) ) { |
| [453](#L453) | foreach ( $country\_list as $ip\_id => $country ) { |
| [454](#L454) | if ( $country ) { |
| [455](#L455) | $response\_data[ $ip\_id ] = cerber\_get\_flag\_html( $country, cerber\_country\_name( $country ) ); |
| [456](#L456) | } |
| [457](#L457) | else { |
| [458](#L458) | $response\_data[ $ip\_id ] = \_\_( 'Unknown', 'wp-cerber' ); |
| [459](#L459) | } |
| [460](#L460) | } |
| [461](#L461) | } |
| [462](#L462) | break; |
| [463](#L463) | case 'cbla': |
| [464](#L464) | $base = cerber\_activity\_link( array( 5 ) ); |
| [465](#L465) | foreach ( $list as $user\_id ) { |
| [466](#L466) | $row = cerber\_db\_get\_row( 'SELECT \* FROM ' . CERBER\_LOG\_TABLE . ' WHERE activity = 5 AND user\_id = ' . absint( $user\_id ) . ' ORDER BY stamp DESC LIMIT 1', MYSQL\_FETCH\_OBJECT ); |
| [467](#L467) | if ( $row ) { |
| [468](#L468) | if ( $country = crb\_country\_html( $row->country, $row->ip, false ) ) { |
| [469](#L469) | $country = '<br />' . $country; |
| [470](#L470) | } |
| [471](#L471) | else { |
| [472](#L472) | $country = ''; |
| [473](#L473) | } |
| [474](#L474) | $val = '<a href="' . $base . '&amp;filter\_user=' . $user\_id . '">' . cerber\_date( $row->stamp ) . '</a>' . $country; |
| [475](#L475) | } |
| [476](#L476) | else { |
| [477](#L477) | $val = \_\_( 'Never', 'wp-cerber' ); |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | $response\_data[ $user\_id ] = $val; |
| [481](#L481) | } |
| [482](#L482) | break; |
| [483](#L483) | case 'cbfl': |
| [484](#L484) | $base = cerber\_activity\_link( array( CRB\_EV\_LFL ) ); |
| [485](#L485) | foreach ( $list as $user\_id ) { |
| [486](#L486) | $u = get\_userdata( $user\_id ); |
| [487](#L487) | $val = 0; |
| [488](#L488) | $failed = cerber\_db\_get\_var( 'SELECT COUNT(user\_id) FROM ' . CERBER\_LOG\_TABLE . ' WHERE ( user\_login = "' . $u->user\_login . '" OR user\_login = "' . $u->user\_email . '" ) AND activity = ' . CRB\_EV\_LFL . ' AND stamp > ' . ( time() - 24 \* 3600 ) ); |
| [489](#L489) | if ( $failed ) { |
| [490](#L490) | $val = '<a href="' . $base . '&amp;filter\_login=' . $u->user\_email . '|' . $u->user\_login . '">' . $failed . '</a>'; |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | $response\_data[ $user\_id ] = $val; |
| [494](#L494) | } |
| [495](#L495) | break; |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | $response['data'] = $response\_data; |
| [499](#L499) | } |
| [500](#L500) | elseif ( $admin && isset( $request['dismiss\_info'] ) ) { |
| [501](#L501) | if ( isset( $request['button\_id'] ) && ( $request['button\_id'] == 'lab\_ok' || $request['button\_id'] == 'lab\_no' ) ) { |
| [502](#L502) | lab\_user\_opt\_in( $request['button\_id'] ); |
| [503](#L503) | } |
| [504](#L504) | else { |
| [505](#L505) | delete\_site\_option( 'cerber\_admin\_info' ); |
| [506](#L506) | } |
| [507](#L507) | } |
| [508](#L508) | elseif ( $admin && ( $ajax\_route = crb\_array\_get( $request, 'ajax\_route' ) ) ) { |
| [509](#L509) |  |
| [510](#L510) | $ref\_params = crb\_get\_referrer\_params(); |
| [511](#L511) |  |
| [512](#L512) | switch ( $ajax\_route ) { |
| [513](#L513) | case 'scanner\_analytics': |
| [514](#L514) | $response = cerber\_generate\_insights( $request['itype'] ); |
| [515](#L515) | break; |
| [516](#L516) | case 'user\_activity\_analytics': |
| [517](#L517) | $data = crb\_generate\_user\_insights( absint( $request['user\_id'] ), $ref\_params['tab'] ); |
| [518](#L518) | $response = array( 'html' => $data, 'error' => '' ); |
| [519](#L519) | break; |
| [520](#L520) | case 'ip\_extra\_info': |
| [521](#L521) | $response = cerber\_ip\_extra\_view\_ajax( $request, $ref\_params ); |
| [522](#L522) | break; |
| [523](#L523) | case 'ip\_quick\_analytics': |
| [524](#L524) | $data = crb\_generate\_ip\_insights( $request['ip\_address'], $ref\_params['tab'] ); |
| [525](#L525) | $response = array( 'html' => $data, 'error' => '' ); |
| [526](#L526) | break; |
| [527](#L527) | } |
| [528](#L528) | } |
| [529](#L529) | elseif ( $admin && ( $usearch = crb\_array\_get( $request, 'user\_search' ) ) ) { |
| [530](#L530) | $users    = get\_users( array( 'search' => '\*' . esc\_attr( $usearch ) . '\*', ) ); |
| [531](#L531) | $response = array(); |
| [532](#L532) | if ( $users ) { |
| [533](#L533) | foreach ( $users as $user ) { |
| [534](#L534) | $data       = get\_userdata( $user->ID ); |
| [535](#L535) | $response[] = array( |
| [536](#L536) | 'id'   => $user->ID, |
| [537](#L537) | 'text' => crb\_format\_user\_name( $data ) |
| [538](#L538) | ); |
| [539](#L539) | } |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | echo json\_encode( $response ); |
| [544](#L544) |  |
| [545](#L545) | if ( ! nexus\_is\_valid\_request() ) { |
| [546](#L546) | wp\_die(); |
| [547](#L547) | } |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | add\_action( 'wp\_ajax\_cerber\_local\_ajax', function () { |
| [551](#L551) | check\_ajax\_referer( 'crb-ajax-admin', 'ajax\_nonce' ); |
| [552](#L552) | if ( ! is\_super\_admin() ) { |
| [553](#L553) | wp\_die( 'Oops! Access denied.' ); |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | $done  = array(); |
| [557](#L557) |  |
| [558](#L558) | switch ( crb\_array\_get( $\_REQUEST, 'crb\_ajax\_do' ) ) { |
| [559](#L559) | case 'bg\_tasks\_run': |
| [560](#L560) | $done = cerber\_bg\_task\_launcher( array\_flip( crb\_array\_get( $\_REQUEST, 'tasks', array() ) ) ); |
| [561](#L561) | break; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | echo json\_encode( array( 'done' => $done ) ); |
| [565](#L565) | exit; |
| [566](#L566) | } ); |
| [567](#L567) |  |
| [568](#L568) | /\*\* |
| [569](#L569) | \* @param string $group |
| [570](#L570) | \* @param string $item\_id |
| [571](#L571) | \* |
| [572](#L572) | \* @return string |
| [573](#L573) | \*/ |
| [574](#L574) | function crb\_get\_ajax\_placeholder( $group, $item\_id ) { |
| [575](#L575) |  |
| [576](#L576) | return '<img class="crb-ajax-load" data-ajax\_group="' . $group . '" data-item\_id="' . $item\_id . '" src="' . CRB\_Globals::$ajax\_loader . '" />'; |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | /\* |
| [580](#L580) | \* Retrieve extended IP information |
| [581](#L581) | \* @since 2.2 |
| [582](#L582) | \* |
| [583](#L583) | \*/ |
| [584](#L584) | function cerber\_get\_ip\_info( $ip, $cache\_only = false ) { |
| [585](#L585) |  |
| [586](#L586) | $ip\_id = cerber\_get\_id\_ip( $ip ); |
| [587](#L587) |  |
| [588](#L588) | $var = get\_transient( $ip\_id ); |
| [589](#L589) | $ip\_info = crb\_unserialize( $var ); // lazy way |
| [590](#L590) | if ( $cache\_only  ) { |
| [591](#L591) | return $ip\_info; |
| [592](#L592) | } |
| [593](#L593) |  |
| [594](#L594) | if ( empty( $ip\_info['hostname\_html'] ) ) { |
| [595](#L595) | $ip\_info  = array(); |
| [596](#L596) | $hostname = @gethostbyaddr( $ip ); |
| [597](#L597) | if ( ! $hostname ) { |
| [598](#L598) | $hostname = \_\_( 'unknown', 'wp-cerber' ); |
| [599](#L599) | } |
| [600](#L600) | $ip\_info['hostname'] = $hostname; |
| [601](#L601) | if ( ! filter\_var( $hostname, FILTER\_VALIDATE\_IP ) ) { |
| [602](#L602) | $hostname = str\_replace( '.', '.<wbr>', $hostname ); |
| [603](#L603) | } |
| [604](#L604) | $ip\_info['hostname\_html'] = $hostname; |
| [605](#L605) | set\_transient( $ip\_id, serialize( $ip\_info ), 24 \* 3600 ); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | return $ip\_info; |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) |  |
| [612](#L612) | /\* |
| [613](#L613) | Admin dashboard actions |
| [614](#L614) | \*/ |
| [615](#L615) | add\_action( 'wp\_loaded', function () {  // 'wp\_loaded' @since 5.6 |
| [616](#L616) | if ( ! is\_admin() ) { |
| [617](#L617) | return; |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | cerber\_admin\_request(); |
| [621](#L621) |  |
| [622](#L622) | }, 0 ); |
| [623](#L623) | /\*\* |
| [624](#L624) | \* @param bool $is\_post |
| [625](#L625) | \* |
| [626](#L626) | \* @return mixed |
| [627](#L627) | \* |
| [628](#L628) | \*/ |
| [629](#L629) | function cerber\_admin\_request( $is\_post = false ) { |
| [630](#L630) | global $wpdb; |
| [631](#L631) |  |
| [632](#L632) | if ( ! nexus\_is\_valid\_request() |
| [633](#L633) | && ! cerber\_user\_can\_manage() ) { |
| [634](#L634) | return; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | $get  = crb\_get\_query\_params(); |
| [638](#L638) |  |
| [639](#L639) | if ( ( ! $nonce = crb\_array\_get( $get, 'cerber\_nonce' ) ) |
| [640](#L640) | && ( ! $nonce = crb\_get\_post\_fields( 'cerber\_nonce' ) ) ) { |
| [641](#L641) |  |
| [642](#L642) | return; |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | if ( ! wp\_verify\_nonce( $nonce, 'control' ) ) { |
| [646](#L646) | // TODO: Investigate why is this fires while managing a slave website via Cerber.Hub |
| [647](#L647) | //cerber\_admin\_notice( 'Nonce verification failed.' ); |
| [648](#L648) |  |
| [649](#L649) | return; |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | $post = crb\_get\_post\_fields(); |
| [653](#L653) |  |
| [654](#L654) | //$q = crb\_admin\_parse\_query( array( 'cerber\_admin\_do', 'ip' ) ); |
| [655](#L655) |  |
| [656](#L656) | $remove\_args = array(); |
| [657](#L657) |  |
| [658](#L658) | if ( cerber\_is\_http\_get() ) { |
| [659](#L659) | if ( ( $do = crb\_array\_get( $get, 'cerber\_admin\_do' ) ) ) { |
| [660](#L660) | switch ( $do ) { |
| [661](#L661) | case 'lockdel': |
| [662](#L662) | $ip = crb\_array\_get( $get, 'ip' ); |
| [663](#L663) | if ( cerber\_block\_delete( $ip ) ) { |
| [664](#L664) | cerber\_admin\_message( sprintf( \_\_( 'Lockout for %s was removed', 'wp-cerber' ), $ip ) ); |
| [665](#L665) | $remove\_args[] = 'ip'; |
| [666](#L666) | } |
| [667](#L667) | break; |
| [668](#L668) | case 'testnotify': |
| [669](#L669) | $test\_type = crb\_array\_get( $get, 'type', '', '\w+' ); |
| [670](#L670) | $test\_chan = crb\_array\_get( $get, 'channel', '', '\w+' ); |
| [671](#L671) |  |
| [672](#L672) | $channels = array(); |
| [673](#L673) |  |
| [674](#L674) | if ( $test\_chan && ( $test\_chan != 'email' || lab\_lab() ) ) { |
| [675](#L675) | $channels = array\_fill\_keys( array\_keys( CRB\_CHANNELS ), 0 ); |
| [676](#L676) | $channels = array\_merge( $channels, array( $test\_chan => 1 ) ); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $sent = cerber\_send\_notification( $test\_type, array( 'subj' => ' \*\*\* ' . \_\_( 'TEST MESSAGE', 'wp-cerber' ) . ' \*\*\* ' ), '', $channels, true ); |
| [680](#L680) |  |
| [681](#L681) | if ( $sent !== false ) { |
| [682](#L682) | $to = ' ' . implode( ', ', $sent); |
| [683](#L683) | /\* translators: %s is the name of a mobile device or/and email addresses. \*/ |
| [684](#L684) | cerber\_admin\_message( sprintf( \_\_( 'A test message has been sent to %s', 'wp-cerber' ), $to ) ); |
| [685](#L685) | } |
| [686](#L686) | else { |
| [687](#L687) | cerber\_admin\_notice( \_\_( 'Unable to send a test message', 'wp-cerber' ) ); |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | $remove\_args[] = 'type'; |
| [691](#L691) | $remove\_args[] = 'channel'; |
| [692](#L692) | break; |
| [693](#L693) | case 'subscribe': |
| [694](#L694) | $m = crb\_array\_get( $get, 'mode' ); |
| [695](#L695) | $mode = ( 'on' == $m ) ? 'on' : 'off'; |
| [696](#L696) | crb\_admin\_alerts\_do( $mode ); |
| [697](#L697) | $remove\_args = array\_merge( $remove\_args, CRB\_NON\_ALERT\_PARAMS ); |
| [698](#L698) | $remove\_args[] = 'subscribe'; |
| [699](#L699) | $remove\_args[] = 'mode'; |
| [700](#L700) | break; |
| [701](#L701) | case 'nexus\_set\_role': |
| [702](#L702) | nexus\_enable\_role(); |
| [703](#L703) | wp\_safe\_redirect( cerber\_admin\_link( null, array( 'page' => 'cerber-nexus' ) ) ); |
| [704](#L704) | exit(); |
| [705](#L705) | break; |
| [706](#L706) | case 'nexus\_delete\_slave': |
| [707](#L707) | //nexus\_delete\_slave( cerber\_get\_get( 'site\_id' ) ); |
| [708](#L708) | wp\_safe\_redirect( cerber\_admin\_link( 'nexus\_sites' ) ); |
| [709](#L709) | exit(); |
| [710](#L710) | break; |
| [711](#L711) | case 'nexus\_site\_table': |
| [712](#L712) | if ( cerber\_get\_bulk\_action() ) { |
| [713](#L713) | nexus\_do\_bulk(); |
| [714](#L714) | } |
| [715](#L715) | break; |
| [716](#L716) | case 'scan\_tegrity': |
| [717](#L717) | $adm  = crb\_array\_get( $get, 'crb\_scan\_adm' ); |
| [718](#L718) | $file = crb\_array\_get( $get, 'crb\_file\_id' ); |
| [719](#L719) | if ( in\_array( $adm, array( 'delete', 'restore' ) ) ) { |
| [720](#L720) | cerber\_quarantine\_do( $adm, crb\_array\_get( $get, 'crb\_scan\_id' ), crb\_array\_get( $get, 'crb\_file\_id' ) ); |
| [721](#L721) | } |
| [722](#L722) | elseif ( $adm == 'remove\_ignore' ) { |
| [723](#L723) | if ( crb\_remove\_ignore( $file ) ) { |
| [724](#L724) | cerber\_admin\_message( 'The file has been removed from the list' ); |
| [725](#L725) | } |
| [726](#L726) | } |
| [727](#L727) | $remove\_args = array( 'crb\_scan\_adm', 'crb\_scan\_id', 'crb\_file\_id' ); |
| [728](#L728) | break; |
| [729](#L729) | case 'manage\_diag\_log': |
| [730](#L730) | cerber\_manage\_diag\_log( crb\_array\_get( $get, 'do\_this' ) ); |
| [731](#L731) | $remove\_args[] = 'do\_this'; |
| [732](#L732) | break; |
| [733](#L733) | case 'terminate\_session': |
| [734](#L734) | crb\_sessions\_kill( crb\_array\_get( $get, 'id', null, '\w+' ), crb\_array\_get( $get, 'user\_id' ) ); |
| [735](#L735) | $remove\_args = array( 'user\_id', 'id' ); |
| [736](#L736) | break; |
| [737](#L737) | case 'crb\_manage\_sessions': |
| [738](#L738) | if ( cerber\_get\_bulk\_action() == 'bulk\_session\_terminate' ) { |
| [739](#L739) | crb\_sessions\_kill( crb\_array\_get( $get, 'ids', array(), '\w+' ) ); |
| [740](#L740) | } |
| [741](#L741) | elseif ( cerber\_get\_bulk\_action() == 'bulk\_block\_user' ) { |
| [742](#L742) | if ( ( $sids = crb\_array\_get( $get, 'ids', array(), '\w+' ) ) |
| [743](#L743) | && ( $users = cerber\_db\_get\_col( 'SELECT user\_id FROM ' . cerber\_get\_db\_prefix() . CERBER\_USS\_TABLE . ' WHERE wp\_session\_token IN ("' . implode( '","', $sids ) . '")' ) ) ) { |
| [744](#L744) | array\_walk( $users, 'cerber\_block\_user' ); |
| [745](#L745) | } |
| [746](#L746) | } |
| [747](#L747) | break; |
| [748](#L748) | case 'export': |
| [749](#L749) | if ( nexus\_is\_valid\_request() ) { |
| [750](#L750) | return crb\_admin\_get\_tokenized\_link(); |
| [751](#L751) | } |
| [752](#L752) | crb\_admin\_download\_file( crb\_array\_get( $get, 'type' ) ); |
| [753](#L753) | break; |
| [754](#L754) | case 'load\_defaults': |
| [755](#L755) | cerber\_load\_defaults(); |
| [756](#L756) | cerber\_admin\_message( \_\_( 'Default settings have been loaded', 'wp-cerber' ) ); |
| [757](#L757) | break; |
| [758](#L758) | case 'clear\_cache': |
| [759](#L759) | CRB\_Cache::reset(); |
| [760](#L760) | break; |
| [761](#L761) | default: |
| [762](#L762) | return; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | if ( nexus\_is\_valid\_request() ) { |
| [766](#L766) | return array( 'redirect' => true, 'remove\_args' => $remove\_args ); |
| [767](#L767) | } |
| [768](#L768) | else { |
| [769](#L769) | cerber\_safe\_redirect( $remove\_args ); |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | } |
| [773](#L773) |  |
| [774](#L774) | // TODO: move to the switch above |
| [775](#L775) | if ( cerber\_get\_get( 'citadel' ) == 'deactivate' ) { |
| [776](#L776) | cerber\_disable\_citadel(); |
| [777](#L777) | } |
| [778](#L778) | elseif ( isset( $\_GET['force\_repair\_db'] ) ) { |
| [779](#L779) | cerber\_create\_db(); |
| [780](#L780) | cerber\_upgrade\_db( true ); |
| [781](#L781) | cerber\_admin\_message( 'Cerber\'s database tables have been repaired and upgraded' ); |
| [782](#L782) | cerber\_safe\_redirect('force\_repair\_db'); |
| [783](#L783) | } |
| [784](#L784) | elseif ( $table = cerber\_get\_get( 'truncate', '[a-z\_]+' ) ) { |
| [785](#L785) | if ( 0 === strpos( $table, 'cerber\_' ) ) { |
| [786](#L786) | if ( $wpdb->query( 'TRUNCATE TABLE ' . $table ) ) { |
| [787](#L787) | cerber\_admin\_message( 'Table ' . $table . ' has been truncated' ); |
| [788](#L788) | } |
| [789](#L789) | else { |
| [790](#L790) | cerber\_admin\_notice( $wpdb->last\_error ); |
| [791](#L791) | } |
| [792](#L792) | } |
| [793](#L793) | cerber\_safe\_redirect( 'truncate' ); |
| [794](#L794) | } |
| [795](#L795) | elseif ( isset( $\_GET['force\_check\_nodes'] ) ) { |
| [796](#L796) | $best = lab\_check\_nodes( true ); |
| [797](#L797) | cerber\_admin\_message( 'Connectivity to all Cerber Lab\'s nodes has been checked. The closest node: ' . $best ); |
| [798](#L798) | cerber\_safe\_redirect( 'force\_check\_nodes' ); |
| [799](#L799) | } |
| [800](#L800) | elseif ( isset( $\_GET['clear\_up\_lab\_cache'] ) ) { |
| [801](#L801) | lab\_cleanup\_cache(); |
| [802](#L802) | cerber\_admin\_message( 'The Cerber Lab cache has been cleared' ); |
| [803](#L803) | cerber\_safe\_redirect( 'clear\_up\_lab\_cache' ); |
| [804](#L804) | } |
| [805](#L805) | elseif ( isset( $\_GET['clear\_up\_the\_cache'] ) ) { |
| [806](#L806) | lab\_cleanup\_cache(); |
| [807](#L807) | cerber\_delete\_expired\_set( true ); |
| [808](#L808) | cerber\_admin\_message( 'The plugin cache has been cleared' ); |
| [809](#L809) | cerber\_safe\_redirect( 'clear\_up\_the\_cache' ); |
| [810](#L810) | } |
| [811](#L811) | } |
| [812](#L812) |  |
| [813](#L813) | if ( cerber\_is\_http\_post() ) { |
| [814](#L814) |  |
| [815](#L815) | $redirect = false; |
| [816](#L816) |  |
| [817](#L817) | if ( ( $do = crb\_array\_get( $post, 'cerber\_admin\_do' ) ) ) { |
| [818](#L818) | switch ( $do ) { |
| [819](#L819) | case 'update\_role\_policies': |
| [820](#L820) | crb\_admin\_save\_role\_policies( $post ); |
| [821](#L821) | $redirect = true; |
| [822](#L822) | break; |
| [823](#L823) | case 'update\_geo\_rules': |
| [824](#L824) | crb\_admin\_save\_geo\_rules( $post ); |
| [825](#L825) | break; |
| [826](#L826) | case 'add2acl': |
| [827](#L827) | cerber\_acl\_form\_process( $post ); |
| [828](#L828) | break; |
| [829](#L829) | case 'add\_slave': |
| [830](#L830) | nexus\_add\_slave( crb\_array\_get( $post, 'new\_slave\_token' ) ); |
| [831](#L831) | break; |
| [832](#L832) | case 'install\_key': |
| [833](#L833) | $lic = preg\_replace( "/[^A-Z0-9]/i", '', crb\_array\_get( $post, 'cerber\_license' ) ); |
| [834](#L834) | if ( ( strlen( $lic ) == LAB\_KEY\_LENGTH ) || empty( $lic ) ) { |
| [835](#L835) | lab\_cleanup\_cache(); |
| [836](#L836) | cerber\_delete\_expired\_set( true ); |
| [837](#L837) | lab\_get\_site\_meta(); |
| [838](#L838) |  |
| [839](#L839) | lab\_update\_key( $lic ); |
| [840](#L840) |  |
| [841](#L841) | if ( $lic ) { |
| [842](#L842) | if ( lab\_validate\_lic() ) { |
| [843](#L843) | cerber\_admin\_message( '<b>Great! You have entered the valid license key.</b><p>Now, whenever you see a green shield icon in the top right-hand corner of any Cerber\'s admin page, it means the professional version works as intended, and your website is protected by WP Cerber Security Cloud.</p> |
| [844](#L844) | <p>Please use our client portal to manage your subscription, license keys and get support at <a target="\_blank" href="https://my.wpcerber.com">https://my.wpcerber.com</a></p> |
| [845](#L845) | <p>Thanks for being our client.</p>' ); |
| [846](#L846) | } |
| [847](#L847) | else { |
| [848](#L848) | cerber\_admin\_notice( 'Error! You have entered an invalid or expired license key.' ); |
| [849](#L849) | } |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | $redirect = true; |
| [853](#L853) | } |
| [854](#L854) | break; |
| [855](#L855) | } |
| [856](#L856) |  |
| [857](#L857) | if ( $redirect ) { |
| [858](#L858) | if ( nexus\_is\_valid\_request() ) { |
| [859](#L859) | // No redirection is needed so far, we use a second 'get\_page' request |
| [860](#L860) | //return array( 'redirect' => true, 'remove\_args' => $remove\_args ); |
| [861](#L861) | } |
| [862](#L862) | else { |
| [863](#L863) | cerber\_safe\_redirect( $remove\_args ); |
| [864](#L864) | } |
| [865](#L865) | } |
| [866](#L866) | } |
| [867](#L867) | } |
| [868](#L868) |  |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | function crb\_admin\_download\_file( $t, $query = array() ) { |
| [872](#L872) | switch ( $t ) { |
| [873](#L873) | case 'activity': |
| [874](#L874) | cerber\_export\_activity( $query ); |
| [875](#L875) | break; |
| [876](#L876) | case 'traffic': |
| [877](#L877) | cerber\_export\_traffic( $query ); |
| [878](#L878) | break; |
| [879](#L879) | case 'get\_diag\_log': |
| [880](#L880) | cerber\_manage\_diag\_log( 'download' ); |
| [881](#L881) | break; |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | function cerber\_safe\_redirect( $rem\_args ) { |
| [886](#L886) | if ( empty( $rem\_args ) ) { |
| [887](#L887) | $rem\_args = array(); |
| [888](#L888) | } |
| [889](#L889) | elseif ( ! is\_array( $rem\_args ) ) { |
| [890](#L890) | $rem\_args = array( $rem\_args ); |
| [891](#L891) | } |
| [892](#L892) | // Most used common args to remove |
| [893](#L893) | $rem\_args = array\_merge( $rem\_args, array( |
| [894](#L894) | '\_wp\_http\_referer', |
| [895](#L895) | '\_wpnonce', |
| [896](#L896) | 'cerber\_nonce', |
| [897](#L897) | 'ids', |
| [898](#L898) | 'cerber\_admin\_do', |
| [899](#L899) | 'action', |
| [900](#L900) | 'action2' |
| [901](#L901) | ) ); |
| [902](#L902) | wp\_safe\_redirect( remove\_query\_arg( $rem\_args ) ); |
| [903](#L903) | exit();  // mandatory! |
| [904](#L904) | } |
| [905](#L905) |  |
| [906](#L906) | function crb\_admin\_get\_tokenized\_link() { |
| [907](#L907) | if ( empty( nexus\_request\_data()->get\_params ) ) { |
| [908](#L908) | return false; |
| [909](#L909) | } |
| [910](#L910) | $key = crb\_random\_string( 26 ); |
| [911](#L911) | if ( cerber\_update\_set( '\_the\_key\_' . $key, array( 'query' => nexus\_request\_data()->get\_params ), 1, true, time() + 60 ) ) { |
| [912](#L912) | return array( 'redirect' => true, 'redirect\_url' => home\_url( '?cerber\_magic\_key=' . $key ) ); |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | cerber\_admin\_notice( 'Unable to generate a tokenized URL' ); |
| [916](#L916) |  |
| [917](#L917) | return false; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | function cerber\_export\_activity( $params = array() ) { |
| [921](#L921) |  |
| [922](#L922) | crb\_raise\_limits( 512 ); |
| [923](#L923) |  |
| [924](#L924) | $args = array( 'per\_page' => 0 ); |
| [925](#L925) |  |
| [926](#L926) | if ( $params ) { |
| [927](#L927) | $args = array\_merge( $params, $args ); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | list( $query, $per\_page, $falist, $ip, $filter\_login, $user\_id, $search, $sid, $in\_url ) = cerber\_activity\_query( $args ); |
| [931](#L931) |  |
| [932](#L932) | // We split into several requests to avoid PHP and MySQL memory limitations |
| [933](#L933) |  |
| [934](#L934) | if ( defined( 'CERBER\_EXPORT\_CHUNK' ) && is\_numeric( CERBER\_EXPORT\_CHUNK ) ) { |
| [935](#L935) | $per\_chunk = CERBER\_EXPORT\_CHUNK; |
| [936](#L936) | } |
| [937](#L937) | else { |
| [938](#L938) | $per\_chunk = 1000;      // Rows per SQL request: a compromise between the size of SQL data at each iteration and script execution time |
| [939](#L939) | } |
| [940](#L940) |  |
| [941](#L941) | if ( ! $result = cerber\_db\_query( $query . ' LIMIT ' . $per\_chunk ) ) { |
| [942](#L942) | wp\_die( 'Nothing to export' ); |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | $total = cerber\_db\_get\_var( "SELECT FOUND\_ROWS()" ); |
| [946](#L946) |  |
| [947](#L947) | $info = array(); |
| [948](#L948) |  |
| [949](#L949) | if ( $ip ) { |
| [950](#L950) | $info[] = '"Filter by IP:","' . $ip . '"'; |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | if ( $user\_id ) { |
| [954](#L954) | $user    = get\_userdata( $user\_id ); |
| [955](#L955) | $info[] = '"Filter by user:","' . $user->display\_name . '"'; |
| [956](#L956) | } |
| [957](#L957) | if ( $search ) { |
| [958](#L958) | $info[] = '"Search results for:","' . $search . '"'; |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) | $heading = array( |
| [962](#L962) | \_\_( 'IP Address', 'wp-cerber' ), |
| [963](#L963) | \_\_( 'Date', 'wp-cerber' ), |
| [964](#L964) | \_\_( 'Event', 'wp-cerber' ), |
| [965](#L965) | \_\_( 'Additional Details', 'wp-cerber' ), |
| [966](#L966) | \_\_( 'Local User', 'wp-cerber' ), |
| [967](#L967) | \_\_( 'User login', 'wp-cerber' ), |
| [968](#L968) | \_\_( 'User ID', 'wp-cerber' ), |
| [969](#L969) | \_\_( 'Username', 'wp-cerber' ), |
| [970](#L970) | 'Unix Timestamp', |
| [971](#L971) | 'Request ID', |
| [972](#L972) | 'URL', |
| [973](#L973) | ); |
| [974](#L974) |  |
| [975](#L975) | cerber\_send\_csv\_header( 'wp-cerber-activity', $total, $heading, $info ); |
| [976](#L976) |  |
| [977](#L977) | $labels = cerber\_get\_labels( 'activity' ); |
| [978](#L978) | $status = cerber\_get\_labels( 'status' ) + cerber\_get\_reason(); |
| [979](#L979) |  |
| [980](#L980) | $placeholder = array( 0, '', '', '', '' ); |
| [981](#L981) |  |
| [982](#L982) | if ( crb\_get\_settings( 'plain\_date' ) ) { |
| [983](#L983) | function \_crb\_csv\_date( $timestamp ) { |
| [984](#L984) | static $gmt\_offset; |
| [985](#L985) | if ( $gmt\_offset === null ) { |
| [986](#L986) | $gmt\_offset = get\_option( 'gmt\_offset' ) \* 3600; |
| [987](#L987) | } |
| [988](#L988) | return date( 'Y-m-d H:i:s', $timestamp + $gmt\_offset ); |
| [989](#L989) | } |
| [990](#L990) | } |
| [991](#L991) | else { |
| [992](#L992) | function \_crb\_csv\_date( $timestamp ) { |
| [993](#L993) | return cerber\_date( $timestamp, false ); |
| [994](#L994) | } |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | // The loop |
| [998](#L998) |  |
| [999](#L999) | $i = 0; |
| [1000](#L1000) |  |
| [1001](#L1001) | do { |
| [1002](#L1002) |  |
| [1003](#L1003) | while ( $row = mysqli\_fetch\_object( $result ) ) { |
| [1004](#L1004) |  |
| [1005](#L1005) | $values = array(); |
| [1006](#L1006) |  |
| [1007](#L1007) | if ( ! empty( $row->details ) ) { |
| [1008](#L1008) | $details = explode( '|', $row->details ); |
| [1009](#L1009) | } |
| [1010](#L1010) | else { |
| [1011](#L1011) | $details = $placeholder; |
| [1012](#L1012) | } |
| [1013](#L1013) |  |
| [1014](#L1014) | $values[] = $row->ip; |
| [1015](#L1015) | $values[] = \_crb\_csv\_date( $row->stamp ); |
| [1016](#L1016) | $values[] = $labels[ $row->activity ]; |
| [1017](#L1017) | $s        = $details[0]; |
| [1018](#L1018) | $values[] = ( isset( $status[ $s ] ) ) ? $status[ $s ] : ''; |
| [1019](#L1019) | $values[] = $row->display\_name; |
| [1020](#L1020) | $values[] = $row->ulogin; |
| [1021](#L1021) | $values[] = $row->user\_id; |
| [1022](#L1022) | $values[] = $row->user\_login; |
| [1023](#L1023) | $values[] = $row->stamp; |
| [1024](#L1024) | $values[] = $row->session\_id; |
| [1025](#L1025) | $values[] = $details[4]; |
| [1026](#L1026) |  |
| [1027](#L1027) | cerber\_send\_csv\_line( $values ); |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | mysqli\_free\_result( $result ); |
| [1031](#L1031) |  |
| [1032](#L1032) | $i ++; |
| [1033](#L1033) | $offset = $per\_chunk \* $i; |
| [1034](#L1034) |  |
| [1035](#L1035) | } while ( ( $result = cerber\_db\_query( $query . ' LIMIT ' . $offset . ', ' . $per\_chunk ) ) |
| [1036](#L1036) | && $result->num\_rows ); |
| [1037](#L1037) |  |
| [1038](#L1038) | exit; |
| [1039](#L1039) |  |
| [1040](#L1040) | } |
| [1041](#L1041) |  |
| [1042](#L1042) | function cerber\_send\_csv\_header( $f\_name, $total, $heading = array(), $info = array() ) { |
| [1043](#L1043) |  |
| [1044](#L1044) | $fname = $f\_name . '.csv'; |
| [1045](#L1045) |  |
| [1046](#L1046) | crb\_file\_headers( $fname ); |
| [1047](#L1047) |  |
| [1048](#L1048) | $info[] = '"Generated by:","WP Cerber Security ' . CERBER\_VER . '"'; |
| [1049](#L1049) | $info[] = '"Website:","' . crb\_get\_blogname\_decoded() . '"'; |
| [1050](#L1050) | $info[] = '"Date:","' . cerber\_date( time(), false ) . '"'; |
| [1051](#L1051) | $info[] = '"Rows in this file:","' . $total . '"'; |
| [1052](#L1052) |  |
| [1053](#L1053) | echo implode( "\r\n", $info ) . "\r\n\r\n"; |
| [1054](#L1054) |  |
| [1055](#L1055) | foreach ( $heading as &$item ) { |
| [1056](#L1056) | $item = '"' . str\_replace( '"', '""', trim( $item ) ) . '"'; |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | echo implode( ',', $heading ) . "\r\n"; |
| [1060](#L1060) |  |
| [1061](#L1061) | } |
| [1062](#L1062) |  |
| [1063](#L1063) | function cerber\_send\_csv\_line( $values ) { |
| [1064](#L1064) | foreach ( $values as &$value ) { |
| [1065](#L1065) | $value = '"' . str\_replace( '"', '""', trim( $value ) ) . '"'; |
| [1066](#L1066) | } |
| [1067](#L1067) | $line = implode( ',', $values ) . "\r\n"; |
| [1068](#L1068) | echo $line; |
| [1069](#L1069) | } |
| [1070](#L1070) |  |
| [1071](#L1071) | function crb\_admin\_activity\_nav\_links( $context = '' ) { |
| [1072](#L1072) |  |
| [1073](#L1073) | $links = array(); |
| [1074](#L1074) |  |
| [1075](#L1075) | if ( ! $context ) { |
| [1076](#L1076) | $links[] = array( array(), \_\_( 'View all', 'wp-cerber' ) ); |
| [1077](#L1077) |  |
| [1078](#L1078) | $labels = cerber\_get\_labels( 'activity' ); |
| [1079](#L1079) |  |
| [1080](#L1080) | $set = array( 5 ); |
| [1081](#L1081) | foreach ( $set as $item ) { |
| [1082](#L1082) | $links[] = array( array( 'filter\_activity' => $item ), $labels[ $item ] ); |
| [1083](#L1083) | } |
| [1084](#L1084) | } |
| [1085](#L1085) |  |
| [1086](#L1086) | if ( $context == 'users' ) { |
| [1087](#L1087) | $links[] = array( array( 'filter\_user' => '\*' ), \_\_( 'View all', 'wp-cerber' ) ); |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | if ( $context != 'suspicious' ) { |
| [1091](#L1091) | $links[] = array( array( 'filter\_activity' => array( 1, 2 ) ), \_\_( 'New users', 'wp-cerber' ) ); |
| [1092](#L1092) | $links[] = array( array( 'filter\_set' => 2 ), \_\_( 'Login issues', 'wp-cerber' ) ); |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | if ( $context != 'users' ) { |
| [1096](#L1096) | if ( ! $context ) { |
| [1097](#L1097) | $txt = \_\_( 'Suspicious activity', 'wp-cerber' ); |
| [1098](#L1098) | } |
| [1099](#L1099) | else { |
| [1100](#L1100) | $txt = \_\_( 'View all', 'wp-cerber' ); |
| [1101](#L1101) | } |
| [1102](#L1102) |  |
| [1103](#L1103) | $links[] = array( array( 'filter\_set' => 1 ), $txt ); |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | if ( ! $context ) { |
| [1107](#L1107) | $links[] = array( array( 'filter\_activity' => array( 10, 11 ) ), \_\_( 'IP blocked', 'wp-cerber' ) ); |
| [1108](#L1108) | $links[] = array( array( 'filter\_user' => '\*' ), \_\_( 'Users', 'wp-cerber' ) ); |
| [1109](#L1109) | $links[] = array( array( 'filter\_user' => 0 ), \_\_( 'Non-authenticated', 'wp-cerber' ) ); |
| [1110](#L1110) | if ( ! nexus\_is\_valid\_request() ) { |
| [1111](#L1111) | $links[] = array( array( 'filter\_user' => get\_current\_user\_id() ), \_\_( 'My activity', 'wp-cerber' ) ); |
| [1112](#L1112) | $links[] = array( array( 'filter\_ip' => cerber\_get\_remote\_ip() ), \_\_( 'My IP', 'wp-cerber' ) ); |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) |  |
| [1116](#L1116) | return crb\_make\_nav\_links( $links, 'activity' ); |
| [1117](#L1117) |  |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | /\*\* |
| [1121](#L1121) | \* @param array $link\_list A list of links |
| [1122](#L1122) | \* @param string $tab Admin page tab to generated links for |
| [1123](#L1123) | \* @param string $class CSS class |
| [1124](#L1124) | \* |
| [1125](#L1125) | \* @return string |
| [1126](#L1126) | \* @since 8.8.3.2 |
| [1127](#L1127) | \*/ |
| [1128](#L1128) | function crb\_make\_nav\_links( $link\_list, $tab = 'activity', $class = '' ) { |
| [1129](#L1129) |  |
| [1130](#L1130) | $params = crb\_get\_referrer\_params(); |
| [1131](#L1131) | unset( $params['page'], $params['tab'], $params['pagen'] ); |
| [1132](#L1132) |  |
| [1133](#L1133) | $base\_url = cerber\_admin\_link( $tab ); |
| [1134](#L1134) | $ret = ''; |
| [1135](#L1135) |  |
| [1136](#L1136) | foreach ( $link\_list as $link ) { |
| [1137](#L1137) | $query\_string = ''; |
| [1138](#L1138) | $selected = false; |
| [1139](#L1139) | $other = $params; |
| [1140](#L1140) |  |
| [1141](#L1141) | if ( ! empty( $link[0] ) ) { |
| [1142](#L1142) | $selected = true; |
| [1143](#L1143) | foreach ( $link[0] as $name => $value ) { |
| [1144](#L1144) | if ( ! is\_array( $value ) ) { |
| [1145](#L1145) | $query\_string .= '&amp;' . $name . '=' . $value; |
| [1146](#L1146) | if ( crb\_array\_get( $params, $name ) !== (string) $value ) { |
| [1147](#L1147) | $selected = false; |
| [1148](#L1148) | } |
| [1149](#L1149) | else { |
| [1150](#L1150) | unset( $other[ $name ] ); |
| [1151](#L1151) | } |
| [1152](#L1152) | } |
| [1153](#L1153) | else { |
| [1154](#L1154) | foreach ( $value as $key => $val ) { |
| [1155](#L1155) | $query\_string .= '&amp;' . $name . '[' . $key . ']=' . $val; |
| [1156](#L1156) | if ( crb\_array\_get( $params, array( $name, $key ) ) !== (string) $val ) { |
| [1157](#L1157) | $selected = false; |
| [1158](#L1158) | } |
| [1159](#L1159) | else { |
| [1160](#L1160) | unset( $other[ $name ][ $key ] ); |
| [1161](#L1161) | } |
| [1162](#L1162) | } |
| [1163](#L1163) | } |
| [1164](#L1164) | } |
| [1165](#L1165) | } |
| [1166](#L1166) |  |
| [1167](#L1167) | $other = array\_filter( $other, function ( $val ) { |
| [1168](#L1168) | return $val === 0 || ! empty( $val ); |
| [1169](#L1169) | } ); |
| [1170](#L1170) |  |
| [1171](#L1171) | if ( $selected & empty( $other ) ) { |
| [1172](#L1172) | $ret .= '<span class="crb\_selected">' . $link[1] . '</span> '; |
| [1173](#L1173) | } |
| [1174](#L1174) | else { |
| [1175](#L1175) | $ret .= '<a class="" href="' . $base\_url . $query\_string . '">' . $link[1] . '</a> '; |
| [1176](#L1176) | } |
| [1177](#L1177) | } |
| [1178](#L1178) |  |
| [1179](#L1179) | return '<div class="crb-tag-buttons ' . $class . '">' . $ret . '</div>'; |
| [1180](#L1180) | } |
| [1181](#L1181) |  |
| [1182](#L1182) | /\* |
| [1183](#L1183) | \* Display activities in the WP Dashboard |
| [1184](#L1184) | \* |
| [1185](#L1185) | \* |
| [1186](#L1186) | \*/ |
| [1187](#L1187) | function cerber\_show\_activity( $args = array(), $echo = true ) { |
| [1188](#L1188) |  |
| [1189](#L1189) | $status\_labels = cerber\_get\_labels( 'status' ) + cerber\_get\_reason(); |
| [1190](#L1190) | $base\_url = cerber\_activity\_link(); |
| [1191](#L1191) | $is\_log\_empty = ! ( (bool) cerber\_db\_get\_var( 'SELECT ip FROM ' . CERBER\_LOG\_TABLE . ' LIMIT 1' ) ); |
| [1192](#L1192) | $export\_link = ''; |
| [1193](#L1193) | $ret = ''; |
| [1194](#L1194) |  |
| [1195](#L1195) | list( $query, $per\_page, $falist, $filter\_ip, $filter\_login, $user\_id, $search, $sid, $in\_url ) = cerber\_activity\_query( $args ); |
| [1196](#L1196) |  |
| [1197](#L1197) | $sname = ''; |
| [1198](#L1198) | $info  = ''; |
| [1199](#L1199) |  |
| [1200](#L1200) | $\_find = array(); |
| [1201](#L1201) |  |
| [1202](#L1202) | if ( $filter\_login ) { |
| [1203](#L1203) | $login = explode( '|', $filter\_login ); |
| [1204](#L1204) | if ( is\_email( $login[0] ) ) { |
| [1205](#L1205) | $\_find[] = array( 'email', $login[0] ); |
| [1206](#L1206) | } |
| [1207](#L1207) | else { |
| [1208](#L1208) | $\_find[] = array( 'login', $login[0] ); |
| [1209](#L1209) | } |
| [1210](#L1210) |  |
| [1211](#L1211) | if ( isset( $login[1] ) ) { |
| [1212](#L1212) | if ( is\_email( $login[1] ) ) { |
| [1213](#L1213) | $\_find[] = array( 'email', $login[1] ); |
| [1214](#L1214) | } |
| [1215](#L1215) | else { |
| [1216](#L1216) | $\_find[] = array( 'login', $login[1] ); |
| [1217](#L1217) | } |
| [1218](#L1218) | } |
| [1219](#L1219) | } |
| [1220](#L1220) |  |
| [1221](#L1221) | if ( $search ) { |
| [1222](#L1222) | if ( cerber\_is\_ip( $search ) ) { |
| [1223](#L1223) | $filter\_ip = $search; |
| [1224](#L1224) | } |
| [1225](#L1225) | else { |
| [1226](#L1226) | if ( is\_email( $search ) ) { |
| [1227](#L1227) | $\_find[] = array( 'email', $search ); |
| [1228](#L1228) | } |
| [1229](#L1229) | else { |
| [1230](#L1230) | $\_find[] = array( 'login', $search ); |
| [1231](#L1231) | } |
| [1232](#L1232) | } |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | if ( ! $user\_id && $\_find ) { |
| [1236](#L1236) | foreach ( $\_find as $item ) { |
| [1237](#L1237) | if ( $user = get\_user\_by( $item[0], $item[1] ) ) { |
| [1238](#L1238) | $user\_id = $user->ID; |
| [1239](#L1239) | break; |
| [1240](#L1240) | } |
| [1241](#L1241) | } |
| [1242](#L1242) | } |
| [1243](#L1243) |  |
| [1244](#L1244) | if ( $user\_id ) { |
| [1245](#L1245) | $sname = crb\_format\_user\_name( $user\_id ); |
| [1246](#L1246) | $info .= cerber\_user\_extra\_view( $user\_id ); |
| [1247](#L1247) | } |
| [1248](#L1248) |  |
| [1249](#L1249) | if ( $filter\_ip ) { |
| [1250](#L1250) | $info .= cerber\_ip\_extra\_view( $filter\_ip ); |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | // No cache |
| [1254](#L1254) | //$rows = cerber\_db\_get\_results( $query, MYSQL\_FETCH\_OBJECT ); |
| [1255](#L1255) | if ( empty( $args['no\_navi'] ) ) { |
| [1256](#L1256) | list( $rows, $total ) = crb\_q\_cache\_get( array( array( $query, MYSQL\_FETCH\_OBJECT ), array( "SELECT FOUND\_ROWS()" ) ), CERBER\_LOG\_TABLE ); |
| [1257](#L1257) | $total = $total[0][0]; |
| [1258](#L1258) | } |
| [1259](#L1259) | else { |
| [1260](#L1260) | $rows = crb\_q\_cache\_get( array( array( $query, MYSQL\_FETCH\_OBJECT ) ), CERBER\_LOG\_TABLE ); |
| [1261](#L1261) | } |
| [1262](#L1262) |  |
| [1263](#L1263) | if ( $rows ) { |
| [1264](#L1264) |  |
| [1265](#L1265) | $no\_results = false; |
| [1266](#L1266) |  |
| [1267](#L1267) | if ( empty( $args['no\_navi'] ) ) { |
| [1268](#L1268) | // No cache |
| [1269](#L1269) | //$total = cerber\_db\_get\_var( "SELECT FOUND\_ROWS()" ); |
| [1270](#L1270) | } |
| [1271](#L1271) |  |
| [1272](#L1272) | $tbody = ''; |
| [1273](#L1273) | $country = ''; |
| [1274](#L1274) | $geo = lab\_lab(); |
| [1275](#L1275) |  |
| [1276](#L1276) | if ( ! defined( 'CERBER\_FULL\_URI' ) || ! CERBER\_FULL\_URI ) { |
| [1277](#L1277) | $short = true; |
| [1278](#L1278) | $site\_url = cerber\_get\_site\_url(); |
| [1279](#L1279) | $site\_url = substr( $site\_url, strpos( $site\_url, '://' ) + 3 ); |
| [1280](#L1280) | $start = strlen( rtrim( $site\_url, '/' ) ); |
| [1281](#L1281) | } |
| [1282](#L1282) | else { |
| [1283](#L1283) | $short = false; |
| [1284](#L1284) | $start = 0; |
| [1285](#L1285) | } |
| [1286](#L1286) |  |
| [1287](#L1287) | foreach ( $rows as $row ) { |
| [1288](#L1288) |  |
| [1289](#L1289) | $ip\_id = cerber\_get\_id\_ip( $row->ip ); |
| [1290](#L1290) |  |
| [1291](#L1291) | $activity = '<span class="crb-activity actv' . $row->activity . '" title="' . $row->activity . '">' . crb\_get\_label( $row->activity, $row->user\_id, $row->ac\_by\_user ) . '</span>'; |
| [1292](#L1292) |  |
| [1293](#L1293) | if ( empty( $args['no\_details'] ) && $row->details ) { |
| [1294](#L1294) | $details = explode( '|', $row->details ); |
| [1295](#L1295) |  |
| [1296](#L1296) | if ( ! empty( $details[0] ) && isset( $status\_labels[ $details[0] ] ) ) { |
| [1297](#L1297) | $activity .= ' <span class = "crb-log-status crb-status-' . $details[0] . '" title="' . $details[0] . '">' . $status\_labels[ $details[0] ] . '</span>'; |
| [1298](#L1298) | } |
| [1299](#L1299) |  |
| [1300](#L1300) | if ( ( $uri = crb\_array\_get( $details, 4 ) ) |
| [1301](#L1301) | && ( $row->activity < 10 || $row->activity > 12 ) ) { |
| [1302](#L1302) |  |
| [1303](#L1303) | if ( $short && 0 === strpos( $uri, $site\_url ) ) { |
| [1304](#L1304) | $ac\_uri = substr( $uri, $start ); |
| [1305](#L1305) | } |
| [1306](#L1306) | else { |
| [1307](#L1307) | $ac\_uri = $uri; |
| [1308](#L1308) | } |
| [1309](#L1309) |  |
| [1310](#L1310) | $activity .= '<p class="crb\_act\_url" title="' . htmlspecialchars( $uri ) . '">' . str\_replace( array( '-', '/' ), array( |
| [1311](#L1311) | '<wbr>-', |
| [1312](#L1312) | '<wbr>/' |
| [1313](#L1313) | ), htmlspecialchars( urldecode( $ac\_uri ) ) ) . '</p>'; |
| [1314](#L1314) | } |
| [1315](#L1315) |  |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | $activity = '<div class="crb' . $row->activity . '">' . $activity . '</div>'; |
| [1319](#L1319) |  |
| [1320](#L1320) | $name = crb\_admin\_get\_user\_cell( $row->user\_id, $base\_url ); |
| [1321](#L1321) |  |
| [1322](#L1322) | $username = '<a href="' . $base\_url . '&amp;filter\_login=' . $row->user\_login . '">' . $row->user\_login . '</a>'; |
| [1323](#L1323) |  |
| [1324](#L1324) | $ip\_info = cerber\_get\_ip\_info( $row->ip, true ); |
| [1325](#L1325) | $hostname = $ip\_info['hostname\_html'] ?? crb\_get\_ajax\_placeholder( 'hostname', $ip\_id ); |
| [1326](#L1326) |  |
| [1327](#L1327) | if ( ! empty( $args['date'] ) && $args['date'] == 'ago' ) { |
| [1328](#L1328) | $date = cerber\_ago\_time( $row->stamp ); |
| [1329](#L1329) | } |
| [1330](#L1330) | else { |
| [1331](#L1331) | $date = '<span title="' . $row->stamp . ' / ' . $row->session\_id . ' / ' . $row->activity . '">' . cerber\_date( $row->stamp ) . '</span>'; |
| [1332](#L1332) | } |
| [1333](#L1333) |  |
| [1334](#L1334) | if ( $geo ) { |
| [1335](#L1335) | $country = '</td><td>' . crb\_country\_html( $row->country, $row->ip ); |
| [1336](#L1336) | } |
| [1337](#L1337) |  |
| [1338](#L1338) | $tbody .= '<tr class="acrow' . $row->activity . '"><td>' . crb\_admin\_ip\_cell( $row->ip, $base\_url . '&amp;filter\_ip=' . $row->ip ) . '</td><td>' . $hostname . $country . '</td><td>' . $date . '</td><td class="acinfo">' . $activity . '</td><td>' . $name . '</td><td>' . $username . '</td></tr>'; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | $heading = array( |
| [1342](#L1342) | 'crb\_ip\_col'       => '<div class="crb\_act\_icon"></div>' . \_\_( 'IP Address', 'wp-cerber' ), |
| [1343](#L1343) | 'crb\_hostname\_col' => \_\_( 'Hostname', 'wp-cerber' ), |
| [1344](#L1344) | 'crb\_country\_col'  => \_\_( 'Country', 'wp-cerber' ), |
| [1345](#L1345) | 'crb\_date\_col'     => \_\_( 'Date', 'wp-cerber' ), |
| [1346](#L1346) | 'crb\_event\_col'    => \_\_( 'Event', 'wp-cerber' ), |
| [1347](#L1347) | 'crb\_user\_col'     => \_\_( 'Local User', 'wp-cerber' ), |
| [1348](#L1348) | 'crb\_username\_col' => \_\_( 'Username', 'wp-cerber' ) |
| [1349](#L1349) | ); |
| [1350](#L1350) |  |
| [1351](#L1351) | if ( ! $geo ) { |
| [1352](#L1352) | unset( $heading['crb\_country\_col'] ); |
| [1353](#L1353) | } |
| [1354](#L1354) |  |
| [1355](#L1355) | $titles\_head = ''; |
| [1356](#L1356) | foreach ( $heading as $id => $title ) { |
| [1357](#L1357) | $titles\_head .= '<th id="' . $id . '">' . $title . '</th>'; |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | $titles\_foot = '<th>' . implode( '</th><th>', $heading ) . '</th>'; |
| [1361](#L1361) |  |
| [1362](#L1362) | $class = 'widefat crb-table cerber-margin crb-' . count( $heading ) . '-columns'; |
| [1363](#L1363) |  |
| [1364](#L1364) | $table = '<table id="crb-activity" class="' . $class . '"><thead><tr>' . $titles\_head . '</tr></thead><tfoot><tr>' . $titles\_foot . '</tr></tfoot><tbody>' . $tbody . '</tbody></table>'; |
| [1365](#L1365) |  |
| [1366](#L1366) | if ( empty( $args['no\_navi'] ) ) { |
| [1367](#L1367) | $table .= cerber\_page\_navi( $total, $per\_page ); |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | //$legend  = '<p>'.sprintf(\_\_('Showing last %d records from %d','wp-cerber'),count($rows),$total); |
| [1371](#L1371) |  |
| [1372](#L1372) | if ( empty( $args['no\_export'] ) ) { |
| [1373](#L1373) | $export\_link .= '<a class="button button-secondary cerber-button" href="' . |
| [1374](#L1374) | cerber\_admin\_link\_add( array( |
| [1375](#L1375) | 'cerber\_admin\_do' => 'export', |
| [1376](#L1376) | 'type'            => 'activity', |
| [1377](#L1377) | ), true ) . '"><i class="crb-icon crb-icon-bx-download"></i> ' . \_\_( 'Export', 'wp-cerber' ) . '</a>'; |
| [1378](#L1378) | //) ) . '"><span class="dashicons dashicons-download" style="vertical-align: middle;"></span> ' . \_\_( 'Export', 'wp-cerber' ) . '</a>'; |
| [1379](#L1379) | } |
| [1380](#L1380) | } |
| [1381](#L1381) | else { |
| [1382](#L1382) |  |
| [1383](#L1383) | // No results found ------------------------------------------------------------- |
| [1384](#L1384) |  |
| [1385](#L1385) | $no\_results = true; |
| [1386](#L1386) |  |
| [1387](#L1387) | // Is it a search (filter) request? |
| [1388](#L1388) |  |
| [1389](#L1389) | $is\_search = ( array\_intersect\_key( CRB\_ACT\_PARAMS, crb\_get\_query\_params() ) ); |
| [1390](#L1390) |  |
| [1391](#L1391) | $hints = array(); |
| [1392](#L1392) |  |
| [1393](#L1393) | if ( ! $is\_search ) { |
| [1394](#L1394) | $hints[] = \_\_( 'No activity has been logged yet.', 'wp-cerber' ); |
| [1395](#L1395) | } |
| [1396](#L1396) | else { |
| [1397](#L1397) | $hints[] = \_\_( 'No events found using the given search criteria', 'wp-cerber' ); |
| [1398](#L1398) |  |
| [1399](#L1399) | if ( crb\_admin\_alert\_exists() ) { |
| [1400](#L1400) | $hints[] = \_\_( 'You will be notified when such an event occurs', 'wp-cerber' ) . ' [ ' . crb\_admin\_alert\_dialog( false, '', \_\_( 'Delete', 'wp-cerber' ) ) . ' ]'; |
| [1401](#L1401) | } |
| [1402](#L1402) | elseif ( $alert\_link = crb\_admin\_alert\_dialog( false, \_\_( 'Get me notified when such an event occurs', 'wp-cerber' ) ) ) { |
| [1403](#L1403) | $hints[] = $alert\_link; |
| [1404](#L1404) | } |
| [1405](#L1405) |  |
| [1406](#L1406) | if ( ! $is\_log\_empty ) { |
| [1407](#L1407) | $hints[] = '<a href="' . $base\_url . '">' . \_\_( 'View all logged events', 'wp-cerber' ) . '</a>'; |
| [1408](#L1408) | } |
| [1409](#L1409) |  |
| [1410](#L1410) | $trf\_params = array(); |
| [1411](#L1411) | if ( cerber\_is\_ip\_or\_net( $search ) ) { |
| [1412](#L1412) | $trf\_params['filter\_ip'] = $search; |
| [1413](#L1413) | } |
| [1414](#L1414) | if ( $trf\_params ) { |
| [1415](#L1415) | $hints[] = '<p class="cerber-margin"><a href="' . cerber\_admin\_link( 'traffic', $trf\_params ) . '">' . \_\_( 'Check for requests from the IP address', 'wp-cerber' ) . ' ' . $trf\_params['filter\_ip'] . '</a></p>'; |
| [1416](#L1416) | } |
| [1417](#L1417) | } |
| [1418](#L1418) |  |
| [1419](#L1419) | $table = '<div class="cerber-margin crb-rectangle"><p>' . implode( '</p><p>', $hints ) . '</p></div>'; |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | if ( empty( $args['no\_navi'] ) ) { |
| [1423](#L1423) |  |
| [1424](#L1424) | $display = ( $sid || $in\_url ) ? '' : 'display: none;'; |
| [1425](#L1425) |  |
| [1426](#L1426) | $filters = '<form action="' . cerber\_activity\_link() . '"><div id="crb-activity-fields"><div>' |
| [1427](#L1427) |  |
| [1428](#L1428) | . crb\_get\_activity\_dd() |
| [1429](#L1429) | . cerber\_select( 'filter\_user', ( $user\_id ) ? array( $user\_id => $sname ) : array(), $user\_id, 'crb-select2-ajax', '', false, esc\_html\_\_( 'Filter by registered user', 'wp-cerber' ), array( 'min\_symbols' => 3 ) ) |
| [1430](#L1430) | . '<input type="text" value="' . $search . '" name="search\_activity" placeholder="' . esc\_html\_\_( 'Search for IP or username', 'wp-cerber' ) . '"> |
| [1431](#L1431) |  |
| [1432](#L1432) | <div id="crb-more-activity-fields" style="' . $display . '"> |
| [1433](#L1433) | <input type="text" value="' . $sid . '" name="filter\_sid" placeholder="' . esc\_html\_\_( 'Request ID', 'wp-cerber' ) . '"> |
| [1434](#L1434) | <input type="text" value="' . $in\_url . '" name="search\_url" placeholder="' . esc\_html\_\_( 'Search in URL', 'wp-cerber' ) . '"> |
| [1435](#L1435) | </div> |
| [1436](#L1436) |  |
| [1437](#L1437) | </div> |
| [1438](#L1438) |  |
| [1439](#L1439) | <div class="crb-act-controls"> |
| [1440](#L1440) | <button type="submit" class="cerber-button button button-primary"> |
| [1441](#L1441) | ' . \_\_( 'Filter', 'wp-cerber' ) . ' |
| [1442](#L1442) | </button> |
| [1443](#L1443) | </div> |
| [1444](#L1444) |  |
| [1445](#L1445) | <div class="crb-act-controls"> |
| [1446](#L1446) | [&nbsp;<a href="#" class="crb-opener" data-target="crb-more-activity-fields">More</a>&nbsp;] |
| [1447](#L1447) | </div> |
| [1448](#L1448) |  |
| [1449](#L1449) | </div> |
| [1450](#L1450) |  |
| [1451](#L1451) | <input type="hidden" name="page" value="cerber-security" > |
| [1452](#L1452) | <input type="hidden" name="tab" value="activity"> |
| [1453](#L1453) | </form>'; |
| [1454](#L1454) |  |
| [1455](#L1455) | $right\_links = ''; |
| [1456](#L1456) |  |
| [1457](#L1457) | if ( ! $no\_results ) { |
| [1458](#L1458) | $right\_links = crb\_admin\_alert\_dialog(); |
| [1459](#L1459) | } |
| [1460](#L1460) |  |
| [1461](#L1461) | $right\_links .= $export\_link; |
| [1462](#L1462) |  |
| [1463](#L1463) | $top\_bar = '<div id="activity-filter"><div>' . $filters . '</div><div>' . $right\_links . '</div></div><br style="clear: both;">'; |
| [1464](#L1464) |  |
| [1465](#L1465) | $quick = ''; |
| [1466](#L1466) | if ( ! $is\_log\_empty ) { |
| [1467](#L1467) | $quick = crb\_admin\_activity\_nav\_links(); |
| [1468](#L1468) | } |
| [1469](#L1469) |  |
| [1470](#L1470) | $ret = '<div><div class="crb-quick-nav">' . $quick . '</div>' . $top\_bar . $info . '</div>' . $ret; |
| [1471](#L1471) |  |
| [1472](#L1472) | } |
| [1473](#L1473) |  |
| [1474](#L1474) | $ret .= $table; |
| [1475](#L1475) |  |
| [1476](#L1476) | if ( $echo ) { |
| [1477](#L1477) | echo $ret; |
| [1478](#L1478) | } |
| [1479](#L1479) | else { |
| [1480](#L1480) | return $ret; |
| [1481](#L1481) | } |
| [1482](#L1482) |  |
| [1483](#L1483) | } |
| [1484](#L1484) |  |
| [1485](#L1485) | /\*\* |
| [1486](#L1486) | \* Parse arguments and create SQL query for retrieving rows from activity log |
| [1487](#L1487) | \* |
| [1488](#L1488) | \* @param array $args Optional arguments to use them instead of using $\_GET |
| [1489](#L1489) | \* |
| [1490](#L1490) | \* @return array |
| [1491](#L1491) | \* @since 4.16 |
| [1492](#L1492) | \*/ |
| [1493](#L1493) | function cerber\_activity\_query( $args = array() ) { |
| [1494](#L1494) | global $wpdb; |
| [1495](#L1495) |  |
| [1496](#L1496) | $ret   = array\_fill( 0, 9, '' ); |
| [1497](#L1497) | $where = array(); |
| [1498](#L1498) |  |
| [1499](#L1499) | $q = crb\_admin\_parse\_query( array\_keys( CRB\_ACT\_PARAMS ), $args ); |
| [1500](#L1500) |  |
| [1501](#L1501) | $falist = array(); |
| [1502](#L1502) | if ( ! empty( $q->filter\_set ) ) { |
| [1503](#L1503) | $falist = crb\_get\_filter\_set( $q->filter\_set ); |
| [1504](#L1504) | } |
| [1505](#L1505) | elseif ( $q->filter\_activity ) { // Multiple activities can be requested this way: &filter\_activity[]=11&filter\_activity[]=7 |
| [1506](#L1506) | $falist = crb\_sanitize\_int( $q->filter\_activity ); |
| [1507](#L1507) | } |
| [1508](#L1508) | if ( $falist ) { |
| [1509](#L1509) | $where[] = 'log.activity IN (' . implode( ',', $falist ) . ')'; |
| [1510](#L1510) | } |
| [1511](#L1511) | $ret[2] = $falist; |
| [1512](#L1512) |  |
| [1513](#L1513) | if ( $q->filter\_status ) { |
| [1514](#L1514) | if ( $status = crb\_sanitize\_int( $q->filter\_status ) ) { |
| [1515](#L1515) | $where[] = 'log.ac\_status IN (' . implode( ',', $status ) . ')'; |
| [1516](#L1516) | } |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | if ( $q->filter\_ip ) { |
| [1520](#L1520) | $range = cerber\_any2range( $q->filter\_ip ); |
| [1521](#L1521) | if ( is\_array( $range ) ) { |
| [1522](#L1522) | $where[] = '(log.ip\_long >= ' . $range['begin'] . ' AND log.ip\_long <= ' . $range['end'] . ')'; |
| [1523](#L1523) | } |
| [1524](#L1524) | elseif ( cerber\_is\_ip\_or\_net( $q->filter\_ip ) ) { |
| [1525](#L1525) | $where[] = 'log.ip = "' . $q->filter\_ip . '"'; |
| [1526](#L1526) | } |
| [1527](#L1527) | else { |
| [1528](#L1528) | $where[] = "ip = 'produce-no-result'"; |
| [1529](#L1529) | } |
| [1530](#L1530) | $ret[3] = preg\_replace( CRB\_IP\_NET\_RANGE, ' ', $q->filter\_ip ); |
| [1531](#L1531) | } |
| [1532](#L1532) |  |
| [1533](#L1533) | if ( $q->filter\_login ) { |
| [1534](#L1534) | if ( strpos( $q->filter\_login, '|' ) ) { |
| [1535](#L1535) | $sanitize = preg\_replace( '/["\'<>\/]+/', '', $q->filter\_login ); |
| [1536](#L1536) | $logins = explode( '|', $sanitize ); |
| [1537](#L1537) | $where[] = '( log.user\_login = "' . implode( '" OR log.user\_login = "', $logins ) . '" )'; |
| [1538](#L1538) | } |
| [1539](#L1539) | else { |
| [1540](#L1540) | $where[] = $wpdb->prepare( 'log.user\_login = %s', $q->filter\_login ); |
| [1541](#L1541) | } |
| [1542](#L1542) | $ret[4] = htmlspecialchars( $q->filter\_login ); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | if ( isset( $q->filter\_user ) ) { |
| [1546](#L1546) | if ( $q->filter\_user == '\*' ) { |
| [1547](#L1547) | $where[] = 'log.user\_id != 0'; |
| [1548](#L1548) | $ret[5]  = ''; |
| [1549](#L1549) | } |
| [1550](#L1550) | elseif ( is\_numeric( $q->filter\_user ) ) { |
| [1551](#L1551) | $user\_id = absint( $q->filter\_user ); |
| [1552](#L1552) | //$where[] = 'log.user\_id = ' . $user\_id; |
| [1553](#L1553) | $where[] = '( log.user\_id = ' . $user\_id . ' OR log.ac\_by\_user =' . $user\_id . ')'; |
| [1554](#L1554) | $ret[5]  = $user\_id; |
| [1555](#L1555) | } |
| [1556](#L1556) | } |
| [1557](#L1557) |  |
| [1558](#L1558) | if ( $q->search\_activity ) { |
| [1559](#L1559) | $search = stripslashes( $q->search\_activity ); |
| [1560](#L1560) | $ret[6] = htmlspecialchars( $search ); |
| [1561](#L1561) | $search = '%' . $search . '%'; |
| [1562](#L1562) |  |
| [1563](#L1563) | $escaped = cerber\_real\_escape( $search ); |
| [1564](#L1564) | $w = array(); |
| [1565](#L1565) | $w[] = 'log.user\_login LIKE "' . $escaped . '"'; |
| [1566](#L1566) | $w[] = 'log.ip LIKE "' . $escaped . '"'; |
| [1567](#L1567) |  |
| [1568](#L1568) | $where[] = '(' . implode( ' OR ', $w ) . ')'; |
| [1569](#L1569) | } |
| [1570](#L1570) |  |
| [1571](#L1571) | if ( $q->filter\_sid ) { |
| [1572](#L1572) | $ret[7] = $sid = preg\_replace( '/[^\w]/', '', $q->filter\_sid ); |
| [1573](#L1573) | $where[] = 'log.session\_id = "' . $sid . '"'; |
| [1574](#L1574) | } |
| [1575](#L1575) |  |
| [1576](#L1576) | if ( $q->search\_url ) { |
| [1577](#L1577) | $search  = stripslashes( $q->search\_url ); |
| [1578](#L1578) | $ret[8]  = htmlspecialchars( $search ); |
| [1579](#L1579) | $where[] = 'log.details LIKE "' . cerber\_real\_escape( '%' . $search . '%' ) . '"'; |
| [1580](#L1580) | } |
| [1581](#L1581) |  |
| [1582](#L1582) | if ( $q->filter\_country ) { |
| [1583](#L1583) | $country = substr( $q->filter\_country, 0, 3 ); |
| [1584](#L1584) | $ret[9]  = htmlspecialchars( $country ); |
| [1585](#L1585) | $where[] = 'log.country = "' . cerber\_real\_escape( $country ) . '"'; |
| [1586](#L1586) | } |
| [1587](#L1587) |  |
| [1588](#L1588) | $where = ( ! empty( $where ) ) ? 'WHERE ' . implode( ' AND ', $where ) : ''; |
| [1589](#L1589) |  |
| [1590](#L1590) | // Limits, if specified |
| [1591](#L1591) | $per\_page = ( isset( $args['per\_page'] ) ) ? absint( $args['per\_page'] ) : crb\_admin\_get\_per\_page(); |
| [1592](#L1592) | $ret[1]   = $per\_page; |
| [1593](#L1593) |  |
| [1594](#L1594) | $calc = ( empty( $args['no\_navi'] ) ) ? 'SQL\_CALC\_FOUND\_ROWS' : ''; |
| [1595](#L1595) |  |
| [1596](#L1596) | if ( $per\_page ) { |
| [1597](#L1597) | $limit = cerber\_get\_sql\_limit( $per\_page ); |
| [1598](#L1598) | $sql = 'SELECT ' . $calc . ' \* FROM ' . CERBER\_LOG\_TABLE . " log {$where} ORDER BY stamp DESC {$limit}"; |
| [1599](#L1599) | } |
| [1600](#L1600) | else { |
| [1601](#L1601) | $sql = 'SELECT ' . $calc . '  log.\*,u.display\_name,u.user\_login ulogin FROM ' . CERBER\_LOG\_TABLE . ' log LEFT JOIN ' . $wpdb->users . " u ON (log.user\_id = u.ID) {$where} ORDER BY stamp DESC"; // "ORDER BY" is mandatory! |
| [1602](#L1602) | } |
| [1603](#L1603) |  |
| [1604](#L1604) | $ret[0] = $sql; |
| [1605](#L1605) |  |
| [1606](#L1606) | return $ret; |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | function crb\_admin\_ip\_cell( $ip, $ip\_link = '', $text = '' ) { |
| [1610](#L1610) | static $cache = array(); |
| [1611](#L1611) |  |
| [1612](#L1612) | if ( isset( $cache[ $ip ] ) ) { |
| [1613](#L1613) | return $cache[ $ip ]; |
| [1614](#L1614) | } |
| [1615](#L1615) |  |
| [1616](#L1616) | $row = true; |
| [1617](#L1617) | $acl = cerber\_acl\_check( $ip, '', 0, $row ); |
| [1618](#L1618) |  |
| [1619](#L1619) | $tip = ''; |
| [1620](#L1620) |  |
| [1621](#L1621) | if ( ! empty( $row->comments ) ) { |
| [1622](#L1622) | $tip = $row->comments; |
| [1623](#L1623) | } |
| [1624](#L1624) | else { |
| [1625](#L1625) | if ( $acl == 'W' ) { |
| [1626](#L1626) | $tip = \_\_( 'White IP Access List', 'wp-cerber' ); |
| [1627](#L1627) | } |
| [1628](#L1628) | elseif ( $acl == 'B' ) { |
| [1629](#L1629) | $tip = \_\_( 'Black IP Access List', 'wp-cerber' ); |
| [1630](#L1630) | } |
| [1631](#L1631) | } |
| [1632](#L1632) |  |
| [1633](#L1633) | if ( $b = cerber\_block\_check( $ip ) ) { |
| [1634](#L1634) | $block = ' crb\_color\_blocked '; |
| [1635](#L1635) | $tip = ( $tip ) ? ' / ' . $b->reason : $b->reason; |
| [1636](#L1636) | } |
| [1637](#L1637) | else { |
| [1638](#L1638) | $block = ''; |
| [1639](#L1639) | } |
| [1640](#L1640) |  |
| [1641](#L1641) | if ( $ip\_link ) { |
| [1642](#L1642) | $ip = '<a href="' . $ip\_link . '">' . $ip . '</a>'; |
| [1643](#L1643) | } |
| [1644](#L1644) |  |
| [1645](#L1645) | $tip = ( $tip ) ? htmlspecialchars( $tip ) : ''; |
| [1646](#L1646) | $cache[ $ip ] = '<div class="crb\_css\_table"><div><span class="crb\_act\_icon crb\_ip\_acl' . $acl . ' ' . $block . '" title="' . $tip . '"></span></div><div>' . $ip . $text . '</div></div>'; |
| [1647](#L1647) |  |
| [1648](#L1648) | return $cache[ $ip ]; |
| [1649](#L1649) | } |
| [1650](#L1650) |  |
| [1651](#L1651) | /\* |
| [1652](#L1652) | \* Additional information about IP address |
| [1653](#L1653) | \*/ |
| [1654](#L1654) | function cerber\_ip\_extra\_view( $ip, $context = 'activity' ) { |
| [1655](#L1655) | if ( ! $ip || ! filter\_var( $ip, FILTER\_VALIDATE\_IP ) ) { |
| [1656](#L1656) | return ''; |
| [1657](#L1657) | } |
| [1658](#L1658) |  |
| [1659](#L1659) | $html = crb\_generate\_ip\_extra\_view( $ip, $context, true ); |
| [1660](#L1660) | $class = 'crb-extra-info'; |
| [1661](#L1661) | $ajax = ''; |
| [1662](#L1662) |  |
| [1663](#L1663) | if ( ! $html ) { |
| [1664](#L1664) | $ajax = ' data-ajax\_route="ip\_extra\_info" data-ip="' . $ip . '"'; |
| [1665](#L1665) | $class .= ' crb\_async\_content'; |
| [1666](#L1666) | $html = UIS\_LOADER\_HTML; |
| [1667](#L1667) | } |
| [1668](#L1668) |  |
| [1669](#L1669) | return '<div id="crb-extra-ip-info" class="' . $class . '" ' . $ajax . '>' . $html . '</div>'; |
| [1670](#L1670) | } |
| [1671](#L1671) |  |
| [1672](#L1672) | /\*\* |
| [1673](#L1673) | \* @param array $request |
| [1674](#L1674) | \* @param array $ref\_params |
| [1675](#L1675) | \* |
| [1676](#L1676) | \* @return array |
| [1677](#L1677) | \*/ |
| [1678](#L1678) | function cerber\_ip\_extra\_view\_ajax( $request, $ref\_params ) { |
| [1679](#L1679) | $ip = filter\_var( $request['ip'], FILTER\_VALIDATE\_IP ); |
| [1680](#L1680) | $tab = $ref\_params['tab'] ?? ''; |
| [1681](#L1681) |  |
| [1682](#L1682) | $ret = crb\_generate\_ip\_extra\_view( $ip, $tab ); |
| [1683](#L1683) |  |
| [1684](#L1684) | return array( 'html' => $ret, 'error' => '' ); |
| [1685](#L1685) | } |
| [1686](#L1686) |  |
| [1687](#L1687) | function crb\_generate\_ip\_extra\_view( $ip, $context = 'activity', $cache\_only = false ) { |
| [1688](#L1688) |  |
| [1689](#L1689) | if ( ! $ip || ! filter\_var( $ip, FILTER\_VALIDATE\_IP ) ) { |
| [1690](#L1690) | return ''; |
| [1691](#L1691) | } |
| [1692](#L1692) |  |
| [1693](#L1693) | $ip\_navs = ''; |
| [1694](#L1694) |  |
| [1695](#L1695) | if ( $context == 'activity' ) { |
| [1696](#L1696) | $ip\_navs .= cerber\_traffic\_link( array( 'filter\_ip' => $ip ) ); |
| [1697](#L1697) | } |
| [1698](#L1698) | else { |
| [1699](#L1699) | $ip\_navs .= ' <a class="crb-button-tiny" href="' . cerber\_admin\_link( 'activity', array( 'filter\_ip' => $ip ) ) . '">' . \_\_( 'Check for activities', 'wp-cerber' ) . '</a>'; |
| [1700](#L1700) | } |
| [1701](#L1701) |  |
| [1702](#L1702) | $row = true; |
| [1703](#L1703) | $acl = cerber\_acl\_check( $ip, '', 0, $row ); |
| [1704](#L1704) |  |
| [1705](#L1705) | $comments = ( ! empty( $row->comments ) ) ? $row->comments : ''; |
| [1706](#L1706) |  |
| [1707](#L1707) | $ip\_status = ''; |
| [1708](#L1708) |  |
| [1709](#L1709) | if ( $acl == 'W' ) { |
| [1710](#L1710) | $ip\_status .= '<span title="' . $comments . '" class="crb\_color\_green crb\_ip\_info\_label">' . \_\_( 'White IP Access List', 'wp-cerber' ) . '</span>'; |
| [1711](#L1711) | } |
| [1712](#L1712) | elseif ( $acl == 'B' ) { |
| [1713](#L1713) | $ip\_status .= '<span title="' . $comments . '" class="crb\_color\_black crb\_ip\_info\_label">' . \_\_( 'Black IP Access List', 'wp-cerber' ) . '</span>'; |
| [1714](#L1714) | } |
| [1715](#L1715) |  |
| [1716](#L1716) | $key\_cache = '\_cache\_ipx\_' . $ip . $context . (string) $acl; |
| [1717](#L1717) |  |
| [1718](#L1718) | if ( $block = cerber\_block\_check( $ip ) ) { |
| [1719](#L1719) | $ip\_status .= '<span class="crb\_color\_blocked crb\_ip\_info\_label">' . \_\_( 'Locked out', 'wp-cerber' ) . '</span><span class="crb-log-status crb-status-' . $block->reason\_id . '">' . $block->reason . '</span>'; |
| [1720](#L1720) | $key\_cache .= '\_blocked'; |
| [1721](#L1721) | } |
| [1722](#L1722) |  |
| [1723](#L1723) | if ( $cache = cerber\_get\_set( $key\_cache, null, false, true ) ) { |
| [1724](#L1724) | return $cache; |
| [1725](#L1725) | } |
| [1726](#L1726) | elseif ( $cache\_only ) { |
| [1727](#L1727) | return ''; |
| [1728](#L1728) | } |
| [1729](#L1729) |  |
| [1730](#L1730) | $whois        = ''; |
| [1731](#L1731) | $country      = ''; |
| [1732](#L1732) | $abuse        = ''; |
| [1733](#L1733) | $network      = ''; |
| [1734](#L1734) | $network\_info = ''; |
| [1735](#L1735) | $network\_navs = ''; |
| [1736](#L1736) |  |
| [1737](#L1737) | if ( crb\_get\_settings( 'ip\_extra' ) ) { |
| [1738](#L1738) | $ip\_data = cerber\_ip\_whois\_info( $ip ); |
| [1739](#L1739) | if ( isset( $ip\_data['error'] ) ) { |
| [1740](#L1740) | $whois = $ip\_data['error']; |
| [1741](#L1741) | } |
| [1742](#L1742) | elseif ( isset( $ip\_data['whois'] ) ) { |
| [1743](#L1743) | $whois = $ip\_data['whois']; |
| [1744](#L1744) | } |
| [1745](#L1745) | if ( isset( $ip\_data['country'] ) ) { |
| [1746](#L1746) | $country = $ip\_data['country']; |
| [1747](#L1747) | } |
| [1748](#L1748) | if ( ! empty( $ip\_data['data']['abuse-mailbox'] ) ) { |
| [1749](#L1749) | $abuse = '<p>' . \_\_( 'Abuse email:', 'wp-cerber' ) . ' <a href="mailto:' . $ip\_data['data']['abuse-mailbox'] . '">' . $ip\_data['data']['abuse-mailbox'] . '</a></p>'; |
| [1750](#L1750) | } |
| [1751](#L1751) | if ( ! empty( $ip\_data['data']['network'] ) ) { |
| [1752](#L1752) | $network = $ip\_data['data']['network']; |
| [1753](#L1753) | $range   = cerber\_any2range( $network ); |
| [1754](#L1754) | //$network\_info = '<p>' . \_\_( 'Network:', 'wp-cerber' ) . ' ' . $network . ' &nbsp; <a class="crb-button-tiny" href="' . cerber\_admin\_link( 'activity', array( 'filter\_ip' => $range['range'] ) ) . '">' . \_\_( 'Check for activities', 'wp-cerber' ) . '</a> ' . cerber\_traffic\_link( array( 'filter\_ip' => $range['range'] ) ); |
| [1755](#L1755) | $network\_info = \_\_( 'Network:', 'wp-cerber' ) . ' ' . $network; |
| [1756](#L1756) | $network\_navs = '<a class="crb-button-tiny" href="' . cerber\_admin\_link( 'activity', array( 'filter\_ip' => $range['range'] ) ) . '">' . \_\_( 'Check for activities', 'wp-cerber' ) . '</a> ' . cerber\_traffic\_link( array( 'filter\_ip' => $range['range'] ) ); |
| [1757](#L1757) | } |
| [1758](#L1758) | } |
| [1759](#L1759) |  |
| [1760](#L1760) | $form = ''; |
| [1761](#L1761) |  |
| [1762](#L1762) | if ( ! cerber\_is\_myip( $ip ) && ! cerber\_acl\_check( $ip ) ) { |
| [1763](#L1763) |  |
| [1764](#L1764) | if ( $network ) { |
| [1765](#L1765) | $net\_button = '<button type="submit" value="' . $network . '" name="add\_acl" class="button button-secondary cerber-button">'; |
| [1766](#L1766) | } |
| [1767](#L1767) | else { |
| [1768](#L1768) | $net\_button = '<button disabled="disabled" class="button button-secondary cerber-button">'; |
| [1769](#L1769) | } |
| [1770](#L1770) |  |
| [1771](#L1771) | $net\_button .= \_\_( 'Add network to the Black List', 'wp-cerber' ) . '</button> '; |
| [1772](#L1772) |  |
| [1773](#L1773) | $form = '<form id="add\_acl\_black" action="" method="post"> |
| [1774](#L1774) | <input type="hidden" name="cerber\_admin\_do" value="add2acl"> |
| [1775](#L1775) | <input type="hidden" name="add\_acl\_comment" value=""> |
| [1776](#L1776) | <input type="hidden" name="acl\_tag" value="B"> |
| [1777](#L1777) | <button type="submit" value="' . $ip . '" name="add\_acl" class="crb-button-tiny">' . \_\_( 'Add IP to the Black List', 'wp-cerber' ) . '</button>' . |
| [1778](#L1778) | '<!-- <p>' . $net\_button . '</p>-->' . |
| [1779](#L1779) | cerber\_nonce\_field( 'control' ) . |
| [1780](#L1780) | '</form>'; |
| [1781](#L1781) | } |
| [1782](#L1782) |  |
| [1783](#L1783) | $ip\_info = '<span id="crb-ip-address">' . $ip . '</span><span id="crb-ip-country">' . $country . '</span>'; |
| [1784](#L1784) |  |
| [1785](#L1785) | $ip\_insights = crb\_generate\_ip\_insights( $ip, $context ); |
| [1786](#L1786) |  |
| [1787](#L1787) | $ret = ' |
| [1788](#L1788) | <div class="crb\_extra\_info\_row"> |
| [1789](#L1789) |  |
| [1790](#L1790) | <div id="crb\_the\_summary"> |
| [1791](#L1791) | <div><div style="white-space: nowrap;">' . $ip\_info . '</div><div class="crb-nav-row">' . $ip\_status . ' ' . $ip\_navs . ' ' . $form . '</div></div> |
| [1792](#L1792) | <div><div style="white-space: nowrap;">' . $network\_info . '</div><div class="crb-nav-row">' . $network\_navs . '</div></div>' . $abuse . ' |
| [1793](#L1793) | </div> |
| [1794](#L1794) | <div class="crb\_async\_content" data-ajax\_route="ip\_quick\_analytics" data-ip\_address="' . $ip . '" data-the\_active\_tab="' . $context . '">' . $ip\_insights . ' |
| [1795](#L1795) | </div> |
| [1796](#L1796) |  |
| [1797](#L1797) | </div> |
| [1798](#L1798) |  |
| [1799](#L1799) | <div id="crb-whois-data">' . $whois . '</div> |
| [1800](#L1800) | '; |
| [1801](#L1801) |  |
| [1802](#L1802) | cerber\_update\_set( $key\_cache, $ret, 0, false, time() + 7200, true ); |
| [1803](#L1803) |  |
| [1804](#L1804) | return $ret; |
| [1805](#L1805) | } |
| [1806](#L1806) |  |
| [1807](#L1807) | /\*\* |
| [1808](#L1808) | \* @param string $ip |
| [1809](#L1809) | \* @param string $tab |
| [1810](#L1810) | \* @param false $cache\_only |
| [1811](#L1811) | \* |
| [1812](#L1812) | \* @return string|false |
| [1813](#L1813) | \*/ |
| [1814](#L1814) | function crb\_generate\_ip\_insights( $ip, $tab = 'activity', $cache\_only = false ) { |
| [1815](#L1815) |  |
| [1816](#L1816) | if ( $tab != 'activity' ) { |
| [1817](#L1817) | $tab = 'traffic'; |
| [1818](#L1818) | } |
| [1819](#L1819) |  |
| [1820](#L1820) | $result = ''; |
| [1821](#L1821) | $links = array(); |
| [1822](#L1822) |  |
| [1823](#L1823) | $labels = cerber\_get\_labels(); |
| [1824](#L1824) |  |
| [1825](#L1825) | if ( $data = crb\_q\_cache\_get( 'SELECT COUNT(activity) as cnt, activity FROM ' . CERBER\_LOG\_TABLE . ' WHERE ip = "' . $ip . '" GROUP BY activity', CERBER\_LOG\_TABLE, $cache\_only ) ) { |
| [1826](#L1826) | $links[] = array( array( 'filter\_ip' => $ip ), \_\_( 'All' ) ); |
| [1827](#L1827) | foreach ( $data as $item ) { |
| [1828](#L1828) | $links[] = array( array( 'filter\_activity' => $item[1], 'filter\_ip' => $ip ), crb\_array\_get( $labels, $item[1], 'Unknown' ) . ' - ' . $item[0] ); |
| [1829](#L1829) | } |
| [1830](#L1830) | } |
| [1831](#L1831) |  |
| [1832](#L1832) | if ( $links ) { |
| [1833](#L1833) | $result = '<div id="crb-quick-insights">' . crb\_make\_nav\_links( $links, $tab ) . '</div>'; |
| [1834](#L1834) | } |
| [1835](#L1835) |  |
| [1836](#L1836) | if ( ! $result ) { |
| [1837](#L1837) | if ( $cache\_only ) { |
| [1838](#L1838) | return false; |
| [1839](#L1839) | } |
| [1840](#L1840) |  |
| [1841](#L1841) | $result = \_\_( 'No activity has been logged yet.', 'wp-cerber' ); |
| [1842](#L1842) | } |
| [1843](#L1843) |  |
| [1844](#L1844) | return $result; |
| [1845](#L1845) | } |
| [1846](#L1846) |  |
| [1847](#L1847) | /\*\* |
| [1848](#L1848) | \* Additional information about user |
| [1849](#L1849) | \*/ |
| [1850](#L1850) | function cerber\_user\_extra\_view( $user\_id, $context = 'activity' ) { |
| [1851](#L1851) | global $wpdb; |
| [1852](#L1852) |  |
| [1853](#L1853) | if ( ! $u = get\_userdata( $user\_id ) ) { |
| [1854](#L1854) | return ''; |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | $ret = ''; |
| [1858](#L1858) | $class = ''; |
| [1859](#L1859) |  |
| [1860](#L1860) | $user\_info = array(); |
| [1861](#L1861) |  |
| [1862](#L1862) | if ( ! is\_multisite() && $u->roles ) { |
| [1863](#L1863) | $roles = array(); |
| [1864](#L1864) | $wp\_roles = wp\_roles(); |
| [1865](#L1865) | foreach ( $u->roles as $role ) { |
| [1866](#L1866) | $roles[] = $wp\_roles->roles[ $role ]['name']; |
| [1867](#L1867) | } |
| [1868](#L1868) | $roles = '<span class="crb\_act\_role">' . implode( ', ', $roles ) . '</span>'; |
| [1869](#L1869) | } |
| [1870](#L1870) | else { |
| [1871](#L1871) | $roles = ''; |
| [1872](#L1872) | } |
| [1873](#L1873) |  |
| [1874](#L1874) | if ( ! nexus\_is\_valid\_request() ) { |
| [1875](#L1875) | $name = '<a href="' . get\_edit\_user\_link( $user\_id ) . '">' . $u->display\_name . '</a>'; |
| [1876](#L1876) | } |
| [1877](#L1877) | else { |
| [1878](#L1878) | $name = $u->display\_name; |
| [1879](#L1879) | } |
| [1880](#L1880) |  |
| [1881](#L1881) | $prohibited = crb\_is\_username\_prohibited( $u->user\_login ) ? '<p style="color: red;">' . \_\_( 'Username is prohibited', 'wp-cerber' ) . '</p>' : ''; |
| [1882](#L1882) |  |
| [1883](#L1883) | $name = '<span class="crb-user-name"><b>' . $name . '</b></span>'.$prohibited.'<p>' . $roles . '</p>'; |
| [1884](#L1884) |  |
| [1885](#L1885) | if ( $context == 'activity' ) { |
| [1886](#L1886) | $link = cerber\_traffic\_link( array( 'filter\_user' => $user\_id ) , 2 ); |
| [1887](#L1887) | } |
| [1888](#L1888) | else { |
| [1889](#L1889) | $link = ' <a href="' . cerber\_admin\_link( 'activity', array( 'filter\_user' => $user\_id ) ) . '">' . \_\_( 'Check for activities', 'wp-cerber' ) . '</a>'; |
| [1890](#L1890) | } |
| [1891](#L1891) |  |
| [1892](#L1892) | $user\_info[] = array( $name, $link ); |
| [1893](#L1893) |  |
| [1894](#L1894) | if ( $avatar = (string) get\_avatar( $user\_id, 96 ) ) { |
| [1895](#L1895) | $avatar = '<div>' . $avatar . '</div>'; |
| [1896](#L1896) | } |
| [1897](#L1897) |  |
| [1898](#L1898) | // Registered (created) |
| [1899](#L1899) | if ( $time = strtotime( cerber\_db\_get\_var( "SELECT user\_registered FROM  {$wpdb->users} WHERE id = " . $user\_id ) ) ) { |
| [1900](#L1900) | $reg\_date = cerber\_auto\_date( $time, false ); |
| [1901](#L1901) | $reg\_event = \_\_( 'Registered', 'wp-cerber' ); |
| [1902](#L1902) | $country = ''; |
| [1903](#L1903) |  |
| [1904](#L1904) | if ( $reg\_meta = get\_user\_meta( $user\_id, '\_crb\_reg\_', true ) ) { |
| [1905](#L1905) | if ( $reg\_meta['IP'] ?? false ) { |
| [1906](#L1906) | $country = crb\_country\_html( null, $reg\_meta['IP'] ); |
| [1907](#L1907) | } |
| [1908](#L1908) | if ( $reg\_meta['user'] ?? false ) { |
| [1909](#L1909) | $reg\_event = crb\_get\_label( 1, $user\_id, $reg\_meta['user'] ); |
| [1910](#L1910) | } |
| [1911](#L1911) | } |
| [1912](#L1912) |  |
| [1913](#L1913) | $user\_info[] = array( $reg\_event, $reg\_date, $country ); |
| [1914](#L1914) | } |
| [1915](#L1915) |  |
| [1916](#L1916) |  |
| [1917](#L1917) | // Activated - BuddyPress |
| [1918](#L1918) | if ( $log = cerber\_get\_log( array( 200 ), array( 'id' => $user\_id ) ) ) { |
| [1919](#L1919) | $acted = $log[0]; |
| [1920](#L1920) | $activated = cerber\_auto\_date( $acted->stamp ); |
| [1921](#L1921) | $country = crb\_country\_html( null, $acted->ip ); |
| [1922](#L1922) |  |
| [1923](#L1923) | $user\_info[] = array( \_\_( 'Activated', 'wp-cerber' ), $activated, $country ); |
| [1924](#L1924) | } |
| [1925](#L1925) |  |
| [1926](#L1926) |  |
| [1927](#L1927) | // Last seen |
| [1928](#L1928) |  |
| [1929](#L1929) | $seen = array(); |
| [1930](#L1930) | $seen[0] = $wpdb->get\_row( 'SELECT stamp,ip FROM  ' . CERBER\_TRAF\_TABLE . ' WHERE user\_id = ' . $user\_id . ' ORDER BY stamp DESC LIMIT 1' ); |
| [1931](#L1931) | $seen[1] = $wpdb->get\_row( 'SELECT stamp,ip FROM  ' . CERBER\_LOG\_TABLE . ' WHERE user\_id = ' . $user\_id . ' AND ac\_by\_user = 0 ORDER BY stamp DESC LIMIT 1' ); |
| [1932](#L1932) | $seen[2] = $wpdb->get\_row( 'SELECT stamp,ip FROM  ' . CERBER\_LOG\_TABLE . ' WHERE ac\_by\_user = ' . $user\_id . ' ORDER BY stamp DESC LIMIT 1' ); |
| [1933](#L1933) |  |
| [1934](#L1934) | $tmp = array(); |
| [1935](#L1935) | foreach ( $seen as $key => $log\_row ) { |
| [1936](#L1936) | $tmp[ $key ] = ( $log\_row ) ? $log\_row->stamp : 0; |
| [1937](#L1937) | } |
| [1938](#L1938) |  |
| [1939](#L1939) | if ( $max = max( $tmp ) ) { |
| [1940](#L1940) | $max\_keys = array\_keys( $tmp, $max ); |
| [1941](#L1941) | $last\_log = $seen[ $max\_keys[0] ]; |
| [1942](#L1942) |  |
| [1943](#L1943) | $last\_seen = '<span title="' . cerber\_date( $last\_log->stamp, false ) . '">' . cerber\_ago\_time( $last\_log->stamp ) . '</span>'; |
| [1944](#L1944) | $country = crb\_country\_html( null, $last\_log->ip ); |
| [1945](#L1945) | $user\_info[] = array( \_\_( 'Last seen', 'wp-cerber' ), $last\_seen, $country ); |
| [1946](#L1946) | } |
| [1947](#L1947) |  |
| [1948](#L1948) | if ( $usn = crb\_sessions\_get\_num( $user\_id ) ) { |
| [1949](#L1949) | $user\_info[] = array( |
| [1950](#L1950) | '<div style="white-space: nowrap;">' . \_\_( 'Active sessions', 'wp-cerber' ) . '</div>', |
| [1951](#L1951) | '<a href="' . cerber\_admin\_link( 'sessions', array( 'filter\_user' => $user\_id ) ) . '">' . $usn . '</a>' |
| [1952](#L1952) | ); |
| [1953](#L1953) | } |
| [1954](#L1954) |  |
| [1955](#L1955) | $summary = ''; |
| [1956](#L1956) | foreach ( $user\_info as $row ) { |
| [1957](#L1957) | $summary .= '<div><div>' . implode( '</div><div>', $row ) . '</div></div>'; |
| [1958](#L1958) | } |
| [1959](#L1959) |  |
| [1960](#L1960) | $ins\_class = ''; |
| [1961](#L1961) | if ( ! $ins = crb\_generate\_user\_insights( $user\_id, $context, true ) ) { |
| [1962](#L1962) | $ins\_class = 'crb\_async\_content'; |
| [1963](#L1963) | } |
| [1964](#L1964) |  |
| [1965](#L1965) | $ret .= '<div class="crb\_extra\_info\_row">' . $avatar . '<div id="crb\_the\_summary">' . $summary . '</div><div class="' . $ins\_class . '" data-ajax\_route="user\_activity\_analytics" data-user\_id="' . $user\_id . '" data-the\_active\_tab="' . $context . '">' . $ins . '</div></div>'; |
| [1966](#L1966) |  |
| [1967](#L1967) | if ( crb\_is\_user\_blocked( $user\_id ) ) { |
| [1968](#L1968) | $class = 'crb-user-blocked'; |
| [1969](#L1969) | } |
| [1970](#L1970) |  |
| [1971](#L1971) | return '<div class="crb-extra-info ' . $class . '" id="crb-user-extra-info">' . $ret . '</div>'; |
| [1972](#L1972) |  |
| [1973](#L1973) | } |
| [1974](#L1974) |  |
| [1975](#L1975) | // Users ------------------------------------------------------------------------------------- |
| [1976](#L1976) |  |
| [1977](#L1977) | add\_filter('users\_list\_table\_query\_args' , function ($args) { |
| [1978](#L1978) | if ( crb\_get\_settings( 'usersort' ) && empty( $args['orderby'] ) ) { |
| [1979](#L1979) | $args['orderby'] = 'user\_registered'; |
| [1980](#L1980) | $args['order'] = 'desc'; |
| [1981](#L1981) | } |
| [1982](#L1982) | return $args; |
| [1983](#L1983) | }); |
| [1984](#L1984) |  |
| [1985](#L1985) | /\* |
| [1986](#L1986) | Add custom columns to the Users admin screen |
| [1987](#L1987) | \*/ |
| [1988](#L1988) | add\_filter( 'manage\_users\_columns', function ( $columns ) { |
| [1989](#L1989) | return array\_merge( $columns, |
| [1990](#L1990) | array( |
| [1991](#L1991) | 'cbcc' => \_\_( 'Comments', 'wp-cerber' ), |
| [1992](#L1992) | 'cbla' => \_\_( 'Last login', 'wp-cerber' ), |
| [1993](#L1993) | 'cbfl' => '<span title="In last 24 hours">' . \_\_( 'Failed login attempts', 'wp-cerber' ) . '</span>', |
| [1994](#L1994) | 'cbdr' => \_\_( 'Registered', 'wp-cerber' ) |
| [1995](#L1995) | ) ); |
| [1996](#L1996) | } ); |
| [1997](#L1997) | add\_filter( 'manage\_users\_sortable\_columns', function ( $sortable\_columns ) { |
| [1998](#L1998) | $sortable\_columns['cbdr'] = 'user\_registered'; |
| [1999](#L1999) |  |
| [2000](#L2000) | return $sortable\_columns; |
| [2001](#L2001) | } ); |
| [2002](#L2002) | /\* |
| [2003](#L2003) | Display custom columns on the Users screen |
| [2004](#L2004) | \*/ |
| [2005](#L2005) | add\_filter( 'manage\_users\_custom\_column', function ( $value, $column, $user\_id ) { |
| [2006](#L2006) | global $wpdb, $user\_ID; |
| [2007](#L2007) |  |
| [2008](#L2008) | $ret = $value; |
| [2009](#L2009) |  |
| [2010](#L2010) | switch ( $column ) { |
| [2011](#L2011) | case 'cbcc' : // to get this work we need add filter 'preprocess\_comment' |
| [2012](#L2012) | if ( $com = get\_comments( array( 'author\_\_in' => $user\_id ) ) ) { |
| [2013](#L2013) | $ret = count( $com ); |
| [2014](#L2014) | } |
| [2015](#L2015) | else { |
| [2016](#L2016) | $ret = 0; |
| [2017](#L2017) | } |
| [2018](#L2018) | break; |
| [2019](#L2019) | case 'cbla' : |
| [2020](#L2020) | case 'cbfl' : |
| [2021](#L2021) | $ret = crb\_get\_ajax\_placeholder( $column, $user\_id ); |
| [2022](#L2022) | break; |
| [2023](#L2023) | case 'cbdr' : |
| [2024](#L2024) | $time = strtotime( cerber\_db\_get\_var( "SELECT user\_registered FROM  $wpdb->users WHERE id = " . $user\_id ) ); |
| [2025](#L2025) | $ret = cerber\_auto\_date( $time ); |
| [2026](#L2026) | if ( $rm = get\_user\_meta( $user\_id, '\_crb\_reg\_', true ) ) { |
| [2027](#L2027) | if ( $rm['IP'] ) { |
| [2028](#L2028) | $act\_link = cerber\_admin\_link( 'activity', array( 'filter\_ip' => $rm['IP'] ) ); |
| [2029](#L2029) | $ret .= '<br /><a href="' . $act\_link . '">' . $rm['IP'] . '</a>'; |
| [2030](#L2030) | if ( $country = crb\_country\_html( null, $rm['IP'] ) ) { |
| [2031](#L2031) | $ret .= '<br />' . $country; |
| [2032](#L2032) | } |
| [2033](#L2033) | } |
| [2034](#L2034) | $uid = absint( $rm['user'] ); |
| [2035](#L2035) | if ( $uid ) { |
| [2036](#L2036) | $name = cerber\_db\_get\_var( 'SELECT meta\_value FROM ' . $wpdb->usermeta . ' WHERE user\_id  = ' . $uid . ' AND meta\_key = "nickname"' ); |
| [2037](#L2037) | if ( ! $user\_ID ) { |
| [2038](#L2038) | $user\_ID = get\_current\_user\_id(); |
| [2039](#L2039) | } |
| [2040](#L2040) | if ( $user\_ID == $uid ) { |
| [2041](#L2041) | $name .= ' (' . \_\_( 'You', 'wp-cerber' ) . ')'; |
| [2042](#L2042) | } |
| [2043](#L2043) | $ret .= '<br />' . $name; |
| [2044](#L2044) | } |
| [2045](#L2045) | } |
| [2046](#L2046) | break; |
| [2047](#L2047) | } |
| [2048](#L2048) |  |
| [2049](#L2049) | return $ret; |
| [2050](#L2050) | }, 10, 3 ); |
| [2051](#L2051) |  |
| [2052](#L2052) | /\* |
| [2053](#L2053) | Registering admin widgets |
| [2054](#L2054) | \*/ |
| [2055](#L2055) | if ( ! is\_multisite() ) { |
| [2056](#L2056) | add\_action( 'wp\_dashboard\_setup', 'cerber\_widgets' ); |
| [2057](#L2057) | } |
| [2058](#L2058) | else { |
| [2059](#L2059) | add\_action( 'wp\_network\_dashboard\_setup', 'cerber\_widgets' ); |
| [2060](#L2060) | } |
| [2061](#L2061) | function cerber\_widgets() { |
| [2062](#L2062) | if ( cerber\_user\_can\_manage() ) { |
| [2063](#L2063) | wp\_add\_dashboard\_widget( 'cerber\_quick', \_\_( 'Cerber Quick View', 'wp-cerber' ), 'cerber\_quick\_w' ); |
| [2064](#L2064) | } |
| [2065](#L2065) | } |
| [2066](#L2066) | /\* |
| [2067](#L2067) | Cerber Quick View widget |
| [2068](#L2068) | \*/ |
| [2069](#L2069) | function cerber\_quick\_w(){ |
| [2070](#L2070) |  |
| [2071](#L2071) | $dash    = cerber\_admin\_link(); |
| [2072](#L2072) | $act     = cerber\_admin\_link( 'activity' ); |
| [2073](#L2073) | $traf    = cerber\_admin\_link( 'traffic' ); |
| [2074](#L2074) | $scanner = cerber\_admin\_link( 'scan\_main' ); |
| [2075](#L2075) | $acl     = cerber\_admin\_link( 'acl' ); |
| [2076](#L2076) | $sess    = cerber\_admin\_link( 'sessions' ); |
| [2077](#L2077) | $locks   = cerber\_admin\_link( 'lockouts' ); |
| [2078](#L2078) |  |
| [2079](#L2079) | $s\_count = cerber\_db\_get\_var('SELECT COUNT(DISTINCT user\_id) FROM '. cerber\_get\_db\_prefix() . CERBER\_USS\_TABLE ); |
| [2080](#L2080) |  |
| [2081](#L2081) | $failed = cerber\_db\_get\_var( 'SELECT count(ip) FROM ' . CERBER\_LOG\_TABLE . ' WHERE activity IN (' . CRB\_EV\_LFL . ') AND stamp > ' . ( time() - 24 \* 3600 ) ); |
| [2082](#L2082) | $failed\_prev = cerber\_db\_get\_var( 'SELECT count(ip) FROM ' . CERBER\_LOG\_TABLE . ' WHERE activity IN (' . CRB\_EV\_LFL . ') AND stamp > ' . ( time() - 48 \* 3600 ) . ' AND stamp < ' . ( time() - 24 \* 3600 ) ); |
| [2083](#L2083) |  |
| [2084](#L2084) | $failed\_ch = cerber\_percent($failed\_prev,$failed); |
| [2085](#L2085) |  |
| [2086](#L2086) | $locked = cerber\_db\_get\_var('SELECT count(ip) FROM '. CERBER\_LOG\_TABLE .' WHERE activity IN (10,11) AND stamp > '.(time() - 24 \* 3600)); |
| [2087](#L2087) | $locked\_prev = cerber\_db\_get\_var('SELECT count(ip) FROM '. CERBER\_LOG\_TABLE .' WHERE activity IN (10,11) AND stamp > '.(time() - 48 \* 3600).' AND stamp < '.(time() - 24 \* 3600)); |
| [2088](#L2088) |  |
| [2089](#L2089) | $locked\_ch = cerber\_percent($locked\_prev,$locked); |
| [2090](#L2090) |  |
| [2091](#L2091) | //$lockouts = $wpdb->get\_var('SELECT count(ip) FROM '. CERBER\_BLOCKS\_TABLE); |
| [2092](#L2092) |  |
| [2093](#L2093) | $lockouts = cerber\_blocked\_num(); |
| [2094](#L2094) | if ($last = cerber\_db\_get\_var('SELECT MAX(stamp) FROM '.CERBER\_LOG\_TABLE.' WHERE  activity IN (10,11)')) { |
| [2095](#L2095) | $last = cerber\_ago\_time( $last ); |
| [2096](#L2096) | } |
| [2097](#L2097) | else $last = \_\_('Never','wp-cerber'); |
| [2098](#L2098) | $w\_count = cerber\_db\_get\_var('SELECT count(ip) FROM '. CERBER\_ACL\_TABLE .' WHERE tag ="W"' ); |
| [2099](#L2099) | $b\_count = cerber\_db\_get\_var('SELECT count(ip) FROM '. CERBER\_ACL\_TABLE .' WHERE tag ="B"' ); |
| [2100](#L2100) |  |
| [2101](#L2101) | if ( cerber\_is\_citadel() ) { |
| [2102](#L2102) | $citadel = '<span style="color:#FF0000;">' . \_\_( 'active', 'wp-cerber' ) . '</span> (<a href="' . wp\_nonce\_url( add\_query\_arg( array( 'citadel' => 'deactivate' ) ), 'control', 'cerber\_nonce' ) . '">' . \_\_( 'deactivate', 'wp-cerber' ) . '</a>)'; |
| [2103](#L2103) | } |
| [2104](#L2104) | else { |
| [2105](#L2105) | if ( crb\_get\_settings( 'citadel\_on' ) && crb\_get\_settings( 'ciperiod' ) ) { |
| [2106](#L2106) | $citadel = \_\_( 'not active', 'wp-cerber' ); |
| [2107](#L2107) | } |
| [2108](#L2108) | else { |
| [2109](#L2109) | $citadel = \_\_( 'disabled', 'wp-cerber' ); |
| [2110](#L2110) | } |
| [2111](#L2111) | } |
| [2112](#L2112) |  |
| [2113](#L2113) | echo '<div class="cerber-widget">'; |
| [2114](#L2114) |  |
| [2115](#L2115) | echo '<table style="width:100%;"><tr><td style="width:50%; vertical-align:top;"><table><tr><td class="bigdig">' . $failed . '</td><td class="per">' . $failed\_ch . '</td></tr></table><p>' . \_\_( 'failed attempts', 'wp-cerber' ) . ' ' . \_\_( 'in 24 hours', 'wp-cerber' ) . '<br/>(<a href="' . $act . '&filter\_activity=' . CRB\_EV\_LFL . '">' . \_\_( 'view all', 'wp-cerber' ) . '</a>)</p></td>'; |
| [2116](#L2116) | echo '<td style="width:50%; vertical-align:top;"><table><tr><td class="bigdig">'.$locked.'</td><td class="per">'.$locked\_ch.'</td></tr></table><p>'.\_\_('lockouts','wp-cerber').' '.\_\_('in 24 hours','wp-cerber').'<br/>(<a href="'.$act.'&filter\_activity[]=10&filter\_activity[]=11">'.\_\_('view all','wp-cerber').'</a>)</p></td></tr></table>'; |
| [2117](#L2117) |  |
| [2118](#L2118) | echo '<table id="quick-info"><tr><td>'.\_\_('Lockouts at the moment','wp-cerber').'</td><td><b><a href="' . $locks . '">'.$lockouts.'</a></b></td></tr>'; |
| [2119](#L2119) | echo '<tr><td>'.\_\_('Last lockout','wp-cerber').'</td><td>'.$last.'</td></tr>'; |
| [2120](#L2120) |  |
| [2121](#L2121) | echo '<tr class="with-padding"><td>' . \_\_( 'Logged-in users', 'wp-cerber' ) . '</td><td><b><a href="' . $sess . '">' . $s\_count . ' ' . \_n( 'user', 'users', $s\_count, 'wp-cerber' ) . '</a></b></td></tr>'; |
| [2122](#L2122) |  |
| [2123](#L2123) | echo '<tr class="with-padding"><td>'.\_\_('White IP Access List','wp-cerber').'</td><td><b><a href="'.$acl.'">'.$w\_count.' '.\_n('entry','entries',$w\_count,'wp-cerber').'</a></b></td></tr>'; |
| [2124](#L2124) | echo '<tr><td>'.\_\_('Black IP Access List','wp-cerber').'</td><td><b><a href="'.$acl.'">'.$b\_count.' '.\_n('entry','entries',$b\_count,'wp-cerber').'</a></b></td></tr>'; |
| [2125](#L2125) | echo '<tr class="with-padding"><td>'.\_\_('Citadel mode','wp-cerber').'</td><td><b>'.$citadel.'</b></td></tr>'; |
| [2126](#L2126) |  |
| [2127](#L2127) | $status = ( ! crb\_get\_settings( 'tienabled' ) ) ? '<span style="color: red;">'.\_\_('disabled','wp-cerber').'</span>' : \_\_('enabled','wp-cerber'); |
| [2128](#L2128) | echo '<tr class="with-padding"><td>'.\_\_('Traffic Inspector','wp-cerber').'</td><td><b>'.$status.'</b></td></tr>'; |
| [2129](#L2129) |  |
| [2130](#L2130) | $lab = lab\_lab(); |
| [2131](#L2131) | if ( $lab ) { |
| [2132](#L2132) | $status = ( ! lab\_is\_cloud\_ok() ) ? '<span style="color: red;">' . \_\_( 'no connection', 'wp-cerber' ) . '</span>' : \_\_( 'active', 'wp-cerber' ); |
| [2133](#L2133) | echo '<tr><td>Cloud Protection</td><td><b>' . $status . '</b></td></tr>'; |
| [2134](#L2134) | } |
| [2135](#L2135) |  |
| [2136](#L2136) | $s    = ''; |
| [2137](#L2137) | $scan = cerber\_get\_scan(); |
| [2138](#L2138) | if ( ! $scan || ( WEEK\_IN\_SECONDS < ( time() - $scan['finished'] ) ) ) { |
| [2139](#L2139) | $s = 'style="color: red;"'; |
| [2140](#L2140) | } |
| [2141](#L2141) |  |
| [2142](#L2142) | if ( $scan ) { |
| [2143](#L2143) | $lms = $scan['mode\_h'] . ' ' . cerber\_auto\_date( $scan['started'] ); |
| [2144](#L2144) | } |
| [2145](#L2145) | else { |
| [2146](#L2146) | $lms = \_\_( 'Never', 'wp-cerber' ); |
| [2147](#L2147) | } |
| [2148](#L2148) |  |
| [2149](#L2149) | echo '<tr ' . $s . '><td>' . \_x( 'Last malware scan', 'Example: Last malware scan: 23 Jan 2018', 'wp-cerber' ) . '</td><td><a href="' . $scanner . '">' . $lms . '</a></td></tr>'; |
| [2150](#L2150) |  |
| [2151](#L2151) | $link = cerber\_admin\_link( 'scan\_schedule' ); |
| [2152](#L2152) | $quick = ( ! $lab || ! $q = absint( crb\_get\_settings( 'scan\_aquick' ) ) ) ? \_\_( 'Disabled', 'wp-cerber' ) : cerber\_get\_qs( $q ); |
| [2153](#L2153) | echo '<tr><td>' . \_\_( 'Quick Scan', 'wp-cerber' ) . '</td><td><a href="' . $link . '">' . $quick . '</a></td></tr>'; |
| [2154](#L2154) | $f = ( ! $lab || ! crb\_get\_settings( 'scan\_afull-enabled' ) ) ? \_\_( 'Disabled', 'wp-cerber' ) : crb\_get\_settings( 'scan\_afull' ); |
| [2155](#L2155) | echo '<tr><td>' . \_\_( 'Full Scan', 'wp-cerber' ) . '</td><td><a href="' . $link . '">' . $f . '</a></td></tr>'; |
| [2156](#L2156) |  |
| [2157](#L2157) |  |
| [2158](#L2158) | /\* |
| [2159](#L2159) | $dev = crb\_get\_settings('pbdevice'); |
| [2160](#L2160) | if (!$dev || $dev == 'N') echo '<tr><td style="padding-top:15px;">'.\_\_('Push notifications','wp-cerber').'</td><td style="padding-top:15px;"><b>not configured</b></td></tr>'; |
| [2161](#L2161) | \*/ |
| [2162](#L2162) | echo '</table></div>'; |
| [2163](#L2163) |  |
| [2164](#L2164) | echo '<div class="wilinks"> |
| [2165](#L2165) | <a href="'.$dash.'"><i class="crb-icon crb-icon-bxs-dashboard"></i> ' . \_\_('Dashboard','wp-cerber').'</a> | |
| [2166](#L2166) | <a href="'.$act.'"><i class="crb-icon crb-icon-bx-pulse"></i> ' . \_\_('Activity','wp-cerber').'</a> | |
| [2167](#L2167) | <a href="'.$traf.'"><i class="crb-icon crb-icon-bx-show"></i> ' . \_\_('Traffic','wp-cerber').'</a> | |
| [2168](#L2168) | <a href="'.$scanner.'"><i class="crb-icon crb-icon-bx-radar"></i> ' . \_\_('Integrity','wp-cerber').'</a> |
| [2169](#L2169) | </div>'; |
| [2170](#L2170) | if ( cerber\_check\_for\_newer() ) { |
| [2171](#L2171) | echo '<div class="up-cerber">' . \_\_( 'A new version is available', 'wp-cerber' ) . '</div>'; |
| [2172](#L2172) | } |
| [2173](#L2173) | } |
| [2174](#L2174) |  |
| [2175](#L2175) | /\* |
| [2176](#L2176) | Show Help tab screen |
| [2177](#L2177) | \*/ |
| [2178](#L2178) | function cerber\_show\_help() { |
| [2179](#L2179) | switch ( crb\_admin\_get\_page()){ |
| [2180](#L2180) | case 'cerber-integrity': |
| [2181](#L2181) | cerber\_show\_scan\_help(); |
| [2182](#L2182) | break; |
| [2183](#L2183) | case 'cerber-nexus': |
| [2184](#L2184) | cerber\_show\_nexus\_help(); |
| [2185](#L2185) | break; |
| [2186](#L2186) | case 'cerber-recaptcha': |
| [2187](#L2187) | cerber\_show\_anti\_help(); |
| [2188](#L2188) | break; |
| [2189](#L2189) | default: |
| [2190](#L2190) | cerber\_show\_general\_help(); |
| [2191](#L2191) | } |
| [2192](#L2192) | } |
| [2193](#L2193) |  |
| [2194](#L2194) | function cerber\_show\_nexus\_help() { |
| [2195](#L2195) |  |
| [2196](#L2196) | ?> |
| [2197](#L2197) | <div id="crb-help"> |
| [2198](#L2198) | <table id="admin-help"> |
| [2199](#L2199) | <tr> |
| [2200](#L2200) | <td> |
| [2201](#L2201) |  |
| [2202](#L2202) | <div> |
| [2203](#L2203) | <h2>How remote management works</h2> |
| [2204](#L2204) |  |
| [2205](#L2205) | <p>The technology enables you to manage the WP Cerber plugin, monitor activity, and upgrade plugins on multiple WordPress powered websites from a main WordPress website which is called a master website.</p> |
| [2206](#L2206) |  |
| [2207](#L2207) | <p>To activate this technology, you need to enable a master mode on the main website and a slave mode on each website you want to connect to the master and manage remotely.</p> |
| [2208](#L2208) |  |
| [2209](#L2209) | <p>Read more: <a href="https://wpcerber.com/manage-multiple-websites/" target="\_blank"> |
| [2210](#L2210) | Manage multiple WP Cerber instances from one dashboard</a></p> |
| [2211](#L2211) |  |
| [2212](#L2212) | </div> |
| [2213](#L2213) |  |
| [2214](#L2214) | <div> |
| [2215](#L2215) | <h2>A safety note</h2> |
| [2216](#L2216) |  |
| [2217](#L2217) | <p>All access tokens are stored in the databases of the master and slave websites in unencrypted form (plaintext). Store a backup copy of all websites in a safe and trusted place.</p> |
| [2218](#L2218) | </div> |
| [2219](#L2219) |  |
| [2220](#L2220) | <div> |
| [2221](#L2221) | <h2>Troubleshooting</h2> |
| [2222](#L2222) | <p> |
| [2223](#L2223) | If you’re unable to get it working, that may be caused by a number of reasons. Enable the diagnostic log on the master and on the slave to obtain more information. You can view the log on the Tools admin page. Here is a list of the most common causes of issues on the slave side. |
| [2224](#L2224) | </p> |
| [2225](#L2225) |  |
| [2226](#L2226) | <ul> |
| [2227](#L2227) | <li>A security plugin on the slave website is interfering with the WP Cerber plugin</li> |
| [2228](#L2228) | <li>A security directive in the .htaccess file on the slave website is blocking incoming requests as suspicious</li> |
| [2229](#L2229) | <li>A firewall or a proxy service (like Cloudflare) is blocking (filtering out) incoming requests to the slave website</li> |
| [2230](#L2230) | <li>The IP address of the master is locked out or in the Black Access List on the slave website</li> |
| [2231](#L2231) | <li>The slave mode on the remote website has been re-enabled making the security token saved on the master invalid</li> |
| [2232](#L2232) | <li>The IP address of the master website does not match the one set in the slave settings on the remote website</li> |
| [2233](#L2233) | </ul> |
| [2234](#L2234) |  |
| [2235](#L2235) | </div> |
| [2236](#L2236) |  |
| [2237](#L2237) | </td> |
| [2238](#L2238) | <td> |
| [2239](#L2239) |  |
| [2240](#L2240) | <div> |
| [2241](#L2241) | <h2>Getting started on the master</h2> |
| [2242](#L2242) |  |
| [2243](#L2243) | <p>To configure the main, master website go to the Cerber.Hub admin page and enable master mode. Once you’ve done this you can add slave websites by using security tokens generated on slaves. |
| [2244](#L2244) | </p> |
| [2245](#L2245) |  |
| [2246](#L2246) | </div> |
| [2247](#L2247) |  |
| [2248](#L2248) | <div> |
| [2249](#L2249) | <h2>Adding slave websites</h2> |
| [2250](#L2250) |  |
| [2251](#L2251) | <p>To add a slave website to the master, you need to enable the slave mode on the website. Go to the Cerber.Hub admin page and enable the slave mode. During the activation of the slave mode, a unique security access token is generated and saved into the database of the slave. Keep the token secret. |
| [2252](#L2252) | </p> |
| [2253](#L2253) | <p> |
| [2254](#L2254) | Go to the master website and click the “Add” button on the “My Websites” admin page. Copy the token and paste it in the “Add a salve website” popup window. |
| [2255](#L2255) | </p> |
| [2256](#L2256) |  |
| [2257](#L2257) |  |
| [2258](#L2258) | </div> |
| [2259](#L2259) |  |
| [2260](#L2260) | <div> |
| [2261](#L2261) | <h2>Manage websites remotely</h2> |
| [2262](#L2262) |  |
| [2263](#L2263) | <p>Once you’ve added all slave websites on the master you can easily switch between them with a single click in a top navigation menu on the admin bar or by clicking the name of a slave on the “My Websites” master page. Once you’ve switched to a slave website use the plugin menu and admin links the way like you do this normally. To switch back to the master website, click a X icon on the admin bar. |
| [2264](#L2264) | </p> |
| [2265](#L2265) | <p> |
| [2266](#L2266) | Note: when you’re managing remote website, the color of the admin bar is blue and the left admin menu on the master is dimmed. |
| [2267](#L2267) | </p> |
| [2268](#L2268) | </div> |
| [2269](#L2269) |  |
| [2270](#L2270) | </td> |
| [2271](#L2271) | </tr> |
| [2272](#L2272) | </table> |
| [2273](#L2273) | </div> |
| [2274](#L2274) | <?php |
| [2275](#L2275) |  |
| [2276](#L2276) | } |
| [2277](#L2277) |  |
| [2278](#L2278) | function cerber\_show\_scan\_help() { |
| [2279](#L2279) |  |
| [2280](#L2280) | ?> |
| [2281](#L2281) | <div id="crb-help"> |
| [2282](#L2282) | <table id="admin-help"> |
| [2283](#L2283) | <tr> |
| [2284](#L2284) | <td> |
| [2285](#L2285) |  |
| [2286](#L2286) | <div> |
| [2287](#L2287) | <h2>Using the malware scanner</h2> |
| [2288](#L2288) |  |
| [2289](#L2289) | <p>To start scanning, click either the Start Quick Scan button or the Start Full Scan button. Do |
| [2290](#L2290) | not close the browser window while the scan is in progress. You may just open a new browser |
| [2291](#L2291) | tab to do something else on the website. Once the scan is finished you can close the window, |
| [2292](#L2292) | the results are stored in the DB until the next scan.</p> |
| [2293](#L2293) |  |
| [2294](#L2294) | <p>Depending on server performance and the number of files, the Quick scan may take about 3-5 |
| [2295](#L2295) | minutes and the Full scan can take about ten minutes or less.</p> |
| [2296](#L2296) |  |
| [2297](#L2297) | <p>During the scan, the plugin verifies plugins, themes, and WordPress by trying to retrieve |
| [2298](#L2298) | checksum data from wordpress.org. If the integrity data is not available, you can upload an |
| [2299](#L2299) | appropriate source ZIP archive for a plugin or a theme. The plugin will use it to detect |
| [2300](#L2300) | changes in files. You need to do it once, after the first scan.</p> |
| [2301](#L2301) |  |
| [2302](#L2302) | <p>Read more: <a href="https://wpcerber.com/malware-scanner-settings/" target="\_blank">Cerber |
| [2303](#L2303) | Security Scanner Settings</a></p> |
| [2304](#L2304) |  |
| [2305](#L2305) | </div> |
| [2306](#L2306) |  |
| [2307](#L2307) | <div> |
| [2308](#L2308) | <h2>Interpreting scan results</h2> |
| [2309](#L2309) |  |
| [2310](#L2310) | <p>The scanner shows you a list of issues and possible actions you can take. If the integrity of |
| [2311](#L2311) | an object has been verified, you see a green mark Verified. If you see the “Integrity data |
| [2312](#L2312) | not found” message, you need to upload a reference ZIP archive by clicking “Resolve issue”. |
| [2313](#L2313) | For all other issues, click on an appropriate issue link. To view the content of a file, |
| [2314](#L2314) | click on its name.</p> |
| [2315](#L2315) | </div> |
| [2316](#L2316) |  |
| [2317](#L2317) | <div> |
| [2318](#L2318) | <h2>Troubleshooting</h2> |
| [2319](#L2319) |  |
| [2320](#L2320) | <p>If the scanner window stops responding or updating, it usually means the process of scanning on the server is hung. This might happen due to a number of reasons but typically this happens due to a misconfigured server or it’s caused by some hosting limitations. Do the following:</p> |
| [2321](#L2321) |  |
| [2322](#L2322) | <ul> |
| [2323](#L2323) | <li>Open the browser console (use F12 key on PC or Cmd + Option + J on Mac) and check it for CERBER ERROR messages</li> |
| [2324](#L2324) | <li>Try to disable scanning the session directory or the temp directory (or both) in the scanner settings</li> |
| [2325](#L2325) | <li>Enable diagnostic logging in the scanner settings and check the log after scanning</li> |
| [2326](#L2326) | </ul> |
| [2327](#L2327) |  |
| [2328](#L2328) | <p>Note: The scanner requires the cURL library to be enabled for PHP scripts. Usually, it's enabled by |
| [2329](#L2329) | default.</p> |
| [2330](#L2330) |  |
| [2331](#L2331) | <p>Read more: <a href="https://wpcerber.com/wordpress-security-scanner/" target="\_blank">Malware |
| [2332](#L2332) | Scanner & Integrity Checker</a></p> |
| [2333](#L2333) |  |
| [2334](#L2334) | </div> |
| [2335](#L2335) |  |
| [2336](#L2336) | <div> |
| [2337](#L2337) | <h2>What's the Quick Scan?</h2> |
| [2338](#L2338) |  |
| [2339](#L2339) | <p>During the Quick Scan, the scanner verifies the integrity and inspects the code of all files |
| [2340](#L2340) | with executable extensions only.</p> |
| [2341](#L2341) |  |
| [2342](#L2342) | <h2>What's the Full Scan?</h2> |
| [2343](#L2343) |  |
| [2344](#L2344) | <p>During the Full Scan, the scanner verifies the integrity and inspects the content of all |
| [2345](#L2345) | files on the website. All media files are scanned for malicious payload.</p> |
| [2346](#L2346) |  |
| [2347](#L2347) | <p>Read more: <a href="https://wpcerber.com/wordpress-security-scanner-scan-malware-detect/" |
| [2348](#L2348) | target="\_blank">What Cerber Security Scanner scans and detects</a> |
| [2349](#L2349) | </div> |
| [2350](#L2350) |  |
| [2351](#L2351) | </td> |
| [2352](#L2352) | <td> |
| [2353](#L2353) |  |
| [2354](#L2354) | <div> |
| [2355](#L2355) | <h2>Configuring scheduled scans</h2> |
| [2356](#L2356) |  |
| [2357](#L2357) | <p>In the Automated recurring scan schedule section you set up your schedule. Select the desired |
| [2358](#L2358) | frequency of the Quick Scan and specify the time of the Full Scan. By default, all automated |
| [2359](#L2359) | recurring scans are turned off. |
| [2360](#L2360) | </p> |
| [2361](#L2361) |  |
| [2362](#L2362) | <p>The Scan results reporting section is about reporting. Here you can easily and flexibly |
| [2363](#L2363) | configure conditions for generating and sending reports. |
| [2364](#L2364) | </p> |
| [2365](#L2365) |  |
| [2366](#L2366) | <p>The email report will only include issues that match conditions in the Report an issue if any |
| [2367](#L2367) | of the following is true filter. So this setting works as a filter for issues you want to |
| [2368](#L2368) | get in a email report. The report will only be sent if there are issues to report and the |
| [2369](#L2369) | following condition is true.</p> |
| [2370](#L2370) |  |
| [2371](#L2371) | <p>The second condition is configured with Send email report. The report will be sent if a |
| [2372](#L2372) | selected condition is true. The last option is the most restrictive.</p> |
| [2373](#L2373) |  |
| [2374](#L2374) | <p>Read more: <a href="https://wpcerber.com/automated-recurring-malware-scans/" target="\_blank">Automated |
| [2375](#L2375) | recurring scans and email reporting</a></p> |
| [2376](#L2376) |  |
| [2377](#L2377) | </div> |
| [2378](#L2378) |  |
| [2379](#L2379) | <div> |
| [2380](#L2380) | <h2>Automatic cleanup of malware</h2> |
| [2381](#L2381) |  |
| [2382](#L2382) | <p>The plugin can automatically delete malicious and suspicious files. Automatic removal |
| [2383](#L2383) | policies are enforced at the end of every scheduled scan based on its results. The list of |
| [2384](#L2384) | files to be deleted depends on the scanner settings. By default automatic removal is |
| [2385](#L2385) | disabled. It's advised to enable it at least for unattended files and files in the media |
| [2386](#L2386) | uploads folder for files with the High severity risk. The plugin deletes only files that |
| [2387](#L2387) | have malicious or suspicious code payload. All detected malicious and suspicious files are |
| [2388](#L2388) | moved to the quarantine. |
| [2389](#L2389) | </p> |
| [2390](#L2390) |  |
| [2391](#L2391) | Read more: <a href="https://wpcerber.com/automatic-malware-removal-wordpress/" target="\_blank">Automatic cleanup of malware and suspicious files</a> |
| [2392](#L2392) |  |
| [2393](#L2393) | </div> |
| [2394](#L2394) |  |
| [2395](#L2395) | <div> |
| [2396](#L2396) | <h2>Deleting files</h2> |
| [2397](#L2397) |  |
| [2398](#L2398) | <p>Usually, you can delete any suspicious or malicious file if it has a checkbox in its row in |
| [2399](#L2399) | the leftmost cell. Before deleting a file, click the issue link in its row to see an |
| [2400](#L2400) | explanation. When you delete a file WP Cerber moves it to a quarantine folder.</p> |
| [2401](#L2401) | </div> |
| [2402](#L2402) |  |
| [2403](#L2403) | <div> |
| [2404](#L2404) | <h2>Restoring deleted files</h2> |
| [2405](#L2405) |  |
| [2406](#L2406) | <p>If you delete an important file by chance, you can restore the file from the quarantine. To |
| [2407](#L2407) | restore one or more files from within the WordPress dashboard, click the Quarantine tab. |
| [2408](#L2408) | Find the filename in the File column and click Restore in the Action column. The file will |
| [2409](#L2409) | be restored to its original location.</p> |
| [2410](#L2410) |  |
| [2411](#L2411) | <p>To restore a file manually, you need to use a file manager in your hosting control panel. All |
| [2412](#L2412) | deleted files are stored in a special quarantine folder. The location of the folder is shown |
| [2413](#L2413) | on the Tools / Diagnostic admin page. The original name and location of a deleted file are |
| [2414](#L2414) | saved in a .restore file. It’s a text file. Open it in a browser or a file viewer, find the |
| [2415](#L2415) | filename you need to restore in a list of deleted files and copy the file back to its |
| [2416](#L2416) | location by using the original name and location of the file. |
| [2417](#L2417) | </p> |
| [2418](#L2418) |  |
| [2419](#L2419) | </div> |
| [2420](#L2420) |  |
| [2421](#L2421) | </td> |
| [2422](#L2422) | </tr> |
| [2423](#L2423) | </table> |
| [2424](#L2424) | </div> |
| [2425](#L2425) | <?php |
| [2426](#L2426) |  |
| [2427](#L2427) | } |
| [2428](#L2428) |  |
| [2429](#L2429) | function cerber\_show\_anti\_help() { |
| [2430](#L2430) |  |
| [2431](#L2431) | ?> |
| [2432](#L2432) | <div id="crb-help"> |
| [2433](#L2433) | <table id="admin-help"> |
| [2434](#L2434) | <tr> |
| [2435](#L2435) | <td> |
| [2436](#L2436) | <?php |
| [2437](#L2437) |  |
| [2438](#L2438) | cerber\_help(); |
| [2439](#L2439) |  |
| [2440](#L2440) | ?> |
| [2441](#L2441) |  |
| [2442](#L2442) | </td> |
| [2443](#L2443) | <td> |
| [2444](#L2444) | <h3>Setting up anti-spam protection</h3> |
| [2445](#L2445) |  |
| [2446](#L2446) | <p> |
| [2447](#L2447) | The Cerber anti-spam and bot detection engine is capable to protect virtually any form on a website. It’s a great alternative to reCAPTCHA. |
| [2448](#L2448) | Tested with Caldera Forms, Gravity Forms, Contact Form 7, Ninja Forms, Formidable Forms, Fast Secure Contact Form, Contact Form by WPForms and WooCommerce forms. |
| [2449](#L2449) | </p> |
| [2450](#L2450) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/how-to-stop-spam-user-registrations-wordpress/">How to stop spam user registrations on your WordPress</a></p> |
| [2451](#L2451) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/antispam-for-wordpress-contact-forms/">How to stop spam form submissions on your WordPress</a></p> |
| [2452](#L2452) |  |
| [2453](#L2453) | <h3>Configuring exceptions for the anti-spam engine</h3> |
| [2454](#L2454) |  |
| [2455](#L2455) | <p> |
| [2456](#L2456) | Usually, you need to specify an exception if you use a plugin or some technology that communicates with your website by submitting forms or sending POST requests programmatically. In this case, Cerber can block these legitimate requests because it recognizes them as generated by bots. This may lead to multiple false positives which you can see on the Activity tab. These entries are marked as <b>Spam form submission denied</b>. |
| [2457](#L2457) | </p> |
| [2458](#L2458) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a href="https://wpcerber.com/antispam-exception-for-specific-http-request/" target="\_blank">Configuring exceptions for the anti-spam engine</a></p> |
| [2459](#L2459) |  |
| [2460](#L2460) | <h3>How to set up reCAPTCHA</h3> |
| [2461](#L2461) |  |
| [2462](#L2462) | <p> |
| [2463](#L2463) |  |
| [2464](#L2464) | Before you can start using reCAPTCHA on the website, you have to obtain a Site key and a Secret key on the Google website. To get the keys you have to have Google account. |
| [2465](#L2465) |  |
| [2466](#L2466) | Register your website and get both keys here: <a href="" target="\_blank" rel="noopener noreferrer">https://www.google.com/recaptcha/admin</a> |
| [2467](#L2467) |  |
| [2468](#L2468) | Note: If you are going to use an invisible version, you must get and use Site key and a Secret key for the invisible version only. |
| [2469](#L2469) |  |
| [2470](#L2470) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/how-to-setup-recaptcha/">How to set up reCAPTCHA in details</a></p> |
| [2471](#L2471) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/why-recaptcha-does-not-protect-wordpress/">Why does reCAPTCHA not protect WordPress against bots and brute-force attacks?</a></p> |
| [2472](#L2472) | </p> |
| [2473](#L2473) |  |
| [2474](#L2474) | </td> |
| [2475](#L2475) | </tr> |
| [2476](#L2476) | </table> |
| [2477](#L2477) | </div> |
| [2478](#L2478) | <?php |
| [2479](#L2479) |  |
| [2480](#L2480) | } |
| [2481](#L2481) |  |
| [2482](#L2482) | function cerber\_show\_general\_help() { |
| [2483](#L2483) |  |
| [2484](#L2484) | ?> |
| [2485](#L2485) | <div id="crb-help"> |
| [2486](#L2486) | <table id="admin-help"> |
| [2487](#L2487) | <tr><td> |
| [2488](#L2488) |  |
| [2489](#L2489) | <?php |
| [2490](#L2490) |  |
| [2491](#L2491) | cerber\_help(); |
| [2492](#L2492) |  |
| [2493](#L2493) | ?> |
| [2494](#L2494) |  |
| [2495](#L2495) |  |
| [2496](#L2496) | <h3>Troubleshooting</h3> |
| [2497](#L2497) |  |
| [2498](#L2498) | <p><a href="https://wpcerber.com/antispam-exception-for-specific-http-request/" target="\_blank">Configuring exceptions for the antispam engine</a></p> |
| [2499](#L2499) |  |
| [2500](#L2500) | <p><a href="https://wpcerber.com/wordpress-probing-for-vulnerable-php-code/" target="\_blank">I’m getting "Probing for vulnerable code"</a></p> |
| [2501](#L2501) |  |
| [2502](#L2502) | <p><a href="https://wpcerber.com/firewall-http-requests-are-being-blocked/" target="\_blank">Some legitimate HTTP requests are being blocked</a></p> |
| [2503](#L2503) |  |
| [2504](#L2504) | <p><a href="https://wpcerber.com/php-warning-cannot-modify-header-information/" target="\_blank">PHP Warning: Cannot modify header information – headers already sent in</a></p> |
| [2505](#L2505) |  |
| [2506](#L2506) | <h3>Traffic Inspector</h3> |
| [2507](#L2507) |  |
| [2508](#L2508) | <p>Traffic Inspector is a set of specialized request inspection algorithms that acts as an additional protection layer (firewall) for your WordPress</p> |
| [2509](#L2509) |  |
| [2510](#L2510) | <p> |
| [2511](#L2511) | <span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" |
| [2512](#L2512) | href="https://wpcerber.com/traffic-inspector-in-a-nutshell/">Traffic |
| [2513](#L2513) | Inspector in a nutshell</a> |
| [2514](#L2514) | </p> |
| [2515](#L2515) |  |
| [2516](#L2516) | <h3>What's new in this version of the plugin?</h3> |
| [2517](#L2517) |  |
| [2518](#L2518) | <p><a href="https://wpcerber.com/security/releases/">Check out release notes</a></p> |
| [2519](#L2519) |  |
| [2520](#L2520) |  |
| [2521](#L2521) | </td> |
| [2522](#L2522) | <td> |
| [2523](#L2523) | <h3>Online Documentation</h3> |
| [2524](#L2524) |  |
| [2525](#L2525) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/toc/">All articles on wpcerber.com</a></p> |
| [2526](#L2526) | <p><span class="dashicons dashicons-before dashicons-shield-alt"></span> <a target="\_blank" href="https://wpcerber.com/how-to-protect-wordpress-checklist/">How to protect WordPress effectively: a must-do list</a></p> |
| [2527](#L2527) |  |
| [2528](#L2528) | <h3>What is IP address of your computer?</h3> |
| [2529](#L2529) |  |
| [2530](#L2530) | <p>To find out your current IP address go to this page: <a target="\_blank" href="https://wpcerber.com/what-is-my-ip/">What is my IP</a>. If you see a different IP address on the Activity tab for your login or logout events, try to enable <b><?php \_e('My site is behind a reverse proxy','wp-cerber'); ?></b>.</p> |
| [2531](#L2531) | <p> |
| [2532](#L2532) | <span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/wordpress-ip-address-detection/">Solving problem with incorrect IP address detection</a> |
| [2533](#L2533) | </p> |
| [2534](#L2534) |  |
| [2535](#L2535) |  |
| [2536](#L2536) | <h3>Setting up antispam protection</h3> |
| [2537](#L2537) |  |
| [2538](#L2538) | <p> |
| [2539](#L2539) | The Cerber antispam and bot detection engine is capable to protect virtually any form on a website. It’s a great alternative to reCAPTCHA. |
| [2540](#L2540) | </p> |
| [2541](#L2541) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/how-to-stop-spam-user-registrations-wordpress/">How to stop spam user registrations on your WordPress</a></p> |
| [2542](#L2542) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/antispam-for-wordpress-contact-forms/">Antispam protection for contact forms</a></p> |
| [2543](#L2543) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a href="https://wpcerber.com/antispam-exception-for-specific-http-request/" target="\_blank">Configuring exceptions for the antispam engine</a></p> |
| [2544](#L2544) |  |
| [2545](#L2545) |  |
| [2546](#L2546) | <h3>Mobile and browser notifications with Pushbullet</h3> |
| [2547](#L2547) |  |
| [2548](#L2548) | <p> |
| [2549](#L2549) | WP Cerber allows you to easily enable desktop and mobile notifications and get notifications instantly and for free. In a desktop browser, you will get popup messages even if you logged out of your WordPress. |
| [2550](#L2550) | Before you start receiving notifications you need to install a free Pushbullet mobile application on your mobile device or free browser extension available for Chrome, Firefox and Opera. |
| [2551](#L2551) | </p> |
| [2552](#L2552) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> |
| [2553](#L2553) | <a target="\_blank" href="https://wpcerber.com/wordpress-mobile-and-browser-notifications-pushbullet/">A three steps instruction how to set up push notifications</a> |
| [2554](#L2554) | </p> |
| [2555](#L2555) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> |
| [2556](#L2556) | <a target="\_blank" href="https://wpcerber.com/wordpress-notifications-made-easy/">How to get alerts for specific activity on your website</a> |
| [2557](#L2557) | </p> |
| [2558](#L2558) |  |
| [2559](#L2559) | <h3>WordPress security explained</h3> |
| [2560](#L2560) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/why-recaptcha-does-not-protect-wordpress/">Why does reCAPTCHA not protect WordPress against bots and brute-force attacks?</a></p> |
| [2561](#L2561) | <p><span class="dashicons dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/why-we-need-to-use-custom-login-url/">Why you need to use Custom login URL for your WordPress</a></p> |
| [2562](#L2562) | <p><span class="dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/why-its-important-to-restrict-access-to-rest-api/">Why it's important to restrict access to the WP REST API</a></p> |
| [2563](#L2563) | <p><span class="dashicons-before dashicons-book-alt"></span> <a target="\_blank" href="https://wpcerber.com/mitigating-brute-force-dos-and-ddos-attacks/">Brute-force, DoS, and DDoS attacks - what's the difference?</a></p> |
| [2564](#L2564) | </td> |
| [2565](#L2565) | </tr> |
| [2566](#L2566) | </table> |
| [2567](#L2567) |  |
| [2568](#L2568) | <h3>What is Drill down IP?</h3> |
| [2569](#L2569) |  |
| [2570](#L2570) | <p> |
| [2571](#L2571) | To get extra information like country, company, network info, abuse contact etc. for a specific IP address, |
| [2572](#L2572) | the plugin makes requests to a limited set of external WHOIS servers which are maintained by appropriate |
| [2573](#L2573) | Registry. All Registry are accredited by ICANN, so there are no reasons for security concerns. Retrieved |
| [2574](#L2574) | information isn't storing in the database, but it is caching for up to 24 hours to avoid excessive requests and |
| [2575](#L2575) | get faster response. |
| [2576](#L2576) | </p> |
| [2577](#L2577) | <p><span class="dashicons-before dashicons-info" style="vertical-align: middle;"></span> <a |
| [2578](#L2578) | href="https://wpcerber.com?p=194">Read more in the Security Blog</a></p> |
| [2579](#L2579) |  |
| [2580](#L2580) | <h3>What is Cerber Lab?</h3> |
| [2581](#L2581) |  |
| [2582](#L2582) | <p> |
| [2583](#L2583) | Cerber Laboratory is a forensic team at Cerber Tech Inc. The team studies and analyzes |
| [2584](#L2584) | patterns of hacker and botnet attacks, malware, vulnerabilities in major plugins and how they are |
| [2585](#L2585) | exploitable on WordPress powered websites. |
| [2586](#L2586) | </p> |
| [2587](#L2587) | <p><span class="dashicons-before dashicons-info" style="vertical-align: middle;"></span> |
| [2588](#L2588) | <a href="https://wpcerber.com/cerber-laboratory/">Know more</a> |
| [2589](#L2589) | </p> |
| [2590](#L2590) |  |
| [2591](#L2591) | <h3>Do you have an idea for a cool new feature that you would love to see in WP Cerber?</h3> |
| [2592](#L2592) |  |
| [2593](#L2593) | <p> |
| [2594](#L2594) | Feel free to submit your ideas here: <a href="https://wpcerber.com/new-feature-request/">New Feature |
| [2595](#L2595) | Request</a>. |
| [2596](#L2596) | </p> |
| [2597](#L2597) |  |
| [2598](#L2598) | <h3>Are you ready to translate this plugin into your language?</h3> |
| [2599](#L2599) |  |
| [2600](#L2600) | <p>I would appreciate that! Please, <a href="https://wpcerber.com/support/">notify me</a></p> |
| [2601](#L2601) |  |
| [2602](#L2602) | <h3 style="margin: 40px 0 40px 0;">Check out other plugins from the trusted author</h3> |
| [2603](#L2603) |  |
| [2604](#L2604) | <div> |
| [2605](#L2605) |  |
| [2606](#L2606) | <a href="https://wordpress.org/plugins/plugin-inspector/"> |
| [2607](#L2607) |  |
| [2608](#L2608) | <img src="<?php echo CRB\_Globals::$assets\_url . 'inspector.png' ?>" |
| [2609](#L2609) | style="float: left; width: 128px; margin-right: 20px;"/> |
| [2610](#L2610) | </a> |
| [2611](#L2611) | <h3>Plugin for inspecting code of plugins on your site: <a |
| [2612](#L2612) | href="https://wordpress.org/plugins/plugin-inspector/">Plugin Inspector</a></h3> |
| [2613](#L2613) | <p style="font-size: 110%">The Plugin Inspector plugin is an easy way to check plugins installed on your |
| [2614](#L2614) | WordPress and make sure |
| [2615](#L2615) | that plugins does not use deprecated WordPress functions and some unsafe functions like eval, |
| [2616](#L2616) | base64\_decode, system, exec etc. Some of those functions may be used to load malicious code (malware) |
| [2617](#L2617) | from the external source directly to the site or WordPress database. |
| [2618](#L2618) | </p> |
| [2619](#L2619) | <p style="font-size: 110%">Plugin Inspector allows you to view all the deprecated functions complete with |
| [2620](#L2620) | path, line number, |
| [2621](#L2621) | deprecation function name, and the new recommended function to use. The checks are run through a simple |
| [2622](#L2622) | admin page and all results are displayed at once. This is very handy for plugin developers or anybody |
| [2623](#L2623) | who want to know more about installed plugins. |
| [2624](#L2624) | </p> |
| [2625](#L2625) | </div> |
| [2626](#L2626) |  |
| [2627](#L2627) | <div style="margin: 40px 0 40px 0;"> |
| [2628](#L2628) | <a href="https://wordpress.org/plugins/goo-translate-widget/"> |
| [2629](#L2629) | <img src="<?php echo CRB\_Globals::$assets\_url . 'goo-translate.png' ?>" |
| [2630](#L2630) | style="float: left; width: 128px; margin-right: 20px;"/> |
| [2631](#L2631) | </a> |
| [2632](#L2632) |  |
| [2633](#L2633) | <h3>Plugin to quick translate site: <a href="https://wordpress.org/plugins/goo-translate-widget/">Google |
| [2634](#L2634) | Translate Widget</a></h3> |
| [2635](#L2635) | <p style="font-size: 110%">Google Translate Widget expands your global reach quickly and easily. Google Translate is a free |
| [2636](#L2636) | multilingual machine translation service provided by Google to translate websites. And now you can allow |
| [2637](#L2637) | visitors around of the world to get your site in their native language. Just put widget on the sidebar |
| [2638](#L2638) | with one click.</p> |
| [2639](#L2639) |  |
| [2640](#L2640) | </div> |
| [2641](#L2641) |  |
| [2642](#L2642) | </div> |
| [2643](#L2643) | <?php |
| [2644](#L2644) | } |
| [2645](#L2645) |  |
| [2646](#L2646) | function cerber\_help() { |
| [2647](#L2647) |  |
| [2648](#L2648) | if ( lab\_lab() ) { |
| [2649](#L2649) | $support = '<p style="margin: 2em 0 5em 0;">Submit a support ticket on our Help Desk: <a href="https://my.wpcerber.com/">https://my.wpcerber.com</a></p>'; |
| [2650](#L2650) | } |
| [2651](#L2651) | else { |
| [2652](#L2652) | $support = '<p>Support for the free version is provided on the <a target="\_blank" href="https://wordpress.org/support/plugin/wp-cerber">WordPress forum only</a>, though, please note, that it is free support hence it is |
| [2653](#L2653) | not always possible to answer all questions on a timely manner, although we do try.</p> |
| [2654](#L2654) |  |
| [2655](#L2655) | <p><a href="https://wpcerber.com/pro/" class="crb-button-tiny">If you need professional and priority support 24/7/365, please buy a PRO license</a></p>'; |
| [2656](#L2656) | } |
| [2657](#L2657) |  |
| [2658](#L2658) | ?> |
| [2659](#L2659) |  |
| [2660](#L2660) | <img style="width: 120px; float: left; margin-right: 30px; margin-bottom: 30px;" src="<?php echo CRB\_Globals::$assets\_url . 'wrench.png' ?>"/> |
| [2661](#L2661) |  |
| [2662](#L2662) | <h3 style="font-size: 150%;">How to configure the plugin</h3> |
| [2663](#L2663) |  |
| [2664](#L2664) | <p style="font-size: 120%;">To get the most out of WP Cerber Security, you need to configure the plugin properly</p> |
| [2665](#L2665) |  |
| [2666](#L2666) | <p style="font-size: 120%;">Please read this first: <a target="\_blank" href="https://wpcerber.com/getting-started/">Getting Started Guide</a></p> |
| [2667](#L2667) |  |
| [2668](#L2668) | <p style="clear: both;"></p> |
| [2669](#L2669) |  |
| [2670](#L2670) | <h3>Do you have a question or need help?</h3> |
| [2671](#L2671) |  |
| [2672](#L2672) | <?php echo $support; ?> |
| [2673](#L2673) |  |
| [2674](#L2674) | <p><span class="dashicons dashicons-before dashicons-format-chat"></span> <a target="\_blank" href="https://wordpress.org/support/plugin/wp-cerber">Get answer on the support forum</a></p> |
| [2675](#L2675) |  |
| [2676](#L2676) | <form style="margin-top: 2em;" action="https://wpcerber.com" target="\_blank"> |
| [2677](#L2677) | <h3>Search plugin documentation on wpcerber.com</h3> |
| [2678](#L2678) | <input type="text" style="width: 80%;" name="s" placeholder="Enter term to search"><input type="submit" value="Search" class="button button-primary"> |
| [2679](#L2679) | </form> |
| [2680](#L2680) |  |
| [2681](#L2681) | <?php |
| [2682](#L2682) | } |
| [2683](#L2683) |  |
| [2684](#L2684) | /\*\* |
| [2685](#L2685) | \* |
| [2686](#L2686) | \* WP Cerber Dashboard |
| [2687](#L2687) | \* |
| [2688](#L2688) | \* |
| [2689](#L2689) | \*/ |
| [2690](#L2690) | function cerber\_show\_dashboard() { |
| [2691](#L2691) |  |
| [2692](#L2692) | $kpi\_list = cerber\_calculate\_kpi( 1 ); |
| [2693](#L2693) |  |
| [2694](#L2694) | $kpi\_show = ''; |
| [2695](#L2695) | foreach ( $kpi\_list as $kpi ) { |
| [2696](#L2696) | $kpi\_show .= '<td>' . $kpi[1] . '</td><td><span style="z-index: 10;">' . $kpi[0] . '</span></td>'; |
| [2697](#L2697) | } |
| [2698](#L2698) |  |
| [2699](#L2699) | $kpi\_show = '<table id = "crb-kpi" class=""><tr>' . $kpi\_show . '</tr></table>'; |
| [2700](#L2700) |  |
| [2701](#L2701) | // TODO: add link "send daily report to my email" |
| [2702](#L2702) | // $kpi\_show .= '<p style="text-align: right; margin: 0;">' . \_\_( 'in the last 24 hours', 'wp-cerber' ) . '</p>'; |
| [2703](#L2703) | echo '<div title="In the last 24 hours">' . $kpi\_show . '</div>'; |
| [2704](#L2704) |  |
| [2705](#L2705) | $placeholder = '<div class="crb-act-padding crb-dash-placeholder">' . \_\_( 'No activity has been logged yet.', 'wp-cerber' ) . '</div>'; |
| [2706](#L2706) |  |
| [2707](#L2707) | $user\_logged = cerber\_db\_get\_var( 'SELECT ip FROM ' . CERBER\_LOG\_TABLE . ' WHERE user\_id !=0 LIMIT 1' ); |
| [2708](#L2708) |  |
| [2709](#L2709) | if ( ! $user\_logged ) { |
| [2710](#L2710) | $nav\_links = ''; |
| [2711](#L2711) | $user\_act = $placeholder; |
| [2712](#L2712) | } |
| [2713](#L2713) | else { |
| [2714](#L2714) | $nav\_links = crb\_admin\_activity\_nav\_links( 'users' ); |
| [2715](#L2715) | $user\_act = cerber\_show\_activity( array( |
| [2716](#L2716) | 'filter\_user' => '\*', |
| [2717](#L2717) | 'per\_page'    => 10, |
| [2718](#L2718) | 'no\_navi'     => true, |
| [2719](#L2719) | 'no\_export'   => true, |
| [2720](#L2720) | 'no\_details'  => true, |
| [2721](#L2721) | 'date'        => 'ago' |
| [2722](#L2722) | ), false ); |
| [2723](#L2723) | } |
| [2724](#L2724) |  |
| [2725](#L2725) | $dash\_widgets[] = array( \_\_( "Users' Activity", 'wp-cerber' ), $user\_act, $nav\_links ); |
| [2726](#L2726) |  |
| [2727](#L2727) | $in = implode( ',', crb\_get\_filter\_set( 1 ) ); |
| [2728](#L2728) | $bad\_logged = cerber\_db\_get\_var( 'SELECT ip FROM ' . CERBER\_LOG\_TABLE . ' WHERE activity IN (' . $in . ') LIMIT 1' ); |
| [2729](#L2729) |  |
| [2730](#L2730) | if ( ! $bad\_logged ) { |
| [2731](#L2731) | $susp\_act = $placeholder; |
| [2732](#L2732) | } |
| [2733](#L2733) | else { |
| [2734](#L2734) | $susp\_act = cerber\_show\_activity( array( |
| [2735](#L2735) | 'filter\_set' => 1, |
| [2736](#L2736) | 'per\_page'    => 10, |
| [2737](#L2737) | 'no\_navi'     => true, |
| [2738](#L2738) | 'no\_export'   => true, |
| [2739](#L2739) | 'no\_details'  => true, |
| [2740](#L2740) | 'date'        => 'ago' |
| [2741](#L2741) | ), false ); |
| [2742](#L2742) | } |
| [2743](#L2743) |  |
| [2744](#L2744) | $nav\_links = ( $bad\_logged ) ? crb\_admin\_activity\_nav\_links( 'suspicious' ) : ''; |
| [2745](#L2745) | $dash\_widgets[] = array( \_\_( 'Malicious Activity', 'wp-cerber' ), $susp\_act, $nav\_links ); |
| [2746](#L2746) |  |
| [2747](#L2747) | /\*$total = cerber\_db\_get\_var( 'SELECT count(ip) FROM ' . CERBER\_LOG\_TABLE ); |
| [2748](#L2748) |  |
| [2749](#L2749) | $nav\_links = ( $total ) ? crb\_admin\_quick\_nav( 'dashboard' ) : ''; |
| [2750](#L2750) |  |
| [2751](#L2751) | echo '<table class="crb-table-heading cerber-margin"><tr><td><h2 style="margin-bottom:0.5em; margin-right: 1em;">' . \_\_( 'Activity', 'wp-cerber' ) . '</h2></td><td>' . $nav\_links . '</td></tr></table>'; |
| [2752](#L2752) |  |
| [2753](#L2753) | /\*cerber\_show\_activity( array( |
| [2754](#L2754) | 'filter\_activity' => crb\_get\_activity\_set( 'dashboard' ), |
| [2755](#L2755) | 'per\_page'        => 10, |
| [2756](#L2756) | 'no\_navi'         => true, |
| [2757](#L2757) | 'no\_export'       => true, |
| [2758](#L2758) | 'no\_details'      => true, |
| [2759](#L2759) | 'date'            => 'ago' |
| [2760](#L2760) | ) );\*/ |
| [2761](#L2761) |  |
| [2762](#L2762) | $locked = cerber\_blocked\_num(); |
| [2763](#L2763) | if ( ! $locked ) { |
| [2764](#L2764) | $view\_all = ''; |
| [2765](#L2765) | $locked\_ips = '<div class="crb-act-padding crb-dash-placeholder">' . \_\_( 'No lockouts at the moment. The sky is clear.', 'wp-cerber' ) . '</div>'; |
| [2766](#L2766) | } |
| [2767](#L2767) | else { |
| [2768](#L2768) | $view\_all = '<a href="' . cerber\_admin\_link( 'lockouts' ) . '">' . \_\_( 'View all', 'wp-cerber' ) . '</a>'; |
| [2769](#L2769) | $locked\_ips = cerber\_show\_lockouts( array( |
| [2770](#L2770) | 'per\_page' => 10, |
| [2771](#L2771) | 'no\_navi'  => true |
| [2772](#L2772) | , |
| [2773](#L2773) | ), false ); |
| [2774](#L2774) | } |
| [2775](#L2775) |  |
| [2776](#L2776) | $dash\_widgets[] = array( \_\_( 'Recently locked out IP addresses', 'wp-cerber' ), $locked\_ips, $view\_all ); |
| [2777](#L2777) |  |
| [2778](#L2778) | foreach ( $dash\_widgets as $dash\_widget ) { |
| [2779](#L2779) | $heading = '<table class="crb-table-heading"><tr><td><h2 class="crb-act-padding">' . $dash\_widget[0] . '</h2></td><td>' . $dash\_widget[2] . '</td></tr></table>'; |
| [2780](#L2780) | echo '<div class="crb-dashboard-element">' . $heading . $dash\_widget[1] . '</div>'; |
| [2781](#L2781) | } |
| [2782](#L2782) | } |
| [2783](#L2783) |  |
| [2784](#L2784) |  |
| [2785](#L2785) | /\* |
| [2786](#L2786) | Admin aside bar |
| [2787](#L2787) | \*/ |
| [2788](#L2788) | function cerber\_show\_aside( $tab ) { |
| [2789](#L2789) |  |
| [2790](#L2790) | if ( in\_array( $tab, array( 'nexus\_sites', 'activity', 'lockouts', 'traffic' ) ) ) { |
| [2791](#L2791) | return; |
| [2792](#L2792) | } |
| [2793](#L2793) |  |
| [2794](#L2794) | $aside = array(); |
| [2795](#L2795) |  |
| [2796](#L2796) | if ( $tab != 'scan\_main' && ! lab\_lab() && crb\_was\_activated( 1 \* DAY\_IN\_SECONDS ) ) { |
| [2797](#L2797) | /\*$aside[] = |
| [2798](#L2798) | '<a class="crb-button-one" style="background-color: #1DA1F2;" href="https://twitter.com/wpcerber" target="\_blank"><span class="dashicons dashicons-twitter"></span> Follow Cerber on Twitter</a>'; |
| [2799](#L2799) | \*/ |
| [2800](#L2800) |  |
| [2801](#L2801) | // <a class="crb-button-one" href="https://wpcerber.com/subscribe-newsletter/" target="\_blank"><span class="dashicons dashicons-email-alt"></span> Subscribe to Cerber\'s newsletter</a> |
| [2802](#L2802) | // <a class="crb-button-one" style="background-color: #3B5998;" href="https://www.facebook.com/wpcerber/" target="\_blank"><span class="dashicons dashicons-facebook"></span> Follow Cerber on Facebook</a> |
| [2803](#L2803) | //'; |
| [2804](#L2804) |  |
| [2805](#L2805) |  |
| [2806](#L2806) | $images = array( 'bn4ra.png', 'bn5ra.png' ); |
| [2807](#L2807) | $d = (int) date( 'z' ); |
| [2808](#L2808) | $n = ( $d & 1 ) ? 1 : 0; |
| [2809](#L2809) | $ban = CRB\_Globals::$assets\_url . $images[ $n ]; |
| [2810](#L2810) |  |
| [2811](#L2811) | $aside[] = '<a href="https://wpcerber.com/pro/" target="\_blank"><img src="'.$ban.'" class="crb-full-width" /></a>'; |
| [2812](#L2812) |  |
| [2813](#L2813) | } |
| [2814](#L2814) |  |
| [2815](#L2815) | $context\_links = ''; |
| [2816](#L2816) | $docs = crb\_get\_doc\_links(); |
| [2817](#L2817) | foreach ( $docs as $doc ) { |
| [2818](#L2818) | $context\_links .= '<p><a href="' . $doc[0] . '" target="\_blank">' . $doc[1] . '</a></p>'; |
| [2819](#L2819) | } |
| [2820](#L2820) |  |
| [2821](#L2821) | $aside[] = '<div class="crb-box" id="crb-blog"><div class="crb-box-inner"> |
| [2822](#L2822) | <h3>Documentation & How To</h3> |
| [2823](#L2823) | ' . $context\_links . '</div></div>'; |
| [2824](#L2824) |  |
| [2825](#L2825) | if ( ! lab\_lab() && crb\_was\_activated( 2 \* WEEK\_IN\_SECONDS ) ) { |
| [2826](#L2826) | $r = array(); |
| [2827](#L2827) | $r[0] = crb\_get\_review\_url( 'tpilot' ); |
| [2828](#L2828) | $r[1] = crb\_get\_review\_url( 'wp' ); |
| [2829](#L2829) | shuffle( $r ); |
| [2830](#L2830) | $aside[] = '<a href="' . $r[0] . '" target="\_blank"><img class="crb-full-width" src="' . CRB\_Globals::$assets\_url . 'fb2b.png" /></a>'; |
| [2831](#L2831) | } |
| [2832](#L2832) |  |
| [2833](#L2833) | echo '<div id="crb-aside">' . implode( ' ', $aside ) . '</div>'; |
| [2834](#L2834) | } |
| [2835](#L2835) |  |
| [2836](#L2836) | function crb\_get\_doc\_links() { |
| [2837](#L2837) | static $links = array( |
| [2838](#L2838) | 'cerber-integrity' => array( |
| [2839](#L2839) | array( 'https://wpcerber.com/wordpress-security-scanner/', 'How to use the integrity checker and malware scanner' ), |
| [2840](#L2840) | array( 'https://wpcerber.com/wordpress-security-scanner-scan-malware-detect/', 'What the scanner scans and detects' ), |
| [2841](#L2841) | array( 'https://wpcerber.com/malware-scanner-settings/', 'Configuring the scanner settings' ), |
| [2842](#L2842) | array( 'https://wpcerber.com/troubleshooting-malware-scanner/', 'Troubleshooting malware scanner issues' ), |
| [2843](#L2843) | array( 'https://wpcerber.com/automatic-malware-removal-wordpress/', 'Automatic cleanup of malware and suspicious files' ), |
| [2844](#L2844) | array( 'https://wpcerber.com/automated-recurring-malware-scans/', 'Automated recurring scans and email reporting' ) |
| [2845](#L2845) | ), |
| [2846](#L2846) | '\*' => array( |
| [2847](#L2847) | array( 'https://wpcerber.com/wordpress-application-passwords-how-to/', 'Managing WordPress application passwords a hassle-free way' ), |
| [2848](#L2848) | array( 'https://wpcerber.com/how-to-protect-wordpress-checklist/', 'How to protect WordPress effectively: a must-do list' ), |
| [2849](#L2849) | array( 'https://wpcerber.com/manage-multiple-websites/', 'Managing multiple WP Cerber instances from one dashboard' ), |
| [2850](#L2850) | array( 'https://wpcerber.com/wordpress/gdpr/', 'Stay in compliance with GDPR' ), |
| [2851](#L2851) | array( 'https://wpcerber.com/two-factor-authentication-for-wordpress/', 'How to protect user accounts with Two-Factor Authentication' ), |
| [2852](#L2852) | array( 'https://wpcerber.com/limiting-concurrent-user-sessions-in-wordpress/', 'How to stop your users from sharing their WordPress accounts' ), |
| [2853](#L2853) | array( 'https://wpcerber.com/wordpress-mobile-and-browser-notifications-pushbullet/', 'Be notified with mobile and browser notifications' ), |
| [2854](#L2854) | array( 'https://wpcerber.com/wordpress-notifications-made-easy/', 'WordPress notifications made easy' ), |
| [2855](#L2855) | array( 'https://wpcerber.com/restrict-access-to-wordpress-rest-api/', 'How to restrict access to REST API' ), |
| [2856](#L2856) | array( 'https://wpcerber.com/automatic-malware-removal-wordpress/', 'Automatic cleanup of malware and suspicious files' ), |
| [2857](#L2857) | array( 'https://wpcerber.com/automated-recurring-malware-scans/', 'Automated recurring scans and email reporting' ), |
| [2858](#L2858) | ), |
| [2859](#L2859) | ); |
| [2860](#L2860) |  |
| [2861](#L2861) | static $get\_started = array( 'https://wpcerber.com/getting-started/', '<b>Getting Started Guide</b>' ); |
| [2862](#L2862) |  |
| [2863](#L2863) | $ret = crb\_array\_get( $links, crb\_admin\_get\_page() ); |
| [2864](#L2864) | $common = crb\_array\_get( $links, '\*' ); |
| [2865](#L2865) |  |
| [2866](#L2866) | if ( ! $ret ) { |
| [2867](#L2867) | array\_unshift( $common, $get\_started ); |
| [2868](#L2868) |  |
| [2869](#L2869) | return $common; |
| [2870](#L2870) | } |
| [2871](#L2871) |  |
| [2872](#L2872) | $ret = array\_merge( $ret, array\_slice( $common, 0, 5 ) ); |
| [2873](#L2873) | $ret[] = $get\_started; |
| [2874](#L2874) |  |
| [2875](#L2875) | return $ret; |
| [2876](#L2876) | } |
| [2877](#L2877) |  |
| [2878](#L2878) | /\* |
| [2879](#L2879) | Displaying notices in the dashboard |
| [2880](#L2880) | \*/ |
| [2881](#L2881) |  |
| [2882](#L2882) | add\_action( 'load-plugins.php', function () { |
| [2883](#L2883) | add\_action( 'admin\_notices', 'cerber\_show\_admin\_notice', 999 ); |
| [2884](#L2884) | add\_action( 'network\_admin\_notices', 'cerber\_show\_admin\_notice', 999 ); |
| [2885](#L2885) | } ); |
| [2886](#L2886) |  |
| [2887](#L2887) | function cerber\_show\_admin\_notice() { |
| [2888](#L2888) | global $cerber\_shown; |
| [2889](#L2889) | $cerber\_shown = false; |
| [2890](#L2890) |  |
| [2891](#L2891) | if ( nexus\_get\_context() ) { |
| [2892](#L2892) | return; |
| [2893](#L2893) | } |
| [2894](#L2894) |  |
| [2895](#L2895) | if ( cerber\_is\_citadel() && cerber\_user\_can\_manage() ) { |
| [2896](#L2896) | echo '<div class="update-nag crb-alarm"><p>' . |
| [2897](#L2897) | \_\_( 'Attention! Citadel mode is now active. Nobody is able to log in.', 'wp-cerber' ) . |
| [2898](#L2898) | ' &nbsp; <a href="' . wp\_nonce\_url( add\_query\_arg( array( 'citadel' => 'deactivate' ) ), 'control', 'cerber\_nonce' ) . '">' . \_\_( 'Deactivate', 'wp-cerber' ) . '</a>' . |
| [2899](#L2899) | ' | <a href="' . cerber\_admin\_link( 'activity' ) . '">' . \_\_( 'View Activity', 'wp-cerber' ) . '</a>' . |
| [2900](#L2900) | '</p></div>'; |
| [2901](#L2901) | } |
| [2902](#L2902) |  |
| [2903](#L2903) | if ( ! nexus\_is\_valid\_request() && ! cerber\_is\_admin\_page( null, true ) ) { |
| [2904](#L2904) | return; |
| [2905](#L2905) | } |
| [2906](#L2906) |  |
| [2907](#L2907) | //if ($notices = get\_site\_option('cerber\_admin\_notice')) |
| [2908](#L2908) | //      echo '<div class="update-nag crb-note"><p>'.$notices.'</p></div>'; // class="updated" - green, class="update-nag" - yellow and above the page title, |
| [2909](#L2909) | //if ($notices = get\_site\_option('cerber\_admin\_message')) |
| [2910](#L2910) | //      echo '<div class="updated" style="overflow: auto;"><p>'.$notices.'</p></div>'; // class="updated" - green, class="update-nag" - yellow and above the page title, |
| [2911](#L2911) |  |
| [2912](#L2912) | $all = array(); |
| [2913](#L2913) | if ( ! empty( $\_GET['settings-updated'] ) ) { |
| [2914](#L2914) | $all[] = array( \_\_( 'Settings saved', 'wp-cerber' ), 'updated' ); |
| [2915](#L2915) | } |
| [2916](#L2916) |  |
| [2917](#L2917) | if ( $notice = cerber\_get\_set( 'admin\_notice' ) ) { |
| [2918](#L2918) | if ( is\_array( $notice ) ) { |
| [2919](#L2919) | $notice = '<p>' . implode( '</p><p>', $notice ) . '</p>'; |
| [2920](#L2920) | } |
| [2921](#L2921) | $all[] = array( $notice, 'error' ); // red |
| [2922](#L2922) | cerber\_update\_set( 'admin\_notice', array() ); |
| [2923](#L2923) | } |
| [2924](#L2924) |  |
| [2925](#L2925) | if ( $message = cerber\_get\_set( 'admin\_message' ) ) { |
| [2926](#L2926) | if ( is\_array( $message ) ) { |
| [2927](#L2927) | $message = '<p>' . implode( '</p><p>', $message ) . '</p>'; |
| [2928](#L2928) | } |
| [2929](#L2929) | $all[] = array( $message, 'updated' ); // green |
| [2930](#L2930) | cerber\_update\_set( 'admin\_message', array() ); |
| [2931](#L2931) | } |
| [2932](#L2932) |  |
| [2933](#L2933) | if ( $all ) { |
| [2934](#L2934) | $cerber\_shown = true; |
| [2935](#L2935) | foreach ( $all as $notice ) { |
| [2936](#L2936) | echo '<div id="setting-error-settings\_updated" class="' . $notice[1] . ' settings-error notice is-dismissible crb-admin-message"> |
| [2937](#L2937) | ' . $notice[0] . '<button type="button" class="notice-dismiss crb-notice-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button></div>'; |
| [2938](#L2938) | } |
| [2939](#L2939) | } |
| [2940](#L2940) |  |
| [2941](#L2941) | if ( $wide = cerber\_get\_set( 'cerber\_admin\_wide', null, false ) ) { |
| [2942](#L2942) | crb\_show\_admin\_announcement( $wide, false ); |
| [2943](#L2943) | $cerber\_shown = true; |
| [2944](#L2944) | cerber\_update\_set( 'cerber\_admin\_wide', '' ); |
| [2945](#L2945) | } |
| [2946](#L2946) |  |
| [2947](#L2947) | if ( $cerber\_shown || ! cerber\_is\_admin\_page() ) { |
| [2948](#L2948) | return; |
| [2949](#L2949) | } |
| [2950](#L2950) |  |
| [2951](#L2951) | if ( $msg = get\_site\_option( 'cerber\_admin\_info' ) ) { |
| [2952](#L2952) | crb\_show\_admin\_announcement( $msg ); |
| [2953](#L2953) | $cerber\_shown = true; |
| [2954](#L2954) |  |
| [2955](#L2955) | return; |
| [2956](#L2956) | } |
| [2957](#L2957) |  |
| [2958](#L2958) | lab\_opt\_in(); |
| [2959](#L2959) | } |
| [2960](#L2960) |  |
| [2961](#L2961) | /\*\* |
| [2962](#L2962) | \* Check if an alert with a given parameters exists |
| [2963](#L2963) | \* |
| [2964](#L2964) | \* @param array $params |
| [2965](#L2965) | \* |
| [2966](#L2966) | \* @return bool |
| [2967](#L2967) | \* |
| [2968](#L2968) | \* @since 8.9.5.6 |
| [2969](#L2969) | \*/ |
| [2970](#L2970) | function crb\_admin\_alert\_exists( $params = null ) { |
| [2971](#L2971) | $alerts = cerber\_get\_site\_option( CRB\_ALERTZ ); |
| [2972](#L2972) |  |
| [2973](#L2973) | if ( ! $alerts ) { |
| [2974](#L2974) | return false; |
| [2975](#L2975) | } |
| [2976](#L2976) |  |
| [2977](#L2977) | if ( ! $params ) { |
| [2978](#L2978) | $params = crb\_get\_alert\_params(); |
| [2979](#L2979) | } |
| [2980](#L2980) |  |
| [2981](#L2981) | $hash = crb\_get\_alert\_id( $params ); |
| [2982](#L2982) |  |
| [2983](#L2983) | if ( isset( $alerts[ $hash ] ) |
| [2984](#L2984) | && ! crb\_is\_alert\_expired( $alerts[ $hash ] ) ) { |
| [2985](#L2985) | return true; |
| [2986](#L2986) | } |
| [2987](#L2987) |  |
| [2988](#L2988) | return false; |
| [2989](#L2989) | } |
| [2990](#L2990) |  |
| [2991](#L2991) | /\*\* |
| [2992](#L2992) | \* Generates a link/button to display a dialog for creating an alert on the currently displaying Activity page |
| [2993](#L2993) | \* |
| [2994](#L2994) | \* @return string HTML code for using in the Dashboard HTML |
| [2995](#L2995) | \* |
| [2996](#L2996) | \* @since 8.9.6 |
| [2997](#L2997) | \*/ |
| [2998](#L2998) | function crb\_admin\_alert\_dialog( $button = true, $create\_txt = null, $delete\_txt = null ) { |
| [2999](#L2999) | $params = crb\_get\_alert\_params(); |
| [3000](#L3000) |  |
| [3001](#L3001) | // Check if query parameters that are used in alerts are set and not empty. |
| [3002](#L3002) | // All activities, without any filter are not allowed |
| [3003](#L3003) | $empty = array\_filter( array\_values( $params ) ); |
| [3004](#L3004) |  |
| [3005](#L3005) | if ( empty( $empty ) ) { |
| [3006](#L3006) | return ''; |
| [3007](#L3007) | } |
| [3008](#L3008) |  |
| [3009](#L3009) | $alerts = cerber\_get\_site\_option( CRB\_ALERTZ ); |
| [3010](#L3010) |  |
| [3011](#L3011) | // Limit to the number of subscriptions |
| [3012](#L3012) |  |
| [3013](#L3013) | if ( $alerts && count( $alerts ) > 50 ) { |
| [3014](#L3014) | return ''; |
| [3015](#L3015) | } |
| [3016](#L3016) |  |
| [3017](#L3017) | $mode = ( crb\_admin\_alert\_exists( $params ) ) ? 'off' : 'on'; |
| [3018](#L3018) |  |
| [3019](#L3019) | if ( $mode == 'on' ) { |
| [3020](#L3020) | $label = $create\_txt ?? \_\_( 'Create Alert', 'wp-cerber' ); |
| [3021](#L3021) | $icon = ( $button ) ? 'crb-icon-bx-bell' : ''; |
| [3022](#L3022) | } |
| [3023](#L3023) | else { |
| [3024](#L3024) | $label = $delete\_txt ?? \_\_( 'Delete Alert', 'wp-cerber' ); |
| [3025](#L3025) | $icon = ( $button ) ? 'crb-icon-bx-bell-off' : ''; |
| [3026](#L3026) | $link = cerber\_admin\_link\_add( array( 'cerber\_admin\_do' => 'subscribe', 'mode' => 'off' ), true ); |
| [3027](#L3027) |  |
| [3028](#L3028) | if ( $button ) { |
| [3029](#L3029) | return '<a class="button button-secondary cerber-button" href="' . $link . '" style="margin-right: 0.5em;"><i class="crb-icon ' . $icon . '"></i> ' . $label . '</a>'; |
| [3030](#L3030) | } |
| [3031](#L3031) |  |
| [3032](#L3032) | return '<a href="' . $link . '">' . $label . '</a>'; |
| [3033](#L3033) | } |
| [3034](#L3034) |  |
| [3035](#L3035) | // Create the alert dialog |
| [3036](#L3036) |  |
| [3037](#L3037) | $em\_list = cerber\_get\_email( 'send\_alert' ); |
| [3038](#L3038) | $mob\_name = cerber\_pb\_get\_active(); |
| [3039](#L3039) |  |
| [3040](#L3040) | if ( $mob\_name && lab\_lab() ) { |
| [3041](#L3041) |  |
| [3042](#L3042) | $channels = array( |
| [3043](#L3043) | 'title'     => \_\_( 'Channels to send alerts', 'wp-cerber' ), |
| [3044](#L3044) | 'visible'   => |
| [3045](#L3045) | array( |
| [3046](#L3046) | 'al\_send\_emails'     => array( |
| [3047](#L3047) | /\* translators: %s is the email address(es). \*/ |
| [3048](#L3048) | 'label' => sprintf( \_\_( 'Send email alerts to %s', 'wp-cerber' ), implode( ', ', $em\_list ) ), |
| [3049](#L3049) | 'value' => '1', |
| [3050](#L3050) | 'atts'  => array( 'type' => 'checkbox', 'data-validation\_group' => 'required\_min\_one', 'checked' => true ), |
| [3051](#L3051) | ), |
| [3052](#L3052) | 'al\_send\_pushbullet' => array( |
| [3053](#L3053) | /\* translators: %s is the name of a mobile device. \*/ |
| [3054](#L3054) | 'label' => sprintf( \_\_( 'Send mobile alerts to %s', 'wp-cerber' ), $mob\_name ), |
| [3055](#L3055) | 'value' => '1', |
| [3056](#L3056) | 'atts'  => array( 'type' => 'checkbox', 'data-validation\_group' => 'required\_min\_one', 'checked' => true ), |
| [3057](#L3057) | ), |
| [3058](#L3058) | ), |
| [3059](#L3059) | 'error\_messages' => array( 'required\_min\_one' => \_\_( 'Please select at least one channel', 'wp-cerber' ) ) |
| [3060](#L3060) | ); |
| [3061](#L3061) |  |
| [3062](#L3062) | } |
| [3063](#L3063) | else { |
| [3064](#L3064) |  |
| [3065](#L3065) | if ( $mob\_name ) { |
| [3066](#L3066) | /\* translators: %s is the name of a mobile device. \*/ |
| [3067](#L3067) | $mobile = sprintf( \_\_( 'Mobile alerts will be sent to %s', 'wp-cerber' ), $mob\_name ); |
| [3068](#L3068) | } |
| [3069](#L3069) | else { |
| [3070](#L3070) | $mobile = \_\_( 'Mobile alerts are not configured', 'wp-cerber' ); |
| [3071](#L3071) | } |
| [3072](#L3072) |  |
| [3073](#L3073) | $recipients = ( 1 < count( $em\_list ) ) ? \_\_( 'Email alerts will be sent to these emails:', 'wp-cerber' ) : \_\_( 'Email alerts will be sent to this email:', 'wp-cerber' ); |
| [3074](#L3074) | $recipients .= ' ' . implode( ', ', $em\_list ); |
| [3075](#L3075) | $recipients = '<p>' . $recipients . '</p><p>' . $mobile . '</p>'; |
| [3076](#L3076) | $recipients .= '<p><a href="https://wpcerber.com/wordpress-notifications-made-easy/" target="\_blank">' . \_\_( 'Documentation', 'wp-cerber' ) . '</a></p>'; |
| [3077](#L3077) |  |
| [3078](#L3078) | $channels = array( |
| [3079](#L3079) | 'html' => $recipients, |
| [3080](#L3080) | ); |
| [3081](#L3081) | } |
| [3082](#L3082) |  |
| [3083](#L3083) | $query\_params = array\_intersect\_key( $params, $\_GET ); |
| [3084](#L3084) |  |
| [3085](#L3085) | $limits = array( |
| [3086](#L3086) | 'title'   => \_\_( 'Optional alert limits', 'wp-cerber' ), |
| [3087](#L3087) | 'hidden'  => array\_merge( $query\_params, array( |
| [3088](#L3088) | 'page'            => crb\_admin\_get\_page(), |
| [3089](#L3089) | 'tab'             => crb\_admin\_get\_tab(), |
| [3090](#L3090) | 'cerber\_nonce'    => crb\_create\_nonce(), |
| [3091](#L3091) | 'cerber\_admin\_do' => 'subscribe', |
| [3092](#L3092) | 'mode'            => $mode |
| [3093](#L3093) | ) ), |
| [3094](#L3094) | 'visible' => array( |
| [3095](#L3095) | 'al\_limit'       => array( |
| [3096](#L3096) | 'label' => \_\_( 'Maximum number of alerts to send', 'wp-cerber' ), |
| [3097](#L3097) | 'value' => '', |
| [3098](#L3098) | 'atts'  => array( |
| [3099](#L3099) | 'type'        => 'text', |
| [3100](#L3100) | 'pattern'     => '\d+', |
| [3101](#L3101) | 'placeholder' => \_\_( 'No limit', 'wp-cerber' ), |
| [3102](#L3102) | ), |
| [3103](#L3103) | ), |
| [3104](#L3104) | 'al\_expires'     => array( |
| [3105](#L3105) | 'label' => \_\_( 'Do not send alerts after this date', 'wp-cerber' ), |
| [3106](#L3106) | 'value' => '', |
| [3107](#L3107) | 'atts'  => array( 'type' => 'date', 'min' => date( 'Y-m-d' ) ), |
| [3108](#L3108) | ), |
| [3109](#L3109) | 'al\_ignore\_rate' => array( |
| [3110](#L3110) | 'label' => \_\_( 'Ignore global rate limits', 'wp-cerber' ), |
| [3111](#L3111) | 'value' => '1', |
| [3112](#L3112) | 'atts'  => array( 'type' => 'checkbox' ), |
| [3113](#L3113) | ), |
| [3114](#L3114) | ), |
| [3115](#L3115) | ); |
| [3116](#L3116) |  |
| [3117](#L3117) | return crb\_create\_popup\_dialog( $limits, $channels, $label, $icon ); |
| [3118](#L3118) | } |
| [3119](#L3119) |  |
| [3120](#L3120) | /\*\* |
| [3121](#L3121) | \* Managing the list of admin alerts |
| [3122](#L3122) | \* |
| [3123](#L3123) | \* @param string $mode Add or delete an alert |
| [3124](#L3124) | \* @param string $hash If specified, an alert with a given hash will be removed |
| [3125](#L3125) | \*/ |
| [3126](#L3126) | function crb\_admin\_alerts\_do( $mode = 'on', $hash = null ) { |
| [3127](#L3127) | if ( $hash ) { |
| [3128](#L3128) | $mode = 'off'; |
| [3129](#L3129) | } |
| [3130](#L3130) | else { |
| [3131](#L3131) | $params = crb\_get\_alert\_params(); |
| [3132](#L3132) | $values = array\_values( $params ); |
| [3133](#L3133) | $hash = crb\_get\_alert\_id( $params ); |
| [3134](#L3134) | } |
| [3135](#L3135) |  |
| [3136](#L3136) | $alerts = get\_site\_option( CRB\_ALERTZ ); |
| [3137](#L3137) |  |
| [3138](#L3138) | if ( ! $alerts || ! is\_array( $alerts ) ) { |
| [3139](#L3139) | $alerts = array(); |
| [3140](#L3140) | } |
| [3141](#L3141) |  |
| [3142](#L3142) | if ( $mode == 'on' ) { |
| [3143](#L3143) | if ( crb\_admin\_alert\_exists() ) { |
| [3144](#L3144) | cerber\_admin\_notice( 'An alert with given parameters exists.' ); |
| [3145](#L3145) |  |
| [3146](#L3146) | return; |
| [3147](#L3147) | } |
| [3148](#L3148) | $alerts[ $hash ] = $values; |
| [3149](#L3149) | $msg = \_\_( 'The alert has been created', 'wp-cerber' ); |
| [3150](#L3150) | } |
| [3151](#L3151) | else { |
| [3152](#L3152) | if ( ! isset( $alerts[ $hash ] ) ) { |
| [3153](#L3153) | cerber\_admin\_notice( 'No alert with the given ID found' ); |
| [3154](#L3154) |  |
| [3155](#L3155) | return; |
| [3156](#L3156) | } |
| [3157](#L3157) | unset( $alerts[ $hash ] ); |
| [3158](#L3158) | $msg = \_\_( 'The alert has been deleted', 'wp-cerber' ); |
| [3159](#L3159) | } |
| [3160](#L3160) |  |
| [3161](#L3161) | if ( update\_site\_option( CRB\_ALERTZ, $alerts ) ) { |
| [3162](#L3162) | cerber\_admin\_message( $msg ); |
| [3163](#L3163) | } |
| [3164](#L3164) | else { |
| [3165](#L3165) | cerber\_admin\_notice( 'Unable to update alerts!' ); |
| [3166](#L3166) | } |
| [3167](#L3167) | } |
| [3168](#L3168) |  |
| [3169](#L3169) | /\*\* |
| [3170](#L3170) | \* Deletes an alert using an alert hash from the $\_GET parameter |
| [3171](#L3171) | \* |
| [3172](#L3172) | \*/ |
| [3173](#L3173) | function cerber\_delete\_alert() { |
| [3174](#L3174) | if ( ( $hash = cerber\_get\_get( 'unsubscribeme', '[a-z\d]+' ) ) |
| [3175](#L3175) | && cerber\_user\_can\_manage() ) { |
| [3176](#L3176) | crb\_admin\_alerts\_do( 'off', $hash ); |
| [3177](#L3177) | wp\_safe\_redirect( remove\_query\_arg( 'unsubscribeme' ) ); |
| [3178](#L3178) | exit; |
| [3179](#L3179) | } |
| [3180](#L3180) | } |
| [3181](#L3181) |  |
| [3182](#L3182) | /\* |
| [3183](#L3183) | Pagination |
| [3184](#L3184) | \*/ |
| [3185](#L3185) | function cerber\_page\_navi( $total, $per\_page ) { |
| [3186](#L3186) | $max\_links = 10; |
| [3187](#L3187) | if ( ! $per\_page ) { |
| [3188](#L3188) | $per\_page = 25; |
| [3189](#L3189) | } |
| [3190](#L3190) | $page = cerber\_get\_pn(); |
| [3191](#L3191) |  |
| [3192](#L3192) | $base\_url = esc\_url( remove\_query\_arg( 'pagen', add\_query\_arg( crb\_get\_query\_params(), cerber\_admin\_link() ) ) ); |
| [3193](#L3193) |  |
| [3194](#L3194) | $last\_page = ceil( $total / $per\_page ); |
| [3195](#L3195) | $ret = ''; |
| [3196](#L3196) | if ( $last\_page > 1 ) { |
| [3197](#L3197) | $start = 1 + $max\_links \* intval( ( $page - 1 ) / $max\_links ); |
| [3198](#L3198) | $end = $start + $max\_links - 1; |
| [3199](#L3199) | if ( $end > $last\_page ) { |
| [3200](#L3200) | $end = $last\_page; |
| [3201](#L3201) | } |
| [3202](#L3202) | if ( $start > $max\_links ) { |
| [3203](#L3203) | $links[] = '<a href="' . $base\_url . '&amp;pagen=' . ( $start - 1 ) . '" class="arrows"><b>&laquo;</b></a>'; |
| [3204](#L3204) | } |
| [3205](#L3205) | for ( $i = $start; $i <= $end; $i ++ ) { |
| [3206](#L3206) | if ( $page != $i ) { |
| [3207](#L3207) | $links[] = '<a href="' . $base\_url . '&amp;pagen=' . $i . '" >' . $i . '</a>'; |
| [3208](#L3208) | } |
| [3209](#L3209) | else { |
| [3210](#L3210) | $links[] = '<a class="active" style="font-size: 16px;">' . $i . '</a> '; |
| [3211](#L3211) | } |
| [3212](#L3212) | } |
| [3213](#L3213) | if ( $end < $last\_page ) { |
| [3214](#L3214) | $links[] = '<a href="' . $base\_url . '&amp;pagen=' . $i . '" class="arrows">&raquo;</a>';  // &#10141; |
| [3215](#L3215) | } |
| [3216](#L3216) | $ret = '<table class="cerber-margin" style="margin-top:1em; border-collapse: collapse;"><tr><td><div class="pagination">' . implode( ' ', $links ) . '</div></td><td><span style="margin-left:2em;"><b>' . $total . ' ' . \_n( 'entry', 'entries', $total, 'wp-cerber' ) . '</b></span></td></tr></table>'; |
| [3217](#L3217) | } |
| [3218](#L3218) |  |
| [3219](#L3219) | return $ret; |
| [3220](#L3220) | } |
| [3221](#L3221) |  |
| [3222](#L3222) | function cerber\_get\_pn() { |
| [3223](#L3223) | $q = crb\_admin\_parse\_query( array( 'pagen' ) ); |
| [3224](#L3224) |  |
| [3225](#L3225) | return ( ! $q->pagen ) ? 1 : absint( $q->pagen ); |
| [3226](#L3226) | } |
| [3227](#L3227) |  |
| [3228](#L3228) | function cerber\_get\_sql\_limit( $per\_page = 25 ) { |
| [3229](#L3229) | return ' LIMIT ' . ( cerber\_get\_pn() - 1 ) \* $per\_page . ',' . $per\_page; |
| [3230](#L3230) | } |
| [3231](#L3231) |  |
| [3232](#L3232) | /\* |
| [3233](#L3233) | Plugins screen links |
| [3234](#L3234) | \*/ |
| [3235](#L3235) | add\_filter('plugin\_action\_links','cerber\_action\_links',10,4); |
| [3236](#L3236) | function cerber\_action\_links($actions, $plugin\_file, $plugin\_data, $context){ |
| [3237](#L3237) | if($plugin\_file == CERBER\_PLUGIN\_ID){ |
| [3238](#L3238) | $link[] = '<a href="' . cerber\_admin\_link() . '">' . \_\_('Dashboard','wp-cerber') . '</a>'; |
| [3239](#L3239) | $link[] = '<a href="' . cerber\_admin\_link('main') . '">' . \_\_('Main settings','wp-cerber') . '</a>'; |
| [3240](#L3240) | $actions = array\_merge ($link,$actions); |
| [3241](#L3241) | } |
| [3242](#L3242) | return $actions; |
| [3243](#L3243) | } |
| [3244](#L3244) |  |
| [3245](#L3245) | /\* |
| [3246](#L3246) | function add\_some\_pointers() { |
| [3247](#L3247) | ?> |
| [3248](#L3248) | <script type="text/javascript"> |
| [3249](#L3249) | jQuery(document).ready( function($) { |
| [3250](#L3250) | var options = {'content':'<h3>Info</h3><p>Cerber will request WHOIS database for extra information when you click on IP.</p>','position':{'edge':'right','align':'center'}}; |
| [3251](#L3251) | if ( ! options ) return; |
| [3252](#L3252) | options = $.extend( options, { |
| [3253](#L3253) | close: function() { |
| [3254](#L3254) | //to do |
| [3255](#L3255) | } |
| [3256](#L3256) | }); |
| [3257](#L3257) |  |
| [3258](#L3258) | //$("#ip\_extra").click(function(){ |
| [3259](#L3259) | //      $(this).pointer( options ).pointer('open'); |
| [3260](#L3260) | //}); |
| [3261](#L3261) |  |
| [3262](#L3262) | $('#subscribe-me').pointer( options ).pointer('open'); |
| [3263](#L3263) |  |
| [3264](#L3264) | }); |
| [3265](#L3265) | </script> |
| [3266](#L3266) | <?php |
| [3267](#L3267) | } |
| [3268](#L3268) | add\_action('admin\_enqueue\_scripts', 'cerber\_admin\_enqueue'); |
| [3269](#L3269) | function cerber\_admin\_enqueue($hook) { |
| [3270](#L3270) | wp\_enqueue\_style( 'wp-pointer' ); |
| [3271](#L3271) | wp\_enqueue\_script( 'wp-pointer' ); |
| [3272](#L3272) | } |
| [3273](#L3273) | \*/ |
| [3274](#L3274) |  |
| [3275](#L3275) |  |
| [3276](#L3276) | add\_action( 'admin\_enqueue\_scripts', 'cerber\_admin\_assets', 9999 ); |
| [3277](#L3277) | function cerber\_admin\_assets() { |
| [3278](#L3278) |  |
| [3279](#L3279) | //$crb\_assets\_url = plugin\_dir\_url( \_\_FILE\_\_ ) . 'assets/'; |
| [3280](#L3280) | //$crb\_assets\_url  = cerber\_plugin\_dir\_url() . 'assets/'; |
| [3281](#L3281) | $crb\_assets\_url = CRB\_Globals::$assets\_url; |
| [3282](#L3282) |  |
| [3283](#L3283) | if ( cerber\_is\_admin\_page() ) { |
| [3284](#L3284) |  |
| [3285](#L3285) | wp\_register\_style( 'crb\_multi\_css', $crb\_assets\_url . 'multi/multi.css', null, CERBER\_VER ); |
| [3286](#L3286) | wp\_enqueue\_style( 'crb\_multi\_css' ); |
| [3287](#L3287) | wp\_enqueue\_script( 'crb\_multi\_js', $crb\_assets\_url . 'multi/multi.min.js', array(), CERBER\_VER ); |
| [3288](#L3288) |  |
| [3289](#L3289) | wp\_register\_style( 'crb\_tpicker\_css', $crb\_assets\_url . 'tpicker/jquery.timepicker.min.css', null, CERBER\_VER ); |
| [3290](#L3290) | wp\_enqueue\_style( 'crb\_tpicker\_css' ); |
| [3291](#L3291) | wp\_enqueue\_script( 'crb\_tpicker', $crb\_assets\_url . 'tpicker/jquery.timepicker.min.js', array(), CERBER\_VER ); |
| [3292](#L3292) |  |
| [3293](#L3293) | // Select2 |
| [3294](#L3294) | wp\_register\_style( 'select2css', $crb\_assets\_url . 'select2/dist/css/select2.min.css', null, null ); |
| [3295](#L3295) | wp\_enqueue\_style( 'select2css' ); |
| [3296](#L3296) | wp\_enqueue\_script( 'select2js', $crb\_assets\_url . 'select2/dist/js/select2.min.js', null, null, true ); |
| [3297](#L3297) |  |
| [3298](#L3298) | wp\_register\_style( 'crb\_magnific\_css', $crb\_assets\_url . 'magnific/magnific-popup.css', null, CERBER\_VER ); |
| [3299](#L3299) | wp\_enqueue\_style( 'crb\_magnific\_css' ); |
| [3300](#L3300) | wp\_enqueue\_script( 'crb\_magnific\_js', $crb\_assets\_url . 'magnific/jquery.magnific-popup.min.js', null, CERBER\_VER ); |
| [3301](#L3301) |  |
| [3302](#L3302) | wp\_register\_style( 'nexus\_css', $crb\_assets\_url . 'nexus.css', null, CERBER\_VER ); |
| [3303](#L3303) | wp\_enqueue\_style( 'nexus\_css' ); |
| [3304](#L3304) |  |
| [3305](#L3305) | wp\_register\_style( 'ui\_stack\_css', $crb\_assets\_url . 'ui-stack.css', null, CERBER\_VER ); |
| [3306](#L3306) | wp\_enqueue\_style( 'ui\_stack\_css' ); |
| [3307](#L3307) |  |
| [3308](#L3308) | add\_thickbox(); |
| [3309](#L3309) |  |
| [3310](#L3310) | wp\_enqueue\_script( 'jquery-ui-core' ); |
| [3311](#L3311) | wp\_enqueue\_script( 'jquery-effects-bounce' ); |
| [3312](#L3312) | } |
| [3313](#L3313) |  |
| [3314](#L3314) | if ( ! defined( 'CERBER\_BETA' ) ) { |
| [3315](#L3315) | wp\_enqueue\_script( 'cerber\_js', $crb\_assets\_url . 'admin.js', array( 'jquery' ), CERBER\_VER, true ); |
| [3316](#L3316) | wp\_enqueue\_script( 'the-ui-stack', $crb\_assets\_url . 'ui-stack.js', array( 'jquery' ), CERBER\_VER, true ); |
| [3317](#L3317) |  |
| [3318](#L3318) | if ( cerber\_is\_admin\_page( array( 'page' => 'cerber-integrity' ) ) ) { |
| [3319](#L3319) | wp\_enqueue\_script( 'cerber\_scan', $crb\_assets\_url . 'scanner.js', array( 'jquery' ), CERBER\_VER, true ); |
| [3320](#L3320) | } |
| [3321](#L3321) | } |
| [3322](#L3322) |  |
| [3323](#L3323) | wp\_register\_style( 'crb\_icons\_css', $crb\_assets\_url . 'icons/style.css', null, CERBER\_VER ); |
| [3324](#L3324) | wp\_enqueue\_style( 'crb\_icons\_css' ); |
| [3325](#L3325) |  |
| [3326](#L3326) | wp\_register\_style( 'cerber\_css', $crb\_assets\_url . 'admin.css', null, CERBER\_VER ); |
| [3327](#L3327) | wp\_enqueue\_style( 'cerber\_css' ); |
| [3328](#L3328) |  |
| [3329](#L3329) | } |
| [3330](#L3330) |  |
| [3331](#L3331) | /\* |
| [3332](#L3332) | \* JS & CSS for admin head |
| [3333](#L3333) | \* |
| [3334](#L3334) | \*/ |
| [3335](#L3335) | add\_action('admin\_head', 'cerber\_admin\_head' ); |
| [3336](#L3336) | add\_action('customize\_controls\_print\_scripts', 'cerber\_admin\_head' ); // @since 5.8.1 |
| [3337](#L3337) | function cerber\_admin\_head() { |
| [3338](#L3338) |  |
| [3339](#L3339) | $crb\_ajax\_nonce  = wp\_create\_nonce( 'crb-ajax-admin' ); |
| [3340](#L3340) |  |
| [3341](#L3341) | $crb\_lab\_available = ( lab\_lab() ) ? 'true' : 'false'; |
| [3342](#L3342) |  |
| [3343](#L3343) | ?> |
| [3344](#L3344) |  |
| [3345](#L3345) | <script type="text/javascript"> |
| [3346](#L3346) | crb\_ajax\_nonce = '<?php echo $crb\_ajax\_nonce; ?>'; |
| [3347](#L3347) | crb\_ajax\_loader = '<?php echo CRB\_Globals::$ajax\_loader; ?>'; |
| [3348](#L3348) | crb\_lab\_available = <?php echo $crb\_lab\_available; ?>; |
| [3349](#L3349) | </script> |
| [3350](#L3350) |  |
| [3351](#L3351) | <?php |
| [3352](#L3352) |  |
| [3353](#L3353) | if ( defined( 'CERBER\_BETA' ) ) : |
| [3354](#L3354) | ?> |
| [3355](#L3355) | <style> |
| [3356](#L3356) | <?php |
| [3357](#L3357) | readfile(cerber\_assets\_dir().'/admin.css'); |
| [3358](#L3358) | ?> |
| [3359](#L3359) | </style> |
| [3360](#L3360) | <?php |
| [3361](#L3361) | endif; |
| [3362](#L3362) |  |
| [3363](#L3363) | if ( ! cerber\_is\_admin\_page() ) { |
| [3364](#L3364) | return; |
| [3365](#L3365) | } |
| [3366](#L3366) |  |
| [3367](#L3367) | ?> |
| [3368](#L3368) |  |
| [3369](#L3369) | <meta http-equiv="x-dns-prefetch-control" content="on" /> |
| [3370](#L3370) | <link rel='dns-prefetch' href='//wpcerber.com' /> |
| [3371](#L3371) |  |
| [3372](#L3372) | <script type="text/javascript"> |
| [3373](#L3373) |  |
| [3374](#L3374) | <?php |
| [3375](#L3375) |  |
| [3376](#L3376) | echo 'crb\_admin\_page = "' . crb\_admin\_get\_page() . '";'; |
| [3377](#L3377) | echo 'crb\_admin\_tab = "' . crb\_admin\_get\_tab() . '";'; |
| [3378](#L3378) | echo 'crb\_user\_locale = "' . substr( get\_user\_locale(), 0, 6 ) . '";'; |
| [3379](#L3379) |  |
| [3380](#L3380) | if ( cerber\_is\_admin\_page( array( 'page' => 'cerber-integrity' ) ) ) { |
| [3381](#L3381) | //echo 'crb\_scan\_msg\_stats = ' . json\_encode( cerber\_get\_stat\_labels() ) . ';'; |
| [3382](#L3382) | echo 'crb\_scan\_msg\_steps = ' . json\_encode( cerber\_get\_step\_description() ) . ';'; |
| [3383](#L3383) | echo 'crb\_scan\_msg\_issues = ' . json\_encode( cerber\_get\_issue\_label() ) . ';'; |
| [3384](#L3384) | echo 'crb\_scan\_msg\_risks = ' . json\_encode( cerber\_get\_risk\_labels() ) . ';'; |
| [3385](#L3385) | echo 'crb\_scan\_msg\_misc = ' . json\_encode( array( |
| [3386](#L3386) | 'delete\_file'     => array( |
| [3387](#L3387) | \_\_( 'Are you sure you want to delete selected files?', 'wp-cerber' ), |
| [3388](#L3388) | \_\_( 'These files have been moved to the quarantine', 'wp-cerber' ) |
| [3389](#L3389) | ), |
| [3390](#L3390) | 'ignore\_add\_file' => array( |
| [3391](#L3391) | \_\_( 'Do you want to add selected files to the ignore list?', 'wp-cerber' ), |
| [3392](#L3392) | \_\_( 'These files have been added to the ignore list', 'wp-cerber' ), |
| [3393](#L3393) | ), |
| [3394](#L3394) | 'file\_error'      => \_\_( 'Some errors occurred', 'wp-cerber' ), |
| [3395](#L3395) | 'all\_ok'          => \_\_( 'All files have been processed', 'wp-cerber' ), |
| [3396](#L3396) | 'rerun\_needed'    => \_\_( 'This scan report was generated by the previous version of WP Cerber. Please run a new scan to get consistent and accurate results.', 'wp-cerber' ), |
| [3397](#L3397) | ) ) . ';'; |
| [3398](#L3398) | } |
| [3399](#L3399) |  |
| [3400](#L3400) | ?> |
| [3401](#L3401) | </script> |
| [3402](#L3402) |  |
| [3403](#L3403) | <style> |
| [3404](#L3404) | /\* Thickbox styles \*/ |
| [3405](#L3405) | #TB\_title { |
| [3406](#L3406) | background-color: #0085ba !important; |
| [3407](#L3407) | color: #fff; |
| [3408](#L3408) | } |
| [3409](#L3409) |  |
| [3410](#L3410) | .tb-close-icon { |
| [3411](#L3411) | color: #fff !important; |
| [3412](#L3412) | } |
| [3413](#L3413) |  |
| [3414](#L3414) | #TB\_window { |
| [3415](#L3415) | font-family: 'Roboto', sans-serif; |
| [3416](#L3416) | } |
| [3417](#L3417) |  |
| [3418](#L3418) | /\* Hide alien's messages on Cerber's admin pages \*/ |
| [3419](#L3419) | .update-nag, |
| [3420](#L3420) | #update-nag, |
| [3421](#L3421) | #setting-error-tgmpa, |
| [3422](#L3422) | .pms-cross-promo, |
| [3423](#L3423) | .vc\_license-activation-notice, |
| [3424](#L3424) | #wordfenceConfigWarning, |
| [3425](#L3425) | #crb-admin div#message.updated { |
| [3426](#L3426) | display: none; |
| [3427](#L3427) | } |
| [3428](#L3428) |  |
| [3429](#L3429) | /\* Cerber's messages are allowed \*/ |
| [3430](#L3430) | div.wrap .update-nag, |
| [3431](#L3431) | .crb-alarm { |
| [3432](#L3432) | display: inline-block; |
| [3433](#L3433) | } |
| [3434](#L3434) | </style> |
| [3435](#L3435) | <?php |
| [3436](#L3436) | } |
| [3437](#L3437) | /\* |
| [3438](#L3438) | \* JS & CSS for admin footer |
| [3439](#L3439) | \* |
| [3440](#L3440) | \*/ |
| [3441](#L3441) | add\_action( 'admin\_footer', 'cerber\_admin\_footer' ); |
| [3442](#L3442) | function cerber\_admin\_footer() { |
| [3443](#L3443) |  |
| [3444](#L3444) | //add\_some\_pointers(); |
| [3445](#L3445) |  |
| [3446](#L3446) | crb\_load\_wp\_js(); |
| [3447](#L3447) |  |
| [3448](#L3448) | // Add buttons to the user profile page |
| [3449](#L3449) |  |
| [3450](#L3450) | $uid = 0; |
| [3451](#L3451) | if ( defined( 'IS\_PROFILE\_PAGE' ) && IS\_PROFILE\_PAGE ) { |
| [3452](#L3452) | $uid = get\_current\_user\_id(); |
| [3453](#L3453) | } |
| [3454](#L3454) | elseif ( ! empty( $\_GET['user\_id'] ) && is\_admin\_user\_edit() ) { |
| [3455](#L3455) | $uid = absint( $\_GET['user\_id'] ); |
| [3456](#L3456) | } |
| [3457](#L3457) |  |
| [3458](#L3458) | if ( $uid ) { |
| [3459](#L3459) | global $profileuser; |
| [3460](#L3460) | if ( crb\_is\_username\_prohibited( $profileuser->user\_login ) ) { |
| [3461](#L3461) | ?> |
| [3462](#L3462) | <script> |
| [3463](#L3463) | document.querySelector('#profile-page #user\_login').insertAdjacentHTML('afterend', '<span style="color:red;"><?php echo \_\_( 'Username is prohibited', 'wp-cerber' ); ?></span>'); |
| [3464](#L3464) | </script> |
| [3465](#L3465) | <?php |
| [3466](#L3466) | } |
| [3467](#L3467) |  |
| [3468](#L3468) | $user\_links = '<a href="' . cerber\_admin\_link( 'activity', array( 'filter\_user' => $uid ) ) . '" class="page-title-action">' . \_\_( 'View Activity', 'wp-cerber' ) . '</a>'; |
| [3469](#L3469) | if ( $uss = crb\_sessions\_get\_num( $uid ) ) { |
| [3470](#L3470) | $user\_links .= '<a href="' . cerber\_admin\_link( 'sessions', array( 'filter\_user' => $uid ) ) . '" class="page-title-action">' . \_\_( 'Sessions', 'wp-cerber' ) . ' ' . $uss . '</a>'; |
| [3471](#L3471) | } |
| [3472](#L3472) | ?> |
| [3473](#L3473) | <script> |
| [3474](#L3474) | document.querySelector('#profile-page .wp-heading-inline').insertAdjacentHTML('afterend','<?php echo $user\_links; ?>'); |
| [3475](#L3475) | </script> |
| [3476](#L3476) | <?php |
| [3477](#L3477) | } |
| [3478](#L3478) |  |
| [3479](#L3479) | // Check for blocked users |
| [3480](#L3480) | $blocked = array(); |
| [3481](#L3481) | if ( $uids = crb\_users\_on\_the\_page() ) { |
| [3482](#L3482) | foreach ( $uids as $uid => $login ) { |
| [3483](#L3483) | if ( crb\_is\_username\_prohibited( $login ) ) { |
| [3484](#L3484) | $blocked[] = $uid; |
| [3485](#L3485) | } |
| [3486](#L3486) | elseif ( crb\_is\_user\_blocked( $uid ) ) { |
| [3487](#L3487) | $blocked[] = $uid; |
| [3488](#L3488) | } |
| [3489](#L3489) | } |
| [3490](#L3490) | } |
| [3491](#L3491) | ?> |
| [3492](#L3492) | <script> |
| [3493](#L3493) | // Highlight blocked users |
| [3494](#L3494) | let crb\_blocked\_users = <?php echo '[' . implode( ',', $blocked ) . ']'; ?>; |
| [3495](#L3495) | if (crb\_blocked\_users.length) { |
| [3496](#L3496) | crb\_blocked\_users.forEach(function (uid) { |
| [3497](#L3497) | let element = document.getElementById('user-' + uid); |
| [3498](#L3498) | element.classList.add("crb-user-blocked"); |
| [3499](#L3499) | }); |
| [3500](#L3500) | } |
| [3501](#L3501) | // Switching textarea |
| [3502](#L3502) | jQuery(document).ready(function ($) { |
| [3503](#L3503) | let mrow = $('#profile-page .crb\_blocked\_txt'); |
| [3504](#L3504) | $("#crb\_user\_blocked").on('change', function () { |
| [3505](#L3505) | if ($(this).is(':checked')) { |
| [3506](#L3506) | mrow.show(); |
| [3507](#L3507) | } |
| [3508](#L3508) | else { |
| [3509](#L3509) | mrow.hide(); |
| [3510](#L3510) | } |
| [3511](#L3511) | }); |
| [3512](#L3512) | }); |
| [3513](#L3513) | </script> |
| [3514](#L3514) | <?php |
| [3515](#L3515) |  |
| [3516](#L3516) | // Background tasks |
| [3517](#L3517) | $list = cerber\_bg\_task\_get\_all(); |
| [3518](#L3518) | if ( $list ) { |
| [3519](#L3519) | $list = array\_slice( $list, 0, 20 ); |
| [3520](#L3520) | $list = array\_keys( $list ); |
| [3521](#L3521) | ?> |
| [3522](#L3522) | <script> |
| [3523](#L3523) | let crb\_bg\_tasks = <?php echo '["' . implode( '","', $list ) . '"]'; ?>; |
| [3524](#L3524) | jQuery(document).ready(function ($) { |
| [3525](#L3525) | //var crb\_bg\_tasks = <?php echo '["' . implode( '","', $list ) . '"]'; ?>; |
| [3526](#L3526) | //console.log('Background tasks: ' + crb\_bg\_tasks.length) |
| [3527](#L3527) | if (crb\_bg\_tasks.length) { |
| [3528](#L3528) | console.log('Background tasks: ' + crb\_bg\_tasks.length); |
| [3529](#L3529) | $.post(ajaxurl, { |
| [3530](#L3530) | ajax\_nonce: crb\_ajax\_nonce, |
| [3531](#L3531) | action: 'cerber\_local\_ajax', |
| [3532](#L3532) | crb\_ajax\_do: 'bg\_tasks\_run', |
| [3533](#L3533) | tasks: $(crb\_bg\_tasks).toArray(), |
| [3534](#L3534) | } |
| [3535](#L3535) | ); |
| [3536](#L3536) | } |
| [3537](#L3537) | }); |
| [3538](#L3538) | </script> |
| [3539](#L3539) | <?php |
| [3540](#L3540) | } |
| [3541](#L3541) |  |
| [3542](#L3542) | // ------------------------------------------------------ |
| [3543](#L3543) |  |
| [3544](#L3544) | if ( ! cerber\_is\_admin\_page() ) { |
| [3545](#L3545) | return; |
| [3546](#L3546) | } |
| [3547](#L3547) |  |
| [3548](#L3548) | if ( defined( 'CERBER\_BETA' ) ) : |
| [3549](#L3549) | ?> |
| [3550](#L3550) | <script type="text/javascript"> |
| [3551](#L3551) | <?php |
| [3552](#L3552) | readfile( cerber\_assets\_dir() . '/admin.js' ); |
| [3553](#L3553) | readfile( cerber\_assets\_dir() . '/ui-stack.js' ); |
| [3554](#L3554) | readfile( cerber\_assets\_dir() . '/scanner.js' ); |
| [3555](#L3555) | ?> |
| [3556](#L3556) | </script> |
| [3557](#L3557) | <?php |
| [3558](#L3558) | endif; |
| [3559](#L3559) |  |
| [3560](#L3560) | // Time pickers |
| [3561](#L3561) | $format = 'H:i'; |
| [3562](#L3562) | if ( cerber\_is\_ampm() ) { |
| [3563](#L3563) | $format = 'h:i A'; |
| [3564](#L3564) | } |
| [3565](#L3565) | ?> |
| [3566](#L3566) | <script type="text/javascript"> |
| [3567](#L3567) | jQuery(document).ready(function ($) { |
| [3568](#L3568) | $('.crb-tpicker').timepicker({ |
| [3569](#L3569) | 'step': 20, |
| [3570](#L3570) | 'forceRoundTime': true, |
| [3571](#L3571) | 'timeFormat': '<?php echo $format; ?>' |
| [3572](#L3572) | }); |
| [3573](#L3573) | }); |
| [3574](#L3574) | </script> |
| [3575](#L3575) | <?php |
| [3576](#L3576) |  |
| [3577](#L3577) | if ( ! lab\_lab() && cerber\_is\_admin\_page( array( 'tab' => array( 'scan\_schedule', 'scan\_policy' ) ) ) ) : |
| [3578](#L3578) | ?> |
| [3579](#L3579) | <script type="text/javascript"> |
| [3580](#L3580) | jQuery(document).ready(function ($) { |
| [3581](#L3581) | $('input').attr('disabled', 'disabled'); |
| [3582](#L3582) | $('select').attr('disabled', 'disabled'); |
| [3583](#L3583) | $('.crb-slider').css('background-color', '#888'); |
| [3584](#L3584) | $('th').add('td').add('h2').css('color', '#888'); |
| [3585](#L3585) |  |
| [3586](#L3586) | $('.crb-main h2').first().before('<?php echo str\_replace( array( |
| [3587](#L3587) | "\n", |
| [3588](#L3588) | "\r" |
| [3589](#L3589) | ), '', crb\_admin\_cool\_features() ); ?>'); |
| [3590](#L3590) | }); |
| [3591](#L3591) | </script> |
| [3592](#L3592) | <?php |
| [3593](#L3593) | endif; |
| [3594](#L3594) |  |
| [3595](#L3595) | } |
| [3596](#L3596) |  |
| [3597](#L3597) | function crb\_load\_wp\_js() { |
| [3598](#L3598) | echo '<script type="text/javascript" src="' . cerber\_plugin\_dir\_url() . 'assets/wp-admin.js' . '"></script>'; |
| [3599](#L3599) | } |
| [3600](#L3600) |  |
| [3601](#L3601) | add\_filter( 'admin\_footer\_text', function ( $text ) { |
| [3602](#L3602) | if ( ! cerber\_is\_admin\_page() ) { |
| [3603](#L3603) | return $text; |
| [3604](#L3604) | } |
| [3605](#L3605) |  |
| [3606](#L3606) | return 'If you like <strong>WP Cerber</strong>, <a target="\_blank" href="' . crb\_get\_review\_url( 'wp' ) . '">please give it a &#9733;&#9733;&#9733;&#9733;&#9733; review</a>. Thanks!'; |
| [3607](#L3607) | }, PHP\_INT\_MAX ); |
| [3608](#L3608) |  |
| [3609](#L3609) | add\_filter( 'update\_footer', function ( $text ) { |
| [3610](#L3610) | if ( ! cerber\_is\_admin\_page() ) { |
| [3611](#L3611) | return $text; |
| [3612](#L3612) | } |
| [3613](#L3613) |  |
| [3614](#L3614) | $pr = ''; |
| [3615](#L3615) | $support = ''; |
| [3616](#L3616) | $mode = ''; |
| [3617](#L3617) | $ver = ''; |
| [3618](#L3618) |  |
| [3619](#L3619) | if ( $remote = nexus\_get\_context() ) { |
| [3620](#L3620) | $ver = $remote->plugin\_v; |
| [3621](#L3621) | if ( $data = nexus\_get\_remote\_data() ) { |
| [3622](#L3622) | $pr = $data['extra']['versions'][6] ?? ''; |
| [3623](#L3623) | } |
| [3624](#L3624) | } |
| [3625](#L3625) | else { |
| [3626](#L3626) |  |
| [3627](#L3627) | $ver = CERBER\_VER; |
| [3628](#L3628) |  |
| [3629](#L3629) | if ( lab\_lab() ) { |
| [3630](#L3630) | $pr = 'PRO'; |
| [3631](#L3631) | $support = '| <a target="\_blank" href="https://my.wpcerber.com">Get Support</a>'; |
| [3632](#L3632) | } |
| [3633](#L3633) | else { |
| [3634](#L3634) | $pr = ''; |
| [3635](#L3635) | $support = '| <a target="\_blank" href="https://wordpress.org/support/plugin/wp-cerber">Support Forum</a>'; |
| [3636](#L3636) | } |
| [3637](#L3637) |  |
| [3638](#L3638) | if ( 1 == cerber\_get\_mode() ) { |
| [3639](#L3639) | $mode = 'in the Standard mode'; |
| [3640](#L3640) | } |
| [3641](#L3641) | else { |
| [3642](#L3642) | $mode = 'in the Legacy mode'; |
| [3643](#L3643) | } |
| [3644](#L3644) | } |
| [3645](#L3645) |  |
| [3646](#L3646) | return 'WP Cerber Security ' . $pr . ' ' . $ver . '. ' . $mode . ' ' . $support; |
| [3647](#L3647) | }, PHP\_INT\_MAX ); |
| [3648](#L3648) |  |
| [3649](#L3649) | /\* |
| [3650](#L3650) | \* Add per screen user settings |
| [3651](#L3651) | \*/ |
| [3652](#L3652) | function crb\_admin\_screen\_options() { |
| [3653](#L3653) | if ( ! $id = crb\_get\_configurable\_screen() ) { |
| [3654](#L3654) | return; |
| [3655](#L3655) | } |
| [3656](#L3656) |  |
| [3657](#L3657) | add\_screen\_option( 'per\_page', array( |
| [3658](#L3658) | //'label' => \_\_( 'Number of items per page:' ), |
| [3659](#L3659) | 'default' => 25, |
| [3660](#L3660) | 'option'  => 'cerber\_screen\_' . $id . '\_page', // '\_page' is mandatory since WP 5.4.2 |
| [3661](#L3661) | ) ); |
| [3662](#L3662) | } |
| [3663](#L3663) |  |
| [3664](#L3664) | /\* |
| [3665](#L3665) | \* Enables saving screen options to the user's meta |
| [3666](#L3666) | \*/ |
| [3667](#L3667) | add\_filter( 'set-screen-option', function ( $status, $option, $value ) { |
| [3668](#L3668) | if ( $id = crb\_get\_configurable\_screen() ) { |
| [3669](#L3669) | if ( 'cerber\_screen\_' . $id . '\_page' == $option ) { |
| [3670](#L3670) | return $value; |
| [3671](#L3671) | } |
| [3672](#L3672) | } |
| [3673](#L3673) |  |
| [3674](#L3674) | return $status; |
| [3675](#L3675) | }, 10, 3 ); |
| [3676](#L3676) | /\* |
| [3677](#L3677) | \* Returns false if the admin page has no screen options to configure |
| [3678](#L3678) | \* |
| [3679](#L3679) | \* @return false|string |
| [3680](#L3680) | \*/ |
| [3681](#L3681) | function crb\_get\_configurable\_screen() { |
| [3682](#L3682) | if ( ! $id = crb\_admin\_get\_tab() ) { |
| [3683](#L3683) | $id = crb\_admin\_get\_page(); |
| [3684](#L3684) | } |
| [3685](#L3685) | if ( $id == 'cerber-traffic' ) { |
| [3686](#L3686) | $id = 'traffic'; |
| [3687](#L3687) | } |
| [3688](#L3688) | if ( ( $id == 'cerber-nexus' ) && nexus\_is\_master() ) { |
| [3689](#L3689) | return 'nexus\_sites'; |
| [3690](#L3690) | } |
| [3691](#L3691) | $ids = array( 'sessions', 'lockouts', 'activity', 'traffic', 'scan\_quarantine', 'scan\_ignore', 'nexus\_sites' ); |
| [3692](#L3692) | if ( ! in\_array( $id, $ids ) ) { |
| [3693](#L3693) | return false; |
| [3694](#L3694) | } |
| [3695](#L3695) |  |
| [3696](#L3696) | return $id; |
| [3697](#L3697) | } |
| [3698](#L3698) |  |
| [3699](#L3699) | /\* |
| [3700](#L3700) | \* Retrieve settings for the current screen |
| [3701](#L3701) | \* |
| [3702](#L3702) | \*/ |
| [3703](#L3703) | function crb\_admin\_get\_per\_page() { |
| [3704](#L3704) | if ( is\_multisite() ) { |
| [3705](#L3705) | return 50;  // temporary workaround |
| [3706](#L3706) | } |
| [3707](#L3707) |  |
| [3708](#L3708) | if ( nexus\_is\_valid\_request() ) { |
| [3709](#L3709) | $per\_page = nexus\_request\_data()->screen['per\_page']; |
| [3710](#L3710) | } |
| [3711](#L3711) | elseif ( function\_exists( 'get\_current\_screen' ) ) { |
| [3712](#L3712) | set\_current\_screen(); |
| [3713](#L3713) | $screen = get\_current\_screen(); |
| [3714](#L3714) |  |
| [3715](#L3715) | if ( $screen\_option = $screen->get\_option( 'per\_page', 'option' ) ) { |
| [3716](#L3716) | $per\_page = absint( get\_user\_meta( get\_current\_user\_id(), $screen\_option, true ) ); |
| [3717](#L3717) | if ( empty ( $per\_page ) ) { |
| [3718](#L3718) | $per\_page = absint( $screen->get\_option( 'per\_page', 'default' ) ); |
| [3719](#L3719) | } |
| [3720](#L3720) | } |
| [3721](#L3721) | } |
| [3722](#L3722) |  |
| [3723](#L3723) | if ( empty ( $per\_page ) ) { |
| [3724](#L3724) | $per\_page = 25; |
| [3725](#L3725) | } |
| [3726](#L3726) |  |
| [3727](#L3727) | return absint( $per\_page ); |
| [3728](#L3728) | } |
| [3729](#L3729) |  |
| [3730](#L3730) | /\*\* |
| [3731](#L3731) | \* @param array $tabs\_config array of tabs: title, desc, contents and optional JS callback |
| [3732](#L3732) | \* @param string $submit Text for the submit button |
| [3733](#L3733) | \* @param array $hidden Hidden form fields |
| [3734](#L3734) | \* @param string $form\_id |
| [3735](#L3735) | \* |
| [3736](#L3736) | \*/ |
| [3737](#L3737) | function crb\_admin\_show\_vtabs( $tabs\_config, $submit = '', $hidden = array(), $form\_id = 'cerber\_tabs' ) { |
| [3738](#L3738) |  |
| [3739](#L3739) | $tablinks  = ''; |
| [3740](#L3740) | $tabs      = ''; |
| [3741](#L3741) |  |
| [3742](#L3742) | foreach ( $tabs\_config as $tab\_id => $tab ) { |
| [3743](#L3743) | $tab\_id = str\_replace( '-', '\_', $tab\_id ); |
| [3744](#L3744) | $tablinks .= '<div class="tablinks" data-tab-id="' . $tab\_id . '" data-callback="' . crb\_array\_get( $tab, 'callback', '' ) . '">' . $tab['title'] . '<br/><span>' . crb\_array\_get( $tab, 'desc', '' ) . '</span></div>'; |
| [3745](#L3745) | $tabs     .= '<div id="tab-' . $tab\_id . '" class="vtabcontent">' . $tab['content'] . '</div>'; |
| [3746](#L3746) | } |
| [3747](#L3747) |  |
| [3748](#L3748) | echo '<form id="' . $form\_id . '" method="post" action="" class="crb-settings">'; |
| [3749](#L3749) |  |
| [3750](#L3750) | if ( ! $submit ) { |
| [3751](#L3751) | $submit = \_\_( 'Save Changes' ); |
| [3752](#L3752) | } |
| [3753](#L3753) |  |
| [3754](#L3754) | echo '<table class="vtable" id="crb\_vtabs\_container" style="width: 100%; border-collapse: collapse;"><tr><td id="crb-vtabs"><div class="vtabs">' . $tablinks . '</div></td><td id="crb-vtabcontent">' . $tabs . ' |
| [3755](#L3755) | </td></tr><tr><td></td><td><div style="padding-left: 3em;">' . crb\_admin\_submit\_button( $submit ) . '</div></td></tr></table>'; |
| [3756](#L3756) |  |
| [3757](#L3757) | cerber\_nonce\_field( 'control', true ); |
| [3758](#L3758) |  |
| [3759](#L3759) | if ( $hidden ) { |
| [3760](#L3760) | foreach ( $hidden as $name => $val ) { |
| [3761](#L3761) | echo '<input type="hidden" name="' . $name . '" value="' . $val . '">'; |
| [3762](#L3762) | } |
| [3763](#L3763) | } |
| [3764](#L3764) |  |
| [3765](#L3765) | echo '</form>'; |
| [3766](#L3766) |  |
| [3767](#L3767) | } |
| [3768](#L3768) |  |
| [3769](#L3769) | function crb\_admin\_show\_geo\_rules(){ |
| [3770](#L3770) |  |
| [3771](#L3771) | $rules = cerber\_geo\_rule\_set(); |
| [3772](#L3772) |  |
| [3773](#L3773) | $tabs\_config = array(); |
| [3774](#L3774) |  |
| [3775](#L3775) | foreach ( $rules as $rule\_id => $rule ) { |
| [3776](#L3776) |  |
| [3777](#L3777) | list( $desc, $content ) = crb\_admin\_geo\_selector( $rule\_id, $rule ); |
| [3778](#L3778) |  |
| [3779](#L3779) | if ( isset( $rule['multi\_set'] ) ) { |
| [3780](#L3780) | $names = array( '---first' => $rule['multi\_top'] . ' — ' . $desc ); |
| [3781](#L3781) | foreach ( $rule['multi\_set'] as $item\_id => $item\_title ) { |
| [3782](#L3782) | $id = $rule\_id . '\_' . $item\_id; |
| [3783](#L3783) | list( $d, $c ) = crb\_admin\_geo\_selector( $id, $rule, 'crb-display-none' ); |
| [3784](#L3784) | $content .= $c; |
| [3785](#L3785) | if ( cerber\_get\_geo\_rules( $id ) ) { |
| [3786](#L3786) | $desc = \_\_( 'Role-based rules are configured', 'wp-cerber' ); |
| [3787](#L3787) | $names[ $item\_id ] = $item\_title . ' — ' . $d; |
| [3788](#L3788) | } |
| [3789](#L3789) | else { |
| [3790](#L3790) | $names[ $item\_id ] = $item\_title; |
| [3791](#L3791) | } |
| [3792](#L3792) | } |
| [3793](#L3793) | $content = '<p>' . cerber\_select( 'sw\_' . $rule\_id, $names, null, 'crb-geo-switcher', null, null, null, array( 'rule-id' => $rule\_id ) ) . '</p>' . $content; |
| [3794](#L3794) | } |
| [3795](#L3795) |  |
| [3796](#L3796) | $tabs\_config[ $rule\_id ] = array( |
| [3797](#L3797) | 'title'    => $rule['name'], |
| [3798](#L3798) | 'desc'     => $desc, |
| [3799](#L3799) | 'content'  => '<div style="padding-top: 22px;">' . $content . '</div>', |
| [3800](#L3800) | 'callback' => 'geo\_rules\_activator', |
| [3801](#L3801) | ); |
| [3802](#L3802) | } |
| [3803](#L3803) |  |
| [3804](#L3804) | ?> |
| [3805](#L3805) |  |
| [3806](#L3806) | <script> |
| [3807](#L3807) | window.geo\_rules\_activator = function (rule\_id) { |
| [3808](#L3808) |  |
| [3809](#L3809) | if( typeof search\_fields === 'undefined' ) { |
| [3810](#L3810) | var search\_fields = jQuery('form#crb-geo-rules .multi-wrapper input:text'); |
| [3811](#L3811) | } |
| [3812](#L3812) |  |
| [3813](#L3813) | search\_fields.each(function () { |
| [3814](#L3814) | if (jQuery(this).val()) { |
| [3815](#L3815) | jQuery(this).val(''); // Reset "Search" field |
| [3816](#L3816) |  |
| [3817](#L3817) | if( typeof wrapper === 'undefined' ) { |
| [3818](#L3818) | var wrapper = jQuery('#crb-geo-rules .multi-wrapper'); |
| [3819](#L3819) | } |
| [3820](#L3820) |  |
| [3821](#L3821) | if( typeof select === 'undefined' ) { |
| [3822](#L3822) | var select = jQuery('#crb-geo-rules .crb-mega-select'); |
| [3823](#L3823) | } |
| [3824](#L3824) |  |
| [3825](#L3825) | wrapper.remove(); |
| [3826](#L3826) | select.removeAttr('data-multijs'); |
| [3827](#L3827) | //document.querySelector('#crb-geo-rules .crb-mega-select').removeAttribute('data-multijs'); |
| [3828](#L3828) | //document.querySelectorAll('#crb-geo-rules .crb-mega-select').removeAttribute('data-multijs'); |
| [3829](#L3829) | } |
| [3830](#L3830) | }); |
| [3831](#L3831) |  |
| [3832](#L3832) | if( typeof geo\_selectors === 'undefined' ) { |
| [3833](#L3833) | var geo\_selectors = jQuery('form#crb-geo-rules select.crb-mega-select'); |
| [3834](#L3834) | } |
| [3835](#L3835) |  |
| [3836](#L3836) | geo\_selectors.multi({'search\_placeholder': '<?php \_e( 'Start typing here to find a country', 'wp-cerber' ); ?>'}); |
| [3837](#L3837) |  |
| [3838](#L3838) | }; |
| [3839](#L3839) | </script> |
| [3840](#L3840) |  |
| [3841](#L3841) | <?php |
| [3842](#L3842) |  |
| [3843](#L3843) | crb\_admin\_show\_vtabs( $tabs\_config, \_\_( 'Save all rules', 'wp-cerber' ), array( 'cerber\_admin\_do' => 'update\_geo\_rules' ), 'crb-geo-rules' ); |
| [3844](#L3844) |  |
| [3845](#L3845) | } |
| [3846](#L3846) |  |
| [3847](#L3847) | function crb\_admin\_geo\_selector( $rule\_id, $rule, $class = '' ) { |
| [3848](#L3848) |  |
| [3849](#L3849) | $config   = cerber\_get\_geo\_rules( $rule\_id ); |
| [3850](#L3850) | $selector = crb\_geo\_country\_selector( $config, $rule\_id, $rule ); |
| [3851](#L3851) | $opt      = crb\_get\_settings(); |
| [3852](#L3852) |  |
| [3853](#L3853) | if ( ! empty( $config['list'] ) ) { |
| [3854](#L3854) | $num = count( $config['list'] ); |
| [3855](#L3855) | if ( $config['type'] == 'W' ) { |
| [3856](#L3856) | $info = sprintf( \_n( 'Permitted for one country', 'Permitted for %d countries', $num, 'wp-cerber' ), $num ); |
| [3857](#L3857) | } |
| [3858](#L3858) | else { |
| [3859](#L3859) | $info = sprintf( \_n( 'Not permitted for one country', 'Not permitted for %d countries', $num, 'wp-cerber' ), $num ); |
| [3860](#L3860) | } |
| [3861](#L3861) | if ( $num == 1 ) { |
| [3862](#L3862) | $info .= ' (' . current( $config['list'] ) . ')'; |
| [3863](#L3863) | //$info .= ' (' . cerber\_get\_flag\_html($c) . $c . ')'; |
| [3864](#L3864) | } |
| [3865](#L3865) | } |
| [3866](#L3866) | else { |
| [3867](#L3867) | $info = \_\_( 'No rule', 'wp-cerber' ); |
| [3868](#L3868) | $info = \_\_( 'Any country is permitted', 'wp-cerber' ); |
| [3869](#L3869) | } |
| [3870](#L3870) |  |
| [3871](#L3871) | $note = ''; |
| [3872](#L3872) | switch ( $rule\_id ) { |
| [3873](#L3873) | case 'geo\_register': |
| [3874](#L3874) | if ( ! get\_option( 'users\_can\_register' ) ) { |
| [3875](#L3875) | $note = 'Registration is disabled in the General WordPress Settings.'; |
| [3876](#L3876) | } |
| [3877](#L3877) | break; |
| [3878](#L3878) | case 'geo\_restapi': |
| [3879](#L3879) | if ( $opt['norest'] ) { |
| [3880](#L3880) | $note = 'REST API is disabled in the Hardening settings of WP Cerber.'; |
| [3881](#L3881) | } |
| [3882](#L3882) | break; |
| [3883](#L3883) | case 'geo\_xmlrpc': |
| [3884](#L3884) | if ( $opt['xmlrpc'] ) { |
| [3885](#L3885) | $note = 'XML-RPC is disabled in the Hardening settings of WP Cerber.'; |
| [3886](#L3886) | } |
| [3887](#L3887) | break; |
| [3888](#L3888) | } |
| [3889](#L3889) | if ( $note ) { |
| [3890](#L3890) | $note = '<p><span class="dashicons-before dashicons-warning"></span> Heads up! ' . $note . '</p>'; |
| [3891](#L3891) | } |
| [3892](#L3892) |  |
| [3893](#L3893) | return array( |
| [3894](#L3894) | $info, |
| [3895](#L3895) | $note . '<div class="crb-geo-wrapper ' . $class . '" id="crb-geo-wrap\_' . $rule\_id . '">' . $selector . '</div>' |
| [3896](#L3896) | ); |
| [3897](#L3897) |  |
| [3898](#L3898) | } |
| [3899](#L3899) |  |
| [3900](#L3900) | /\*\* |
| [3901](#L3901) | \* Generates GEO rule selector |
| [3902](#L3902) | \* |
| [3903](#L3903) | \* @param array $config Rule configuration |
| [3904](#L3904) | \* @param string $rule\_id |
| [3905](#L3905) | \* @param array $rule |
| [3906](#L3906) | \* |
| [3907](#L3907) | \* @return string   HTML code of form |
| [3908](#L3908) | \*/ |
| [3909](#L3909) | function crb\_geo\_country\_selector( $config = array(), $rule\_id = '', $rule = array() ) { |
| [3910](#L3910) |  |
| [3911](#L3911) | $ret = '<div class="crb-super-select"><select id="countries-' . $rule\_id . '" name="crb-' . $rule\_id . '-list[]" class="crb-mega-select" style="display: none;" multiple="multiple">'; |
| [3912](#L3912) |  |
| [3913](#L3913) | if ( ! empty( $config['list'] ) ) { |
| [3914](#L3914) | $selected = $config['list']; |
| [3915](#L3915) | } |
| [3916](#L3916) | else { |
| [3917](#L3917) | $selected = null; |
| [3918](#L3918) | } |
| [3919](#L3919) |  |
| [3920](#L3920) | foreach ( cerber\_get\_country\_list() as $code => $country ) { |
| [3921](#L3921) | if ( $selected && in\_array( $code, $selected ) ) { |
| [3922](#L3922) | $sel = 'selected'; |
| [3923](#L3923) | } |
| [3924](#L3924) | else { |
| [3925](#L3925) | $sel = ''; |
| [3926](#L3926) | } |
| [3927](#L3927) | $ret .= '<option ' . $sel . ' value="' . $code . '">' . $country . '</option>'; |
| [3928](#L3928) | } |
| [3929](#L3929) |  |
| [3930](#L3930) | if ( ! empty( $config['type'] ) && $config['type'] == 'B' ) { |
| [3931](#L3931) | $w = ''; |
| [3932](#L3932) | $b = 'checked="checked"'; |
| [3933](#L3933) | } |
| [3934](#L3934) | else { |
| [3935](#L3935) | $w = 'checked="checked"'; |
| [3936](#L3936) | $b = ''; |
| [3937](#L3937) | } |
| [3938](#L3938) |  |
| [3939](#L3939) | if ( ! empty( $rule['desc'] ) ) { |
| [3940](#L3940) | $desc = $rule['desc']; |
| [3941](#L3941) | } |
| [3942](#L3942) | else { |
| [3943](#L3943) | $desc = '<span style="text-transform: lowercase;">' . $rule['name'] . '</span>'; |
| [3944](#L3944) | } |
| [3945](#L3945) |  |
| [3946](#L3946) |  |
| [3947](#L3947) | $ret .= ' |
| [3948](#L3948) | </select> |
| [3949](#L3949) |  |
| [3950](#L3950) | <div class="crb-super-details"> |
| [3951](#L3951) | <p><span style="opacity: 0.7;">' . \_\_( 'Click on a country name to add it to the list of selected countries', 'wp-cerber' ) . '</span></p> |
| [3952](#L3952) |  |
| [3953](#L3953) | <p style="margin-top: 2em;"> |
| [3954](#L3954) | <input type="radio" value="W" name="crb-' . $rule\_id . '-type" id="geo-type-' . $rule\_id . '-W" ' . $w . '> |
| [3955](#L3955) | <label for="geo-type-' . $rule\_id . '-W">' . sprintf( \_x( 'Selected countries are permitted to %s, other countries are not permitted to', 'to is a marker of infinitive, e.g. "to use it"', 'wp-cerber' ), $desc ) . '</label> |
| [3956](#L3956) | <p> |
| [3957](#L3957) | <input type="radio" value="B" name="crb-' . $rule\_id . '-type" id="geo-type-' . $rule\_id . '-B" ' . $b . '> |
| [3958](#L3958) | <label for="geo-type-' . $rule\_id . '-B">' . sprintf( \_x( 'Selected countries are not permitted to %s, other countries are permitted to', 'to is a marker of infinitive, e.g. "to use it"', 'wp-cerber' ), $desc ) . '</label> |
| [3959](#L3959) | </p> |
| [3960](#L3960) | </div> |
| [3961](#L3961) |  |
| [3962](#L3962) | </div>'; |
| [3963](#L3963) |  |
| [3964](#L3964) | return $ret; |
| [3965](#L3965) |  |
| [3966](#L3966) | } |
| [3967](#L3967) |  |
| [3968](#L3968) | /\*\* |
| [3969](#L3969) | \* A list of available GEO rules |
| [3970](#L3970) | \* |
| [3971](#L3971) | \* @return array |
| [3972](#L3972) | \*/ |
| [3973](#L3973) | function cerber\_geo\_rule\_set() { |
| [3974](#L3974) | $set = wp\_roles()->role\_names; |
| [3975](#L3975) |  |
| [3976](#L3976) | $rules = array( |
| [3977](#L3977) | 'geo\_login' => array( |
| [3978](#L3978) | 'name'      => \_\_( 'Log into the website', 'wp-cerber' ), |
| [3979](#L3979) | 'multi\_set' => $set, |
| [3980](#L3980) | 'multi\_top' => \_\_( 'All Users' ) |
| [3981](#L3981) | ), |
| [3982](#L3982) | 'geo\_register' => array( 'name' => \_\_( 'Register on the website', 'wp-cerber' ) ), |
| [3983](#L3983) | 'geo\_submit'   => array( 'name' => \_\_( 'Submit forms', 'wp-cerber' ) ), |
| [3984](#L3984) | 'geo\_comment'  => array( 'name' => \_\_( 'Post comments', 'wp-cerber' ) ), |
| [3985](#L3985) | 'geo\_xmlrpc'   => array( 'name' => \_\_( 'Use XML-RPC', 'wp-cerber' ) ), |
| [3986](#L3986) | 'geo\_restapi'  => array( 'name' => \_\_( 'Use REST API', 'wp-cerber' ) ), |
| [3987](#L3987) | ); |
| [3988](#L3988) |  |
| [3989](#L3989) | return $rules; |
| [3990](#L3990) | } |
| [3991](#L3991) |  |
| [3992](#L3992) | function crb\_admin\_save\_geo\_rules( $post\_fields = array() ) { |
| [3993](#L3993) | global $cerber\_country\_names, $check, $admin\_country; |
| [3994](#L3994) |  |
| [3995](#L3995) | if ( ! lab\_lab() ) { |
| [3996](#L3996) | return; |
| [3997](#L3997) | } |
| [3998](#L3998) |  |
| [3999](#L3999) | $check = array\_keys( $cerber\_country\_names ); |
| [4000](#L4000) |  |
| [4001](#L4001) | // Prevent admin country from being blocked |
| [4002](#L4002) | if ( nexus\_is\_valid\_request() ) { |
| [4003](#L4003) | $admin\_country = null; |
| [4004](#L4004) | } |
| [4005](#L4005) | else { |
| [4006](#L4006) | $admin\_country = lab\_get\_country( cerber\_get\_remote\_ip(), false ); |
| [4007](#L4007) | } |
| [4008](#L4008) |  |
| [4009](#L4009) | $geo   = array(); |
| [4010](#L4010) |  |
| [4011](#L4011) | foreach ( cerber\_geo\_rule\_set() as $rule\_id => $rule ) { |
| [4012](#L4012) |  |
| [4013](#L4013) | if ( $data = crb\_admin\_process\_geo( $post\_fields, $rule\_id ) ) { |
| [4014](#L4014) | $geo[ $rule\_id ] = $data; |
| [4015](#L4015) | } |
| [4016](#L4016) |  |
| [4017](#L4017) | if ( isset( $rule['multi\_set'] ) ) { |
| [4018](#L4018) | foreach ( $rule['multi\_set'] as $item\_id => $item\_title ) { |
| [4019](#L4019) | $id = $rule\_id . '\_' . $item\_id; |
| [4020](#L4020) | if ( $data = crb\_admin\_process\_geo( $post\_fields, $id ) ) { |
| [4021](#L4021) | $geo[ $id ] = $data; |
| [4022](#L4022) | } |
| [4023](#L4023) | } |
| [4024](#L4024) | } |
| [4025](#L4025) | } |
| [4026](#L4026) |  |
| [4027](#L4027) | if ( update\_site\_option( CERBER\_GEO\_RULES, $geo ) ) { |
| [4028](#L4028) | cerber\_admin\_message( \_\_( 'Security rules have been updated', 'wp-cerber' ) ); |
| [4029](#L4029) | } |
| [4030](#L4030) | } |
| [4031](#L4031) |  |
| [4032](#L4032) | function crb\_admin\_process\_geo( $post, $rule\_id ) { |
| [4033](#L4033) | global $check, $admin\_country; |
| [4034](#L4034) |  |
| [4035](#L4035) | if ( empty( $post[ 'crb-' . $rule\_id . '-list' ] ) || empty( $post[ 'crb-' . $rule\_id . '-type' ] ) ) { |
| [4036](#L4036) | return false; |
| [4037](#L4037) | } |
| [4038](#L4038) |  |
| [4039](#L4039) | $list = array\_intersect( $post[ 'crb-' . $rule\_id . '-list' ], $check ); |
| [4040](#L4040) |  |
| [4041](#L4041) | if ( $post[ 'crb-' . $rule\_id . '-type' ] == 'B' ) { |
| [4042](#L4042) | $type = 'B'; |
| [4043](#L4043) | if ( $admin\_country && ( ( $key = array\_search( $admin\_country, $list ) ) !== false ) ) { |
| [4044](#L4044) | unset( $list[ $key ] ); |
| [4045](#L4045) | } |
| [4046](#L4046) | } |
| [4047](#L4047) | else { |
| [4048](#L4048) | $type = 'W'; |
| [4049](#L4049) | if ( $admin\_country && ( ( $key = array\_search( $admin\_country, $list ) ) === false ) ) { |
| [4050](#L4050) | array\_push( $list, $admin\_country ); |
| [4051](#L4051) | } |
| [4052](#L4052) | } |
| [4053](#L4053) |  |
| [4054](#L4054) | return array( 'list' => $list, 'type' => $type ); |
| [4055](#L4055) | } |
| [4056](#L4056) |  |
| [4057](#L4057) | /\*\* |
| [4058](#L4058) | \* Generates HTML for showing country in UI |
| [4059](#L4059) | \* |
| [4060](#L4060) | \* @param null $code |
| [4061](#L4061) | \* @param null $ip |
| [4062](#L4062) | \* @param bool $cache\_only |
| [4063](#L4063) | \* |
| [4064](#L4064) | \* @return string |
| [4065](#L4065) | \*/ |
| [4066](#L4066) | function crb\_country\_html( $code = null, $ip = null, $cache\_only = true ) { |
| [4067](#L4067) |  |
| [4068](#L4068) | if ( ! lab\_lab() ) { |
| [4069](#L4069) | return ''; |
| [4070](#L4070) | } |
| [4071](#L4071) |  |
| [4072](#L4072) | if ( ! $code ) { |
| [4073](#L4073) | if ( $ip ) { |
| [4074](#L4074) | $code = lab\_get\_country( $ip, $cache\_only ); |
| [4075](#L4075) | } |
| [4076](#L4076) | else { |
| [4077](#L4077) | return ''; |
| [4078](#L4078) | } |
| [4079](#L4079) | } |
| [4080](#L4080) |  |
| [4081](#L4081) | if ( $code ) { |
| [4082](#L4082) | $ret = cerber\_get\_flag\_html( $code, cerber\_country\_name( $code ) ); |
| [4083](#L4083) | } |
| [4084](#L4084) | else { |
| [4085](#L4085) | $ip\_id = cerber\_get\_id\_ip( $ip ); |
| [4086](#L4086) | $ret = crb\_get\_ajax\_placeholder( 'country', $ip\_id ); |
| [4087](#L4087) | } |
| [4088](#L4088) |  |
| [4089](#L4089) | return $ret; |
| [4090](#L4090) | } |
| [4091](#L4091) |  |
| [4092](#L4092) | // Traffic ===================================================================================== |
| [4093](#L4093) |  |
| [4094](#L4094) | function cerber\_export\_traffic( $params = array() ) { |
| [4095](#L4095) |  |
| [4096](#L4096) | crb\_raise\_limits( 512 ); |
| [4097](#L4097) |  |
| [4098](#L4098) | $args = array( |
| [4099](#L4099) | 'per\_page' => 0, |
| [4100](#L4100) | 'columns'  => array( 'ip', 'stamp', 'uri', 'session\_id', 'user\_id', 'processing', 'request\_method', 'http\_code', 'wp\_type', 'blog\_id' ) |
| [4101](#L4101) | ); |
| [4102](#L4102) |  |
| [4103](#L4103) | if ( $params ) { |
| [4104](#L4104) | $args = array\_merge( $params, $args ); |
| [4105](#L4105) | } |
| [4106](#L4106) |  |
| [4107](#L4107) | list( $query, $found ) = cerber\_traffic\_query( $args ); |
| [4108](#L4108) |  |
| [4109](#L4109) | // We split into several requests to avoid PHP and MySQL memory limitations |
| [4110](#L4110) |  |
| [4111](#L4111) | if ( defined( 'CERBER\_EXPORT\_CHUNK' ) && is\_numeric( CERBER\_EXPORT\_CHUNK ) ) { |
| [4112](#L4112) | $per\_chunk = CERBER\_EXPORT\_CHUNK; |
| [4113](#L4113) | } |
| [4114](#L4114) | else { |
| [4115](#L4115) | $per\_chunk = 1000;      // Rows per SQL request, we assume that this number is not too small and not too big |
| [4116](#L4116) | } |
| [4117](#L4117) |  |
| [4118](#L4118) | if ( ! $result = cerber\_db\_query( $query . ' LIMIT ' . $per\_chunk ) ) { |
| [4119](#L4119) | wp\_die( 'Nothing to export' ); |
| [4120](#L4120) | } |
| [4121](#L4121) |  |
| [4122](#L4122) | $total = cerber\_db\_get\_var( $found ); |
| [4123](#L4123) |  |
| [4124](#L4124) | $info = array(); |
| [4125](#L4125) |  |
| [4126](#L4126) | $heading = array( |
| [4127](#L4127) | \_\_( 'IP address', 'wp-cerber' ), |
| [4128](#L4128) | \_\_( 'Date', 'wp-cerber' ), |
| [4129](#L4129) | 'Method', |
| [4130](#L4130) | 'URI', |
| [4131](#L4131) | 'HTTP Code', |
| [4132](#L4132) | 'Request ID', |
| [4133](#L4133) | \_\_( 'User ID', 'wp-cerber' ), |
| [4134](#L4134) | \_\_( 'Page generation time', 'wp-cerber' ), |
| [4135](#L4135) | 'Blog ID', |
| [4136](#L4136) | 'Type', |
| [4137](#L4137) | 'Unix Timestamp', |
| [4138](#L4138) | ); |
| [4139](#L4139) |  |
| [4140](#L4140) | cerber\_send\_csv\_header( 'wp-cerber-http-requests', $total, $heading, $info ); |
| [4141](#L4141) |  |
| [4142](#L4142) | //$labels = cerber\_get\_labels( 'activity' ); |
| [4143](#L4143) | //$status = cerber\_get\_labels( 'status' ); |
| [4144](#L4144) |  |
| [4145](#L4145) | if ( crb\_get\_settings( 'plain\_date' ) ) { |
| [4146](#L4146) | function \_crb\_csv\_date( $timestamp ) { |
| [4147](#L4147) | static $gmt\_offset; |
| [4148](#L4148) | if ( $gmt\_offset === null ) { |
| [4149](#L4149) | $gmt\_offset = get\_option( 'gmt\_offset' ) \* 3600; |
| [4150](#L4150) | } |
| [4151](#L4151) | return date( 'Y-m-d H:i:s', $timestamp + $gmt\_offset ); |
| [4152](#L4152) | } |
| [4153](#L4153) | } |
| [4154](#L4154) | else { |
| [4155](#L4155) | function \_crb\_csv\_date( $timestamp ) { |
| [4156](#L4156) | return cerber\_date( $timestamp, false ); |
| [4157](#L4157) | } |
| [4158](#L4158) | } |
| [4159](#L4159) |  |
| [4160](#L4160) | // The loop |
| [4161](#L4161) |  |
| [4162](#L4162) | $i = 0; |
| [4163](#L4163) |  |
| [4164](#L4164) | do { |
| [4165](#L4165) |  |
| [4166](#L4166) | while ( $row = mysqli\_fetch\_assoc( $result ) ) { |
| [4167](#L4167) |  |
| [4168](#L4168) | $values = array(); |
| [4169](#L4169) |  |
| [4170](#L4170) | /\* |
| [4171](#L4171) | $values[] = $row->ip; |
| [4172](#L4172) | $values[] = cerber\_date( $row->stamp ); |
| [4173](#L4173) | $values[] = $row->request\_method; |
| [4174](#L4174) | $values[] = $row->uri; |
| [4175](#L4175) | $values[] = $row->http\_code; |
| [4176](#L4176) | $values[] = $row->session\_id; |
| [4177](#L4177) | $values[] = $row->user\_id; |
| [4178](#L4178) | $values[] = $row->processing; |
| [4179](#L4179) | $values[] = $row->blog\_id; |
| [4180](#L4180) | $values[] = $row->wp\_type; |
| [4181](#L4181) | $values[] = $row->stamp;\*/ |
| [4182](#L4182) |  |
| [4183](#L4183) | $values[] = $row['ip']; |
| [4184](#L4184) | $values[] = \_crb\_csv\_date( $row['stamp'] ); |
| [4185](#L4185) | $values[] = $row['request\_method']; |
| [4186](#L4186) | $values[] = $row['uri']; |
| [4187](#L4187) | $values[] = $row['http\_code']; |
| [4188](#L4188) | $values[] = $row['session\_id']; |
| [4189](#L4189) | $values[] = $row['user\_id']; |
| [4190](#L4190) | $values[] = $row['processing']; |
| [4191](#L4191) | $values[] = $row['blog\_id']; |
| [4192](#L4192) | $values[] = $row['wp\_type']; |
| [4193](#L4193) | $values[] = $row['stamp']; |
| [4194](#L4194) |  |
| [4195](#L4195) | cerber\_send\_csv\_line( $values ); |
| [4196](#L4196) | } |
| [4197](#L4197) |  |
| [4198](#L4198) | mysqli\_free\_result( $result ); |
| [4199](#L4199) |  |
| [4200](#L4200) | $i++; |
| [4201](#L4201) | $offset = $per\_chunk \* $i; |
| [4202](#L4202) |  |
| [4203](#L4203) | } while ( ( $result = cerber\_db\_query( $query . ' LIMIT ' . $offset . ', ' . $per\_chunk ) ) |
| [4204](#L4204) | && $result->num\_rows ); |
| [4205](#L4205) |  |
| [4206](#L4206) | exit; |
| [4207](#L4207) | } |
| [4208](#L4208) |  |
| [4209](#L4209) | /\* |
| [4210](#L4210) | \* Display traffic in the WP Dashboard |
| [4211](#L4211) | \* |
| [4212](#L4212) | \*/ |
| [4213](#L4213) | function cerber\_show\_traffic( $args = array(), $echo = true ) { |
| [4214](#L4214) | global $wpdb; |
| [4215](#L4215) |  |
| [4216](#L4216) | $labels = cerber\_get\_labels( 'activity' ); |
| [4217](#L4217) | $status\_labels = cerber\_get\_labels( 'status' ) + cerber\_get\_reason(); |
| [4218](#L4218) |  |
| [4219](#L4219) | $base\_url = cerber\_admin\_link( 'traffic' ); |
| [4220](#L4220) | $logging\_enabled = (bool) crb\_get\_settings( 'timode' ); |
| [4221](#L4221) | $is\_log\_empty = ! ( (bool) cerber\_db\_get\_var( 'SELECT stamp FROM ' . CERBER\_TRAF\_TABLE . ' LIMIT 1' ) ); |
| [4222](#L4222) |  |
| [4223](#L4223) | $ret = ''; |
| [4224](#L4224) | $total = 0; |
| [4225](#L4225) |  |
| [4226](#L4226) | list( $query, $found, $per\_page, $filter\_act, $filter\_ip, $prc, $user\_id ) = cerber\_traffic\_query( $args ); |
| [4227](#L4227) |  |
| [4228](#L4228) | // No cache |
| [4229](#L4229) | //$rows = cerber\_db\_get\_results( $query, MYSQL\_FETCH\_OBJECT\_K ); |
| [4230](#L4230) | //$total = cerber\_db\_get\_var( $found ); |
| [4231](#L4231) |  |
| [4232](#L4232) | list( $rows, $total ) = crb\_q\_cache\_get( array( |
| [4233](#L4233) | array( $query, MYSQL\_FETCH\_OBJECT\_K ), |
| [4234](#L4234) | array( $found ) |
| [4235](#L4235) | ), CERBER\_TRAF\_TABLE ); |
| [4236](#L4236) | if ( is\_object( $rows ) ) { // Due to json |
| [4237](#L4237) | $rows = get\_object\_vars( $rows ); |
| [4238](#L4238) | } |
| [4239](#L4239) | $total = $total[0][0]; |
| [4240](#L4240) |  |
| [4241](#L4241) | if ( $rows ) { |
| [4242](#L4242) |  |
| [4243](#L4243) | // No cache |
| [4244](#L4244) | // $act\_events = cerber\_db\_get\_results( 'SELECT \* FROM ' . CERBER\_LOG\_TABLE . ' WHERE session\_id IN ("' . implode( '", "', array\_keys( $rows ) ) . '" ) ORDER BY stamp DESC', MYSQL\_FETCH\_OBJECT ); |
| [4245](#L4245) | // $act\_events = cerber\_db\_get\_results( 'SELECT \* FROM ' . CERBER\_LOG\_TABLE . ' WHERE session\_id IN ("' . implode( '", "', array\_keys( $rows ) ) . '" )', MYSQL\_FETCH\_OBJECT ); |
| [4246](#L4246) | $act\_events = crb\_q\_cache\_get( array( |
| [4247](#L4247) | array( |
| [4248](#L4248) | 'SELECT \* FROM ' . CERBER\_LOG\_TABLE . ' WHERE session\_id IN ("' . implode( '", "', array\_keys( $rows ) ) . '" ) ORDER BY stamp DESC', |
| [4249](#L4249) | MYSQL\_FETCH\_OBJECT |
| [4250](#L4250) | ) |
| [4251](#L4251) | ), CERBER\_LOG\_TABLE ); |
| [4252](#L4252) |  |
| [4253](#L4253) | $events = array(); |
| [4254](#L4254) | if ( $act\_events ) { |
| [4255](#L4255) | foreach ( $act\_events as $ac ) { |
| [4256](#L4256) | $events[ $ac->session\_id ][] = $ac; |
| [4257](#L4257) | } |
| [4258](#L4258) | } |
| [4259](#L4259) |  |
| [4260](#L4260) | $roles = wp\_roles()->roles; |
| [4261](#L4261) | $users = array(); |
| [4262](#L4262) | $acl = array(); |
| [4263](#L4263) | $block = array(); |
| [4264](#L4264) | $wp\_objects = array(); |
| [4265](#L4265) |  |
| [4266](#L4266) | foreach ( $rows as $row ) { |
| [4267](#L4267) |  |
| [4268](#L4268) | if ( $row->user\_id && ! isset( $users[ $row->user\_id ] ) ) { |
| [4269](#L4269) | if ( $u = get\_userdata( $row->user\_id ) ) { |
| [4270](#L4270) | $n = $u->display\_name; |
| [4271](#L4271) | $r = ''; |
| [4272](#L4272) | if ( ! is\_multisite() && $u->roles ) { |
| [4273](#L4273) | $r = array(); |
| [4274](#L4274) | foreach ( $u->roles as $role ) { |
| [4275](#L4275) | $r[] = $roles[ $role ]['name']; |
| [4276](#L4276) | } |
| [4277](#L4277) | $r = '<span class="crb\_act\_role">' . implode( ', ', $r ) . '</span>'; |
| [4278](#L4278) | } |
| [4279](#L4279) | } |
| [4280](#L4280) | else { |
| [4281](#L4281) | $n = \_\_( 'Unknown', 'wp-cerber' ) . ' (' . $row->user\_id . ')'; |
| [4282](#L4282) | $r = ''; |
| [4283](#L4283) | } |
| [4284](#L4284) |  |
| [4285](#L4285) | $users[ $row->user\_id ]['name'] = $n; |
| [4286](#L4286) | $users[ $row->user\_id ]['roles'] = $r; |
| [4287](#L4287) | } |
| [4288](#L4288) |  |
| [4289](#L4289) | if ( ! isset( $acl[ $row->ip ] ) ) { |
| [4290](#L4290) | $acl[ $row->ip ] = cerber\_acl\_check( $row->ip ); |
| [4291](#L4291) | } |
| [4292](#L4292) |  |
| [4293](#L4293) | if ( ! isset( $block[ $row->ip ] ) ) { |
| [4294](#L4294) | $block[ $row->ip ] = cerber\_block\_check( $row->ip ); |
| [4295](#L4295) | } |
| [4296](#L4296) |  |
| [4297](#L4297) | // TODO: make it compatible with multisite WP |
| [4298](#L4298) | if ( $row->wp\_type == 601 && $row->wp\_id > 0 ) { |
| [4299](#L4299) | $title = cerber\_db\_get\_var( 'SELECT post\_title FROM ' . $wpdb->posts . ' WHERE ID = ' . absint( $row->wp\_id ) ); |
| [4300](#L4300) | if ( $title ) { |
| [4301](#L4301) | $wp\_objects[ $row->wp\_id ] = apply\_filters( 'the\_title', $title, $row->wp\_id ); |
| [4302](#L4302) | } |
| [4303](#L4303) | } |
| [4304](#L4304) |  |
| [4305](#L4305) | } |
| [4306](#L4306) | } |
| [4307](#L4307) |  |
| [4308](#L4308) | $info = ''; |
| [4309](#L4309) |  |
| [4310](#L4310) | if ( $filter\_ip ) { |
| [4311](#L4311) | $info .= cerber\_ip\_extra\_view( $filter\_ip, 'traffic' ); |
| [4312](#L4312) | } |
| [4313](#L4313) |  |
| [4314](#L4314) | if ( $user\_id ) { |
| [4315](#L4315) | $info .= cerber\_user\_extra\_view( $user\_id, 'traffic' ); |
| [4316](#L4316) | } |
| [4317](#L4317) |  |
| [4318](#L4318) | if ( $rows ) { |
| [4319](#L4319) |  |
| [4320](#L4320) | $no\_results = false; |
| [4321](#L4321) |  |
| [4322](#L4322) | $tbody = ''; |
| [4323](#L4323) | $country = ''; |
| [4324](#L4324) | $geo = lab\_lab(); |
| [4325](#L4325) |  |
| [4326](#L4326) | if ( ! defined( 'CERBER\_FULL\_URI' ) || ! CERBER\_FULL\_URI ) { |
| [4327](#L4327) | $short = true; |
| [4328](#L4328) | $site\_url = cerber\_get\_site\_url(); |
| [4329](#L4329) | $len = strlen( rtrim( $site\_url, '/' ) ); |
| [4330](#L4330) | } |
| [4331](#L4331) | else { |
| [4332](#L4332) | $short = false; |
| [4333](#L4333) | $len = 0; |
| [4334](#L4334) | } |
| [4335](#L4335) |  |
| [4336](#L4336) | foreach ( $rows as $row ) { |
| [4337](#L4337) |  |
| [4338](#L4338) | // URI |
| [4339](#L4339) |  |
| [4340](#L4340) | $full\_uri = urldecode( $row->uri ); |
| [4341](#L4341) |  |
| [4342](#L4342) | if ( $short && 0 === strpos( $full\_uri, $site\_url ) ) { |
| [4343](#L4343) | $row\_uri = substr( $full\_uri, $len ); |
| [4344](#L4344) | } |
| [4345](#L4345) | else { |
| [4346](#L4346) | $row\_uri = $full\_uri; |
| [4347](#L4347) | } |
| [4348](#L4348) |  |
| [4349](#L4349) | if ( strlen( $row\_uri ) > 220 ) { |
| [4350](#L4350) | $truncated = true; |
| [4351](#L4351) | $row\_uri = substr( $row\_uri, 0, 220 ); |
| [4352](#L4352) | } |
| [4353](#L4353) | else { |
| [4354](#L4354) | $truncated = false; |
| [4355](#L4355) | } |
| [4356](#L4356) |  |
| [4357](#L4357) | $row\_uri = htmlentities( $row\_uri, ENT\_SUBSTITUTE ); |
| [4358](#L4358) | $row\_uri = str\_replace( array( '-', '/', '%', '&', '=', '?', '(', ')', ), |
| [4359](#L4359) | array( '<wbr>-', '<wbr>/', '<wbr>%', '<wbr>&', '<wbr>=', '<wbr>?', '<wbr>(', ')<wbr>' ), $row\_uri ); |
| [4360](#L4360) |  |
| [4361](#L4361) | if ( $truncated ) { |
| [4362](#L4362) | $row\_uri .= ' <span style="color: red;">&hellip;</span>'; |
| [4363](#L4363) | } |
| [4364](#L4364) |  |
| [4365](#L4365) | // User |
| [4366](#L4366) |  |
| [4367](#L4367) | $ip\_id = cerber\_get\_id\_ip( $row->ip ); |
| [4368](#L4368) |  |
| [4369](#L4369) | if ( $row->user\_id ) { |
| [4370](#L4370) | $name = '<a href="' . $base\_url . '&filter\_user=' . $row->user\_id . '"><b>' . $users[ $row->user\_id ]['name'] . '</b></a><br/>' . $users[ $row->user\_id ]['roles']; |
| [4371](#L4371) | } |
| [4372](#L4372) | else { |
| [4373](#L4373) | $name = ''; |
| [4374](#L4374) | } |
| [4375](#L4375) |  |
| [4376](#L4376) | if ( ! empty( $row->hostname ) ) { |
| [4377](#L4377) | $hostname = $row->hostname; |
| [4378](#L4378) | } |
| [4379](#L4379) | else { |
| [4380](#L4380) | $ip\_info = cerber\_get\_ip\_info( $row->ip, true ); |
| [4381](#L4381) | $hostname = $ip\_info['hostname\_html'] ?? crb\_get\_ajax\_placeholder( 'hostname', $ip\_id ); |
| [4382](#L4382) | } |
| [4383](#L4383) |  |
| [4384](#L4384) | if ( ! empty( $args['date'] ) && $args['date'] == 'ago' ) { |
| [4385](#L4385) | $date = cerber\_ago\_time( $row->stamp ); |
| [4386](#L4386) | } |
| [4387](#L4387) | else { |
| [4388](#L4388) | $date = '<span title="' . $row->stamp . ' / ' . $row->session\_id . '">' . cerber\_date( $row->stamp ) . '</span>'; |
| [4389](#L4389) | } |
| [4390](#L4390) |  |
| [4391](#L4391) | if ( $geo ) { |
| [4392](#L4392) | $country = '<p style="">' . crb\_country\_html( $row->country, $row->ip ) . '</p>'; |
| [4393](#L4393) | } |
| [4394](#L4394) |  |
| [4395](#L4395) | $activity = ''; |
| [4396](#L4396) | if ( ! empty( $events[ $row->session\_id ] ) ) { |
| [4397](#L4397) | foreach ( $events[ $row->session\_id ] as $a ) { |
| [4398](#L4398) | $activity .= '<p><a href="' . $base\_url . '&filter\_activity=' . $a->activity . '" title="' . $a->activity . '" data-no-js="1">' . $labels[ $a->activity ] . '</a>'; |
| [4399](#L4399) |  |
| [4400](#L4400) | $ad = explode( '|', $a->details ); |
| [4401](#L4401) | if ( ! empty( $ad[0] ) && $ad[0] != 500 ) { // 500 Whitelisted |
| [4402](#L4402) | $activity .= ' &nbsp;<span class = "crb-log-status crb-status-' . $ad[0] . '" title="' . $ad[0] . '">' . $status\_labels[ $ad[0] ] . '</span>'; |
| [4403](#L4403) | } |
| [4404](#L4404) | } |
| [4405](#L4405) | } |
| [4406](#L4406) |  |
| [4407](#L4407) | if ( $row->processing ) { |
| [4408](#L4408) | $processing = $row->processing . ' ms'; |
| [4409](#L4409) | if ( ( $threshold = crb\_get\_settings( 'tithreshold' ) ) && $row->processing > $threshold ) { |
| [4410](#L4410) | $processing = '<span class="crb-processing crb-above">' . $processing . '</span>'; |
| [4411](#L4411) | } |
| [4412](#L4412) | } |
| [4413](#L4413) | else { |
| [4414](#L4414) | $processing = ''; |
| [4415](#L4415) | } |
| [4416](#L4416) |  |
| [4417](#L4417) | $wp\_type = ''; |
| [4418](#L4418) | if ( $t = cerber\_get\_wp\_type( $row->wp\_type ) ) { |
| [4419](#L4419) | $wp\_type = '<span class="crb-wp-type-' . $row->wp\_type . '">' . $t . '</span>'; |
| [4420](#L4420) | } |
| [4421](#L4421) |  |
| [4422](#L4422) | $wp\_obj = ''; |
| [4423](#L4423) | if ( isset( $wp\_objects[ $row->wp\_id ] ) ) { |
| [4424](#L4424) | $wp\_obj = '<p><i>' . $wp\_objects[ $row->wp\_id ] . '</i></p>'; |
| [4425](#L4425) | } |
| [4426](#L4426) |  |
| [4427](#L4427) | $more\_details = array(); |
| [4428](#L4428) |  |
| [4429](#L4429) | if ( $truncated ) { |
| [4430](#L4430) | $full\_uri = htmlentities( $full\_uri, ENT\_SUBSTITUTE ); |
| [4431](#L4431) | $full\_uri = str\_replace( array( '-', '/', '%', '&', '=', '?', '(', ')', ), |
| [4432](#L4432) | array( '<wbr>-', '<wbr>/', '<wbr>%', '<wbr>&', '<wbr>=', '<wbr>?', '<wbr>(', ')<wbr>' ), $full\_uri ); |
| [4433](#L4433) | $more\_details[] = array( |
| [4434](#L4434) | 'Full URL', |
| [4435](#L4435) | '<span class="crb-monospace">' . $full\_uri . '</span>' |
| [4436](#L4436) | ); |
| [4437](#L4437) | } |
| [4438](#L4438) |  |
| [4439](#L4439) | $fields = crb\_auto\_decode( $row->request\_fields ); |
| [4440](#L4440) | $details = crb\_auto\_decode( $row->request\_details ); |
| [4441](#L4441) |  |
| [4442](#L4442) | if ( ! empty( $details[2] ) ) { |
| [4443](#L4443) | $more\_details[] = array( |
| [4444](#L4444) | 'Referrer', |
| [4445](#L4445) | '<span class="crb-monospace">' . htmlentities( urldecode( $details[2] ), ENT\_SUBSTITUTE ) . '</span>' |
| [4446](#L4446) | ); |
| [4447](#L4447) | } |
| [4448](#L4448) |  |
| [4449](#L4449) | if ( ! empty( $details[1] ) ) { |
| [4450](#L4450) | $more\_details[] = array( |
| [4451](#L4451) | 'User Agent', |
| [4452](#L4452) | '<span class="crb-monospace">' . htmlentities( $details[1], ENT\_SUBSTITUTE ) . '</span>' |
| [4453](#L4453) | ); |
| [4454](#L4454) | } |
| [4455](#L4455) |  |
| [4456](#L4456) | // POST fields |
| [4457](#L4457) |  |
| [4458](#L4458) | if ( ! empty( $fields[1] ) ) { |
| [4459](#L4459) | $more\_details[] = array( '', cerber\_table\_view( 'Form fields', $fields[1] ) ); |
| [4460](#L4460) | } |
| [4461](#L4461) |  |
| [4462](#L4462) | // GET fields |
| [4463](#L4463) |  |
| [4464](#L4464) | if ( ! empty( $fields[2] ) ) { |
| [4465](#L4465) | $more\_details[] = array( '', cerber\_table\_view( 'GET fields', $fields[2] ) ); |
| [4466](#L4466) | } |
| [4467](#L4467) |  |
| [4468](#L4468) | // Files |
| [4469](#L4469) |  |
| [4470](#L4470) | $files = array(); |
| [4471](#L4471) | $f = ''; |
| [4472](#L4472) | if ( ! empty( $fields[3] ) ) { |
| [4473](#L4473) |  |
| [4474](#L4474) | foreach ( $fields[3] as $field\_name => $file ) { |
| [4475](#L4475) |  |
| [4476](#L4476) | if ( is\_array( $file['error'] ) ) { |
| [4477](#L4477) | $f\_err = array\_shift( $file['error'] ); |
| [4478](#L4478) | } |
| [4479](#L4479) | else { |
| [4480](#L4480) | $f\_err = $file['error']; |
| [4481](#L4481) | } |
| [4482](#L4482) |  |
| [4483](#L4483) | if ( $f\_err == UPLOAD\_ERR\_NO\_FILE ) { |
| [4484](#L4484) | continue; |
| [4485](#L4485) | } |
| [4486](#L4486) |  |
| [4487](#L4487) | if ( is\_array( $file['name'] ) ) { |
| [4488](#L4488) | $f\_name = array\_shift( $file['name'] ); |
| [4489](#L4489) | } |
| [4490](#L4490) | else { |
| [4491](#L4491) | $f\_name = $file['name']; |
| [4492](#L4492) | } |
| [4493](#L4493) |  |
| [4494](#L4494) | if ( is\_array( $file['size'] ) ) { |
| [4495](#L4495) | $f\_size = array\_shift( $file['size'] ); |
| [4496](#L4496) | } |
| [4497](#L4497) | else { |
| [4498](#L4498) | $f\_size = $file['size']; |
| [4499](#L4499) | } |
| [4500](#L4500) |  |
| [4501](#L4501) | $files[ $field\_name ] = htmlentities( $f\_name, ENT\_SUBSTITUTE ) . ', size: ' . absint( $f\_size ) . ' bytes'; |
| [4502](#L4502) | } |
| [4503](#L4503) |  |
| [4504](#L4504) | if ( ! empty( $files ) ) { |
| [4505](#L4505) | $f = '<span class="crb-ffile">F</span>'; |
| [4506](#L4506) | $more\_details[] = array( '', cerber\_table\_view( 'Files submitted', $files ) ); |
| [4507](#L4507) | } |
| [4508](#L4508) | } |
| [4509](#L4509) |  |
| [4510](#L4510) | // Additional details |
| [4511](#L4511) |  |
| [4512](#L4512) | if ( ! empty( $details[5] ) ) { |
| [4513](#L4513) | $more\_details[] = array( 'XML-RPC Data', htmlentities( $details[5], ENT\_SUBSTITUTE ) ); |
| [4514](#L4514) | } |
| [4515](#L4515) |  |
| [4516](#L4516) | if ( ! empty( $details[6] ) ) { |
| [4517](#L4517) | $more\_details[] = array( '', cerber\_table\_view( 'Request Headers', $details[6] ) ); |
| [4518](#L4518) | } |
| [4519](#L4519) |  |
| [4520](#L4520) | if ( ! empty( $details[10] ) ) { |
| [4521](#L4521) | $list = array(); |
| [4522](#L4522) | foreach ( $details[10] as $item ) { |
| [4523](#L4523) | $e = explode( ':', $item, 2 ); |
| [4524](#L4524) | /\* $key = ( isset( $list[ $e[0] ] ) ) ? $e[0] . '&nbsp;' : $e[0]; |
| [4525](#L4525) | $list[ $key ] = $e[1];\*/ |
| [4526](#L4526) | $list[] = array( $e[0] => $e[1] ); |
| [4527](#L4527) | } |
| [4528](#L4528) | $more\_details[] = array( '', cerber\_table\_view( 'Response Headers', $list ) ); |
| [4529](#L4529) | } |
| [4530](#L4530) |  |
| [4531](#L4531) | if ( ! empty( $details[8] ) ) { |
| [4532](#L4532) | $more\_details[] = array( '', cerber\_table\_view( 'Request Cookies', $details[8] ) ); |
| [4533](#L4533) | } |
| [4534](#L4534) |  |
| [4535](#L4535) | if ( ! empty( $details[9] ) ) { |
| [4536](#L4536) | $start = strlen( 'Set-Cookie:' ); |
| [4537](#L4537) | $list = array(); |
| [4538](#L4538) | foreach ( $details[9] as $item ) { |
| [4539](#L4539) | if ( $e = explode( '=', substr( $item, $start ), 2 ) ) { |
| [4540](#L4540) | $list[ $e[0] ] = $e[1]; |
| [4541](#L4541) | } |
| [4542](#L4542) | } |
| [4543](#L4543) | $more\_details[] = array( '', cerber\_table\_view( 'Response Cookies', $list ) ); |
| [4544](#L4544) | } |
| [4545](#L4545) |  |
| [4546](#L4546) | if ( ! empty( $details[7] ) ) { |
| [4547](#L4547) | $more\_details[] = array( '', cerber\_table\_view( '$\_SERVER', $details[7] ) ); |
| [4548](#L4548) | } |
| [4549](#L4549) |  |
| [4550](#L4550) | $php\_errors = ''; |
| [4551](#L4551) | if ( $err\_list = crb\_auto\_decode( $row->php\_errors ) ) { |
| [4552](#L4552) | $errors = array(); |
| [4553](#L4553) | foreach ( $err\_list as $err ) { |
| [4554](#L4554) | $errors[] = array( |
| [4555](#L4555) | 'type' => cerber\_get\_err\_type( $err[0] ) . ' (' . $err[0] . ')', |
| [4556](#L4556) | 'info' => $err[1], |
| [4557](#L4557) | 'file' => $err[2], |
| [4558](#L4558) | 'line' => $err[3] |
| [4559](#L4559) | ); |
| [4560](#L4560) | } |
| [4561](#L4561) | $more\_details[] = array( '', cerber\_table\_view( 'Software errors', $errors ) ); |
| [4562](#L4562) | $php\_errors = '<span class="crb-php-error">SE &nbsp;' . count( $err\_list ) . '</span>'; |
| [4563](#L4563) | } |
| [4564](#L4564) |  |
| [4565](#L4565) | $req\_status = ''; |
| [4566](#L4566) | if ( ! empty( $row->req\_status ) ) { |
| [4567](#L4567) | $req\_status = '<span class="crb-req-status-' . $row->req\_status . '">' . $status\_labels[ $row->req\_status ] . '</span>'; |
| [4568](#L4568) | } |
| [4569](#L4569) |  |
| [4570](#L4570) | $request\_details = ''; |
| [4571](#L4571) | $more\_link = ''; |
| [4572](#L4572) | $toggle\_class = ''; |
| [4573](#L4573) |  |
| [4574](#L4574) | if ( $more\_details ) { |
| [4575](#L4575) | foreach ( $more\_details as $d ) { |
| [4576](#L4576) | if ( $d[0] ) { |
| [4577](#L4577) | $request\_details .= '<div style="margin-bottom: 1.5em;"><p style="font-weight: bold;">' . $d[0] . '</p>' . $d[1] . '</div>'; |
| [4578](#L4578) | } |
| [4579](#L4579) | else { |
| [4580](#L4580) | $request\_details .= $d[1]; |
| [4581](#L4581) | } |
| [4582](#L4582) | } |
| [4583](#L4583) | $more\_link = '<a href="#" onclick="return false;" class="crb-traffic-more">Details</a>'; |
| [4584](#L4584) | $toggle\_class = 'crb-toggle'; |
| [4585](#L4585) | } |
| [4586](#L4586) |  |
| [4587](#L4587) | $request = '<b>' . $row\_uri . '</b>' . '<p style="margin-top:1em;"><span class="crb-' . $row->request\_method . '">' . $row->request\_method . '</span>' . $f . $wp\_type . '<span class="crb-' . $row->http\_code . '"> HTTP ' . $row->http\_code . ' ' . get\_status\_header\_desc( $row->http\_code ) . '</span>' . $req\_status . $php\_errors . '<span>' . $processing . '</span> ' . $more\_link . ' ' . $activity . ' </p>' . $wp\_obj; |
| [4588](#L4588) |  |
| [4589](#L4589) | // Decorating this table can't be done via simple CSS |
| [4590](#L4590) | if ( ! empty( $even ) ) { |
| [4591](#L4591) | $class = 'crb-even'; |
| [4592](#L4592) | $even = false; |
| [4593](#L4593) | } |
| [4594](#L4594) | else { |
| [4595](#L4595) | $even = true; |
| [4596](#L4596) | $class = 'crb-odd'; |
| [4597](#L4597) | } |
| [4598](#L4598) |  |
| [4599](#L4599) | $tbody .= '<tr class="' . $class . ' ' . $toggle\_class . '"> |
| [4600](#L4600) | <td>' . $date . '</td> |
| [4601](#L4601) | <td class="crb-request">' . $request . '</td> |
| [4602](#L4602) | <td>' . crb\_admin\_ip\_cell( $row->ip, $base\_url . '&amp;filter\_ip=' . $row->ip ) . '</td> |
| [4603](#L4603) | <td>' . $hostname . $country . '</td> |
| [4604](#L4604) | <td>' . cerber\_detect\_browser( $details[1] ) . '</td> |
| [4605](#L4605) | <td>' . $name . '</td></tr>'; |
| [4606](#L4606) |  |
| [4607](#L4607) | $tbody .= '<tr class="' . $class . '" style="display: none;"><td></td><td colspan="5" class="crb-traffic-details" data-session-id="' . $row->session\_id . '"><div>' . $request\_details . '</div></td></tr>'; |
| [4608](#L4608) | } |
| [4609](#L4609) |  |
| [4610](#L4610) | $heading = array( |
| [4611](#L4611) | 'crb\_date\_col'     => \_\_( 'Date', 'wp-cerber' ), |
| [4612](#L4612) | 'crb\_request\_col'  => \_\_( 'Request', 'wp-cerber' ), |
| [4613](#L4613) | 'crb\_ip\_col'       => '<div class="crb\_act\_icon"></div>' . \_\_( 'IP Address', 'wp-cerber' ), |
| [4614](#L4614) | 'crb\_hostinfo\_col' => \_\_( 'Host Info', 'wp-cerber' ), |
| [4615](#L4615) | 'crb\_ua\_col'       => \_\_( 'User Agent', 'wp-cerber' ), |
| [4616](#L4616) | 'crb\_user\_col'     => \_\_( 'Local User', 'wp-cerber' ), |
| [4617](#L4617) | ); |
| [4618](#L4618) |  |
| [4619](#L4619) | $titles\_head = ''; |
| [4620](#L4620) | foreach ( $heading as $id => $title ) { |
| [4621](#L4621) | $titles\_head .= '<th id="' . $id . '">' . $title . '</th>'; |
| [4622](#L4622) | } |
| [4623](#L4623) |  |
| [4624](#L4624) | $titles\_foot = '<th>' . implode( '</th><th>', $heading ) . '</th>'; |
| [4625](#L4625) |  |
| [4626](#L4626) | $table = '<table id="crb-traffic" class="widefat crb-table cerber-margin"><thead><tr>' . $titles\_head . '</tr></thead><tfoot><tr>' . $titles\_foot . '</tr></tfoot><tbody>' . $tbody . '</tbody></table>'; |
| [4627](#L4627) |  |
| [4628](#L4628) | if ( empty( $args['no\_navi'] ) ) { |
| [4629](#L4629) | $table .= cerber\_page\_navi( $total, $per\_page ); |
| [4630](#L4630) | } |
| [4631](#L4631) |  |
| [4632](#L4632) | //$legend  = '<p>'.sprintf(\_\_('Showing last %d records from %d','wp-cerber'),count($rows),$total); |
| [4633](#L4633) |  |
| [4634](#L4634) | //if (empty($args['no\_export'])) $export\_link = '<a class="button button-secondary cerber-button" href="'.wp\_nonce\_url(add\_query\_arg('export\_activity',1),'control','cerber\_nonce').'"><span class="dashicons dashicons-download" style="vertical-align: middle;"></span> '.\_\_('Export','wp-cerber').'</a>'; |
| [4635](#L4635) | } |
| [4636](#L4636) | else { |
| [4637](#L4637) |  |
| [4638](#L4638) | $no\_results = true; |
| [4639](#L4639) |  |
| [4640](#L4640) | $is\_search = ( array\_intersect\_key( CRB\_TRF\_PARAMS, crb\_get\_query\_params() ) ); |
| [4641](#L4641) |  |
| [4642](#L4642) | $hints = array(); |
| [4643](#L4643) |  |
| [4644](#L4644) | if ( ! $is\_search ) { |
| [4645](#L4645) | $hints[] = \_\_( 'No requests have been logged yet.', 'wp-cerber' ); |
| [4646](#L4646) | } |
| [4647](#L4647) | else { |
| [4648](#L4648) | $hints[] = \_\_( 'No requests found using the given search criteria', 'wp-cerber' ); |
| [4649](#L4649) | if ( ! $is\_log\_empty ) { |
| [4650](#L4650) | $hints[] = '<a href="' . $base\_url . '">' . \_\_( 'View all logged requests', 'wp-cerber' ) . '</a>'; |
| [4651](#L4651) | } |
| [4652](#L4652) | } |
| [4653](#L4653) |  |
| [4654](#L4654) | if ( ! $logging\_enabled ) { |
| [4655](#L4655) | $hints[] = \_\_( 'Note: Logging is currently disabled', 'wp-cerber' ); |
| [4656](#L4656) | if ( ! $is\_search ) { |
| [4657](#L4657) | $hints[] = '<a href="https://wpcerber.com/wordpress-traffic-logging/" target="\_blank">' . \_\_( 'Documentation', 'wp-cerber' ) . '</a>'; |
| [4658](#L4658) | } |
| [4659](#L4659) | } |
| [4660](#L4660) |  |
| [4661](#L4661) | $table = '<div class="cerber-margin crb-rectangle"><p>' . implode( '</p><p>', $hints ) . '</p></div>'; |
| [4662](#L4662) |  |
| [4663](#L4663) | if ( $is\_log\_empty ) { |
| [4664](#L4664) | cerber\_watchdog( true ); |
| [4665](#L4665) | } |
| [4666](#L4666) | } |
| [4667](#L4667) |  |
| [4668](#L4668) | if ( empty( $args['no\_navi'] ) ) { |
| [4669](#L4669) |  |
| [4670](#L4670) | $filter\_links = ''; |
| [4671](#L4671) | $search\_button = ''; |
| [4672](#L4672) |  |
| [4673](#L4673) | if ( ! $is\_log\_empty ) { |
| [4674](#L4674) |  |
| [4675](#L4675) | $nav\_links = array(); |
| [4676](#L4676) | $nav\_links[] = array( array(), \_\_( 'View all', 'wp-cerber' ) ); |
| [4677](#L4677) | $nav\_links[] = array( array( 'filter\_set' => 1 ), \_\_( 'Suspicious requests', 'wp-cerber' ) ); |
| [4678](#L4678) | $nav\_links[] = array( array( 'filter\_http\_code' => 399, 'filter\_http\_code\_mode' => 'GT' ), \_\_( 'Errors', 'wp-cerber' ) ); |
| [4679](#L4679) | $nav\_links[] = array( array( 'filter\_user' => '\*' ), \_\_( 'Users', 'wp-cerber' ) ); |
| [4680](#L4680) | $nav\_links[] = array( array( 'filter\_user' => 0 ), \_\_( 'Non-authenticated', 'wp-cerber' ) ); |
| [4681](#L4681) | $nav\_links[] = array( array( 'filter\_method' => 'POST', 'filter\_wp\_type' => 519, 'filter\_wp\_type\_mode' => 'GT' ), \_\_( 'Form submissions', 'wp-cerber' ) ); |
| [4682](#L4682) | $nav\_links[] = array( array( 'filter\_http\_code' => 404 ), \_\_( 'Page Not Found', 'wp-cerber' ) ); |
| [4683](#L4683) | $nav\_links[] = array( array( 'filter\_wp\_type' => 520 ), 'REST API' ); |
| [4684](#L4684) | $nav\_links[] = array( array( 'filter\_wp\_type' => 515 ), 'XML-RPC' ); |
| [4685](#L4685) | $nav\_links[] = array( array( 'filter\_user' => get\_current\_user\_id() ), \_\_( 'My requests', 'wp-cerber' ) ); |
| [4686](#L4686) | $nav\_links[] = array( array( 'filter\_ip' => cerber\_get\_remote\_ip() ), \_\_( 'My IP', 'wp-cerber' ) ); |
| [4687](#L4687) |  |
| [4688](#L4688) | if ( $threshold = crb\_get\_settings( 'tithreshold' ) ) { |
| [4689](#L4689) | $nav\_links[] = array( array( 'filter\_processing' => $threshold ), \_\_( 'Longer than', 'wp-cerber' ) . ' ' . $threshold . ' ms' ); |
| [4690](#L4690) | } |
| [4691](#L4691) |  |
| [4692](#L4692) | $filter\_links = crb\_make\_nav\_links( $nav\_links, 'traffic' ); |
| [4693](#L4693) |  |
| [4694](#L4694) | $search\_button = '<a href="#" id="traffic-search-btn" class="button button-secondary cerber-button" title="Search in the request history"><i class="crb-icon crb-icon-bx-search"></i> ' . \_\_( 'Advanced Search', 'wp-cerber' ) . '</a>'; |
| [4695](#L4695) | } |
| [4696](#L4696) |  |
| [4697](#L4697) | $export\_button = ''; |
| [4698](#L4698) | if ( ! $no\_results ) { |
| [4699](#L4699) | $export\_button .= '<a class="button button-secondary cerber-button" href="' . |
| [4700](#L4700) | cerber\_admin\_link\_add( array( |
| [4701](#L4701) | 'cerber\_admin\_do' => 'export', |
| [4702](#L4702) | 'type'            => 'traffic', |
| [4703](#L4703) | ), true ) |
| [4704](#L4704) | . '"><i class="crb-icon crb-icon-bx-download"></i> ' . \_\_( 'Export', 'wp-cerber' ) . '</a>'; |
| [4705](#L4705) |  |
| [4706](#L4706) | } |
| [4707](#L4707) |  |
| [4708](#L4708) | $right\_links = $search\_button . ' ' . $export\_button; |
| [4709](#L4709) |  |
| [4710](#L4710) | $refresh = ''; |
| [4711](#L4711) | if ( $logging\_enabled && ! $no\_results ) { |
| [4712](#L4712) | $refresh = '<a href="" style="white-space: pre;"><i class="dashicons dashicons-update" style=""></i> <span>' . \_\_( 'Refresh', 'wp-cerber' ) . '</span></a>'; |
| [4713](#L4713) | } |
| [4714](#L4714) |  |
| [4715](#L4715) | $top\_bar = '<div id = "activity-filter"><div><div style="display: table-cell; width: 80%;">' . $filter\_links . '</div><div style="display: table-cell;">' . $refresh . '</div></div><div>' . $right\_links . '</div></div><br style="clear: both;">'; |
| [4716](#L4716) |  |
| [4717](#L4717) | $ret = '<div class="cerber-margin">' . $top\_bar . crb\_admin\_traffic\_search\_form() . $info . '</div>' . $ret; |
| [4718](#L4718) | } |
| [4719](#L4719) |  |
| [4720](#L4720) | $ret .= $table; |
| [4721](#L4721) |  |
| [4722](#L4722) | if ( ! $logging\_enabled && ! $no\_results ) { |
| [4723](#L4723) | $ret = '<p class="cerber-margin" style="padding: 0.5em; font-weight: bold;">Logging is currently disabled, you are viewing  historical information.</p>' . $ret; |
| [4724](#L4724) | } |
| [4725](#L4725) |  |
| [4726](#L4726) | if ( $echo ) { |
| [4727](#L4727) | echo $ret; |
| [4728](#L4728) | } |
| [4729](#L4729) | else { |
| [4730](#L4730) | return $ret; |
| [4731](#L4731) | } |
| [4732](#L4732) |  |
| [4733](#L4733) | } |
| [4734](#L4734) |  |
| [4735](#L4735) | /\*\* |
| [4736](#L4736) | \* Detects known browsers/crawlers and platform in User Agent string |
| [4737](#L4737) | \* |
| [4738](#L4738) | \* @param $ua |
| [4739](#L4739) | \* |
| [4740](#L4740) | \* @return string Sanitized browser name and platform on success |
| [4741](#L4741) | \* @since 6.0 |
| [4742](#L4742) | \*/ |
| [4743](#L4743) | function cerber\_detect\_browser( $ua ) { |
| [4744](#L4744) | $ua  = trim( $ua ); |
| [4745](#L4745) |  |
| [4746](#L4746) | if ( empty( $ua ) ) { |
| [4747](#L4747) | return \_\_( 'Not specified', 'wp-cerber' ); |
| [4748](#L4748) | } |
| [4749](#L4749) |  |
| [4750](#L4750) | if ( preg\_match( '/\(compatible\;(.+)\)/i', $ua, $matches ) ) { |
| [4751](#L4751) | $bot\_info = explode( ';', $matches[1] ); |
| [4752](#L4752) | foreach ( $bot\_info as $item ) { |
| [4753](#L4753) | if ( stripos( $item, 'bot' ) |
| [4754](#L4754) | || stripos( $item, 'crawler' ) |
| [4755](#L4755) | || stripos( $item, 'spider' ) |
| [4756](#L4756) | || stripos( $item, 'Yandex' ) |
| [4757](#L4757) | || stripos( $item, 'Yahoo! Slurp' ) |
| [4758](#L4758) | ) { |
| [4759](#L4759) | if ( strpos( $ua, 'Android' ) ) { |
| [4760](#L4760) | $item .= ' Mobile'; |
| [4761](#L4761) | } |
| [4762](#L4762) | return htmlentities( $item, ENT\_SUBSTITUTE ); |
| [4763](#L4763) | } |
| [4764](#L4764) | } |
| [4765](#L4765) | if ( strpos( $ua, 'Google-Read-Aloud' ) ) { |
| [4766](#L4766) | return 'Google Read Aloud'; |
| [4767](#L4767) | } |
| [4768](#L4768) | } |
| [4769](#L4769) | elseif ( strpos( $ua, 'google.com' ) || strpos( $ua, 'Google' ) ) { |
| [4770](#L4770) | // Various Google bots |
| [4771](#L4771) |  |
| [4772](#L4772) | $ret = ''; |
| [4773](#L4773) |  |
| [4774](#L4774) | if ( false !== strpos( $ua, 'Googlebot' ) ) { |
| [4775](#L4775) | if ( strpos( $ua, 'Android' ) ) { |
| [4776](#L4776) | $ret = 'Googlebot Mobile'; |
| [4777](#L4777) | } |
| [4778](#L4778) | elseif ( false !== strpos( $ua, 'Mozilla' ) ) { |
| [4779](#L4779) | $ret = 'Googlebot Desktop'; |
| [4780](#L4780) | } |
| [4781](#L4781) | } |
| [4782](#L4782) | elseif ( preg\_match( '/AdsBot-Google-Mobile|AdsBot-Google|APIs-Google|FeedFetcher-Google/', $ua, $matches ) ) { |
| [4783](#L4783) | $ret = $matches[0]; |
| [4784](#L4784) | } |
| [4785](#L4785) | elseif ( 0 === strpos( $ua, 'Googlebot' ) ) { |
| [4786](#L4786) | if ( preg\_match( '/Googlebot-\w+/', $ua, $matches ) ) { |
| [4787](#L4787) | $ret = $matches[0]; |
| [4788](#L4788) | } |
| [4789](#L4789) | } |
| [4790](#L4790) | elseif ( 0 === strpos( $ua, 'Mediapartners-Google' ) ) { |
| [4791](#L4791) | return 'AdSense Crawler'; |
| [4792](#L4792) | } |
| [4793](#L4793) | elseif ( 0 === strpos( $ua, 'AdsBot-Google-Mobile-Apps' ) ) { |
| [4794](#L4794) | return 'Mobile Apps Android'; |
| [4795](#L4795) | } |
| [4796](#L4796) | elseif ( strpos( $ua, 'DuplexWeb-Google' ) ) { |
| [4797](#L4797) | return 'Duplex on the Web by Google'; |
| [4798](#L4798) | } |
| [4799](#L4799) | elseif ( strpos( $ua, 'Google Favicon' ) ) { |
| [4800](#L4800) | return 'Google Favicon'; |
| [4801](#L4801) | } |
| [4802](#L4802) |  |
| [4803](#L4803) | if ( $ret ) { |
| [4804](#L4804) | return htmlentities( $ret, ENT\_SUBSTITUTE ); |
| [4805](#L4805) | } |
| [4806](#L4806) | else { |
| [4807](#L4807) | return \_\_( 'Unknown Google\'s bot', 'wp-cerber' ); |
| [4808](#L4808) | } |
| [4809](#L4809) | } |
| [4810](#L4810) | /\*elseif ( 0 === strpos( $ua, 'Googlebot' ) ) { |
| [4811](#L4811) | if ( preg\_match( '/Googlebot-\w+/', $ua, $matches ) ) { |
| [4812](#L4812) | return $matches[0]; |
| [4813](#L4813) | } |
| [4814](#L4814) | }\*/ |
| [4815](#L4815) | elseif ( 0 === strpos( $ua, 'WordPress/' ) ) { |
| [4816](#L4816) | list( $ret ) = explode( ';', $ua, 2 ); |
| [4817](#L4817) | return htmlentities( $ret, ENT\_SUBSTITUTE ); |
| [4818](#L4818) | } |
| [4819](#L4819) | elseif ( 0 === strpos( $ua, 'PayPal IPN' ) ) { |
| [4820](#L4820) | return 'PayPal Payment Notification'; |
| [4821](#L4821) | } |
| [4822](#L4822) | elseif (0 === strpos( $ua, 'Wget/' )){ |
| [4823](#L4823) | return htmlentities( $ua, ENT\_SUBSTITUTE ); |
| [4824](#L4824) | } |
| [4825](#L4825) | elseif ( strpos( $ua, 'googleweblight' )){ |
| [4826](#L4826) | return 'Web Light by Google'; |
| [4827](#L4827) | } |
| [4828](#L4828) |  |
| [4829](#L4829) | $browsers = array( |
| [4830](#L4830) | 'Firefox/'   => 'Firefox', |
| [4831](#L4831) | 'OPR/'       => 'Opera', |
| [4832](#L4832) | 'Opera/'     => 'Opera', |
| [4833](#L4833) | 'YaBrowser/' => 'Yandex Browser', |
| [4834](#L4834) | 'Trident/'   => 'Internet Explorer', |
| [4835](#L4835) | 'IE/'        => 'Internet Explorer', |
| [4836](#L4836) | 'Edge/'      => 'Microsoft Edge', |
| [4837](#L4837) | 'Edg/'       => 'Microsoft Edge', |
| [4838](#L4838) | 'Chrome/'    => 'Chrome', |
| [4839](#L4839) | 'Safari/'    => 'Safari', |
| [4840](#L4840) | 'Lynx/'      => 'Lynx', |
| [4841](#L4841) | ); |
| [4842](#L4842) |  |
| [4843](#L4843) | $systems  = array( 'Android' , 'Linux', 'Windows', 'iPhone', 'iPad', 'Macintosh', 'OpenBSD', 'Unix' ); |
| [4844](#L4844) |  |
| [4845](#L4845) | $browser = ''; |
| [4846](#L4846) | foreach ( $browsers as $browser\_id => $browser\_name ) { |
| [4847](#L4847) | if ( false !== strpos( $ua, $browser\_id ) ) { |
| [4848](#L4848) | $browser = $browser\_name; |
| [4849](#L4849) | break; |
| [4850](#L4850) | } |
| [4851](#L4851) | } |
| [4852](#L4852) |  |
| [4853](#L4853) | $system = ''; |
| [4854](#L4854) | foreach ( $systems as $system\_id ) { |
| [4855](#L4855) | if ( false !== strpos( $ua, $system\_id ) ) { |
| [4856](#L4856) | $system = $system\_id; |
| [4857](#L4857) | break; |
| [4858](#L4858) | } |
| [4859](#L4859) | } |
| [4860](#L4860) |  |
| [4861](#L4861) | if ( $browser == 'Lynx' && ! $system ) { |
| [4862](#L4862) | $system = 'Linux'; |
| [4863](#L4863) | } |
| [4864](#L4864) | elseif ( $system == 'Macintosh' ) { |
| [4865](#L4865) | $system = 'Mac'; |
| [4866](#L4866) | } |
| [4867](#L4867) |  |
| [4868](#L4868) | if ( $system == 'Android' ) { |
| [4869](#L4869) | if ( preg\_match( '/(Android\s+\d+);/', $ua, $matches ) ) { |
| [4870](#L4870) | $system = $matches[1]; |
| [4871](#L4871) | } |
| [4872](#L4872) | } |
| [4873](#L4873) |  |
| [4874](#L4874) | if ( $browser && $system ) { |
| [4875](#L4875) | $ret = $browser . ' on ' . $system; |
| [4876](#L4876) | } |
| [4877](#L4877) | elseif ( 0 === strpos( $ua, 'python-requests' ) ) { |
| [4878](#L4878) | $ret = 'Python Script'; |
| [4879](#L4879) | } |
| [4880](#L4880) | elseif ( 0 === strpos( $ua, 'ApacheBench' ) ) { |
| [4881](#L4881) | $ret = $ua; |
| [4882](#L4882) | } |
| [4883](#L4883) | else { |
| [4884](#L4884) | $ret = \_\_( 'Unknown', 'wp-cerber' ); |
| [4885](#L4885) | } |
| [4886](#L4886) |  |
| [4887](#L4887) | return htmlentities( $ret, ENT\_SUBSTITUTE ); |
| [4888](#L4888) | } |
| [4889](#L4889) |  |
| [4890](#L4890) | /\*\* |
| [4891](#L4891) | \* Create a table view of an array to display it |
| [4892](#L4892) | \* |
| [4893](#L4893) | \* @param $title |
| [4894](#L4894) | \* @param $fields |
| [4895](#L4895) | \* |
| [4896](#L4896) | \* @return string |
| [4897](#L4897) | \*/ |
| [4898](#L4898) | function cerber\_table\_view( $title, $fields, $sub\_key = null ) { |
| [4899](#L4899) | if ( empty( $fields ) ) { |
| [4900](#L4900) | return ''; |
| [4901](#L4901) | } |
| [4902](#L4902) |  |
| [4903](#L4903) | if ( ! isset( $sub\_key ) ) { |
| [4904](#L4904) | $class = 'crb-fields-table crb-top-table'; |
| [4905](#L4905) | } |
| [4906](#L4906) | else { |
| [4907](#L4907) | $class = 'crb-fields-table crb-sub-table'; |
| [4908](#L4908) | } |
| [4909](#L4909) |  |
| [4910](#L4910) | $view = '<table class="' . $class . '">'; |
| [4911](#L4911) |  |
| [4912](#L4912) | if ( $title ) { |
| [4913](#L4913) | $view .= '<tr><td colspan="2" style="font-weight: 500">' . $title . '</td></tr>'; |
| [4914](#L4914) | } |
| [4915](#L4915) |  |
| [4916](#L4916) | $i = 1; |
| [4917](#L4917) | foreach ( $fields as $key => $value ) { |
| [4918](#L4918) | if ( is\_array( $value ) ) { |
| [4919](#L4919) | $view .= '<tr><td>' . htmlentities( $key, ENT\_SUBSTITUTE ) . '</td><td>' . cerber\_table\_view( '', $value, $key ) . '</td></tr>'; |
| [4920](#L4920) | } |
| [4921](#L4921) | else { |
| [4922](#L4922) | $view .= '<tr><td>' . htmlentities( $key, ENT\_SUBSTITUTE ) . '</td><td><div>' . nl2br( htmlentities( $value, ENT\_SUBSTITUTE ) ) . '</div></td></tr>'; |
| [4923](#L4923) | } |
| [4924](#L4924) | $i ++; |
| [4925](#L4925) | } |
| [4926](#L4926) |  |
| [4927](#L4927) | $view .= '</table>'; |
| [4928](#L4928) |  |
| [4929](#L4929) | return $view; |
| [4930](#L4930) | } |
| [4931](#L4931) |  |
| [4932](#L4932) | /\*\* |
| [4933](#L4933) | \* Parse arguments and create SQL query for retrieving rows from the traffic table |
| [4934](#L4934) | \* |
| [4935](#L4935) | \* @param array $args Optional arguments to use them instead of using $\_GET |
| [4936](#L4936) | \* |
| [4937](#L4937) | \* @return array |
| [4938](#L4938) | \* @since 6.0 |
| [4939](#L4939) | \*/ |
| [4940](#L4940) | function cerber\_traffic\_query( $args = array() ) { |
| [4941](#L4941) | global $wpdb; |
| [4942](#L4942) |  |
| [4943](#L4943) | $ret = array\_fill( 0, 8, '' ); |
| [4944](#L4944) | $where = array(); |
| [4945](#L4945) | $join = ''; |
| [4946](#L4946) | $join\_act = false; |
| [4947](#L4947) |  |
| [4948](#L4948) | $q = crb\_admin\_parse\_query( array\_keys( CRB\_TRF\_PARAMS ), $args ); |
| [4949](#L4949) |  |
| [4950](#L4950) | if ( preg\_match( '/^\w+$/', $q->filter\_sid ) ) { |
| [4951](#L4951) | $where[] = 'log.session\_id = "' . $q->filter\_sid . '"'; |
| [4952](#L4952) | } |
| [4953](#L4953) |  |
| [4954](#L4954) | $falist = array(); |
| [4955](#L4955) | if ( $q->filter\_http\_code ) { // Multiple codes can be requested this way: &filter\_http\_code[]=404&filter\_http\_code[]=405 |
| [4956](#L4956) | if ( is\_array( $q->filter\_http\_code ) ) { |
| [4957](#L4957) | $falist  = array\_filter( array\_map( 'absint', $q->filter\_http\_code ) ); |
| [4958](#L4958) | $where[] = 'log.http\_code IN (' . implode( ',', $falist ) . ')'; |
| [4959](#L4959) | } |
| [4960](#L4960) | else { |
| [4961](#L4961) | $filter  = absint( $q->filter\_http\_code ); |
| [4962](#L4962) | $op = '='; |
| [4963](#L4963) | if ( $q->filter\_http\_code\_mode == 'GT' ) { |
| [4964](#L4964) | $op = '>'; |
| [4965](#L4965) | } |
| [4966](#L4966) | $where[] = 'log.http\_code ' . $op . $filter; |
| [4967](#L4967) | $falist  = array( $filter ); // for further using in links |
| [4968](#L4968) | } |
| [4969](#L4969) | } |
| [4970](#L4970) | //$ret[3] = $falist; |
| [4971](#L4971) |  |
| [4972](#L4972) | if ( $q->filter\_ip ) { |
| [4973](#L4973) | $range = cerber\_any2range( $q->filter\_ip ); |
| [4974](#L4974) | if ( is\_array( $range ) ) { |
| [4975](#L4975) | $where[] = '(log.ip\_long >= ' . $range['begin'] . ' AND log.ip\_long <= ' . $range['end'] . ')'; |
| [4976](#L4976) | } |
| [4977](#L4977) | elseif ( cerber\_is\_ip\_or\_net( $q->filter\_ip ) ) { |
| [4978](#L4978) | $where[] = 'log.ip = "' . $q->filter\_ip . '"'; |
| [4979](#L4979) | } |
| [4980](#L4980) | else { |
| [4981](#L4981) | $where[] = "log.ip = 'produce-no-result'"; |
| [4982](#L4982) | } |
| [4983](#L4983) | $ret[4] = preg\_replace( CRB\_IP\_NET\_RANGE, '', $q->filter\_ip ); |
| [4984](#L4984) | } |
| [4985](#L4985) |  |
| [4986](#L4986) | if ( $q->filter\_processing ) { |
| [4987](#L4987) | $p       = absint( $q->filter\_processing ); |
| [4988](#L4988) | $where[] = 'log.processing > ' . $p; |
| [4989](#L4989) | $ret[5]  = $p; |
| [4990](#L4990) | } |
| [4991](#L4991) |  |
| [4992](#L4992) | $filter\_user = false; |
| [4993](#L4993) |  |
| [4994](#L4994) | if ( $q->filter\_user !== false ) { |
| [4995](#L4995) | $filter\_user = $q->filter\_user; |
| [4996](#L4996) | } |
| [4997](#L4997) | elseif ( $q->filter\_user\_alt !== false ) { |
| [4998](#L4998) | $filter\_user = $q->filter\_user\_alt; |
| [4999](#L4999) | } |
| [5000](#L5000) |  |
| [5001](#L5001) | if ( $filter\_user !== false ) { |
| [5002](#L5002) | if ( $filter\_user == '\*' ) { |
| [5003](#L5003) | $um      = ( ! empty( $q->filter\_user\_mode ) ) ? '=' : '!='; |
| [5004](#L5004) | $where[] = 'log.user\_id ' . $um . ' 0'; |
| [5005](#L5005) | $ret[6]  = '\*'; |
| [5006](#L5006) | } |
| [5007](#L5007) | elseif ( preg\_match\_all( '/\d+/', $filter\_user, $matches ) ) { |
| [5008](#L5008) | $users = implode( ',', $matches[0] ); |
| [5009](#L5009) |  |
| [5010](#L5010) | if ( ! empty( $q->filter\_user\_mode ) ) { |
| [5011](#L5011) | $um = 'NOT IN'; |
| [5012](#L5012) | } |
| [5013](#L5013) | else { |
| [5014](#L5014) | $um     = 'IN'; |
| [5015](#L5015) | $ret[6] = $users; |
| [5016](#L5016) | } |
| [5017](#L5017) |  |
| [5018](#L5018) | $where[] = 'log.user\_id ' . $um . ' (' . $users . ')'; |
| [5019](#L5019) | } |
| [5020](#L5020) | } |
| [5021](#L5021) |  |
| [5022](#L5022) | if ( $q->filter\_wp\_type ) { |
| [5023](#L5023) | $t      = absint( $q->filter\_wp\_type ); |
| [5024](#L5024) | $ret[7] = $t; |
| [5025](#L5025) | $op     = '='; |
| [5026](#L5026) | if ( $q->filter\_wp\_type\_mode == 'GT' ) { |
| [5027](#L5027) | $op = '>'; |
| [5028](#L5028) | } |
| [5029](#L5029) |  |
| [5030](#L5030) | $where[] = 'log.wp\_type ' . $op . $t; |
| [5031](#L5031) | } |
| [5032](#L5032) |  |
| [5033](#L5033) | if ( $q->search\_traffic ) { |
| [5034](#L5034) | $search = stripslashes\_deep( $q->search\_traffic ); |
| [5035](#L5035) | if ( $search['ip'] ) { |
| [5036](#L5036) | if ( $ip = filter\_var( $search['ip'], FILTER\_VALIDATE\_IP ) ) { |
| [5037](#L5037) | $where[] = 'log.ip = "' . $ip . '"'; |
| [5038](#L5038) | $ret[4] = $ip; |
| [5039](#L5039) | } |
| [5040](#L5040) | else { |
| [5041](#L5041) | $where[] = 'log.ip LIKE "%' . cerber\_real\_escape( $search['ip'] ) . '%"'; |
| [5042](#L5042) | } |
| [5043](#L5043) | } |
| [5044](#L5044) | if ( $search['uri'] ) { |
| [5045](#L5045) | $where[] = 'log.uri LIKE "%' . cerber\_real\_escape( $search['uri'] ) . '%"'; |
| [5046](#L5046) | } |
| [5047](#L5047) | if ( $search['fields'] ) { |
| [5048](#L5048) | $where[] = 'log.request\_fields LIKE "%' . cerber\_real\_escape( $search['fields'] ) . '%"'; |
| [5049](#L5049) | } |
| [5050](#L5050) | if ( $search['details'] ) { |
| [5051](#L5051) | $where[] = 'log.request\_details LIKE "%' . cerber\_real\_escape( $search['details'] ) . '%"'; |
| [5052](#L5052) | } |
| [5053](#L5053) | if ( $search['date\_from'] ) { |
| [5054](#L5054) | if ( $stamp = strtotime( 'midnight ' . $search['date\_from'] ) ) { |
| [5055](#L5055) | $gmt\_offset = get\_option( 'gmt\_offset' ) \* 3600; |
| [5056](#L5056) | $where[]    = 'log.stamp >= ' . ( absint( $stamp ) - $gmt\_offset ); |
| [5057](#L5057) | } |
| [5058](#L5058) | } |
| [5059](#L5059) | if ( $search['date\_to'] ) { |
| [5060](#L5060) | if ( $stamp = 24 \* 3600 + strtotime( 'midnight ' . $search['date\_to'] ) ) { |
| [5061](#L5061) | $gmt\_offset = get\_option( 'gmt\_offset' ) \* 3600; |
| [5062](#L5062) | $where[]    = 'log.stamp <= ' . ( absint( $stamp ) - $gmt\_offset ); |
| [5063](#L5063) | } |
| [5064](#L5064) | } |
| [5065](#L5065) | if ( ! $q->filter\_errors && $search['errors'] ) { |
| [5066](#L5066) | $where[] = 'log.php\_errors LIKE "%' . cerber\_real\_escape( $search['errors'] ) . '%"'; |
| [5067](#L5067) | } |
| [5068](#L5068) | } |
| [5069](#L5069) |  |
| [5070](#L5070) | if ( $q->filter\_method ) { |
| [5071](#L5071) | $where[] = $wpdb->prepare( 'log.request\_method = %s', $q->filter\_method ); |
| [5072](#L5072) | } |
| [5073](#L5073) |  |
| [5074](#L5074) | $activity = null; |
| [5075](#L5075) | if ( $q->filter\_activity ) { |
| [5076](#L5076) | $activity = absint( $q->filter\_activity ); |
| [5077](#L5077) | } |
| [5078](#L5078) | if ( $q->filter\_set ) { |
| [5079](#L5079) | $activity = implode( ',', crb\_get\_filter\_set( $q->filter\_set ) ); |
| [5080](#L5080) | } |
| [5081](#L5081) | if ( $activity ) { |
| [5082](#L5082) | $ret[3]   = $activity; |
| [5083](#L5083) | $where[]  = 'act.activity IN (' . $activity . ')'; |
| [5084](#L5084) | $join\_act = true; |
| [5085](#L5085) | } |
| [5086](#L5086) |  |
| [5087](#L5087) | if ( $q->filter\_errors ) { |
| [5088](#L5088) | $where[] = 'log.php\_errors != ""'; |
| [5089](#L5089) | } |
| [5090](#L5090) |  |
| [5091](#L5091) | // --------------------------------------------------------------------------------- |
| [5092](#L5092) |  |
| [5093](#L5093) | $where = ( ! empty( $where ) ) ? 'WHERE ' . implode( ' AND ', $where ) : ''; |
| [5094](#L5094) |  |
| [5095](#L5095) | // Limits, if specified |
| [5096](#L5096) | $per\_page = $args['per\_page'] ?? crb\_admin\_get\_per\_page(); |
| [5097](#L5097) | $per\_page = absint( $per\_page ); |
| [5098](#L5098) | $ret[2]   = $per\_page; |
| [5099](#L5099) |  |
| [5100](#L5100) | $cols = 'log.\*'; |
| [5101](#L5101) | if ( ! empty( $args['columns'] ) ) { |
| [5102](#L5102) | $cols = ''; |
| [5103](#L5103) | foreach ( $args['columns'] as $col\_name ) { |
| [5104](#L5104) | $cols .= ',log.' . preg\_replace( '/[^A-Z\_\d]/i', '', $col\_name ); |
| [5105](#L5105) | } |
| [5106](#L5106) | $cols = trim( $cols, ',' ); |
| [5107](#L5107) | } |
| [5108](#L5108) |  |
| [5109](#L5109) | if ( $join\_act ) { |
| [5110](#L5110) | $join    = ' JOIN ' . CERBER\_LOG\_TABLE . ' act ON (log.session\_id = act.session\_id)'; |
| [5111](#L5111) | } |
| [5112](#L5112) |  |
| [5113](#L5113) | if ( $per\_page ) { |
| [5114](#L5114) | $limit = cerber\_get\_sql\_limit( $per\_page ); |
| [5115](#L5115) | //$ret[0] = 'SELECT SQL\_CALC\_FOUND\_ROWS log.session\_id,log.\* FROM ' . CERBER\_TRAF\_TABLE . " log USE INDEX FOR ORDER BY (stamp) {$where} ORDER BY stamp DESC {$limit}"; |
| [5116](#L5116) | $ret[0] = 'SELECT log.session\_id,' . $cols . ' FROM ' . CERBER\_TRAF\_TABLE . " log {$join} {$where} ORDER BY log.stamp DESC {$limit}"; |
| [5117](#L5117) | //$ret[0] = 'SELECT SQL\_CALC\_FOUND\_ROWS log.\*,act.activity FROM ' . CERBER\_TRAF\_TABLE . ' log USE INDEX FOR ORDER BY (stamp) LEFT JOIN '.CERBER\_LOG\_TABLE." act ON (log.session\_id = act.session\_id) {$where} ORDER BY log.stamp DESC {$limit}"; |
| [5118](#L5118) | } |
| [5119](#L5119) | else { |
| [5120](#L5120) | $ret[0] = 'SELECT log.session\_id,' . $cols . ' FROM ' . CERBER\_TRAF\_TABLE . " log {$join} {$where} ORDER BY stamp DESC"; // "ORDER BY" is mandatory! |
| [5121](#L5121) | } |
| [5122](#L5122) |  |
| [5123](#L5123) | $ret[1] = 'SELECT COUNT(log.stamp) FROM ' . CERBER\_TRAF\_TABLE . " log {$join} {$where}"; |
| [5124](#L5124) |  |
| [5125](#L5125) | return $ret; |
| [5126](#L5126) | } |
| [5127](#L5127) |  |
| [5128](#L5128) | /\*\* |
| [5129](#L5129) | \* Traffic Search form HTML |
| [5130](#L5130) | \* |
| [5131](#L5131) | \* @return string |
| [5132](#L5132) | \* |
| [5133](#L5133) | \*/ |
| [5134](#L5134) | function crb\_admin\_traffic\_search\_form() { |
| [5135](#L5135) | ob\_start(); |
| [5136](#L5136) | ?> |
| [5137](#L5137) | <div id="crb-traffic-search" style="display: none;"> |
| [5138](#L5138) | <form id="crb-traffic-form" method="get" action=""> |
| [5139](#L5139) | <input type="hidden" name="page" value="cerber-traffic"> |
| [5140](#L5140) |  |
| [5141](#L5141) | <div> |
| [5142](#L5142) | <div> |
| [5143](#L5143) | <p style="width: 100%;"><label>Activity</label> |
| [5144](#L5144) | <?php |
| [5145](#L5145) | echo crb\_get\_activity\_dd(); |
| [5146](#L5146) | ?> |
| [5147](#L5147) | </p> |
| [5148](#L5148) |  |
| [5149](#L5149) | <p><label for="search-traffic-url">URL contains</label> |
| [5150](#L5150) | <br/><input id="search-traffic-url" type="text" name="search\_traffic[uri]"></p> |
| [5151](#L5151) |  |
| [5152](#L5152) | <p><label for="filter-method">Request method</label> |
| [5153](#L5153) | <select id="filter-method" name="filter\_method"> |
| [5154](#L5154) | <option value="0">Any</option> |
| [5155](#L5155) | <option>GET</option> |
| [5156](#L5156) | <option>POST</option> |
| [5157](#L5157) | </select></p> |
| [5158](#L5158) |  |
| [5159](#L5159) | <p><label for="search-traffic-fields">POST or GET fields contain</label> |
| [5160](#L5160) | <br/><input id="search-traffic-fields" type="text" name="search\_traffic[fields]"></p> |
| [5161](#L5161) |  |
| [5162](#L5162) | <p><label for="search-traffic-details">Miscellaneous details contains</label> |
| [5163](#L5163) | <br/><input id="search-traffic-details" type="text" name="search\_traffic[details]"></p> |
| [5164](#L5164) |  |
| [5165](#L5165) | <p><label for="filter-http-code">HTTP Response Code equals</label> |
| [5166](#L5166) | <br/><input id="filter-http-code" type="number" name="filter\_http\_code"></p> |
| [5167](#L5167) |  |
| [5168](#L5168) | <p><label for="search-traffic-date-from">Date from</label> |
| [5169](#L5169) | <br/><input id="search-traffic-date-from" type="date" name="search\_traffic[date\_from]" |
| [5170](#L5170) | placeholder="month/day/year"></p> |
| [5171](#L5171) |  |
| [5172](#L5172) | <p><label for="search-traffic-date-to">Date to</label> |
| [5173](#L5173) | <br/><input id="search-traffic-date-to" type="date" name="search\_traffic[date\_to]" |
| [5174](#L5174) | placeholder="month/day/year"></p> |
| [5175](#L5175) | </div> |
| [5176](#L5176) | <div> |
| [5177](#L5177) | <p><label for="search-traffic-ip">Remote IP address contains or equals</label> |
| [5178](#L5178) | <br/><input id="search-traffic-ip" type="text" name="search\_traffic[ip]"></p> |
| [5179](#L5179) | <p> |
| [5180](#L5180) | <label for="">User</label> |
| [5181](#L5181) | <br/> |
| [5182](#L5182) | <?php |
| [5183](#L5183) | echo cerber\_select( 'filter\_user', array(), null, 'crb-select2-ajax', '', false, '', array( 'min\_symbols' => 3 ) ) |
| [5184](#L5184) | ?> |
| [5185](#L5185) | </p> |
| [5186](#L5186) |  |
| [5187](#L5187) | <p><label for="filter-user-alt">User ID</label> |
| [5188](#L5188) | <br/><input id="filter-user-alt" type="text" name="filter\_user\_alt" placeholder="Use comma to specify multiple IDs"></p> |
| [5189](#L5189) |  |
| [5190](#L5190) | <p><label for="filter-user-mode">User operator</label> |
| [5191](#L5191) | <select id="filter-user-mode" name="filter\_user\_mode"> |
| [5192](#L5192) | <option value="0">Include</option> |
| [5193](#L5193) | <option value="1">Exclude</option> |
| [5194](#L5194) | </select></p> |
| [5195](#L5195) | <p><label for="filter-sid">RID</label> |
| [5196](#L5196) | <br/><input id="filter-sid" type="text" name="filter\_sid" placeholder="Request ID"></p> |
| [5197](#L5197) | <p><label for="search-err">Software errors contain</label> |
| [5198](#L5198) | <br/><input id="search-err" type="text" name="search\_traffic[errors]"></p> |
| [5199](#L5199) | <p class="crb-has-checkbox"> |
| [5200](#L5200) | <input type="checkbox" name="filter\_errors" id="filter-err" value="1"><label for="filter-err">Any software error</label> |
| [5201](#L5201) | </p> |
| [5202](#L5202) | <p style="margin-top: 3em;">The search uses AND logic for all non-empty fields</p> |
| [5203](#L5203) | </div> |
| [5204](#L5204) | </div> |
| [5205](#L5205) | <div> |
| [5206](#L5206) | <p><input type="submit" class="button button-primary" value="Search" style="width: 8rem;"></p> |
| [5207](#L5207) | </div> |
| [5208](#L5208) | </form> |
| [5209](#L5209) | </div> |
| [5210](#L5210) |  |
| [5211](#L5211) | <?php |
| [5212](#L5212) | return ob\_get\_clean(); |
| [5213](#L5213) | } |
| [5214](#L5214) |  |
| [5215](#L5215) | function cerber\_get\_wp\_type( $wp\_type ) { |
| [5216](#L5216) | $types = array( |
| [5217](#L5217) | 515 => 'XML-RPC', |
| [5218](#L5218) | 520 => 'REST API' |
| [5219](#L5219) | ); |
| [5220](#L5220) |  |
| [5221](#L5221) | if ( isset( $types[ $wp\_type ] ) ) { |
| [5222](#L5222) | return $types[ $wp\_type ]; |
| [5223](#L5223) | } |
| [5224](#L5224) |  |
| [5225](#L5225) | return ''; |
| [5226](#L5226) | } |
| [5227](#L5227) |  |
| [5228](#L5228) | function cerber\_get\_err\_type( $type ) { |
| [5229](#L5229) | $list = array( |
| [5230](#L5230) | 'E\_ERROR', |
| [5231](#L5231) | 'E\_WARNING', |
| [5232](#L5232) | 'E\_PARSE', |
| [5233](#L5233) | 'E\_NOTICE', |
| [5234](#L5234) | 'E\_CORE\_ERROR', |
| [5235](#L5235) | 'E\_CORE\_WARNING', |
| [5236](#L5236) | 'E\_COMPILE\_ERROR', |
| [5237](#L5237) | 'E\_COMPILE\_WARNING', |
| [5238](#L5238) | 'E\_USER\_ERROR', |
| [5239](#L5239) | 'E\_USER\_WARNING', |
| [5240](#L5240) | 'E\_USER\_NOTICE', |
| [5241](#L5241) | 'E\_STRICT', |
| [5242](#L5242) | 'E\_RECOVERABLE\_ERROR', |
| [5243](#L5243) | 'E\_DEPRECATED', |
| [5244](#L5244) | 'E\_USER\_DEPRECATED', |
| [5245](#L5245) | 'E\_ALL', |
| [5246](#L5246) | ); |
| [5247](#L5247) |  |
| [5248](#L5248) | return $list[ intval( log( $type, 2 ) ) ]; |
| [5249](#L5249) | } |
| [5250](#L5250) |  |
| [5251](#L5251) | /\*\* |
| [5252](#L5252) | \* Check if admin AJAX is permitted. |
| [5253](#L5253) | \* |
| [5254](#L5254) | \*/ |
| [5255](#L5255) | function cerber\_check\_ajax\_permissions( $strict = true ) { |
| [5256](#L5256) | if ( nexus\_is\_valid\_request() ) { |
| [5257](#L5257) | /\* |
| [5258](#L5258) | $nonce = crb\_array\_get( nexus\_request\_data()->get\_params, 'ajax\_nonce' ); |
| [5259](#L5259) | if ( ! $nonce ) { |
| [5260](#L5260) | $nonce = nexus\_request\_data()->get\_post\_data( 'ajax\_nonce' ); |
| [5261](#L5261) | } |
| [5262](#L5262) | if ( ! wp\_verify\_nonce( $nonce, 'crb-ajax-admin' ) ) { |
| [5263](#L5263) | return false; |
| [5264](#L5264) | } |
| [5265](#L5265) | \*/ |
| [5266](#L5266) |  |
| [5267](#L5267) | return true; |
| [5268](#L5268) | } |
| [5269](#L5269) |  |
| [5270](#L5270) | check\_ajax\_referer( 'crb-ajax-admin', 'ajax\_nonce' ); |
| [5271](#L5271) |  |
| [5272](#L5272) | if ( ! cerber\_user\_can\_manage() ) { |
| [5273](#L5273) | if ( $strict ) { |
| [5274](#L5274) | wp\_die( 'Oops! Access denied.' ); |
| [5275](#L5275) | } |
| [5276](#L5276) |  |
| [5277](#L5277) | return 0; |
| [5278](#L5278) | } |
| [5279](#L5279) |  |
| [5280](#L5280) | return true; |
| [5281](#L5281) | } |
| [5282](#L5282) |  |
| [5283](#L5283) | function crb\_admin\_allowed\_ajax( $action ) { |
| [5284](#L5284) | $list = array( |
| [5285](#L5285) | 'cerber\_ajax', |
| [5286](#L5286) | 'cerber\_scan\_control', |
| [5287](#L5287) | 'cerber\_ref\_upload', |
| [5288](#L5288) | 'cerber\_view\_file', |
| [5289](#L5289) | 'cerber\_scan\_bulk\_files' |
| [5290](#L5290) | ); |
| [5291](#L5291) |  |
| [5292](#L5292) | return in\_array( $action, $list ); |
| [5293](#L5293) | } |
| [5294](#L5294) |  |
| [5295](#L5295) | function crb\_is\_task\_permitted( $die = false ) { |
| [5296](#L5296) | if ( is\_super\_admin() |
| [5297](#L5297) | || nexus\_is\_valid\_request() ) { |
| [5298](#L5298) | return true; |
| [5299](#L5299) | } |
| [5300](#L5300) | if ( $die ) { |
| [5301](#L5301) | wp\_die( 'Oops! Access denied.' ); |
| [5302](#L5302) | } |
| [5303](#L5303) |  |
| [5304](#L5304) | return false; |
| [5305](#L5305) | } |
| [5306](#L5306) |  |
| [5307](#L5307) | /\*\* |
| [5308](#L5308) | \* Identify and render Cerber's admin page |
| [5309](#L5309) | \* |
| [5310](#L5310) | \* @param string $page\_id |
| [5311](#L5311) | \* @param string $active\_tab |
| [5312](#L5312) | \*/ |
| [5313](#L5313) | function cerber\_render\_admin\_page( $page\_id = '', $active\_tab = '' ) { |
| [5314](#L5314) |  |
| [5315](#L5315) | if ( nexus\_get\_context() ) { |
| [5316](#L5316) | nexus\_show\_remote\_page(); |
| [5317](#L5317) |  |
| [5318](#L5318) | return; |
| [5319](#L5319) | } |
| [5320](#L5320) |  |
| [5321](#L5321) | $error = ''; |
| [5322](#L5322) |  |
| [5323](#L5323) | if ( $page = cerber\_get\_admin\_page\_config( $page\_id ) ) { |
| [5324](#L5324) | if ( ! empty( $page['pro\_page'] ) && ! lab\_lab() ) { |
| [5325](#L5325) | $error = 'This feature requires the PRO version of the plugin.'; |
| [5326](#L5326) | } |
| [5327](#L5327) | else { |
| [5328](#L5328) | if ( ( $tab\_filter = crb\_array\_get( $page, 'tab\_filter' ) ) |
| [5329](#L5329) | && is\_callable( $tab\_filter ) ) { |
| [5330](#L5330) | $page['tabs'] = call\_user\_func( $tab\_filter, $page['tabs'] ); |
| [5331](#L5331) | } |
| [5332](#L5332) |  |
| [5333](#L5333) | cerber\_show\_admin\_page( $page['title'], $page['tabs'], $active\_tab, $page['callback'] ); |
| [5334](#L5334) | } |
| [5335](#L5335) | } |
| [5336](#L5336) | else { |
| [5337](#L5337) | $error = 'Unknown admin page: ' . htmlspecialchars( $page\_id ); |
| [5338](#L5338) | } |
| [5339](#L5339) |  |
| [5340](#L5340) | if ( $error ) { |
| [5341](#L5341) | echo '<div class="crb-generic-error">ERROR: ' . $error . ' on ' . get\_bloginfo( 'name' ) . '</div>'; |
| [5342](#L5342) | } |
| [5343](#L5343) | } |
| [5344](#L5344) |  |
| [5345](#L5345) | function cerber\_get\_admin\_page\_config( $page = '' ) { |
| [5346](#L5346) | if ( ! $page ) { |
| [5347](#L5347) | if ( ! $page = crb\_admin\_get\_page() ) { |
| [5348](#L5348) | return false; |
| [5349](#L5349) | } |
| [5350](#L5350) | } |
| [5351](#L5351) |  |
| [5352](#L5352) | if ( $config = crb\_addon\_admin\_page( $page ) ) { |
| [5353](#L5353) | return $config; |
| [5354](#L5354) | } |
| [5355](#L5355) |  |
| [5356](#L5356) | $admin\_pages = array( |
| [5357](#L5357) | 'cerber-security'  => array( |
| [5358](#L5358) | 'title'      => 'WP Cerber Security', |
| [5359](#L5359) | 'tabs'       => array( |
| [5360](#L5360) | 'dashboard'     => array( 'bxs-dashboard', \_\_( 'Dashboard', 'wp-cerber' ) ), |
| [5361](#L5361) | 'activity'      => array( 'bx-pulse', \_\_( 'Activity', 'wp-cerber' ) ), |
| [5362](#L5362) | 'sessions'      => array( 'bx-group', \_\_( 'Sessions', 'wp-cerber' ) ), |
| [5363](#L5363) | 'lockouts'      => array( 'bxs-shield', \_\_( 'Lockouts', 'wp-cerber' ) ), |
| [5364](#L5364) | 'main'          => array( 'bx-slider', \_\_( 'Main Settings', 'wp-cerber' ) ), |
| [5365](#L5365) | 'acl'           => array( 'bx-lock', \_\_( 'Access Lists', 'wp-cerber' ) ), |
| [5366](#L5366) | 'hardening'     => array( 'bx-shield-alt', \_\_( 'Hardening', 'wp-cerber' ) ), |
| [5367](#L5367) | //'users'         => array( 'bx-group', \_\_( 'Users', 'wp-cerber' ) ), |
| [5368](#L5368) | 'notifications' => array( 'bx-bell', \_\_( 'Notifications', 'wp-cerber' ) ), |
| [5369](#L5369) | ), |
| [5370](#L5370) | 'tab\_filter' => function ( $tabs ) { |
| [5371](#L5371) | crb\_del\_expired\_blocks(); |
| [5372](#L5372) | $blocked = cerber\_blocked\_num(); |
| [5373](#L5373) | $acl = cerber\_db\_get\_var( 'SELECT COUNT(ip) FROM ' . CERBER\_ACL\_TABLE . ' WHERE acl\_slice = 0' ); |
| [5374](#L5374) | crb\_sessions\_del\_expired(); |
| [5375](#L5375) | $uss = crb\_sessions\_get\_num(); |
| [5376](#L5376) | if ( ! $uss ) { |
| [5377](#L5377) | cerber\_bg\_task\_add( 'crb\_sessions\_sync\_all' ); |
| [5378](#L5378) | } |
| [5379](#L5379) | $tabs['sessions'][1] .= ' <sup>' . $uss . '</sup>'; |
| [5380](#L5380) | $tabs['lockouts'][1] .= ' <sup>' . $blocked . '</sup>'; |
| [5381](#L5381) | $tabs['acl'][1] .= ' <sup>' . $acl . '</sup>'; |
| [5382](#L5382) |  |
| [5383](#L5383) | return $tabs; |
| [5384](#L5384) | }, |
| [5385](#L5385) | 'callback'   => function ( $tab ) { |
| [5386](#L5386) | switch ( $tab ) { |
| [5387](#L5387) | case 'acl': |
| [5388](#L5388) | cerber\_acl\_form(); |
| [5389](#L5389) | break; |
| [5390](#L5390) | case 'activity': |
| [5391](#L5391) | cerber\_show\_activity(); |
| [5392](#L5392) | break; |
| [5393](#L5393) | case 'sessions': |
| [5394](#L5394) | crb\_admin\_show\_sessions(); |
| [5395](#L5395) | break; |
| [5396](#L5396) | case 'lockouts': |
| [5397](#L5397) | cerber\_show\_lockouts(); |
| [5398](#L5398) | break; |
| [5399](#L5399) | case 'help': |
| [5400](#L5400) | cerber\_show\_help(); |
| [5401](#L5401) | break; |
| [5402](#L5402) | case 'dashboard': |
| [5403](#L5403) | cerber\_show\_dashboard(); |
| [5404](#L5404) | break; |
| [5405](#L5405) | default: |
| [5406](#L5406) | cerber\_show\_settings\_form( $tab ); |
| [5407](#L5407) | } |
| [5408](#L5408) | } |
| [5409](#L5409) | ), |
| [5410](#L5410) | 'cerber-recaptcha' => array( |
| [5411](#L5411) | 'title'    => \_\_( 'Anti-spam and bot detection settings', 'wp-cerber' ), |
| [5412](#L5412) | 'tabs'     => array( |
| [5413](#L5413) | 'antispam' => array( 'bx-chip', \_\_( 'Anti-spam engine', 'wp-cerber' ) ), |
| [5414](#L5414) | 'captcha'  => array( 'bxl-google', 'reCAPTCHA' ), |
| [5415](#L5415) | ), |
| [5416](#L5416) | 'callback' => function ( $tab ) { |
| [5417](#L5417) |  |
| [5418](#L5418) | switch ( $tab ) { |
| [5419](#L5419) | case 'captcha': |
| [5420](#L5420) | $group = 'recaptcha'; |
| [5421](#L5421) | break; |
| [5422](#L5422) | default: |
| [5423](#L5423) | $group = 'antispam'; |
| [5424](#L5424) | } |
| [5425](#L5425) |  |
| [5426](#L5426) | cerber\_show\_settings\_form( $group ); |
| [5427](#L5427) |  |
| [5428](#L5428) | } |
| [5429](#L5429) | ), |
| [5430](#L5430) | 'cerber-traffic'   => array( |
| [5431](#L5431) | 'title'    => \_\_( 'Traffic Inspector', 'wp-cerber' ), |
| [5432](#L5432) | 'tabs'     => array( |
| [5433](#L5433) | 'traffic'     => array( 'bx-show', \_\_( 'Live Traffic', 'wp-cerber' ) ), |
| [5434](#L5434) | 'ti\_settings' => array( 'bx-slider', \_\_( 'Settings', 'wp-cerber' ) ), |
| [5435](#L5435) | ), |
| [5436](#L5436) | 'callback' => function ( $tab ) { |
| [5437](#L5437) | switch ( $tab ) { |
| [5438](#L5438) | case 'ti\_settings': |
| [5439](#L5439) | cerber\_show\_settings\_form( 'traffic' ); |
| [5440](#L5440) | break; |
| [5441](#L5441) | default: |
| [5442](#L5442) | cerber\_show\_traffic(); |
| [5443](#L5443) | } |
| [5444](#L5444) | } |
| [5445](#L5445) | ), |
| [5446](#L5446) | 'cerber-shield'    => array( |
| [5447](#L5447) | 'title'    => \_\_( 'Data Shield Policies', 'wp-cerber' ), |
| [5448](#L5448) | 'tabs'     => array( |
| [5449](#L5449) | 'user\_shield' => array( 'bx-group', \_\_( 'Accounts & Roles', 'wp-cerber' ) ), |
| [5450](#L5450) | 'opt\_shield'  => array( 'bx-slider', \_\_( 'Site Settings', 'wp-cerber' ) ), |
| [5451](#L5451) | ), |
| [5452](#L5452) | 'callback' => function ( $tab ) { |
| [5453](#L5453) | cerber\_show\_settings\_form( $tab ); |
| [5454](#L5454) | } |
| [5455](#L5455) | ), |
| [5456](#L5456) | 'cerber-users'     => array( |
| [5457](#L5457) | 'title'    => \_\_( 'User Policies', 'wp-cerber' ), |
| [5458](#L5458) | 'tabs'     => array( |
| [5459](#L5459) | 'role\_policies'   => array( 'bx-group', \_\_( 'Role-Based', 'wp-cerber' ) ), |
| [5460](#L5460) | 'global\_policies' => array( 'bx-user-detail', \_\_( 'Global', 'wp-cerber' ) ), |
| [5461](#L5461) | ), |
| [5462](#L5462) | 'callback' => function ( $tab ) { |
| [5463](#L5463) | switch ( $tab ) { |
| [5464](#L5464) | case 'role\_policies': |
| [5465](#L5465) | crb\_admin\_show\_role\_policies(); |
| [5466](#L5466) | break; |
| [5467](#L5467) | case 'global\_policies': |
| [5468](#L5468) | cerber\_show\_settings\_form( 'users' ); |
| [5469](#L5469) | break; |
| [5470](#L5470) | default: |
| [5471](#L5471) | cerber\_show\_settings\_form( $tab ); |
| [5472](#L5472) | } |
| [5473](#L5473) | } |
| [5474](#L5474) | ), |
| [5475](#L5475) | 'cerber-rules' => array( |
| [5476](#L5476) | 'pro\_page' => 1, |
| [5477](#L5477) | 'title'    => \_\_( 'Security Rules', 'wp-cerber' ), |
| [5478](#L5478) | 'tabs'     => array( |
| [5479](#L5479) | 'geo' => array( 'bxs-world', \_\_( 'Countries', 'wp-cerber' ) ), |
| [5480](#L5480) | ), |
| [5481](#L5481) | 'callback' => function ( $tab ) { |
| [5482](#L5482) | switch ( $tab ) { |
| [5483](#L5483) | case 'geo': |
| [5484](#L5484) | crb\_admin\_show\_geo\_rules(); |
| [5485](#L5485) | break; |
| [5486](#L5486) | default: |
| [5487](#L5487) | crb\_admin\_show\_geo\_rules(); |
| [5488](#L5488) | } |
| [5489](#L5489) | } |
| [5490](#L5490) | ), |
| [5491](#L5491) | 'cerber-integrity' => array( |
| [5492](#L5492) | 'title'    => \_\_( 'Site Integrity', 'wp-cerber' ), |
| [5493](#L5493) | 'tabs'     => array( |
| [5494](#L5494) | 'scan\_main'       => array( 'bx-radar', \_\_( 'Security Scanner', 'wp-cerber' ) ), |
| [5495](#L5495) | 'scan\_settings'   => array( 'bxs-slider-alt', \_\_( 'Settings', 'wp-cerber' ) ), |
| [5496](#L5496) | 'scan\_schedule'   => array( 'bx-time', \_\_( 'Scheduling', 'wp-cerber' ) ), |
| [5497](#L5497) | 'scan\_policy'     => array( 'bx-bolt', \_\_( 'Cleaning up', 'wp-cerber' ) ), |
| [5498](#L5498) | 'scan\_ignore'     => array( 'bx-hide', \_\_( 'Ignore List', 'wp-cerber' ) ), |
| [5499](#L5499) | 'scan\_quarantine' => array( 'bx-trash', \_\_( 'Quarantine', 'wp-cerber' ) ), |
| [5500](#L5500) | 'scan\_insights' => array( 'bx-flask', \_\_( 'Analytics', 'wp-cerber' ) ), |
| [5501](#L5501) | ), |
| [5502](#L5502) | 'tab\_filter' => function ( $tabs ) { |
| [5503](#L5503) | $numi = 0; |
| [5504](#L5504) | if ( $list = cerber\_get\_set( 'ignore-list' ) ) { |
| [5505](#L5505) | $numi = count( $list ); |
| [5506](#L5506) | } |
| [5507](#L5507) | $numq = cerber\_get\_set( 'quarantined\_total', null, false ); |
| [5508](#L5508) | if ( ! is\_numeric( $numq ) ) { |
| [5509](#L5509) | cerber\_bg\_task\_add( '\_crb\_qr\_total\_sync' ); |
| [5510](#L5510) | $numq = ''; |
| [5511](#L5511) | } |
| [5512](#L5512) | $tabs['scan\_quarantine'][1] .= ' <sup>' . $numq . '</sup>'; |
| [5513](#L5513) | $tabs['scan\_ignore'][1] .= ' <sup>' . $numi . '</sup>'; |
| [5514](#L5514) |  |
| [5515](#L5515) | return $tabs; |
| [5516](#L5516) | }, |
| [5517](#L5517) | 'callback' => function ( $tab ) { |
| [5518](#L5518) | switch ( $tab ) { |
| [5519](#L5519) | case 'scan\_settings': |
| [5520](#L5520) | cerber\_show\_settings\_form( 'scanner' ); |
| [5521](#L5521) | break; |
| [5522](#L5522) | case 'scan\_schedule': |
| [5523](#L5523) | cerber\_show\_settings\_form( 'schedule' ); |
| [5524](#L5524) | break; |
| [5525](#L5525) | case 'scan\_policy': |
| [5526](#L5526) | cerber\_show\_settings\_form( 'policies' ); |
| [5527](#L5527) | break; |
| [5528](#L5528) | case 'scan\_quarantine': |
| [5529](#L5529) | cerber\_show\_quarantine(); |
| [5530](#L5530) | break; |
| [5531](#L5531) | case 'scan\_ignore': |
| [5532](#L5532) | cerber\_show\_ignore(); |
| [5533](#L5533) | break; |
| [5534](#L5534) | case 'scan\_insights': |
| [5535](#L5535) | cerber\_scan\_insights(); |
| [5536](#L5536) | break; |
| [5537](#L5537) | case 'help': |
| [5538](#L5538) | cerber\_show\_help(); |
| [5539](#L5539) | break; |
| [5540](#L5540) | default: |
| [5541](#L5541) | cerber\_show\_scanner(); |
| [5542](#L5542) | } |
| [5543](#L5543) | } |
| [5544](#L5544) | ), |
| [5545](#L5545) | 'cerber-tools'     => array( |
| [5546](#L5546) | 'title'    => \_\_( 'Tools', 'wp-cerber' ), |
| [5547](#L5547) | 'tabs'     => array( |
| [5548](#L5548) | //'imex'       => array( 'bx-layer', \_\_( 'Export & Import', 'wp-cerber' ) ), |
| [5549](#L5549) | 'imex'       => array( 'bx-layer', \_\_( 'Manage Settings', 'wp-cerber' ) ), |
| [5550](#L5550) | 'diagnostic' => array( 'bx-wrench', \_\_( 'Diagnostic', 'wp-cerber' ) ), |
| [5551](#L5551) | 'diag-log'   => array( 'bx-bug', \_\_( 'Diagnostic Log', 'wp-cerber' ) ), |
| [5552](#L5552) | 'change-log' => array( 'bx-collection', \_\_( 'Changelog', 'wp-cerber' ) ), |
| [5553](#L5553) | 'license'    => array( 'bx-key', \_\_( 'License', 'wp-cerber' ) ), |
| [5554](#L5554) | ), |
| [5555](#L5555) | 'callback' => function ( $tab ) { |
| [5556](#L5556) | switch ( $tab ) { |
| [5557](#L5557) | case 'diagnostic': |
| [5558](#L5558) | cerber\_show\_diag(); |
| [5559](#L5559) | break; |
| [5560](#L5560) | case 'license': |
| [5561](#L5561) | cerber\_show\_lic(); |
| [5562](#L5562) | break; |
| [5563](#L5563) | case 'diag-log': |
| [5564](#L5564) | cerber\_show\_diag\_log(); |
| [5565](#L5565) | break; |
| [5566](#L5566) | case 'change-log': |
| [5567](#L5567) | cerber\_show\_change\_log(); |
| [5568](#L5568) | break; |
| [5569](#L5569) | case 'help': |
| [5570](#L5570) | cerber\_show\_help(); |
| [5571](#L5571) | break; |
| [5572](#L5572) | default: |
| [5573](#L5573) | if ( ! nexus\_is\_valid\_request() ) { |
| [5574](#L5574) | cerber\_show\_imex(); |
| [5575](#L5575) | } |
| [5576](#L5576) | else { |
| [5577](#L5577) | echo 'This admin page is not available in this mode.'; |
| [5578](#L5578) | } |
| [5579](#L5579) | } |
| [5580](#L5580) | } |
| [5581](#L5581) | ), |
| [5582](#L5582) | ); |
| [5583](#L5583) |  |
| [5584](#L5584) | return crb\_array\_get( $admin\_pages, $page ); |
| [5585](#L5585) | } |
| [5586](#L5586) |  |
| [5587](#L5587) | function crb\_admin\_parse\_query( $fields, $alt = array() ) { |
| [5588](#L5588) | $arr = crb\_get\_query\_params(); |
| [5589](#L5589) | $ret = array(); |
| [5590](#L5590) |  |
| [5591](#L5591) | foreach ( $fields as $field ) { |
| [5592](#L5592) |  |
| [5593](#L5593) | $val = $alt[ $field ] ?? crb\_array\_get( $arr, $field, false ); |
| [5594](#L5594) |  |
| [5595](#L5595) | if ( is\_array( $val ) ) { |
| [5596](#L5596) | $val = array\_map( 'trim', $val ); |
| [5597](#L5597) | } |
| [5598](#L5598) | elseif ( $val !== false ) { |
| [5599](#L5599) | $val = trim( $val ); |
| [5600](#L5600) | } |
| [5601](#L5601) |  |
| [5602](#L5602) | $ret[ $field ] = $val; |
| [5603](#L5603) | } |
| [5604](#L5604) |  |
| [5605](#L5605) | return (object) $ret; |
| [5606](#L5606) | } |
| [5607](#L5607) |  |
| [5608](#L5608) | function crb\_admin\_get\_page() { |
| [5609](#L5609) | if ( nexus\_is\_valid\_request() ) { |
| [5610](#L5610) | $page = nexus\_request\_data()->page; |
| [5611](#L5611) | } |
| [5612](#L5612) | else { |
| [5613](#L5613) | $page = cerber\_get\_get( 'page', '[A-Z0-9\\_\-]+' ); |
| [5614](#L5614) | } |
| [5615](#L5615) | return $page; |
| [5616](#L5616) | } |
| [5617](#L5617) |  |
| [5618](#L5618) | function crb\_admin\_get\_tab( $tabs = array() ) { |
| [5619](#L5619) | if ( nexus\_is\_valid\_request() ) { |
| [5620](#L5620) | $tab = nexus\_request\_data()->tab; |
| [5621](#L5621) | } |
| [5622](#L5622) | else { |
| [5623](#L5623) | $tab = cerber\_get\_get( 'tab', '[\w\-]+' ); |
| [5624](#L5624) | } |
| [5625](#L5625) |  |
| [5626](#L5626) | if ( empty( $tabs ) ) { |
| [5627](#L5627) | return $tab; |
| [5628](#L5628) | } |
| [5629](#L5629) |  |
| [5630](#L5630) | $tabs['help'] = 1; // always must be in the array |
| [5631](#L5631) |  |
| [5632](#L5632) | if ( ! $tab || ! isset( $tabs[ $tab ] ) ) { |
| [5633](#L5633) | reset( $tabs ); |
| [5634](#L5634) | $tab = key( $tabs ); |
| [5635](#L5635) | } |
| [5636](#L5636) |  |
| [5637](#L5637) | return $tab; |
| [5638](#L5638) | } |
| [5639](#L5639) |  |
| [5640](#L5640) | function cerber\_show\_tabs( $active, $tabs = array() ) { |
| [5641](#L5641) | echo '<h2 class="nav-tab-wrapper cerber-tabs">'; |
| [5642](#L5642) |  |
| [5643](#L5643) | $args = array( 'page' => crb\_admin\_get\_page() ); |
| [5644](#L5644) |  |
| [5645](#L5645) | foreach ( $tabs as $tab => $data ) { |
| [5646](#L5646) | echo '<a href="' . cerber\_admin\_link( $tab, $args ) . '" class="nav-tab ' . ( $tab == $active ? 'nav-tab-active' : '' ) . '"><i class="crb-icon crb-icon-' . $data[0] . '"></i> ' . $data[1] . '</a>'; |
| [5647](#L5647) | } |
| [5648](#L5648) |  |
| [5649](#L5649) | echo '<a href="' . cerber\_admin\_link( 'help', $args ) . '" class="nav-tab ' . ( $active == 'help' ? 'nav-tab-active' : '' ) . '"><i class="crb-icon crb-icon-bx-idea"></i> ' . \_\_( 'Help', 'wp-cerber' ) . '</a>'; |
| [5650](#L5650) |  |
| [5651](#L5651) | $lab = lab\_indicator(); |
| [5652](#L5652) | $ro  = ''; |
| [5653](#L5653) | if ( nexus\_is\_valid\_request() && ! nexus\_is\_granted( 'submit' ) ) { |
| [5654](#L5654) | $ro = '<span style="font-weight: bold; font-size: 0.8em; color: #f00;">Read-only mode</span>'; |
| [5655](#L5655) | } |
| [5656](#L5656) |  |
| [5657](#L5657) | echo '<div style="float: right;">' . $ro . ' ' . $lab . '</div>'; |
| [5658](#L5658) |  |
| [5659](#L5659) | echo '</h2>'; |
| [5660](#L5660) | } |
| [5661](#L5661) |  |
| [5662](#L5662) | // Access Lists (ACL) --------------------------------------------------------- |
| [5663](#L5663) |  |
| [5664](#L5664) | /\*\* |
| [5665](#L5665) | \* @param string $ip |
| [5666](#L5666) | \* @param string $tag |
| [5667](#L5667) | \* @param string $comment |
| [5668](#L5668) | \* @param int $acl\_slice |
| [5669](#L5669) | \* |
| [5670](#L5670) | \* @return bool|WP\_Error |
| [5671](#L5671) | \*/ |
| [5672](#L5672) | function cerber\_acl\_add( $ip, $tag, $comment = '', $acl\_slice = 0 ) { |
| [5673](#L5673) | global $wpdb; |
| [5674](#L5674) |  |
| [5675](#L5675) | $ip = trim( $ip ); |
| [5676](#L5676) |  |
| [5677](#L5677) | $acl\_slice = absint( $acl\_slice ); |
| [5678](#L5678) | $v6range = ''; |
| [5679](#L5679) | $ver6 = 0; |
| [5680](#L5680) |  |
| [5681](#L5681) | if ( cerber\_is\_ipv4( $ip ) ) { |
| [5682](#L5682) | $begin = ip2long( $ip ); |
| [5683](#L5683) | $end   = ip2long( $ip ); |
| [5684](#L5684) | } |
| [5685](#L5685) | elseif ( cerber\_is\_ipv6( $ip ) ) { |
| [5686](#L5686) | $ip = cerber\_ipv6\_short( $ip ); |
| [5687](#L5687) | list( $begin, $end, $v6range ) = crb\_ipv6\_prepare( $ip, $ip ); |
| [5688](#L5688) | $ver6 = 1; |
| [5689](#L5689) | } |
| [5690](#L5690) | elseif ( ( $range = cerber\_any2range( $ip ) ) |
| [5691](#L5691) | && is\_array( $range ) ) { |
| [5692](#L5692) | $ver6    = $range['IPV6']; |
| [5693](#L5693) | $begin   = $range['begin']; |
| [5694](#L5694) | $end     = $range['end']; |
| [5695](#L5695) | $v6range = $range['IPV6range']; |
| [5696](#L5696) | } |
| [5697](#L5697) | else { |
| [5698](#L5698) | return new WP\_Error( 'acl\_wrong\_ip', \_\_( 'Incorrect IP address or IP range', 'wp-cerber' ) . ' ' . $ip ); |
| [5699](#L5699) | } |
| [5700](#L5700) |  |
| [5701](#L5701) | if ( cerber\_db\_get\_var( 'SELECT ip FROM ' . CERBER\_ACL\_TABLE . ' WHERE acl\_slice = ' . $acl\_slice . ' AND ver6 = ' . $ver6 . ' AND ip\_long\_begin = ' . $begin . ' AND ip\_long\_end = ' . $end . ' AND v6range = "' . $v6range . '" LIMIT 1' ) ) { |
| [5702](#L5702) | return new WP\_Error( 'acl\_wrong\_ip', \_\_( 'The IP address you are trying to add is already in the list', 'wp-cerber' ) ); |
| [5703](#L5703) | } |
| [5704](#L5704) |  |
| [5705](#L5705) | $result = $wpdb->insert( CERBER\_ACL\_TABLE, array( |
| [5706](#L5706) | 'ip'            => $ip, |
| [5707](#L5707) | 'ip\_long\_begin' => $begin, |
| [5708](#L5708) | 'ip\_long\_end'   => $end, |
| [5709](#L5709) | 'tag'           => $tag, |
| [5710](#L5710) | 'comments'      => $comment, |
| [5711](#L5711) | 'acl\_slice'     => $acl\_slice, |
| [5712](#L5712) | 'v6range'       => $v6range, |
| [5713](#L5713) | 'ver6'          => $ver6, |
| [5714](#L5714) | ), array( '%s', '%d', '%d', '%s', '%s', '%d', '%s', '%d' ) ); |
| [5715](#L5715) |  |
| [5716](#L5716) | if ( ! $result ) { |
| [5717](#L5717) | return new WP\_Error( 'acl\_db\_error', $wpdb->last\_error ); |
| [5718](#L5718) | } |
| [5719](#L5719) |  |
| [5720](#L5720) | crb\_event\_handler( 'ip\_event', array( |
| [5721](#L5721) | 'e\_type'   => 'acl\_add', |
| [5722](#L5722) | 'ip'       => $ip, |
| [5723](#L5723) | 'tag'      => $tag, |
| [5724](#L5724) | 'slice'    => $acl\_slice, |
| [5725](#L5725) | 'comments' => $comment, |
| [5726](#L5726) | ) ); |
| [5727](#L5727) |  |
| [5728](#L5728) | return true; |
| [5729](#L5729) |  |
| [5730](#L5730) | } |
| [5731](#L5731) |  |
| [5732](#L5732) | function cerber\_add\_white( $ip, $comment = '' ) { |
| [5733](#L5733) | return cerber\_acl\_add( $ip, 'W', $comment ); |
| [5734](#L5734) | } |
| [5735](#L5735) |  |
| [5736](#L5736) | function cerber\_add\_black( $ip, $comment = '' ) { |
| [5737](#L5737) | return cerber\_acl\_add( $ip, 'B', $comment ); |
| [5738](#L5738) | } |
| [5739](#L5739) |  |
| [5740](#L5740) | function cerber\_acl\_remove( $ip, $acl\_slice = 0 ) { |
| [5741](#L5741) |  |
| [5742](#L5742) | if ( ! is\_numeric( $acl\_slice ) ) { |
| [5743](#L5743) | return false; |
| [5744](#L5744) | } |
| [5745](#L5745) |  |
| [5746](#L5746) | $acl\_slice = absint( $acl\_slice ); |
| [5747](#L5747) | $ip  = preg\_replace( CRB\_IP\_NET\_RANGE, ' ', $ip ); |
| [5748](#L5748) |  |
| [5749](#L5749) | $ret = cerber\_db\_query( 'DELETE FROM ' . CERBER\_ACL\_TABLE . ' WHERE acl\_slice = ' . $acl\_slice . ' AND ip = "' . $ip . '"' ); |
| [5750](#L5750) |  |
| [5751](#L5751) | crb\_event\_handler( 'ip\_event', array( |
| [5752](#L5752) | 'e\_type' => 'acl\_remove', |
| [5753](#L5753) | 'ip'     => $ip, |
| [5754](#L5754) | 'slice'  => $acl\_slice, |
| [5755](#L5755) | 'result' => $ret |
| [5756](#L5756) | ) ); |
| [5757](#L5757) |  |
| [5758](#L5758) | return $ret; |
| [5759](#L5759) | } |
| [5760](#L5760) |  |
| [5761](#L5761) | /\*\* |
| [5762](#L5762) | \* Can a given IP be added to the blacklist |
| [5763](#L5763) | \* |
| [5764](#L5764) | \* @param $ip string A candidate to be added to the list |
| [5765](#L5765) | \* @param $list string |
| [5766](#L5766) | \* |
| [5767](#L5767) | \* @return bool True if IP can be listed |
| [5768](#L5768) | \*/ |
| [5769](#L5769) | function cerber\_can\_be\_listed( $ip, $list = 'B' ) { |
| [5770](#L5770) |  |
| [5771](#L5771) | if ( $list == 'B' ) { |
| [5772](#L5772) |  |
| [5773](#L5773) | $admin\_ip = cerber\_get\_remote\_ip(); |
| [5774](#L5774) |  |
| [5775](#L5775) | if ( cerber\_is\_ip( $ip ) ) { |
| [5776](#L5776) | if ( $admin\_ip == cerber\_ipv6\_short( $ip ) ) { |
| [5777](#L5777) | return false; |
| [5778](#L5778) | } |
| [5779](#L5779) |  |
| [5780](#L5780) | return true; |
| [5781](#L5781) | } |
| [5782](#L5782) |  |
| [5783](#L5783) | // $ip = range |
| [5784](#L5784) |  |
| [5785](#L5785) | if ( crb\_acl\_is\_white( $admin\_ip ) ) { |
| [5786](#L5786) | return true; |
| [5787](#L5787) | } |
| [5788](#L5788) |  |
| [5789](#L5789) | if ( ! $range = cerber\_any2range( $ip ) ) { |
| [5790](#L5790) | return false; |
| [5791](#L5791) | } |
| [5792](#L5792) |  |
| [5793](#L5793) | if ( cerber\_is\_ip\_in\_range( $range, $admin\_ip ) ) { |
| [5794](#L5794) | return false; |
| [5795](#L5795) | } |
| [5796](#L5796) |  |
| [5797](#L5797) | return true; |
| [5798](#L5798) |  |
| [5799](#L5799) | } |
| [5800](#L5800) |  |
| [5801](#L5801) | return true; |
| [5802](#L5802) | } |
| [5803](#L5803) |  |
| [5804](#L5804) | /\*\* |
| [5805](#L5805) | \* Bulk action for WP\_List\_Table |
| [5806](#L5806) | \* |
| [5807](#L5807) | \* @return bool|array|string |
| [5808](#L5808) | \*/ |
| [5809](#L5809) | function cerber\_get\_bulk\_action() { |
| [5810](#L5810) |  |
| [5811](#L5811) | // GET |
| [5812](#L5812) | if ( cerber\_is\_http\_get() ) { |
| [5813](#L5813) | if ( ( $ac = crb\_get\_query\_params( 'action', '[\w\-]+' ) ) && $ac != '-1' ) { |
| [5814](#L5814) | return $ac; |
| [5815](#L5815) | } |
| [5816](#L5816) | if ( ( $ac = crb\_get\_query\_params( 'action2', '[\w\-]+' ) ) && $ac != '-1' ) { |
| [5817](#L5817) | return $ac; |
| [5818](#L5818) | } |
| [5819](#L5819) |  |
| [5820](#L5820) | return false; |
| [5821](#L5821) | } |
| [5822](#L5822) |  |
| [5823](#L5823) | // POST |
| [5824](#L5824) | if ( ( $ac = crb\_get\_post\_fields( 'action', false, '[\w\-]+' ) ) && $ac != '-1' ) { |
| [5825](#L5825) | return $ac; |
| [5826](#L5826) | } |
| [5827](#L5827) | if ( ( $ac = crb\_get\_post\_fields( 'action2', false, '[\w\-]+' ) ) && $ac != '-1' ) { |
| [5828](#L5828) | return $ac; |
| [5829](#L5829) | } |
| [5830](#L5830) |  |
| [5831](#L5831) | return false; |
| [5832](#L5832) | } |
| [5833](#L5833) |  |
| [5834](#L5834) | function crb\_admin\_cool\_features() { |
| [5835](#L5835) | return |
| [5836](#L5836) | '<div class="crb-pro-req">' . |
| [5837](#L5837) | \_\_( 'These features are available in the professional version of WP Cerber.', 'wp-cerber' ) . |
| [5838](#L5838) | '<br/><br/>' . \_\_( 'Know more about all advantages at', 'wp-cerber' ) . |
| [5839](#L5839) | ' <a href="https://wpcerber.com/pro/" target="\_blank">https://wpcerber.com/pro/</a> |
| [5840](#L5840) | </div>'; |
| [5841](#L5841) | } |
| [5842](#L5842) |  |
| [5843](#L5843) | /\*\* |
| [5844](#L5844) | \* @param string $url |
| [5845](#L5845) | \* @param string $ancor |
| [5846](#L5846) | \* @param string $msg |
| [5847](#L5847) | \* |
| [5848](#L5848) | \* @return string |
| [5849](#L5849) | \*/ |
| [5850](#L5850) | function crb\_confirmation\_link( $url, $ancor, $msg = '' ) { |
| [5851](#L5851) | if ( ! $msg ) { |
| [5852](#L5852) | $msg = \_\_( 'Are you sure?', 'wp-cerber' ); |
| [5853](#L5853) | } |
| [5854](#L5854) |  |
| [5855](#L5855) | return '<a href="' . $url . '" onclick="return confirm(\'' . $msg . '\');">' . $ancor . '</a>'; |
| [5856](#L5856) | } |
| [5857](#L5857) |  |
| [5858](#L5858) | /\*\* |
| [5859](#L5859) | \* @param array $args |
| [5860](#L5860) | \* @param string $title |
| [5861](#L5861) | \* |
| [5862](#L5862) | \* @return string |
| [5863](#L5863) | \* |
| [5864](#L5864) | \* @since 8.9.6.1 |
| [5865](#L5865) | \*/ |
| [5866](#L5866) | function crb\_test\_notify\_link( $args = array(), $title = null ) { |
| [5867](#L5867) | return '<span class="crb-insetting-link">[ <a href="' . |
| [5868](#L5868) | cerber\_admin\_link\_add( array\_merge( |
| [5869](#L5869) | array( |
| [5870](#L5870) | 'cerber\_admin\_do' => 'testnotify', |
| [5871](#L5871) | 'type'            => 'lockout', |
| [5872](#L5872) | ), $args ) ) . '">' . ( $title ?? \_\_( 'Click to send test', 'wp-cerber' ) ) . '</a> ]</span>'; |
| [5873](#L5873) | } |
| [5874](#L5874) |  |
| [5875](#L5875) | // Pop-up dialogs ------------------------------------------------------------- |
| [5876](#L5876) |  |
| [5877](#L5877) | /\*\* |
| [5878](#L5878) | \* Creates a pop-up dialog window with a button that opens the dialog. |
| [5879](#L5879) | \* |
| [5880](#L5880) | \* @param array $fields Form fields - left side |
| [5881](#L5881) | \* @param array $aside Form fields - right side, optional |
| [5882](#L5882) | \* @param string $label Button label |
| [5883](#L5883) | \* @param string $button\_icon Button icon |
| [5884](#L5884) | \* @param string $method Form method |
| [5885](#L5885) | \* @param null $action Form action |
| [5886](#L5886) | \* |
| [5887](#L5887) | \* @return string The HTML code of the pop-up prepared to add to the web page |
| [5888](#L5888) | \* |
| [5889](#L5889) | \* @since 8.9.5.3 |
| [5890](#L5890) | \*/ |
| [5891](#L5891) | function crb\_create\_popup\_dialog( $fields, $aside = array(), $label = '', $button\_icon = '', $method = 'get', $action = null ) { |
| [5892](#L5892) | static $counter = 0; |
| [5893](#L5893) |  |
| [5894](#L5894) | $counter ++; // In case of multiple dialogs on a page |
| [5895](#L5895) |  |
| [5896](#L5896) | if ( $button\_icon ) { |
| [5897](#L5897) | $control = '<a data-popup\_element\_id="crb-popup-dialog-' . $counter . '" class="button button-secondary cerber-button crb-popup-dialog-open" href="#" style="margin-right: 0.5em;"><i class="crb-icon ' . $button\_icon . '"></i> ' . $label . '</a>'; |
| [5898](#L5898) | } |
| [5899](#L5899) | else { |
| [5900](#L5900) | $control = '<a data-popup\_element\_id="crb-popup-dialog-' . $counter . '" class="crb-popup-dialog-open" href="#">' . $label . '</a>'; |
| [5901](#L5901) | } |
| [5902](#L5902) |  |
| [5903](#L5903) | if ( $aside ) { |
| [5904](#L5904) | $class = 'crb-table-2cols'; |
| [5905](#L5905) | $td\_aside = '<td><div class="crb-popup-dialog-aside">' . crb\_create\_dialog\_form( $aside ) . '</div></td>'; |
| [5906](#L5906) | $last\_row = '<td></td>'; |
| [5907](#L5907) | } |
| [5908](#L5908) | else { |
| [5909](#L5909) | $class = 'crb-table-1col'; |
| [5910](#L5910) | $td\_aside = ''; |
| [5911](#L5911) | $last\_row = ''; |
| [5912](#L5912) | } |
| [5913](#L5913) |  |
| [5914](#L5914) | $dialog = $control; |
| [5915](#L5915) |  |
| [5916](#L5916) | $dialog .= '<div id="crb-popup-dialog-' . $counter . '" class="mfp-hide crb-popup-dialog">'; |
| [5917](#L5917) | $dialog .= '<form action="' . ( $action ?? crb\_get\_admin\_base() ) . '" method="' . $method . '">'; |
| [5918](#L5918) | $dialog .= '<table class="' . $class . '">'; |
| [5919](#L5919) | $dialog .= '<tr><td>' . crb\_create\_dialog\_form( $fields ) . '</td>' . $td\_aside . '</tr>'; |
| [5920](#L5920) |  |
| [5921](#L5921) | $dialog .= '<tr>' . $last\_row . '<td style="text-align: center"> |
| [5922](#L5922) | <input type="submit" class="button button-primary" value="' . \_\_( 'OK', 'wp-cerber' ) . '" style="min-width: 6rem;"> |
| [5923](#L5923) | &nbsp; <input type="button" class="button button-secondary crb-popup-dialog-close" value="' . \_\_( 'Cancel', 'wp-cerber' ) . '" style="min-width: 6rem;"> |
| [5924](#L5924) | </td></tr>'; |
| [5925](#L5925) |  |
| [5926](#L5926) | $dialog .= '</table></form></div>'; |
| [5927](#L5927) |  |
| [5928](#L5928) | return $dialog; |
| [5929](#L5929) | } |
| [5930](#L5930) |  |
| [5931](#L5931) | /\*\* |
| [5932](#L5932) | \* Creates a basic HTML form for pop-up dialogs |
| [5933](#L5933) | \* |
| [5934](#L5934) | \* @param array $form\_data List of form fields |
| [5935](#L5935) | \* |
| [5936](#L5936) | \* @return string HTML code |
| [5937](#L5937) | \* |
| [5938](#L5938) | \* @since 8.9.5.3 |
| [5939](#L5939) | \*/ |
| [5940](#L5940) | function crb\_create\_dialog\_form( $form\_data ) { |
| [5941](#L5941) |  |
| [5942](#L5942) | $form = ''; |
| [5943](#L5943) |  |
| [5944](#L5944) | if ( $title = $form\_data['title'] ?? '' ) { |
| [5945](#L5945) | $form .= '<h3>' . $title . '</h3>'; |
| [5946](#L5946) | } |
| [5947](#L5947) |  |
| [5948](#L5948) | $form .= $form\_data['html'] ?? ''; |
| [5949](#L5949) |  |
| [5950](#L5950) | $hidden = $form\_data['hidden'] ?? array(); |
| [5951](#L5951) |  |
| [5952](#L5952) | foreach ( $hidden as $field => $value ) { |
| [5953](#L5953) | if ( is\_array( $value ) ) { |
| [5954](#L5954) | foreach ( $value as $val ) { |
| [5955](#L5955) | $form .= '<input type="hidden" name="' . $field . '[]" value="' . htmlspecialchars( $val ) . '">' . "\n"; |
| [5956](#L5956) | } |
| [5957](#L5957) | } |
| [5958](#L5958) | else { |
| [5959](#L5959) | $form .= '<input type="hidden" name="' . $field . '" value="' . htmlspecialchars( $value ) . '">' . "\n"; |
| [5960](#L5960) | } |
| [5961](#L5961) | } |
| [5962](#L5962) |  |
| [5963](#L5963) | $form .= '<table class="crb-form-fields">'; |
| [5964](#L5964) |  |
| [5965](#L5965) | $visible = $form\_data['visible'] ?? array(); |
| [5966](#L5966) |  |
| [5967](#L5967) | foreach ( $visible as $field => $config ) { |
| [5968](#L5968) |  |
| [5969](#L5969) | $atts = ''; |
| [5970](#L5970) |  |
| [5971](#L5971) | foreach ( $config['atts'] as $att => $val ) { |
| [5972](#L5972) | $atts .= ' ' . $att . '="' . $val . '" '; |
| [5973](#L5973) | } |
| [5974](#L5974) |  |
| [5975](#L5975) | $input = '<input id="' . $field . '" name="' . $field . '" value="' . htmlspecialchars( $config['value'] ) . '" ' . $atts . '>'; |
| [5976](#L5976) | $label = '<label for="' . $field . '">' . $config['label'] . '</label>'; |
| [5977](#L5977) |  |
| [5978](#L5978) | $type = $config['atts']['type'] ?? ''; |
| [5979](#L5979) |  |
| [5980](#L5980) | $form .= '<tr><td>'; |
| [5981](#L5981) |  |
| [5982](#L5982) | if ( $type == 'checkbox' ) { |
| [5983](#L5983) | $form .= '<div class="crb-wrap-' . $type . '"><div>' . $input .'</div><div>'. $label . '</div></div>'; |
| [5984](#L5984) | } |
| [5985](#L5985) | else { |
| [5986](#L5986) | $form .= $label . '<div>' . $input . '</div>'; |
| [5987](#L5987) | } |
| [5988](#L5988) |  |
| [5989](#L5989) | $form .= '</td></tr>'; |
| [5990](#L5990) | } |
| [5991](#L5991) |  |
| [5992](#L5992) | $form .= '</table>'; |
| [5993](#L5993) |  |
| [5994](#L5994) | $mess = $form\_data['error\_messages'] ?? array(); |
| [5995](#L5995) |  |
| [5996](#L5996) | foreach ( $mess as $id => $msg ) { |
| [5997](#L5997) | $form .= '<p id="crb-message-' . $id . '" class="crb-error-text" style="display:none;">' . $msg . '</p>'; |
| [5998](#L5998) | } |
| [5999](#L5999) |  |
| [6000](#L6000) | return '<div class="crb-popup-dialog-form">' . $form . '</div>'; |
| [6001](#L6001) |  |
| [6002](#L6002) | } |
| [6003](#L6003) |  |
| [6004](#L6004) | // Setting up menu editor ----------------------------------------------------- |
| [6005](#L6005) |  |
| [6006](#L6006) | add\_action( 'admin\_head-nav-menus.php', function () { |
| [6007](#L6007) | add\_meta\_box( 'wp\_cerber\_nav\_menu', |
| [6008](#L6008) | 'WP Cerber', |
| [6009](#L6009) | 'cerber\_nav\_menu\_box', |
| [6010](#L6010) | 'nav-menus', |
| [6011](#L6011) | 'side', |
| [6012](#L6012) | 'low' ); |
| [6013](#L6013) | } ); |
| [6014](#L6014) |  |
| [6015](#L6015) | function cerber\_nav\_menu\_box() { |
| [6016](#L6016) |  |
| [6017](#L6017) | // Warning: do not change array indexes |
| [6018](#L6018) | $list = array( |
| [6019](#L6019) | 'login-url'  => \_\_( 'Log In', 'wp-cerber' ), |
| [6020](#L6020) | 'logout-url' => \_\_( 'Log Out', 'wp-cerber' ), |
| [6021](#L6021) | 'reg-url'    => \_\_( 'Register', 'wp-cerber' ), |
| [6022](#L6022) | ); |
| [6023](#L6023) | if ( class\_exists( 'WooCommerce' ) ) { |
| [6024](#L6024) | $list['wc-login-url']  = \_\_( 'WooCommerce Log In', 'wp-cerber' ); |
| [6025](#L6025) | $list['wc-logout-url'] = \_\_( 'WooCommerce Log Out', 'wp-cerber' ); |
| [6026](#L6026) | } |
| [6027](#L6027) |  |
| [6028](#L6028) | ?> |
| [6029](#L6029) | <div id="posttype-wp-cerber-nav" class="posttypediv"> |
| [6030](#L6030) | <div id="tabs-panel-wp-cerber-nav" class="tabs-panel tabs-panel-active"> |
| [6031](#L6031) | <ul id="wp-cerber-nav-checklist" class="categorychecklist form-no-clear"> |
| [6032](#L6032) | <?php |
| [6033](#L6033) | $i = - 1; |
| [6034](#L6034) | foreach ( $list as $key => $value ) : |
| [6035](#L6035) | $id = 'wp-cerber-' . $key; |
| [6036](#L6036) | ?> |
| [6037](#L6037) | <li> |
| [6038](#L6038) | <label class="menu-item-title"> |
| [6039](#L6039) | <input type="checkbox" class="menu-item-checkbox" |
| [6040](#L6040) | name="menu-item[<?php echo esc\_attr( $i ); ?>][menu-item-object-id]" |
| [6041](#L6041) | value="<?php echo esc\_attr( $i ); ?>"/> <?php echo esc\_html( $value ); ?> |
| [6042](#L6042) | </label> |
| [6043](#L6043) | <input type="hidden" class="menu-item-type" |
| [6044](#L6044) | name="menu-item[<?php echo esc\_attr( $i ); ?>][menu-item-type]" value="custom"/> |
| [6045](#L6045) | <input type="hidden" class="menu-item-title" |
| [6046](#L6046) | name="menu-item[<?php echo esc\_attr( $i ); ?>][menu-item-title]" |
| [6047](#L6047) | value="<?php echo esc\_html( $value ); ?>"/> |
| [6048](#L6048) | <input type="hidden" class="menu-item-url" |
| [6049](#L6049) | name="menu-item[<?php echo esc\_attr( $i ); ?>][menu-item-url]" |
| [6050](#L6050) | value="<?php echo '#will-be-generated-automatically'; ?>"/> |
| [6051](#L6051) | <input type="hidden" class="menu-item-attr-title" |
| [6052](#L6052) | name="menu-item[<?php echo esc\_attr( $i ); ?>][menu-item-attr-title]" |
| [6053](#L6053) | value="<?php echo '\*MENU\*CERBER\*|' . $id; ?>"/> |
| [6054](#L6054) | </li> |
| [6055](#L6055) | <?php |
| [6056](#L6056) | $i --; |
| [6057](#L6057) | endforeach; |
| [6058](#L6058) | ?> |
| [6059](#L6059) | </ul> |
| [6060](#L6060) | </div> |
| [6061](#L6061) | <p class="button-controls"> |
| [6062](#L6062) | <span class="add-to-menu"> |
| [6063](#L6063) | <button type="submit" class="button-secondary submit-add-to-menu right" |
| [6064](#L6064) | value="<?php esc\_attr\_e( 'Add to menu' ); ?>" name="add-post-type-menu-item" |
| [6065](#L6065) | id="submit-posttype-wp-cerber-nav"><?php esc\_html\_e( 'Add to menu' ); ?></button> |
| [6066](#L6066) | <span class="spinner"></span> |
| [6067](#L6067) | </span> |
| [6068](#L6068) | </p> |
| [6069](#L6069) | </div> |
| [6070](#L6070) | <?php |
| [6071](#L6071) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-cerber/trunk/admin/cerber-dashboard.php?rev=2721561&format=txt)
* [Original Format](/export/2721561/wp-cerber/trunk/admin/cerber-dashboard.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


