=== Content from github.com_3f11a629_20250114_191720.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1588)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1588)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=unicorn-engine%2Funicorn)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unicorn-engine](/unicorn-engine)
/
**[unicorn](/unicorn-engine/unicorn)**
Public

* [Notifications](/login?return_to=%2Funicorn-engine%2Funicorn) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Funicorn-engine%2Funicorn)
* [Star
   7.8k](/login?return_to=%2Funicorn-engine%2Funicorn)

* [Code](/unicorn-engine/unicorn)
* [Issues
  108](/unicorn-engine/unicorn/issues)
* [Pull requests
  13](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects
  0](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

Additional navigation options

* [Code](/unicorn-engine/unicorn)
* [Issues](/unicorn-engine/unicorn/issues)
* [Pull requests](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Null pointer dereference in `qemu_ram_free` when HVA malloc fails #1588

Closed

[liyansong2018](/liyansong2018) opened this issue
Apr 12, 2022
· 2 comments

Closed

# [Null pointer dereference in `qemu_ram_free` when HVA malloc fails](#top) #1588

[liyansong2018](/liyansong2018) opened this issue
Apr 12, 2022
· 2 comments

## Comments

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=80&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)

Copy link

Contributor

### **[liyansong2018](/liyansong2018)** commented [Apr 12, 2022](#issue-1201749652) • edited Loading

| When we try to use `uc_mem_map` to apply for super large memory, memory allocation in HAV fails, but succeeds in GVA. This inconsistency leads to null pointer dereference in `us_ close` release about the ram block requested by `uc_mem_map`.  PoC  ``` int main(int argc, char **argv) {     uc_engine *uc;     uc_err err;     err = uc_open(UC_ARCH_X86, UC_MODE_64, &uc);     if (err != UC_ERR_OK) {         printf("Failed on uc_open() with error returned: %u %s\n", err, uc_strerror(err));         return -1;     }      err = uc_mem_map(uc, 0x0, 0xfffffffff000, UC_PROT_ALL);     if (err != UC_ERR_OK) {         printf("Failed on uc_open() with error returned: %u %s\n", err, uc_strerror(err));         //return -1;     }     uc_close(uc);     return 0; } ```  output  ``` $ ./poc_test AddressSanitizer:DEADLYSIGNAL ================================================================= ==36945==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7f6f0c61dc5f bp 0x7ffd6adc9320 sp 0x7ffd6adc9310 T0)                                                                                                                    ==36945==The signal is caused by a WRITE memory access.                                                                     ==36945==Hint: address points to the zero page.     #0 0x7f6f0c61dc5f in qemu_ram_free_x86_64 /home/lys/Documents/my/unicorn/qemu/exec.c:1133     #1 0x7f6f0c624483 in memory_region_destructor_ram /home/lys/Documents/my/unicorn/qemu/softmmu/memory.c:882     #2 0x7f6f0c62269f in memory_free_x86_64 /home/lys/Documents/my/unicorn/qemu/softmmu/memory.c:182     #3 0x7f6f0c6169da in release_common /home/lys/Documents/my/unicorn/qemu/unicorn_common.h:62     #4 0x7f6f0c616cd3 in x86_release /home/lys/Documents/my/unicorn/qemu/target/i386/unicorn.c:47     #5 0x7f6f0c60e4c5 in uc_close /home/lys/Documents/my/unicorn/uc.c:419     #6 0x55955d1423e1 in main /home/lys/Documents/unitest/poc_test.c:60     #7 0x7f6f0c0d47ec in __libc_start_main ../csu/libc-start.c:332     #8 0x55955d142129 in _start (/home/lys/Documents/unitest/poc_test+0x1129)  AddressSanitizer can not provide additional info. SUMMARY: AddressSanitizer: SEGV /home/lys/Documents/my/unicorn/qemu/exec.c:1133 in qemu_ram_free_x86_64 ==36945==ABORTING ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=40&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)
[liyansong2018](/liyansong2018)
changed the title
~~Null pointer dereference in `qemu_ram_free` when HVA malloc failed~~
Null pointer dereference in `qemu_ram_free` when HVA malloc fails
[Apr 12, 2022](#event-6418550212)

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=80&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)

Copy link

Contributor

Author

### **[liyansong2018](/liyansong2018)** commented [Apr 12, 2022](#issuecomment-1096649084) • edited Loading

| There are many ways to fix this bug. I will pull request with a simple patch later. |
| --- |

All reactions

Sorry, something went wrong.

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=40&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)
[liyansong2018](/liyansong2018)
mentioned this issue
[Apr 13, 2022](#ref-pullrequest-1201801936)

[Fix unicorn-engine#1588 #1590
#1589](/unicorn-engine/unicorn/pull/1589)
 Closed

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=80&u=0349d29c906330eae5e106f37944c0e34ede49f5&v=4)](/wtdcode)

Copy link

Member

### **[wtdcode](/wtdcode)** commented [Apr 16, 2022](#issuecomment-1100712583)

| Fixed in [3d3deac](https://github.com/unicorn-engine/unicorn/commit/3d3deac5e6d38602b689c4fef5dac004f07a2e63) |
| --- |

All reactions

Sorry, something went wrong.

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=40&u=0349d29c906330eae5e106f37944c0e34ede49f5&v=4)](/wtdcode)
[wtdcode](/wtdcode)
closed this as [completed](/unicorn-engine/unicorn/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Apr 16, 2022](#event-6443633441)

[![@jba](https://avatars.githubusercontent.com/u/18483045?s=40&v=4)](/jba)
[jba](/jba)
mentioned this issue
[Jun 2, 2022](#ref-issue-1258232991)

[x/vulndb: potential Go vuln in github.com/unicorn-engine/unicorn: CVE-2022-29694
jba/nested-modules#337](/jba/nested-modules/issues/337)

Open

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this issue
[Jun 2, 2022](#ref-issue-1258233095)

[x/vulndb: potential Go vuln in github.com/unicorn-engine/unicorn: CVE-2022-29694
golang/vulndb#472](/golang/vulndb/issues/472)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1588)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=52&v=4)](/liyansong2018) [![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=52&v=4)](/wtdcode)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from violentbinary.github.io_b807674a_20250114_191725.html ===

[![/images/binary-code.png](/svg/loading.min.svg "/images/binary-code.png") Violent Binary](/ "Violent Binary")

 [Posts](/posts/)  [Tags](/tags/)  [Categories](/categories/) English
English简体中文

[![/images/binary-code.png](/svg/loading.min.svg "/images/binary-code.png") Violent Binary](/ "Violent Binary")

[Posts](/posts/)[Tags](/tags/)[Categories](/categories/)English
English简体中文

## Contents

# Simple Analysis of Software Virtualization of Memory in Unicorn Engine

[liyansong](/ "Author") included in [Virtualization](/categories/virtualization/) [Vulnerability Analysis](/categories/vulnerability-analysis/)
 2022-04-14  1009 words
 5 minutes
  views

![/images/2-null-pointer/title.png](/svg/loading.min.svg "/images/2-null-pointer/title.png")
Contents

* [Important Structure](#important-structure)
  + [Memory Region](#memory-region)
  + [RAM Block](#ram-block)
* [Entry to Memory](#entry-to-memory)
  + [Apply for Memory Region](#apply-for-memory-region)
  + [Apply for RAM Block](#apply-for-ram-block)
  + [CVE-2022-29694](#cve-2022-29694)
* [Fixs](#fixs)
* [Conclusion](#conclusion)

Unicorn Engine is cut from QEMU, it can be said to be a branch of QEMU, but it is a completely independent project. Unicorn provides a wealth of APIs, allowing us to easily experience many features brought by QEMU virtualization technology, but it also faces some security issues. We take the analysis of CVE-2022-29694 as an example to briefly outline the principle of Unicorn memory virtualization. Only some simple analysis is made here, so that everyone can quickly grasp the whole picture of QEMU virtualization.

## Important Structure

We first introduce two important structures in QEMU, namely `MemoryRegion` and `RAMBlock`. You can also look at the specific code in the following chapters, and then look back at the role of each domain member in them to achieve a better understanding.

[![../../../../images/2-null-pointer/MemoryManager.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/MemoryManager.png "MemoryManager")

Structure of memory manager

### Memory Region

MemoryRegion is an important structure in QEMU memory management, and it is a structure that manages each memory space of GVA(Guest Virtual Address).

```
struct MemoryRegion {
    /* private: */

    /* The following fields should fit in a cache line */
    bool ram;					//
    bool subpage;
    bool readonly; 				//
    bool is_iommu;
    RAMBlock *ram_block;		// physical address in virtual machine

    const MemoryRegionOps *ops;
    void *opaque;
    MemoryRegion *container;	// parent MemoryRegion
    Int128 size;
    hwaddr addr;
    void (*destructor)(MemoryRegion *mr);
    uint64_t align;
    bool terminates;
    bool enabled;
    int32_t priority;
    QTAILQ_HEAD(, MemoryRegion) subregions;
    QTAILQ_ENTRY(MemoryRegion) subregions_link;

    struct uc_struct *uc;
    uint32_t perms;
    hwaddr end;
};

```
### RAM Block

RAM Block represents a memory stick in the virtual machine, namely **GPA(Guest Physical Address)**. All RAMBlocks will be connected to the linked list through the next field, and the linked list header is `ram_list.blocks`.

```
struct RAMBlock {
    struct MemoryRegion *mr;		// GPA->GVA
    uint8_t *host;					// GPA->HVA
    ram_addr_t offset;				// The offset address of the memory stick in the entire virtual machine
    ram_addr_t used_length;			// used length
    ram_addr_t max_length;
    uint32_t flags;
    /* RCU-enabled, writes protected by the ramlist lock */
    QLIST_ENTRY(RAMBlock) next;
    size_t page_size;				// system page size
};

```
## Entry to Memory

`uc_mem_map` is an interface provided by Unicorn to users. We can use this function to apply for a memory space for the simulator. This space can not only store the instructions to be simulated, but also be used as the stack of the virtual machine.

```
uc_err uc_mem_map(uc_engine *uc, uint64_t address, size_t size, uint32_t perms)
{
    uc_err res;

    /* init unicorn */
    UC_INIT(uc);

    /* only defined in MIPS */
    if (uc->mem_redirect) {
        address = uc->mem_redirect(address);
    }

    /* For memory safety checks, check the incoming address range */
    res = mem_map_check(uc, address, size, perms);
    if (res) {
        return res;
    }

    /* mem_map mapped_blocks
     * memory_map GVA
     */
    return mem_map(uc, address, size, perms,
                   uc->memory_map(uc, address, size, perms));
}

```
### Apply for Memory Region

Continue to analyze `memory_map`, this function is defined in `qemu/softmmu/memory.c` file, used to formally apply for Memory Region. As can be seen from the function `memory_region_add_subregion`, Unicorn uses uc->system\_memory as a parent set to manage all Regions.

[![../../../../images/2-null-pointer/MemoryRegion.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/MemoryRegion.png "MemoryRegion")

Memory region in QEMU

Code

```
MemoryRegion *memory_map(struct uc_struct *uc, hwaddr begin, size_t size, uint32_t perms)
{
    /* ram */
    MemoryRegion *ram = g_new(MemoryRegion, 1);

    /* RAM allocation */
    memory_region_init_ram(uc, ram, size, perms);
    if (ram->addr == -1) {
        // out of memory
        return NULL;
    }

    /* system_memory->subregion = ram
     */
    memory_region_add_subregion(uc->system_memory, begin, ram);

    if (uc->cpu) {
        tlb_flush(uc->cpu);
    }

    return ram;
}

```

`memory_region_init_ram` is an important function for the virtual machine to request RAM.

```
void memory_region_init_ram(struct uc_struct *uc,
                            MemoryRegion *mr,
                            uint64_t size,
                            uint32_t perms)
{
    /* init MR */
    memory_region_init(uc, mr, size);
    mr->ram = true;
    if (!(perms & UC_PROT_WRITE)) {
        mr->readonly = true;
    }
    mr->perms = perms;
    mr->terminates = true;
    mr->destructor = memory_region_destructor_ram;
    /* important！apply for GPA and HVA */
    mr->ram_block = qemu_ram_alloc(uc, size, mr);
}

```

The function `qemu_ram_alloc` is the encapsulation of `qemu_ram_alloc_from_ptr`, which is used to apply for RAMBlock.

### Apply for RAM Block

RAMBlock initialization

```
RAMBlock *qemu_ram_alloc_from_ptr(struct uc_struct *uc, ram_addr_t size, void *host,
                                   MemoryRegion *mr)
{
    RAMBlock *new_block;
    ram_addr_t max_size = size;

    size = HOST_PAGE_ALIGN(uc, size);
    max_size = HOST_PAGE_ALIGN(uc, max_size);
    new_block = g_malloc0(sizeof(*new_block));
    if (new_block == NULL)
        return NULL;
    new_block->mr = mr;
    new_block->used_length = size;
    new_block->max_length = max_size;
    assert(max_size >= size);
    new_block->page_size = uc->qemu_real_host_page_size;
    new_block->host = host;
    if (host) {
        new_block->flags |= RAM_PREALLOC;
    }
    ram_block_add(mr->uc, new_block);

    return new_block;
}

```

The function `ram_block_add` is used to add a memory stick to the system. This function first applies for PVA(Physical Virutal Address), and then adds RAMBlock to the system space.

### CVE-2022-29694

The QEMU virtual machine applies for memory, and finally needs to apply for the corresponding memory on the host. Then the problem arises. When a virtual machine applies for a large memory, the actual application will inevitably fail. The following function does not return the status of the application result, and the current RAMBlock has not been added to `ram_list.blocks`.

[![../../../../images/2-null-pointer/CVE-2022.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/CVE-2022.png "CVE-2022")

Alloc memory in GPA->HVA

The upper layer function does not judge whether the applied HVA is successful, but the virtual machine defaults that the applied GVA has been successful. When the virtual machine is shut down, QEMU memory free is triggered. At this time, the block is not QLIST, resulting in null pointer dereference.

[![../../../../images/2-null-pointer/CVE-2022-1.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/CVE-2022-1.png "CVE-2022-1")

Null pinter to free QEMU ram

As shown below, when the virtual machine applies for large memory, the GVA is successful, but the GPA->HVA using the `mmap` function fails. Unsynchronized allocated memory results in a null pointer.

[![../../../../images/2-null-pointer/CVE-2022-2.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/CVE-2022-2.png "CVE-2022-2")

Analysis of vulnerability

## Fixs

The first repair method is relatively simple, directly using `QLIST_SAFE_REMOVE` provided by QEMU.

[![../../../../images/2-null-pointer/fix-1.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/fix-1.png "fix-1")

Patch 1

The second repair solution seems more reasonable, because the essence of this problem is the inconsistency of the judgment of applying for GVA and GPA, so it is necessary to add consistency judgment results of them.

[![../../../../images/2-null-pointer/fix-2.png](/svg/loading.min.svg)](../../../../images/2-null-pointer/fix-2.png "fix-2")

Patch 2

## Conclusion

This article is only a preliminary analysis of the process of Unicorn Engine memory virtualization, and introduces the general scheme for QEMU to apply for memory for virtual machines. QEMU memory virtualization is a complex process, and more mechanisms behind it need to be further studied in the future.

Updated on 2022-05-29

 [Unicorn](/tags/unicorn/), [QEMU](/tags/qemu/), [CVE](/tags/cve/)
Back | [Home](/)

[ELF Static Injection to Load Malicious Dynamic Link Library](/posts/1-elf-static-injection-to-load-malicious-dynamic-link-library/ "ELF Static Injection to Load Malicious Dynamic Link Library")

Please enable JavaScript to view the comments powered by [Valine](https://valine.js.org/).

Powered by [Hugo](https://gohugo.io/ "Hugo 0.89.0") | Theme -  [LoveIt](https://github.com/dillonzq/LoveIt "LoveIt 0.2.10")
2021 - 2022 [liyansong](/) | [CC BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/)



=== Content from github.com_f6651261_20250114_191718.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fcommit%2F3d3deac5e6d38602b689c4fef5dac004f07a2e63)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fcommit%2F3d3deac5e6d38602b689c4fef5dac004f07a2e63)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=unicorn-engine%2Funicorn)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unicorn-engine](/unicorn-engine)
/
**[unicorn](/unicorn-engine/unicorn)**
Public

* [Notifications](/login?return_to=%2Funicorn-engine%2Funicorn) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Funicorn-engine%2Funicorn)
* [Star
   7.8k](/login?return_to=%2Funicorn-engine%2Funicorn)

* [Code](/unicorn-engine/unicorn)
* [Issues
  108](/unicorn-engine/unicorn/issues)
* [Pull requests
  13](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects
  0](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

Additional navigation options

* [Code](/unicorn-engine/unicorn)
* [Issues](/unicorn-engine/unicorn/issues)
* [Pull requests](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

## Commit

[Permalink](/unicorn-engine/unicorn/commit/3d3deac5e6d38602b689c4fef5dac004f07a2e63)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix crash when mapping a big memory and calling uc\_close

[Browse files](/unicorn-engine/unicorn/tree/3d3deac5e6d38602b689c4fef5dac004f07a2e63)
Browse the repository at this point in the history

* Loading branch information

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=40&v=4)](/wtdcode)

[wtdcode](/unicorn-engine/unicorn/commits?author=wtdcode "View all commits by wtdcode")
committed
Apr 16, 2022

1 parent
[cf18982](/unicorn-engine/unicorn/commit/cf18982e1c29d354805863a8e017cddd974e3114)

commit 3d3deac

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**353 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* qemu

  + qemu/exec.c
    [exec.c](#diff-c1efa53607a49f1108605a8886903b5e6fe9d2faf4acb21417ec318cfcc7e753)
  + include/qemu

    - qemu/include/qemu/atomic.h
      [atomic.h](#diff-5aaf1bd0cf6bc22b01ec672536bb017857dd11b8d940f4d07edb4b19ca1bd176)
    - qemu/include/qemu/rcu\_queue.h
      [rcu\_queue.h](#diff-d1d3e656bde16d1583b156eae782109d350a3f6d6d9ea6ba0da9873d575b26be)
  + softmmu

    - qemu/softmmu/memory.c
      [memory.c](#diff-92d454cb3b4a0181bb14fd349c84c980479f43b3252a8142d1e66188f4aca50a)
* tests/unit

  + tests/unit/test\_mem.c
    [test\_mem.c](#diff-88a5fbffe2f4e7fa34c81156daaf2c225b167bd21bf80a4a9cd51c144fc12812)

## There are no files selected for viewing

21 changes: 15 additions & 6 deletions

21
[qemu/exec.c](#diff-c1efa53607a49f1108605a8886903b5e6fe9d2faf4acb21417ec318cfcc7e753 "qemu/exec.c")

Show comments

[View file](/unicorn-engine/unicorn/blob/3d3deac5e6d38602b689c4fef5dac004f07a2e63/qemu/exec.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -42,7 +42,7 @@ |
|  |  | #include "exec/ram\_addr.h" |
|  |  |  |
|  |  | #include "qemu/range.h" |
|  |  |  |
|  |  | #include "qemu/rcu\_queue.h" |
|  |  | #include "uc\_priv.h" |
|  |  |  |
|  |  | typedef struct PhysPageEntry PhysPageEntry; |
| Expand Down  Expand Up | | @@ -966,7 +966,7 @@ static ram\_addr\_t find\_ram\_offset(struct uc\_struct \*uc, ram\_addr\_t size) |
|  |  |  |
|  |  | assert(size != 0); /\* it would hand out same offset multiple times \*/ |
|  |  |  |
|  |  | if (QLIST\_EMPTY(&uc->ram\_list.blocks)) { |
|  |  | if (QLIST\_EMPTY\_RCU(&uc->ram\_list.blocks)) { |
|  |  | return 0; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1043,6 +1043,8 @@ static void ram\_block\_add(struct uc\_struct \*uc, RAMBlock \*new\_block) |
|  |  | new\_block->host = phys\_mem\_alloc(uc, new\_block->max\_length, |
|  |  | &new\_block->mr->align); |
|  |  | if (!new\_block->host) { |
|  |  | // mmap fails. |
|  |  | uc->invalid\_error = UC\_ERR\_NOMEM; |
|  |  | // error\_setg\_errno(errp, errno, |
|  |  | // "cannot set up guest memory '%s'", |
|  |  | // memory\_region\_name(new\_block->mr)); |
| Expand All | | @@ -1062,11 +1064,11 @@ static void ram\_block\_add(struct uc\_struct \*uc, RAMBlock \*new\_block) |
|  |  | } |
|  |  | } |
|  |  | if (block) { |
|  |  | QLIST\_INSERT\_BEFORE(block, new\_block, next); |
|  |  | QLIST\_INSERT\_BEFORE\_RCU(block, new\_block, next); |
|  |  | } else if (last\_block) { |
|  |  | QLIST\_INSERT\_AFTER(last\_block, new\_block, next); |
|  |  | QLIST\_INSERT\_AFTER\_RCU(last\_block, new\_block, next); |
|  |  | } else { /\* list is empty \*/ |
|  |  | QLIST\_INSERT\_HEAD(&uc->ram\_list.blocks, new\_block, next); |
|  |  | QLIST\_INSERT\_HEAD\_RCU(&uc->ram\_list.blocks, new\_block, next); |
|  |  | } |
|  |  | uc->ram\_list.mru\_block = NULL; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1099,8 +1101,15 @@ RAMBlock \*qemu\_ram\_alloc\_from\_ptr(struct uc\_struct \*uc, ram\_addr\_t size, void \*h |
|  |  | if (host) { |
|  |  | new\_block->flags |= RAM\_PREALLOC; |
|  |  | } |
|  |  |  |
|  |  | uc->invalid\_addr = UC\_ERR\_OK; |
|  |  | ram\_block\_add(mr->uc, new\_block); |
|  |  |  |
|  |  | if (uc->invalid\_error != UC\_ERR\_OK) { |
|  |  | g\_free(new\_block); |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | return new\_block; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1130,7 +1139,7 @@ void qemu\_ram\_free(struct uc\_struct \*uc, RAMBlock \*block) |
|  |  | // ram\_block\_notify\_remove(block->host, block->max\_length); |
|  |  | //} |
|  |  |  |
|  |  | QLIST\_REMOVE(block, next); |
|  |  | QLIST\_REMOVE\_RCU(block, next); |
|  |  | uc->ram\_list.mru\_block = NULL; |
|  |  | /\* Write list before version \*/ |
|  |  | //smp\_wmb(); |
| Expand Down | |  |

53 changes: 53 additions & 0 deletions

53
[qemu/include/qemu/atomic.h](#diff-5aaf1bd0cf6bc22b01ec672536bb017857dd11b8d940f4d07edb4b19ca1bd176 "qemu/include/qemu/atomic.h")

Show comments

[View file](/unicorn-engine/unicorn/blob/3d3deac5e6d38602b689c4fef5dac004f07a2e63/qemu/include/qemu/atomic.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -115,6 +115,19 @@ |
|  |  | atomic\_set\_\_nocheck(ptr, i); \ |
|  |  | } while(0) |
|  |  |  |
|  |  | #define atomic\_rcu\_read(ptr) \ |
|  |  | ({ \ |
|  |  | QEMU\_BUILD\_BUG\_ON(sizeof(\*ptr) > ATOMIC\_REG\_SIZE); \ |
|  |  | typeof\_strip\_qual(\*ptr) \_val; \ |
|  |  | atomic\_rcu\_read\_\_nocheck(ptr, &\_val); \ |
|  |  | \_val; \ |
|  |  | }) |
|  |  |  |
|  |  | #define atomic\_rcu\_set(ptr, i) do { \ |
|  |  | QEMU\_BUILD\_BUG\_ON(sizeof(\*ptr) > ATOMIC\_REG\_SIZE); \ |
|  |  | \_\_atomic\_store\_n(ptr, i, \_\_ATOMIC\_RELEASE); \ |
|  |  | } while(0) |
|  |  |  |
|  |  | /\* All the remaining operations are fully sequentially consistent \*/ |
|  |  |  |
|  |  | #define atomic\_xchg\_\_nocheck(ptr, i) ({ \ |
| Expand Down  Expand Up | | @@ -192,6 +205,46 @@ |
|  |  | #define atomic\_read(ptr) atomic\_read\_\_nocheck(ptr) |
|  |  | #define atomic\_set(ptr, i) atomic\_set\_\_nocheck(ptr,i) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* atomic\_rcu\_read - reads a RCU-protected pointer to a local variable |
|  |  | \* into a RCU read-side critical section. The pointer can later be safely |
|  |  | \* dereferenced within the critical section. |
|  |  | \* |
|  |  | \* This ensures that the pointer copy is invariant thorough the whole critical |
|  |  | \* section. |
|  |  | \* |
|  |  | \* Inserts memory barriers on architectures that require them (currently only |
|  |  | \* Alpha) and documents which pointers are protected by RCU. |
|  |  | \* |
|  |  | \* atomic\_rcu\_read also includes a compiler barrier to ensure that |
|  |  | \* value-speculative optimizations (e.g. VSS: Value Speculation |
|  |  | \* Scheduling) does not perform the data read before the pointer read |
|  |  | \* by speculating the value of the pointer. |
|  |  | \* |
|  |  | \* Should match atomic\_rcu\_set(), atomic\_xchg(), atomic\_cmpxchg(). |
|  |  | \*/ |
|  |  | #define atomic\_rcu\_read(ptr) ({ \ |
|  |  | typeof(\*ptr) \_val = atomic\_read(ptr); \ |
|  |  | smp\_read\_barrier\_depends(); \ |
|  |  | \_val; \ |
|  |  | }) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* atomic\_rcu\_set - assigns (publicizes) a pointer to a new data structure |
|  |  | \* meant to be read by RCU read-side critical sections. |
|  |  | \* |
|  |  | \* Documents which pointers will be dereferenced by RCU read-side critical |
|  |  | \* sections and adds the required memory barriers on architectures requiring |
|  |  | \* them. It also makes sure the compiler does not reorder code initializing the |
|  |  | \* data structure before its publication. |
|  |  | \* |
|  |  | \* Should match atomic\_rcu\_read(). |
|  |  | \*/ |
|  |  | #define atomic\_rcu\_set(ptr, i) do { \ |
|  |  | smp\_wmb(); \ |
|  |  | atomic\_set(ptr, i); \ |
|  |  | } while (0) |
|  |  |  |
|  |  | #define atomic\_xchg\_\_nocheck atomic\_xchg |
|  |  |  |
|  |  | /\* Provide shorter names for GCC atomic builtins. \*/ |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3d3deac`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fcommit%2F3d3deac5e6d38602b689c4fef5dac004f07a2e63) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0e292b45_20250114_191723.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fpull%2F1593%2Fcommits%2F31389e59457f304be3809f9679f91a42daa7ebaa)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fpull%2F1593%2Fcommits%2F31389e59457f304be3809f9679f91a42daa7ebaa)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=unicorn-engine%2Funicorn)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unicorn-engine](/unicorn-engine)
/
**[unicorn](/unicorn-engine/unicorn)**
Public

* [Notifications](/login?return_to=%2Funicorn-engine%2Funicorn) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Funicorn-engine%2Funicorn)
* [Star
   7.8k](/login?return_to=%2Funicorn-engine%2Funicorn)

* [Code](/unicorn-engine/unicorn)
* [Issues
  108](/unicorn-engine/unicorn/issues)
* [Pull requests
  13](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects
  0](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

Additional navigation options

* [Code](/unicorn-engine/unicorn)
* [Issues](/unicorn-engine/unicorn/issues)
* [Pull requests](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)
to your account

# Fix https://github.com/unicorn-engine/unicorn/issues/1588 #1593

 Closed

[liyansong2018](/liyansong2018)
wants to merge
2
commits into
[unicorn-engine:dev](/unicorn-engine/unicorn/tree/dev "unicorn-engine/unicorn:dev")
from
liyansong2018:dev

[Conversation
1](/unicorn-engine/unicorn/pull/1593)
[Commits
2](/unicorn-engine/unicorn/pull/1593/commits)
[Checks
0](/unicorn-engine/unicorn/pull/1593/checks)
[Files changed](/unicorn-engine/unicorn/pull/1593/files)

 Closed

# [Fix https://github.com/unicorn-engine/unicorn/issues/1588](#top) #1593

 Show file tree

 Hide file tree

Changes from **1 commit**

Commits

[Show all changes

2 commits](/unicorn-engine/unicorn/pull/1593/files)
Select commit
Hold shift + click to select a range

[`6a879a0`
Fix https://github.com/unicorn-engine/unicorn/issues/1588

liyansong2018 Apr 13, 2022](/unicorn-engine/unicorn/pull/1593/commits/6a879a082d4d67a5d13f1233ae0334cde0a7f844)
[`31389e5`
More reasonable fix https://github.com/unicorn-engine/unicorn/issues/…

liyansong2018 Apr 14, 2022](/unicorn-engine/unicorn/pull/1593/commits/31389e59457f304be3809f9679f91a42daa7ebaa)

**File filter**

### Filter by extension

Filter by extension

.c
(2)

All 1 file type selected

---

Viewed files

[Clear filters](/unicorn-engine/unicorn/pull/1593/commits/31389e59457f304be3809f9679f91a42daa7ebaa)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

* qemu

  + qemu/exec.c
    [exec.c](#diff-c1efa53607a49f1108605a8886903b5e6fe9d2faf4acb21417ec318cfcc7e753)
  + softmmu

    - qemu/softmmu/memory.c
      [memory.c](#diff-92d454cb3b4a0181bb14fd349c84c980479f43b3252a8142d1e66188f4aca50a)

 [Prev](/unicorn-engine/unicorn/pull/1593/commits/6a879a082d4d67a5d13f1233ae0334cde0a7f844)Previous commit

Next

More reasonable fix [#1588](https://github.com/unicorn-engine/unicorn/issues/1588)

* Loading branch information

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=40&v=4)](/liyansong2018)

[liyansong2018](/unicorn-engine/unicorn/commits?author=liyansong2018 "View all commits by liyansong2018")
committed
Apr 14, 2022

commit 31389e59457f304be3809f9679f91a42daa7ebaa

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[qemu/exec.c](#diff-c1efa53607a49f1108605a8886903b5e6fe9d2faf4acb21417ec318cfcc7e753 "qemu/exec.c")

Show comments

[View file](/unicorn-engine/unicorn/blob/31389e59457f304be3809f9679f91a42daa7ebaa/qemu/exec.c)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1130,7 +1130,7 @@ void qemu\_ram\_free(struct uc\_struct \*uc, RAMBlock \*block) |
|  |  | // ram\_block\_notify\_remove(block->host, block->max\_length); |
|  |  | //} |
|  |  |  |
|  |  | QLIST\_SAFE\_REMOVE(block, next); |
|  |  | QLIST\_REMOVE(block, next); |
|  |  | uc->ram\_list.mru\_block = NULL; |
|  |  | /\* Write list before version \*/ |
|  |  | //smp\_wmb(); |
| Expand Down | |  |

9 changes: 7 additions & 2 deletions

9
[qemu/softmmu/memory.c](#diff-92d454cb3b4a0181bb14fd349c84c980479f43b3252a8142d1e66188f4aca50a "qemu/softmmu/memory.c")

Show comments

[View file](/unicorn-engine/unicorn/blob/31389e59457f304be3809f9679f91a42daa7ebaa/qemu/softmmu/memory.c)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -43,12 +43,17 @@ MemoryRegion \*memory\_map(struct uc\_struct \*uc, hwaddr begin, size\_t size, uint32 |
|  |  | MemoryRegion \*ram = g\_new(MemoryRegion, 1); |
|  |  |  |
|  |  | memory\_region\_init\_ram(uc, ram, size, perms); |
|  |  | if (ram->addr == -1) { |
|  |  | // out of memory |
|  |  | if (!ram->ram\_block->host) { |
|  |  | g\_free(ram->ram\_block); |
|  |  | g\_free(ram); |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | memory\_region\_add\_subregion(uc->system\_memory, begin, ram); |
|  |  | if (ram->addr == -1) { |
|  |  | // out of memory |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | if (uc->cpu) { |
|  |  | tlb\_flush(uc->cpu); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bef0f4dc_20250114_191724.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fpull%2F1593%2Fcommits%2F6a879a082d4d67a5d13f1233ae0334cde0a7f844)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fpull%2F1593%2Fcommits%2F6a879a082d4d67a5d13f1233ae0334cde0a7f844)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=unicorn-engine%2Funicorn)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unicorn-engine](/unicorn-engine)
/
**[unicorn](/unicorn-engine/unicorn)**
Public

* [Notifications](/login?return_to=%2Funicorn-engine%2Funicorn) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Funicorn-engine%2Funicorn)
* [Star
   7.8k](/login?return_to=%2Funicorn-engine%2Funicorn)

* [Code](/unicorn-engine/unicorn)
* [Issues
  108](/unicorn-engine/unicorn/issues)
* [Pull requests
  13](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects
  0](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

Additional navigation options

* [Code](/unicorn-engine/unicorn)
* [Issues](/unicorn-engine/unicorn/issues)
* [Pull requests](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)
to your account

# Fix https://github.com/unicorn-engine/unicorn/issues/1588 #1593

 Closed

[liyansong2018](/liyansong2018)
wants to merge
2
commits into
[unicorn-engine:dev](/unicorn-engine/unicorn/tree/dev "unicorn-engine/unicorn:dev")
from
liyansong2018:dev

[Conversation
1](/unicorn-engine/unicorn/pull/1593)
[Commits
2](/unicorn-engine/unicorn/pull/1593/commits)
[Checks
0](/unicorn-engine/unicorn/pull/1593/checks)
[Files changed](/unicorn-engine/unicorn/pull/1593/files)

 Closed

# [Fix https://github.com/unicorn-engine/unicorn/issues/1588](#top) #1593

Changes from **1 commit**

Commits

[Show all changes

2 commits](/unicorn-engine/unicorn/pull/1593/files)
Select commit
Hold shift + click to select a range

[`6a879a0`
Fix https://github.com/unicorn-engine/unicorn/issues/1588

liyansong2018 Apr 13, 2022](/unicorn-engine/unicorn/pull/1593/commits/6a879a082d4d67a5d13f1233ae0334cde0a7f844)
[`31389e5`
More reasonable fix https://github.com/unicorn-engine/unicorn/issues/…

liyansong2018 Apr 14, 2022](/unicorn-engine/unicorn/pull/1593/commits/31389e59457f304be3809f9679f91a42daa7ebaa)

**File filter**

### Filter by extension

Filter by extension

.c
(1)

All 1 file type selected

---

Viewed files

[Clear filters](/unicorn-engine/unicorn/pull/1593/commits/6a879a082d4d67a5d13f1233ae0334cde0a7f844)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Prev

 [Next](/unicorn-engine/unicorn/pull/1593/commits/31389e59457f304be3809f9679f91a42daa7ebaa)Next commit

Fix [#1588](https://github.com/unicorn-engine/unicorn/issues/1588)

* Loading branch information

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=40&v=4)](/liyansong2018)

[liyansong2018](/unicorn-engine/unicorn/commits?author=liyansong2018 "View all commits by liyansong2018")
committed
Apr 13, 2022

commit 6a879a082d4d67a5d13f1233ae0334cde0a7f844

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[qemu/exec.c](#diff-c1efa53607a49f1108605a8886903b5e6fe9d2faf4acb21417ec318cfcc7e753 "qemu/exec.c")

Show comments

[View file](/unicorn-engine/unicorn/blob/6a879a082d4d67a5d13f1233ae0334cde0a7f844/qemu/exec.c)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1130,7 +1130,7 @@ void qemu\_ram\_free(struct uc\_struct \*uc, RAMBlock \*block) |
|  |  | // ram\_block\_notify\_remove(block->host, block->max\_length); |
|  |  | //} |
|  |  |  |
|  |  | QLIST\_REMOVE(block, next); |
|  |  | QLIST\_SAFE\_REMOVE(block, next); |
|  |  | uc->ram\_list.mru\_block = NULL; |
|  |  | /\* Write list before version \*/ |
|  |  | //smp\_wmb(); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


