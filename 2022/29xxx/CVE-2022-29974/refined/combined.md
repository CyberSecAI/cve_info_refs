=== Content from www.ami.com_199a63ed_20250114_183207.html ===


* [Contact Us](https://www.ami.com/contact-us/)

[![ami logo](https://www.ami.com/wp-content/uploads/2021/05/ami-_Accent_Red_White.png)](https://ami.com)

* [![ami logo](https://www.ami.com/wp-content/uploads/2021/05/ami-_Accent_Red_White-152x40.png)](https://www.ami.com)
* Solutions
  + [Open Source](/open-source/)
    - #### Aptio® and MegaRAC® OpenEditions, Available on GitHub Today

      The key to MegaRAC OpenEdition’s flexibility is a robust “common core” concept that delivers a highly-managed source base with high ROI, and a complete Service Processor Solution for wide product deployments. MegaRAC OpenEdition includes dedicated support, code patches and security advisories that all AMI customers trust and expect.

      Aptio OpenEdition, with all the benefits of Aptio V, now available in open source. Firmware features support for the latest UEFI specifications and the security, fast boot and touch support that today’s platforms require.
    - ![](https://www.ami.com/wp-content/uploads/2023/03/Open-source-200x300.jpg)
  + [Confidential Computing](/confidential-computing/)
    - #### AMI TruE® enabling Confidential Computing

      Leveraging Intel® SGX secure enclaves, AMI TruE enables secure computing, easy to deploy workload attestation and secure application keys without compromising confidentiality – to deliver a secure data center solution that is scalable, extensible and built for cloud-to-edge applications. It establishes and tracks the servers’ trusted compute status in the data center, complies with data security regulations and provides remediation for untrusted platforms. Adding support for these key security features makes AMI TruE a reliable and easily deployed solution for data centers and cloud service providers that delivers functional computing, attestation, confidential computing and cloud execution without compromise.
    - ![](https://www.ami.com/wp-content/uploads/2023/03/Confidential-Computing-200x300.jpg)
  + [Supply Chain Security](https://www.ami.com/server-platform-security/)
    - #### AMI FirST Builds a Platform of Trust

      The supply chain is a significant cybersecurity threat for mission-critical servers in modern data centers or enterprises. Before a device leaves the manufacturing site, it’s crucial for the original design manufacturers (ODMs), OEMs and firmware suppliers to work together to ensure the firmware is attested. At AMI, we are committed to helping maintain firmware integrity throughout the supply chain.
    - ![](https://www.ami.com/wp-content/uploads/2023/03/Supply-Chain-Security-200x300.jpg)
  + [Zero Trust Firmware](/zero-trust-firmware/)
    - #### Zero Trust Security Starts with Firmware

      Zero Trust security is essential for protecting an organization’s infrastructure and business critical data in today’s digital transformation. But without secure firmware running on the infrastructure, Zero Trust strategy weakens significantly.

      From your car to airport kiosks and power grids, nearly all technology is powered by firmware and for that reason, firmware attacks are on the rise. Firmware attacks are much more dangerous than OS-based attacks because firmware is invisible to OS-based security solutions.

      AMI’s Zero Trust firmware security solutions can help maintain firmware integrity and strengthen organizations’ Zero trust strategy.
    - ![](https://www.ami.com/wp-content/uploads/2022/06/iStock-599104976-1-259x300.jpg)
  + [Arm Solutions](https://www.ami.com/arm-solutions/)
    - #### Empower Your Arm Devices With AMI Foundational Firmware

      As an Arm license partner, one of your main objectives is to bring your designs to the market as quickly and efficiently as possible. However, this process can be fraught with challenges, and one of the biggest hurdles you may encounter is in the development of firmware. Firmware is a critical component of your device, ensuring that it powers on, runs securely, and stays on during its lifecycle. Developing firmware that meets these requirements can be a complex and time-consuming task, but it is essential for the success of your device.
    - ![](https://www.ami.com/wp-content/uploads/2023/01/Arm-Services-webpage_01252023-04-300x185.png)
* Products
  + - * BIOS/UEFI
        + [Aptio UEFI Firmware](/aptio/)
        + [Aptio CommunityEdition](/open-source/)
    - * Manageability
        + [MegaRAC OneTree](/megarac/#onetree)
        + [MegaRAC SP-X](/megarac/#sp-x)
        + [MegaRAC CommunityEdition](/open-source/#open-edition)
        + [Enclosure Management - Backplane](/backplane-controller/)
    - * Security
        + [Tektagon - Platform Root of Trust](/tektagon/)
        + [AMI CLEFS - Cloud-based Signing Service](/ami-clefs/)
    - * Meridian Services
        + [Data Center Manager (DCM)](/ami-dcm)
        + [Memory Resilience Technology (MRT)](/data-center-uptime/)
        + [Platform Attestation Service](/run-secure/)
* [Resources](/resources/)
* Developers
  + - * [Developer Support](https://www.ami.com/developer-support/)
        + [Customer Portal](https://cp.ami.com/SitePages/Home.aspx)
        + [Support Portal](https://eip.ami.com/eip/myStart.do;jsessionid=0EE98043F556F9A6F07237D87D3FDA56.eip-app1)
        + [Technical Support](https://www.ami.com/contact-us/)
    - * [Tools & Utilities](/tools-and-utilities/)
        + [BIOS / UEFI](/bios-uefi-utilities/)
        + [VeB Development Environment](/veb-development-environment/)
        + [MegaRAC Development Kit](https://www.ami.com/development-kits/)
* Company
  + [About](/about/)
  + [Careers](https://www.ami.com/careers-at-ami/)
  + [News & Events](https://www.ami.com/news/)
    - #### Recent Posts

      * [MegaRAC OneTree 2.0: New Release Available Now!](https://www.ami.com/blog/2025/01/09/megarac-onetree-2-0-new-release-available-now/)
        January 9, 2025
      * [The Role of Common-source Firmware in ODM-based Enterprise Datacenters](https://www.ami.com/blog/2024/12/20/the-role-of-common-source-firmware-in-odm-based-enterprise-datacenters/)
        December 20, 2024
      * [The New Frontier: The Enterprise OCP Model for Returning to On-premises](https://www.ami.com/blog/2024/12/06/the-new-frontier-the-enterprise-ocp-model-for-returning-to-on-premises/)
        December 6, 2024
      * [Wiwynn and AMI: Partnering on AI Cluster Management with AMI DCM](https://www.ami.com/blog/2024/11/18/wiwynn-and-ami-partnering-on-ai-cluster-management-with-ami-dcm/)
        November 18, 2024
      * [AMI at SC24: At the Core of Innovation, Powering HPC with Secure AI Server Manageability](https://www.ami.com/blog/2024/11/12/ami-at-sc24-at-the-core-of-innovation-powering-hpc-with-secure-ai-server-manageability/)
        November 12, 2024
  + [Locations](https://www.ami.com/office-locations/)
  + [AMI Trust Center](https://www.ami.com/trust-center/)
* [Contact Us](https://www.ami.com/contact-us/)
* [Blogs](https://www.ami.com/blog/)

# A DYNAMIC WORLD A SCALABLE WORLD A SECURE WORLD A SUSTAINABLE WORLD AN OPEN COMMUNITYRUNS ON AMI

Dynamic firmware at the heart of nearly every computing platform.

# A DYNAMIC WORLD A SCALABLE WORLD A SECURE WORLD A SUSTAINABLE WORLD AN OPEN COMMUNITYSTARTS ON AMI

Dynamic firmware at the heart of nearly every compute platform.

### We Enable the future of Compute

At AMI, we’re at the forefront of a new era of computing. Our Dynamic Firmware is the backbone that powers, manages, orchestrates, and secures modern compute environments. With a purpose-built design, it responds to dynamic workload needs and optimizes compute performance, ensuring scalability, security, sustainability, and ecosystem community. Join us in revolutionizing the world of computing.

![Power on icon](https://www.ami.com/wp-content/uploads/2023/02/Aptio-Centered-03.svg)
#### BIOS/UEFI Solutions

[Learn More](https://www.ami.com/aptio/)

![Power on icon](https://www.ami.com/wp-content/uploads/2023/02/MegaRAC_Tektagon_Aptio-Centered-01.svg)
#### BMC Manageability

[Learn More](https://www.ami.com/megarac/)

![Power on icon](https://www.ami.com/wp-content/uploads/2023/02/MegaRAC_Tektagon_Aptio-Centered-02.svg)
#### Platform Root of Trust

[Learn More](https://www.ami.com/tektagon/)

### We’re in a whole new era for firmware

AMI’s Dynamic Firmware is a one-firmware approach. It can adapt to various compute environments to meet workload needs, ensuring that server designs and management are robust and cost-effective. We are dedicated to delivering solutions that address four pillars:

#### Scalability

One firmware approach allows maximum scalability, flexibility, and adaptability for multiple purpose-built systems, fully leveraging a variety of specialized processing units.

#### Security

Platform security with Tektagon Platform Root of Trust (PRoT) is designed to provide foundational security for compute platforms, helping protect enterprise data.

#### Sustainability

Through our Dynamic Firmware technology, we strive to achieve sustainability in server designs and reduce the environmental impact of expanding carbon footprint from millions of servers in data centers across the world.

#### Community

Dynamic Firmware technology enables easier collaboration and customization. AMI actively engages in industry forums, open-source projects and more to stay ahead of the curve and share knowledge.

[Learn More Here](#startsonamivideo)

![](https://www.ami.com/wp-content/uploads/2022/05/iStock-599104976-scaled.jpg "Driven by the digital age")

## The World Runs on AMI

Nearly every meaningful technology company in the world relies on AMI solutions. AMI is an essential part of computing, found in embedded devices, servers, data centers and beyond. We’ve been partners with Intel for more than 25 years, with 70% percent of all server platforms everywhere powering up with AMI software.

[![](https://www.ami.com/wp-content/uploads/2024/06/NXP_logo-CCC-3-01-02.png)](https://www.intel.com/content/www/us/en/homepage.html)

[![](/wp-content/uploads/2021/07/Intel_logo-White-3-01-01.svg)](https://www.intel.com/content/www/us/en/homepage.html)

[![](/wp-content/uploads/2021/07/AMD_logo-White-3-01-01.svg)](https://www.amd.com/en)

[![](/wp-content/uploads/2021/07/ARM_logo-White-01.svg)](https://arm.com)

[![](/wp-content/uploads/2021/07/ampere_computing_logo-White-1-01.svg)](https://amperecomputing.com/)

[![](https://www.ami.com/wp-content/uploads/2022/08/Lattice_logo-CCC-3-01-01.svg)](https://www.latticesemi.com/)

[![](https://www.ami.com/wp-content/uploads/2022/08/Qualcomm_logo-CCC-3-01-01.svg)](https://www.qualcomm.com/)

[![](https://www.ami.com/wp-content/uploads/2021/07/nvidia_logo-white-01.png)](https://www.nvidia.com/)

## News & Blog

## [MegaRAC OneTree 2.0: New Release Available Now!](https://www.ami.com/blog/2025/01/09/megarac-onetree-2-0-new-release-available-now/)

Jan 9, 2025 | [BMC](https://www.ami.com/blog/category/bmc/), [Press Release](https://www.ami.com/blog/category/press-release/), [Tech Blog](https://www.ami.com/blog/category/tech-blog/)

Elevating Server Management Software for Gen-AI Infrastructure For over a decade, AMI's MegaRAC® solution has established itself as a leader in the...

## [The Role of Common-source Firmware in ODM-based Enterprise Datacenters](https://www.ami.com/blog/2024/12/20/the-role-of-common-source-firmware-in-odm-based-enterprise-datacenters/)

Dec 20, 2024 | [Tech Blog](https://www.ami.com/blog/category/tech-blog/)

In a recent AMI blog, “The New Frontier: The Enterprise OCP Model for Returning to On-premises”, we wrote about the GEICO keynote from the 2024 Open...

## [The New Frontier: The Enterprise OCP Model for Returning to On-premises](https://www.ami.com/blog/2024/12/06/the-new-frontier-the-enterprise-ocp-model-for-returning-to-on-premises/)

Dec 6, 2024 | [Tech Blog](https://www.ami.com/blog/category/tech-blog/)

During the 2024 Open Compute Project (OCP) Global Summit, a keynote was given by GEICO outlining the reasons why in 2023 they made the decision to...

[Read More](https://www.ami.com/news/)

## The World Starts on AMI

![](/wp-content/uploads/2021/05/ami-logo_no-tagline-1.png "ami-logo_no-tagline-1")

### SOLUTIONS

Open Source

Zero Trust Firmware

ARM Solutions

### Products

Aptio

MegaRAC

Tektagon

### Company

About

News & Events

AMI Security Center

![colored divider](/wp-content/uploads/2021/07/AMI__Gradient_VR_Sep.png "AMI__Gradient_VR_Sep")

### [Contact](/contact-us/ "Contact AMI")

* [Follow](https://www.facebook.com/AMI-112144290374420 "Follow on Facebook")
* [Follow](https://www.youtube.com/c/AMI_PR "Follow on Youtube")
* [Follow](https://www.linkedin.com/company/ami "Follow on LinkedIn")
* [Follow](http://www.twitter.com/AMI_PR "Follow on google-plus")

![](/wp-content/uploads/2021/05/ami-logo_no-tagline-1.png "ami-logo_no-tagline-1")
##### None

##### Solutions

[Open Source](/open-source)

##### Products

[Aptio](/power-up)

[MegaRAC](/megarac)

[Tektagon](/tektagon)

##### Company

[About](/about)

[News & Events](/news)

[AMI Security Center](/security-center/)

##### Contact

[Contact Us Today](/contact-us/ "Contact AMI Support")

* [Follow](https://www.facebook.com/AMI-112144290374420 "Follow on Facebook")
* [Follow](https://twitter.com/AMI_PR "Follow on google-plus")
* [Follow](https://www.youtube.com/channel/UC12o28faFg9c-3SDGn5rMew "Follow on Youtube")
* [Follow](https://www.linkedin.com/company/ami "Follow on LinkedIn")

Copyright ©2024 AMI. All Rights Reserved. Contents of this website are subject to change without notice. Products mentioned herein may be trademarks or registered trademarks of their respective companies. No warranties are made, either expressed or implied, with regard to the contents within, its merchantability or fitness for a particular use.

[Legal](/legal-information/ "Legal Information")  |  [Trademarks](/trademarks/ "Trademarks")  |  [Patents](/patent-portfolio/ "AMI Patents")  |  [Privacy Statement (EU)](/privacy-statement-eu/ "Privacy Statement (EU)")  |  [Cookie Policy (UK)](/cookie-policy-uk/ "Cookie Policy (UK)")  |  [Privacy Statement (UK)](/privacy-statement-uk/ "Privacy Statement (UK)")  |  [Cookie Policy (US)](/cookie-policy-us/ "Cookie Policy (US)")  |  [Privacy Statement (US)](/privacy-statement-us/ "Privacy Statement (US)")  |  [Cookie Policy (EU)](/cookie-policy-eu/ "Cookie Policy (EU)")  |  [Cookie Policy (CA)](/cookie-policy-ca/ "Cookie Policy (CA)")  |  [Privacy Statement (CA)](/privacy-statement-ca/ "Privacy Statement (CA)")  |  [Cookie Policy (AU)](/cookie-policy-au/ "Cookie Policy (AU)")  |  [Privacy Statement (AU)](/privacy-statement-au/ "Privacy Statement (AU)")



=== Content from dfir.ru_de5845b3_20250114_183206.html ===

[Skip to content](#content)

[My DFIR Blog](https://dfir.ru/)

Digital Forensics & Incident Response & Reverse Engineering

Menu

* [Home](/)
* [About Me](https://dfir.ru/me/)
* [My Tools](https://dfir.ru/tools/)

# Multiple vulnerabilities in AMI file system drivers

[December 9, 2024December 10, 2024](https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/) ~ [msuhanov](https://dfir.ru/author/msuhanov/)

**Background**

The same malformed file system structures can cause problems in independently developed file system parsers…

For example, [missing boundary checks when parsing the NTFS update sequence array](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/) resulted in two vulnerabilities disclosed before: one [in the ntfsck tool](https://github.com/tuxera/ntfs-3g/issues/16) (from the ntfs-3g package) – [CVE-2021-46790](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46790), one in the 7-Zip archiver – [CVE-2023-52168](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52168).

Now, there is a third item in that row: [CVE-2022-29974](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29974).

This is a pool-based buffer overflow in the AMI NTFS driver, it has the same root cause as two other vulnerabilities mentioned above. And, interestingly, it took more than 2 years for the fix to reach downstream firmware updates…

*This post is about 5 vulnerabilities discovered in EFI file system drivers from AMI.*

**CVE-2022-29974**

Here is my report, sent to the AMI BIOS Security Team in 2021:

```
Hello.

# Summary
I have discovered an out-of-bounds write condition in the AMI NTFS driver, version 1.0.0.
A successful exploitation of this condition results in two bytes at a specific, out-of-bounds, offset being overwritten with two bytes chosen by an attacker. The value of these two bytes to be overwritten must be known prior to the exploitation attempt (and they can’t be equal to 0x0000, this means that two bytes together can’t be null).

# Description
The NTFS file system implements a multi-sector transfer protection feature. This feature takes multiple sectors to be written to the underlying drive as input and copies the last two bytes of each sector into the array located in the first sector, then replaces the last two bytes of each sector with a placeholder value; these modified sectors are then written to the drive. This array is called an update sequence array (or USA). The feature allows the NTFS driver to detect torn writes when reading from the drive (the last two bytes of a failed sector won't match the placeholder value, which is known because it’s stored in the first sector); if no torn write is detected, original values are restored from the update sequence array into the end of each sector (overwriting the placeholder values). This is used when writing file record segments and index buffers, so they are protected against torn writes.

(More details about this feature can be found here: <https://flatcap.org/linux-ntfs/ntfs/concepts/fixup.html>.)

Your driver implements this feature, but fails to detect a condition when the number of update sequence array entries is too large for the given buffer.

For example, an index buffer is 4096 bytes in length (by default).
Thus, it contains 8 sectors (the sector size is always assumed to be 512 bytes in this case), so the update sequence array must contain 9 entries (1 placeholder value, 8 original values to be restored when reading from the drive).
However, the AMI NTFS driver allows any number of update sequence array entries. An attacker can exploit this to "restore" values (from the update sequence array) beyond the allocated buffer.

A vulnerable function is shown in <applyusa.png>.
I have confirmed the vulnerability using QEMU and Tianocore EDK II.
User actions required to trigger the vulnerability are shown in <qemu.png>.
The file system sample required to trigger the vulnerability is <ntfs.raw.gz> (unpack before using).

Note that this file system isn’t valid, the following error is shown by The Sleuth Kit: "Error in metadata structure (ntfs_fix_idxrec: More Update Sequence Entries than idx record size)". Also, due to several implementation details of your driver, the file system must have its cluster size set to 2048 bytes (or to a smaller value).

The initial state before applying the update sequence array entry is shown in <ida-1.png>.
The last sector before applying the update sequence array entry is shown in <ida-2.png>. The pool footer is also shown here.
The memory region beyond the allocated buffer before applying the update sequence array entry is shown in <ida-3.png>.
The memory region beyond the allocated buffer after applying the update sequence array entry is shown in <ida-4.png>.
The last sector and the memory region beyond the allocated buffer are shown in <ida-5.png>.

As you can see, the vulnerable function replaced two bytes after the allocated pool buffer (AF AF => BA AD).
Note that the file system sample requires Tianocore EDK II and debugging enabled, it's expected (when using this sample) that unused memory is filled with the 0xAF pattern (it's impossible to exploit the condition if both bytes to be replaced are equal to 0x00, see line #13 in <applyusa.png>).

# Fix
A proposed fix is to check the number of update sequence array entries against the allocated buffer size and bail out if any unexpected value is encountered.
```

Here are all files attached to that report:

![](https://dfir.ru/wp-content/uploads/2024/12/applyusa.png?w=897)

A vulnerable function (decompiled), referred to as *applyusa.png*

And a bunch of additional screenshots: [ida-1.png](https://dfir.ru/wp-content/uploads/2024/12/ida-1.png), [ida-2.png](https://dfir.ru/wp-content/uploads/2024/12/ida-2.png), [ida-3.png](https://dfir.ru/wp-content/uploads/2024/12/ida-3.png), [ida-4.png](https://dfir.ru/wp-content/uploads/2024/12/ida-4.png), [ida-5.png](https://dfir.ru/wp-content/uploads/2024/12/ida-5.png), [qemu.png](https://dfir.ru/wp-content/uploads/2024/12/qemu.png).

The PoC file system image is here: [ntfs.raw.gz](https://github.com/msuhanov/articles/blob/master/misc/ntfs.raw.gz).

**Timeline**

* On 2021-08-27, I sent the vulnerability report to the AMI BIOS Security Team.
* On 2021-09-03, the AMI BIOS Security Team confirmed that they have received my report.
* On 2021-09-10, the AMI BIOS Security Team stated that “*[the vulnerability] has been addressed in the NTFS driver module*“.
* On 2021-09-19, the AMI BIOS Security Team stated that “*[they] are planning to provide a mitigation to customers by end of October*“.
* On 2022-05-02, the following identifier was assigned to the vulnerability: CVE-2022-29974 (CNA: MITRE). It was requested by me.
* On 2024-01-21, I found that the fix isn’t shipped by at least one downstream vendor (in particular, ASUS). Affected ASUS products include: H610M-AYW D4 and PRIME Z790M-PLUS (and, possibly, other products are affected as well). The NTFS fix isn’t there, while other recent security fixes (e.g., for [LogoFAIL](https://en.wikipedia.org/wiki/LogoFAIL)) are shipped as expected. This was reported to the AMI BIOS Security Team.
* On 2024-02-27, I reported that the fix isn’t shipped by more downstream vendors (in particular, Dell). Affected Dell products include: Latitude 3120 (and, possibly, others as well – it should be noted that not all Dell products use EFI NTFS drivers based on AMI code). The fix isn’t in the latest firmware update. This was reported to the AMI BIOS Security Team.
* On 2024-02-29, the AMI BIOS Security Team stated that “*ASUS indicated they will patch these two products to take the NTFS fixes*“…

No further communication arrived from the AMI BIOS Security Team specifically about this vulnerability and other affected vendors like Dell.

* On 2024-03-13, I noticed that a fixed version of the driver is shipped by ASUS.

**So, it took more than two years to roll out the vulnerability fix (August 2021 – February/March 2024).** No public security advisory was ever issued.

---

**Another vulnerability in the same function**

If you look at the decompiled function shown above, you might notice another vulnerability on line #22.

The code writes two null bytes into a memory location calculated from on-disk data without any boundary checks. The *“write a null byte to an attacker-chosen memory location”* primitives [are known to be dangerous](https://dfir.ru/2023/08/23/cve-2023-4273-a-vulnerability-in-the-linux-exfat-driver/) (for example, an attacker can reset a variable that enables some runtime security-related features, thus turning them off).

And I didn’t notice that vulnerability before validating the fix for CVE-2022-29974…

Here is my message, sent on 2024-03-13 to the AMI BIOS Security Team (in this message, I also mention the fix for CVE-2022-29974, because I was replying to their message from 2024-02-29):

```
Hello.

    1. Thank you. I see the first related firmware update (ASUS H610M-AYW D4 BIOS 3203).

    2. Also, I found another issue in the same function used to apply update sequence array elements.

After the update sequence array elements have been successfully applied, the function assigns zero to the first element (i.e., two bytes) of this array, the first element contains the placeholder value (see <ida-func.png>). There is no boundary check for the array, so an attacker could produce a specially-crafted file system image and zero-out two bytes beyond the allocated buffer (see <ida-before-zeroing.png> and <ida-after-zeroing.png>, also see <ami_ntfs_test_3.raw>, this file system image was attached to a virtual machine debugged as shown on two screenshots just mentioned).

These two bytes can be located within the 65535-byte range (the exact offset is attacker-chosen) starting from the first byte of the current file record segment (or the current index buffer), and an attacker must know their value before the attack.

So, the idea is that v3 (as shown on <ida-func.png>) points to two bytes to be changed (beyond the allocated buffer), *(a2+6) is 2 (one placeholder value and one "original" value), *v5 is equal to *v3 (v5 points to two bytes at a2+510, this is within the allocated buffer; *v5 is equal to the value at v3 which is going to be changed).

I have attached three screenshots and a sample file system image (gzipped).
```

Here are all files attached to that message:

![](https://dfir.ru/wp-content/uploads/2024/12/ida-func.png)

An updated version of the same function (containing the fix for CVE-2022-29974), referred to as *ida-func.png*

And two more screenshots: [ida-before-zeroing.png](https://dfir.ru/wp-content/uploads/2024/12/ida-before-zeroing-4162017192-e1733673600180.png), [ida-after-zeroing.png.](https://dfir.ru/wp-content/uploads/2024/12/ida-after-zeroing-4183214671-e1733673618260.png)

The PoC file system image is here: [ami\_ntfs\_test\_3.raw.gz](https://github.com/msuhanov/articles/blob/master/misc/ami_ntfs_test_3.raw.gz).

**Timeline**

* On 2024-03-13, I sent the vulnerability report to the AMI BIOS Security Team.
* On 2024-07-03, the AMI BIOS Security Team says that they started the analysis of this vulnerability.

No further communication arrived from the AMI BIOS Security Team specifically about this vulnerability.

**Thus, it took more than 3 months to start the analysis of my vulnerability report…**

---

**Two more overflows in the AMI NTFS driver**

In January 2024, I discovered two more vulnerabilities in the same NTFS driver. Both were reported to the AMI BIOS Security Team, here is my message:

```
Hello.

I have discovered two vulnerabilities in the AMI NTFS driver, both of them are pool-based buffer overflows occurring when calling the EFI_BOOT_SERVICES.CopyMem() function.

1. One pool-based buffer overflow occurs when parsing the $VOLUME_NAME attribute.

A function used to extract the volume name into a pool-allocated area doesn't validate the Length argument passed for the EFI_BOOT_SERVICES.CopyMem() function (the argument value is simply taken from the corresponding on-disk structure), so a specially-crafted file system image could trigger an out-of-bounds write (see: "volname_func.png").

Date discovered: 2024-01-18.

2. Another pool-based buffer overflow occurs when parsing the resident $ATTRIBUTE_LIST attribute.

A function used to extract data from a resident $ATTRIBUTE_LIST attribute found in a file record segment into a pool-allocated area doesn't validate the Length argument passed for the EFI_BOOT_SERVICES.CopyMem() function (the argument value is simply taken from the corresponding on-disk structure), so a specially-crafted file system image could trigger an out-of-bounds write (see: "attrlist_func.png").

Additionally, the same piece of code contains unsafe arithmetic, which could overflow the size of the attribute data to be copied using the EFI_BOOT_SERVICES.CopyMem() function (see the "attr_data_size_calulated = ..." line on the same screenshot).

Date discovered: 2024-01-19.

3. I have attached two proof-of-concept disk images to this report. See the "ami_ntfs.rar" archive.

The first one, "ami_ntfs_test.raw", corresponds to the $VOLUME_NAME flaw. An attempt to list the volume name for this image would trigger the overflow.
The second one, "ami_ntfs_test_2.raw", corresponds to the $ATTRIBUTE_LIST flaw. An attempt to list the root directory of this volume (or to read the text file within the volume) would trigger the overflow.
```

Here are all files attached to the report:

![](https://dfir.ru/wp-content/uploads/2024/12/volname_func_.png)

A vulnerable function used to parse the NTFS volume name, referred to as *volname\_func.png*

![](https://dfir.ru/wp-content/uploads/2024/12/attrlist_func_.png)

A vulnerable function used to parse the $ATTRIBUTE\_LIST attribute, referred to as *attrlist\_func.png*

The PoC file system images are here: [ami\_ntfs.rar](https://github.com/msuhanov/articles/blob/master/misc/ami_ntfs.rar).

It should be noted that each vulnerability triggers the overflow with attacker-controlled data (this was confirmed by triggering each vulnerability in the debugger). And the amount of bytes overwritten beyond the allocated buffer is huge (and is also attacker-controlled)…

**Timeline**

* On 2024-01-21, I reported both vulnerabilities to the AMI BIOS Security Team.
* On 2024-01-22, I sent two updated screenshots (having better comments) to the AMI BIOS Security Team.
* On the same day, the AMI BIOS Security Team asked if these are the same vulnerabilities as reported by me in 2021. (Clearly, my answer was “no”.)
* On the same day, the AMI BIOS Security Team stated that they started the investigation.
* On 2024-07-03, the AMI BIOS Security Team stated that these are bugs, not vulnerabilities. And they are going to fix them.
* On the same day, I asked for justification behind the “not a vulnerability” response.

No further communication arrived from the AMI BIOS Security Team about these vulnerabilities. Obviously, such overflows with attacker-controlled data are vulnerabilities, not regular bugs…

---

**One overflow in the AMI exFAT driver**

I also discovered a vulnerability in another file system driver from AMI – in the AMI exFAT driver.

Here is my report:

```
Hello.

I have discovered a vulnerability in the AMI exFAT driver, which is a pool-based buffer overflow occurring when calling the EFI_BOOT_SERVICES.CopyMem() function.

A function used to extract the volume name into a pool-allocated area doesn't validate the Length argument passed for the EFI_BOOT_SERVICES.CopyMem() function (the argument value is taken from the corresponding on-disk structure, then multiplied by 2), so a specially-crafted file system image could trigger an out-of-bounds write (see: "volname_func_exfat.png", "before_copymem.png", and "after_copymem.png").

Note that the EFI_BOOT_SERVICES.CopyMem() function is used twice there: in one place, it copies the volume label to a per-volume structure allocated by the AMI exFAT driver; in another place, it copies the volume label to a caller-supplied buffer. The overflow occurs in the former case only (there are proper checks in the latter case).
In the worst case scenario, the on-disk image defines the volume label size as being 255 characters in length, while the specification limit is 11 and the pool-allocated area is limited to 12 characters. Since these are 16-bit characters, the actual overflow is 486 bytes. This is enough to touch the next pool allocation existing in the memory.

Date discovered: 2024-01-23.

I have attached a proof-of-concept disk image to this report. See the "ami_exfat.rar" archive.
```

Here are all files attached to the report:

![](https://dfir.ru/wp-content/uploads/2024/12/volname_func_exfat.png)

A vulnerable function used to parse the exFAT volume label, referred to as *volname\_func\_exfat.png*

And two more screenshots: [before\_copymem.png](https://dfir.ru/wp-content/uploads/2024/12/before_copymem.png), [after\_copymem.png](https://dfir.ru/wp-content/uploads/2024/12/after_copymem.png).

The PoC file system image is here: [ami\_exfat.rar](https://github.com/msuhanov/articles/blob/master/misc/ami_exfat.rar).

The vulnerability triggers the overflow with at most of 486 bytes of attacker-controlled data.

**Timeline**

* On 2024-01-25, I sent the vulnerability report to the AMI BIOS Security Team.
* On the same day, I sent two follow-up messages to fix some typos in my report (the report quoted above includes these fixes).
* On 2024-01-28, the AMI BIOS Security Team stated that they started the investigation.
* On 2024-07-03, the AMI BIOS Security Team stated that this is a bug, not a vulnerability. And they are going to fix it.

No further communication arrived from the AMI BIOS Security Team about this vulnerability.

**Vulnerable drivers (MD5 hashes for reference)**

* c17f84a6f3f16f80b1ace71d7b19cd7b (AMI NTFS driver, shipped by ASUS, affected by CVE-2022-29974)
* b578e8f8db9d699669cb5f63b26912b3 (AMI NTFS driver, shipped by Dell, affected by CVE-2022-29974)
* 43bbcdc0513034ffef62f9be3651f6ef (AMI NTFS driver, shipped by ASUS, containing a fix for CVE-2022-29974, but affected by three other vulnerabilities described)
* 7de308b1e01c1392b73ccb894a69f797 (AMI exFAT driver, shipped by ASUS, affected by the vulnerability described)

**Conclusions**

1. memcpy()-style overflows and insecure/unsafe pointer arithmetic seem to be common in EFI file system drivers.
2. The AMI BIOS Security Team handles vulnerability reports in an awkward way.

**Update (2024-12-10):**

I decided to re-check all five vulnerabilities against a random (but recent) firmware update from ASUS.

The following product was selected: Pro WS Z890-ACE SE. The following firmware update was tested: 1101 (2024/12/05).

The results are: all five vulnerabilities are present there.

There is a small change in the code of the AMI exFAT driver, now the overflow touches at most 478 bytes after the allocated buffer (the allocated buffer size is 32 bytes, which is slightly larger than before).

And, still, there is no fix for CVE-2022-29974 (3 years without a fix!).

Here are the screenshots (for two overflows in the volume label field, in the exFAT and NTFS): [1](https://dfir.ru/wp-content/uploads/2024/12/ida-2024-12_1.png), [2](https://dfir.ru/wp-content/uploads/2024/12/ida-2024-12_2.png) and [3](https://dfir.ru/wp-content/uploads/2024/12/ida-2024-12_3.png), [4](https://dfir.ru/wp-content/uploads/2024/12/ida-2024-12_4.png)…

Vulnerable drivers (MD5): 74a7f6ec656344babe1c72566e942eab (exFAT), 890537676b745ab921ce2a6ce35f7d7d (NTFS).

### Share this:

* [Twitter](https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/?share=twitter "Click to share on Twitter")
* [Facebook](https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Posted in [FAT](https://dfir.ru/category/fat/), [fsfail](https://dfir.ru/category/fsfail/), [NTFS](https://dfir.ru/category/ntfs/), [research](https://dfir.ru/category/research/), [vulnerability](https://dfir.ru/category/vulnerability/)

![](https://1.gravatar.com/avatar/7080afd45e36103ecb41521121b88abb23dc5eff14343f0deeede9c1c0cbd4e8?s=60&d=identicon&r=G)
## Published by msuhanov

[View all posts by msuhanov](https://dfir.ru/author/msuhanov/)

## Post navigation

[‹ PreviousVulnerabilities in 7-Zip and ntfs3](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/)

## One thought on “Multiple vulnerabilities in AMI file system drivers”

1. Pingback: [Week 50 – 2024 – This Week In 4n6](http://thisweekin4n6.com/2024/12/15/week-50-2024/)

### Leave a comment [Cancel reply](/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/#respond)

Δ

Search for:

# Follow Blog via Email

Enter your email address to follow this blog and receive notifications of new posts by email.

Email Address:

Follow

Join 75 other subscribers

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* [Comment](https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/#comments)
* Reblog
* Subscribe
  Subscribed

  + [![](https://dfir.ru/wp-content/uploads/2018/07/cropped-logo1.png?w=50) My DFIR Blog](https://dfir.ru)

  Join 75 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fdfir.ru%252F2024%252F12%252F09%252Fmultiple-vulnerabilities-in-ami-file-system-drivers%252F)
* Privacy
* + [![](https://dfir.ru/wp-content/uploads/2018/07/cropped-logo1.png?w=50) My DFIR Blog](https://dfir.ru)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fdfir.ru%252F2024%252F12%252F09%252Fmultiple-vulnerabilities-in-ami-file-system-drivers%252F)
  + [Copy shortlink](https://wp.me/pa5GsX-wn)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/)
  + [View post in Reader](https://wordpress.com/read/blogs/149118243/posts/2007)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)


