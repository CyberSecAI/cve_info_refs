=== Content from github.com_6e6b9425_20250114_195255.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftheupdateframework%2Fgo-tuf%2Fcommit%2Fed6788e710fc3093a7ecc2d078bf734c0f200d8d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftheupdateframework%2Fgo-tuf%2Fcommit%2Fed6788e710fc3093a7ecc2d078bf734c0f200d8d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=theupdateframework%2Fgo-tuf)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[theupdateframework](/theupdateframework)
/
**[go-tuf](/theupdateframework/go-tuf)**
Public

* [Notifications](/login?return_to=%2Ftheupdateframework%2Fgo-tuf) You must be signed in to change notification settings
* [Fork
  110](/login?return_to=%2Ftheupdateframework%2Fgo-tuf)
* [Star
   642](/login?return_to=%2Ftheupdateframework%2Fgo-tuf)

* [Code](/theupdateframework/go-tuf)
* [Issues
  24](/theupdateframework/go-tuf/issues)
* [Pull requests
  3](/theupdateframework/go-tuf/pulls)
* [Discussions](/theupdateframework/go-tuf/discussions)
* [Actions](/theupdateframework/go-tuf/actions)
* [Projects
  1](/theupdateframework/go-tuf/projects)
* [Security](/theupdateframework/go-tuf/security)
* [Insights](/theupdateframework/go-tuf/pulse)

Additional navigation options

* [Code](/theupdateframework/go-tuf)
* [Issues](/theupdateframework/go-tuf/issues)
* [Pull requests](/theupdateframework/go-tuf/pulls)
* [Discussions](/theupdateframework/go-tuf/discussions)
* [Actions](/theupdateframework/go-tuf/actions)
* [Projects](/theupdateframework/go-tuf/projects)
* [Security](/theupdateframework/go-tuf/security)
* [Insights](/theupdateframework/go-tuf/pulse)

## Commit

[Permalink](/theupdateframework/go-tuf/commit/ed6788e710fc3093a7ecc2d078bf734c0f200d8d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-66x3-6cw3-v5gj](https://github.com/advisories/GHSA-66x3-6cw3-v5gj "GHSA-66x3-6cw3-v5gj")

[Browse files](/theupdateframework/go-tuf/tree/ed6788e710fc3093a7ecc2d078bf734c0f200d8d)
Browse the repository at this point in the history

```
* Remove obsolete snapshot error check

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Add a dedicated error for missing target metadata file

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Fix protection against metadata rollback attacks

The go-tuf client now loads any previously trusted metadata before
proceeding with the update process. This is mandatory for the
protection against rollback attacks. It also fixes the detailed order
of operations necessary to implement such protection.

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Don't abort the update process if loading trusted metadata fails

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Update getLocalMeta so it tries loading every verified metadata file

If some of the metadata files fail to load, getLocalMeta will proceed
with trying to load the rest, but still return an error at the end,
if such occurred.

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Revert the preliminary targets.json download check

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Use current instead of old when addressing metadata

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* Timestamp metadata do not require hashes and lenght being present

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* fix: reload local meta based on the latest root

Clear the in-memory copy of the local metadata. The goal is to reload
and take into account only the metadata files that are verified by
the latest root. Otherwise, their content should be ignored.

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* fix: update client unit tests for cases where metadata is now invalidated

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* chore: clarify the case where targets rollback verification will be skipped

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* chore: update getLocalMeta() description

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* chore: simplify getLocalMeta() so it wraps the inner error upon failure

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* chore: remove unused ErrLoadLocalFailed error type

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>

* chore: improve code layout for decodeSnapshot()

Signed-off-by: Radoslav Dimitrov <dimitrovr@vmware.com>
```

* Loading branch information

[![@rdimitrov](https://avatars.githubusercontent.com/u/16540482?s=40&v=4)](/rdimitrov)

[rdimitrov](/theupdateframework/go-tuf/commits?author=rdimitrov "View all commits by rdimitrov")
authored
May 5, 2022

1 parent
[90f34f0](/theupdateframework/go-tuf/commit/90f34f07cce1bd127b8d307fd5614fe1baa8bb0b)

commit ed6788e

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**126 additions**
and
**49 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* client

  + client/client.go
    [client.go](#diff-bd3a55a72186f59e2e63efb4951573b2f9e4a7cc98086e922b0859f8ccc1dd09)
  + client/errors.go
    [errors.go](#diff-f12f1bb4e14e9b4f35a62b18aacb25da8cfa219b7a8f1cfeabf6715be2430723)
  + client/interop\_test.go
    [interop\_test.go](#diff-e813b56236a2d9cc9e3295c01db6f201e4507bf271c6587b3f48b86e8b9cc4f7)
* cmd/tuf-client

  + cmd/tuf-client/get.go
    [get.go](#diff-e96ae16d489c5f2c4a06f8bbf477dd55ce1aef9d6f69ad5ce2731fda30416899)
  + cmd/tuf-client/list.go
    [list.go](#diff-939e175df827e7f1db80c6124d3e87e0eca6d781f58544d8e98a9004ac9a3051)
* util

  + util/util.go
    [util.go](#diff-a61d5e39f45fb5ed2dc1ef71fa708c8db480e9a396adb8a5d9d17b8e6ba1e186)
* verify

  + verify/errors.go
    [errors.go](#diff-1b56d2dcbca0a618eb3c9f5fc2bcd2631aaadca3234de0f3ac528b816c8404eb)
  + verify/verify.go
    [verify.go](#diff-74bf513d3702c8cef8c8ddc497ada4d06e46f7ba6ae4674f3d44321a8b30512a)

## There are no files selected for viewing

117 changes: 97 additions & 20 deletions

117
[client/client.go](#diff-bd3a55a72186f59e2e63efb4951573b2f9e4a7cc98086e922b0859f8ccc1dd09 "client/client.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/client/client.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -177,33 +177,38 @@ func (c \*Client) Update() (data.TargetFiles, error) { |
|  |  | return nil, err |
|  |  | } |
|  |  |  |
|  |  | // Get timestamp.json, extract snapshot.json file meta and save the |
|  |  | // timestamp.json locally |
|  |  | // Load trusted metadata files, if any, and verify them against the latest root |
|  |  | c.getLocalMeta() |
|  |  |  |
|  |  | // 5.4.1 - Download the timestamp metadata |
|  |  | timestampJSON, err := c.downloadMetaUnsafe("timestamp.json", defaultTimestampDownloadLimit) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.4.(2,3 and 4) - Verify timestamp against various attacks |
|  |  | // Returns the extracted snapshot metadata |
|  |  | snapshotMeta, err := c.decodeTimestamp(timestampJSON) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.4.5 - Persist the timestamp metadata |
|  |  | if err := c.local.SetMeta("timestamp.json", timestampJSON); err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  |  |
|  |  | // Get snapshot.json, then extract file metas. |
|  |  | // root.json meta should not be stored in the snapshot, if it is, |
|  |  | // the root will be checked, re-downloaded |
|  |  | // 5.5.1 - Download snapshot metadata |
|  |  | // 5.5.2 and 5.5.4 - Check against timestamp role's snapshot hash and version |
|  |  | snapshotJSON, err := c.downloadMetaFromTimestamp("snapshot.json", snapshotMeta) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.5.(3,5 and 6) - Verify snapshot against various attacks |
|  |  | // Returns the extracted metadata files |
|  |  | snapshotMetas, err := c.decodeSnapshot(snapshotJSON) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  |  |
|  |  | // Save the snapshot.json |
|  |  | // 5.5.7 - Persist snapshot metadata |
|  |  | if err := c.local.SetMeta("snapshot.json", snapshotJSON); err != nil { |
|  |  | return nil, err |
|  |  | } |
| Expand All | | @@ -213,14 +218,18 @@ func (c \*Client) Update() (data.TargetFiles, error) { |
|  |  | var updatedTargets data.TargetFiles |
|  |  | targetsMeta := snapshotMetas["targets.json"] |
|  |  | if !c.hasMetaFromSnapshot("targets.json", targetsMeta) { |
|  |  | // 5.6.1 - Download the top-level targets metadata file |
|  |  | // 5.6.2 and 5.6.4 - Check against snapshot role's targets hash and version |
|  |  | targetsJSON, err := c.downloadMetaFromSnapshot("targets.json", targetsMeta) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.6.(3 and 5) - Verify signatures and check against freeze attack |
|  |  | updatedTargets, err = c.decodeTargets(targetsJSON) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.6.6 - Persist targets metadata |
|  |  | if err := c.local.SetMeta("targets.json", targetsJSON); err != nil { |
|  |  | return nil, err |
|  |  | } |
| Expand Down  Expand Up | | @@ -393,44 +402,69 @@ func (c \*Client) UpdateRoots() error { |
|  |  | // getLocalMeta decodes and verifies metadata from local storage. |
|  |  | // The verification of local files is purely for consistency, if an attacker |
|  |  | // has compromised the local storage, there is no guarantee it can be trusted. |
|  |  | // Before trying to load the metadata files, it clears the in-memory copy of the local metadata. |
|  |  | // This is to insure that all of the loaded metadata files at the end are indeed verified by the latest root. |
|  |  | // If some of the metadata files fail to load it will proceed with trying to load the rest, |
|  |  | // but still return an error at the end, if such occurred. Otherwise returns nil. |
|  |  | func (c \*Client) getLocalMeta() error { |
|  |  | var retErr error |
|  |  | loadFailed := false |
|  |  | // Clear the in-memory copy of the local metadata. The goal is to reload and take into account |
|  |  | // only the metadata files that are verified by the latest root. Otherwise, their content should |
|  |  | // be ignored. |
|  |  | c.localMeta = make(map[string]json.RawMessage) |
|  |  |  |
|  |  | // Load the latest root meta |
|  |  | if err := c.loadAndVerifyLocalRootMeta( /\*ignoreExpiredCheck=\*/ false); err != nil { |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | // Load into memory the existing meta, if any, from the local storage |
|  |  | meta, err := c.local.GetMeta() |
|  |  | if err != nil { |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | // Verify the top-level metadata (timestamp, snapshot and targets) against the latest root and load it, if okay |
|  |  | if timestampJSON, ok := meta["timestamp.json"]; ok { |
|  |  | timestamp := &data.Timestamp{} |
|  |  | if err := c.db.UnmarshalTrusted(timestampJSON, timestamp, "timestamp"); err != nil { |
|  |  | return err |
|  |  | loadFailed = true |
|  |  | retErr = err |
|  |  | } else { |
|  |  | c.localMeta["timestamp.json"] = meta["timestamp.json"] |
|  |  | c.timestampVer = timestamp.Version |
|  |  | } |
|  |  | c.timestampVer = timestamp.Version |
|  |  | } |
|  |  |  |
|  |  | if snapshotJSON, ok := meta["snapshot.json"]; ok { |
|  |  | snapshot := &data.Snapshot{} |
|  |  | if err := c.db.UnmarshalTrusted(snapshotJSON, snapshot, "snapshot"); err != nil { |
|  |  | return err |
|  |  | loadFailed = true |
|  |  | retErr = err |
|  |  | } else { |
|  |  | c.localMeta["snapshot.json"] = meta["snapshot.json"] |
|  |  | c.snapshotVer = snapshot.Version |
|  |  | } |
|  |  | c.snapshotVer = snapshot.Version |
|  |  | } |
|  |  |  |
|  |  | if targetsJSON, ok := meta["targets.json"]; ok { |
|  |  | targets := &data.Targets{} |
|  |  | if err := c.db.UnmarshalTrusted(targetsJSON, targets, "targets"); err != nil { |
|  |  | return err |
|  |  | loadFailed = true |
|  |  | retErr = err |
|  |  | } else { |
|  |  | c.localMeta["targets.json"] = meta["targets.json"] |
|  |  | c.targetsVer = targets.Version |
|  |  | // FIXME(TUF-0.9) temporarily support files with leading path separators. |
|  |  | // c.targets = targets.Targets |
|  |  | c.loadTargets(targets.Targets) |
|  |  | } |
|  |  | c.targetsVer = targets.Version |
|  |  | // FIXME(TUF-0.9) temporarily support files with leading path separators. |
|  |  | // c.targets = targets.Targets |
|  |  | c.loadTargets(targets.Targets) |
|  |  | } |
|  |  |  |
|  |  | c.localMeta = meta |
|  |  | if loadFailed { |
|  |  | // If any of the metadata failed to be verified, return the reason for that failure |
|  |  | return retErr |
|  |  | } |
|  |  | return nil |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -660,6 +694,7 @@ func (c \*Client) downloadMetaFromSnapshot(name string, m data.SnapshotFileMeta) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.6.2 and 5.6.4 - Check against snapshot role's targets hash and version |
|  |  | if err := util.SnapshotFileMetaEqual(meta, m); err != nil { |
|  |  | return nil, ErrDownloadFailed{name, err} |
|  |  | } |
| Expand All | | @@ -676,6 +711,7 @@ func (c \*Client) downloadMetaFromTimestamp(name string, m data.TimestampFileMeta |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // 5.5.2 and 5.5.4 - Check against timestamp role's snapshot hash and version |
|  |  | if err := util.TimestampFileMetaEqual(meta, m); err != nil { |
|  |  | return nil, ErrDownloadFailed{name, err} |
|  |  | } |
| Expand All | | @@ -697,20 +733,53 @@ func (c \*Client) decodeRoot(b json.RawMessage) error { |
|  |  | // root and targets file meta. |
|  |  | func (c \*Client) decodeSnapshot(b json.RawMessage) (data.SnapshotFiles, error) { |
|  |  | snapshot := &data.Snapshot{} |
|  |  | // 5.5.(3 and 6) - Verify it's signed correctly and it's not expired |
|  |  | if err := c.db.Unmarshal(b, snapshot, "snapshot", c.snapshotVer); err != nil { |
|  |  | return data.SnapshotFiles{}, ErrDecodeFailed{"snapshot.json", err} |
|  |  | } |
|  |  | c.snapshotVer = snapshot.Version |
|  |  | // 5.5.5 - Check for top-level targets rollback attack |
|  |  | // Verify explicitly that current targets meta version is less than or equal to the new one |
|  |  | if snapshot.Meta["targets.json"].Version < c.targetsVer { |
|  |  | return data.SnapshotFiles{}, verify.ErrLowVersion{Actual: snapshot.Meta["targets.json"].Version, Current: c.targetsVer} |
|  |  | } |
|  |  |  |
|  |  | // 5.5.5 - Get the local/trusted snapshot metadata, if any, and check all target metafiles against rollback attack |
|  |  | // In case the local snapshot metadata was not verified by the keys in the latest root during getLocalMeta(), |
|  |  | // snapshot.json won't be present in c.localMeta and thus this check will not be processed. |
|  |  | if snapshotJSON, ok := c.localMeta["snapshot.json"]; ok { |
|  |  | currentSnapshot := &data.Snapshot{} |
|  |  | if err := c.db.UnmarshalTrusted(snapshotJSON, currentSnapshot, "snapshot"); err != nil { |
|  |  | return data.SnapshotFiles{}, err |
|  |  | } |
|  |  | // 5.5.5 - Check for rollback attacks in both top-level and delegated targets roles (note that the Meta object includes both) |
|  |  | for path, local := range currentSnapshot.Meta { |
|  |  | if newMeta, ok := snapshot.Meta[path]; ok { |
|  |  | // 5.5.5 - Check for rollback attack |
|  |  | if newMeta.Version < local.Version { |
|  |  | return data.SnapshotFiles{}, verify.ErrLowVersion{Actual: newMeta.Version, Current: local.Version} |
|  |  | } |
|  |  | } else { |
|  |  | // 5.5.5 - Abort the update if a target file has been removed from the new snapshot file |
|  |  | return data.SnapshotFiles{}, verify.ErrMissingTargetFile |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | // At this point we can trust the new snapshot, the top-level targets, and any delegated targets versions it refers to |
|  |  | // so we can update the client's trusted versions and proceed with persisting the new snapshot metadata |
|  |  | // c.snapshotVer was already set when we verified the timestamp metadata |
|  |  | c.targetsVer = snapshot.Meta["targets.json"].Version |
|  |  | return snapshot.Meta, nil |
|  |  | } |
|  |  |  |
|  |  | // decodeTargets decodes and verifies targets metadata, sets c.targets and |
|  |  | // returns updated targets. |
|  |  | func (c \*Client) decodeTargets(b json.RawMessage) (data.TargetFiles, error) { |
|  |  | targets := &data.Targets{} |
|  |  | // 5.6.(3 and 5) - Verify signatures and check against freeze attack |
|  |  | if err := c.db.Unmarshal(b, targets, "targets", c.targetsVer); err != nil { |
|  |  | return nil, ErrDecodeFailed{"targets.json", err} |
|  |  | } |
|  |  | // Generate a list with the updated targets |
|  |  | updatedTargets := make(data.TargetFiles) |
|  |  | for path, meta := range targets.Targets { |
|  |  | if local, ok := c.targets[path]; ok { |
| Expand All | | @@ -720,7 +789,7 @@ func (c \*Client) decodeTargets(b json.RawMessage) (data.TargetFiles, error) { |
|  |  | } |
|  |  | updatedTargets[path] = meta |
|  |  | } |
|  |  | c.targetsVer = targets.Version |
|  |  | // c.targetsVer was already updated when we verified the snapshot metadata |
|  |  | // FIXME(TUF-0.9) temporarily support files with leading path separators. |
|  |  | // c.targets = targets.Targets |
|  |  | c.loadTargets(targets.Targets) |
| Expand All | | @@ -734,7 +803,15 @@ func (c \*Client) decodeTimestamp(b json.RawMessage) (data.TimestampFileMeta, err |
|  |  | if err := c.db.Unmarshal(b, timestamp, "timestamp", c.timestampVer); err != nil { |
|  |  | return data.TimestampFileMeta{}, ErrDecodeFailed{"timestamp.json", err} |
|  |  | } |
|  |  | // 5.4.3.2 - Check for snapshot rollback attack |
|  |  | // Verify that the current snapshot meta version is less than or equal to the new one |
|  |  | if timestamp.Meta["snapshot.json"].Version < c.snapshotVer { |
|  |  | return data.TimestampFileMeta{}, verify.ErrLowVersion{Actual: timestamp.Meta["snapshot.json"].Version, Current: c.snapshotVer} |
|  |  | } |
|  |  | // At this point we can trust the new timestamp and the snaphost version it refers to |
|  |  | // so we can update the client's trusted versions and proceed with persisting the new timestamp |
|  |  | c.timestampVer = timestamp.Version |
|  |  | c.snapshotVer = timestamp.Meta["snapshot.json"].Version |
|  |  | return timestamp.Meta["snapshot.json"], nil |
|  |  | } |
|  |  |  |
| Expand Down | |  |

13 changes: 0 additions & 13 deletions

13
[client/errors.go](#diff-f12f1bb4e14e9b4f35a62b18aacb25da8cfa219b7a8f1cfeabf6715be2430723 "client/errors.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/client/errors.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -70,19 +70,6 @@ func (e ErrWrongSize) Error() string { |
|  |  | return fmt.Sprintf("tuf: unexpected file size: %s (expected %d bytes, got %d bytes)", e.File, e.Expected, e.Actual) |
|  |  | } |
|  |  |  |
|  |  | type ErrLatestSnapshot struct { |
|  |  | Version int64 |
|  |  | } |
|  |  |  |
|  |  | func (e ErrLatestSnapshot) Error() string { |
|  |  | return fmt.Sprintf("tuf: the local snapshot version (%d) is the latest", e.Version) |
|  |  | } |
|  |  |  |
|  |  | func IsLatestSnapshot(err error) bool { |
|  |  | \_, ok := err.(ErrLatestSnapshot) |
|  |  | return ok |
|  |  | } |
|  |  |  |
|  |  | type ErrUnknownTarget struct { |
|  |  | Name string |
|  |  | SnapshotVersion int64 |
| Expand Down | |  |

15 changes: 11 additions & 4 deletions

15
[client/interop\_test.go](#diff-e813b56236a2d9cc9e3295c01db6f201e4507bf271c6587b3f48b86e8b9cc4f7 "client/interop_test.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/client/interop_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,7 +9,6 @@ import ( |
|  |  | "net/http" |
|  |  | "os" |
|  |  | "path/filepath" |
|  |  | "strconv" |
|  |  |  |
|  |  | "github.com/theupdateframework/go-tuf/util" |
|  |  | . "gopkg.in/check.v1" |
| Expand Down  Expand Up | | @@ -159,9 +158,17 @@ func (t \*testCase) runStep(c \*C, stepName string) { |
|  |  | // check update returns the correct updated targets |
|  |  | files, err := client.Update() |
|  |  | c.Assert(err, IsNil) |
|  |  | l, \_ := strconv.Atoi(stepName) |
|  |  | c.Assert(files, HasLen, l+1) |
|  |  |  |
|  |  | if stepName != "2" { |
|  |  | // The rest of the test cases add one target file at a time for each cycle, so this is why we expect that |
|  |  | // the number of updated targets returned by Update() should equals to 1 |
|  |  | c.Assert(files, HasLen, 1) |
|  |  | } else { |
|  |  | // The following test case (#2) verifies that when a targets key has been rotated in the latest 3.root.json, |
|  |  | // the local targets.json meta is indeed ignored since it's signed with a key that has been now changed. |
|  |  | // The reason we check for 3 here is that the updated targets corresponds to all target files listed in the |
|  |  | // targets.json for test case #2 |
|  |  | c.Assert(files, HasLen, 3) |
|  |  | } |
|  |  | targetName := stepName |
|  |  | t.targets[targetName] = []byte(targetName) |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[cmd/tuf-client/get.go](#diff-e96ae16d489c5f2c4a06f8bbf477dd55ce1aef9d6f69ad5ce2731fda30416899 "cmd/tuf-client/get.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/cmd/tuf-client/get.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,7 +31,7 @@ func (t \*tmpFile) Delete() error { |
|  |  | } |
|  |  |  |
|  |  | func cmdGet(args \*docopt.Args, client \*tuf.Client) error { |
|  |  | if \_, err := client.Update(); err != nil && !tuf.IsLatestSnapshot(err) { |
|  |  | if \_, err := client.Update(); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | target := util.NormalizeTarget(args.String["<target>"]) |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[cmd/tuf-client/list.go](#diff-939e175df827e7f1db80c6124d3e87e0eca6d781f58544d8e98a9004ac9a3051 "cmd/tuf-client/list.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/cmd/tuf-client/list.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,7 +22,7 @@ List available target files. |
|  |  | } |
|  |  |  |
|  |  | func cmdList(args \*docopt.Args, client \*tuf.Client) error { |
|  |  | if \_, err := client.Update(); err != nil && !tuf.IsLatestSnapshot(err) { |
|  |  | if \_, err := client.Update(); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | targets, err := client.Targets() |
| Expand Down | |  |

21 changes: 13 additions & 8 deletions

21
[util/util.go](#diff-a61d5e39f45fb5ed2dc1ef71fa708c8db480e9a396adb8a5d9d17b8e6ba1e186 "util/util.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/util/util.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -118,13 +118,13 @@ func SnapshotFileMetaEqual(actual data.SnapshotFileMeta, expected data.SnapshotF |
|  |  | if expected.Length != 0 && actual.Length != expected.Length { |
|  |  | return ErrWrongLength{expected.Length, actual.Length} |
|  |  | } |
|  |  |  |
|  |  | // 5.6.2 - Check against snapshot role's targets hash |
|  |  | if len(expected.Hashes) != 0 { |
|  |  | if err := hashEqual(actual.Hashes, expected.Hashes); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // 5.6.4 - Check against snapshot role's snapshot version |
|  |  | if err := versionEqual(actual.Version, expected.Version); err != nil { |
|  |  | return err |
|  |  | } |
| Expand All | | @@ -137,13 +137,18 @@ func TargetFileMetaEqual(actual data.TargetFileMeta, expected data.TargetFileMet |
|  |  | } |
|  |  |  |
|  |  | func TimestampFileMetaEqual(actual data.TimestampFileMeta, expected data.TimestampFileMeta) error { |
|  |  | // As opposed to snapshots, the length and hashes are still required in |
|  |  | // TUF-1.0. See: |
|  |  | // https://github.com/theupdateframework/specification/issues/38 |
|  |  | if err := FileMetaEqual(actual.FileMeta, expected.FileMeta); err != nil { |
|  |  | return err |
|  |  | // TUF no longer considers the length and hashes to be a required |
|  |  | // member of Timestamp. |
|  |  | if expected.Length != 0 && actual.Length != expected.Length { |
|  |  | return ErrWrongLength{expected.Length, actual.Length} |
|  |  | } |
|  |  |  |
|  |  | // 5.5.2 - Check against timestamp role's snapshot hash |
|  |  | if len(expected.Hashes) != 0 { |
|  |  | if err := hashEqual(actual.Hashes, expected.Hashes); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | } |
|  |  | // 5.5.4 - Check against timestamp role's snapshot version |
|  |  | if err := versionEqual(actual.Version, expected.Version); err != nil { |
|  |  | return err |
|  |  | } |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[verify/errors.go](#diff-1b56d2dcbca0a618eb3c9f5fc2bcd2631aaadca3234de0f3ac528b816c8404eb "verify/errors.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/verify/errors.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,7 @@ var ( |
|  |  | ErrInvalidDelegatedRole = errors.New("tuf: invalid delegated role") |
|  |  | ErrInvalidKeyID = errors.New("tuf: invalid key id") |
|  |  | ErrInvalidThreshold = errors.New("tuf: invalid role threshold") |
|  |  | ErrMissingTargetFile = errors.New("tuf: missing previously listed targets metadata file") |
|  |  | ) |
|  |  |  |
|  |  | type ErrWrongID struct{} |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[verify/verify.go](#diff-74bf513d3702c8cef8c8ddc497ada4d06e46f7ba6ae4674f3d44321a8b30512a "verify/verify.go")

Show comments

[View file](/theupdateframework/go-tuf/blob/ed6788e710fc3093a7ecc2d078bf734c0f200d8d/verify/verify.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -47,7 +47,7 @@ func (db \*DB) VerifyIgnoreExpiredCheck(s \*data.Signed, role string, minVersion i |
|  |  | } |
|  |  |  |
|  |  | func (db \*DB) Verify(s \*data.Signed, role string, minVersion int64) error { |
|  |  |  |
|  |  | // Verify signatures and versions |
|  |  | err := db.VerifyIgnoreExpiredCheck(s, role, minVersion) |
|  |  |  |
|  |  | if err != nil { |
| Expand All | | @@ -58,7 +58,7 @@ func (db \*DB) Verify(s \*data.Signed, role string, minVersion int64) error { |
|  |  | if err := json.Unmarshal(s.Signed, sm); err != nil { |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | // Verify expiration |
|  |  | if IsExpired(sm.Expires) { |
|  |  | return ErrExpired{sm.Expires} |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ed6788e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftheupdateframework%2Fgo-tuf%2Fcommit%2Fed6788e710fc3093a7ecc2d078bf734c0f200d8d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_e14575b3_20250114_195256.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftheupdateframework%2Fgo-tuf%2Fsecurity%2Fadvisories%2FGHSA-66x3-6cw3-v5gj)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftheupdateframework%2Fgo-tuf%2Fsecurity%2Fadvisories%2FGHSA-66x3-6cw3-v5gj)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=theupdateframework%2Fgo-tuf)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[theupdateframework](/theupdateframework)
/
**[go-tuf](/theupdateframework/go-tuf)**
Public

* [Notifications](/login?return_to=%2Ftheupdateframework%2Fgo-tuf) You must be signed in to change notification settings
* [Fork
  110](/login?return_to=%2Ftheupdateframework%2Fgo-tuf)
* [Star
   642](/login?return_to=%2Ftheupdateframework%2Fgo-tuf)

* [Code](/theupdateframework/go-tuf)
* [Issues
  24](/theupdateframework/go-tuf/issues)
* [Pull requests
  3](/theupdateframework/go-tuf/pulls)
* [Discussions](/theupdateframework/go-tuf/discussions)
* [Actions](/theupdateframework/go-tuf/actions)
* [Projects
  1](/theupdateframework/go-tuf/projects)
* [Security](/theupdateframework/go-tuf/security)
* [Insights](/theupdateframework/go-tuf/pulse)

Additional navigation options

* [Code](/theupdateframework/go-tuf)
* [Issues](/theupdateframework/go-tuf/issues)
* [Pull requests](/theupdateframework/go-tuf/pulls)
* [Discussions](/theupdateframework/go-tuf/discussions)
* [Actions](/theupdateframework/go-tuf/actions)
* [Projects](/theupdateframework/go-tuf/projects)
* [Security](/theupdateframework/go-tuf/security)
* [Insights](/theupdateframework/go-tuf/pulse)

# No protection against rollback attacks for roles other than root

High

[joshuagl](/joshuagl)
published
GHSA-66x3-6cw3-v5gj
May 5, 2022
·
1 comment

## Package

gomod

go-tuf
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

v0.2.0

## Patched versions

v0.3.0

## Description

### Impact

[go-tuf](https://github.com/theupdateframework/go-tuf) does not correctly implement the [client workflow](https://theupdateframework.github.io/specification/v1.0.28/index.html#detailed-client-workflow) for updating the metadata files for roles other than the root role. Specifically, checks for rollback attacks are not implemented correctly meaning an attacker can cause clients to install software that is older than the software which the client previously knew to be available, and may include software with known vulnerabilities.

In more detail, the client code of go-tuf has several issues in regards to preventing rollback attacks:

1. It does not take into account the content of any previously trusted metadata, if available, before proceeding with updating roles other than the root role (i.e., steps 5.4.3.1 and 5.5.5 of the detailed client workflow). This means that any form of version verification done on the newly-downloaded metadata is made using the default value of zero, which always passes.
2. For both timestamp and snapshot roles, go-tuf saves these metadata files as trusted before verifying if the version of the metafiles they refer to is correct (i.e., steps 5.5.4 and 5.6.4 of the detailed client workflow).

### Patches

A fix is available in version 0.3.0 or newer.

### Workarounds

No workarounds are known for this issue apart from upgrading.

### References

* Commit resolving the issue [ed6788e](https://github.com/theupdateframework/go-tuf/commit/ed6788e710fc3093a7ecc2d078bf734c0f200d8d)
* TUF specification version against which this vulnerability is observed is [v.1.0.28](https://theupdateframework.github.io/specification/v1.0.28/index.html#detailed-client-workflow). For more details, refer to Section 5.
* Codebase that is affected is [go-tuf@f0c3294f63b9145029464164f9bce49553b77cbb](https://github.com/theupdateframework/go-tuf/tree/f0c3294f63b9145029464164f9bce49553b77cbb)

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [go-tuf](https://github.com/theupdateframework/go-tuf/issues)
* Email us at TUF's mailing list
* The [#tuf](https://cloud-native.slack.com/archives/C8NMD3QJ3) channel on [CNCF Slack](https://slack.cncf.io/).

[![@znewman01](https://avatars.githubusercontent.com/u/873857?s=80&v=4)](/znewman01)

Copy link

Contributor

### **[znewman01](/znewman01)** commented [Oct 11, 2022](#advisory-comment-75595)

| \*\*EDIT:\*\* please ignore, I think the below message just got stuck in the tubes for 5 months … ---------------------------------------------------------------------------- I will review by EOD Wednesday. Can’t commit to earlier right now unfortunately. Thanks for coordinating Joshua  On Apr 25, 2022, at 11:52 AM, Joshua Lock \*\*\*@\*\*\*.\*\*\*> wrote: ﻿ Adding [@znewman01](https://github.com/znewman01) (newly minted maintainer) for a chance to review and comment. I really want to get this published this week unless there are any major roadblocks. [@cedricvanrompay-datadog](https://github.com/cedricvanrompay-datadog) [@asraa](https://github.com/asraa) [@znewman01](https://github.com/znewman01) please indicate here whether you intend to review (ideally before EOD Wednesday). — Reply to this email directly, view it on GitHub, or unsubscribe. You are receiving this because you are either an administrator on theupdateframework/go-tuf, or a collaborator on GHSA-66x3-6cw3-v5gj. |
| --- |

All reactions

### Severity

High

### CVE ID

CVE-2022-29173

### Weaknesses

No CWEs

### Credits

* [![@rdimitrov](https://avatars.githubusercontent.com/u/16540482?s=40&v=4)](/rdimitrov)
  [rdimitrov](/rdimitrov)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


