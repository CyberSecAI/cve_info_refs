=== Content from github.com_b9379f85_20250114_195033.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1578)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1578)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=unicorn-engine%2Funicorn)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unicorn-engine](/unicorn-engine)
/
**[unicorn](/unicorn-engine/unicorn)**
Public

* [Notifications](/login?return_to=%2Funicorn-engine%2Funicorn) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Funicorn-engine%2Funicorn)
* [Star
   7.8k](/login?return_to=%2Funicorn-engine%2Funicorn)

* [Code](/unicorn-engine/unicorn)
* [Issues
  108](/unicorn-engine/unicorn/issues)
* [Pull requests
  13](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects
  0](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

Additional navigation options

* [Code](/unicorn-engine/unicorn)
* [Issues](/unicorn-engine/unicorn/issues)
* [Pull requests](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Null pointer caused by UAF in unicorn-1.0.3 #1578

Closed

[liyansong2018](/liyansong2018) opened this issue
Apr 1, 2022
¬∑ 6 comments

Closed

# [Null pointer caused by UAF in unicorn-1.0.3](#top) #1578

[liyansong2018](/liyansong2018) opened this issue
Apr 1, 2022
¬∑ 6 comments

Labels
[question](/unicorn-engine/unicorn/labels/question)
[stale](/unicorn-engine/unicorn/labels/stale)

## Comments

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=80&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)

Copy link

Contributor

### **[liyansong2018](/liyansong2018)** commented [Apr 1, 2022](#issue-1189543314) ‚Ä¢ edited Loading

| Hello, :)  Unicorn-1.0.3 Python API   * Add `emu_start` to the hook function (uc\_hook\_mem\_read\_unmapped) * Releasing the hook function will cause the null pointer dereference.   PoC is as follows  ``` def disasm(cont, addr):     md = Cs(CS_ARCH_X86, CS_MODE_64)     for i in md.disasm(cont, addr):         print("0x%x:\t%s\t%s" % (i.address, i.mnemonic, i.op_str))  def read(name):     with open(name, "rb") as fp:         return fp.read()  def hook_unmapped(uc, access, address, size, value, user_data):     print('>>> Tracing instruction at 0x%x, instruction size = 0x%x' %(address, size))     print(os.getpid())     #time.sleep(10)     ######### poc #########     uc.emu_start(address + size, 0x400582)     ######### poc #########  insn_skip_list = [0x4004ef, 0x4004f6, 0x400502, 0x40054f, 0x400560] def hook_code(mu, address, size, user_data):     disasm(mu.mem_read(address, size), address)  def main():     uc = Uc(UC_ARCH_X86, UC_MODE_64)      uc.mem_map(0x400000, 1024 * 1024)    # binary     uc.mem_map(0x100000, 1024 * 1024)         # stack     uc.mem_write(0x400000, read("./fibonacci"))     uc.reg_write(UC_X86_REG_RSP, 0x100000 + 1024 * 1024 - 1)      uc.hook_add(UC_HOOK_CODE, hook_code)     uc.hook_add(UC_HOOK_MEM_READ_UNMAPPED, hook_unmapped)     #uc.hook_add(UC_ERR_FETCH_UNMAPPED, unicorn_hook_add)      try:         uc.emu_start(0x4004E0, 0x400582)     except UcError as e:         print(e)  if __name__ == "__main__":     main() ```  segmentation fault  ``` ‚îî‚îÄ$ python3 poc.py      0x4004e0:       push    rbp 0x4004e1:       push    rbx 0x4004e2:       xor     esi, esi 0x4004e4:       mov     ebp, 0x4007e1 0x4004e9:       xor     ebx, ebx 0x4004eb:       sub     rsp, 0x18 0x4004ef:       mov     rdi, qword ptr [rip + 0x200b42] >>> Tracing instruction at 0x601038, instruction size = 0x8 17303 zsh: segmentation fault  python3 poc.py ```  gdb debug  ``` gef‚û§  bt #0  0x0000000000000000 in ?? () #1  0x00000000013fdd38 in ?? () #2  0x00007f9e1eac5269 in clear_deleted_hooks (uc=0x13fd620) at /home/lys/Documents/unicorn-1.0.3/uc.c:567 #3  uc_emu_start (uc=0x13fd620, begin=<optimized out>, until=<optimized out>, timeout=0x0, count=<optimized out>) at /home/lys/Documents/unicorn-1.0.3/uc.c:673                                                                                        #4  0x00007f9e1fa12ccd in ?? () from /lib/x86_64-linux-gnu/libffi.so.7 #5  0x00007f9e1fa1225a in ?? () from /lib/x86_64-linux-gnu/libffi.so.7 #6  0x00000000004f8209 in _PyObject_GenericSetAttrWithDict () #7  0x00000000004f7d8a in PyObject_SetAttr () #8  0x0000000000505fa5 in _PyEval_EvalFrameDefault () #9  0x000000000050f9c0 in _PyObject_FastCallDict () #10 0x0000000000526a61 in ?? () #11 0x00007f9e1fa1202c in ?? () from /lib/x86_64-linux-gnu/libffi.so.7 #12 0x00007f9e1fa1225a in ?? () from /lib/x86_64-linux-gnu/libffi.so.7 #13 0x00007f9e1fb9960a in _ctypes_callproc () from /usr/lib/python3.8/lib-dynload/_ctypes.cpython-38-x86_64-linux-gnu.so #14 0x00000000008c3bc0 in ?? () #15 0x00007f9e1fa8ed70 in ?? () #16 0x00007f9e1fb027c0 in ?? () #17 0x00007f9e1fa9b680 in ?? () #18 0x0000000000000000 in ?? () ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@aquynh](https://avatars.githubusercontent.com/u/5965536?s=80&u=f3eac23969e0e93688f38ac9cf81f264eb9ea509&v=4)](/aquynh)

Copy link

Member

### **[aquynh](/aquynh)** commented [Apr 1, 2022](#issuecomment-1085744780) via email

| Please try with "dev" branch |
| --- |

All reactions

Sorry, something went wrong.

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=80&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)

Copy link

Contributor

Author

### **[liyansong2018](/liyansong2018)** commented [Apr 1, 2022](#issuecomment-1086034398) ‚Ä¢ edited Loading

| Unicorn Python package supports up to version 1.0.3  ``` [Latest version](https://pypi.org/project/unicorn/) Released: May 27, 2021 unicorn 1.0.3  ```  I also tried to use `libunicorn.so.2` generated by compiling unicorn dev branch replace `libunicorn.so`(1.0.3) installed by PIP command. But unicorn 2 doesn't seem to work well in the latest version of the unicorn python API.  I also modified the `unicorn.py` to try to bypass `unicorn.py` detection of the unicorn version, but there will still be compatibility problems.  ``` # unicorn.py # verify version compatibility with the core before doing anything (major, minor, _combined) = uc_version() ''' if major != uc.UC_API_MAJOR or minor != uc.UC_API_MINOR:     self._uch = None     # our binding version is different from the core's API version     raise UcError(uc.UC_ERR_VERSION) ''' ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=80&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)

Copy link

Contributor

Author

### **[liyansong2018](/liyansong2018)** commented [Apr 2, 2022](#issuecomment-1086629453) ‚Ä¢ edited Loading

| I may know the cause of the problem.  `0x00000000013fdd38` -> `uc->hooks_to_del->head` .  When we use `uc_emu_start` for the second time, unicorn is already in an abnormal state (`Invalid memory read (UC_ERR_READ_UNMAPPED)`), so it will continue run to the following code  ``` // uc.c  uc_emu_start if (uc->vm_start(uc)) {     return UC_ERR_RESOURCE; }  // emulation is done uc->emulation_done = true;  // remove hooks to delete clear_deleted_hooks(uc); ```  remove hooks to delete!  However, our PoC is still in the first `uc_emu_start->vm_start` environment, and QEMU TCG is still trying to execute hook code. In fact, the hook code has been released. |
| --- |

All reactions

Sorry, something went wrong.

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=80&u=0349d29c906330eae5e106f37944c0e34ede49f5&v=4)](/wtdcode)

Copy link

Member

### **[wtdcode](/wtdcode)** commented [Apr 2, 2022](#issuecomment-1086734432)

| Unicorn Python package supports up to version 1.0.3  ``` [Latest version](https://pypi.org/project/unicorn/) Released: May 27, 2021 unicorn 1.0.3  ```  I also tried to use `libunicorn.so.2` generated by compiling unicorn dev branch replace `libunicorn.so`(1.0.3) installed by PIP command. But unicorn 2 doesn't seem to work well in the latest version of the unicorn python API.  I also modified the `unicorn.py` to try to bypass `unicorn.py` detection of the unicorn version, but there will still be compatibility problems.  ``` # unicorn.py # verify version compatibility with the core before doing anything (major, minor, _combined) = uc_version() ''' if major != uc.UC_API_MAJOR or minor != uc.UC_API_MINOR:     self._uch = None     # our binding version is different from the core's API version     raise UcError(uc.UC_ERR_VERSION) ''' ```  `pip3 install --pre unicorn` will do the trick. |
| --- |

All reactions

Sorry, something went wrong.

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=40&u=0349d29c906330eae5e106f37944c0e34ede49f5&v=4)](/wtdcode)
[wtdcode](/wtdcode)
added
the
[question](/unicorn-engine/unicorn/labels/question)
label
[Apr 3, 2022](#event-6358710313)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=80&v=4)](/apps/github-actions)

Copy link

### **[github-actions](/apps/github-actions) bot** commented [Jun 3, 2022](#issuecomment-1145600231)

| This issue is stale because it has been open 60 days with no activity. Remove stale label or comment or this will be closed in 15 days. |
| --- |

All reactions

Sorry, something went wrong.

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
the
[stale](/unicorn-engine/unicorn/labels/stale)
label
[Jun 3, 2022](#event-6733707760)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
closed this as [completed](/unicorn-engine/unicorn/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jun 19, 2022](#event-6834292335)

[![@snemes](https://avatars.githubusercontent.com/u/6277790?s=80&v=4)](/snemes)

Copy link

### **[snemes](/snemes)** commented [Dec 7, 2022](#issuecomment-1340868780) ‚Ä¢ edited Loading

| Just FYI, this issue no longer seems to affect the 2.0.1 version.  I tried to run the proof of concept code posted in the description, and apparently it does not produce a crash with the 2.0.1 version of unicorn.  ``` $ venv/bin/python3 -m pip install unicorn==1.0.3 Collecting unicorn==1.0.3   Using cached unicorn-1.0.3-py2.py3-none-manylinux1_x86_64.whl (8.1 MB) Installing collected packages: unicorn Successfully installed unicorn-1.0.3  $ ./poc.py 0x4004e0:    adc    byte ptr [rax], dh >>> Tracing instruction at 0x0, instruction size = 0x1 160351 Segmentation fault (core dumped)  $ venv/bin/python3 -m pip install -U unicorn Requirement already satisfied: unicorn in ./venv/lib/python3.10/site-packages (1.0.3) Collecting unicorn   Downloading unicorn-2.0.1.post1-py2.py3-none-manylinux1_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl (16.1 MB)      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ 16.1/16.1 MB 9.9 MB/s eta 0:00:00 Installing collected packages: unicorn   Attempting uninstall: unicorn     Found existing installation: unicorn 1.0.3     Uninstalling unicorn-1.0.3:       Successfully uninstalled unicorn-1.0.3 Successfully installed unicorn-2.0.1.post1  $ ./poc.py 0x4004e0:    adc    byte ptr [rax], dh >>> Tracing instruction at 0x0, instruction size = 0x1 160366 Invalid memory read (UC_ERR_READ_UNMAPPED)  ```  The 2nd invocation of the Python code using the 2.0.1 version of the package just displays an error message as expected without crashing. |
| --- |

 üëç
1
 themanifold reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1578)

Assignees

No one assigned

Labels

[question](/unicorn-engine/unicorn/labels/question)
[stale](/unicorn-engine/unicorn/labels/stale)

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

4 participants

[![@aquynh](https://avatars.githubusercontent.com/u/5965536?s=52&v=4)](/aquynh) [![@snemes](https://avatars.githubusercontent.com/u/6277790?s=52&v=4)](/snemes) [![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=52&v=4)](/liyansong2018) [![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=52&v=4)](/wtdcode)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


