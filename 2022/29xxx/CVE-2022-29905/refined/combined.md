=== Content from gerrit.wikimedia.org_058e4ec8_20250114_214406.html ===




=== Content from phabricator.wikimedia.org_9551889e_20250114_214407.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT306741)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T306741
# FanBoxes: classic CSRF in Special:UserBoxesClosed, Resolved[Public](/policy/explain/PHID-TASK-umbiiscciiqnt565bhen/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/306741/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/306741/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-umbiiscciiqnt565bhen/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-umbiiscciiqnt565bhen/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-umbiiscciiqnt565bhen/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-umbiiscciiqnt565bhen/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-umbiiscciiqnt565bhen/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-umbiiscciiqnt565bhen/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-umbiiscciiqnt565bhen/)
* [Protect as security issue](/wmf/escalate-task/306741/)
* [Award Token](/token/give/PHID-TASK-umbiiscciiqnt565bhen/)
* [Flag For Later](/flag/edit/PHID-TASK-umbiiscciiqnt565bhen/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Apr 23 2022, 1:04 PM2022-04-23 13:04:04 (UTC+0) |

Tags

* [Security](/tag/security/)
* [Social-Tools](/tag/social-tools/) [(Backlog)](/project/board/1009/)
* [FanBoxes](/tag/fanboxes/) [(Backlog)](/project/board/810/)
* [Vuln-CSRF](/tag/vuln-csrf/) [(Tracked)](/project/board/907/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

Special:UserBoxes, the special page used to create new social user boxes and edit existing ones (pages in the UserBox: namespace), does not check for the presence of an anti-CSRF token, it will happily create/update the requested page as long as the request was POSTed and the desired form fields are set.

Quick patch:

```
diff --git a/includes/specials/SpecialFanBoxes.php b/includes/specials/SpecialFanBoxes.php
index aac26be..7835e2d 100644
--- a/includes/specials/SpecialFanBoxes.php
+++ b/includes/specials/SpecialFanBoxes.php
@@ -115,6 +115,7 @@ class FanBoxes extends SpecialPage {
                        $output .= Html::hidden( 'textColorLeftSideColor', $update_fan->getFanBoxLeftTextColor(), [ 'id' => 'textColorLeftSideColor' ] ) . "\n";
                        $output .= Html::hidden( 'bgColorRightSideColor', $update_fan->getFanBoxRightBgColor(), [ 'id' => 'bgColorRightSideColor' ] ) . "\n";
                        $output .= Html::hidden( 'textColorRightSideColor', $update_fan->getFanBoxRightTextColor(), [ 'id' => 'textColorRightSideColor' ] ) . "\n";
+                       $output .= Html::hidden( 'wpEditToken', $user->getEditToken() );

                        $fantag_image_tag = '';
                        if ( $update_fan->getFanBoxImage() ) {
@@ -254,6 +255,8 @@ class FanBoxes extends SpecialPage {
                        <input type="hidden" name="bgColorRightSideColor" id="bgColorRightSideColor" value="" />
                        <input type="hidden" name="textColorRightSideColor" id="textColorRightSideColor" value="" />';

+                       $output .= Html::hidden( 'wpEditToken', $user->getEditToken() );
+
                        if ( !$destination ) {
                                $output .= '<h2 class="fanbox-form-label">' . $this->msg( 'fanbox-title' )->escaped() . '</h2>
                                        <div class="create-fanbox-title">
@@ -330,6 +333,13 @@ class FanBoxes extends SpecialPage {

                // Send values to database and create fantag page when form is submitted
                if ( $request->wasPosted() ) {
+                       // Protect against CSRF
+                       if ( !$user->matchEditToken( $request->getVal( 'wpEditToken' ) ) ) {
+                               $out->addWikiMsg( 'sessionfailure' );
+                               $out->addReturnTo( $this->getPageTitle() );
+                               return;
+                       }
+
                        if ( !$fanboxId ) {
                                // @phan-suppress-next-line PhanTypeMismatchArgumentNullable
                                $fan = FanBox::newFromName( $title );
```
# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [[SECURITY] Add anti-CSRF token to Special:UserBoxes](https://gerrit.wikimedia.org/r/c/786327) | [mediawiki/extensions/FanBoxes](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FanBoxes) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FanBoxes/%2B/master) | +10 -0 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T306741)
# Related Objects

* Mentions

Mentioned In [T305209: Write and send supplementary release announcement for extensions and skins with security patches (1.35.7/1.37.3/1.38.2)](/T305209)
### Event Timeline

[ashley](/p/ashley/) created this task.[Apr 23 2022, 1:04 PM2022-04-23 13:04:04 (UTC+0)](#7874958)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/4733973/)[Apr 23 2022, 1:04 PM2022-04-23 13:04:05 (UTC+0)](#7874968)[ashley](/p/ashley/) claimed this task.[Apr 23 2022, 1:04 PM2022-04-23 13:04:39 (UTC+0)](#7874969)[ashley](/p/ashley/) added projects: [Social-Tools](/tag/social-tools/), [FanBoxes](/tag/fanboxes/), [Vuln-CSRF](/tag/vuln-csrf/).[ashley](/p/ashley/) added a subscriber: [Bawolff](/p/Bawolff/).[Apr 26 2022, 3:01 PM2022-04-26 15:01:25 (UTC+0)](#7881259)[Bawolff](/p/Bawolff/) added a comment.[Apr 26 2022, 3:03 PM2022-04-26 15:03:10 (UTC+0)](#7881268)Comment Actions

Looks like it fixes the problem

[Bawolff](/p/Bawolff/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-73u4t2nekkddxu2/)" to "Public (No Login Required)".[Apr 26 2022, 3:19 PM2022-04-26 15:19:45 (UTC+0)](#7881309)[Bawolff](/p/Bawolff/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-oweivf53gvyzuzh/)" to "All Users".[ashley](/p/ashley/) closed this task as Resolved.[Apr 26 2022, 3:21 PM2022-04-26 15:21:57 (UTC+0)](#7881315)[RhinosF1](/p/RhinosF1/) mentioned this in [T305209: Write and send supplementary release announcement for extensions and skins with security patches (1.35.7/1.37.3/1.38.2)](/T305209).[Apr 27 2022, 7:43 PM2022-04-27 19:43:38 (UTC+0)](#7885768)[sbassett](/p/sbassett/) edited projects, added [SecTeam-Processed](/tag/secteam-processed/); removed [Security-Team](/tag/security-team/).[May 2 2022, 5:35 PM2022-05-02 17:35:16 (UTC+0)](#7896875)[sbassett](/p/sbassett/) subscribed.Comment Actions

**gerritbot:** [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/FanBoxes/+/786327](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/FanBoxes/%2B/786327)

Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
