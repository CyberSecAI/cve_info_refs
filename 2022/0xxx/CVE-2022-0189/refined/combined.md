=== Content from plugins.trac.wordpress.org_ee26cf2c_20250114_220623.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2659298)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/2659297 "Changeset 2659297")
* [Next Changeset](/changeset/2659299 "Changeset 2659299") →

---

# Changeset 2659298

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
01/18/2022 11:48:26 AM
([3 years](/timeline?from=2022-01-18T11%3A48%3A26Z&precision=second "See timeline at 01/18/2022 11:48:26 AM") ago)

Author:
Mekku
Message:

Trunk v4.20

Location:
[wp-rss-aggregator/trunk](/browser/wp-rss-aggregator/trunk?rev=2659298)
Files:

11 edited

* [CHANGELOG.md](/browser/wp-rss-aggregator/trunk/CHANGELOG.md?rev=2659298 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [includes/Aventura/Wprss/Core/Licensing/Settings.php](/browser/wp-rss-aggregator/trunk/includes/Aventura/Wprss/Core/Licensing/Settings.php?rev=2659298 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [includes/admin-display.php](/browser/wp-rss-aggregator/trunk/includes/admin-display.php?rev=2659298 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [includes/admin-help-metaboxes.php](/browser/wp-rss-aggregator/trunk/includes/admin-help-metaboxes.php?rev=2659298 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [includes/admin-metaboxes.php](/browser/wp-rss-aggregator/trunk/includes/admin-metaboxes.php?rev=2659298 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [includes/feed-importing-images.php](/browser/wp-rss-aggregator/trunk/includes/feed-importing-images.php?rev=2659298 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [includes/feed-importing.php](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298 "Show entry in browser")
  (modified)
  ([8 diffs](#file6 "Show differences"))
* [includes/feed-processing.php](/browser/wp-rss-aggregator/trunk/includes/feed-processing.php?rev=2659298 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [readme.txt](/browser/wp-rss-aggregator/trunk/readme.txt?rev=2659298 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [vendor/composer/installed.php](/browser/wp-rss-aggregator/trunk/vendor/composer/installed.php?rev=2659298 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [wp-rss-aggregator.php](/browser/wp-rss-aggregator/trunk/wp-rss-aggregator.php?rev=2659298 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-rss-aggregator/trunk/CHANGELOG.md](/changeset/2659298/wp-rss-aggregator/trunk/CHANGELOG.md "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/CHANGELOG.md")

  | [r2634846](/browser/wp-rss-aggregator/trunk/CHANGELOG.md?rev=2634846#L4 "Show revision 2634846 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/CHANGELOG.md?rev=2659298#L4 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | The format is based on [Keep a Changelog](http://keepachangelog.com/) |
  | 5 | 5 | and this project adheres to [Semantic Versioning](http://semver.org/). |
  |  | 6 |  |
  |  | 7 | ## [4.20] - 2022-01-18 |
  |  | 8 | ### Added |
  |  | 9 | \* New option to use feed item GUIDs instead of permalinks to detect duplicate items. |
  |  | 10 |  |
  |  | 11 | ### Changed |
  |  | 12 | \* Small performance improvement when importing feed items. |
  |  | 13 |  |
  |  | 14 | ### Fixed |
  |  | 15 | \* A warning about `get\_headers()` only working with URLs. |
  |  | 16 | \* A warning about iteration over a non-array value. |
  |  | 17 | \* An AJAX XSS vulnerability on the Feed Sources page. Thanks WPScan! |
  | 6 | 18 |  |
  | 7 | 19 | ## [4.19.3] - 2021-11-24 |
* ## [wp-rss-aggregator/trunk/includes/Aventura/Wprss/Core/Licensing/Settings.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/Aventura/Wprss/Core/Licensing/Settings.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/Aventura/Wprss/Core/Licensing/Settings.php")

  | [r2621306](/browser/wp-rss-aggregator/trunk/includes/Aventura/Wprss/Core/Licensing/Settings.php?rev=2621306#L350 "Show revision 2621306 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/Aventura/Wprss/Core/Licensing/Settings.php?rev=2659298#L350 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 350 | 350 |  |
  | 351 | 351 | $license = $manager->getLicense($addonId); |
  | 352 |  |  |
  | 353 |  | if ($license !== null && !$license->isInvalid() && ($licenseKey = $license->getKey()) && !empty($licenseKey)) { |
  |  | 352 | $licenseValid = $license !== null && $license->isValid(); |
  |  | 353 | $licenseKey = $license !== null ? $license->getKey() : null; |
  |  | 354 |  |
  |  | 355 | if ($licenseValid && !empty($licenseKey)) { |
  | 354 | 356 | if (!is\_object($data)) { |
  | 355 | 357 | printf( |
  | 356 |  | '<p><small>%</small></p>', |
  |  | 358 | '<p><small>%s</small></p>', |
  | 357 | 359 | \_\_( |
  | 358 | 360 | 'Failed to get license information. This is a temporary problem. Check your internet connection and try again later.', |
* ## [wp-rss-aggregator/trunk/includes/admin-display.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/admin-display.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/admin-display.php")

  | [r2621306](/browser/wp-rss-aggregator/trunk/includes/admin-display.php?rev=2621306#L484 "Show revision 2621306 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/admin-display.php?rev=2659298#L484 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 484 | 484 | $response = wprss()->createAjaxResponse(); |
  | 485 | 485 | $wprss = wprss(); |
  | 486 |  | $kFeedSourceId = 'feed\_source\_id'; |
  |  | 486 | $feedIdKey = 'feed\_source\_id'; |
  |  | 487 |  |
  | 487 | 488 | try { |
  | 488 |  | ~~$kId = 'id';~~ |
  | 489 |  | ~~if (!isset($\_POST[$kId]) || empty($\_POST[$kId])) {~~ |
  | 490 |  | ~~throw new Exception($wprss->\_\_('Could not schedule fetch: source ID must be specified'));~~ |
  | 491 |  | ~~}~~ |
  | 492 |  | ~~$id = $\_POST['id'];~~ |
  | 493 |  | ~~$response->setAjaxData($kFeedSourceId, $id);~~ |
  | 494 |  |  |
  | 495 | 489 | if (!current\_user\_can('edit\_feed\_sources')) { |
  | 496 |  | throw new Exception($wprss->\_\_([ |
  | 497 |  | 'Could not schedule fetch for source #%1$s: user must have sufficient privileges', |
  | 498 |  | $id, |
  | 499 |  | ])); |
  |  | 490 | throw new Exception(\_\_('Could not schedule fetch for feed source: user must have sufficient privileges.')); |
  | 500 | 491 | } |
  | 501 | 492 |  |
  | 502 | 493 | // Verify admin referer |
  | 503 | 494 | if (!wprss\_verify\_nonce('wprss\_feed\_source\_action', 'wprss\_admin\_ajax\_nonce')) { |
  | 504 |  | throw new Exception($wprss->\_\_(['Could not schedule fetch for source #%1$s: nonce is expired', $id])); |
  | 505 |  | } |
  |  | 495 | throw new Exception(\_\_('Could not schedule fetch for feed source: nonce is invalid.', 'wprss')); |
  |  | 496 | } |
  |  | 497 |  |
  |  | 498 | $id = filter\_input(INPUT\_POST, 'id', FILTER\_VALIDATE\_INT); |
  |  | 499 | if (!$id) { |
  |  | 500 | throw new Exception($wprss->\_\_('Could not schedule fetch: feed source ID is invalid or was not specified')); |
  |  | 501 | } |
  |  | 502 | $response->setAjaxData($feedIdKey, $id); |
  |  | 503 |  |
  | 506 | 504 |  |
  | 507 | 505 | update\_post\_meta($id, 'wprss\_force\_next\_fetch', '1'); |
  | […](/browser/wp-rss-aggregator/trunk/includes/admin-display.php?rev=2621306#L535) | […](/browser/wp-rss-aggregator/trunk/includes/admin-display.php?rev=2659298#L533) |  |
  | 535 | 533 | $response = wprss()->createAjaxErrorResponse($e); |
  | 536 | 534 | if (isset($id)) { |
  | 537 |  | $response->setAjaxData($~~kFeedSourceId~~, $id); |
  |  | 535 | $response->setAjaxData($feedIdKey, $id); |
  | 538 | 536 | } |
  | 539 | 537 | echo $response->getBody(); |
* ## [wp-rss-aggregator/trunk/includes/admin-help-metaboxes.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/admin-help-metaboxes.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/admin-help-metaboxes.php")

  | [r2621306](/browser/wp-rss-aggregator/trunk/includes/admin-help-metaboxes.php?rev=2621306#L54 "Show revision 2621306 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/admin-help-metaboxes.php?rev=2659298#L54 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 54 | 54 | "\n\n" . |
  | 55 | 55 | 'This option only applies when using the shortcode to output feed items.', |
  |  | 56 | 'wprss' |
  |  | 57 | ), |
  |  | 58 |  |
  |  | 59 | 'wprss\_use\_guids' => \_\_( |
  |  | 60 | 'Enable this option to identify duplicate feed items by their GUIDs, rather than by their permalink.' . |
  |  | 61 | "\n\n" . |
  |  | 62 | 'This can be useful when the feed items share the same permalink, and so not all feed items would get imported.', |
  | 56 | 63 | 'wprss' |
  | 57 | 64 | ), |
* ## [wp-rss-aggregator/trunk/includes/admin-metaboxes.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/admin-metaboxes.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/admin-metaboxes.php")

  | [r2621306](/browser/wp-rss-aggregator/trunk/includes/admin-metaboxes.php?rev=2621306#L120 "Show revision 2621306 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/admin-metaboxes.php?rev=2659298#L120 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 120 | 120 | 'label' => \_\_('Use source info', 'wprss'), |
  | 121 | 121 | 'id' => $prefix . 'import\_source', |
  |  | 122 | 'type' => 'checkbox', |
  |  | 123 | ]; |
  |  | 124 |  |
  |  | 125 | $wprss\_meta\_fields['use\_guids'] = [ |
  |  | 126 | 'label' => \_\_('Use GUIDs', 'wprss'), |
  |  | 127 | 'id' => $prefix . 'use\_guids', |
  | 122 | 128 | 'type' => 'checkbox', |
  | 123 | 129 | ]; |
* ## [wp-rss-aggregator/trunk/includes/feed-importing-images.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/feed-importing-images.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/feed-importing-images.php")

  | [r2634846](/browser/wp-rss-aggregator/trunk/includes/feed-importing-images.php?rev=2634846#L465 "Show revision 2634846 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/feed-importing-images.php?rev=2659298#L465 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 465 | 465 | } |
  | 466 | 466 |  |
  | 467 |  | foreach ($enclosure->get\_thumbnails() as $thumbnail) { |
  |  | 467 | $thumbnails = $enclosure->get\_thumbnails(); |
  |  | 468 | $thumbnails = is\_array($thumbnails) ? $thumbnails : []; |
  |  | 469 |  |
  |  | 470 | foreach ($thumbnails as $thumbnail) { |
  | 468 | 471 | if (empty($thumbnail)) { |
  | 469 | 472 | continue; |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing-images.php?rev=2634846#L1037) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing-images.php?rev=2659298#L1040) |  |
  | 1037 | 1040 | function wpra\_is\_url\_an\_image($url) |
  | 1038 | 1041 | { |
  | 1039 |  | $headers = get\_headers($url, true); |
  |  | 1042 | $headers = @get\_headers($url, true); |
  |  | 1043 | $headers = is\_array($headers) ? $headers : []; |
  | 1040 | 1044 | $headers = array\_change\_key\_case($headers, CASE\_LOWER); |
  | 1041 | 1045 |  |
* ## [wp-rss-aggregator/trunk/includes/feed-importing.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/feed-importing.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/feed-importing.php")

  | [r2621306](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L34 "Show revision 2621306 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L34 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 |  |
  | 35 | 35 | $importFn = function ($feed\_ID) { |
  |  | 36 | $feedName = get\_the\_title($feed\_ID); |
  |  | 37 |  |
  | 36 | 38 | $logger = wpra\_get\_logger($feed\_ID); |
  | 37 |  | $logger->info('Starting import ~~of feed {id}', ['id' => $feed\_ID~~]); |
  |  | 39 | $logger->info('Starting import for "{0}"', [$feedName]); |
  | 38 | 40 |  |
  | 39 | 41 | $t = microtime(true); |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L107) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L109) |  |
  | 107 | 109 | $existing\_titles = []; |
  | 108 | 110 |  |
  | 109 |  | // Gather the permalinks of existing feed item's related to this feed source |
  | 110 |  | $existing\_permalinks = wprss\_get\_existing\_permalinks( $feed\_ID ); |
  |  | 111 | // Gather the existing feed item IDs for this feed source |
  |  | 112 | $useGuids = get\_post\_meta($feed\_ID, 'wprss\_use\_guids', true); |
  |  | 113 | $useGuids = filter\_var($useGuids, FILTER\_VALIDATE\_BOOLEAN); |
  |  | 114 | $existingIds = $useGuids |
  |  | 115 | ? wprss\_get\_existing\_guids($feed\_ID) |
  |  | 116 | : wprss\_get\_existing\_permalinks($feed\_ID); |
  | 111 | 117 |  |
  | 112 | 118 | // Generate a list of items fetched, that are not already in the DB |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L114) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L120) |  |
  | 114 | 120 | foreach ( $items\_to\_insert as $item ) { |
  | 115 | 121 | $item\_title = $item->get\_title(); |
  |  | 122 | $guid = $item->get\_id(); |
  | 116 | 123 | $permalink = $item->get\_permalink(); |
  | 117 | 124 | $permalink = wprss\_normalize\_permalink( $permalink, $item, $feed\_ID ); |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L125) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L132) |  |
  | 125 | 132 |  |
  | 126 | 133 | // Check if already imported |
  | 127 |  | if (array\_key\_exists($permalink, $existing\_permalinks)) { |
  |  | 134 | $idToCheck = $useGuids ? $guid : $permalink; |
  |  | 135 | if (array\_key\_exists($idToCheck, $existingIds)) { |
  | 128 | 136 | $logger->debug('Item "{0}" already exists in the database', [$item\_title]); |
  | 129 | 137 |  |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L146) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L154) |  |
  | 146 | 154 | } |
  | 147 | 155 |  |
  |  | 156 | $existingIds[$idToCheck] = 1; |
  | 148 | 157 | $new\_items[] = $item; |
  | 149 | 158 | } |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L573) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L582) |  |
  | 573 | 582 | $logger = wpra\_get\_logger($feed\_ID); |
  | 574 | 583 |  |
  | 575 |  | ~~// Gather the permalinks of existing feed item's related to this feed source~~ |
  | 576 |  | ~~$existing\_permalinks = wprss\_get\_existing\_permalinks( $feed\_ID );~~ |
  | 577 |  |  |
  | 578 | 584 | // Count of items inserted |
  | 579 | 585 | $items\_inserted = 0; |
  | 580 | 586 |  |
  | 581 | 587 | foreach ( $items as $i => $item ) { |
  | 582 |  |  |
  | 583 |  | // Normalize the URL |
  | 584 |  | $permalink = $item->get\_permalink(); // Link or enclosure URL |
  | 585 |  | $permalink = wprss\_normalize\_permalink( $permalink, $item, $feed\_ID ); |
  |  | 588 | $permalink = $item->get\_permalink(); |
  |  | 589 | $permalink = wprss\_normalize\_permalink($permalink, $item, $feed\_ID); |
  | 586 | 590 |  |
  | 587 | 591 | $logger->debug('Beginning import for item "{0}"', [$item->get\_title()]); |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L595) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L599) |  |
  | 595 | 599 | } |
  | 596 | 600 |  |
  | 597 |  | // Check if newly fetched item already present in existing feed items, |
  | 598 |  | // if not insert it into wp\_posts and insert post meta. |
  | 599 |  | if ( ! ( array\_key\_exists( $permalink, $existing\_permalinks ) ) ) { |
  | 600 |  | // Extend the importing time and refresh the feed's updating flag to reflect that it is active |
  | 601 |  | $time\_limit = wprss\_get\_item\_import\_time\_limit(); |
  | 602 |  | set\_time\_limit( $time\_limit ); |
  | 603 |  |  |
  | 604 |  | global $wp\_filter; |
  | 605 |  | if (isset($wp\_filter['wprss\_insert\_post\_item\_conditionals'])) { |
  | 606 |  | $hook = $wp\_filter['wprss\_insert\_post\_item\_conditionals']; |
  | 607 |  |  |
  | 608 |  | if (count($hook->callbacks) > 0) { |
  | 609 |  | $logger->debug('Hooks for `wprss\_insert\_post\_item\_conditionals`:'); |
  |  | 601 | // Extend the importing time and refresh the feed's updating flag to reflect that it is active |
  |  | 602 | $time\_limit = wprss\_get\_item\_import\_time\_limit(); |
  |  | 603 | set\_time\_limit( $time\_limit ); |
  |  | 604 |  |
  |  | 605 | global $wp\_filter; |
  |  | 606 | if (isset($wp\_filter['wprss\_insert\_post\_item\_conditionals'])) { |
  |  | 607 | $hook = $wp\_filter['wprss\_insert\_post\_item\_conditionals']; |
  |  | 608 |  |
  |  | 609 | if (count($hook->callbacks) > 0) { |
  |  | 610 | $logger->debug('Hooks for `wprss\_insert\_post\_item\_conditionals`:'); |
  |  | 611 | } |
  |  | 612 |  |
  |  | 613 | foreach ($hook->callbacks as $list) { |
  |  | 614 | foreach ($list as $callback) { |
  |  | 615 | $logger->debug('-> {0}', [wprss\_format\_hook\_callback($callback)]); |
  | 610 | 616 | } |
  | 611 |  |  |
  | 612 |  | foreach ($hook->callbacks as $list) { |
  | 613 |  | foreach ($list as $callback) { |
  | 614 |  | $logger->debug('-> {0}', [wprss\_format\_hook\_callback($callback)]); |
  |  | 617 | } |
  |  | 618 | } |
  |  | 619 |  |
  |  | 620 | $logger->debug('Checking conditionals ...'); |
  |  | 621 |  |
  |  | 622 | // Apply filters that determine if the feed item should be inserted into the DB or not. |
  |  | 623 | $ogItem = $item; |
  |  | 624 | $item = apply\_filters( 'wprss\_insert\_post\_item\_conditionals', $item, $feed\_ID, $permalink ); |
  |  | 625 | /\* @var $item SimplePie\_Item \*/ |
  |  | 626 |  |
  |  | 627 | // Check if the imported count should still be updated, even if the item is NULL |
  |  | 628 | $still\_update\_count = apply\_filters( 'wprss\_still\_update\_import\_count', FALSE ); |
  |  | 629 |  |
  |  | 630 | // If the item is not NULL, continue to inserting the feed item post into the DB |
  |  | 631 | if ( $item !== NULL && !is\_bool($item) ) { |
  |  | 632 | $logger->debug('Resuming insertion into DB'); |
  |  | 633 |  |
  |  | 634 | $post\_status = 'publish'; |
  |  | 635 |  |
  |  | 636 | // Get the date and GMT date and normalize if not valid or not given by the feed |
  |  | 637 | $format    = 'Y-m-d H:i:s'; |
  |  | 638 | $timestamp = $item->get\_date( 'U' ); |
  |  | 639 | $has\_date  = $timestamp ? true : false; |
  |  | 640 |  |
  |  | 641 | if ($has\_date) { |
  |  | 642 | $logger->debug('Feed item "{0}" date: {1}', [$item->get\_title(), $item->get\_date($format)]); |
  |  | 643 |  |
  |  | 644 | if ($timestamp > time()) { |
  |  | 645 | // Item has a future timestamp ... |
  |  | 646 | $logger->debug('Item "{0}" has a future date', [$item->get\_title()]); |
  |  | 647 |  |
  |  | 648 | $schedule\_items\_filter = apply\_filters('wpra/importer/allow\_scheduled\_items', false); |
  |  | 649 | $schedule\_items\_option = wprss\_get\_general\_setting('schedule\_future\_items'); |
  |  | 650 |  |
  |  | 651 | if ($schedule\_items\_filter || $schedule\_items\_option) { |
  |  | 652 | // If can schedule future items, set the post status to "future" (aka scheduled) |
  |  | 653 | $post\_status = 'future'; |
  |  | 654 |  |
  |  | 655 | $logger->debug('Setting future status'); |
  |  | 656 | } else { |
  |  | 657 | // If cannot schedule future items, clamp the timestamp to the current time minus |
  |  | 658 | // 1 second for each iteration done so far |
  |  | 659 | $timestamp = min(time() - $i, $timestamp); |
  |  | 660 |  |
  |  | 661 | $logger->debug('Date was clamped to present time'); |
  | 615 | 662 | } |
  | 616 | 663 | } |
  | 617 |  | } |
  | 618 |  |  |
  | 619 |  | $logger->debug('Checking conditionals ...'); |
  | 620 |  |  |
  | 621 |  | // Apply filters that determine if the feed item should be inserted into the DB or not. |
  | 622 |  | $ogItem = $item; |
  | 623 |  | $item = apply\_filters( 'wprss\_insert\_post\_item\_conditionals', $item, $feed\_ID, $permalink ); |
  | 624 |  | /\* @var $item SimplePie\_Item \*/ |
  | 625 |  |  |
  | 626 |  | // Check if the imported count should still be updated, even if the item is NULL |
  | 627 |  | $still\_update\_count = apply\_filters( 'wprss\_still\_update\_import\_count', FALSE ); |
  | 628 |  |  |
  | 629 |  | // If the item is not NULL, continue to inserting the feed item post into the DB |
  | 630 |  | if ( $item !== NULL && !is\_bool($item) ) { |
  | 631 |  | $logger->debug('Resuming insertion into DB'); |
  | 632 |  |  |
  | 633 |  | $post\_status = 'publish'; |
  | 634 |  |  |
  | 635 |  | // Get the date and GMT date and normalize if not valid or not given by the feed |
  | 636 |  | $format    = 'Y-m-d H:i:s'; |
  | 637 |  | $timestamp = $item->get\_date( 'U' ); |
  | 638 |  | $has\_date  = $timestamp ? true : false; |
  | 639 |  |  |
  | 640 |  | if ($has\_date) { |
  | 641 |  | $logger->debug('Feed item "{0}" date: {1}', [$item->get\_title(), $item->get\_date($format)]); |
  | 642 |  |  |
  | 643 |  | if ($timestamp > time()) { |
  | 644 |  | // Item has a future timestamp ... |
  | 645 |  | $logger->debug('Item "{0}" has a future date', [$item->get\_title()]); |
  | 646 |  |  |
  | 647 |  | $schedule\_items\_filter = apply\_filters('wpra/importer/allow\_scheduled\_items', false); |
  | 648 |  | $schedule\_items\_option = wprss\_get\_general\_setting('schedule\_future\_items'); |
  | 649 |  |  |
  | 650 |  | if ($schedule\_items\_filter || $schedule\_items\_option) { |
  | 651 |  | // If can schedule future items, set the post status to "future" (aka scheduled) |
  | 652 |  | $post\_status = 'future'; |
  | 653 |  |  |
  | 654 |  | $logger->debug('Setting future status'); |
  | 655 |  | } else { |
  | 656 |  | // If cannot schedule future items, clamp the timestamp to the current time minus |
  | 657 |  | // 1 second for each iteration done so far |
  | 658 |  | $timestamp = min(time() - $i, $timestamp); |
  | 659 |  |  |
  | 660 |  | $logger->debug('Date was clamped to present time'); |
  | 661 |  | } |
  |  | 664 | } else { |
  |  | 665 | // Item has no date ... |
  |  | 666 | $logger->debug('Item "{0}" has no date. Using current time', [$item->get\_title()]); |
  |  | 667 | $timestamp = time(); |
  |  | 668 | } |
  |  | 669 |  |
  |  | 670 | $date     = date( $format, $timestamp ); |
  |  | 671 | $date\_gmt = gmdate( $format, $item->get\_gmdate( 'U' ) ); |
  |  | 672 |  |
  |  | 673 | $logger->debug('Date for "{0}" will be {1}', [$item->get\_title(), $date]); |
  |  | 674 |  |
  |  | 675 | // Do not let WordPress sanitize the excerpt |
  |  | 676 | // WordPress sanitizes the excerpt because it's expected to be typed by a user and sent in a POST |
  |  | 677 | // request. However, our excerpt is being inserted as a raw string with custom sanitization. |
  |  | 678 | remove\_all\_filters( 'excerpt\_save\_pre' ); |
  |  | 679 |  |
  |  | 680 | $title = trim(html\_entity\_decode($item->get\_title())); |
  |  | 681 | $title = empty($title) ? $item->get\_id() : $title; |
  |  | 682 |  |
  |  | 683 | // Prepare the item data |
  |  | 684 | $feed\_item = apply\_filters( |
  |  | 685 | 'wprss\_populate\_post\_data', |
  |  | 686 | array( |
  |  | 687 | 'post\_title'     => $title, |
  |  | 688 | 'post\_content'   => $item->get\_content(), |
  |  | 689 | 'post\_excerpt'   => wprss\_sanitize\_excerpt($item->get\_description()), |
  |  | 690 | 'post\_status'    => $post\_status, |
  |  | 691 | 'post\_type'      => 'wprss\_feed\_item', |
  |  | 692 | 'post\_date'      => $date, |
  |  | 693 | 'post\_date\_gmt'  => $date\_gmt |
  |  | 694 | ), |
  |  | 695 | $item |
  |  | 696 | ); |
  |  | 697 |  |
  |  | 698 | if ( defined('ICL\_SITEPRESS\_VERSION') ) |
  |  | 699 | @include\_once( WP\_PLUGIN\_DIR . '/sitepress-multilingual-cms/inc/wpml-api.php' ); |
  |  | 700 | if ( defined('ICL\_LANGUAGE\_CODE') ) { |
  |  | 701 | $\_POST['icl\_post\_language'] = $language\_code = ICL\_LANGUAGE\_CODE; |
  |  | 702 | } |
  |  | 703 |  |
  |  | 704 | // Create and insert post object into the DB |
  |  | 705 | $inserted\_ID = wp\_insert\_post( $feed\_item ); |
  |  | 706 |  |
  |  | 707 | if ( !is\_wp\_error( $inserted\_ID ) ) { |
  |  | 708 |  |
  |  | 709 | if ( is\_object( $inserted\_ID ) ) { |
  |  | 710 | if ( isset( $inserted\_ID['ID'] ) ) { |
  |  | 711 | $inserted\_ID = $inserted\_ID['ID']; |
  | 662 | 712 | } |
  | 663 |  | } else { |
  | 664 |  | // Item has no date ... |
  | 665 |  | $logger->debug('Item "{0}" has no date. Using current time', [$item->get\_title()]); |
  | 666 |  | $timestamp = time(); |
  |  | 713 | elseif ( isset( $inserted\_ID->ID ) ) { |
  |  | 714 | $inserted\_ID = $inserted\_ID->ID; |
  |  | 715 | } |
  | 667 | 716 | } |
  | 668 | 717 |  |
  | 669 |  | $date     = date( $format, $timestamp ); |
  | 670 |  | $date\_gmt = gmdate( $format, $item->get\_gmdate( 'U' ) ); |
  | 671 |  |  |
  | 672 |  | $logger->debug('Date for "{0}" will be {1}', [$item->get\_title(), $date]); |
  | 673 |  |  |
  | 674 |  | // Do not let WordPress sanitize the excerpt |
  | 675 |  | // WordPress sanitizes the excerpt because it's expected to be typed by a user and sent in a POST |
  | 676 |  | // request. However, our excerpt is being inserted as a raw string with custom sanitization. |
  | 677 |  | remove\_all\_filters( 'excerpt\_save\_pre' ); |
  | 678 |  |  |
  | 679 |  | $title = trim(html\_entity\_decode($item->get\_title())); |
  | 680 |  | $title = empty($title) ? $item->get\_id() : $title; |
  | 681 |  |  |
  | 682 |  | // Prepare the item data |
  | 683 |  | $feed\_item = apply\_filters( |
  | 684 |  | 'wprss\_populate\_post\_data', |
  | 685 |  | array( |
  | 686 |  | 'post\_title'     => $title, |
  | 687 |  | 'post\_content'   => $item->get\_content(), |
  | 688 |  | 'post\_excerpt'   => wprss\_sanitize\_excerpt($item->get\_description()), |
  | 689 |  | 'post\_status'    => $post\_status, |
  | 690 |  | 'post\_type'      => 'wprss\_feed\_item', |
  | 691 |  | 'post\_date'      => $date, |
  | 692 |  | 'post\_date\_gmt'  => $date\_gmt |
  | 693 |  | ), |
  | 694 |  | $item |
  | 695 |  | ); |
  | 696 |  |  |
  | 697 |  | if ( defined('ICL\_SITEPRESS\_VERSION') ) |
  | 698 |  | @include\_once( WP\_PLUGIN\_DIR . '/sitepress-multilingual-cms/inc/wpml-api.php' ); |
  | 699 |  | if ( defined('ICL\_LANGUAGE\_CODE') ) { |
  | 700 |  | $\_POST['icl\_post\_language'] = $language\_code = ICL\_LANGUAGE\_CODE; |
  | 701 |  | } |
  | 702 |  |  |
  | 703 |  | // Create and insert post object into the DB |
  | 704 |  | $inserted\_ID = wp\_insert\_post( $feed\_item ); |
  | 705 |  |  |
  | 706 |  | if ( !is\_wp\_error( $inserted\_ID ) ) { |
  | 707 |  |  |
  | 708 |  | if ( is\_object( $inserted\_ID ) ) { |
  | 709 |  | if ( isset( $inserted\_ID['ID'] ) ) { |
  | 710 |  | $inserted\_ID = $inserted\_ID['ID']; |
  | 711 |  | } |
  | 712 |  | elseif ( isset( $inserted\_ID->ID ) ) { |
  | 713 |  | $inserted\_ID = $inserted\_ID->ID; |
  | 714 |  | } |
  | 715 |  | } |
  | 716 |  |  |
  | 717 |  | $logger->debug('Item "{0}" was inserted into DB, ID: {1}', [ |
  | 718 |  | $ogItem->get\_title(), |
  | 719 |  | $inserted\_ID, |
  | 720 |  | ]); |
  | 721 |  |  |
  | 722 |  | // Create and insert post meta into the DB |
  | 723 |  | wprss\_items\_insert\_post\_meta( $inserted\_ID, $item, $feed\_ID, $permalink ); |
  | 724 |  |  |
  | 725 |  | $logger->debug('Inserted meta data for item #{0}', [ |
  | 726 |  | $inserted\_ID, |
  | 727 |  | ]); |
  | 728 |  |  |
  | 729 |  | // Remember newly added permalink |
  | 730 |  | $existing\_permalinks[$permalink] = 1; |
  | 731 |  |  |
  | 732 |  | // Increment the inserted items counter |
  | 733 |  | $items\_inserted++; |
  | 734 |  |  |
  | 735 |  | $logger->notice('Finished import for item {0}, ID {1}', [ |
  | 736 |  | $ogItem->get\_title(), |
  | 737 |  | $inserted\_ID, |
  | 738 |  | ]); |
  | 739 |  | } |
  | 740 |  | else { |
  | 741 |  | update\_post\_meta( $feed\_ID, 'wprss\_error\_last\_import', 'An error occurred while inserting a feed item into the database.' ); |
  | 742 |  |  |
  | 743 |  | $logger->error('Failed to save item "{0}" into the database', [$item->get\_title()]); |
  | 744 |  | } |
  | 745 |  | } |
  | 746 |  | // If the item is TRUE, then a hook function in the filter inserted the item. |
  | 747 |  | // increment the inserted counter |
  | 748 |  | elseif ( ( is\_bool($item) && $item === TRUE ) || ( $still\_update\_count === TRUE && $item !== FALSE ) ) { |
  | 749 |  | $logger->debug('Item "{0}" was imported by an add-on or filter', [ |
  |  | 718 | $logger->debug('Item "{0}" was inserted into DB, ID: {1}', [ |
  | 750 | 719 | $ogItem->get\_title(), |
  |  | 720 | $inserted\_ID, |
  | 751 | 721 | ]); |
  |  | 722 |  |
  |  | 723 | // Create and insert post meta into the DB |
  |  | 724 | wprss\_items\_insert\_post\_meta( $inserted\_ID, $item, $feed\_ID, $permalink ); |
  |  | 725 |  |
  |  | 726 | $logger->debug('Inserted meta data for item #{0}', [ |
  |  | 727 | $inserted\_ID, |
  |  | 728 | ]); |
  |  | 729 |  |
  |  | 730 | // Increment the inserted items counter |
  | 752 | 731 | $items\_inserted++; |
  | 753 |  | } elseif (has\_filter('wprss\_insert\_post\_item\_conditionals', 'wprss\_kf\_check\_post\_item\_keywords')) { |
  | 754 |  | $logger->info('Item "{0}" was rejected by your keyword or tag filtering.', [ |
  | 755 |  | $ogItem->get\_title() |
  |  | 732 |  |
  |  | 733 | $logger->notice('Finished import for item {0}, ID {1}', [ |
  |  | 734 | $ogItem->get\_title(), |
  |  | 735 | $inserted\_ID, |
  | 756 | 736 | ]); |
  | 757 |  | } else { |
  | 758 |  | $logger->notice('Item "{0}" was rejected by an add-on or filter.', [ |
  | 759 |  | $ogItem->get\_title() |
  | 760 |  | ]); |
  | 761 |  | } |
  |  | 737 | } |
  |  | 738 | else { |
  |  | 739 | update\_post\_meta( $feed\_ID, 'wprss\_error\_last\_import', 'An error occurred while inserting a feed item into the database.' ); |
  |  | 740 |  |
  |  | 741 | $logger->error('Failed to save item "{0}" into the database', [$item->get\_title()]); |
  |  | 742 | } |
  |  | 743 | } |
  |  | 744 | // If the item is TRUE, then a hook function in the filter inserted the item. |
  |  | 745 | // increment the inserted counter |
  |  | 746 | elseif ( ( is\_bool($item) && $item === TRUE ) || ( $still\_update\_count === TRUE && $item !== FALSE ) ) { |
  |  | 747 | $logger->debug('Item "{0}" was imported by an add-on or filter', [ |
  |  | 748 | $ogItem->get\_title(), |
  |  | 749 | ]); |
  |  | 750 | $items\_inserted++; |
  |  | 751 | } elseif (has\_filter('wprss\_insert\_post\_item\_conditionals', 'wprss\_kf\_check\_post\_item\_keywords')) { |
  |  | 752 | $logger->info('Item "{0}" was rejected by your keyword or tag filtering.', [ |
  |  | 753 | $ogItem->get\_title() |
  |  | 754 | ]); |
  |  | 755 | } else { |
  |  | 756 | $logger->notice('Item "{0}" was rejected by an add-on or filter.', [ |
  |  | 757 | $ogItem->get\_title() |
  |  | 758 | ]); |
  | 762 | 759 | } |
  | 763 | 760 | } |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2621306#L778) | […](/browser/wp-rss-aggregator/trunk/includes/feed-importing.php?rev=2659298#L775) |  |
  | 778 | 775 | \*/ |
  | 779 | 776 | function wprss\_items\_insert\_post\_meta( $inserted\_ID, $item, $feed\_ID, $permalink ) { |
  | 780 |  | update\_post\_meta( $inserted\_ID, 'wprss\_item\_date', $item->get\_date(DATE\_ISO8601) ); |
  | 781 |  | update\_post\_meta( $inserted\_ID, 'wprss\_item\_permalink', $permalink ); |
  |  | 777 | update\_post\_meta($inserted\_ID, 'wprss\_item\_guid', $item->get\_id()); |
  |  | 778 | update\_post\_meta($inserted\_ID, 'wprss\_item\_permalink', $permalink ); |
  |  | 779 | update\_post\_meta($inserted\_ID, 'wprss\_item\_date', $item->get\_date(DATE\_ISO8601)); |
  | 782 | 780 |  |
  | 783 | 781 | $enclosure = $item->get\_enclosure(0); |
* ## [wp-rss-aggregator/trunk/includes/feed-processing.php](/changeset/2659298/wp-rss-aggregator/trunk/includes/feed-processing.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/includes/feed-processing.php")

  | [r2621306](/browser/wp-rss-aggregator/trunk/includes/feed-processing.php?rev=2621306#L1 "Show revision 2621306 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/includes/feed-processing.php?rev=2659298#L1 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 |  | define( 'WPRSS\_TRANSIENT\_NAME\_IS\_REIMPORTING', 'is\_reimporting' ); |
  | 4 |  |  |
  | 5 |  | /\*\* |
  | 6 |  | \* Feed processing related functions |
  | 7 |  | \* |
  | 8 |  | \* @package WPRSSAggregator |
  | 9 |  | \*/ |
  | 10 |  |  |
  | 11 |  | /\*\* |
  | 12 |  | \* Returns whether or not the feed source will forcefully fetch the next fetch, |
  | 13 |  | \* ignoring whether or not it is paused or not. |
  | 14 |  | \* |
  | 15 |  | \* @param $source\_id    The ID of the feed soruce |
  | 16 |  | \* @return boolean |
  | 17 |  | \* @since 3.7 |
  | 18 |  | \*/ |
  | 19 |  | function wprss\_feed\_source\_force\_next\_fetch( $source\_id ) { |
  | 20 |  | $force = get\_post\_meta( $source\_id, 'wprss\_force\_next\_fetch', TRUE ); |
  | 21 |  | return ( $force !== '' || $force == '1' ); |
  | 22 |  | } |
  | 23 |  |  |
  | 24 |  |  |
  | 25 |  | /\*\* |
  | 26 |  | \* Change the default feed cache recreation period to 2 hours |
  | 27 |  | \* |
  | 28 |  | \* Probably not needed since we are now disabling caching altogether |
  | 29 |  | \* |
  | 30 |  | \* @since 2.1 |
  | 31 |  | \*/ |
  | 32 |  | function wprss\_feed\_cache\_lifetime( $seconds ) { |
  | 33 |  | return 1; // one second |
  | 34 |  | } |
  | 35 |  |  |
  | 36 |  |  |
  | 37 |  | /\*\* |
  | 38 |  | \* Disable caching of feeds in transients, we don't need it as we are storing them in the wp\_posts table |
  | 39 |  | \* |
  | 40 |  | \* @since 3.0 |
  | 41 |  | \*/ |
  | 42 |  | function wprss\_do\_not\_cache\_feeds( &$feed ) { |
  | 43 |  | $feed->enable\_cache( false ); |
  | 44 |  | } |
  | 45 |  |  |
  | 46 |  |  |
  | 47 |  | /\*\* |
  | 48 |  | \* Parameters for query to get all feed sources |
  | 49 |  | \* |
  | 50 |  | \* @since 3.0 |
  | 51 |  | \*/ |
  | 52 |  | function wprss\_get\_all\_feed\_sources() { |
  | 53 |  | // Get all feed sources |
  | 54 |  | $feed\_sources = new WP\_Query( apply\_filters( |
  | 55 |  | 'wprss\_get\_all\_feed\_sources', |
  | 56 |  | array( |
  | 57 |  | 'post\_type'      => 'wprss\_feed', |
  | 58 |  | 'post\_status'    => 'publish', |
  | 59 |  | 'cache\_results'  => false,   // Disable caching, used for one-off queries |
  | 60 |  | 'no\_found\_rows'  => true,    // We don't need pagination, so disable it |
  | 61 |  | 'posts\_per\_page' => -1 |
  | 62 |  | ) |
  | 63 |  | ) ); |
  | 64 |  | return $feed\_sources; |
  | 65 |  | } |
  | 66 |  |  |
  | 67 |  |  |
  | 68 |  | /\*\* |
  | 69 |  | \* Retrieves the query to use for retrieving imported items. |
  | 70 |  | \* |
  | 71 |  | \* @since 4.17.4 |
  | 72 |  | \*/ |
  | 73 |  | function wprss\_get\_imported\_items\_query($source\_id = null) { |
  | 74 |  | $args = [ |
  | 75 |  | 'post\_type'             => array\_values(get\_post\_types()), |
  | 76 |  | 'post\_status'           => 'any', |
  | 77 |  | 'cache\_results'         => false, |
  | 78 |  | 'no\_found\_rows'         => true, |
  | 79 |  | 'posts\_per\_page'        => -1, |
  | 80 |  | 'ignore\_sticky\_posts'   => 'true', |
  | 81 |  | 'orderby'               => 'date', |
  | 82 |  | 'order'                 => 'DESC', |
  | 83 |  | 'meta\_query'            => [ |
  | 84 |  | 'relation' => 'AND', |
  | 85 |  | ], |
  | 86 |  | 'suppress\_filters'  => 1 |
  |  | 3 | define('WPRSS\_TRANSIENT\_NAME\_IS\_REIMPORTING', 'is\_reimporting'); |
  |  | 4 |  |
  |  | 5 | /\*\* |
  |  | 6 | \* Returns whether or not the feed source will forcefully fetch the next fetch, |
  |  | 7 | \* ignoring whether or not it is paused or not. |
  |  | 8 | \* |
  |  | 9 | \* @since 3.7 |
  |  | 10 | \* |
  |  | 11 | \* @param int $source\_id The ID of the feed source |
  |  | 12 | \* |
  |  | 13 | \* @return boolean |
  |  | 14 | \*/ |
  |  | 15 | function wprss\_feed\_source\_force\_next\_fetch($source\_id) |
  |  | 16 | { |
  |  | 17 | $force = get\_post\_meta($source\_id, 'wprss\_force\_next\_fetch', true); |
  |  | 18 |  |
  |  | 19 | return ($force !== ''); |
  |  | 20 | } |
  |  | 21 |  |
  |  | 22 | /\*\* |
  |  | 23 | \* Change the default feed cache recreation period to 2 hours |
  |  | 24 | \* |
  |  | 25 | \* Probably not needed since we are now disabling caching altogether |
  |  | 26 | \* |
  |  | 27 | \* @since 2.1 |
  |  | 28 | \*/ |
  |  | 29 | function wprss\_feed\_cache\_lifetime($seconds) |
  |  | 30 | { |
  |  | 31 | return 1; // one second |
  |  | 32 | } |
  |  | 33 |  |
  |  | 34 | /\*\* |
  |  | 35 | \* Disable caching of feeds in transients, we don't need it as we are storing them in the wp\_posts table |
  |  | 36 | \* |
  |  | 37 | \* @since 3.0 |
  |  | 38 | \*/ |
  |  | 39 | function wprss\_do\_not\_cache\_feeds(&$feed) |
  |  | 40 | { |
  |  | 41 | $feed->enable\_cache(false); |
  |  | 42 | } |
  |  | 43 |  |
  |  | 44 | /\*\* |
  |  | 45 | \* Parameters for query to get all feed sources |
  |  | 46 | \* |
  |  | 47 | \* @since 3.0 |
  |  | 48 | \*/ |
  |  | 49 | function wprss\_get\_all\_feed\_sources() |
  |  | 50 | { |
  |  | 51 | $queryArgs = apply\_filters( |
  |  | 52 | 'wprss\_get\_all\_feed\_sources', |
  |  | 53 | [ |
  |  | 54 | 'post\_type' => 'wprss\_feed', |
  |  | 55 | 'post\_status' => 'publish', |
  |  | 56 | 'cache\_results' => false,   // Disable caching, used for one-off queries |
  |  | 57 | 'no\_found\_rows' => true,    // We don't need pagination, so disable it |
  |  | 58 | 'posts\_per\_page' => -1, |
  |  | 59 | ] |
  |  | 60 | ); |
  |  | 61 |  |
  |  | 62 | return new WP\_Query($queryArgs); |
  |  | 63 | } |
  |  | 64 |  |
  |  | 65 | /\*\* |
  |  | 66 | \* Retrieves the query to use for retrieving imported items. |
  |  | 67 | \* |
  |  | 68 | \* @since 4.17.4 |
  |  | 69 | \*/ |
  |  | 70 | function wprss\_get\_imported\_items\_query($source\_id = null) |
  |  | 71 | { |
  |  | 72 | $args = [ |
  |  | 73 | 'post\_type' => array\_values(get\_post\_types()), |
  |  | 74 | 'post\_status' => 'any', |
  |  | 75 | 'cache\_results' => false, |
  |  | 76 | 'no\_found\_rows' => true, |
  |  | 77 | 'posts\_per\_page' => -1, |
  |  | 78 | 'ignore\_sticky\_posts' => 'true', |
  |  | 79 | 'orderby' => 'date', |
  |  | 80 | 'order' => 'DESC', |
  |  | 81 | 'meta\_query' => [ |
  |  | 82 | 'relation' => 'AND', |
  |  | 83 | ], |
  |  | 84 | 'suppress\_filters' => 1, |
  |  | 85 | ]; |
  |  | 86 |  |
  |  | 87 | if ($source\_id !== null) { |
  |  | 88 | $args['meta\_query'][] = [ |
  |  | 89 | 'key' => 'wprss\_feed\_id', |
  |  | 90 | 'value' => (string) $source\_id, |
  |  | 91 | 'compare' => '=', |
  | 87 | 92 | ]; |
  | 88 |  |  |
  | 89 |  | if ($source\_id !== null) { |
  | 90 |  | $args['meta\_query'][] = [ |
  | 91 |  | 'key'       => 'wprss\_feed\_id', |
  | 92 |  | 'value'     => (string) $source\_id, |
  | 93 |  | 'compare'   => '=', |
  | 94 |  | ]; |
  | 95 |  | } else { |
  | 96 |  | $args['meta\_query'][] = [ |
  | 97 |  | 'key'       => 'wprss\_feed\_id', |
  | 98 |  | 'compare'   => 'EXISTS', |
  | 99 |  | ]; |
  |  | 93 | } else { |
  |  | 94 | $args['meta\_query'][] = [ |
  |  | 95 | 'key' => 'wprss\_feed\_id', |
  |  | 96 | 'compare' => 'EXISTS', |
  |  | 97 | ]; |
  |  | 98 | } |
  |  | 99 |  |
  |  | 100 | return apply\_filters('wprss\_get\_feed\_items\_for\_source\_args', $args, $source\_id); |
  |  | 101 | } |
  |  | 102 |  |
  |  | 103 | /\*\* |
  |  | 104 | \* Queries for imported items. |
  |  | 105 | \* |
  |  | 106 | \* @since 4.17.4 |
  |  | 107 | \*/ |
  |  | 108 | function wprss\_get\_imported\_items($source\_id = null) |
  |  | 109 | { |
  |  | 110 | return new WP\_Query(wprss\_get\_imported\_items\_query($source\_id)); |
  |  | 111 | } |
  |  | 112 |  |
  |  | 113 | /\*\* |
  |  | 114 | \* Returns all the feed items of a source. |
  |  | 115 | \* |
  |  | 116 | \* @since 3.8 |
  |  | 117 | \*/ |
  |  | 118 | function wprss\_get\_feed\_items\_for\_source($source\_id) |
  |  | 119 | { |
  |  | 120 | return wprss\_get\_imported\_items($source\_id); |
  |  | 121 | } |
  |  | 122 |  |
  |  | 123 | /\*\* |
  |  | 124 | \* Queries the DB to get the GUIDs for existing feed items. |
  |  | 125 | \* |
  |  | 126 | \* @param int|string $feedId The ID of the feed source. |
  |  | 127 | \*/ |
  |  | 128 | function wprss\_get\_existing\_guids($feedId) { |
  |  | 129 | global $wpdb; |
  |  | 130 |  |
  |  | 131 | $cols = $wpdb->get\_col( |
  |  | 132 | "SELECT q.`meta\_value` |
  |  | 133 | FROM {$wpdb->postmeta} AS p |
  |  | 134 | JOIN {$wpdb->postmeta} AS q |
  |  | 135 | ON (q.`meta\_key` = 'wprss\_item\_guid' AND p.`post\_id` = q.`post\_id`) |
  |  | 136 | WHERE p.`meta\_key` = 'wprss\_feed\_id' AND p.`meta\_value` = '{$feedId}'" |
  |  | 137 | ); |
  |  | 138 |  |
  |  | 139 | return @array\_flip($cols); |
  |  | 140 | } |
  |  | 141 |  |
  |  | 142 | /\*\* |
  |  | 143 | \* Database query to get existing permalinks |
  |  | 144 | \* |
  |  | 145 | \* @since 3.0 |
  |  | 146 | \*/ |
  |  | 147 | function wprss\_get\_existing\_permalinks($feed\_ID) |
  |  | 148 | { |
  |  | 149 | global $wpdb; |
  |  | 150 |  |
  |  | 151 | $cols = $wpdb->get\_col( |
  |  | 152 | "SELECT q.`meta\_value` |
  |  | 153 | FROM {$wpdb->postmeta} AS p |
  |  | 154 | JOIN {$wpdb->postmeta} AS q |
  |  | 155 | ON (q.`meta\_key` = 'wprss\_item\_permalink' AND p.`post\_id` = q.`post\_id`) |
  |  | 156 | WHERE p.`meta\_key` = 'wprss\_feed\_id' AND p.`meta\_value` = '{$feed\_ID}'" |
  |  | 157 | ); |
  |  | 158 |  |
  |  | 159 | return @array\_flip($cols); |
  |  | 160 | } |
  |  | 161 |  |
  |  | 162 | /\*\* |
  |  | 163 | \* Checks if an item title exists in the database. |
  |  | 164 | \* |
  |  | 165 | \* @since 4.14 |
  |  | 166 | \* |
  |  | 167 | \* @param string $title The title to search for. |
  |  | 168 | \* |
  |  | 169 | \* @return bool True if the title exists, false if not. |
  |  | 170 | \*/ |
  |  | 171 | function wprss\_item\_title\_exists($title) |
  |  | 172 | { |
  |  | 173 | global $wpdb; |
  |  | 174 |  |
  |  | 175 | $query = $wpdb->prepare( |
  |  | 176 | "SELECT \* |
  |  | 177 | FROM `{$wpdb->posts}` AS p |
  |  | 178 | JOIN `{$wpdb->postmeta}` AS q |
  |  | 179 | ON p.`ID` = q.`post\_id` |
  |  | 180 | WHERE q.`meta\_key` = 'wprss\_feed\_id' AND p.`post\_title` = %s", |
  |  | 181 | [html\_entity\_decode($title)] |
  |  | 182 | ); |
  |  | 183 |  |
  |  | 184 | $cols = $wpdb->get\_col($query); |
  |  | 185 |  |
  |  | 186 | return count($cols) > 0; |
  |  | 187 | } |
  |  | 188 |  |
  |  | 189 | /\*\* |
  |  | 190 | \* Database query to get existing titles |
  |  | 191 | \* |
  |  | 192 | \* @since 4.7 |
  |  | 193 | \*/ |
  |  | 194 | function wprss\_get\_existing\_titles($feed\_ID = null) |
  |  | 195 | { |
  |  | 196 | global $wpdb; |
  |  | 197 |  |
  |  | 198 | $condition = ($feed\_ID !== null) |
  |  | 199 | ? "AND q.`meta\_value` = '{$feed\_ID}'" |
  |  | 200 | : ''; |
  |  | 201 |  |
  |  | 202 | $cols = $wpdb->get\_col( |
  |  | 203 | "SELECT p.`post\_title` |
  |  | 204 | FROM `{$wpdb->posts}` AS p |
  |  | 205 | JOIN `{$wpdb->postmeta}` AS q |
  |  | 206 | ON p.`ID` = q.`post\_id` |
  |  | 207 | WHERE q.`meta\_key` = 'wprss\_feed\_id' $condition" |
  |  | 208 | ); |
  |  | 209 |  |
  |  | 210 | return @array\_flip($cols); |
  |  | 211 | } |
  |  | 212 |  |
  |  | 213 | /\*\* |
  |  | 214 | \* Checks if a permalink exists. |
  |  | 215 | \* |
  |  | 216 | \* Untested! |
  |  | 217 | \* |
  |  | 218 | \* @param string $permalink The permalink, expected to be normalized. |
  |  | 219 | \* |
  |  | 220 | \* @return   bool |
  |  | 221 | \*/ |
  |  | 222 | function wprss\_permalink\_exists($permalink) |
  |  | 223 | { |
  |  | 224 | global $wpdb; |
  |  | 225 |  |
  |  | 226 | $wpdb->query( |
  |  | 227 | $wpdb->prepare( |
  |  | 228 | "SELECT \* |
  |  | 229 | FROM {$wpdb->postmeta} |
  |  | 230 | WHERE `meta\_value` = '{$permalink}'" |
  |  | 231 | ) |
  |  | 232 | ); |
  |  | 233 |  |
  |  | 234 | return $wpdb->num\_rows > 0; |
  |  | 235 | } |
  |  | 236 |  |
  |  | 237 | add\_action('publish\_wprss\_feed', 'wprss\_fetch\_insert\_feed\_items', 10); |
  |  | 238 | /\*\* |
  |  | 239 | \* Fetches feed items from source provided and inserts into db |
  |  | 240 | \* |
  |  | 241 | \* This function is used when inserting or un-trashing a feed source, it only gets feeds from that particular source. |
  |  | 242 | \* |
  |  | 243 | \* @since 3.0 |
  |  | 244 | \*/ |
  |  | 245 | function wprss\_fetch\_insert\_feed\_items($post\_id) |
  |  | 246 | { |
  |  | 247 | wp\_schedule\_single\_event(time(), 'wprss\_fetch\_single\_feed\_hook', [$post\_id]); |
  |  | 248 | } |
  |  | 249 |  |
  |  | 250 | /\*\* |
  |  | 251 | \* Returns the image of the feed. |
  |  | 252 | \* The reason this function exists is for add-ons to be able to detect if the plugin core |
  |  | 253 | \* supports feed image functionality through a simple function\_exists() call. |
  |  | 254 | \* |
  |  | 255 | \* @since 1.0 |
  |  | 256 | \* |
  |  | 257 | \* @param int $source\_id The ID of the feed source |
  |  | 258 | \* |
  |  | 259 | \* @return string The link to the feed image |
  |  | 260 | \*/ |
  |  | 261 | function wprss\_get\_feed\_image($source\_id) |
  |  | 262 | { |
  |  | 263 | return get\_post\_meta($source\_id, 'wprss\_feed\_image', true); |
  |  | 264 | } |
  |  | 265 |  |
  |  | 266 | add\_action('post\_updated', 'wprss\_updated\_feed\_source', 10, 3); |
  |  | 267 | /\*\* |
  |  | 268 | \* This function is triggered just after a post is updated. |
  |  | 269 | \* It checks if the updated post is a feed source, and carries out any |
  |  | 270 | \* updating necessary. |
  |  | 271 | \* |
  |  | 272 | \* @since 3.3 |
  |  | 273 | \*/ |
  |  | 274 | function wprss\_updated\_feed\_source($post\_ID, $post\_after, $post\_before) |
  |  | 275 | { |
  |  | 276 | // Check if the post is a feed source and is published |
  |  | 277 |  |
  |  | 278 | if (($post\_after->post\_type == 'wprss\_feed') && ($post\_after->post\_status == 'publish')) { |
  |  | 279 | if (isset($\_POST['wprss\_url']) && !empty($\_POST['wprss\_url'])) { |
  |  | 280 | $url = $\_POST['wprss\_url']; |
  |  | 281 | $feed = wprss\_fetch\_feed($url); |
  |  | 282 | if ($feed !== null && !is\_wp\_error($feed)) { |
  |  | 283 | update\_post\_meta($post\_ID, 'wprss\_site\_url', $feed->get\_permalink()); |
  |  | 284 | update\_post\_meta($post\_ID, 'wprss\_feed\_image', $feed->get\_image\_url()); |
  |  | 285 | } |
  | 100 | 286 | } |
  | 101 | 287 |  |
  | 102 |  | return apply\_filters('wprss\_get\_feed\_items\_for\_source\_args', $args, $source\_id); |
  | 103 |  | } |
  | 104 |  |  |
  | 105 |  | /\*\* |
  | 106 |  | \* Queries for imported items. |
  | 107 |  | \* |
  | 108 |  | \* @since 4.17.4 |
  | 109 |  | \*/ |
  | 110 |  | function wprss\_get\_imported\_items($source\_id = null) { |
  | 111 |  | return new WP\_Query(wprss\_get\_imported\_items\_query($source\_id)); |
  | 112 |  | } |
  | 113 |  |  |
  | 114 |  | /\*\* |
  | 115 |  | \* Returns all the feed items of a source. |
  | 116 |  | \* |
  | 117 |  | \* @since 3.8 |
  | 118 |  | \*/ |
  | 119 |  | function wprss\_get\_feed\_items\_for\_source( $source\_id ) { |
  | 120 |  | return wprss\_get\_imported\_items($source\_id); |
  | 121 |  | } |
  | 122 |  |  |
  | 123 |  |  |
  | 124 |  | /\*\* |
  | 125 |  | \* Parameters for query to get feed sources |
  | 126 |  | \* |
  | 127 |  | \* @since 3.0 |
  | 128 |  | \*/ |
  | 129 |  | function wprss\_get\_feed\_source() { |
  | 130 |  | // Get all feed sources |
  | 131 |  | $feed\_sources = new WP\_Query( apply\_filters( |
  | 132 |  | 'wprss\_get\_all\_feed\_sources', |
  | 133 |  | array( |
  | 134 |  | 'post\_type'      => 'wprss\_feed', |
  | 135 |  | 'post\_status'    => 'publish', |
  | 136 |  | 'cache\_results'  => false,   // Disable caching, used for one-off queries |
  | 137 |  | 'no\_found\_rows'  => true,    // We don't need pagination, so disable it |
  | 138 |  | 'posts\_per\_page' => -1 |
  | 139 |  | ) |
  | 140 |  | ) ); |
  | 141 |  | return $feed\_sources; |
  | 142 |  | } |
  | 143 |  |  |
  | 144 |  |  |
  | 145 |  | /\*\* |
  | 146 |  | \* Database query to get existing permalinks |
  | 147 |  | \* |
  | 148 |  | \* @since 3.0 |
  | 149 |  | \*/ |
  | 150 |  | function wprss\_get\_existing\_permalinks( $feed\_ID ) { |
  | 151 |  | global $wpdb; |
  | 152 |  |  |
  | 153 |  | $cols = $wpdb->get\_col( |
  | 154 |  | "SELECT q.`meta\_value` |
  | 155 |  | FROM {$wpdb->postmeta} AS p |
  | 156 |  | JOIN {$wpdb->postmeta} AS q ON (q.`meta\_key` = 'wprss\_item\_permalink' AND p.`post\_id` = q.`post\_id`) |
  | 157 |  | WHERE p.`meta\_key` = 'wprss\_feed\_id' AND p.`meta\_value` = '{$feed\_ID}'" |
  | 158 |  | ); |
  | 159 |  |  |
  | 160 |  | return @array\_flip($cols); |
  | 161 |  | } |
  | 162 |  |  |
  | 163 |  | /\*\* |
  | 164 |  | \* Checks if an item title exists in the database. |
  | 165 |  | \* |
  | 166 |  | \* @since 4.14 |
  | 167 |  | \* |
  | 168 |  | \* @param string $title The title to search for. |
  | 169 |  | \* |
  | 170 |  | \* @return bool True if the title exists, false if not. |
  | 171 |  | \*/ |
  | 172 |  | function wprss\_item\_title\_exists( $title ) { |
  | 173 |  | global $wpdb; |
  | 174 |  |  |
  | 175 |  | $query = $wpdb->prepare( |
  | 176 |  | "SELECT \* |
  | 177 |  | FROM `{$wpdb->posts}` AS p |
  | 178 |  | JOIN `{$wpdb->postmeta}` AS q ON p.`ID` = q.`post\_id` |
  | 179 |  | WHERE q.`meta\_key` = 'wprss\_feed\_id' AND p.`post\_title` = %s", |
  | 180 |  | [html\_entity\_decode($title)] |
  | 181 |  | ); |
  | 182 |  |  |
  | 183 |  | $cols = $wpdb->get\_col($query); |
  | 184 |  |  |
  | 185 |  | return count($cols) > 0; |
  | 186 |  | } |
  | 187 |  |  |
  | 188 |  | /\*\* |
  | 189 |  | \* Database query to get existing titles |
  | 190 |  | \* |
  | 191 |  | \* @since 4.7 |
  | 192 |  | \*/ |
  | 193 |  | function wprss\_get\_existing\_titles( $feed\_ID = NULL ) { |
  | 194 |  | global $wpdb; |
  | 195 |  |  |
  | 196 |  | $condition = ($feed\_ID !== NULL) ? "AND q.`meta\_value` = '{$feed\_ID}'" : ''; |
  | 197 |  |  |
  | 198 |  | $cols = $wpdb->get\_col( |
  | 199 |  | "SELECT p.`post\_title` |
  | 200 |  | FROM `{$wpdb->posts}` AS p |
  | 201 |  | JOIN `{$wpdb->postmeta}` AS q ON p.`ID` = q.`post\_id` |
  | 202 |  | WHERE q.`meta\_key` = 'wprss\_feed\_id' $condition" |
  | 203 |  | ); |
  | 204 |  |  |
  | 205 |  | return @array\_flip($cols); |
  | 206 |  | } |
  | 207 |  |  |
  | 208 |  |  |
  | 209 |  | /\*\* |
  | 210 |  | \* Checks if a permalink exists. |
  | 211 |  | \* |
  | 212 |  | \* Untested! |
  | 213 |  | \* |
  | 214 |  | \* @param  string $permalink The permalink, expected to be normalized. |
  | 215 |  | \* @return   bool |
  | 216 |  | \*/ |
  | 217 |  | function wprss\_permalink\_exists( $permalink ) { |
  | 218 |  | global $wpdb; |
  | 219 |  |  |
  | 220 |  | $wpdb->query( |
  | 221 |  | $wpdb->prepare( |
  | 222 |  | "SELECT \* |
  | 223 |  | FROM {$wpdb->postmeta} |
  | 224 |  | WHERE `meta\_value` = '{$permalink}'" |
  | 225 |  | ) |
  | 226 |  | ); |
  | 227 |  |  |
  | 228 |  | return $wpdb->num\_rows > 0; |
  | 229 |  | } |
  | 230 |  |  |
  | 231 |  |  |
  | 232 |  | add\_action( 'publish\_wprss\_feed', 'wprss\_fetch\_insert\_feed\_items', 10 ); |
  | 233 |  | /\*\* |
  | 234 |  | \* Fetches feed items from source provided and inserts into db |
  | 235 |  | \* |
  | 236 |  | \* This function is used when inserting or untrashing a new feed source, it only gets feeds from that particular source |
  | 237 |  | \* |
  | 238 |  | \* @since 3.0 |
  | 239 |  | \*/ |
  | 240 |  | function wprss\_fetch\_insert\_feed\_items( $post\_id ) { |
  | 241 |  | wp\_schedule\_single\_event( time(), 'wprss\_fetch\_single\_feed\_hook', array( $post\_id ) ); |
  | 242 |  | } |
  | 243 |  |  |
  | 244 |  |  |
  | 245 |  | /\*\* |
  | 246 |  | \* Returns the image of the feed. |
  | 247 |  | \* The reason this function exists is for add-ons to be able to detect if the plugin core |
  | 248 |  | \* supports feed image functionality through a simple function\_exists() call. |
  | 249 |  | \* |
  | 250 |  | \* @param $source\_id The ID of the feed source |
  | 251 |  | \* @return string The link to the feed image |
  | 252 |  | \* @since 1.0 |
  | 253 |  | \*/ |
  | 254 |  | function wprss\_get\_feed\_image( $source\_id ) { |
  | 255 |  | return get\_post\_meta( $source\_id, 'wprss\_feed\_image', true ); |
  | 256 |  | } |
  | 257 |  |  |
  | 258 |  |  |
  | 259 |  | add\_action( 'post\_updated', 'wprss\_updated\_feed\_source', 10, 3 ); |
  | 260 |  | /\*\* |
  | 261 |  | \* This function is triggered just after a post is updated. |
  | 262 |  | \* It checks if the updated post is a feed source, and carries out any |
  | 263 |  | \* updating necassary. |
  | 264 |  | \* |
  | 265 |  | \* @since 3.3 |
  | 266 |  | \*/ |
  | 267 |  | function wprss\_updated\_feed\_source( $post\_ID, $post\_after, $post\_before ) { |
  | 268 |  | // Check if the post is a feed source and is published |
  | 269 |  |  |
  | 270 |  | if ( ( $post\_after->post\_type == 'wprss\_feed' ) && ( $post\_after->post\_status == 'publish' ) ) { |
  | 271 |  |  |
  | 272 |  | if ( isset( $\_POST['wprss\_url'] ) && !empty( $\_POST['wprss\_url'] ) ) { |
  | 273 |  | $url = $\_POST['wprss\_url']; |
  | 274 |  | $feed = wprss\_fetch\_feed( $url ); |
  | 275 |  | if ( $feed !== NULL && !is\_wp\_error( $feed ) ) { |
  | 276 |  | update\_post\_meta( $post\_ID, 'wprss\_site\_url', $feed->get\_permalink() ); |
  | 277 |  | update\_post\_meta( $post\_ID, 'wprss\_feed\_image', $feed->get\_image\_url() ); |
  | 278 |  | } |
  | 279 |  | } |
  | 280 |  |  |
  | 281 |  |  |
  | 282 |  | if ( isset( $\_POST['wprss\_limit'] ) && !empty( $\_POST['wprss\_limit'] ) ) { |
  | 283 |  | // Checking feed limit change |
  | 284 |  | // Get the limit currently saved in db, and limit in POST request |
  | 285 |  | //$limit = get\_post\_meta( $post\_ID, 'wprss\_limit', true ); |
  | 286 |  | $limit = $\_POST['wprss\_limit']; |
  | 287 |  | // Get all feed items for this source |
  | 288 |  | $feed\_sources = new WP\_Query( |
  | 289 |  | array( |
  | 290 |  | 'post\_type'      => 'wprss\_feed\_item', |
  | 291 |  | 'post\_status'    => 'publish', |
  | 292 |  | 'cache\_results'  => false,   // Disable caching, used for one-off queries |
  | 293 |  | 'no\_found\_rows'  => true,    // We don't need pagination, so disable it |
  | 294 |  | 'posts\_per\_page' => -1, |
  | 295 |  | 'orderby'        => 'date', |
  | 296 |  | 'order'          => 'ASC', |
  | 297 |  | 'meta\_query'     => array( |
  | 298 |  | array( |
  | 299 |  | 'key'     => 'wprss\_feed\_id', |
  | 300 |  | 'value'   => $post\_ID, |
  | 301 |  | 'compare' => 'LIKE' |
  | 302 |  | ) |
  | 303 |  | ) |
  | 304 |  | ) |
  | 305 |  | ); |
  | 306 |  | // If the limit is smaller than the number of found posts, delete the feed items |
  | 307 |  | // and re-import, to ensure that most recent feed items are present. |
  | 308 |  | $difference = intval( $feed\_sources->post\_count ) - intval( $limit ); |
  | 309 |  | if ( $difference > 0 ) { |
  | 310 |  | // Loop and delete the excess feed items |
  | 311 |  | while ( $feed\_sources->have\_posts() && $difference > 0 ) { |
  | 312 |  | $feed\_sources->the\_post(); |
  | 313 |  | wp\_delete\_post( get\_the\_ID(), true ); |
  | 314 |  | $difference--; |
  | 315 |  | } |
  | 316 |  | } |
  | 317 |  | } |
  | 318 |  | } |
  | 319 |  | } |
  | 320 |  |  |
  | 321 |  |  |
  | 322 |  | add\_action( 'added\_post\_meta', 'wprss\_update\_feed\_meta', 10, 4 ); |
  | 323 |  | add\_action( 'updated\_post\_meta', 'wprss\_update\_feed\_meta', 10, 4 ); |
  | 324 |  | /\*\* |
  | 325 |  | \* This function is run whenever a post is saved or updated. |
  | 326 |  | \* |
  | 327 |  | \* @since 3.4 |
  | 328 |  | \*/ |
  | 329 |  | function wprss\_update\_feed\_meta( $meta\_id, $post\_id, $meta\_key, $meta\_value ) { |
  | 330 |  | $post = get\_post( $post\_id ); |
  | 331 |  | if ( $post !== NULL && $post->post\_status === 'publish' && $post->post\_type === 'wprss\_feed' ) { |
  | 332 |  | if ( $meta\_key === 'wprss\_url' ) |
  | 333 |  | wprss\_change\_fb\_url( $post\_id, $meta\_value ); |
  | 334 |  | } |
  | 335 |  | } |
  | 336 |  |  |
  | 337 |  |  |
  | 338 |  | function wprss\_change\_fb\_url( $post\_id, $url ) { |
  | 339 |  | # Check if url begins with a known facebook hostname. |
  | 340 |  | if (    stripos( $url, 'http://facebook.com' ) === 0 |
  | 341 |  | ||  stripos( $url, 'http://www.facebook.com' ) === 0 |
  | 342 |  | ||  stripos( $url, 'https://facebook.com' ) === 0 |
  | 343 |  | ||  stripos( $url, 'https://www.facebook.com' ) === 0 |
  | 344 |  | ) { |
  | 345 |  | # Generate the new URL to FB Graph |
  | 346 |  | $com\_index = stripos( $url, '.com' ); |
  | 347 |  | $fb\_page = substr( $url, $com\_index + 4 ); # 4 = length of ".com" |
  | 348 |  | $fb\_graph\_url = 'https://graph.facebook.com' . $fb\_page; |
  | 349 |  | # Contact FB Graph and get data |
  | 350 |  | $response = wp\_remote\_get( $fb\_graph\_url ); |
  | 351 |  | # If the repsonse successful and has a body |
  | 352 |  | if ( !is\_wp\_error( $response ) && isset( $response['body'] ) ) { |
  | 353 |  | # Parse the body as a JSON string |
  | 354 |  | $json = json\_decode( $response['body'], true ); |
  | 355 |  | # If an id is present ... |
  | 356 |  | if ( isset( $json['id'] ) ) { |
  | 357 |  | # Generate the final URL for this feed and update the post meta |
  | 358 |  | $final\_url = "https://www.facebook.com/feeds/page.php?format=rss20&id=" . $json['id']; |
  | 359 |  | update\_post\_meta( $post\_id, 'wprss\_url', $final\_url, $url ); |
  |  | 288 | if (isset($\_POST['wprss\_limit']) && !empty($\_POST['wprss\_limit'])) { |
  |  | 289 | // Checking feed limit change |
  |  | 290 | // Get the limit currently saved in db, and limit in POST request |
  |  | 291 | //$limit = get\_post\_meta( $post\_ID, 'wprss\_limit', true ); |
  |  | 292 | $limit = $\_POST['wprss\_limit']; |
  |  | 293 | // Get all feed items for this source |
  |  | 294 | $feed\_sources = new WP\_Query( |
  |  | 295 | [ |
  |  | 296 | 'post\_type' => 'wprss\_feed\_item', |
  |  | 297 | 'post\_status' => 'publish', |
  |  | 298 | 'cache\_results' => false,   // Disable caching, used for one-off queries |
  |  | 299 | 'no\_found\_rows' => true,    // We don't need pagination, so disable it |
  |  | 300 | 'posts\_per\_page' => -1, |
  |  | 301 | 'orderby' => 'date', |
  |  | 302 | 'order' => 'ASC', |
  |  | 303 | 'meta\_query' => [ |
  |  | 304 | [ |
  |  | 305 | 'key' => 'wprss\_feed\_id', |
  |  | 306 | 'value' => $post\_ID, |
  |  | 307 | 'compare' => 'LIKE', |
  |  | 308 | ], |
  |  | 309 | ], |
  |  | 310 | ] |
  |  | 311 | ); |
  |  | 312 | // If the limit is smaller than the number of found posts, delete the feed items |
  |  | 313 | // and re-import, to ensure that most recent feed items are present. |
  |  | 314 | $difference = intval($feed\_sources->post\_count) - intval($limit); |
  |  | 315 | if ($difference > 0) { |
  |  | 316 | // Loop and delete the excess feed items |
  |  | 317 | while ($feed\_sources->have\_posts() && $difference > 0) { |
  |  | 318 | $feed\_sources->the\_post(); |
  |  | 319 | wp\_delete\_post(get\_the\_ID(), true); |
  |  | 320 | $difference--; |
  | 360 | 321 | } |
  | 361 | 322 | } |
  | 362 | 323 | } |
  | 363 | 324 | } |
  | 364 |  |  |
  | 365 |  |  |
  | 366 |  | add\_action( 'trash\_wprss\_feed', 'wprss\_delete\_feed\_items' );   // maybe use wp\_trash\_post action? wp\_trash\_wprss\_feed |
  | 367 |  | /\*\* |
  | 368 |  | \* Delete feed items on trashing of corresponding feed source |
  | 369 |  | \* |
  | 370 |  | \* @since 2.0 |
  | 371 |  | \*/ |
  | 372 |  | function wprss\_delete\_feed\_items ($source\_id) { |
  | 373 |  | $force\_delete = apply\_filters('wprss\_force\_delete\_when\_by\_source', true); |
  | 374 |  |  |
  | 375 |  | // WPML fix: removes the current language from the query WHERE and JOIN clauses |
  | 376 |  | global $sitepress; |
  | 377 |  | if ($sitepress !== null) { |
  | 378 |  | remove\_filter('posts\_join', [$sitepress,'posts\_join\_filter']); |
  | 379 |  | remove\_filter('posts\_where', [$sitepress,'posts\_where\_filter']); |
  |  | 325 | } |
  |  | 326 |  |
  |  | 327 | add\_action('added\_post\_meta', 'wprss\_update\_feed\_meta', 10, 4); |
  |  | 328 | add\_action('updated\_post\_meta', 'wprss\_update\_feed\_meta', 10, 4); |
  |  | 329 | /\*\* |
  |  | 330 | \* This function is run whenever a post is saved or updated. |
  |  | 331 | \* |
  |  | 332 | \* @since 3.4 |
  |  | 333 | \*/ |
  |  | 334 | function wprss\_update\_feed\_meta($meta\_id, $post\_id, $meta\_key, $meta\_value) |
  |  | 335 | { |
  |  | 336 | $post = get\_post($post\_id); |
  |  | 337 | if ($post !== null && $post->post\_status === 'publish' && $post->post\_type === 'wprss\_feed') { |
  |  | 338 | if ($meta\_key === 'wprss\_url') { |
  |  | 339 | wprss\_change\_fb\_url($post\_id, $meta\_value); |
  | 380 | 340 | } |
  | 381 |  |  |
  | 382 |  | $args = wprss\_get\_imported\_items\_query($source\_id); |
  | 383 |  | $items = get\_posts($args); |
  | 384 |  |  |
  | 385 |  | foreach ($items as $item) { |
  | 386 |  | wp\_delete\_post($item->ID, $force\_delete); |
  | 387 |  | } |
  | 388 |  | } |
  | 389 |  |  |
  | 390 |  |  |
  | 391 |  | add\_action( 'wprss\_delete\_all\_feed\_items\_hook', 'wprss\_delete\_all\_feed\_items' ); |
  | 392 |  | /\*\* |
  | 393 |  | \* Delete all feed items |
  | 394 |  | \* |
  | 395 |  | \* @since 3.0 |
  | 396 |  | \*/ |
  | 397 |  | function wprss\_delete\_all\_feed\_items() { |
  | 398 |  | $args = wprss\_get\_imported\_items\_query(); |
  | 399 |  | $items = get\_posts($args); |
  | 400 |  |  |
  | 401 |  | foreach ($items as $item) { |
  | 402 |  | wp\_delete\_post($item->ID, true); |
  | 403 |  | } |
  | 404 |  | } |
  | 405 |  |  |
  | 406 |  |  |
  | 407 |  | /\*\* |
  | 408 |  | \* Marks the feed source as 'updating' (importing). |
  | 409 |  | \* |
  | 410 |  | \* @since 4.6.6 |
  | 411 |  | \* @return int The time value set in the 'updating' meta field |
  | 412 |  | \*/ |
  | 413 |  | function wprss\_flag\_feed\_as\_updating( $feed\_ID ) { |
  | 414 |  | update\_post\_meta( $feed\_ID, 'wprss\_feed\_is\_updating', $start\_time = time() ); |
  | 415 |  | return $start\_time; |
  | 416 |  | } |
  | 417 |  |  |
  | 418 |  | /\*\* |
  | 419 |  | \* Marks the feed source as 'idle' (not importing). |
  | 420 |  | \* |
  | 421 |  | \* @since 4.6.6 |
  | 422 |  | \*/ |
  | 423 |  | function wprss\_flag\_feed\_as\_idle( $feed\_ID ) { |
  | 424 |  | update\_post\_meta( $feed\_ID, 'wprss\_feed\_is\_updating', '' ); |
  | 425 |  | } |
  | 426 |  |  |
  | 427 |  |  |
  | 428 |  | /\*\* |
  | 429 |  | \* Returns whether or not the feed source is updating. |
  | 430 |  | \* |
  | 431 |  | \* @param (string|int) The id of the feed source |
  | 432 |  | \* @return (bool) TRUE if the feed source is currently updating, FALSE otherwise. |
  | 433 |  | \* |
  | 434 |  | \*/ |
  | 435 |  | function wprss\_is\_feed\_source\_updating( $id ) { |
  | 436 |  | // Get the 'updating' meta field |
  | 437 |  | $is\_updating\_meta = get\_post\_meta( $id, 'wprss\_feed\_is\_updating', TRUE ); |
  | 438 |  |  |
  | 439 |  | // Check if the feed has the 'updating' meta field set |
  | 440 |  | if ( $is\_updating\_meta === '' ) { |
  | 441 |  | // If not, then the feed is not updating |
  | 442 |  | return FALSE; |
  | 443 |  | } |
  | 444 |  |  |
  | 445 |  | // Get the limit used for the feed |
  | 446 |  | $limit = get\_post\_meta( $id, 'wprss\_limit', true ); |
  | 447 |  | if ( $limit === '' || intval( $limit ) <= 0 ) { |
  | 448 |  | $global\_limit = wprss\_get\_general\_setting('limit\_feed\_items\_imported'); |
  | 449 |  | $limit = ( $global\_limit === '' || intval( $global\_limit ) <= 0 ) ? NULL : $global\_limit; |
  | 450 |  | } |
  | 451 |  |  |
  | 452 |  | // Calculate the allowed maximum time, based on the maximum number of items allowed to be |
  | 453 |  | // imported from this source. |
  | 454 |  | // If no limit is used, 60s (1min) is used. |
  | 455 |  | $single\_item\_time\_limit = wprss\_get\_feed\_fetch\_time\_limit(); |
  | 456 |  | $allowed\_time = $limit === NULL ? 120 : $single\_item\_time\_limit \* intval( $limit ); |
  | 457 |  |  |
  | 458 |  | // Calculate how many seconds have passed since the feed last signalled that it is updating |
  | 459 |  | $diff = time() - $is\_updating\_meta; |
  | 460 |  |  |
  | 461 |  | // Get the transient that is set when the import function is called and the time of the next scheduled cron |
  | 462 |  | $is\_updating\_transient = get\_transient('wpra/feeds/importing/' . $id); |
  | 463 |  | $scheduled = (wprss\_get\_next\_feed\_source\_update($id) !== false); |
  | 464 |  | // If more than 5 seconds have passed and the transient is not yet set and the cron was not scheduled |
  | 465 |  | // then the cron probably failed to be registered |
  | 466 |  | if ( $diff > 5  && !$is\_updating\_transient && !$scheduled) { |
  | 467 |  | wprss\_flag\_feed\_as\_idle($id); |
  | 468 |  | update\_post\_meta( |
  | 469 |  | $id, |
  | 470 |  | 'wprss\_error\_last\_import', |
  | 471 |  | \_\_('The plugin failed to schedule a fetch for this feed. Please try again.', 'wprss') |
  | 472 |  | ); |
  | 473 |  |  |
  | 474 |  | return false; |
  | 475 |  | } |
  | 476 |  |  |
  | 477 |  | // If the difference is greater than the allowed maximum amount of time, mark the feed as idle. |
  | 478 |  | if ( $diff > $allowed\_time ) { |
  | 479 |  | wprss\_flag\_feed\_as\_idle( $id ); |
  | 480 |  | // Feed is not updating |
  | 481 |  | return FALSE; |
  | 482 |  | } |
  | 483 |  |  |
  | 484 |  | // Feed is updating |
  | 485 |  | return TRUE; |
  | 486 |  | } |
  | 487 |  |  |
  | 488 |  |  |
  | 489 |  | /\*\* |
  | 490 |  | \* Returns whether or not the feed source is deleting its feeed items. |
  | 491 |  | \* |
  | 492 |  | \* @param (string|int) The id of the feed source |
  | 493 |  | \* @return (bool) TRUE if the feed source is currently deleting its items, FALSE otherwise. |
  | 494 |  | \* |
  | 495 |  | \*/ |
  | 496 |  | function wprss\_is\_feed\_source\_deleting( $id ) { |
  | 497 |  | $is\_deleting\_meta = get\_post\_meta( $id, 'wprss\_feed\_is\_deleting\_items', TRUE ); |
  | 498 |  |  |
  | 499 |  | if ( $is\_deleting\_meta === '' ) { |
  | 500 |  | return FALSE; |
  | 501 |  | } |
  | 502 |  |  |
  | 503 |  | $diff = time() - $is\_deleting\_meta; |
  | 504 |  |  |
  | 505 |  | $items = wprss\_get\_feed\_items\_for\_source( $id ); |
  | 506 |  | if ( $items->post\_count === 0 || $diff > 300 ) { |
  | 507 |  | delete\_post\_meta( $id, 'wprss\_feed\_is\_deleting\_items' ); |
  | 508 |  | return FALSE; |
  | 509 |  | } |
  | 510 |  |  |
  | 511 |  | return TRUE; |
  | 512 |  | } |
  | 513 |  |  |
  | 514 |  |  |
  | 515 |  | /\*\* |
  | 516 |  | \* Returns the given parameter as a string. Used in wprss\_truncate\_posts() |
  | 517 |  | \* |
  | 518 |  | \* @return string The given parameter as a string |
  | 519 |  | \* @since 3.5.1 |
  | 520 |  | \*/ |
  | 521 |  | function wprss\_return\_as\_string( $item ) { |
  | 522 |  | return "'$item'"; |
  | 523 |  | } |
  | 524 |  |  |
  | 525 |  |  |
  | 526 |  | /\*\* |
  | 527 |  | \* Returns true if the feed item is older than the given timestamp, |
  | 528 |  | \* false otherwise; |
  | 529 |  | \* |
  | 530 |  | \* @since 3.8 |
  | 531 |  | \*/ |
  | 532 |  | function wprss\_is\_feed\_item\_older\_than( $id, $timestamp ) { |
  | 533 |  | // GET THE DATE |
  | 534 |  | $age = get\_the\_time( 'U', $id ); |
  | 535 |  | if ( $age === '' ) return FALSE; |
  | 536 |  | // Calculate the age difference |
  | 537 |  | $difference = $age - $timestamp; |
  | 538 |  | // Return whether the difference is negative ( the age is smaller than the timestamp ) |
  | 539 |  | return ( $difference <= 0 ); |
  | 540 |  | } |
  | 541 |  |  |
  | 542 |  |  |
  | 543 |  | /\*\* |
  | 544 |  | \* Returns the maximum age setting for a feed source. |
  | 545 |  | \* |
  | 546 |  | \* @since 3.8 |
  | 547 |  | \*/ |
  | 548 |  | function wprss\_get\_max\_age\_for\_feed\_source( $source\_id ) { |
  | 549 |  | $general\_settings = get\_option( 'wprss\_settings\_general' ); |
  | 550 |  | // Get the meta data for age for this feed source |
  | 551 |  | $age\_limit = trim( get\_post\_meta( $source\_id, 'wprss\_age\_limit', TRUE ) ); |
  | 552 |  | $age\_unit = get\_post\_meta( $source\_id, 'wprss\_age\_unit', TRUE ); |
  | 553 |  |  |
  | 554 |  | // If the meta does not exist, use the global settings |
  | 555 |  | if( $age\_limit === '' ) { |
  | 556 |  | $age\_limit = trim( wprss\_get\_general\_setting( 'limit\_feed\_items\_age' ) ); |
  | 557 |  | $age\_unit = wprss\_get\_general\_setting( 'limit\_feed\_items\_age\_unit' ); |
  | 558 |  | } |
  | 559 |  |  |
  | 560 |  | // If the age limit is an empty string, use no limit |
  | 561 |  | if ( $age\_limit === '' ) { |
  | 562 |  | return FALSE; |
  | 563 |  | } |
  | 564 |  |  |
  | 565 |  | // Return the timestamp of the max age date |
  | 566 |  | return strtotime( "-$age\_limit $age\_unit" ); |
  | 567 |  | } |
  | 568 |  |  |
  | 569 |  | /\*\* |
  | 570 |  | \* Truncates the items for a single feed source based on its age limit. |
  | 571 |  | \* |
  | 572 |  | \* @since 4.14 |
  | 573 |  | \* |
  | 574 |  | \* @param int|WP\_Post $source The source ID or post instance. |
  | 575 |  | \*/ |
  | 576 |  | function wprss\_truncate\_items\_for\_source( $source ) |
  | 577 |  | { |
  | 578 |  | $id = ( $source instanceof WP\_Post ) |
  | 579 |  | ? $source->ID |
  | 580 |  | : $source; |
  | 581 |  |  |
  | 582 |  | $logger = wpra\_get\_logger($id); |
  | 583 |  |  |
  | 584 |  | // Get the max age setting for this feed source |
  | 585 |  | $max\_age = wprss\_get\_max\_age\_for\_feed\_source( $id ); |
  | 586 |  |  |
  | 587 |  | // If the data is empty, do not delete |
  | 588 |  | if ( $max\_age === false ) { |
  | 589 |  | return; |
  | 590 |  | } |
  | 591 |  |  |
  | 592 |  | // Get all feed items for this source |
  | 593 |  | $feed\_items = wprss\_get\_feed\_items\_for\_source( $id ); |
  | 594 |  |  |
  | 595 |  | // If there are no feed items, stop |
  | 596 |  | if ( ! $feed\_items->have\_posts() ) { |
  | 597 |  | return; |
  | 598 |  | } |
  | 599 |  |  |
  | 600 |  | // Extend the timeout time limit for the deletion of the feed items |
  | 601 |  | set\_time\_limit( wprss\_get\_item\_import\_time\_limit() ); |
  | 602 |  |  |
  | 603 |  | $logger->debug('Truncating existing items'); |
  | 604 |  |  |
  | 605 |  | // For each feed item |
  | 606 |  | while ( $feed\_items->have\_posts() ) { |
  | 607 |  | $feed\_items->the\_post(); |
  | 608 |  | // If the post is older than the maximum age |
  | 609 |  | $item\_id = get\_the\_ID(); |
  | 610 |  |  |
  | 611 |  | if ( wprss\_is\_feed\_item\_older\_than( $item\_id, $max\_age ) === true ){ |
  | 612 |  | // Delete the post |
  | 613 |  | wp\_delete\_post( $item\_id, true ); |
  |  | 341 | } |
  |  | 342 | } |
  |  | 343 |  |
  |  | 344 | function wprss\_change\_fb\_url($post\_id, $url) |
  |  | 345 | { |
  |  | 346 | # Check if url begins with a known facebook hostname. |
  |  | 347 | if (stripos($url, 'http://facebook.com') === 0 |
  |  | 348 | || stripos($url, 'http://www.facebook.com') === 0 |
  |  | 349 | || stripos($url, 'https://facebook.com') === 0 |
  |  | 350 | || stripos($url, 'https://www.facebook.com') === 0 |
  |  | 351 | ) { |
  |  | 352 | # Generate the new URL to FB Graph |
  |  | 353 | $com\_index = stripos($url, '.com'); |
  |  | 354 | $fb\_page = substr($url, $com\_index + 4); # 4 = length of ".com" |
  |  | 355 | $fb\_graph\_url = 'https://graph.facebook.com' . $fb\_page; |
  |  | 356 | # Contact FB Graph and get data |
  |  | 357 | $response = wp\_remote\_get($fb\_graph\_url); |
  |  | 358 | # If the response successful and has a body |
  |  | 359 | if (!is\_wp\_error($response) && isset($response['body'])) { |
  |  | 360 | # Parse the body as a JSON string |
  |  | 361 | $json = json\_decode($response['body'], true); |
  |  | 362 | # If an id is present ... |
  |  | 363 | if (isset($json['id'])) { |
  |  | 364 | # Generate the final URL for this feed and update the post meta |
  |  | 365 | $final\_url = "https://www.facebook.com/feeds/page.php?format=rss20&id=" . $json['id']; |
  |  | 366 | update\_post\_meta($post\_id, 'wprss\_url', $final\_url, $url); |
  | 614 | 367 | } |
  | 615 | 368 | } |
  | 616 |  |  |
  | 617 |  | // Reset feed items query data |
  |  | 369 | } |
  |  | 370 | } |
  |  | 371 |  |
  |  | 372 | add\_action('trash\_wprss\_feed', 'wprss\_delete\_feed\_items');   // maybe use wp\_trash\_post action? wp\_trash\_wprss\_feed |
  |  | 373 | /\*\* |
  |  | 374 | \* Delete feed items on trashing of corresponding feed source |
  |  | 375 | \* |
  |  | 376 | \* @since 2.0 |
  |  | 377 | \*/ |
  |  | 378 | function wprss\_delete\_feed\_items($source\_id) |
  |  | 379 | { |
  |  | 380 | $force\_delete = apply\_filters('wprss\_force\_delete\_when\_by\_source', true); |
  |  | 381 |  |
  |  | 382 | // WPML fix: removes the current language from the query WHERE and JOIN clauses |
  |  | 383 | global $sitepress; |
  |  | 384 | if ($sitepress !== null) { |
  |  | 385 | remove\_filter('posts\_join', [$sitepress, 'posts\_join\_filter']); |
  |  | 386 | remove\_filter('posts\_where', [$sitepress, 'posts\_where\_filter']); |
  |  | 387 | } |
  |  | 388 |  |
  |  | 389 | $args = wprss\_get\_imported\_items\_query($source\_id); |
  |  | 390 | $items = get\_posts($args); |
  |  | 391 |  |
  |  | 392 | foreach ($items as $item) { |
  |  | 393 | wp\_delete\_post($item->ID, $force\_delete); |
  |  | 394 | } |
  |  | 395 | } |
  |  | 396 |  |
  |  | 397 | add\_action('wprss\_delete\_all\_feed\_items\_hook', 'wprss\_delete\_all\_feed\_items'); |
  |  | 398 | /\*\* |
  |  | 399 | \* Delete all feed items |
  |  | 400 | \* |
  |  | 401 | \* @since 3.0 |
  |  | 402 | \*/ |
  |  | 403 | function wprss\_delete\_all\_feed\_items() |
  |  | 404 | { |
  |  | 405 | $args = wprss\_get\_imported\_items\_query(); |
  |  | 406 | $items = get\_posts($args); |
  |  | 407 |  |
  |  | 408 | foreach ($items as $item) { |
  |  | 409 | wp\_delete\_post($item->ID, true); |
  |  | 410 | } |
  |  | 411 | } |
  |  | 412 |  |
  |  | 413 | /\*\* |
  |  | 414 | \* Marks the feed source as 'updating' (importing). |
  |  | 415 | \* |
  |  | 416 | \* @since 4.6.6 |
  |  | 417 | \* @return int The time value set in the 'updating' meta field |
  |  | 418 | \*/ |
  |  | 419 | function wprss\_flag\_feed\_as\_updating($feed\_ID) |
  |  | 420 | { |
  |  | 421 | update\_post\_meta($feed\_ID, 'wprss\_feed\_is\_updating', $start\_time = time()); |
  |  | 422 | return $start\_time; |
  |  | 423 | } |
  |  | 424 |  |
  |  | 425 | /\*\* |
  |  | 426 | \* Marks the feed source as 'idle' (not importing). |
  |  | 427 | \* |
  |  | 428 | \* @since 4.6.6 |
  |  | 429 | \*/ |
  |  | 430 | function wprss\_flag\_feed\_as\_idle($feed\_ID) |
  |  | 431 | { |
  |  | 432 | update\_post\_meta($feed\_ID, 'wprss\_feed\_is\_updating', ''); |
  |  | 433 | } |
  |  | 434 |  |
  |  | 435 | /\*\* |
  |  | 436 | \* Returns whether the feed source is updating. |
  |  | 437 | \* |
  |  | 438 | \* @param string|int The id of the feed source |
  |  | 439 | \* |
  |  | 440 | \* @return bool TRUE if the feed source is currently updating, FALSE otherwise. |
  |  | 441 | \*/ |
  |  | 442 | function wprss\_is\_feed\_source\_updating($id) |
  |  | 443 | { |
  |  | 444 | // Get the 'updating' meta field |
  |  | 445 | $is\_updating\_meta = get\_post\_meta($id, 'wprss\_feed\_is\_updating', true); |
  |  | 446 |  |
  |  | 447 | // Check if the feed has the 'updating' meta field set |
  |  | 448 | if ($is\_updating\_meta === '') { |
  |  | 449 | // If not, then the feed is not updating |
  |  | 450 | return false; |
  |  | 451 | } |
  |  | 452 |  |
  |  | 453 | // Get the limit used for the feed |
  |  | 454 | $limit = get\_post\_meta($id, 'wprss\_limit', true); |
  |  | 455 | if ($limit === '' || intval($limit) <= 0) { |
  |  | 456 | $global\_limit = wprss\_get\_general\_setting('limit\_feed\_items\_imported'); |
  |  | 457 | $limit = ($global\_limit === '' || intval($global\_limit) <= 0) ? null : $global\_limit; |
  |  | 458 | } |
  |  | 459 |  |
  |  | 460 | // Calculate the allowed maximum time, based on the maximum number of items allowed to be |
  |  | 461 | // imported from this source. |
  |  | 462 | // If no limit is used, 60s (1min) is used. |
  |  | 463 | $single\_item\_time\_limit = wprss\_get\_feed\_fetch\_time\_limit(); |
  |  | 464 | $allowed\_time = $limit === null ? 120 : $single\_item\_time\_limit \* intval($limit); |
  |  | 465 |  |
  |  | 466 | // Calculate how many seconds have passed since the feed last signalled that it is updating |
  |  | 467 | $diff = time() - $is\_updating\_meta; |
  |  | 468 |  |
  |  | 469 | // Get the transient that is set when the import function is called and the time of the next scheduled cron |
  |  | 470 | $is\_updating\_transient = get\_transient('wpra/feeds/importing/' . $id); |
  |  | 471 | $scheduled = (wprss\_get\_next\_feed\_source\_update($id) !== false); |
  |  | 472 | // If more than 5 seconds have passed and the transient is not yet set and the cron was not scheduled |
  |  | 473 | // then the cron probably failed to be registered |
  |  | 474 | if ($diff > 5 && !$is\_updating\_transient && !$scheduled) { |
  |  | 475 | wprss\_flag\_feed\_as\_idle($id); |
  |  | 476 | update\_post\_meta( |
  |  | 477 | $id, |
  |  | 478 | 'wprss\_error\_last\_import', |
  |  | 479 | \_\_('The plugin failed to schedule a fetch for this feed. Please try again.', 'wprss') |
  |  | 480 | ); |
  |  | 481 |  |
  |  | 482 | return false; |
  |  | 483 | } |
  |  | 484 |  |
  |  | 485 | // If the difference is greater than the allowed maximum amount of time, mark the feed as idle. |
  |  | 486 | if ($diff > $allowed\_time) { |
  |  | 487 | wprss\_flag\_feed\_as\_idle($id); |
  |  | 488 | // Feed is not updating |
  |  | 489 | return false; |
  |  | 490 | } |
  |  | 491 |  |
  |  | 492 | // Feed is updating |
  |  | 493 | return true; |
  |  | 494 | } |
  |  | 495 |  |
  |  | 496 | /\*\* |
  |  | 497 | \* Returns whether the feed source is deleting its feed items. |
  |  | 498 | \* |
  |  | 499 | \* @param string|int The id of the feed source |
  |  | 500 | \* |
  |  | 501 | \* @return bool TRUE if the feed source is currently deleting its items, FALSE otherwise. |
  |  | 502 | \*/ |
  |  | 503 | function wprss\_is\_feed\_source\_deleting($id) |
  |  | 504 | { |
  |  | 505 | $is\_deleting\_meta = get\_post\_meta($id, 'wprss\_feed\_is\_deleting\_items', true); |
  |  | 506 |  |
  |  | 507 | if ($is\_deleting\_meta === '') { |
  |  | 508 | return false; |
  |  | 509 | } |
  |  | 510 |  |
  |  | 511 | $diff = time() - $is\_deleting\_meta; |
  |  | 512 |  |
  |  | 513 | $items = wprss\_get\_feed\_items\_for\_source($id); |
  |  | 514 | if ($items->post\_count === 0 || $diff > 300) { |
  |  | 515 | delete\_post\_meta($id, 'wprss\_feed\_is\_deleting\_items'); |
  |  | 516 | return false; |
  |  | 517 | } |
  |  | 518 |  |
  |  | 519 | return true; |
  |  | 520 | } |
  |  | 521 |  |
  |  | 522 | /\*\* |
  |  | 523 | \* Returns the given parameter as a string. Used in wprss\_truncate\_posts() |
  |  | 524 | \* |
  |  | 525 | \* @since 3.5.1 |
  |  | 526 | \* @return string The given parameter as a string |
  |  | 527 | \*/ |
  |  | 528 | function wprss\_return\_as\_string($item) |
  |  | 529 | { |
  |  | 530 | return "'$item'"; |
  |  | 531 | } |
  |  | 532 |  |
  |  | 533 | /\*\* |
  |  | 534 | \* Returns true if the feed item is older than the given timestamp, |
  |  | 535 | \* false otherwise; |
  |  | 536 | \* |
  |  | 537 | \* @since 3.8 |
  |  | 538 | \*/ |
  |  | 539 | function wprss\_is\_feed\_item\_older\_than($id, $timestamp) |
  |  | 540 | { |
  |  | 541 | // GET THE DATE |
  |  | 542 | $age = get\_the\_time('U', $id); |
  |  | 543 | if ($age === '') { |
  |  | 544 | return false; |
  |  | 545 | } |
  |  | 546 | // Calculate the age difference |
  |  | 547 | $difference = $age - $timestamp; |
  |  | 548 | // Return whether the difference is negative ( the age is smaller than the timestamp ) |
  |  | 549 | return ($difference <= 0); |
  |  | 550 | } |
  |  | 551 |  |
  |  | 552 | /\*\* |
  |  | 553 | \* Returns the maximum age setting for a feed source. |
  |  | 554 | \* |
  |  | 555 | \* @since 3.8 |
  |  | 556 | \*/ |
  |  | 557 | function wprss\_get\_max\_age\_for\_feed\_source($source\_id) |
  |  | 558 | { |
  |  | 559 | $general\_settings = get\_option('wprss\_settings\_general'); |
  |  | 560 | // Get the metadata for age for this feed source |
  |  | 561 | $age\_limit = trim(get\_post\_meta($source\_id, 'wprss\_age\_limit', true)); |
  |  | 562 | $age\_unit = get\_post\_meta($source\_id, 'wprss\_age\_unit', true); |
  |  | 563 |  |
  |  | 564 | // If the meta does not exist, use the global settings |
  |  | 565 | if ($age\_limit === '') { |
  |  | 566 | $age\_limit = trim(wprss\_get\_general\_setting('limit\_feed\_items\_age')); |
  |  | 567 | $age\_unit = wprss\_get\_general\_setting('limit\_feed\_items\_age\_unit'); |
  |  | 568 | } |
  |  | 569 |  |
  |  | 570 | // If the age limit is an empty string, use no limit |
  |  | 571 | if ($age\_limit === '') { |
  |  | 572 | return false; |
  |  | 573 | } |
  |  | 574 |  |
  |  | 575 | // Return the timestamp of the max age date |
  |  | 576 | return strtotime("-$age\_limit $age\_unit"); |
  |  | 577 | } |
  |  | 578 |  |
  |  | 579 | /\*\* |
  |  | 580 | \* Truncates the items for a single feed source based on its age limit. |
  |  | 581 | \* |
  |  | 582 | \* @since 4.14 |
  |  | 583 | \* |
  |  | 584 | \* @param int|WP\_Post $source The source ID or post instance. |
  |  | 585 | \*/ |
  |  | 586 | function wprss\_truncate\_items\_for\_source($source) |
  |  | 587 | { |
  |  | 588 | $id = ($source instanceof WP\_Post) |
  |  | 589 | ? $source->ID |
  |  | 590 | : $source; |
  |  | 591 |  |
  |  | 592 | $logger = wpra\_get\_logger($id); |
  |  | 593 |  |
  |  | 594 | // Get the max age setting for this feed source |
  |  | 595 | $max\_age = wprss\_get\_max\_age\_for\_feed\_source($id); |
  |  | 596 |  |
  |  | 597 | // If the data is empty, do not delete |
  |  | 598 | if ($max\_age === false) { |
  |  | 599 | return; |
  |  | 600 | } |
  |  | 601 |  |
  |  | 602 | // Get all feed items for this source |
  |  | 603 | $feed\_items = wprss\_get\_feed\_items\_for\_source($id); |
  |  | 604 |  |
  |  | 605 | // If there are no feed items, stop |
  |  | 606 | if (!$feed\_items->have\_posts()) { |
  |  | 607 | return; |
  |  | 608 | } |
  |  | 609 |  |
  |  | 610 | // Extend the timeout time limit for the deletion of the feed items |
  |  | 611 | set\_time\_limit(wprss\_get\_item\_import\_time\_limit()); |
  |  | 612 |  |
  |  | 613 | $logger->debug('Truncating existing items'); |
  |  | 614 |  |
  |  | 615 | // For each feed item |
  |  | 616 | while ($feed\_items->have\_posts()) { |
  |  | 617 | $feed\_items->the\_post(); |
  |  | 618 | // If the post is older than the maximum age |
  |  | 619 | $item\_id = get\_the\_ID(); |
  |  | 620 |  |
  |  | 621 | if (wprss\_is\_feed\_item\_older\_than($item\_id, $max\_age) === true) { |
  |  | 622 | // Delete the post |
  |  | 623 | wp\_delete\_post($item\_id, true); |
  |  | 624 | } |
  |  | 625 | } |
  |  | 626 |  |
  |  | 627 | // Reset feed items query data |
  |  | 628 | wp\_reset\_postdata(); |
  |  | 629 | } |
  |  | 630 |  |
  |  | 631 | /\*\* |
  |  | 632 | \* Delete old feed items from the database to avoid bloat. |
  |  | 633 | \* As of 3.8, it uses the new feed age system. |
  |  | 634 | \* |
  |  | 635 | \* @since 3.8 |
  |  | 636 | \*/ |
  |  | 637 | function wprss\_truncate\_posts() |
  |  | 638 | { |
  |  | 639 | // Get general settings |
  |  | 640 | $general\_settings = get\_option('wprss\_settings\_general'); |
  |  | 641 | // Get all feed sources |
  |  | 642 | $feed\_sources = wprss\_get\_all\_feed\_sources(); |
  |  | 643 |  |
  |  | 644 | // Check if there are feed sources |
  |  | 645 | if ($feed\_sources->have\_posts()) { |
  |  | 646 | // Truncate items for each feed source |
  |  | 647 | while ($feed\_sources->have\_posts()) { |
  |  | 648 | $feed\_sources->the\_post(); |
  |  | 649 | wprss\_truncate\_items\_for\_source(get\_the\_ID()); |
  |  | 650 | } |
  |  | 651 | // Reset feed sources query data |
  | 618 | 652 | wp\_reset\_postdata(); |
  | 619 | 653 | } |
  | 620 | 654 |  |
  | 621 |  | /\*\* |
  | 622 |  | \* Delete old feed items from the database to avoid bloat. |
  | 623 |  | \* As of 3.8, it uses the new feed age system. |
  | 624 |  | \* |
  | 625 |  | \* @since 3.8 |
  | 626 |  | \*/ |
  | 627 |  | function wprss\_truncate\_posts() { |
  | 628 |  | // Get general settings |
  | 629 |  | $general\_settings = get\_option( 'wprss\_settings\_general' ); |
  | 630 |  | // Get all feed sources |
  | 631 |  | $feed\_sources = wprss\_get\_all\_feed\_sources(); |
  | 632 |  |  |
  | 633 |  | // Check if there are feed sources |
  | 634 |  | if( $feed\_sources->have\_posts() ) { |
  | 635 |  | // Truncate items for each feed source |
  | 636 |  | while ( $feed\_sources->have\_posts() ) { |
  | 637 |  | $feed\_sources->the\_post(); |
  | 638 |  | wprss\_truncate\_items\_for\_source( get\_the\_ID() ); |
  | 639 |  | } |
  | 640 |  | // Reset feed sources query data |
  | 641 |  | wp\_reset\_postdata(); |
  | 642 |  | } |
  | 643 |  |  |
  | 644 |  | // If the filter to use the fixed limit is enabled, call the old truncation function |
  | 645 |  | if ( apply\_filters( 'wprss\_use\_fixed\_feed\_limit', FALSE ) === TRUE && isset( $general\_settings['limit\_feed\_items\_db'] ) ) { |
  | 646 |  | wprss\_old\_truncate\_posts(); |
  | 647 |  | } |
  | 648 |  | } |
  | 649 |  |  |
  | 650 |  |  |
  | 651 |  | /\*\* |
  | 652 |  | \* The old truncation function. |
  | 653 |  | \* This truncation method uses the deprecated fixed feed limit. |
  | 654 |  | \* |
  | 655 |  | \* @since 2.0 |
  | 656 |  | \*/ |
  | 657 |  | function wprss\_old\_truncate\_posts() { |
  | 658 |  | global $wpdb; |
  | 659 |  | $general\_settings = get\_option( 'wprss\_settings\_general' ); |
  | 660 |  |  |
  | 661 |  | if ( $general\_settings['limit\_feed\_items\_db'] == 0 ) { |
  | 662 |  | return; |
  | 663 |  | } |
  | 664 |  |  |
  | 665 |  | // Set your threshold of max posts and post\_type name |
  | 666 |  | $threshold = $general\_settings['limit\_feed\_items\_db']; |
  | 667 |  | $post\_types = apply\_filters( 'wprss\_truncation\_post\_types', array( 'wprss\_feed\_item' ) ); |
  | 668 |  | $post\_types\_str = array\_map( 'wprss\_return\_as\_string', $post\_types ); |
  | 669 |  |  |
  | 670 |  | $post\_type\_list = implode( ',' , $post\_types\_str ); |
  | 671 |  |  |
  | 672 |  | // Query post type |
  | 673 |  | // $wpdb query allows me to select specific columns instead of grabbing the entire post object. |
  | 674 |  | $query = " |
  |  | 655 | // If the filter to use the fixed limit is enabled, call the old truncation function |
  |  | 656 | if (apply\_filters('wprss\_use\_fixed\_feed\_limit', |
  |  | 657 | false) === true && isset($general\_settings['limit\_feed\_items\_db'])) { |
  |  | 658 | wprss\_old\_truncate\_posts(); |
  |  | 659 | } |
  |  | 660 | } |
  |  | 661 |  |
  |  | 662 | /\*\* |
  |  | 663 | \* The old truncation function. |
  |  | 664 | \* This truncation method uses the deprecated fixed feed limit. |
  |  | 665 | \* |
  |  | 666 | \* @since 2.0 |
  |  | 667 | \*/ |
  |  | 668 | function wprss\_old\_truncate\_posts() |
  |  | 669 | { |
  |  | 670 | global $wpdb; |
  |  | 671 | $general\_settings = get\_option('wprss\_settings\_general'); |
  |  | 672 |  |
  |  | 673 | if ($general\_settings['limit\_feed\_items\_db'] == 0) { |
  |  | 674 | return; |
  |  | 675 | } |
  |  | 676 |  |
  |  | 677 | // Set your threshold of max posts and post\_type name |
  |  | 678 | $threshold = $general\_settings['limit\_feed\_items\_db']; |
  |  | 679 | $post\_types = apply\_filters('wprss\_truncation\_post\_types', ['wprss\_feed\_item']); |
  |  | 680 | $post\_types\_str = array\_map('wprss\_return\_as\_string', $post\_types); |
  |  | 681 |  |
  |  | 682 | $post\_type\_list = implode(',', $post\_types\_str); |
  |  | 683 |  |
  |  | 684 | // Query post type |
  |  | 685 | // $wpdb query allows me to select specific columns instead of grabbing the entire post object. |
  |  | 686 | $query = " |
  | 675 | 687 | SELECT ID, post\_title FROM $wpdb->posts |
  | 676 | 688 | WHERE post\_type IN ($post\_type\_list) |
  | […](/browser/wp-rss-aggregator/trunk/includes/feed-processing.php?rev=2621306#L679) | […](/browser/wp-rss-aggregator/trunk/includes/feed-processing.php?rev=2659298#L691) |  |
  | 679 | 691 | "; |
  | 680 | 692 |  |
  | 681 |  | $results = $wpdb->get\_results( $query ); |
  | 682 |  |  |
  | 683 |  | // Check if there are any results |
  | 684 |  | $i = 0; |
  | 685 |  | if ( count( $results ) ){ |
  | 686 |  | foreach ( $results as $post ) { |
  | 687 |  | $i++; |
  | 688 |  |  |
  | 689 |  | // Skip any posts within our threshold |
  | 690 |  | if ( $i <= $threshold ) |
  | 691 |  | continue; |
  | 692 |  |  |
  | 693 |  | // Let the WordPress API do the heavy lifting for cleaning up entire post trails |
  | 694 |  | $purge = wp\_delete\_post( $post->ID, true ); |
  |  | 693 | $results = $wpdb->get\_results($query); |
  |  | 694 |  |
  |  | 695 | // Check if there are any results |
  |  | 696 | $i = 0; |
  |  | 697 | if (count($results)) { |
  |  | 698 | foreach ($results as $post) { |
  |  | 699 | $i++; |
  |  | 700 |  |
  |  | 701 | // Skip any posts within our threshold |
  |  | 702 | if ($i <= $threshold) { |
  |  | 703 | continue; |
  | 695 | 704 | } |
  |  | 705 |  |
  |  | 706 | // Let the WordPress API do the heavy lifting for cleaning up entire post trails |
  |  | 707 | $purge = wp\_delete\_post($post->ID, true); |
  | 696 | 708 | } |
  | 697 | 709 | } |
  | 698 |  |  |
  | 699 |  |  |
  | 700 |  | add\_filter( 'wprss\_insert\_post\_item\_conditionals', 'wprss\_check\_feed\_item\_date\_on\_import', 2, 3 ); |
  | 701 |  | /\*\* |
  | 702 |  | \* When a feed item is imported, it's date is compared against the max age of it's feed source. |
  | 703 |  | \* |
  | 704 |  | \* |
  | 705 |  | \* @since 3.8 |
  | 706 |  | \*/ |
  | 707 |  | function wprss\_check\_feed\_item\_date\_on\_import( $item, $source, $permalink ){ |
  | 708 |  | if ( $item === NULL ) return NULL; |
  | 709 |  |  |
  | 710 |  | // Get the age of the item and the max age setting for its feed source |
  | 711 |  | $age = $item->get\_date( 'U' ); |
  | 712 |  | $max\_age = wprss\_get\_max\_age\_for\_feed\_source( $source ); |
  | 713 |  |  |
  | 714 |  | // If the age is not a valid timestamp, and the max age setting is disabled, return the item |
  | 715 |  | if ( $age === '' || $age === NULL || $max\_age === FALSE || $max\_age === NULL ) { |
  | 716 |  | return $item; |
  | 717 |  | } |
  | 718 |  |  |
  | 719 |  | // Calculate the age difference |
  | 720 |  | $difference = $age - $max\_age; |
  | 721 |  |  |
  | 722 |  | if ( $difference <= 0 ) { |
  | 723 |  | wpra\_get\_logger()->debug('Item "{0}" was rejected by age limit settings.', [ |
  | 724 |  | $item->get\_title() |
  | 725 |  | ]); |
  | 726 |  |  |
  | 727 |  | return NULL; |
  | 728 |  | } else { |
  | 729 |  | return $item; |
  | 730 |  | } |
  | 731 |  | } |
  | 732 |  |  |
  | 733 |  |  |
  | 734 |  | /\*\* |
  | 735 |  | \* Deletes all imported feeds. |
  | 736 |  | \* |
  | 737 |  | \* @since 3.0 |
  | 738 |  | \*/ |
  | 739 |  | function wprss\_feed\_reset() { |
  | 740 |  | wp\_schedule\_single\_event( time(), 'wprss\_delete\_all\_feed\_items\_hook' ); |
  | 741 |  | } |
  | 742 |  |  |
  | 743 |  |  |
  | 744 |  |  |
  | 745 |  | function wprss\_schedule\_reimport\_all($deleted\_ids) { |
  | 746 |  | if( !get\_transient( WPRSS\_TRANSIENT\_NAME\_IS\_REIMPORTING ) ) |
  | 747 |  | return; |
  | 748 |  |  |
  | 749 |  | wprss\_log( 'Re-import scheduled...', \_\_FUNCTION\_\_, WPRSS\_LOG\_LEVEL\_SYSTEM); |
  | 750 |  | delete\_transient( WPRSS\_TRANSIENT\_NAME\_IS\_REIMPORTING ); |
  | 751 |  | wprss\_fetch\_insert\_all\_feed\_items( TRUE ); |
  | 752 |  | } |
  | 753 |  |  |
  | 754 |  |  |
  | 755 |  | /\*\* |
  | 756 |  | \* Deletes N oldest feed items for the given source |
  | 757 |  | \* |
  | 758 |  | \* @since 4.2 |
  | 759 |  | \* @deprecated |
  | 760 |  | \*/ |
  | 761 |  | function wprss\_delete\_oldest\_feed\_items( $n, $source ) { |
  | 762 |  | // If the source does not exist, do nothing |
  | 763 |  | if ( get\_post( $source ) == NULL ) return; |
  | 764 |  |  |
  | 765 |  | // Make sure $n is an integer |
  | 766 |  | $n = intval($n); |
  | 767 |  |  |
  | 768 |  | // Do nothing if n is zero or negative |
  | 769 |  | if ( $n <= 0 ) return; |
  | 770 |  |  |
  | 771 |  | // Get the feed items, as an array, not WP\_Query. |
  | 772 |  | // We will need to perform some array operations |
  | 773 |  | $feed\_items = wprss\_get\_feed\_items\_for\_source( $source ); |
  | 774 |  | $feed\_items = $feed\_items->get\_posts(); |
  | 775 |  | // Get number of feed items |
  | 776 |  | $count = count( $feed\_items ); |
  | 777 |  |  |
  | 778 |  | // Index of first feed item to delete |
  | 779 |  | $start = $count - $n; |
  | 780 |  | // Cut the array of feed items to get the items to delete |
  | 781 |  | $to\_delete = array\_slice( $feed\_items, $start ); |
  | 782 |  | // log -- for now |
  | 783 |  | foreach( $to\_delete as $fi ) { |
  | 784 |  | //wprss\_log\_obj( "To delete" , $fi->ID ); |
  | 785 |  | } |
  | 786 |  | } |
  | 787 |  |  |
  | 788 |  |  |
  | 789 |  | /\*\* |
  | 790 |  | \* Deletes the required number of feed items for the given source, |
  | 791 |  | \* to keep the number of feed items below its limit. |
  | 792 |  | \* |
  | 793 |  | \* @since 4.2 |
  | 794 |  | \* @deprecated |
  | 795 |  | \*/ |
  | 796 |  | function wprss\_truncate\_feed\_items\_for\_source( $source ) { |
  | 797 |  | // Get the limit setting |
  | 798 |  | $limit = get\_post\_meta( $source, 'wprss\_limit', true ); |
  | 799 |  |  |
  | 800 |  | // Calculate the number of feed items to delete |
  | 801 |  | $feed\_items = wprss\_get\_feed\_items\_for\_source( $source ); |
  | 802 |  | $n = intval($feed\_items->found\_posts) - intval($limit); |
  | 803 |  |  |
  | 804 |  | // Delete the feed items |
  | 805 |  | wprss\_delete\_oldest\_feed\_items( $n, $source ); |
  | 806 |  | } |
  |  | 710 | } |
  |  | 711 |  |
  |  | 712 | add\_filter('wprss\_insert\_post\_item\_conditionals', 'wprss\_check\_feed\_item\_date\_on\_import', 2, 3); |
  |  | 713 | /\*\* |
  |  | 714 | \* When a feed item is imported, it's date is compared against the max age of it's feed source. |
  |  | 715 | \* |
  |  | 716 | \* @since 3.8 |
  |  | 717 | \*/ |
  |  | 718 | function wprss\_check\_feed\_item\_date\_on\_import($item, $source, $permalink) |
  |  | 719 | { |
  |  | 720 | if ($item === null) { |
  |  | 721 | return null; |
  |  | 722 | } |
  |  | 723 |  |
  |  | 724 | // Get the age of the item and the max age setting for its feed source |
  |  | 725 | $age = $item->get\_date('U'); |
  |  | 726 | $max\_age = wprss\_get\_max\_age\_for\_feed\_source($source); |
  |  | 727 |  |
  |  | 728 | // If the age is not a valid timestamp, and the max age setting is disabled, return the item |
  |  | 729 | if ($age === '' || $age === null || $max\_age === false || $max\_age === null) { |
  |  | 730 | return $item; |
  |  | 731 | } |
  |  | 732 |  |
  |  | 733 | // Calculate the age difference |
  |  | 734 | $difference = $age - $max\_age; |
  |  | 735 |  |
  |  | 736 | if ($difference <= 0) { |
  |  | 737 | wpra\_get\_logger()->debug('Item "{0}" was rejected by age limit settings.', [ |
  |  | 738 | $item->get\_title(), |
  |  | 739 | ]); |
  |  | 740 |  |
  |  | 741 | return null; |
  |  | 742 | } else { |
  |  | 743 | return $item; |
  |  | 744 | } |
  |  | 745 | } |
  |  | 746 |  |
  |  | 747 | /\*\* |
  |  | 748 | \* Deletes all imported feeds. |
  |  | 749 | \* |
  |  | 750 | \* @since 3.0 |
  |  | 751 | \*/ |
  |  | 752 | function wprss\_feed\_reset() |
  |  | 753 | { |
  |  | 754 | wp\_schedule\_single\_event(time(), 'wprss\_delete\_all\_feed\_items\_hook'); |
  |  | 755 | } |
  |  | 756 |  |
  |  | 757 | function wprss\_schedule\_reimport\_all($deleted\_ids) |
  |  | 758 | { |
  |  | 759 | if (!get\_transient(WPRSS\_TRANSIENT\_NAME\_IS\_REIMPORTING)) { |
  |  | 760 | return; |
  |  | 761 | } |
  |  | 762 |  |
  |  | 763 | wprss\_log('Re-import scheduled...', \_\_FUNCTION\_\_, WPRSS\_LOG\_LEVEL\_SYSTEM); |
  |  | 764 | delete\_transient(WPRSS\_TRANSIENT\_NAME\_IS\_REIMPORTING); |
  |  | 765 | wprss\_fetch\_insert\_all\_feed\_items(true); |
  |  | 766 | } |
* ## [wp-rss-aggregator/trunk/readme.txt](/changeset/2659298/wp-rss-aggregator/trunk/readme.txt "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/readme.txt")

  | [r2634850](/browser/wp-rss-aggregator/trunk/readme.txt?rev=2634850#L255 "Show revision 2634850 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/readme.txt?rev=2659298#L255 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 255 | 255 | == Changelog == |
  | 256 | 256 |  |
  |  | 257 | = 4.20 (2022-01-18) = |
  |  | 258 | \*\*Added\*\* |
  |  | 259 | - New option to use feed item GUIDs instead of permalinks to detect duplicate items. |
  |  | 260 |  |
  |  | 261 | \*\*Changed\*\* |
  |  | 262 | - Small performance improvement when importing feed items. |
  |  | 263 |  |
  |  | 264 | \*\*Fixed\*\* |
  |  | 265 | - A warning about `get\_headers()` only working with URLs. |
  |  | 266 | - A warning about iteration over a non-array value. |
  |  | 267 | - An AJAX XSS vulnerability on the Feed Sources page. Thanks WPScan! |
  |  | 268 |  |
  | 257 | 269 | = 4.19.3 (2021-11-24) |
  | 258 | 270 | \*\*Fixed\*\* |
* ## [wp-rss-aggregator/trunk/vendor/composer/installed.php](/changeset/2659298/wp-rss-aggregator/trunk/vendor/composer/installed.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/vendor/composer/installed.php")

  | [r2634846](/browser/wp-rss-aggregator/trunk/vendor/composer/installed.php?rev=2634846#L6 "Show revision 2634846 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/vendor/composer/installed.php?rev=2659298#L6 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 7 | 7 | 'aliases' => array(), |
  | 8 |  | 'reference' => '~~6ac1322b90948d7d50b0db7ff5ef6e3d08506d11~~', |
  |  | 8 | 'reference' => '935532e5af1a44ac838ebb1f7054b1963781c4dc', |
  | 9 | 9 | 'name' => 'wprss/core', |
  | 10 | 10 | 'dev' => false, |
  | […](/browser/wp-rss-aggregator/trunk/vendor/composer/installed.php?rev=2634846#L344) | […](/browser/wp-rss-aggregator/trunk/vendor/composer/installed.php?rev=2659298#L344) |  |
  | 344 | 344 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 345 | 345 | 'aliases' => array(), |
  | 346 |  | 'reference' => '~~6ac1322b90948d7d50b0db7ff5ef6e3d08506d11~~', |
  |  | 346 | 'reference' => '935532e5af1a44ac838ebb1f7054b1963781c4dc', |
  | 347 | 347 | 'dev\_requirement' => false, |
  | 348 | 348 | ), |
* ## [wp-rss-aggregator/trunk/wp-rss-aggregator.php](/changeset/2659298/wp-rss-aggregator/trunk/wp-rss-aggregator.php "Show the changeset 2659298 restricted to wp-rss-aggregator/trunk/wp-rss-aggregator.php")

  | [r2634846](/browser/wp-rss-aggregator/trunk/wp-rss-aggregator.php?rev=2634846#L5 "Show revision 2634846 of this file in browser") | [r2659298](/browser/wp-rss-aggregator/trunk/wp-rss-aggregator.php?rev=2659298#L5 "Show revision 2659298 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: https://www.wprssaggregator.com/#utm\_source=wpadmin&utm\_medium=plugin&utm\_campaign=wpraplugin |
  | 6 | 6 | \* Description: Imports and aggregates multiple RSS Feeds. |
  | 7 |  | \* Version: 4.~~19.3~~ |
  |  | 7 | \* Version: 4.20 |
  | 8 | 8 | \* Author: RebelCode |
  | 9 | 9 | \* Author URI: https://www.wprssaggregator.com |
  | […](/browser/wp-rss-aggregator/trunk/wp-rss-aggregator.php?rev=2634846#L77) | […](/browser/wp-rss-aggregator/trunk/wp-rss-aggregator.php?rev=2659298#L77) |  |
  | 77 | 77 | // Set the version number of the plugin. |
  | 78 | 78 | if( !defined( 'WPRSS\_VERSION' ) ) |
  | 79 |  | define( 'WPRSS\_VERSION', '4.~~19.3~~' ); |
  |  | 79 | define( 'WPRSS\_VERSION', '4.20' ); |
  | 80 | 80 |  |
  | 81 | 81 | if( !defined( 'WPRSS\_WP\_MIN\_VERSION' ) ) |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2659298)
* [Zip Archive](?format=zip&new=2659298)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wpscan.com_9430c5b4_20250114_220624.html ===


[Skip to content](#wp--skip-link--target)

* [Features](https://a8cteam5105.wordpress.com/features/)
* [Pricing](https://a8cteam5105.wordpress.com/pricing/)
* Solutions
  + [Status](https://status.wpscan.com/)
  + [API Details](/api)
  + [CLI Scanner](https://a8cteam5105.wordpress.com/wordpress-cli-scanner/)
* Vulnerabilities
  + [Themes](/themes)
  + [WordPress](/wordpresses)
  + [Plugins](/plugins)
  + [Stats](/statistics)
  + [Submit Vulnerabilities](/submit)
  + [Leaderboard](/leaderboard)
* Resources
  + [Blog](/blog)
  + [Enterprise Features](https://a8cteam5105.wordpress.com/enterprise-customers-features/)
  + [How to Install WPScan](https://a8cteam5105.wordpress.com/how-to-install-wpscan/)
  + [WPScan Glossary](/wpscan-glossary)
  + [2024 Website Threat Report](https://wpscan.com/2023-website-threat-report/)

Search

## WordPress Plugin Vulnerabilities

# WP RSS Aggregator < 4.20 - Reflected Cross-Site Scripting (XSS)

### Description

The plugin does not sanitise and escape the id parameter in the wprss\_fetch\_items\_row\_action AJAX action before outputting it back in the response, leading to a Reflected Cross-Site Scripting

### Proof of Concept

Save the HTML below to a file with the .html extension, then open it in Firefox, while being authenticated in a separate tab to a WordPress site with the plugin installed.
<html>
<form action="http://example.com/wp-admin/admin-ajax.php?action=wprss\_fetch\_items\_row\_action" method="POST">
<input type="text" value="<html><img src onerror=alert(`XSS`)>" name="id">
<input type="submit" value="Send">
</form>
</html>

### Affects Plugins

[![Plugin icon](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/plugin-icon.svg)

wp-rss-aggregator](https://a8cteam5105.wordpress.com/plugin/wp-rss-aggregator/)

![](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/checkmark-green-alt.svg)
Fixed in 4.20

### References

CVE
[CVE-2022-0189](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0189)

URL
<https://plugins.trac.wordpress.org/changeset/2659298>

### Classification

Type
XSS

OWASP top 10
[A7: Cross-Site Scripting (XSS)](https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_%28XSS%29)

CWE
[CWE-79](https://cwe.mitre.org/data/definitions/79.html)

CVSS
[6.1 (medium)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

### Miscellaneous

Original Researcher
Krzysztof Zając

Submitter
Krzysztof Zając

Submitter website
<https://kazet.cc/>

Verified
Yes

WPVDB ID
[52a71bf1-b8bc-479e-b741-eb8fb9685014](https://a8cteam5105.wordpress.com/vulnerability/52a71bf1-b8bc-479e-b741-eb8fb9685014/)

### Timeline

Publicly Published
2022-01-26 (about 2 years ago)

Added
2022-01-26 (about 2 years ago)

Last Updated
2022-04-09 (about 2 years ago)

### Other

Published
Title

Published
2024-06-28
Title
[WidgetKit < 2.5.1 - Authenticated (Contributor+) Stored Cross-Site Scripting](https://a8cteam5105.wordpress.com/vulnerability/3d13eab1-7c94-4560-b33e-77f78eb6c9f2/)

Published
2024-03-15
Title
[WP Responsive Tabs horizontal vertical and accordion Tabs < 1.1.18 - Authenticated (Contributor+) Stored Cross-Site Scripting](https://a8cteam5105.wordpress.com/vulnerability/e3f589c3-83b8-4e5a-a0df-4d86c9769e02/)

Published
2025-01-07
Title
[Justified Image Gallery <= 1.0 - Authenticated (Contributor+) Stored Cross-Site Scripting](https://a8cteam5105.wordpress.com/vulnerability/f570c51e-6f68-4bc1-aad0-1ae8b667e0d0/)

Published
2025-01-09
Title
[Bulk Me Now <= 2.0 - Message Deletion via CSRF](https://a8cteam5105.wordpress.com/vulnerability/d93056f1-1a6e-405f-a094-d4d270393f87/)

Published
2012-05-15
Title
[Sharebar <= 1.2.1 - SQL Injection & Cross-Site Scripting (XSS)](https://a8cteam5105.wordpress.com/vulnerability/fd5a315c-92fe-4d8a-b546-47efee3a4e4e/)

![](https://wpscan.com/wp-content/uploads/2023/10/wpscan-logo-dark.png?w=246)

### Vulnerabilities

* [WordPress](/wordpresses)
* [Plugins](/plugins)
* [Themes](/themes)
* [Our Stats](https://a8cteam5105.wordpress.com/statistics/)
* [Submit vulnerabilities](https://a8cteam5105.wordpress.com/submit/)

#### About

* [How it works](/features)
* [Pricing](/pricing)
* [WordPress plugin](https://wordpress.org/plugins/wpscan/)
* [Blog](/blog)
* [Contact](/contact)

#### For Developers

* [Status](https://status.wpscan.com/)
* [API details](/api)
* [CLI scanner](/wordpress-cli-scanner)

#### Other

* [Privacy](https://automattic.com/privacy/)
* [Terms of service](/terms)
* [Submission terms](/submission-terms/)
* [Disclosure policy](/vulnerability-disclosure-policy)
* [Privacy Notice for California Users](https://automattic.com/privacy/#california-consumer-privacy-act-ccpa)

---

![](https://wpscan.com/wp-content/uploads/2023/08/frame-1323.png?w=48)

In partnership with [Jetpack](https://jetpack.com/)

* [GitHub](https://github.com/wpscanteam/wpscan/)
* [Twitter](https://twitter.com/_wpscan_)
* [Facebook](https://www.facebook.com/WPScan)

---

An

![](https://wpscan.com/wp-content/uploads/2023/08/autpmattic-logo.png?w=298)

endeavor

[Work With Us](https://automattic.com/work-with-us/)

[Press](https://automattic.com/press/)

* Subscribe
  Subscribed

  + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)

  Join 30,404 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
* Privacy
* + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://wpscan.com)
  + [View site in Reader](https://wordpress.com/read/feeds/156197069)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

![](https://pixel.wp.com/b.gif?v=noscript)

