=== Content from github.com_1cd37585_20250114_202818.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flitespeedtech%2Fopenlitespeed%2Fblob%2Fv1.7.16.1%2Fsrc%2Fmain%2Fhttpserver.cpp)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flitespeedtech%2Fopenlitespeed%2Fblob%2Fv1.7.16.1%2Fsrc%2Fmain%2Fhttpserver.cpp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=litespeedtech%2Fopenlitespeed)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[litespeedtech](/litespeedtech)
/
**[openlitespeed](/litespeedtech/openlitespeed)**
Public

* [Notifications](/login?return_to=%2Flitespeedtech%2Fopenlitespeed) You must be signed in to change notification settings
* [Fork
  195](/login?return_to=%2Flitespeedtech%2Fopenlitespeed)
* [Star
   1.2k](/login?return_to=%2Flitespeedtech%2Fopenlitespeed)

* [Code](/litespeedtech/openlitespeed/tree/v1.7.16.1)
* [Issues
  71](/litespeedtech/openlitespeed/issues)
* [Pull requests
  2](/litespeedtech/openlitespeed/pulls)
* [Actions](/litespeedtech/openlitespeed/actions)
* [Projects
  0](/litespeedtech/openlitespeed/projects)
* [Wiki](/litespeedtech/openlitespeed/wiki)
* [Security](/litespeedtech/openlitespeed/security)
* [Insights](/litespeedtech/openlitespeed/pulse)

Additional navigation options

* [Code](/litespeedtech/openlitespeed/tree/v1.7.16.1)
* [Issues](/litespeedtech/openlitespeed/issues)
* [Pull requests](/litespeedtech/openlitespeed/pulls)
* [Actions](/litespeedtech/openlitespeed/actions)
* [Projects](/litespeedtech/openlitespeed/projects)
* [Wiki](/litespeedtech/openlitespeed/wiki)
* [Security](/litespeedtech/openlitespeed/security)
* [Insights](/litespeedtech/openlitespeed/pulse)

## Files

 v1.7.16.1
## Breadcrumbs

1. [openlitespeed](/litespeedtech/openlitespeed/tree/v1.7.16.1)
2. /[src](/litespeedtech/openlitespeed/tree/v1.7.16.1/src)
3. /[main](/litespeedtech/openlitespeed/tree/v1.7.16.1/src/main)
/
# httpserver.cpp

Copy path Blame  Blame
## Latest commit

## History

[History](/litespeedtech/openlitespeed/commits/v1.7.16.1/src/main/httpserver.cpp)5765 lines (4788 loc) · 174 KB v1.7.16.1
## Breadcrumbs

1. [openlitespeed](/litespeedtech/openlitespeed/tree/v1.7.16.1)
2. /[src](/litespeedtech/openlitespeed/tree/v1.7.16.1/src)
3. /[main](/litespeedtech/openlitespeed/tree/v1.7.16.1/src/main)
/
# httpserver.cpp

Top
## File metadata and controls

* Code
* Blame

5765 lines (4788 loc) · 174 KB[Raw](https://github.com/litespeedtech/openlitespeed/raw/refs/tags/v1.7.16.1/src/main/httpserver.cpp)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* Open LiteSpeed is an open source HTTP server. \*\* Copyright (C) 2013 - 2022 LiteSpeed Technologies, Inc. \*\* \*\* This program is free software: you can redistribute it and/or modify \*\* it under the terms of the GNU General Public License as published by \*\* the Free Software Foundation, either version 3 of the License, or \*\* (at your option) any later version. \*\* \*\* This program is distributed in the hope that it will be useful, \*\* but WITHOUT ANY WARRANTY; without even the implied warranty of \*\* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \*\* GNU General Public License for more details. \*\* \*\* You should have received a copy of the GNU General Public License \*\* along with this program. If not, see http://www.gnu.org/licenses/. \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/
#include <config.h>
#include "httpserver.h"
#include <adns/adns.h>
#include <edio/multiplexer.h>#include <edio/multiplexerfactory.h>#include <edio/sigeventdispatcher.h>
#include <extensions/extworker.h>#include <extensions/localworker.h>#include <extensions/localworkerconfig.h>#include <extensions/cgi/cgidworker.h>#include <extensions/cgi/lscgiddef.h>#include <extensions/cgi/suexec.h>#include <extensions/cgi/cgidconfig.h>#include <extensions/registry/extappregistry.h>#include <extensions/registry/appconfig.h>
#include <http/accesslog.h>#include <http/clientcache.h>#include <http/connlimitctrl.h>#include <http/contextlist.h>#include <http/denieddir.h>#include <http/eventdispatcher.h>#include <http/handlerfactory.h>#include <http/handlertype.h>#include <http/httpaiosendfile.h>#include <http/httpcgitool.h>#include <http/httpcontext.h>#include <http/httpdefs.h>#include <http/httplistener.h>#include <http/httplistenerlist.h>#include <http/httplog.h>#include <http/httpmime.h>#include <http/httpresourcemanager.h>#include <http/httprespheaders.h>#include <http/httpserverconfig.h>#include <http/httpserverversion.h>#include <http/httpsignals.h>#include <http/httpstats.h>#include <http/httpstatuscode.h>#include <http/httpvhost.h>#include <http/httpvhostlist.h>#include <http/iptogeo2.h>#include <http/iptoloc.h>#include <http/ntwkiolink.h>#include <http/platforms.h>#include <http/recaptcha.h>#include <http/serverprocessconfig.h>#include <http/staticfilecache.h>#include <http/staticfilecachedata.h>#include <http/stderrlogger.h>#include <http/vhostmap.h>#include <http/clientinfo.h>
#include <log4cxx/appender.h>#include <log4cxx/logger.h>#include <lsr/ls\_strtool.h>#include <lsr/ls\_time.h>
#include <main/configctx.h>#include <main/mainserverconfig.h>#include <main/plainconf.h>#include <main/serverinfo.h>#include <main/zconfclient.h>#include <main/zconfmanager.h>
#include <quic/quicengine.h>#include <quic/udplistener.h>
#include <shm/lsshm.h>#include <sslpp/sslcontext.h>#include <sslpp/sslcontextconfig.h>#include <sslpp/sslengine.h>#include <sslpp/sslocspstapling.h>#include <sslpp/sslsesscache.h>#include <sslpp/sslticket.h>#include <sslpp/sslutil.h>
#include <util/accesscontrol.h>#include <util/accessdef.h>#include <util/autostr.h>#include <util/daemonize.h>#include <util/datetime.h>#include <util/gpath.h>#include <util/pcutil.h>#include <util/vmembuf.h>#include <util/xmlnode.h>#include <util/stringtool.h>#include <util/sysinfo/nicdetect.h>#include <util/sysinfo/systeminfo.h>#include <util/ni\_fio.h>#include <util/stringtool.h>
#include <ctype.h>#include <dirent.h>#include <errno.h>#include <fcntl.h>#include <math.h>#include <pwd.h>#include <stdio.h>#include <sys/types.h>#include <sys/wait.h>#include <unistd.h>#include <sys/utsname.h>
#include <new>#include <util/httpfetch.h>
#ifdef RUN\_TEST#include <httpdtest.h>#include <extensions/fcgi/fcgiapp.h>#include <extensions/fcgi/fcgiappconfig.h>#include <extensions/jk/jworker.h>#include <extensions/jk/jworkerconfig.h>#include <http/htauth.h>#include <http/httpresp.h>#include <http/httpsession.h>#endif
#define USE\_REUSEPORT\_BY\_DEFAULT 1
#if defined(linux) || defined(\_\_linux) || defined(\_\_linux\_\_) || defined(\_\_gnu\_linux\_\_)#include <sys/prctl.h>#endif
#if defined(\_\_FreeBSD\_\_ ) || defined(\_\_NetBSD\_\_) || defined(\_\_OpenBSD\_\_) \ || defined(macintosh) || defined(\_\_APPLE\_\_) || defined(\_\_APPLE\_CC\_\_)#include <sys/sysctl.h>#endif
#define FILEMODE 0644
static int s\_achPid[256];static int s\_curPid = 0;//int SslContext::s\_iEnableMultiCerts = 0;static int s\_lsquic\_inited;
const char \*sStatDir = DEFAULT\_TMP\_DIR;
static void sigchild(int sig){ int status, pid; while (true) { pid = waitpid(-1, &status, WNOHANG | WUNTRACED); if (pid <= 0) { //if ((pid < 1)&&( errno == EINTR )) // continue; break; } if (s\_curPid < 256) s\_achPid[s\_curPid++] = pid; //PidRegistry::remove( pid ); } HttpSignals::orEvent(HS\_CHILD);}
void HttpServer::cleanPid(){ int pid; sigset\_t newmask, oldmask; ExtWorker \*pWorker;
 sigemptyset(&newmask); sigaddset(&newmask, SIGCHLD); if (sigprocmask(SIG\_BLOCK, &newmask, &oldmask) < 0) return ;
 while (s\_curPid > 0) { pid = s\_achPid[--s\_curPid]; LS\_DBG\_L("Remove pid: %d", pid); pWorker = PidRegistry::remove(pid); if (pWorker) pWorker->removePid(pid); } sigprocmask(SIG\_SETMASK, &oldmask, NULL);
}
LS\_SINGLETON(HttpServer);
class HttpServerImpl{ friend class HttpServer;
private:
 // members HttpVHostMap m\_vhosts; HttpVHostMap m\_orgVHosts; VHostList m\_toBeReleasedVHosts; EventDispatcher m\_dispatcher; HttpListenerList m\_listeners; HttpListenerList m\_oldListeners; HttpListenerList m\_toBeReleasedListeners; ContextList m\_toBeReleasedContext; HttpContext m\_serverContext; AccessControl m\_accessCtrl; AutoStr m\_sSwapDirectory; AutoStr2 m\_sRTReportFile; AutoStr2 m\_sIpv4; AutoStr2 m\_sIpv6; HttpMime m\_httpMime; long m\_lStartTime; pid\_t m\_pid; gid\_t m\_pri\_gid; HttpFetch \*m\_pAutoUpdFetch[3]; QuicEngine \*m\_pQuicEngine;
 HttpServerImpl(const HttpServerImpl &rhs); void operator=(const HttpServerImpl &rhs);
 // interface functions HttpServerImpl(HttpServer \*pServer) : m\_sSwapDirectory(DEFAULT\_SWAP\_DIR) , m\_pri\_gid(0) , m\_pQuicEngine(NULL) { ClientCache::initObjPool(); ExtAppRegistry::init(); HttpMime::setMime(&m\_httpMime); m\_serverContext.allocateInternal(); HttpRespHeaders::buildCommonHeaders(); m\_sRTReportFile = DEFAULT\_TMP\_DIR "/.rtreport"; SslContext::setSniLookupCb(VHostMapFindSslContext); memset(m\_pAutoUpdFetch, 0, sizeof(m\_pAutoUpdFetch)); }
 ~HttpServerImpl() { }
 int initAdns() { ServerProcessConfig &procConfig = ServerProcessConfig::getInstance(); if (Adns::getInstance().init() == -1) return LS\_FAIL; if (Adns::getInstance().initShm(procConfig.getUid(), procConfig.getGid()) == -1) return LS\_FAIL; MultiplexerFactory::getMultiplexer()->add(&Adns::getInstance(), POLLIN | POLLHUP | POLLERR); return 0; }
 int initAioSendFile() { HttpAioSendFile \*pHasf = new HttpAioSendFile(); if (pHasf->initNotifier(MultiplexerFactory::getMultiplexer())) return LS\_FAIL; else if (pHasf->startProcessor()) return LS\_FAIL; HttpAioSendFile::setHttpAioSendFile(pHasf); return HttpResourceManager::getInstance().initAiosfcbPool(); }
 void releaseAll(); int isServerOk(); int setupSwap(); void setSwapDir(const char \*pDir); const char \*getSwapDir() const { return m\_sSwapDirectory.c\_str(); }
 int start(); int shutdown(); void adjustListeners(int iNumChildren); int gracefulShutdown(); int generateStatusReport(); void setRTReportName(int proc); int generateRTReport(); int generateProcessReport(int fd); HttpListener \*newTcpListener(const char \*pName, const char \*pAddr, int reuseport);
 HttpListener \*addListener(const char \*pName, const char \*pAddr, int reuseport); HttpListener \*addListener(const char \*pName) { return addListener(pName, pName, 1); }
 int removeListener(const char \*pName);
 HttpListener \*getListener(const char \*pName) { return m\_listeners.get(pName, NULL); }
 int addVHost(HttpVHost \*pVHost); int removeVHost(const char \*pName); HttpVHost \*getVHost(const char \*pName) const { return m\_vhosts.get(pName); }
 int enableVHost(const char \*pVHostName, int enable); int updateVHost(const char \*pVHostName, HttpVHost \*pVHost); void updateMapping(); void beginConfig(); void endConfig(int error); void offsetChroot();
 int removeVHostFromListener(const char \*pListenerName, const char \*pVHostName); int mapListenerToVHost(const char \*pListenerName, const char \*pKey, const char \*pVHostName); int mapListenerToVHost(HttpListener \*pListener, const char \*pKey, const char \*pVHostName); int mapListenerToVHost(HttpListener \*pListener, HttpVHost \*pVHost, const char \*pDomains);
 void checkOLSUpdate(); void onTimer(); void onTimer60Secs(); void onTimer30Secs(); void onTimer10Secs(); void onTimerSecond();
 void setBlackBoard(char \*pBB);
 int restartMark(int cmd);
 int cleanUp(int pid, char \*pBlackBoard); int initSampleServer(); int initLscpd(); int reinitMultiplexer(); int authAdminReq(char \*pAuth);
 void recycleContext(HttpContext \*pContext) { pContext->setLastMod(DateTime::s\_curTime); m\_toBeReleasedContext.add(pContext, 1); } int addVirtualHostMapping(HttpListener \*pListener, const char \*value, const char \*pVHostName); int addVirtualHostMapping(HttpListener \*pListener, const XmlNode \*pNode, const char \*pVHostName); int configVirtualHostMappings(HttpListener \*pListener, const XmlNode \*pNode, const char \*pVHostName); int configListenerVHostMap(const XmlNode \*pRoot, const char \*pVHostName);
 void configCRL(const XmlNode \*pNode, SslContext \*pSsl); SslContext \*newSSLContext(const XmlNode \*pNode, const char \*pName, SslContext \*pOldContext); int initOcspCachePath(); int configStapling(const XmlNode \*pNode, SslContextConfig \*pConf);
 int enableQuicListener(HttpListener \*pListener); HttpListener \*configListener(const XmlNode \*pNode, int isAdmin); int configListeners(const XmlNode \*pRoot, int isAdmin);
 int startAdminListener(const XmlNode \*pRoot, const char \*pName); int startListeners(const XmlNode \*pRoot);
 void mapDomainList(const XmlNode \*pListenerNodes, HttpVHost \*pVHost); int enableWebConsole(); void setAdminThrottleLimits(HttpVHost \*pVHostAdmin); HttpVHost \*createAdminVhost(LocalWorker \*pFcgiApp, int iChrootLen, char \*pchPHPBin, size\_t phpBinLen); LocalWorker \*createAdminPhpApp(const char \*pChroot, int iChrootLen, const char \*pURI, char \*pchPHPBin, size\_t szPhpBin); const char \*configAdminPhpUri(const XmlNode \*pNode); int configAdminConsole(const XmlNode \*pNode); int configSysShmDirs(char \*pConfDir); int configTuning(const XmlNode \*pRoot); void setMaxConns(int32\_t conns); void setMaxSSLConns(int32\_t conns); int configSecurity(const XmlNode \*pRoot); int configAccessDeniedDir(const XmlNode \*pNode);
 void maybeDownloadQuicCloudTrustIp(); static int asyncDownloadQuicCloudIpCb(void \*pArg, HttpFetch \*pHttpFetch); void asyncDownloadQuicCloudTrustIp(); int downloadQuicCloudTrustIp(); void gracefulRestartIfIpsChange(); void updateQuicCloudTrustIp(bool force); void addCfTrustIp(); void addLocalTrustIp(); void detectAllIps();
 int denyAccessFiles(HttpVHost \*pVHost, const char \*pFile, int regex); int configMime(const XmlNode \*pRoot); void testAndFixDirs(const char \*pSuffix, uid\_t uid, gid\_t gid, mode\_t mod); void fixConfDirsPermission();
 int configServerBasic2(const XmlNode \*pRoot, const char \*pSwapDir); int configMultiplexer(const XmlNode \*pNode); void configVHTemplateToListenerMap(const XmlNodeList \*pList, TPointerList<HttpListener> &listeners, XmlNode \*pVhConfNode, XmlNode \*pTmpConfNode, const char \*pTemplateName); int configVHTemplate(const XmlNode \*pNode); int configVHTemplates(const XmlNode \*pRoot); int configVHosts(const XmlNode \*pRoot); int configServerBasics(int reconfig, const XmlNode \*pRoot); int configModules(const XmlNode \*pRoot); int initGroups(); int loadAdminConfig(XmlNode \*pRoot); int configIpToGeo(const XmlNode \*pNode); int configIpToLoc(const XmlNode \*pNode); int configChroot(const XmlNode \*pRoot); int configServer(int reconfig, XmlNode \*pRoot); void enableCoreDump(); int changeUserChroot();// int reconfigVHost( const char \*pVHostName, HttpVHost \* &pVHost, XmlNode\* pRoot );// void reconfigVHost( char \*pVHostName, XmlNode\* pRoot ); void setServerRoot(const char \*pRoot); int initServer(XmlNode \*pRoot, int reconfig); int initServer(XmlNode \*pRoot, int &iReleaseXmlTree, int reconfig);
 void chmodDirToAll(const char \*path, struct stat &sb); void verifyStatDir(const char \*path);
 void configZconfSvrConf(const XmlNode \*pRoot);
 int configLsrecaptchaWorker(const XmlNode \*pNode); int configLsrecaptchaContexts(); int initLsrecaptcha(const XmlNode \* pNode);
 int initQuic(const XmlNode \*pNode); void initQuicEngine(const char \*pShmDir, const struct lsquic\_engine\_settings \*settings, const char \*quicLogLevel);
public: void hideServerSignature(int sv);
 void addQuicEngine(QuicEngine \*pEngine) { m\_pQuicEngine = pEngine; }
 QuicEngine \*getQuicEngine() const { return m\_pQuicEngine; }
};
#include <http/userdir.h>#include <http/reqparserparam.h>#include <http/httplistener.h>#include <http/httplistener.h>
int HttpServerImpl::authAdminReq(char \*pAuth){ char \*pEnd = strchr(pAuth, '\n'); if (strncasecmp(pAuth, "auth:", 5) != 0) { LS\_ERROR("[ADMIN] missing authentication."); return LS\_FAIL; } if (!pEnd) { LS\_ERROR("[ADMIN] missing '\n' in authentication request."); return LS\_FAIL; } char \*pUserName = pAuth + 5; char \*pPasswd = (char \*)memchr(pUserName, ':', pEnd - pUserName); int nameLen; if (!pPasswd) { LS\_ERROR("[ADMIN] invald authenticator."); return LS\_FAIL; } nameLen = pPasswd - pUserName; \*pPasswd++ = 0; HttpVHost \*pAdmin = m\_vhosts.get(DEFAULT\_ADMIN\_SERVER\_NAME); if (!pAdmin) { LS\_ERROR("[ADMIN] missing admin vhost."); return LS\_FAIL; } UserDir \*pRealm = pAdmin->getRealm(ADMIN\_USERDB); if (!pRealm) { LS\_ERROR("[ADMIN] missing authentication realm."); return LS\_FAIL; } \*pEnd = 0; int ret = pRealm->authenticate(NULL, pUserName, nameLen, pPasswd, ENCRYPT\_PLAIN, NULL); if (ret != 0) { LS\_DBG("[ADMIN] UserName %.\*s, Password %s", nameLen, pUserName, pPasswd); LS\_ERROR("[ADMIN] authentication failed!"); } \*pEnd = '\n'; return ret;}
void HttpServerImpl::setSwapDir(const char \*pDir){ if (pDir) { m\_sSwapDirectory = pDir; chown(m\_sSwapDirectory.c\_str(), ServerProcessConfig::getInstance().getUid(), ServerProcessConfig::getInstance().getGid()); }}
int HttpServerImpl::start(){ m\_pid = getpid(); DateTime::s\_curTime = time(NULL); HttpSignals::init(sigchild); HttpCgiTool::buildServerEnv(); if (isServerOk() == -1) return LS\_FAIL; LS\_NOTICE("Setup swapping space..."); if (setupSwap() == - 1) { LS\_ERROR("Failed to setup swapping space!"); return LS\_FAIL; } LS\_NOTICE("%s starts successfully!", HttpServerVersion::getVersion()); ConnLimitCtrl::getInstance().setListeners(&m\_listeners); m\_lStartTime = time(NULL);
 // if child 1 if (1 == HttpServerConfig::getInstance().getProcNo()) ZConfManager::getInstance().sendStartUp(); m\_dispatcher.run(); LS\_NOTICE("Start shutting down gracefully ..."); gracefulShutdown(); LS\_NOTICE("Shut down successfully! "); StdErrLogger::getInstance().dupAppenderFdToStdErr(); return 0;
}
int HttpServerImpl::shutdown(){ LS\_NOTICE("Shutting down ...!"); HttpSignals::setSigStop(); return 0;}
void HttpServerImpl::adjustListeners(int iNumChildren){ int n = m\_listeners.size(); for (int i = 0; i < n; ++i) { HttpListener \*p = m\_listeners[i]; p->adjustFds(iNumChildren); }}
int HttpServerImpl::generateStatusReport(){ char achBuf[1024] = ""; if (ServerProcessConfig::getInstance().getChroot() != NULL) { lstrncpy(achBuf, ServerProcessConfig::getInstance().getChroot()->c\_str(), sizeof(achBuf)); } lstrncat(achBuf, sStatDir, sizeof(achBuf)); lstrncat(achBuf, "/.status", sizeof(achBuf)); LOG4CXX\_NS::Appender \*pAppender = LOG4CXX\_NS::Appender::getAppender(achBuf); pAppender->setAppendMode(0); if (pAppender->open()) { LS\_ERROR("Failed to open the status report: %s!", achBuf); return LS\_FAIL; } int ret = m\_listeners.writeStatusReport(pAppender->getfd()); if (!ret) ret = m\_vhosts.writeStatusReport(pAppender->getfd()); if (ret) LS\_ERROR("Failed to generate the status report!"); char achBuf1[1024]; ret = snprintf(achBuf1, 1024, "DEBUG\_LOG: %d, VERSION: %s-%s\n", (LS\_LOG\_ENABLED(LOG4CXX\_NS::Level::DBG\_LESS)) ? 1 : 0, PACKAGE\_VERSION, LS\_PLATFORM); pAppender->append(achBuf1, ret);
 pAppender->append("EOF\n", 4); pAppender->close(); return 0;}
int generateConnReport(int fd){ ConnLimitCtrl &ctrl = ConnLimitCtrl::getInstance(); char achBuf[4096]; int SSLConns = ctrl.getMaxSSLConns() - ctrl.availSSLConn(); HttpStats::getReqStats()->finalizeRpt(); if (ctrl.getMaxConns() - ctrl.availConn() - HttpStats::getIdleConns() < 0) HttpStats::setIdleConns(ctrl.getMaxConns() - ctrl.availConn()); int n = ls\_snprintf(achBuf, 4096, "BPS\_IN: %ld, BPS\_OUT: %ld, " "SSL\_BPS\_IN: %ld, SSL\_BPS\_OUT: %ld\n" "MAXCONN: %d, MAXSSL\_CONN: %d, PLAINCONN: %d, " "AVAILCONN: %d, IDLECONN: %d, SSLCONN: %d, AVAILSSL: %d\n" "REQ\_RATE []: REQ\_PROCESSING: %d, REQ\_PER\_SEC: %d, TOT\_REQS: %d, " "PUB\_CACHE\_HITS\_PER\_SEC: %d, TOTAL\_PUB\_CACHE\_HITS: %d, " "PRIVATE\_CACHE\_HITS\_PER\_SEC: %d, TOTAL\_PRIVATE\_CACHE\_HITS: %d, " "STATIC\_HITS\_PER\_SEC: %d, TOTAL\_STATIC\_HITS: %d\n",
 HttpStats::getBytesRead() / 1024, HttpStats::getBytesWritten() / 1024, HttpStats::getSSLBytesRead() / 1024, HttpStats::getSSLBytesWritten() / 1024, ctrl.getMaxConns(), ctrl.getMaxSSLConns(), ctrl.getMaxConns() - SSLConns - ctrl.availConn(), ctrl.availConn(), HttpStats::getIdleConns(), SSLConns, ctrl.availSSLConn(), ctrl.getMaxConns() - ctrl.availConn() - HttpStats::getIdleConns(), HttpStats::getReqStats()->getRPS(), HttpStats::getReqStats()->getTotal(),
 HttpStats::getReqStats()->getPubHitsPS(), HttpStats::getReqStats()->getTotalPubHits(), HttpStats::getReqStats()->getPrivHitsPS(), HttpStats::getReqStats()->getTotalPrivHits(), HttpStats::getReqStats()->getHitsPS(), HttpStats::getReqStats()->getTotalHits());
 write(fd, achBuf, n);
 HttpStats::setBytesRead(0); HttpStats::setBytesWritten(0); HttpStats::setSSLBytesRead(0); HttpStats::setSSLBytesWritten(0); HttpStats::getReqStats()->reset(); return 0;}
int HttpServerImpl::generateProcessReport(int fd){ char achBuf[4096]; long delta = time(NULL) - m\_lStartTime; long days; int hours, mins, seconds; seconds = delta % 60; delta /= 60; mins = delta % 60; delta /= 60; hours = delta % 24; days = delta / 24; char \*p = achBuf; p += ls\_snprintf(p, &achBuf[4096] - p, "VERSION: LiteSpeed Web Server/%s/%s\n", "Open", PACKAGE\_VERSION); p += ls\_snprintf(p, &achBuf[4096] - p, "UPTIME:");
 if (days) p += ls\_snprintf(p, &achBuf[4096] - p, " %ld day%s", days, (days > 1) ? "s" : ""); p += ls\_snprintf(p, &achBuf[4096] - p, " %02d:%02d:%02d\n", hours, mins, seconds); write(fd, achBuf, p - achBuf); return 0;
}
void HttpServerImpl::setRTReportName(int proc){ if (proc != 1) { char achBuf[256]; ls\_snprintf(achBuf, 256, "%s/.rtreport.%d", sStatDir, proc); m\_sRTReportFile.setStr(achBuf); }}
int HttpServerImpl::generateRTReport(){ LOG4CXX\_NS::Appender \*pAppender = LOG4CXX\_NS::Appender::getAppender( m\_sRTReportFile.c\_str()); pAppender->setAppendMode(0); if (pAppender->open()) { LS\_ERROR("Failed to open the real time report: %s!", m\_sRTReportFile.c\_str()); return LS\_FAIL; } int ret; ret = generateProcessReport(pAppender->getfd()); ret = generateConnReport(pAppender->getfd()); ret = m\_listeners.writeRTReport(pAppender->getfd()); if (!ret) ret = m\_vhosts.writeRTReport(pAppender->getfd()); if (ret) LS\_ERROR("Failed to generate the real time report!"); ret = ExtAppRegistry::generateRTReport(pAppender->getfd()); ret = ClientCache::getClientCache()->generateBlockedIPReport( pAppender->getfd());
 pAppender->append("EOF\n", 4); pAppender->close(); return 0;}
HttpListener \*HttpServerImpl::newTcpListener(const char \*pName, const char \*pAddr, int reuseport){ HttpListener \*pListener = new HttpListener(pName, pAddr); if (pListener == NULL) return pListener; int ret; for (int i = 0; i < 8; ++i) { if (reuseport) pListener->enableReusePort(); ret = pListener->start(); if (!ret) return pListener; if (errno == EACCES) break; ls\_sleep(500); } LS\_ERROR("HttpListener::start(): Can't listen at address %s: %s!", pName, ::strerror(ret)); //LS\_ERROR( "Unable to add listener [%s]!", pName )); delete pListener; return NULL;}
HttpListener \*HttpServerImpl::addListener(const char \*pName, const char \*pAddr, int reuseport){ HttpListener \*pListener = NULL; if (!pName) return NULL; pListener = m\_listeners.get(pName, pAddr); if (pListener) { LS\_NOTICE("Reuse existing Listener [%s] [%s].", pName, pAddr); return pListener; } pListener = m\_oldListeners.get(pName, pAddr); if (!pListener) { pListener = newTcpListener(pName, pAddr, reuseport); if (pListener) LS\_NOTICE("Created new Listener [%s].", pName); else { LS\_ERROR("HttpServer::addListener(%s) failed to create new listener" , pName); return NULL; } } else { LS\_NOTICE("Reuse current listener [%s].", pName); pListener->beginConfig(); if (reuseport) pListener->enableReusePort(); m\_oldListeners.remove(pListener); } m\_listeners.add(pListener); return pListener;}
int HttpServerImpl::removeListener(const char \*pName){ HttpListener \*pListener = m\_listeners.get(pName, NULL); if (pListener != NULL) { LS\_DBG\_L("Removed listener [%s].", pName); m\_listeners.remove(pListener); pListener->stop(); if (pListener->getVHostMap()->getRef() > 0) m\_toBeReleasedListeners.add(pListener); else delete pListener; } return 0;}
int HttpServerImpl::addVHost(HttpVHost \*pVHost){ assert(pVHost);// if ( m\_vhosts.size() > MAX\_VHOSTS )// {// return LS\_FAIL;// } int ret = m\_vhosts.add(pVHost); return ret;}
int HttpServerImpl::updateVHost(const char \*pVHostName, HttpVHost \*pVHost){ HttpVHost \*pOld = getVHost(pVHostName); if (pOld) { m\_vhosts.remove(pOld); pVHost->enable(pOld->isEnabled()); m\_listeners.removeVHostMappings(pOld); assert(pOld->getMappingRef() == 0); if (pOld->getRef() > 0) { pOld->getAccessLog()->setAsyncAccessLog(0); m\_toBeReleasedVHosts.push\_back(pOld); } else delete pOld; } return addVHost(pVHost);
}
int HttpServerImpl::removeVHost(const char \*pName){ HttpVHost \*pVHost = getVHost(pName); if (pVHost != NULL) { int ret = m\_vhosts.remove(pVHost); if (ret) { LS\_ERROR("HttpServer::removeVHost(): virtual host %s failed! ", pName); } else LS\_DBG\_L("Removed virtual host %s!", pName); return ret; } else return 0;}
int HttpServerImpl::mapListenerToVHost(HttpListener \*pListener, HttpVHost \*pVHost, const char \*pDomains){ if (!pListener) return LS\_FAIL; return pListener->mapDomainList(pVHost, pDomains);}
int HttpServerImpl::mapListenerToVHost(HttpListener \*pListener, const char \*pKey, const char \*pVHostName){ HttpVHost \*pVHost = getVHost(pVHostName); return mapListenerToVHost(pListener, pVHost, pKey);}
int HttpServerImpl::mapListenerToVHost(const char \*pListenerName, const char \*pKey, const char \*pVHostName){ HttpListener \*pListener = getListener(pListenerName); return mapListenerToVHost(pListener, pKey, pVHostName);}
int HttpServerImpl::removeVHostFromListener(const char \*pListenerName, const char \*pVHostName){ HttpListener \*pListener = getListener(pListenerName); HttpVHost \*pVHost = getVHost(pVHostName); if ((pListener == NULL) || (pVHost == NULL)) return EINVAL; int ret = pListener->getVHostMap()->removeVHost(pVHost); LS\_ERROR("Deassociates [%s] with [%s] on %s!", pVHostName, pListenerName, (ret ? "failed" : "succeed")); return ret;}
void HttpServerImpl::beginConfig(){ assert(m\_oldListeners.size() == 0); m\_oldListeners.swap(m\_listeners); m\_vhosts.swap(m\_orgVHosts); HttpVHost \*pVHost = m\_orgVHosts.get(DEFAULT\_ADMIN\_SERVER\_NAME); if (pVHost) { m\_orgVHosts.remove(pVHost); m\_vhosts.add(pVHost); } //ClientCache::getClientCache()->dirtyAll();}
void HttpServerImpl::updateMapping(){ int n = m\_listeners.size(); for (int i = 0; i < n; ++i) m\_listeners[i]->getVHostMap()->updateMapping(m\_vhosts);}
void HttpServerImpl::endConfig(int error){ if (error) { m\_vhosts.moveNonExist(m\_orgVHosts); m\_listeners.moveNonExist(m\_oldListeners); updateMapping(); } m\_oldListeners.saveInUseListnersTo(m\_toBeReleasedListeners); m\_orgVHosts.appendTo(m\_toBeReleasedVHosts); m\_listeners.endConfig(); ServerAddrRegistry::getInstance().init(&m\_listeners);}
int HttpServerImpl::enableVHost(const char \*pVHostName, int enable){ HttpVHost \*pVHost = getVHost(pVHostName); if (pVHost) { pVHost->enable(enable); return 0; } return LS\_FAIL;}
void HttpServerImpl::onTimerSecond(){ HttpRespHeaders::updateDateHeader(); HttpLog::onTimer(); ClientCache::getClientCache()->onTimer(); m\_vhosts.onTimer(); if (m\_lStartTime > 0) generateRTReport();
 ServerInfo::getServerInfo()->setAdnsOp(1); Adns::getInstance().trimCache(); ServerInfo::getServerInfo()->setAdnsOp(0);}
void HttpServerImpl::onTimer10Secs(){ ExtAppRegistry::onTimer(); HttpResourceManager::getInstance().onTimer(); static int s\_timeOut = 3; s\_timeOut --; if (!s\_timeOut) { s\_timeOut = 3; onTimer30Secs(); }}
void HttpServerImpl::onTimer30Secs(){ /\*\*\* \* When server is quiting, do nothing \*/ if (m\_lStartTime <= 0) return ;
 ClientCache::getClientCache()->onTimer30Secs(); StaticFileCache::getInstance().onTimer(); m\_vhosts.onTimer30Secs(); static int s\_timeOut = 2; s\_timeOut --; if (!s\_timeOut)[View remainder of file in raw view](https://github.com/litespeedtech/openlitespeed/raw/refs/tags/v1.7.16.1/src/main/httpserver.cpp)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a1874b5f_20250114_202820.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flitespeedtech%2Fopenlitespeed%2Fblob%2Fv1.7.16%2Fsrc%2Fmain%2Fhttpserver.cpp)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flitespeedtech%2Fopenlitespeed%2Fblob%2Fv1.7.16%2Fsrc%2Fmain%2Fhttpserver.cpp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=litespeedtech%2Fopenlitespeed)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[litespeedtech](/litespeedtech)
/
**[openlitespeed](/litespeedtech/openlitespeed)**
Public

* [Notifications](/login?return_to=%2Flitespeedtech%2Fopenlitespeed) You must be signed in to change notification settings
* [Fork
  195](/login?return_to=%2Flitespeedtech%2Fopenlitespeed)
* [Star
   1.2k](/login?return_to=%2Flitespeedtech%2Fopenlitespeed)

* [Code](/litespeedtech/openlitespeed/tree/v1.7.16)
* [Issues
  71](/litespeedtech/openlitespeed/issues)
* [Pull requests
  2](/litespeedtech/openlitespeed/pulls)
* [Actions](/litespeedtech/openlitespeed/actions)
* [Projects
  0](/litespeedtech/openlitespeed/projects)
* [Wiki](/litespeedtech/openlitespeed/wiki)
* [Security](/litespeedtech/openlitespeed/security)
* [Insights](/litespeedtech/openlitespeed/pulse)

Additional navigation options

* [Code](/litespeedtech/openlitespeed/tree/v1.7.16)
* [Issues](/litespeedtech/openlitespeed/issues)
* [Pull requests](/litespeedtech/openlitespeed/pulls)
* [Actions](/litespeedtech/openlitespeed/actions)
* [Projects](/litespeedtech/openlitespeed/projects)
* [Wiki](/litespeedtech/openlitespeed/wiki)
* [Security](/litespeedtech/openlitespeed/security)
* [Insights](/litespeedtech/openlitespeed/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


