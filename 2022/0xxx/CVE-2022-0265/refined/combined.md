=== Content from huntr.dev_b04c2c12_20250114_193553.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)

=== Content from github.com_0ce71c1f_20250114_193552.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhazelcast%2Fhazelcast%2Fcommit%2F4d6b666cd0291abd618c3b95cdbb51aa4208e748)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhazelcast%2Fhazelcast%2Fcommit%2F4d6b666cd0291abd618c3b95cdbb51aa4208e748)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=hazelcast%2Fhazelcast)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[hazelcast](/hazelcast)
/
**[hazelcast](/hazelcast/hazelcast)**
Public

* [Notifications](/login?return_to=%2Fhazelcast%2Fhazelcast) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Fhazelcast%2Fhazelcast)
* [Star
   6.2k](/login?return_to=%2Fhazelcast%2Fhazelcast)

* [Code](/hazelcast/hazelcast)
* [Issues
  1.2k](/hazelcast/hazelcast/issues)
* [Pull requests
  4](/hazelcast/hazelcast/pulls)
* [Discussions](/hazelcast/hazelcast/discussions)
* [Actions](/hazelcast/hazelcast/actions)
* [Wiki](/hazelcast/hazelcast/wiki)
* [Security](/hazelcast/hazelcast/security)
* [Insights](/hazelcast/hazelcast/pulse)

Additional navigation options

* [Code](/hazelcast/hazelcast)
* [Issues](/hazelcast/hazelcast/issues)
* [Pull requests](/hazelcast/hazelcast/pulls)
* [Discussions](/hazelcast/hazelcast/discussions)
* [Actions](/hazelcast/hazelcast/actions)
* [Wiki](/hazelcast/hazelcast/wiki)
* [Security](/hazelcast/hazelcast/security)
* [Insights](/hazelcast/hazelcast/pulse)

## Commit

[Permalink](/hazelcast/hazelcast/commit/4d6b666cd0291abd618c3b95cdbb51aa4208e748)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add helper method to XmlUtil to enable XXE protection in the SAXParse…

[Browse files](/hazelcast/hazelcast/tree/4d6b666cd0291abd618c3b95cdbb51aa4208e748)
Browse the repository at this point in the history

```
…rFactory and XMLInputFactory ([#20407](https://github.com/hazelcast/hazelcast/pull/20407))
```

* Loading branch information

[![@kwart](https://avatars.githubusercontent.com/u/962661?s=40&v=4)](/kwart)

[kwart](/hazelcast/hazelcast/commits?author=kwart "View all commits by kwart")
authored
Jan 19, 2022

1 parent
[7e7f00b](/hazelcast/hazelcast/commit/7e7f00be7b5ed17b2afce73b5b14598e45350175)

commit 4d6b666

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**213 additions**
and
**48 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* hazelcast/src

  + main/java/com/hazelcast/internal

    - config

      * hazelcast/src/main/java/com/hazelcast/internal/config/AbstractXmlConfigRootTagRecognizer.java
        [AbstractXmlConfigRootTagRecognizer.java](#diff-d3e1cf69cb092f007e0c7373804035f0f354e3fd315487f04f7c4d89c5965f6e)
    - util

      * hazelcast/src/main/java/com/hazelcast/internal/util/XmlUtil.java
        [XmlUtil.java](#diff-0dc708582772308fc78fa7748b789dad38cb7517a04c5a28600eb10bf99cedb8)
  + test/java/com/hazelcast/internal/util

    - hazelcast/src/test/java/com/hazelcast/internal/util/XmlUtilTest.java
      [XmlUtilTest.java](#diff-f0939dfa972f2ec8d0c47d08ab56e8ceb2cda4b21eec92617b0aa6a917d7ffe7)

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[...lcast/src/main/java/com/hazelcast/internal/config/AbstractXmlConfigRootTagRecognizer.java](#diff-d3e1cf69cb092f007e0c7373804035f0f354e3fd315487f04f7c4d89c5965f6e "hazelcast/src/main/java/com/hazelcast/internal/config/AbstractXmlConfigRootTagRecognizer.java")

Show comments

[View file](/hazelcast/hazelcast/blob/4d6b666cd0291abd618c3b95cdbb51aa4208e748/hazelcast/src/main/java/com/hazelcast/internal/config/AbstractXmlConfigRootTagRecognizer.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,7 @@ |
|  |  |  |
|  |  | import com.hazelcast.config.ConfigRecognizer; |
|  |  | import com.hazelcast.config.ConfigStream; |
|  |  | import com.hazelcast.internal.util.XmlUtil; |
|  |  | import com.hazelcast.logging.ILogger; |
|  |  | import com.hazelcast.logging.Logger; |
|  |  | import org.xml.sax.Attributes; |
| Expand Down  Expand Up | | @@ -54,7 +55,7 @@ public class AbstractXmlConfigRootTagRecognizer implements ConfigRecognizer { |
|  |  |  |
|  |  | public AbstractXmlConfigRootTagRecognizer(String expectedRootNode) throws Exception { |
|  |  | this.expectedRootNode = expectedRootNode; |
|  |  | SAXParserFactory factory = SAXParserFactory.newInstance(); |
|  |  | SAXParserFactory factory = XmlUtil.getSAXParserFactory(); |
|  |  | saxParser = factory.newSAXParser(); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

113 changes: 69 additions & 44 deletions

113
[hazelcast/src/main/java/com/hazelcast/internal/util/XmlUtil.java](#diff-0dc708582772308fc78fa7748b789dad38cb7517a04c5a28600eb10bf99cedb8 "hazelcast/src/main/java/com/hazelcast/internal/util/XmlUtil.java")

Show comments

[View file](/hazelcast/hazelcast/blob/4d6b666cd0291abd618c3b95cdbb51aa4208e748/hazelcast/src/main/java/com/hazelcast/internal/util/XmlUtil.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -25,6 +25,8 @@ |
|  |  | import javax.xml.XMLConstants; |
|  |  | import javax.xml.parsers.DocumentBuilderFactory; |
|  |  | import javax.xml.parsers.ParserConfigurationException; |
|  |  | import javax.xml.parsers.SAXParserFactory; |
|  |  | import javax.xml.stream.XMLInputFactory; |
|  |  | import javax.xml.transform.ErrorListener; |
|  |  | import javax.xml.transform.OutputKeys; |
|  |  | import javax.xml.transform.Source; |
| Expand All | | @@ -41,7 +43,10 @@ |
|  |  | import com.hazelcast.logging.Logger; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Utility class for XML processing. |
|  |  | \* Utility class for XML processing. It contains several methods to retrieve XML processing factories with XXE protection |
|  |  | \* enabled (based on recommendation in the |
|  |  | \* <a href="https://cheatsheetseries.owasp.org/cheatsheets/XML\_External\_Entity\_Prevention\_Cheat\_Sheet.html">OWASP XXE prevention |
|  |  | \* cheat-sheet</a>). |
|  |  | \*/ |
|  |  | public final class XmlUtil { |
|  |  |  |
| Expand All | | @@ -55,6 +60,7 @@ public final class XmlUtil { |
|  |  | \*/ |
|  |  | public static final String SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES = "hazelcast.ignoreXxeProtectionFailures"; |
|  |  |  |
|  |  | private static final String FEATURES\_DISALLOW\_DOCTYPE = "http://apache.org/xml/features/disallow-doctype-decl"; |
|  |  | private static final ILogger LOGGER = Logger.getLogger(XmlUtil.class); |
|  |  |  |
|  |  | private XmlUtil() { |
| Expand All | | @@ -68,7 +74,7 @@ private XmlUtil() { |
|  |  | public static DocumentBuilderFactory getNsAwareDocumentBuilderFactory() throws ParserConfigurationException { |
|  |  | DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance(); |
|  |  | dbf.setNamespaceAware(true); |
|  |  | setFeature(dbf, "http://apache.org/xml/features/disallow-doctype-decl"); |
|  |  | setFeature(dbf, FEATURES\_DISALLOW\_DOCTYPE); |
|  |  | return dbf; |
|  |  | } |
|  |  |  |
| Expand All | | @@ -92,6 +98,24 @@ public static SchemaFactory getSchemaFactory() throws SAXException { |
|  |  | return schemaFactory; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns {@link SAXParserFactory} with XXE protection enabled. |
|  |  | \*/ |
|  |  | public static SAXParserFactory getSAXParserFactory() throws ParserConfigurationException, SAXException { |
|  |  | SAXParserFactory factory = SAXParserFactory.newInstance(); |
|  |  | setFeature(factory, FEATURES\_DISALLOW\_DOCTYPE); |
|  |  | return factory; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns {@link XMLInputFactory} with XXE protection enabled. |
|  |  | \*/ |
|  |  | public static XMLInputFactory getXMLInputFactory() { |
|  |  | XMLInputFactory xmlInputFactory = XMLInputFactory.newInstance(); |
|  |  | setProperty(xmlInputFactory, XMLInputFactory.SUPPORT\_DTD, false); |
|  |  | return xmlInputFactory; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Formats given XML String with the given indentation used. If the {@code input} XML string is {@code null}, or |
|  |  | \* {@code indent} parameter is negative, or XML transformation fails, then the original value is returned unchanged. The |
| Expand Down  Expand Up | | @@ -166,62 +190,63 @@ static void setAttribute(TransformerFactory transformerFactory, String attribute |
|  |  | try { |
|  |  | transformerFactory.setAttribute(attributeName, ""); |
|  |  | } catch (IllegalArgumentException iae) { |
|  |  | if (Boolean.getBoolean(SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES)) { |
|  |  | LOGGER.warning("Enabling XXE protection failed. The attribute " + attributeName |
|  |  | + " is not supported by the TransformerFactory. The " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property is used so the XML processing continues in the UNSECURE mode" |
|  |  | + " with XXE protection disabled!!!"); |
|  |  | } else { |
|  |  | LOGGER.severe("Enabling XXE protection failed. The attribute " + attributeName |
|  |  | + " is not supported by the TransformerFactory. This usually mean an outdated XML processor" |
|  |  | + " is present on the classpath (e.g. Xerces, Xalan). If you are not able to resolve the issue by" |
|  |  | + " fixing the classpath, the " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property can be used to disable XML External Entity protections." |
|  |  | + " We don't recommend disabling the XXE as such the XML processor configuration is unsecure!!!", iae); |
|  |  | throw iae; |
|  |  | } |
|  |  | printWarningAndRethrowEventually(iae, TransformerFactory.class, "attribute " + attributeName); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static void setFeature(DocumentBuilderFactory dbf, String featureName) throws ParserConfigurationException { |
|  |  | try { |
|  |  | dbf.setFeature(featureName, true); |
|  |  | } catch (ParserConfigurationException e) { |
|  |  | if (Boolean.getBoolean(SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES)) { |
|  |  | LOGGER.warning("Enabling XXE protection failed. The feature " + featureName |
|  |  | + " is not supported by the DocumentBuilderFactory. The " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property is used so the XML processing continues in the UNSECURE mode" |
|  |  | + " with XXE protection disabled!!!"); |
|  |  | } else { |
|  |  | LOGGER.severe("Enabling XXE protection failed. The feature " + featureName |
|  |  | + " is not supported by the DocumentBuilderFactory. This usually mean an outdated XML processor" |
|  |  | + " is present on the classpath (e.g. Xerces, Xalan). If you are not able to resolve the issue by" |
|  |  | + " fixing the classpath, the " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property can be used to disable XML External Entity protections." |
|  |  | + " We don't recommend disabling the XXE as such the XML processor configuration is unsecure!!!", e); |
|  |  | throw e; |
|  |  | } |
|  |  | printWarningAndRethrowEventually(e, DocumentBuilderFactory.class, "feature " + featureName); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static void setFeature(SAXParserFactory saxParserFactory, String featureName) |
|  |  | throws ParserConfigurationException, SAXException { |
|  |  | try { |
|  |  | saxParserFactory.setFeature(featureName, true); |
|  |  | } catch (SAXException e) { |
|  |  | printWarningAndRethrowEventually(e, SAXParserFactory.class, "feature " + featureName); |
|  |  | } catch (ParserConfigurationException e) { |
|  |  | printWarningAndRethrowEventually(e, SAXParserFactory.class, "feature " + featureName); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static void setProperty(SchemaFactory schemaFactory, String propertyName) throws SAXException { |
|  |  | try { |
|  |  | schemaFactory.setProperty(propertyName, ""); |
|  |  | } catch (SAXException e) { |
|  |  | if (Boolean.getBoolean(SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES)) { |
|  |  | LOGGER.warning("Enabling XXE protection failed. The property " + propertyName |
|  |  | + " is not supported by the SchemaFactory. The " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property is used so the XML processing continues in the UNSECURE mode" |
|  |  | + " with XXE protection disabled!!!"); |
|  |  | } else { |
|  |  | LOGGER.severe("Enabling XXE protection failed. The property " + propertyName |
|  |  | + " is not supported by the SchemaFactory. This usually mean an outdated XML processor" |
|  |  | + " is present on the classpath (e.g. Xerces, Xalan). If you are not able to resolve the issue by" |
|  |  | + " fixing the classpath, the " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property can be used to disable XML External Entity protections." |
|  |  | + " We don't recommend disabling the XXE as such the XML processor configuration is unsecure!!!", e); |
|  |  | throw e; |
|  |  | } |
|  |  | printWarningAndRethrowEventually(e, SchemaFactory.class, "property " + propertyName); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static void setProperty(XMLInputFactory xmlInputFactory, String propertyName, Object value) { |
|  |  | try { |
|  |  | xmlInputFactory.setProperty(propertyName, value); |
|  |  | } catch (IllegalArgumentException e) { |
|  |  | printWarningAndRethrowEventually(e, XMLInputFactory.class, "property " + propertyName); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private static <T extends Exception> void printWarningAndRethrowEventually(T cause, Class<?> clazz, String objective) |
|  |  | throws T { |
|  |  | String className = clazz.getSimpleName(); |
|  |  | if (Boolean.getBoolean(SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES)) { |
|  |  | LOGGER.warning("Enabling XXE protection failed. The " + objective + " is not supported by the " + className |
|  |  | + ". The " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property is used so the XML processing continues in the UNSECURE mode" |
|  |  | + " with XXE protection disabled!!!"); |
|  |  | } else { |
|  |  | LOGGER.severe( |
|  |  | "Enabling XXE protection failed. The " + objective + " is not supported by the " + className |
|  |  | + ". This usually mean an outdated XML processor" |
|  |  | + " is present on the classpath (e.g. Xerces, Xalan). If you are not able to resolve the issue by" |
|  |  | + " fixing the classpath, the " + SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES |
|  |  | + " system property can be used to disable XML External Entity protections." |
|  |  | + " We don't recommend disabling the XXE as such the XML processor configuration is unsecure!", |
|  |  | cause); |
|  |  | throw cause; |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

145 changes: 142 additions & 3 deletions

145
[hazelcast/src/test/java/com/hazelcast/internal/util/XmlUtilTest.java](#diff-f0939dfa972f2ec8d0c47d08ab56e8ceb2cda4b21eec92617b0aa6a917d7ffe7 "hazelcast/src/test/java/com/hazelcast/internal/util/XmlUtilTest.java")

Show comments

[View file](/hazelcast/hazelcast/blob/4d6b666cd0291abd618c3b95cdbb51aa4208e748/hazelcast/src/test/java/com/hazelcast/internal/util/XmlUtilTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,19 +18,39 @@ |
|  |  |  |
|  |  | import static com.hazelcast.internal.util.XmlUtil.SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES; |
|  |  | import static com.hazelcast.internal.util.XmlUtil.format; |
|  |  | import static java.nio.charset.StandardCharsets.UTF\_8; |
|  |  | import static org.hamcrest.MatcherAssert.assertThat; |
|  |  | import static org.junit.Assert.assertEquals; |
|  |  | import static org.junit.Assert.assertNotNull; |
|  |  | import static org.junit.Assert.assertThrows; |
|  |  |  |
|  |  | import java.io.IOException; |
|  |  | import java.io.StringReader; |
|  |  | import java.net.InetAddress; |
|  |  | import java.net.ServerSocket; |
|  |  | import java.net.Socket; |
|  |  | import java.util.concurrent.atomic.AtomicInteger; |
|  |  |  |
|  |  | import javax.xml.parsers.DocumentBuilder; |
|  |  | import javax.xml.parsers.DocumentBuilderFactory; |
|  |  | import javax.xml.parsers.ParserConfigurationException; |
|  |  | import javax.xml.parsers.SAXParser; |
|  |  | import javax.xml.parsers.SAXParserFactory; |
|  |  | import javax.xml.stream.XMLEventReader; |
|  |  | import javax.xml.stream.XMLInputFactory; |
|  |  | import javax.xml.stream.XMLStreamException; |
|  |  | import javax.xml.transform.TransformerFactory; |
|  |  | import javax.xml.validation.SchemaFactory; |
|  |  |  |
|  |  | import org.fusesource.hawtbuf.ByteArrayInputStream; |
|  |  | import org.hamcrest.Matchers; |
|  |  | import org.junit.After; |
|  |  | import org.junit.Before; |
|  |  | import org.junit.Rule; |
|  |  | import org.junit.Test; |
|  |  | import org.junit.experimental.categories.Category; |
|  |  | import org.junit.runner.RunWith; |
|  |  | import org.xml.sax.HandlerBase; |
|  |  | import org.xml.sax.SAXException; |
|  |  |  |
|  |  | import com.hazelcast.test.HazelcastSerialClassRunner; |
| Expand All | | @@ -45,6 +65,30 @@ public class XmlUtilTest { |
|  |  | public OverridePropertyRule ignoreXxeFailureProp = OverridePropertyRule |
|  |  | .clear(SYSTEM\_PROPERTY\_IGNORE\_XXE\_PROTECTION\_FAILURES); |
|  |  |  |
|  |  | private DummyServer server; |
|  |  |  |
|  |  | @Before |
|  |  | public void before() throws IOException { |
|  |  | server = new DummyServer(); |
|  |  | server.start(); |
|  |  | } |
|  |  |  |
|  |  | @After |
|  |  | public void after() { |
|  |  | server.stop(); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testUnprotectedXxe() throws Exception { |
|  |  | DocumentBuilder db = DocumentBuilderFactory.newInstance().newDocumentBuilder(); |
|  |  | try { |
|  |  | db.parse(new ByteArrayInputStream(server.getTestXml().getBytes(UTF\_8))); |
|  |  | } catch (Exception e) { |
|  |  | // not important if it fails |
|  |  | } |
|  |  | assertThat(server.getHits(), Matchers.greaterThan(0)); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testFormat() throws Exception { |
|  |  | assertEquals("<a> <b>c</b></a>", format("<a><b>c</b></a>", 1).replaceAll("[\r\n]", "")); |
| Expand All | | @@ -54,9 +98,9 @@ public void testFormat() throws Exception { |
|  |  | assertThrows(IllegalArgumentException.class, () -> format("<a><b>c</b></a>", 0)); |
|  |  |  |
|  |  | // check if the XXE protection is enabled |
|  |  | String xxeAttack = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" + " <!DOCTYPE test [\n" |
|  |  | + " <!ENTITY xxe SYSTEM \"file:///etc/passwd\">\n" + " ]>" + "<a><b>&xxe;</b></a>"; |
|  |  | assertEquals(xxeAttack, format(xxeAttack, 1)); |
|  |  | String xml = server.getTestXml(); |
|  |  | assertEquals(xml, format(xml, 1)); |
|  |  | assertEquals(0, server.getHits()); |
|  |  |  |
|  |  | // wrongly formatted XML |
|  |  | assertEquals("<a><b>c</b><a>", format("<a><b>c</b><a>", 1)); |
| Expand Down  Expand Up | | @@ -94,4 +138,99 @@ public void testGetDocumentBuilderFactory() throws Exception { |
|  |  | ignoreXxeFailureProp.setOrClearProperty("true"); |
|  |  | XmlUtil.setFeature(dbf, "test://no-such-feature"); |
|  |  | } |
|  |  |  |
|  |  | @SuppressWarnings("deprecation") |
|  |  | @Test |
|  |  | public void testGetSAXParserFactory() throws Exception { |
|  |  | SAXParserFactory saxParserFactory = XmlUtil.getSAXParserFactory(); |
|  |  | assertNotNull(saxParserFactory); |
|  |  | // check if the XXE protection is enabled |
|  |  | SAXParser saxParser = saxParserFactory.newSAXParser(); |
|  |  | assertThrows(SAXException.class, |
|  |  | () -> saxParser.parse(new ByteArrayInputStream(server.getTestXml().getBytes(UTF\_8)), new HandlerBase())); |
|  |  | assertEquals(0, server.getHits()); |
|  |  |  |
|  |  | assertThrows(SAXException.class, () -> XmlUtil.setFeature(saxParserFactory, "test://no-such-feature")); |
|  |  | ignoreXxeFailureProp.setOrClearProperty("false"); |
|  |  | assertThrows(SAXException.class, () -> XmlUtil.setFeature(saxParserFactory, "test://no-such-feature")); |
|  |  | ignoreXxeFailureProp.setOrClearProperty("true"); |
|  |  | XmlUtil.setFeature(saxParserFactory, "test://no-such-feature"); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testGetXmlInputFactory() throws Exception { |
|  |  | XMLInputFactory xmlInputFactory = XmlUtil.getXMLInputFactory(); |
|  |  | assertNotNull(xmlInputFactory); |
|  |  | // check if the XXE protection is enabled |
|  |  | assertThrows(XMLStreamException.class, |
|  |  | () -> staxReadEvents(xmlInputFactory.createXMLEventReader(new StringReader(server.getTestXml())))); |
|  |  | assertEquals(0, server.getHits()); |
|  |  |  |
|  |  | assertThrows(IllegalArgumentException.class, |
|  |  | () -> XmlUtil.setProperty(xmlInputFactory, "test://no-such-property", false)); |
|  |  | ignoreXxeFailureProp.setOrClearProperty("false"); |
|  |  | assertThrows(IllegalArgumentException.class, |
|  |  | () -> XmlUtil.setProperty(xmlInputFactory, "test://no-such-property", false)); |
|  |  | ignoreXxeFailureProp.setOrClearProperty("true"); |
|  |  | XmlUtil.setProperty(xmlInputFactory, "test://no-such-feature", false); |
|  |  | } |
|  |  |  |
|  |  | private void staxReadEvents(XMLEventReader reader) throws XMLStreamException { |
|  |  | try { |
|  |  | while (reader.hasNext()) { |
|  |  | reader.nextEvent(); |
|  |  | } |
|  |  | } finally { |
|  |  | reader.close(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static class DummyServer implements Runnable { |
|  |  | private static final String XXE\_TEST\_STR\_TEMPLATE = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" |
|  |  | + " <!DOCTYPE test [\n" + " <!ENTITY xxe SYSTEM \"%s\">\n" + " ]>" + "<a><b>&xxe;</b></a>"; |
|  |  |  |
|  |  | private final ServerSocket serverSocket; |
|  |  | private final AtomicInteger counter = new AtomicInteger(); |
|  |  |  |
|  |  | DummyServer() throws IOException { |
|  |  | serverSocket = new ServerSocket(0, 5, InetAddress.getLoopbackAddress()); |
|  |  | } |
|  |  |  |
|  |  | public void start() { |
|  |  | new Thread(this, "DummyServer-acceptor").start(); |
|  |  | } |
|  |  |  |
|  |  | public String getUrlString() { |
|  |  | return "http://127.0.0.1:" + serverSocket.getLocalPort(); |
|  |  | } |
|  |  |  |
|  |  | public String getTestXml() { |
|  |  | return String.format(XXE\_TEST\_STR\_TEMPLATE, getUrlString()); |
|  |  | } |
|  |  |  |
|  |  | public int getHits() { |
|  |  | return counter.get(); |
|  |  | } |
|  |  |  |
|  |  | public void stop() { |
|  |  | try { |
|  |  | serverSocket.close(); |
|  |  | } catch (IOException e) { |
|  |  | e.printStackTrace(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public void run() { |
|  |  | while (true) { |
|  |  | try (Socket socket = serverSocket.accept()) { |
|  |  | System.out.println(">> connection accepted: " + socket); |
|  |  | counter.incrementAndGet(); |
|  |  | } catch (Exception e) { |
|  |  | System.out.println(">> stopping the server. Cause: " + e.getClass().getName()); |
|  |  | return; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4d6b666`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhazelcast%2Fhazelcast%2Fcommit%2F4d6b666cd0291abd618c3b95cdbb51aa4208e748) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


