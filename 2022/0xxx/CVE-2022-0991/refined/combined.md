=== Content from huntr.dev_c17c0914_20250115_095416.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)

=== Content from github.com_ca7a92ff_20250115_095416.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadmidio%2Fadmidio%2Fcommit%2Fe84e472ebe517e2ff5795c46dc10b5f49dc4d46a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadmidio%2Fadmidio%2Fcommit%2Fe84e472ebe517e2ff5795c46dc10b5f49dc4d46a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Admidio%2Fadmidio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Admidio](/Admidio)
/
**[admidio](/Admidio/admidio)**
Public

* [Notifications](/login?return_to=%2FAdmidio%2Fadmidio) You must be signed in to change notification settings
* [Fork
  134](/login?return_to=%2FAdmidio%2Fadmidio)
* [Star
   349](/login?return_to=%2FAdmidio%2Fadmidio)

* [Code](/Admidio/admidio)
* [Issues
  154](/Admidio/admidio/issues)
* [Pull requests
  3](/Admidio/admidio/pulls)
* [Actions](/Admidio/admidio/actions)
* [Projects
  0](/Admidio/admidio/projects)
* [Security](/Admidio/admidio/security)
* [Insights](/Admidio/admidio/pulse)

Additional navigation options

* [Code](/Admidio/admidio)
* [Issues](/Admidio/admidio/issues)
* [Pull requests](/Admidio/admidio/pulls)
* [Actions](/Admidio/admidio/actions)
* [Projects](/Admidio/admidio/projects)
* [Security](/Admidio/admidio/security)
* [Insights](/Admidio/admidio/pulse)

## Commit

[Permalink](/Admidio/admidio/commit/e84e472ebe517e2ff5795c46dc10b5f49dc4d46a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Sessions should be invalidated if password was changed [#1238](https://github.com/Admidio/admidio/issues/1238)

[Browse files](/Admidio/admidio/tree/e84e472ebe517e2ff5795c46dc10b5f49dc4d46a)
Browse the repository at this point in the history

* Loading branch information

[![@Fasse](https://avatars.githubusercontent.com/u/7038017?s=40&v=4)](/Fasse)

[Fasse](/Admidio/admidio/commits?author=Fasse "View all commits by Fasse")
committed
Mar 13, 2022

1 parent
[c9b08f0](/Admidio/admidio/commit/c9b08f08af860c1eba1b1f830485ab3bb9b2458a)

commit e84e472

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**85 additions**
and
**44 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* adm\_program/system/classes

  + adm\_program/system/classes/Session.php
    [Session.php](#diff-bb5d9467b693e9f6a75ea30604cd69f05d1d64f9b5d8a00123fa3f91ddcd97f9)
  + adm\_program/system/classes/User.php
    [User.php](#diff-2f129cce9f3e6d064c6dd169fdfcc2b2a16c386fcd91f36c1649caafc09c6313)

## There are no files selected for viewing

45 changes: 28 additions & 17 deletions

45
[adm\_program/system/classes/Session.php](#diff-bb5d9467b693e9f6a75ea30604cd69f05d1d64f9b5d8a00123fa3f91ddcd97f9 "adm_program/system/classes/Session.php")

Show comments

[View file](/Admidio/admidio/blob/e84e472ebe517e2ff5795c46dc10b5f49dc4d46a/adm_program/system/classes/Session.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -74,7 +74,7 @@ public function \_\_construct(Database $database, $cookiePrefix = '') |
|  |  | $this->readDataByColumns(array('ses\_session\_id' => $sessionId)); |
|  |  |  |
|  |  | if ($this->newRecord) { |
|  |  | // if PHP session id was commited then store them in that field |
|  |  | // if PHP session id was committed then store them in that field |
|  |  | $this->setValue('ses\_session\_id', $sessionId); |
|  |  | $this->setValue('ses\_timestamp', DATETIME\_NOW); |
|  |  | } |
| Expand Down  Expand Up | | @@ -117,9 +117,11 @@ protected function clearUserData() |
|  |  | \* Returns a CSRF token from the session. If no CSRF token exists a new one will be |
|  |  | \* generated and stored within the session. The next call of the method will than |
|  |  | \* return the existing token. The CSRF token has 30 characters. A new token could |
|  |  | \* be forced by the paramter \*\*$newToken\*\* |
|  |  | \* be forced by the parameter \*\*$newToken\*\* |
|  |  | \* @param bool $newToken If set to true, always a new token will be generated. |
|  |  | \* @return string Returns the CSRF token |
|  |  | \* @throws AdmException |
|  |  | \* @throws AdmException |
|  |  | \*/ |
|  |  | public function getCsrfToken(bool $newToken = false): string |
|  |  | { |
| Expand All | | @@ -132,7 +134,7 @@ public function getCsrfToken(bool $newToken = false): string |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns a reference of an object that is stored in the session. |
|  |  | \* This is necessary because the old database connection is not longer valid. |
|  |  | \* This is necessary because the old database connection is not valid anymore. |
|  |  | \* @param string $objectName Internal unique name of the object. The name was set with the method \*\*addObject\*\* |
|  |  | \* @return object|false Returns the reference to the object or false if the object was not found. |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -174,8 +176,8 @@ public function hasObject(string $objectName): bool |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Initialize the array with all objects except the gNavigation object. If the session got an refresh |
|  |  | \* the existing navigation should still be stored in the refreshed sesssion. |
|  |  | \* Initialize the array with all objects except the gNavigation object. If the session got a refresh |
|  |  | \* the existing navigation should still be stored in the refreshed session. |
|  |  | \*/ |
|  |  | public function initializeObjects() |
|  |  | { |
| Expand All | | @@ -201,7 +203,7 @@ public function isValidLogin(int $userId): bool |
|  |  | // session has a user assigned -> check if login is still valid |
|  |  | $timeGap = time() - strtotime($this->getValue('ses\_timestamp', 'Y-m-d H:i:s')); |
|  |  |  |
|  |  | // Check how long the user was inactive. If time range is to long -> logout |
|  |  | // Check how long the user was inactive. If time range is too long -> logout |
|  |  | // if user has auto login than session is also valid |
|  |  | if ($this->mAutoLogin instanceof AutoLogin || $timeGap < $gSettingsManager->getInt('logout\_minutes') \* 60) { |
|  |  | return true; |
| Expand Down  Expand Up | | @@ -261,8 +263,8 @@ public function refreshAutoLogin() |
|  |  | $this->setValue('ses\_usr\_id', (int) $this->mAutoLogin->getValue('atl\_usr\_id')); |
|  |  |  |
|  |  | // save cookie for autologin |
|  |  | $currDateTime = new \DateTime(); |
|  |  | $oneYearDateInterval = new \DateInterval('P1Y'); |
|  |  | $currDateTime = new DateTime(); |
|  |  | $oneYearDateInterval = new DateInterval('P1Y'); |
|  |  | $oneYearAfterDateTime = $currDateTime->add($oneYearDateInterval); |
|  |  | $timestampExpired = $oneYearAfterDateTime->getTimestamp(); |
|  |  |  |
| Expand Down  Expand Up | | @@ -297,8 +299,13 @@ public function refreshAutoLogin() |
|  |  | \*/ |
|  |  | public function refresh() |
|  |  | { |
|  |  | // read session data from database to update the renew flag |
|  |  | $this->readDataById((int) $this->getValue('ses\_id')); |
|  |  | // read session data from database to update the reload flag |
|  |  | if(!$this->readDataById((int) $this->getValue('ses\_id'))) { |
|  |  | // if session was not found than destroy session object |
|  |  | unset($\_SESSION['gCurrentSession']); |
|  |  | $this->initializeObjects(); |
|  |  | $this->clear(); |
|  |  | } |
|  |  |  |
|  |  | // check if current connection has same ip address as of session initialization |
|  |  | // if config parameter $gCheckIpAddress = 0 then don't check ip address |
| Expand Down  Expand Up | | @@ -370,9 +377,11 @@ public function reload(int $userId) |
|  |  | \*/ |
|  |  | public function save($updateFingerPrint = true): bool |
|  |  | { |
|  |  | global $gCurrentOrgId; |
|  |  |  |
|  |  | if ($this->newRecord) { |
|  |  | // Insert |
|  |  | $this->setValue('ses\_org\_id', $GLOBALS['gCurrentOrgId']); |
|  |  | $this->setValue('ses\_org\_id', $gCurrentOrgId); |
|  |  | $this->setValue('ses\_begin', DATETIME\_NOW); |
|  |  | // remove the last part of the IP because of privacy (GDPR) |
|  |  | $ip = preg\_replace(array('/\.\d+$/', '/[\da-f]\*:[\da-f]\*$/'), array('.XXX', 'XXXX:XXXX'), $\_SERVER['REMOTE\_ADDR']); |
| Expand Down  Expand Up | | @@ -403,8 +412,8 @@ public function setAutoLogin() |
|  |  | $this->mAutoLogin->save(); |
|  |  |  |
|  |  | // save cookie for autologin |
|  |  | $currDateTime = new \DateTime(); |
|  |  | $oneYearDateInterval = new \DateInterval('P1Y'); |
|  |  | $currDateTime = new DateTime(); |
|  |  | $oneYearDateInterval = new DateInterval('P1Y'); |
|  |  | $oneYearAfterDateTime = $currDateTime->add($oneYearDateInterval); |
|  |  | $timestampExpired = $oneYearAfterDateTime->getTimestamp(); |
|  |  |  |
| Expand Down  Expand Up | | @@ -478,7 +487,7 @@ public static function setCookie( |
|  |  | \* @param bool|null $secure If "true" cookie is only set if connection is HTTPS. Default is an auto detection. |
|  |  | \* @param bool $httpOnly If "true" cookie is accessible only via HTTP. |
|  |  | \* Set to "false" to allow access for JavaScript. (Possible XSS security leak) |
|  |  | \* @throws \RuntimeException |
|  |  | \* @throws RuntimeException |
|  |  | \*/ |
|  |  | public static function start(string $cookiePrefix, int $limit = 0, string $path = '', string $domain = '', bool $secure = null, bool $httpOnly = true) |
|  |  | { |
| Expand All | | @@ -488,7 +497,7 @@ public static function start(string $cookiePrefix, int $limit = 0, string $path |
|  |  | $message = 'HTTP-Headers already sent!'; |
|  |  | $gLogger->alert($message); |
|  |  |  |
|  |  | throw new \RuntimeException($message); |
|  |  | throw new RuntimeException($message); |
|  |  | } |
|  |  |  |
|  |  | $sessionName = $cookiePrefix . '\_SESSION\_ID'; |
| Expand Down  Expand Up | | @@ -543,11 +552,13 @@ public static function start(string $cookiePrefix, int $limit = 0, string $path |
|  |  | /\*\* |
|  |  | \* Deletes all sessions in table admSessions that are inactive since \*\*$maxInactiveTime\*\* minutes.. |
|  |  | \* @param int $maxInactiveMinutes Time in Minutes after that a session will be deleted. |
|  |  | \* @throws Exception |
|  |  | \* @throws Exception |
|  |  | \*/ |
|  |  | public function tableCleanup(int $maxInactiveMinutes = 30) |
|  |  | { |
|  |  | $now = new \DateTime(); |
|  |  | $minutesBack = new \DateInterval('PT' . $maxInactiveMinutes . 'M'); |
|  |  | $now = new DateTime(); |
|  |  | $minutesBack = new DateInterval('PT' . $maxInactiveMinutes . 'M'); |
|  |  | $timestamp = $now->sub($minutesBack)->format('Y-m-d H:i:s'); |
|  |  |  |
|  |  | $sql = 'DELETE FROM '.TBL\_SESSIONS.' |
| Expand Down | |  |

84 changes: 57 additions & 27 deletions

84
[adm\_program/system/classes/User.php](#diff-2f129cce9f3e6d064c6dd169fdfcc2b2a16c386fcd91f36c1649caafc09c6313 "adm_program/system/classes/User.php")

Show comments

[View file](/Admidio/admidio/blob/e84e472ebe517e2ff5795c46dc10b5f49dc4d46a/adm_program/system/classes/User.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -109,7 +109,7 @@ public function allowedEditProfileField(self $user, $fieldNameIntern) |
|  |  | \* @param string $fieldNameIntern Expects the \*\*usf\_name\_intern\*\* of the field that should be checked. |
|  |  | \* @return bool Return true if the current user is allowed to view this profile field of \*\*$user\*\*. |
|  |  | \*/ |
|  |  | public function allowedViewProfileField(self $user, $fieldNameIntern) |
|  |  | public function allowedViewProfileField(self $user, string $fieldNameIntern) |
|  |  | { |
|  |  | return $user->mProfileFieldsData->isVisible($fieldNameIntern, $this->hasRightEditProfile($user)); |
|  |  | } |
| Expand All | | @@ -125,7 +125,7 @@ public function assignDefaultRoles() |
|  |  | $this->db->startTransaction(); |
|  |  |  |
|  |  | // every user will get the default roles for registration, if the current user has the right to assign roles |
|  |  | // than the roles assignment dialog will be shown |
|  |  | // than the role assignment dialog will be shown |
|  |  | $sql = 'SELECT rol\_id |
|  |  | FROM '.TBL\_ROLES.' |
|  |  | INNER JOIN '.TBL\_CATEGORIES.' |
| Expand All | | @@ -149,7 +149,7 @@ public function assignDefaultRoles() |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param string $mode 'set' or 'edit' |
|  |  | \* @param int $id Id of the role for which the membership should be set, |
|  |  | \* @param int $id ID of the role for which the membership should be set, |
|  |  | \* or id of the current membership that should be edited. |
|  |  | \* @param string $startDate New start date of the membership. Default will be \*\*DATE\_NOW\*\*. |
|  |  | \* @param string $endDate New end date of the membership. Default will be \*\*31.12.9999\*\* |
| Expand All | | @@ -169,7 +169,7 @@ private function changeRoleMembership($mode, $id, $startDate, $endDate, $leader) |
|  |  | $maxEndDate = $endDate; |
|  |  |  |
|  |  | if ($mode === 'set') { |
|  |  | // subtract 1 day from start date so that we find memberships that ends yesterday |
|  |  | // subtract 1 day from start date so that we find memberships that end yesterday |
|  |  | // these memberships can be continued with new date |
|  |  | $oneDayOffset = new \DateInterval('P1D'); |
|  |  |  |
| Expand All | | @@ -192,7 +192,7 @@ private function changeRoleMembership($mode, $id, $startDate, $endDate, $leader) |
|  |  | AND mem\_usr\_id = ? -- $usrId |
|  |  | AND mem\_begin <= ? -- $endDate |
|  |  | AND mem\_end >= ? -- $startDate |
|  |  | ORDER BY mem\_begin ASC'; |
|  |  | ORDER BY mem\_begin'; |
|  |  | $queryParams = array( |
|  |  | $id, |
|  |  | $usrId, |
| Expand All | | @@ -209,7 +209,7 @@ private function changeRoleMembership($mode, $id, $startDate, $endDate, $leader) |
|  |  | AND mem\_usr\_id = ? -- $usrId |
|  |  | AND mem\_begin <= ? -- $endDate |
|  |  | AND mem\_end >= ? -- $startDate |
|  |  | ORDER BY mem\_begin ASC'; |
|  |  | ORDER BY mem\_begin'; |
|  |  | $queryParams = array( |
|  |  | $id, |
|  |  | $member->getValue('mem\_rol\_id'), |
| Expand All | | @@ -234,14 +234,14 @@ private function changeRoleMembership($mode, $id, $startDate, $endDate, $leader) |
|  |  | } |
|  |  |  |
|  |  | if ($mode === 'set') { |
|  |  | // save new end date if an later date exists |
|  |  | // but only if end date is greater than the begin date otherwise the membership should be deleted |
|  |  | // save new end date if a later date exists |
|  |  | // but only if end date is greater than the beginn date otherwise the membership should be deleted |
|  |  | if (strcmp($member->getValue('mem\_end', 'Y-m-d'), $maxEndDate) > 0 |
|  |  | && strcmp($member->getValue('mem\_begin', 'Y-m-d'), $maxEndDate) < 0) { |
|  |  | $maxEndDate = $member->getValue('mem\_end', 'Y-m-d'); |
|  |  | } |
|  |  | } else { |
|  |  | // save new end date if an later date exists |
|  |  | // save new end date if a later date exists |
|  |  | if (strcmp($member->getValue('mem\_end', 'Y-m-d'), $maxEndDate) > 0) { |
|  |  | $maxEndDate = $member->getValue('mem\_end', 'Y-m-d'); |
|  |  | } |
| Expand All | | @@ -257,7 +257,7 @@ private function changeRoleMembership($mode, $id, $startDate, $endDate, $leader) |
|  |  | $minStartDate = $member->getValue('mem\_begin', 'Y-m-d'); |
|  |  | } |
|  |  |  |
|  |  | // save new end date if an later date exists |
|  |  | // save new end date if a later date exists |
|  |  | if (strcmp($member->getValue('mem\_end', 'Y-m-d'), $maxEndDate) > 0) { |
|  |  | $maxEndDate = $member->getValue('mem\_end', 'Y-m-d'); |
|  |  | } |
| Expand Down  Expand Up | | @@ -296,7 +296,7 @@ private function changeRoleMembership($mode, $id, $startDate, $endDate, $leader) |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Method reads all relationships of the user and will store them in an array. Also the |
|  |  | \* Method reads all relationships of the user and will store them in an array. The |
|  |  | \* relationship property if the user can edit the profile of the other user will be stored |
|  |  | \* for later checks within this class. |
|  |  | \* @return bool Return true if relationships could be checked. |
| Expand Down  Expand Up | | @@ -336,8 +336,8 @@ private function checkRelationshipsRights() |
|  |  | /\*\* |
|  |  | \* The method reads all roles where this user has a valid membership and checks the rights of |
|  |  | \* those roles. It stores all rights that the user get at last through one role in an array. |
|  |  | \* In addition the method checks which roles lists the user could see in an separate array. |
|  |  | \* Also an array with all roles where the user has the right to write an email will be stored. |
|  |  | \* The method checks which role lists the user could see in a separate array. |
|  |  | \* An array with all roles where the user has the right to write an email will be stored. |
|  |  | \* The method considered the role leader rights of each role if this is set and the current |
|  |  | \* user is a leader in a role. |
|  |  | \* @param string $right The database column name of the right that should be checked. If this param |
| Expand Down  Expand Up | | @@ -409,8 +409,7 @@ public function checkRolesRight($right = null) |
|  |  | // add role to membership array |
|  |  | $this->rolesMembership[] = $rolId; |
|  |  |  |
|  |  | // Rechte der Rollen in das Array uebertragen, |
|  |  | // falls diese noch nicht durch andere Rollen gesetzt wurden |
|  |  | // Transfer the rights of the roles into the array, if these have not yet been set by other roles |
|  |  | foreach ($tmpRolesRights as $key => &$value) { |
|  |  | if (!$value && $row[$key] == '1') { |
|  |  | $value = true; |
| Expand All | | @@ -429,38 +428,38 @@ public function checkRolesRight($right = null) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Listenansichtseinstellung merken |
|  |  | // Leiter duerfen die Rolle sehen |
|  |  | // Remember list view setting |
|  |  | // leaders are allowed to see the role |
|  |  | if ($row['mem\_usr\_id'] > 0 && ($row['rol\_this\_list\_view'] > 0 || $memLeader)) { |
|  |  | // Mitgliedschaft bei der Rolle und diese nicht gesperrt, dann anschauen |
|  |  | // Membership to the role and this is not locked, then look at it |
|  |  | $this->listViewRights[$rolId] = true; |
|  |  | } elseif ((int) $row['rol\_this\_list\_view'] === 2) { |
|  |  | // andere Rollen anschauen, wenn jeder sie sehen darf |
|  |  | // look at other roles when everyone is allowed to see them |
|  |  | $this->listViewRights[$rolId] = true; |
|  |  | } else { |
|  |  | $this->listViewRights[$rolId] = false; |
|  |  | } |
|  |  |  |
|  |  | // Mailrechte setzen |
|  |  | // Leiter duerfen der Rolle Mails schreiben |
|  |  | // Set mail permissions |
|  |  | // Leaders are allowed to write mails to the role |
|  |  | if ($row['mem\_usr\_id'] > 0 && ($row['rol\_mail\_this\_role'] > 0 || $memLeader)) { |
|  |  | // Mitgliedschaft bei der Rolle und diese nicht gesperrt, dann anschauen |
|  |  | // Membership to the role and this is not locked, then look at it |
|  |  | $this->listMailRights[$rolId] = true; |
|  |  | } elseif ($row['rol\_mail\_this\_role'] >= 2) { |
|  |  | // andere Rollen anschauen, wenn jeder sie sehen darf |
|  |  | // look at other roles when everyone is allowed to see them |
|  |  | $this->listMailRights[$rolId] = true; |
|  |  | } else { |
|  |  | $this->listMailRights[$rolId] = false; |
|  |  | } |
|  |  | } |
|  |  | $this->rolesRights = $tmpRolesRights; |
|  |  |  |
|  |  | // ist das Recht 'alle Listen einsehen' gesetzt, dann dies auch im Array bei allen Rollen setzen |
|  |  | // if the right 'view all lists' is set, then set this also in the array for all roles |
|  |  | if ($this->rolesRights['rol\_all\_lists\_view']) { |
|  |  | $this->listViewRights = array\_fill\_keys(array\_keys($this->listViewRights), true); |
|  |  | } |
|  |  |  |
|  |  | // ist das Recht 'allen Rollen EMails schreiben' gesetzt, dann dies auch im Array bei allen Rollen setzen |
|  |  | // if the right 'write emails to all roles' is set, then set this also in the array for all roles |
|  |  | if ($this->rolesRights['rol\_mail\_to\_all']) { |
|  |  | $this->listMailRights = array\_fill\_keys(array\_keys($this->listMailRights), true); |
|  |  | } |
| Expand Down  Expand Up | | @@ -1422,6 +1421,32 @@ private function handleIncorrectPasswordLogin() |
|  |  | return 'SYS\_LOGIN\_USERNAME\_PASSWORD\_INCORRECT'; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Deletes all other sessions of the current user except the current session. Also all auto logins of the user |
|  |  | \* will be removed. This method is useful if the user changed his password or if unusual activities within |
|  |  | \* the user account are noticed. |
|  |  | \* @return bool Returns true if all things could be done. Otherwise false is returned. |
|  |  | \*/ |
|  |  | public function invalidateAllOtherLogins() |
|  |  | { |
|  |  | global $gCurrentUserId, $gCurrentSession; |
|  |  |  |
|  |  | // remove all sessions of the current user except the current session |
|  |  | $sql = 'DELETE FROM ' . TBL\_SESSIONS . ' |
|  |  | WHERE ses\_usr\_id = ? -- $gCurrentUserId |
|  |  | AND ses\_id <> ? -- $gCurrentSession->getValue(\'ses\_id\') '; |
|  |  | $queryParams = array($gCurrentUserId, $gCurrentSession->getValue('ses\_id')); |
|  |  | $this->db->queryPrepared($sql, $queryParams); |
|  |  |  |
|  |  | // remove all auto logins of the current user |
|  |  | $sql = 'DELETE FROM ' . TBL\_AUTO\_LOGIN . ' |
|  |  | WHERE atl\_usr\_id = ? -- $gCurrentUserId '; |
|  |  | $queryParams = array($gCurrentUserId); |
|  |  | $this->db->queryPrepared($sql, $queryParams); |
|  |  |  |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Checks if the user is assigned to the role \*\*Administrator\*\* |
|  |  | \* @return bool Returns \*\*true\*\* if the user is a member of the role \*\*Administrator\*\* |
| Expand Down  Expand Up | | @@ -1765,7 +1790,12 @@ public function setPassword($newPassword, $doHashing = true) |
|  |  | $this |
|  |  | ); |
|  |  | } |
|  |  | return parent::setValue('usr\_password', $newPasswordHash, false); |
|  |  | if(parent::setValue('usr\_password', $newPasswordHash, false)) { |
|  |  | // for security reasons remove all sessions and auto login of the user |
|  |  | return $this->invalidateAllOtherLogins(); |
|  |  | } |
|  |  |  |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -2029,7 +2059,7 @@ public function editWeblinksRight() |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Return the (internal) representation of this user's profile fields |
|  |  | \* @return array All profile fields of the user |
|  |  | \* @return object<ProfileFields> All profile fields of the user |
|  |  | \*/ |
|  |  | public function getProfileFieldsData() |
|  |  | { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e84e472`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadmidio%2Fadmidio%2Fcommit%2Fe84e472ebe517e2ff5795c46dc10b5f49dc4d46a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


