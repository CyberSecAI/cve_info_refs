=== Content from lore.kernel.org_679c65e6_20250115_112028.html ===

```
[bpf.vger.kernel.org archive mirror](../../?t=20220104093330)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#ee56d798f8b2c41edb32b4c1e840aeedaa4cc480a) [PATCH net] bpf: Add missing map_get_next_key method to bloom filter map
@ 2022-01-04  9:01 Eric Dumazet
  2022-01-04  9:21 ` [Daniel Borkmann](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
  [0 siblings, 1 reply; 3+ messages in thread](#re56d798f8b2c41edb32b4c1e840aeedaa4cc480a)
From: Eric Dumazet @ 2022-01-04  9:01 UTC ([permalink](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/) / [raw](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/raw))
  To: Alexei Starovoitov, Daniel Borkmann
  Cc: David S . Miller, [netdev](../../../netdev/?t=20220104090136), Eric Dumazet, Eric Dumazet, [bpf](../../../bpf/?t=20220104090136), syzbot,
	Yonghong Song

From: Eric Dumazet <edumazet@google.com>

It appears map_get_next_key() method is mandatory,
as syzbot is able to trigger a NULL deref in map_get_next_key().

Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Alexei Starovoitov <ast@kernel.org>
Cc: Yonghong Song <yhs@fb.com>
---
 [kernel/bpf/bloom_filter.c](#Z2e.:..:20220104090130.3121751-1-eric.dumazet::40gmail.com:1kernel:bpf:bloom_filter.c) | 7 +++++++
 1 file [changed](#ee56d798f8b2c41edb32b4c1e840aeedaa4cc480a), 7 insertions(+)

[diff](#iZ2e.:..:20220104090130.3121751-1-eric.dumazet::40gmail.com:1kernel:bpf:bloom_filter.c) --git a/kernel/bpf/bloom_filter.c b/kernel/bpf/bloom_filter.c
index 277a05e9c9849324a277d77eeec12963cc7519b7..34f48058515cfd3f8ea6816ccad1f4a26eba0ebf 100644
--- a/kernel/bpf/bloom_filter.c
+++ b/kernel/bpf/bloom_filter.c
@@ -82,6 +82,12 @@ static int bloom_map_delete_elem(struct bpf_map *map, void *value)
 	return -EOPNOTSUPP;
 }

+static int bloom_get_next_key(struct bpf_map *map, void *key,
+			      void *next_key)
+{
+	return -ENOTSUPP;
+}
+
 static struct bpf_map *bloom_map_alloc(union bpf_attr *attr)
 {
 	u32 bitset_bytes, bitset_mask, nr_hash_funcs, nr_bits;
@@ -201,4 +207,5 @@ const struct bpf_map_ops bloom_filter_map_ops = {
 	.map_check_btf = bloom_map_check_btf,
 	.map_btf_name = "bpf_bloom_filter",
 	.map_btf_id = &bpf_bloom_map_btf_id,
+	.map_get_next_key = bloom_get_next_key,
 };
--
2.34.1.448.ga2b2bfdf31-goog

[^](#me56d798f8b2c41edb32b4c1e840aeedaa4cc480a) [permalink](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/) [raw](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/raw) [reply](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/#R) [related](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/#related)	[[flat](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/T/#u)|[nested](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/t/#u)] [3+ messages in thread](#re56d798f8b2c41edb32b4c1e840aeedaa4cc480a)
```

---

```
[*](#e469240a59ec5f9ec730ac8b26875c3cd9aee0e29) Re: [PATCH net] bpf: Add missing map_get_next_key method to bloom filter map
  2022-01-04  9:01 [[PATCH net] bpf: Add missing map_get_next_key method to bloom filter map](#me56d798f8b2c41edb32b4c1e840aeedaa4cc480a) Eric Dumazet
@ 2022-01-04  9:21 ` Daniel Borkmann
  2022-01-04  9:33   ` [Eric Dumazet](#madcd190dd928d05b2f933c822f67dde25c9e8ab2)
  [0 siblings, 1 reply; 3+ messages in thread](#r469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
From: Daniel Borkmann @ 2022-01-04  9:21 UTC ([permalink](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/) / [raw](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/raw))
  To: Eric Dumazet, Alexei Starovoitov
  Cc: David S . Miller, [netdev](../../../netdev/?t=20220104092134), Eric Dumazet, [bpf](../../../bpf/?t=20220104092134), syzbot,
	Yonghong Song, joannekoong

Hi Eric, [ +Joanne, ]

On 1/4/22 10:01 AM, Eric Dumazet wrote:
> From: Eric Dumazet <edumazet@google.com>
>
> It appears map_get_next_key() method is mandatory,
> as syzbot is able to trigger a NULL deref in map_get_next_key().
>
> Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
> Reported-by: syzbot <syzkaller@googlegroups.com>
> Signed-off-by: Eric Dumazet <edumazet@google.com>
> Cc: Alexei Starovoitov <ast@kernel.org>
> Cc: Yonghong Song <yhs@fb.com>

Thanks for your patch, this has recently been fixed:

   <https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=3ccdcee28415c4226de05438b4d89eb5514edf73>

I'm not quite sure why it was applied to bpf-next instead of bpf (maybe assumption was
that there would be no rc8 anymore), but I'd expect it to land in Linus' tree once merge
window opens up on 9th Jan. In that case stable team would have to pick it up for 5.16.

Thanks,
Daniel

[^](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29) [permalink](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/) [raw](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/raw) [reply](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/#R)	[[flat](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/T/#u)|[nested](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/t/#u)] [3+ messages in thread](#r469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
```

---

```
[*](#eadcd190dd928d05b2f933c822f67dde25c9e8ab2) Re: [PATCH net] bpf: Add missing map_get_next_key method to bloom filter map
  2022-01-04  9:21 ` [Daniel Borkmann](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
@ 2022-01-04  9:33   ` Eric Dumazet
  [0 siblings, 0 replies; 3+ messages in thread](#radcd190dd928d05b2f933c822f67dde25c9e8ab2)
From: Eric Dumazet @ 2022-01-04  9:33 UTC ([permalink](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/) / [raw](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/raw))
  To: Daniel Borkmann
  Cc: Eric Dumazet, Alexei Starovoitov, David S . Miller, [netdev](../../../netdev/?t=20220104093330), [bpf](../../../bpf/?t=20220104093330),
	syzbot, Yonghong Song, Joanne Koong

On Tue, Jan 4, 2022 at 1:21 AM Daniel Borkmann <daniel@iogearbox.net> wrote:
>
> Hi Eric, [ +Joanne, ]
>
> On 1/4/22 10:01 AM, Eric Dumazet wrote:
> > From: Eric Dumazet <edumazet@google.com>
> >
> > It appears map_get_next_key() method is mandatory,
> > as syzbot is able to trigger a NULL deref in map_get_next_key().
> >
> > Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
> > Reported-by: syzbot <syzkaller@googlegroups.com>
> > Signed-off-by: Eric Dumazet <edumazet@google.com>
> > Cc: Alexei Starovoitov <ast@kernel.org>
> > Cc: Yonghong Song <yhs@fb.com>
>
> Thanks for your patch, this has recently been fixed:
>
>    <https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=3ccdcee28415c4226de05438b4d89eb5514edf73>
>
> I'm not quite sure why it was applied to bpf-next instead of bpf (maybe assumption was
> that there would be no rc8 anymore), but I'd expect it to land in Linus' tree once merge
> window opens up on 9th Jan. In that case stable team would have to pick it up for 5.16.
>

Ah, this is why I could not find the fix in bpf or net tree, thanks.

> Thanks,
> Daniel

[^](#madcd190dd928d05b2f933c822f67dde25c9e8ab2) [permalink](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/) [raw](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/raw) [reply](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/#R)	[[flat](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/T/#u)|[nested](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/t/#u)] [3+ messages in thread](#radcd190dd928d05b2f933c822f67dde25c9e8ab2)
```

---

```
end of thread, other threads:[[~2022-01-04  9:33 UTC](../../?t=20220104093330) | [newest](../../)]

Thread overview: 3+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-01-04  9:01 [[PATCH net] bpf: Add missing map_get_next_key method to bloom filter map](#me56d798f8b2c41edb32b4c1e840aeedaa4cc480a) Eric Dumazet
2022-01-04  9:21 ` [Daniel Borkmann](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
2022-01-04  9:33   ` [Eric Dumazet](#madcd190dd928d05b2f933c822f67dde25c9e8ab2)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```


=== Content from lore.kernel.org_13c1a904_20250114_181553.html ===

```
[bpf.vger.kernel.org archive mirror](../../?t=20211229174211)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#eadefe058e0595de0a50cebcbbd871c52eb9c2cb8) [PATCH v2] bpf: Add missing map_get_next_key method to bloom filter map
@ 2021-12-29 11:20 tcs.kernel
  2021-12-29 17:21 ` [Joanne Koong](#m748a3b7c4a513e40d1dec73c526fb9282d271ff8)
  [0 siblings, 1 reply; 3+ messages in thread](#radefe058e0595de0a50cebcbbd871c52eb9c2cb8)
From: tcs.kernel @ 2021-12-29 11:20 UTC ([permalink](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/) / [raw](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/raw))
  To: ast, daniel, andrii, kafai, songliubraving, yhs, john.fastabend,
	kpsingh, joannekoong, [bpf](../../../bpf/?t=20211229112059)
  Cc: Haimin Zhang

From: Haimin Zhang <tcs_kernel@tencent.com>

Without it, kernel crashes in map_get_next_key().

Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")

Reported-by: TCS Robot <tcs_robot@tencent.com>
Signed-off-by: Haimin Zhang <tcs_kernel@tencent.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
---
 [kernel/bpf/bloom_filter.c](#Z2e.:..:1640776802-22421-1-git-send-email-tcs.kernel::40gmail.com:1kernel:bpf:bloom_filter.c) | 6 ++++++
 1 file [changed](#eadefe058e0595de0a50cebcbbd871c52eb9c2cb8), 6 insertions(+)

[diff](#iZ2e.:..:1640776802-22421-1-git-send-email-tcs.kernel::40gmail.com:1kernel:bpf:bloom_filter.c) --git a/kernel/bpf/bloom_filter.c b/kernel/bpf/bloom_filter.c
index 277a05e9c984..fa34dc871995 100644
--- a/kernel/bpf/bloom_filter.c
+++ b/kernel/bpf/bloom_filter.c
@@ -82,6 +82,11 @@ static int bloom_map_delete_elem(struct bpf_map *map, void *value)
 	return -EOPNOTSUPP;
 }

+static int bloom_map_get_next_key(struct bpf_map *map, void *key, void *next_key)
+{
+	return -EOPNOTSUPP;
+}
+
 static struct bpf_map *bloom_map_alloc(union bpf_attr *attr)
 {
 	u32 bitset_bytes, bitset_mask, nr_hash_funcs, nr_bits;
@@ -192,6 +197,7 @@ const struct bpf_map_ops bloom_filter_map_ops = {
 	.map_meta_equal = bpf_map_meta_equal,
 	.map_alloc = bloom_map_alloc,
 	.map_free = bloom_map_free,
+	.map_get_next_key = bloom_map_get_next_key,
 	.map_push_elem = bloom_map_push_elem,
 	.map_peek_elem = bloom_map_peek_elem,
 	.map_pop_elem = bloom_map_pop_elem,
--
2.27.0

[^](#madefe058e0595de0a50cebcbbd871c52eb9c2cb8) [permalink](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/) [raw](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/raw) [reply](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/#R) [related](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/#related)	[[flat](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/T/#u)|[nested](../../1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com/t/#u)] [3+ messages in thread](#radefe058e0595de0a50cebcbbd871c52eb9c2cb8)
```

* ```
  [*](#e748a3b7c4a513e40d1dec73c526fb9282d271ff8) Re: [PATCH v2] bpf: Add missing map_get_next_key method to bloom filter map
    2021-12-29 11:20 [[PATCH v2] bpf: Add missing map_get_next_key method to bloom filter map](#madefe058e0595de0a50cebcbbd871c52eb9c2cb8) tcs.kernel
  @ 2021-12-29 17:21 ` Joanne Koong
    2021-12-29 17:41   ` [Alexei Starovoitov](#m16034dc3ed2b36e36fa2ed66ff3c2735313dd8cf)
    [0 siblings, 1 reply; 3+ messages in thread](#r748a3b7c4a513e40d1dec73c526fb9282d271ff8)
  From: Joanne Koong @ 2021-12-29 17:21 UTC ([permalink](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/) / [raw](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/raw))
    To: tcs.kernel, ast, daniel, andrii, kafai, songliubraving, yhs,
  	john.fastabend, kpsingh, [bpf](../../../bpf/?t=20211229172235)
    Cc: Haimin Zhang

  On 12/29/21 3:20 AM, tcs.kernel@gmail.com wrote:

  > From: Haimin Zhang <tcs_kernel@tencent.com>
  >
  > Without it, kernel crashes in map_get_next_key().
  >
  > Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
  >
  > Reported-by: TCS Robot <tcs_robot@tencent.com>
  > Signed-off-by: Haimin Zhang <tcs_kernel@tencent.com>
  > Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
  > ---

  Thanks for fixing this. I'll take a look at the other bpf_map_ops and see if
  there are other missing ones.

  Acked-by: Joanne Koong <joannekoong@fb.com>
  >   kernel/bpf/bloom_filter.c | 6 ++++++
  >   1 file changed, 6 insertions(+)
  >
  > diff --git a/kernel/bpf/bloom_filter.c b/kernel/bpf/bloom_filter.c
  > index 277a05e9c984..fa34dc871995 100644
  > --- a/kernel/bpf/bloom_filter.c
  > +++ b/kernel/bpf/bloom_filter.c
  > @@ -82,6 +82,11 @@ static int bloom_map_delete_elem(struct bpf_map *map, void *value)
  >   	return -EOPNOTSUPP;
  >   }
  >
  > +static int bloom_map_get_next_key(struct bpf_map *map, void *key, void *next_key)
  > +{
  > +	return -EOPNOTSUPP;
  > +}
  > +
  >   static struct bpf_map *bloom_map_alloc(union bpf_attr *attr)
  >   {
  >   	u32 bitset_bytes, bitset_mask, nr_hash_funcs, nr_bits;
  > @@ -192,6 +197,7 @@ const struct bpf_map_ops bloom_filter_map_ops = {
  >   	.map_meta_equal = bpf_map_meta_equal,
  >   	.map_alloc = bloom_map_alloc,
  >   	.map_free = bloom_map_free,
  > +	.map_get_next_key = bloom_map_get_next_key,
  >   	.map_push_elem = bloom_map_push_elem,
  >   	.map_peek_elem = bloom_map_peek_elem,
  >   	.map_pop_elem = bloom_map_pop_elem,

  [^](#m748a3b7c4a513e40d1dec73c526fb9282d271ff8) [permalink](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/) [raw](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/raw) [reply](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/#R)	[[flat](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/T/#u)|[nested](../../1c8f6a26-658c-8986-2186-7e1868850cc2%40fb.com/t/#u)] [3+ messages in thread](#r748a3b7c4a513e40d1dec73c526fb9282d271ff8)
  ```
* + ```
    [*](#e16034dc3ed2b36e36fa2ed66ff3c2735313dd8cf) Re: [PATCH v2] bpf: Add missing map_get_next_key method to bloom filter map
      2021-12-29 17:21 ` [Joanne Koong](#m748a3b7c4a513e40d1dec73c526fb9282d271ff8)
    @ 2021-12-29 17:41   ` Alexei Starovoitov
      [0 siblings, 0 replies; 3+ messages in thread](#r16034dc3ed2b36e36fa2ed66ff3c2735313dd8cf)
    From: Alexei Starovoitov @ 2021-12-29 17:41 UTC ([permalink](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/) / [raw](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/raw))
      To: Joanne Koong
      Cc: tcs.kernel, Alexei Starovoitov, Daniel Borkmann, Andrii Nakryiko,
    	Martin KaFai Lau, Song Liu, Yonghong Song, John Fastabend,
    	KP Singh, [bpf](../../../bpf/?t=20211229174211), Haimin Zhang

    On Wed, Dec 29, 2021 at 9:22 AM Joanne Koong <joannekoong@fb.com> wrote:
    >
    > On 12/29/21 3:20 AM, tcs.kernel@gmail.com wrote:
    >
    > > From: Haimin Zhang <tcs_kernel@tencent.com>
    > >
    > > Without it, kernel crashes in map_get_next_key().
    > >
    > > Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
    > >
    > > Reported-by: TCS Robot <tcs_robot@tencent.com>
    > > Signed-off-by: Haimin Zhang <tcs_kernel@tencent.com>
    > > Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>

    Haimin,

    Daniel didn't give you his SOB in v1 patch, so I've dropped it
    while applying.

    > > ---
    >
    > Thanks for fixing this. I'll take a look at the other bpf_map_ops and see if
    > there are other missing ones.
    >
    > Acked-by: Joanne Koong <joannekoong@fb.com>

    Thanks everyone.

    [^](#m16034dc3ed2b36e36fa2ed66ff3c2735313dd8cf) [permalink](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/) [raw](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/raw) [reply](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/#R)	[[flat](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/T/#u)|[nested](../../CAADnVQLth6eh3UfdkHgKAX%2BUCTSyizw6OAc7-ZS0WEQgdj1b5g%40mail.gmail.com/t/#u)] [3+ messages in thread](#r16034dc3ed2b36e36fa2ed66ff3c2735313dd8cf)
    ```

---

```
end of thread, other threads:[[~2021-12-29 17:42 UTC](../../?t=20211229174211) | [newest](../../)]

Thread overview: 3+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2021-12-29 11:20 [[PATCH v2] bpf: Add missing map_get_next_key method to bloom filter map](#madefe058e0595de0a50cebcbbd871c52eb9c2cb8) tcs.kernel
2021-12-29 17:21 ` [Joanne Koong](#m748a3b7c4a513e40d1dec73c526fb9282d271ff8)
2021-12-29 17:41   ` [Alexei Starovoitov](#m16034dc3ed2b36e36fa2ed66ff3c2735313dd8cf)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```


=== Content from bugzilla.redhat.com_7fe1005b_20250114_181552.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D2048259)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D2048259)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D2048259)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 2048259

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 2048259**](show_bug.cgi?id=2048259)
(CVE-2022-0433)
- [CVE-2022-0433](https://access.redhat.com/security/cve/CVE-2022-0433) kernel: missing initialization in bloom filter map in kernel/bpf/bloom\_filter.c can lead to DoS

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2022-0433 kernel: missing initialization in bloom filter map in kernel/bp...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED NOTABUG | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2022-0433 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [2048262](show_bug.cgi?id=2048262 "CLOSED NOTABUG - CVE-2022-0433 kernel: missing initialization in bloom filter map in kernel/bpf/bloom_filter.c can lead to DoS [fedora-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [2039891](show_bug.cgi?id=2039891) [2048649](show_bug.cgi?id=2048649) | | TreeView+ | [depends on](buglist.cgi?bug_id=2048259&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=2048259&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2022-01-30 16:50 UTC by Alex | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2022-03-09 14:46 UTC ([History](show_activity.cgi?id=2048259)) | | [CC List:](page.cgi?id=fields.html#cclist) | 47 users (show)  acaringi adscvr airlied alciregi bdettelb bhu brdeoliv bskeggs chwhite crwood dhoward dvlasenk fhrbata fpacheco hdegoede hkrzesin jarod jarodwilson jburrell jeremy jfaracco jforbes jglisse jlelli joe.lawrence jonathan josef jshortt jstancek jwboyer kcarcia kernel-maint kernel-mgr lgoncalv linville lzampier masami256 mchehab nmurray ptalbert qzhao rvrbovsk scweaver steved vkumar walters williams | | Fixed In Version: | Linux kernel 5.17-rc1 | | | Doc Type: | If docs needed, set a value | | | Doc Text: | A NULL pointer dereference flaw was found in the Linux kernel’s BPF subsystem in the way a user triggers the map\_get\_next\_key function of the BPF bloom filter. This flaw allows a local user to crash the system. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2022-01-31 14:01:16 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2048259#c0)  Alex    2022-01-30 16:50:51 UTC  ``` The bug inside bloom filter. Results in Null Pointer Dereference when map_get_next_key function inside BPF code being executed by local user.  This is new (fresh) bloom filter functionality of the eBPF that is actual starting from this commit: [https://lore.kernel.org/bpf/20210921210225.4095056-2-joannekoong@fb.com/](https://lore.kernel.org/bpf/20210921210225.4095056-2-joannekoong%40fb.com/)  Reference to the patch: [https://lore.kernel.org/bpf/d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d@iogearbox.net/T/](https://lore.kernel.org/bpf/d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/T/)   ```  [Comment 1](show_bug.cgi?id=2048259#c1)  Alex    2022-01-30 17:06:29 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 2048262](show_bug.cgi?id=2048262 "CLOSED NOTABUG - CVE-2022-0433 kernel: missing initialization in bloom filter map in kernel/bpf/bloom_filter.c can lead to DoS [fedora-all]")]   ```  [Comment 3](show_bug.cgi?id=2048259#c3)  juneau    2022-01-31 13:34:03 UTC  ``` Services notaffected per kernel analysis.   ```  [Comment 5](show_bug.cgi?id=2048259#c5)  Justin M. Forbes    2022-01-31 22:53:46 UTC  ``` This bug was introduced in 5.16 kernels and a fix was included in 5.16.3 upstream. It was never shipped as an update to stable Fedora users.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=2048259&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from lore.kernel.org_3eb6545a_20250115_112030.html ===

```
[bpf.vger.kernel.org archive mirror](../../?t=20220104093330)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#ee56d798f8b2c41edb32b4c1e840aeedaa4cc480a) [PATCH net] bpf: Add missing map_get_next_key method to bloom filter map
@ 2022-01-04  9:01 Eric Dumazet
  2022-01-04  9:21 ` [Daniel Borkmann](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
  [0 siblings, 1 reply; 3+ messages in thread](#re56d798f8b2c41edb32b4c1e840aeedaa4cc480a)
From: Eric Dumazet @ 2022-01-04  9:01 UTC ([permalink](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/) / [raw](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/raw))
  To: Alexei Starovoitov, Daniel Borkmann
  Cc: David S . Miller, [netdev](../../../netdev/?t=20220104090136), Eric Dumazet, Eric Dumazet, [bpf](../../../bpf/?t=20220104090136), syzbot,
	Yonghong Song

From: Eric Dumazet <edumazet@google.com>

It appears map_get_next_key() method is mandatory,
as syzbot is able to trigger a NULL deref in map_get_next_key().

Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Alexei Starovoitov <ast@kernel.org>
Cc: Yonghong Song <yhs@fb.com>
---
 [kernel/bpf/bloom_filter.c](#Z2e.:..:20220104090130.3121751-1-eric.dumazet::40gmail.com:1kernel:bpf:bloom_filter.c) | 7 +++++++
 1 file [changed](#ee56d798f8b2c41edb32b4c1e840aeedaa4cc480a), 7 insertions(+)

[diff](#iZ2e.:..:20220104090130.3121751-1-eric.dumazet::40gmail.com:1kernel:bpf:bloom_filter.c) --git a/kernel/bpf/bloom_filter.c b/kernel/bpf/bloom_filter.c
index 277a05e9c9849324a277d77eeec12963cc7519b7..34f48058515cfd3f8ea6816ccad1f4a26eba0ebf 100644
--- a/kernel/bpf/bloom_filter.c
+++ b/kernel/bpf/bloom_filter.c
@@ -82,6 +82,12 @@ static int bloom_map_delete_elem(struct bpf_map *map, void *value)
 	return -EOPNOTSUPP;
 }

+static int bloom_get_next_key(struct bpf_map *map, void *key,
+			      void *next_key)
+{
+	return -ENOTSUPP;
+}
+
 static struct bpf_map *bloom_map_alloc(union bpf_attr *attr)
 {
 	u32 bitset_bytes, bitset_mask, nr_hash_funcs, nr_bits;
@@ -201,4 +207,5 @@ const struct bpf_map_ops bloom_filter_map_ops = {
 	.map_check_btf = bloom_map_check_btf,
 	.map_btf_name = "bpf_bloom_filter",
 	.map_btf_id = &bpf_bloom_map_btf_id,
+	.map_get_next_key = bloom_get_next_key,
 };
--
2.34.1.448.ga2b2bfdf31-goog

[^](#me56d798f8b2c41edb32b4c1e840aeedaa4cc480a) [permalink](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/) [raw](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/raw) [reply](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/#R) [related](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/#related)	[[flat](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/T/#u)|[nested](../../20220104090130.3121751-1-eric.dumazet%40gmail.com/t/#u)] [3+ messages in thread](#re56d798f8b2c41edb32b4c1e840aeedaa4cc480a)
```

---

```
[*](#e469240a59ec5f9ec730ac8b26875c3cd9aee0e29) Re: [PATCH net] bpf: Add missing map_get_next_key method to bloom filter map
  2022-01-04  9:01 [[PATCH net] bpf: Add missing map_get_next_key method to bloom filter map](#me56d798f8b2c41edb32b4c1e840aeedaa4cc480a) Eric Dumazet
@ 2022-01-04  9:21 ` Daniel Borkmann
  2022-01-04  9:33   ` [Eric Dumazet](#madcd190dd928d05b2f933c822f67dde25c9e8ab2)
  [0 siblings, 1 reply; 3+ messages in thread](#r469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
From: Daniel Borkmann @ 2022-01-04  9:21 UTC ([permalink](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/) / [raw](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/raw))
  To: Eric Dumazet, Alexei Starovoitov
  Cc: David S . Miller, [netdev](../../../netdev/?t=20220104092134), Eric Dumazet, [bpf](../../../bpf/?t=20220104092134), syzbot,
	Yonghong Song, joannekoong

Hi Eric, [ +Joanne, ]

On 1/4/22 10:01 AM, Eric Dumazet wrote:
> From: Eric Dumazet <edumazet@google.com>
>
> It appears map_get_next_key() method is mandatory,
> as syzbot is able to trigger a NULL deref in map_get_next_key().
>
> Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
> Reported-by: syzbot <syzkaller@googlegroups.com>
> Signed-off-by: Eric Dumazet <edumazet@google.com>
> Cc: Alexei Starovoitov <ast@kernel.org>
> Cc: Yonghong Song <yhs@fb.com>

Thanks for your patch, this has recently been fixed:

   <https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=3ccdcee28415c4226de05438b4d89eb5514edf73>

I'm not quite sure why it was applied to bpf-next instead of bpf (maybe assumption was
that there would be no rc8 anymore), but I'd expect it to land in Linus' tree once merge
window opens up on 9th Jan. In that case stable team would have to pick it up for 5.16.

Thanks,
Daniel

[^](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29) [permalink](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/) [raw](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/raw) [reply](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/#R)	[[flat](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/T/#u)|[nested](../../d5776f5d-3416-4e3b-8751-8a5a9e6a0d4d%40iogearbox.net/t/#u)] [3+ messages in thread](#r469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
```

---

```
[*](#eadcd190dd928d05b2f933c822f67dde25c9e8ab2) Re: [PATCH net] bpf: Add missing map_get_next_key method to bloom filter map
  2022-01-04  9:21 ` [Daniel Borkmann](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
@ 2022-01-04  9:33   ` Eric Dumazet
  [0 siblings, 0 replies; 3+ messages in thread](#radcd190dd928d05b2f933c822f67dde25c9e8ab2)
From: Eric Dumazet @ 2022-01-04  9:33 UTC ([permalink](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/) / [raw](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/raw))
  To: Daniel Borkmann
  Cc: Eric Dumazet, Alexei Starovoitov, David S . Miller, [netdev](../../../netdev/?t=20220104093330), [bpf](../../../bpf/?t=20220104093330),
	syzbot, Yonghong Song, Joanne Koong

On Tue, Jan 4, 2022 at 1:21 AM Daniel Borkmann <daniel@iogearbox.net> wrote:
>
> Hi Eric, [ +Joanne, ]
>
> On 1/4/22 10:01 AM, Eric Dumazet wrote:
> > From: Eric Dumazet <edumazet@google.com>
> >
> > It appears map_get_next_key() method is mandatory,
> > as syzbot is able to trigger a NULL deref in map_get_next_key().
> >
> > Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
> > Reported-by: syzbot <syzkaller@googlegroups.com>
> > Signed-off-by: Eric Dumazet <edumazet@google.com>
> > Cc: Alexei Starovoitov <ast@kernel.org>
> > Cc: Yonghong Song <yhs@fb.com>
>
> Thanks for your patch, this has recently been fixed:
>
>    <https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=3ccdcee28415c4226de05438b4d89eb5514edf73>
>
> I'm not quite sure why it was applied to bpf-next instead of bpf (maybe assumption was
> that there would be no rc8 anymore), but I'd expect it to land in Linus' tree once merge
> window opens up on 9th Jan. In that case stable team would have to pick it up for 5.16.
>

Ah, this is why I could not find the fix in bpf or net tree, thanks.

> Thanks,
> Daniel

[^](#madcd190dd928d05b2f933c822f67dde25c9e8ab2) [permalink](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/) [raw](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/raw) [reply](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/#R)	[[flat](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/T/#u)|[nested](../../CANn89iKkTb0%3D6_uGj7dnvGm6%3Dyjet8AhXG2nEC49A6dE7DfwaQ%40mail.gmail.com/t/#u)] [3+ messages in thread](#radcd190dd928d05b2f933c822f67dde25c9e8ab2)
```

---

```
end of thread, other threads:[[~2022-01-04  9:33 UTC](../../?t=20220104093330) | [newest](../../)]

Thread overview: 3+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-01-04  9:01 [[PATCH net] bpf: Add missing map_get_next_key method to bloom filter map](#me56d798f8b2c41edb32b4c1e840aeedaa4cc480a) Eric Dumazet
2022-01-04  9:21 ` [Daniel Borkmann](#m469240a59ec5f9ec730ac8b26875c3cd9aee0e29)
2022-01-04  9:33   ` [Eric Dumazet](#madcd190dd928d05b2f933c822f67dde25c9e8ab2)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```


=== Content from git.kernel.org_303eb5dc_20250114_181552.html ===


| [cgit logo](/) | [index](/) : [kernel/git/netdev/net-next.git](/pub/scm/linux/kernel/git/netdev/net-next.git/) | main |
| --- | --- | --- |
| Netdev Group's -next networking tree | Netdev Group |

| [about](/pub/scm/linux/kernel/git/netdev/net-next.git/about/)[summary](/pub/scm/linux/kernel/git/netdev/net-next.git/)[refs](/pub/scm/linux/kernel/git/netdev/net-next.git/refs/?id=3ccdcee28415c4226de05438b4d89eb5514edf73)[log](/pub/scm/linux/kernel/git/netdev/net-next.git/log/)[tree](/pub/scm/linux/kernel/git/netdev/net-next.git/tree/?id=3ccdcee28415c4226de05438b4d89eb5514edf73)[commit](/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=3ccdcee28415c4226de05438b4d89eb5514edf73)[diff](/pub/scm/linux/kernel/git/netdev/net-next.git/diff/?id=3ccdcee28415c4226de05438b4d89eb5514edf73)[stats](/pub/scm/linux/kernel/git/netdev/net-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Haimin Zhang <tcs\_kernel@tencent.com> | 2021-12-29 19:20:02 +0800 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2021-12-29 09:38:31 -0800 |
| commit | [3ccdcee28415c4226de05438b4d89eb5514edf73](/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=3ccdcee28415c4226de05438b4d89eb5514edf73) ([patch](/pub/scm/linux/kernel/git/netdev/net-next.git/patch/?id=3ccdcee28415c4226de05438b4d89eb5514edf73)) | |
| tree | [339f6dfbed7e292fc81c4f1751f4c528a7983229](/pub/scm/linux/kernel/git/netdev/net-next.git/tree/?id=3ccdcee28415c4226de05438b4d89eb5514edf73) | |
| parent | [b6459415b384cb829f0b2a4268f211c789f6cf0b](/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=b6459415b384cb829f0b2a4268f211c789f6cf0b) ([diff](/pub/scm/linux/kernel/git/netdev/net-next.git/diff/?id=3ccdcee28415c4226de05438b4d89eb5514edf73&id2=b6459415b384cb829f0b2a4268f211c789f6cf0b)) | |
| download | [net-next-3ccdcee28415c4226de05438b4d89eb5514edf73.tar.gz](/pub/scm/linux/kernel/git/netdev/net-next.git/snapshot/net-next-3ccdcee28415c4226de05438b4d89eb5514edf73.tar.gz) | |

bpf: Add missing map\_get\_next\_key method to bloom filter map.Without it, kernel crashes in map\_get\_next\_key().
Fixes: 9330986c0300 ("bpf: Add bloom filter map implementation")
Reported-by: TCS Robot <tcs\_robot@tencent.com>
Signed-off-by: Haimin Zhang <tcs\_kernel@tencent.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Acked-by: Joanne Koong <joannekoong@fb.com>
Link: [https://lore.kernel.org/bpf/1640776802-22421-1-git-send-email-tcs.kernel@gmail.com](https://lore.kernel.org/bpf/1640776802-22421-1-git-send-email-tcs.kernel%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/netdev/net-next.git/diff/?id=3ccdcee28415c4226de05438b4d89eb5514edf73)

| -rw-r--r-- | [kernel/bpf/bloom\_filter.c](/pub/scm/linux/kernel/git/netdev/net-next.git/diff/kernel/bpf/bloom_filter.c?id=3ccdcee28415c4226de05438b4d89eb5514edf73) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/kernel/bpf/bloom\_filter.c b/kernel/bpf/bloom\_filter.cindex 277a05e9c98493..b141a1346f72dd 100644--- a/[kernel/bpf/bloom\_filter.c](/pub/scm/linux/kernel/git/netdev/net-next.git/tree/kernel/bpf/bloom_filter.c?id=b6459415b384cb829f0b2a4268f211c789f6cf0b)+++ b/[kernel/bpf/bloom\_filter.c](/pub/scm/linux/kernel/git/netdev/net-next.git/tree/kernel/bpf/bloom_filter.c?id=3ccdcee28415c4226de05438b4d89eb5514edf73)@@ -82,6 +82,11 @@ static int bloom\_map\_delete\_elem(struct bpf\_map \*map, void \*value) return -EOPNOTSUPP; } +static int bloom\_map\_get\_next\_key(struct bpf\_map \*map, void \*key, void \*next\_key)+{+ return -EOPNOTSUPP;+}+ static struct bpf\_map \*bloom\_map\_alloc(union bpf\_attr \*attr) { u32 bitset\_bytes, bitset\_mask, nr\_hash\_funcs, nr\_bits;@@ -192,6 +197,7 @@ const struct bpf\_map\_ops bloom\_filter\_map\_ops = { .map\_meta\_equal = bpf\_map\_meta\_equal, .map\_alloc = bloom\_map\_alloc, .map\_free = bloom\_map\_free,+ .map\_get\_next\_key = bloom\_map\_get\_next\_key, .map\_push\_elem = bloom\_map\_push\_elem, .map\_peek\_elem = bloom\_map\_peek\_elem, .map\_pop\_elem = bloom\_map\_pop\_elem, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:14:30 +0000



=== Content from access.redhat.com_2027f727_20250115_112029.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from lore.kernel.org_386bcae8_20250115_112029.html ===

```
[bpf.vger.kernel.org archive mirror](../?t=20210921210502)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Joanne Koong <joannekoong@fb.com>
To: <[bpf@vger.kernel.org](../../bpf/?t=20210921210502)>
Cc: <Kernel-team@fb.com>, Joanne Koong <joannekoong@fb.com>
Subject: [[PATCH v3 bpf-next 1/5] bpf: Add bloom filter map implementation](#r)
Date: Tue, 21 Sep 2021 14:02:21 -0700	[[thread overview]](#r)
Message-ID: <20210921210225.4095056-2-joannekoong@fb.com> (<raw>)
In-Reply-To: <[20210921210225.4095056-1-joannekoong@fb.com](../20210921210225.4095056-1-joannekoong%40fb.com/)>

Bloom filters are a space-efficient probabilistic data structure
used to quickly test whether an element exists in a set.
In a bloom filter, false positives are possible whereas false
negatives should never be.

This patch adds a bloom filter map for bpf programs.
The bloom filter map supports peek (determining whether an element
is present in the map) and push (adding an element to the map)
operations.These operations are exposed to userspace applications
through the already existing syscalls in the following way:

BPF_MAP_LOOKUP_ELEM -> peek
BPF_MAP_UPDATE_ELEM -> push

The bloom filter map does not have keys, only values. In light of
this, the bloom filter map's API matches that of queue stack maps:
user applications use BPF_MAP_LOOKUP_ELEM/BPF_MAP_UPDATE_ELEM
which correspond internally to bpf_map_peek_elem/bpf_map_push_elem,
and bpf programs must use the bpf_map_peek_elem and bpf_map_push_elem
APIs to query or add an element to the bloom filter map. When the
bloom filter map is created, it must be created with a key_size of 0.

For updates, the user will pass in the element to add to the map
as the value, with a NULL key. For lookups, the user will pass in the
element to query in the map as the value. In the verifier layer, this
requires us to modify the argument type of a bloom filter's
BPF_FUNC_map_peek_elem call to ARG_PTR_TO_MAP_VALUE; as well, in
the syscall layer, we need to copy over the user value so that in
bpf_map_peek_elem, we know which specific value to query.

A few things to please take note of:
 * If there are any concurrent lookups + updates, the user is
responsible for synchronizing this to ensure no false negative lookups
occur.
 * The number of hashes to use for the bloom filter is configurable from
userspace. If no number is specified, the default used will be 5 hash
functions. The benchmarks later in this patchset can help compare the
performance of using different number of hashes on different entry
sizes. In general, using more hashes decreases the speed of a lookup,
but increases the false positive rate of an element being detected in the
bloom filter.
 * Deleting an element in the bloom filter map is not supported.
 * The bloom filter map may be used as an inner map.
 * The "max_entries" size that is specified at map creation time is used to
approximate a reasonable bitmap size for the bloom filter, and is not
otherwise strictly enforced. If the user wishes to insert more entries into
the bloom filter than "max_entries", they may do so but they should be
aware that this may lead to a higher false positive rate.

Signed-off-by: Joanne Koong <joannekoong@fb.com>
---
 [include/linux/bpf_types.h](#Z31include:linux:bpf_types.h)      |   1 +
 [include/uapi/linux/bpf.h](#Z31include:uapi:linux:bpf.h)       |   1 +
 [kernel/bpf/Makefile](#Z31kernel:bpf:Makefile)            |   2 +-
 [kernel/bpf/bloom_filter.c](#Z31kernel:bpf:bloom_filter.c)      | 185 +++++++++++++++++++++++++++++++++
 [kernel/bpf/syscall.c](#Z31kernel:bpf:syscall.c)           |  14 ++-
 [kernel/bpf/verifier.c](#Z31kernel:bpf:verifier.c)          |  19 +++-
 [tools/include/uapi/linux/bpf.h](#Z31tools:include:uapi:linux:bpf.h) |   1 +
 7 files [changed](#related), 217 insertions(+), 6 deletions(-)
 create mode 100644 kernel/bpf/bloom_filter.c

[diff](#iZ31include:linux:bpf_types.h) --git a/include/linux/bpf_types.h b/include/linux/bpf_types.h
index 9c81724e4b98..c4424ac2fa02 100644
--- a/include/linux/bpf_types.h
+++ b/include/linux/bpf_types.h
@@ -125,6 +125,7 @@ BPF_MAP_TYPE(BPF_MAP_TYPE_STACK, stack_map_ops)
 BPF_MAP_TYPE(BPF_MAP_TYPE_STRUCT_OPS, bpf_struct_ops_map_ops)
 #endif
 BPF_MAP_TYPE(BPF_MAP_TYPE_RINGBUF, ringbuf_map_ops)
+BPF_MAP_TYPE(BPF_MAP_TYPE_BLOOM_FILTER, bloom_filter_map_ops)

 BPF_LINK_TYPE(BPF_LINK_TYPE_RAW_TRACEPOINT, raw_tracepoint)
 BPF_LINK_TYPE(BPF_LINK_TYPE_TRACING, tracing)
[diff](#iZ31include:uapi:linux:bpf.h) --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.h
index 6fc59d61937a..fec9fcfe0629 100644
--- a/include/uapi/linux/bpf.h
+++ b/include/uapi/linux/bpf.h
@@ -906,6 +906,7 @@ enum bpf_map_type {
 	BPF_MAP_TYPE_RINGBUF,
 	BPF_MAP_TYPE_INODE_STORAGE,
 	BPF_MAP_TYPE_TASK_STORAGE,
+	BPF_MAP_TYPE_BLOOM_FILTER,
 };

 /* Note that tracing related programs such as
[diff](#iZ31kernel:bpf:Makefile) --git a/kernel/bpf/Makefile b/kernel/bpf/Makefile
index 7f33098ca63f..cf6ca339f3cd 100644
--- a/kernel/bpf/Makefile
+++ b/kernel/bpf/Makefile
@@ -7,7 +7,7 @@ endif
 CFLAGS_core.o += $(call cc-disable-warning, override-init) $(cflags-nogcse-yy)

 obj-$(CONFIG_BPF_SYSCALL) += syscall.o verifier.o inode.o helpers.o tnum.o bpf_iter.o map_iter.o task_iter.o prog_iter.o
-obj-$(CONFIG_BPF_SYSCALL) += hashtab.o arraymap.o percpu_freelist.o bpf_lru_list.o lpm_trie.o map_in_map.o
+obj-$(CONFIG_BPF_SYSCALL) += hashtab.o arraymap.o percpu_freelist.o bpf_lru_list.o lpm_trie.o map_in_map.o bloom_filter.o
 obj-$(CONFIG_BPF_SYSCALL) += local_storage.o queue_stack_maps.o ringbuf.o
 obj-$(CONFIG_BPF_SYSCALL) += bpf_local_storage.o bpf_task_storage.o
 obj-${CONFIG_BPF_LSM}	  += bpf_inode_storage.o
[diff](#iZ31kernel:bpf:bloom_filter.c) --git a/kernel/bpf/bloom_filter.c b/kernel/bpf/bloom_filter.c
new file mode 100644
index 000000000000..72254edb24f1
--- /dev/null
+++ b/kernel/bpf/bloom_filter.c
@@ -0,0 +1,185 @@
+// SPDX-License-Identifier: GPL-2.0
+/* Copyright (c) 2021 Facebook */
+
+#include <linux/bitmap.h>
+#include <linux/bpf.h>
+#include <linux/err.h>
+#include <linux/jhash.h>
+#include <linux/random.h>
+
+#define BLOOM_FILTER_CREATE_FLAG_MASK \
+	(BPF_F_NUMA_NODE | BPF_F_ZERO_SEED | BPF_F_ACCESS_MASK)
+
+struct bpf_bloom_filter {
+	struct bpf_map map;
+	u32 bit_array_mask;
+	u32 hash_seed;
+	/* If the size of the values in the bloom filter is u32 aligned,
+	 * then it is more performant to use jhash2 as the underlying hash
+	 * function, else we use jhash. This tracks the number of u32s
+	 * in an u32-aligned value size. If the value size is not u32 aligned,
+	 * this will be 0.
+	 */
+	u32 aligned_u32_count;
+	u32 nr_hash_funcs;
+	unsigned long bit_array[];
+};
+
+static inline u32 hash(struct bpf_bloom_filter *bloom_filter, void *value,
+		       u64 value_size, u32 index)
+{
+	if (bloom_filter->aligned_u32_count)
+		return jhash2(value, bloom_filter->aligned_u32_count,
+			      bloom_filter->hash_seed + index) &
+			bloom_filter->bit_array_mask;
+
+	return jhash(value, value_size, bloom_filter->hash_seed + index) &
+		bloom_filter->bit_array_mask;
+}
+
+static int bloom_filter_map_peek_elem(struct bpf_map *map, void *value)
+{
+	struct bpf_bloom_filter *bloom_filter =
+		container_of(map, struct bpf_bloom_filter, map);
+	u32 i;
+
+	for (i = 0; i < bloom_filter->nr_hash_funcs; i++) {
+		if (!test_bit(hash(bloom_filter, value, map->value_size, i),
+			      bloom_filter->bit_array))
+			return -ENOENT;
+	}
+
+	return 0;
+}
+
+static struct bpf_map *bloom_filter_map_alloc(union bpf_attr *attr)
+{
+	u32 nr_bits, bit_array_bytes, bit_array_mask;
+	int numa_node = bpf_map_attr_numa_node(attr);
+	struct bpf_bloom_filter *bloom_filter;
+	u32 nr_hash_funcs;
+
+	if (!bpf_capable())
+		return ERR_PTR(-EPERM);
+
+	if (attr->key_size != 0 || attr->value_size == 0 || attr->max_entries == 0 ||
+	    attr->map_flags & ~BLOOM_FILTER_CREATE_FLAG_MASK ||
+	    !bpf_map_flags_access_ok(attr->map_flags))
+		return ERR_PTR(-EINVAL);
+
+	/* Default to 5 if no number of hash functions was specified */
+	nr_hash_funcs = attr->nr_hash_funcs == 0 ? 5 : attr->nr_hash_funcs;
+
+	/* For the bloom filter, the optimal bit array size that minimizes the
+	 * false positive probability is n * k / ln(2) where n is the number of
+	 * expected entries in the bloom filter and k is the number of hash
+	 * functions. We use 7 / 5 to approximate 1 / ln(2).
+	 *
+	 * We round this up to the nearest power of two to enable more efficient
+	 * hashing using bitmasks. The bitmask will be the bit array size - 1.
+	 *
+	 * If this overflows a u32, the bit array size will have 2^32 (4
+	 * GB) bits.
+	 */
+	if (check_mul_overflow(attr->max_entries, nr_hash_funcs, &nr_bits) ||
+	    check_mul_overflow(nr_bits / 5, (u32)7, &nr_bits) ||
+	    nr_bits > (1UL << 31)) {
+		/* The bit array size is 2^32 bits but to avoid overflowing the
+		 * u32, we use BITS_TO_BYTES(U32_MAX), which will round up to the
+		 * equivalent number of bytes
+		 */
+		bit_array_bytes = BITS_TO_BYTES(U32_MAX);
+		bit_array_mask = U32_MAX;
+	} else {
+		if (nr_bits <= BITS_PER_LONG)
+			nr_bits = BITS_PER_LONG;
+		else
+			nr_bits = roundup_pow_of_two(nr_bits);
+		bit_array_bytes = BITS_TO_BYTES(nr_bits);
+		bit_array_mask = nr_bits - 1;
+	}
+
+	bit_array_bytes = roundup(bit_array_bytes, sizeof(unsigned long));
+	bloom_filter = bpf_map_area_alloc(sizeof(*bloom_filter) + bit_array_bytes,
+					  numa_node);
+
+	if (!bloom_filter)
+		return ERR_PTR(-ENOMEM);
+
+	bpf_map_init_from_attr(&bloom_filter->map, attr);
+
+	bloom_filter->nr_hash_funcs = nr_hash_funcs;
+	bloom_filter->bit_array_mask = bit_array_mask;
+	if ((attr->value_size & (sizeof(u32) - 1)) == 0)
+		bloom_filter->aligned_u32_count = attr->value_size / sizeof(u32);
+
+	if (!(attr->map_flags & BPF_F_ZERO_SEED))
+		bloom_filter->hash_seed = get_random_int();
+
+	return &bloom_filter->map;
+}
+
+static void bloom_filter_map_free(struct bpf_map *map)
+{
+	struct bpf_bloom_filter *bloom_filter =
+		container_of(map, struct bpf_bloom_filter, map);
+
+	bpf_map_area_free(bloom_filter);
+}
+
+static int bloom_filter_map_push_elem(struct bpf_map *map, void *value,
+				      u64 flags)
+{
+	struct bpf_bloom_filter *bloom_filter =
+		container_of(map, struct bpf_bloom_filter, map);
+	u32 i;
+
+	if (flags != BPF_ANY)
+		return -EINVAL;
+
+	for (i = 0; i < bloom_filter->nr_hash_funcs; i++)
+		set_bit(hash(bloom_filter, value, map->value_size, i),
+			bloom_filter->bit_array);
+
+	return 0;
+}
+
+static void *bloom_filter_map_lookup_elem(struct bpf_map *map, void *key)
+{
+	/* The eBPF program should use map_peek_elem instead */
+	return ERR_PTR(-EINVAL);
+}
+
+static int bloom_filter_map_update_elem(struct bpf_map *map, void *key,
+					void *value, u64 flags)
+{
+	/* The eBPF program should use map_push_elem instead */
+	return -EINVAL;
+}
+
+static int bloom_filter_map_delete_elem(struct bpf_map *map, void *key)
+{
+	return -EOPNOTSUPP;
+}
+
+static int bloom_filter_map_get_next_key(struct bpf_map *map, void *key,
+					 void *next_key)
+{
+	return -EOPNOTSUPP;
+}
+
+static int bloom_filter_map_btf_id;
+const struct bpf_map_ops bloom_filter_map_ops = {
+	.map_meta_equal = bpf_map_meta_equal,
+	.map_alloc = bloom_filter_map_alloc,
+	.map_free = bloom_filter_map_free,
+	.map_push_elem = bloom_filter_map_push_elem,
+	.map_peek_elem = bloom_filter_map_peek_elem,
+	.map_lookup_elem = bloom_filter_map_lookup_elem,
+	.map_update_elem = bloom_filter_map_update_elem,
+	.map_delete_elem = bloom_filter_map_delete_elem,
+	.map_get_next_key = bloom_filter_map_get_next_key,
+	.map_check_btf = map_check_no_btf,
+	.map_btf_name = "bpf_bloom_filter",
+	.map_btf_id = &bloom_filter_map_btf_id,
+};
[diff](#iZ31kernel:bpf:syscall.c) --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
index 4e50c0bfdb7d..9865b5b1e667 100644
--- a/kernel/bpf/syscall.c
+++ b/kernel/bpf/syscall.c
@@ -199,7 +199,8 @@ static int bpf_map_update_value(struct bpf_map *map, struct fd f, void *key,
 		err = bpf_fd_reuseport_array_update_elem(map, key, value,
 							 flags);
 	} else if (map->map_type == BPF_MAP_TYPE_QUEUE ||
-		   map->map_type == BPF_MAP_TYPE_STACK) {
+		   map->map_type == BPF_MAP_TYPE_STACK ||
+		   map->map_type == BPF_MAP_TYPE_BLOOM_FILTER) {
 		err = map->ops->map_push_elem(map, value, flags);
 	} else {
 		rcu_read_lock();
@@ -238,7 +239,8 @@ static int bpf_map_copy_value(struct bpf_map *map, void *key, void *value,
 	} else if (map->map_type == BPF_MAP_TYPE_REUSEPORT_SOCKARRAY) {
 		err = bpf_fd_reuseport_array_lookup_elem(map, key, value);
 	} else if (map->map_type == BPF_MAP_TYPE_QUEUE ||
-		   map->map_type == BPF_MAP_TYPE_STACK) {
+		   map->map_type == BPF_MAP_TYPE_STACK ||
+		   map->map_type == BPF_MAP_TYPE_BLOOM_FILTER) {
 		err = map->ops->map_peek_elem(map, value);
 	} else if (map->map_type == BPF_MAP_TYPE_STRUCT_OPS) {
 		/* struct_ops map requires directly updating "value" */
@@ -1080,6 +1082,14 @@ static int map_lookup_elem(union bpf_attr *attr)
 	if (!value)
 		goto free_key;

+	if (map->map_type == BPF_MAP_TYPE_BLOOM_FILTER) {
+		if (copy_from_user(value, uvalue, value_size))
+			err = -EFAULT;
+		else
+			err = bpf_map_copy_value(map, key, value, attr->flags);
+		goto free_value;
+	}
+
 	err = bpf_map_copy_value(map, key, value, attr->flags);
 	if (err)
 		goto free_value;
[diff](#iZ31kernel:bpf:verifier.c) --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c
index e76b55917905..fd2b7f9dccae 100644
--- a/kernel/bpf/verifier.c
+++ b/kernel/bpf/verifier.c
@@ -4813,7 +4813,10 @@ static int resolve_map_arg_type(struct bpf_verifier_env *env,
 			return -EINVAL;
 		}
 		break;
-
+	case BPF_MAP_TYPE_BLOOM_FILTER:
+		if (meta->func_id == BPF_FUNC_map_peek_elem)
+			*arg_type = ARG_PTR_TO_MAP_VALUE;
+		break;
 	default:
 		break;
 	}
@@ -5388,6 +5391,11 @@ static int check_map_func_compatibility(struct bpf_verifier_env *env,
 		    func_id != BPF_FUNC_task_storage_delete)
 			goto error;
 		break;
+	case BPF_MAP_TYPE_BLOOM_FILTER:
+		if (func_id != BPF_FUNC_map_push_elem &&
+		    func_id != BPF_FUNC_map_peek_elem)
+			goto error;
+		break;
 	default:
 		break;
 	}
@@ -5455,13 +5463,18 @@ static int check_map_func_compatibility(struct bpf_verifier_env *env,
 		    map->map_type != BPF_MAP_TYPE_SOCKHASH)
 			goto error;
 		break;
-	case BPF_FUNC_map_peek_elem:
 	case BPF_FUNC_map_pop_elem:
-	case BPF_FUNC_map_push_elem:
 		if (map->map_type != BPF_MAP_TYPE_QUEUE &&
 		    map->map_type != BPF_MAP_TYPE_STACK)
 			goto error;
 		break;
+	case BPF_FUNC_map_push_elem:
+	case BPF_FUNC_map_peek_elem:
+		if (map->map_type != BPF_MAP_TYPE_QUEUE &&
+		    map->map_type != BPF_MAP_TYPE_STACK &&
+		    map->map_type != BPF_MAP_TYPE_BLOOM_FILTER)
+			goto error;
+		break;
 	case BPF_FUNC_sk_storage_get:
 	case BPF_FUNC_sk_storage_delete:
 		if (map->map_type != BPF_MAP_TYPE_SK_STORAGE)
[diff](#iZ31tools:include:uapi:linux:bpf.h) --git a/tools/include/uapi/linux/bpf.h b/tools/include/uapi/linux/bpf.h
index 6fc59d61937a..fec9fcfe0629 100644
--- a/tools/include/uapi/linux/bpf.h
+++ b/tools/include/uapi/linux/bpf.h
@@ -906,6 +906,7 @@ enum bpf_map_type {
 	BPF_MAP_TYPE_RINGBUF,
 	BPF_MAP_TYPE_INODE_STORAGE,
 	BPF_MAP_TYPE_TASK_STORAGE,
+	BPF_MAP_TYPE_BLOOM_FILTER,
 };

 /* Note that tracing related programs such as
--
2.30.2

```

---

```
[next](../CAEf4BzZfeGGv%2BgBbfBJq5W8eQESgdqeNaByk-agOgMaB8BjQhA%40mail.gmail.com/) [prev parent](../20210921210225.4095056-1-joannekoong%40fb.com/) [reply](#R)	other threads:[[~2021-09-21 21:05 UTC](../?t=20210921210502)|[newest](../)]

Thread overview: 37+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2021-09-21 21:02 [[PATCH v3 bpf-next 0/5] Implement bloom filter map](../20210921210225.4095056-1-joannekoong%40fb.com/) Joanne Koong
2021-09-21 21:02 ` [Joanne Koong [this message]](#t)
2021-09-21 23:44   ` [[PATCH v3 bpf-next 1/5] bpf: Add bloom filter map implementation](../CAEf4BzZfeGGv%2BgBbfBJq5W8eQESgdqeNaByk-agOgMaB8BjQhA%40mail.gmail.com/) Andrii Nakryiko
2021-09-22 19:06     ` [Joanne Koong](../517a137d-66aa-8aa8-a064-fad8ae0c7fa8%40fb.com/)
2021-09-22 19:38       ` [Martin KaFai Lau](../20210922193827.ypqlt3ube4cbbp5a%40kafai-mbp.dhcp.thefacebook.com/)
2021-09-22 20:52         ` [Andrii Nakryiko](../CAEf4BzYi3VXdMctKVFsDqG%2B_nDTSGooJ2sSkF1FuKkqDKqc82g%40mail.gmail.com/)
2021-09-22 22:08           ` [Martin KaFai Lau](../20210922220844.ihzoapwytaz2o7nn%40kafai-mbp.dhcp.thefacebook.com/)
2021-09-22 23:07             ` [Andrii Nakryiko](../CAEf4BzaQ42NTx9tcP43N-%2BSkXbFin9U%2BjSVy6HAmO8e%2BCci5Dw%40mail.gmail.com/)
2021-09-23  1:28               ` [Martin KaFai Lau](../20210923012849.qfgammwxxcd47fgn%40kafai-mbp.dhcp.thefacebook.com/)
2021-09-23 18:42                 ` [Andrii Nakryiko](../CAEf4BzYstaeBBOPsA%2BstMOmZ%2BoBh384E2sY7P8GOtsZFfN%3Dg0w%40mail.gmail.com/)
2021-09-23 19:42                   ` [Martin KaFai Lau](../20210923194233.og5pamu6g7xfnsmp%40kafai-mbp/)
2021-09-23 20:30                     ` [Alexei Starovoitov](../20210923203046.a3fsogdl37mw56kp%40ast-mbp/)
2021-09-23 21:12                       ` [Andrii Nakryiko](../CAEf4BzZJLFxD%3Dv-NvX%2BMUjrtJHnO9H1C66ymgWFO-ZM39UBonA%40mail.gmail.com/)
2021-09-23 22:28                         ` [Joanne Koong](../7957a053-8b98-1e09-26c8-882df6920e6e%40fb.com/)
2021-09-23 23:46                           ` [Martin KaFai Lau](../20210923234602.3pxuw3kzdayc675j%40kafai-mbp/)
2021-09-24  2:23                           ` [Andrii Nakryiko](../CAEf4BzYx22q5HFEqQ6q5Y0LcambUBDb%2B-YggbwiLDU86QBYvWA%40mail.gmail.com/)
2021-09-24 16:32                             ` [Joanne Koong](../118c7f22-f710-581f-b87e-ee07aced429a%40fb.com/)
2021-09-24 23:12                               ` [Andrii Nakryiko](../CAEf4BzZ1BXyTWmLpfqoGOms02_bwQDgBgEd9LkUM_%2BuDZJo1Og%40mail.gmail.com/)
2021-09-27 16:41                                 ` [Alexei Starovoitov](../20210927164110.gg33uypguty45huk%40ast-mbp.dhcp.thefacebook.com/)
2021-09-27 21:14                                   ` [Andrii Nakryiko](../CAEf4Bzb7bASQ3jXJ3JiKBinnb4ct9Y5pAhn-eVsdCY7rRus8Fg%40mail.gmail.com/)
2021-09-27 23:51                                     ` [Alexei Starovoitov](../20210927235144.7xp3ngebl67egc6a%40ast-mbp.dhcp.thefacebook.com/)
2021-09-28  0:36                                       ` [Andrii Nakryiko](../CAEf4BzY%3DyrSZFJ_dgeS5MSn%2BpTR%2BY9d4am2v%2BUby-TBGn4i%2BCg%40mail.gmail.com/)
2021-09-28 16:21                                         ` [Alexei Starovoitov](../20210928162125.qsidw3zkzsfy4ms2%40ast-mbp.dhcp.thefacebook.com/)
     [not found]                                           ` <[aa967ed2-a958-f995-3a09-bbd6b6e775d4@fb.com](../aa967ed2-a958-f995-3a09-bbd6b6e775d4%40fb.com/)>
2021-09-28 23:54                                             ` [Andrii Nakryiko](../CAEf4BzY08boSQdzC8RKkhoTyMXrSmz%3DUgcb3EJwGyfj05stO1A%40mail.gmail.com/)
2021-09-29  1:54                                               ` [Joanne Koong](../fc94d56e-8d49-40ca-2614-c91a6181296e%40fb.com/)
2021-09-29  0:14                                           ` [Andrii Nakryiko](../CAEf4BzbH8v2m4tJEz2hFU%2BPGxMxP6QrFXcRmD3ESiQi_jqBbtw%40mail.gmail.com/)
2021-09-29  3:17                                             ` [Alexei Starovoitov](../20210929031715.wvicuaf6iixm7xsb%40ast-mbp.dhcp.thefacebook.com/)
2021-09-29  3:38                                               ` [Joanne Koong](../c74f5df1-4953-29ca-2217-e63c3f112463%40fb.com/)
2021-09-28  1:09                                 ` [Martin KaFai Lau](../20210928010946.lrmwfhxopwv6i5ne%40kafai-mbp/)
2021-09-22 20:44       ` [Andrii Nakryiko](../CAEf4BzYpMx6YLs3LJWuNxV2FW_jWQjji8o04jcrK%2BPv3SbQz6g%40mail.gmail.com/)
2021-09-21 21:02 ` [[PATCH v3 bpf-next 2/5] libbpf: Allow the number of hashes in bloom filter maps to be configurable](../20210921210225.4095056-3-joannekoong%40fb.com/) Joanne Koong
2021-09-21 22:24   ` [Joanne Koong](../9d26bf60-6a74-f994-d199-1babcd4b1943%40fb.com/)
2021-09-22 23:14     ` [Andrii Nakryiko](../CAEf4Bza4r3J4pw%2B_xXawSqGTO_iXc9kXu9eVGp1teLsKoVoVNA%40mail.gmail.com/)
2021-09-21 23:57   ` [Andrii Nakryiko](../CAEf4BzYb1FioqRXTGZY%2Bv0ScRSv_5jYdx7KOz47FUjAru8maeQ%40mail.gmail.com/)
2021-09-21 21:02 ` [[PATCH v3 bpf-next 3/5] selftests/bpf: Add bloom filter map test cases](../20210921210225.4095056-4-joannekoong%40fb.com/) Joanne Koong
2021-09-21 21:02 ` [[PATCH v3 bpf-next 4/5] bpf/benchs: Add benchmark test for bloom filter maps](../20210921210225.4095056-5-joannekoong%40fb.com/) Joanne Koong
2021-09-21 21:02 ` [[PATCH v3 bpf-next 5/5] bpf/benchs: Add benchmarks for comparing hashmap lookups with vs. without bloom filter](../20210921210225.4095056-6-joannekoong%40fb.com/) Joanne Koong

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:9c81724e4b9 dfblob:c4424ac2fa0 dfblob:6fc59d61937
dfblob:fec9fcfe062 dfblob:7f33098ca63 dfblob:cf6ca339f3c
dfblob:72254edb24f dfblob:4e50c0bfdb7 dfblob:9865b5b1e66
dfblob:e76b5591790 dfblob:fd2b7f9dcca dfblob:6fc59d61937
dfblob:fec9fcfe062 )
 OR (
bs:"[PATCH v3 bpf-next 1/5] bpf: Add bloom filter map implementation" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20210921210225.4095056-2-joannekoong@fb.com \
    --to=joannekoong@fb.com \
    --cc=Kernel-team@fb.com \
    --cc=bpf@vger.kernel.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```


=== Content from lore.kernel.org_dbd1c655_20250115_112030.html ===

```
[bpf.vger.kernel.org archive mirror](../?t=20210921210502)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Joanne Koong <joannekoong@fb.com>
To: <[bpf@vger.kernel.org](../../bpf/?t=20210921210502)>
Cc: <Kernel-team@fb.com>, Joanne Koong <joannekoong@fb.com>
Subject: [[PATCH v3 bpf-next 1/5] bpf: Add bloom filter map implementation](#r)
Date: Tue, 21 Sep 2021 14:02:21 -0700	[[thread overview]](#r)
Message-ID: <20210921210225.4095056-2-joannekoong@fb.com> (<raw>)
In-Reply-To: <[20210921210225.4095056-1-joannekoong@fb.com](../20210921210225.4095056-1-joannekoong%40fb.com/)>

Bloom filters are a space-efficient probabilistic data structure
used to quickly test whether an element exists in a set.
In a bloom filter, false positives are possible whereas false
negatives should never be.

This patch adds a bloom filter map for bpf programs.
The bloom filter map supports peek (determining whether an element
is present in the map) and push (adding an element to the map)
operations.These operations are exposed to userspace applications
through the already existing syscalls in the following way:

BPF_MAP_LOOKUP_ELEM -> peek
BPF_MAP_UPDATE_ELEM -> push

The bloom filter map does not have keys, only values. In light of
this, the bloom filter map's API matches that of queue stack maps:
user applications use BPF_MAP_LOOKUP_ELEM/BPF_MAP_UPDATE_ELEM
which correspond internally to bpf_map_peek_elem/bpf_map_push_elem,
and bpf programs must use the bpf_map_peek_elem and bpf_map_push_elem
APIs to query or add an element to the bloom filter map. When the
bloom filter map is created, it must be created with a key_size of 0.

For updates, the user will pass in the element to add to the map
as the value, with a NULL key. For lookups, the user will pass in the
element to query in the map as the value. In the verifier layer, this
requires us to modify the argument type of a bloom filter's
BPF_FUNC_map_peek_elem call to ARG_PTR_TO_MAP_VALUE; as well, in
the syscall layer, we need to copy over the user value so that in
bpf_map_peek_elem, we know which specific value to query.

A few things to please take note of:
 * If there are any concurrent lookups + updates, the user is
responsible for synchronizing this to ensure no false negative lookups
occur.
 * The number of hashes to use for the bloom filter is configurable from
userspace. If no number is specified, the default used will be 5 hash
functions. The benchmarks later in this patchset can help compare the
performance of using different number of hashes on different entry
sizes. In general, using more hashes decreases the speed of a lookup,
but increases the false positive rate of an element being detected in the
bloom filter.
 * Deleting an element in the bloom filter map is not supported.
 * The bloom filter map may be used as an inner map.
 * The "max_entries" size that is specified at map creation time is used to
approximate a reasonable bitmap size for the bloom filter, and is not
otherwise strictly enforced. If the user wishes to insert more entries into
the bloom filter than "max_entries", they may do so but they should be
aware that this may lead to a higher false positive rate.

Signed-off-by: Joanne Koong <joannekoong@fb.com>
---
 [include/linux/bpf_types.h](#Z31include:linux:bpf_types.h)      |   1 +
 [include/uapi/linux/bpf.h](#Z31include:uapi:linux:bpf.h)       |   1 +
 [kernel/bpf/Makefile](#Z31kernel:bpf:Makefile)            |   2 +-
 [kernel/bpf/bloom_filter.c](#Z31kernel:bpf:bloom_filter.c)      | 185 +++++++++++++++++++++++++++++++++
 [kernel/bpf/syscall.c](#Z31kernel:bpf:syscall.c)           |  14 ++-
 [kernel/bpf/verifier.c](#Z31kernel:bpf:verifier.c)          |  19 +++-
 [tools/include/uapi/linux/bpf.h](#Z31tools:include:uapi:linux:bpf.h) |   1 +
 7 files [changed](#related), 217 insertions(+), 6 deletions(-)
 create mode 100644 kernel/bpf/bloom_filter.c

[diff](#iZ31include:linux:bpf_types.h) --git a/include/linux/bpf_types.h b/include/linux/bpf_types.h
index 9c81724e4b98..c4424ac2fa02 100644
--- a/include/linux/bpf_types.h
+++ b/include/linux/bpf_types.h
@@ -125,6 +125,7 @@ BPF_MAP_TYPE(BPF_MAP_TYPE_STACK, stack_map_ops)
 BPF_MAP_TYPE(BPF_MAP_TYPE_STRUCT_OPS, bpf_struct_ops_map_ops)
 #endif
 BPF_MAP_TYPE(BPF_MAP_TYPE_RINGBUF, ringbuf_map_ops)
+BPF_MAP_TYPE(BPF_MAP_TYPE_BLOOM_FILTER, bloom_filter_map_ops)

 BPF_LINK_TYPE(BPF_LINK_TYPE_RAW_TRACEPOINT, raw_tracepoint)
 BPF_LINK_TYPE(BPF_LINK_TYPE_TRACING, tracing)
[diff](#iZ31include:uapi:linux:bpf.h) --git a/include/uapi/linux/bpf.h b/include/uapi/linux/bpf.h
index 6fc59d61937a..fec9fcfe0629 100644
--- a/include/uapi/linux/bpf.h
+++ b/include/uapi/linux/bpf.h
@@ -906,6 +906,7 @@ enum bpf_map_type {
 	BPF_MAP_TYPE_RINGBUF,
 	BPF_MAP_TYPE_INODE_STORAGE,
 	BPF_MAP_TYPE_TASK_STORAGE,
+	BPF_MAP_TYPE_BLOOM_FILTER,
 };

 /* Note that tracing related programs such as
[diff](#iZ31kernel:bpf:Makefile) --git a/kernel/bpf/Makefile b/kernel/bpf/Makefile
index 7f33098ca63f..cf6ca339f3cd 100644
--- a/kernel/bpf/Makefile
+++ b/kernel/bpf/Makefile
@@ -7,7 +7,7 @@ endif
 CFLAGS_core.o += $(call cc-disable-warning, override-init) $(cflags-nogcse-yy)

 obj-$(CONFIG_BPF_SYSCALL) += syscall.o verifier.o inode.o helpers.o tnum.o bpf_iter.o map_iter.o task_iter.o prog_iter.o
-obj-$(CONFIG_BPF_SYSCALL) += hashtab.o arraymap.o percpu_freelist.o bpf_lru_list.o lpm_trie.o map_in_map.o
+obj-$(CONFIG_BPF_SYSCALL) += hashtab.o arraymap.o percpu_freelist.o bpf_lru_list.o lpm_trie.o map_in_map.o bloom_filter.o
 obj-$(CONFIG_BPF_SYSCALL) += local_storage.o queue_stack_maps.o ringbuf.o
 obj-$(CONFIG_BPF_SYSCALL) += bpf_local_storage.o bpf_task_storage.o
 obj-${CONFIG_BPF_LSM}	  += bpf_inode_storage.o
[diff](#iZ31kernel:bpf:bloom_filter.c) --git a/kernel/bpf/bloom_filter.c b/kernel/bpf/bloom_filter.c
new file mode 100644
index 000000000000..72254edb24f1
--- /dev/null
+++ b/kernel/bpf/bloom_filter.c
@@ -0,0 +1,185 @@
+// SPDX-License-Identifier: GPL-2.0
+/* Copyright (c) 2021 Facebook */
+
+#include <linux/bitmap.h>
+#include <linux/bpf.h>
+#include <linux/err.h>
+#include <linux/jhash.h>
+#include <linux/random.h>
+
+#define BLOOM_FILTER_CREATE_FLAG_MASK \
+	(BPF_F_NUMA_NODE | BPF_F_ZERO_SEED | BPF_F_ACCESS_MASK)
+
+struct bpf_bloom_filter {
+	struct bpf_map map;
+	u32 bit_array_mask;
+	u32 hash_seed;
+	/* If the size of the values in the bloom filter is u32 aligned,
+	 * then it is more performant to use jhash2 as the underlying hash
+	 * function, else we use jhash. This tracks the number of u32s
+	 * in an u32-aligned value size. If the value size is not u32 aligned,
+	 * this will be 0.
+	 */
+	u32 aligned_u32_count;
+	u32 nr_hash_funcs;
+	unsigned long bit_array[];
+};
+
+static inline u32 hash(struct bpf_bloom_filter *bloom_filter, void *value,
+		       u64 value_size, u32 index)
+{
+	if (bloom_filter->aligned_u32_count)
+		return jhash2(value, bloom_filter->aligned_u32_count,
+			      bloom_filter->hash_seed + index) &
+			bloom_filter->bit_array_mask;
+
+	return jhash(value, value_size, bloom_filter->hash_seed + index) &
+		bloom_filter->bit_array_mask;
+}
+
+static int bloom_filter_map_peek_elem(struct bpf_map *map, void *value)
+{
+	struct bpf_bloom_filter *bloom_filter =
+		container_of(map, struct bpf_bloom_filter, map);
+	u32 i;
+
+	for (i = 0; i < bloom_filter->nr_hash_funcs; i++) {
+		if (!test_bit(hash(bloom_filter, value, map->value_size, i),
+			      bloom_filter->bit_array))
+			return -ENOENT;
+	}
+
+	return 0;
+}
+
+static struct bpf_map *bloom_filter_map_alloc(union bpf_attr *attr)
+{
+	u32 nr_bits, bit_array_bytes, bit_array_mask;
+	int numa_node = bpf_map_attr_numa_node(attr);
+	struct bpf_bloom_filter *bloom_filter;
+	u32 nr_hash_funcs;
+
+	if (!bpf_capable())
+		return ERR_PTR(-EPERM);
+
+	if (attr->key_size != 0 || attr->value_size == 0 || attr->max_entries == 0 ||
+	    attr->map_flags & ~BLOOM_FILTER_CREATE_FLAG_MASK ||
+	    !bpf_map_flags_access_ok(attr->map_flags))
+		return ERR_PTR(-EINVAL);
+
+	/* Default to 5 if no number of hash functions was specified */
+	nr_hash_funcs = attr->nr_hash_funcs == 0 ? 5 : attr->nr_hash_funcs;
+
+	/* For the bloom filter, the optimal bit array size that minimizes the
+	 * false positive probability is n * k / ln(2) where n is the number of
+	 * expected entries in the bloom filter and k is the number of hash
+	 * functions. We use 7 / 5 to approximate 1 / ln(2).
+	 *
+	 * We round this up to the nearest power of two to enable more efficient
+	 * hashing using bitmasks. The bitmask will be the bit array size - 1.
+	 *
+	 * If this overflows a u32, the bit array size will have 2^32 (4
+	 * GB) bits.
+	 */
+	if (check_mul_overflow(attr->max_entries, nr_hash_funcs, &nr_bits) ||
+	    check_mul_overflow(nr_bits / 5, (u32)7, &nr_bits) ||
+	    nr_bits > (1UL << 31)) {
+		/* The bit array size is 2^32 bits but to avoid overflowing the
+		 * u32, we use BITS_TO_BYTES(U32_MAX), which will round up to the
+		 * equivalent number of bytes
+		 */
+		bit_array_bytes = BITS_TO_BYTES(U32_MAX);
+		bit_array_mask = U32_MAX;
+	} else {
+		if (nr_bits <= BITS_PER_LONG)
+			nr_bits = BITS_PER_LONG;
+		else
+			nr_bits = roundup_pow_of_two(nr_bits);
+		bit_array_bytes = BITS_TO_BYTES(nr_bits);
+		bit_array_mask = nr_bits - 1;
+	}
+
+	bit_array_bytes = roundup(bit_array_bytes, sizeof(unsigned long));
+	bloom_filter = bpf_map_area_alloc(sizeof(*bloom_filter) + bit_array_bytes,
+					  numa_node);
+
+	if (!bloom_filter)
+		return ERR_PTR(-ENOMEM);
+
+	bpf_map_init_from_attr(&bloom_filter->map, attr);
+
+	bloom_filter->nr_hash_funcs = nr_hash_funcs;
+	bloom_filter->bit_array_mask = bit_array_mask;
+	if ((attr->value_size & (sizeof(u32) - 1)) == 0)
+		bloom_filter->aligned_u32_count = attr->value_size / sizeof(u32);
+
+	if (!(attr->map_flags & BPF_F_ZERO_SEED))
+		bloom_filter->hash_seed = get_random_int();
+
+	return &bloom_filter->map;
+}
+
+static void bloom_filter_map_free(struct bpf_map *map)
+{
+	struct bpf_bloom_filter *bloom_filter =
+		container_of(map, struct bpf_bloom_filter, map);
+
+	bpf_map_area_free(bloom_filter);
+}
+
+static int bloom_filter_map_push_elem(struct bpf_map *map, void *value,
+				      u64 flags)
+{
+	struct bpf_bloom_filter *bloom_filter =
+		container_of(map, struct bpf_bloom_filter, map);
+	u32 i;
+
+	if (flags != BPF_ANY)
+		return -EINVAL;
+
+	for (i = 0; i < bloom_filter->nr_hash_funcs; i++)
+		set_bit(hash(bloom_filter, value, map->value_size, i),
+			bloom_filter->bit_array);
+
+	return 0;
+}
+
+static void *bloom_filter_map_lookup_elem(struct bpf_map *map, void *key)
+{
+	/* The eBPF program should use map_peek_elem instead */
+	return ERR_PTR(-EINVAL);
+}
+
+static int bloom_filter_map_update_elem(struct bpf_map *map, void *key,
+					void *value, u64 flags)
+{
+	/* The eBPF program should use map_push_elem instead */
+	return -EINVAL;
+}
+
+static int bloom_filter_map_delete_elem(struct bpf_map *map, void *key)
+{
+	return -EOPNOTSUPP;
+}
+
+static int bloom_filter_map_get_next_key(struct bpf_map *map, void *key,
+					 void *next_key)
+{
+	return -EOPNOTSUPP;
+}
+
+static int bloom_filter_map_btf_id;
+const struct bpf_map_ops bloom_filter_map_ops = {
+	.map_meta_equal = bpf_map_meta_equal,
+	.map_alloc = bloom_filter_map_alloc,
+	.map_free = bloom_filter_map_free,
+	.map_push_elem = bloom_filter_map_push_elem,
+	.map_peek_elem = bloom_filter_map_peek_elem,
+	.map_lookup_elem = bloom_filter_map_lookup_elem,
+	.map_update_elem = bloom_filter_map_update_elem,
+	.map_delete_elem = bloom_filter_map_delete_elem,
+	.map_get_next_key = bloom_filter_map_get_next_key,
+	.map_check_btf = map_check_no_btf,
+	.map_btf_name = "bpf_bloom_filter",
+	.map_btf_id = &bloom_filter_map_btf_id,
+};
[diff](#iZ31kernel:bpf:syscall.c) --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
index 4e50c0bfdb7d..9865b5b1e667 100644
--- a/kernel/bpf/syscall.c
+++ b/kernel/bpf/syscall.c
@@ -199,7 +199,8 @@ static int bpf_map_update_value(struct bpf_map *map, struct fd f, void *key,
 		err = bpf_fd_reuseport_array_update_elem(map, key, value,
 							 flags);
 	} else if (map->map_type == BPF_MAP_TYPE_QUEUE ||
-		   map->map_type == BPF_MAP_TYPE_STACK) {
+		   map->map_type == BPF_MAP_TYPE_STACK ||
+		   map->map_type == BPF_MAP_TYPE_BLOOM_FILTER) {
 		err = map->ops->map_push_elem(map, value, flags);
 	} else {
 		rcu_read_lock();
@@ -238,7 +239,8 @@ static int bpf_map_copy_value(struct bpf_map *map, void *key, void *value,
 	} else if (map->map_type == BPF_MAP_TYPE_REUSEPORT_SOCKARRAY) {
 		err = bpf_fd_reuseport_array_lookup_elem(map, key, value);
 	} else if (map->map_type == BPF_MAP_TYPE_QUEUE ||
-		   map->map_type == BPF_MAP_TYPE_STACK) {
+		   map->map_type == BPF_MAP_TYPE_STACK ||
+		   map->map_type == BPF_MAP_TYPE_BLOOM_FILTER) {
 		err = map->ops->map_peek_elem(map, value);
 	} else if (map->map_type == BPF_MAP_TYPE_STRUCT_OPS) {
 		/* struct_ops map requires directly updating "value" */
@@ -1080,6 +1082,14 @@ static int map_lookup_elem(union bpf_attr *attr)
 	if (!value)
 		goto free_key;

+	if (map->map_type == BPF_MAP_TYPE_BLOOM_FILTER) {
+		if (copy_from_user(value, uvalue, value_size))
+			err = -EFAULT;
+		else
+			err = bpf_map_copy_value(map, key, value, attr->flags);
+		goto free_value;
+	}
+
 	err = bpf_map_copy_value(map, key, value, attr->flags);
 	if (err)
 		goto free_value;
[diff](#iZ31kernel:bpf:verifier.c) --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c
index e76b55917905..fd2b7f9dccae 100644
--- a/kernel/bpf/verifier.c
+++ b/kernel/bpf/verifier.c
@@ -4813,7 +4813,10 @@ static int resolve_map_arg_type(struct bpf_verifier_env *env,
 			return -EINVAL;
 		}
 		break;
-
+	case BPF_MAP_TYPE_BLOOM_FILTER:
+		if (meta->func_id == BPF_FUNC_map_peek_elem)
+			*arg_type = ARG_PTR_TO_MAP_VALUE;
+		break;
 	default:
 		break;
 	}
@@ -5388,6 +5391,11 @@ static int check_map_func_compatibility(struct bpf_verifier_env *env,
 		    func_id != BPF_FUNC_task_storage_delete)
 			goto error;
 		break;
+	case BPF_MAP_TYPE_BLOOM_FILTER:
+		if (func_id != BPF_FUNC_map_push_elem &&
+		    func_id != BPF_FUNC_map_peek_elem)
+			goto error;
+		break;
 	default:
 		break;
 	}
@@ -5455,13 +5463,18 @@ static int check_map_func_compatibility(struct bpf_verifier_env *env,
 		    map->map_type != BPF_MAP_TYPE_SOCKHASH)
 			goto error;
 		break;
-	case BPF_FUNC_map_peek_elem:
 	case BPF_FUNC_map_pop_elem:
-	case BPF_FUNC_map_push_elem:
 		if (map->map_type != BPF_MAP_TYPE_QUEUE &&
 		    map->map_type != BPF_MAP_TYPE_STACK)
 			goto error;
 		break;
+	case BPF_FUNC_map_push_elem:
+	case BPF_FUNC_map_peek_elem:
+		if (map->map_type != BPF_MAP_TYPE_QUEUE &&
+		    map->map_type != BPF_MAP_TYPE_STACK &&
+		    map->map_type != BPF_MAP_TYPE_BLOOM_FILTER)
+			goto error;
+		break;
 	case BPF_FUNC_sk_storage_get:
 	case BPF_FUNC_sk_storage_delete:
 		if (map->map_type != BPF_MAP_TYPE_SK_STORAGE)
[diff](#iZ31tools:include:uapi:linux:bpf.h) --git a/tools/include/uapi/linux/bpf.h b/tools/include/uapi/linux/bpf.h
index 6fc59d61937a..fec9fcfe0629 100644
--- a/tools/include/uapi/linux/bpf.h
+++ b/tools/include/uapi/linux/bpf.h
@@ -906,6 +906,7 @@ enum bpf_map_type {
 	BPF_MAP_TYPE_RINGBUF,
 	BPF_MAP_TYPE_INODE_STORAGE,
 	BPF_MAP_TYPE_TASK_STORAGE,
+	BPF_MAP_TYPE_BLOOM_FILTER,
 };

 /* Note that tracing related programs such as
--
2.30.2

```

---

```
[next](../CAEf4BzZfeGGv%2BgBbfBJq5W8eQESgdqeNaByk-agOgMaB8BjQhA%40mail.gmail.com/) [prev parent](../20210921210225.4095056-1-joannekoong%40fb.com/) [reply](#R)	other threads:[[~2021-09-21 21:05 UTC](../?t=20210921210502)|[newest](../)]

Thread overview: 37+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2021-09-21 21:02 [[PATCH v3 bpf-next 0/5] Implement bloom filter map](../20210921210225.4095056-1-joannekoong%40fb.com/) Joanne Koong
2021-09-21 21:02 ` [Joanne Koong [this message]](#t)
2021-09-21 23:44   ` [[PATCH v3 bpf-next 1/5] bpf: Add bloom filter map implementation](../CAEf4BzZfeGGv%2BgBbfBJq5W8eQESgdqeNaByk-agOgMaB8BjQhA%40mail.gmail.com/) Andrii Nakryiko
2021-09-22 19:06     ` [Joanne Koong](../517a137d-66aa-8aa8-a064-fad8ae0c7fa8%40fb.com/)
2021-09-22 19:38       ` [Martin KaFai Lau](../20210922193827.ypqlt3ube4cbbp5a%40kafai-mbp.dhcp.thefacebook.com/)
2021-09-22 20:52         ` [Andrii Nakryiko](../CAEf4BzYi3VXdMctKVFsDqG%2B_nDTSGooJ2sSkF1FuKkqDKqc82g%40mail.gmail.com/)
2021-09-22 22:08           ` [Martin KaFai Lau](../20210922220844.ihzoapwytaz2o7nn%40kafai-mbp.dhcp.thefacebook.com/)
2021-09-22 23:07             ` [Andrii Nakryiko](../CAEf4BzaQ42NTx9tcP43N-%2BSkXbFin9U%2BjSVy6HAmO8e%2BCci5Dw%40mail.gmail.com/)
2021-09-23  1:28               ` [Martin KaFai Lau](../20210923012849.qfgammwxxcd47fgn%40kafai-mbp.dhcp.thefacebook.com/)
2021-09-23 18:42                 ` [Andrii Nakryiko](../CAEf4BzYstaeBBOPsA%2BstMOmZ%2BoBh384E2sY7P8GOtsZFfN%3Dg0w%40mail.gmail.com/)
2021-09-23 19:42                   ` [Martin KaFai Lau](../20210923194233.og5pamu6g7xfnsmp%40kafai-mbp/)
2021-09-23 20:30                     ` [Alexei Starovoitov](../20210923203046.a3fsogdl37mw56kp%40ast-mbp/)
2021-09-23 21:12                       ` [Andrii Nakryiko](../CAEf4BzZJLFxD%3Dv-NvX%2BMUjrtJHnO9H1C66ymgWFO-ZM39UBonA%40mail.gmail.com/)
2021-09-23 22:28                         ` [Joanne Koong](../7957a053-8b98-1e09-26c8-882df6920e6e%40fb.com/)
2021-09-23 23:46                           ` [Martin KaFai Lau](../20210923234602.3pxuw3kzdayc675j%40kafai-mbp/)
2021-09-24  2:23                           ` [Andrii Nakryiko](../CAEf4BzYx22q5HFEqQ6q5Y0LcambUBDb%2B-YggbwiLDU86QBYvWA%40mail.gmail.com/)
2021-09-24 16:32                             ` [Joanne Koong](../118c7f22-f710-581f-b87e-ee07aced429a%40fb.com/)
2021-09-24 23:12                               ` [Andrii Nakryiko](../CAEf4BzZ1BXyTWmLpfqoGOms02_bwQDgBgEd9LkUM_%2BuDZJo1Og%40mail.gmail.com/)
2021-09-27 16:41                                 ` [Alexei Starovoitov](../20210927164110.gg33uypguty45huk%40ast-mbp.dhcp.thefacebook.com/)
2021-09-27 21:14                                   ` [Andrii Nakryiko](../CAEf4Bzb7bASQ3jXJ3JiKBinnb4ct9Y5pAhn-eVsdCY7rRus8Fg%40mail.gmail.com/)
2021-09-27 23:51                                     ` [Alexei Starovoitov](../20210927235144.7xp3ngebl67egc6a%40ast-mbp.dhcp.thefacebook.com/)
2021-09-28  0:36                                       ` [Andrii Nakryiko](../CAEf4BzY%3DyrSZFJ_dgeS5MSn%2BpTR%2BY9d4am2v%2BUby-TBGn4i%2BCg%40mail.gmail.com/)
2021-09-28 16:21                                         ` [Alexei Starovoitov](../20210928162125.qsidw3zkzsfy4ms2%40ast-mbp.dhcp.thefacebook.com/)
     [not found]                                           ` <[aa967ed2-a958-f995-3a09-bbd6b6e775d4@fb.com](../aa967ed2-a958-f995-3a09-bbd6b6e775d4%40fb.com/)>
2021-09-28 23:54                                             ` [Andrii Nakryiko](../CAEf4BzY08boSQdzC8RKkhoTyMXrSmz%3DUgcb3EJwGyfj05stO1A%40mail.gmail.com/)
2021-09-29  1:54                                               ` [Joanne Koong](../fc94d56e-8d49-40ca-2614-c91a6181296e%40fb.com/)
2021-09-29  0:14                                           ` [Andrii Nakryiko](../CAEf4BzbH8v2m4tJEz2hFU%2BPGxMxP6QrFXcRmD3ESiQi_jqBbtw%40mail.gmail.com/)
2021-09-29  3:17                                             ` [Alexei Starovoitov](../20210929031715.wvicuaf6iixm7xsb%40ast-mbp.dhcp.thefacebook.com/)
2021-09-29  3:38                                               ` [Joanne Koong](../c74f5df1-4953-29ca-2217-e63c3f112463%40fb.com/)
2021-09-28  1:09                                 ` [Martin KaFai Lau](../20210928010946.lrmwfhxopwv6i5ne%40kafai-mbp/)
2021-09-22 20:44       ` [Andrii Nakryiko](../CAEf4BzYpMx6YLs3LJWuNxV2FW_jWQjji8o04jcrK%2BPv3SbQz6g%40mail.gmail.com/)
2021-09-21 21:02 ` [[PATCH v3 bpf-next 2/5] libbpf: Allow the number of hashes in bloom filter maps to be configurable](../20210921210225.4095056-3-joannekoong%40fb.com/) Joanne Koong
2021-09-21 22:24   ` [Joanne Koong](../9d26bf60-6a74-f994-d199-1babcd4b1943%40fb.com/)
2021-09-22 23:14     ` [Andrii Nakryiko](../CAEf4Bza4r3J4pw%2B_xXawSqGTO_iXc9kXu9eVGp1teLsKoVoVNA%40mail.gmail.com/)
2021-09-21 23:57   ` [Andrii Nakryiko](../CAEf4BzYb1FioqRXTGZY%2Bv0ScRSv_5jYdx7KOz47FUjAru8maeQ%40mail.gmail.com/)
2021-09-21 21:02 ` [[PATCH v3 bpf-next 3/5] selftests/bpf: Add bloom filter map test cases](../20210921210225.4095056-4-joannekoong%40fb.com/) Joanne Koong
2021-09-21 21:02 ` [[PATCH v3 bpf-next 4/5] bpf/benchs: Add benchmark test for bloom filter maps](../20210921210225.4095056-5-joannekoong%40fb.com/) Joanne Koong
2021-09-21 21:02 ` [[PATCH v3 bpf-next 5/5] bpf/benchs: Add benchmarks for comparing hashmap lookups with vs. without bloom filter](../20210921210225.4095056-6-joannekoong%40fb.com/) Joanne Koong

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:9c81724e4b9 dfblob:c4424ac2fa0 dfblob:6fc59d61937
dfblob:fec9fcfe062 dfblob:7f33098ca63 dfblob:cf6ca339f3c
dfblob:72254edb24f dfblob:4e50c0bfdb7 dfblob:9865b5b1e66
dfblob:e76b5591790 dfblob:fd2b7f9dcca dfblob:6fc59d61937
dfblob:fec9fcfe062 )
 OR (
bs:"[PATCH v3 bpf-next 1/5] bpf: Add bloom filter map implementation" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20210921210225.4095056-2-joannekoong@fb.com \
    --to=joannekoong@fb.com \
    --cc=Kernel-team@fb.com \
    --cc=bpf@vger.kernel.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

