=== Content from github.com_1d3f689d_20250114_211557.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F92dba16749fae36c246bec3f9ba474d9ddeb7662)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F92dba16749fae36c246bec3f9ba474d9ddeb7662)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/92dba16749fae36c246bec3f9ba474d9ddeb7662)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Prevent a null-pointer dereference / `CHECK`-fail in grappler.

[Browse files](/tensorflow/tensorflow/tree/92dba16749fae36c246bec3f9ba474d9ddeb7662)
Browse the repository at this point in the history

```
PiperOrigin-RevId: 409187354
Change-Id: I369c249cca32e6c56ec193f0ebbf2f2768fc7d43
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 11, 2021

1 parent
[1cda4d4](/tensorflow/tensorflow/commit/1cda4d4a26acea3814d06e7d9525772ab357fc1c)

commit 92dba16

Showing
**1 changed file**
with
**4 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 4 additions & 2 deletions

6
[tensorflow/core/grappler/optimizers/dependency\_optimizer.cc](#diff-0fa9e5ce4d31c88f238608dd839882d051f20bc3b376bb4ff79684dc78582a1d "tensorflow/core/grappler/optimizers/dependency_optimizer.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/92dba16749fae36c246bec3f9ba474d9ddeb7662/tensorflow/core/grappler/optimizers/dependency_optimizer.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -75,8 +75,10 @@ bool DependencyOptimizer::SafeToRemoveIdentity(const NodeDef& node) const { |
|  |  | } |
|  |  |  |
|  |  | const NodeDef\* input = node\_map\_->GetNode(NodeName(node.input(0))); |
|  |  | CHECK(input != nullptr) << "node = " << node.name() |
|  |  | << " input = " << node.input(0); |
|  |  | if (input == nullptr) { |
|  |  | VLOG(1) << "node = " << node.name() << " input = " << node.input(0); |
|  |  | return false; |
|  |  | } |
|  |  | // Don't remove Identity nodes corresponding to Variable reads or following |
|  |  | // Recv. |
|  |  | if (IsVariable(\*input) || IsRecv(\*input)) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `92dba16`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F92dba16749fae36c246bec3f9ba474d9ddeb7662) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3d6c3817_20250114_211557.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-5f2r-qp73-37mr)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-5f2r-qp73-37mr)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# `CHECK`-failures during Grappler's `SafeToRemoveIdentity`

Moderate

[mihaimaruseac](/mihaimaruseac)
published
GHSA-5f2r-qp73-37mr
Feb 2, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.8.0

## Patched versions

2.5.3, 2.6.3, 2.7.1

## Description

### Impact

The Grappler optimizer in TensorFlow can be used to cause a denial of service by altering a `SavedModel` such that [`SafeToRemoveIdentity`](https://github.com/tensorflow/tensorflow/blob/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/dependency_optimizer.cc#L59-L98) would trigger `CHECK` failures.

### Patches

We have patched the issue in GitHub commit [92dba16749fae36c246bec3f9ba474d9ddeb7662](https://github.com/tensorflow/tensorflow/commit/92dba16749fae36c246bec3f9ba474d9ddeb7662).

The fix will be included in TensorFlow 2.8.0. We will also cherrypick this commit on TensorFlow 2.7.1, TensorFlow 2.6.3, and TensorFlow 2.5.3, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Moderate

### CVE ID

CVE-2022-23579

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_427d7a35_20250114_211555.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fgrappler%2Foptimizers%2Fdependency_optimizer.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fgrappler%2Foptimizers%2Fdependency_optimizer.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[grappler](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler)
5. /[optimizers](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers)
/
# dependency\_optimizer.cc

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/dependency_optimizer.cc)791 lines (736 loc) · 30.7 KB a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[grappler](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler)
5. /[optimizers](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers)
/
# dependency\_optimizer.cc

Top
## File metadata and controls

* Code
* Blame

791 lines (736 loc) · 30.7 KB[Raw](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/dependency_optimizer.cc)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791/\* Copyright 2017 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
#include "tensorflow/core/grappler/optimizers/dependency\_optimizer.h"
#include <unordered\_set>
#include "absl/container/flat\_hash\_map.h"#include "tensorflow/core/framework/node\_def.pb.h"#include "tensorflow/core/framework/node\_def\_util.h"#include "tensorflow/core/framework/op.h"#include "tensorflow/core/grappler/costs/graph\_properties.h"#include "tensorflow/core/grappler/grappler\_item.h"#include "tensorflow/core/grappler/op\_types.h"#include "tensorflow/core/grappler/optimizers/constant\_folding.h"#include "tensorflow/core/grappler/utils.h"#include "tensorflow/core/grappler/utils/topological\_sort.h"#include "tensorflow/core/lib/core/errors.h"#include "tensorflow/core/lib/core/stringpiece.h"#include "tensorflow/core/lib/gtl/inlined\_vector.h"#include "tensorflow/core/lib/strings/str\_util.h"#include "tensorflow/core/lib/strings/strcat.h"#include "tensorflow/core/util/device\_name\_utils.h"
namespace tensorflow {namespace grappler {
namespace {
bool RemoveControlInput(NodeDef\* node, const string& control\_input\_to\_remove, NodeMap\* node\_map) { for (int pos = node->input\_size() - 1; pos >= 0; --pos) { const string& input = node->input(pos); if (input[0] != '^') break; if (input == control\_input\_to\_remove) { node->mutable\_input()->SwapElements(pos, node->input\_size() - 1); node->mutable\_input()->RemoveLast(); node\_map->RemoveOutput(NodeName(input), node->name()); return true; } } return false;}
} // namespace
bool DependencyOptimizer::SafeToRemoveIdentity(const NodeDef& node) const { if (!IsIdentity(node) && !IsIdentityN(node)) { return true; }
 if (nodes\_to\_preserve\_.find(node.name()) != nodes\_to\_preserve\_.end()) { return false; } if (!fetch\_nodes\_known\_) { // The output values of this node may be needed. return false; }
 if (node.input\_size() < 1) { // Node lacks input, is invalid return false; }
 const NodeDef\* input = node\_map\_->GetNode(NodeName(node.input(0))); CHECK(input != nullptr) << "node = " << node.name() << " input = " << node.input(0); // Don't remove Identity nodes corresponding to Variable reads or following // Recv. if (IsVariable(\*input) || IsRecv(\*input)) { return false; } for (const auto& consumer : node\_map\_->GetOutputs(node.name())) { if (node.input\_size() > 1 && (IsRetval(\*consumer) || IsMerge(\*consumer))) { return false; } if (IsSwitch(\*input)) { for (const string& consumer\_input : consumer->input()) { if (consumer\_input == AsControlDependency(node.name())) { return false; } } } } return true;}
bool DependencyOptimizer::SafeToConvertToNoOp(const NodeDef& node) const { if (HasRegularOutputs(node, \*node\_map\_)) { // The output values of this node may be needed. VLOG(3) << "Not safe to convert '" << node.name() << " to NoOp. Node has outputs."; return false; } if (!fetch\_nodes\_known\_) { VLOG(3) << "Not safe to convert '" << node.name() << " to NoOp. Fetches unknown."; return false; } if (nodes\_to\_preserve\_.find(node.name()) != nodes\_to\_preserve\_.end()) { VLOG(3) << "Not safe to convert to NoOp: " << node.name() << " is in preserve set."; return false; } if (IsMerge(node) || IsSwitch(node) || ModifiesFrameInfo(node)) { VLOG(3) << "Not safe to convert '" << node.name() << " to NoOp. Node modifies frame info."; return false; } // Ops reading variables are marked as stateful, but are safe to remove if // redundant. static const absl::flat\_hash\_set<string>\* gather\_ops = new absl::flat\_hash\_set<string>{"Gather", "GatherV2", "GatherNd", "ResourceGather", "ResourceGatherNd"}; const bool is\_variable\_read = IsReadVariableOp(node) || IsReadVariablesOp(node) || gather\_ops->find(node.op()) != gather\_ops->end(); if (!is\_variable\_read && !IsFreeOfSideEffect(node)) { VLOG(3) << "Not safe to convert '" << node.name() << " to NoOp. Node has side effect."; return false; } if (node.op().rfind("Submodel", 0) == 0) { return false; } const OpDef\* op\_def = nullptr; Status status = OpRegistry::Global()->LookUpOpDef(node.op(), &op\_def); if (!status.ok() || op\_def->output\_arg\_size() == 0) { return false; } const std::unordered\_set<string> do\_not\_rewrite\_ops{ "Assert", "CheckNumerics", "\_Retval", "\_Arg", "\_ParallelConcatUpdate", "TPUExecute", "TPUCompile", "ControlTrigger"}; if (do\_not\_rewrite\_ops.find(node.op()) != do\_not\_rewrite\_ops.end()) { return false; } if (!SafeToRemoveIdentity(node)) { return false; } return true;}
int DependencyOptimizer::NumEdgesIfBypassed( const NodeDef& node, const std::vector<NodeDef\*>& output\_nodes) const { const bool is\_multi\_input\_identity\_n = IsIdentityN(node) && !IsIdentityNSingleInput(node); const int num\_outputs = output\_nodes.size(); const int num\_inputs = node.input\_size();
 if (is\_multi\_input\_identity\_n) { // multi-input identity\_n with input/output control dependencies will likely // increase number of edges after optimization. int num\_edges\_if\_bypassed(0); for (const string& input\_node\_name : node.input()) { if (IsControlInput(input\_node\_name)) { num\_edges\_if\_bypassed += num\_outputs; } else { ++num\_edges\_if\_bypassed; } }
 for (auto consumer : output\_nodes) { for (int j = 0; j < consumer->input\_size(); ++j) { const TensorId consumer\_input = ParseTensorName(consumer->input(j)); if (consumer\_input.node() == node.name()) { if (IsControlInput(consumer\_input)) { num\_edges\_if\_bypassed += num\_inputs; } else { ++num\_edges\_if\_bypassed; } } } } return num\_edges\_if\_bypassed; } else { return num\_inputs \* num\_outputs; }}
bool DependencyOptimizer::BypassingNodeIsBeneficial( const NodeDef& node, const std::vector<NodeDef\*>& input\_nodes, const std::vector<NodeDef\*>& output\_nodes) const { const bool is\_identity = IsIdentity(node) || IsIdentityNSingleInput(node); const bool is\_multi\_input\_identity\_n = IsIdentityN(node) && !IsIdentityNSingleInput(node); const int num\_outputs = output\_nodes.size(); const int num\_inputs = node.input\_size();
 if (NumEdgesIfBypassed(node, output\_nodes) > num\_inputs + num\_outputs) { return false; }
 // Make sure that we don't increase the number of edges that cross // device boundaries. if ((num\_inputs == 1 && num\_outputs > 1 && input\_nodes[0]->device() != node.device()) || (num\_inputs > 1 && num\_outputs == 1 && output\_nodes[0]->device() != node.device())) { return false; }
 // TODO(rmlarsen): Not all device crossings are equally expensive. // Assign a cost to each based on device affinity and compute a // cost before and after. const string& node\_dev = node.device(); int num\_cross\_in = 0; for (NodeDef\* input\_node : input\_nodes) { num\_cross\_in += static\_cast<int>(input\_node->device() != node\_dev); } int num\_cross\_out = 0; for (NodeDef\* output\_node : output\_nodes) { num\_cross\_out += static\_cast<int>(output\_node->device() != node\_dev); }
 // Make sure we do not increase the number of device crossings. const int num\_cross\_before = num\_cross\_in + num\_cross\_out; int num\_cross\_after = 0; for (NodeDef\* input\_node : input\_nodes) { for (NodeDef\* output\_node : output\_nodes) { num\_cross\_after += static\_cast<int>(input\_node->device() != output\_node->device()); } } if (num\_cross\_after > num\_cross\_before) { return false; }
 if ((is\_identity || is\_multi\_input\_identity\_n) && num\_cross\_in > 0 && num\_cross\_out > 0 && num\_cross\_after > 0) { // This identity node follows a device crossing, so it might be // following a \_Recv node after partitioning. Do not remove such nodes, // unless they only have consumers on the same device as themselves. return false; }
 return true;}
void DependencyOptimizer::OptimizeNode(int node\_idx, SetVector<int>\* nodes\_to\_simplify, std::set<int>\* nodes\_to\_delete) { NodeDef\* node = optimized\_graph\_->mutable\_node(node\_idx); const bool is\_noop = IsNoOp(\*node); const bool is\_identity = IsIdentity(\*node) || IsIdentityNSingleInput(\*node); const bool is\_multi\_input\_identity = IsIdentityN(\*node) && !IsIdentityNSingleInput(\*node); const string node\_name = node->name(); // Constant nodes with no input control dependency are always executed early, // so we can prune all their output control dependencies. if (IsConstant(\*node) && node->input\_size() == 0) { const auto output\_nodes = node\_map\_->GetOutputs(node\_name); for (NodeDef\* fanout : output\_nodes) { bool optimize\_fanout = false; bool data\_connection = false; for (int i = fanout->input\_size() - 1; i >= 0; --i) { const TensorId input\_tensor = ParseTensorName(fanout->input(i)); if (input\_tensor.node() == node\_name) { if (input\_tensor.index() < 0) { fanout->mutable\_input()->SwapElements(i, fanout->input\_size() - 1); fanout->mutable\_input()->RemoveLast(); optimize\_fanout = true; } else { data\_connection = true; } } } if (optimize\_fanout) { nodes\_to\_simplify->PushBack(node\_to\_idx\_[fanout]); if (!data\_connection) { node\_map\_->RemoveOutput(node\_name, fanout->name()); } } } if (node\_map\_->GetOutputs(node\_name).empty() && fetch\_nodes\_known\_ && nodes\_to\_preserve\_.find(node\_name) == nodes\_to\_preserve\_.end()) { // Mark the node for deletion. nodes\_to\_delete->insert(node\_to\_idx\_[node]); } return; }
 // Change ops that only have control dependencies as outputs to NoOps. if (!is\_noop && SafeToConvertToNoOp(\*node)) { VLOG(2) << "\*\*\*\*\* Replacing " << node\_name << " (" << node->op() << ") with NoOp."; // The outputs of this node are not consumed. Replace its inputs with // control dependencies and replace the op itself with the NoOp op. std::unordered\_set<string> ctrl\_inputs; int pos = 0; while (pos < node->input\_size()) { const string old\_input = node->input(pos); if (IsControlInput(old\_input)) { if (!ctrl\_inputs.insert(old\_input).second) { // We found a duplicate control input. Remove it. node->mutable\_input()->SwapElements(pos, node->input\_size() - 1); node->mutable\_input()->RemoveLast(); } else { ++pos; } continue; } // Replace a normal input with a control input. const string ctrl\_input = ConstantFolding::AddControlDependency( old\_input, optimized\_graph\_, node\_map\_.get()); ctrl\_inputs.insert(ctrl\_input); node->set\_input(pos, ctrl\_input); node\_map\_->UpdateInput(node\_name, old\_input, ctrl\_input); const NodeDef\* old\_input\_node = node\_map\_->GetNode(old\_input); nodes\_to\_simplify->PushBack(node\_to\_idx\_[old\_input\_node]); ++pos; } node->set\_op("NoOp"); EraseRegularNodeAttributes(node); DedupControlInputs(node); nodes\_to\_simplify->PushBack(node\_to\_idx\_[node]); return; }
 // Remove NoOp nodes if the product of their fan-in and fan-out is less than // or equal to the sum of the fan-in and fan-out. The non-trivial rewrites // take the following form: // // Case a) // x --^> +------+ x --^> +---+ // y --^> | NoOp | --^> a ==> y --^> | a | // ... | | ... | | // z --^> +------+ z --^> +---+ // // Case b) // +------+ --^> a +---+ --^> a // x --^> | NoOp | --^> b ==> | x | --^> b // | | ... | | ... // +------+ --^> c +---+ --^> c // Case c) // +------+ x ---^> a // x --^> | NoOp | --^> a ==> \/ // y --^> | | --^> b /\ // +------+ y ---^> b // // We only apply this optimization if we don't increase the number of control // edges across device boundaries, e.g. in cases a) and b) if NoOp and // a and x, respectively, are on the same device. Control edges across device // boundaries require inter-device communication (Send/Recv pairs to be // inserted in the graph), which is very costly. // // We also remove identity nodes, subject to the same constraints on number of // resulting control edges and device boundary crossings: // // Case a) // +----------+ ---> a +---+ ---> a // x --> | Identity | --^> b ==> | x | --^> b // | | ... | | ... // +----------+ --^> c +---+ --^> c // // Case b) // x ---> +----------+ ---> a x ---> +---+ // y --^> | Identity | ==> y --^> | a | // ... | | ... | | // z --^> +----------+ z --^> +---+ // // Case c) // +----------+ x ---> +---+ // x ---> | Identity | ---> a ==> \--^> | a | // y --^> | | --^> b /\ +---+ // +----------+ y --^> b
 if (is\_noop || ((is\_identity || is\_multi\_input\_identity) && SafeToRemoveIdentity(\*node))) { const int num\_inputs = node->input\_size(); std::vector<NodeDef\*> input\_nodes; for (int i = 0; i < num\_inputs; ++i) { NodeDef\* input\_node = node\_map\_->GetNode(node->input(i)); if (input\_node == nullptr) { LOG(ERROR) << "Invalid input " << node->input(i); return; } input\_nodes.push\_back(input\_node); } const auto& output\_node\_set = node\_map\_->GetOutputs(node\_name); const std::vector<NodeDef\*> output\_nodes(output\_node\_set.begin(), output\_node\_set.end());
 if (!BypassingNodeIsBeneficial(\*node, input\_nodes, output\_nodes)) { return; }
 VLOG(2) << "\*\*\*\*\* Rerouting input around\n" << node->DebugString(); // Now remove the node and re-wire its inputs to its outputs. for (auto consumer : output\_nodes) { bool updated\_consumer = false; VLOG(2) << "consumer before:\n" << consumer->DebugString(); // Remove dependency on node from consumer. for (int i = 0; i < num\_inputs; ++i) { const NodeDef\* input = input\_nodes[i]; // Forward dependency from input to consumer if it doesn't already // depend on it. if ((is\_identity && i == 0) || (is\_multi\_input\_identity && !IsControlInput(node->input(i)))) { // Replace regular input from Identity node. string new\_input; const string& input\_to\_forward = node->input(i); CHECK(!IsControlInput(input\_to\_forward)); for (int j = 0; j < consumer->input\_size(); ++j) { const TensorId old\_input = ParseTensorName(consumer->input(j)); if (old\_input.node() == node\_name) { if (old\_input.index() == i) { // Regular input new\_input = input\_to\_forward; node\_map\_->UpdateInput(consumer->name(), string(old\_input.node()), new\_input); consumer->set\_input(j, new\_input); } else if (old\_input.index() == -1) { // Control dependency new\_input = AsControlDependency(NodeName(input\_to\_forward)); node\_map\_->UpdateInput(consumer->name(), string(old\_input.node()), new\_input); consumer->set\_input(j, new\_input); } } } updated\_consumer = true; } else { // Forward dependency from input to consumer if it doesn't already // depend on it. if (node\_map\_->GetOutputs(input->name()).count(consumer) == 0) { consumer->add\_input(AsControlDependency(input->name())); node\_map\_->AddOutput(input->name(), consumer->name()); nodes\_to\_simplify->PushBack(node\_to\_idx\_[input]); updated\_consumer = true; } } } updated\_consumer |= RemoveControlInput( consumer, AsControlDependency(node\_name), node\_map\_.get()); if (updated\_consumer) { nodes\_to\_simplify->PushBack(node\_to\_idx\_[consumer]); } VLOG(2) << "consumer after:\n" << consumer->DebugString(); } node\_map\_->RemoveOutputs(node\_name); if (fetch\_nodes\_known\_ && nodes\_to\_preserve\_.find(node\_name) == nodes\_to\_preserve\_.end()) { // Mark the node for deletion. nodes\_to\_delete->insert(node\_idx);
 // Disconnect the node from its inputs to enable further optimizations. node\_map\_->RemoveInputs(node\_name); node->clear\_input(); } }}
void DependencyOptimizer::CleanControlInputs() { for (int i = 0; i < optimized\_graph\_->node\_size(); ++i) { DedupControlInputs(optimized\_graph\_->mutable\_node(i)); }}
Status DependencyOptimizer::OptimizeDependencies() { SetVector<int> nodes\_to\_simplify; std::set<int> nodes\_to\_delete; for (int i = 0; i < optimized\_graph\_->node\_size(); ++i) { const NodeDef& node = optimized\_graph\_->node(i); if (IsNoOp(node) || IsIdentity(node) || IsIdentityN(node) || IsConstant(node) || SafeToConvertToNoOp(node)) { nodes\_to\_simplify.PushBack(i); } } while (!nodes\_to\_simplify.Empty()) { int node\_to\_simplify = nodes\_to\_simplify.PopBack(); // Discard nodes that were marked for deletion already. while (nodes\_to\_delete.find(node\_to\_simplify) != nodes\_to\_delete.end()) { node\_to\_simplify = nodes\_to\_simplify.PopBack(); } OptimizeNode(node\_to\_simplify, &nodes\_to\_simplify, &nodes\_to\_delete); }
 if (fetch\_nodes\_known\_) { VLOG(1) << "Deleted " << nodes\_to\_delete.size() << " out of " << optimized\_graph\_->node\_size() << " nodes."; EraseNodesFromGraph(nodes\_to\_delete, optimized\_graph\_); node\_map\_.reset(new NodeMap(optimized\_graph\_)); BuildNodeToIdx(); } return Status::OK();}
namespace {
enum DistanceFromSource : uint8 { ZERO = 0, ONE = 1, TWO\_OR\_GREATER = 2 };
void LongestPathsLowerBounds( int source, const std::pair<int, int>& target\_range, const std::vector<std::vector<int>>& outputs, std::vector<DistanceFromSource>\* longest\_distance) { std::deque<int> queue; queue.emplace\_front(source); while (!queue.empty()) { int node = queue.front(); queue.pop\_front(); for (int fanout : outputs[node]) { // 1) Only nodes in the target range can be on paths from source to one of // its control outputs. // 2) Since we only need a lower bound on the longest distance, we can // skip nodes for which we have already proven have a path of // length > 1 from the source. if (fanout >= target\_range.first && fanout <= target\_range.second && (\*longest\_distance)[fanout] != TWO\_OR\_GREATER) { (\*longest\_distance)[fanout] = (\*longest\_distance)[fanout] == ZERO ? ONE : TWO\_OR\_GREATER; queue.emplace\_front(fanout); } } }}
} // namespace
Status DependencyOptimizer::TransitiveReduction() { // PRECONDITION: optimized\_graph\_ must be sorted topologically. const int num\_nodes = optimized\_graph\_->node\_size(); // Set up a compressed version of the graph to save a constant factor in the // expensive algorithm below. Also cache the set of control outputs and the // highest index of a target of any control output from each node. int num\_controls = 0; std::vector<std::vector<int>> outputs(num\_nodes); std::vector<gtl::InlinedVector<std::pair<int, int>, 2>> control\_outputs( num\_nodes); // target\_range[i] contains the range of node indices for which to compute // longest paths starting from node i. std::vector<std::pair<int, int>> target\_range(num\_nodes, {num\_nodes, -1}); for (int node\_idx = 0; node\_idx < num\_nodes; ++node\_idx) { const NodeDef& node = optimized\_graph\_->node(node\_idx); if (ModifiesFrameInfo(node) || !HasOpDef(node)) { // Ignore function nodes and nodes that modify frame info. continue; } for (int input\_slot = 0; input\_slot < node.input\_size(); ++input\_slot) { const string& input = node.input(input\_slot); const NodeDef\* input\_node = node\_map\_->GetNode(input); if (ModifiesFrameInfo(\*input\_node) || IsMerge(\*input\_node)) { // Ignore edges from nodes that modify frame info and from Merge nodes, // because we cannot know which of it's input paths executes. continue; } const int input\_node\_idx = node\_to\_idx\_[input\_node]; outputs[input\_node\_idx].push\_back(node\_idx); target\_range[input\_node\_idx].first = std::min(target\_range[input\_node\_idx].first, node\_idx); if (IsControlInput(input)) { ++num\_controls; control\_outputs[input\_node\_idx].emplace\_back(node\_idx, input\_slot); target\_range[input\_node\_idx].second = std::max(target\_range[input\_node\_idx].second, node\_idx); } } }
 // Run the longest path in DAG algorithm for each source node that has control // outputs. If, for any target node of a control output, there exists a path // of length > 1, we can drop that control dependency. int num\_controls\_removed = 0; std::vector<DistanceFromSource> longest\_distance(num\_nodes); // Map from target\_index -> set of (input\_slot, source\_index), representing // the control edges to remove. We sort them in reverse order by input slot, // such that when we swap them out so we don't clobber the // node(target).input() repeated field. typedef std::pair<int, int> InputSlotAndSource; absl::flat\_hash\_map< int, std::set<InputSlotAndSource, std::greater<InputSlotAndSource>>> control\_edges\_to\_remove; for (int source = 0; source < num\_nodes; ++source) { if (target\_range[source].first >= target\_range[source].second || target\_range[source].second <= source) { continue; } // Compute the set of nodes in the transitive fanout of source with // topological sort index in [target\_range.first : target\_range.second]] // to which there exists a path of length 2 or more from source. std::fill(longest\_distance.begin() + target\_range[source].first, longest\_distance.begin() + target\_range[source].second + 1, ZERO); LongestPathsLowerBounds(source, target\_range[source], outputs, &longest\_distance);
 // If the longest path from source to target of a control dependency is // longer than 1, there exists an alternate path, and we can eliminate the // redundant direct control dependency. for (const auto& control\_output : control\_outputs[source]) { const int target = control\_output.first; if (longest\_distance[target] == TWO\_OR\_GREATER) { const int input\_slot = control\_output.second; control\_edges\_to\_remove[target].emplace(input\_slot, source); } } } for (const auto& it : control\_edges\_to\_remove) { const int target = it.first; NodeDef\* target\_node = optimized\_graph\_->mutable\_node(target); for (const InputSlotAndSource& slot\_and\_source : it.second) { const int input\_slot = slot\_and\_source.first; const int source = slot\_and\_source.second; const NodeDef& source\_node = optimized\_graph\_->node(source); CHECK\_LT(input\_slot, target\_node->input\_size()); target\_node->mutable\_input()->SwapElements(input\_slot, target\_node->input\_size() - 1); node\_map\_->RemoveOutput(source\_node.name(), target\_node->name()); target\_node->mutable\_input()->RemoveLast(); ++num\_controls\_removed; } } VLOG(1) << "Removed " << num\_controls\_removed << " out of " << num\_controls << " control dependencies"; return Status::OK();}
void DependencyOptimizer::BuildNodeToIdx() { // Set up &node -> index map. node\_to\_idx\_.clear(); for (int i = 0; i < optimized\_graph\_->node\_size(); ++i) { const NodeDef& node = optimized\_graph\_->node(i); node\_to\_idx\_[&node] = i; }}
// Suppose there are cross-device control inputs to node C from multiple nodes// that are located on another device, e.g., we have control edges:// A->C, B->C// where A and B are on device X and C is on device Y.// We can reduce cross-device communication by introducing an intermediate// NoOp node C' on device X and rewriting the control edges to:// A->C', B->C', C' -> Cvoid DependencyOptimizer::GroupCrossDeviceControlEdges(bool host\_granularity) { VLOG(1) << "DependencyOptimizer::GroupCrossDeviceControlEdges host\_granularity=" << host\_granularity; const int num\_nodes = optimized\_graph\_->node\_size(); for (int i = 0; i < num\_nodes; ++i) { NodeDef\* node = optimized\_graph\_->mutable\_node(i); if (node->device().empty()) continue; string rest, node\_device = node->device(); if (host\_granularity) { DeviceNameUtils::SplitDeviceName(node->device(), &node\_device, &rest); }
 // Creates new noop nodes for devices on which multiple control inputs are // located.
 // Map keyed by device name to the newly introduced Noop node for that // device. A nullptr value means that we have only seen a single node on // that device. std::map<string, NodeDef\*> noops; int num\_noops = 0; for (int j = 0; j < node->input\_size(); ++j) { if (IsControlInput(node->input(j))) { const NodeDef\* input = node\_map\_->GetNode(node->input(j)); if (input == nullptr || input->device().empty()) continue; string input\_device = input->device(); if (host\_granularity) { DeviceNameUtils::SplitDeviceName(input->device(), &input\_device, &rest); } if (input\_device != node\_device) { VLOG(2) << "Cross-device " << node->name() << " " << input->device() << " -> " << node->device(); auto emplace\_result = noops.emplace(input\_device, nullptr); if (!emplace\_result.second && emplace\_result.first->second == nullptr) { VLOG(2) << "Duplicate input device from " << node->name(); // This is the second cross-device control input from the same // device. Creates an intermediate noop node on that device. string group\_name; NodeDef\* noop; // Creates a fresh node name; there may be conflicting names from // a previous iteration of the optimizer. do { group\_name = AddPrefixToNodeName( node->name(), strings::StrCat("GroupCrossDeviceControlEdges\_", num\_noops)); noop = node\_map\_->GetNode(group\_name); ++num\_noops; } while (noop != nullptr); noop = optimized\_graph\_->add\_node(); noop->set\_name(group\_name); noop->set\_device(input->device()); noop->set\_op("NoOp"); node\_map\_->AddNode(noop->name(), noop); emplace\_result.first->second = noop; VLOG(1) << "GroupCrossDeviceControlEdges: Added " << SummarizeNodeDef(\*noop); } } } }
 // Reroute existing control edges to go via the newly introduced NoOp nodes. int pos = 0; while (pos < node->input\_size()) { const string& input\_name = node->input(pos); if (IsControlInput(input\_name)) { NodeDef\* input = node\_map\_->GetNode(input\_name); if (input == nullptr) { ++pos; } else { string input\_device = input->device(); if (host\_granularity) { DeviceNameUtils::SplitDeviceName(input->device(), &input\_device, &rest); } auto it = noops.find(input\_device); if (it == noops.end() || it->second == nullptr) { ++pos; } else { VLOG(2) << "Rewriting input from " << input\_name; node->mutable\_input()->SwapElements(pos, node->input\_size() - 1); node->mutable\_input()->RemoveLast(); it->second->add\_input(AsControlDependency(\*input)); node\_map\_->UpdateOutput(input\_name, node->name(), it->second->name()); } } } else { ++pos; } } for (const auto& entry : noops) { if (entry.second) { node->add\_input(AsControlDependency(\*entry.second)); node\_map\_->AddOutput(entry.second->name(), node->name()); } } }}
Status DependencyOptimizer::Optimize(Cluster\* cluster, const GrapplerItem& item, GraphDef\* optimized\_graph) { optimized\_graph\_ = optimized\_graph; \*optimized\_graph\_ = item.graph; nodes\_to\_preserve\_ = item.NodesToPreserve(); fetch\_nodes\_known\_ = !item.fetch.empty(); CleanControlInputs();
 const int num\_iterations = 2; for (int iteration = 0; iteration < num\_iterations; ++iteration) { GRAPPLER\_RETURN\_IF\_DEADLINE\_EXCEEDED(); Status topo\_sort\_status; // Perform topological sort to prepare the graph for transitive reduction. topo\_sort\_status = TopologicalSort(optimized\_graph\_); // Set up index-based graph datastructures to speed up analysis steps below. node\_map\_.reset(new NodeMap(optimized\_graph\_)); BuildNodeToIdx();
 if (topo\_sort\_status.ok()) { // Remove redundant control dependencies. TF\_RETURN\_IF\_ERROR(TransitiveReduction()); } else { LOG(ERROR) << "Iteration = " << iteration << ", topological sort failed with message: " << topo\_sort\_status.error\_message(); } // Turn nodes with only control outputs into NoOps, prune NoOp and Identity // nodes. TF\_RETURN\_IF\_ERROR(OptimizeDependencies());
 // Dedup control inputs. CleanControlInputs();
 // Merge multiple control edges from the same device. GroupCrossDeviceControlEdges(/\*host\_granularity=\*/false);
 // Merge control edges from the same host to reduce RPC traffic. GroupCrossDeviceControlEdges(/\*host\_granularity=\*/true); }
 return Status::OK();}
} // end namespace grappler} // end namespace tensorflow

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


