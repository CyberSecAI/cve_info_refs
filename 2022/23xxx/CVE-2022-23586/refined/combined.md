=== Content from github.com_3a450a83_20250115_084345.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-43jf-985q-588j)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-43jf-985q-588j)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# Multiple `CHECK`-fails in `function.cc`

Moderate

[mihaimaruseac](/mihaimaruseac)
published
GHSA-43jf-985q-588j
Feb 2, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.8.0

## Patched versions

2.5.3, 2.6.3, 2.7.1

## Description

### Impact

A malicious user can cause a denial of service by altering a `SavedModel` such that [assertions in `function.cc`](https://github.com/tensorflow/tensorflow/blob/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/function.cc) would be falsified and crash the Python interpreter.

### Patches

We have patched the issue in GitHub commits [dcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2](https://github.com/tensorflow/tensorflow/commit/dcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2) and [3d89911481ba6ebe8c88c1c0b595412121e6c645](https://github.com/tensorflow/tensorflow/commit/3d89911481ba6ebe8c88c1c0b595412121e6c645).

The fix will be included in TensorFlow 2.8.0. We will also cherrypick this commit on TensorFlow 2.7.1, TensorFlow 2.6.3, and TensorFlow 2.5.3, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Moderate

### CVE ID

CVE-2022-23586

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_1d57f921_20250115_084345.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fdcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fdcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/dcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Eliminate debug `CHECK`-fail from `function.cc`

[Browse files](/tensorflow/tensorflow/tree/dcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2)
Browse the repository at this point in the history

```
PiperOrigin-RevId: 409416119
Change-Id: I8376ee464d434e9b970ff0ad49edfdaa2a273cfe
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 12, 2021

1 parent
[9550598](/tensorflow/tensorflow/commit/955059813cc325dc1db5e2daa6221271406d4439)

commit dcc21c7

Showing
**1 changed file**
with
**5 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 5 additions & 1 deletion

6
[tensorflow/core/framework/function.cc](#diff-a17a235434650bddd3d2698c9a61db6fa03f7f7d826a1beaccd7baf6dbd86df2 "tensorflow/core/framework/function.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/dcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2/tensorflow/core/framework/function.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -191,7 +191,11 @@ class FunctionInstantiationHelper { |
|  |  | for (size\_t i = 0; i < dtypes.size(); ++i) { |
|  |  | TF\_RETURN\_IF\_ERROR(AddItem(strings::StrCat(arg\_def.name(), ":", i), |
|  |  | {true, arg\_index, 0, false, {dtypes[i]}})); |
|  |  | DCHECK\_EQ(arg\_index, result\_.nodes.size()); |
|  |  | if (arg\_index != result\_.nodes.size()) { |
|  |  | return errors::Internal( |
|  |  | "Expected arg\_index to be equal to the number of nodes in result.", |
|  |  | " Got ", arg\_index, " and ", result\_.nodes.size()); |
|  |  | } |
|  |  | string name = arg\_def.name(); |
|  |  | if (dtypes.size() > 1) { |
|  |  | strings::StrAppend(&name, "\_", i); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `dcc21c7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fdcc21c7bc972b10b6fb95c2fb0f4ab5a59680ec2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a9bb9507_20250115_084343.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fframework%2Ffunction.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fframework%2Ffunction.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[framework](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework)
/
# function.cc

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/function.cc)2034 lines (1851 loc) · 68.7 KB a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[framework](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework)
/
# function.cc

Top
## File metadata and controls

* Code
* Blame

2034 lines (1851 loc) · 68.7 KB[Raw](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/function.cc)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\* Copyright 2015 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
#include "tensorflow/core/framework/function.h"
#include <ctype.h>
#include <map>#include <unordered\_map>#include <utility>#include <vector>
#include "absl/container/flat\_hash\_set.h"#include "absl/strings/escaping.h"#include "absl/strings/str\_cat.h"#include "absl/strings/str\_join.h"#include "tensorflow/core/framework/allocator.h"#include "tensorflow/core/framework/common\_shape\_fns.h"#include "tensorflow/core/framework/function.pb.h"#include "tensorflow/core/framework/graph.pb.h"#include "tensorflow/core/framework/node\_def.pb.h"#include "tensorflow/core/framework/node\_def\_util.h"#include "tensorflow/core/framework/op.h"#include "tensorflow/core/graph/graph.h"#include "tensorflow/core/lib/core/errors.h"#include "tensorflow/core/lib/gtl/inlined\_vector.h"#include "tensorflow/core/lib/gtl/map\_util.h"#include "tensorflow/core/lib/strings/proto\_serialization.h"#include "tensorflow/core/platform/fingerprint.h"#include "tensorflow/core/util/device\_name\_utils.h"#include "tensorflow/core/util/equal\_graph\_def.h"
namespace tensorflow {
/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kArgOp;/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kDeviceArgOp;/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kRetOp;/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kDeviceRetOp;/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kIntsOnDeviceAttr;/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kGradientOp;/\* static \*/ constexpr const char\* const FunctionLibraryDefinition::kFuncAttr;
// Extracts the actual type from "attr\_values" based on its definition// "arg\_def".//// If "arg\_def" is a N\*T type, \*is\_type\_list is set to false, and// \*dtypes is set to be a vector of size N and each element is T.//// If "arg\_def" is a list(type), \*is\_type\_list is set to true, and// \*dtypes is set to be a vector of types specified in attrs for// arg\_def.//// Otherwise (arg\_def is a simple type T), \*is\_type\_list is set to// false, and \*dtypes is set to a single element vector, whose only// element is T.Status ArgNumType(AttrSlice attrs, const OpDef::ArgDef& arg\_def, bool\* is\_type\_list, DataTypeVector\* dtypes) { dtypes->clear(); if (!arg\_def.type\_list\_attr().empty()) { const AttrValue\* v = attrs.Find(arg\_def.type\_list\_attr()); if (v == nullptr) { return errors::NotFound("type attr not found: ", arg\_def.type\_list\_attr()); } \*is\_type\_list = true; for (int i = 0; i < v->list().type\_size(); ++i) { dtypes->push\_back(v->list().type(i)); } return Status::OK(); }
 \*is\_type\_list = false; int num = 1; if (!arg\_def.number\_attr().empty()) { const AttrValue\* v = attrs.Find(arg\_def.number\_attr()); if (v == nullptr) { return errors::NotFound("type attr not found: ", arg\_def.type\_attr()); } num = v->i(); }
 DataType dtype; if (arg\_def.type() != DT\_INVALID) { dtype = arg\_def.type(); } else if (arg\_def.type\_attr().empty()) { dtype = DT\_INVALID; } else { const AttrValue\* v = attrs.Find(arg\_def.type\_attr()); if (v == nullptr) { return errors::NotFound("type attr not found: ", arg\_def.type\_attr()); } dtype = v->type(); } dtypes->resize(num, dtype); return Status::OK();}
namespace {
template <typename T>void AddAttr(const string& name, const T& val, NodeDef\* ndef) { SetAttrValue(val, &((\*ndef->mutable\_attr())[name]));}
Status ValidateSignatureWithAttrs(const OpDef& sig, AttrSlice attr\_values) { // attr\_values should specify all attrs defined in fdef, except for those // which have a default value for (const auto& attr : sig.attr()) { const AttrValue\* attr\_value = attr\_values.Find(attr.name()); if (attr\_value) { Status status = AttrValueHasType(\*attr\_value, attr.type()); if (!status.ok()) { errors::AppendToMessage(&status, "for attr '", attr.name(), "'"); return status; } } else if (!attr.has\_default\_value()) { return errors::NotFound("Attr ", attr.name(), " is not found from ", SummarizeOpDef(sig)); } }
// TODO(josh11b): Enable this code once it works with function gradients.// Right now the C++ function gradient code assumes it can pass// all the attrs of the function to the gradient, and any attrs that// the gradient doesn't care about will be ignored.#if 0 if (attr\_values.size() != sig.attr\_size()) { for (const auto& a : attr\_values) { // TODO(josh11b): Possibly should ignore attrs that start with "\_" here? bool found = false; for (const auto& s : sig.attr()) { if (a.first == s.name()) { found = true; break; } } if (!found) { return errors::NotFound("Attr ", a.first, " is not found in ", SummarizeOpDef(sig)); } } }#endif
 return Status::OK();}
// A helper class for instantiating functions. This contains shared information// like the resulting graph and node name index.class FunctionInstantiationHelper { public: FunctionInstantiationHelper(GetFunctionSignature get\_function, InstantiationResult\* result) : get\_function\_(std ::move(get\_function)), result\_(\*result) { result\_.nodes.clear(); }
 // Builds index for nodes that can be used as node's input arguments. // `resource\_arg\_unique\_id`: if non-negative, will be populated to the // "\_resource\_arg\_unique\_id" attribute of the arg node. Status BuildInputArgIndex(const OpDef::ArgDef& arg\_def, AttrSlice attr\_values, const FunctionDef::ArgAttrs\* arg\_attrs, bool ints\_on\_device, int64\_t resource\_arg\_unique\_id) { bool is\_type\_list; DataTypeVector dtypes; TF\_RETURN\_IF\_ERROR( ArgNumType(attr\_values, arg\_def, &is\_type\_list, &dtypes)); CHECK\_GE(dtypes.size(), size\_t{1}); int arg\_index = result\_.nodes.size(); TF\_RETURN\_IF\_ERROR( AddItem(arg\_def.name(), {true, arg\_index, 0, is\_type\_list, dtypes})); // Creates dtypes.size() nodes in the graph. for (size\_t i = 0; i < dtypes.size(); ++i) { TF\_RETURN\_IF\_ERROR(AddItem(strings::StrCat(arg\_def.name(), ":", i), {true, arg\_index, 0, false, {dtypes[i]}})); DCHECK\_EQ(arg\_index, result\_.nodes.size()); string name = arg\_def.name(); if (dtypes.size() > 1) { strings::StrAppend(&name, "\_", i); } NodeDef\* gnode = AddNode(name); if (ints\_on\_device && dtypes[i] == DataType::DT\_INT32) { gnode->set\_op(FunctionLibraryDefinition::kDeviceArgOp); } else { gnode->set\_op(FunctionLibraryDefinition::kArgOp); } DataType dtype = arg\_def.is\_ref() ? MakeRefType(dtypes[i]) : dtypes[i]; AddAttr("T", dtype, gnode); AddAttr("index", arg\_index, gnode); if (resource\_arg\_unique\_id >= 0) { AddAttr("\_resource\_arg\_unique\_id", resource\_arg\_unique\_id, gnode); } if (arg\_attrs) { for (const auto& arg\_attr : arg\_attrs->attr()) { AddAttr(arg\_attr.first, arg\_attr.second, gnode->mutable\_attr()); } } result\_.arg\_types.push\_back(dtypes[i]); ++arg\_index; } return Status::OK(); }
 Status BuildNodeOutputIndex(const NodeDef& node, AttrSlice attrs, const int arg\_index) { const OpDef\* node\_sig = nullptr; TF\_RETURN\_IF\_ERROR(get\_function\_(node.op(), &node\_sig)); if (node\_sig->output\_arg\_size() == 0) { return AddItem(node.name(), {false, arg\_index, 0, false, {}}); } const int num\_retval = node\_sig->output\_arg\_size(); int start = 0; bool is\_type\_list; DataTypeVector dtypes; for (int i = 0; i < num\_retval; ++i) { TF\_RETURN\_IF\_ERROR( ArgNumType(attrs, node\_sig->output\_arg(i), &is\_type\_list, &dtypes)); // Note that we rely on the backwards-compatibility test enforcing // that output\_arg(\*).name() doesn't change here. const string base\_name = strings::StrCat(node.name(), ":", node\_sig->output\_arg(i).name()); TF\_RETURN\_IF\_ERROR( AddItem(base\_name, {false, arg\_index, start, is\_type\_list, dtypes})); for (int j = 0; j < static\_cast<int>(dtypes.size()); ++j) { TF\_RETURN\_IF\_ERROR( AddItem(strings::StrCat(base\_name, ":", j), {false, arg\_index, start + j, false, {dtypes[j]}})); } start += dtypes.size(); } return Status::OK(); }
 Status InstantiateNode(const NodeDef& fnode, AttrSlice attrs) { const OpDef\* fnode\_sig = nullptr; TF\_CHECK\_OK(get\_function\_(fnode.op(), &fnode\_sig)); NodeDef\* gnode = AddNode(fnode.name()); gnode->set\_op(fnode.op()); gnode->set\_device(fnode.device()); int gnode\_idx = nodes\_.size() - 1;
 // Input const int num\_args = fnode\_sig->input\_arg\_size(); bool is\_type\_list; // ignored DataTypeVector dtypes; int fnode\_arg\_index = 0; for (int i = 0; i < num\_args; ++i) { TF\_RETURN\_IF\_ERROR( ArgNumType(attrs, fnode\_sig->input\_arg(i), &is\_type\_list, &dtypes)); // Consume inputs (indexed by fnode\_arg\_index) until we have // matched each element of dtypes (indexed by j). for (size\_t j = 0; j < dtypes.size(); ++fnode\_arg\_index) { if (fnode\_arg\_index >= fnode.input\_size()) { // Should never happen if we computed dtypes correctly. return errors::InvalidArgument( "Attempt to access beyond input size: ", fnode\_arg\_index, " >= ", fnode.input\_size()); } // Look up the next input. const string& input\_name = fnode.input(fnode\_arg\_index); const auto\* item = GetItemOrNull(input\_name); if (item == nullptr) { return errors::InvalidArgument( "input ", input\_name, " is not found: ", FormatNodeDefForError(fnode)); } if (item->dtypes.size() > dtypes.size() - j) { return errors::InvalidArgument("Input ", input\_name, " too long for ", fnode\_sig->input\_arg(i).name()); } // Match up all the elements of this input (indexed by k) with // elements of dtypes (advancing j). for (int k = 0; k < item->dtypes.size(); ++k, ++j) { if (item->dtypes[k] != dtypes[j]) { return errors::InvalidArgument( "input ", fnode\_sig->input\_arg(i).name(), "[", j, "] expected type ", DataTypeString(dtypes[j]), " != ", DataTypeString(item->dtypes[k]), ", the type of ", input\_name, "[", k, "]"); } if (item->is\_func\_arg) { AddInput(gnode\_idx, item->nid + k, 0); } else { AddInput(gnode\_idx, item->nid, item->idx + k); } } } }
 // Control deps. for (int i = fnode\_arg\_index; i < fnode.input\_size(); ++i) { const string& input = fnode.input(i); if (input.empty() || input[0] != '^') { return errors::InvalidArgument("Expected input[", i, "] == '", input, "' to be a control input."); } int nid = -1; const string node\_name = input.substr(1); const string node\_colon = node\_name + ":"; const string node\_colon\_bound = node\_name + ";"; // index\_ is a map sorted lexicographically, so the key we are looking for // must lie in the range [node\_name, node\_colon\_bound). auto it = index\_.lower\_bound(node\_name); while (it != index\_.end() && it->first <= node\_colon\_bound) { if (it->first == node\_name || absl::StartsWith(it->first, node\_colon)) { nid = it->second.nid; break; } ++it; } if (nid == -1) { return errors::InvalidArgument("input[", i, "] == '", input, "', is not found."); } AddDep(gnode\_idx, nid); }
 // Attrs. for (const auto& p : attrs) { (\*gnode->mutable\_attr())[p.first] = p.second; }
 // Experimental\_debug\_info. if (fnode.has\_experimental\_debug\_info()) { gnode->mutable\_experimental\_debug\_info()->MergeFrom( fnode.experimental\_debug\_info()); }
 // Tye info. // TODO(mdan): Might this need adjustment at instantiation? if (fnode.has\_experimental\_type()) { \*gnode->mutable\_experimental\_type() = fnode.experimental\_type(); }
 return Status::OK(); }
 Status AddReturnNode( const OpDef::ArgDef& ret\_def, AttrSlice attrs, const ::tensorflow::protobuf::Map<string, string>& ret\_map, bool ints\_on\_device, int\* ret\_index) { auto ret\_iter = ret\_map.find(ret\_def.name()); if (ret\_iter == ret\_map.end()) { return errors::InvalidArgument("Return ", ret\_def.name(), " missing."); } bool is\_type\_list; DataTypeVector dtypes; TF\_RETURN\_IF\_ERROR(ArgNumType(attrs, ret\_def, &is\_type\_list, &dtypes)); CHECK\_GE(dtypes.size(), size\_t{1}); const auto\* item = GetItemOrNull(ret\_iter->second); if (item == nullptr) { return errors::InvalidArgument("Return ", ret\_def.name(), " -> ", ret\_iter->second, " is not found."); } if (dtypes != item->dtypes) { return errors::InvalidArgument("Invalid ret types ", ret\_def.name(), " : ", DataTypeVectorString(dtypes), " vs. ", DataTypeVectorString(item->dtypes)); } for (size\_t i = 0; i < dtypes.size(); ++i) { string name = strings::StrCat(ret\_def.name(), "\_RetVal"); if (dtypes.size() > 1) { strings::StrAppend(&name, "\_", i); } NodeDef\* gnode = AddNode(name); if (ints\_on\_device && dtypes[i] == DataType::DT\_INT32) { gnode->set\_op(FunctionLibraryDefinition::kDeviceRetOp); } else { gnode->set\_op(FunctionLibraryDefinition::kRetOp); } AddInput(nodes\_.size() - 1, item->nid, item->idx + i); DataType dtype = ret\_def.is\_ref() ? MakeRefType(dtypes[i]) : dtypes[i]; AddAttr("T", dtype, gnode); AddAttr("index", (\*ret\_index)++, gnode); result\_.ret\_types.push\_back(dtypes[i]); } return Status::OK(); }
 // Adds the actual node inputs to the result graph by converting indexes to // the node names. void AddNodeInputs() { for (int i = 0; i < result\_.nodes.size(); i++) { NodeInfo& node\_info = nodes\_[i]; for (const auto& p : node\_info.data\_inputs) { result\_.nodes[i].add\_input(Name(p.first, p.second)); } for (int index : node\_info.control\_inputs) { result\_.nodes[i].add\_input(Dep(index)); } } }
 private: // This is used to build a small index for all names that can be used as a // node's input arguments. // // If is\_func\_arg is true, the name is a function's argument. In // this case, the produced graph def has node[nid:nid + dtype.size()]. // // Otherwise, the name is a function body's node return value. In // this case, the produced graph def has one node node[nid] and // the node's output index [idx ... idx + num) corresponds to the // named outputs. // // In all cases, "dtype" specifies the data type. struct NameInfoItem { bool is\_func\_arg; int nid; int idx; bool is\_type\_list; DataTypeVector dtypes; };
 // Adds an item into the input name index. Status AddItem(const string& name, const NameInfoItem& item) { if (!index\_.insert({name, item}).second) { return errors::InvalidArgument( strings::StrCat("Duplicated ", item.is\_func\_arg ? "arg" : "ret", " name: "), name); } return Status::OK(); }
 const NameInfoItem\* GetItemOrNull(const string& name) const { return gtl::FindOrNull(index\_, name); }
 string Dep(int node\_index) const { return strings::StrCat("^", Name(node\_index)); }
 string Name(int node\_index) const { CHECK\_LT(node\_index, nodes\_.size()); return nodes\_[node\_index].name; }
 string Name(int node\_index, int output\_index) const { if (output\_index == 0) { return Name(node\_index); } else { return strings::StrCat(Name(node\_index), ":", output\_index); } }
 NodeDef\* AddNode(const string& name) { result\_.nodes.emplace\_back(); NodeDef\* gnode = &result\_.nodes.back(); gnode->set\_name(name); nodes\_.push\_back({name, {}, {}}); CHECK\_EQ(result\_.nodes.size(), nodes\_.size()); return gnode; }
 void AddInput(int node\_index, int output\_node, int output\_index) { CHECK\_LT(node\_index, nodes\_.size()); nodes\_[node\_index].data\_inputs.push\_back( std::make\_pair(output\_node, output\_index)); }
 void AddDep(int node\_index, int dep\_index) { CHECK\_LT(node\_index, nodes\_.size()); nodes\_[node\_index].control\_inputs.push\_back(dep\_index); }
 GetFunctionSignature get\_function\_; InstantiationResult& result\_; // A small index for all names that can be used as a node's input arguments. std::map<string, NameInfoItem> index\_; // This contains information about a node in the new graph including the node // names and input nodes' indexes. struct NodeInfo { string name; // Data inputs where <n, k> means arg k of node n. std::vector<std::pair<int, int>> data\_inputs; // Control inputs (dependencies). std::vector<int> control\_inputs; }; // nodes\_[i] is the information about result\_.nodes[i]. std::vector<NodeInfo> nodes\_;};
// Various helpers Print(proto) to print relevant protos to ascii.string Print(const OpDef::ArgDef& arg) { string out; strings::StrAppend(&out, arg.name(), ":"); if (arg.is\_ref()) strings::StrAppend(&out, "Ref("); if (!arg.number\_attr().empty()) { strings::StrAppend(&out, arg.number\_attr(), "\*"); } if (arg.type() != DT\_INVALID) { strings::StrAppend(&out, DataTypeString(arg.type())); } else { strings::StrAppend(&out, arg.type\_attr()); } if (arg.is\_ref()) strings::StrAppend(&out, ")"); return out;}
// TODO(josh11b): Merge this with SummarizeAttrValue().// When hash\_string\_attrs = true, string attributes are hashed instead of being// truncated with ellipses. This is done to reduce the chance of collisions when// looking up functions using the canonical representation.string Print(const AttrValue& attr\_value, const bool hash\_string\_attrs = false) { if (attr\_value.value\_case() == AttrValue::kType) { return DataTypeString(attr\_value.type()); } else if ((attr\_value.value\_case() == AttrValue::kList) && (attr\_value.list().type\_size() > 0)) { string ret = "{"; for (int i = 0; i < attr\_value.list().type\_size(); ++i) { if (i > 0) strings::StrAppend(&ret, ", "); strings::StrAppend(&ret, DataTypeString(attr\_value.list().type(i))); } strings::StrAppend(&ret, "}"); return ret; } else if (attr\_value.value\_case() == AttrValue::kFunc) { if (attr\_value.func().attr\_size() == 0) { return attr\_value.func().name(); } std::vector<string> entries; for (const auto& p : attr\_value.func().attr()) { entries.push\_back(strings::StrCat(p.first, "=", Print(p.second))); } std::sort(entries.begin(), entries.end()); return strings::StrCat(attr\_value.func().name(), "[", absl::StrJoin(entries, ", "), "]"); } else if (attr\_value.value\_case() == AttrValue::kS && hash\_string\_attrs) { return strings::StrCat(Fingerprint64(attr\_value.s())); } return SummarizeAttrValue(attr\_value);}
// TODO(josh11b): Merge this with SummarizeNodeDef().string Print(const NodeDef& n) { string out; strings::StrAppend(&out, n.name(), " = ", n.op()); if (n.attr\_size() > 0) { std::vector<string> entries; for (auto& a : n.attr()) { entries.push\_back(strings::StrCat(a.first, "=", Print(a.second))); } std::sort(entries.begin(), entries.end()); // Add a short device string at the end of all attributes. if (!n.device().empty()) { DeviceNameUtils::ParsedName parsed; if (DeviceNameUtils::ParseFullName(n.device(), &parsed)) { entries.push\_back( strings::StrCat("device=", parsed.type, ":", parsed.id)); } else { entries.push\_back("device=<FAILED\_TO\_PARSE>"); } } strings::StrAppend(&out, "[", absl::StrJoin(entries, ", "), "]"); } strings::StrAppend(&out, "("); std::vector<StringPiece> dat; std::vector<string> dep; for (StringPiece s : n.input()) { if (absl::ConsumePrefix(&s, "^")) { dep.emplace\_back(s); } else { dat.push\_back(s); } } strings::StrAppend(&out, absl::StrJoin(dat, ", "), ")"); if (!dep.empty()) { strings::StrAppend(&out, " @ ", absl::StrJoin(dep, ", ")); } return out;}
string Print(const FunctionDef& fdef) { string out; const OpDef& sig = fdef.signature(); strings::StrAppend(&out, "\n", sig.name()); if (sig.attr\_size() > 0) { strings::StrAppend(&out, "["); for (int i = 0; i < sig.attr\_size(); ++i) { const auto& a = sig.attr(i); if (i > 0) strings::StrAppend(&out, ", "); if (a.type() == "type") { strings::StrAppend(&out, a.name(), ":", Print(a.allowed\_values())); } else { strings::StrAppend(&out, a.name(), ":", a.type()); } } strings::StrAppend(&out, "]"); } strings::StrAppend(&out, "("); for (int i = 0; i < sig.input\_arg\_size(); ++i) { if (i > 0) strings::StrAppend(&out, ", "); strings::StrAppend(&out, Print(sig.input\_arg(i))); } strings::StrAppend(&out, ") -> ("); for (int i = 0; i < sig.output\_arg\_size(); ++i) { if (i > 0) strings::StrAppend(&out, ", "); strings::StrAppend(&out, Print(sig.output\_arg(i))); } strings::StrAppend(&out, ") {\n"); for (const auto& n : fdef.node\_def()) { strings::StrAppend(&out, " ", Print(n), "\n"); } for (const auto& cr : fdef.control\_ret()) { strings::StrAppend(&out, " @return ", cr.first, " = ", cr.second, "\n"); } for (const auto& r : fdef.ret()) { strings::StrAppend(&out, " return ", r.first, " = ", r.second, "\n"); } strings::StrAppend(&out, "}\n"); return out;}
string Print(gtl::ArraySlice<const NodeDef\*> nodes) { std::vector<const NodeDef\*> arg; std::vector<const NodeDef\*> ret; std::vector<const NodeDef\*> body; for (const NodeDef\* n : nodes) { if (n->op() == FunctionLibraryDefinition::kArgOp || n->op() == FunctionLibraryDefinition::kDeviceArgOp) { arg.push\_back(n); } else if (n->op() == FunctionLibraryDefinition::kRetOp || n->op() == FunctionLibraryDefinition::kDeviceRetOp) { ret.push\_back(n); } else { body.push\_back(n); } } auto comp = [](const NodeDef\* x, const NodeDef\* y) { int xi; TF\_CHECK\_OK(GetNodeAttr(\*x, "index", &xi)); int yi; TF\_CHECK\_OK(GetNodeAttr(\*y, "index", &yi)); return xi < yi; }; std::sort(arg.begin(), arg.end(), comp); std::sort(ret.begin(), ret.end(), comp); string out; strings::StrAppend(&out, "\n("); auto get\_type\_and\_device = [](const NodeDef& n) { DataType dt; if (!TryGetNodeAttr(n, "T", &dt)) { dt = DT\_INVALID; } if (!n.device().empty()) { DeviceNameUtils::ParsedName parsed; if (DeviceNameUtils::ParseFullName(n.device(), &parsed)) { return strings::StrCat(DataTypeString(dt), "@", parsed.type, ":", parsed.id); } else { LOG(WARNING) << "Failed to parse device \"" << n.device() << "\" in " << n.op() << ":" << n.name(); return strings::StrCat(DataTypeString(dt), "@", "<FAILED\_TO\_PARSE\_DEVICE>"); } } return DataTypeString(dt); }; for (size\_t i = 0; i < arg.size(); ++i) { const NodeDef\* n = arg[i]; if (i > 0) strings::StrAppend(&out, ", "); CHECK\_GE(n->attr\_size(), 2); strings::StrAppend(&out, n->name(), ":", get\_type\_and\_device(\*n)); } strings::StrAppend(&out, ") -> ("); for (size\_t i = 0; i < ret.size(); ++i) { const NodeDef\* n = ret[i]; if (i > 0) strings::StrAppend(&out, ", "); CHECK\_LE(2, n->attr\_size());
 // The \_RetVal op should have a unique non-control input. We assert that // here and add it to the output. bool found\_non\_control\_input = false; for (const string& input : n->input()) { if (!input.empty() && input[0] != '^') { DCHECK\_EQ(found\_non\_control\_input, false) << "RetVal node has more than one non-control input: " << absl::StrJoin(n->input(), ", "); strings::StrAppend(&out, n->input(0), ":", get\_type\_and\_device(\*n)); found\_non\_control\_input = true; } } DCHECK\_EQ(found\_non\_control\_input, true) << "RetVal did not have any non-control inputs: " << absl::StrJoin(n->input(), ", "); } strings::StrAppend(&out, ") {\n"); for (size\_t i = 0; i < body.size(); ++i) { strings::StrAppend(&out, " ", Print(\*body[i]), "\n"); } strings::StrAppend(&out, "}\n"); return out;}
Status AddDefaultAttrs(const string& op, const GetFunctionSignature& get\_function, AttrValueMap\* attrs) { const OpDef\* op\_def = nullptr; TF\_RETURN\_IF\_ERROR(get\_function(op, &op\_def)); AttrSlice attr\_slice(attrs); for (const auto& attr\_def : op\_def->attr()) { if (attr\_def.has\_default\_value() && !attr\_slice.Find(attr\_def.name())) { if (!attrs->insert({attr\_def.name(), attr\_def.default\_value()}).second) { return errors::Internal("Somehow duplicated: ", attr\_def.name()); } } } return Status::OK();}
} // end namespace
Status InstantiateFunction(const FunctionDef& fdef, AttrSlice attr\_values, GetFunctionSignature get\_function, InstantiationResult\* result) { if (VLOG\_IS\_ON(5)) { const auto& signature = fdef.signature(); VLOG(5) << "Instantiate function definition: name=" << signature.name() << " #input\_args=" << signature.input\_arg\_size() << " #output\_args=" << signature.output\_arg\_size() << " #control\_output=" << signature.control\_output\_size(); for (const auto& line : str\_util::Split(Print(fdef), '\n')) { VLOG(5) << "|| " << line; } }
 const OpDef& sig = fdef.signature(); TF\_RETURN\_IF\_ERROR(ValidateSignatureWithAttrs(sig, attr\_values));
 bool ints\_on\_device = fdef.attr().count(FunctionLibraryDefinition::kIntsOnDeviceAttr) != 0 && fdef.attr().at(FunctionLibraryDefinition::kIntsOnDeviceAttr).b();
 FunctionInstantiationHelper helper(get\_function, result); Status s; for (int i = 0, e = sig.input\_arg\_size(); i < e; ++i) { const OpDef::ArgDef& arg\_def = sig.input\_arg(i); auto it = fdef.arg\_attr().find(i); const FunctionDef::ArgAttrs\* arg\_attrs = it != fdef.arg\_attr().end() ? &it->second : nullptr; auto resource\_id\_it = fdef.resource\_arg\_unique\_id().find(i); int64\_t resource\_arg\_unique\_id = resource\_id\_it != fdef.resource\_arg\_unique\_id().end() ? resource\_id\_it->second : -1LL; s = helper.BuildInputArgIndex(arg\_def, attr\_values, arg\_attrs, ints\_on\_device, resource\_arg\_unique\_id);
 if (!s.ok()) { errors::AppendToMessage(&s, "In ", Print(arg\_def)); return s; } }
 auto substitute = [attr\_values, &sig](StringPiece name, AttrValue\* val) { // Look for a specified value... if (const AttrValue\* v = attr\_values.Find(name)) { \*val = \*v; return true; } // .. and if not, then check for a default value. if (const OpDef::AttrDef\* attr = FindAttr(name, sig)) { if (attr->has\_default\_value()) { \*val = attr->default\_value(); return true; } } // No luck finding a substitution. return false; };
 // Makes a copy of all attrs in fdef and substitutes placeholders. // After this step, every attr is bound to a concrete value. std::vector<AttrValueMap> node\_attrs; node\_attrs.resize(fdef.node\_def\_size()); for (int i = 0; i < fdef.node\_def\_size(); ++i) { for (auto attr : fdef.node\_def(i).attr()) { if (!SubstitutePlaceholders(substitute, &attr.second)) { return errors::InvalidArgument("Failed to bind all placeholders in ", SummarizeAttrValue(attr.second)); } if (!node\_attrs[i].insert(attr).second) { return errors::Internal("Somehow duplicated: ", attr.first); } } TF\_RETURN\_IF\_ERROR( AddDefaultAttrs(fdef.node\_def(i).op(), get\_function, &node\_attrs[i])); }
 for (int i = 0; i < fdef.node\_def\_size(); ++i) { s = helper.BuildNodeOutputIndex(fdef.node\_def(i), AttrSlice(&node\_attrs[i]), result->nodes.size() + i); if (!s.ok()) { errors::AppendToMessage(&s, "In ", FormatNodeDefForError(fdef.node\_def(i))); return s; } } // Emits one node for each fdef.node\_def. for (int i = 0; i < fdef.node\_def\_size(); ++i) { s = helper.InstantiateNode(fdef.node\_def(i), AttrSlice(&node\_attrs[i])); if (!s.ok()) { errors::AppendToMessage(&s, "In ", FormatNodeDefForError(fdef.node\_def(i))); return s; } }
 // Emits nodes for the function's return values. int ret\_index = 0; for (const OpDef::ArgDef& ret\_def : sig.output\_arg()) { s = helper.AddReturnNode(ret\_def, attr\_values, fdef.ret(), ints\_on\_device, &ret\_index); if (!s.ok()) { errors::AppendToMessage(&s, "In function output ", Print(ret\_def)); return s; } }
 // Adds the actual node inputs using the input indexes. helper.AddNodeInputs();
 return Status::OK();}
string DebugString(const FunctionDef& func\_def) { return Print(func\_def); }
string DebugString(const GraphDef& instantiated\_func\_def) { std::vector<const NodeDef\*> ptrs; for (const NodeDef& n : instantiated\_func\_def.node()) { ptrs.push\_back(&n); } return Print(ptrs);}
string DebugString(gtl::ArraySlice<NodeDef> instantiated\_func\_nodes) { std::vector<const NodeDef\*> ptrs; for (const NodeDef& n : instantiated\_func\_nodes) { ptrs.push\_back(&n); } return Print(ptrs);}
string DebugStringWhole(const GraphDef& gdef) { string ret; for (const auto& fdef : gdef.library().function()) { strings::StrAppend(&ret, Print(fdef)); } strings::StrAppend(&ret, "\n"); for (const auto& ndef : gdef.node()) { strings::StrAppend(&ret, Print(ndef), "\n"); } return ret;}
namespace {
// Returns the name -> attr mapping of fdef's attrs that have a value set. In// Python, it's possible to access unset attrs, which returns a default value// and adds an unset attr to the map.std::map<string, AttrValue> GetSetAttrs(const FunctionDef& fdef) { std::map<string, AttrValue> set\_attrs; for (const auto& pair : fdef.attr()) { if (pair.second.value\_case() != AttrValue::VALUE\_NOT\_SET) { set\_attrs[pair.first] = pair.second; } } return set\_attrs;}
} // end namespace
bool FunctionDefsEqual(const FunctionDef& f1, const FunctionDef& f2) { if (!OpDefEqual(f1.signature(), f2.signature())) return false;
 std::map<string, AttrValue> f1\_attrs = GetSetAttrs(f1); std::map<string, AttrValue> f2\_attrs = GetSetAttrs(f2); if (f1\_attrs.size() != f2\_attrs.size()) return false; for (const auto& iter1 : f1\_attrs) { auto iter2 = f2\_attrs.find(iter1.first); if (iter2 == f2\_attrs.end()) return false; if (!AreAttrValuesEqual(iter1.second, iter2->second)) return false; }
 if (!EqualRepeatedNodeDef(f1.node\_def(), f2.node\_def(), nullptr)) { return false; }
 std::map<string, string> ret1(f1.ret().begin(), f1.ret().end()); std::map<string, string> ret2(f2.ret().begin(), f2.ret().end()); if (ret1 != ret2) return false;
 std::map<string, string> control\_ret1(f1.control\_ret().begin(), f1.control\_ret().end()); std::map<string, string> control\_ret2(f2.control\_ret().begin(), f2.control\_ret().end()); if (control\_ret1 != control\_ret2) return false;
 return true;}
uint64 FunctionDefHash(const FunctionDef& fdef) { // signature uint64 h = OpDefHash(fdef.signature());
 // attrs std::map<string, AttrValue> attrs = GetSetAttrs(fdef); for (const auto& p : attrs) { h = Hash64(p.first.data(), p.first.size(), h); h = Hash64Combine(AttrValueHash(p.second), h); }
 // node defs h = Hash64Combine(RepeatedNodeDefHash(fdef.node\_def()), h);
 // output names std::map<string, string> ret(fdef.ret().begin(), fdef.ret().end()); for (const auto& p : ret) { h = Hash64(p.first.data(), p.first.size(), h); h = Hash64(p.second.data(), p.second.size(), h); }
 // control output names std::map<string, string> control\_ret(fdef.control\_ret().begin(), fdef.control\_ret().end()); for (const auto& p : control\_ret) { h = Hash64(p.first.data(), p.first.size(), h); h = Hash64(p.second.data(), p.second.size(), h); }
 return h;}
static constexpr const char\* const kExecutorAttr = "\_executor";
/\* static \*/string FunctionLibraryRuntime::ExecutorType(const InstantiateOptions& options, AttrSlice attrs) { if (!options.executor\_type.empty()) { return options.executor\_type; } else if (const AttrValue\* executor\_attr = attrs.Find(kExecutorAttr)) { return executor\_attr->s(); } else { return string(); }}
namespace {class AttrKeyAndValue { public: enum ValueRepresentationOp { kRaw, kCEscape, }; AttrKeyAndValue(absl::string\_view key\_name, int key\_suffix, string value, ValueRepresentationOp value\_op = kRaw) : key\_name\_(key\_name), key\_suffix\_(key\_suffix), value\_op\_(value\_op), value\_(std::move(value)) {}
 bool operator<(const AttrKeyAndValue& b) const { if (key\_name\_ != b.key\_name\_) { return key\_name\_ < b.key\_name\_; } else if (key\_suffix\_ != b.key\_suffix\_) { return key\_suffix\_ < b.key\_suffix\_; } else { return value\_ < b.value\_; } }
 void AppendTo(bool first, string\* s) const { absl::string\_view v; bool add\_escaped = false; if ((value\_op\_ == kCEscape) && NeedsEscaping(value\_)) { // Use CEscape call below add\_escaped = true; } else { // Add raw value contents directly v = value\_; } if (key\_suffix\_ >= 0) {[View remainder of file in raw view](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/function.cc)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_705990e5_20250115_084344.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F3d89911481ba6ebe8c88c1c0b595412121e6c645)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F3d89911481ba6ebe8c88c1c0b595412121e6c645)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/3d89911481ba6ebe8c88c1c0b595412121e6c645)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Eliminate `CHECK`-fail from `function.cc`.

[Browse files](/tensorflow/tensorflow/tree/3d89911481ba6ebe8c88c1c0b595412121e6c645)
Browse the repository at this point in the history

```
PiperOrigin-RevId: 409414744
Change-Id: Ic854e12ab2edb88b165d32e2d632c4ee654d71ad
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 12, 2021

1 parent
[92dbfd9](/tensorflow/tensorflow/commit/92dbfd9938db956c8d95ea4c9af0e7d6bb2b17cb)

commit 3d89911

Showing
**1 changed file**
with
**3 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

4 changes: 3 additions & 1 deletion

4
[tensorflow/core/framework/function.cc](#diff-a17a235434650bddd3d2698c9a61db6fa03f7f7d826a1beaccd7baf6dbd86df2 "tensorflow/core/framework/function.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/3d89911481ba6ebe8c88c1c0b595412121e6c645/tensorflow/core/framework/function.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -181,7 +181,9 @@ class FunctionInstantiationHelper { |
|  |  | DataTypeVector dtypes; |
|  |  | TF\_RETURN\_IF\_ERROR( |
|  |  | ArgNumType(attr\_values, arg\_def, &is\_type\_list, &dtypes)); |
|  |  | CHECK\_GE(dtypes.size(), size\_t{1}); |
|  |  | if (dtypes.size() < size\_t{1}) { |
|  |  | return errors::Internal("Expected a list of at least one dtype"); |
|  |  | } |
|  |  | int arg\_index = result\_.nodes.size(); |
|  |  | TF\_RETURN\_IF\_ERROR( |
|  |  | AddItem(arg\_def.name(), {true, arg\_index, 0, is\_type\_list, dtypes})); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3d89911`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F3d89911481ba6ebe8c88c1c0b595412121e6c645) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


