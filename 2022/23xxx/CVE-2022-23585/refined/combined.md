=== Content from github.com_89177b3b_20250114_214956.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-fq6p-6334-8gr4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-fq6p-6334-8gr4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# Memory leak in decoding PNG images

Low

[mihaimaruseac](/mihaimaruseac)
published
GHSA-fq6p-6334-8gr4
Feb 2, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.8.0

## Patched versions

2.5.3, 2.6.3, 2.7.1

## Description

### Impact

When [decoding PNG images](https://github.com/tensorflow/tensorflow/blob/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels/image/decode_image_op.cc#L322-L416) TensorFlow can produce a memory leak if the image is invalid.

After calling `png::CommonInitDecode(..., &decode)`, the `decode` value contains allocated buffers which can only be freed by calling `png::CommonFreeDecode(&decode)`. However, several error case in the function implementation invoke the `OP_REQUIRES` macro which immediately terminates the execution of the function, without allowing for the memory free to occur.

### Patches

We have patched the issue in GitHub commit [ab51e5b813573dc9f51efa335aebcf2994125ee9](https://github.com/tensorflow/tensorflow/commit/ab51e5b813573dc9f51efa335aebcf2994125ee9).

The fix will be included in TensorFlow 2.8.0. We will also cherrypick this commit on TensorFlow 2.7.1, TensorFlow 2.6.3, and TensorFlow 2.5.3, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Low

### CVE ID

CVE-2022-23585

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_2163b562_20250114_214953.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fkernels%2Fimage%2Fdecode_image_op.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fkernels%2Fimage%2Fdecode_image_op.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[kernels](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels)
5. /[image](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels/image)
/
# decode\_image\_op.cc

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels/image/decode_image_op.cc)737 lines (668 loc) · 31.6 KB a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[kernels](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels)
5. /[image](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels/image)
/
# decode\_image\_op.cc

Top
## File metadata and controls

* Code
* Blame

737 lines (668 loc) · 31.6 KB[Raw](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/kernels/image/decode_image_op.cc)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737/\* Copyright 2015 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
// See docs in ../ops/image\_ops.cc
#include <cstdint>#include <memory>
#define EIGEN\_USE\_THREADS
#include "absl/strings/escaping.h"#include "tensorflow/core/framework/bounds\_check.h"#include "tensorflow/core/framework/op\_kernel.h"#include "tensorflow/core/framework/register\_types.h"#include "tensorflow/core/framework/tensor.h"#include "tensorflow/core/framework/tensor\_shape.h"#include "tensorflow/core/framework/types.h"#include "tensorflow/core/lib/core/status.h"#include "tensorflow/core/lib/gif/gif\_io.h"#include "tensorflow/core/lib/jpeg/jpeg\_mem.h"#include "tensorflow/core/lib/png/png\_io.h"#include "tensorflow/core/lib/strings/str\_util.h"#include "tensorflow/core/platform/byte\_order.h"#include "tensorflow/core/platform/logging.h"#include "tensorflow/core/util/tensor\_bundle/byte\_swap.h"
namespace tensorflow {namespace {
// Magic bytes (hex) for each image format.// https://en.wikipedia.org/wiki/List\_of\_file\_signatures// WARNING: Changing `static const` to `constexpr` requires first checking that// it works with supported MSVC version.// https://docs.microsoft.com/en-us/cpp/cpp/constexpr-cpp?redirectedfrom=MSDN&view=vs-2019static const char kPngMagicBytes[] = "\x89\x50\x4E\x47\x0D\x0A\x1A\x0A";static const char kGifMagicBytes[] = "\x47\x49\x46\x38";static const char kBmpMagicBytes[] = "\x42\x4d";// The 4th byte of JPEG is '\xe0' or '\xe1', so check just the first three.static const char kJpegMagicBytes[] = "\xff\xd8\xff";
enum FileFormat { kUnknownFormat = 0, kPngFormat = 1, kJpgFormat = 2, kGifFormat = 3, kBmpFormat = 4,};
// Classify the contents of a file based on starting bytes (the magic number).FileFormat ClassifyFileFormat(StringPiece data) { if (absl::StartsWith(data, kJpegMagicBytes)) return kJpgFormat; if (absl::StartsWith(data, kPngMagicBytes)) return kPngFormat; if (absl::StartsWith(data, kGifMagicBytes)) return kGifFormat; if (absl::StartsWith(data, kBmpMagicBytes)) return kBmpFormat; return kUnknownFormat;}
// Decode an image. Supported image formats are JPEG, PNG, GIF and BMP. This is// a newer version of `DecodeImageOp` for enabling image data parsing to take// place in kernels only, reducing security vulnerabilities and redundancy.class DecodeImageV2Op : public OpKernel { public: explicit DecodeImageV2Op(OpKernelConstruction\* context) : OpKernel(context) { // Keep track of op string information because: // [1] Currently by the API, PNG, JPEG and GIF can decode each other and // depending on the op type, we need to return either 3-D or 4-D shapes. // [2] Different ops have different attributes. e.g. `DecodeImage` op has // `expand\_animations` attribute that other ops don't. // `DecodeAndDropJpeg` also has additional attributes. op\_type\_ = type\_string();
 // Validate op type. OP\_REQUIRES(context, op\_type\_ == "DecodeJpeg" || op\_type\_ == "DecodeAndCropJpeg" || op\_type\_ == "DecodePng" || op\_type\_ == "DecodeGif" || op\_type\_ == "DecodeBmp" || op\_type\_ == "DecodeImage", errors::InvalidArgument("Bad op type ", op\_type\_));
 // Get attributes from `DecodeJpeg` and `DecodeAndCropJpeg` op // invocations. For `DecodeImage` op, set JPEG decoding setting to TF // default. if (op\_type\_ == "DecodeJpeg" || op\_type\_ == "DecodeAndCropJpeg") { OP\_REQUIRES\_OK(context, context->GetAttr("ratio", &flags\_.ratio)); OP\_REQUIRES(context, flags\_.ratio == 1 || flags\_.ratio == 2 || flags\_.ratio == 4 || flags\_.ratio == 8, errors::InvalidArgument("ratio must be 1, 2, 4, or 8, got ", flags\_.ratio)); OP\_REQUIRES\_OK(context, context->GetAttr("fancy\_upscaling", &flags\_.fancy\_upscaling)); OP\_REQUIRES\_OK(context, context->GetAttr("try\_recover\_truncated", &flags\_.try\_recover\_truncated\_jpeg)); OP\_REQUIRES\_OK(context, context->GetAttr("acceptable\_fraction", &flags\_.min\_acceptable\_fraction)); string dct\_method; OP\_REQUIRES\_OK(context, context->GetAttr("dct\_method", &dct\_method)); OP\_REQUIRES( context, (dct\_method.empty() || dct\_method == "INTEGER\_FAST" || dct\_method == "INTEGER\_ACCURATE"), errors::InvalidArgument("dct\_method must be one of " "{'', 'INTEGER\_FAST', 'INTEGER\_ACCURATE'}")); // The TensorFlow-chosen default for JPEG decoding is IFAST, sacrificing // image quality for speed. if (dct\_method.empty() || dct\_method == "INTEGER\_FAST") { flags\_.dct\_method = JDCT\_IFAST; } else if (dct\_method == "INTEGER\_ACCURATE") { flags\_.dct\_method = JDCT\_ISLOW; } } else { flags\_ = jpeg::UncompressFlags(); flags\_.dct\_method = JDCT\_IFAST; }
 // Get `dtype` attribute from `DecodePng` or `DecodeImage` op invocations. if (op\_type\_ == "DecodePng" || op\_type\_ == "DecodeImage") { OP\_REQUIRES\_OK(context, context->GetAttr("dtype", &data\_type\_)); if (op\_type\_ == "DecodePng") { OP\_REQUIRES( context, data\_type\_ == DataType::DT\_UINT8 || data\_type\_ == DataType::DT\_UINT16, errors::InvalidArgument( "`dtype` for `DecodePng` must be unit8, unit16 but got: ", data\_type\_)); } else { OP\_REQUIRES(context, data\_type\_ == DataType::DT\_UINT8 || data\_type\_ == DataType::DT\_UINT16 || data\_type\_ == DataType::DT\_FLOAT, errors::InvalidArgument("`dtype` for `DecodeImage` must be " "unit8, unit16, float but got: ", data\_type\_)); OP\_REQUIRES\_OK(context, context->GetAttr("expand\_animations", &expand\_animations\_)); } }
 // Get `channels` attribute for all ops except `DecodeGif` op. // `DecodeGif` doesn't have `channels` attribute but it supports 3 // channels by default. if (op\_type\_ != "DecodeGif") { OP\_REQUIRES\_OK(context, context->GetAttr("channels", &channels\_)); OP\_REQUIRES( context, channels\_ == 0 || channels\_ == 1 || channels\_ == 3 || channels\_ == 4, errors::InvalidArgument("`channels` must be 0, 1, 3 or 4 but got ", channels\_)); } else { channels\_ = 3; } }
 // Helper for decoding BMP. inline int32 ByteSwapInt32ForBigEndian(int32\_t x) { if (!port::kLittleEndian) { return BYTE\_SWAP\_32(x); } else { return x; } }
 // Helper for decoding BMP. inline int16 ByteSwapInt16ForBigEndian(int16\_t x) { if (!port::kLittleEndian) { return BYTE\_SWAP\_16(x); } else { return x; } }
 void Compute(OpKernelContext\* context) override { const Tensor& contents = context->input(0); OP\_REQUIRES( context, TensorShapeUtils::IsScalar(contents.shape()), errors::InvalidArgument("`contents` must be scalar but got shape", contents.shape().DebugString())); const StringPiece input = contents.scalar<tstring>()(); OP\_REQUIRES(context, !input.empty(), errors::InvalidArgument("Input is empty.")); OP\_REQUIRES(context, input.size() <= std::numeric\_limits<int>::max(), errors::InvalidArgument( "Input contents are too large for int: ", input.size()));
 // Parse magic bytes to determine file format. switch (ClassifyFileFormat(input)) { case kJpgFormat: DecodeJpegV2(context, input); break; case kPngFormat: DecodePngV2(context, input); break; case kGifFormat: DecodeGifV2(context, input); break; case kBmpFormat: DecodeBmpV2(context, input); break; case kUnknownFormat: OP\_REQUIRES(context, false, errors::InvalidArgument("Unknown image file format. One of " "JPEG, PNG, GIF, BMP required.")); break; } }
 void DecodeJpegV2(OpKernelContext\* context, StringPiece input) { OP\_REQUIRES(context, channels\_ == 0 || channels\_ == 1 || channels\_ == 3, errors::InvalidArgument("JPEG does not support 4 channels"));
 // Use local copy of flags to avoid race condition as the class member is // shared among different invocations. jpeg::UncompressFlags flags = flags\_; flags.components = channels\_;
 if (op\_type\_ == "DecodeAndCropJpeg") { flags.crop = true; // Update flags to include crop window. const Tensor& crop\_window = context->input(1); OP\_REQUIRES(context, crop\_window.dims() == 1, errors::InvalidArgument("crop\_window must be 1-D, got shape ", crop\_window.shape().DebugString())); OP\_REQUIRES(context, crop\_window.dim\_size(0) == 4, errors::InvalidArgument("crop\_size must have four elements ", crop\_window.shape().DebugString())); auto crop\_window\_vec = crop\_window.vec<int32>(); flags.crop\_y = crop\_window\_vec(0); flags.crop\_x = crop\_window\_vec(1); flags.crop\_height = crop\_window\_vec(2); flags.crop\_width = crop\_window\_vec(3); } else if (op\_type\_ == "DecodeBmp") { // TODO(b/171060723): Only DecodeBmp as op\_type\_ is not acceptable here // because currently `decode\_(jpeg|png|gif)` ops can decode any one of // jpeg, png or gif but not bmp. Similarly, `decode\_bmp` cannot decode // anything but bmp formats. This behavior needs to be revisited. For more // details, please refer to the bug. OP\_REQUIRES(context, false, errors::InvalidArgument( "Trying to decode JPEG format using DecodeBmp op. Use " "`decode\_jpeg` or `decode\_image` instead.")); }
 // Output tensor and the image buffer size. Tensor\* output = nullptr; int buffer\_size = 0;
 // Decode JPEG. Directly allocate to the output buffer if data type is // uint8 (to save extra copying). Otherwise, allocate a new uint8 buffer // with buffer size. `jpeg::Uncompress` supports unit8 only. uint8\* buffer = jpeg::Uncompress( input.data(), input.size(), flags, nullptr /\* nwarn \*/, [&](int width, int height, int channels) -> uint8\* { buffer\_size = height \* width \* channels; Status status; // By the existing API, we support decoding JPEG with `DecodeGif` // op. We need to make sure to return 4-D shapes when using // `DecodeGif`. if (op\_type\_ == "DecodeGif") { status = context->allocate\_output( 0, TensorShape({1, height, width, channels}), &output); } else { status = context->allocate\_output( 0, TensorShape({height, width, channels}), &output); } if (!status.ok()) { VLOG(1) << status; context->SetStatus(status); return nullptr; }
 if (data\_type\_ == DataType::DT\_UINT8) { return output->flat<uint8>().data(); } else { return new uint8[buffer\_size]; } });
 OP\_REQUIRES( context, buffer, errors::InvalidArgument( "jpeg::Uncompress failed. Invalid JPEG data or crop window."));
 // For when desired data type if unit8, the output buffer is already // allocated during the `jpeg::Uncompress` call above; return. if (data\_type\_ == DataType::DT\_UINT8) { return; } // Make sure we don't forget to deallocate `buffer`. std::unique\_ptr<uint8[]> buffer\_unique\_ptr(buffer);
 // Convert uint8 image data to desired data type. // Use eigen threadpooling to speed up the copy operation. const auto& device = context->eigen\_device<Eigen::ThreadPoolDevice>(); TTypes<uint8>::UnalignedConstFlat buffer\_view(buffer, buffer\_size); if (data\_type\_ == DataType::DT\_UINT16) { uint16 scale = floor((std::numeric\_limits<uint16>::max() + 1) / (std::numeric\_limits<uint8>::max() + 1)); // Fill output tensor with desired dtype. output->flat<uint16>().device(device) = buffer\_view.cast<uint16>() \* scale; } else if (data\_type\_ == DataType::DT\_FLOAT) { float scale = 1. / std::numeric\_limits<uint8>::max(); // Fill output tensor with desired dtype. output->flat<float>().device(device) = buffer\_view.cast<float>() \* scale; } }
 void DecodePngV2(OpKernelContext\* context, StringPiece input) { int channel\_bits = (data\_type\_ == DataType::DT\_UINT8) ? 8 : 16; png::DecodeContext decode; OP\_REQUIRES( context, png::CommonInitDecode(input, channels\_, channel\_bits, &decode), errors::InvalidArgument("Invalid PNG. Failed to initialize decoder."));
 // Verify that width and height are not too large: // - verify width and height don't overflow int. // - width can later be multiplied by channels\_ and sizeof(uint16), so // verify single dimension is not too large. // - verify when width and height are multiplied together, there are a few // bits to spare as well. const int width = static\_cast<int>(decode.width); const int height = static\_cast<int>(decode.height); const int64\_t total\_size = static\_cast<int64\_t>(width) \* static\_cast<int64\_t>(height); if (width != static\_cast<int64\_t>(decode.width) || width <= 0 || width >= (1LL << 27) || height != static\_cast<int64\_t>(decode.height) || height <= 0 || height >= (1LL << 27) || total\_size >= (1LL << 29)) { png::CommonFreeDecode(&decode); OP\_REQUIRES(context, false, errors::InvalidArgument("PNG size too large for int: ", decode.width, " by ", decode.height)); }
 Tensor\* output = nullptr; Status status; // By the existing API, we support decoding PNG with `DecodeGif` op. // We need to make sure to return 4-D shapes when using `DecodeGif`. if (op\_type\_ == "DecodeGif") { status = context->allocate\_output( 0, TensorShape({1, height, width, decode.channels}), &output); } else { status = context->allocate\_output( 0, TensorShape({height, width, decode.channels}), &output); }
 if (op\_type\_ == "DecodeBmp") { // TODO(b/171060723): Only DecodeBmp as op\_type\_ is not acceptable here // because currently `decode\_(jpeg|png|gif)` ops can decode any one of // jpeg, png or gif but not bmp. Similarly, `decode\_bmp` cannot decode // anything but bmp formats. This behavior needs to be revisited. For more // details, please refer to the bug. OP\_REQUIRES(context, false, errors::InvalidArgument( "Trying to decode PNG format using DecodeBmp op. Use " "`decode\_png` or `decode\_image` instead.")); } else if (op\_type\_ == "DecodeAndCropJpeg") { OP\_REQUIRES(context, false, errors::InvalidArgument( "DecodeAndCropJpeg operation can run on JPEG only, but " "detected PNG.")); }
 if (!status.ok()) png::CommonFreeDecode(&decode); OP\_REQUIRES\_OK(context, status);
 if (data\_type\_ == DataType::DT\_UINT8) { OP\_REQUIRES( context, png::CommonFinishDecode( reinterpret\_cast<png\_bytep>(output->flat<uint8>().data()), decode.channels \* width \* sizeof(uint8), &decode), errors::InvalidArgument("Invalid PNG data, size ", input.size())); } else if (data\_type\_ == DataType::DT\_UINT16) { OP\_REQUIRES( context, png::CommonFinishDecode( reinterpret\_cast<png\_bytep>(output->flat<uint16>().data()), decode.channels \* width \* sizeof(uint16), &decode), errors::InvalidArgument("Invalid PNG data, size ", input.size())); } else if (data\_type\_ == DataType::DT\_FLOAT) { // `png::CommonFinishDecode` does not support `float`. First allocate // uint16 buffer for the image and decode in uint16 (lossless). Wrap the // buffer in `unique\_ptr` so that we don't forget to delete the buffer. std::unique\_ptr<uint16[]> buffer( new uint16[height \* width \* decode.channels]); OP\_REQUIRES( context, png::CommonFinishDecode(reinterpret\_cast<png\_bytep>(buffer.get()), decode.channels \* width \* sizeof(uint16), &decode), errors::InvalidArgument("Invalid PNG data, size ", input.size()));
 // Convert uint16 image data to desired data type. // Use eigen threadpooling to speed up the copy operation. const auto& device = context->eigen\_device<Eigen::ThreadPoolDevice>(); TTypes<uint16, 3>::UnalignedConstTensor buf(buffer.get(), height, width, decode.channels); float scale = 1. / std::numeric\_limits<uint16>::max(); // Fill output tensor with desired dtype. output->tensor<float, 3>().device(device) = buf.cast<float>() \* scale; } }
 void DecodeGifV2(OpKernelContext\* context, StringPiece input) { // GIF has 3 channels. OP\_REQUIRES(context, channels\_ == 0 || channels\_ == 3, errors::InvalidArgument("channels must be 0 or 3 for GIF, got ", channels\_));
 if (op\_type\_ == "DecodeBmp") { // TODO(b/171060723): Only DecodeBmp as op\_type\_ is not acceptable here // because currently `decode\_(jpeg|png|gif)` ops can decode any one of // jpeg, png or gif but not bmp. Similarly, `decode\_bmp` cannot decode // anything but bmp formats. This behavior needs to be revisited. For more // details, please refer to the bug. OP\_REQUIRES(context, false, errors::InvalidArgument( "Trying to decode GIF format using DecodeBmp op. Use " "`decode\_gif` or `decode\_image` instead.")); } else if (op\_type\_ == "DecodeAndCropJpeg") { OP\_REQUIRES(context, false, errors::InvalidArgument( "DecodeAndCropJpeg operation can run on JPEG only, but " "detected GIF.")); }
 // Decode GIF, allocating tensor if dtype is uint8, otherwise defer tensor // allocation til after dtype conversion is done. `gif`::Decode` supports // uint8 only. Tensor\* output = nullptr; int buffer\_size = 0; string error\_string; uint8\* buffer = gif::Decode( input.data(), input.size(), [&](int num\_frames, int width, int height, int channels) -> uint8\* { buffer\_size = num\_frames \* height \* width \* channels;
 Status status; // By the existing API, we support decoding GIF with `decode\_jpeg` or // with `decode\_png` if the GIF is a single-frame GIF (non-animated). // We need to make sure to return 3-D shapes when using in this case. if (op\_type\_ == "DecodePng" || op\_type\_ == "DecodeJpeg") { if (num\_frames == 1) { status = context->allocate\_output( 0, TensorShape({height, width, channels}), &output); } else { status = errors::InvalidArgument( "Got ", num\_frames, " frames, but animated gifs ", "can only be decoded by tf.io.decode\_gif or ", "tf.io.decode\_image"); } } else if (op\_type\_ == "DecodeGif" || (op\_type\_ == "DecodeImage" && expand\_animations\_)) { status = context->allocate\_output( 0, TensorShape({num\_frames, height, width, channels}), &output); } else if (op\_type\_ == "DecodeImage" && !expand\_animations\_) { status = context->allocate\_output( 0, TensorShape({height, width, channels}), &output); } else { status = errors::InvalidArgument("Bad op type ", op\_type\_); } if (!status.ok()) { VLOG(1) << status; context->SetStatus(status); return nullptr; }
 if (data\_type\_ == DataType::DT\_UINT8) { return output->flat<uint8>().data(); } else { return new uint8[buffer\_size]; } }, &error\_string, expand\_animations\_);
 OP\_REQUIRES(context, buffer, errors::InvalidArgument("Invalid GIF data (size ", input.size(), "), ", error\_string));
 // For when desired data type is unit8, the output buffer is already // allocated during the `gif::Decode` call above; return. if (data\_type\_ == DataType::DT\_UINT8) { return; } // Make sure we don't forget to deallocate `buffer`. std::unique\_ptr<uint8[]> buffer\_unique\_ptr(buffer);
 // Convert the raw uint8 buffer to desired dtype. // Use eigen threadpooling to speed up the copy operation. TTypes<uint8>::UnalignedConstFlat buffer\_view(buffer, buffer\_size); const auto& device = context->eigen\_device<Eigen::ThreadPoolDevice>(); if (data\_type\_ == DataType::DT\_UINT16) { uint16 scale = floor((std::numeric\_limits<uint16>::max() + 1) / (std::numeric\_limits<uint8>::max() + 1)); // Fill output tensor with desired dtype. output->flat<uint16>().device(device) = buffer\_view.cast<uint16>() \* scale; } else if (data\_type\_ == DataType::DT\_FLOAT) { float scale = 1. / std::numeric\_limits<uint8>::max(); // Fill output tensor with desired dtype. output->flat<float>().device(device) = buffer\_view.cast<float>() \* scale; } }
 void DecodeBmpV2(OpKernelContext\* context, StringPiece input) { OP\_REQUIRES( context, channels\_ != 1, errors::InvalidArgument( "`channels` must be 0, 3 or 4 for BMP, but got ", channels\_));
 if (op\_type\_ != "DecodeBmp" && op\_type\_ != "DecodeImage") { if (op\_type\_ == "DecodeAndCropJpeg") { OP\_REQUIRES(context, false, errors::InvalidArgument( "DecodeAndCropJpeg operation can run on JPEG only, but " "detected BMP.")); } else { OP\_REQUIRES(context, false, errors::InvalidArgument( "Trying to decode BMP format using a wrong op. Use " "`decode\_bmp` or `decode\_image` instead. Op used: ", op\_type\_)); } }
 OP\_REQUIRES(context, (32 <= input.size()), errors::InvalidArgument("Incomplete bmp content, requires at " "least 32 bytes to find the header " "size, width, height, and bpp, got ", input.size(), " bytes"));
 const uint8\* img\_bytes = reinterpret\_cast<const uint8\*>(input.data()); int32\_t header\_size\_ = internal::SubtleMustCopy( \*(reinterpret\_cast<const int32\*>(img\_bytes + 10))); const int32\_t header\_size = ByteSwapInt32ForBigEndian(header\_size\_); int32\_t width\_ = internal::SubtleMustCopy( \*(reinterpret\_cast<const int32\*>(img\_bytes + 18))); const int32\_t width = ByteSwapInt32ForBigEndian(width\_); int32\_t height\_ = internal::SubtleMustCopy( \*(reinterpret\_cast<const int32\*>(img\_bytes + 22))); const int32\_t height = ByteSwapInt32ForBigEndian(height\_); int16\_t bpp\_ = internal::SubtleMustCopy( \*(reinterpret\_cast<const int16\*>(img\_bytes + 28))); const int16\_t bpp = ByteSwapInt16ForBigEndian(bpp\_);
 // `channels\_` is desired number of channels. `img\_channels` is number of // channels inherent in the image. int img\_channels = bpp / 8; OP\_REQUIRES( context, (img\_channels == 1 || img\_channels == 3 || img\_channels == 4), errors::InvalidArgument( "Number of channels inherent in the image must be 1, 3 or 4, was ", img\_channels)); const int requested\_channels = channels\_ ? channels\_ : img\_channels;
 OP\_REQUIRES(context, width > 0, errors::InvalidArgument("Width must be positive")); OP\_REQUIRES(context, height != 0, errors::InvalidArgument("Height must be nonzero")); OP\_REQUIRES(context, header\_size >= 0, errors::InvalidArgument("header size must be nonnegative"));
 // The real requirement is < 2^31 minus some headers and channel data, // so rounding down to something that's still ridiculously big. OP\_REQUIRES( context, (static\_cast<int64\_t>(width) \* std::abs(static\_cast<int64\_t>(height))) < static\_cast<int64\_t>(std::numeric\_limits<int32\_t>::max() / 8), errors::InvalidArgument( "Total possible pixel bytes must be less than 2^30"));
 const int32\_t abs\_height = abs(height);
 // there may be padding bytes when the width is not a multiple of 4 bytes const int row\_size = (img\_channels \* width + 3) / 4 \* 4;
 // Make sure the size of input data matches up with the total size of // headers plus height \* row\_size. int size\_diff = input.size() - header\_size - (row\_size \* abs\_height); OP\_REQUIRES( context, size\_diff == 0, errors::InvalidArgument( "Input size should match (header\_size + row\_size \* abs\_height) but " "they differ by ", size\_diff));
 const int64\_t last\_pixel\_offset = static\_cast<int64\_t>(header\_size) + (abs\_height - 1) \* row\_size + (width - 1) \* img\_channels;
 // [expected file size] = [last pixel offset] + [last pixel size=channels] const int64\_t expected\_file\_size = last\_pixel\_offset + img\_channels;
 OP\_REQUIRES( context, (expected\_file\_size <= input.size()), errors::InvalidArgument("Incomplete bmp content, requires at least ", expected\_file\_size, " bytes, got ", input.size(), " bytes"));
 // if height is negative, data layout is top down // otherwise, it's bottom up. bool top\_down = (height < 0);
 // Decode image, allocating tensor once the image size is known. Tensor\* output = nullptr; OP\_REQUIRES\_OK( context, context->allocate\_output( 0, TensorShape({abs\_height, width, requested\_channels}), &output));
 const uint8\* bmp\_pixels = &img\_bytes[header\_size];
 if (data\_type\_ == DataType::DT\_UINT8) { DecodeBMP(bmp\_pixels, row\_size, output->flat<uint8>().data(), width, abs\_height, requested\_channels, img\_channels, top\_down); } else { std::unique\_ptr<uint8[]> buffer( new uint8[height \* width \* requested\_channels]); DecodeBMP(bmp\_pixels, row\_size, buffer.get(), width, abs\_height, requested\_channels, img\_channels, top\_down); TTypes<uint8, 3>::UnalignedConstTensor buf(buffer.get(), height, width, requested\_channels); // Convert the raw uint8 buffer to desired dtype. // Use eigen threadpooling to speed up the copy operation. const auto& device = context->eigen\_device<Eigen::ThreadPoolDevice>(); if (data\_type\_ == DataType::DT\_UINT16) { uint16 scale = floor((std::numeric\_limits<uint16>::max() + 1) / (std::numeric\_limits<uint8>::max() + 1)); // Fill output tensor with desired dtype. output->tensor<uint16, 3>().device(device) = buf.cast<uint16>() \* scale; } else if (data\_type\_ == DataType::DT\_FLOAT) { float scale = 1. / std::numeric\_limits<uint8>::max(); // Fill output tensor with desired dtype. output->tensor<float, 3>().device(device) = buf.cast<float>() \* scale; } } }
 private: void DecodeBMP(const uint8\* input, const int row\_size, uint8\* const output, const int width, const int height, const int output\_channels, const int input\_channels, bool top\_down);
 int channels\_ = 0; DataType data\_type\_ = DataType::DT\_UINT8; bool expand\_animations\_ = true; jpeg::UncompressFlags flags\_; string op\_type\_;};
REGISTER\_KERNEL\_BUILDER(Name("DecodeJpeg").Device(DEVICE\_CPU), DecodeImageV2Op);REGISTER\_KERNEL\_BUILDER(Name("DecodePng").Device(DEVICE\_CPU), DecodeImageV2Op);REGISTER\_KERNEL\_BUILDER(Name("DecodeGif").Device(DEVICE\_CPU), DecodeImageV2Op);REGISTER\_KERNEL\_BUILDER(Name("DecodeAndCropJpeg").Device(DEVICE\_CPU), DecodeImageV2Op);REGISTER\_KERNEL\_BUILDER(Name("DecodeImage").Device(DEVICE\_CPU), DecodeImageV2Op);REGISTER\_KERNEL\_BUILDER(Name("DecodeBmp").Device(DEVICE\_CPU), DecodeImageV2Op);
void DecodeImageV2Op::DecodeBMP(const uint8\* input, const int row\_size, uint8\* const output, const int width, const int height, const int output\_channels, const int input\_channels, bool top\_down) { for (int i = 0; i < height; i++) { int src\_pos; int dst\_pos;
 for (int j = 0; j < width; j++) { if (!top\_down) { src\_pos = ((height - 1 - i) \* row\_size) + j \* input\_channels; } else { src\_pos = i \* row\_size + j \* input\_channels; }
 dst\_pos = (i \* width + j) \* output\_channels;
 switch (input\_channels) { case 1: output[dst\_pos] = input[src\_pos]; // Set 2nd and 3rd channels if user requested for 3 or 4 channels. // Repeat 1st channel's value. if (output\_channels == 3 || output\_channels == 4) { output[dst\_pos + 1] = input[src\_pos]; output[dst\_pos + 2] = input[src\_pos]; } // Set 4th channel (alpha) to maximum value if user requested for // 4 channels. if (output\_channels == 4) { output[dst\_pos + 3] = UINT8\_MAX; } break; case 3: // BGR -> RGB output[dst\_pos] = input[src\_pos + 2]; output[dst\_pos + 1] = input[src\_pos + 1]; output[dst\_pos + 2] = input[src\_pos]; // Set 4th channel (alpha) to maximum value if the user requested for // 4 channels and the input image has 3 channels only. if (output\_channels == 4) { output[dst\_pos + 3] = UINT8\_MAX; } break; case 4: // BGRA -> RGBA output[dst\_pos] = input[src\_pos + 2]; output[dst\_pos + 1] = input[src\_pos + 1]; output[dst\_pos + 2] = input[src\_pos]; // Set 4th channel only if the user requested for 4 channels. If not, // then user requested 3 channels; skip this step. if (output\_channels == 4) { output[dst\_pos + 3] = input[src\_pos + 3]; } break; default: LOG(FATAL) << "Unexpected number of channels: " << input\_channels; break; } } }}
} // namespace} // namespace tensorflow

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fbfdf631_20250114_214955.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fab51e5b813573dc9f51efa335aebcf2994125ee9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fab51e5b813573dc9f51efa335aebcf2994125ee9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/ab51e5b813573dc9f51efa335aebcf2994125ee9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Prevent memory leak in decoding PNG images.

[Browse files](/tensorflow/tensorflow/tree/ab51e5b813573dc9f51efa335aebcf2994125ee9)
Browse the repository at this point in the history

```
PiperOrigin-RevId: 409300653
Change-Id: I6182124c545989cef80cefd439b659095920763b
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 12, 2021

1 parent
[fb5ce99](/tensorflow/tensorflow/commit/fb5ce99505358985ace9e811fd25a57047471d6f)

commit ab51e5b

Showing
**1 changed file**
with
**12 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

12 changes: 12 additions & 0 deletions

12
[tensorflow/core/kernels/image/decode\_image\_op.cc](#diff-8809fe592efeaf1f7548374d41e35e4d1a7987300af00cd3e0d17112fd235104 "tensorflow/core/kernels/image/decode_image_op.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/ab51e5b813573dc9f51efa335aebcf2994125ee9/tensorflow/core/kernels/image/decode_image_op.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,8 @@ limitations under the License. |
|  |  | #include <cstdint> |
|  |  | #include <memory> |
|  |  |  |
|  |  | #include "tensorflow/core/lib/gtl/cleanup.h" |
|  |  |  |
|  |  | #define EIGEN\_USE\_THREADS |
|  |  |  |
|  |  | #include "absl/strings/escaping.h" |
| Expand Down  Expand Up | | @@ -326,6 +328,16 @@ class DecodeImageV2Op : public OpKernel { |
|  |  | context, png::CommonInitDecode(input, channels\_, channel\_bits, &decode), |
|  |  | errors::InvalidArgument("Invalid PNG. Failed to initialize decoder.")); |
|  |  |  |
|  |  | // If we reach this point, then there is data in `decode` which must be |
|  |  | // freed by the time we end execution in this function. We cannot call |
|  |  | // `png::CommonFreeDecode()` before an `OP\_REQUIRES` because if |
|  |  | // `OP\_REQUIRES` constraint is satisfied then the data would be freed |
|  |  | // prematurely. Instead, let's use a `Cleanup` object. |
|  |  | auto cleanup = gtl::MakeCleanup([&decode]() { |
|  |  | std::cerr << "Cleanup called...\n"; |
|  |  | png::CommonFreeDecode(&decode); |
|  |  | }); |
|  |  |  |
|  |  | // Verify that width and height are not too large: |
|  |  | // - verify width and height don't overflow int. |
|  |  | // - width can later be multiplied by channels\_ and sizeof(uint16), so |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ab51e5b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fab51e5b813573dc9f51efa335aebcf2994125ee9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


