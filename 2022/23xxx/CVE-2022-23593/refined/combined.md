=== Content from github.com_06c40258_20250115_084059.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-gwcx-jrx4-92w2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-gwcx-jrx4-92w2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# Segfault in `simplifyBroadcast` (MLIR)

Moderate

[mihaimaruseac](/mihaimaruseac)
published
GHSA-gwcx-jrx4-92w2
Feb 2, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

== 2.8.0

## Patched versions

2.8.0

## Description

### Impact

The [`simplifyBroadcast` function in the MLIR-TFRT infrastructure in TensorFlow](https://github.com/tensorflow/tensorflow/blob/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit/transforms/tf_cpurt_symbolic_shape_optimization.cc#L149-L205) is vulenrable to a segfault (hence, denial of service), if called with scalar shapes.

```
  size_t maxRank = 0;
  for (auto shape : llvm::enumerate(shapes)) {
    auto found_shape = analysis.dimensionsForShapeTensor(shape.value());
    if (!found_shape) return {};
    shapes_found.push_back(*found_shape);
    maxRank = std::max(maxRank, found_shape->size());
  }

  SmallVector<const ShapeComponentAnalysis::SymbolicDimension*>
      joined_dimensions(maxRank);
```

If all shapes are scalar, then `maxRank` is 0, so we build an empty `SmallVector`.

### Patches

We have patched the issue in GitHub commit [35f0fabb4c178253a964d7aabdbb15c6a398b69a](https://github.com/tensorflow/tensorflow/commit/35f0fabb4c178253a964d7aabdbb15c6a398b69a).

The fix will be included in TensorFlow 2.8.0. This is the only affected version.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Moderate

### CVE ID

CVE-2022-23593

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9630a102_20250115_084053.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2F274df9b02330b790aa8de1cee164b70f72b9b244%2Ftensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Fjit%2Ftransforms%2Ftf_cpurt_symbolic_shape_optimization.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2F274df9b02330b790aa8de1cee164b70f72b9b244%2Ftensorflow%2Fcompiler%2Fmlir%2Ftfrt%2Fjit%2Ftransforms%2Ftf_cpurt_symbolic_shape_optimization.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 274df9b
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244)
2. /[tensorflow](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow)
3. /[compiler](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler)
4. /[mlir](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir)
5. /[tfrt](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt)
6. /[jit](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit)
7. /[transforms](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit/transforms)
/
# tf\_cpurt\_symbolic\_shape\_optimization.cc

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit/transforms/tf_cpurt_symbolic_shape_optimization.cc)387 lines (326 loc) · 15.3 KB 274df9b
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244)
2. /[tensorflow](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow)
3. /[compiler](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler)
4. /[mlir](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir)
5. /[tfrt](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt)
6. /[jit](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit)
7. /[transforms](/tensorflow/tensorflow/tree/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit/transforms)
/
# tf\_cpurt\_symbolic\_shape\_optimization.cc

Top
## File metadata and controls

* Code
* Blame

387 lines (326 loc) · 15.3 KB[Raw](https://github.com/tensorflow/tensorflow/raw/274df9b02330b790aa8de1cee164b70f72b9b244/tensorflow/compiler/mlir/tfrt/jit/transforms/tf_cpurt_symbolic_shape_optimization.cc)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387/\* Copyright 2021 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
#include <sys/types.h>
#include <string>
#include "mlir/Dialect/StandardOps/IR/Ops.h"#include "mlir/IR/AffineMap.h"#include "mlir/IR/BuiltinOps.h"#include "mlir/IR/BuiltinTypes.h"#include "mlir/IR/MLIRContext.h"#include "mlir/IR/Operation.h"#include "mlir/IR/OperationSupport.h"#include "mlir/IR/TypeRange.h"#include "mlir/Transforms/GreedyPatternRewriteDriver.h"#include "llvm/ADT/DenseMap.h"#include "llvm/ADT/DenseSet.h"#include "llvm/ADT/STLExtras.h"#include "llvm/ADT/StringExtras.h"#include "llvm/ADT/iterator\_range.h"#include "llvm/Support/Alignment.h"#include "llvm/Support/Casting.h"#include "llvm/Support/ErrorOr.h"#include "tensorflow/compiler/mlir/hlo/include/mlir-hlo/Analysis/shape\_component\_analysis.h"#include "tensorflow/compiler/mlir/hlo/include/mlir-hlo/Dialect/mhlo/IR/hlo\_ops.h"#include "tensorflow/compiler/mlir/hlo/include/mlir-hlo/Dialect/mhlo/transforms/rewriters.h"#include "tensorflow/compiler/mlir/tfrt/jit/transforms/tf\_cpurt\_passes.h"
namespace tensorflow {namespace {
using llvm::ArrayRef;using llvm::SmallVector;
using mlir::AffineExpr;using mlir::AffineMap;using mlir::failure;using mlir::FuncOp;using mlir::FunctionPass;using mlir::Location;using mlir::LogicalResult;using mlir::MLIRContext;using mlir::OpBuilder;using mlir::RankedTensorType;using mlir::ShapeComponentAnalysis;using mlir::success;using mlir::TypeRange;using mlir::Value;using mlir::ValueRange;using mlir::arith::ConstantIndexOp;using mlir::arith::ConstantOp;using mlir::arith::IndexCastOp;
namespace linalg = mlir::linalg;namespace mhlo = mlir::mhlo;namespace shape = mlir::shape;namespace tensor = mlir::tensor;
#define GEN\_PASS\_CLASSES#include "tensorflow/compiler/mlir/tfrt/jit/transforms/tf\_cpurt\_passes.h.inc"
// -------------------------------------------------------------------------- //
// Rewrite shape.cstr\_broadcastable with constant witness if can prove that// shapes are broadcastable from the symbolic shapes.
class CstrBroadcastableOpLowering : public mlir::OpRewritePattern<shape::CstrBroadcastableOp> { public: using Base = OpRewritePattern<shape::CstrBroadcastableOp>;
 explicit CstrBroadcastableOpLowering(MLIRContext\* ctx);
 LogicalResult matchAndRewrite(shape::CstrBroadcastableOp op, mlir::PatternRewriter& rewriter) const override;};
CstrBroadcastableOpLowering::CstrBroadcastableOpLowering(MLIRContext\* ctx) : Base(ctx) {}
// Returns true if all of bcasted\_shapes can be broadcasted with output\_shape.bool isKnownBroadcastable(ShapeComponentAnalysis& analysis, ValueRange bcasted\_shapes, Value output\_shape) { auto output\_shape\_dims = analysis.dimensionsForShapeTensor(output\_shape); if (!output\_shape\_dims) return false; for (Value shape : bcasted\_shapes) { auto shape\_dims = analysis.dimensionsForShapeTensor(shape); if (!shape\_dims) return false; // Iterate backwards over the smallest input shape. for (auto zip : llvm::zip(llvm::reverse(\*output\_shape\_dims), llvm::reverse(\*shape\_dims))) { const auto& first = std::get<0>(zip); const auto& second = std::get<1>(zip); // TODO(ezhulenev): What to do with dimensions statically known to be // zero? // Numpy can only broadcast [0] with [1], however Tensorflow can broadcast // [0] with any dimension size, and produces dimension of size [0]. // Currently we'll conservatively return failure and will not proceed with // a rewrite. if (first.isConstant(0) || second.isConstant(0)) return false; // If either shape has a static one dimension the broadcast will always // succeed. if (first.isConstant(1) || second.isConstant(1)) continue; // Otherwise dims have to be equal. if (first != second) return false; } } return true;}
LogicalResult CstrBroadcastableOpLowering::matchAndRewrite( shape::CstrBroadcastableOp op, mlir::PatternRewriter& rewriter) const { ShapeComponentAnalysis shape\_component\_analysis; if (!isKnownBroadcastable(shape\_component\_analysis, op.getShapes(), op.getShapes().front())) return failure();
 // Replace constraint with a true witness. rewriter.replaceOpWithNewOp<shape::ConstWitnessOp>(op, true);
 return success();}
// Replace shape.broadcast with a shape if it's statically known.class BroadcastOpLowering final : public mlir::OpRewritePattern<shape::BroadcastOp> { public: explicit BroadcastOpLowering(MLIRContext\* ctx) : OpRewritePattern(ctx) {}
 LogicalResult matchAndRewrite(shape::BroadcastOp op, mlir::PatternRewriter& rewriter) const override;};
// Returns a shape tensor if the shapes can be broadcasted to a known shape.// Will either return one of the shapes or a generated mix of the shapes.llvm::Optional<Value> simplifyBroadcast(ShapeComponentAnalysis& analysis, ValueRange shapes, Location loc, OpBuilder\* builder) { // First find the input shape with the largest rank. SmallVector<ArrayRef<ShapeComponentAnalysis::SymbolicDimension>> shapes\_found; size\_t maxRank = 0; for (auto shape : llvm::enumerate(shapes)) { auto found\_shape = analysis.dimensionsForShapeTensor(shape.value()); if (!found\_shape) return {}; shapes\_found.push\_back(\*found\_shape); maxRank = std::max(maxRank, found\_shape->size()); }
 SmallVector<const ShapeComponentAnalysis::SymbolicDimension\*> joined\_dimensions(maxRank); SmallVector<std::pair<Value, int64\_t>> shape\_and\_rank\_for\_dim(maxRank); for (auto shape : llvm::enumerate(shapes\_found)) { for (auto dim : llvm::enumerate(llvm::reverse(shape.value()))) { // 1 dimensions don't contribute to the final result. if (dim.value().isConstant(1)) continue; // If it's not a 1 dimension it will be present in the result. Remember // where it came from. auto index = maxRank - dim.index() - 1; if (!joined\_dimensions[index]) { joined\_dimensions[index] = &dim.value(); shape\_and\_rank\_for\_dim[index] = std::make\_pair(shapes[shape.index()], shape.value().size()); continue; } // Bail if the dimensions are neither equal nor 1. if (\*joined\_dimensions[index] != dim.value()) return {}; } } // If the output is the same as one of the inputs just return that. if (llvm::is\_splat(shape\_and\_rank\_for\_dim) && shape\_and\_rank\_for\_dim[0].first) { return shape\_and\_rank\_for\_dim[0].first; } // Otherwise rematerialize the shape from the pieces we have. SmallVector<Value> elements; for (int i = 0; i != maxRank; ++i) { // 1 dimensions are filtered above, recreate the constant. if (!shape\_and\_rank\_for\_dim[i].first) { auto one = builder->getIntegerAttr( shapes[0].getType().cast<RankedTensorType>().getElementType(), 1); elements.push\_back(builder->create<ConstantOp>(loc, one)); continue; } // Extract from one of the shapes, accounting for the reverse indexing // performed by broadcast. Value index = builder->create<ConstantIndexOp>( loc, i - maxRank + shape\_and\_rank\_for\_dim[i].second); elements.push\_back(builder->create<tensor::ExtractOp>( loc, shape\_and\_rank\_for\_dim[i].first, index)); } return Value(builder->create<tensor::FromElementsOp>(loc, elements));}
LogicalResult BroadcastOpLowering::matchAndRewrite( shape::BroadcastOp op, mlir::PatternRewriter& rewriter) const { ShapeComponentAnalysis shape\_component\_analysis; auto new\_broadcast = simplifyBroadcast( shape\_component\_analysis, op.getShapes(), op.getLoc(), &rewriter); if (!new\_broadcast) return failure(); rewriter.replaceOp(op, {\*new\_broadcast}); return success();}
// -------------------------------------------------------------------------- //
// Rewrite mhlo.dynamic\_broadcast\_in\_dim operation into linalg.generic operation// if can infer the indexing maps for the operand from the symbolic shapes.class DynamicBroadcastInDimOpLowering : public mlir::OpRewritePattern<mhlo::DynamicBroadcastInDimOp> { public: using Base = OpRewritePattern<mhlo::DynamicBroadcastInDimOp>;
 explicit DynamicBroadcastInDimOpLowering(MLIRContext\* ctx);
 LogicalResult matchAndRewrite(mhlo::DynamicBroadcastInDimOp op, mlir::PatternRewriter& rewriter) const override;};
DynamicBroadcastInDimOpLowering::DynamicBroadcastInDimOpLowering( MLIRContext\* ctx) : Base(ctx) {}
// Check if broadcasting `from` to `to\_shape` is statically known to only have// dimensions that never expand or always expand.llvm::Optional<AffineMap> isNonExpandingBroadcast( ShapeComponentAnalysis& analysis, Value from, Value to\_shape) { auto in\_shape = analysis.dimensionsForShape(from); auto out\_shape = analysis.dimensionsForShapeTensor(to\_shape); if (!in\_shape || !out\_shape) return {};
 SmallVector<AffineExpr> input\_map\_exprs; size\_t rank = out\_shape->size(); MLIRContext\* ctx = (\*out\_shape)[0].expr.getContext(); size\_t d = 0; auto affine\_zero = getAffineConstantExpr(0, ctx); for (auto zip : llvm::zip(llvm::reverse(\*in\_shape), llvm::reverse(\*out\_shape))) { const auto& in = std::get<0>(zip); const auto& out = std::get<1>(zip); bool extend = in.isConstant(1) && !out.isConstant(1); input\_map\_exprs.push\_back(extend ? affine\_zero : getAffineDimExpr(rank - d - 1, ctx)); ++d;
 // Bail if this is neither a known expansion nor a known non-expansion. if (!extend && in != out) return {}; } // Any leading dimensions will be expanded. input\_map\_exprs.resize(in\_shape->size(), affine\_zero); std::reverse(input\_map\_exprs.begin(), input\_map\_exprs.end()); return AffineMap::get(/\*dimCount=\*/rank, /\*symbolCount=\*/0, input\_map\_exprs, ctx);}
LogicalResult DynamicBroadcastInDimOpLowering::matchAndRewrite( mhlo::DynamicBroadcastInDimOp op, mlir::PatternRewriter& rewriter) const { MLIRContext\* ctx = getContext();
 auto in\_type = op.operand().getType().dyn\_cast<RankedTensorType>(); auto out\_type = op.getResult().getType().dyn\_cast<RankedTensorType>(); if (!in\_type || !out\_type) return failure();
 // Check that broadcast is right-aligned (numpy style), so that operand // dimensions broadcasted to match inner-most dimensions of the output. auto bcast\_dims = op.broadcast\_dimensions().getValues<int64\_t>(); auto expected\_bcast\_dims = llvm::seq<int64\_t>( out\_type.getRank() - in\_type.getRank(), out\_type.getRank()); if (!llvm::equal(bcast\_dims, expected\_bcast\_dims)) return failure();
 ShapeComponentAnalysis shape\_component\_analysis; auto input\_map = isNonExpandingBroadcast( shape\_component\_analysis, op.operand(), op.output\_dimensions()); if (!input\_map) return failure();
 // Resolve dynamic output dimensions for the `linalg.init\_tensor` operation. SmallVector<Value> output\_dyn\_dimensions; Location loc = op.getLoc(); int64\_t rank = out\_type.getRank(); for (size\_t d = 0; d < rank; ++d) { int64\_t output\_dim = out\_type.getShape()[d];
 // Skip static output dimensions, they will be resolved from the shape. if (output\_dim >= 0) continue;
 // Resolve the dynamic size of the output dimension. Value output\_dyn\_dim = rewriter.create<tensor::ExtractOp>( loc, op.output\_dimensions(), ValueRange{rewriter.create<ConstantIndexOp>(loc, d)});
 // Symbolic shape analysis might have given us an i32 or i64. Cast to index. if (!output\_dyn\_dim.getType().isIndex()) output\_dyn\_dim = rewriter.create<IndexCastOp>(loc, output\_dyn\_dim, rewriter.getIndexType());
 output\_dyn\_dimensions.push\_back(output\_dyn\_dim); }
 // Create a linalg.tensor\_init operation to initialize output. Value init = rewriter.create<linalg::InitTensorOp>(loc, output\_dyn\_dimensions, out\_type.getShape(), out\_type.getElementType());
 // Output indexing map is an identity with `rank` number of loops. AffineMap output\_map = AffineMap::getMultiDimIdentityMap(rank, ctx);
 // All iterators are parallel. SmallVector<llvm::StringRef> iterator\_types(rank, "parallel");
 rewriter.replaceOpWithNewOp<linalg::GenericOp>( op, /\*resultTensorTypes=\*/TypeRange{init.getType()}, /\*inputs=\*/ValueRange{op.operand()}, /\*outputs=\*/ValueRange{init}, /\*indexingMaps=\*/llvm::makeArrayRef({\*input\_map, output\_map}), /\*iteratorTypes=\*/iterator\_types, [&](OpBuilder& nested\_builder, Location nested\_loc, ValueRange args) { nested\_builder.create<linalg::YieldOp>(nested\_loc, args[0]); });
 return success();}
// -------------------------------------------------------------------------- //// Optimize function based on the symbolic shape attributes.// -------------------------------------------------------------------------- //
struct SymbolicShapeOptimizationPass : public SymbolicShapeOptimizationBase<SymbolicShapeOptimizationPass> { SymbolicShapeOptimizationPass() = default;
 explicit SymbolicShapeOptimizationPass(bool constraints\_only) { this->optimize\_only\_constraints = constraints\_only; }
 void runOnFunction() override { FuncOp func = getFunction();
 MLIRContext\* ctx = &getContext(); mlir::RewritePatternSet patterns(ctx);
 // Rewrite constraints based on the symbolic shapes. patterns.insert<CstrBroadcastableOpLowering>(ctx); // Rewrite shape.broadcast based on the symbolic shapes. patterns.insert<BroadcastOpLowering>(ctx);
 // Move broadcasts up across mhlo operations to enable more opportunities // for constraints and broadcasts optimizations. These patterns are only // applicable if we do not lower mhlo broadcasts to linalg.generic. if (optimize\_only\_constraints) mlir::mhlo::PopulateBroadcastsPropagationPatterns(ctx, &patterns);
 // Rewrite broadcasts based on the symbolic shapes if enabled. if (!optimize\_only\_constraints) patterns.insert<DynamicBroadcastInDimOpLowering>(ctx);
 // Add shape dialect canonicalization patterns to fold shape operations // after constraints are replaced with constant witness. mlir::Dialect\* shape\_dialect = ctx->getLoadedDialect<shape::ShapeDialect>(); for (auto\* op : ctx->getRegisteredOperations()) { if (op->dialect.getTypeID() == shape\_dialect->getTypeID()) op->getCanonicalizationPatterns(patterns, ctx); }
 (void)mlir::applyPatternsAndFoldGreedily(func, std::move(patterns)); }};
} // namespace
std::unique\_ptr<FunctionPass> CreateSymbolicShapeOptimizationPass( bool constraints\_only) { return std::make\_unique<SymbolicShapeOptimizationPass>(constraints\_only);}
} // namespace tensorflow

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9fc81e45_20250115_084056.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F35f0fabb4c178253a964d7aabdbb15c6a398b69a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F35f0fabb4c178253a964d7aabdbb15c6a398b69a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  826](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/35f0fabb4c178253a964d7aabdbb15c6a398b69a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid Segfault for scalar shapes.

[Browse files](/tensorflow/tensorflow/tree/35f0fabb4c178253a964d7aabdbb15c6a398b69a)
Browse the repository at this point in the history

```
Calling tensor::FromElementsOp with an empty vector of elements and no type
causes a segfault. We need to let the FromElementsOp know which scalar type it
should have.
Also add back the DynamicBroadcastInDimOp canonicalization patterns, which
previously prevented this bug from happening.
Add a regression test that demonstrates the bug.

PiperOrigin-RevId: 417561444
Change-Id: I6d1d6cfb71aabbad6102422625a00bbe253ac95a
```

* Loading branch information

[![@akuegel](https://avatars.githubusercontent.com/u/14309772?s=40&v=4)](/akuegel) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[akuegel](/tensorflow/tensorflow/commits?author=akuegel "View all commits by akuegel")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Dec 21, 2021

1 parent
[69db6c4](/tensorflow/tensorflow/commit/69db6c4226c706bb6394010133d9c46c9485cae5)

commit 35f0fab

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**15 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/compiler/mlir/tfrt

  + jit/transforms

    - tensorflow/compiler/mlir/tfrt/jit/transforms/tf\_cpurt\_symbolic\_shape\_optimization.cc
      [tf\_cpurt\_symbolic\_shape\_optimization.cc](#diff-f334ddbd8068cb3d4408df19c03396eeb428e9b98510629d6e459d7d84e07878)
  + python\_tests/regression\_tests

    - tensorflow/compiler/mlir/tfrt/python\_tests/regression\_tests/scalar\_broadcast.mlir
      [scalar\_broadcast.mlir](#diff-76da4dafd2122adbf72e8751ec06e3441a648d6f39b88b2d6397ae94a5ad62bc)

## There are no files selected for viewing

4 changes: 4 additions & 0 deletions

4
[tensorflow/compiler/mlir/tfrt/jit/transforms/tf\_cpurt\_symbolic\_shape\_optimization.cc](#diff-f334ddbd8068cb3d4408df19c03396eeb428e9b98510629d6e459d7d84e07878 "tensorflow/compiler/mlir/tfrt/jit/transforms/tf_cpurt_symbolic_shape_optimization.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/35f0fabb4c178253a964d7aabdbb15c6a398b69a/tensorflow/compiler/mlir/tfrt/jit/transforms/tf_cpurt_symbolic_shape_optimization.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,10 @@ llvm::Optional<Value> simplifyBroadcast(ShapeComponentAnalysis& analysis, |
|  |  | shapes\_found.push\_back(\*found\_shape); |
|  |  | maxRank = std::max(maxRank, found\_shape->size()); |
|  |  | } |
|  |  | if (maxRank == 0) { |
|  |  | return Value(builder->create<tensor::FromElementsOp>( |
|  |  | loc, shapes[0].getType(), SmallVector<Value>())); |
|  |  | } |
|  |  |  |
|  |  | SmallVector<const ShapeComponentAnalysis::SymbolicExpr\*> joined\_dimensions( |
|  |  | maxRank); |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[tensorflow/compiler/mlir/tfrt/python\_tests/regression\_tests/scalar\_broadcast.mlir](#diff-76da4dafd2122adbf72e8751ec06e3441a648d6f39b88b2d6397ae94a5ad62bc "tensorflow/compiler/mlir/tfrt/python_tests/regression_tests/scalar_broadcast.mlir")

Show comments

[View file](/tensorflow/tensorflow/blob/35f0fabb4c178253a964d7aabdbb15c6a398b69a/tensorflow/compiler/mlir/tfrt/python_tests/regression_tests/scalar_broadcast.mlir)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,11 @@ |
|  |  | builtin.func @test(%V\_\_0 : tensor<i1> { python\_test\_attrs.static\_type = tensor<i1> }, %V\_\_1 : tensor<f32> { python\_test\_attrs.static\_type = tensor<f32> }, %V\_\_2 : tensor<f32> { python\_test\_attrs.static\_type = tensor<f32> }) -> tensor<f32> { |
|  |  | %0 = "tf.Cast"(%V\_\_0) : (tensor<i1>) -> tensor<i1> |
|  |  | %1 = "tf.Selu"(%V\_\_2) : (tensor<f32>) -> tensor<f32> |
|  |  | %2 = "tf.NextAfter"(%1, %V\_\_2) : (tensor<f32>, tensor<f32>) -> tensor<f32> |
|  |  | %3 = "tf.Elu"(%2) : (tensor<f32>) -> tensor<f32> |
|  |  | %4 = "tf.Cosh"(%3) : (tensor<f32>) -> tensor<f32> |
|  |  | %5 = "tf.Elu"(%4) : (tensor<f32>) -> tensor<f32> |
|  |  | %6 = "tf.Div"(%V\_\_1, %5) : (tensor<f32>, tensor<f32>) -> tensor<f32> |
|  |  | %7 = "tf.Select"(%0, %6, %V\_\_1) : (tensor<i1>, tensor<f32>, tensor<f32>) -> tensor<f32> |
|  |  | return %7 : tensor<f32> |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `35f0fab`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F35f0fabb4c178253a964d7aabdbb15c6a398b69a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


