=== Content from github.com_cb532280_20250114_215124.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F6b5adc0877de832b2a7c189532dbbbc64622eeb6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F6b5adc0877de832b2a7c189532dbbbc64622eeb6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/6b5adc0877de832b2a7c189532dbbbc64622eeb6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Prevent `CHECK`-fail when building reference tensor.

[Browse files](/tensorflow/tensorflow/tree/6b5adc0877de832b2a7c189532dbbbc64622eeb6)
Browse the repository at this point in the history

```
The tensor constructor does not allow reference dtypes, as these should not show up explicitly. However, when passed these invalid types instead of building an invalid object the constructor crashes via a `CHECK`-fail. We have a static builder that properly handles this case but is not applicable given current usage.

Instead, before calling the constructor, we can check that the dtype is not a reference type and return an error otherwise, given that the dtype is user controlled so malicious users can trigger denial of service.

PiperOrigin-RevId: 409662503
Change-Id: I5892f831fde7f276cd7ab34519cf6b8061c71a59
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 13, 2021

1 parent
[af2cab9](/tensorflow/tensorflow/commit/af2cab9355e8d5bf48c2c7042b3faaf31262ea8c)

commit 6b5adc0

Showing
**1 changed file**
with
**5 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

5 changes: 5 additions & 0 deletions

5
[tensorflow/core/grappler/optimizers/constant\_folding.cc](#diff-663636d4972e75e590efa74039aebbdd26f36eeabbf81ab6691915aa5995a349 "tensorflow/core/grappler/optimizers/constant_folding.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/6b5adc0877de832b2a7c189532dbbbc64622eeb6/tensorflow/core/grappler/optimizers/constant_folding.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1363,6 +1363,11 @@ Status ConstantFolding::EvaluateOneFoldable(const NodeDef& node, |
|  |  | input\_tensor.ToString(), |
|  |  | " has a dtype of DT\_INVALID.")); |
|  |  | } |
|  |  | if (IsRefType(raw\_val.dtype())) { |
|  |  | return errors::InvalidArgument( |
|  |  | "Not allowed to construct a tensor with reference dtype, got ", |
|  |  | DataTypeString(raw\_val.dtype())); |
|  |  | } |
|  |  | Tensor\* value = new Tensor(raw\_val.dtype(), raw\_val.tensor\_shape()); |
|  |  | if (!value->FromProto(raw\_val)) { |
|  |  | delete (value); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6b5adc0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F6b5adc0877de832b2a7c189532dbbbc64622eeb6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_323c8481_20250114_215126.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-fx5c-h9f6-rv7c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-fx5c-h9f6-rv7c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# `CHECK`-fails due to attempting to build a reference tensor

Moderate

[mihaimaruseac](/mihaimaruseac)
published
GHSA-fx5c-h9f6-rv7c
Feb 2, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.8.0

## Patched versions

2.5.3, 2.6.3, 2.7.1

## Description

### Impact

A malicious user can cause a denial of service by altering a `SavedModel` such that [Grappler optimizer would attempt to build a tensor using a reference `dtype`](https://github.com/tensorflow/tensorflow/blob/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/constant_folding.cc#L1328-L1402). This would result in a crash due to a `CHECK`-fail [in the `Tensor` constructor](https://github.com/tensorflow/tensorflow/blob/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/tensor.cc#L733-L781) as reference types are not allowed.

### Patches

We have patched the issue in GitHub commit [6b5adc0877de832b2a7c189532dbbbc64622eeb6](https://github.com/tensorflow/tensorflow/commit/6b5adc0877de832b2a7c189532dbbbc64622eeb6).

The fix will be included in TensorFlow 2.8.0. We will also cherrypick this commit on TensorFlow 2.7.1, TensorFlow 2.6.3, and TensorFlow 2.5.3, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Moderate

### CVE ID

CVE-2022-23588

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_27cf57a9_20250114_215117.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fframework%2Ftensor.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fframework%2Ftensor.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[framework](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework)
/
# tensor.cc

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/tensor.cc)1316 lines (1194 loc) · 45.1 KB a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[framework](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework)
/
# tensor.cc

Top
## File metadata and controls

* Code
* Blame

1316 lines (1194 loc) · 45.1 KB[Raw](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/tensor.cc)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\* Copyright 2015 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
// Implementation notes://// Tensor.cc uses a few templated classes and structs to facilitate// implementation of the Tensor class.//// \* Buffer<T>: provides the implementation for a typed array T[n].// The array is allocated by the given allocator. It runs T's// default constructors and destructors when T is not a simple type// (e.g., string.), and skips them otherwise.//// \* Helper<T>: provides various routines given type T. The routines// includes running the constructor and destructor of T[], encoding// an decoding T[] into/from a Cord, etc.
#include "tensorflow/core/framework/tensor.h"
#include <utility>
#include "absl/strings/escaping.h"#include "tensorflow/core/framework/allocation\_description.pb.h"#include "tensorflow/core/framework/log\_memory.h"#include "tensorflow/core/framework/resource\_handle.h"#include "tensorflow/core/framework/resource\_handle.pb.h"#include "tensorflow/core/framework/tensor.pb.h"#include "tensorflow/core/framework/tensor\_description.pb.h"#include "tensorflow/core/framework/type\_traits.h"#include "tensorflow/core/framework/typed\_allocator.h"#include "tensorflow/core/framework/types.h"#include "tensorflow/core/framework/types.pb.h"#include "tensorflow/core/framework/variant.h"#include "tensorflow/core/framework/variant\_encode\_decode.h"#include "tensorflow/core/framework/variant\_op\_registry.h"#include "tensorflow/core/framework/variant\_tensor\_data.h"#include "tensorflow/core/lib/core/coding.h"#include "tensorflow/core/lib/core/errors.h"#include "tensorflow/core/lib/core/status.h"#include "tensorflow/core/lib/gtl/inlined\_vector.h"#include "tensorflow/core/lib/strings/str\_util.h"#include "tensorflow/core/lib/strings/strcat.h"#include "tensorflow/core/platform/errors.h"#include "tensorflow/core/platform/logging.h"#include "tensorflow/core/platform/macros.h"#include "tensorflow/core/platform/protobuf.h"#include "tensorflow/core/platform/tensor\_coding.h"#include "tensorflow/core/platform/types.h"
namespace tensorflow {
// Allow Tensors to be stored inside Variants with automatic// encoding/decoding when those Variants are themselves being decoded// in a Tensor's FromProto.//// NOTE(mrry): The corresponding "copy function" registrations can be found in// ../common\_runtime/copy\_tensor.cc (due to dependencies on other common\_runtime// code).REGISTER\_UNARY\_VARIANT\_DECODE\_FUNCTION(Tensor, "tensorflow::Tensor");
bool TensorBuffer::GetAllocatedBytes(size\_t\* out\_bytes) const { AllocationDescription allocation\_description; FillAllocationDescription(&allocation\_description); if (allocation\_description.allocated\_bytes() > 0) { \*out\_bytes = allocation\_description.allocated\_bytes(); return true; } else { return false; }}
namespace {
// An un-templated base class for Buffer.class BufferBase : public TensorBuffer { public: explicit BufferBase(Allocator\* alloc, void\* data\_ptr) : TensorBuffer(data\_ptr), alloc\_(alloc) {}
 TensorBuffer\* root\_buffer() override { return this; }
 bool GetAllocatedBytes(size\_t\* out\_bytes) const override { if (alloc\_->TracksAllocationSizes()) { \*out\_bytes = alloc\_->AllocatedSize(data()); return \*out\_bytes > 0; } else { return false; } }
 void FillAllocationDescription(AllocationDescription\* proto) const override { void\* data\_ptr = data(); int64\_t rb = size(); proto->set\_requested\_bytes(rb); proto->set\_allocator\_name(alloc\_->Name()); proto->set\_ptr(reinterpret\_cast<uintptr\_t>(data\_ptr)); if (alloc\_->TracksAllocationSizes()) { int64\_t ab = alloc\_->AllocatedSize(data\_ptr); proto->set\_allocated\_bytes(ab); int64\_t id = alloc\_->AllocationId(data\_ptr); if (id > 0) { proto->set\_allocation\_id(id); } if (RefCountIsOne()) { proto->set\_has\_single\_reference(true); } } }
 protected: void RecordDeallocation() { LogMemory::RecordTensorDeallocation(alloc\_->AllocationId(data()), alloc\_->Name()); }
 Allocator\* const alloc\_;};
// Typed ref-counted buffer: T[n].template <typename T>class Buffer : public BufferBase { public: Buffer(Allocator\* a, int64\_t n); Buffer(Allocator\* a, int64\_t n, const AllocationAttributes& allocation\_attr);
 size\_t size() const override { return sizeof(T) \* elem\_; }
 private: int64\_t elem\_;
 ~Buffer() override;
 TF\_DISALLOW\_COPY\_AND\_ASSIGN(Buffer);};
void LogUnexpectedSize(int64\_t actual, int64\_t expected) { LOG(ERROR) << "Input size was " << actual << " and expected " << expected;}
bool MemoryLoggingEnabled() { static bool memory\_logging\_enabled = LogMemory::IsEnabled(); return memory\_logging\_enabled;}
// A set of helper functions depending on T.template <typename T>struct Helper { // By default, we assume T is a simple type (float, int32, etc.) static\_assert(is\_simple\_type<T>::value, "T is not a simple type."); typedef protobuf::RepeatedField<T> RepeatedFieldType;
 // Encoder of simple type T to a string. We do a copy. template <typename Destination> static void Encode(TensorBuffer\* in, int64\_t n, Destination\* out) { DCHECK\_EQ(in->size(), sizeof(T) \* n); port::AssignRefCounted(StringPiece(in->base<const char>(), in->size()), in, out); }
 // Decoder of simple type T. Copy the bytes from "in" into the // tensor buffer. template <typename Source> static TensorBuffer\* Decode(Allocator\* a, const Source& in, int64\_t n) { if (in.size() != sizeof(T) \* n) { LogUnexpectedSize(in.size(), sizeof(T) \* n); return nullptr; } Buffer<T>\* buf = new Buffer<T>(a, n); char\* data = buf->template base<char>(); if (data == nullptr) { buf->Unref(); return nullptr; } port::CopyToArray(in, data); return buf; }
 // Memory usage. static int64\_t TotalBytes(TensorBuffer\* in, int64\_t n) { DCHECK\_EQ(in->size(), sizeof(T) \* n); return in->size(); }};
// Helper specialization for string (the only non-simple type we// support).template <>struct Helper<tstring> { // Proto message uses RepeatedFieldType to hold repeated T. typedef protobuf::RepeatedPtrField<string> RepeatedFieldType;
 // Encodes "n" elements of type string stored in "in" into Cord // "out", which is usually the TensorProto::tensor\_content. template <typename Destination> static void Encode(TensorBuffer\* in, int64\_t n, Destination\* out) { port::EncodeStringList(in->base<const tstring>(), n, out); }
 // Decodes "n" elements of type string from "in" and constructs a // buffer out of it. Returns nullptr if the decoding fails. "in" is // usually the TensorProto::tensor\_content. template <typename Source> static TensorBuffer\* Decode(Allocator\* a, const Source& in, int64\_t n) { Buffer<tstring>\* buf = new Buffer<tstring>(a, n); tstring\* strings = buf->template base<tstring>(); if (strings == nullptr || !port::DecodeStringList(in, strings, n)) { buf->Unref(); return nullptr; } return buf; }
 // Returns the estimated memory usage of "n" elements of type T // stored in buffer "in". static int64\_t TotalBytes(TensorBuffer\* in, int n) { int64\_t tot = in->size(); DCHECK\_EQ(tot, sizeof(tstring) \* n); const tstring\* p = in->base<const tstring>(); for (int i = 0; i < n; ++i, ++p) tot += p->size(); return tot; }};
template <>struct Helper<ResourceHandle> { // Proto message uses RepeatedFieldType to hold repeated T. typedef protobuf::RepeatedPtrField<string> RepeatedFieldType;
 // Encodes "n" elements of type ResourceHandle stored in "in" into destination // "out", which is usually the TensorProto::tensor\_content. template <typename Destination> static void Encode(TensorBuffer\* in, int64\_t n, Destination\* out) { EncodeResourceHandleList(in->base<const ResourceHandle>(), n, port::NewStringListEncoder(out)); }
 // Decodes "n" elements of type string from "in" and constructs a // buffer out of it. Returns nullptr if the decoding fails. "in" is // usually the TensorProto::tensor\_content. template <typename Source> static TensorBuffer\* Decode(Allocator\* a, const Source& in, int64\_t n) { auto\* buf = new Buffer<ResourceHandle>(a, n); ResourceHandle\* ps = buf->template base<ResourceHandle>(); if (ps == nullptr || !DecodeResourceHandleList(port::NewStringListDecoder(in), ps, n)) { buf->Unref(); return nullptr; } return buf; }
 // Returns the estimated memory usage of "n" elements of type T // stored in buffer "in". static int64\_t TotalBytes(TensorBuffer\* in, int n) { return n \* sizeof(ResourceHandle); }};
template <>struct Helper<Variant> { // Encodes "n" elements of type Variant stored in "in" into destination // "out", which is usually the TensorProto::tensor\_content. template <typename Destination> static void Encode(TensorBuffer\* in, int64\_t n, Destination\* out) { EncodeVariantList(in->base<const Variant>(), n, port::NewStringListEncoder(out)); }
 // Decodes "n" elements of type Variant from "in" and constructs a // buffer out of it. Returns nullptr if the decoding fails. "in" is // usually the TensorProto::tensor\_content. template <typename Source> static TensorBuffer\* Decode(Allocator\* a, const Source& in, int64\_t n) { auto\* buf = new Buffer<Variant>(a, n); Variant\* ps = buf->template base<Variant>(); if (ps == nullptr || !DecodeVariantList(port::NewStringListDecoder(in), ps, n)) { buf->Unref(); return nullptr; } return buf; }
 // Returns the estimated memory usage of "n" elements of type T // stored in buffer "in". static int64\_t TotalBytes(TensorBuffer\* in, int n) { return n \* sizeof(Variant); }};
template <typename T>struct ProtoHelper {};
// For a C++ type "T" (float, double, int32, etc.), the repeated field// "N"\_val (float\_val, int\_val, label\_val, etc.) of type "F" (float,// int32, string, etc) in the TensorProto is used for serializing the// tensor of type "T".#define PROTO\_TRAITS(T, F, N) \ template <> \ struct ProtoHelper<T> { \ typedef Helper<F>::RepeatedFieldType FieldType; \ static FieldType::const\_iterator Begin(const TensorProto& proto) { \ return proto.N##\_val().begin(); \ } \ static size\_t NumElements(const TensorProto& proto) { \ return proto.N##\_val().size(); \ } \ static void Fill(const T\* data, size\_t n, TensorProto\* proto) { \ typename ProtoHelper<T>::FieldType copy(data, data + n); \ proto->mutable\_##N##\_val()->Swap(&copy); \ } \ };PROTO\_TRAITS(float, float, float);PROTO\_TRAITS(double, double, double);PROTO\_TRAITS(int32, int32, int);PROTO\_TRAITS(uint8, int32, int);PROTO\_TRAITS(uint16, int32, int);PROTO\_TRAITS(uint32, uint32, uint32);PROTO\_TRAITS(int16, int32, int);PROTO\_TRAITS(int8, int32, int);PROTO\_TRAITS(bool, bool, bool);PROTO\_TRAITS(tstring, tstring, string);PROTO\_TRAITS(qint8, int32, int);PROTO\_TRAITS(quint8, int32, int);PROTO\_TRAITS(qint16, int32, int);PROTO\_TRAITS(quint16, int32, int);#undef PROTO\_TRAITS
template <>struct ProtoHelper<int64\_t> { static const int64\_t\* Begin(const TensorProto& proto) { return reinterpret\_cast<const int64\_t\*>(proto.int64\_val().begin()); } static size\_t NumElements(const TensorProto& proto) { return proto.int64\_val().size(); } static void Fill(const int64\_t\* data, size\_t n, TensorProto\* proto) { protobuf::RepeatedField<protobuf\_int64> copy(data, data + n); proto->mutable\_int64\_val()->Swap(&copy); }};
template <>struct ProtoHelper<uint64> { static const uint64\* Begin(const TensorProto& proto) { return reinterpret\_cast<const uint64\*>(proto.uint64\_val().begin()); } static size\_t NumElements(const TensorProto& proto) { return proto.uint64\_val().size(); } static void Fill(const uint64\* data, size\_t n, TensorProto\* proto) { protobuf::RepeatedField<protobuf\_uint64> copy(data, data + n); proto->mutable\_uint64\_val()->Swap(&copy); }};
template <>struct ProtoHelper<ResourceHandle> { static protobuf::RepeatedPtrField<ResourceHandleProto>::const\_iterator Begin( const TensorProto& proto) { return proto.resource\_handle\_val().begin(); } static size\_t NumElements(const TensorProto& proto) { return proto.resource\_handle\_val().size(); } static void Fill(const ResourceHandle\* data, size\_t n, TensorProto\* proto) { auto\* handles = proto->mutable\_resource\_handle\_val(); handles->Clear(); for (size\_t i = 0; i < n; i++) { data[i].AsProto(handles->Add()); } }};
template <>struct ProtoHelper<Variant> { static protobuf::RepeatedPtrField<VariantTensorDataProto>::const\_iterator Begin(const TensorProto& proto) { return proto.variant\_val().begin(); } static size\_t NumElements(const TensorProto& proto) { return proto.variant\_val().size(); } static void Fill(const Variant\* data, size\_t n, TensorProto\* proto) { auto\* variant\_values = proto->mutable\_variant\_val(); variant\_values->Clear(); for (size\_t i = 0; i < n; ++i) { VariantTensorData tmp; data[i].Encode(&tmp); tmp.ToProto(variant\_values->Add()); } }};
template <>struct ProtoHelper<complex64> { typedef Helper<float>::RepeatedFieldType FieldType; static const complex64\* Begin(const TensorProto& proto) { return reinterpret\_cast<const complex64\*>(proto.scomplex\_val().data()); } static size\_t NumElements(const TensorProto& proto) { return proto.scomplex\_val().size() / 2; } static void Fill(const complex64\* data, size\_t n, TensorProto\* proto) { const float\* p = reinterpret\_cast<const float\*>(data); FieldType copy(p, p + n \* 2); proto->mutable\_scomplex\_val()->Swap(&copy); }};
template <>struct ProtoHelper<complex128> { typedef Helper<double>::RepeatedFieldType FieldType; static const complex128\* Begin(const TensorProto& proto) { return reinterpret\_cast<const complex128\*>(proto.dcomplex\_val().data()); } static size\_t NumElements(const TensorProto& proto) { return proto.dcomplex\_val().size() / 2; } static void Fill(const complex128\* data, size\_t n, TensorProto\* proto) { const double\* p = reinterpret\_cast<const double\*>(data); FieldType copy(p, p + n \* 2); proto->mutable\_dcomplex\_val()->Swap(&copy); }};
template <>struct ProtoHelper<qint32> { typedef Helper<int32>::RepeatedFieldType FieldType; static const qint32\* Begin(const TensorProto& proto) { return reinterpret\_cast<const qint32\*>(proto.int\_val().data()); } static size\_t NumElements(const TensorProto& proto) { return proto.int\_val().size(); } static void Fill(const qint32\* data, size\_t n, TensorProto\* proto) { const int32\* p = reinterpret\_cast<const int32\*>(data); FieldType copy(p, p + n); proto->mutable\_int\_val()->Swap(&copy); }};
template <>struct ProtoHelper<bfloat16> { static void Fill(const bfloat16\* data, size\_t n, TensorProto\* proto) { proto->mutable\_half\_val()->Reserve(n); for (size\_t i = 0; i < n; ++i) { proto->mutable\_half\_val()->AddAlreadyReserved( Eigen::numext::bit\_cast<uint16>(data[i])); } }};
template <>struct ProtoHelper<Eigen::half> { static void Fill(const Eigen::half\* data, size\_t n, TensorProto\* proto) { proto->mutable\_half\_val()->Reserve(n); for (size\_t i = 0; i < n; ++i) { proto->mutable\_half\_val()->AddAlreadyReserved( Eigen::numext::bit\_cast<uint16>(data[i])); } }};
template <typename T>Buffer<T>::Buffer(Allocator\* a, int64\_t n) : BufferBase(a, TypedAllocator::Allocate<T>(a, n, AllocationAttributes())), elem\_(n) {}
template <typename T>Buffer<T>::Buffer(Allocator\* a, int64\_t n, const AllocationAttributes& allocation\_attr) : BufferBase(a, TypedAllocator::Allocate<T>(a, n, allocation\_attr)), elem\_(n) {}
template <typename T>Buffer<T>::~Buffer() { if (data()) { if (MemoryLoggingEnabled()) { RecordDeallocation(); } TypedAllocator::Deallocate<T>(alloc\_, static\_cast<T\*>(data()), elem\_); }}
// Allocates a T[n] buffer. Fills in the buffer with repeated values// in "in". If "in" has less values than "n", fills the rest of T[n]// with the last value. If "in" has no values, fills T[n] with the// default value for T.//// This routine is using the typed fields (float\_val, etc.) in the// tensor proto as opposed to the untyped binary representation// (tensor\_content). This is used when we expect the TensorProto is// used by a client program which may not know how to encode a tensor// in the compact binary representation.template <typename T>TensorBuffer\* FromProtoField(Allocator\* a, const TensorProto& in, int64\_t n) { CHECK\_GT(n, 0); Buffer<T>\* buf = new Buffer<T>(a, n); T\* data = buf->template base<T>(); if (data == nullptr) { buf->Unref(); return nullptr; }
 const int64\_t in\_n = ProtoHelper<T>::NumElements(in); if (in\_n <= 0) { std::fill\_n(data, n, T()); } else { auto begin = ProtoHelper<T>::Begin(in); if (n <= in\_n) { std::copy\_n(begin, n, data); } else { std::copy\_n(begin, in\_n, data); if (std::is\_trivially\_copyable<T>::value) { const T last = \*(data + in\_n - 1); std::fill\_n(data + in\_n, n - in\_n, last); } else { const T& last = \*(data + in\_n - 1); std::fill\_n(data + in\_n, n - in\_n, last); } } }
 return buf;}
template <>TensorBuffer\* FromProtoField<Variant>(Allocator\* a, const TensorProto& in, int64\_t n) { CHECK\_GT(n, 0); Buffer<Variant>\* buf = new Buffer<Variant>(a, n); Variant\* data = buf->template base<Variant>(); if (data == nullptr) { buf->Unref(); return nullptr; } const int64\_t in\_n = ProtoHelper<Variant>::NumElements(in); if (in\_n <= 0) { std::fill\_n(data, n, Variant()); } else { // If tensor shape says we have n < in\_n elements in the output tensor // then make sure to only decode the first n out of the in\_n elements in the // in tensors. In all other cases, we decode all in\_n elements of in and set // the remaining elements up to n to be the default Variant() value. const int64\_t real\_n = n < in\_n ? n : in\_n; for (int64\_t i = 0; i < real\_n; ++i) { data[i] = in.variant\_val(i); if (!DecodeUnaryVariant(&data[i])) { LOG(ERROR) << "Could not decode variant with type\_name: \"" << data[i].TypeName() << "\". Perhaps you forgot to register a " "decoder via REGISTER\_UNARY\_VARIANT\_DECODE\_FUNCTION?"; buf->Unref(); return nullptr; } } for (int64\_t i = in\_n; i < n; ++i) { data[i] = Variant(); } } return buf;}
// fp16 and bfloat16 are opaque to the protobuf, so we deserialize these// identical to uint16 but with data stored in half\_val instead of int\_val (ie.,// we don't use ProtoHelper<uint16>).template <>TensorBuffer\* FromProtoField<Eigen::half>(Allocator\* a, const TensorProto& in, int64\_t n) { CHECK\_GT(n, 0); Buffer<Eigen::half>\* buf = new Buffer<Eigen::half>(a, n); uint16\* data = buf->template base<uint16>(); if (data == nullptr) { buf->Unref(); return nullptr; } const int64\_t in\_n = in.half\_val().size(); auto begin = in.half\_val().begin(); if (n <= in\_n) { std::copy\_n(begin, n, data); } else if (in\_n > 0) { std::copy\_n(begin, in\_n, data); const uint16 last = \*(data + in\_n - 1); std::fill\_n(data + in\_n, n - in\_n, last); } else { std::fill\_n(data, n, 0); } return buf;}
template <>TensorBuffer\* FromProtoField<bfloat16>(Allocator\* a, const TensorProto& in, int64\_t n) { CHECK\_GT(n, 0); Buffer<bfloat16>\* buf = new Buffer<bfloat16>(a, n); uint16\* data = buf->template base<uint16>(); if (data == nullptr) { buf->Unref(); return nullptr; } const int64\_t in\_n = in.half\_val().size(); auto begin = in.half\_val().begin(); if (n <= in\_n) { std::copy\_n(begin, n, data); } else if (in\_n > 0) { std::copy\_n(begin, in\_n, data); const uint16 last = \*(data + in\_n - 1); std::fill\_n(data + in\_n, n - in\_n, last); } else { std::fill\_n(data, n, 0); } return buf;}
// Copies T[n] stored in the buffer "in" into the repeated field in// "out" corresponding to type T.template <typename T>void ToProtoField(const TensorBuffer& in, int64\_t n, TensorProto\* out) { const T\* data = in.base<const T>(); // NOTE: T may not the same as // ProtoHelper<T>::FieldType::value\_type. E.g., T==int16, // ProtoHelper<T>::FieldType::value\_type==int32. If performance is // critical, we can specialize T=float and do memcpy directly. ProtoHelper<T>::Fill(data, n, out);}
void RefIfNonNull(core::RefCounted\* buf) { if (buf) buf->Ref();}
void UnrefIfNonNull(core::RefCounted\* buf) { if (buf) buf->Unref();}
} // end namespace
Tensor::Tensor() : Tensor(DT\_FLOAT) {}
Tensor::Tensor(DataType type) : shape\_(type), buf\_(nullptr) {}
Tensor::Tensor(DataType type, const TensorShape& shape, TensorBuffer\* buf) : shape\_(shape), buf\_(buf) { set\_dtype(type); RefIfNonNull(buf);}
Tensor::Tensor(DataType type, TensorShape shape, core::RefCountPtr<TensorBuffer> buf) : shape\_(std::move(shape)), buf\_(buf.release()) { set\_dtype(type);}
bool Tensor::IsInitialized() const { return (buf\_ != nullptr && buf\_->data() != nullptr) || shape\_.num\_elements() == 0;}
void Tensor::CheckType(DataType expected\_dtype) const { CHECK\_EQ(dtype(), expected\_dtype) << " " << DataTypeString(expected\_dtype) << " expected, got " << DataTypeString(dtype());}
void Tensor::CheckTypeAndIsAligned(DataType expected\_dtype) const { CHECK\_EQ(dtype(), expected\_dtype) << " " << DataTypeString(expected\_dtype) << " expected, got " << DataTypeString(dtype()); CHECK(IsAligned()) << "ptr = " << base<void>();}
void Tensor::CheckIsAlignedAndSingleElement() const { CHECK(IsAligned()) << "Aligned and single element"; CHECK\_EQ(1, NumElements()) << "Must have a one element tensor";}
Tensor::~Tensor() { UnrefIfNonNull(buf\_); }
Status Tensor::BitcastFrom(const Tensor& other, DataType dtype, const TensorShape& shape) { int in\_size = DataTypeSize(other.dtype()); int out\_size = DataTypeSize(dtype); if (in\_size == 0) { return errors::InvalidArgument("other tensor has zero-sized data type"); } if (out\_size == 0) { return errors::InvalidArgument("specified output type is zero-sized"); } if (shape.num\_elements() \* out\_size != other.shape().num\_elements() \* in\_size) { return errors::InvalidArgument( "input and output shapes/data type sizes are not compatible"); } shape\_ = shape; shape\_.set\_data\_type(dtype); if (buf\_ != other.buf\_) { UnrefIfNonNull(buf\_); buf\_ = other.buf\_; RefIfNonNull(buf\_); } return Status::OK();}
// Notice that buf\_ either points to a regular TensorBuffer or a SubBuffer.// For the latter case, we have to make sure that the refcount is// one both for the SubBuffer \_and\_ the underlying TensorBuffer.bool Tensor::RefCountIsOne() const { return buf\_ != nullptr && buf\_->RefCountIsOne() && buf\_->root\_buffer()->RefCountIsOne() && buf\_->OwnsMemory();}
// The macro CASES() expands to a switch statement conditioned on// TYPE\_ENUM. Each case expands the STMTS after a typedef for T.#define SINGLE\_ARG(...) \_\_VA\_ARGS\_\_#define CASE(TYPE, STMTS) \ case DataTypeToEnum<TYPE>::value: { \ typedef TF\_ATTRIBUTE\_UNUSED TYPE T; \ STMTS; \ break; \ }#define CASES\_WITH\_DEFAULT(TYPE\_ENUM, STMTS, INVALID, DEFAULT) \ switch (TYPE\_ENUM) { \ CASE(float, SINGLE\_ARG(STMTS)) \ CASE(double, SINGLE\_ARG(STMTS)) \ CASE(int32, SINGLE\_ARG(STMTS)) \ CASE(uint8, SINGLE\_ARG(STMTS)) \ CASE(uint16, SINGLE\_ARG(STMTS)) \ CASE(uint32, SINGLE\_ARG(STMTS)) \ CASE(uint64, SINGLE\_ARG(STMTS)) \ CASE(int16, SINGLE\_ARG(STMTS)) \ CASE(int8, SINGLE\_ARG(STMTS)) \ CASE(tstring, SINGLE\_ARG(STMTS)) \ CASE(complex64, SINGLE\_ARG(STMTS)) \ CASE(complex128, SINGLE\_ARG(STMTS)) \ CASE(int64\_t, SINGLE\_ARG(STMTS)) \ CASE(bool, SINGLE\_ARG(STMTS)) \ CASE(qint32, SINGLE\_ARG(STMTS)) \ CASE(quint8, SINGLE\_ARG(STMTS)) \ CASE(qint8, SINGLE\_ARG(STMTS)) \ CASE(quint16, SINGLE\_ARG(STMTS)) \ CASE(qint16, SINGLE\_ARG(STMTS)) \ CASE(bfloat16, SINGLE\_ARG(STMTS)) \ CASE(Eigen::half, SINGLE\_ARG(STMTS)) \ CASE(ResourceHandle, SINGLE\_ARG(STMTS)) \ CASE(Variant, SINGLE\_ARG(STMTS)) \ case DT\_INVALID: \ INVALID; \ break; \ default: \ DEFAULT; \ break; \ }
#define CASES(TYPE\_ENUM, STMTS) \ CASES\_WITH\_DEFAULT(TYPE\_ENUM, STMTS, LOG(FATAL) << "Type not set"; \ , LOG(FATAL) << "Unexpected type: " << TYPE\_ENUM;)
Tensor::Tensor(Allocator\* a, DataType type, const TensorShape& shape) : shape\_(shape), buf\_(nullptr) { set\_dtype(type); CHECK\_NOTNULL(a); if (shape\_.num\_elements() > 0 || a->AllocatesOpaqueHandle()) { CASES(type, buf\_ = new Buffer<T>(a, shape.num\_elements())); } if (MemoryLoggingEnabled() && buf\_ != nullptr && buf\_->data() != nullptr) { LogMemory::RecordTensorAllocation("Unknown", LogMemory::UNKNOWN\_STEP\_ID, \*this); }}
Tensor::Tensor(Allocator\* a, DataType type, const TensorShape& shape, const AllocationAttributes& allocation\_attr) : shape\_(shape), buf\_(nullptr) { set\_dtype(type); CHECK\_NOTNULL(a); if (shape\_.num\_elements() > 0 || a->AllocatesOpaqueHandle()) { CASES(type, buf\_ = new Buffer<T>(a, shape.num\_elements(), allocation\_attr)); } if (MemoryLoggingEnabled() && !allocation\_attr.allocation\_will\_be\_logged && buf\_ != nullptr && buf\_->data() != nullptr) { LogMemory::RecordTensorAllocation("Unknown (with attributes)", LogMemory::UNKNOWN\_STEP\_ID, \*this); }}
Status Tensor::BuildTensor(DataType type, const TensorShape& shape, Tensor\* out\_tensor) { // Avoid crashes due to invalid or unsupported types. CASES\_WITH\_DEFAULT( type, {}, return errors::InvalidArgument("Type not set"), return errors::InvalidArgument("Unexpected type: ", DataType\_Name(type))); \*out\_tensor = Tensor(type, shape); return Status::OK();}
// NOTE(mrry): The default allocator for a Tensor (when none is specified) is// the default CPU allocator for NUMA zone 0. Accessing that currently involves// acquiring a lock, which guards initialization of the per-NUMA zone// allocators, and becomes highly contended.//// Note also that it would be better if all Tensor allocations required the user// to specify an allocator, for purposes of accounting, etc. However, the// default allocator is widely used throughout the codebase and in client code.static Allocator\* get\_default\_cpu\_allocator() { static Allocator\* default\_cpu\_allocator = cpu\_allocator(port::kNUMANoAffinity); return default\_cpu\_allocator;}
Tensor::Tensor(DataType type, const TensorShape& shape) : Tensor(get\_default\_cpu\_allocator(), type, shape) {}
bool Tensor::HostScalarTensorBufferBase::GetAllocatedBytes( size\_t\* out\_bytes) const { // `this->FillAllocationDescription()` never sets allocated bytes information, // so we can short-circuit the construction of an `AllocationDescription`. return false;}
void Tensor::HostScalarTensorBufferBase::FillAllocationDescription( AllocationDescription\* proto) const { proto->set\_requested\_bytes(size()); proto->set\_allocator\_name("HostScalarTensorBuffer"); proto->set\_ptr(reinterpret\_cast<uintptr\_t>(data()));}
template <typename T>class SubBuffer : public TensorBuffer { public: // This buffer is an alias to buf[delta, delta + n). SubBuffer(TensorBuffer\* buf, int64\_t delta, int64\_t n) : TensorBuffer(buf->base<T>() + delta), root\_(buf->root\_buffer()), elem\_(n) { // Sanity check. The caller should ensure the sub buffer is valid. CHECK\_LE(root\_->base<T>(), this->base<T>()); T\* root\_limit = root\_->base<T>() + root\_->size() / sizeof(T); CHECK\_LE(this->base<T>(), root\_limit); CHECK\_LE(this->base<T>() + n, root\_limit); // Hold a ref of the underlying root buffer. // NOTE: 'buf' is a sub-buffer inside the 'root\_' buffer. root\_->Ref(); }
 size\_t size() const override { return sizeof(T) \* elem\_; } TensorBuffer\* root\_buffer() override { return root\_; } bool GetAllocatedBytes(size\_t\* out\_bytes) const override { return root\_->GetAllocatedBytes(out\_bytes); } void FillAllocationDescription(AllocationDescription\* proto) const override { root\_->FillAllocationDescription(proto); }
 private: TensorBuffer\* root\_; int64\_t elem\_;
 ~SubBuffer() override { root\_->Unref(); }
 TF\_DISALLOW\_COPY\_AND\_ASSIGN(SubBuffer);};
Tensor Tensor::Slice(int64\_t start, int64\_t limit) const { CHECK\_GE(dims(), 1); CHECK\_LE(0, start); CHECK\_LE(start, limit); int64\_t dim0\_size = shape\_.dim\_size(0); CHECK\_LE(limit, dim0\_size); if ((start == 0) && (limit == dim0\_size)) { return \*this; } Tensor ret; ret.shape\_ = shape\_; ret.set\_dtype(dtype()); ret.buf\_ = nullptr; if (dim0\_size > 0) { const int64\_t elems\_per\_dim0 = NumElements() / dim0\_size; const int64\_t delta = start \* elems\_per\_dim0; dim0\_size = limit - start; ret.shape\_.set\_dim(0, dim0\_size); const int64\_t num\_elems = dim0\_size \* elems\_per\_dim0; if (buf\_) { DataType dt = dtype(); CASES(dt, ret.buf\_ = new SubBuffer<T>(buf\_, delta, num\_elems)); } } return ret;}
Tensor Tensor::SubSlice(int64\_t index) const { CHECK\_GE(dims(), 1); // Crash ok. CHECK\_LE(0, index); // Crash ok. int64\_t dim0\_size = shape\_.dim\_size(0); CHECK\_LE(index, dim0\_size); // Crash ok. Tensor ret; ret.shape\_ = shape\_; ret.shape\_.RemoveDim(0); ret.set\_dtype(dtype()); ret.buf\_ = nullptr; if (dim0\_size > 0) { const int64\_t elems\_per\_dim0 = NumElements() / dim0\_size; const int64\_t delta = index \* elems\_per\_dim0; const int64\_t num\_elems = elems\_per\_dim0; if (buf\_) { DataType dt = dtype(); CASES(dt, ret.buf\_ = new SubBuffer<T>(buf\_, delta, num\_elems)); } } return ret;}
bool Tensor::FromProto(const TensorProto& proto) { return FromProto(get\_default\_cpu\_allocator(), proto);}
bool Tensor::FromProto(Allocator\* a, const TensorProto& proto) { CHECK\_NOTNULL(a); TensorBuffer\* p = nullptr; if (!TensorShape::IsValid(proto.tensor\_shape())) return false; if (proto.dtype() == DT\_INVALID) return false; TensorShape shape(proto.tensor\_shape()); const int64\_t N = shape.num\_elements(); if (N > 0 && proto.dtype()) { bool dtype\_error = false; if (!proto.tensor\_content().empty()) { const auto& content = proto.tensor\_content(); CASES\_WITH\_DEFAULT(proto.dtype(), p = Helper<T>::Decode(a, content, N), dtype\_error = true, dtype\_error = true); } else { CASES\_WITH\_DEFAULT(proto.dtype(), p = FromProtoField<T>(a, proto, N), dtype\_error = true, dtype\_error = true); } if (dtype\_error || p == nullptr) return false; } shape\_ = shape; set\_dtype(proto.dtype()); UnrefIfNonNull(buf\_); buf\_ = p; // TODO(misard) add tracking of which kernels and steps are calling // FromProto. if (MemoryLoggingEnabled() && buf\_ != nullptr && buf\_->data() != nullptr) { LogMemory::RecordTensorAllocation("Unknown (from Proto)", LogMemory::UNKNOWN\_STEP\_ID, \*this); } return true;}
void Tensor::AsProtoField(TensorProto\* proto) const { proto->Clear(); shape\_.AsProto(proto->mutable\_tensor\_shape()); proto->set\_dtype(dtype()); if (buf\_) { CASES(dtype(), ToProtoField<T>(\*buf\_, shape\_.num\_elements(), proto)); }}
void Tensor::AsProtoTensorContent(TensorProto\* proto) const { proto->Clear(); proto->set\_dtype(dtype()); shape\_.AsProto(proto->mutable\_tensor\_shape()); if (buf\_) { CASES(dtype(), Helper<T>::Encode(buf\_, shape\_.num\_elements(), proto->mutable\_tensor\_content())); }}
size\_t Tensor::TotalBytes() const { if (shape\_.num\_elements() == 0) return 0; CHECK(buf\_) << "null buf\_ with non-zero shape size " << shape\_.num\_elements(); CASES(dtype(), return Helper<T>::TotalBytes(buf\_, shape\_.num\_elements())); return 0; // Makes compiler happy.}
size\_t Tensor::AllocatedBytes() const { if (buf\_) { size\_t ret; if (buf\_->GetAllocatedBytes(&ret)) { return ret; } } return TotalBytes();}
bool Tensor::CanUseDMA() const { CASES(dtype(), return is\_simple\_type<T>::value); return false; // Makes compiler happy.}
[View remainder of file in raw view](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/framework/tensor.cc)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_f4b7ee99_20250114_215121.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fgrappler%2Foptimizers%2Fconstant_folding.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fgrappler%2Foptimizers%2Fconstant_folding.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


