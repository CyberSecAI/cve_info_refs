=== Content from seclists.org_ca4b7ec3_20250115_083641.html ===

[![](/shared/images/nst-icons.svg#menu)](#menu)
![](/shared/images/nst-icons.svg#close)
[![Home page logo](/images/sitelogo.png)](/)
[Nmap.org](https://nmap.org/)
[Npcap.com](https://npcap.com/)
[Seclists.org](https://seclists.org/)
[Sectools.org](https://sectools.org)
[Insecure.org](https://insecure.org/)

![](/shared/images/nst-icons.svg#search)

[![oss-sec logo](/images/oss-sec-logo.png)](/oss-sec/)
## [oss-sec](/oss-sec/) mailing list archives

[![Previous](/images/left-icon-16x16.png)](100)
[By Date](date.html#101)
[![Next](/images/right-icon-16x16.png)](102)

[![Previous](/images/left-icon-16x16.png)](99)
[By Thread](index.html#101)
[![Next](/images/right-icon-16x16.png)](102)

![](/shared/images/nst-icons.svg#search)

# keylime: Multiple Security Issues (including remote code execution in the Agent component)

---

*From*: Matthias Gerstner <mgerstner () suse de>

*Date*: Fri, 28 Jan 2022 13:57:23 +0100

---

```
Hello list,

I have been reviewing the Keylime TPM remote attestation solution [1]
which resulted in a number of security related findings, including an
arbitrary remote code execution in the Keylime Agent component. The
upstream project published security advisories, fixes and an update
strategy to Keylime version 6.3.X today. Please find the details in the
following full report:

1) Scope of Review
==================

I've been looking into the four main components of Keylime: the Agent,
Registrar, Verifier and Tenant applications. I have been looking into
version 6.2.0. Any source code locations mentioned in this report relate
to this version.

2) Findings in the Agent Component
==================================

a) `check_mounted()` Function Logic can be Fooled by Unprivileged Mounts (CVE-2022-23948)
-----------------------------------------------------------------------------------------

The `check_mounted()` function in `secure_mount.py` attempts to make
sure that a "secure" tmpfs is mounted at `/var/lib/keylime/secure` to
store sensitive data on that never gets written to disk. To do so the
function parses the output of the `mount` utility to determine whether
this file system is already mounted at the desired location.

There can exist the possibility of unprivileged users performing certain
mount operations, one of the most prominent examples being the
`fusermount` setuid-root binary for mounting FUSE file systems. In view
of this, parsing mount table output needs prudence. I described the
basic issue previously already in another report [2].

The following is a reproducer using `fusermount` that shows the basic local
attack vector:

    user$ export _FUSE_COMMFD=0
    user$ fusermount some/path/ -ononempty,fsname="tmpfs on /var/lib/keylime/secure"

This will fool the parsing logic in `check_mounted()` and thus the
function assumes that the "secure" tmpfs is already mounted, while it
actually isn't.  Thus this will allow a local attacker on the system to
prevent this security feature to be effective, *if* the local attacker
manages to create such a mount entry before the `keylime_agent` is
starting up.

The attack vector can also be used to perform a local DoS against
`keylime_agent` by claiming a different `fsname` than tmpfs.
`check_mounted()` will throw an Exception in this case and the Agent
won't start.

On a side note there are calls to `secure_mount.mount()` spread
throughout the Keylime codebase (for example three times in
`keylime_agent.py`, two times in `tpm_main.py` and two times in
`ca_impl_cfssl.py`. There is no code to *clean up* this mount again,
however. So it potentially leaves behind a stale mount after services
are shutdown. Furthermore, if multiple Keylime processes should operate
in parallel this could result in a race condition where the "secure"
tmpfs is mounted twice, in the worst case mounting a fresh tmpfs over
previously stored content there.

My recommendation is to parse the `/proc/self/mountinfo` pseudo file for
mount table information instead. Whitespace is specially encoded in this
file. Furthermore the responsibility of mounting and unmounting this
file system should be more clearly defined during startup/shutdown of
processes and maybe a reference counting / locking scheme to prevent
race conditions should be used.

### Upstream Security Advisory

<https://github.com/keylime/keylime/security/advisories/GHSA-wj36-qcfg-5j52>

### Upstream Fixes

<https://github.com/keylime/keylime/commit/1a4f31a6368d651222683c9debe7d6832db6f607>
<https://github.com/keylime/keylime/commit/d37c406e69cb6689baa2fb7964bad75209703724>

b) Possible Information Leaks via Unauthenticated Agent Quote Interface
-----------------------------------------------------------------------

A TPM quote can be requested without authentication from the Agent service via
the network:

    $ curl "keyagent-host:9002/?api_version=500&quotes=myquote&nonce=mynonce"
    {
        "code": 200,
        "status": "Success",
        "results": {
            "quote": <base64-data>, "hash_alg": "sha256", "enc_alg": "rsa", "sign_alg": "rsassa",
            "pubkey": <PEM key>", "boottime": 1639999864
        }
    }

This exposes for example the *boottime* of the host where the Agent is
running, information that is not otherwise easily publicly available.
Furthermore: Could the contents of the TPM quote data also be
interesting data? Could it for example allow deductions about which kind
of operating system kernel is running on the host?

I recommend to somehow authenticate and cryptographically secure this
Agent interface to prevent information leaks of this kind.

### Upstream Fixes

This issue did not receive a dedicated CVE and fix. It is covered
together with the following issue 2.c).

c) Arbitrary Remote Code Execution in the Agent via Unauthenticated Bootstrap Interface (CVE-2021-43310)
--------------------------------------------------------------------------------------------------------

Note that this issue has been discovered in parallel also by Thore
Sommer, a Keylime upstream developer.

It looks like it is possible to simply post arbitrary new values for the
U and V key parts and provide a new configuration payload to the Agent,
only knowing the Agent's UUID. The Agent's UUID can be public or
semi-public information like when `agent_uuid=hostname` is configured.
From the Keylime paper [3] (section 3.2.2) it sounds like the UUID HMAC
check is not considered a security feature but only a sanity check:

```
> ```
> This provides the node with a quick check to determine if Kb is correct.
>
> ```

```

When `extract_payload_script=true` (default) and
`payload_script=autorun.sh` (default) are configured in `keylime.conf`
then the provided payload will be unzipped and a potentially contained
`autorun.sh` script is executed with full root privileges. Attached you
can find a reproducer script `post_key.py` that demonstrates the issue
by creating a file `/tmp/evil` on the Agent host by only providing the
Agent hostname and UUID as input parameters.

Even if `payload_script` is disabled then the extraction of a ZIP file
as _root_ might result in a remote root exploit by extracting files
outside of the intended target directory. I did not test this variant of
the attack vector, though. Furthermore by providing a ZIP bomb as
payload the Agent process can be subjected to a remote DoS through
memory exhaustion.

Retrieving the full symmetric key previously stored in
`/var/lib/keylime/secure/derived_tci_key` should not be possible this
way, because when performing the bootstrap protocol, the previous data
is removed in `keylime_agent.py:242`. A skillful attacker might attempt
to first compromise the Agent node and then wait for the Tenant to
re-deploy the Agent using authentic keys and payload. Should this
succeed then the attacker can obtain the secret symmetric key from the
compromised Agent node after all.

Similar to issue b) I recommend to somehow authenticate and
cryptographically secure this Agent interface to prevent these attacks.
As a hotfix disabling the relevant configuration features should at
least prevent the remote code execution and memory exhaustion attack
vectors. Setting non-predictable UUID values can also help (but one
should also consider item 3.a in this context).  Even then this
interface still allows to disrupt the operational state of the Agent
host by simply overwriting its current configuration.

### Upstream Security Advisory

<https://github.com/keylime/keylime/security/advisories/GHSA-2m39-75g9-ff5r>

### Upstream Fixes

The fix consists of a larger number of upstream commits regarding
introduction of "mTLS" for the Agent interface. This means the
connection towards the Agent will in the future be cryptographically
secured and thus only trusted actors can use the Agent interface.

The upgrade path is a bit complicated because of this (see upstream
advisory).  Upstream version 6.3.X will introduce the new mTLS support
but not enforce it, to allow upgrading of all Keylime components on all
nodes. Only upstream version 6.4.x will enforce the new protocol.

d) Key Exchange and Bootstrap Protocol Susceptible to Replay Attacks
--------------------------------------------------------------------

Authentic payloads being passed from the Tenant to the Agent should be
reasonably safe from attackers (when not considering issue c)), since
the two halves of the symmetric key are encrypted using the per-agent
node RSA public key. The bootstrap protocol seems to be susceptible to
certain replay attacks, however. Since the interface does not employ
transport security, the bootstrap protocol can simply be recorded and
replayed to activate an authentic configuration payload. This could e.g.
be used by an attacker to activate an outdated or even insecure older
configuration of the Agent node.

### Upstream Fixes

This issue did not receive a dedicated CVE and fix. It is covered
together with the previous issue 2.c).

3) Findings in the Registrar Component
======================================

a) UUID of Agents is Received on Unprotected HTTP Interface
-----------------------------------------------------------

The Registrar provides two separate HTTP interfaces, a TLS protected one
and an unprotected one. Part of the unprotected interface is the Agent
registration.  As part of the Agent registration the Agent UUID is
passed unencrypted (processed in `registrar_common.py:229`).

This is not a security issue in its own but relates to issue 2.c where
the knowledge of the UUID facilitates remote code execution on the Agent
nodes.  This means if an attacker can listen in on the Registrar's Agent
registration communication then even unpredictable Agent UUIDs no longer
hinder the attack described in issue 2.c).

As outlined in 2.c) the UUID does not seem to have been thought of as a
security property in the first place so I see no urge to change anything
here. Although when the bootstrap protocol should get TLS protection
then for completeness it could also make sense to protect this Registrar
interface as well the same way.

### Upstream Fixes

This specific aspect is covered by the following commit:

<https://github.com/keylime/keylime/commit/e5f033c66403a899685b81a3af03cd59f76e455f>

There is no dedicated CVE but it is covered together with the
overarching introduction of mTLS as outlined in issue 2.c).

b) Unsanitized UUID passed on Unprotected HTTP Interface Facilitates Log Spoofing (CVE-2022-23949)
--------------------------------------------------------------------------------------------------

Since the Registrar's unprotected HTTP interface requires no
authentication, anybody can post arbitrary Agent registrations with
arbitrary parameters. The Agent ID (UUID) parameter is not sanitized in
any way and is used unfiltered in log messages (e.g.
`registrar_common.py:107`).

As a result the Agent ID parameter can be used to inject seemingly valid
additional log lines that appear e.g. in `journalctl -u
keylime_registrar.service`. The attached reproducer script
`post_agent.py` can be used to demonstrate this:

    $ ./post_agent.py --host registrar-host --log-line "Please run rm -rf /* to protect your system"

In the journal we will then see:

    Dec 21 11:44:22 registrar-host keylime_registrar[1426]: 2021-12-21 11:44:22.281 - keylime.registrar - WARNING -
POST for trusted-agent
    Dec 21 11:44:22 registrar-host keylime_registrar[1426]: 2021-12-21 11:44:22.931 - keylime.registrar - WARNING -
Please run rm -rf /* to protect your system
    Dec 21 11:44:22 registrar-host keylime_registrar[1426]: 2021-12-21 11:44:22.940 - keylime.registrar - DEBUG -
returning 400 response. [...]

Such log spoofing could be used to entice Administrators to perform
actions that can be harmful or otherwise in the interest of an attacker.

My recommendation is on the one hand to diligently sanitize untrusted
input parameters. On the other hand it might make sense to authenticate
this currently untrusted interface.

### Upstream Advisory

<https://github.com/keylime/keylime/security/advisories/GHSA-87gh-qc28-j9mm>

### Upstream Fixes

The UUID sanitazion is introduced via these commits:

<https://github.com/keylime/keylime/commit/387e320dc22c89f4f47c68cb37eb9eec2137f34b>
<https://github.com/keylime/keylime/commit/e429e95329fc60608713ddfb82f4a92ee3b3d2d9>
<https://github.com/keylime/keylime/commit/65c2b737129b5837f4a03660aeb1191ced275a57>

Otherwise the introduction of mTLS as outlined in issues 3.a) and 2.c)
further protect this.

4) Findings in the Verifier Component
=====================================

a) Revocation Notifier Uses Fixed /tmp Path for UNIX Domain Socket (CVE-2022-23950)
-----------------------------------------------------------------------------------

In *revocation_notifier.py* a fixed path in the world writable location
*/tmp/keylime.verifier.ipc* is used. The code (in this case the third
party `zeromq` Python module) forcefully removes any file object found
there earlier.  Should the program be running as non-root, or if another
local user simply places a *directory* at this location, then this
serves as a local DoS attack against the revocation notifier process,
because the socket cannot be created.

This situation doesn't even seem to be noticed by the Verifier main
process, because the child process `broker_proc` is never waited on.
This means that the local attacker could even replace the "blocking"
directory by his own UNIX domain socket later on and will then receive
revocation events from invocations of the `notify()` function in the
main Verifier process.  The full impact of this would have to be
researched further. It looks like failed quote notifications would
longer be sent out.

I recommend to place UNIX domains sockets in a dedicated safe directory
in /run that cannot be staged with attacks by other local users in the
system.

### Upstream Advisory

<https://github.com/keylime/keylime/security/advisories/GHSA-9r9r-f8xc-m875>

### Upstream Fixes

This fix places the socket into a private /run/keylime directory:

<https://github.com/keylime/keylime/commit/ea5d0373fa2c050d5d95404eb779be7e8327b911>

b) Get Quote Response Contains Possibly Untrusted ZIP Data (CVE-2022-23951)
---------------------------------------------------------------------------

The Verifier process periodically performs quote operations on
registered Agents. As part of this `process_quote_response()` is called
and furthermore `check_quote()` and finally `_tpm2_checkquote()`. In
`tpm_main.py:1018` a couple of ZIP data streams are uncompressed via
`zlib.decompress()`.

Since this is processing possibly untrusted data - the Verifier is
attempting to verify the current trust status of the node after all - it
needs to be assumed that malicous data can also be supplied here.

Therefore the question arises whether `zlib.decompress()` is robust
against processing invalid ZIP data streams. One thing I already found
out is that it is not robust against delivering ZIP bombs that will
cause a memory exhaustion in the Verifier process.

This finding also is valid similarly for all other Keylime interface
that process ZIP data, like in the Agent.

### Upstream Advisory

<https://github.com/keylime/keylime/security/advisories/GHSA-6xx7-m45w-76m2>

### Upstream Fixes

This fix simply removes the ZIP compression from the Verifier interface:

<https://github.com/keylime/keylime/commit/6e44758b64b0ee13564fc46e807f4ba98091c355>

5) General Findings
===================

This section contains findings that apply to all keylime components
alike.

a) World-Readable keylime.conf Contains Potentially Sensitive Data (CVE-2022-23952)
-----------------------------------------------------------------------------------

The configuration `/etc/keylime.conf` is installed world-readable:

    $ ls -l /etc/keylime.conf
    -rw-r--r-- 1 root root 26770 Dec 16 14:54 /etc/keylime.conf

This is the case for installations performed manually via the provided
`installer.sh` script as well as for the RPM packaging found in both
openSUSE Tumbleweed and Fedora 35 Linux distributions. Further
distributions might be affected.

`keylime.conf` contains a lot of information, some of it sensitive like
the TPM ownership password (`tpm_ownerpassword`), TLS certificate
private key passwords (`private_key_pw`, `registrar_private_key_pw`) or
the database password for the Registrar (`database_password`). Thus this
is a local information leak, because arbitrary local users can obtain
these passwords from the configuration file.

My recommendation is to make this file only accessible to _root_ and
adjust all installation routines and possibly documentation. The Keylime
code could perform a sanity check of the permissions of the
configuration file before reading it in.

### Upstream Advisory

<https://github.com/keylime/keylime/security/advisories/GHSA-fchm-5w2v-qfm8>

### Upstream Fixes

The following fix explicitly sets the permissions for the configuration
file in the installer:

<https://github.com/keylime/keylime/commit/883085d6a4bcea3012729014d5b8e15ecd65fc7c>

b) Lack of Privilege Separation
-------------------------------

All keylime services are currently designed to run as root all the time
(except for testing purposes, see `REQUIRE_ROOT` in `config.py`). Only
few bits of the keylime components actually should need root privileges.
Most notably the bootstrapping scripts in the Agent component or the
ability to bind privileged ports.

Implementing a privilege separation approach would increase the defense
in depth for keylime considerably, avoiding smaller security issues to
become severe fast.

### Upstream Statement

Keylime upstream states that it is already possible to run Keylime as
non-root. The `REQUIRE_ROOT` bits are not strictly necessary any more
and can be removed from the code. The Debian packaging already makes use
of the privilege separation.

6) Timeline
===========

2021-12-09: I started the review on the code
2021-12-23: I contacted the upstream security contact and upstream
            developer Thore Sommer privately by email and provided them
            the report results, offering coordinates disclosure.
2022-01-04: Upstream confirmed most of my findings and work on the fixes
            began. Alberto Planas, a SUSE colleague and maintainer of
            the SUSE Keylime packaging also contributed some fixes.
2022-01-28: Publication of the security advisories and fixes by upstream
            took place. Upstream also discovered some further security
            issues themselves in the meanwhile.

[1]: <https://github.com/keylime/keylime>
[2]: <https://www.openwall.com/lists/oss-security/2020/06/04/5>
[3]: <https://www.ll.mit.edu/sites/default/files/publication/doc/2018-04/2016_12_07_SchearN_ACSAC_FP.pdf>

Cheers

Matthias

--
Matthias Gerstner <matthias.gerstner () suse de>
Security Engineer
<https://www.suse.com/security>
GPG Key ID: 0x14C405C971923553

SUSE Software Solutions Germany GmbH
HRB 36809, AG Nürnberg
Geschäftsführer: Ivo Totev

```

**Attachment:
[post\_agent.py](att-101/post_agent_py.bin)**

*Description:*

**Attachment:
[post\_key.py](att-101/post_key_py.bin)**

*Description:*

**Attachment:
[signature.asc](att-101/signature_asc.bin)**

*Description:*

---

[![Previous](/images/left-icon-16x16.png)](100)
[By Date](date.html#101)
[![Next](/images/right-icon-16x16.png)](102)

[![Previous](/images/left-icon-16x16.png)](99)
[By Thread](index.html#101)
[![Next](/images/right-icon-16x16.png)](102)

### Current thread:

* **keylime: Multiple Security Issues (including remote code execution in the Agent component)** *Matthias Gerstner (Jan 28)*

![](/shared/images/nst-icons.svg#search)

## [Nmap Security Scanner](https://nmap.org/)

* [Ref Guide](https://nmap.org/book/man.html)* [Install Guide](https://nmap.org/book/install.html)* [Docs](https://nmap.org/docs.html)* [Download](https://nmap.org/download.html)* [Nmap OEM](https://nmap.org/oem/)

## [Npcap packet capture](https://npcap.com/)

* [User's Guide](https://npcap.com/guide/)* [API docs](https://npcap.com/guide/npcap-devguide.html#npcap-api)* [Download](https://npcap.com/#download)* [Npcap OEM](https://npcap.com/oem/)

## [Security Lists](https://seclists.org/)

* [Nmap Announce](https://seclists.org/nmap-announce/)* [Nmap Dev](https://seclists.org/nmap-dev/)* [Full Disclosure](https://seclists.org/fulldisclosure/)* [Open Source Security](https://seclists.org/oss-sec/)* [BreachExchange](https://seclists.org/dataloss/)

## [Security Tools](https://sectools.org)

* [Vuln scanners](https://sectools.org/tag/vuln-scanners/)* [Password audit](https://sectools.org/tag/pass-audit/)* [Web scanners](https://sectools.org/tag/web-scanners/)* [Wireless](https://sectools.org/tag/wireless/)* [Exploitation](https://sectools.org/tag/sploits/)

## [About](https://insecure.org/)

* [About/Contact](https://insecure.org/fyodor/)* [Privacy](https://insecure.org/privacy.html)* [Advertising](https://insecure.org/advertising.html)* [Nmap Public Source License](https://nmap.org/npsl/)

[![](/shared/images/nst-icons.svg#twitter)](https://twitter.com/nmap "Visit us on Twitter")
[![](/shared/images/nst-icons.svg#facebook)](https://facebook.com/nmap "Visit us on Facebook")
[![](/shared/images/nst-icons.svg#github)](https://github.com/nmap/ "Visit us on Github")
[![](/shared/images/nst-icons.svg#reddit)](https://reddit.com/r/nmap/ "Discuss Nmap on Reddit")



=== Content from github.com_2774252a_20250115_083634.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fcommit%2F1a4f31a6368d651222683c9debe7d6832db6f607)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fcommit%2F1a4f31a6368d651222683c9debe7d6832db6f607)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=keylime%2Fkeylime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keylime](/keylime)
/
**[keylime](/keylime/keylime)**
Public

* [Notifications](/login?return_to=%2Fkeylime%2Fkeylime) You must be signed in to change notification settings
* [Fork
  153](/login?return_to=%2Fkeylime%2Fkeylime)
* [Star
   438](/login?return_to=%2Fkeylime%2Fkeylime)

* [Code](/keylime/keylime)
* [Issues
  27](/keylime/keylime/issues)
* [Pull requests
  7](/keylime/keylime/pulls)
* [Discussions](/keylime/keylime/discussions)
* [Actions](/keylime/keylime/actions)
* [Projects
  0](/keylime/keylime/projects)
* [Wiki](/keylime/keylime/wiki)
* [Security](/keylime/keylime/security)
* [Insights](/keylime/keylime/pulse)

Additional navigation options

* [Code](/keylime/keylime)
* [Issues](/keylime/keylime/issues)
* [Pull requests](/keylime/keylime/pulls)
* [Discussions](/keylime/keylime/discussions)
* [Actions](/keylime/keylime/actions)
* [Projects](/keylime/keylime/projects)
* [Wiki](/keylime/keylime/wiki)
* [Security](/keylime/keylime/security)
* [Insights](/keylime/keylime/pulse)

## Commit

[Permalink](/keylime/keylime/commit/1a4f31a6368d651222683c9debe7d6832db6f607)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

secure\_mount: use /proc/self/mountinfo

[Browse files](/keylime/keylime/tree/1a4f31a6368d651222683c9debe7d6832db6f607)
Browse the repository at this point in the history

```
The function `check_mounted()` is parsing the output of the `mount`
command.  This command can have an unknown number of spaces, that can
break the parsing logic (and produces security issues)

This commit take the mount information data from `/proc/self/mountinfo`,
that is more friendly parsed as it will escape the spaces.

Signed-off-by: Alberto Planas <aplanas@suse.com>
```

* Loading branch information

[![@aplanas](https://avatars.githubusercontent.com/u/645701?s=40&v=4)](/aplanas) [![@mpeters](https://avatars.githubusercontent.com/u/23815?s=40&v=4)](/mpeters)

[aplanas](/keylime/keylime/commits?author=aplanas "View all commits by aplanas")
authored and
[mpeters](/keylime/keylime/commits?author=mpeters "View all commits by mpeters")
committed
Jan 27, 2022

1 parent
[387e320](/keylime/keylime/commit/387e320dc22c89f4f47c68cb37eb9eec2137f34b)

commit 1a4f31a

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**117 additions**
and
**20 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* keylime

  + keylime/secure\_mount.py
    [secure\_mount.py](#diff-32746143819af231311e3146b2db21198df9c69691120418dd0836b8f192b132)
* test

  + test/test\_secure\_mount.py
    [test\_secure\_mount.py](#diff-a8f92ee278b225647bfe0536f8a4c86011c4b8645f0db5b03fbffc3d42ef4fe2)

## There are no files selected for viewing

56 changes: 36 additions & 20 deletions

56
[keylime/secure\_mount.py](#diff-32746143819af231311e3146b2db21198df9c69691120418dd0836b8f192b132 "keylime/secure_mount.py")

Show comments

[View file](/keylime/keylime/blob/1a4f31a6368d651222683c9debe7d6832db6f607/keylime/secure_mount.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,29 +13,45 @@ |
|  |  |  |
|  |  |  |
|  |  | def check\_mounted(secdir): |
|  |  | whatsmounted = cmd\_exec.run("mount")['retout'] |
|  |  | whatsmounted\_converted = config.convert(whatsmounted) |
|  |  | for line in whatsmounted\_converted: |
|  |  | tokens = line.split() |
|  |  | tmpfs = False |
|  |  | if len(tokens) < 3: |
|  |  | continue |
|  |  | if tokens[0] == 'tmpfs': |
|  |  | tmpfs = True |
|  |  | if tokens[2] == secdir: |
|  |  | if not tmpfs: |
|  |  | logger.error("secure storage location %s already mounted " |
|  |  | "on wrong file system type: %s. Unmount to" |
|  |  | "continue.", secdir, tokens[0]) |
|  |  | raise Exception( |
|  |  | f"secure storage location {secdir} already mounted on " |
|  |  | f"wrong file system type: {tokens[0]}. Unmount to " |
|  |  | f"continue.") |
|  |  | """Inspect mountinfo to detect if a directory is mounted.""" |
|  |  | secdir\_escaped = secdir.replace(" ", r"\040") |
|  |  | for line in open("/proc/self/mountinfo", "r"): |
|  |  | # /proc/[pid]/mountinfo have 10+ elements separated with |
|  |  | # spaces (check proc (5) for a complete description) |
|  |  | # |
|  |  | # At position 7 there are some optional fields, so we need |
|  |  | # first to determine the separator mark, and validate the |
|  |  | # final total number of fields. |
|  |  | elements = line.split() |
|  |  | try: |
|  |  | separator = elements.index("-") |
|  |  | except ValueError: |
|  |  | msg = "Separator filed not found. " \ |
|  |  | "Information line cannot be parsed" |
|  |  | logger.error(msg) |
|  |  | raise Exception(msg) |
|  |  |  |
|  |  | if len(elements) < 10 or len(elements) - separator < 4: |
|  |  | msg = "Mount information line cannot be parsed" |
|  |  | logger.error(msg) |
|  |  | raise Exception(msg) |
|  |  |  |
|  |  | mount\_point = elements[4] |
|  |  | filesystem\_type = elements[separator + 1] |
|  |  | if mount\_point == secdir\_escaped: |
|  |  | if filesystem\_type != "tmpfs": |
|  |  | msg = f"Secure storage location {secdir} already mounted " \ |
|  |  | f"on wrong file system type: {filesystem\_type}. " \ |
|  |  | "Unmount to continue." |
|  |  | logger.error(msg) |
|  |  | raise Exception(msg) |
|  |  |  |
|  |  | logger.debug( |
|  |  | "secure storage location %s already mounted on tmpfs" % secdir) |
|  |  | "Secure storage location %s already mounted on tmpfs", secdir |
|  |  | ) |
|  |  | return True |
|  |  | logger.debug("secure storage location %s not mounted " % secdir) |
|  |  |  |
|  |  | logger.debug("Secure storage location %s not mounted", secdir) |
|  |  | return False |
|  |  |  |
|  |  |  |
| Expand Down | |  |

81 changes: 81 additions & 0 deletions

81
[test/test\_secure\_mount.py](#diff-a8f92ee278b225647bfe0536f8a4c86011c4b8645f0db5b03fbffc3d42ef4fe2 "test/test_secure_mount.py")

Show comments

[View file](/keylime/keylime/blob/1a4f31a6368d651222683c9debe7d6832db6f607/test/test_secure_mount.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,81 @@ |
|  |  | import unittest |
|  |  | from unittest.mock import patch |
|  |  |  |
|  |  | from keylime import secure\_mount |
|  |  |  |
|  |  |  |
|  |  | class TestSecureMount(unittest.TestCase): |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_not\_found(self, open\_mock, logger\_mock): |
|  |  | """Test when secdir is not mounted.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | ) |
|  |  | self.assertFalse(secure\_mount.check\_mounted("/secdir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found(self, open\_mock, logger\_mock): |
|  |  | """Test when secdir is mounted.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | "303 154 0:69 / /secdir rw,relatime shared:130 - tmpfs tmpfs rw,size=1024k,mode=700,inode64", |
|  |  | ) |
|  |  | self.assertTrue(secure\_mount.check\_mounted("/secdir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_zero\_optional\_fields(self, open\_mock, logger\_mock): |
|  |  | """Test when secdir is mounted when there are no optional fields.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | "303 154 0:69 / /secdir rw,relatime - tmpfs tmpfs rw,size=1024k,mode=700,inode64", |
|  |  | ) |
|  |  | self.assertTrue(secure\_mount.check\_mounted("/secdir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_extra\_optional\_fields(self, open\_mock, logger\_mock): |
|  |  | """Test when secdir is mounted when there are extra optional fields.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | "303 154 0:69 / /secdir rw,relatime shared:130 extra:1 - tmpfs tmpfs rw,size=1024k,mode=700,inode64", |
|  |  | ) |
|  |  | self.assertTrue(secure\_mount.check\_mounted("/secdir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_wrong\_fs(self, open\_mock, logger\_mock): |
|  |  | """Test when secdir is mounted but under a wrong fs.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | "303 154 0:69 / /secdir rw,relatime shared:130 - btrfs /dev/sda2 rw", |
|  |  | ) |
|  |  | with self.assertRaises(Exception) as e: |
|  |  | secure\_mount.check\_mounted("/secdir") |
|  |  | self.assertTrue("wrong file system" in str(e.exception)) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_spaces(self, open\_mock, logger\_mock): |
|  |  | """Test when secdir is mounted and contains spaces.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | r"303 154 0:69 / /sec\040dir rw,relatime shared:130 - tmpfs tmpfs rw,size=1024k,mode=700,inode64", |
|  |  | ) |
|  |  | self.assertTrue(secure\_mount.check\_mounted("/sec dir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_wrong\_format(self, open\_mock, logger\_mock): |
|  |  | """Test when the mount info lines are wrong.""" |
|  |  | open\_mock.return\_value = ("invalid line",) |
|  |  | with self.assertRaises(Exception) as e: |
|  |  | secure\_mount.check\_mounted("/secdir") |
|  |  | self.assertTrue("cannot be parsed" in str(e.exception)) |
|  |  |  |
|  |  |  |
|  |  | if \_\_name\_\_ == "\_\_main\_\_": |
|  |  | unittest.main() |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1a4f31a`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fcommit%2F1a4f31a6368d651222683c9debe7d6832db6f607) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_00351f57_20250115_083639.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fsecurity%2Fadvisories%2FGHSA-wj36-qcfg-5j52)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fsecurity%2Fadvisories%2FGHSA-wj36-qcfg-5j52)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=keylime%2Fkeylime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keylime](/keylime)
/
**[keylime](/keylime/keylime)**
Public

* [Notifications](/login?return_to=%2Fkeylime%2Fkeylime) You must be signed in to change notification settings
* [Fork
  153](/login?return_to=%2Fkeylime%2Fkeylime)
* [Star
   438](/login?return_to=%2Fkeylime%2Fkeylime)

* [Code](/keylime/keylime)
* [Issues
  27](/keylime/keylime/issues)
* [Pull requests
  7](/keylime/keylime/pulls)
* [Discussions](/keylime/keylime/discussions)
* [Actions](/keylime/keylime/actions)
* [Projects
  0](/keylime/keylime/projects)
* [Wiki](/keylime/keylime/wiki)
* [Security](/keylime/keylime/security)
* [Insights](/keylime/keylime/pulse)

Additional navigation options

* [Code](/keylime/keylime)
* [Issues](/keylime/keylime/issues)
* [Pull requests](/keylime/keylime/pulls)
* [Discussions](/keylime/keylime/discussions)
* [Actions](/keylime/keylime/actions)
* [Projects](/keylime/keylime/projects)
* [Wiki](/keylime/keylime/wiki)
* [Security](/keylime/keylime/security)
* [Insights](/keylime/keylime/pulse)

# Keylime: Secure mount logic can leak sensitive data

High

[mpeters](/mpeters)
published
GHSA-wj36-qcfg-5j52
Jan 27, 2022

## Package

keylime
(Keylime)

## Affected versions

<6.2.0

## Patched versions

6.3.0

## Description

### Impact

The logic in the Keylime agent for checking for a secure mount can be fooled by previously created unprivileged mounts allowing secrets to be leaked to other processes on the host.

### Patches

Users should upgrade to at least 6.3.x.

### Workarounds

None

### Credit

Many thanks to Matthias Gerstner for finding this issue and for Alberto Planas for the fix.

### For more information

If you have any questions or comments about this advisory:

* Email us at security@keylime.groups.io
* Ask on #keylime channel on the CNCF Slack

### Severity

High

### CVE ID

CVE-2022-23948

### Weaknesses

No CWEs

### Credits

* [![@mgerstner](https://avatars.githubusercontent.com/u/24227799?s=40&v=4)](/mgerstner)
  [mgerstner](/mgerstner)
  Analyst
* [![@aplanas](https://avatars.githubusercontent.com/u/645701?s=40&v=4)](/aplanas)
  [aplanas](/aplanas)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_cd2e5ffb_20250115_083637.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fcommit%2Fd37c406e69cb6689baa2fb7964bad75209703724)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fcommit%2Fd37c406e69cb6689baa2fb7964bad75209703724)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=keylime%2Fkeylime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keylime](/keylime)
/
**[keylime](/keylime/keylime)**
Public

* [Notifications](/login?return_to=%2Fkeylime%2Fkeylime) You must be signed in to change notification settings
* [Fork
  153](/login?return_to=%2Fkeylime%2Fkeylime)
* [Star
   438](/login?return_to=%2Fkeylime%2Fkeylime)

* [Code](/keylime/keylime)
* [Issues
  27](/keylime/keylime/issues)
* [Pull requests
  7](/keylime/keylime/pulls)
* [Discussions](/keylime/keylime/discussions)
* [Actions](/keylime/keylime/actions)
* [Projects
  0](/keylime/keylime/projects)
* [Wiki](/keylime/keylime/wiki)
* [Security](/keylime/keylime/security)
* [Insights](/keylime/keylime/pulse)

Additional navigation options

* [Code](/keylime/keylime)
* [Issues](/keylime/keylime/issues)
* [Pull requests](/keylime/keylime/pulls)
* [Discussions](/keylime/keylime/discussions)
* [Actions](/keylime/keylime/actions)
* [Projects](/keylime/keylime/projects)
* [Wiki](/keylime/keylime/wiki)
* [Security](/keylime/keylime/security)
* [Insights](/keylime/keylime/pulse)

## Commit

[Permalink](/keylime/keylime/commit/d37c406e69cb6689baa2fb7964bad75209703724)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

secure\_mount: add umount function

[Browse files](/keylime/keylime/tree/d37c406e69cb6689baa2fb7964bad75209703724)
Browse the repository at this point in the history

```
The `mount` function is called several times in different places in the
code, but it takes care of not mounting the secure directory if is
already present.  The problem is that this is never umounted.

This patch add the `umount` function, and update the `mount` one to
track when a mount point needs to be umounted.

Also adjust the keylime_agent exit point to make sure that the `umount`
function is called at the end.

Signed-off-by: Alberto Planas <aplanas@suse.com>
```

* Loading branch information

[![@aplanas](https://avatars.githubusercontent.com/u/645701?s=40&v=4)](/aplanas) [![@mpeters](https://avatars.githubusercontent.com/u/23815?s=40&v=4)](/mpeters)

[aplanas](/keylime/keylime/commits?author=aplanas "View all commits by aplanas")
authored and
[mpeters](/keylime/keylime/commits?author=mpeters "View all commits by mpeters")
committed
Jan 27, 2022

1 parent
[1a4f31a](/keylime/keylime/commit/1a4f31a6368d651222683c9debe7d6832db6f607)

commit d37c406

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**167 additions**
and
**16 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* keylime

  + keylime/keylime\_agent.py
    [keylime\_agent.py](#diff-d32fead59105bb306a5dd9f541932a905dfebb1819c599c47e4e731d52357e72)
  + keylime/secure\_mount.py
    [secure\_mount.py](#diff-32746143819af231311e3146b2db21198df9c69691120418dd0836b8f192b132)
* test

  + test/test\_secure\_mount.py
    [test\_secure\_mount.py](#diff-a8f92ee278b225647bfe0536f8a4c86011c4b8645f0db5b03fbffc3d42ef4fe2)

## There are no files selected for viewing

6 changes: 4 additions & 2 deletions

6
[keylime/keylime\_agent.py](#diff-d32fead59105bb306a5dd9f541932a905dfebb1819c599c47e4e731d52357e72 "keylime/keylime_agent.py")

Show comments

[View file](/keylime/keylime/blob/d37c406e69cb6689baa2fb7964bad75209703724/keylime/keylime_agent.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -746,9 +746,11 @@ def shutdown\_handler(\*\_): |
|  |  | server.shutdown() |
|  |  | server.server\_close() |
|  |  | serverthread.join() |
|  |  | logger.debug("...HTTP server stopped") |
|  |  | logger.debug("HTTP server stopped...") |
|  |  | revocation\_process.join() |
|  |  | logger.debug("... revocation notifier stopped") |
|  |  | logger.debug("Revocation notifier stopped...") |
|  |  | secure\_mount.umount() |
|  |  | logger.debug("Umounting directories...") |
|  |  | instance\_tpm.flush\_keys() |
|  |  | logger.debug("Flushed keys successfully") |
|  |  | sys.exit(0) |
| Expand Down | |  |

28 changes: 25 additions & 3 deletions

28
[keylime/secure\_mount.py](#diff-32746143819af231311e3146b2db21198df9c69691120418dd0836b8f192b132 "keylime/secure_mount.py")

Show comments

[View file](/keylime/keylime/blob/d37c406e69cb6689baa2fb7964bad75209703724/keylime/secure_mount.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,11 +11,15 @@ |
|  |  |  |
|  |  | logger = keylime\_logging.init\_logging('secure\_mount') |
|  |  |  |
|  |  | # Store the mounted directories done by Keylime, so we can unmount |
|  |  | # them in reverse order |
|  |  | \_MOUNTED = [] |
|  |  |  |
|  |  |  |
|  |  | def check\_mounted(secdir): |
|  |  | """Inspect mountinfo to detect if a directory is mounted.""" |
|  |  | secdir\_escaped = secdir.replace(" ", r"\040") |
|  |  | for line in open("/proc/self/mountinfo", "r"): |
|  |  | for line in open("/proc/self/mountinfo", "r", encoding="utf-8"): |
|  |  | # /proc/[pid]/mountinfo have 10+ elements separated with |
|  |  | # spaces (check proc (5) for a complete description) |
|  |  | # |
| Expand All | | @@ -29,6 +33,7 @@ def check\_mounted(secdir): |
|  |  | msg = "Separator filed not found. " \ |
|  |  | "Information line cannot be parsed" |
|  |  | logger.error(msg) |
|  |  | # pylint: disable=raise-missing-from |
|  |  | raise Exception(msg) |
|  |  |  |
|  |  | if len(elements) < 10 or len(elements) - separator < 4: |
| Expand Down  Expand Up | | @@ -56,10 +61,10 @@ def check\_mounted(secdir): |
|  |  |  |
|  |  |  |
|  |  | def mount(): |
|  |  | secdir = config.WORK\_DIR + "/secure" |
|  |  | secdir = os.path.join(config.WORK\_DIR, "secure") |
|  |  |  |
|  |  | if not config.MOUNT\_SECURE: |
|  |  | secdir = config.WORK\_DIR + "/tmpfs-dev" |
|  |  | secdir = os.path.join(config.WORK\_DIR, "tmpfs-dev") |
|  |  | if not os.path.isdir(secdir): |
|  |  | os.makedirs(secdir) |
|  |  | return secdir |
| Expand All | | @@ -74,5 +79,22 @@ def mount(): |
|  |  | cmd = ('mount', '-t', 'tmpfs', '-o', 'size=%s,mode=0700' % size, |
|  |  | 'tmpfs', secdir) |
|  |  | cmd\_exec.run(cmd) |
|  |  | \_MOUNTED.append(secdir) |
|  |  |  |
|  |  | return secdir |
|  |  |  |
|  |  |  |
|  |  | def umount(): |
|  |  | """Umount all the devices mounted by Keylime.""" |
|  |  | while \_MOUNTED: |
|  |  | directory = \_MOUNTED.pop() |
|  |  | logger.info("Unmounting %s", directory) |
|  |  | if check\_mounted(directory): |
|  |  | cmd = ("umount", directory) |
|  |  | ret = cmd\_exec.run(cmd, raiseOnError=False) |
|  |  | if ret["code"] != 0: |
|  |  | logger.error("%s cannot be umounted. " |
|  |  | "A running process can be keeping it bussy: %s", |
|  |  | directory, str(ret["reterr"])) |
|  |  | else: |
|  |  | logger.warning("%s already unmounted by another process", directory) |

149 changes: 138 additions & 11 deletions

149
[test/test\_secure\_mount.py](#diff-a8f92ee278b225647bfe0536f8a4c86011c4b8645f0db5b03fbffc3d42ef4fe2 "test/test_secure_mount.py")

Show comments

[View file](/keylime/keylime/blob/d37c406e69cb6689baa2fb7964bad75209703724/test/test_secure_mount.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,33 +1,38 @@ |
|  |  | import tempfile |
|  |  | import unittest |
|  |  | from unittest.mock import patch |
|  |  |  |
|  |  | from keylime import secure\_mount |
|  |  |  |
|  |  |  |
|  |  | class TestSecureMount(unittest.TestCase): |
|  |  | def setUp(self): |
|  |  | """Remove global state from secure\_mount module.""" |
|  |  | # pylint: disable=protected-access |
|  |  | secure\_mount.\_MOUNTED = [] |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_not\_found(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_not\_found(self, open\_mock, \_logger\_mock): |
|  |  | """Test when secdir is not mounted.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | ) |
|  |  | ) |
|  |  | self.assertFalse(secure\_mount.check\_mounted("/secdir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_found(self, open\_mock, \_logger\_mock): |
|  |  | """Test when secdir is mounted.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | "303 154 0:69 / /secdir rw,relatime shared:130 - tmpfs tmpfs rw,size=1024k,mode=700,inode64", |
|  |  | ) |
|  |  | ) |
|  |  | self.assertTrue(secure\_mount.check\_mounted("/secdir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_zero\_optional\_fields(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_found\_zero\_optional\_fields(self, open\_mock, \_logger\_mock): |
|  |  | """Test when secdir is mounted when there are no optional fields.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
| Expand All | | @@ -37,7 +42,7 @@ def test\_check\_mounted\_found\_zero\_optional\_fields(self, open\_mock, logger\_mock): |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_extra\_optional\_fields(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_found\_extra\_optional\_fields(self, open\_mock, \_logger\_mock): |
|  |  | """Test when secdir is mounted when there are extra optional fields.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
| Expand All | | @@ -47,35 +52,157 @@ def test\_check\_mounted\_found\_extra\_optional\_fields(self, open\_mock, logger\_mock) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_wrong\_fs(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_found\_wrong\_fs(self, open\_mock, \_logger\_mock): |
|  |  | """Test when secdir is mounted but under a wrong fs.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | "303 154 0:69 / /secdir rw,relatime shared:130 - btrfs /dev/sda2 rw", |
|  |  | ) |
|  |  | ) |
|  |  | with self.assertRaises(Exception) as e: |
|  |  | secure\_mount.check\_mounted("/secdir") |
|  |  | self.assertTrue("wrong file system" in str(e.exception)) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_found\_spaces(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_found\_spaces(self, open\_mock, \_logger\_mock): |
|  |  | """Test when secdir is mounted and contains spaces.""" |
|  |  | open\_mock.return\_value = ( |
|  |  | "23 106 0:21 / /proc rw,nosuid,nodev,noexec,relatime shared:26 - proc proc rw", |
|  |  | r"303 154 0:69 / /sec\040dir rw,relatime shared:130 - tmpfs tmpfs rw,size=1024k,mode=700,inode64", |
|  |  | ) |
|  |  | ) |
|  |  | self.assertTrue(secure\_mount.check\_mounted("/sec dir")) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.open") |
|  |  | def test\_check\_mounted\_wrong\_format(self, open\_mock, logger\_mock): |
|  |  | def test\_check\_mounted\_wrong\_format(self, open\_mock, \_logger\_mock): |
|  |  | """Test when the mount info lines are wrong.""" |
|  |  | open\_mock.return\_value = ("invalid line",) |
|  |  | with self.assertRaises(Exception) as e: |
|  |  | secure\_mount.check\_mounted("/secdir") |
|  |  | self.assertTrue("cannot be parsed" in str(e.exception)) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.config") |
|  |  | def test\_check\_mount\_no\_secure(self, config\_mock, \_logger\_mock): |
|  |  | """Test when mounted outside tmpfs.""" |
|  |  | config\_mock.MOUNT\_SECURE = False |
|  |  |  |
|  |  | with tempfile.TemporaryDirectory() as tmpdirname: |
|  |  | config\_mock.WORK\_DIR = tmpdirname |
|  |  | self.assertEqual(secure\_mount.mount(), f"{tmpdirname}/tmpfs-dev") |
|  |  | # pylint: disable=protected-access |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, []) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.check\_mounted") |
|  |  | @patch("keylime.secure\_mount.config") |
|  |  | def test\_check\_mount\_secure\_already\_mounted(self, config\_mock, check\_mounted\_mock): |
|  |  | """Test when mounting in tmpfs but is already present.""" |
|  |  | config\_mock.MOUNT\_SECURE = True |
|  |  | check\_mounted\_mock.return\_value = True |
|  |  |  |
|  |  | with tempfile.TemporaryDirectory() as tmpdirname: |
|  |  | config\_mock.WORK\_DIR = tmpdirname |
|  |  | self.assertEqual(secure\_mount.mount(), f"{tmpdirname}/secure") |
|  |  | # pylint: disable=protected-access |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, []) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.check\_mounted") |
|  |  | @patch("keylime.secure\_mount.config") |
|  |  | @patch("keylime.secure\_mount.os.path.exists") |
|  |  | @patch("keylime.secure\_mount.cmd\_exec") |
|  |  | def test\_check\_mount\_secure\_already\_created( |
|  |  | self, \_cmd\_exec\_mock, exists\_mock, config\_mock, check\_mounted\_mock, \_logger\_mock |
|  |  | ): |
|  |  | """Test when mounting in tmpfs but the mount point is present.""" |
|  |  | exists\_mock.return\_value = True |
|  |  | config\_mock.MOUNT\_SECURE = True |
|  |  | check\_mounted\_mock.return\_value = False |
|  |  |  |
|  |  | with tempfile.TemporaryDirectory() as tmpdirname: |
|  |  | config\_mock.WORK\_DIR = tmpdirname |
|  |  | self.assertEqual(secure\_mount.mount(), f"{tmpdirname}/secure") |
|  |  | # pylint: disable=protected-access |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, [f"{tmpdirname}/secure"]) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.check\_mounted") |
|  |  | @patch("keylime.secure\_mount.config") |
|  |  | @patch("keylime.secure\_mount.os.path.exists") |
|  |  | @patch("keylime.secure\_mount.os.makedirs") |
|  |  | @patch("keylime.secure\_mount.cmd\_exec") |
|  |  | def test\_check\_mount( |
|  |  | self, |
|  |  | \_cmd\_exec\_mock, |
|  |  | \_makedirs\_mock, |
|  |  | exists\_mock, |
|  |  | config\_mock, |
|  |  | check\_mounted\_mock, |
|  |  | \_logger\_mock, |
|  |  | ): |
|  |  | """Test when mounting in tmpfs but the mount point is not present.""" |
|  |  | exists\_mock.return\_value = False |
|  |  | config\_mock.MOUNT\_SECURE = True |
|  |  | check\_mounted\_mock.return\_value = False |
|  |  |  |
|  |  | with tempfile.TemporaryDirectory() as tmpdirname: |
|  |  | config\_mock.WORK\_DIR = tmpdirname |
|  |  | self.assertEqual(secure\_mount.mount(), f"{tmpdirname}/secure") |
|  |  | # pylint: disable=protected-access |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, [f"{tmpdirname}/secure"]) |
|  |  |  |
|  |  | def test\_check\_umount\_empty(self): |
|  |  | """Test umount when there are nothing to clean.""" |
|  |  | secure\_mount.umount() |
|  |  | # pylint: disable=protected-access |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, []) |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.check\_mounted") |
|  |  | @patch("keylime.secure\_mount.cmd\_exec") |
|  |  | def test\_check\_umount\_mount(self, cmd\_exec\_mock, check\_mounted\_mock, logger\_mock): |
|  |  | """Test umount for a single mount.""" |
|  |  | # pylint: disable=protected-access |
|  |  | secure\_mount.\_MOUNTED = ["/secdir"] |
|  |  | check\_mounted\_mock.return\_value = True |
|  |  | cmd\_exec\_mock.run.return\_value = {"code": 0} |
|  |  | secure\_mount.umount() |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, []) |
|  |  | cmd\_exec\_mock.run.assert\_called\_once() |
|  |  | logger\_mock.error.assert\_not\_called() |
|  |  | logger\_mock.warning.assert\_not\_called() |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.check\_mounted") |
|  |  | @patch("keylime.secure\_mount.cmd\_exec") |
|  |  | def test\_check\_umount\_mount\_busy( |
|  |  | self, cmd\_exec\_mock, check\_mounted\_mock, logger\_mock |
|  |  | ): |
|  |  | """Test umount for a single mount that fail.""" |
|  |  | # pylint: disable=protected-access |
|  |  | secure\_mount.\_MOUNTED = ["/secdir"] |
|  |  | check\_mounted\_mock.return\_value = True |
|  |  | cmd\_exec\_mock.run.return\_value = {"code": 1, "reterr": "Device busy"} |
|  |  | secure\_mount.umount() |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, []) |
|  |  | cmd\_exec\_mock.run.assert\_called\_once() |
|  |  | logger\_mock.error.assert\_called\_once() |
|  |  | logger\_mock.warning.assert\_not\_called() |
|  |  |  |
|  |  | @patch("keylime.secure\_mount.logger") |
|  |  | @patch("keylime.secure\_mount.check\_mounted") |
|  |  | @patch("keylime.secure\_mount.cmd\_exec") |
|  |  | def test\_check\_umount\_umount(self, cmd\_exec\_mock, check\_mounted\_mock, logger\_mock): |
|  |  | """Test umount for a single umount and no creation.""" |
|  |  | # pylint: disable=protected-access |
|  |  | secure\_mount.\_MOUNTED = ["/secdir"] |
|  |  | check\_mounted\_mock.return\_value = False |
|  |  | secure\_mount.umount() |
|  |  | self.assertEqual(secure\_mount.\_MOUNTED, []) |
|  |  | cmd\_exec\_mock.run.assert\_not\_called() |
|  |  | logger\_mock.error.assert\_not\_called() |
|  |  | logger\_mock.warning.assert\_called\_once() |
|  |  |  |
|  |  |  |
|  |  | if \_\_name\_\_ == "\_\_main\_\_": |
|  |  | unittest.main() |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d37c406`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeylime%2Fkeylime%2Fcommit%2Fd37c406e69cb6689baa2fb7964bad75209703724) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


