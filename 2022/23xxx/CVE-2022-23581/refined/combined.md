=== Content from github.com_768fff38_20250114_210532.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fgrappler%2Foptimizers%2Fconstant_folding.cc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fblob%2Fa1320ec1eac186da1d03f033109191f715b2b130%2Ftensorflow%2Fcore%2Fgrappler%2Foptimizers%2Fconstant_folding.cc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Files

 a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[grappler](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler)
5. /[optimizers](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers)
/
# constant\_folding.cc

Copy path Blame  Blame
## Latest commit

## History

[History](/tensorflow/tensorflow/commits/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/constant_folding.cc)4050 lines (3771 loc) · 154 KB a1320ec
## Breadcrumbs

1. [tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130)
2. /[tensorflow](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow)
3. /[core](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core)
4. /[grappler](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler)
5. /[optimizers](/tensorflow/tensorflow/tree/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers)
/
# constant\_folding.cc

Top
## File metadata and controls

* Code
* Blame

4050 lines (3771 loc) · 154 KB[Raw](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/constant_folding.cc)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\* Copyright 2017 The TensorFlow Authors. All Rights Reserved.
Licensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License.==============================================================================\*/
#define EIGEN\_USE\_THREADS
#include "tensorflow/core/grappler/optimizers/constant\_folding.h"
#include <cmath>
#include "absl/strings/string\_view.h"#include "absl/strings/substitute.h"#include "tensorflow/core/framework/allocator.h"#include "tensorflow/core/framework/attr\_value.pb.h"#include "tensorflow/core/framework/function.pb.h"#include "tensorflow/core/framework/node\_def.pb.h"#include "tensorflow/core/framework/op.h"#include "tensorflow/core/framework/op\_def.pb.h"#include "tensorflow/core/framework/tensor.pb.h"#include "tensorflow/core/framework/tensor\_shape.pb.h"#include "tensorflow/core/framework/tensor\_util.h"#include "tensorflow/core/framework/types.h"#include "tensorflow/core/framework/types.pb.h"#include "tensorflow/core/framework/versions.pb.h"#include "tensorflow/core/grappler/clusters/cluster.h"#include "tensorflow/core/grappler/costs/graph\_properties.h"#include "tensorflow/core/grappler/grappler\_item.h"#include "tensorflow/core/grappler/op\_types.h"#include "tensorflow/core/grappler/optimizers/evaluation\_utils.h"#include "tensorflow/core/grappler/utils.h"#include "tensorflow/core/grappler/utils/symbolic\_shapes.h"#include "tensorflow/core/lib/core/errors.h"#include "tensorflow/core/lib/core/stringpiece.h"#include "tensorflow/core/lib/gtl/cleanup.h"#include "tensorflow/core/lib/gtl/inlined\_vector.h"#include "tensorflow/core/lib/strings/numbers.h"#include "tensorflow/core/lib/strings/strcat.h"#include "tensorflow/core/platform/cpu\_info.h"#include "tensorflow/core/platform/denormal.h"#include "tensorflow/core/platform/env.h"#include "tensorflow/core/platform/setround.h"#include "tensorflow/core/platform/tensor\_coding.h"#include "tensorflow/core/public/version.h"#include "tensorflow/core/util/bcast.h"#include "tensorflow/core/util/saved\_tensor\_slice\_util.h"
namespace tensorflow {namespace grappler {using TensorVector = gtl::InlinedVector<TensorValue, 4>;
// We only fold/materialize constants smaller than 100kB.const int64\_t kMaxConstantSize = 100 \* 1024;
namespace {template <typename T>bool AllValuesAre(const TensorProto& proto, const T& value) { Tensor tensor; if (!tensor.FromProto(proto)) { return false; } auto values = tensor.flat<T>(); for (int i = 0; i < tensor.NumElements(); ++i) { if (values(i) != value) { return false; } } return true;}
// Add new\_input as a control input to node if it does not already depend on it.// TODO(rmlarsen): Move the following two utility functions to utils.{h,cc} and// clean up code that should be using them.bool MaybeAddControlInput(const string& ctrl\_input, NodeDef\* node, GraphDef\* graph, NodeMap\* node\_map) { bool already\_exists = false; for (const string& input : node->input()) { if (input == ctrl\_input || AsControlDependency(input) == ctrl\_input) { already\_exists = true; break; } } if (!already\_exists) { const string ctrl\_dep = ConstantFolding::AddControlDependency(ctrl\_input, graph, node\_map); node->add\_input(ctrl\_dep); node\_map->AddOutput(NodeName(ctrl\_input), node->name()); } return !already\_exists;}
// Remove old\_input as a control input to node.bool MaybeRemoveControlInput(const string& old\_input, NodeDef\* node, GraphDef\* graph, NodeMap\* node\_map) { bool removed\_input = false; bool update\_node\_map = true; const string old\_input\_ctrl\_dep = AsControlDependency(NodeName(old\_input)); for (int i = 0; i < node->input\_size(); ++i) { const string& input = node->input(i); if (old\_input\_ctrl\_dep == input) { if (IsControlInput(input)) { node->mutable\_input()->SwapElements(i, node->input\_size() - 1); node->mutable\_input()->RemoveLast(); removed\_input = true; } else { // There is a non-control input from the same node. // Don't remove the output from the NodeMap. update\_node\_map = false; } } } if (update\_node\_map) { node\_map->RemoveOutput(NodeName(old\_input), node->name()); } return removed\_input;}
bool HasTPUAttributes(const NodeDef& node) { AttrSlice attrs(node); for (const auto& attr : attrs) { if (attr.first.find("\_tpu\_") != attr.first.npos) { return true; } } return false;}
template <typename T>bool PackedValuesNotEqual(T a, T b) { return a != b;}
template <>bool PackedValuesNotEqual(float a, float b) { return reinterpret\_cast<int32\_t&>(a) != reinterpret\_cast<int32\_t&>(b);}
template <>bool PackedValuesNotEqual(double a, double b) { return reinterpret\_cast<int64\_t&>(a) != reinterpret\_cast<int64\_t&>(b);}
float QuantizedTypeMinAsFloat(DataType data\_type) { switch (data\_type) { case DT\_QINT8: return Eigen::NumTraits<qint8>::lowest(); case DT\_QUINT8: return Eigen::NumTraits<quint8>::lowest(); case DT\_QINT16: return Eigen::NumTraits<qint16>::lowest(); case DT\_QUINT16: return Eigen::NumTraits<quint16>::lowest(); case DT\_QINT32: return Eigen::NumTraits<qint32>::lowest(); default: return 0.0f; }}
float QuantizedTypeMaxAsFloat(DataType data\_type) { switch (data\_type) { case DT\_QINT8: return Eigen::NumTraits<qint8>::highest(); case DT\_QUINT8: return Eigen::NumTraits<quint8>::highest(); case DT\_QINT16: return Eigen::NumTraits<qint16>::highest(); case DT\_QUINT16: return Eigen::NumTraits<quint16>::highest(); case DT\_QINT32: return Eigen::NumTraits<qint32>::highest(); default: return 0.0f; }}
} // namespace
ConstantFolding::ConstantFolding(RewriterConfig::Toggle opt\_level, DeviceBase\* cpu\_device, bool disable\_compressed\_tensor\_optimization, bool fold\_quantization\_emulation) : opt\_level\_(opt\_level), cpu\_device\_(cpu\_device), disable\_compressed\_tensor\_optimization\_( disable\_compressed\_tensor\_optimization), fold\_quantization\_emulation\_(fold\_quantization\_emulation) { resource\_mgr\_.reset(new ResourceMgr());}
ConstantFolding::ConstantFolding(DeviceBase\* cpu\_device, bool disable\_compressed\_tensor\_optimization, bool fold\_quantization\_ops) : ConstantFolding(RewriterConfig::ON, cpu\_device, disable\_compressed\_tensor\_optimization, fold\_quantization\_ops) {}
// staticstring ConstantFolding::AddControlDependency(const string& input\_name, GraphDef\* graph, NodeMap\* node\_map) { if (IsControlInput(input\_name)) { return input\_name; } const NodeDef\* node = node\_map->GetNode(input\_name); // Sanity check for missing node. if (!node) { return input\_name; } if (!IsSwitch(\*node)) { return AsControlDependency(\*node); } else { // We can't anchor control dependencies directly on the switch node: unlike // other nodes only one of the outputs of the switch node will be generated // when the switch node is executed, and we need to make sure the control // dependency is only triggered when the corresponding output is triggered. // We start by looking for an identity node connected to the output of the // switch node, and use it to anchor the control dependency. for (const NodeDef\* output : node\_map->GetOutputs(node->name())) { if (IsIdentity(\*output) || IsIdentityNSingleInput(\*output)) { if (IsSameInput(node->input(0), input\_name)) { return AsControlDependency(\*output); } } } // We haven't found an existing node where we can anchor the control // dependency: add a new identity node. int port = 0; string ctrl\_dep\_name = ParseNodeName(input\_name, &port); strings::StrAppend(&ctrl\_dep\_name, "\_", port); ctrl\_dep\_name = AddPrefixToNodeName(ctrl\_dep\_name, kConstantFoldingCtrl); const DataType output\_type = node->attr().at("T").type();
 NodeDef\* added\_node = node\_map->GetNode(ctrl\_dep\_name); if (added\_node == nullptr) { added\_node = graph->add\_node(); added\_node->set\_name(ctrl\_dep\_name); added\_node->set\_op("Identity"); added\_node->set\_device(node->device());
 (\*added\_node->mutable\_attr())["T"].set\_type(output\_type); \*added\_node->add\_input() = input\_name; node\_map->AddNode(added\_node->name(), added\_node); node\_map->AddOutput(node->name(), added\_node->name()); } return AsControlDependency(\*added\_node); }}
// Forward inputs at the given indices to outputs and add a control dependency// on node.bool ConstantFolding::ForwardInputs(NodeDef\* node, absl::Span<const int> inputs\_to\_forward) { for (int input\_idx : inputs\_to\_forward) { if (input\_idx < 0 || input\_idx >= node->input\_size()) { return false; } }
 const auto& tmp = node\_map\_->GetOutputs(node->name()); const std::vector<NodeDef\*> consumers(tmp.begin(), tmp.end()); bool updated\_graph = false; for (int input\_idx : inputs\_to\_forward) { const string& input = node->input(input\_idx); if (IsControlInput(input) && consumers.size() > 1) { continue; } const NodeDef\* input\_node = node\_map\_->GetNode(NodeName(input)); if (input\_node == nullptr) { LOG(ERROR) << "Bad input: " << input; break; } // Update each consumer. for (NodeDef\* consumer : consumers) { bool add\_dep = false; for (int consumer\_input\_idx = 0; consumer\_input\_idx < consumer->input\_size(); ++consumer\_input\_idx) { const string& consumer\_input = consumer->input(consumer\_input\_idx); if (IsControlInput(consumer\_input)) { break; } // It is illegal to add control dependencies to \_Retval nodes, so we // can't bypass value producing `node` and forward inputs to `consumer`. if (IsRetval(\*consumer)) { break; } int output\_idx; const string input\_node\_name = ParseNodeName(consumer\_input, &output\_idx); if (input\_node\_name == node->name() && output\_idx == input\_idx) { consumer->set\_input(consumer\_input\_idx, input); // We will keep the input from the node through a control // dependency, so we only need to add the consumer as an output // for the input node. node\_map\_->AddOutput(NodeName(input), consumer->name()); add\_dep = true; } } if (add\_dep) { consumer->add\_input(AsControlDependency(node->name())); updated\_graph = true; } } }
 if (updated\_graph) { for (NodeDef\* consumer : consumers) { DedupControlInputs(consumer); } } return updated\_graph;}
// Puts the given value into the tensor at the given "flat" index.static Status PutValueIntoTensor(const int64\_t value, const DataType& type, const int index, Tensor\* tensor) { if (type == DT\_INT32) { if (value >= INT\_MAX) { return Status(error::INVALID\_ARGUMENT, "int32 overflow"); } tensor->flat<int32>()(index) = static\_cast<int32>(value); } else { tensor->flat<int64\_t>()(index) = value; } return Status::OK();}
// Writes the given tensor shape into the given tensor.// Op is assumed to be Shape, ShapeN, Size or Rank.static Status ConvertShapeToConstant(const string& op, const DataType& type, const PartialTensorShape& shp, Tensor\* tensor) { if (op == "Shape" || op == "ShapeN") { \*tensor = Tensor(type, TensorShape({shp.dims()})); for (int i = 0; i < shp.dims(); ++i) { TF\_RETURN\_IF\_ERROR(PutValueIntoTensor(shp.dim\_size(i), type, i, tensor)); } } else if (op == "Size") { int64\_t size = 1; for (int i = 0; i < shp.dims(); ++i) { size \*= shp.dim\_size(i); } \*tensor = Tensor(type, TensorShape({})); TF\_RETURN\_IF\_ERROR(PutValueIntoTensor(size, type, 0, tensor)); } else { CHECK\_EQ(op, "Rank"); \*tensor = Tensor(type, TensorShape({})); TF\_RETURN\_IF\_ERROR(PutValueIntoTensor(shp.dims(), type, 0, tensor)); } return Status::OK();}
// TODO(rmlarsen): Perhaps we should move this to the GraphOptimizer base class.bool ConstantFolding::OptimizedNodeExists(const NodeDef& node, StringPiece suffix) const { return node\_map\_->NodeExists(OptimizedNodeName(node, suffix));}
string ConstantFolding::OptimizedNodeName(const NodeDef& node, StringPiece suffix) const { return AddPrefixToNodeName(strings::StrCat(node.name(), suffix), kConstantFoldingConst);}
bool ConstantFolding::IsReallyConstant(const NodeDef& node) const { if (!IsConstant(node)) { return false; } // If the node is fed it's not constant anymore. return feed\_nodes\_.find(node.name()) == feed\_nodes\_.end();}
// TODO(rmlarsen): Refactor to shared util.bool ConstantFolding::GetTensorFromConstNode(const string& node\_name\_or\_input, Tensor\* tensor) { const NodeDef\* node = node\_map\_->GetNode(node\_name\_or\_input); return node != nullptr && IsReallyConstant(\*node) && CheckAttrExists(\*node, "value").ok() && tensor->FromProto(node->attr().at("value").tensor());}
// Materialize the shapes using constants whenever possible.Status ConstantFolding::MaterializeShapes(const GraphProperties& properties) { // We may add some nodes to the graph to encode control dependencies and hold // the materialized shapes: there is no need to process these added nodes, so // only iterate over the nodes of the input graph. const int node\_count = graph\_->node\_size(); for (int node\_idx = 0; node\_idx < node\_count; ++node\_idx) { NodeDef\* node = graph\_->mutable\_node(node\_idx); const string op = node->op(); if (op != "Shape" && op != "Size" && op != "Rank" && op != "ShapeN" && op != "TensorArraySizeV3") { continue; } const std::vector<OpInfo::TensorProperties>& output = properties.GetOutputProperties(node->name()); const std::vector<OpInfo::TensorProperties>& input = properties.GetInputProperties(node->name()); if (input.empty() || output.empty()) { continue; }
 if (op == "Shape" || op == "Size" || op == "Rank") { CHECK\_EQ(1, output.size()); CHECK\_EQ(1, input.size());
 const DataType type = output[0].dtype(); CHECK(type == DT\_INT32 || type == DT\_INT64); const PartialTensorShape shape(input[0].shape());
 if ((op != "Rank" && !shape.IsFullyDefined()) || (op == "Rank" && shape.unknown\_rank())) { continue; }
 Tensor constant\_value(type); if (!ConvertShapeToConstant(op, type, shape, &constant\_value).ok()) { continue; }
 // TODO(rmlarsen): Remove this workaround for b/150861569 // The bug involves an expression of the form Shape(ExpandDims(x) // with an incorrectly inferred zero-size first dimension. if (op == "Shape") { if (shape.dims() > 0 && shape.dim\_size(0) == 0) continue; }
 // Repurpose the existing node to be the constant. // Device placement is preserved. graph\_modified\_ = true; node->set\_op("Const"); EraseRegularNodeAttributes(node); (\*node->mutable\_attr())["dtype"].set\_type(type); constant\_value.AsProtoTensorContent( (\*node->mutable\_attr())["value"].mutable\_tensor());
 // Turn the data input into a control dependency: this is needed to // ensure that the constant value will only be run in the // cases where the shape/rank/size would have been run in // the original graph. string ctrl\_dep = AddControlDependency(node->input(0), graph\_, node\_map\_.get()); node\_map\_->UpdateInput(node->name(), node->input(0), ctrl\_dep); node->set\_input(0, ctrl\_dep); // Done with the Shape/Size/Rank node, move to the next node. continue; }
 if (op == "TensorArraySizeV3") { const NodeDef\* array = CHECK\_NOTNULL(node\_map\_->GetNode(node->input(0))); if (array->input\_size() == 0 || (array->attr().count("dynamic\_size") != 0 && array->attr().at("dynamic\_size").b())) { continue; } const NodeDef\* array\_size = CHECK\_NOTNULL(node\_map\_->GetNode(array->input(0))); if (IsReallyConstant(\*array\_size)) { // Don't materialize 0 sizes to avoid triggering incorrect static // checks. A 0 sized array that can't grow isn't useful anyway. if (array\_size->attr().count("value") == 0) { continue; } const TensorProto& raw\_val = array\_size->attr().at("value").tensor(); if (raw\_val.dtype() != DT\_INT32) { continue; } Tensor value(raw\_val.dtype(), raw\_val.tensor\_shape()); if (!value.FromProto(raw\_val)) { continue; } if (value.flat<int32>()(0) == 0) { continue; }
 graph\_modified\_ = true; node->set\_op("Const"); \*node->mutable\_attr() = array\_size->attr(); node->set\_input(0, AsControlDependency(NodeName(node->input(0)))); node->set\_input(1, AddControlDependency(NodeName(node->input(1)), graph\_, node\_map\_.get())); } continue; }
 // Handle ShapeN materialization case. // It's possible that not all input tensors have known shapes. CHECK\_EQ(op, "ShapeN"); CHECK\_EQ(input.size(), output.size()); const NodeDef\* const shape\_n\_node = node; for (int port\_idx = 0, idx\_limit = output.size(); port\_idx < idx\_limit; ++port\_idx) { const DataType type = output[port\_idx].dtype(); CHECK(type == DT\_INT32 || type == DT\_INT64); const PartialTensorShape shape(input[port\_idx].shape()); if (!shape.IsFullyDefined()) { continue; } Tensor constant\_value(type); auto status = ConvertShapeToConstant(op, type, shape, &constant\_value); if (!status.ok()) { continue; }
 // We make a copy because we mutate the nodes. auto fanouts = node\_map\_->GetOutputs(shape\_n\_node->name()); // Find all nodes consuming this shape and connect them through the new // constant node instead. for (NodeDef\* output : fanouts) { // Track whether there are any direct edges left between shape\_n\_node // and this output node after the transformation. bool direct\_edges\_exist = false; for (int k = 0; k < output->input\_size(); ++k) { int port; const string node\_name = ParseNodeName(output->input(k), &port); if (node\_name == shape\_n\_node->name() && port == port\_idx) { // Create a const node as ShapeN's output if not already. const string const\_name = OptimizedNodeName( \*shape\_n\_node, strings::StrCat("-matshapes-", port\_idx)); if (node\_map\_->GetNode(const\_name) == nullptr) { NodeDef\* added\_node = graph\_->add\_node(); added\_node->set\_name(const\_name); added\_node->set\_op("Const"); added\_node->set\_device(shape\_n\_node->device()); node\_map\_->AddNode(added\_node->name(), added\_node); (\*added\_node->mutable\_attr())["dtype"].set\_type(type); constant\_value.AsProtoTensorContent( (\*added\_node->mutable\_attr())["value"].mutable\_tensor()); // We add a control dependency to the original ShapeN node, // so that the node will only be run if all inputs of the // original ShapeN node are run. string ctrl\_dep = AddControlDependency(shape\_n\_node->name(), graph\_, node\_map\_.get()); \*added\_node->add\_input() = ctrl\_dep; node\_map\_->AddOutput(NodeName(ctrl\_dep), added\_node->name()); } \*output->mutable\_input(k) = const\_name; node\_map\_->AddOutput(const\_name, output->name()); graph\_modified\_ = true; } if (node\_name == shape\_n\_node->name() && port != port\_idx) { direct\_edges\_exist = true; } } if (!direct\_edges\_exist) { node\_map\_->RemoveOutput(node->name(), output->name()); } } } }
 return Status::OK();}
namespace {bool ExtractShape(const NodeDef& shape\_node, const GraphProperties& properties, BCast::Vec\* shape, int64\_t\* min\_id) { if (shape\_node.op() == "Shape") { const std::vector<OpInfo::TensorProperties>& prop1 = properties.GetInputProperties(shape\_node.name()); if (prop1.size() != 1) { return false; } const TensorShapeProto& shp = prop1[0].shape(); if (shp.unknown\_rank()) { return false; } for (const auto& dim : shp.dim()) { shape->push\_back(dim.size()); \*min\_id = std::min<int64\_t>(\*min\_id, dim.size()); } } else { if (shape\_node.attr().count("value") == 0) { return false; } const TensorProto& raw\_val = shape\_node.attr().at("value").tensor(); if (raw\_val.dtype() != DT\_INT64 && raw\_val.dtype() != DT\_INT32) { return false; } Tensor value(raw\_val.dtype(), raw\_val.tensor\_shape()); if (!value.FromProto(raw\_val)) { return false; } for (int j = 0; j < value.NumElements(); ++j) { if (raw\_val.dtype() == DT\_INT64) { shape->push\_back(value.vec<int64\_t>()(j)); } else { shape->push\_back(value.vec<int>()(j)); } } } return true;}} // namespace
Status ConstantFolding::MaterializeBroadcastGradientArgs( const NodeDef& node, const GraphProperties& properties) { const NodeDef\* shape\_node1 = node\_map\_->GetNode(node.input(0)); const NodeDef\* shape\_node2 = node\_map\_->GetNode(node.input(1)); if (shape\_node1 == nullptr || (shape\_node1->op() != "Shape" && !IsReallyConstant(\*shape\_node1)) || shape\_node2 == nullptr || (shape\_node2->op() != "Shape" && !IsReallyConstant(\*shape\_node2))) { return Status::OK(); }
 // Don't optimize this again if it was already optimized and folded. if (OptimizedNodeExists(node, "-folded-1") || OptimizedNodeExists(node, "-folded-2")) { return Status::OK(); } int64\_t min\_id = 0; BCast::Vec shape1; if (!ExtractShape(\*shape\_node1, properties, &shape1, &min\_id)) { return Status::OK(); } BCast::Vec shape2; if (!ExtractShape(\*shape\_node2, properties, &shape2, &min\_id)) { return Status::OK(); } // A value of -1 means we don't known anything about the dimension. Replace // the -1 values with unique dimension ids since we don't want two '-1' // dimensions to be considered equal. for (auto& id : shape1) { if (id == -1) { id = --min\_id; } } for (auto& id : shape2) { if (id == -1) { id = --min\_id; } }
 // Beware: the reduction dimensions computed by the BCast class are valid iff // we assume that two distinct symbolic dimensions can't be equal and a // symbolic dimension can't be equal to 1. This is often but not always true, // so to make this optimization safe we filter out these cases. const int common\_dims = std::min(shape1.size(), shape2.size()); for (int i = 0; i < common\_dims; ++i) { if (shape1[i] >= 0 && shape2[i] >= 0) { continue; } if (shape1[i] != shape2[i]) { // We're either dealing with 2 different symbolic dimensions or a symbolic // and a know dimensions. We can't be sure whether both are equal or not, // so we can't be sure whether we'll be broadcasting or not. return Status::OK(); } } // These extra dims could be equal to 1, in which case there is no // broadcasting. It could also be greater than 1, in which case there would // be broadcasting. Since we don't know, we'll just punt. for (int i = common\_dims, end = shape1.size(); i < end; ++i) { if (shape1[i] < 0) { return Status::OK(); } } for (int i = common\_dims, end = shape2.size(); i < end; ++i) { if (shape2[i] < 0) { return Status::OK(); } }
 BCast bcast(shape1, shape2); if (!bcast.IsValid()) { return Status::OK(); }
 BCast::Vec reduce\_dims[2]; reduce\_dims[0] = bcast.grad\_x\_reduce\_idx(); reduce\_dims[1] = bcast.grad\_y\_reduce\_idx();
 TF\_RETURN\_IF\_ERROR(CheckAttrExists(node, "T")); const DataType type = node.attr().at("T").type(); NodeDef\* out[2]; for (int j = 0; j < 2; ++j) { int reduction\_indices = reduce\_dims[j].size(); Tensor value(type, TensorShape({reduction\_indices})); for (int i = 0; i < reduction\_indices; ++i) { if (type == DT\_INT32) { value.vec<int32>()(i) = reduce\_dims[j][i]; } else { value.vec<int64\_t>()(i) = reduce\_dims[j][i]; } } string const\_name = OptimizedNodeName(node, strings::StrCat("-bcastargs-", j)); out[j] = node\_map\_->GetNode(const\_name); if (out[j] == nullptr) { out[j] = graph\_->add\_node(); TF\_RETURN\_IF\_ERROR( CreateNodeDef(const\_name, TensorValue(&value), out[j])); out[j]->set\_device(node.device()); node\_map\_->AddNode(const\_name, out[j]); string ctrl\_dep = AddControlDependency(node.name(), graph\_, node\_map\_.get()); \*out[j]->add\_input() = ctrl\_dep; node\_map\_->AddOutput(NodeName(ctrl\_dep), const\_name); } }
 // We make a copy here since we might mutate the set. const auto outputs = node\_map\_->GetOutputs(node.name()); for (NodeDef\* output : outputs) { for (int k = 0; k < output->input\_size(); ++k) { int port; string node\_name = ParseNodeName(output->input(k), &port); if (node\_name == node.name() && port >= 0 && port < 2 && out[port]) { \*output->mutable\_input(k) = out[port]->name(); node\_map\_->UpdateInput(output->name(), node\_name, out[port]->name()); } } }
 return Status::OK();}
Status ConstantFolding::MaterializeReductionIndices( NodeDef\* node, const GraphProperties& properties) { if (node->input\_size() < 2) { return Status::OK(); } const NodeDef\* indices = node\_map\_->GetNode(node->input(1)); if (!indices || IsReallyConstant(\*indices)) { // The reduction indices are already constant, there's nothing to do. return Status::OK(); }
 const std::vector<OpInfo::TensorProperties>& input\_props = properties.GetInputProperties(node->name()); if (input\_props.size() != 2) { return Status::OK(); } const OpInfo::TensorProperties& input\_prop = input\_props[0]; if (input\_prop.shape().unknown\_rank()) { // We can't do anything if we don't know the rank of the input. return Status::OK(); } const int input\_rank = input\_prop.shape().dim\_size(); if (input\_rank < 1) { // Unexpected graph, don't try to change it. return Status::OK(); } const OpInfo::TensorProperties& reduction\_indices\_prop = input\_props[1]; DataType dtype = reduction\_indices\_prop.dtype(); if (dtype != DT\_INT32 && dtype != DT\_INT64) { return Status::OK(); } PartialTensorShape reduction\_indices\_shape(reduction\_indices\_prop.shape()); const int num\_reduction\_indices = reduction\_indices\_shape.num\_elements();
 const std::vector<OpInfo::TensorProperties>& output\_props = properties.GetOutputProperties(node->name()); if (output\_props.size() != 1) { return Status::OK(); } const OpInfo::TensorProperties& output\_prop = output\_props[0]; const int output\_rank = output\_prop.shape().unknown\_rank() ? -1 : output\_prop.shape().dim\_size();
 bool full\_reduction = output\_rank == 0 || num\_reduction\_indices == input\_rank; if (!full\_reduction) { // A full reduction will generate a tensor of one of the shapes // [], [1], [1, 1], [1, 1, ...]. Even if we do not know the number of // elements in the output of the reduction, we may deduce it from reshape // nodes following it. for (const NodeDef\* fanout : node\_map\_->GetOutputs(node->name())) { full\_reduction = false; if (!IsReshape(\*fanout)) { return Status::OK(); } const std::vector<OpInfo::TensorProperties>& reshape\_props = properties.GetOutputProperties(fanout->name()); if (reshape\_props.size() != 1) { return Status::OK(); } const OpInfo::TensorProperties& reshape\_prop = reshape\_props[0]; PartialTensorShape shape(reshape\_prop.shape()); if (shape.num\_elements() != 1) { return Status::OK(); } else { full\_reduction = true; } } if (!full\_reduction) { return Status::OK(); } }
 // We know it's a full reduction. We can generate the full set of indices to // reduce as a constant node. string const\_name = OptimizedNodeName(\*node, "-reduction\_indices"); if (node\_map\_->GetNode(const\_name)) { return Status::OK(); } NodeDef\* reduction\_indices = graph\_->add\_node(); Tensor value(dtype, TensorShape({input\_rank})); for (int i = 0; i < input\_rank; ++i) { if (dtype == DT\_INT32) { value.vec<int32>()(i) = i; } else { value.vec<int64\_t>()(i) = i; } } TF\_RETURN\_IF\_ERROR( CreateNodeDef(const\_name, TensorValue(&value), reduction\_indices));
 reduction\_indices->set\_device(node->device()); string ctrl\_dep = AddControlDependency(node->input(1), graph\_, node\_map\_.get()); \*reduction\_indices->add\_input() = ctrl\_dep; node\_map\_->AddNode(const\_name, reduction\_indices); node\_map\_->AddOutput(NodeName(ctrl\_dep), const\_name);
 node->set\_input(1, reduction\_indices->name()); node\_map\_->UpdateInput(node->name(), indices->name(), reduction\_indices->name());
 return Status::OK();}
Status ConstantFolding::MaterializeConstantValuedNode( NodeDef\* node, const GraphProperties& properties) { if (disable\_compressed\_tensor\_optimization\_) { return Status::OK(); } // Nodes that generate constant-valued outputs can be represented compactly in // compressed format, regardless of their shape. const std::vector<OpInfo::TensorProperties>& output\_props = properties.GetOutputProperties(node->name()); if (output\_props.size() != 1) return Status::OK(); const auto& output\_shape = output\_props[0].shape(); if (!PartialTensorShape(output\_shape).IsFullyDefined()) { return Status::OK(); } if (IsFill(\*node)) { const auto output\_dtype = output\_props[0].dtype(); NodeDef\* input\_node = nullptr; for (int i = 0; i < 2; ++i) { input\_node = node\_map\_->GetNode(NodeName(node->input(i))); if (input\_node == nullptr || !IsReallyConstant(\*input\_node)) { return Status::OK(); } } TF\_RETURN\_IF\_ERROR(CheckAttrExists(\*input\_node, "value"));
 // Copy the input tensor to the fill node, set the output shape and data // type, and change the node type to Const. TensorProto\* tensor = (\*node->mutable\_attr())["value"].mutable\_tensor(); const TensorProto& input\_tensor = input\_node->attr().at("value").tensor(); if (!input\_tensor.tensor\_content().empty()) { // Convert the value to repeated field format, so we can use the // decompression mechanism to store only a single value in the constant // node, even if the shape specified in the original Fill is large. Tensor t; if (!t.FromProto(input\_tensor)) { return errors::InvalidArgument( "Could not construct Tensor form TensorProto in node: ", input\_node->name()); } tensor->clear\_tensor\_content(); t.AsProtoField(tensor); } else { \*tensor = input\_tensor; } \*(tensor->mutable\_tensor\_shape()) = output\_shape; (\*node->mutable\_attr())["dtype"].set\_type(output\_dtype); node->mutable\_attr()->erase("T"); node->mutable\_attr()->erase("index\_type"); node->set\_op("Const"); for (int i = 0; i < 2; i++) { // Change inputs to a control inputs. const string ctrl\_dep = AsControlDependency(node->input(i)); node\_map\_->UpdateInput(node->name(), node->input(i), ctrl\_dep); node->set\_input(i, ctrl\_dep); } graph\_modified\_ = true; } else { double value = (IsZerosLike(\*node) ? 0.0 : (IsOnesLike(\*node) ? 1.0 : -1.0)); if (value >= 0) { TF\_RETURN\_IF\_ERROR(ReplaceOperationWithConstant( value, properties, output\_shape, node, graph\_)); } } return Status::OK();}
// Materialize output values inferred by the shape inference.Status ConstantFolding::MaterializeOutputValues( NodeDef\* node, const GraphProperties& properties) { const std::vector<OpInfo::TensorProperties>& output = properties.GetOutputProperties(node->name()); if (output.size() != 1 || !output[0].has\_value() || !IsFoldable(\*node, &properties)) { return Status::OK(); }
 // If this is a trivial Identity node with a constant input, just route the // input around it. if (IsIdentity(\*node)) { NodeDef\* input = node\_map\_->GetNode(node->input(0)); if (IsReallyConstant(\*input)) { std::vector<int> inputs\_to\_forward; std::iota(inputs\_to\_forward.begin(), inputs\_to\_forward.end(), 0); graph\_modified\_ = ForwardInputs(node, inputs\_to\_forward); return Status::OK(); } } // Repurpose the existing node to be the constant. // Device placement is preserved. TensorProto value\_copy = output[0].value(); return ReplaceOperationWithConstantTensor(output[0].dtype(), &value\_copy, node, graph\_);}
Status ConstantFolding::MaterializeConstants( const GraphProperties& properties) { const int node\_count = graph\_->node\_size(); for (int i = 0; i < node\_count; ++i) { NodeDef& node = \*graph\_->mutable\_node(i); const string& op = node.op(); if (op == "BroadcastGradientArgs") { TF\_RETURN\_IF\_ERROR(MaterializeBroadcastGradientArgs(node, properties)); } else if (IsReduction(node)) { TF\_RETURN\_IF\_ERROR(MaterializeReductionIndices(&node, properties)); } else if (IsFill(node) || IsZerosLike(node) || IsOnesLike(node)) { TF\_RETURN\_IF\_ERROR(MaterializeConstantValuedNode(&node, properties)); } else { TF\_RETURN\_IF\_ERROR(MaterializeOutputValues(&node, properties)); } } return Status::OK();}
bool ConstantFolding::IsFoldable(const NodeDef& node, const GraphProperties\* properties) { string key = strings::StrCat(node.name(), "/", node.op()); auto it = maybe\_foldable\_nodes\_.find(key); if (it == maybe\_foldable\_nodes\_.end()) { it = maybe\_foldable\_nodes\_ .emplace(std::move(key), MaybeFoldable(node, properties)) .first; } if (!it->second) { return false; } else { return IsFoldableUncached(node, properties); }}
bool ConstantFolding::IsFoldableUncached( const NodeDef& node, const GraphProperties\* properties) const { // Folding not applicable to ops with no inputs. if (node.input().empty()) { return false; } // We can only fold nodes if all their inputs are known statically, except in // the case of a merge node that propagate the first inputs that becomes // available, and therefore only requires a single constant input to be // foldable. bool merge\_has\_constant\_input = false; const bool is\_merge = IsMerge(node); for (const auto& input : node.input()) { if (IsControlInput(input)) { continue; } const NodeDef\* input\_node = node\_map\_->GetNode(input); if (!input\_node) { return false; } bool is\_const = IsReallyConstant(\*input\_node); if (is\_const) { // Don't fold strings constants for now since this causes problems with // checkpointing. if (input\_node->attr().count("dtype") == 0 || input\_node->attr().at("dtype").type() == DT\_STRING) { return false; } // Special case: If a Merge node has at least one constant input that // does not depend on a control input, we can fold it. merge\_has\_constant\_input |= !HasControlInputs(\*input\_node); } else if (!is\_merge) { return false; } } if (is\_merge && !merge\_has\_constant\_input) return false; if (disable\_compressed\_tensor\_optimization\_ && (IsFill(node) || IsZerosLike(node) || IsOnesLike(node)))[View remainder of file in raw view](https://github.com/tensorflow/tensorflow/raw/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/constant_folding.cc)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_f5326bff_20250114_210538.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-fq86-3f29-px2c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-fq86-3f29-px2c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# `CHECK`-failures during Grappler's `IsSimplifiableReshape`

Moderate

[mihaimaruseac](/mihaimaruseac)
published
GHSA-fq86-3f29-px2c
Feb 2, 2022

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.8.0

## Patched versions

2.5.3, 2.6.3, 2.7.1

## Description

### Impact

The Grappler optimizer in TensorFlow can be used to cause a denial of service by altering a `SavedModel` such that [`IsSimplifiableReshape`](https://github.com/tensorflow/tensorflow/blob/a1320ec1eac186da1d03f033109191f715b2b130/tensorflow/core/grappler/optimizers/constant_folding.cc#L1687-L1742) would trigger `CHECK` failures.

### Patches

We have patched the issue in GitHub commits [ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1](https://github.com/tensorflow/tensorflow/commit/ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1), [1fb27733f943295d874417630edd3b38b34ce082](https://github.com/tensorflow/tensorflow/commit/1fb27733f943295d874417630edd3b38b34ce082), and [240655511cd3e701155f944a972db71b6c0b1bb6](https://github.com/tensorflow/tensorflow/commit/240655511cd3e701155f944a972db71b6c0b1bb6).

The fix will be included in TensorFlow 2.8.0. We will also cherrypick this commit on TensorFlow 2.7.1, TensorFlow 2.6.3, and TensorFlow 2.5.3, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Moderate

### CVE ID

CVE-2022-23581

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c6440351_20250114_210534.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F1fb27733f943295d874417630edd3b38b34ce082)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F1fb27733f943295d874417630edd3b38b34ce082)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/1fb27733f943295d874417630edd3b38b34ce082)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Remove `CHECK`-fails from `IsSimplifiableReshape`

[Browse files](/tensorflow/tensorflow/tree/1fb27733f943295d874417630edd3b38b34ce082)
Browse the repository at this point in the history

```
PiperOrigin-RevId: 409164987
Change-Id: I58c7dd459ff348c3dbae95e00c4c5e63b30a4e65
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 11, 2021

1 parent
[ebc1a2f](/tensorflow/tensorflow/commit/ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1)

commit 1fb2773

Showing
**1 changed file**
with
**10 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

12 changes: 10 additions & 2 deletions

12
[tensorflow/core/grappler/optimizers/constant\_folding.cc](#diff-663636d4972e75e590efa74039aebbdd26f36eeabbf81ab6691915aa5995a349 "tensorflow/core/grappler/optimizers/constant_folding.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/1fb27733f943295d874417630edd3b38b34ce082/tensorflow/core/grappler/optimizers/constant_folding.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1689,7 +1689,11 @@ Status ConstantFolding::IsSimplifiableReshape( |
|  |  | if (!IsReshape(node)) { |
|  |  | return errors::Internal("Node ", node.name(), " is not a Reshape node"); |
|  |  | } |
|  |  | CHECK\_LE(2, node.input\_size()); |
|  |  | if (2 > node.input\_size()) { |
|  |  | return errors::Internal("Node ", node.name(), |
|  |  | " must have at most 2 inputs but has ", |
|  |  | node.input\_size()); |
|  |  | } |
|  |  | const NodeDef\* new\_shape = node\_map\_->GetNode(node.input(1)); |
|  |  | if (!IsReallyConstant(\*new\_shape)) { |
|  |  | return errors::Internal("Node ", node.name(), " has shape ", |
| Expand All | | @@ -1707,7 +1711,11 @@ Status ConstantFolding::IsSimplifiableReshape( |
|  |  | if (!s.ok()) { |
|  |  | return errors::Internal("Could not evaluate node ", node.name()); |
|  |  | } |
|  |  | CHECK\_EQ(1, outputs.size()); |
|  |  | if (outputs.size() != 1) { |
|  |  | return errors::Internal("Node ", node.name(), |
|  |  | " must have exactly 1 output but has ", |
|  |  | outputs.size()); |
|  |  | } |
|  |  |  |
|  |  | const std::vector<OpInfo::TensorProperties>& props = |
|  |  | properties.GetInputProperties(node.name()); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1fb2773`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F1fb27733f943295d874417630edd3b38b34ce082) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8044d0c1_20250114_210535.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F240655511cd3e701155f944a972db71b6c0b1bb6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F240655511cd3e701155f944a972db71b6c0b1bb6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/240655511cd3e701155f944a972db71b6c0b1bb6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Eliminate `CHECK`-fails from `IsSimplifiableReshape` via `MakeShape(<…

[Browse files](/tensorflow/tensorflow/tree/240655511cd3e701155f944a972db71b6c0b1bb6)
Browse the repository at this point in the history

```
…invalid shape>)`

PiperOrigin-RevId: 409166738
Change-Id: I7f0a3590b8acae3f3e3e2fe636e1f5ef285693cf
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 11, 2021

1 parent
[1fb2773](/tensorflow/tensorflow/commit/1fb27733f943295d874417630edd3b38b34ce082)

commit 2406555

Showing
**1 changed file**
with
**4 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 4 additions & 2 deletions

6
[tensorflow/core/grappler/optimizers/constant\_folding.cc](#diff-663636d4972e75e590efa74039aebbdd26f36eeabbf81ab6691915aa5995a349 "tensorflow/core/grappler/optimizers/constant_folding.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/240655511cd3e701155f944a972db71b6c0b1bb6/tensorflow/core/grappler/optimizers/constant_folding.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1741,14 +1741,16 @@ Status ConstantFolding::IsSimplifiableReshape( |
|  |  | int32\_t dim = outputs[0]->flat<int32>()(i); |
|  |  | shp.push\_back(dim); |
|  |  | } |
|  |  | TF\_CHECK\_OK(TensorShapeUtils::MakeShape(shp, &new\_dims)); |
|  |  | s = TensorShapeUtils::MakeShape(shp, &new\_dims); |
|  |  | if (!s.ok()) return s; |
|  |  | } else { |
|  |  | std::vector<int64\_t> shp; |
|  |  | for (int i = 0; i < outputs[0]->NumElements(); ++i) { |
|  |  | int64\_t dim = outputs[0]->flat<int64\_t>()(i); |
|  |  | shp.push\_back(dim); |
|  |  | } |
|  |  | TF\_CHECK\_OK(TensorShapeUtils::MakeShape(shp, &new\_dims)); |
|  |  | s = TensorShapeUtils::MakeShape(shp, &new\_dims); |
|  |  | if (!s.ok()) return s; |
|  |  | } |
|  |  |  |
|  |  | if (!shape.IsCompatibleWith(new\_dims)) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2406555`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F240655511cd3e701155f944a972db71b6c0b1bb6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c1f30bb7_20250114_210538.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Febc1a2ffe5a7573d905e99bd0ee3568ee07c12c1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Febc1a2ffe5a7573d905e99bd0ee3568ee07c12c1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Make `IsSimplifiableReshape` return `Status` instead of `bool`.

[Browse files](/tensorflow/tensorflow/tree/ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1)
Browse the repository at this point in the history

```
This is to allow remove `CHECK`-fails in subsequent commits.

PiperOrigin-RevId: 409160987
Change-Id: I3f050218a3832271395c4372a0b8ea05f1c03d80
```

* Loading branch information

[![@mihaimaruseac](https://avatars.githubusercontent.com/u/323199?s=40&v=4)](/mihaimaruseac) [![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[mihaimaruseac](/tensorflow/tensorflow/commits?author=mihaimaruseac "View all commits by mihaimaruseac")
authored and
[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Nov 11, 2021

1 parent
[71399f9](/tensorflow/tensorflow/commit/71399f96b8dd97b2e5b1eeaf1a0e7b905d70e381)

commit ebc1a2f

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**21 additions**
and
**11 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/core/grappler/optimizers

  + tensorflow/core/grappler/optimizers/constant\_folding.cc
    [constant\_folding.cc](#diff-663636d4972e75e590efa74039aebbdd26f36eeabbf81ab6691915aa5995a349)
  + tensorflow/core/grappler/optimizers/constant\_folding.h
    [constant\_folding.h](#diff-ac7550e067e2ab578104886a18d8e7b78cd243d7a22766e4e93a806c1faf3fac)

## There are no files selected for viewing

28 changes: 19 additions & 9 deletions

28
[tensorflow/core/grappler/optimizers/constant\_folding.cc](#diff-663636d4972e75e590efa74039aebbdd26f36eeabbf81ab6691915aa5995a349 "tensorflow/core/grappler/optimizers/constant_folding.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1/tensorflow/core/grappler/optimizers/constant_folding.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1684,15 +1684,17 @@ Status ConstantFolding::FoldGraph( |
|  |  | return Status::OK(); |
|  |  | } |
|  |  |  |
|  |  | bool ConstantFolding::IsSimplifiableReshape( |
|  |  | Status ConstantFolding::IsSimplifiableReshape( |
|  |  | const NodeDef& node, const GraphProperties& properties) const { |
|  |  | if (!IsReshape(node)) { |
|  |  | return false; |
|  |  | return errors::Internal("Node ", node.name(), " is not a Reshape node"); |
|  |  | } |
|  |  | CHECK\_LE(2, node.input\_size()); |
|  |  | const NodeDef\* new\_shape = node\_map\_->GetNode(node.input(1)); |
|  |  | if (!IsReallyConstant(\*new\_shape)) { |
|  |  | return false; |
|  |  | return errors::Internal("Node ", node.name(), " has shape ", |
|  |  | new\_shape->DebugString(), |
|  |  | " which is not a constant"); |
|  |  | } |
|  |  | TensorVector outputs; |
|  |  | auto outputs\_cleanup = gtl::MakeCleanup([&outputs] { |
| Expand All | | @@ -1703,22 +1705,25 @@ bool ConstantFolding::IsSimplifiableReshape( |
|  |  |  |
|  |  | Status s = EvaluateNode(\*new\_shape, TensorVector(), &outputs); |
|  |  | if (!s.ok()) { |
|  |  | return false; |
|  |  | return errors::Internal("Could not evaluate node ", node.name()); |
|  |  | } |
|  |  | CHECK\_EQ(1, outputs.size()); |
|  |  |  |
|  |  | const std::vector<OpInfo::TensorProperties>& props = |
|  |  | properties.GetInputProperties(node.name()); |
|  |  | if (props.empty()) { |
|  |  | return false; |
|  |  | return errors::Internal("Node ", node.name(), " has no properties"); |
|  |  | } |
|  |  | const OpInfo::TensorProperties& prop = props[0]; |
|  |  | if (prop.dtype() == DT\_INVALID) { |
|  |  | return false; |
|  |  | return errors::Internal("Node ", node.name(), " has property ", |
|  |  | prop.DebugString(), " with invalid dtype"); |
|  |  | } |
|  |  | const PartialTensorShape shape(prop.shape()); |
|  |  | if (!shape.IsFullyDefined()) { |
|  |  | return false; |
|  |  | return errors::Internal("Node ", node.name(), " has property ", |
|  |  | prop.DebugString(), " with shape ", |
|  |  | shape.DebugString(), " which is not fully defined"); |
|  |  | } |
|  |  |  |
|  |  | PartialTensorShape new\_dims; |
| Expand All | | @@ -1738,7 +1743,12 @@ bool ConstantFolding::IsSimplifiableReshape( |
|  |  | TF\_CHECK\_OK(TensorShapeUtils::MakeShape(shp, &new\_dims)); |
|  |  | } |
|  |  |  |
|  |  | return shape.IsCompatibleWith(new\_dims); |
|  |  | if (!shape.IsCompatibleWith(new\_dims)) { |
|  |  | return errors::Internal("Expected shape ", shape.DebugString(), |
|  |  | "to be compatible with ", new\_dims.DebugString()); |
|  |  | } |
|  |  |  |
|  |  | return Status::OK(); |
|  |  | } |
|  |  |  |
|  |  | #define IS\_VALUE\_CASE(DTYPE, VALUE) \ |
| Expand Down  Expand Up | | @@ -2925,7 +2935,7 @@ bool ConstantFolding::SimplifyReduction(GraphDef\* optimized\_graph, |
|  |  | bool ConstantFolding::SimplifyReshape(const GraphProperties& properties, |
|  |  | bool use\_shape\_info, NodeDef\* node) { |
|  |  | if (!use\_shape\_info || node->attr().count("T") == 0 || |
|  |  | !IsSimplifiableReshape(\*node, properties)) { |
|  |  | !IsSimplifiableReshape(\*node, properties).ok()) { |
|  |  | return false; |
|  |  | } |
|  |  | DataType output\_type = node->attr().at("T").type(); |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[tensorflow/core/grappler/optimizers/constant\_folding.h](#diff-ac7550e067e2ab578104886a18d8e7b78cd243d7a22766e4e93a806c1faf3fac "tensorflow/core/grappler/optimizers/constant_folding.h")

Show comments

[View file](/tensorflow/tensorflow/blob/ebc1a2ffe5a7573d905e99bd0ee3568ee07c12c1/tensorflow/core/grappler/optimizers/constant_folding.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -129,8 +129,8 @@ class ConstantFolding : public GraphOptimizer { |
|  |  | Status FoldGraph(const GraphProperties& properties, GraphDef\* output, |
|  |  | absl::flat\_hash\_set<string>\* nodes\_to\_not\_simplify); |
|  |  |  |
|  |  | bool IsSimplifiableReshape(const NodeDef& node, |
|  |  | const GraphProperties& properties) const; |
|  |  | Status IsSimplifiableReshape(const NodeDef& node, |
|  |  | const GraphProperties& properties) const; |
|  |  | Status SimplifyGraph(GraphDef\* optimized\_graph, GraphProperties\* properties, |
|  |  | absl::flat\_hash\_set<string>\* nodes\_to\_not\_simplify); |
|  |  | Status SimplifyNode(NodeDef\* node, GraphDef\* optimized\_graph, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ebc1a2f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Febc1a2ffe5a7573d905e99bd0ee3568ee07c12c1) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


