=== Content from packetstormsecurity.com_35fed2aa_20250114_185916.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from lessonsec.com_c1e2116e_20250114_185919.html ===

[![](/images/logo_white.svg)](https://lessonsec.com)
[# less on sec](https://lessonsec.com)
### exploring, hacking and breaking stuff

[**Home**](/)
|
[**Whoami**](/whoami/)
|
[**Posts**](/posts/)
|
[**CVE**](/cve/)

Links:
[GitHub](https://github.com/0xless)
|
[Linkedin](https://www.linkedin.com/in/matteo-cosentino/)
|
Email

---

# CVE-2022-44900: path traversal vulnerability in py7zr

**Posted on
2022-12-06**
 • 258 words

Directory traversal vulnerability in SevenZipFile.extractall() function of the python library py7zr version 0.20.0 and earlier allow attackers to read and write arbitrary files on the local machine via malicious 7z file extraction.

To exploit [CVE-2022-44900](https://www.cve.org/CVERecord?id=CVE-2022-44900) vulnerability an attacker needs to create a malicious 7z archive containing a symlink to achieve an arbitrary file read and a file with a path traversal payload as name to achieve an arbitrary file write.

## Exploiting

The script used for tests is the following:

```
import py7zr
import click

@click.command()
@click.argument("filename")

def main_procedure(filename):
	with py7zr.SevenZipFile(filename, 'r') as archive:
	    archive.extractall()

main_procedure()

```

The vulnerable function targeted is `py7zr.SevenZipFile.extractall()`.

A lab setup has been built to test for vulnerabilities.
Directories structured as follow were used:

```
├── start_point
│   ├── archive.7z
│   └── py7zr_test.py
└── target
    ├── write
    └── read

```

The `start_point` directory contains the script used for tests and the malicious archive containing the path traversal payload in the form of the filename of an archived file.

To achieve an arbitrary file write, one of the files in the archives needs to have `../target/write` set as name. The content of the file will be written into `target/write`.

In a similar way, to achieve an arbitrary file read, a symlink pointing to `../target/read` needs to be present in the archive. When extracted the symlink will consist of the content of `target/read`.

## Disclosure timeline

29/10/2022 - Maintainer was notified privately of the vulnerabilities

30/10/2022 - Response from maintainer

01/11/2022 - Release of patched version 0.20.1

01/11/2022 - CVE ID request

06/12/2022 - CVE ID obtained

06/12/2022 - Public disclosure

---

Copyright © 2024
[**Matteo [0xless] Cosentino**](https://lessonsec.com).



=== Content from github.com_2ef0f59b_20250114_185918.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiurahr%2Fpy7zr%2Fcommit%2F1bb43f17515c7f69673a1c88ab9cc72a7bbef406)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiurahr%2Fpy7zr%2Fcommit%2F1bb43f17515c7f69673a1c88ab9cc72a7bbef406)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=miurahr%2Fpy7zr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[miurahr](/miurahr)
/
**[py7zr](/miurahr/py7zr)**
Public

* [Notifications](/login?return_to=%2Fmiurahr%2Fpy7zr) You must be signed in to change notification settings
* [Fork
  75](/login?return_to=%2Fmiurahr%2Fpy7zr)
* [Star
   471](/login?return_to=%2Fmiurahr%2Fpy7zr)

* [Code](/miurahr/py7zr)
* [Issues
  19](/miurahr/py7zr/issues)
* [Pull requests
  4](/miurahr/py7zr/pulls)
* [Discussions](/miurahr/py7zr/discussions)
* [Actions](/miurahr/py7zr/actions)
* [Wiki](/miurahr/py7zr/wiki)
* [Security](/miurahr/py7zr/security)
* [Insights](/miurahr/py7zr/pulse)

Additional navigation options

* [Code](/miurahr/py7zr)
* [Issues](/miurahr/py7zr/issues)
* [Pull requests](/miurahr/py7zr/pulls)
* [Discussions](/miurahr/py7zr/discussions)
* [Actions](/miurahr/py7zr/actions)
* [Wiki](/miurahr/py7zr/wiki)
* [Security](/miurahr/py7zr/security)
* [Insights](/miurahr/py7zr/pulse)

## Commit

[Permalink](/miurahr/py7zr/commit/1bb43f17515c7f69673a1c88ab9cc72a7bbef406)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix sanity check for path traversal attack

[Browse files](/miurahr/py7zr/tree/1bb43f17515c7f69673a1c88ab9cc72a7bbef406)
Browse the repository at this point in the history

```
- Previous versions do not detect the attack in some case
   - fixed it by call resolve()
   - resolve() converts "/hoge/fuga/../../../tmp/evil.sh" to be "/tmp/evil.sh" then
     relative_to() can detect path traversal attack.
- Add path checker in writef() and writestr() methods
  - When pass arcname as evil path such as "../../../../tmp/evil.sh"
    it raises ValueError
- Add test case of bad path detection
- extraction: check symlink and junction is under target folder
- Fix relative_path_marker removal
- Don't put windows file namespace to output file path

Signed-off-by: Hiroshi Miura <miurahr@linux.com>
```

* Loading branch information

[![@miurahr](https://avatars.githubusercontent.com/u/123720?s=40&v=4)](/miurahr)

[miurahr](/miurahr/py7zr/commits?author=miurahr "View all commits by miurahr")
committed
Oct 31, 2022

1 parent
[04e3af5](/miurahr/py7zr/commit/04e3af5ae5092137ee7b015b85efac1c7fd8974e)

commit 1bb43f1

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**158 additions**
and
**53 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* MANIFEST.in
  [MANIFEST.in](#diff-41d5a52589e0480be9c099d2bba7a8135b8b0d71bcbb8df3582a8df1c2295003)
* py7zr

  + py7zr/helpers.py
    [helpers.py](#diff-1e04b493982aef3db6e041f2b01a3d212203fbedbae95b1e1744bf0de03c5215)
  + py7zr/py7zr.py
    [py7zr.py](#diff-db929f7a4ed029e85ca81e5f3b8f9b5ec025d4988f8d0b1716f99f44a5bbe46b)
* tests

  + tests/test\_extract.py
    [test\_extract.py](#diff-24ff2537b4f0f0e2917e279686bf69fb986c20223430905764ef2f6a0e53a975)
  + tests/test\_zipslip.py
    [test\_zipslip.py](#diff-de0e3585e7baeec87d985b94a69e55ade02042655675016179bb1c6bae157c7e)

## There are no files selected for viewing

3 changes: 0 additions & 3 deletions

3
[MANIFEST.in](#diff-41d5a52589e0480be9c099d2bba7a8135b8b0d71bcbb8df3582a8df1c2295003 "MANIFEST.in")

Show comments

[View file](/miurahr/py7zr/blob/1bb43f17515c7f69673a1c88ab9cc72a7bbef406/MANIFEST.in)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,8 +3,6 @@ include \*.rst |
|  |  | include \*.svg |
|  |  | include \*.toml |
|  |  | include LICENSE |
|  |  | include .coveragerc |
|  |  | include tox.ini |
|  |  | include py7zr/py.typed |
|  |  | recursive-include py7zr \*.py |
|  |  | recursive-include tests \*.py |
| Expand All | | @@ -25,7 +23,6 @@ recursive-include docs \*.yml |
|  |  | recursive-include docs \*.odp |
|  |  | recursive-include docs \*.pdf |
|  |  | recursive-include docs \*.svg |
|  |  | recursive-include docs \*.txt |
|  |  | recursive-include docs Makefile |
|  |  | prune .github |
|  |  | exclude .gitignore |
| Expand Down | |  |

60 changes: 58 additions & 2 deletions

60
[py7zr/helpers.py](#diff-1e04b493982aef3db6e041f2b01a3d212203fbedbae95b1e1744bf0de03c5215 "py7zr/helpers.py")

Show comments

[View file](/miurahr/py7zr/blob/1bb43f17515c7f69673a1c88ab9cc72a7bbef406/py7zr/helpers.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -33,6 +33,8 @@ |
|  |  | import \_hashlib # type: ignore # noqa |
|  |  |  |
|  |  | import py7zr.win32compat |
|  |  | from py7zr import Bad7zFile |
|  |  | from py7zr.win32compat import is\_windows\_native\_python, is\_windows\_unc\_path |
|  |  |  |
|  |  | # String used at the beginning of relative paths |
|  |  | RELATIVE\_PATH\_MARKER = "./" |
| Expand Down  Expand Up | | @@ -265,7 +267,7 @@ def from\_now(): |
|  |  | def islink(path): |
|  |  | """ |
|  |  | Cross-platform islink implementation. |
|  |  | Supports Windows NT symbolic links and reparse points. |
|  |  | Support Windows NT symbolic links and reparse points. |
|  |  | """ |
|  |  | is\_symlink = os.path.islink(str(path)) |
|  |  | if sys.version\_info >= (3, 8) or sys.platform != "win32" or sys.getwindowsversion()[0] < 6: |
| Expand All | | @@ -280,7 +282,7 @@ def islink(path): |
|  |  | def readlink(path: Union[str, pathlib.Path], \*, dir\_fd=None) -> Union[str, pathlib.Path]: |
|  |  | """ |
|  |  | Cross-platform compat implementation of os.readlink and Path.readlink(). |
|  |  | Supports Windows NT symbolic links and reparse points. |
|  |  | Support Windows NT symbolic links and reparse points. |
|  |  | When called with path argument as pathlike(str), return result as a pathlike(str). |
|  |  | When called with Path object, return also Path object. |
|  |  | When called with path argument as bytes, return result as a bytes. |
| Expand Down  Expand Up | | @@ -431,3 +433,57 @@ def remove\_relative\_path\_marker(path: str) -> str: |
|  |  | processed\_path = path[len(RELATIVE\_PATH\_MARKER) :] |
|  |  |  |
|  |  | return processed\_path |
|  |  |  |
|  |  |  |
|  |  | def get\_sanitized\_output\_path(fname: str, path: Optional[pathlib.Path]) -> pathlib.Path: |
|  |  | """ |
|  |  | check f.filename has invalid directory traversals |
|  |  | do following but is\_relative\_to introduced in py 3.9, |
|  |  | so I replaced it with relative\_to. when condition is not satisfied, raise ValueError |
|  |  | if not pathlib.Path(...).joinpath(remove\_relative\_path\_marker(outname)).is\_relative\_to(...): |
|  |  | raise Bad7zFile |
|  |  | """ |
|  |  | if path is None: |
|  |  | try: |
|  |  | pathlib.Path(os.getcwd()).joinpath(fname).resolve().relative\_to(os.getcwd()) |
|  |  | outfile = pathlib.Path(remove\_relative\_path\_marker(fname)) |
|  |  | except ValueError: |
|  |  | raise Bad7zFile(f"Specified path is bad: {fname}") |
|  |  | else: |
|  |  | try: |
|  |  | outfile = path.joinpath(remove\_relative\_path\_marker(fname)) |
|  |  | outfile.resolve().relative\_to(path) |
|  |  | except ValueError: |
|  |  | raise Bad7zFile(f"Specified path is bad: {fname}") |
|  |  | return outfile |
|  |  |  |
|  |  |  |
|  |  | def check\_archive\_path(arcname: str) -> bool: |
|  |  | path = pathlib.Path("/foo/boo/fuga/hoge/a90sufoiasj09/dafj08sajfa/") # dummy path |
|  |  | return is\_target\_path\_valid(path, path.joinpath(arcname)) |
|  |  |  |
|  |  |  |
|  |  | def is\_target\_path\_valid(path: pathlib.Path, target: pathlib.Path) -> bool: |
|  |  | try: |
|  |  | if path.is\_absolute(): |
|  |  | target.resolve().relative\_to(path) |
|  |  | else: |
|  |  | target.resolve().relative\_to(pathlib.Path(os.getcwd()).joinpath(path)) |
|  |  | except ValueError: |
|  |  | return False |
|  |  | return True |
|  |  |  |
|  |  |  |
|  |  | def check\_win32\_file\_namespace(pathname: pathlib.Path) -> pathlib.Path: |
|  |  | # When python on Windows and not python on Cygwin, |
|  |  | # Add win32 file namespace to exceed Microsoft Windows |
|  |  | # path length limitation to 260 bytes |
|  |  | # ref. |
|  |  | # https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file |
|  |  | # In editions of Windows before Windows 10 version 1607, |
|  |  | # the maximum length for a path is MAX\_PATH, which is defined as |
|  |  | # 260 characters. In later versions of Windows, changing a registry key |
|  |  | # or select option when python installation is required to remove the limit. |
|  |  | if is\_windows\_native\_python() and pathname.is\_absolute() and not is\_windows\_unc\_path(pathname): |
|  |  | pathname = pathlib.WindowsPath("\\\\?\\" + str(pathname)) |
|  |  | return pathname |

98 changes: 51 additions & 47 deletions

98
[py7zr/py7zr.py](#diff-db929f7a4ed029e85ca81e5f3b8f9b5ec025d4988f8d0b1716f99f44a5bbe46b "py7zr/py7zr.py")

Show comments

[View file](/miurahr/py7zr/blob/1bb43f17515c7f69673a1c88ab9cc72a7bbef406/py7zr/py7zr.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -50,12 +50,13 @@ |
|  |  | MemIO, |
|  |  | NullIO, |
|  |  | calculate\_crc32, |
|  |  | check\_archive\_path, |
|  |  | filetime\_to\_dt, |
|  |  | get\_sanitized\_output\_path, |
|  |  | is\_target\_path\_valid, |
|  |  | readlink, |
|  |  | remove\_relative\_path\_marker, |
|  |  | ) |
|  |  | from py7zr.properties import DEFAULT\_FILTERS, FILTER\_DEFLATE64, MAGIC\_7Z, get\_default\_blocksize, get\_memory\_limit |
|  |  | from py7zr.win32compat import is\_windows\_native\_python, is\_windows\_unc\_path |
|  |  |  |
|  |  | if sys.platform.startswith("win"): |
|  |  | import \_winapi |
| Expand Down  Expand Up | | @@ -567,34 +568,10 @@ def \_extract( |
|  |  | break |
|  |  | i += 1 |
|  |  | fnames.append(outname) |
|  |  | # check f.filename has invalid directory traversals |
|  |  | if path is None: |
|  |  | # do following but is\_relative\_to introduced in py 3.9 |
|  |  | # so I replaced it with relative\_to. when condition is not satisfied, raise ValueError |
|  |  | # if not pathlib.Path(...).joinpath(remove\_relative\_path\_marker(outname)).is\_relative\_to(...): |
|  |  | # raise Bad7zFile |
|  |  | try: |
|  |  | pathlib.Path(os.getcwd()).joinpath(remove\_relative\_path\_marker(outname)).relative\_to(os.getcwd()) |
|  |  | except ValueError: |
|  |  | raise Bad7zFile |
|  |  | outfilename = pathlib.Path(remove\_relative\_path\_marker(outname)) |
|  |  | if path is None or path.is\_absolute(): |
|  |  | outfilename = get\_sanitized\_output\_path(outname, path) |
|  |  | else: |
|  |  | outfilename = path.joinpath(remove\_relative\_path\_marker(outname)) |
|  |  | try: |
|  |  | outfilename.relative\_to(path) |
|  |  | except ValueError: |
|  |  | raise Bad7zFile |
|  |  | # When python on Windows and not python on Cygwin, |
|  |  | # Add win32 file namespace to exceed microsoft windows |
|  |  | # path length limitation to 260 bytes |
|  |  | # ref. |
|  |  | # https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file |
|  |  | # In editions of Windows before Windows 10 version 1607, |
|  |  | # the maximum length for a path is MAX\_PATH, which is defined as |
|  |  | # 260 characters. In later versions of Windows, changing a registry key |
|  |  | # or select option when python installation is required to remove the limit. |
|  |  | if is\_windows\_native\_python() and outfilename.is\_absolute() and not is\_windows\_unc\_path(outfilename): |
|  |  | outfilename = pathlib.WindowsPath("\\\\?\\" + str(outfilename)) |
|  |  | outfilename = get\_sanitized\_output\_path(outname, pathlib.Path(os.getcwd()).joinpath(path)) |
|  |  | if targets is not None and f.filename not in targets: |
|  |  | self.worker.register\_filelike(f.id, None) |
|  |  | continue |
| Expand Down  Expand Up | | @@ -634,12 +611,14 @@ def \_extract( |
|  |  | if callback is not None: |
|  |  | self.worker.extract( |
|  |  | self.fp, |
|  |  | path, |
|  |  | parallel=(not self.password\_protected and not self.\_filePassed), |
|  |  | q=self.q, |
|  |  | ) |
|  |  | else: |
|  |  | self.worker.extract( |
|  |  | self.fp, |
|  |  | path, |
|  |  | parallel=(not self.password\_protected and not self.\_filePassed), |
|  |  | ) |
|  |  |  |
| Expand Down  Expand Up | | @@ -1040,6 +1019,11 @@ def writed(self, targets: Dict[str, IO[Any]]) -> None: |
|  |  | self.writef(input, target) |
|  |  |  |
|  |  | def writef(self, bio: IO[Any], arcname: str): |
|  |  | if not check\_archive\_path(arcname): |
|  |  | raise ValueError(f"Specified path is bad: {arcname}") |
|  |  | return self.\_writef(bio, arcname) |
|  |  |  |
|  |  | def \_writef(self, bio: IO[Any], arcname: str): |
|  |  | if isinstance(bio, io.BytesIO): |
|  |  | size = bio.getbuffer().nbytes |
|  |  | elif isinstance(bio, io.TextIOBase): |
| Expand Down  Expand Up | | @@ -1069,12 +1053,17 @@ def writef(self, bio: IO[Any], arcname: str): |
|  |  | self.files.append(file\_info) |
|  |  |  |
|  |  | def writestr(self, data: Union[str, bytes, bytearray, memoryview], arcname: str): |
|  |  | if not check\_archive\_path(arcname): |
|  |  | raise ValueError(f"Specified path is bad: {arcname}") |
|  |  | return self.\_writestr(data, arcname) |
|  |  |  |
|  |  | def \_writestr(self, data: Union[str, bytes, bytearray, memoryview], arcname: str): |
|  |  | if not isinstance(arcname, str): |
|  |  | raise ValueError("Unsupported arcname") |
|  |  | if isinstance(data, str): |
|  |  | self.writef(io.BytesIO(data.encode("UTF-8")), arcname) |
|  |  | self.\_writef(io.BytesIO(data.encode("UTF-8")), arcname) |
|  |  | elif isinstance(data, bytes) or isinstance(data, bytearray) or isinstance(data, memoryview): |
|  |  | self.writef(io.BytesIO(data), arcname) |
|  |  | self.\_writef(io.BytesIO(bytes(data)), arcname) |
|  |  | else: |
|  |  | raise ValueError("Unsupported data type.") |
|  |  |  |
| Expand Down  Expand Up | | @@ -1131,7 +1120,9 @@ def testzip(self) -> Optional[str]: |
|  |  | for f in self.files: |
|  |  | self.worker.register\_filelike(f.id, None) |
|  |  | try: |
|  |  | self.worker.extract(self.fp, parallel=(not self.password\_protected), skip\_notarget=False) # TODO: print progress |
|  |  | self.worker.extract( |
|  |  | self.fp, None, parallel=(not self.password\_protected), skip\_notarget=False |
|  |  | ) # TODO: print progress |
|  |  | except CrcError as crce: |
|  |  | return crce.args[2] |
|  |  | else: |
| Expand Down  Expand Up | | @@ -1200,7 +1191,7 @@ def \_\_init\_\_(self, files, src\_start: int, header, mp=False) -> None: |
|  |  | else: |
|  |  | self.concurrent = Thread |
|  |  |  |
|  |  | def extract(self, fp: BinaryIO, parallel: bool, skip\_notarget=True, q=None) -> None: |
|  |  | def extract(self, fp: BinaryIO, path: Optional[pathlib.Path], parallel: bool, skip\_notarget=True, q=None) -> None: |
|  |  | """Extract worker method to handle 7zip folder and decompress each files.""" |
|  |  | if hasattr(self.header, "main\_streams") and self.header.main\_streams is not None: |
|  |  | src\_end = self.src\_start + self.header.main\_streams.packinfo.packpositions[-1] |
| Expand All | | @@ -1209,6 +1200,7 @@ def extract(self, fp: BinaryIO, parallel: bool, skip\_notarget=True, q=None) -> N |
|  |  | self.extract\_single( |
|  |  | fp, |
|  |  | self.files, |
|  |  | path, |
|  |  | self.src\_start, |
|  |  | src\_end, |
|  |  | q, |
| Expand All | | @@ -1219,14 +1211,15 @@ def extract(self, fp: BinaryIO, parallel: bool, skip\_notarget=True, q=None) -> N |
|  |  | positions = self.header.main\_streams.packinfo.packpositions |
|  |  | empty\_files = [f for f in self.files if f.emptystream] |
|  |  | if not parallel: |
|  |  | self.extract\_single(fp, empty\_files, 0, 0, q) |
|  |  | self.extract\_single(fp, empty\_files, path, 0, 0, q) |
|  |  | for i in range(numfolders): |
|  |  | if skip\_notarget: |
|  |  | if not any([self.target\_filepath.get(f.id, None) for f in folders[i].files]): |
|  |  | continue |
|  |  | self.extract\_single( |
|  |  | fp, |
|  |  | folders[i].files, |
|  |  | path, |
|  |  | self.src\_start + positions[i], |
|  |  | self.src\_start + positions[i + 1], |
|  |  | q, |
| Expand All | | @@ -1236,7 +1229,7 @@ def extract(self, fp: BinaryIO, parallel: bool, skip\_notarget=True, q=None) -> N |
|  |  | if getattr(fp, "name", None) is None: |
|  |  | raise InternalError("Caught unknown variable status error") |
|  |  | filename: str = getattr(fp, "name", "") # do not become "" but it is for type check. |
|  |  | self.extract\_single(open(filename, "rb"), empty\_files, 0, 0, q) |
|  |  | self.extract\_single(open(filename, "rb"), empty\_files, path, 0, 0, q) |
|  |  | concurrent\_tasks = [] |
|  |  | exc\_q: queue.Queue = queue.Queue() |
|  |  | for i in range(numfolders): |
| Expand All | | @@ -1248,6 +1241,7 @@ def extract(self, fp: BinaryIO, parallel: bool, skip\_notarget=True, q=None) -> N |
|  |  | args=( |
|  |  | filename, |
|  |  | folders[i].files, |
|  |  | path, |
|  |  | self.src\_start + positions[i], |
|  |  | self.src\_start + positions[i + 1], |
|  |  | q, |
| Expand All | | @@ -1266,12 +1260,13 @@ def extract(self, fp: BinaryIO, parallel: bool, skip\_notarget=True, q=None) -> N |
|  |  | raise exc\_info[1].with\_traceback(exc\_info[2]) |
|  |  | else: |
|  |  | empty\_files = [f for f in self.files if f.emptystream] |
|  |  | self.extract\_single(fp, empty\_files, 0, 0, q) |
|  |  | self.extract\_single(fp, empty\_files, path, 0, 0, q) |
|  |  |  |
|  |  | def extract\_single( |
|  |  | self, |
|  |  | fp: Union[BinaryIO, str], |
|  |  | files, |
|  |  | path, |
|  |  | src\_start: int, |
|  |  | src\_end: int, |
|  |  | q: Optional[queue.Queue], |
| Expand All | | @@ -1287,7 +1282,7 @@ def extract\_single( |
|  |  | if isinstance(fp, str): |
|  |  | fp = open(fp, "rb") |
|  |  | fp.seek(src\_start) |
|  |  | self.\_extract\_single(fp, files, src\_end, q, skip\_notarget) |
|  |  | self.\_extract\_single(fp, files, path, src\_end, q, skip\_notarget) |
|  |  | except Exception as e: |
|  |  | if exc\_q is None: |
|  |  | raise e |
| Expand All | | @@ -1299,6 +1294,7 @@ def \_extract\_single( |
|  |  | self, |
|  |  | fp: BinaryIO, |
|  |  | files, |
|  |  | path, |
|  |  | src\_end: int, |
|  |  | q: Optional[queue.Queue], |
|  |  | skip\_notarget=True, |
| Expand Down  Expand Up | | @@ -1331,20 +1327,28 @@ def \_extract\_single( |
|  |  | with io.BytesIO() as ofp: |
|  |  | self.decompress(fp, f.folder, ofp, f.uncompressed, f.compressed, src\_end) |
|  |  | dst: str = ofp.read().decode("utf-8") |
|  |  | # fileish.unlink(missing\_ok=True) > py3.7 |
|  |  | if fileish.exists(): |
|  |  | fileish.unlink() |
|  |  | if sys.platform == "win32": # hint for mypy |
|  |  | \_winapi.CreateJunction(str(fileish), dst) # noqa |
|  |  | if is\_target\_path\_valid(path, fileish.parent.joinpath(dst)): |
|  |  | # fileish.unlink(missing\_ok=True) > py3.7 |
|  |  | if fileish.exists(): |
|  |  | fileish.unlink() |
|  |  | if sys.platform == "win32": # hint for mypy |
|  |  | \_winapi.CreateJunction(str(fileish), dst) # noqa |
|  |  | else: |
|  |  | raise Bad7zFile("Junction point out of target directory.") |
|  |  | elif f.is\_symlink and not isinstance(fileish, MemIO): |
|  |  | with io.BytesIO() as omfp: |
|  |  | self.decompress(fp, f.folder, omfp, f.uncompressed, f.compressed, src\_end) |
|  |  | omfp.seek(0) |
|  |  | sym\_target = pathlib.Path(omfp.read().decode("utf-8")) |
|  |  | # fileish.unlink(missing\_ok=True) > py3.7 |
|  |  | if fileish.exists(): |
|  |  | fileish.unlink() |
|  |  | fileish.symlink\_to(sym\_target) |
|  |  | dst = omfp.read().decode("utf-8") |
|  |  | # check sym\_target points inside an archive target? |
|  |  | if is\_target\_path\_valid(path, fileish.parent.joinpath(dst)): |
|  |  | sym\_target = pathlib.Path(dst) |
|  |  | # fileish.unlink(missing\_ok=True) > py3.7 |
|  |  | if fileish.exists(): |
|  |  | fileish.unlink() |
|  |  | fileish.symlink\_to(sym\_target) |
|  |  | else: |
|  |  | raise Bad7zFile("Symlink point out of target directory.") |
|  |  | else: |
|  |  | with fileish.open(mode="wb") as obfp: |
|  |  | crc32 = self.decompress(fp, f.folder, obfp, f.uncompressed, f.compressed, src\_end) |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[tests/test\_extract.py](#diff-24ff2537b4f0f0e2917e279686bf69fb986c20223430905764ef2f6a0e53a975 "tests/test_extract.py")

Show comments

[View file](/miurahr/py7zr/blob/1bb43f17515c7f69673a1c88ab9cc72a7bbef406/tests/test_extract.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -332,7 +332,7 @@ def test\_skip(): |
|  |  | for i, cf in enumerate(archive.files): |
|  |  | assert cf is not None |
|  |  | archive.worker.register\_filelike(cf.id, None) |
|  |  | archive.worker.extract(archive.fp, parallel=True) |
|  |  | archive.worker.extract(archive.fp, None, parallel=True) |
|  |  | archive.close() |
|  |  |  |
|  |  |  |
| Expand Down | |  |

48 changes: 48 additions & 0 deletions

48
[tests/test\_zipslip.py](#diff-de0e3585e7baeec87d985b94a69e55ade02042655675016179bb1c6bae157c7e "tests/test_zipslip.py")

Show comments

[View file](/miurahr/py7zr/blob/1bb43f17515c7f69673a1c88ab9cc72a7bbef406/tests/test_zipslip.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,48 @@ |
|  |  | import os |
|  |  |  |
|  |  | import pytest |
|  |  |  |
|  |  | from py7zr import SevenZipFile |
|  |  | from py7zr.exceptions import Bad7zFile |
|  |  | from py7zr.helpers import check\_archive\_path, get\_sanitized\_output\_path |
|  |  | from py7zr.properties import FILTER\_LZMA2, PRESET\_DEFAULT |
|  |  |  |
|  |  | testdata\_path = os.path.join(os.path.dirname(\_\_file\_\_), "data") |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.misc |
|  |  | def test\_check\_archive\_path(): |
|  |  | bad\_path = "../../.../../../../../../tmp/evil.sh" |
|  |  | assert not check\_archive\_path(bad\_path) |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.misc |
|  |  | def test\_get\_sanitized\_output\_path\_1(tmp\_path): |
|  |  | bad\_path = "../../.../../../../../../tmp/evil.sh" |
|  |  | with pytest.raises(Bad7zFile): |
|  |  | get\_sanitized\_output\_path(bad\_path, tmp\_path) |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.misc |
|  |  | def test\_get\_sanitized\_output\_path\_2(tmp\_path): |
|  |  | good\_path = "good.sh" |
|  |  | expected = tmp\_path.joinpath(good\_path) |
|  |  | assert expected == get\_sanitized\_output\_path(good\_path, tmp\_path) |
|  |  |  |
|  |  |  |
|  |  | @pytest.mark.misc |
|  |  | def test\_extract\_path\_traversal\_attack(tmp\_path): |
|  |  | my\_filters = [ |
|  |  | {"id": FILTER\_LZMA2, "preset": PRESET\_DEFAULT}, |
|  |  | ] |
|  |  | target = tmp\_path.joinpath("target.7z") |
|  |  | good\_data = b"#!/bin/sh\necho good\n" |
|  |  | good\_path = "good.sh" |
|  |  | bad\_data = b"!#/bin/sh\necho bad\n" |
|  |  | bad\_path = "../../.../../../../../../tmp/evil.sh" |
|  |  | with SevenZipFile(target, "w", filters=my\_filters) as archive: |
|  |  | archive.writestr(good\_data, good\_path) |
|  |  | archive.\_writestr(bad\_data, bad\_path) # bypass a path check |
|  |  | with pytest.raises(Bad7zFile): |
|  |  | with SevenZipFile(target, "r") as archive: |
|  |  | archive.extractall(path=tmp\_path) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1bb43f1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiurahr%2Fpy7zr%2Fcommit%2F1bb43f17515c7f69673a1c88ab9cc72a7bbef406) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


