=== Content from github.com_5b400de0_20250114_183202.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fcommit%2Ff3a8f88167d55caa2f78aeb72d4dc1987a9ed62d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fcommit%2Ff3a8f88167d55caa2f78aeb72d4dc1987a9ed62d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=aws%2Fefs-utils)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[aws](/aws)
/
**[efs-utils](/aws/efs-utils)**
Public

* [Notifications](/login?return_to=%2Faws%2Fefs-utils) You must be signed in to change notification settings
* [Fork
  196](/login?return_to=%2Faws%2Fefs-utils)
* [Star
   307](/login?return_to=%2Faws%2Fefs-utils)

* [Code](/aws/efs-utils)
* [Issues
  42](/aws/efs-utils/issues)
* [Pull requests
  9](/aws/efs-utils/pulls)
* [Actions](/aws/efs-utils/actions)
* [Projects
  0](/aws/efs-utils/projects)
* [Security](/aws/efs-utils/security)
* [Insights](/aws/efs-utils/pulse)

Additional navigation options

* [Code](/aws/efs-utils)
* [Issues](/aws/efs-utils/issues)
* [Pull requests](/aws/efs-utils/pulls)
* [Actions](/aws/efs-utils/actions)
* [Projects](/aws/efs-utils/projects)
* [Security](/aws/efs-utils/security)
* [Insights](/aws/efs-utils/pulse)

## Commit

[Permalink](/aws/efs-utils/commit/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix potential tlsport selection collision by using state file as

[Browse files](/aws/efs-utils/tree/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d)
Browse the repository at this point in the history

```
tlsport lock file

This removes all potential concurrency issues during tls port selection
and ensures that concurrent mounts will never select the same port.
```

* Loading branch information

[![@RyanStan](https://avatars.githubusercontent.com/u/31710983?s=40&v=4)](/RyanStan)

[RyanStan](/aws/efs-utils/commits?author=RyanStan "View all commits by RyanStan")
committed
Dec 14, 2022

1 parent
[d504305](/aws/efs-utils/commit/d504305340e54c4e82723530ae038c6ff6a3dfd5)

commit f3a8f88

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**130 additions**
and
**34 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* amazon-efs-utils.spec
  [amazon-efs-utils.spec](#diff-cd7c7b39792d1e7e718d51ce61270222e7216417833baba7efef7a716be6bd54)
* build-deb.sh
  [build-deb.sh](#diff-32232255c853cafcf7c82885e6bb22f09671c055b48f43543e408448712ee7d7)
* config.ini
  [config.ini](#diff-0795adfe01df662f6a34b421a29ee3c5f05389a705da6a791126c6f916701da7)
* dist

  + dist/amazon-efs-utils.control
    [amazon-efs-utils.control](#diff-1687059f0af508e3c23a77fa48d62932a7f1eab150da5c221dc349471cc9193a)
* src

  + mount\_efs

    - src/mount\_efs/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-ebc2f4cb2a27f555929aab44a3f15be40decdc0432e7ffa6b7e6a588354c166b)
  + watchdog

    - src/watchdog/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-0955d4a3f9d03f58aafc10b4617c70d0dbc2aba7a412ae2f37e6f7a8e953ea7e)
* test/mount\_efs\_test

  + test/mount\_efs\_test/test\_bootstrap\_tls.py
    [test\_bootstrap\_tls.py](#diff-4b5e88021276a3f066bda7c640bb855d8f678508938616f3fb55174435ba878c)
  + test/mount\_efs\_test/test\_choose\_tls\_port.py
    [test\_choose\_tls\_port.py](#diff-f8442fcfa701da0d11199d187f53335a59768c7521f5ae7d9beac08d7f96b9e9)

## There are no files selected for viewing

5 changes: 4 additions & 1 deletion

5
[amazon-efs-utils.spec](#diff-cd7c7b39792d1e7e718d51ce61270222e7216417833baba7efef7a716be6bd54 "amazon-efs-utils.spec")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/amazon-efs-utils.spec)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -35,7 +35,7 @@ |
|  |  | %endif |
|  |  |  |
|  |  | Name : amazon-efs-utils |
|  |  | Version : 1.34.3 |
|  |  | Version : 1.34.4 |
|  |  | Release : 1%{platform} |
|  |  | Summary : This package provides utilities for simplifying the use of EFS file systems |
|  |  |  |
| Expand Down  Expand Up | | @@ -137,6 +137,9 @@ fi |
|  |  | %clean |
|  |  |  |
|  |  | %changelog |
|  |  | \* Tue Dec 13 2022 Ryan Stankiewicz <rjstank@amazon.com> - 1.34.4 |
|  |  | - Fix potential tlsport selection collision by using state file as tlsport lock file. |
|  |  |  |
|  |  | \* Thu Dec 1 2022 Preetham Puneeth Munipalli <tmunipre@amazon.com> - 1.34.3 |
|  |  | - Fix potential tlsport selection race condition by closing socket right before establishing stunnel |
|  |  | - Fix stunnel constantly restart issue when upgrading from 1.32.1 and before version to latest version |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[build-deb.sh](#diff-32232255c853cafcf7c82885e6bb22f09671c055b48f43543e408448712ee7d7 "build-deb.sh")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/build-deb.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,7 @@ set -ex |
|  |  |  |
|  |  | BASE\_DIR=$(pwd) |
|  |  | BUILD\_ROOT=${BASE\_DIR}/build/debbuild |
|  |  | VERSION=1.34.3 |
|  |  | VERSION=1.34.4 |
|  |  | RELEASE=1 |
|  |  | DEB\_SYSTEM\_RELEASE\_PATH=/etc/os-release |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[config.ini](#diff-0795adfe01df662f6a34b421a29ee3c5f05389a705da6a791126c6f916701da7 "config.ini")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/config.ini)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,5 +7,5 @@ |
|  |  | # |
|  |  |  |
|  |  | [global] |
|  |  | version=1.34.3 |
|  |  | version=1.34.4 |
|  |  | release=1 |

2 changes: 1 addition & 1 deletion

2
[dist/amazon-efs-utils.control](#diff-1687059f0af508e3c23a77fa48d62932a7f1eab150da5c221dc349471cc9193a "dist/amazon-efs-utils.control")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/dist/amazon-efs-utils.control)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,6 @@ |
|  |  | Package: amazon-efs-utils |
|  |  | Architecture: all |
|  |  | Version: 1.34.3 |
|  |  | Version: 1.34.4 |
|  |  | Section: utils |
|  |  | Depends: python3, nfs-common, stunnel4 (>= 4.56), openssl (>= 1.0.2), util-linux |
|  |  | Priority: optional |
| Expand Down | |  |

83 changes: 67 additions & 16 deletions

83
[src/mount\_efs/\_\_init\_\_.py](#diff-ebc2f4cb2a27f555929aab44a3f15be40decdc0432e7ffa6b7e6a588354c166b "src/mount_efs/__init__.py")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/src/mount_efs/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -85,7 +85,7 @@ |
|  |  | BOTOCORE\_PRESENT = False |
|  |  |  |
|  |  |  |
|  |  | VERSION = "1.34.3" |
|  |  | VERSION = "1.34.4" |
|  |  | SERVICE = "elasticfilesystem" |
|  |  |  |
|  |  | AMAZON\_LINUX\_2\_RELEASE\_ID = "Amazon Linux release 2 (Karoo)" |
| Expand Down  Expand Up | | @@ -939,7 +939,7 @@ def get\_tls\_port\_range(config): |
|  |  | return lower\_bound, upper\_bound |
|  |  |  |
|  |  |  |
|  |  | def choose\_tls\_port\_and\_get\_bind\_sock(config, options): |
|  |  | def choose\_tls\_port\_and\_get\_bind\_sock(config, options, state\_file\_dir): |
|  |  | if "tlsport" in options: |
|  |  | ports\_to\_try = [int(options["tlsport"])] |
|  |  | else: |
| Expand All | | @@ -951,10 +951,14 @@ def choose\_tls\_port\_and\_get\_bind\_sock(config, options): |
|  |  | random.shuffle(ports\_to\_try) |
|  |  |  |
|  |  | if "netns" not in options: |
|  |  | tls\_port\_sock = find\_tls\_port\_in\_range\_and\_get\_bind\_sock(ports\_to\_try) |
|  |  | tls\_port\_sock = find\_tls\_port\_in\_range\_and\_get\_bind\_sock( |
|  |  | ports\_to\_try, state\_file\_dir |
|  |  | ) |
|  |  | else: |
|  |  | with NetNS(nspath=options["netns"]): |
|  |  | tls\_port\_sock = find\_tls\_port\_in\_range\_and\_get\_bind\_sock(ports\_to\_try) |
|  |  | tls\_port\_sock = find\_tls\_port\_in\_range\_and\_get\_bind\_sock( |
|  |  | ports\_to\_try, state\_file\_dir |
|  |  | ) |
|  |  |  |
|  |  | if tls\_port\_sock: |
|  |  | return tls\_port\_sock |
| Expand All | | @@ -971,20 +975,44 @@ def choose\_tls\_port\_and\_get\_bind\_sock(config, options): |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | def find\_tls\_port\_in\_range\_and\_get\_bind\_sock(ports\_to\_try): |
|  |  | def find\_tls\_port\_in\_range\_and\_get\_bind\_sock(ports\_to\_try, state\_file\_dir): |
|  |  | sock = socket.socket() |
|  |  | for tls\_port in ports\_to\_try: |
|  |  | mount = find\_existing\_mount\_using\_tls\_port(state\_file\_dir, tls\_port) |
|  |  | if mount: |
|  |  | logging.debug( |
|  |  | "Skip binding TLS port %s as it is already assigned to %s", |
|  |  | tls\_port, |
|  |  | mount, |
|  |  | ) |
|  |  | continue |
|  |  | try: |
|  |  | logging.info("binding %s", tls\_port) |
|  |  | sock.bind(("localhost", tls\_port)) |
|  |  | return sock |
|  |  | except socket.error as e: |
|  |  | logging.info(e) |
|  |  | logging.warning(e) |
|  |  | continue |
|  |  | sock.close() |
|  |  | return None |
|  |  |  |
|  |  |  |
|  |  | def find\_existing\_mount\_using\_tls\_port(state\_file\_dir, tls\_port): |
|  |  | if not os.path.exists(state\_file\_dir): |
|  |  | logging.debug( |
|  |  | "State file dir %s does not exist, assuming no existing mount using tls port %s", |
|  |  | state\_file\_dir, |
|  |  | tls\_port, |
|  |  | ) |
|  |  | return None |
|  |  |  |
|  |  | for fname in os.listdir(state\_file\_dir): |
|  |  | if fname.endswith(".%s" % tls\_port): |
|  |  | return fname |
|  |  |  |
|  |  | return None |
|  |  |  |
|  |  |  |
|  |  | def is\_ocsp\_enabled(config, options): |
|  |  | if "ocsp" in options: |
|  |  | return True |
| Expand Down  Expand Up | | @@ -1301,6 +1329,24 @@ def write\_tls\_tunnel\_state\_file( |
|  |  | return state\_file |
|  |  |  |
|  |  |  |
|  |  | def rewrite\_tls\_tunnel\_state\_file(state, state\_file\_dir, state\_file): |
|  |  | with open(os.path.join(state\_file\_dir, state\_file), "w") as f: |
|  |  | json.dump(state, f) |
|  |  | return state\_file |
|  |  |  |
|  |  |  |
|  |  | def update\_tls\_tunnel\_temp\_state\_file\_with\_tunnel\_pid( |
|  |  | temp\_tls\_state\_file, state\_file\_dir, stunnel\_pid |
|  |  | ): |
|  |  | with open(os.path.join(state\_file\_dir, temp\_tls\_state\_file), "r") as f: |
|  |  | state = json.load(f) |
|  |  | state["pid"] = stunnel\_pid |
|  |  | temp\_tls\_state\_file = rewrite\_tls\_tunnel\_state\_file( |
|  |  | state, state\_file\_dir, temp\_tls\_state\_file |
|  |  | ) |
|  |  | return temp\_tls\_state\_file |
|  |  |  |
|  |  |  |
|  |  | def test\_tunnel\_process(tunnel\_proc, fs\_id): |
|  |  | tunnel\_proc.poll() |
|  |  | if tunnel\_proc.returncode is not None: |
| Expand Down  Expand Up | | @@ -1478,7 +1524,7 @@ def bootstrap\_tls( |
|  |  | state\_file\_dir=STATE\_FILE\_DIR, |
|  |  | fallback\_ip\_address=None, |
|  |  | ): |
|  |  | tls\_port\_sock = choose\_tls\_port\_and\_get\_bind\_sock(config, options) |
|  |  | tls\_port\_sock = choose\_tls\_port\_and\_get\_bind\_sock(config, options, state\_file\_dir) |
|  |  | tls\_port = get\_tls\_port\_from\_sock(tls\_port\_sock) |
|  |  |  |
|  |  | try: |
| Expand Down  Expand Up | | @@ -1560,6 +1606,18 @@ def bootstrap\_tls( |
|  |  | tunnel\_args = [\_stunnel\_bin(), stunnel\_config\_file] |
|  |  | if "netns" in options: |
|  |  | tunnel\_args = ["nsenter", "--net=" + options["netns"]] + tunnel\_args |
|  |  |  |
|  |  | # This temp state file is acting like a tlsport lock file, which is why pid =- 1 |
|  |  | temp\_tls\_state\_file = write\_tls\_tunnel\_state\_file( |
|  |  | fs\_id, |
|  |  | mountpoint, |
|  |  | tls\_port, |
|  |  | -1, |
|  |  | tunnel\_args, |
|  |  | [stunnel\_config\_file], |
|  |  | state\_file\_dir, |
|  |  | cert\_details=cert\_details, |
|  |  | ) |
|  |  | finally: |
|  |  | # Always close the socket we created when choosing TLS port only until now to |
|  |  | # 1. avoid concurrent TLS mount port collision 2. enable stunnel process to bind the port |
| Expand All | | @@ -1577,15 +1635,8 @@ def bootstrap\_tls( |
|  |  | ) |
|  |  | logging.info("Started TLS tunnel, pid: %d", tunnel\_proc.pid) |
|  |  |  |
|  |  | temp\_tls\_state\_file = write\_tls\_tunnel\_state\_file( |
|  |  | fs\_id, |
|  |  | mountpoint, |
|  |  | tls\_port, |
|  |  | tunnel\_proc.pid, |
|  |  | tunnel\_args, |
|  |  | [stunnel\_config\_file], |
|  |  | state\_file\_dir, |
|  |  | cert\_details=cert\_details, |
|  |  | update\_tls\_tunnel\_temp\_state\_file\_with\_tunnel\_pid( |
|  |  | temp\_tls\_state\_file, state\_file\_dir, tunnel\_proc.pid |
|  |  | ) |
|  |  |  |
|  |  | if "netns" not in options: |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/watchdog/\_\_init\_\_.py](#diff-0955d4a3f9d03f58aafc10b4617c70d0dbc2aba7a412ae2f37e6f7a8e953ea7e "src/watchdog/__init__.py")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/src/watchdog/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -56,7 +56,7 @@ |
|  |  | AMAZON\_LINUX\_2\_RELEASE\_ID, |
|  |  | AMAZON\_LINUX\_2\_PRETTY\_NAME, |
|  |  | ] |
|  |  | VERSION = "1.34.3" |
|  |  | VERSION = "1.34.4" |
|  |  | SERVICE = "elasticfilesystem" |
|  |  |  |
|  |  | CONFIG\_FILE = "/etc/amazon/efs/efs-utils.conf" |
| Expand Down | |  |

9 changes: 9 additions & 0 deletions

9
[test/mount\_efs\_test/test\_bootstrap\_tls.py](#diff-4b5e88021276a3f066bda7c640bb855d8f678508938616f3fb55174435ba878c "test/mount_efs_test/test_bootstrap_tls.py")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/test/mount_efs_test/test_bootstrap_tls.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -44,6 +44,10 @@ def setup\_mocks(mocker): |
|  |  | mocker.patch("mount\_efs.create\_certificate") |
|  |  | mocker.patch("os.rename") |
|  |  | mocker.patch("os.kill") |
|  |  | mocker.patch( |
|  |  | "mount\_efs.update\_tls\_tunnel\_temp\_state\_file\_with\_tunnel\_pid", |
|  |  | return\_value="~mocktempfile", |
|  |  | ) |
|  |  |  |
|  |  | process\_mock = MagicMock() |
|  |  | process\_mock.communicate.return\_value = ( |
| Expand Down  Expand Up | | @@ -72,6 +76,10 @@ def setup\_mocks\_without\_popen(mocker): |
|  |  | ) |
|  |  | mocker.patch("mount\_efs.write\_tls\_tunnel\_state\_file", return\_value="~mocktempfile") |
|  |  | mocker.patch("os.kill") |
|  |  | mocker.patch( |
|  |  | "mount\_efs.update\_tls\_tunnel\_temp\_state\_file\_with\_tunnel\_pid", |
|  |  | return\_value="~mocktempfile", |
|  |  | ) |
|  |  |  |
|  |  | write\_config\_mock = mocker.patch( |
|  |  | "mount\_efs.write\_stunnel\_config\_file", return\_value=EXPECTED\_STUNNEL\_CONFIG\_FILE |
| Expand Down  Expand Up | | @@ -115,6 +123,7 @@ def config\_get\_side\_effect(section, field): |
|  |  | assert not os.path.exists(state\_file\_dir) |
|  |  |  |
|  |  | mocker.patch("mount\_efs.\_stunnel\_bin", return\_value="/usr/bin/stunnel") |
|  |  | mocker.patch("mount\_efs.find\_existing\_mount\_using\_tls\_port", return\_value=None) |
|  |  | with mount\_efs.bootstrap\_tls( |
|  |  | MOCK\_CONFIG, INIT\_SYSTEM, DNS\_NAME, FS\_ID, MOUNT\_POINT, {}, state\_file\_dir |
|  |  | ): |
| Expand Down | |  |

59 changes: 46 additions & 13 deletions

59
[test/mount\_efs\_test/test\_choose\_tls\_port.py](#diff-f8442fcfa701da0d11199d187f53335a59768c7521f5ae7d9beac08d7f96b9e9 "test/mount_efs_test/test_choose_tls_port.py")

Show comments

[View file](/aws/efs-utils/blob/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d/test/mount_efs_test/test_choose_tls_port.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,9 +3,12 @@ |
|  |  | # Licensed under the MIT License. See the LICENSE accompanying this file |
|  |  | # for the specific language governing permissions and limitations under |
|  |  | # the License. |
|  |  |  |
|  |  | import logging |
|  |  | import random |
|  |  | import socket |
|  |  | import sys |
|  |  | import tempfile |
|  |  | import unittest |
|  |  | from unittest.mock import MagicMock |
|  |  |  |
|  |  | import pytest |
| Expand Down  Expand Up | | @@ -45,42 +48,70 @@ def \_get\_config(): |
|  |  | return config |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_first\_try(mocker): |
|  |  | def test\_choose\_tls\_port\_first\_try(mocker, tmpdir): |
|  |  | sock\_mock = MagicMock() |
|  |  | sock\_mock.getsockname.return\_value = ("local\_host", DEFAULT\_TLS\_PORT) |
|  |  | mocker.patch("socket.socket", return\_value=sock\_mock) |
|  |  | options = {} |
|  |  |  |
|  |  | tls\_port\_sock = mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options) |
|  |  | tls\_port\_sock = mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock( |
|  |  | \_get\_config(), options, str(tmpdir) |
|  |  | ) |
|  |  | tls\_port = mount\_efs.get\_tls\_port\_from\_sock(tls\_port\_sock) |
|  |  | assert DEFAULT\_TLS\_PORT\_RANGE\_LOW <= tls\_port <= DEFAULT\_TLS\_PORT\_RANGE\_HIGH |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_second\_try(mocker): |
|  |  | def test\_choose\_tls\_port\_second\_try(mocker, tmpdir): |
|  |  | bad\_sock = MagicMock() |
|  |  | bad\_sock.bind.side\_effect = [socket.error, None] |
|  |  | bad\_sock.getsockname.return\_value = ("local\_host", DEFAULT\_TLS\_PORT) |
|  |  | options = {} |
|  |  |  |
|  |  | mocker.patch("socket.socket", return\_value=bad\_sock) |
|  |  |  |
|  |  | tls\_port\_sock = mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options) |
|  |  | tls\_port\_sock = mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock( |
|  |  | \_get\_config(), options, str(tmpdir) |
|  |  | ) |
|  |  | tls\_port = mount\_efs.get\_tls\_port\_from\_sock(tls\_port\_sock) |
|  |  |  |
|  |  | assert DEFAULT\_TLS\_PORT\_RANGE\_LOW <= tls\_port <= DEFAULT\_TLS\_PORT\_RANGE\_HIGH |
|  |  | assert 2 == bad\_sock.bind.call\_count |
|  |  | assert 1 == bad\_sock.getsockname.call\_count |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_never\_succeeds(mocker, capsys): |
|  |  | @unittest.skipIf(sys.version\_info < (3, 6), reason="requires python3.6") |
|  |  | def test\_choose\_tls\_port\_collision(mocker, tmpdir, caplog): |
|  |  | """Ensure we don't choose a port that is pending mount""" |
|  |  | sock = MagicMock() |
|  |  | mocker.patch("socket.socket", return\_value=sock) |
|  |  | mocker.patch( |
|  |  | "random.shuffle", |
|  |  | return\_value=range(DEFAULT\_TLS\_PORT\_RANGE\_LOW, DEFAULT\_TLS\_PORT\_RANGE\_HIGH), |
|  |  | ) |
|  |  |  |
|  |  | port\_suffix = ".%s" % str(DEFAULT\_TLS\_PORT\_RANGE\_LOW) |
|  |  | temp\_state\_file = tempfile.NamedTemporaryFile( |
|  |  | suffix=port\_suffix, prefix="~", dir=tmpdir |
|  |  | ) |
|  |  |  |
|  |  | options = {} |
|  |  | with caplog.at\_level(logging.DEBUG): |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options, tmpdir) |
|  |  |  |
|  |  | temp\_state\_file.close() |
|  |  | sock.bind.assert\_called\_once\_with(("localhost", DEFAULT\_TLS\_PORT\_RANGE\_LOW + 1)) |
|  |  | assert "Skip binding TLS port" in caplog.text |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_never\_succeeds(mocker, tmpdir, capsys): |
|  |  | bad\_sock = MagicMock() |
|  |  | bad\_sock.bind.side\_effect = socket.error() |
|  |  | options = {} |
|  |  |  |
|  |  | mocker.patch("socket.socket", return\_value=bad\_sock) |
|  |  |  |
|  |  | with pytest.raises(SystemExit) as ex: |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options) |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options, str(tmpdir)) |
|  |  |  |
|  |  | assert 0 != ex.value.code |
|  |  |  |
| Expand All | | @@ -93,27 +124,29 @@ def test\_choose\_tls\_port\_never\_succeeds(mocker, capsys): |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_option\_specified(mocker): |
|  |  | def test\_choose\_tls\_port\_option\_specified(mocker, tmpdir): |
|  |  | sock\_mock = MagicMock() |
|  |  | sock\_mock.getsockname.return\_value = ("local\_host", DEFAULT\_TLS\_PORT) |
|  |  | mocker.patch("socket.socket", return\_value=sock\_mock) |
|  |  | options = {"tlsport": DEFAULT\_TLS\_PORT} |
|  |  |  |
|  |  | tls\_port\_sock = mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options) |
|  |  | tls\_port\_sock = mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock( |
|  |  | \_get\_config(), options, str(tmpdir) |
|  |  | ) |
|  |  | tls\_port = mount\_efs.get\_tls\_port\_from\_sock(tls\_port\_sock) |
|  |  |  |
|  |  | assert DEFAULT\_TLS\_PORT == tls\_port |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_option\_specified\_unavailable(mocker, capsys): |
|  |  | def test\_choose\_tls\_port\_option\_specified\_unavailable(mocker, tmpdir, capsys): |
|  |  | bad\_sock = MagicMock() |
|  |  | bad\_sock.bind.side\_effect = socket.error() |
|  |  | options = {"tlsport": 1000} |
|  |  |  |
|  |  | mocker.patch("socket.socket", return\_value=bad\_sock) |
|  |  |  |
|  |  | with pytest.raises(SystemExit) as ex: |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options) |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options, str(tmpdir)) |
|  |  |  |
|  |  | assert 0 != ex.value.code |
|  |  |  |
| Expand All | | @@ -123,13 +156,13 @@ def test\_choose\_tls\_port\_option\_specified\_unavailable(mocker, capsys): |
|  |  | assert 1 == bad\_sock.bind.call\_count |
|  |  |  |
|  |  |  |
|  |  | def test\_choose\_tls\_port\_under\_netns(mocker, capsys): |
|  |  | def test\_choose\_tls\_port\_under\_netns(mocker, tmpdir): |
|  |  | mocker.patch("builtins.open") |
|  |  | setns\_mock = mocker.patch("mount\_efs.setns", return\_value=(None, None)) |
|  |  | mocker.patch("socket.socket", return\_value=MagicMock()) |
|  |  | options = {"netns": "/proc/1000/ns/net"} |
|  |  |  |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options) |
|  |  | mount\_efs.choose\_tls\_port\_and\_get\_bind\_sock(\_get\_config(), options, str(tmpdir)) |
|  |  | utils.assert\_called(setns\_mock) |
|  |  |  |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f3a8f88`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fcommit%2Ff3a8f88167d55caa2f78aeb72d4dc1987a9ed62d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ca465035_20250114_183203.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fissues%2F125)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fissues%2F125)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=aws%2Fefs-utils)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[aws](/aws)
/
**[efs-utils](/aws/efs-utils)**
Public

* [Notifications](/login?return_to=%2Faws%2Fefs-utils) You must be signed in to change notification settings
* [Fork
  196](/login?return_to=%2Faws%2Fefs-utils)
* [Star
   307](/login?return_to=%2Faws%2Fefs-utils)

* [Code](/aws/efs-utils)
* [Issues
  42](/aws/efs-utils/issues)
* [Pull requests
  9](/aws/efs-utils/pulls)
* [Actions](/aws/efs-utils/actions)
* [Projects
  0](/aws/efs-utils/projects)
* [Security](/aws/efs-utils/security)
* [Insights](/aws/efs-utils/pulse)

Additional navigation options

* [Code](/aws/efs-utils)
* [Issues](/aws/efs-utils/issues)
* [Pull requests](/aws/efs-utils/pulls)
* [Actions](/aws/efs-utils/actions)
* [Projects](/aws/efs-utils/projects)
* [Security](/aws/efs-utils/security)
* [Insights](/aws/efs-utils/pulse)

# Mounting several volumes at once fails very frequently #125

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Mounting several volumes at once fails very frequently](#top)#125Copy link![@tsmetana](https://avatars.githubusercontent.com/u/4759699?v=4&size=80)
## Description

![@tsmetana](https://avatars.githubusercontent.com/u/4759699?v=4&size=48)[tsmetana](https://github.com/tsmetana)opened [on Mar 23, 2022](https://github.com/aws/efs-utils/issues/125#issue-1178072087)

We're encountering problems when trying to mount multiple EFS volumes at once. The mount process gets stuck, when trying to debug RPC there are occassional `nfs: server 127.0.0.1 not responding, timed out` errors in the log (not sure if those are related -- the mount.efs should retry AFAIK). The stunnel processes serving the mount RPC connections seem to be just waiting for for connection but nothing happens.

This problem has been observed only with Centos 8 (or Centos Streams 8) running stunnel-5.56-5.el8\_3 and openssl-libs-1.1.1k-5.el8\_5. When trying Amazon Linux 2 with stunnel-4.56-6.amzn2.0.3 and openssl-libs-1.0.2k-19.amzn2.2.0.10 everything works OK. I suspected this is a race in stunnel, so I've tried to recompile stunnel-5.56-5 and install it on Amazon Linux 2 but the issue is again not reproducible, so it's not stunnel (or not stunnel itself).

The issue seems to be also quite timing-sensitive. Increasing log level or changing stunnel options seems to have effect on probability of the problem to show. I've tried to remove PID file creation (since the issue [#112](https://github.com/aws/efs-utils/issues/112) looked quite similar) but it doesn't seem to help -- I can still see the pending mounts. I also suspected the issue [#105](https://github.com/aws/efs-utils/issues/105), but even if I fixed that (I hope -- PR [#119](https://github.com/aws/efs-utils/pull/119)) the mounts still get stuck.

I wonder if the problem in issue [#114](https://github.com/aws/efs-utils/issues/114) is related: we're mostly encountering this problem through efs-csi-driver on kubernetes clusters when creating and removing multiple EFS volumes in the cluster in one shot.

I'm curious if somebody had more insight or encountered the problem: it looks like it's the combination of multiple factors that cause this and I failed to find any interesting debugging clues.

## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d996f18a_20250114_183204.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fsecurity%2Fadvisories%2FGHSA-4fv8-w65m-3932)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Faws%2Fefs-utils%2Fsecurity%2Fadvisories%2FGHSA-4fv8-w65m-3932)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=aws%2Fefs-utils)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[aws](/aws)
/
**[efs-utils](/aws/efs-utils)**
Public

* [Notifications](/login?return_to=%2Faws%2Fefs-utils) You must be signed in to change notification settings
* [Fork
  196](/login?return_to=%2Faws%2Fefs-utils)
* [Star
   307](/login?return_to=%2Faws%2Fefs-utils)

* [Code](/aws/efs-utils)
* [Issues
  42](/aws/efs-utils/issues)
* [Pull requests
  9](/aws/efs-utils/pulls)
* [Actions](/aws/efs-utils/actions)
* [Projects
  0](/aws/efs-utils/projects)
* [Security](/aws/efs-utils/security)
* [Insights](/aws/efs-utils/pulse)

Additional navigation options

* [Code](/aws/efs-utils)
* [Issues](/aws/efs-utils/issues)
* [Pull requests](/aws/efs-utils/pulls)
* [Actions](/aws/efs-utils/actions)
* [Projects](/aws/efs-utils/projects)
* [Security](/aws/efs-utils/security)
* [Insights](/aws/efs-utils/pulse)

# Race condition during concurrent TLS mounts in efs-utils and aws-efs-csi-driver

Moderate

[tijumat](/tijumat)
published
GHSA-4fv8-w65m-3932
Dec 27, 2022

## Package

gomod

aws-efs-csi-driver
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

<= v1.4.7

## Patched versions

>= v1.4.8

efs-utils
(yum)

<= v1.34.3

>= v1.34.4

## Description

### Impact

A potential race condition issue exists within the Amazon EFS mount helper in efs-utils versions v1.34.3 and below, and aws-efs-csi-driver versions v1.4.7 and below. When using TLS to mount file systems, the mount helper allocates a local port for stunnel to receive NFS connections prior to applying the TLS tunnel. In affected versions, concurrent mount operations can allocate the same local port, leading to either failed mount operations or an inappropriate mapping from an EFS customer’s local mount points to that customer’s EFS file systems.

Affected versions: efs-utils <= v1.34.3, aws-efs-csi-driver <= v1.4.7

### Patches

The patches are included in efs-utils version v1.34.4 and newer, and in aws-efs-csi-driver v1.4.8 and newer.

### Workarounds

There is no recommended work around. We recommend affected users update the installed version of efs-utils to v1.34.4+ or aws-efs-csi-driver to v1.4.8+ to address this issue.

### References

[f3a8f88](https://github.com/aws/efs-utils/commit/f3a8f88167d55caa2f78aeb72d4dc1987a9ed62d)

[#125](https://github.com/aws/efs-utils/issues/125)

[kubernetes-sigs/aws-efs-csi-driver#282](https://github.com/kubernetes-sigs/aws-efs-csi-driver/issues/282)

[kubernetes-sigs/aws-efs-csi-driver#635](https://github.com/kubernetes-sigs/aws-efs-csi-driver/issues/635)

### Severity

Moderate

### CVE ID

CVE-2022-46174

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


