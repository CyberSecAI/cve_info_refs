=== Content from gitlab.com_18235daa_20250115_101550.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-3767.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-3767.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-3767.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-3767.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Mar 04, 2023

  [7d18e94c](/gitlab-org/cves/-/commit/7d18e94cff7f8fc91916bd5f96be469128d1a8b4)
  [Publishing 0 updated advisories and 2 new advisories](/gitlab-org/cves/-/commit/7d18e94cff7f8fc91916bd5f96be469128d1a8b4)
  ·
  7d18e94c

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Mar 04, 2023

  7d18e94c

  [Publishing 0 updated advisories and 2 new advisories](/gitlab-org/cves/-/commit/7d18e94cff7f8fc91916bd5f96be469128d1a8b4)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Mar 04, 2023

Loading



=== Content from gitlab.com_e4ce8eac_20250115_101551.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Restrict sending custom request headers to allowed hosts

### Problem

DAST sends user configured custom request headers with every request, regardless of the host. This can cause the following issues:

* A request that was previously a simple CORS request becomes a preflighted request
* Scans are slower due to the extra preflighted HTTP request (one per external resource request)
* If the external host rejects the preflight request due to the additional header, it's likely the user's scan will fail (missing JavaScript, CSS, etc)
* If the external host accepts the preflight request despite the additional header, the the request header is sent to the external host. This can be a security issue, depending on what was configured in the request headers.

This only affects requests made by a browser.

### Proposal

Limit custom request headers to only be sent on `DAST_BROWSER_ALLOWED_HOSTS`. This is a breaking change.

This applies to the CI/CD variables `DAST_REQUEST_HEADERS_BASE64`, `DAST_REQUEST_HEADER` and `DAST_REQUEST_HEADERS`.

### Proof that tokens may be leaked

The following redacted log was taken from a customer scan:

```
2022-10-06T05:30:16.000 TRC CHROM event received  {"method":"Network.requestWillBeSent","params":
{"requestId":"240.6","loaderId":"4E1105698FC8652047FB127FDC470C3B","documentURL":"<redacted>","request":
{"url":"https://use.fontawesome.com/releases/v6.2.0/css/all.css","method":"GET","headers":{"Authorization":"Bearer <secret-token>",...
```

### Reference

From customer issue, see internal [Slack thread](https://gitlab.slack.com/archives/CKWJP0ZS7/p1665418791755529?thread_ts=1664406800.113639&cid=CKWJP0ZS7).

### Example

A user has a target website, that loads bootstrap JavaScript from an external CDN. A simple CORS request is made, to get the JavaScript. This is a GET HTTP request, where the response is status `200`, the resource body contains the JavaScript and there is a `Access-Control-Allow-Origin` response header.

| Page source | Network requests |
| --- | --- |
| ``` <html> <body> Hello world!  <script>   let host = "maxcdn.bootstrapcdn.com"   let url = "https://" + host + "/bootstrap/3.3.7/js/bootstrap.min.js"   fetch(url) </script> </body> </html> ``` |  |

Suppose the user adds a custom authorization token header, `DAST_REQUEST_HEADERS: "Authorization: Bearer secret.token"`. The following network requests show that an extra request is made, a preflight CORS request. In this case, `maxcdn.bootstrapcdn.com` rejects the preflight request, therefore the JavaScript is unable to load.

| Page source | Network requests |
| --- | --- |
| ``` <html> <body> Hello world!  <script>   let host = "maxcdn.bootstrapcdn.com"   let url = "https://" + host + "/bootstrap/3.3.7/js/bootstrap.min.js"   fetch(url, {headers: {"Authorization": "Bearer secret.token"}}) </script> </body> </html> ``` |  |

### Implementation plan

* Remove the call to [Network.setExtraHTTPHeaders](https://gitlab.com/gitlab-org/security-products/analyzers/browserker/-/blob/81091d53efc8d290bdd7a48c6cf8bd818624541c/scanner/browser/gcdtab.go#L159) ([DevTools](https://chromedevtools.github.io/devtools-protocol/tot/Network/#method-setExtraHTTPHeaders)), as this indiscriminately adds headers to every request made by the current browser tab (<https://gitlab.com/gitlab-org/security-products/analyzers/browserker/-/merge_requests/881/>)
* Store the custom headers and allowed hosts as new fields on the `browser.Tab` (see `Tab.Init`/`setCustomHeaders`) (<https://gitlab.com/gitlab-org/security-products/analyzers/browserker/-/merge_requests/881/>)
* The DevTools event `Fetch.requestPaused` ([DevTools](https://chromedevtools.github.io/devtools-protocol/tot/Fetch/#event-requestPaused)) is used to intercept all requests and responses. When a request is [continued](https://gitlab.com/gitlab-org/security-products/analyzers/browserker/-/blob/81091d53efc8d290bdd7a48c6cf8bd818624541c/scanner/browser/fetch_events.go#L154), add the custom headers to `ContinueRequestWithParams` if the request host is an allowed host. The headers/allowed hosts can be retrieved from the tab. (**part 1:** <https://gitlab.com/gitlab-org/security-products/analyzers/browserker/-/merge_requests/881/>, **part 2:** <https://gitlab.com/gitlab-org/security-products/analyzers/browserker/-/merge_requests/885>)
* Using an integration test, verify that extra headers are sent, but only to allowed hosts
  + `TestCookiesAreRecordedWhenNavigationIsExecuted` is a good example of such a test. More than one HTTP server could be created, so that there is more than one host. The second server could load a CSS file from the first server, emulating the problem.

Edited Oct 13, 2022 by [Philip Cunningham](/philipcunningham)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


