=== Content from gitlab.com_04a1eff7_20250115_092019.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-3483.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-3483.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-3483.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-3483.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Nov 09, 2022

  [6b92471b](/gitlab-org/cves/-/commit/6b92471bacb10077caffc5162afd936bdf116122)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/6b92471bacb10077caffc5162afd936bdf116122)
  ·
  6b92471b

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Nov 09, 2022

  6b92471b

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/6b92471bacb10077caffc5162afd936bdf116122)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Nov 09, 2022

Loading



=== Content from gitlab.com_c43d1a83_20250115_092019.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Maintainer can leak Datadog API key by changing integration URL

**[HackerOne report #1724402](https://hackerone.com/reports/1724402)** by `ryotak` on 2022-10-06, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Due to the incomplete fixes for [CVE-2022-2497](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-2497) and [CVE-2022-2882](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-2882), a malicious maintainer can still leak the API key of Datadog by changing integration URL.

##### Description

In [the patch](https://gitlab.com/gitlab-org/gitlab/-/commit/7b3ca281bce8cf8006852bc8adf303646706d543 "Merge branch 'security-protect-github-integration-secrets' into 'master'") for [CVE-2022-2882](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-2882), some fields of `Github` integration model was modified, and `exposes_secrets: true` was added to `repository_url` field.

This option enables resetting of secrets once the field is updated, which makes exfiltrating of access tokens impossible.

[`ee/app/models/integrations/github.rb` line 22-26](https://gitlab.com/gitlab-org/gitlab/-/blob/94a18e02afaa493983087287607632538a200fd3/ee/app/models/integrations/github.rb#L22-26)

```
    field :repository_url,
      title: -> { s_('GithubIntegration|Repository URL') },
      required: true,
      exposes_secrets: true,
      placeholder: 'https://github.com/owner/repository'
```

However, there are some models that are missing `exposes_secrets` option.

While most of these models are using their own method to reset the secrets (e.g. `before_validation :reset_passwowrd`), there is one exception: Datadog

[`app/models/integrations/jenkins.rb` line 30-44](https://gitlab.com/gitlab-org/gitlab/-/blob/94a18e02afaa493983087287607632538a200fd3/app/models/integrations/jenkins.rb#L30-44)

```
    before_validation :reset_password
    [...]
    def reset_password
      # don't reset the password if a new one is provided
      if (jenkins_url_changed? || username.blank?) && !password_touched?
        self.password = nil
      end
    end
```

In Datadog model, there are no validations for exposing the secrets, which allows a malicious maintainer to leak API keys by changing integration URL.

[`app/models/integrations/datadog.rb` line 25](https://gitlab.com/gitlab-org/gitlab/-/blob/94a18e02afaa493983087287607632538a200fd3/app/models/integrations/datadog.rb#L25)

```
      validates :api_url, public_url: { allow_blank: true }
```

##### Steps to reproduce

(These steps to reproduce assumes that you're using gitlab.com. If you're using a self-hosted instance, you may need to prepare a GitLab runner.)

1. Prepare 2 GitLab accounts. (Called `account A` and `account B` below)
2. Create a project with account A and upload [![.gitlab-ci.yml](data:image/gif;base64...)](https://user-content.gitlab-static.net/72c42cd58e5f86cc4a2d70dba9aecae42ad2d643/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64313336616265372d343836652d343864322d623839652d3530303464636439396635382f2e6769746c61622d63692e796d6c) to the repository.
3. In `Settings -> Integrations -> Datadog`, enable a Datadog integration and enter a new API key. (This API key can be a random string)
4. In `Project information -> Members`, invite account B with the `Maintainer` permission.
5. Login to account B, and open a project created in step 2.
6. In `Settings -> Integrations -> Datadog`, fill the `API URL` to a server that you can read the request log. (I'd recommend <https://requestbin.com/> if you need a server.)
7. Click `Test settings`.
8. Confirm the API key of Datadog is sent to the server.

If you have any troubles with these steps to reproduce, please check the video attached to this report.

##### Examples

Example repository that demonstrated the vulnerability: <https://gitlab.com/Ry0taK/maintainer-integration-leak>

As this repository is private, please let me know if you need to access this repository.

##### What is the current *bug* behavior?

Access tokens for Datadog integration are keep remaining even after changing the API URLs.

##### What is the expected *correct* behavior?

Access tokens for Datadog integration should be cleared once API URLs are changed.

##### Suggested fix

Add `exposes_secrets: true` to `api_url` of Datadog integration model.

##### Relevant logs and/or screenshots

##### Output of checks

###### Results of GitLab environment info

```
System information
System:         Ubuntu 20.04
Proxy:          no
Current User:   git
Using RVM:      no
Ruby Version:   2.7.5p203
Gem Version:    3.1.6
Bundler Version:2.3.15
Rake Version:   13.0.6
Redis Version:  6.2.7
Sidekiq Version:6.4.2
Go Version:     unknown

GitLab information
Version:        15.4.1-ee
Revision:       7b2ed8f038f
Directory:      /opt/gitlab/embedded/service/gitlab-rails
DB Adapter:     PostgreSQL
DB Version:     13.6
URL:            https://gl.ryotak.me
HTTP Clone URL: https://gl.ryotak.me/some-group/some-project.git
SSH Clone URL:  git@gl.ryotak.me:some-group/some-project.git
Elasticsearch:  no
Geo:            no
Using LDAP:     no
Using Omniauth: yes
Omniauth Providers:

GitLab Shell
Version:        14.10.0
Repository storage paths:
- default:      /var/opt/gitlab/git-data/repositories
GitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell
```

##### Impact

A malicious maintainer can leak Datadog API key, and modify/exfiltrate information on Datadog.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [.gitlab-ci.yml](https://h1.sec.gitlab.net/a/d136abe7-486e-48d2-b89e-5004dcd99f58/.gitlab-ci.yml)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Dec 06, 2022 by [Costel Maxim](/cmaxim)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


