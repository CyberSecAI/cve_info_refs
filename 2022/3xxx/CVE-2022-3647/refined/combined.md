=== Content from github.com_029169a3_20250115_082559.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Fcommit%2F0bf90d944313919eb8e63d3588bf63a367f020a3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Fcommit%2F0bf90d944313919eb8e63d3588bf63a367f020a3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=redis%2Fredis)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[redis](/redis)
/
**[redis](/redis/redis)**
Public

* [Notifications](/login?return_to=%2Fredis%2Fredis) You must be signed in to change notification settings
* [Fork
  23.9k](/login?return_to=%2Fredis%2Fredis)
* [Star
   67.7k](/login?return_to=%2Fredis%2Fredis)

* [Code](/redis/redis)
* [Issues
  2.1k](/redis/redis/issues)
* [Pull requests
  465](/redis/redis/pulls)
* [Discussions](/redis/redis/discussions)
* [Actions](/redis/redis/actions)
* [Projects
  10](/redis/redis/projects)
* [Security](/redis/redis/security)
* [Insights](/redis/redis/pulse)

Additional navigation options

* [Code](/redis/redis)
* [Issues](/redis/redis/issues)
* [Pull requests](/redis/redis/pulls)
* [Discussions](/redis/redis/discussions)
* [Actions](/redis/redis/actions)
* [Projects](/redis/redis/projects)
* [Security](/redis/redis/security)
* [Insights](/redis/redis/pulse)

## Commit

[Permalink](/redis/redis/commit/0bf90d944313919eb8e63d3588bf63a367f020a3)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid crash on crash report when a bad function pointer was called ([#…](https://github.com/redis/redis/pull/11298)

[Browse files](/redis/redis/tree/0bf90d944313919eb8e63d3588bf63a367f020a3)
Browse the repository at this point in the history

```
[…11298](https://github.com/redis/redis/pull/11298))

If Redis crashes due to calling an invalid function pointer,
the `backtrace` function will try to dereference this invalid pointer
which will cause a crash inside the crash report and will kill
the processes without having all the crash report information.

Example:

```
=== REDIS BUG REPORT START: Cut & paste starting from here ===
198672:M 19 Sep 2022 18:06:12.936 # Redis 255.255.255 crashed by signal: 11, si_code: 1
198672:M 19 Sep 2022 18:06:12.936 # Accessing address: 0x1
198672:M 19 Sep 2022 18:06:12.936 # Crashed running the instruction at: 0x1
// here the processes is crashing
```

This PR tries to fix this crash be:
1. Identify the issue when it happened.
2. Replace the invalid pointer with a pointer to some dummy function
   so that `backtrace` will not crash.

I identification is done by comparing `eip` to `info->si_addr`, if they
are the same we know that the crash happened on the same address it tries to
accesses and we can conclude that it tries to call and invalid function pointer.

To replace the invalid pointer we introduce a new function, `setMcontextEip`,
which is very similar to `getMcontextEip` and it knows to set the Eip for the
different supported OS's. After printing the trace we retrieve the old `Eip` value.
```

* Loading branch information

[![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=40&v=4)](/MeirShpilraien)

[MeirShpilraien](/redis/redis/commits?author=MeirShpilraien "View all commits by MeirShpilraien")
authored
Sep 29, 2022

1 parent
[f106bee](/redis/redis/commit/f106beebfa3e6c677aeb5933c3e1784cac36d283)

commit 0bf90d9

Showing
**1 changed file**
with
**58 additions**
and
**22 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

80 changes: 58 additions & 22 deletions

80
[src/debug.c](#diff-9450d43dd0c51c7b781f01100a2d37e9ef1903d6a16fcf51be40b03f3d8aed38 "src/debug.c")

Show comments

[View file](/redis/redis/blob/0bf90d944313919eb8e63d3588bf63a367f020a3/src/debug.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1123,73 +1123,88 @@ void bugReportStart(void) { |
|  |  | } |
|  |  |  |
|  |  | #ifdef HAVE\_BACKTRACE |
|  |  | static void \*getMcontextEip(ucontext\_t \*uc) { |
|  |  |  |
|  |  | /\* Returns the current eip and set it to the given new value (if its not NULL) \*/ |
|  |  | static void\* getAndSetMcontextEip(ucontext\_t \*uc, void \*eip) { |
|  |  | #define NOT\_SUPPORTED() do {\ |
|  |  | UNUSED(uc);\ |
|  |  | UNUSED(eip);\ |
|  |  | return NULL;\ |
|  |  | } while(0) |
|  |  | #define GET\_SET\_RETURN(target\_var, new\_val) do {\ |
|  |  | void \*old\_val = (void\*)target\_var; \ |
|  |  | if (new\_val) { \ |
|  |  | void \*\*temp = (void\*\*)&target\_var; \ |
|  |  | \*temp = new\_val; \ |
|  |  | } \ |
|  |  | return old\_val; \ |
|  |  | } while(0) |
|  |  | #if defined(\_\_APPLE\_\_) && !defined(MAC\_OS\_X\_VERSION\_10\_6) |
|  |  | /\* OSX < 10.6 \*/ |
|  |  | #if defined(\_\_x86\_64\_\_) |
|  |  | return (void\*) uc->uc\_mcontext->\_\_ss.\_\_rip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext->\_\_ss.\_\_rip, eip); |
|  |  | #elif defined(\_\_i386\_\_) |
|  |  | return (void\*) uc->uc\_mcontext->\_\_ss.\_\_eip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext->\_\_ss.\_\_eip, eip); |
|  |  | #else |
|  |  | return (void\*) uc->uc\_mcontext->\_\_ss.\_\_srr0; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext->\_\_ss.\_\_srr0, eip); |
|  |  | #endif |
|  |  | #elif defined(\_\_APPLE\_\_) && defined(MAC\_OS\_X\_VERSION\_10\_6) |
|  |  | /\* OSX >= 10.6 \*/ |
|  |  | #if defined(\_STRUCT\_X86\_THREAD\_STATE64) && !defined(\_\_i386\_\_) |
|  |  | return (void\*) uc->uc\_mcontext->\_\_ss.\_\_rip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext->\_\_ss.\_\_rip, eip); |
|  |  | #elif defined(\_\_i386\_\_) |
|  |  | return (void\*) uc->uc\_mcontext->\_\_ss.\_\_eip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext->\_\_ss.\_\_eip, eip); |
|  |  | #else |
|  |  | /\* OSX ARM64 \*/ |
|  |  | return (void\*) arm\_thread\_state64\_get\_pc(uc->uc\_mcontext->\_\_ss); |
|  |  | void \*old\_val = (void\*)arm\_thread\_state64\_get\_pc(uc->uc\_mcontext->\_\_ss); |
|  |  | if (eip) { |
|  |  | arm\_thread\_state64\_set\_pc\_fptr(uc->uc\_mcontext->\_\_ss, eip); |
|  |  | } |
|  |  | return old\_val; |
|  |  | #endif |
|  |  | #elif defined(\_\_linux\_\_) |
|  |  | /\* Linux \*/ |
|  |  | #if defined(\_\_i386\_\_) || ((defined(\_\_X86\_64\_\_) || defined(\_\_x86\_64\_\_)) && defined(\_\_ILP32\_\_)) |
|  |  | return (void\*) uc->uc\_mcontext.gregs[14]; /\* Linux 32 \*/ |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.gregs[14], eip); |
|  |  | #elif defined(\_\_X86\_64\_\_) || defined(\_\_x86\_64\_\_) |
|  |  | return (void\*) uc->uc\_mcontext.gregs[16]; /\* Linux 64 \*/ |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.gregs[16], eip); |
|  |  | #elif defined(\_\_ia64\_\_) /\* Linux IA64 \*/ |
|  |  | return (void\*) uc->uc\_mcontext.sc\_ip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.sc\_ip, eip); |
|  |  | #elif defined(\_\_arm\_\_) /\* Linux ARM \*/ |
|  |  | return (void\*) uc->uc\_mcontext.arm\_pc; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.arm\_pc, eip); |
|  |  | #elif defined(\_\_aarch64\_\_) /\* Linux AArch64 \*/ |
|  |  | return (void\*) uc->uc\_mcontext.pc; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.pc, eip); |
|  |  | #else |
|  |  | NOT\_SUPPORTED(); |
|  |  | #endif |
|  |  | #elif defined(\_\_FreeBSD\_\_) |
|  |  | /\* FreeBSD \*/ |
|  |  | #if defined(\_\_i386\_\_) |
|  |  | return (void\*) uc->uc\_mcontext.mc\_eip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.mc\_eip, eip); |
|  |  | #elif defined(\_\_x86\_64\_\_) |
|  |  | return (void\*) uc->uc\_mcontext.mc\_rip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.mc\_rip, eip); |
|  |  | #else |
|  |  | NOT\_SUPPORTED(); |
|  |  | #endif |
|  |  | #elif defined(\_\_OpenBSD\_\_) |
|  |  | /\* OpenBSD \*/ |
|  |  | #if defined(\_\_i386\_\_) |
|  |  | return (void\*) uc->sc\_eip; |
|  |  | GET\_SET\_RETURN(uc->sc\_eip, eip); |
|  |  | #elif defined(\_\_x86\_64\_\_) |
|  |  | return (void\*) uc->sc\_rip; |
|  |  | GET\_SET\_RETURN(uc->sc\_rip, eip); |
|  |  | #else |
|  |  | NOT\_SUPPORTED(); |
|  |  | #endif |
|  |  | #elif defined(\_\_NetBSD\_\_) |
|  |  | #if defined(\_\_i386\_\_) |
|  |  | return (void\*) uc->uc\_mcontext.\_\_gregs[\_REG\_EIP]; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.\_\_gregs[\_REG\_EIP], eip); |
|  |  | #elif defined(\_\_x86\_64\_\_) |
|  |  | return (void\*) uc->uc\_mcontext.\_\_gregs[\_REG\_RIP]; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.\_\_gregs[\_REG\_RIP], eip); |
|  |  | #else |
|  |  | NOT\_SUPPORTED(); |
|  |  | #endif |
|  |  | #elif defined(\_\_DragonFly\_\_) |
|  |  | return (void\*) uc->uc\_mcontext.mc\_rip; |
|  |  | GET\_SET\_RETURN(uc->uc\_mcontext.mc\_rip, eip); |
|  |  | #else |
|  |  | NOT\_SUPPORTED(); |
|  |  | #endif |
| Expand Down  Expand Up | | @@ -1951,6 +1966,10 @@ void dumpCodeAroundEIP(void \*eip) { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void invalidFunctionWasCalled() {} |
|  |  |  |
|  |  | typedef void (\*invalidFunctionWasCalledType)(); |
|  |  |  |
|  |  | void sigsegvHandler(int sig, siginfo\_t \*info, void \*secret) { |
|  |  | UNUSED(secret); |
|  |  | UNUSED(info); |
| Expand All | | @@ -1968,13 +1987,30 @@ void sigsegvHandler(int sig, siginfo\_t \*info, void \*secret) { |
|  |  |  |
|  |  | #ifdef HAVE\_BACKTRACE |
|  |  | ucontext\_t \*uc = (ucontext\_t\*) secret; |
|  |  | void \*eip = getMcontextEip(uc); |
|  |  | void \*eip = getAndSetMcontextEip(uc, NULL); |
|  |  | if (eip != NULL) { |
|  |  | serverLog(LL\_WARNING, |
|  |  | "Crashed running the instruction at: %p", eip); |
|  |  | } |
|  |  |  |
|  |  | logStackTrace(getMcontextEip(uc), 1); |
|  |  | if (eip == info->si\_addr) { |
|  |  | /\* When eip matches the bad address, it's an indication that we crashed when calling a non-mapped |
|  |  | \* function pointer. In that case the call to backtrace will crash trying to access that address and we |
|  |  | \* won't get a crash report logged. Set it to a valid point to avoid that crash. \*/ |
|  |  |  |
|  |  | /\* This trick allow to avoid compiler warning \*/ |
|  |  | void \*ptr; |
|  |  | invalidFunctionWasCalledType \*ptr\_ptr = (invalidFunctionWasCalledType\*)&ptr; |
|  |  | \*ptr\_ptr = invalidFunctionWasCalled; |
|  |  | getAndSetMcontextEip(uc, ptr); |
|  |  | } |
|  |  |  |
|  |  | logStackTrace(eip, 1); |
|  |  |  |
|  |  | if (eip == info->si\_addr) { |
|  |  | /\* Restore old eip \*/ |
|  |  | getAndSetMcontextEip(uc, eip); |
|  |  | } |
|  |  |  |
|  |  | logRegisters(uc); |
|  |  | #endif |
| Expand Down  Expand Up | | @@ -2079,7 +2115,7 @@ void watchdogSignalHandler(int sig, siginfo\_t \*info, void \*secret) { |
|  |  |  |
|  |  | serverLogFromHandler(LL\_WARNING,"\n--- WATCHDOG TIMER EXPIRED ---"); |
|  |  | #ifdef HAVE\_BACKTRACE |
|  |  | logStackTrace(getMcontextEip(uc), 1); |
|  |  | logStackTrace(getAndSetMcontextEip(uc, NULL), 1); |
|  |  | #else |
|  |  | serverLogFromHandler(LL\_WARNING,"Sorry: no support for backtrace()."); |
|  |  | #endif |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0bf90d9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Fcommit%2F0bf90d944313919eb8e63d3588bf63a367f020a3) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


