=== Content from git.kernel.org_98d50841_20250114_221456.html ===


| [cgit logo](/) | [index](/) : [kernel/git/klassert/ipsec-next.git](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/) | master testing |
| --- | --- | --- |
| Steffen Klassert's ipsec-next networking tree | Steffen Klassert |

| [about](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/about/)[summary](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/)[refs](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/refs/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)[log](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/log/)[tree](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)[commit](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)[diff](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)[stats](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peilin Ye <peilin.ye@bytedance.com> | 2022-08-08 11:04:47 -0700 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-08-10 09:50:18 +0100 |
| commit | [7e97cfed9929eaabc41829c395eb0d1350fccb9d](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d) ([patch](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/patch/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)) | |
| tree | [071ee789d5405db1155b1518329e519607f2c620](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d) | |
| parent | [6fd2c17fb6e02a8c0ab51df1cfec82ce96b8e83d](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=6fd2c17fb6e02a8c0ab51df1cfec82ce96b8e83d) ([diff](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d&id2=6fd2c17fb6e02a8c0ab51df1cfec82ce96b8e83d)) | |
| download | [ipsec-next-7e97cfed9929eaabc41829c395eb0d1350fccb9d.tar.gz](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/snapshot/ipsec-next-7e97cfed9929eaabc41829c395eb0d1350fccb9d.tar.gz) | |

vsock: Fix memory leak in vsock\_connect()An O\_NONBLOCK vsock\_connect() request may try to reschedule
@connect\_work. Imagine the following sequence of vsock\_connect()
requests:
1. The 1st, non-blocking request schedules @connect\_work, which will
expire after 200 jiffies. Socket state is now SS\_CONNECTING;
2. Later, the 2nd, blocking request gets interrupted by a signal after
a few jiffies while waiting for the connection to be established.
Socket state is back to SS\_UNCONNECTED, but @connect\_work is still
pending, and will expire after 100 jiffies.
3. Now, the 3rd, non-blocking request tries to schedule @connect\_work
again. Since @connect\_work is already scheduled,
schedule\_delayed\_work() silently returns. sock\_hold() is called
twice, but sock\_put() will only be called once in
vsock\_connect\_timeout(), causing a memory leak reported by syzbot:
BUG: memory leak
unreferenced object 0xffff88810ea56a40 (size 1232):
comm "syz-executor756", pid 3604, jiffies 4294947681 (age 12.350s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
28 00 07 40 00 00 00 00 00 00 00 00 00 00 00 00 (..@............
backtrace:
[<ffffffff837c830e>] sk\_prot\_alloc+0x3e/0x1b0 net/core/sock.c:1930
[<ffffffff837cbe22>] sk\_alloc+0x32/0x2e0 net/core/sock.c:1989
[<ffffffff842ccf68>] \_\_vsock\_create.constprop.0+0x38/0x320 net/vmw\_vsock/af\_vsock.c:734
[<ffffffff842ce8f1>] vsock\_create+0xc1/0x2d0 net/vmw\_vsock/af\_vsock.c:2203
[<ffffffff837c0cbb>] \_\_sock\_create+0x1ab/0x2b0 net/socket.c:1468
[<ffffffff837c3acf>] sock\_create net/socket.c:1519 [inline]
[<ffffffff837c3acf>] \_\_sys\_socket+0x6f/0x140 net/socket.c:1561
[<ffffffff837c3bba>] \_\_do\_sys\_socket net/socket.c:1570 [inline]
[<ffffffff837c3bba>] \_\_se\_sys\_socket net/socket.c:1568 [inline]
[<ffffffff837c3bba>] \_\_x64\_sys\_socket+0x1a/0x20 net/socket.c:1568
[<ffffffff84512815>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<ffffffff84512815>] do\_syscall\_64+0x35/0x80 arch/x86/entry/common.c:80
[<ffffffff84600068>] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
<...>
Use mod\_delayed\_work() instead: if @connect\_work is already scheduled,
reschedule it, and undo sock\_hold() to keep the reference count
balanced.
Reported-and-tested-by: syzbot+b03f55bf128f9a38f064@syzkaller.appspotmail.com
Fixes: d021c344051a ("VSOCK: Introduce VM Sockets")
Co-developed-by: Stefano Garzarella <sgarzare@redhat.com>
Signed-off-by: Stefano Garzarella <sgarzare@redhat.com>
Reviewed-by: Stefano Garzarella <sgarzare@redhat.com>
Signed-off-by: Peilin Ye <peilin.ye@bytedance.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)

| -rw-r--r-- | [net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/net/vmw_vsock/af_vsock.c?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/net/vmw\_vsock/af\_vsock.c b/net/vmw\_vsock/af\_vsock.cindex f04abf662ec6cb..4d68681f5abe68 100644--- a/[net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/net/vmw_vsock/af_vsock.c?id=6fd2c17fb6e02a8c0ab51df1cfec82ce96b8e83d)+++ b/[net/vmw\_vsock/af\_vsock.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/net/vmw_vsock/af_vsock.c?id=7e97cfed9929eaabc41829c395eb0d1350fccb9d)@@ -1391,7 +1391,14 @@ static int vsock\_connect(struct socket \*sock, struct sockaddr \*addr, \* timeout fires. \*/ sock\_hold(sk);- schedule\_delayed\_work(&vsk->connect\_work, timeout);++ /\* If the timeout function is already scheduled,+ \* reschedule it, then ungrab the socket refcount to+ \* keep it balanced.+ \*/+ if (mod\_delayed\_work(system\_wq, &vsk->connect\_work,+ timeout))+ sock\_put(sk);  /\* Skip ahead to preserve error code set above. \*/ goto out\_wait; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:13:34 +0000


