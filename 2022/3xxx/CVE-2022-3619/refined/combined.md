=== Content from git.kernel.org_0cda66ad_20250114_192433.html ===


| [cgit logo](/) | [index](/) : [kernel/git/bluetooth/bluetooth-next.git](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/) | bluetooth-next for-upstream master |
| --- | --- | --- |
| Bluetooth kernel development tree | Bluetooth group |

| [about](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/about/)[summary](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/)[refs](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/refs/?id=97097c85c088e11651146da32a4e1cdb9dfa6193)[log](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/log/)[tree](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/?id=97097c85c088e11651146da32a4e1cdb9dfa6193)[commit](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=97097c85c088e11651146da32a4e1cdb9dfa6193)[diff](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=97097c85c088e11651146da32a4e1cdb9dfa6193)[stats](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hawkins Jiawei <yin31149@gmail.com> | 2022-10-18 10:18:51 +0800 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-10-18 12:51:03 -0700 |
| commit | [97097c85c088e11651146da32a4e1cdb9dfa6193](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=97097c85c088e11651146da32a4e1cdb9dfa6193) ([patch](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/patch/?id=97097c85c088e11651146da32a4e1cdb9dfa6193)) | |
| tree | [3f884883faef9d7e7d0754d07b9b79044d9bbee7](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/?id=97097c85c088e11651146da32a4e1cdb9dfa6193) | |
| parent | [42cf46dea905a80f6de218e837ba4d4cc33d6979](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=42cf46dea905a80f6de218e837ba4d4cc33d6979) ([diff](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=97097c85c088e11651146da32a4e1cdb9dfa6193&id2=42cf46dea905a80f6de218e837ba4d4cc33d6979)) | |
| download | [bluetooth-next-97097c85c088e11651146da32a4e1cdb9dfa6193.tar.gz](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/snapshot/bluetooth-next-97097c85c088e11651146da32a4e1cdb9dfa6193.tar.gz) | |

Bluetooth: L2CAP: Fix memory leak in vhci\_writeNotice: this object is not reachable from any branch.
Syzkaller reports a memory leak as follows:
====================================
BUG: memory leak
unreferenced object 0xffff88810d81ac00 (size 240):
[...]
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[<ffffffff838733d9>] \_\_alloc\_skb+0x1f9/0x270 net/core/skbuff.c:418
[<ffffffff833f742f>] alloc\_skb include/linux/skbuff.h:1257 [inline]
[<ffffffff833f742f>] bt\_skb\_alloc include/net/bluetooth/bluetooth.h:469 [inline]
[<ffffffff833f742f>] vhci\_get\_user drivers/bluetooth/hci\_vhci.c:391 [inline]
[<ffffffff833f742f>] vhci\_write+0x5f/0x230 drivers/bluetooth/hci\_vhci.c:511
[<ffffffff815e398d>] call\_write\_iter include/linux/fs.h:2192 [inline]
[<ffffffff815e398d>] new\_sync\_write fs/read\_write.c:491 [inline]
[<ffffffff815e398d>] vfs\_write+0x42d/0x540 fs/read\_write.c:578
[<ffffffff815e3cdd>] ksys\_write+0x9d/0x160 fs/read\_write.c:631
[<ffffffff845e0645>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<ffffffff845e0645>] do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
[<ffffffff84600087>] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
====================================
HCI core will uses hci\_rx\_work() to process frame, which is queued to
the hdev->rx\_q tail in hci\_recv\_frame() by HCI driver.
Yet the problem is that, HCI core may not free the skb after handling
ACL data packets. To be more specific, when start fragment does not
contain the L2CAP length, HCI core just copies skb into conn->rx\_skb and
finishes frame process in l2cap\_recv\_acldata(), without freeing the skb,
which triggers the above memory leak.
This patch solves it by releasing the relative skb, after processing
the above case in l2cap\_recv\_acldata().
Fixes: 4d7ea8ee90e4 ("Bluetooth: L2CAP: Fix handling fragmented length")
Link: [https://lore.kernel.org/all/0000000000000d0b1905e6aaef64@google.com/](https://lore.kernel.org/all/0000000000000d0b1905e6aaef64%40google.com/)
Reported-and-tested-by: syzbot+8f819e36e01022991cfa@syzkaller.appspotmail.com
Signed-off-by: Hawkins Jiawei <yin31149@gmail.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Notice: this object is not reachable from any branch.
[Diffstat](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=97097c85c088e11651146da32a4e1cdb9dfa6193)

| -rw-r--r-- | [net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/net/bluetooth/l2cap_core.c?id=97097c85c088e11651146da32a4e1cdb9dfa6193) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 4 deletions

| diff --git a/net/bluetooth/l2cap\_core.c b/net/bluetooth/l2cap\_core.cindex 9a32ce63491948..1fbe087d6ae4eb 100644--- a/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/net/bluetooth/l2cap_core.c?id=42cf46dea905a80f6de218e837ba4d4cc33d6979)+++ b/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/net/bluetooth/l2cap_core.c?id=97097c85c088e11651146da32a4e1cdb9dfa6193)@@ -8461,9 +8461,8 @@ void l2cap\_recv\_acldata(struct hci\_conn \*hcon, struct sk\_buff \*skb, u16 flags) \* expected length. \*/ if (skb->len < L2CAP\_LEN\_SIZE) {- if (l2cap\_recv\_frag(conn, skb, conn->mtu) < 0)- goto drop;- return;+ l2cap\_recv\_frag(conn, skb, conn->mtu);+ break; }  len = get\_unaligned\_le16(skb->data) + L2CAP\_HDR\_SIZE;@@ -8507,7 +8506,7 @@ void l2cap\_recv\_acldata(struct hci\_conn \*hcon, struct sk\_buff \*skb, u16 flags)  /\* Header still could not be read just continue \*/ if (conn->rx\_skb->len < L2CAP\_LEN\_SIZE)- return;+ break; }  if (skb->len > conn->rx\_len) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:53:36 +0000


