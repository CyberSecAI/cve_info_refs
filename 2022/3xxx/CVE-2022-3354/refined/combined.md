=== Content from github.com_d1d26550_20250115_100957.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen5gs%2Fopen5gs%2Fissues%2F1767)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen5gs%2Fopen5gs%2Fissues%2F1767)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=open5gs%2Fopen5gs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[open5gs](/open5gs)
/
**[open5gs](/open5gs/open5gs)**
Public

* [Notifications](/login?return_to=%2Fopen5gs%2Fopen5gs) You must be signed in to change notification settings
* [Fork
  783](/login?return_to=%2Fopen5gs%2Fopen5gs)
* [Star
   1.9k](/login?return_to=%2Fopen5gs%2Fopen5gs)

* [Code](/open5gs/open5gs)
* [Issues
  149](/open5gs/open5gs/issues)
* [Pull requests
  55](/open5gs/open5gs/pulls)
* [Discussions](/open5gs/open5gs/discussions)
* [Actions](/open5gs/open5gs/actions)
* [Projects
  0](/open5gs/open5gs/projects)
* [Wiki](/open5gs/open5gs/wiki)
* [Security](/open5gs/open5gs/security)
* [Insights](/open5gs/open5gs/pulse)

Additional navigation options

* [Code](/open5gs/open5gs)
* [Issues](/open5gs/open5gs/issues)
* [Pull requests](/open5gs/open5gs/pulls)
* [Discussions](/open5gs/open5gs/discussions)
* [Actions](/open5gs/open5gs/actions)
* [Projects](/open5gs/open5gs/projects)
* [Wiki](/open5gs/open5gs/wiki)
* [Security](/open5gs/open5gs/security)
* [Insights](/open5gs/open5gs/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fopen5gs%2Fopen5gs%2Fissues%2Fnew%2Fchoose)

By clicking â€œSign up for GitHubâ€, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). Weâ€™ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fopen5gs%2Fopen5gs%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# UPF crashes after UDP port scan #1767

Closed

[Popvlvs](/Popvlvs) opened this issue
Sep 19, 2022
Â· 6 comments

Closed

# [UPF crashes after UDP port scan](#top) #1767

[Popvlvs](/Popvlvs) opened this issue
Sep 19, 2022
Â· 6 comments

Labels
[Type:Security](/open5gs/open5gs/labels/Type%3ASecurity)
Security issue

## Comments

[![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=80&u=bfa02d72c7a5b815484649071f19fdb4b9f53dc0&v=4)](/Popvlvs)

Copy link

### **[Popvlvs](/Popvlvs)** commented [Sep 19, 2022](#issue-1377601946)

| Hi all,  First of all, I'd like to analyze this issue deeply, because I got this in the very first test. However, it seems really easy to achieve a DoS attack by executing a simple port scan.  Following image shows the UPF log after the scan:  [image](https://user-images.githubusercontent.com/56645347/190979660-dfd0717f-382e-46d8-8f06-267fb26ccea6.png)  I'll update this thread with further discoveries.  Regards. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=40&u=bfa02d72c7a5b815484649071f19fdb4b9f53dc0&v=4)](/Popvlvs)
[Popvlvs](/Popvlvs)
changed the title
~~UDM crahses after UDP port scan~~
UPFcrahses after UDP port scan
[Sep 19, 2022](#event-7411613458)

[![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=40&u=bfa02d72c7a5b815484649071f19fdb4b9f53dc0&v=4)](/Popvlvs)
[Popvlvs](/Popvlvs)
changed the title
~~UPFcrahses after UDP port scan~~
UPF crashes after UDP port scan
[Sep 19, 2022](#event-7411614258)

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[acetcom](/acetcom)
added
the
[type:bug](/open5gs/open5gs/labels/type%3Abug)
Open5GS bug
label
[Sep 25, 2022](#event-7452749811)

[acetcom](/acetcom)
added a commit
that referenced
this issue
[Sep 25, 2022](#ref-commit-c2f6a02)
[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

`[[TLV] Added more debug information (](/open5gs/open5gs/commit/c2f6a020a7b505e0d55748464406fb9aca062026 "[TLV] Added more debug information (#1767)")[#1767](https://github.com/open5gs/open5gs/issues/1767)[)](/open5gs/open5gs/commit/c2f6a020a7b505e0d55748464406fb9aca062026 "[TLV] Added more debug information (#1767)")`

`[c2f6a02](/open5gs/open5gs/commit/c2f6a020a7b505e0d55748464406fb9aca062026)`

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[acetcom](/acetcom)
added
the
[status:more-info-needed](/open5gs/open5gs/labels/status%3Amore-info-needed)
Maintenance is requesting additional information to address this issue.
label
[Sep 25, 2022](#event-7452754071)

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=80&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

Copy link

Member

### **[acetcom](/acetcom)** commented [Sep 25, 2022](#issuecomment-1257088942)

| [@Popvlvs](https://github.com/Popvlvs)  I've added more debug information to fix this issue in the main branch. If you can reproduce this problem, please share the print log message.  Thanks a lot! Sukchan |
| --- |

All reactions

Sorry, something went wrong.

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[acetcom](/acetcom)
added
[Type:Security](/open5gs/open5gs/labels/Type%3ASecurity)
Security issue
and removed
[status:more-info-needed](/open5gs/open5gs/labels/status%3Amore-info-needed)
Maintenance is requesting additional information to address this issue.
[type:bug](/open5gs/open5gs/labels/type%3Abug)
Open5GS bug
labels
[Sep 28, 2022](#event-7473382278)

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=80&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

Copy link

Member

### **[acetcom](/acetcom)** commented [Sep 28, 2022](#issuecomment-1260447789)

| [@Popvlvs](https://github.com/Popvlvs)  I've improved the security protection in the branch issues1767.  Please let me know if the issue has been resolved.  Thanks a lot! Sukchan |
| --- |

All reactions

Sorry, something went wrong.

[![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=80&u=bfa02d72c7a5b815484649071f19fdb4b9f53dc0&v=4)](/Popvlvs)

Copy link

Author

### **[Popvlvs](/Popvlvs)** commented [Sep 28, 2022](#issuecomment-1260517688)

| [@acetcom](https://github.com/acetcom)  It fails when compiling. See the following picture:  [image](https://user-images.githubusercontent.com/56645347/192719823-f9800fc2-fb46-47f7-9e35-0fa01f3ade11.png)  Regards. |
| --- |

All reactions

Sorry, something went wrong.

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=80&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

Copy link

Member

### **[acetcom](/acetcom)** commented [Sep 28, 2022](#issuecomment-1260523584)

| [@Popvlvs](https://github.com/Popvlvs)  Here are my results.  ``` $ rm -Rf open5gs $ git clone https://github.com/open5gs/open5gs $ cd open5gs $ git checkout issues1767 Branch 'issues1767' set up to track remote branch 'issues1767' from 'origin'. Switched to a new branch 'issues1767' $ meson build --prefix=`pwd`/install $ cd build  $ ninja [3241/3241] Linking target tests/non3gpp/non3gpp.  ```  That works well.  Good luck with you! Sukchan |
| --- |

All reactions

Sorry, something went wrong.

[![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=80&u=bfa02d72c7a5b815484649071f19fdb4b9f53dc0&v=4)](/Popvlvs)

Copy link

Author

### **[Popvlvs](/Popvlvs)** commented [Sep 28, 2022](#issuecomment-1260606217)

| [@acetcom](https://github.com/acetcom)  My fault :)  It seems it's fixed now. It logs errors because of the malformed UDP payload (as expected) but it doesn't crash. Besides, I tried to register a new UE during the port scan and it attaches to the network successfully (highlighted on the following picture).  [image](https://user-images.githubusercontent.com/56645347/192737024-73e427c1-f4dd-41ca-97c0-620f70157f6e.png)  Thanks again!  Regards. |
| --- |

 ðŸ‘
1
 acetcom reacted with thumbs up emoji

All reactions

* ðŸ‘
  1 reaction

Sorry, something went wrong.

[acetcom](/acetcom)
added a commit
that referenced
this issue
[Oct 1, 2022](#ref-commit-71a1516)
[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

`[[Security] Fixed a crash for port scanning (](/open5gs/open5gs/commit/71a1516b0376340d267caa85920cb0a4da261176 "[Security] Fixed a crash for port scanning (#1767)")[#1767](https://github.com/open5gs/open5gs/issues/1767)[)](/open5gs/open5gs/commit/71a1516b0376340d267caa85920cb0a4da261176 "[Security] Fixed a crash for port scanning (#1767)")`

`[71a1516](/open5gs/open5gs/commit/71a1516b0376340d267caa85920cb0a4da261176)`

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=80&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)

Copy link

Member

### **[acetcom](/acetcom)** commented [Oct 1, 2022](#issuecomment-1264239267)

| [@Popvlvs](https://github.com/Popvlvs)  I've merge it to the main branch.  Thank you so much! Sukchan |
| --- |

All reactions

Sorry, something went wrong.

[![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=40&u=bfa02d72c7a5b815484649071f19fdb4b9f53dc0&v=4)](/Popvlvs)
[Popvlvs](/Popvlvs)
closed this as [completed](/open5gs/open5gs/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Oct 4, 2022](#event-7515213444)

[NLag](/NLag)
added a commit
to securitylab-repository/open5gs\_ciot
that referenced
this issue
[Oct 19, 2022](#ref-commit-fdfe2c9)
[![@NLag](https://avatars.githubusercontent.com/u/23296450?s=40&u=e3580870f84ea63e0be0f838c827a29c8dbe5eb2&v=4)](/NLag) [![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom)
[![@pespin](https://avatars.githubusercontent.com/u/1515985?s=40&v=4)](/pespin) [![@bmeglic](https://avatars.githubusercontent.com/u/103102696?s=40&v=4)](/bmeglic) [![@Networkmama](https://avatars.githubusercontent.com/u/107408378?s=40&v=4)](/Networkmama) [![@osmith42](https://avatars.githubusercontent.com/u/44496293?s=40&u=7af9ef64bffa3b52be62c159d5d0936f161fbde0&v=4)](/osmith42) [![@jmasterfunk84](https://avatars.githubusercontent.com/u/48972964?s=40&v=4)](/jmasterfunk84) [![@herlesupreeth](https://avatars.githubusercontent.com/u/4115839?s=40&u=0df0d633efb5eab3da1aea56c63526525ce90ef4&v=4)](/herlesupreeth) [![@lynxis](https://avatars.githubusercontent.com/u/272583?s=40&v=4)](/lynxis) [![@mitmitmitm](https://avatars.githubusercontent.com/u/106949222?s=40&v=4)](/mitmitmitm) [![@EugeneBogush](https://avatars.githubusercontent.com/u/1798186?s=40&u=0b2c70944ac63dd38b439ab12b6087c539cb854d&v=4)](/EugeneBogush) [![@neggles](https://avatars.githubusercontent.com/u/4232981?s=40&u=93a2cb4de3496042ddf49595cc47e22321b2478a&v=4)](/neggles) [![@gstaa](https://avatars.githubusercontent.com/u/93838663?s=40&v=4)](/gstaa) [![@spencersevilla](https://avatars.githubusercontent.com/u/1691412?s=40&v=4)](/spencersevilla) [![@dibasdas02](https://avatars.githubusercontent.com/u/84923695?s=40&v=4)](/dibasdas02) [![@ssafaorhan](https://avatars.githubusercontent.com/u/95750427?s=40&u=c95e9e49bcb03d0642a1861fee04b43d0c926a69&v=4)](/ssafaorhan)

`[Update repo to open5gs/open5gs main (](/securitylab-repository/open5gs_ciot/commit/fdfe2c951870458716094018f75ebc5d298f3bd7 "Update repo to open5gs/open5gs main (#1)

* Initialize pgw_s5u_teid (#1559)

* [SMF] Gy: Send Multiple-Services-Indicator AVP only during Initial CCR (#1616)

Gy (3GPP TS 32.299 ) refers to AVP in DCCA (RFC4006).

RFC4006 5.1.2:
\"[...] by including the Multiple-Services-Indicator AVP in the first
interrogation.\"

Nokia's infocenter documentation also states it's sent during Initial CCR
only: \"(CCR-I only)\".

* [SBI] Fix memory leak for nghttp2 session (#1618)

Delete nghttp2 session to prevent memory leaks.
The issue was detected using valgrind.

* [CORE] fsm: Add asserts to validate ogs_fsm_t is not null (#1619)

* Change Default MCC/MNC 901/70 -> 999/70 (#1331)

* [SMF] track and fix scenario where gtp node mempool becomes full (#1622)

* [SMF] Avoid abort() if gtp_node mempool becomes full

Related: https://github.com/open5gs/open5gs/issues/1621

* [SMF] metrics: Add new ctr tracking gtp_node allocation failures

This metrics is useful to track whether at some point the mempool went
full, so that config needs to be updated to increase the mempool size.

* [SGWC,SMF] Add specific config opt max.gtp_peer to set gtp_node mempool size (#1623)

This is needed specially for SMFs handling a pool of SGWs.

* [UPF] Avoid crash if no default subnet configured (#1624)

In that case, ogs_pfcp_ue_ip_alloc() will fail with  the error message
\"CHECK CONFIGURATION: Cannot find subnet [...]\" and the assert will make
upf crash.
That's not desirable, let's keep it running and simply reject the
request. The error log is big enoguh to find out.

* [SMF] pfcp-sm: Fix ogs_fsm_dispatch() on NULL sess (#1628)

It was spotted that if DeleteSessionReq sent by SMF is answered by UPF
with cause=\"Session context not found\", then it contains SEID=0 (this is
correct as per specs). Hence, since SEID=0 session is not looked up, so
sess=NULL.

A follow up commit improves the situation by looking up the SEID in the
originating request message in that case.

* [SMF] Set v4/6 flag in F-TEID IE request type (#1625)

Signed-off-by: Networkmama <networkmama12@gmail.com>

* Set v4/v6 flags in local F-TEID (#1625)

* [PFCP] Added DNN/APN in FAR (#1629, #1630)

* [PFCP] Added Network Instance to CP-UP FAR (#1630)

* [SMF] Gn: QoS Profile and PCO IE improvements (#1631)

* [SMF] pfcp: Retrieve sess when response with SEID=0 is received (#1620)

3GPP TS 29.244 7.2.2.4.2 documents that the peer will set SEID=0 in the
response when we request something for a session not existing at the peer.
If that's the case, we still want to locate the local session which
originated the request, so let's store the local SEID in the xact when
submitting the message, so that we can retrieve the related SEID and
find the session if we receive SEID=0.

* [SGWC] pfcp: Retrieve sess when SEID=0 (#1620)

* [GTP] context when TEID=0 (#1620, #1606, #1594)

* [SCTP] Add protection code jumbo frame (#1632)

* [GTP] Avoid abort if ogs_gtp_node_new() returns NULL (#1633)

* [GTP] Avoid abort if ogs_gtp_node_new() returns NULL

* [SGWC] Avoid abort if ogs_gtp_node_add_by_addr() returns NULL

* [GTP] avoid abort for ogs_gtp_node_new() (#1633)

* [UPF] N4: Remove unnecessary assert (#1634)

* Changes MAX TLV MORE to 16

OGS_MAX_NUM_OF_PDR is 16, but OGS_TLV_MAX_MORE is 8.
To match the size of two macros, increased OGS_TLV_MAX_MORE to 16.

* Revert \"[GTP] context when TEID=0 (#1620, #1606, #1594)\"

This reverts commit 0d61f7a7f905a865bcd8be9382ffabeb817f8464.

* Revert \"[SGWC] pfcp: Retrieve sess when SEID=0 (#1620)\"

This reverts commit 970056302390471e7089a7a2ed08bcf979fd057d.

* [PFCP] Refine error code path without assertion

Refer to #1635, #1620

* [GTP] Refine error code path without assertion

Refer to #1635, #1620, #1606, #1594

* Fixed a crash when slice/session overflow (#1637)

* [MISC] Add support for static code analysis

Static code analysis can be executed with following commands:
  meson build
  ninja -C build analyze-cppcheck
  ninja -C build analyze-clang-tidy

These commands are available only if additional tools are installed:
  - cppcheck
  - clang-tidy
  - clang-tools is optional if you want to paralelize the clang-tidy

In case of cppcheck analysis, a file called build/cppchecklog.log is
created with the analysis results.

In case of clang-tidy analysis, some checks are disabled. See file
.clang-tidy, and reenable them if you see fit.
Also it does not scan all the files in the project, since some of them
are imported from other sources. It does not scan any sources under:
  - subprojects/
  - lib/asn1c/
  - lib/ipfw/

* [ALL] Fix differences in function parameter names between definition and declaration

* [CORE] Fix detection of a failed memory allocation

* [CORE] Added memory check (#1638)

* [PFCP] Fixed a endianness Apply Action (#1640)

* [SMF] copy UE ip address to uplink PDR rules.

This helps UPF to add ACL based on src ip

Signed-off-by: Networkmama <networkmama12@gmail.com>

* [PFCP] Added UE IP address in the EPC (#1642)

* d/open5gs-upf.postinst: don't restart service in chroot

Don't attempt to restart systemd-networkd if systemd is not running
(e.g. installing open5gs inside a chroot).

Fix for:
  System has not been booted with systemd as init system (PID 1). Can't operate.
  Failed to connect to bus: Host is down
  dpkg: error processing package open5gs-upf:amd64 (--configure):
   installed open5gs-upf:amd64 package post-installation script subprocess returned error exit status 1

* [SBI] fixed wrong request-nf-type (#1650)

* [AMF] Do not send Deregistration Event to UDM when UE deregisters

According to TS 23.502, 4.2.2.2.2, AMF sends Registration event to UDM
in the following cases:
- If the AMF has changed since the last Registration procedure, or
- if the UE provides a SUPI which doesn't refer to a valid context in
the AMF,
- or if the UE registers to the same AMF it has already registered
to a non- 3GPP access (i.e. the UE is registered over a non-3GPP access
and initiates this Registration procedure to add a 3GPP access).

In case that UE re-registers to the network with a GUTI, it bypasses
authentication check to the AUSF. In this case, AMF does not send
Registration event to UDM.
Consequently, when UE deregisters again, AMF would send a Deregistration
Event to a UDM, which does not have a context for it.

3GPP standard does not say when AMF sends Deregistration Event to UDM,
only that it is optional.

These (De-)Registration events are for (de-)registering AMF to the UDM
for serving the UE. And not for (de-)registering UE itself for purpose
of tracking when UE is registered on the network.

This partially reverts commit 7be7029ac40b2eecbf70564d5306f85dafa2b848

* [NAS] modify library to include both directions of deregistration requests

Definitions in NAS library now include both directions of deregistration
requests/accepts - from UE and from network.

* [SBI] Add support for DeregistrationData in SBI messages

* [AMF] Handle namf-callback DeregNotify message from UDM

UDM may send a Deregistration Notification to AMF, to deregister
specific UE from the network - Network-Initiated Deregistration.
Deregistration procedure includes sending Deregistration Request to UE,
starting a timer T3522, releasing PDU sessions from SMF, releasing PCF
policies from PCF, and waiting for Deregistration Accept from UE.

Not yet implemented is:
- to prevent deregistration of UE in case it has any emergency sessions,
- page UE when UE is in IDLE mode.

* [SBI] incrased session pool of server (#1652)

* [CORE] Increased memory pool for poll (#1652)

* [SCP] Support of Indirect Communication

* [asn1c] rework aper from mouse07410/asn1c#94

Merge @pespin the following work
- mouse07410/asn1c#93
- mouse07410/asn1c#100

* [AMF] Fixed 5GMM cause in Reject message (#1660)

When a UE that requests slices tries to connect and there are no slices configured, the reject message is:

5GMM cause = 0x7 (5GS Services not allowed)

however it should be:

5GMM cause = 0x3e (No network slices available)

All 5GMM cause value in reject message is reviewed in this commit

* Fixed ASSERT when context has already been removed

* fixed the memory leak in test program

* Fixed the crash in UERANSIM 500 test (#1652)

* Oops! Redundant code is removed (#1652)

* Add missing pkbuf_free() (#1652)

* Refactor for the UERANSIM 500 test (#1652)

* Add more protection code for (#1652)

* [tests] Fix running unit tests inside docker environment

The issue was introduced with the commit, which builds Open5GS from
local sources instead of downloading them each time from Github.

Fixes: d2cbcf711 (\"[build] Use local sources to build applications (#1583)\")

* [SBI] Add function to request NF Instance from NRF by providing it's Instance Id

* [SMF] Send PDU Session Establish Accept to serving AMF

In case there are multiple AMF registered to NRF, SMF would pick only
the first AMF from the list.
In the case of sending PDU Session Establishment Accept from SMF to
AMF, this would mean a high chance of failure since the AMF might
be different than the original requester, and would not know about a
particular UE.

Modify SMF to use ServingNfId field from original request
SmContextCreateData from AMF to determine to which AMF should it send
PDU Session Establishment Accept message.

* Set default Network-Access-Mode to 0

For HSS's which do not include the NAM, the MME should not treat this as a fatal error.  MME should just assume PACKET_AND_CIRCUIT (0), as was decided in a previous PR.

* [MME] Handle Charging Characteristics

Found no support for HSS provided charging characteristics.  Following TS32.251 A.4:
- Use PDN level CC, if one wasn't provided then use subscription level CC
- Don't send CC in S11 if it wasn't included

* Moving handling of assigning sub level cc into the pdn to s11.

* Support Discovery Optional Parameter (#1671)

To support target-nf-instance-id in the discovery,
Discovery optional parameter is implemeted

* Oops! Warning removed!

* Refine code of discovery option param (#1671)

* Release v2.4.9

* [MME] Introduce support for S6a Cancel Location Request

- Added diameter dictionary definitions for Cancel Location
- Cancel Location will completely remove UE from MME, allow for a fresh IMSI attach to occur on next attempt.
- T3422 is used for detach request.
- Added new handling for s6a events in mme-sm, as not all s6a messages are at attach now.  Maybe there's something in a state machine I should've been using here instead of a new flag?

- Testing was completed with UE in idle and connected.  With CLR flags indicating re-attach required and without.  Also sending CLR after UE detach.  And then sending again when mme_ue is empty.

* Refact paging module (#1676)

* [MME] Changed S1AP_Cause in S1AP Release (#1676)

S1AP_CauseNas_detach -> S1AP_CauseNas_normal_release

* [SBI] Fixed nf_instance memory leak

- Rollback commit ed3444eef5e9e57705645b500dbd6c5af453703f
- Do not modify reference count when REGISTER/DEREGISTER notified from NRF

* [PFCP] Revert Changes 5e18b2b

* [MME+HSS] AVP Occurring Too Many Times

Do not Set Origin-Hosts with fd_msg_rescode_set before potential use of ogs_diam_message_experimental_rescode_set.  This results in multiple Origin-Host/Realm AVPs.

* [Diameter] Fixed Coding convention (#1680)

* [NRF] Fixed the nfInstanceUri (#1683)

* [PFCP] Revert Changes 5e18b2b and d21e9aa

To protect malicious or buggy, we need to check that session context is NULL.

* Changed configuration name from gnb to peer

And restored gtp_peer configuration

* [GTP] gtp_peer override the pool size of GTP node

* [MME] Changed CauseNas_detach in DETACH (#1676)

* [SBI] Increased the max stream number

* [SBI] CLIENT max concurrent streams to 16384

* Move src/../nf-sm.[ch] to lib/sbi/nf-sm.[ch]

* [PFCP] Fixed security protection

Check the length to prevent buffer overflow attacks.

* Lower Linux version cannot change HTTP2 max stream

CURLMOPT_MAX_CONCURRENT_STREAMS can be supported as of curl 7.67.0

* [SMF]: Update stored PCO IE requested in GTPv2 over S5c in SMF context

As per 3GPP TS 29.274 version 10.5.0, section 7.2.9 and 7.2.10,
Only if PCO IE is included in Delete Session Request then it
must be present in Delete Session Response.

In order to reflect on whether the request contained PCO IE or not
the SMF context containing the GTP request needs to be updated
i.e. update if present else clear the contents

* [SMF]: Update stored PCO IE requested over Gn in SMF context

As per 3GPP TS 29.060 version 15.3.0, section 7.3.3, 7.3.4, 7.3.5 and 7.3.6

Only if PCO IE is included in Update/Delete PDP Context Request then it
must be present in Update/Delete PDP Context Response.

In order to reflect on whether the request contained PCO IE or not
the SMF context containing the GTP request needs to be updated
i.e. update if present else clear the contents

* Update docs @nickvsnetworking and @@s5uishida

* Update docs @s5uishida

* Removed duplicated document link

* Fixed Defects reported by Coverity Scan

* [DOCS] Updated if subscribers changed [#1694]

* [PFCP] security vulnerability continued in d99491a

* [MME] Cancel Location Handling (#1698)

* CLR while idle is broken after https://github.com/open5gs/open5gs/commit/7031856cd779af0129ca444e18bbe2ed5db9ff32

Cancel Location Request arriving while UE is idle will not proceed to paging due to this check for S1 connection.  Using new flag \"isAnswer\" to bypass this check to allow paging to occur when we are not doing a AIA/ULA related procedure.

* No Context Setup is required when sending the detach request.  If the paging was due to wanting to send a Detach Request to the UE, then we fast track to sending the detach request.

* emm-sm.c:
In the case of MME initiated detach while UE is idle, there is no initial conext setup.  We go right from the service request after paging into sending the detach request.  TS23.401

mme-path.c:
Using nas_eps.type in the case of MME Initiated Detach while UE is idle does not work.  nas_eps.type would represent the service request.

mme-s11-handler.c:
After S11 action, no action should be taken.  We want to wait for the detach accept from the UE before proceeding with the S1 release (detach).

* InitialContextSetup should occur for detach.

* [MME] Follow-up Cancel Location Handling (#1698)

* [MME] Fixed GTP transaction crash (#1696)

* [SGsAP] Changed message if Paging failed (#1701)

The problem occurred in the following scenario:

1. VLR sent PAGING-REQUEST to the MME
2. MME sent S1-Paging to the UE
3. Paging failed
4. MME responded SERVICE-REQUEST to the VLR
5. VLR sent DOWNLINK-UNITDATA to the MME
6. Even though there is no S1 Context,
   MME try to sent DownlinkNASTransport message to the UE.
7. So, the problem occurred.

I've changed the number 4 PAGING-REJECT instead of SERVICE-REQUEST.

* [MME] Detach removed MME-UE context (#1698)

* [MME] UE-initiated detach removes S1 only (#1698)

* [SMF] Fix abort on app exit when no Diameter configuration

In case that SMF was configured to run without Diameter, it would crash
on application exit due to uninitialized variables/pointers.

ERROR  pid:unnamed in fd_sess_handler_destroy@sessions.c:324: ERROR: Invalid parameter '(handler && ( ((*handler) != ((void *)0)) && ( ((struct session_handler *)(*handler))->eyec == 0x53554AD1) ))', 22
[smf] FATAL: smf_gx_final: Assertion `ret == 0' failed. (../src/smf/gx-path.c:1353)

* [MME] Dictionary Updates and IDR Support (#1714)

* Add Diameter Dictionary Elements

* Initial IDR Framework

* Resolve Compile Issues

* Moving Closer

* Compile error

* Somewhat Working stuffing Code

* Add Timestamp Changes

* Cleanup some of this code.  mme_s6a_handle_idr in s6a-handler.c removed for now, since it will only come in handy when IDR flag is set to request current location, which would involve breaking out into paging.  I think there's a few other things we can do just within fd-path first.

* further removal of mme_s6a_handle_idr

* Follow up on #1714

* Changed sprintf to ogs_snprintf

* Limited to 80 column

* [NRF] Fixed library load error

* [metrics] Fix double-free on application exit (#1717)

* [SBI] Support service-names in discovery option

* [SBI] Added config for service-names discovery

* diameter: Gx: add AVP 3GPP-Charging-Characteristics

The 3GPP-Charging-Characteristics is an operator specific AVP
(optional). The 3GPP-Charging-Characteristics can be filled by the HSS
and pass through to the Gx interface.

See ETSI 29.212 5.4.0.1 for further details.

* [SMF] send 3GPP-Charging-Characteristics on Gx if received on S5/8c

The 3GPP-Charging-Characteristics is an operator specific AVP
(optional). The 3GPP-Charging-Characteristics can be filled by the HSS
and forwarded by the MME towards the SMF.

* Follow up on #1715

* Changed <TAB> to <SPACE>*4

* Changed snprintf to ogs_snprintf

* [Conf] Changed MTU size from 1500 to 1400

* [SMF] fixup send 3GPP-Charging-Characteristics on Gx if received on S5/8c

- Gy instead of Gx AVP was used.
- Use correct avp position and avp variables.

Fixes: 657eef9169af (\"[SMF] send 3GPP-Charging-Characteristics on Gx if received on S5/8c\")

* Added Service-based NF discovery

== Known limitation ==
Placing npcf-smpolicycontrol and pcf-policyauthorization
in different NFs is not supported. Both npcf-smpolicycontrol
and pcf-policyauthorization should be placed in the same NF.

* [ALL] Removing trailing whitespace and tab

* [MME] Fixed buffer overflow (#1728)

* Added simple test program

./tests/registration/registration simple-test
./tests/vonr/vonr simple-test
./tests/attach/attach simple-test
./tests/volte/volte simple-test

* [SMF] Handle upCnxState=ACTIVATING by replying with 200 instead of 204

According to TS 29.502 5.2.2.3.2.2., we should reply with a 200 response
including the upCnxState attribute.

* Follow-up on #1729

* [SBI] Send NF discovery query with service-names delimited with comma

OpenAPI specification for sending NF discovery query with
\"service-names\" parameter is defined as folowing:

- name: service-names
  ...
  style: form
  explode: false

According to OpenAPI specification, this means array items
should be delimited with a comma character (example: /users?id=3,4,5).

* [PCF] Check NF service configuration

* npcf-smpolicycontrol - enabled or disabled
* npcf-policyauthorization - enabled or disabled

Only one of npcf-smpolicycontrol and npcf-policyauthorization cannot be enabled. (../src/pcf/sbi-path.c:151)

They can be enabled or disabled together.

* [CORE] Check if timer is double free in SBI module

* removing extra lines

I did not find the purpose of their use

* [AMF] Accept Deregistration Notification from UDM only for registered UE (#1737)

Add additional check when receiving Deregistration Notification from
UDM. UE should already be in registered state before accepting the
request and deregistering the UE.

Also add additional check that PCF association policy exists before
sending a delete request to PCF.

* When using longer APN name, it is obscured due to short field.

* Also format for pcc_rule.  UE and SMF look okay as medium_data as first section.

* Minor typo fix

* Support service-based NF subscription

* [AMF] Handle APN/DNN names as case-insensitive

In case that APN name sent from UE does not case-match with the one
configured in the database, AMF would reject the registration with the
message:

[gmm] WARNING: [imsi-xxx] DNN Not Supported OR Not Subscribed in the
Slice (../src/amf/gmm-handler.c:1051)

* Follow-up on #1747

* Release v2.4.10

* Added Release Notes for v2.4.10

* Introduce Cancel Location and Insert Subscriber Data features to HSS. (#1744)

* Introduce Cancel Location and Insert Subscriber Data features to HSS.
* HSS database will keep track of last known MME and Update Time
* Purged UE flag is established in HSS for future PUR handling
* HSS Thread will connect to database and watch change stream
  mongoDB must be configured with a Replica Set to use this
* HSS will send IDR if subscription data changes
* HSS will send CLR to old MME if MME host or realm changes
* Function created to allow ULA and IDR to generate Subscription-Data AVP
* MME Hostname and Realm shown in WebUI

* Resolve freeDiameter errors

During a ULR, if database does not contain a last known MME, a CLR is being sent to a Null destination.  This will ensure that a destination is available in the database before sending the CLR.

* Removed change streams.  Added PUR handling.

* newline needed at end of file.

* Removed temp variable.

* * Change WebUI to 2x2 display
* Including UE Purged indicator
* Using pointers in ogs_subscription_data_t
* better memory mangement with pointers
* Tweak to Destination used by hss_s6a_send_idr to use last known MME

* Check for null mme_host and mme_realms

Do this before trying to compare the strings.

* Follow-up on #1744

* [SMF] Wait for both N1&N2 release signals before releasing session

When UE would send a request to release PDU session, AMF would
eventually send \"PDU Session Resource Release Command\" downlink to both
UE (N1) and gNB (N2). Each UE and gNB would then reply with \"PDU Session
Resource Release Response\" indicating they released their own resources.

Usually the first one to respond would be gNB. SMF made an assumption
that this would always be the case. And it would wait for signal that UE
resources were freed, before releasing session resources. But
occasionally the situation is that UE responds first, and SMF releases
resources prematurely.

This situation does not normally occur. But under high stress (100's of
UE PDU releases at the same time) this happens occasionally.
According to the standard, this situation is perfectly normal.

3GPP TS 23.502 Rel. 16
4.3.4.2 UE or network requested PDU Session Release for Non-Roaming and
Roaming with Local Breakout
...
Steps 8-10 may happen before steps 6-7.
...

* Added commercial 5G

* Add tested Ericsson gNodeBs and eNodeBs

* [DOC] Fixed alphabet order

* Sponsors logo updated to be dark-mode friendly

* Updated favicon.ico in Document

* [GTP/PFCP] TLV length more acceptable (#1780)

Acceptable even if the TLV length is smaller than expected

* [AMF] Add amfInfoList to NFProfile

The actual configured GUAMIs and TAIs are used to form NF profile.
Comparing to SMF the \"info\" section is not introduced into amf.yaml!
Each amf_id (region, set) produces a separate Info in the InfoList.
Guami list consists of all GUAMIs of particular Info.
taiList consists of all TAIs for all PLMNs of particular Info.

Examle:

amf.yaml:
    guami:
      - plmn_id:
          mcc: 999
          mnc: 70
        amf_id:
          region: 2
          set: 2
          pointer: 4
      - plmn_id:
          mcc: 001
          mnc: 01
        amf_id:
          region: 2
          set: 1
      - plmn_id:
          mcc: 001
          mnc: 02
        amf_id:
          region: 2
          set: 2
    tai:
      - plmn_id:
          mcc: 001
          mnc: 01
        tac: [1, 2, 3]
    tai:
      - plmn_id:
          mcc: 002
          mnc: 02
        tac: 4
      - plmn_id:
          mcc: 001
          mnc: 02
        tac: 10
    tai:
      - plmn_id:
          mcc: 004
          mnc: 04
        tac: [6, 7]
      - plmn_id:
          mcc: 005
          mnc: 05
        tac: 8
      - plmn_id:
          mcc: 999
          mnc: 70
        tac: [9, 10]

\"amfInfoList\":  {
        \"1\":    {
                \"amfSetId\":     \"002\",
                \"amfRegionId\":  \"02\",
                \"guamiList\":    [{
                                \"plmnId\":       {
                                        \"mcc\":  \"999\",
                                        \"mnc\":  \"70\"
                                },
                                \"amfId\":        \"020084\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"02\"
                                },
                                \"amfId\":        \"020080\"
                        }],
                \"taiList\":      [{
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"02\"
                                },
                                \"tac\":  \"00000a\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"999\",
                                        \"mnc\":  \"70\"
                                },
                                \"tac\":  \"000009\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"999\",
                                        \"mnc\":  \"70\"
                                },
                                \"tac\":  \"00000a\"
                        }]
        },
        \"2\":    {
                \"amfSetId\":     \"001\",
                \"amfRegionId\":  \"02\",
                \"guamiList\":    [{
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"amfId\":        \"020040\"
                        }],
                \"taiList\":      [{
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"tac\":  \"000001\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"tac\":  \"000002\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"tac\":  \"000003\"
                        }]
        }
}

* Follow-up on #1757

* [HSS] Enable Change Streams (#1758)

* [HSS] Enable Change Streams
* Enable Events and Timers in HSS
* Integrate change streams in dbi
* mongodb should be configured with replica sets enabled to use feature
* Change streams are optional in HSS
* Timer will poll change stream for changes in the database
* As changes are detected, event is created to perform the correct
  action

* Changes made as suggested

* Follow-up on #1758

* Update document

* [TLV] Added more debug information (#1767)

* Fixed HTTP2 crashes for random JSON data (#1769)

* [core] fix timer overflow on 32bit systems (#16)

must cast ts.tv_sec to 64bits before we multiply it to prevent 32bit math and overflow

* Follow-up on #1770

* [SGWC] Fixed a crash (#1765)

Session context could be deleted before a response message is not
received from SMF

* add addr/port to pfcp assoc/de-assoc logs (#40)

pfcp association log adds addr/port

* [GTP] Changes the print message (#1772)

* [config,metrics] Move metrics configuration section under respective NF section

Without this change, using metrics with core setup configurations
(configs/vonr.yaml for example) would not be possible. Having one
metrics section for whole config file causes every NF to start metrics
server on same port causing an abort.

* Follow-on up #1754

* [DOC] iptable setting for security (#1768)

* [MME] Added protection code if no PDN-Type (#1756)

* Changes new GA4 in Google Analytics

* Commercial Term by NeoPlane - https://neoplane.io/

* Fix UL and DL URR Usage Report

* Follow-on up #1793

* [AMF] Fix for switching state when sending Deregistration Request fails

Provide pointer to state machine, instead of pointer to timer structure.
Bug was noticed when switching compiler optimization to -O2.

* [5GC] Fixed session deletion in a BSF (#1725)

* [UPF] test code for unspecified address (#1776)

* [Security] Fixed a crash for port scanning (#1767)

* Release v2.4.11

* Added Release Notes for v2.4.11

* [MME] Support for Insert Subscriber Data (#1794)

* [MME] Support for Insert Subscriber Data

* Supported AVPs in IDR will overwrite existing subscription information
* Provide error on partial APN updates
* IDR and ULA use same function to process AVPs
* Move subdatamask values into s6a, so both HSS and MME can use them
* Updates are not actioned at this time.  A Re-attach is required for
  most changes to take effect

* Memory issue on IDR exceptions

* Remove of handling MSIDSN change until DSR is used

* Follow-on up #1794

* [SBI] Client Request timeout

TS29.500
Ch 6.11 Detection and handling of late arriving requests

In Open5GS, this part was hard-corded.

HTTP2 Client sends a request and waits for 10 seconds.
If no response is received from the HTTP2 Server,
HTTP2 Client performs the exception handling.

In this commit, HTTP2 client sends Header with setting Max-Rsp-Time to 10 seconds.
However, HTTP2 server has not yet been implemented to process this value.
The server is still processing using hard-corded values (10 seconds).

* [MME] Cancel Location while Idle (#1797)

* Cancel Location while Idle Fix

* Forgot about SGSAP on MME Change.

Added \"action\" to sgsap_send_detach..

* Make handle_clr uniform with other handlers

* Added Robustness for Any Detach Type

* Memory wasn't freed upon CLR for unknown IMSIs

* Moving MME Detach to new PR

* Follow-up on #1797

* ogs_info swaps CP and UP SEIDs

* Follow-up on #1797

* fix dropped_dl_traffic_threshold ie.

* [AMF,UDM] Add support to subscribe to SDM changes

AMF subscribes to UDM for each registered UE.

At the moment, UDM does not send callback to AMF when any of the UE's
properties in the database changes.
At the moment, AMF does properly parse the ModificationNotification, but
does not do anything useful.

* [SMF] Update PFCP report error situation (#1819)

* Revert the previous commit on #1797

* Updated SBI module

- Introduced NF_INSTANCE_ID/NF_INSTANCE_TYPE
- Skip SCP in configuration validation

* [AMF] Increase size of TMSI pool

Each UE context has 'current' and 'next' TMSI values. AMF first
allocates the 'next' value, before confirming it and releasing the
'previous'. This means that we potentially need pool size of 2x the
amount of maximum configured UE.

Without this change, AMF would crash in case that there are 'x'
configured maximum amount of UE, and there are already 'x' registered
UE.

[gmm] INFO: Registration request (../src/amf/gmm-sm.c:135)
[gmm] INFO: [suci-0-001-01-1234-0-1-1000000000]    SUCI (../src/amf/gmm-handler.c:149)
[gmm] DEBUG:     OLD TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:179)
[gmm] DEBUG:     NEW TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:186)
[amf] FATAL: amf_m_tmsi_alloc: Assertion `m_tmsi' failed. (../src/amf/context.c:2160)
[core] FATAL: backtrace() returned 13 addresses (../lib/core/ogs-abort.c:37)

* [AMF] Reject registration requests when pool for UE contexts is empty

AMF does not crash anymore when a new UE registration request arrives,
and there is no available space left in UE context pool. Now it just
rejects the request with an error.

* Follow-up on #1828

* Follow-up on #1827

* [DBI] Disable Change Streams with mongo Version

Support for change stream is only available in mongoc >=1.9.0
- Disabled related functions in dbi.
Support for bson to json used in debug statement only in libbson >=1.7.0
- Simple debug message in lower versions

* Follow-up on #1827

* Update README.md

Signed-off-by: Networkmama <networkmama12@gmail.com>
Co-authored-by: Sukchan Lee <acetcom@gmail.com>
Co-authored-by: Pau Espin Pedrol <pespin@sysmocom.de>
Co-authored-by: Bostjan Meglic <103102696+bmeglicit@users.noreply.github.com>
Co-authored-by: Networkmama <networkmama12@gmail.com>
Co-authored-by: Bostjan Meglic <b.meglic@iskratel.si>
Co-authored-by: Oliver Smith <osmith@sysmocom.de>
Co-authored-by: jmasterfunk84 <48972964+jmasterfunk84@users.noreply.github.com>
Co-authored-by: herlesupreeth <herlesupreeth@gmail.com>
Co-authored-by: Alexander Couzens <lynxis@fe80.eu>
Co-authored-by: mitmitmitm <m.rihtarsic@iskratel.si>
Co-authored-by: EugeneBogush <eugeneb2008@gmail.com>
Co-authored-by: neg2led <4232981+neg2led@users.noreply.github.com>
Co-authored-by: Gaber Stare <g.stare@iskratel.si>
Co-authored-by: Spencer Sevilla <spencer.builds.networks@gmail.com>
Co-authored-by: Dibas Das <dibasdas02@gmail.com>
Co-authored-by: safaorhann <safa.orhan@b-ulltech.com>")[#1](https://github.com/securitylab-repository/open5gs_ciot/pull/1)[)](/securitylab-repository/open5gs_ciot/commit/fdfe2c951870458716094018f75ebc5d298f3bd7 "Update repo to open5gs/open5gs main (#1)

* Initialize pgw_s5u_teid (#1559)

* [SMF] Gy: Send Multiple-Services-Indicator AVP only during Initial CCR (#1616)

Gy (3GPP TS 32.299 ) refers to AVP in DCCA (RFC4006).

RFC4006 5.1.2:
\"[...] by including the Multiple-Services-Indicator AVP in the first
interrogation.\"

Nokia's infocenter documentation also states it's sent during Initial CCR
only: \"(CCR-I only)\".

* [SBI] Fix memory leak for nghttp2 session (#1618)

Delete nghttp2 session to prevent memory leaks.
The issue was detected using valgrind.

* [CORE] fsm: Add asserts to validate ogs_fsm_t is not null (#1619)

* Change Default MCC/MNC 901/70 -> 999/70 (#1331)

* [SMF] track and fix scenario where gtp node mempool becomes full (#1622)

* [SMF] Avoid abort() if gtp_node mempool becomes full

Related: https://github.com/open5gs/open5gs/issues/1621

* [SMF] metrics: Add new ctr tracking gtp_node allocation failures

This metrics is useful to track whether at some point the mempool went
full, so that config needs to be updated to increase the mempool size.

* [SGWC,SMF] Add specific config opt max.gtp_peer to set gtp_node mempool size (#1623)

This is needed specially for SMFs handling a pool of SGWs.

* [UPF] Avoid crash if no default subnet configured (#1624)

In that case, ogs_pfcp_ue_ip_alloc() will fail with  the error message
\"CHECK CONFIGURATION: Cannot find subnet [...]\" and the assert will make
upf crash.
That's not desirable, let's keep it running and simply reject the
request. The error log is big enoguh to find out.

* [SMF] pfcp-sm: Fix ogs_fsm_dispatch() on NULL sess (#1628)

It was spotted that if DeleteSessionReq sent by SMF is answered by UPF
with cause=\"Session context not found\", then it contains SEID=0 (this is
correct as per specs). Hence, since SEID=0 session is not looked up, so
sess=NULL.

A follow up commit improves the situation by looking up the SEID in the
originating request message in that case.

* [SMF] Set v4/6 flag in F-TEID IE request type (#1625)

Signed-off-by: Networkmama <networkmama12@gmail.com>

* Set v4/v6 flags in local F-TEID (#1625)

* [PFCP] Added DNN/APN in FAR (#1629, #1630)

* [PFCP] Added Network Instance to CP-UP FAR (#1630)

* [SMF] Gn: QoS Profile and PCO IE improvements (#1631)

* [SMF] pfcp: Retrieve sess when response with SEID=0 is received (#1620)

3GPP TS 29.244 7.2.2.4.2 documents that the peer will set SEID=0 in the
response when we request something for a session not existing at the peer.
If that's the case, we still want to locate the local session which
originated the request, so let's store the local SEID in the xact when
submitting the message, so that we can retrieve the related SEID and
find the session if we receive SEID=0.

* [SGWC] pfcp: Retrieve sess when SEID=0 (#1620)

* [GTP] context when TEID=0 (#1620, #1606, #1594)

* [SCTP] Add protection code jumbo frame (#1632)

* [GTP] Avoid abort if ogs_gtp_node_new() returns NULL (#1633)

* [GTP] Avoid abort if ogs_gtp_node_new() returns NULL

* [SGWC] Avoid abort if ogs_gtp_node_add_by_addr() returns NULL

* [GTP] avoid abort for ogs_gtp_node_new() (#1633)

* [UPF] N4: Remove unnecessary assert (#1634)

* Changes MAX TLV MORE to 16

OGS_MAX_NUM_OF_PDR is 16, but OGS_TLV_MAX_MORE is 8.
To match the size of two macros, increased OGS_TLV_MAX_MORE to 16.

* Revert \"[GTP] context when TEID=0 (#1620, #1606, #1594)\"

This reverts commit 0d61f7a7f905a865bcd8be9382ffabeb817f8464.

* Revert \"[SGWC] pfcp: Retrieve sess when SEID=0 (#1620)\"

This reverts commit 970056302390471e7089a7a2ed08bcf979fd057d.

* [PFCP] Refine error code path without assertion

Refer to #1635, #1620

* [GTP] Refine error code path without assertion

Refer to #1635, #1620, #1606, #1594

* Fixed a crash when slice/session overflow (#1637)

* [MISC] Add support for static code analysis

Static code analysis can be executed with following commands:
  meson build
  ninja -C build analyze-cppcheck
  ninja -C build analyze-clang-tidy

These commands are available only if additional tools are installed:
  - cppcheck
  - clang-tidy
  - clang-tools is optional if you want to paralelize the clang-tidy

In case of cppcheck analysis, a file called build/cppchecklog.log is
created with the analysis results.

In case of clang-tidy analysis, some checks are disabled. See file
.clang-tidy, and reenable them if you see fit.
Also it does not scan all the files in the project, since some of them
are imported from other sources. It does not scan any sources under:
  - subprojects/
  - lib/asn1c/
  - lib/ipfw/

* [ALL] Fix differences in function parameter names between definition and declaration

* [CORE] Fix detection of a failed memory allocation

* [CORE] Added memory check (#1638)

* [PFCP] Fixed a endianness Apply Action (#1640)

* [SMF] copy UE ip address to uplink PDR rules.

This helps UPF to add ACL based on src ip

Signed-off-by: Networkmama <networkmama12@gmail.com>

* [PFCP] Added UE IP address in the EPC (#1642)

* d/open5gs-upf.postinst: don't restart service in chroot

Don't attempt to restart systemd-networkd if systemd is not running
(e.g. installing open5gs inside a chroot).

Fix for:
  System has not been booted with systemd as init system (PID 1). Can't operate.
  Failed to connect to bus: Host is down
  dpkg: error processing package open5gs-upf:amd64 (--configure):
   installed open5gs-upf:amd64 package post-installation script subprocess returned error exit status 1

* [SBI] fixed wrong request-nf-type (#1650)

* [AMF] Do not send Deregistration Event to UDM when UE deregisters

According to TS 23.502, 4.2.2.2.2, AMF sends Registration event to UDM
in the following cases:
- If the AMF has changed since the last Registration procedure, or
- if the UE provides a SUPI which doesn't refer to a valid context in
the AMF,
- or if the UE registers to the same AMF it has already registered
to a non- 3GPP access (i.e. the UE is registered over a non-3GPP access
and initiates this Registration procedure to add a 3GPP access).

In case that UE re-registers to the network with a GUTI, it bypasses
authentication check to the AUSF. In this case, AMF does not send
Registration event to UDM.
Consequently, when UE deregisters again, AMF would send a Deregistration
Event to a UDM, which does not have a context for it.

3GPP standard does not say when AMF sends Deregistration Event to UDM,
only that it is optional.

These (De-)Registration events are for (de-)registering AMF to the UDM
for serving the UE. And not for (de-)registering UE itself for purpose
of tracking when UE is registered on the network.

This partially reverts commit 7be7029ac40b2eecbf70564d5306f85dafa2b848

* [NAS] modify library to include both directions of deregistration requests

Definitions in NAS library now include both directions of deregistration
requests/accepts - from UE and from network.

* [SBI] Add support for DeregistrationData in SBI messages

* [AMF] Handle namf-callback DeregNotify message from UDM

UDM may send a Deregistration Notification to AMF, to deregister
specific UE from the network - Network-Initiated Deregistration.
Deregistration procedure includes sending Deregistration Request to UE,
starting a timer T3522, releasing PDU sessions from SMF, releasing PCF
policies from PCF, and waiting for Deregistration Accept from UE.

Not yet implemented is:
- to prevent deregistration of UE in case it has any emergency sessions,
- page UE when UE is in IDLE mode.

* [SBI] incrased session pool of server (#1652)

* [CORE] Increased memory pool for poll (#1652)

* [SCP] Support of Indirect Communication

* [asn1c] rework aper from mouse07410/asn1c#94

Merge @pespin the following work
- mouse07410/asn1c#93
- mouse07410/asn1c#100

* [AMF] Fixed 5GMM cause in Reject message (#1660)

When a UE that requests slices tries to connect and there are no slices configured, the reject message is:

5GMM cause = 0x7 (5GS Services not allowed)

however it should be:

5GMM cause = 0x3e (No network slices available)

All 5GMM cause value in reject message is reviewed in this commit

* Fixed ASSERT when context has already been removed

* fixed the memory leak in test program

* Fixed the crash in UERANSIM 500 test (#1652)

* Oops! Redundant code is removed (#1652)

* Add missing pkbuf_free() (#1652)

* Refactor for the UERANSIM 500 test (#1652)

* Add more protection code for (#1652)

* [tests] Fix running unit tests inside docker environment

The issue was introduced with the commit, which builds Open5GS from
local sources instead of downloading them each time from Github.

Fixes: d2cbcf711 (\"[build] Use local sources to build applications (#1583)\")

* [SBI] Add function to request NF Instance from NRF by providing it's Instance Id

* [SMF] Send PDU Session Establish Accept to serving AMF

In case there are multiple AMF registered to NRF, SMF would pick only
the first AMF from the list.
In the case of sending PDU Session Establishment Accept from SMF to
AMF, this would mean a high chance of failure since the AMF might
be different than the original requester, and would not know about a
particular UE.

Modify SMF to use ServingNfId field from original request
SmContextCreateData from AMF to determine to which AMF should it send
PDU Session Establishment Accept message.

* Set default Network-Access-Mode to 0

For HSS's which do not include the NAM, the MME should not treat this as a fatal error.  MME should just assume PACKET_AND_CIRCUIT (0), as was decided in a previous PR.

* [MME] Handle Charging Characteristics

Found no support for HSS provided charging characteristics.  Following TS32.251 A.4:
- Use PDN level CC, if one wasn't provided then use subscription level CC
- Don't send CC in S11 if it wasn't included

* Moving handling of assigning sub level cc into the pdn to s11.

* Support Discovery Optional Parameter (#1671)

To support target-nf-instance-id in the discovery,
Discovery optional parameter is implemeted

* Oops! Warning removed!

* Refine code of discovery option param (#1671)

* Release v2.4.9

* [MME] Introduce support for S6a Cancel Location Request

- Added diameter dictionary definitions for Cancel Location
- Cancel Location will completely remove UE from MME, allow for a fresh IMSI attach to occur on next attempt.
- T3422 is used for detach request.
- Added new handling for s6a events in mme-sm, as not all s6a messages are at attach now.  Maybe there's something in a state machine I should've been using here instead of a new flag?

- Testing was completed with UE in idle and connected.  With CLR flags indicating re-attach required and without.  Also sending CLR after UE detach.  And then sending again when mme_ue is empty.

* Refact paging module (#1676)

* [MME] Changed S1AP_Cause in S1AP Release (#1676)

S1AP_CauseNas_detach -> S1AP_CauseNas_normal_release

* [SBI] Fixed nf_instance memory leak

- Rollback commit ed3444eef5e9e57705645b500dbd6c5af453703f
- Do not modify reference count when REGISTER/DEREGISTER notified from NRF

* [PFCP] Revert Changes 5e18b2b

* [MME+HSS] AVP Occurring Too Many Times

Do not Set Origin-Hosts with fd_msg_rescode_set before potential use of ogs_diam_message_experimental_rescode_set.  This results in multiple Origin-Host/Realm AVPs.

* [Diameter] Fixed Coding convention (#1680)

* [NRF] Fixed the nfInstanceUri (#1683)

* [PFCP] Revert Changes 5e18b2b and d21e9aa

To protect malicious or buggy, we need to check that session context is NULL.

* Changed configuration name from gnb to peer

And restored gtp_peer configuration

* [GTP] gtp_peer override the pool size of GTP node

* [MME] Changed CauseNas_detach in DETACH (#1676)

* [SBI] Increased the max stream number

* [SBI] CLIENT max concurrent streams to 16384

* Move src/../nf-sm.[ch] to lib/sbi/nf-sm.[ch]

* [PFCP] Fixed security protection

Check the length to prevent buffer overflow attacks.

* Lower Linux version cannot change HTTP2 max stream

CURLMOPT_MAX_CONCURRENT_STREAMS can be supported as of curl 7.67.0

* [SMF]: Update stored PCO IE requested in GTPv2 over S5c in SMF context

As per 3GPP TS 29.274 version 10.5.0, section 7.2.9 and 7.2.10,
Only if PCO IE is included in Delete Session Request then it
must be present in Delete Session Response.

In order to reflect on whether the request contained PCO IE or not
the SMF context containing the GTP request needs to be updated
i.e. update if present else clear the contents

* [SMF]: Update stored PCO IE requested over Gn in SMF context

As per 3GPP TS 29.060 version 15.3.0, section 7.3.3, 7.3.4, 7.3.5 and 7.3.6

Only if PCO IE is included in Update/Delete PDP Context Request then it
must be present in Update/Delete PDP Context Response.

In order to reflect on whether the request contained PCO IE or not
the SMF context containing the GTP request needs to be updated
i.e. update if present else clear the contents

* Update docs @nickvsnetworking and @@s5uishida

* Update docs @s5uishida

* Removed duplicated document link

* Fixed Defects reported by Coverity Scan

* [DOCS] Updated if subscribers changed [#1694]

* [PFCP] security vulnerability continued in d99491a

* [MME] Cancel Location Handling (#1698)

* CLR while idle is broken after https://github.com/open5gs/open5gs/commit/7031856cd779af0129ca444e18bbe2ed5db9ff32

Cancel Location Request arriving while UE is idle will not proceed to paging due to this check for S1 connection.  Using new flag \"isAnswer\" to bypass this check to allow paging to occur when we are not doing a AIA/ULA related procedure.

* No Context Setup is required when sending the detach request.  If the paging was due to wanting to send a Detach Request to the UE, then we fast track to sending the detach request.

* emm-sm.c:
In the case of MME initiated detach while UE is idle, there is no initial conext setup.  We go right from the service request after paging into sending the detach request.  TS23.401

mme-path.c:
Using nas_eps.type in the case of MME Initiated Detach while UE is idle does not work.  nas_eps.type would represent the service request.

mme-s11-handler.c:
After S11 action, no action should be taken.  We want to wait for the detach accept from the UE before proceeding with the S1 release (detach).

* InitialContextSetup should occur for detach.

* [MME] Follow-up Cancel Location Handling (#1698)

* [MME] Fixed GTP transaction crash (#1696)

* [SGsAP] Changed message if Paging failed (#1701)

The problem occurred in the following scenario:

1. VLR sent PAGING-REQUEST to the MME
2. MME sent S1-Paging to the UE
3. Paging failed
4. MME responded SERVICE-REQUEST to the VLR
5. VLR sent DOWNLINK-UNITDATA to the MME
6. Even though there is no S1 Context,
   MME try to sent DownlinkNASTransport message to the UE.
7. So, the problem occurred.

I've changed the number 4 PAGING-REJECT instead of SERVICE-REQUEST.

* [MME] Detach removed MME-UE context (#1698)

* [MME] UE-initiated detach removes S1 only (#1698)

* [SMF] Fix abort on app exit when no Diameter configuration

In case that SMF was configured to run without Diameter, it would crash
on application exit due to uninitialized variables/pointers.

ERROR  pid:unnamed in fd_sess_handler_destroy@sessions.c:324: ERROR: Invalid parameter '(handler && ( ((*handler) != ((void *)0)) && ( ((struct session_handler *)(*handler))->eyec == 0x53554AD1) ))', 22
[smf] FATAL: smf_gx_final: Assertion `ret == 0' failed. (../src/smf/gx-path.c:1353)

* [MME] Dictionary Updates and IDR Support (#1714)

* Add Diameter Dictionary Elements

* Initial IDR Framework

* Resolve Compile Issues

* Moving Closer

* Compile error

* Somewhat Working stuffing Code

* Add Timestamp Changes

* Cleanup some of this code.  mme_s6a_handle_idr in s6a-handler.c removed for now, since it will only come in handy when IDR flag is set to request current location, which would involve breaking out into paging.  I think there's a few other things we can do just within fd-path first.

* further removal of mme_s6a_handle_idr

* Follow up on #1714

* Changed sprintf to ogs_snprintf

* Limited to 80 column

* [NRF] Fixed library load error

* [metrics] Fix double-free on application exit (#1717)

* [SBI] Support service-names in discovery option

* [SBI] Added config for service-names discovery

* diameter: Gx: add AVP 3GPP-Charging-Characteristics

The 3GPP-Charging-Characteristics is an operator specific AVP
(optional). The 3GPP-Charging-Characteristics can be filled by the HSS
and pass through to the Gx interface.

See ETSI 29.212 5.4.0.1 for further details.

* [SMF] send 3GPP-Charging-Characteristics on Gx if received on S5/8c

The 3GPP-Charging-Characteristics is an operator specific AVP
(optional). The 3GPP-Charging-Characteristics can be filled by the HSS
and forwarded by the MME towards the SMF.

* Follow up on #1715

* Changed <TAB> to <SPACE>*4

* Changed snprintf to ogs_snprintf

* [Conf] Changed MTU size from 1500 to 1400

* [SMF] fixup send 3GPP-Charging-Characteristics on Gx if received on S5/8c

- Gy instead of Gx AVP was used.
- Use correct avp position and avp variables.

Fixes: 657eef9169af (\"[SMF] send 3GPP-Charging-Characteristics on Gx if received on S5/8c\")

* Added Service-based NF discovery

== Known limitation ==
Placing npcf-smpolicycontrol and pcf-policyauthorization
in different NFs is not supported. Both npcf-smpolicycontrol
and pcf-policyauthorization should be placed in the same NF.

* [ALL] Removing trailing whitespace and tab

* [MME] Fixed buffer overflow (#1728)

* Added simple test program

./tests/registration/registration simple-test
./tests/vonr/vonr simple-test
./tests/attach/attach simple-test
./tests/volte/volte simple-test

* [SMF] Handle upCnxState=ACTIVATING by replying with 200 instead of 204

According to TS 29.502 5.2.2.3.2.2., we should reply with a 200 response
including the upCnxState attribute.

* Follow-up on #1729

* [SBI] Send NF discovery query with service-names delimited with comma

OpenAPI specification for sending NF discovery query with
\"service-names\" parameter is defined as folowing:

- name: service-names
  ...
  style: form
  explode: false

According to OpenAPI specification, this means array items
should be delimited with a comma character (example: /users?id=3,4,5).

* [PCF] Check NF service configuration

* npcf-smpolicycontrol - enabled or disabled
* npcf-policyauthorization - enabled or disabled

Only one of npcf-smpolicycontrol and npcf-policyauthorization cannot be enabled. (../src/pcf/sbi-path.c:151)

They can be enabled or disabled together.

* [CORE] Check if timer is double free in SBI module

* removing extra lines

I did not find the purpose of their use

* [AMF] Accept Deregistration Notification from UDM only for registered UE (#1737)

Add additional check when receiving Deregistration Notification from
UDM. UE should already be in registered state before accepting the
request and deregistering the UE.

Also add additional check that PCF association policy exists before
sending a delete request to PCF.

* When using longer APN name, it is obscured due to short field.

* Also format for pcc_rule.  UE and SMF look okay as medium_data as first section.

* Minor typo fix

* Support service-based NF subscription

* [AMF] Handle APN/DNN names as case-insensitive

In case that APN name sent from UE does not case-match with the one
configured in the database, AMF would reject the registration with the
message:

[gmm] WARNING: [imsi-xxx] DNN Not Supported OR Not Subscribed in the
Slice (../src/amf/gmm-handler.c:1051)

* Follow-up on #1747

* Release v2.4.10

* Added Release Notes for v2.4.10

* Introduce Cancel Location and Insert Subscriber Data features to HSS. (#1744)

* Introduce Cancel Location and Insert Subscriber Data features to HSS.
* HSS database will keep track of last known MME and Update Time
* Purged UE flag is established in HSS for future PUR handling
* HSS Thread will connect to database and watch change stream
  mongoDB must be configured with a Replica Set to use this
* HSS will send IDR if subscription data changes
* HSS will send CLR to old MME if MME host or realm changes
* Function created to allow ULA and IDR to generate Subscription-Data AVP
* MME Hostname and Realm shown in WebUI

* Resolve freeDiameter errors

During a ULR, if database does not contain a last known MME, a CLR is being sent to a Null destination.  This will ensure that a destination is available in the database before sending the CLR.

* Removed change streams.  Added PUR handling.

* newline needed at end of file.

* Removed temp variable.

* * Change WebUI to 2x2 display
* Including UE Purged indicator
* Using pointers in ogs_subscription_data_t
* better memory mangement with pointers
* Tweak to Destination used by hss_s6a_send_idr to use last known MME

* Check for null mme_host and mme_realms

Do this before trying to compare the strings.

* Follow-up on #1744

* [SMF] Wait for both N1&N2 release signals before releasing session

When UE would send a request to release PDU session, AMF would
eventually send \"PDU Session Resource Release Command\" downlink to both
UE (N1) and gNB (N2). Each UE and gNB would then reply with \"PDU Session
Resource Release Response\" indicating they released their own resources.

Usually the first one to respond would be gNB. SMF made an assumption
that this would always be the case. And it would wait for signal that UE
resources were freed, before releasing session resources. But
occasionally the situation is that UE responds first, and SMF releases
resources prematurely.

This situation does not normally occur. But under high stress (100's of
UE PDU releases at the same time) this happens occasionally.
According to the standard, this situation is perfectly normal.

3GPP TS 23.502 Rel. 16
4.3.4.2 UE or network requested PDU Session Release for Non-Roaming and
Roaming with Local Breakout
...
Steps 8-10 may happen before steps 6-7.
...

* Added commercial 5G

* Add tested Ericsson gNodeBs and eNodeBs

* [DOC] Fixed alphabet order

* Sponsors logo updated to be dark-mode friendly

* Updated favicon.ico in Document

* [GTP/PFCP] TLV length more acceptable (#1780)

Acceptable even if the TLV length is smaller than expected

* [AMF] Add amfInfoList to NFProfile

The actual configured GUAMIs and TAIs are used to form NF profile.
Comparing to SMF the \"info\" section is not introduced into amf.yaml!
Each amf_id (region, set) produces a separate Info in the InfoList.
Guami list consists of all GUAMIs of particular Info.
taiList consists of all TAIs for all PLMNs of particular Info.

Examle:

amf.yaml:
    guami:
      - plmn_id:
          mcc: 999
          mnc: 70
        amf_id:
          region: 2
          set: 2
          pointer: 4
      - plmn_id:
          mcc: 001
          mnc: 01
        amf_id:
          region: 2
          set: 1
      - plmn_id:
          mcc: 001
          mnc: 02
        amf_id:
          region: 2
          set: 2
    tai:
      - plmn_id:
          mcc: 001
          mnc: 01
        tac: [1, 2, 3]
    tai:
      - plmn_id:
          mcc: 002
          mnc: 02
        tac: 4
      - plmn_id:
          mcc: 001
          mnc: 02
        tac: 10
    tai:
      - plmn_id:
          mcc: 004
          mnc: 04
        tac: [6, 7]
      - plmn_id:
          mcc: 005
          mnc: 05
        tac: 8
      - plmn_id:
          mcc: 999
          mnc: 70
        tac: [9, 10]

\"amfInfoList\":  {
        \"1\":    {
                \"amfSetId\":     \"002\",
                \"amfRegionId\":  \"02\",
                \"guamiList\":    [{
                                \"plmnId\":       {
                                        \"mcc\":  \"999\",
                                        \"mnc\":  \"70\"
                                },
                                \"amfId\":        \"020084\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"02\"
                                },
                                \"amfId\":        \"020080\"
                        }],
                \"taiList\":      [{
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"02\"
                                },
                                \"tac\":  \"00000a\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"999\",
                                        \"mnc\":  \"70\"
                                },
                                \"tac\":  \"000009\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"999\",
                                        \"mnc\":  \"70\"
                                },
                                \"tac\":  \"00000a\"
                        }]
        },
        \"2\":    {
                \"amfSetId\":     \"001\",
                \"amfRegionId\":  \"02\",
                \"guamiList\":    [{
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"amfId\":        \"020040\"
                        }],
                \"taiList\":      [{
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"tac\":  \"000001\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"tac\":  \"000002\"
                        }, {
                                \"plmnId\":       {
                                        \"mcc\":  \"001\",
                                        \"mnc\":  \"01\"
                                },
                                \"tac\":  \"000003\"
                        }]
        }
}

* Follow-up on #1757

* [HSS] Enable Change Streams (#1758)

* [HSS] Enable Change Streams
* Enable Events and Timers in HSS
* Integrate change streams in dbi
* mongodb should be configured with replica sets enabled to use feature
* Change streams are optional in HSS
* Timer will poll change stream for changes in the database
* As changes are detected, event is created to perform the correct
  action

* Changes made as suggested

* Follow-up on #1758

* Update document

* [TLV] Added more debug information (#1767)

* Fixed HTTP2 crashes for random JSON data (#1769)

* [core] fix timer overflow on 32bit systems (#16)

must cast ts.tv_sec to 64bits before we multiply it to prevent 32bit math and overflow

* Follow-up on #1770

* [SGWC] Fixed a crash (#1765)

Session context could be deleted before a response message is not
received from SMF

* add addr/port to pfcp assoc/de-assoc logs (#40)

pfcp association log adds addr/port

* [GTP] Changes the print message (#1772)

* [config,metrics] Move metrics configuration section under respective NF section

Without this change, using metrics with core setup configurations
(configs/vonr.yaml for example) would not be possible. Having one
metrics section for whole config file causes every NF to start metrics
server on same port causing an abort.

* Follow-on up #1754

* [DOC] iptable setting for security (#1768)

* [MME] Added protection code if no PDN-Type (#1756)

* Changes new GA4 in Google Analytics

* Commercial Term by NeoPlane - https://neoplane.io/

* Fix UL and DL URR Usage Report

* Follow-on up #1793

* [AMF] Fix for switching state when sending Deregistration Request fails

Provide pointer to state machine, instead of pointer to timer structure.
Bug was noticed when switching compiler optimization to -O2.

* [5GC] Fixed session deletion in a BSF (#1725)

* [UPF] test code for unspecified address (#1776)

* [Security] Fixed a crash for port scanning (#1767)

* Release v2.4.11

* Added Release Notes for v2.4.11

* [MME] Support for Insert Subscriber Data (#1794)

* [MME] Support for Insert Subscriber Data

* Supported AVPs in IDR will overwrite existing subscription information
* Provide error on partial APN updates
* IDR and ULA use same function to process AVPs
* Move subdatamask values into s6a, so both HSS and MME can use them
* Updates are not actioned at this time.  A Re-attach is required for
  most changes to take effect

* Memory issue on IDR exceptions

* Remove of handling MSIDSN change until DSR is used

* Follow-on up #1794

* [SBI] Client Request timeout

TS29.500
Ch 6.11 Detection and handling of late arriving requests

In Open5GS, this part was hard-corded.

HTTP2 Client sends a request and waits for 10 seconds.
If no response is received from the HTTP2 Server,
HTTP2 Client performs the exception handling.

In this commit, HTTP2 client sends Header with setting Max-Rsp-Time to 10 seconds.
However, HTTP2 server has not yet been implemented to process this value.
The server is still processing using hard-corded values (10 seconds).

* [MME] Cancel Location while Idle (#1797)

* Cancel Location while Idle Fix

* Forgot about SGSAP on MME Change.

Added \"action\" to sgsap_send_detach..

* Make handle_clr uniform with other handlers

* Added Robustness for Any Detach Type

* Memory wasn't freed upon CLR for unknown IMSIs

* Moving MME Detach to new PR

* Follow-up on #1797

* ogs_info swaps CP and UP SEIDs

* Follow-up on #1797

* fix dropped_dl_traffic_threshold ie.

* [AMF,UDM] Add support to subscribe to SDM changes

AMF subscribes to UDM for each registered UE.

At the moment, UDM does not send callback to AMF when any of the UE's
properties in the database changes.
At the moment, AMF does properly parse the ModificationNotification, but
does not do anything useful.

* [SMF] Update PFCP report error situation (#1819)

* Revert the previous commit on #1797

* Updated SBI module

- Introduced NF_INSTANCE_ID/NF_INSTANCE_TYPE
- Skip SCP in configuration validation

* [AMF] Increase size of TMSI pool

Each UE context has 'current' and 'next' TMSI values. AMF first
allocates the 'next' value, before confirming it and releasing the
'previous'. This means that we potentially need pool size of 2x the
amount of maximum configured UE.

Without this change, AMF would crash in case that there are 'x'
configured maximum amount of UE, and there are already 'x' registered
UE.

[gmm] INFO: Registration request (../src/amf/gmm-sm.c:135)
[gmm] INFO: [suci-0-001-01-1234-0-1-1000000000]    SUCI (../src/amf/gmm-handler.c:149)
[gmm] DEBUG:     OLD TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:179)
[gmm] DEBUG:     NEW TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:186)
[amf] FATAL: amf_m_tmsi_alloc: Assertion `m_tmsi' failed. (../src/amf/context.c:2160)
[core] FATAL: backtrace() returned 13 addresses (../lib/core/ogs-abort.c:37)

* [AMF] Reject registration requests when pool for UE contexts is empty

AMF does not crash anymore when a new UE registration request arrives,
and there is no available space left in UE context pool. Now it just
rejects the request with an error.

* Follow-up on #1828

* Follow-up on #1827

* [DBI] Disable Change Streams with mongo Version

Support for change stream is only available in mongoc >=1.9.0
- Disabled related functions in dbi.
Support for bson to json used in debug statement only in libbson >=1.7.0
- Simple debug message in lower versions

* Follow-up on #1827

* Update README.md

Signed-off-by: Networkmama <networkmama12@gmail.com>
Co-authored-by: Sukchan Lee <acetcom@gmail.com>
Co-authored-by: Pau Espin Pedrol <pespin@sysmocom.de>
Co-authored-by: Bostjan Meglic <103102696+bmeglicit@users.noreply.github.com>
Co-authored-by: Networkmama <networkmama12@gmail.com>
Co-authored-by: Bostjan Meglic <b.meglic@iskratel.si>
Co-authored-by: Oliver Smith <osmith@sysmocom.de>
Co-authored-by: jmasterfunk84 <48972964+jmasterfunk84@users.noreply.github.com>
Co-authored-by: herlesupreeth <herlesupreeth@gmail.com>
Co-authored-by: Alexander Couzens <lynxis@fe80.eu>
Co-authored-by: mitmitmitm <m.rihtarsic@iskratel.si>
Co-authored-by: EugeneBogush <eugeneb2008@gmail.com>
Co-authored-by: neg2led <4232981+neg2led@users.noreply.github.com>
Co-authored-by: Gaber Stare <g.stare@iskratel.si>
Co-authored-by: Spencer Sevilla <spencer.builds.networks@gmail.com>
Co-authored-by: Dibas Das <dibasdas02@gmail.com>
Co-authored-by: safaorhann <safa.orhan@b-ulltech.com>")`
â€¦

`[fdfe2c9](/securitylab-repository/open5gs_ciot/commit/fdfe2c951870458716094018f75ebc5d298f3bd7)`

```
* Initialize pgw_s5u_teid ([open5gs#1559](https://github.com/open5gs/open5gs/issues/1559))

* [SMF] Gy: Send Multiple-Services-Indicator AVP only during Initial CCR ([open5gs#1616](https://github.com/open5gs/open5gs/pull/1616))

Gy (3GPP TS 32.299 ) refers to AVP in DCCA (RFC4006).

RFC4006 5.1.2:
"[...] by including the Multiple-Services-Indicator AVP in the first
interrogation."

Nokia's infocenter documentation also states it's sent during Initial CCR
only: "(CCR-I only)".

* [SBI] Fix memory leak for nghttp2 session ([open5gs#1618](https://github.com/open5gs/open5gs/pull/1618))

Delete nghttp2 session to prevent memory leaks.
The issue was detected using valgrind.

* [CORE] fsm: Add asserts to validate ogs_fsm_t is not null ([open5gs#1619](https://github.com/open5gs/open5gs/pull/1619))

* Change Default MCC/MNC 901/70 -> 999/70 ([open5gs#1331](https://github.com/open5gs/open5gs/pull/1331))

* [SMF] track and fix scenario where gtp node mempool becomes full ([open5gs#1622](https://github.com/open5gs/open5gs/pull/1622))

* [SMF] Avoid abort() if gtp_node mempool becomes full

Related: [open5gs#1621](https://github.com/open5gs/open5gs/issues/1621)

* [SMF] metrics: Add new ctr tracking gtp_node allocation failures

This metrics is useful to track whether at some point the mempool went
full, so that config needs to be updated to increase the mempool size.

* [SGWC,SMF] Add specific config opt max.gtp_peer to set gtp_node mempool size ([open5gs#1623](https://github.com/open5gs/open5gs/pull/1623))

This is needed specially for SMFs handling a pool of SGWs.

* [UPF] Avoid crash if no default subnet configured ([open5gs#1624](https://github.com/open5gs/open5gs/pull/1624))

In that case, ogs_pfcp_ue_ip_alloc() will fail with  the error message
"CHECK CONFIGURATION: Cannot find subnet [...]" and the assert will make
upf crash.
That's not desirable, let's keep it running and simply reject the
request. The error log is big enoguh to find out.

* [SMF] pfcp-sm: Fix ogs_fsm_dispatch() on NULL sess ([open5gs#1628](https://github.com/open5gs/open5gs/pull/1628))

It was spotted that if DeleteSessionReq sent by SMF is answered by UPF
with cause="Session context not found", then it contains SEID=0 (this is
correct as per specs). Hence, since SEID=0 session is not looked up, so
sess=NULL.

A follow up commit improves the situation by looking up the SEID in the
originating request message in that case.

* [SMF] Set v4/6 flag in F-TEID IE request type ([open5gs#1625](https://github.com/open5gs/open5gs/pull/1625))

Signed-off-by: Networkmama <networkmama12@gmail.com>

* Set v4/v6 flags in local F-TEID ([open5gs#1625](https://github.com/open5gs/open5gs/pull/1625))

* [PFCP] Added DNN/APN in FAR ([open5gs#1629](https://github.com/open5gs/open5gs/pull/1629), [open5gs#1630](https://github.com/open5gs/open5gs/pull/1630))

* [PFCP] Added Network Instance to CP-UP FAR ([open5gs#1630](https://github.com/open5gs/open5gs/pull/1630))

* [SMF] Gn: QoS Profile and PCO IE improvements ([open5gs#1631](https://github.com/open5gs/open5gs/pull/1631))

* [SMF] pfcp: Retrieve sess when response with SEID=0 is received ([open5gs#1620](https://github.com/open5gs/open5gs/pull/1620))

3GPP TS 29.244 7.2.2.4.2 documents that the peer will set SEID=0 in the
response when we request something for a session not existing at the peer.
If that's the case, we still want to locate the local session which
originated the request, so let's store the local SEID in the xact when
submitting the message, so that we can retrieve the related SEID and
find the session if we receive SEID=0.

* [SGWC] pfcp: Retrieve sess when SEID=0 ([open5gs#1620](https://github.com/open5gs/open5gs/pull/1620))

* [GTP] context when TEID=0 ([open5gs#1620](https://github.com/open5gs/open5gs/pull/1620), [open5gs#1606](https://github.com/open5gs/open5gs/pull/1606), [open5gs#1594](https://github.com/open5gs/open5gs/pull/1594))

* [SCTP] Add protection code jumbo frame ([open5gs#1632](https://github.com/open5gs/open5gs/issues/1632))

* [GTP] Avoid abort if ogs_gtp_node_new() returns NULL ([open5gs#1633](https://github.com/open5gs/open5gs/pull/1633))

* [GTP] Avoid abort if ogs_gtp_node_new() returns NULL

* [SGWC] Avoid abort if ogs_gtp_node_add_by_addr() returns NULL

* [GTP] avoid abort for ogs_gtp_node_new() ([open5gs#1633](https://github.com/open5gs/open5gs/pull/1633))

* [UPF] N4: Remove unnecessary assert ([open5gs#1634](https://github.com/open5gs/open5gs/pull/1634))

* Changes MAX TLV MORE to 16

OGS_MAX_NUM_OF_PDR is 16, but OGS_TLV_MAX_MORE is 8.
To match the size of two macros, increased OGS_TLV_MAX_MORE to 16.

* Revert "[GTP] context when TEID=0 ([open5gs#1620](https://github.com/open5gs/open5gs/pull/1620), [open5gs#1606](https://github.com/open5gs/open5gs/pull/1606), [open5gs#1594](https://github.com/open5gs/open5gs/pull/1594))"

This reverts commit [0d61f7a](https://github.com/securitylab-repository/open5gs_ciot/commit/0d61f7a7f905a865bcd8be9382ffabeb817f8464).

* Revert "[SGWC] pfcp: Retrieve sess when SEID=0 ([open5gs#1620](https://github.com/open5gs/open5gs/pull/1620))"

This reverts commit [9700563](https://github.com/securitylab-repository/open5gs_ciot/commit/970056302390471e7089a7a2ed08bcf979fd057d).

* [PFCP] Refine error code path without assertion

Refer to [open5gs#1635](https://github.com/open5gs/open5gs/issues/1635), [open5gs#1620](https://github.com/open5gs/open5gs/pull/1620)

* [GTP] Refine error code path without assertion

Refer to [open5gs#1635](https://github.com/open5gs/open5gs/issues/1635), [open5gs#1620](https://github.com/open5gs/open5gs/pull/1620), [open5gs#1606](https://github.com/open5gs/open5gs/pull/1606), [open5gs#1594](https://github.com/open5gs/open5gs/pull/1594)

* Fixed a crash when slice/session overflow ([open5gs#1637](https://github.com/open5gs/open5gs/issues/1637))

* [MISC] Add support for static code analysis

Static code analysis can be executed with following commands:
  meson build
  ninja -C build analyze-cppcheck
  ninja -C build analyze-clang-tidy

These commands are available only if additional tools are installed:
  - cppcheck
  - clang-tidy
  - clang-tools is optional if you want to paralelize the clang-tidy

In case of cppcheck analysis, a file called build/cppchecklog.log is
created with the analysis results.

In case of clang-tidy analysis, some checks are disabled. See file
.clang-tidy, and reenable them if you see fit.
Also it does not scan all the files in the project, since some of them
are imported from other sources. It does not scan any sources under:
  - subprojects/
  - lib/asn1c/
  - lib/ipfw/

* [ALL] Fix differences in function parameter names between definition and declaration

* [CORE] Fix detection of a failed memory allocation

* [CORE] Added memory check ([open5gs#1638](https://github.com/open5gs/open5gs/pull/1638))

* [PFCP] Fixed a endianness Apply Action ([open5gs#1640](https://github.com/open5gs/open5gs/issues/1640))

* [SMF] copy UE ip address to uplink PDR rules.

This helps UPF to add ACL based on src ip

Signed-off-by: Networkmama <networkmama12@gmail.com>

* [PFCP] Added UE IP address in the EPC ([open5gs#1642](https://github.com/open5gs/open5gs/pull/1642))

* d/open5gs-upf.postinst: don't restart service in chroot

Don't attempt to restart systemd-networkd if systemd is not running
(e.g. installing open5gs inside a chroot).

Fix for:
  System has not been booted with systemd as init system (PID 1). Can't operate.
  Failed to connect to bus: Host is down
  dpkg: error processing package open5gs-upf:amd64 (--configure):
   installed open5gs-upf:amd64 package post-installation script subprocess returned error exit status 1

* [SBI] fixed wrong request-nf-type ([open5gs#1650](https://github.com/open5gs/open5gs/issues/1650))

* [AMF] Do not send Deregistration Event to UDM when UE deregisters

According to TS 23.502, 4.2.2.2.2, AMF sends Registration event to UDM
in the following cases:
- If the AMF has changed since the last Registration procedure, or
- if the UE provides a SUPI which doesn't refer to a valid context in
the AMF,
- or if the UE registers to the same AMF it has already registered
to a non- 3GPP access (i.e. the UE is registered over a non-3GPP access
and initiates this Registration procedure to add a 3GPP access).

In case that UE re-registers to the network with a GUTI, it bypasses
authentication check to the AUSF. In this case, AMF does not send
Registration event to UDM.
Consequently, when UE deregisters again, AMF would send a Deregistration
Event to a UDM, which does not have a context for it.

3GPP standard does not say when AMF sends Deregistration Event to UDM,
only that it is optional.

These (De-)Registration events are for (de-)registering AMF to the UDM
for serving the UE. And not for (de-)registering UE itself for purpose
of tracking when UE is registered on the network.

This partially reverts commit [7be7029](https://github.com/securitylab-repository/open5gs_ciot/commit/7be7029ac40b2eecbf70564d5306f85dafa2b848)

* [NAS] modify library to include both directions of deregistration requests

Definitions in NAS library now include both directions of deregistration
requests/accepts - from UE and from network.

* [SBI] Add support for DeregistrationData in SBI messages

* [AMF] Handle namf-callback DeregNotify message from UDM

UDM may send a Deregistration Notification to AMF, to deregister
specific UE from the network - Network-Initiated Deregistration.
Deregistration procedure includes sending Deregistration Request to UE,
starting a timer T3522, releasing PDU sessions from SMF, releasing PCF
policies from PCF, and waiting for Deregistration Accept from UE.

Not yet implemented is:
- to prevent deregistration of UE in case it has any emergency sessions,
- page UE when UE is in IDLE mode.

* [SBI] incrased session pool of server ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* [CORE] Increased memory pool for poll ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* [SCP] Support of Indirect Communication

* [asn1c] rework aper from [mouse07410/asn1c#94](https://github.com/mouse07410/asn1c/issues/94)

Merge [@pespin](https://github.com/pespin) the following work
- [mouse07410/asn1c#93](https://github.com/mouse07410/asn1c/pull/93)
- [mouse07410/asn1c#100](https://github.com/mouse07410/asn1c/pull/100)

* [AMF] Fixed 5GMM cause in Reject message ([open5gs#1660](https://github.com/open5gs/open5gs/issues/1660))

When a UE that requests slices tries to connect and there are no slices configured, the reject message is:

5GMM cause = 0x7 (5GS Services not allowed)

however it should be:

5GMM cause = 0x3e (No network slices available)

All 5GMM cause value in reject message is reviewed in this commit

* Fixed ASSERT when context has already been removed

* fixed the memory leak in test program

* Fixed the crash in UERANSIM 500 test ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* Oops! Redundant code is removed ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* Add missing pkbuf_free() ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* Refactor for the UERANSIM 500 test ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* Add more protection code for ([open5gs#1652](https://github.com/open5gs/open5gs/issues/1652))

* [tests] Fix running unit tests inside docker environment

The issue was introduced with the commit, which builds Open5GS from
local sources instead of downloading them each time from Github.

Fixes: [d2cbcf7](https://github.com/securitylab-repository/open5gs_ciot/commit/d2cbcf7118eea6be2a6da315fb5a5442f8bf719e) ("[build] Use local sources to build applications ([open5gs#1583](https://github.com/open5gs/open5gs/pull/1583))")

* [SBI] Add function to request NF Instance from NRF by providing it's Instance Id

* [SMF] Send PDU Session Establish Accept to serving AMF

In case there are multiple AMF registered to NRF, SMF would pick only
the first AMF from the list.
In the case of sending PDU Session Establishment Accept from SMF to
AMF, this would mean a high chance of failure since the AMF might
be different than the original requester, and would not know about a
particular UE.

Modify SMF to use ServingNfId field from original request
SmContextCreateData from AMF to determine to which AMF should it send
PDU Session Establishment Accept message.

* Set default Network-Access-Mode to 0

For HSS's which do not include the NAM, the MME should not treat this as a fatal error.  MME should just assume PACKET_AND_CIRCUIT (0), as was decided in a previous PR.

* [MME] Handle Charging Characteristics

Found no support for HSS provided charging characteristics.  Following TS32.251 A.4:
- Use PDN level CC, if one wasn't provided then use subscription level CC
- Don't send CC in S11 if it wasn't included

* Moving handling of assigning sub level cc into the pdn to s11.

* Support Discovery Optional Parameter ([open5gs#1671](https://github.com/open5gs/open5gs/pull/1671))

To support target-nf-instance-id in the discovery,
Discovery optional parameter is implemeted

* Oops! Warning removed!

* Refine code of discovery option param ([open5gs#1671](https://github.com/open5gs/open5gs/pull/1671))

* Release v2.4.9

* [MME] Introduce support for S6a Cancel Location Request

- Added diameter dictionary definitions for Cancel Location
- Cancel Location will completely remove UE from MME, allow for a fresh IMSI attach to occur on next attempt.
- T3422 is used for detach request.
- Added new handling for s6a events in mme-sm, as not all s6a messages are at attach now.  Maybe there's something in a state machine I should've been using here instead of a new flag?

- Testing was completed with UE in idle and connected.  With CLR flags indicating re-attach required and without.  Also sending CLR after UE detach.  And then sending again when mme_ue is empty.

* Refact paging module ([open5gs#1676](https://github.com/open5gs/open5gs/pull/1676))

* [MME] Changed S1AP_Cause in S1AP Release ([open5gs#1676](https://github.com/open5gs/open5gs/pull/1676))

S1AP_CauseNas_detach -> S1AP_CauseNas_normal_release

* [SBI] Fixed nf_instance memory leak

- Rollback commit [ed3444e](https://github.com/securitylab-repository/open5gs_ciot/commit/ed3444eef5e9e57705645b500dbd6c5af453703f)
- Do not modify reference count when REGISTER/DEREGISTER notified from NRF

* [PFCP] Revert Changes [5e18b2b](https://github.com/securitylab-repository/open5gs_ciot/commit/5e18b2bd13e16246b20838e84d92f6bf9ec15f5c)

* [MME+HSS] AVP Occurring Too Many Times

Do not Set Origin-Hosts with fd_msg_rescode_set before potential use of ogs_diam_message_experimental_rescode_set.  This results in multiple Origin-Host/Realm AVPs.

* [Diameter] Fixed Coding convention ([open5gs#1680](https://github.com/open5gs/open5gs/pull/1680))

* [NRF] Fixed the nfInstanceUri ([open5gs#1683](https://github.com/open5gs/open5gs/issues/1683))

* [PFCP] Revert Changes [5e18b2b](https://github.com/securitylab-repository/open5gs_ciot/commit/5e18b2bd13e16246b20838e84d92f6bf9ec15f5c) and [d21e9aa](https://github.com/securitylab-repository/open5gs_ciot/commit/d21e9aa5e0db5930bc2d47b6eb29bf9fe591a23a)

To protect malicious or buggy, we need to check that session context is NULL.

* Changed configuration name from gnb to peer

And restored gtp_peer configuration

* [GTP] gtp_peer override the pool size of GTP node

* [MME] Changed CauseNas_detach in DETACH ([open5gs#1676](https://github.com/open5gs/open5gs/pull/1676))

* [SBI] Increased the max stream number

* [SBI] CLIENT max concurrent streams to 16384

* Move src/../nf-sm.[ch] to lib/sbi/nf-sm.[ch]

* [PFCP] Fixed security protection

Check the length to prevent buffer overflow attacks.

* Lower Linux version cannot change HTTP2 max stream

CURLMOPT_MAX_CONCURRENT_STREAMS can be supported as of curl 7.67.0

* [SMF]: Update stored PCO IE requested in GTPv2 over S5c in SMF context

As per 3GPP TS 29.274 version 10.5.0, section 7.2.9 and 7.2.10,
Only if PCO IE is included in Delete Session Request then it
must be present in Delete Session Response.

In order to reflect on whether the request contained PCO IE or not
the SMF context containing the GTP request needs to be updated
i.e. update if present else clear the contents

* [SMF]: Update stored PCO IE requested over Gn in SMF context

As per 3GPP TS 29.060 version 15.3.0, section 7.3.3, 7.3.4, 7.3.5 and 7.3.6

Only if PCO IE is included in Update/Delete PDP Context Request then it
must be present in Update/Delete PDP Context Response.

In order to reflect on whether the request contained PCO IE or not
the SMF context containing the GTP request needs to be updated
i.e. update if present else clear the contents

* Update docs [@nickvsnetworking](https://github.com/nickvsnetworking) and @[@s5uishida](https://github.com/s5uishida)

* Update docs [@s5uishida](https://github.com/s5uishida)

* Removed duplicated document link

* Fixed Defects reported by Coverity Scan

* [DOCS] Updated if subscribers changed [[open5gs#1694](https://github.com/open5gs/open5gs/issues/1694)]

* [PFCP] security vulnerability continued in [d99491a](https://github.com/securitylab-repository/open5gs_ciot/commit/d99491aca5304460d3929b37bf26e064efd86686)

* [MME] Cancel Location Handling ([open5gs#1698](https://github.com/open5gs/open5gs/pull/1698))

* CLR while idle is broken after [open5gs@7031856](https://github.com/open5gs/open5gs/commit/7031856cd779af0129ca444e18bbe2ed5db9ff32)

Cancel Location Request arriving while UE is idle will not proceed to paging due to this check for S1 connection.  Using new flag "isAnswer" to bypass this check to allow paging to occur when we are not doing a AIA/ULA related procedure.

* No Context Setup is required when sending the detach request.  If the paging was due to wanting to send a Detach Request to the UE, then we fast track to sending the detach request.

* emm-sm.c:
In the case of MME initiated detach while UE is idle, there is no initial conext setup.  We go right from the service request after paging into sending the detach request.  TS23.401

mme-path.c:
Using nas_eps.type in the case of MME Initiated Detach while UE is idle does not work.  nas_eps.type would represent the service request.

mme-s11-handler.c:
After S11 action, no action should be taken.  We want to wait for the detach accept from the UE before proceeding with the S1 release (detach).

* InitialContextSetup should occur for detach.

* [MME] Follow-up Cancel Location Handling ([open5gs#1698](https://github.com/open5gs/open5gs/pull/1698))

* [MME] Fixed GTP transaction crash ([open5gs#1696](https://github.com/open5gs/open5gs/issues/1696))

* [SGsAP] Changed message if Paging failed ([open5gs#1701](https://github.com/open5gs/open5gs/issues/1701))

The problem occurred in the following scenario:

1. VLR sent PAGING-REQUEST to the MME
2. MME sent S1-Paging to the UE
3. Paging failed
4. MME responded SERVICE-REQUEST to the VLR
5. VLR sent DOWNLINK-UNITDATA to the MME
6. Even though there is no S1 Context,
   MME try to sent DownlinkNASTransport message to the UE.
7. So, the problem occurred.

I've changed the number 4 PAGING-REJECT instead of SERVICE-REQUEST.

* [MME] Detach removed MME-UE context ([open5gs#1698](https://github.com/open5gs/open5gs/pull/1698))

* [MME] UE-initiated detach removes S1 only ([open5gs#1698](https://github.com/open5gs/open5gs/pull/1698))

* [SMF] Fix abort on app exit when no Diameter configuration

In case that SMF was configured to run without Diameter, it would crash
on application exit due to uninitialized variables/pointers.

ERROR  pid:unnamed in fd_sess_handler_destroy@sessions.c:324: ERROR: Invalid parameter '(handler && ( ((*handler) != ((void *)0)) && ( ((struct session_handler *)(*handler))->eyec == 0x53554AD1) ))', 22
[smf] FATAL: smf_gx_final: Assertion `ret == 0' failed. (../src/smf/gx-path.c:1353)

* [MME] Dictionary Updates and IDR Support ([open5gs#1714](https://github.com/open5gs/open5gs/pull/1714))

* Add Diameter Dictionary Elements

* Initial IDR Framework

* Resolve Compile Issues

* Moving Closer

* Compile error

* Somewhat Working stuffing Code

* Add Timestamp Changes

* Cleanup some of this code.  mme_s6a_handle_idr in s6a-handler.c removed for now, since it will only come in handy when IDR flag is set to request current location, which would involve breaking out into paging.  I think there's a few other things we can do just within fd-path first.

* further removal of mme_s6a_handle_idr

* Follow up on [open5gs#1714](https://github.com/open5gs/open5gs/pull/1714)

* Changed sprintf to ogs_snprintf

* Limited to 80 column

* [NRF] Fixed library load error

* [metrics] Fix double-free on application exit ([open5gs#1717](https://github.com/open5gs/open5gs/pull/1717))

* [SBI] Support service-names in discovery option

* [SBI] Added config for service-names discovery

* diameter: Gx: add AVP 3GPP-Charging-Characteristics

The 3GPP-Charging-Characteristics is an operator specific AVP
(optional). The 3GPP-Charging-Characteristics can be filled by the HSS
and pass through to the Gx interface.

See ETSI 29.212 5.4.0.1 for further details.

* [SMF] send 3GPP-Charging-Characteristics on Gx if received on S5/8c

The 3GPP-Charging-Characteristics is an operator specific AVP
(optional). The 3GPP-Charging-Characteristics can be filled by the HSS
and forwarded by the MME towards the SMF.

* Follow up on [open5gs#1715](https://github.com/open5gs/open5gs/pull/1715)

* Changed <TAB> to <SPACE>*4

* Changed snprintf to ogs_snprintf

* [Conf] Changed MTU size from 1500 to 1400

* [SMF] fixup send 3GPP-Charging-Characteristics on Gx if received on S5/8c

- Gy instead of Gx AVP was used.
- Use correct avp position and avp variables.

Fixes: [657eef9](https://github.com/securitylab-repository/open5gs_ciot/commit/657eef9169af49268d8d92cecb3ed872e954b015) ("[SMF] send 3GPP-Charging-Characteristics on Gx if received on S5/8c")

* Added Service-based NF discovery

== Known limitation ==
Placing npcf-smpolicycontrol and pcf-policyauthorization
in different NFs is not supported. Both npcf-smpolicycontrol
and pcf-policyauthorization should be placed in the same NF.

* [ALL] Removing trailing whitespace and tab

* [MME] Fixed buffer overflow ([open5gs#1728](https://github.com/open5gs/open5gs/issues/1728))

* Added simple test program

./tests/registration/registration simple-test
./tests/vonr/vonr simple-test
./tests/attach/attach simple-test
./tests/volte/volte simple-test

* [SMF] Handle upCnxState=ACTIVATING by replying with 200 instead of 204

According to TS 29.502 5.2.2.3.2.2., we should reply with a 200 response
including the upCnxState attribute.

* Follow-up on [open5gs#1729](https://github.com/open5gs/open5gs/pull/1729)

* [SBI] Send NF discovery query with service-names delimited with comma

OpenAPI specification for sending NF discovery query with
"service-names" parameter is defined as folowing:

- name: service-names
  ...
  style: form
  explode: false

According to OpenAPI specification, this means array items
should be delimited with a comma character (example: /users?id=3,4,5).

* [PCF] Check NF service configuration

* npcf-smpolicycontrol - enabled or disabled
* npcf-policyauthorization - enabled or disabled

Only one of npcf-smpolicycontrol and npcf-policyauthorization cannot be enabled. (../src/pcf/sbi-path.c:151)

They can be enabled or disabled together.

* [CORE] Check if timer is double free in SBI module

* removing extra lines

I did not find the purpose of their use

* [AMF] Accept Deregistration Notification from UDM only for registered UE ([open5gs#1737](https://github.com/open5gs/open5gs/pull/1737))

Add additional check when receiving Deregistration Notification from
UDM. UE should already be in registered state before accepting the
request and deregistering the UE.

Also add additional check that PCF association policy exists before
sending a delete request to PCF.

* When using longer APN name, it is obscured due to short field.

* Also format for pcc_rule.  UE and SMF look okay as medium_data as first section.

* Minor typo fix

* Support service-based NF subscription

* [AMF] Handle APN/DNN names as case-insensitive

In case that APN name sent from UE does not case-match with the one
configured in the database, AMF would reject the registration with the
message:

[gmm] WARNING: [imsi-xxx] DNN Not Supported OR Not Subscribed in the
Slice (../src/amf/gmm-handler.c:1051)

* Follow-up on [open5gs#1747](https://github.com/open5gs/open5gs/pull/1747)

* Release v2.4.10

* Added Release Notes for v2.4.10

* Introduce Cancel Location and Insert Subscriber Data features to HSS. ([open5gs#1744](https://github.com/open5gs/open5gs/pull/1744))

* Introduce Cancel Location and Insert Subscriber Data features to HSS.
* HSS database will keep track of last known MME and Update Time
* Purged UE flag is established in HSS for future PUR handling
* HSS Thread will connect to database and watch change stream
  mongoDB must be configured with a Replica Set to use this
* HSS will send IDR if subscription data changes
* HSS will send CLR to old MME if MME host or realm changes
* Function created to allow ULA and IDR to generate Subscription-Data AVP
* MME Hostname and Realm shown in WebUI

* Resolve freeDiameter errors

During a ULR, if database does not contain a last known MME, a CLR is being sent to a Null destination.  This will ensure that a destination is available in the database before sending the CLR.

* Removed change streams.  Added PUR handling.

* newline needed at end of file.

* Removed temp variable.

* * Change WebUI to 2x2 display
* Including UE Purged indicator
* Using pointers in ogs_subscription_data_t
* better memory mangement with pointers
* Tweak to Destination used by hss_s6a_send_idr to use last known MME

* Check for null mme_host and mme_realms

Do this before trying to compare the strings.

* Follow-up on [open5gs#1744](https://github.com/open5gs/open5gs/pull/1744)

* [SMF] Wait for both N1&N2 release signals before releasing session

When UE would send a request to release PDU session, AMF would
eventually send "PDU Session Resource Release Command" downlink to both
UE (N1) and gNB (N2). Each UE and gNB would then reply with "PDU Session
Resource Release Response" indicating they released their own resources.

Usually the first one to respond would be gNB. SMF made an assumption
that this would always be the case. And it would wait for signal that UE
resources were freed, before releasing session resources. But
occasionally the situation is that UE responds first, and SMF releases
resources prematurely.

This situation does not normally occur. But under high stress (100's of
UE PDU releases at the same time) this happens occasionally.
According to the standard, this situation is perfectly normal.

3GPP TS 23.502 Rel. 16
4.3.4.2 UE or network requested PDU Session Release for Non-Roaming and
Roaming with Local Breakout
...
Steps 8-10 may happen before steps 6-7.
...

* Added commercial 5G

* Add tested Ericsson gNodeBs and eNodeBs

* [DOC] Fixed alphabet order

* Sponsors logo updated to be dark-mode friendly

* Updated favicon.ico in Document

* [GTP/PFCP] TLV length more acceptable ([open5gs#1780](https://github.com/open5gs/open5gs/discussions/1780))

Acceptable even if the TLV length is smaller than expected

* [AMF] Add amfInfoList to NFProfile

The actual configured GUAMIs and TAIs are used to form NF profile.
Comparing to SMF the "info" section is not introduced into amf.yaml!
Each amf_id (region, set) produces a separate Info in the InfoList.
Guami list consists of all GUAMIs of particular Info.
taiList consists of all TAIs for all PLMNs of particular Info.

Examle:

amf.yaml:
    guami:
      - plmn_id:
          mcc: 999
          mnc: 70
        amf_id:
          region: 2
          set: 2
          pointer: 4
      - plmn_id:
          mcc: 001
          mnc: 01
        amf_id:
          region: 2
          set: 1
      - plmn_id:
          mcc: 001
          mnc: 02
        amf_id:
          region: 2
          set: 2
    tai:
      - plmn_id:
          mcc: 001
          mnc: 01
        tac: [1, 2, 3]
    tai:
      - plmn_id:
          mcc: 002
          mnc: 02
        tac: 4
      - plmn_id:
          mcc: 001
          mnc: 02
        tac: 10
    tai:
      - plmn_id:
          mcc: 004
          mnc: 04
        tac: [6, 7]
      - plmn_id:
          mcc: 005
          mnc: 05
        tac: 8
      - plmn_id:
          mcc: 999
          mnc: 70
        tac: [9, 10]

"amfInfoList":  {
        "1":    {
                "amfSetId":     "002",
                "amfRegionId":  "02",
                "guamiList":    [{
                                "plmnId":       {
                                        "mcc":  "999",
                                        "mnc":  "70"
                                },
                                "amfId":        "020084"
                        }, {
                                "plmnId":       {
                                        "mcc":  "001",
                                        "mnc":  "02"
                                },
                                "amfId":        "020080"
                        }],
                "taiList":      [{
                                "plmnId":       {
                                        "mcc":  "001",
                                        "mnc":  "02"
                                },
                                "tac":  "00000a"
                        }, {
                                "plmnId":       {
                                        "mcc":  "999",
                                        "mnc":  "70"
                                },
                                "tac":  "000009"
                        }, {
                                "plmnId":       {
                                        "mcc":  "999",
                                        "mnc":  "70"
                                },
                                "tac":  "00000a"
                        }]
        },
        "2":    {
                "amfSetId":     "001",
                "amfRegionId":  "02",
                "guamiList":    [{
                                "plmnId":       {
                                        "mcc":  "001",
                                        "mnc":  "01"
                                },
                                "amfId":        "020040"
                        }],
                "taiList":      [{
                                "plmnId":       {
                                        "mcc":  "001",
                                        "mnc":  "01"
                                },
                                "tac":  "000001"
                        }, {
                                "plmnId":       {
                                        "mcc":  "001",
                                        "mnc":  "01"
                                },
                                "tac":  "000002"
                        }, {
                                "plmnId":       {
                                        "mcc":  "001",
                                        "mnc":  "01"
                                },
                                "tac":  "000003"
                        }]
        }
}

* Follow-up on [open5gs#1757](https://github.com/open5gs/open5gs/pull/1757)

* [HSS] Enable Change Streams ([open5gs#1758](https://github.com/open5gs/open5gs/pull/1758))

* [HSS] Enable Change Streams
* Enable Events and Timers in HSS
* Integrate change streams in dbi
* mongodb should be configured with replica sets enabled to use feature
* Change streams are optional in HSS
* Timer will poll change stream for changes in the database
* As changes are detected, event is created to perform the correct
  action

* Changes made as suggested

* Follow-up on [open5gs#1758](https://github.com/open5gs/open5gs/pull/1758)

* Update document

* [TLV] Added more debug information ([open5gs#1767](https://github.com/open5gs/open5gs/issues/1767))

* Fixed HTTP2 crashes for random JSON data ([open5gs#1769](https://github.com/open5gs/open5gs/issues/1769))

* [core] fix timer overflow on 32bit systems ([open5gs#16](https://github.com/open5gs/open5gs/issues/16))

must cast ts.tv_sec to 64bits before we multiply it to prevent 32bit math and overflow

* Follow-up on [open5gs#1770](https://github.com/open5gs/open5gs/pull/1770)

* [SGWC] Fixed a crash ([open5gs#1765](https://github.com/open5gs/open5gs/issues/1765))

Session context could be deleted before a response message is not
received from SMF

* add addr/port to pfcp assoc/de-assoc logs ([open5gs#40](https://github.com/open5gs/open5gs/issues/40))

pfcp association log adds addr/port

* [GTP] Changes the print message ([open5gs#1772](https://github.com/open5gs/open5gs/pull/1772))

* [config,metrics] Move metrics configuration section under respective NF section

Without this change, using metrics with core setup configurations
(configs/vonr.yaml for example) would not be possible. Having one
metrics section for whole config file causes every NF to start metrics
server on same port causing an abort.

* Follow-on up [open5gs#1754](https://github.com/open5gs/open5gs/pull/1754)

* [DOC] iptable setting for security ([open5gs#1768](https://github.com/open5gs/open5gs/issues/1768))

* [MME] Added protection code if no PDN-Type ([open5gs#1756](https://github.com/open5gs/open5gs/issues/1756))

* Changes new GA4 in Google Analytics

* Commercial Term by NeoPlane - <https://neoplane.io/>

* Fix UL and DL URR Usage Report

* Follow-on up [open5gs#1793](https://github.com/open5gs/open5gs/pull/1793)

* [AMF] Fix for switching state when sending Deregistration Request fails

Provide pointer to state machine, instead of pointer to timer structure.
Bug was noticed when switching compiler optimization to -O2.

* [5GC] Fixed session deletion in a BSF ([open5gs#1725](https://github.com/open5gs/open5gs/issues/1725))

* [UPF] test code for unspecified address ([open5gs#1776](https://github.com/open5gs/open5gs/discussions/1776))

* [Security] Fixed a crash for port scanning ([open5gs#1767](https://github.com/open5gs/open5gs/issues/1767))

* Release v2.4.11

* Added Release Notes for v2.4.11

* [MME] Support for Insert Subscriber Data ([open5gs#1794](https://github.com/open5gs/open5gs/pull/1794))

* [MME] Support for Insert Subscriber Data

* Supported AVPs in IDR will overwrite existing subscription information
* Provide error on partial APN updates
* IDR and ULA use same function to process AVPs
* Move subdatamask values into s6a, so both HSS and MME can use them
* Updates are not actioned at this time.  A Re-attach is required for
  most changes to take effect

* Memory issue on IDR exceptions

* Remove of handling MSIDSN change until DSR is used

* Follow-on up [open5gs#1794](https://github.com/open5gs/open5gs/pull/1794)

* [SBI] Client Request timeout

TS29.500
Ch 6.11 Detection and handling of late arriving requests

In Open5GS, this part was hard-corded.

HTTP2 Client sends a request and waits for 10 seconds.
If no response is received from the HTTP2 Server,
HTTP2 Client performs the exception handling.

In this commit, HTTP2 client sends Header with setting Max-Rsp-Time to 10 seconds.
However, HTTP2 server has not yet been implemented to process this value.
The server is still processing using hard-corded values (10 seconds).

* [MME] Cancel Location while Idle ([open5gs#1797](https://github.com/open5gs/open5gs/pull/1797))

* Cancel Location while Idle Fix

* Forgot about SGSAP on MME Change.

Added "action" to sgsap_send_detach..

* Make handle_clr uniform with other handlers

* Added Robustness for Any Detach Type

* Memory wasn't freed upon CLR for unknown IMSIs

* Moving MME Detach to new PR

* Follow-up on [open5gs#1797](https://github.com/open5gs/open5gs/pull/1797)

* ogs_info swaps CP and UP SEIDs

* Follow-up on [open5gs#1797](https://github.com/open5gs/open5gs/pull/1797)

* fix dropped_dl_traffic_threshold ie.

* [AMF,UDM] Add support to subscribe to SDM changes

AMF subscribes to UDM for each registered UE.

At the moment, UDM does not send callback to AMF when any of the UE's
properties in the database changes.
At the moment, AMF does properly parse the ModificationNotification, but
does not do anything useful.

* [SMF] Update PFCP report error situation ([open5gs#1819](https://github.com/open5gs/open5gs/pull/1819))

* Revert the previous commit on [open5gs#1797](https://github.com/open5gs/open5gs/pull/1797)

* Updated SBI module

- Introduced NF_INSTANCE_ID/NF_INSTANCE_TYPE
- Skip SCP in configuration validation

* [AMF] Increase size of TMSI pool

Each UE context has 'current' and 'next' TMSI values. AMF first
allocates the 'next' value, before confirming it and releasing the
'previous'. This means that we potentially need pool size of 2x the
amount of maximum configured UE.

Without this change, AMF would crash in case that there are 'x'
configured maximum amount of UE, and there are already 'x' registered
UE.

[gmm] INFO: Registration request (../src/amf/gmm-sm.c:135)
[gmm] INFO: [suci-0-001-01-1234-0-1-1000000000]    SUCI (../src/amf/gmm-handler.c:149)
[gmm] DEBUG:     OLD TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:179)
[gmm] DEBUG:     NEW TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:186)
[amf] FATAL: amf_m_tmsi_alloc: Assertion `m_tmsi' failed. (../src/amf/context.c:2160)
[core] FATAL: backtrace() returned 13 addresses (../lib/core/ogs-abort.c:37)

* [AMF] Reject registration requests when pool for UE contexts is empty

AMF does not crash anymore when a new UE registration request arrives,
and there is no available space left in UE context pool. Now it just
rejects the request with an error.

* Follow-up on [open5gs#1828](https://github.com/open5gs/open5gs/pull/1828)

* Follow-up on [open5gs#1827](https://github.com/open5gs/open5gs/pull/1827)

* [DBI] Disable Change Streams with mongo Version

Support for change stream is only available in mongoc >=1.9.0
- Disabled related functions in dbi.
Support for bson to json used in debug statement only in libbson >=1.7.0
- Simple debug message in lower versions

* Follow-up on [open5gs#1827](https://github.com/open5gs/open5gs/pull/1827)

* Update README.md

Signed-off-by: Networkmama <networkmama12@gmail.com>
Co-authored-by: Sukchan Lee <acetcom@gmail.com>
Co-authored-by: Pau Espin Pedrol <pespin@sysmocom.de>
Co-authored-by: Bostjan Meglic <103102696+bmeglicit@users.noreply.github.com>
Co-authored-by: Networkmama <networkmama12@gmail.com>
Co-authored-by: Bostjan Meglic <b.meglic@iskratel.si>
Co-authored-by: Oliver Smith <osmith@sysmocom.de>
Co-authored-by: jmasterfunk84 <48972964+jmasterfunk84@users.noreply.github.com>
Co-authored-by: herlesupreeth <herlesupreeth@gmail.com>
Co-authored-by: Alexander Couzens <lynxis@fe80.eu>
Co-authored-by: mitmitmitm <m.rihtarsic@iskratel.si>
Co-authored-by: EugeneBogush <eugeneb2008@gmail.com>
Co-authored-by: neg2led <4232981+neg2led@users.noreply.github.com>
Co-authored-by: Gaber Stare <g.stare@iskratel.si>
Co-authored-by: Spencer Sevilla <spencer.builds.networks@gmail.com>
Co-authored-by: Dibas Das <dibasdas02@gmail.com>
Co-authored-by: safaorhann <safa.orhan@b-ulltech.com>
```

[NLag](/NLag)
added a commit
to securitylab-repository/open5gs\_ciot
that referenced
this issue
[Mar 14, 2023](#ref-commit-175b475)
[![@NLag](https://avatars.githubusercontent.com/u/23296450?s=40&u=e3580870f84ea63e0be0f838c827a29c8dbe5eb2&v=4)](/NLag) [![@dibasdas02](https://avatars.githubusercontent.com/u/84923695?s=40&v=4)](/dibasdas02)
[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=40&u=71a6e5e0382ff3d0e1191594f5fb838bfc2268bf&v=4)](/acetcom) [![@bmeglic](https://avatars.githubusercontent.com/u/103102696?s=40&v=4)](/bmeglic) [![@jmasterfunk84](https://avatars.githubusercontent.com/u/48972964?s=40&v=4)](/jmasterfunk84) [![@spencersevilla](https://avatars.githubusercontent.com/u/1691412?s=40&v=4)](/spencersevilla) [![@ssafaorhan](https://avatars.githubusercontent.com/u/95750427?s=40&u=c95e9e49bcb03d0642a1861fee04b43d0c926a69&v=4)](/ssafaorhan) [![@mitmitmitm](https://avatars.githubusercontent.com/u/106949222?s=40&v=4)](/mitmitmitm) [![@EugeneBogush](https://avatars.githubusercontent.com/u/1798186?s=40&u=0b2c70944ac63dd38b439ab12b6087c539cb854d&v=4)](/EugeneBogush) [![@lost-res](https://avatars.githubusercontent.com/u/28389382?s=40&v=4)](/lost-res) [![@bojanHub](https://avatars.githubusercontent.com/u/83633896?s=40&v=4)](/bojanHub) [![@lester-001](https://avatars.githubusercontent.com/u/55822214?s=40&v=4)](/lester-001) [![@miguelbf-alb](https://avatars.githubusercontent.com/u/80750248?s=40&u=8fb7e04fe8244ddd76e6f9fddc440efe96c6a445&v=4)](/miguelbf-alb) [![@gstaa](https://avatars.githubusercontent.com/u/93838663?s=40&v=4)](/gstaa) [![@matejGradisar](https://avatars.githubusercontent.com/u/120629867?s=40&u=1bacd0e87576705603ed41d47114390f35462764&v=4)](/matejGradisar) [![@ridzafauzi](https://avatars.githubusercontent.com/u/36556704?s=40&v=4)](/ridzafauzi) [![@pobk](https://avatars.githubusercontent.com/u/923392?s=40&v=4)](/pobk) [![@alishir](https://avatars.githubusercontent.com/u/978306?s=40&u=26c89d8b10a29d67b071f90623e90d6d35177477&v=4)](/alishir)

`[Merge main with test (](/securitylab-repository/open5gs_ciot/commit/175b475eec13115733ad8ad5dd92000c4519323a "Merge main with test (#4)

* Fix UL and DL URR Usage Report

* Follow-on up #1793

* [AMF] Fix for switching state when sending Deregistration Request fails

Provide pointer to state machine, instead of pointer to timer structure.
Bug was noticed when switching compiler optimization to -O2.

* [5GC] Fixed session deletion in a BSF (#1725)

* [UPF] test code for unspecified address (#1776)

* [Security] Fixed a crash for port scanning (#1767)

* Release v2.4.11

* Added Release Notes for v2.4.11

* [MME] Support for Insert Subscriber Data (#1794)

* [MME] Support for Insert Subscriber Data

* Supported AVPs in IDR will overwrite existing subscription information
* Provide error on partial APN updates
* IDR and ULA use same function to process AVPs
* Move subdatamask values into s6a, so both HSS and MME can use them
* Updates are not actioned at this time.  A Re-attach is required for
  most changes to take effect

* Memory issue on IDR exceptions

* Remove of handling MSIDSN change until DSR is used

* Follow-on up #1794

* [SBI] Client Request timeout

TS29.500
Ch 6.11 Detection and handling of late arriving requests

In Open5GS, this part was hard-corded.

HTTP2 Client sends a request and waits for 10 seconds.
If no response is received from the HTTP2 Server,
HTTP2 Client performs the exception handling.

In this commit, HTTP2 client sends Header with setting Max-Rsp-Time to 10 seconds.
However, HTTP2 server has not yet been implemented to process this value.
The server is still processing using hard-corded values (10 seconds).

* [MME] Cancel Location while Idle (#1797)

* Cancel Location while Idle Fix

* Forgot about SGSAP on MME Change.

Added \"action\" to sgsap_send_detach..

* Make handle_clr uniform with other handlers

* Added Robustness for Any Detach Type

* Memory wasn't freed upon CLR for unknown IMSIs

* Moving MME Detach to new PR

* Follow-up on #1797

* ogs_info swaps CP and UP SEIDs

* Follow-up on #1797

* fix dropped_dl_traffic_threshold ie.

* [AMF,UDM] Add support to subscribe to SDM changes

AMF subscribes to UDM for each registered UE.

At the moment, UDM does not send callback to AMF when any of the UE's
properties in the database changes.
At the moment, AMF does properly parse the ModificationNotification, but
does not do anything useful.

* [SMF] Update PFCP report error situation (#1819)

* Revert the previous commit on #1797

* Updated SBI module

- Introduced NF_INSTANCE_ID/NF_INSTANCE_TYPE
- Skip SCP in configuration validation

* [AMF] Increase size of TMSI pool

Each UE context has 'current' and 'next' TMSI values. AMF first
allocates the 'next' value, before confirming it and releasing the
'previous'. This means that we potentially need pool size of 2x the
amount of maximum configured UE.

Without this change, AMF would crash in case that there are 'x'
configured maximum amount of UE, and there are already 'x' registered
UE.

[gmm] INFO: Registration request (../src/amf/gmm-sm.c:135)
[gmm] INFO: [suci-0-001-01-1234-0-1-1000000000]    SUCI (../src/amf/gmm-handler.c:149)
[gmm] DEBUG:     OLD TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:179)
[gmm] DEBUG:     NEW TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:186)
[amf] FATAL: amf_m_tmsi_alloc: Assertion `m_tmsi' failed. (../src/amf/context.c:2160)
[core] FATAL: backtrace() returned 13 addresses (../lib/core/ogs-abort.c:37)

* [AMF] Reject registration requests when pool for UE contexts is empty

AMF does not crash anymore when a new UE registration request arrives,
and there is no available space left in UE context pool. Now it just
rejects the request with an error.

* Follow-up on #1828

* Follow-up on #1827

* [DBI] Disable Change Streams with mongo Version

Support for change stream is only available in mongoc >=1.9.0
- Disabled related functions in dbi.
Support for bson to json used in debug statement only in libbson >=1.7.0
- Simple debug message in lower versions

* Follow-up on #1827

* Update README.md

* SCP(Model D) is now the default setting.

* remove warning in MacOSX (#1797)

* Fixed the WebUI to Support MongoDB 6.0(#1824)

* SCP is added in Debian package

* Fixed the bug of SGW-C session deletion (#1825)

* Release v2.5.0

* Added missing files(SCP for systemd)

* Release v2.5.0

* Update document for v2.5.0

* [AMF] Support REREGISTRATION_REQUIRED in dereg notify

* Fixed a bug WebUI for production build (#1824)

* Support SMF Security Indication IE (#1851)

* Release v2.5.1

* Document update for v2.5.1

* [NAS] Discard message if Integrity failed (#1848)

* SCP had a serioud memory problem and fixed it

* Fix to avoid port (7777) conflicts on Mac OS X

* Release v2.5.2

* fix for scp daemon (#1872)

* fix

* fix2

* fix

* Release v2.5.3

* added open5gs-scp

* Release v2.5.4

* [SBI] Do not send empty arrays when registering to NRF

OpenAPI dictates that certain arrays should have at least one item,
otherwise they should not be present.
This includes lists for IPv4/v6 addresses, TAI/TAC lists, ...

Add a check if there is at least 1 item, before creating an array.
Also move variable declarations to inner blocks, to prevent some
accidental usage out of wanted scope.

* Follow-up on #1876

* Squashed commit of the following:

commit 5070c19a5469269d036bf243ebdb2740aefc7b8d
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 15:46:35 2022 +0900

    updte it

commit e49107f46152ff6dce5658b48cfb2c31df61724a
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 11:03:37 2022 +0900

    update it

commit a55b977e044b1d74ccc8a19f1dbf8194c3cd7daa
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 10:50:41 2022 +0900

    update it

commit 0ff0930d99bfeb91134271dae0941b4c454d1a3d
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 10:09:35 2022 +0900

    update it

commit 8cb5038b66d4a605446c6fc200b77f645f7ad328
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 09:39:08 2022 +0900

    update it

commit 0a6829dfb6470f3d9b786363d49387fdc688e33b
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 09:06:22 2022 +0900

    update it

commit ea85035300d9a42cc5f8f7ee300d28cd055f0f1c
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 21:36:17 2022 +0900

    update it

commit e86ba621de332d3f712569cf0580fc8a5321adbd
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 17:39:27 2022 +0900

    update it

commit 2c05df84eabeba7c277c622e5d810768b2895961
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 16:20:47 2022 +0900

    update it

commit 43c88aed3f2001fdbc28ce0f11cc21dfcdc5906f
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Wed Nov 2 22:17:37 2022 +0900

    update it

commit b374db4e02e7dd153944f5a6fdc2a50c434dfa09
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Wed Nov 2 22:05:53 2022 +0900

    update it

* Fix the WebUI installation bug

* Fixed the WebUI installation

* Release v2.5.5

* [WebUI] Change installation script (#1824)

* [SMF] Fixed PTI when PDU Session Reject

* Build webui from local source

Use local copy of source code to build webui,
instead of downloading the code from Github.

* Rollback WebUI (#1882)

* [AMF] Add implicit_unsubscribe field to SDMSubscription

* Build WebUI from local source

Use local copy of source code to build WebUI,
instead of downloading the code from Github.

* Update 01-quickstart.md

Change S1AP bind address for external eNB.

* Follow-up on #1886

* Add TLS support

* Fix TLS error handling

* Follow-up on #1865

* [SBI] Introduced HTTP2-TLS based on #1865

Verfication is not implemented.

* Changed the location of Osmocom nightly build

* Added OSS Notice

* Update document

* Update document

* Update document

* [metrics] Fix log output for metrics

Even if the configured log level for the application was set to \"error\",
the first \"info\" message of the metrics library was output to the log.
Reorder the initialization of the metrics library.

* Fixed crash after 48 hours of running (#1893)

* Prometheus metrics set to default

* Fixed prometheus-client-c branch next to open5gs

* Fixed test code for MacOSX Ventura

* update document

* Fixed MacOSX Test code

* Removed MongoDB from WebUI install-script (#1824)

* Oops! errata

* OpenAPI: Move any_type.[ch] from custom/ into sbi/openapi/model/

This makes it possible to have object values of type \"any_type\" in OpenAPI
specifications.

* OpenAPI: Generate patch_item.[ch] from OpenAPI specifications

* OpenAPI: AnyType for ChangeItem's newValue and origValue properties

* get amf_ue from sess

amf_ue will be null and cause a coredump when type is OGS_SBI_OBJ_SESS_TYPE.

* [AMF/MME] Refactor SM to prevent crash (#1912)

* Fixed alpine stack overflow (#1911)

* Continue to fix alpine stack overflow (#1911)

* [AMF/MME] forget UE Radio Capability (#1917)

forgetting the UE Radio Capabilities
when UE is sending NAS \"De-Registration Request\" with \"type = Switch-off

* [WebUI] Install on MongoDB below v6.0 (#1910)

* OpenAPI: Add functions OpenAPI_list_clear and OpenAPI_list_insert_prev

* [UDM] Handle SDM unsubscribe

* [UDM/UDR] Handle UEAuthentication authRemovalInd

* [AUSF] Handle UEAuthentication DELETE

* [AMF] Allow unspecified (infinity) ue_ambr up/downlink limits

* [AMF] Add support for SDM subscription and authentication deletion

* [AMF] Handle am-data/ratRestrictions change notification

When such a notification arrives from UDM, delete the corresponding SDM
subscription from the UDM and deregister the UE if it becomes RAT restricted.

* [AMF] Handle am-data/subscribedUeAmbr change notification

When such a notification arrives from UDM, notify the GNB of the new values
AMBR uplink/downlink values.

* [AMF/MME] Added Timer Configuration (#1905)

* [AMF/MME] Added missing T3423 in conf (#1905)

* Fixed manual of sgwu.yaml conf

* [UPF] Fixed an infinte loop when ext_len is 0

* [SBI] Remove redundant code (#1923)

* Added more log in GTP Error (#1920)

* [AMF] Wrongly sending PDU Session Release (#1925)

* [AMF] Fixed a crash while NGReset (#1928)

* amf: fix regression for smf selection

* free replybuf after sent replay message

* [SBI] Case-Insensitive inside MIME message (#1939)

* [UPF] Add metrics support

Expose metrics with labels according to ETSI TS 128 552 V16.13.0 in
UPF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

5qi is not available in UPF.
To present 5qi to the user, MN will have to maintain a table qfi->5qi
for each QoS flow (will have to get information from SMF).
So UPF has to expose qfi. qfi itself is not useful. When used, UPF will
have to expose additional label to define the session (e.g. source
interface).

Label dnn is set to value of APN/DNN received in Establishment.
Since SMF does not add APN/DNN to Establishment, the label is empty.
When APN/DNN will be set by SMF, it should be added to sess in UPF
and used in metrics on Modification and Deletion.

Both datavolumeqosleveln3upf are exposed in bytes.
MN is providing the transformation to kbits.

fivegs_upffunction_upf_qosflows should expose the number of QFIs used in
sessions, but exposes number of QER rules, which is currently equal to
QFIs.
The label snsssai is not provided since the slice is not available on UPF.

Exposed metrics example:
Standard counters:
fivegs_ep_n3_gtp_indatapktn3upf 28637
fivegs_ep_n3_gtp_outdatapktn3upf 14729
fivegs_upffunction_sm_n4sessionestabreq 4
fivegs_upffunction_sm_n4sessionestabfail{cause=\"66\"} 1
fivegs_upffunction_sm_n4sessionestabfail{cause=\"71\"} 68
fivegs_upffunction_sm_n4sessionestabfail{cause=\"68\"} 4
fivegs_upffunction_sm_n4sessionestabfail{cause=\"72\"} 15
fivegs_upffunction_sm_n4sessionestabfail{cause=\"75\"} 3
fivegs_upffunction_sm_n4sessionestabfail{cause=\"65\"} 4
fivegs_upffunction_sm_n4sessionreport 0
fivegs_upffunction_sm_n4sessionreportsucc 0
fivegs_ep_n3_gtp_indatavolumeqosleveln3upf{qfi=\"1\"} 39792997
fivegs_ep_n3_gtp_outdatavolumeqosleveln3upf{qfi=\"1\"} 737548
Nonstandard gauge (added for controlling purposes -
same metric as existing metric on AMF and SMF):
fivegs_upffunction_upf_sessionnbr 1
Standard gauge:
fivegs_upffunction_upf_qosflows{dnn=\"\"} 1

* [PCF] Add metrics support

Expose metrics with labels according to ETSI TS 128 552 V16.13.0 in
PCF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

AM policy:
fivegs_pcffunction_pa_policyamassoreq and
fivegs_pcffunction_pa_policyamassosucc do not expose snssai label
since it is not available at the time of exposure.
plmnid is defined during AM policy processing, so not to lose the
difference to ...succ, the basic metric
fivegs_pcffunction_pa_policyamassoreq is preserved.

SM policy:
snssai is defined during SM policy processing, so not to lose the
difference to ...succ, the basic metric
fivegs_pcffunction_pa_policysmassoreq is preserved.

Those 2 basic metrics retain their position but are exposed with empty
labels.
Metrics with labels are called later, when the label values are known.

Exposed metrics example:
-standard counters:
fivegs_pcffunction_pa_policyamassoreq{plmnid=\"\"} 3
fivegs_pcffunction_pa_policyamassoreq{plmnid=\"99970\"} 3
fivegs_pcffunction_pa_policyamassosucc{plmnid=\"99970\"} 3
fivegs_pcffunction_pa_policysmassoreq{plmnid=\"\",snssai=\"\"} 3
fivegs_pcffunction_pa_policysmassoreq{plmnid=\"99970\",snssai=\"1000009\"} 3
fivegs_pcffunction_pa_policysmassosucc{plmnid=\"99970\",snssai=\"1000009\"} 3

-nonstandard gauge (added for controlling purposes -
same metric as existing metric on AMF and SMF):
fivegs_pcffunction_pa_sessionnbr{plmnid=\"99970\",snssai=\"1000009\"} 0

* Follow-up on #1940

* Follow-up on #1940 - Fixed compile error

* [SMF] fix crash due free-ing invalid pointer

In case that database is (manually) corrupted for a specific UE, SSC
mode and ARP preemption vulnerability fields are not set correctly,
SMF will crash when trying to build a request to create PCF association.

Function smf_npcf_smpolicycontrol_build_create() will end prematurely,
and when cleaning up resources it will try to free() up invalid pointer,
which was not set to 0 at beginning of the function.

[smf] ERROR: SSCMode is not allowed (../src/smf/nudm-handler.c:165)
[sbi] DEBUG: STATUS [201] (../lib/sbi/nghttp2-server.c:443)
[sbi] DEBUG: SENDING...: 3 (../lib/sbi/nghttp2-server.c:451)
[sbi] DEBUG: {
} (../lib/sbi/nghttp2-server.c:452)
[sbi] DEBUG: STREAM closed [1] (../lib/sbi/nghttp2-server.c:962)
[smf] ERROR: No Arp.preempt_cap (../src/smf/npcf-build.c:132)
<crash>

0  __GI_abort () at ./stdlib/abort.c:107
1  0x00007f9348fe43b1 in ?? () from /lib/x86_64-linux-gnu/libtalloc.so.2
2  0x00007f9349aef745 in ogs_talloc_free (ptr=0x7f9348e38dab <_int_free+1675>,
    location=0x5591b8675d27 \"../src/smf/npcf-build.c:181\") at ../lib/core/ogs-memory.c:107
3  0x00005591b8653c45 in smf_npcf_smpolicycontrol_build_create (sess=0x7f9343070010, data=0x0)
    at ../src/smf/npcf-build.c:181
4  0x00007f9349abc2b4 in ogs_sbi_xact_add (sbi_object=0x7f9343070010,
    service_type=OGS_SBI_SERVICE_TYPE_NPCF_SMPOLICYCONTROL, discovery_option=0x7f9338006d90,
    build=0x5591b86531d0 <smf_npcf_smpolicycontrol_build_create>, context=0x7f9343070010, data=0x0)
    at ../lib/sbi/context.c:1699
5  0x00005591b86580be in smf_sbi_discover_and_send (service_type=OGS_SBI_SERVICE_TYPE_NPCF_SMPOLICYCONTROL,
    discovery_option=0x0, build=0x5591b86531d0 <smf_npcf_smpolicycontrol_build_create>, sess=0x7f9343070010,
    stream=0x7f9344fce0a0, state=0, data=0x0) at ../src/smf/sbi-path.c:110
6  0x00005591b864e9da in smf_nudm_sdm_handle_get (sess=0x7f9343070010, stream=0x7f9344fce0a0,
    recvmsg=0x7f933f52d5a0) at ../src/smf/nudm-handler.c:290
7  0x00005591b8600c96 in smf_gsm_state_wait_5gc_sm_policy_association (s=0x7f9343070610, e=0x7f9338076730)
    at ../src/smf/gsm-sm.c:523
...

* [AMF] Add RM metrics support

Expose RM metrics with labels according to ETSI TS 128 552 V16.13.0 in
AMF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

RegInitFail is exposed as an alternative to RegInitReq and RegInitSucc
counters so cause label can be provided. It counts rejected registrations
and rejected authentications.
Rejected authentications are counted under label cause=\"0\".

Exposed metrics example:
-standard gauge:
fivegs_amffunction_rm_registeredsubnbr{plmnid=\"00101\",snssai=\"1000009\"} 1

-nonstandard counter:
fivegs_amffunction_rm_reginitfail{cause=\"3\"} 4

* [SMF] Add SM metrics support

Expose SM metrics with labels according to ETSI TS 128 552 V16.13.0 in
SMF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>
Existing gauge sessions_active is renamed!

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

Exposed metrics example:
-standard gauges:
fivegs_smffunction_sm_sessionnbr{plmnid=\"00101\",snssai=\"1000009\"} 0
fivegs_smffunction_sm_qos_flow_nbr{plmnid=\"00101\",snssai=\"1000009\",fiveqi=\"9\"} 0

-nonstandard counters:
fivegs_smffunction_sm_n4sessionestabfail{cause=\"71\"} 68
fivegs_smffunction_sm_n4sessionreport 1
fivegs_smffunction_sm_n4sessionreportsucc 1
fivegs_smffunction_sm_n4sessionestabreq 1

* [AMF] Fix deletion of auth data from AUSF

* free socket fd

call ogs_sock_destroy to free sock when fail to get socket fd

* Update document

* Update document

* Add NF load to NRF Heartbeat

The current load percentage of the NF Service Consumer is provided
in the payload body of the PATCH request when periodically
contacting the NRF (heart-beat).

AMF: ratio between currently connected ran_ue and maximum number of them
SMF: ratio between current PDU sessions and maximum available
PCF: ratio between current AM+SM policy associations and maximum available
     or ratio between currently connected UEs and maximum number of them
     (the load which is higher)
AUSF, UDM: ratio between currently connected UE and maximum number of them
BSF: ratio between current sessions and maximum available
NSSF: ratio between currently used NSIs and maximum number of them

NRF currently doesn't determine that the NF Profile has changed.

* [SMF] Fix metric bearers_active

Metric 'bearers_active' was incremented in only one code path
(smf_bearer_add() for 4G only), while it was decremented from two paths
(smf_bearer_remove() for both 4G and 5G).
Increment metric also for 5G path (smf_qos_flow_add()), so it won't get
decremented into negative values.

* [mongo] Use \"ping\" command instead of \"serverStatus\"

\"serverStatus\" on the \"admin\" database may fail due to insufficient privileges.

* Introduced Subscription identifier de-concealing

 o Generate the private key as below.
   $ openssl genpkey -algorithm X25519 -out /etc/open5gs/hnet/curve25519-1.key
   $ openssl ecparam -name prime256v1 -genkey -conv_form compressed -out /etc/open5gs/hnet/secp256r1-2.key

 o The private and public keys can be viewed with the command.
   The public key is used when creating the SIM.
   $ openssl pkey -in /etc/open5gs/hnet/curve25519-1.key -text
   $ openssl ec -in /etc/open5gs/hnet/secp256r1-2.key -conv_form compressed -text

In ausf/udm.yaml

 hnet:
    o Home network public key identifier(PKI) value : 1
      Protection scheme identifier : ECIES scheme profile A
    - id: 1
      scheme: 1
      key: /etc/open5gs/hnet/curve25519-1.key

    o Home network public key identifier(PKI) value : 2
      Protection scheme identifier : ECIES scheme profile B
    - id: 2
      scheme: 2
      key: /etc/open5gs/hnet/secp256r1-2.key

    o Home network public key identifier(PKI) value : 3
      Protection scheme identifier : ECIES scheme profile A
    - id: 3
      scheme: 1
      key: /etc/open5gs/hnet/curve25519-1.key

    o Home network public key identifier(PKI) value : 4
      Protection scheme identifier : ECIES scheme profile B
    - id: 4
      scheme: 2
      key: /etc/open5gs/hnet/secp256r1-2.key

Related to #1779

* New AMF ID in SMF session context for 'inter-AMF change or mobility'

* Fixed SMF-METRICS bug in EPC

* SIDF only required in UDM, not AUSF (#1779)

* [MME] Clear UE Context for Attach Reject (#1848)

Attach Reject + PDN Connectivity Reject need to clear UE Context

* [PCRF] Fixed a crash (#1981)

An assertion was fired when switching between video and audio.

* [METRICS] Fixed a core dump in SMF/UPF/PCF (#1985)

* [AMF] Implicit Network-initiated Deregistration

Two timers are introduced (both with duration of T3512 + 4 min):
-MOBILE_REACHABLE
-IMPLICIT_DEREGISTRATION
MOBILE_REACHABLE is set when NAS connection for the UE is released.
IMPLICIT_DEREGISTRATION is set when MOBILE_REACHABLE expires.

On MOBILE_REACHABLE expiry Paging is ignored.
On IMPLICIT_DEREGISTRATION expiry:
-UE's RM_State is set to DEREGISTERED
-UE is Nudm_SDM_Unsubscribed
-UE is Nudm_UECM_Deregistered
-PDU sessions are released
-AM policies are deleted

Existing flag amf_ue->network_initiated_de_reg is used.

* [AMF] Follow-up on #1987

    [AMF] Implicit Network-initiated Deregistration

    Two timers are introduced (both with duration of T3512 + 4 min):
    -MOBILE_REACHABLE
    -IMPLICIT_DEREGISTRATION
    MOBILE_REACHABLE is set when NAS connection for the UE is released.
    IMPLICIT_DEREGISTRATION is set when MOBILE_REACHABLE expires.

    On MOBILE_REACHABLE expiry Paging is ignored.
    On IMPLICIT_DEREGISTRATION expiry:
    -UE's RM_State is set to DEREGISTERED
    -UE is Nudm_SDM_Unsubscribed
    -UE is Nudm_UECM_Deregistered
    -PDU sessions are released
    -AM policies are deleted

    Existing flag amf_ue->network_initiated_de_reg is used.

* [AMF] More Follow-up on #1987

* [pfcp] Fix code style

* [PCRF] More fixes for crashes (#1981)

* changed error tagged log to info tagged log for handling 5g guti information during Configuration Update procedure

* [SMF] Added User-ID, APP_DNN, S-NSSAI (#1986)

Added User-ID, APP_DNN, S-NSSAI in N4 PFCP Session Establishment Request

* [MME] Add Purge-UE Capability (#1991)

* [MME] Add Purge-UE Capability

* Add OGS_GTP_..._PURGE_AND_REMOVE to split CLR case

* Follow-up on #1991

* More follow-up on #1911

* Update document for v2.4.13

* Update document for 2.5.7

* Version update

* Update document for v2.4.13 and v2.5.7

* [AMF] Fixed RM metric RegisteredSubNbr (#2001)

* [UPF] Fixed bug when 2 PDRs with same TEID (#2003)

* [MME] Introduce aging timers

* Creating three new timers
* mirroring work done by gstaa on the AMF
* Implicit detach procedures added
* Fix for detach from unknown UE

* [METRICS] Re-order init/final (#1985, #2001)

* [AMF] Fixed MEMORY LEAK (#1925)

* [PROTO] Increase SDU buffer 8k->16k (#2008)

* [PFCP] Allow up to 8 framed routes for each IP type

* [BSF] Handle Ipv4FrameRouteList, save it into context

* [PCF] Handle framed routes, forward them to BSF

* [UPF] Handle framed routes

* [SMF] Handle framed routes, forward them to UPF and PCF

* Follow-up on #2009

* [AMF/MME] Fixed crash when no NG/S1 context(#2012)

* Update document for v2.5.8

* remove old document

* [UPF] URR time threshold log to info (#1997)

* [MME] Fixed a crash when no UE context (#2016)

* [LOG] remove ogs_expect_or_return()/return_val()

* [CORE] Rollback ogs_pkbuf_copy() from (#2012)

In the previous #2012 working, I've added ogs_pkbuf_free() for original
buffer. But, this rasied double free. So, I've rollback it,

* [PFCP] buffer overflow in ALPINE (#1911, #2009)

A buffer overflow occurred in ALPINE
because the size of the pfcp message structure increased by

    ogs_pfcp_tlv_framed_route_t framed_route[8];
    ogs_pfcp_tlv_framed_ipv6_route_t framed_ipv6_route[8];

* Fixed warning

* [CORE] Increase SDU buffer to 32k (#2008)

* [SBI] Fixed crash if no BW Unit(Xbps) (#2000)

* no Purge Timer, no config, expanded code

* [CORE] OGS_MAX_SDU_LEN->OGS_HUGE_LEN Stack (#2008)

Changed all OGS_MAX_SDU_LEN in the stack to OGS_HUGE_LEN.

* [AMF/AMF] Not assert for ogs_asn_copy_ie() (#2018)

Does not raise an assertion even if open5gs cannot handle the ASN in
ogs_asn_copy_ie()

* [AMF] Fixed crashes from malformed 5GS-ID (#2020)

* [MME] Implicit Network-initiated Deregistration (#2013)

* [MME] Introduce aging timers

* Creating three new timers
* mirroring work done by gstaa on the AMF
* Implicit detach procedures added
* Fix for detach from unknown UE

* no Purge Timer, no config, expanded code

* update it

* ogs_session_s.framed_routes type change to (char **)

OpenAPI_list_t wasn't optimal as it created a dependency on ogs-sbi.h.

* [UDR] Read framed routes from DB send them in sm-data

The framed routes are stored in mongo as

 {
     \"imsi\" : \"$IMSI\",
     ...,
     \"slice\" :
     [{
         ...,
         \"session\" :
             ...,
             \"ipv4_framed_routes\" : [\"10.45.33.0/24\", \"10.45.35.0/24\"],
         }],
     }],
 },

* [MME] Fixed crash due to Paging routine (#2017)

* Added Service-MAP to Requester-Features (#2027)

ALWAYS Added Service-MAP to Requester-Features in Discovery Option

* [AMX] Fixed a crash due to deregistration (#2021)

Fixed an issue where AMF would crash
if an implicit deregistration occurred twice.

* [NRF] Fixed a crash during NRF discovery (#2034)

Other NF instances are obtained through NRF
or created directly through configuration files.

Other NFs created by the config file should not be passed
through NRF discovery or anything like that.

Since self-created NF Instances do not have an ID,
they are implemented to exclude them from NRF Discovery.

* [CORE] Add defense code to ogs_pkbuf_copy (#2032)

Added a defense code to prevent NF crash when ogs_pkbuf_copy() size is 0.

* [AMF] Network Initiated De-Register (#2014, #2021)

Resolved Network Initiated Implicit/Explicit De-Registration

* Update Document for Frame Routing (#2035)

* Remove not valid UTF-8 characters

These UTF-8 characters are causing issues with static code analysis
tools.

Error: encoding error in ./lib/crypt/zuc.c
'utf-8' codec can't decode byte 0x97 in position 3948: invalid start byte
Python3 requires input character data to be perfectly encoded;
it also requires perfectly correct system encoding settings.
Unfortunately, your data and/or system settings are not.

* [AMF] Network-Initiated Deregister (#2014, #2021)

Fixed a bug network-initiated implicit/explict deregistration

* [Gx/Gy] MAX_CC_REQUESTER_NUMBER(32->64) (#2038)

Incrased MAX_CC_REQUESTER_NUMBER from 32 to 64

* [NF] Fix double-free crash when NF is under heavy load

<nf>/init.c:<nf>_main() :
ogs_pollset_poll() receives the time of the expiration of next timer as
an argument. If this timeout is in very near future (1 millisecond),
and if there are multiple events that need to be processed by
ogs_pollset_poll(), these could take more than 1 millisecond for
processing, resulting in the timer already passed the expiration.

In case that another NF is under heavy load and responds to an SBI
request with some delay of a few seconds, it can happen that
ogs_pollset_poll() adds SBI responses to the event list for further
processing, then ogs_timer_mgr_expire() is called which will add an
additional event for timer expiration. When all events are processed
one-by-one, the SBI xact would get deleted twice in a row, resulting in
a crash.

0  __GI_abort () at ./stdlib/abort.c:107
1  0x00007f9de91693b1 in ?? () from /lib/x86_64-linux-gnu/libtalloc.so.2
2  0x00007f9de9a21745 in ogs_talloc_free (ptr=0x7f9d906c2c70, location=0x7f9de960bf41 \"../lib/sbi/message.c:2423\") at ../lib/core/ogs-memory.c:107
3  0x00007f9de95dbf31 in ogs_sbi_discovery_option_free (discovery_option=0x7f9d9090e670) at ../lib/sbi/message.c:2423
4  0x00007f9de95f7c47 in ogs_sbi_xact_remove (xact=0x7f9db630b630) at ../lib/sbi/context.c:1702
5  0x000055a482784846 in amf_state_operational (s=0x7f9d9488bbb0, e=0x7f9d90aecf20) at ../src/amf/amf-sm.c:604
6  0x00007f9de9a33cf0 in ogs_fsm_dispatch (fsm=0x7f9d9488bbb0, event=0x7f9d90aecf20) at ../lib/core/ogs-fsm.c:127
7  0x000055a48275b32e in amf_main (data=0x0) at ../src/amf/init.c:149
8  0x00007f9de9a249eb in thread_worker (arg=0x55a483d41d90) at ../lib/core/ogs-thread.c:67
9  0x00007f9de8fd2b43 in start_thread (arg=<optimized out>) at ./nptl/pthread_create.c:442
10 0x00007f9de9063bb4 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:100

* [SBI/NF] Follow-up on #2045

* Support for UPF HA - release/establish new PDU session

* Follow-up on #2048

* [SBI] HTTP/2 user-agent header (#2048)

Open5GS now checks User-AGENT only in SCP.

* [AMF/MME] Delete UERadioCapability (#2040, #1917)

o TS24.301(4G/LTE)
  5.5.1 Attach procedure
  5.5.1.2 Attach procedure for EPS services
  5.5.1.2.4 Attach accepted by the network

If the attach request is accepted by the network,
the MME shall delete the stored UE radio capability information
or the UE radio capability ID, if any.

o TS24.501(5G)
  5.5.2 De-registration procedure
  5.5.2.1 General

When the AMF enters the state 5GMM-DEREGISTERED for 3GPP access,
the AMF shall delete the stored UE radio capability information
or the UE radio capability ID, if any.

* [TEST] Reduce paging wait time

* [AMF] Network-Initiated Deregister (#2014, #2021)

I accidentally missed one so I added it again.

* [AMF] Delete UERadioCapability (#2040, #1917)

23.501 (5G NAS stage 2)
5.4.4.1:
\"When the AMF receives Registration Request with the Registration type set
to Initial Registration or when it receives the first Registration Request
after E-UTRA/EPC Attach with Registration type set to Mobility Registration
Update, the AMF deletes the UE radio capability.\"

* [SBI,NF] Don't treat SBI connection errors as asserts

* [AMF] Network Deregister (#2056, #2014, #2021)

Fixed a crash on explicit network-initiated deregister
with SUBSCRIPTION_WITHDRAWN

* [MME] KeNB derive from TAU(active flag=1) (#2063)

TS33.401
7 Security procedures between UE and EPS access network elements
7.2 Handling of user-related keys in E-UTRAN
7.2.7 Key handling for the TAU procedure when registered in E-UTRAN

If the \"active flag\" is set in the TAU request message or
the MME chooses to establish radio bearers when there is pending downlink
UP data or pending downlink signalling, radio bearers will be established
as part of the TAU procedure and a KeNB derivation is necessary.

* [SBI] Do not treat removed streams as errors when sending responses

This is in line with the implementation with microhttpd server
(mhd-server.c).

* [SBI] Fix possible crash when handling PatchItems in NFProfile PATCH req

* Follow-up on #2069

* [DOCS] Removed missing link

* Further Follow-up on #2063

* [pfcp] response_timeout should not call ogs_pfcp_xact_delete (#2072)

* [pfcp] response_timeout should never call ogs_pfcp_xact_delete (#50)

* also remove ogs_pfcp_xact_delete since never called

* also had to catch one more ogs_pfcp_sendto()

---------

Co-authored-by: Spencer Sevilla <spencer@MacBook-Air.local>

* [GTP/PFCP] Follow-up on #2073

* [gtpc] silently handle OGS_GTP2_CAUSE_UE_ALREADY_RE_ATTACHED (#17)

no need to log \"GTP Failed\"; just handle silently or move on.

* Issue housekeeping (#2078)

* Added GitHub issue templates and config.yaml for issue templating

* Fixed capitalisation of labels.

* updated bugreport.yaml template

* Fixed typos in GitHub templates and bug schemas (#2080)

* [SBI] HTTP2-TLS verification - ConfFile Changed

You should add the following configuration if you would not use TLS.

sbi:
    server:
      no_tls: true
    client:
      no_tls: true

* [SBI] Move HNET PKI conf inside UDM

* Updated bugreport.yaml

Fixed a typo/hangover from sense-checking

* Removed 'bug' from auto-labels on new issue template

* [AMF/SMF] Fixed a crash (#2030, #2074, #2085)

* Don't left-shift by negative amount, which is UB according to C17

* Remove MACOSX in github CI

* Update 01-quickstart.md

* [Release-17] Upgrade S1AP/NGAP to v17.3.9

* [PFCP] Support pfcp advertise address

* [SBI] Fixed openapitools MAP generation (#2103)

MAP was generated incorrectly because {{#items}}..{{#items}} was
missing.

Because of this, If scpInfo has scpPort, NRF crashes.

* [SBI] Crash occurs when ENUM in the MAP (#2103)

* [Release-17] Upgrade SBI to v17.x.0

* [AMF] Disallow handling service requests unless UE is already registered

* Follow-up on #2100

* [Release-17] Upgrade NAS to v17.8.0

* [PFCP/GTP] Fixed security bug (#2127,#2128,#2129)

* [Release-17] Upgrade GTPv1/v2 to v17.4.0/v17.7.0

* [Release-17] Upgrade PFCP to v17.7.1

* Added N32 Interface to implement SEPP

* [AMF] Expose more metrics

[ETSI TS 128 552 V16.9.0](https://www.etsi.org/deliver/etsi_ts/128500_128599/128552/16.09.00_60/ts_128552v160900p.pdf)

5.2.2 Registration procedure related measurements

SNSSAI labels are not provided.

- Number of registration requests received by the AMF is
exposed for each registration type.
```
fivegs_amffunction_rm_reginitreq 1
fivegs_amffunction_rm_regmobreq 0
fivegs_amffunction_rm_regperiodreq 0
fivegs_amffunction_rm_regemergreq 0
```

- Number of successful initial registrations at the AMF is
exposed for each registration type.
```
fivegs_amffunction_rm_reginitsucc 1
fivegs_amffunction_rm_regmobsucc 0
fivegs_amffunction_rm_regperiodsucc 0
fivegs_amffunction_rm_regemergsucc 0
```

- The existing counter of failed registrations at the AMF
is exposed separately for each registration type.
```
fivegs_amffunction_rm_reginitfail
fivegs_amffunction_rm_regmobfail
fivegs_amffunction_rm_regperiodfail
fivegs_amffunction_rm_regemergfail
```

5.2.5.2 Measurements for 5G paging

Number of 5G paging procedures initiated at the AMF:
```
fivegs_amffunction_mm_paging5greq 1
```
Number of successful 5G paging procedures initiated at the AMF:
```
fivegs_amffunction_mm_paging5gsucc 1
```

5.2.11 Authentication procedure related measurements

Number of authentication requests:
```
fivegs_amffunction_amf_authreq 2
```
Number of authentication rejections:
```
fivegs_amffunction_amf_authreject 1
```
Number of failed authentications due to parameter error:
```
fivegs_amffunction_amf_authfail{cause=\"21\"} 1
```

5.2.8 UE Configuration Update procedure related measurements

Number of UE Configuration Update commands requested by the AMF:
```
fivegs_amffunction_mm_confupdate 2
```
Number of UE Configuration Update complete messages received by the AMF:
```
fivegs_amffunction_mm_confupdatesucc 1
```

* [SMF] Fixed crash during UPF-HA process (#2115)

* Added log message for troubleshooting #2117

* Release v2.6.0

* Update document for v2.6.0

* Upgrade to Release-17

* Release v2.6.1

* Release v2.6.1

* Update document for v2.6.1

* [NAS/GTP/PFCP] Upgrade IE to Release-17

As raised in #2147, AMF fails to decode S1 UE Network Capability.

So I reviewed all IE in NAS, GTP and PFCP and fixed it for Release-17.

* [AMF] Fix handling Service Request

In case that handling Service Request results in an error, AMF sends a
Service Reject and sets UE's context to exception state. Without the
'break', the code would set UE's context to registered state.

* [BSF] Removed MongoDB in BSF configuration file

* [SBI] Added Handler for Subscription PATCH (#2152)

* [SBI] Conforms standard in Subscription API(#2152)

POST requests to {apiRoot}/nnrf-nfm/v1/subscriptions return
a HTTP Location header in 201 respose
in the form {apiRoot}/nnrf-nfm/v1/subscriptions/{subscriptionID}

* [SBI] Check POST format in Subscription (#2152)

POST requests to {apiRoot}/nnrf-nfm/v1/subscriptions/{subscriptionID} return an error

* add git ignore

---------

Co-authored-by: Dibas Das <dibasdas02@gmail.com>
Co-authored-by: Sukchan Lee <acetcom@gmail.com>
Co-authored-by: Bostjan Meglic <b.meglic@iskratel.si>
Co-authored-by: jmasterfunk84 <48972964+jmasterfunk84@users.noreply.github.com>
Co-authored-by: Spencer Sevilla <spencer.builds.networks@gmail.com>
Co-authored-by: safaorhann <safa.orhan@b-ulltech.com>
Co-authored-by: mitmitmitm <ois@oasd8i.at>
Co-authored-by: EugeneBogush <eugeneb2008@gmail.com>
Co-authored-by: Yarin Sergey <yarin@iskrauraltel.ru>
Co-authored-by: lost_res <wilcodex8@gmail.com>
Co-authored-by: Flander Bojan <flander@iskratel.si>
Co-authored-by: Lester <55822214+lester-001@users.noreply.github.com>
Co-authored-by: Miguel Borges de Freitas <miguel-r-freitas@alticelabs.com>
Co-authored-by: Gaber Stare <g.stare@iskratel.si>
Co-authored-by: Matej Gradisar <gradisar@iskratel.si>
Co-authored-by: ridzafauzi <ridza.fauzi@yahoo.com>
Co-authored-by: Spencer Sevilla <spencer@MacBook-Air.local>
Co-authored-by: Richard <pobk@users.noreply.github.com>
Co-authored-by: Ali Shirvani <alishirv@pm.me>")[#4](https://github.com/securitylab-repository/open5gs_ciot/pull/4)[)](/securitylab-repository/open5gs_ciot/commit/175b475eec13115733ad8ad5dd92000c4519323a "Merge main with test (#4)

* Fix UL and DL URR Usage Report

* Follow-on up #1793

* [AMF] Fix for switching state when sending Deregistration Request fails

Provide pointer to state machine, instead of pointer to timer structure.
Bug was noticed when switching compiler optimization to -O2.

* [5GC] Fixed session deletion in a BSF (#1725)

* [UPF] test code for unspecified address (#1776)

* [Security] Fixed a crash for port scanning (#1767)

* Release v2.4.11

* Added Release Notes for v2.4.11

* [MME] Support for Insert Subscriber Data (#1794)

* [MME] Support for Insert Subscriber Data

* Supported AVPs in IDR will overwrite existing subscription information
* Provide error on partial APN updates
* IDR and ULA use same function to process AVPs
* Move subdatamask values into s6a, so both HSS and MME can use them
* Updates are not actioned at this time.  A Re-attach is required for
  most changes to take effect

* Memory issue on IDR exceptions

* Remove of handling MSIDSN change until DSR is used

* Follow-on up #1794

* [SBI] Client Request timeout

TS29.500
Ch 6.11 Detection and handling of late arriving requests

In Open5GS, this part was hard-corded.

HTTP2 Client sends a request and waits for 10 seconds.
If no response is received from the HTTP2 Server,
HTTP2 Client performs the exception handling.

In this commit, HTTP2 client sends Header with setting Max-Rsp-Time to 10 seconds.
However, HTTP2 server has not yet been implemented to process this value.
The server is still processing using hard-corded values (10 seconds).

* [MME] Cancel Location while Idle (#1797)

* Cancel Location while Idle Fix

* Forgot about SGSAP on MME Change.

Added \"action\" to sgsap_send_detach..

* Make handle_clr uniform with other handlers

* Added Robustness for Any Detach Type

* Memory wasn't freed upon CLR for unknown IMSIs

* Moving MME Detach to new PR

* Follow-up on #1797

* ogs_info swaps CP and UP SEIDs

* Follow-up on #1797

* fix dropped_dl_traffic_threshold ie.

* [AMF,UDM] Add support to subscribe to SDM changes

AMF subscribes to UDM for each registered UE.

At the moment, UDM does not send callback to AMF when any of the UE's
properties in the database changes.
At the moment, AMF does properly parse the ModificationNotification, but
does not do anything useful.

* [SMF] Update PFCP report error situation (#1819)

* Revert the previous commit on #1797

* Updated SBI module

- Introduced NF_INSTANCE_ID/NF_INSTANCE_TYPE
- Skip SCP in configuration validation

* [AMF] Increase size of TMSI pool

Each UE context has 'current' and 'next' TMSI values. AMF first
allocates the 'next' value, before confirming it and releasing the
'previous'. This means that we potentially need pool size of 2x the
amount of maximum configured UE.

Without this change, AMF would crash in case that there are 'x'
configured maximum amount of UE, and there are already 'x' registered
UE.

[gmm] INFO: Registration request (../src/amf/gmm-sm.c:135)
[gmm] INFO: [suci-0-001-01-1234-0-1-1000000000]    SUCI (../src/amf/gmm-handler.c:149)
[gmm] DEBUG:     OLD TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:179)
[gmm] DEBUG:     NEW TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:186)
[amf] FATAL: amf_m_tmsi_alloc: Assertion `m_tmsi' failed. (../src/amf/context.c:2160)
[core] FATAL: backtrace() returned 13 addresses (../lib/core/ogs-abort.c:37)

* [AMF] Reject registration requests when pool for UE contexts is empty

AMF does not crash anymore when a new UE registration request arrives,
and there is no available space left in UE context pool. Now it just
rejects the request with an error.

* Follow-up on #1828

* Follow-up on #1827

* [DBI] Disable Change Streams with mongo Version

Support for change stream is only available in mongoc >=1.9.0
- Disabled related functions in dbi.
Support for bson to json used in debug statement only in libbson >=1.7.0
- Simple debug message in lower versions

* Follow-up on #1827

* Update README.md

* SCP(Model D) is now the default setting.

* remove warning in MacOSX (#1797)

* Fixed the WebUI to Support MongoDB 6.0(#1824)

* SCP is added in Debian package

* Fixed the bug of SGW-C session deletion (#1825)

* Release v2.5.0

* Added missing files(SCP for systemd)

* Release v2.5.0

* Update document for v2.5.0

* [AMF] Support REREGISTRATION_REQUIRED in dereg notify

* Fixed a bug WebUI for production build (#1824)

* Support SMF Security Indication IE (#1851)

* Release v2.5.1

* Document update for v2.5.1

* [NAS] Discard message if Integrity failed (#1848)

* SCP had a serioud memory problem and fixed it

* Fix to avoid port (7777) conflicts on Mac OS X

* Release v2.5.2

* fix for scp daemon (#1872)

* fix

* fix2

* fix

* Release v2.5.3

* added open5gs-scp

* Release v2.5.4

* [SBI] Do not send empty arrays when registering to NRF

OpenAPI dictates that certain arrays should have at least one item,
otherwise they should not be present.
This includes lists for IPv4/v6 addresses, TAI/TAC lists, ...

Add a check if there is at least 1 item, before creating an array.
Also move variable declarations to inner blocks, to prevent some
accidental usage out of wanted scope.

* Follow-up on #1876

* Squashed commit of the following:

commit 5070c19a5469269d036bf243ebdb2740aefc7b8d
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 15:46:35 2022 +0900

    updte it

commit e49107f46152ff6dce5658b48cfb2c31df61724a
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 11:03:37 2022 +0900

    update it

commit a55b977e044b1d74ccc8a19f1dbf8194c3cd7daa
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 10:50:41 2022 +0900

    update it

commit 0ff0930d99bfeb91134271dae0941b4c454d1a3d
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 10:09:35 2022 +0900

    update it

commit 8cb5038b66d4a605446c6fc200b77f645f7ad328
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 09:39:08 2022 +0900

    update it

commit 0a6829dfb6470f3d9b786363d49387fdc688e33b
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 09:06:22 2022 +0900

    update it

commit ea85035300d9a42cc5f8f7ee300d28cd055f0f1c
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 21:36:17 2022 +0900

    update it

commit e86ba621de332d3f712569cf0580fc8a5321adbd
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 17:39:27 2022 +0900

    update it

commit 2c05df84eabeba7c277c622e5d810768b2895961
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 16:20:47 2022 +0900

    update it

commit 43c88aed3f2001fdbc28ce0f11cc21dfcdc5906f
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Wed Nov 2 22:17:37 2022 +0900

    update it

commit b374db4e02e7dd153944f5a6fdc2a50c434dfa09
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Wed Nov 2 22:05:53 2022 +0900

    update it

* Fix the WebUI installation bug

* Fixed the WebUI installation

* Release v2.5.5

* [WebUI] Change installation script (#1824)

* [SMF] Fixed PTI when PDU Session Reject

* Build webui from local source

Use local copy of source code to build webui,
instead of downloading the code from Github.

* Rollback WebUI (#1882)

* [AMF] Add implicit_unsubscribe field to SDMSubscription

* Build WebUI from local source

Use local copy of source code to build WebUI,
instead of downloading the code from Github.

* Update 01-quickstart.md

Change S1AP bind address for external eNB.

* Follow-up on #1886

* Add TLS support

* Fix TLS error handling

* Follow-up on #1865

* [SBI] Introduced HTTP2-TLS based on #1865

Verfication is not implemented.

* Changed the location of Osmocom nightly build

* Added OSS Notice

* Update document

* Update document

* Update document

* [metrics] Fix log output for metrics

Even if the configured log level for the application was set to \"error\",
the first \"info\" message of the metrics library was output to the log.
Reorder the initialization of the metrics library.

* Fixed crash after 48 hours of running (#1893)

* Prometheus metrics set to default

* Fixed prometheus-client-c branch next to open5gs

* Fixed test code for MacOSX Ventura

* update document

* Fixed MacOSX Test code

* Removed MongoDB from WebUI install-script (#1824)

* Oops! errata

* OpenAPI: Move any_type.[ch] from custom/ into sbi/openapi/model/

This makes it possible to have object values of type \"any_type\" in OpenAPI
specifications.

* OpenAPI: Generate patch_item.[ch] from OpenAPI specifications

* OpenAPI: AnyType for ChangeItem's newValue and origValue properties

* get amf_ue from sess

amf_ue will be null and cause a coredump when type is OGS_SBI_OBJ_SESS_TYPE.

* [AMF/MME] Refactor SM to prevent crash (#1912)

* Fixed alpine stack overflow (#1911)

* Continue to fix alpine stack overflow (#1911)

* [AMF/MME] forget UE Radio Capability (#1917)

forgetting the UE Radio Capabilities
when UE is sending NAS \"De-Registration Request\" with \"type = Switch-off

* [WebUI] Install on MongoDB below v6.0 (#1910)

* OpenAPI: Add functions OpenAPI_list_clear and OpenAPI_list_insert_prev

* [UDM] Handle SDM unsubscribe

* [UDM/UDR] Handle UEAuthentication authRemovalInd

* [AUSF] Handle UEAuthentication DELETE

* [AMF] Allow unspecified (infinity) ue_ambr up/downlink limits

* [AMF] Add support for SDM subscription and authentication deletion

* [AMF] Handle am-data/ratRestrictions change notification

When such a notification arrives from UDM, delete the corresponding SDM
subscription from the UDM and deregister the UE if it becomes RAT restricted.

* [AMF] Handle am-data/subscribedUeAmbr change notification

When such a notification arrives from UDM, notify the GNB of the new values
AMBR uplink/downlink values.

* [AMF/MME] Added Timer Configuration (#1905)

* [AMF/MME] Added missing T3423 in conf (#1905)

* Fixed manual of sgwu.yaml conf

* [UPF] Fixed an infinte loop when ext_len is 0

* [SBI] Remove redundant code (#1923)

* Added more log in GTP Error (#1920)

* [AMF] Wrongly sending PDU Session Release (#1925)

* [AMF] Fixed a crash while NGReset (#1928)

* amf: fix regression for smf selection

* free replybuf after sent replay message

* [SBI] Case-Insensitive inside MIME message (#1939)

* [UPF] Add metrics support

Expose metrics with labels according to ETSI TS 128 552 V16.13.0 in
UPF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

5qi is not available in UPF.
To present 5qi to the user, MN will have to maintain a table qfi->5qi
for each QoS flow (will have to get information from SMF).
So UPF has to expose qfi. qfi itself is not useful. When used, UPF will
have to expose additional label to define the session (e.g. source
interface).

Label dnn is set to value of APN/DNN received in Establishment.
Since SMF does not add APN/DNN to Establishment, the label is empty.
When APN/DNN will be set by SMF, it should be added to sess in UPF
and used in metrics on Modification and Deletion.

Both datavolumeqosleveln3upf are exposed in bytes.
MN is providing the transformation to kbits.

fivegs_upffunction_upf_qosflows should expose the number of QFIs used in
sessions, but exposes number of QER rules, which is currently equal to
QFIs.
The label snsssai is not provided since the slice is not available on UPF.

Exposed metrics example:
Standard counters:
fivegs_ep_n3_gtp_indatapktn3upf 28637
fivegs_ep_n3_gtp_outdatapktn3upf 14729
fivegs_upffunction_sm_n4sessionestabreq 4
fivegs_upffunction_sm_n4sessionestabfail{cause=\"66\"} 1
fivegs_upffunction_sm_n4sessionestabfail{cause=\"71\"} 68
fivegs_upffunction_sm_n4sessionestabfail{cause=\"68\"} 4
fivegs_upffunction_sm_n4sessionestabfail{cause=\"72\"} 15
fivegs_upffunction_sm_n4sessionestabfail{cause=\"75\"} 3
fivegs_upffunction_sm_n4sessionestabfail{cause=\"65\"} 4
fivegs_upffunction_sm_n4sessionreport 0
fivegs_upffunction_sm_n4sessionreportsucc 0
fivegs_ep_n3_gtp_indatavolumeqosleveln3upf{qfi=\"1\"} 39792997
fivegs_ep_n3_gtp_outdatavolumeqosleveln3upf{qfi=\"1\"} 737548
Nonstandard gauge (added for controlling purposes -
same metric as existing metric on AMF and SMF):
fivegs_upffunction_upf_sessionnbr 1
Standard gauge:
fivegs_upffunction_upf_qosflows{dnn=\"\"} 1

* [PCF] Add metrics support

Expose metrics with labels according to ETSI TS 128 552 V16.13.0 in
PCF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

AM policy:
fivegs_pcffunction_pa_policyamassoreq and
fivegs_pcffunction_pa_policyamassosucc do not expose snssai label
since it is not available at the time of exposure.
plmnid is defined during AM policy processing, so not to lose the
difference to ...succ, the basic metric
fivegs_pcffunction_pa_policyamassoreq is preserved.

SM policy:
snssai is defined during SM policy processing, so not to lose the
difference to ...succ, the basic metric
fivegs_pcffunction_pa_policysmassoreq is preserved.

Those 2 basic metrics retain their position but are exposed with empty
labels.
Metrics with labels are called later, when the label values are known.

Exposed metrics example:
-standard counters:
fivegs_pcffunction_pa_policyamassoreq{plmnid=\"\"} 3
fivegs_pcffunction_pa_policyamassoreq{plmnid=\"99970\"} 3
fivegs_pcffunction_pa_policyamassosucc{plmnid=\"99970\"} 3
fivegs_pcffunction_pa_policysmassoreq{plmnid=\"\",snssai=\"\"} 3
fivegs_pcffunction_pa_policysmassoreq{plmnid=\"99970\",snssai=\"1000009\"} 3
fivegs_pcffunction_pa_policysmassosucc{plmnid=\"99970\",snssai=\"1000009\"} 3

-nonstandard gauge (added for controlling purposes -
same metric as existing metric on AMF and SMF):
fivegs_pcffunction_pa_sessionnbr{plmnid=\"99970\",snssai=\"1000009\"} 0

* Follow-up on #1940

* Follow-up on #1940 - Fixed compile error

* [SMF] fix crash due free-ing invalid pointer

In case that database is (manually) corrupted for a specific UE, SSC
mode and ARP preemption vulnerability fields are not set correctly,
SMF will crash when trying to build a request to create PCF association.

Function smf_npcf_smpolicycontrol_build_create() will end prematurely,
and when cleaning up resources it will try to free() up invalid pointer,
which was not set to 0 at beginning of the function.

[smf] ERROR: SSCMode is not allowed (../src/smf/nudm-handler.c:165)
[sbi] DEBUG: STATUS [201] (../lib/sbi/nghttp2-server.c:443)
[sbi] DEBUG: SENDING...: 3 (../lib/sbi/nghttp2-server.c:451)
[sbi] DEBUG: {
} (../lib/sbi/nghttp2-server.c:452)
[sbi] DEBUG: STREAM closed [1] (../lib/sbi/nghttp2-server.c:962)
[smf] ERROR: No Arp.preempt_cap (../src/smf/npcf-build.c:132)
<crash>

0  __GI_abort () at ./stdlib/abort.c:107
1  0x00007f9348fe43b1 in ?? () from /lib/x86_64-linux-gnu/libtalloc.so.2
2  0x00007f9349aef745 in ogs_talloc_free (ptr=0x7f9348e38dab <_int_free+1675>,
    location=0x5591b8675d27 \"../src/smf/npcf-build.c:181\") at ../lib/core/ogs-memory.c:107
3  0x00005591b8653c45 in smf_npcf_smpolicycontrol_build_create (sess=0x7f9343070010, data=0x0)
    at ../src/smf/npcf-build.c:181
4  0x00007f9349abc2b4 in ogs_sbi_xact_add (sbi_object=0x7f9343070010,
    service_type=OGS_SBI_SERVICE_TYPE_NPCF_SMPOLICYCONTROL, discovery_option=0x7f9338006d90,
    build=0x5591b86531d0 <smf_npcf_smpolicycontrol_build_create>, context=0x7f9343070010, data=0x0)
    at ../lib/sbi/context.c:1699
5  0x00005591b86580be in smf_sbi_discover_and_send (service_type=OGS_SBI_SERVICE_TYPE_NPCF_SMPOLICYCONTROL,
    discovery_option=0x0, build=0x5591b86531d0 <smf_npcf_smpolicycontrol_build_create>, sess=0x7f9343070010,
    stream=0x7f9344fce0a0, state=0, data=0x0) at ../src/smf/sbi-path.c:110
6  0x00005591b864e9da in smf_nudm_sdm_handle_get (sess=0x7f9343070010, stream=0x7f9344fce0a0,
    recvmsg=0x7f933f52d5a0) at ../src/smf/nudm-handler.c:290
7  0x00005591b8600c96 in smf_gsm_state_wait_5gc_sm_policy_association (s=0x7f9343070610, e=0x7f9338076730)
    at ../src/smf/gsm-sm.c:523
...

* [AMF] Add RM metrics support

Expose RM metrics with labels according to ETSI TS 128 552 V16.13.0 in
AMF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

RegInitFail is exposed as an alternative to RegInitReq and RegInitSucc
counters so cause label can be provided. It counts rejected registrations
and rejected authentications.
Rejected authentications are counted under label cause=\"0\".

Exposed metrics example:
-standard gauge:
fivegs_amffunction_rm_registeredsubnbr{plmnid=\"00101\",snssai=\"1000009\"} 1

-nonstandard counter:
fivegs_amffunction_rm_reginitfail{cause=\"3\"} 4

* [SMF] Add SM metrics support

Expose SM metrics with labels according to ETSI TS 128 552 V16.13.0 in
SMF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>
Existing gauge sessions_active is renamed!

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

Exposed metrics example:
-standard gauges:
fivegs_smffunction_sm_sessionnbr{plmnid=\"00101\",snssai=\"1000009\"} 0
fivegs_smffunction_sm_qos_flow_nbr{plmnid=\"00101\",snssai=\"1000009\",fiveqi=\"9\"} 0

-nonstandard counters:
fivegs_smffunction_sm_n4sessionestabfail{cause=\"71\"} 68
fivegs_smffunction_sm_n4sessionreport 1
fivegs_smffunction_sm_n4sessionreportsucc 1
fivegs_smffunction_sm_n4sessionestabreq 1

* [AMF] Fix deletion of auth data from AUSF

* free socket fd

call ogs_sock_destroy to free sock when fail to get socket fd

* Update document

* Update document

* Add NF load to NRF Heartbeat

The current load percentage of the NF Service Consumer is provided
in the payload body of the PATCH request when periodically
contacting the NRF (heart-beat).

AMF: ratio between currently connected ran_ue and maximum number of them
SMF: ratio between current PDU sessions and maximum available
PCF: ratio between current AM+SM policy associations and maximum available
     or ratio between currently connected UEs and maximum number of them
     (the load which is higher)
AUSF, UDM: ratio between currently connected UE and maximum number of them
BSF: ratio between current sessions and maximum available
NSSF: ratio between currently used NSIs and maximum number of them

NRF currently doesn't determine that the NF Profile has changed.

* [SMF] Fix metric bearers_active

Metric 'bearers_active' was incremented in only one code path
(smf_bearer_add() for 4G only), while it was decremented from two paths
(smf_bearer_remove() for both 4G and 5G).
Increment metric also for 5G path (smf_qos_flow_add()), so it won't get
decremented into negative values.

* [mongo] Use \"ping\" command instead of \"serverStatus\"

\"serverStatus\" on the \"admin\" database may fail due to insufficient privileges.

* Introduced Subscription identifier de-concealing

 o Generate the private key as below.
   $ openssl genpkey -algorithm X25519 -out /etc/open5gs/hnet/curve25519-1.key
   $ openssl ecparam -name prime256v1 -genkey -conv_form compressed -out /etc/open5gs/hnet/secp256r1-2.key

 o The private and public keys can be viewed with the command.
   The public key is used when creating the SIM.
   $ openssl pkey -in /etc/open5gs/hnet/curve25519-1.key -text
   $ openssl ec -in /etc/open5gs/hnet/secp256r1-2.key -conv_form compressed -text

In ausf/udm.yaml

 hnet:
    o Home network public key identifier(PKI) value : 1
      Protection scheme identifier : ECIES scheme profile A
    - id: 1
      scheme: 1
      key: /etc/open5gs/hnet/curve25519-1.key

    o Home network public key identifier(PKI) value : 2
      Protection scheme identifier : ECIES scheme profile B
    - id: 2
      scheme: 2
      key: /etc/open5gs/hnet/secp256r1-2.key

    o Home network public key identifier(PKI) value : 3
      Protection scheme identifier : ECIES scheme profile A
    - id: 3
      scheme: 1
      key: /etc/open5gs/hnet/curve25519-1.key

    o Home network public key identifier(PKI) value : 4
      Protection scheme identifier : ECIES scheme profile B
    - id: 4
      scheme: 2
      key: /etc/open5gs/hnet/secp256r1-2.key

Related to #1779

* New AMF ID in SMF session context for 'inter-AMF change or mobility'

* Fixed SMF-METRICS bug in EPC

* SIDF only required in UDM, not AUSF (#1779)

* [MME] Clear UE Context for Attach Reject (#1848)

Attach Reject + PDN Connectivity Reject need to clear UE Context

* [PCRF] Fixed a crash (#1981)

An assertion was fired when switching between video and audio.

* [METRICS] Fixed a core dump in SMF/UPF/PCF (#1985)

* [AMF] Implicit Network-initiated Deregistration

Two timers are introduced (both with duration of T3512 + 4 min):
-MOBILE_REACHABLE
-IMPLICIT_DEREGISTRATION
MOBILE_REACHABLE is set when NAS connection for the UE is released.
IMPLICIT_DEREGISTRATION is set when MOBILE_REACHABLE expires.

On MOBILE_REACHABLE expiry Paging is ignored.
On IMPLICIT_DEREGISTRATION expiry:
-UE's RM_State is set to DEREGISTERED
-UE is Nudm_SDM_Unsubscribed
-UE is Nudm_UECM_Deregistered
-PDU sessions are released
-AM policies are deleted

Existing flag amf_ue->network_initiated_de_reg is used.

* [AMF] Follow-up on #1987

    [AMF] Implicit Network-initiated Deregistration

    Two timers are introduced (both with duration of T3512 + 4 min):
    -MOBILE_REACHABLE
    -IMPLICIT_DEREGISTRATION
    MOBILE_REACHABLE is set when NAS connection for the UE is released.
    IMPLICIT_DEREGISTRATION is set when MOBILE_REACHABLE expires.

    On MOBILE_REACHABLE expiry Paging is ignored.
    On IMPLICIT_DEREGISTRATION expiry:
    -UE's RM_State is set to DEREGISTERED
    -UE is Nudm_SDM_Unsubscribed
    -UE is Nudm_UECM_Deregistered
    -PDU sessions are released
    -AM policies are deleted

    Existing flag amf_ue->network_initiated_de_reg is used.

* [AMF] More Follow-up on #1987

* [pfcp] Fix code style

* [PCRF] More fixes for crashes (#1981)

* changed error tagged log to info tagged log for handling 5g guti information during Configuration Update procedure

* [SMF] Added User-ID, APP_DNN, S-NSSAI (#1986)

Added User-ID, APP_DNN, S-NSSAI in N4 PFCP Session Establishment Request

* [MME] Add Purge-UE Capability (#1991)

* [MME] Add Purge-UE Capability

* Add OGS_GTP_..._PURGE_AND_REMOVE to split CLR case

* Follow-up on #1991

* More follow-up on #1911

* Update document for v2.4.13

* Update document for 2.5.7

* Version update

* Update document for v2.4.13 and v2.5.7

* [AMF] Fixed RM metric RegisteredSubNbr (#2001)

* [UPF] Fixed bug when 2 PDRs with same TEID (#2003)

* [MME] Introduce aging timers

* Creating three new timers
* mirroring work done by gstaa on the AMF
* Implicit detach procedures added
* Fix for detach from unknown UE

* [METRICS] Re-order init/final (#1985, #2001)

* [AMF] Fixed MEMORY LEAK (#1925)

* [PROTO] Increase SDU buffer 8k->16k (#2008)

* [PFCP] Allow up to 8 framed routes for each IP type

* [BSF] Handle Ipv4FrameRouteList, save it into context

* [PCF] Handle framed routes, forward them to BSF

* [UPF] Handle framed routes

* [SMF] Handle framed routes, forward them to UPF and PCF

* Follow-up on #2009

* [AMF/MME] Fixed crash when no NG/S1 context(#2012)

* Update document for v2.5.8

* remove old document

* [UPF] URR time threshold log to info (#1997)

* [MME] Fixed a crash when no UE context (#2016)

* [LOG] remove ogs_expect_or_return()/return_val()

* [CORE] Rollback ogs_pkbuf_copy() from (#2012)

In the previous #2012 working, I've added ogs_pkbuf_free() for original
buffer. But, this rasied double free. So, I've rollback it,

* [PFCP] buffer overflow in ALPINE (#1911, #2009)

A buffer overflow occurred in ALPINE
because the size of the pfcp message structure increased by

    ogs_pfcp_tlv_framed_route_t framed_route[8];
    ogs_pfcp_tlv_framed_ipv6_route_t framed_ipv6_route[8];

* Fixed warning

* [CORE] Increase SDU buffer to 32k (#2008)

* [SBI] Fixed crash if no BW Unit(Xbps) (#2000)

* no Purge Timer, no config, expanded code

* [CORE] OGS_MAX_SDU_LEN->OGS_HUGE_LEN Stack (#2008)

Changed all OGS_MAX_SDU_LEN in the stack to OGS_HUGE_LEN.

* [AMF/AMF] Not assert for ogs_asn_copy_ie() (#2018)

Does not raise an assertion even if open5gs cannot handle the ASN in
ogs_asn_copy_ie()

* [AMF] Fixed crashes from malformed 5GS-ID (#2020)

* [MME] Implicit Network-initiated Deregistration (#2013)

* [MME] Introduce aging timers

* Creating three new timers
* mirroring work done by gstaa on the AMF
* Implicit detach procedures added
* Fix for detach from unknown UE

* no Purge Timer, no config, expanded code

* update it

* ogs_session_s.framed_routes type change to (char **)

OpenAPI_list_t wasn't optimal as it created a dependency on ogs-sbi.h.

* [UDR] Read framed routes from DB send them in sm-data

The framed routes are stored in mongo as

 {
     \"imsi\" : \"$IMSI\",
     ...,
     \"slice\" :
     [{
         ...,
         \"session\" :
             ...,
             \"ipv4_framed_routes\" : [\"10.45.33.0/24\", \"10.45.35.0/24\"],
         }],
     }],
 },

* [MME] Fixed crash due to Paging routine (#2017)

* Added Service-MAP to Requester-Features (#2027)

ALWAYS Added Service-MAP to Requester-Features in Discovery Option

* [AMX] Fixed a crash due to deregistration (#2021)

Fixed an issue where AMF would crash
if an implicit deregistration occurred twice.

* [NRF] Fixed a crash during NRF discovery (#2034)

Other NF instances are obtained through NRF
or created directly through configuration files.

Other NFs created by the config file should not be passed
through NRF discovery or anything like that.

Since self-created NF Instances do not have an ID,
they are implemented to exclude them from NRF Discovery.

* [CORE] Add defense code to ogs_pkbuf_copy (#2032)

Added a defense code to prevent NF crash when ogs_pkbuf_copy() size is 0.

* [AMF] Network Initiated De-Register (#2014, #2021)

Resolved Network Initiated Implicit/Explicit De-Registration

* Update Document for Frame Routing (#2035)

* Remove not valid UTF-8 characters

These UTF-8 characters are causing issues with static code analysis
tools.

Error: encoding error in ./lib/crypt/zuc.c
'utf-8' codec can't decode byte 0x97 in position 3948: invalid start byte
Python3 requires input character data to be perfectly encoded;
it also requires perfectly correct system encoding settings.
Unfortunately, your data and/or system settings are not.

* [AMF] Network-Initiated Deregister (#2014, #2021)

Fixed a bug network-initiated implicit/explict deregistration

* [Gx/Gy] MAX_CC_REQUESTER_NUMBER(32->64) (#2038)

Incrased MAX_CC_REQUESTER_NUMBER from 32 to 64

* [NF] Fix double-free crash when NF is under heavy load

<nf>/init.c:<nf>_main() :
ogs_pollset_poll() receives the time of the expiration of next timer as
an argument. If this timeout is in very near future (1 millisecond),
and if there are multiple events that need to be processed by
ogs_pollset_poll(), these could take more than 1 millisecond for
processing, resulting in the timer already passed the expiration.

In case that another NF is under heavy load and responds to an SBI
request with some delay of a few seconds, it can happen that
ogs_pollset_poll() adds SBI responses to the event list for further
processing, then ogs_timer_mgr_expire() is called which will add an
additional event for timer expiration. When all events are processed
one-by-one, the SBI xact would get deleted twice in a row, resulting in
a crash.

0  __GI_abort () at ./stdlib/abort.c:107
1  0x00007f9de91693b1 in ?? () from /lib/x86_64-linux-gnu/libtalloc.so.2
2  0x00007f9de9a21745 in ogs_talloc_free (ptr=0x7f9d906c2c70, location=0x7f9de960bf41 \"../lib/sbi/message.c:2423\") at ../lib/core/ogs-memory.c:107
3  0x00007f9de95dbf31 in ogs_sbi_discovery_option_free (discovery_option=0x7f9d9090e670) at ../lib/sbi/message.c:2423
4  0x00007f9de95f7c47 in ogs_sbi_xact_remove (xact=0x7f9db630b630) at ../lib/sbi/context.c:1702
5  0x000055a482784846 in amf_state_operational (s=0x7f9d9488bbb0, e=0x7f9d90aecf20) at ../src/amf/amf-sm.c:604
6  0x00007f9de9a33cf0 in ogs_fsm_dispatch (fsm=0x7f9d9488bbb0, event=0x7f9d90aecf20) at ../lib/core/ogs-fsm.c:127
7  0x000055a48275b32e in amf_main (data=0x0) at ../src/amf/init.c:149
8  0x00007f9de9a249eb in thread_worker (arg=0x55a483d41d90) at ../lib/core/ogs-thread.c:67
9  0x00007f9de8fd2b43 in start_thread (arg=<optimized out>) at ./nptl/pthread_create.c:442
10 0x00007f9de9063bb4 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:100

* [SBI/NF] Follow-up on #2045

* Support for UPF HA - release/establish new PDU session

* Follow-up on #2048

* [SBI] HTTP/2 user-agent header (#2048)

Open5GS now checks User-AGENT only in SCP.

* [AMF/MME] Delete UERadioCapability (#2040, #1917)

o TS24.301(4G/LTE)
  5.5.1 Attach procedure
  5.5.1.2 Attach procedure for EPS services
  5.5.1.2.4 Attach accepted by the network

If the attach request is accepted by the network,
the MME shall delete the stored UE radio capability information
or the UE radio capability ID, if any.

o TS24.501(5G)
  5.5.2 De-registration procedure
  5.5.2.1 General

When the AMF enters the state 5GMM-DEREGISTERED for 3GPP access,
the AMF shall delete the stored UE radio capability information
or the UE radio capability ID, if any.

* [TEST] Reduce paging wait time

* [AMF] Network-Initiated Deregister (#2014, #2021)

I accidentally missed one so I added it again.

* [AMF] Delete UERadioCapability (#2040, #1917)

23.501 (5G NAS stage 2)
5.4.4.1:
\"When the AMF receives Registration Request with the Registration type set
to Initial Registration or when it receives the first Registration Request
after E-UTRA/EPC Attach with Registration type set to Mobility Registration
Update, the AMF deletes the UE radio capability.\"

* [SBI,NF] Don't treat SBI connection errors as asserts

* [AMF] Network Deregister (#2056, #2014, #2021)

Fixed a crash on explicit network-initiated deregister
with SUBSCRIPTION_WITHDRAWN

* [MME] KeNB derive from TAU(active flag=1) (#2063)

TS33.401
7 Security procedures between UE and EPS access network elements
7.2 Handling of user-related keys in E-UTRAN
7.2.7 Key handling for the TAU procedure when registered in E-UTRAN

If the \"active flag\" is set in the TAU request message or
the MME chooses to establish radio bearers when there is pending downlink
UP data or pending downlink signalling, radio bearers will be established
as part of the TAU procedure and a KeNB derivation is necessary.

* [SBI] Do not treat removed streams as errors when sending responses

This is in line with the implementation with microhttpd server
(mhd-server.c).

* [SBI] Fix possible crash when handling PatchItems in NFProfile PATCH req

* Follow-up on #2069

* [DOCS] Removed missing link

* Further Follow-up on #2063

* [pfcp] response_timeout should not call ogs_pfcp_xact_delete (#2072)

* [pfcp] response_timeout should never call ogs_pfcp_xact_delete (#50)

* also remove ogs_pfcp_xact_delete since never called

* also had to catch one more ogs_pfcp_sendto()

---------

Co-authored-by: Spencer Sevilla <spencer@MacBook-Air.local>

* [GTP/PFCP] Follow-up on #2073

* [gtpc] silently handle OGS_GTP2_CAUSE_UE_ALREADY_RE_ATTACHED (#17)

no need to log \"GTP Failed\"; just handle silently or move on.

* Issue housekeeping (#2078)

* Added GitHub issue templates and config.yaml for issue templating

* Fixed capitalisation of labels.

* updated bugreport.yaml template

* Fixed typos in GitHub templates and bug schemas (#2080)

* [SBI] HTTP2-TLS verification - ConfFile Changed

You should add the following configuration if you would not use TLS.

sbi:
    server:
      no_tls: true
    client:
      no_tls: true

* [SBI] Move HNET PKI conf inside UDM

* Updated bugreport.yaml

Fixed a typo/hangover from sense-checking

* Removed 'bug' from auto-labels on new issue template

* [AMF/SMF] Fixed a crash (#2030, #2074, #2085)

* Don't left-shift by negative amount, which is UB according to C17

* Remove MACOSX in github CI

* Update 01-quickstart.md

* [Release-17] Upgrade S1AP/NGAP to v17.3.9

* [PFCP] Support pfcp advertise address

* [SBI] Fixed openapitools MAP generation (#2103)

MAP was generated incorrectly because {{#items}}..{{#items}} was
missing.

Because of this, If scpInfo has scpPort, NRF crashes.

* [SBI] Crash occurs when ENUM in the MAP (#2103)

* [Release-17] Upgrade SBI to v17.x.0

* [AMF] Disallow handling service requests unless UE is already registered

* Follow-up on #2100

* [Release-17] Upgrade NAS to v17.8.0

* [PFCP/GTP] Fixed security bug (#2127,#2128,#2129)

* [Release-17] Upgrade GTPv1/v2 to v17.4.0/v17.7.0

* [Release-17] Upgrade PFCP to v17.7.1

* Added N32 Interface to implement SEPP

* [AMF] Expose more metrics

[ETSI TS 128 552 V16.9.0](https://www.etsi.org/deliver/etsi_ts/128500_128599/128552/16.09.00_60/ts_128552v160900p.pdf)

5.2.2 Registration procedure related measurements

SNSSAI labels are not provided.

- Number of registration requests received by the AMF is
exposed for each registration type.
```
fivegs_amffunction_rm_reginitreq 1
fivegs_amffunction_rm_regmobreq 0
fivegs_amffunction_rm_regperiodreq 0
fivegs_amffunction_rm_regemergreq 0
```

- Number of successful initial registrations at the AMF is
exposed for each registration type.
```
fivegs_amffunction_rm_reginitsucc 1
fivegs_amffunction_rm_regmobsucc 0
fivegs_amffunction_rm_regperiodsucc 0
fivegs_amffunction_rm_regemergsucc 0
```

- The existing counter of failed registrations at the AMF
is exposed separately for each registration type.
```
fivegs_amffunction_rm_reginitfail
fivegs_amffunction_rm_regmobfail
fivegs_amffunction_rm_regperiodfail
fivegs_amffunction_rm_regemergfail
```

5.2.5.2 Measurements for 5G paging

Number of 5G paging procedures initiated at the AMF:
```
fivegs_amffunction_mm_paging5greq 1
```
Number of successful 5G paging procedures initiated at the AMF:
```
fivegs_amffunction_mm_paging5gsucc 1
```

5.2.11 Authentication procedure related measurements

Number of authentication requests:
```
fivegs_amffunction_amf_authreq 2
```
Number of authentication rejections:
```
fivegs_amffunction_amf_authreject 1
```
Number of failed authentications due to parameter error:
```
fivegs_amffunction_amf_authfail{cause=\"21\"} 1
```

5.2.8 UE Configuration Update procedure related measurements

Number of UE Configuration Update commands requested by the AMF:
```
fivegs_amffunction_mm_confupdate 2
```
Number of UE Configuration Update complete messages received by the AMF:
```
fivegs_amffunction_mm_confupdatesucc 1
```

* [SMF] Fixed crash during UPF-HA process (#2115)

* Added log message for troubleshooting #2117

* Release v2.6.0

* Update document for v2.6.0

* Upgrade to Release-17

* Release v2.6.1

* Release v2.6.1

* Update document for v2.6.1

* [NAS/GTP/PFCP] Upgrade IE to Release-17

As raised in #2147, AMF fails to decode S1 UE Network Capability.

So I reviewed all IE in NAS, GTP and PFCP and fixed it for Release-17.

* [AMF] Fix handling Service Request

In case that handling Service Request results in an error, AMF sends a
Service Reject and sets UE's context to exception state. Without the
'break', the code would set UE's context to registered state.

* [BSF] Removed MongoDB in BSF configuration file

* [SBI] Added Handler for Subscription PATCH (#2152)

* [SBI] Conforms standard in Subscription API(#2152)

POST requests to {apiRoot}/nnrf-nfm/v1/subscriptions return
a HTTP Location header in 201 respose
in the form {apiRoot}/nnrf-nfm/v1/subscriptions/{subscriptionID}

* [SBI] Check POST format in Subscription (#2152)

POST requests to {apiRoot}/nnrf-nfm/v1/subscriptions/{subscriptionID} return an error

* add git ignore

---------

Co-authored-by: Dibas Das <dibasdas02@gmail.com>
Co-authored-by: Sukchan Lee <acetcom@gmail.com>
Co-authored-by: Bostjan Meglic <b.meglic@iskratel.si>
Co-authored-by: jmasterfunk84 <48972964+jmasterfunk84@users.noreply.github.com>
Co-authored-by: Spencer Sevilla <spencer.builds.networks@gmail.com>
Co-authored-by: safaorhann <safa.orhan@b-ulltech.com>
Co-authored-by: mitmitmitm <ois@oasd8i.at>
Co-authored-by: EugeneBogush <eugeneb2008@gmail.com>
Co-authored-by: Yarin Sergey <yarin@iskrauraltel.ru>
Co-authored-by: lost_res <wilcodex8@gmail.com>
Co-authored-by: Flander Bojan <flander@iskratel.si>
Co-authored-by: Lester <55822214+lester-001@users.noreply.github.com>
Co-authored-by: Miguel Borges de Freitas <miguel-r-freitas@alticelabs.com>
Co-authored-by: Gaber Stare <g.stare@iskratel.si>
Co-authored-by: Matej Gradisar <gradisar@iskratel.si>
Co-authored-by: ridzafauzi <ridza.fauzi@yahoo.com>
Co-authored-by: Spencer Sevilla <spencer@MacBook-Air.local>
Co-authored-by: Richard <pobk@users.noreply.github.com>
Co-authored-by: Ali Shirvani <alishirv@pm.me>")`
â€¦

`[175b475](/securitylab-repository/open5gs_ciot/commit/175b475eec13115733ad8ad5dd92000c4519323a)`

```
* Fix UL and DL URR Usage Report

* Follow-on up [open5gs#1793](https://github.com/open5gs/open5gs/pull/1793)

* [AMF] Fix for switching state when sending Deregistration Request fails

Provide pointer to state machine, instead of pointer to timer structure.
Bug was noticed when switching compiler optimization to -O2.

* [5GC] Fixed session deletion in a BSF ([open5gs#1725](https://github.com/open5gs/open5gs/issues/1725))

* [UPF] test code for unspecified address ([open5gs#1776](https://github.com/open5gs/open5gs/discussions/1776))

* [Security] Fixed a crash for port scanning ([open5gs#1767](https://github.com/open5gs/open5gs/issues/1767))

* Release v2.4.11

* Added Release Notes for v2.4.11

* [MME] Support for Insert Subscriber Data ([open5gs#1794](https://github.com/open5gs/open5gs/pull/1794))

* [MME] Support for Insert Subscriber Data

* Supported AVPs in IDR will overwrite existing subscription information
* Provide error on partial APN updates
* IDR and ULA use same function to process AVPs
* Move subdatamask values into s6a, so both HSS and MME can use them
* Updates are not actioned at this time.  A Re-attach is required for
  most changes to take effect

* Memory issue on IDR exceptions

* Remove of handling MSIDSN change until DSR is used

* Follow-on up [open5gs#1794](https://github.com/open5gs/open5gs/pull/1794)

* [SBI] Client Request timeout

TS29.500
Ch 6.11 Detection and handling of late arriving requests

In Open5GS, this part was hard-corded.

HTTP2 Client sends a request and waits for 10 seconds.
If no response is received from the HTTP2 Server,
HTTP2 Client performs the exception handling.

In this commit, HTTP2 client sends Header with setting Max-Rsp-Time to 10 seconds.
However, HTTP2 server has not yet been implemented to process this value.
The server is still processing using hard-corded values (10 seconds).

* [MME] Cancel Location while Idle ([open5gs#1797](https://github.com/open5gs/open5gs/pull/1797))

* Cancel Location while Idle Fix

* Forgot about SGSAP on MME Change.

Added "action" to sgsap_send_detach..

* Make handle_clr uniform with other handlers

* Added Robustness for Any Detach Type

* Memory wasn't freed upon CLR for unknown IMSIs

* Moving MME Detach to new PR

* Follow-up on [open5gs#1797](https://github.com/open5gs/open5gs/pull/1797)

* ogs_info swaps CP and UP SEIDs

* Follow-up on [open5gs#1797](https://github.com/open5gs/open5gs/pull/1797)

* fix dropped_dl_traffic_threshold ie.

* [AMF,UDM] Add support to subscribe to SDM changes

AMF subscribes to UDM for each registered UE.

At the moment, UDM does not send callback to AMF when any of the UE's
properties in the database changes.
At the moment, AMF does properly parse the ModificationNotification, but
does not do anything useful.

* [SMF] Update PFCP report error situation ([open5gs#1819](https://github.com/open5gs/open5gs/pull/1819))

* Revert the previous commit on [open5gs#1797](https://github.com/open5gs/open5gs/pull/1797)

* Updated SBI module

- Introduced NF_INSTANCE_ID/NF_INSTANCE_TYPE
- Skip SCP in configuration validation

* [AMF] Increase size of TMSI pool

Each UE context has 'current' and 'next' TMSI values. AMF first
allocates the 'next' value, before confirming it and releasing the
'previous'. This means that we potentially need pool size of 2x the
amount of maximum configured UE.

Without this change, AMF would crash in case that there are 'x'
configured maximum amount of UE, and there are already 'x' registered
UE.

[gmm] INFO: Registration request (../src/amf/gmm-sm.c:135)
[gmm] INFO: [suci-0-001-01-1234-0-1-1000000000]    SUCI (../src/amf/gmm-handler.c:149)
[gmm] DEBUG:     OLD TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:179)
[gmm] DEBUG:     NEW TSC[UE:0,AMF:0] KSI[UE:7,AMF:0] (../src/amf/gmm-handler.c:186)
[amf] FATAL: amf_m_tmsi_alloc: Assertion `m_tmsi' failed. (../src/amf/context.c:2160)
[core] FATAL: backtrace() returned 13 addresses (../lib/core/ogs-abort.c:37)

* [AMF] Reject registration requests when pool for UE contexts is empty

AMF does not crash anymore when a new UE registration request arrives,
and there is no available space left in UE context pool. Now it just
rejects the request with an error.

* Follow-up on [open5gs#1828](https://github.com/open5gs/open5gs/pull/1828)

* Follow-up on [open5gs#1827](https://github.com/open5gs/open5gs/pull/1827)

* [DBI] Disable Change Streams with mongo Version

Support for change stream is only available in mongoc >=1.9.0
- Disabled related functions in dbi.
Support for bson to json used in debug statement only in libbson >=1.7.0
- Simple debug message in lower versions

* Follow-up on [open5gs#1827](https://github.com/open5gs/open5gs/pull/1827)

* Update README.md

* SCP(Model D) is now the default setting.

* remove warning in MacOSX ([open5gs#1797](https://github.com/open5gs/open5gs/pull/1797))

* Fixed the WebUI to Support MongoDB 6.0([open5gs#1824](https://github.com/open5gs/open5gs/issues/1824))

* SCP is added in Debian package

* Fixed the bug of SGW-C session deletion ([open5gs#1825](https://github.com/open5gs/open5gs/issues/1825))

* Release v2.5.0

* Added missing files(SCP for systemd)

* Release v2.5.0

* Update document for v2.5.0

* [AMF] Support REREGISTRATION_REQUIRED in dereg notify

* Fixed a bug WebUI for production build ([open5gs#1824](https://github.com/open5gs/open5gs/issues/1824))

* Support SMF Security Indication IE ([open5gs#1851](https://github.com/open5gs/open5gs/discussions/1851))

* Release v2.5.1

* Document update for v2.5.1

* [NAS] Discard message if Integrity failed ([open5gs#1848](https://github.com/open5gs/open5gs/pull/1848))

* SCP had a serioud memory problem and fixed it

* Fix to avoid port (7777) conflicts on Mac OS X

* Release v2.5.2

* fix for scp daemon ([open5gs#1872](https://github.com/open5gs/open5gs/pull/1872))

* fix

* fix2

* fix

* Release v2.5.3

* added open5gs-scp

* Release v2.5.4

* [SBI] Do not send empty arrays when registering to NRF

OpenAPI dictates that certain arrays should have at least one item,
otherwise they should not be present.
This includes lists for IPv4/v6 addresses, TAI/TAC lists, ...

Add a check if there is at least 1 item, before creating an array.
Also move variable declarations to inner blocks, to prevent some
accidental usage out of wanted scope.

* Follow-up on [open5gs#1876](https://github.com/open5gs/open5gs/pull/1876)

* Squashed commit of the following:

commit [5070c19](https://github.com/securitylab-repository/open5gs_ciot/commit/5070c19a5469269d036bf243ebdb2740aefc7b8d)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 15:46:35 2022 +0900

    updte it

commit [e49107f](https://github.com/securitylab-repository/open5gs_ciot/commit/e49107f46152ff6dce5658b48cfb2c31df61724a)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 11:03:37 2022 +0900

    update it

commit [a55b977](https://github.com/securitylab-repository/open5gs_ciot/commit/a55b977e044b1d74ccc8a19f1dbf8194c3cd7daa)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 10:50:41 2022 +0900

    update it

commit [0ff0930](https://github.com/securitylab-repository/open5gs_ciot/commit/0ff0930d99bfeb91134271dae0941b4c454d1a3d)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 10:09:35 2022 +0900

    update it

commit [8cb5038](https://github.com/securitylab-repository/open5gs_ciot/commit/8cb5038b66d4a605446c6fc200b77f645f7ad328)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 09:39:08 2022 +0900

    update it

commit [0a6829d](https://github.com/securitylab-repository/open5gs_ciot/commit/0a6829dfb6470f3d9b786363d49387fdc688e33b)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Fri Nov 4 09:06:22 2022 +0900

    update it

commit [ea85035](https://github.com/securitylab-repository/open5gs_ciot/commit/ea85035300d9a42cc5f8f7ee300d28cd055f0f1c)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 21:36:17 2022 +0900

    update it

commit [e86ba62](https://github.com/securitylab-repository/open5gs_ciot/commit/e86ba621de332d3f712569cf0580fc8a5321adbd)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 17:39:27 2022 +0900

    update it

commit [2c05df8](https://github.com/securitylab-repository/open5gs_ciot/commit/2c05df84eabeba7c277c622e5d810768b2895961)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Thu Nov 3 16:20:47 2022 +0900

    update it

commit [43c88ae](https://github.com/securitylab-repository/open5gs_ciot/commit/43c88aed3f2001fdbc28ce0f11cc21dfcdc5906f)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Wed Nov 2 22:17:37 2022 +0900

    update it

commit [b374db4](https://github.com/securitylab-repository/open5gs_ciot/commit/b374db4e02e7dd153944f5a6fdc2a50c434dfa09)
Author: Sukchan Lee <acetcom@gmail.com>
Date:   Wed Nov 2 22:05:53 2022 +0900

    update it

* Fix the WebUI installation bug

* Fixed the WebUI installation

* Release v2.5.5

* [WebUI] Change installation script ([open5gs#1824](https://github.com/open5gs/open5gs/issues/1824))

* [SMF] Fixed PTI when PDU Session Reject

* Build webui from local source

Use local copy of source code to build webui,
instead of downloading the code from Github.

* Rollback WebUI ([open5gs#1882](https://github.com/open5gs/open5gs/pull/1882))

* [AMF] Add implicit_unsubscribe field to SDMSubscription

* Build WebUI from local source

Use local copy of source code to build WebUI,
instead of downloading the code from Github.

* Update 01-quickstart.md

Change S1AP bind address for external eNB.

* Follow-up on [open5gs#1886](https://github.com/open5gs/open5gs/pull/1886)

* Add TLS support

* Fix TLS error handling

* Follow-up on [open5gs#1865](https://github.com/open5gs/open5gs/pull/1865)

* [SBI] Introduced HTTP2-TLS based on [open5gs#1865](https://github.com/open5gs/open5gs/pull/1865)

Verfication is not implemented.

* Changed the location of Osmocom nightly build

* Added OSS Notice

* Update document

* Update document

* Update document

* [metrics] Fix log output for metrics

Even if the configured log level for the application was set to "error",
the first "info" message of the metrics library was output to the log.
Reorder the initialization of the metrics library.

* Fixed crash after 48 hours of running ([open5gs#1893](https://github.com/open5gs/open5gs/issues/1893))

* Prometheus metrics set to default

* Fixed prometheus-client-c branch next to open5gs

* Fixed test code for MacOSX Ventura

* update document

* Fixed MacOSX Test code

* Removed MongoDB from WebUI install-script ([open5gs#1824](https://github.com/open5gs/open5gs/issues/1824))

* Oops! errata

* OpenAPI: Move any_type.[ch] from custom/ into sbi/openapi/model/

This makes it possible to have object values of type "any_type" in OpenAPI
specifications.

* OpenAPI: Generate patch_item.[ch] from OpenAPI specifications

* OpenAPI: AnyType for ChangeItem's newValue and origValue properties

* get amf_ue from sess

amf_ue will be null and cause a coredump when type is OGS_SBI_OBJ_SESS_TYPE.

* [AMF/MME] Refactor SM to prevent crash ([open5gs#1912](https://github.com/open5gs/open5gs/issues/1912))

* Fixed alpine stack overflow ([open5gs#1911](https://github.com/open5gs/open5gs/issues/1911))

* Continue to fix alpine stack overflow ([open5gs#1911](https://github.com/open5gs/open5gs/issues/1911))

* [AMF/MME] forget UE Radio Capability ([open5gs#1917](https://github.com/open5gs/open5gs/issues/1917))

forgetting the UE Radio Capabilities
when UE is sending NAS "De-Registration Request" with "type = Switch-off

* [WebUI] Install on MongoDB below v6.0 ([open5gs#1910](https://github.com/open5gs/open5gs/discussions/1910))

* OpenAPI: Add functions OpenAPI_list_clear and OpenAPI_list_insert_prev

* [UDM] Handle SDM unsubscribe

* [UDM/UDR] Handle UEAuthentication authRemovalInd

* [AUSF] Handle UEAuthentication DELETE

* [AMF] Allow unspecified (infinity) ue_ambr up/downlink limits

* [AMF] Add support for SDM subscription and authentication deletion

* [AMF] Handle am-data/ratRestrictions change notification

When such a notification arrives from UDM, delete the corresponding SDM
subscription from the UDM and deregister the UE if it becomes RAT restricted.

* [AMF] Handle am-data/subscribedUeAmbr change notification

When such a notification arrives from UDM, notify the GNB of the new values
AMBR uplink/downlink values.

* [AMF/MME] Added Timer Configuration ([open5gs#1905](https://github.com/open5gs/open5gs/issues/1905))

* [AMF/MME] Added missing T3423 in conf ([open5gs#1905](https://github.com/open5gs/open5gs/issues/1905))

* Fixed manual of sgwu.yaml conf

* [UPF] Fixed an infinte loop when ext_len is 0

* [SBI] Remove redundant code ([open5gs#1923](https://github.com/open5gs/open5gs/pull/1923))

* Added more log in GTP Error ([open5gs#1920](https://github.com/open5gs/open5gs/issues/1920))

* [AMF] Wrongly sending PDU Session Release ([open5gs#1925](https://github.com/open5gs/open5gs/issues/1925))

* [AMF] Fixed a crash while NGReset ([open5gs#1928](https://github.com/open5gs/open5gs/issues/1928))

* amf: fix regression for smf selection

* free replybuf after sent replay message

* [SBI] Case-Insensitive inside MIME message ([open5gs#1939](https://github.com/open5gs/open5gs/issues/1939))

* [UPF] Add metrics support

Expose metrics with labels according to ETSI TS 128 552 V16.13.0 in
UPF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

5qi is not available in UPF.
To present 5qi to the user, MN will have to maintain a table qfi->5qi
for each QoS flow (will have to get information from SMF).
So UPF has to expose qfi. qfi itself is not useful. When used, UPF will
have to expose additional label to define the session (e.g. source
interface).

Label dnn is set to value of APN/DNN received in Establishment.
Since SMF does not add APN/DNN to Establishment, the label is empty.
When APN/DNN will be set by SMF, it should be added to sess in UPF
and used in metrics on Modification and Deletion.

Both datavolumeqosleveln3upf are exposed in bytes.
MN is providing the transformation to kbits.

fivegs_upffunction_upf_qosflows should expose the number of QFIs used in
sessions, but exposes number of QER rules, which is currently equal to
QFIs.
The label snsssai is not provided since the slice is not available on UPF.

Exposed metrics example:
Standard counters:
fivegs_ep_n3_gtp_indatapktn3upf 28637
fivegs_ep_n3_gtp_outdatapktn3upf 14729
fivegs_upffunction_sm_n4sessionestabreq 4
fivegs_upffunction_sm_n4sessionestabfail{cause="66"} 1
fivegs_upffunction_sm_n4sessionestabfail{cause="71"} 68
fivegs_upffunction_sm_n4sessionestabfail{cause="68"} 4
fivegs_upffunction_sm_n4sessionestabfail{cause="72"} 15
fivegs_upffunction_sm_n4sessionestabfail{cause="75"} 3
fivegs_upffunction_sm_n4sessionestabfail{cause="65"} 4
fivegs_upffunction_sm_n4sessionreport 0
fivegs_upffunction_sm_n4sessionreportsucc 0
fivegs_ep_n3_gtp_indatavolumeqosleveln3upf{qfi="1"} 39792997
fivegs_ep_n3_gtp_outdatavolumeqosleveln3upf{qfi="1"} 737548
Nonstandard gauge (added for controlling purposes -
same metric as existing metric on AMF and SMF):
fivegs_upffunction_upf_sessionnbr 1
Standard gauge:
fivegs_upffunction_upf_qosflows{dnn=""} 1

* [PCF] Add metrics support

Expose metrics with labels according to ETSI TS 128 552 V16.13.0 in
PCF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

AM policy:
fivegs_pcffunction_pa_policyamassoreq and
fivegs_pcffunction_pa_policyamassosucc do not expose snssai label
since it is not available at the time of exposure.
plmnid is defined during AM policy processing, so not to lose the
difference to ...succ, the basic metric
fivegs_pcffunction_pa_policyamassoreq is preserved.

SM policy:
snssai is defined during SM policy processing, so not to lose the
difference to ...succ, the basic metric
fivegs_pcffunction_pa_policysmassoreq is preserved.

Those 2 basic metrics retain their position but are exposed with empty
labels.
Metrics with labels are called later, when the label values are known.

Exposed metrics example:
-standard counters:
fivegs_pcffunction_pa_policyamassoreq{plmnid=""} 3
fivegs_pcffunction_pa_policyamassoreq{plmnid="99970"} 3
fivegs_pcffunction_pa_policyamassosucc{plmnid="99970"} 3
fivegs_pcffunction_pa_policysmassoreq{plmnid="",snssai=""} 3
fivegs_pcffunction_pa_policysmassoreq{plmnid="99970",snssai="1000009"} 3
fivegs_pcffunction_pa_policysmassosucc{plmnid="99970",snssai="1000009"} 3

-nonstandard gauge (added for controlling purposes -
same metric as existing metric on AMF and SMF):
fivegs_pcffunction_pa_sessionnbr{plmnid="99970",snssai="1000009"} 0

* Follow-up on [open5gs#1940](https://github.com/open5gs/open5gs/pull/1940)

* Follow-up on [open5gs#1940](https://github.com/open5gs/open5gs/pull/1940) - Fixed compile error

* [SMF] fix crash due free-ing invalid pointer

In case that database is (manually) corrupted for a specific UE, SSC
mode and ARP preemption vulnerability fields are not set correctly,
SMF will crash when trying to build a request to create PCF association.

Function smf_npcf_smpolicycontrol_build_create() will end prematurely,
and when cleaning up resources it will try to free() up invalid pointer,
which was not set to 0 at beginning of the function.

[smf] ERROR: SSCMode is not allowed (../src/smf/nudm-handler.c:165)
[sbi] DEBUG: STATUS [201] (../lib/sbi/nghttp2-server.c:443)
[sbi] DEBUG: SENDING...: 3 (../lib/sbi/nghttp2-server.c:451)
[sbi] DEBUG: {
} (../lib/sbi/nghttp2-server.c:452)
[sbi] DEBUG: STREAM closed [1] (../lib/sbi/nghttp2-server.c:962)
[smf] ERROR: No Arp.preempt_cap (../src/smf/npcf-build.c:132)
<crash>

0  __GI_abort () at ./stdlib/abort.c:107
1  0x00007f9348fe43b1 in ?? () from /lib/x86_64-linux-gnu/libtalloc.so.2
2  0x00007f9349aef745 in ogs_talloc_free (ptr=0x7f9348e38dab <_int_free+1675>,
    location=0x5591b8675d27 "../src/smf/npcf-build.c:181") at ../lib/core/ogs-memory.c:107
3  0x00005591b8653c45 in smf_npcf_smpolicycontrol_build_create (sess=0x7f9343070010, data=0x0)
    at ../src/smf/npcf-build.c:181
4  0x00007f9349abc2b4 in ogs_sbi_xact_add (sbi_object=0x7f9343070010,
    service_type=OGS_SBI_SERVICE_TYPE_NPCF_SMPOLICYCONTROL, discovery_option=0x7f9338006d90,
    build=0x5591b86531d0 <smf_npcf_smpolicycontrol_build_create>, context=0x7f9343070010, data=0x0)
    at ../lib/sbi/context.c:1699
5  0x00005591b86580be in smf_sbi_discover_and_send (service_type=OGS_SBI_SERVICE_TYPE_NPCF_SMPOLICYCONTROL,
    discovery_option=0x0, build=0x5591b86531d0 <smf_npcf_smpolicycontrol_build_create>, sess=0x7f9343070010,
    stream=0x7f9344fce0a0, state=0, data=0x0) at ../src/smf/sbi-path.c:110
6  0x00005591b864e9da in smf_nudm_sdm_handle_get (sess=0x7f9343070010, stream=0x7f9344fce0a0,
    recvmsg=0x7f933f52d5a0) at ../src/smf/nudm-handler.c:290
7  0x00005591b8600c96 in smf_gsm_state_wait_5gc_sm_policy_association (s=0x7f9343070610, e=0x7f9338076730)
    at ../src/smf/gsm-sm.c:523
...

* [AMF] Add RM metrics support

Expose RM metrics with labels according to ETSI TS 128 552 V16.13.0 in
AMF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

RegInitFail is exposed as an alternative to RegInitReq and RegInitSucc
counters so cause label can be provided. It counts rejected registrations
and rejected authentications.
Rejected authentications are counted under label cause="0".

Exposed metrics example:
-standard gauge:
fivegs_amffunction_rm_registeredsubnbr{plmnid="00101",snssai="1000009"} 1

-nonstandard counter:
fivegs_amffunction_rm_reginitfail{cause="3"} 4

* [SMF] Add SM metrics support

Expose SM metrics with labels according to ETSI TS 128 552 V16.13.0 in
SMF by using hash.

The metrics are named respecting the rule:
<generation>_<measurement_object_class>_<measurement_family_name>_<metric_name_as_in_TS_128_552>
Existing gauge sessions_active is renamed!

Since slice itself is not unique, the plmnid label is exposed in
addition to snssai.

Exposed metrics example:
-standard gauges:
fivegs_smffunction_sm_sessionnbr{plmnid="00101",snssai="1000009"} 0
fivegs_smffunction_sm_qos_flow_nbr{plmnid="00101",snssai="1000009",fiveqi="9"} 0

-nonstandard counters:
fivegs_smffunction_sm_n4sessionestabfail{cause="71"} 68
fivegs_smffunction_sm_n4sessionreport 1
fivegs_smffunction_sm_n4sessionreportsucc 1
fivegs_smffunction_sm_n4sessionestabreq 1

* [AMF] Fix deletion of auth data from AUSF

* free socket fd

call ogs_sock_destroy to free sock when fail to get socket fd

* Update document

* Update document

* Add NF load to NRF Heartbeat

The current load percentage of the NF Service Consumer is provided
in the payload body of the PATCH request when periodically
contacting the NRF (heart-beat).

AMF: ratio between currently connected ran_ue and maximum number of them
SMF: ratio between current PDU sessions and maximum available
PCF: ratio between current AM+SM policy associations and maximum available
     or ratio between currently connected UEs and maximum number of them
     (the load which is higher)
AUSF, UDM: ratio between currently connected UE and maximum number of them
BSF: ratio between current sessions and maximum available
NSSF: ratio between currently used NSIs and maximum number of them

NRF currently doesn't determine that the NF Profile has changed.

* [SMF] Fix metric bearers_active

Metric 'bearers_active' was incremented in only one code path
(smf_bearer_add() for 4G only), while it was decremented from two paths
(smf_bearer_remove() for both 4G and 5G).
Increment metric also for 5G path (smf_qos_flow_add()), so it won't get
decremented into negative values.

* [mongo] Use "ping" command instead of "serverStatus"

"serverStatus" on the "admin" database may fail due to insufficient privileges.

* Introduced Subscription identifier de-concealing

 o Generate the private key as below.
   $ openssl genpkey -algorithm X25519 -out /etc/open5gs/hnet/curve25519-1.key
   $ openssl ecparam -name prime256v1 -genkey -conv_form compressed -out /etc/open5gs/hnet/secp256r1-2.key

 o The private and public keys can be viewed with the command.
   The public key is used when creating the SIM.
   $ openssl pkey -in /etc/open5gs/hnet/curve25519-1.key -text
   $ openssl ec -in /etc/open5gs/hnet/secp256r1-2.key -conv_form compressed -text

In ausf/udm.yaml

 hnet:
    o Home network public key identifier(PKI) value : 1
      Protection scheme identifier : ECIES scheme profile A
    - id: 1
      scheme: 1
      key: /etc/open5gs/hnet/curve25519-1.key

    o Home network public key identifier(PKI) value : 2
      Protection scheme identifier : ECIES scheme profile B
    - id: 2
      scheme: 2
      key: /etc/open5gs/hnet/secp256r1-2.key

    o Home network public key identifier(PKI) value : 3
      Protection scheme identifier : ECIES scheme profile A
    - id: 3
      scheme: 1
      key: /etc/open5gs/hnet/curve25519-1.key

    o Home network public key identifier(PKI) value : 4
      Protection scheme identifier : ECIES scheme profile B
    - id: 4
      scheme: 2
      key: /etc/open5gs/hnet/secp256r1-2.key

Related to [open5gs#1779](https://github.com/open5gs/open5gs/issues/1779)

* New AMF ID in SMF session context for 'inter-AMF change or mobility'

* Fixed SMF-METRICS bug in EPC

* SIDF only required in UDM, not AUSF ([open5gs#1779](https://github.com/open5gs/open5gs/issues/1779))

* [MME] Clear UE Context for Attach Reject ([open5gs#1848](https://github.com/open5gs/open5gs/pull/1848))

Attach Reject + PDN Connectivity Reject need to clear UE Context

* [PCRF] Fixed a crash ([open5gs#1981](https://github.com/open5gs/open5gs/issues/1981))

An assertion was fired when switching between video and audio.

* [METRICS] Fixed a core dump in SMF/UPF/PCF ([open5gs#1985](https://github.com/open5gs/open5gs/pull/1985))

* [AMF] Implicit Network-initiated Deregistration

Two timers are introduced (both with duration of T3512 + 4 min):
-MOBILE_REACHABLE
-IMPLICIT_DEREGISTRATION
MOBILE_REACHABLE is set when NAS connection for the UE is released.
IMPLICIT_DEREGISTRATION is set when MOBILE_REACHABLE expires.

On MOBILE_REACHABLE expiry Paging is ignored.
On IMPLICIT_DEREGISTRATION expiry:
-UE's RM_State is set to DEREGISTERED
-UE is Nudm_SDM_Unsubscribed
-UE is Nudm_UECM_Deregistered
-PDU sessions are released
-AM policies are deleted

Existing flag amf_ue->network_initiated_de_reg is used.

* [AMF] Follow-up on [open5gs#1987](https://github.com/open5gs/open5gs/pull/1987)

    [AMF] Implicit Network-initiated Deregistration

    Two timers are introduced (both with duration of T3512 + 4 min):
    -MOBILE_REACHABLE
    -IMPLICIT_DEREGISTRATION
    MOBILE_REACHABLE is set when NAS connection for the UE is released.
    IMPLICIT_DEREGISTRATION is set when MOBILE_REACHABLE expires.

    On MOBILE_REACHABLE expiry Paging is ignored.
    On IMPLICIT_DEREGISTRATION expiry:
    -UE's RM_State is set to DEREGISTERED
    -UE is Nudm_SDM_Unsubscribed
    -UE is Nudm_UECM_Deregistered
    -PDU sessions are released
    -AM policies are deleted

    Existing flag amf_ue->network_initiated_de_reg is used.

* [AMF] More Follow-up on [open5gs#1987](https://github.com/open5gs/open5gs/pull/1987)

* [pfcp] Fix code style

* [PCRF] More fixes for crashes ([open5gs#1981](https://github.com/open5gs/open5gs/issues/1981))

* changed error tagged log to info tagged log for handling 5g guti information during Configuration Update procedure

* [SMF] Added User-ID, APP_DNN, S-NSSAI ([open5gs#1986](https://github.com/open5gs/open5gs/pull/1986))

Added User-ID, APP_DNN, S-NSSAI in N4 PFCP Session Establishment Request

* [MME] Add Purge-UE Capability ([open5gs#1991](https://github.com/open5gs/open5gs/pull/1991))

* [MME] Add Purge-UE Capability

* Add OGS_GTP_..._PURGE_AND_REMOVE to split CLR case

* Follow-up on [open5gs#1991](https://github.com/open5gs/open5gs/pull/1991)

* More follow-up on [open5gs#1911](https://github.com/open5gs/open5gs/issues/1911)

* Update document for v2.4.13

* Update document for 2.5.7

* Version update

* Update document for v2.4.13 and v2.5.7

* [AMF] Fixed RM metric RegisteredSubNbr ([open5gs#2001](https://github.com/open5gs/open5gs/issues/2001))

* [UPF] Fixed bug when 2 PDRs with same TEID ([open5gs#2003](https://github.com/open5gs/open5gs/issues/2003))

* [MME] Introduce aging timers

* Creating three new timers
* mirroring work done by gstaa on the AMF
* Implicit detach procedures added
* Fix for detach from unknown UE

* [METRICS] Re-order init/final ([open5gs#1985](https://github.com/open5gs/open5gs/pull/1985), [open5gs#2001](https://github.com/open5gs/open5gs/issues/2001))

* [AMF] Fixed MEMORY LEAK ([open5gs#1925](https://github.com/open5gs/open5gs/issues/1925))

* [PROTO] Increase SDU buffer 8k->16k ([open5gs#2008](https://github.com/open5gs/open5gs/issues/2008))

* [PFCP] Allow up to 8 framed routes for each IP type

* [BSF] Handle Ipv4FrameRouteList, save it into context

* [PCF] Handle framed routes, forward them to BSF

* [UPF] Handle framed routes

* [SMF] Handle framed routes, forward them to UPF and PCF

* Follow-up on [open5gs#2009](https://github.com/open5gs/open5gs/pull/2009)

* [AMF/MME] Fixed crash when no NG/S1 context([open5gs#2012](https://github.com/open5gs/open5gs/issues/2012))

* Update document for v2.5.8

* remove old document

* [UPF] URR time threshold log to info ([open5gs#1997](https://github.com/open5gs/open5gs/issues/1997))

* [MME] Fixed a crash when no UE context ([open5gs#2016](https://github.com/open5gs/open5gs/issues/2016))

* [LOG] remove ogs_expect_or_return()/return_val()

* [CORE] Rollback ogs_pkbuf_copy() from ([open5gs#2012](https://github.com/open5gs/open5gs/issues/2012))

In the previous [open5gs#2012](https://github.com/open5gs/open5gs/issues/2012) working, I've added ogs_pkbuf_free() for original
buffer. But, this rasied double free. So, I've rollback it,

* [PFCP] buffer overflow in ALPINE ([open5gs#1911](https://github.com/open5gs/open5gs/issues/1911), [open5gs#2009](https://github.com/open5gs/open5gs/pull/2009))

A buffer overflow occurred in ALPINE
because the size of the pfcp message structure increased by

    ogs_pfcp_tlv_framed_route_t framed_route[8];
    ogs_pfcp_tlv_framed_ipv6_route_t framed_ipv6_route[8];

* Fixed warning

* [CORE] Increase SDU buffer to 32k ([open5gs#2008](https://github.com/open5gs/open5gs/issues/2008))

* [SBI] Fixed crash if no BW Unit(Xbps) ([open5gs#2000](https://github.com/open5gs/open5gs/issues/2000))

* no Purge Timer, no config, expanded code

* [CORE] OGS_MAX_SDU_LEN->OGS_HUGE_LEN Stack ([open5gs#2008](https://github.com/open5gs/open5gs/issues/2008))

Changed all OGS_MAX_SDU_LEN in the stack to OGS_HUGE_LEN.

* [AMF/AMF] Not assert for ogs_asn_copy_ie() ([open5gs#2018](https://github.com/open5gs/open5gs/issues/2018))

Does not raise an assertion even if open5gs cannot handle the ASN in
ogs_asn_copy_ie()

* [AMF] Fixed crashes from malformed 5GS-ID ([open5gs#2020](https://github.com/open5gs/open5gs/issues/2020))

* [MME] Implicit Network-initiated Deregistration ([open5gs#2013](https://github.com/open5gs/open5gs/pull/2013))

* [MME] Introduce aging timers

* Creating three new timers
* mirroring work done by gstaa on the AMF
* Implicit detach procedures added
* Fix for detach from unknown UE

* no Purge Timer, no config, expanded code

* update it

* ogs_session_s.framed_routes type change to (char **)

OpenAPI_list_t wasn't optimal as it created a dependency on ogs-sbi.h.

* [UDR] Read framed routes from DB send them in sm-data

The framed routes are stored in mongo as

 {
     "imsi" : "$IMSI",
     ...,
     "slice" :
     [{
         ...,
         "session" :
             ...,
             "ipv4_framed_routes" : ["10.45.33.0/24", "10.45.35.0/24"],
         }],
     }],
 },

* [MME] Fixed crash due to Paging routine ([open5gs#2017](https://github.com/open5gs/open5gs/issues/2017))

* Added Service-MAP to Requester-Features ([open5gs#2027](https://github.com/open5gs/open5gs/issues/2027))

ALWAYS Added Service-MAP to Requester-Features in Discovery Option

* [AMX] Fixed a crash due to deregistration ([open5gs#2021](https://github.com/open5gs/open5gs/issues/2021))

Fixed an issue where AMF would crash
if an implicit deregistration occurred twice.

* [NRF] Fixed a crash during NRF discovery ([open5gs#2034](https://github.com/open5gs/open5gs/issues/2034))

Other NF instances are obtained through NRF
or created directly through configuration files.

Other NFs created by the config file should not be passed
through NRF discovery or anything like that.

Since self-created NF Instances do not have an ID,
they are implemented to exclude them from NRF Discovery.

* [CORE] Add defense code to ogs_pkbuf_copy ([open5gs#2032](https://github.com/open5gs/open5gs/issues/2032))

Added a defense code to prevent NF crash when ogs_pkbuf_copy() size is 0.

* [AMF] Network Initiated De-Register ([open5gs#2014](https://github.com/open5gs/open5gs/pull/2014), [open5gs#2021](https://github.com/open5gs/open5gs/issues/2021))

Resolved Network Initiated Implicit/Explicit De-Registration

* Update Document for Frame Routing ([open5gs#2035](https://github.com/open5gs/open5gs/discussions/2035))

* Remove not valid UTF-8 characters

These UTF-8 characters are causing issues with static code analysis
tools.

Error: encoding error in ./lib/crypt/zuc.c
'utf-8' codec can't decode byte 0x97 in position 3948: invalid start byte
Python3 requires input character data to be perfectly encoded;
it also requires perfectly correct system encoding settings.
Unfortunately, your data and/or system settings are not.

* [AMF] Network-Initiated Deregister ([open5gs#2014](https://github.com/open5gs/open5gs/pull/2014), [open5gs#2021](https://github.com/open5gs/open5gs/issues/2021))

Fixed a bug network-initiated implicit/explict deregistration

* [Gx/Gy] MAX_CC_REQUESTER_NUMBER(32->64) ([open5gs#2038](https://github.com/open5gs/open5gs/issues/2038))

Incrased MAX_CC_REQUESTER_NUMBER from 32 to 64

* [NF] Fix double-free crash when NF is under heavy load

<nf>/init.c:<nf>_main() :
ogs_pollset_poll() receives the time of the expiration of next timer as
an argument. If this timeout is in very near future (1 millisecond),
and if there are multiple events that need to be processed by
ogs_pollset_poll(), these could take more than 1 millisecond for
processing, resulting in the timer already passed the expiration.

In case that another NF is under heavy load and responds to an SBI
request with some delay of a few seconds, it can happen that
ogs_pollset_poll() adds SBI responses to the event list for further
processing, then ogs_timer_mgr_expire() is called which will add an
additional event for timer expiration. When all events are processed
one-by-one, the SBI xact would get deleted twice in a row, resulting in
a crash.

0  __GI_abort () at ./stdlib/abort.c:107
1  0x00007f9de91693b1 in ?? () from /lib/x86_64-linux-gnu/libtalloc.so.2
2  0x00007f9de9a21745 in ogs_talloc_free (ptr=0x7f9d906c2c70, location=0x7f9de960bf41 "../lib/sbi/message.c:2423") at ../lib/core/ogs-memory.c:107
3  0x00007f9de95dbf31 in ogs_sbi_discovery_option_free (discovery_option=0x7f9d9090e670) at ../lib/sbi/message.c:2423
4  0x00007f9de95f7c47 in ogs_sbi_xact_remove (xact=0x7f9db630b630) at ../lib/sbi/context.c:1702
5  0x000055a482784846 in amf_state_operational (s=0x7f9d9488bbb0, e=0x7f9d90aecf20) at ../src/amf/amf-sm.c:604
6  0x00007f9de9a33cf0 in ogs_fsm_dispatch (fsm=0x7f9d9488bbb0, event=0x7f9d90aecf20) at ../lib/core/ogs-fsm.c:127
7  0x000055a48275b32e in amf_main (data=0x0) at ../src/amf/init.c:149
8  0x00007f9de9a249eb in thread_worker (arg=0x55a483d41d90) at ../lib/core/ogs-thread.c:67
9  0x00007f9de8fd2b43 in start_thread (arg=<optimized out>) at ./nptl/pthread_create.c:442
10 0x00007f9de9063bb4 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:100

* [SBI/NF] Follow-up on [open5gs#2045](https://github.com/open5gs/open5gs/pull/2045)

* Support for UPF HA - release/establish new PDU session

* Follow-up on [open5gs#2048](https://github.com/open5gs/open5gs/pull/2048)

* [SBI] HTTP/2 user-agent header ([open5gs#2048](https://github.com/open5gs/open5gs/pull/2048))

Open5GS now checks User-AGENT only in SCP.

* [AMF/MME] Delete UERadioCapability ([open5gs#2040](https://github.com/open5gs/open5gs/issues/2040), [open5gs#1917](https://github.com/open5gs/open5gs/issues/1917))

o TS24.301(4G/LTE)
  5.5.1 Attach procedure
  5.5.1.2 Attach procedure for EPS services
  5.5.1.2.4 Attach accepted by the network

If the attach request is accepted by the network,
the MME shall delete the stored UE radio capability information
or the UE radio capability ID, if any.

o TS24.501(5G)
  5.5.2 De-registration procedure
  5.5.2.1 General

When the AMF enters the state 5GMM-DEREGISTERED for 3GPP access,
the AMF shall delete the stored UE radio capability information
or the UE radio capability ID, if any.

* [TEST] Reduce paging wait time

* [AMF] Network-Initiated Deregister ([open5gs#2014](https://github.com/open5gs/open5gs/pull/2014), [open5gs#2021](https://github.com/open5gs/open5gs/issues/2021))

I accidentally missed one so I added it again.

* [AMF] Delete UERadioCapability ([open5gs#2040](https://github.com/open5gs/open5gs/issues/2040), [open5gs#1917](https://github.com/open5gs/open5gs/issues/1917))

23.501 (5G NAS stage 2)
5.4.4.1:
"When the AMF receives Registration Request with the Registration type set
to Initial Registration or when it receives the first Registration Request
after E-UTRA/EPC Attach with Registration type set to Mobility Registration
Update, the AMF deletes the UE radio capability."

* [SBI,NF] Don't treat SBI connection errors as asserts

* [AMF] Network Deregister ([open5gs#2056](https://github.com/open5gs/open5gs/issues/2056), [open5gs#2014](https://github.com/open5gs/open5gs/pull/2014), [open5gs#2021](https://github.com/open5gs/open5gs/issues/2021))

Fixed a crash on explicit network-initiated deregister
with SUBSCRIPTION_WITHDRAWN

* [MME] KeNB derive from TAU(active flag=1) ([open5gs#2063](https://github.com/open5gs/open5gs/issues/2063))

TS33.401
7 Security procedures between UE and EPS access network elements
7.2 Handling of user-related keys in E-UTRAN
7.2.7 Key handling for the TAU procedure when registered in E-UTRAN

If the "active flag" is set in the TAU request message or
the MME chooses to establish radio bearers when there is pending downlink
UP data or pending downlink signalling, radio bearers will be established
as part of the TAU procedure and a KeNB derivation is necessary.

* [SBI] Do not treat removed streams as errors when sending responses

This is in line with the implementation with microhttpd server
(mhd-server.c).

* [SBI] Fix possible crash when handling PatchItems in NFProfile PATCH req

* Follow-up on [open5gs#2069](https://github.com/open5gs/open5gs/pull/2069)

* [DOCS] Removed missing link

* Further Follow-up on [open5gs#2063](https://github.com/open5gs/open5gs/issues/2063)

* [pfcp] response_timeout should not call ogs_pfcp_xact_delete ([open5gs#2072](https://github.com/open5gs/open5gs/pull/2072))

* [pfcp] response_timeout should never call ogs_pfcp_xact_delete ([open5gs#50](https://github.com/open5gs/open5gs/issues/50))

* also remove ogs_pfcp_xact_delete since never called

* also had to catch one more ogs_pfcp_sendto()

---------

Co-authored-by: Spencer Sevilla <spencer@MacBook-Air.local>

* [GTP/PFCP] Follow-up on [open5gs#2073](https://github.com/open5gs/open5gs/pull/2073)

* [gtpc] silently handle OGS_GTP2_CAUSE_UE_ALREADY_RE_ATTACHED ([open5gs#17](https://github.com/open5gs/open5gs/issues/17))

no need to log "GTP Failed"; just handle silently or move on.

* Issue housekeeping ([open5gs#2078](https://github.com/open5gs/open5gs/pull/2078))

* Added GitHub issue templates and config.yaml for issue templating

* Fixed capitalisation of labels.

* updated bugreport.yaml template

* Fixed typos in GitHub templates and bug schemas ([open5gs#2080](https://github.com/open5gs/open5gs/pull/2080))

* [SBI] HTTP2-TLS verification - ConfFile Changed

You should add the following configuration if you would not use TLS.

sbi:
    server:
      no_tls: true
    client:
      no_tls: true

* [SBI] Move HNET PKI conf inside UDM

* Updated bugreport.yaml

Fixed a typo/hangover from sense-checking

* Removed 'bug' from auto-labels on new issue template

* [AMF/SMF] Fixed a crash ([open5gs#2030](https://github.com/open5gs/open5gs/issues/2030), [open5gs#2074](https://github.com/open5gs/open5gs/issues/2074), [open5gs#2085](https://github.com/open5gs/open5gs/issues/2085))

* Don't left-shift by negative amount, which is UB according to C17

* Remove MACOSX in github CI

* Update 01-quickstart.md

* [Release-17] Upgrade S1AP/NGAP to v17.3.9

* [PFCP] Support pfcp advertise address

* [SBI] Fixed openapitools MAP generation ([open5gs#2103](https://github.com/open5gs/open5gs/issues/2103))

MAP was generated incorrectly because {{#items}}..{{#items}} was
missing.

Because of this, If scpInfo has scpPort, NRF crashes.

* [SBI] Crash occurs when ENUM in the MAP ([open5gs#2103](https://github.com/open5gs/open5gs/issues/2103))

* [Release-17] Upgrade SBI to v17.x.0

* [AMF] Disallow handling service requests unless UE is already registered

* Follow-up on [open5gs#2100](https://github.com/open5gs/open5gs/pull/2100)

* [Release-17] Upgrade NAS to v17.8.0

* [PFCP/GTP] Fixed security bug ([open5gs#2127](https://github.com/open5gs/open5gs/issues/2127),[open5gs#2128](https://github.com/open5gs/open5gs/issues/2128),[open5gs#2129](https://github.com/open5gs/open5gs/issues/2129))

* [Release-17] Upgrade GTPv1/v2 to v17.4.0/v17.7.0

* [Release-17] Upgrade PFCP to v17.7.1

* Added N32 Interface to implement SEPP

* [AMF] Expose more metrics

[ETSI TS 128 552 V16.9.0](<https://www.etsi.org/deliver/etsi_ts/128500_128599/128552/16.09.00_60/ts_128552v160900p.pdf>)

5.2.2 Registration procedure related measurements

SNSSAI labels are not provided.

- Number of registration requests received by the AMF is
exposed for each registration type.
```
fivegs_amffunction_rm_reginitreq 1
fivegs_amffunction_rm_regmobreq 0
fivegs_amffunction_rm_regperiodreq 0
fivegs_amffunction_rm_regemergreq 0
```

- Number of successful initial registrations at the AMF is
exposed for each registration type.
```
fivegs_amffunction_rm_reginitsucc 1
fivegs_amffunction_rm_regmobsucc 0
fivegs_amffunction_rm_regperiodsucc 0
fivegs_amffunction_rm_regemergsucc 0
```

- The existing counter of failed registrations at the AMF
is exposed separately for each registration type.
```
fivegs_amffunction_rm_reginitfail
fivegs_amffunction_rm_regmobfail
fivegs_amffunction_rm_regperiodfail
fivegs_amffunction_rm_regemergfail
```

5.2.5.2 Measurements for 5G paging

Number of 5G paging procedures initiated at the AMF:
```
fivegs_amffunction_mm_paging5greq 1
```
Number of successful 5G paging procedures initiated at the AMF:
```
fivegs_amffunction_mm_paging5gsucc 1
```

5.2.11 Authentication procedure related measurements

Number of authentication requests:
```
fivegs_amffunction_amf_authreq 2
```
Number of authentication rejections:
```
fivegs_amffunction_amf_authreject 1
```
Number of failed authentications due to parameter error:
```
fivegs_amffunction_amf_authfail{cause="21"} 1
```

5.2.8 UE Configuration Update procedure related measurements

Number of UE Configuration Update commands requested by the AMF:
```
fivegs_amffunction_mm_confupdate 2
```
Number of UE Configuration Update complete messages received by the AMF:
```
fivegs_amffunction_mm_confupdatesucc 1
```

* [SMF] Fixed crash during UPF-HA process ([open5gs#2115](https://github.com/open5gs/open5gs/issues/2115))

* Added log message for troubleshooting [open5gs#2117](https://github.com/open5gs/open5gs/discussions/2117)

* Release v2.6.0

* Update document for v2.6.0

* Upgrade to Release-17

* Release v2.6.1

* Release v2.6.1

* Update document for v2.6.1

* [NAS/GTP/PFCP] Upgrade IE to Release-17

As raised in [open5gs#2147](https://github.com/open5gs/open5gs/issues/2147), AMF fails to decode S1 UE Network Capability.

So I reviewed all IE in NAS, GTP and PFCP and fixed it for Release-17.

* [AMF] Fix handling Service Request

In case that handling Service Request results in an error, AMF sends a
Service Reject and sets UE's context to exception state. Without the
'break', the code would set UE's context to registered state.

* [BSF] Removed MongoDB in BSF configuration file

* [SBI] Added Handler for Subscription PATCH ([open5gs#2152](https://github.com/open5gs/open5gs/issues/2152))

* [SBI] Conforms standard in Subscription API([open5gs#2152](https://github.com/open5gs/open5gs/issues/2152))

POST requests to {apiRoot}/nnrf-nfm/v1/subscriptions return
a HTTP Location header in 201 respose
in the form {apiRoot}/nnrf-nfm/v1/subscriptions/{subscriptionID}

* [SBI] Check POST format in Subscription ([open5gs#2152](https://github.com/open5gs/open5gs/issues/2152))

POST requests to {apiRoot}/nnrf-nfm/v1/subscriptions/{subscriptionID} return an error

* add git ignore

---------

Co-authored-by: Dibas Das <dibasdas02@gmail.com>
Co-authored-by: Sukchan Lee <acetcom@gmail.com>
Co-authored-by: Bostjan Meglic <b.meglic@iskratel.si>
Co-authored-by: jmasterfunk84 <48972964+jmasterfunk84@users.noreply.github.com>
Co-authored-by: Spencer Sevilla <spencer.builds.networks@gmail.com>
Co-authored-by: safaorhann <safa.orhan@b-ulltech.com>
Co-authored-by: mitmitmitm <ois@oasd8i.at>
Co-authored-by: EugeneBogush <eugeneb2008@gmail.com>
Co-authored-by: Yarin Sergey <yarin@iskrauraltel.ru>
Co-authored-by: lost_res <wilcodex8@gmail.com>
Co-authored-by: Flander Bojan <flander@iskratel.si>
Co-authored-by: Lester <55822214+lester-001@users.noreply.github.com>
Co-authored-by: Miguel Borges de Freitas <miguel-r-freitas@alticelabs.com>
Co-authored-by: Gaber Stare <g.stare@iskratel.si>
Co-authored-by: Matej Gradisar <gradisar@iskratel.si>
Co-authored-by: ridzafauzi <ridza.fauzi@yahoo.com>
Co-authored-by: Spencer Sevilla <spencer@MacBook-Air.local>
Co-authored-by: Richard <pobk@users.noreply.github.com>
Co-authored-by: Ali Shirvani <alishirv@pm.me>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen5gs%2Fopen5gs%2Fissues%2F1767)

Assignees

No one assigned

Labels

[Type:Security](/open5gs/open5gs/labels/Type%3ASecurity)
Security issue

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@acetcom](https://avatars.githubusercontent.com/u/4222492?s=52&v=4)](/acetcom) [![@Popvlvs](https://avatars.githubusercontent.com/u/56645347?s=52&v=4)](/Popvlvs)

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.


