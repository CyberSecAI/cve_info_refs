=== Content from gitlab.com_24615743_20250114_224409.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-3573.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-3573.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-3573.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-3573.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ GitLab Bot 's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 " GitLab Bot ")](/gitlab-bot)

  Jan 10, 2023

  [ac9c4c18](/gitlab-org/cves/-/commit/ac9c4c18b373d1a9ac611aafcfb4297f7423a999)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/ac9c4c18b373d1a9ac611aafcfb4297f7423a999)
  繚
  ac9c4c18

  [ GitLab Bot ](/gitlab-bot) authored Jan 10, 2023

  ac9c4c18

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/ac9c4c18b373d1a9ac611aafcfb4297f7423a999)
  [ GitLab Bot ](/gitlab-bot) authored Jan 10, 2023

Loading



=== Content from gitlab.com_daef9b4b_20250114_224410.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Cross-site scripting in wiki changes page affecting self-hosted instances running without strict CSP

**[HackerOne report #1730461](https://hackerone.com/reports/1730461)** by `ryotak` on 2022-10-11, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Due to the improper filtering of query parameters in the `wiki changes` page, an attacker can execute arbitrary JavaScript on the self-hosted instances running without strict CSP.

##### Description

In `app/views/projects/diffs/_diffs.html.haml`, the following code is used to generate a link to remove whitespace changes from the diff.

[`app/views/projects/diffs/_diffs.html.haml` line 24](https://gitlab.com/gitlab-org/gitlab/-/blob/277890f7d42f52042158c25a6122a20eaa23befd/app/views/projects/diffs/_diffs.html.haml#L24)

```
          = toggle_whitespace_link(url_for(params_with_whitespace), class: 'd-none d-sm-inline-block')
```

[`app/helpers/diff_helper.rb` line 280-282](https://gitlab.com/gitlab-org/gitlab/-/blob/277890f7d42f52042158c25a6122a20eaa23befd/app/helpers/diff_helper.rb#L280-282)

```
  def params_with_whitespace
    hide_whitespace? ? request.query_parameters.except(:w) : request.query_parameters.merge(w: 1)
  end
```

As `params_with_whitespace` is using `request.query_parameters` instead of `safe_params` is used to pass parameters to `link_to`, arbitrary parameters can be passed here.

Since `link_to` supports parameters such as `protocol` or `host`, it's possible to inject `javascript:` URLs and achieves XSS.

##### Steps to reproduce

###### Self-hosted instance (with an alert)

1. Set up your own GitLab instance.
2. Log in to the GitLab instance.
3. Create a project.
4. From the sidebar, click `Wiki`.
5. Click `Create your first page`
6. Fill in the contents.
7. Click `Create page`
8. Open [https://YOUR\_OWN\_INSTANCE/USERNAME/PROJECT\_NAME/-/wikis/home/diff?protocol=javascript&host=%250dalert(document.domain)//](https://YOUR_OWN_INSTANCE/USERNAME/PROJECT_NAME/-/wikis/home/diff?protocol=javascript&host=%25250dalert(document.domain)//)
9. Click `Hide whitespace changes`
10. Confirm that `alert(document.domain)` has been executed.

###### GitLab.com (with a CSP error message)

1. Log in to your GitLab account.
2. Create a project.
3. From the sidebar, click `Wiki`.
4. Click `Create your first page`
5. Fill in the contents.
6. Click `Create page`
7. Open <https://gitlab.com/USERNAME/PROJECT_NAME/-/wikis/home/diff?protocol=javascript&host=%250dalert(document.domain)//>
8. Open DevTools.
9. Click `Hide whitespace changes`.
10. Confirm that CSP prevented the execution of JavaScript.

##### Examples

<https://gitlab.com/Ry0taK/testproject/-/wikis/home/diff?protocol=javascript&host=%250dalert(document.domain)//>

##### What is the current *bug* behavior?

`request.query_parameters` is used, which may include dangerous parameters.

##### What is the expected *correct* behavior?

`safe_params` should be used to filter the dangerous parameters.

##### Relevant logs and/or screenshots

[2022-10-11\_22-54-51.mp4](https://user-content.gitlab-static.net/a2d106f7ddeac95410feb90dbf9ac1e33658c804/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33363664653137392d643433312d343930642d393464342d3635363233663461626535382f323032322d31302d31315f32322d35342d35312e6d7034 "Download '2022-10-11_22-54-51.mp4'")

##### Details of CVSS

```
Attack Vector: Network (Attacks can be performed over the internet.)
Attack Complexity: Low (Attack complexity shouldn't be affected by user interactions.)
Privileges Required: Low (An attacker needs to create a project before attacking the victim.)
User Interaction: Required (Clicks are required.)
Scope: Changed (The vulnerable component and the impacted component are different; GitLab server and the browser)
Confidentiality: High (Since an attacker can perform arbitrary actions on behalf of the user, this should be rated as High.)
Integrity: High (Same as above.)
Availability: None (Account takeover doesn't directly affect the availability.)
```

###### Results of GitLab environment info

```
System information
System:         Ubuntu 20.04
Proxy:          no
Current User:   git
Using RVM:      no
Ruby Version:   2.7.5p203
Gem Version:    3.1.6
Bundler Version:2.3.15
Rake Version:   13.0.6
Redis Version:  6.2.7
Sidekiq Version:6.4.2
Go Version:     unknown

GitLab information
Version:        15.4.1-ee
Revision:       7b2ed8f038f
Directory:      /opt/gitlab/embedded/service/gitlab-rails
DB Adapter:     PostgreSQL
DB Version:     13.6
URL:            https://gl.ryotak.me
HTTP Clone URL: https://gl.ryotak.me/some-group/some-project.git
SSH Clone URL:  git@gl.ryotak.me:some-group/some-project.git
Elasticsearch:  no
Geo:            no
Using LDAP:     no
Using Omniauth: yes
Omniauth Providers:

GitLab Shell
Version:        14.10.0
Repository storage paths:
- default:      /var/opt/gitlab/git-data/repositories
GitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell
```

##### Impact

An attacker can execute arbitrary JavaScript on the victim's browser and do any actions on behalf of the user.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [2022-10-11\_22-54-51.mp4](https://h1.sec.gitlab.net/a/366de179-d431-490d-94d4-65623f4abe58/2022-10-11_22-54-51.mp4)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


