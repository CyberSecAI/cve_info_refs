=== Content from plugins.trac.wordpress.org_0eaad77f_20250114_181801.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2765630%2540corner-ad%252Ftrunk%26old%3D2719671%2540corner-ad%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2719671/corner-ad/trunk?old=2765630&old_path=%2Fcorner-ad%2Ftrunk)

---

# Changes in [corner-ad/trunk](/browser/corner-ad/trunk?rev=2765630 "Show entry in browser") [[2719671:2765630]](/log/corner-ad/trunk?rev=2765630&stop_rev=2719671 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[corner-ad/trunk](/browser/corner-ad/trunk?rev=2765630)
Files:

12 edited

* [banner.php](/browser/corner-ad/trunk/banner.php?rev=2765630 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [corner-ad.php](/browser/corner-ad/trunk/corner-ad.php?rev=2765630 "Show entry in browser")
  (modified)
  ([11 diffs](#file1 "Show differences"))
* [includes/admin\_functions.php](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630 "Show entry in browser")
  (modified)
  ([12 diffs](#file2 "Show differences"))
* [pagebuilders/beaverbuilder/cornerad.inc.php](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2765630 "Show entry in browser")
  (modified)
  ([3 diffs](#file3 "Show differences"))
* [pagebuilders/beaverbuilder/cornerad/cornerad.php](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/cornerad.php?rev=2765630 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [pagebuilders/beaverbuilder/cornerad/includes/frontend.php](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/includes/frontend.php?rev=2765630 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [pagebuilders/builders.php](/browser/corner-ad/trunk/pagebuilders/builders.php?rev=2765630 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [pagebuilders/elementor/elementor.pb.php](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630 "Show entry in browser")
  (modified)
  ([7 diffs](#file7 "Show differences"))
* [pagebuilders/elementor/elementor\_category.pb.php](/browser/corner-ad/trunk/pagebuilders/elementor/elementor_category.pb.php?rev=2765630 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php?rev=2765630 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php?rev=2765630 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [readme.txt](/browser/corner-ad/trunk/readme.txt?rev=2765630 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [corner-ad/trunk/banner.php](/changeset/2765630/corner-ad/trunk/banner.php?old=2288762&old_path=corner-ad%2Ftrunk%2Fbanner.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/banner.php")

  | [r2719671](/browser/corner-ad/trunk/banner.php?rev=2288762#L1 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/banner.php?rev=2765630#L1 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | global $codepeople\_promote\_banner\_plugins; |
  | 3 |  | if~~(empty($codepeople\_promote\_banner\_plugins)) $codepeople\_promote\_banner\_plugins = array();~~ |
  | 4 |  | if(!function\_exists( 'codepeople\_add\_promote\_banner' )) |
  | 5 |  | { |
  | 6 |  | function codepeople\_add\_promote\_banner($wp\_admin\_bar) |
  | 7 |  | { |
  |  | 3 | if ( empty( $codepeople\_promote\_banner\_plugins ) ) { |
  |  | 4 | $codepeople\_promote\_banner\_plugins = array(); |
  |  | 5 | } |
  |  | 6 | if ( ! function\_exists( 'codepeople\_add\_promote\_banner' ) ) { |
  |  | 7 | function codepeople\_add\_promote\_banner( $wp\_admin\_bar ) { |
  | 8 | 8 | global $codepeople\_promote\_banner\_plugins; |
  | 9 | 9 |  |
  | 10 |  | if( |
  | 11 |  | empty($codepeople\_promote\_banner\_plugins) || |
  | 12 |  | !is\_admin() || |
  | 13 |  | !current\_user\_can( 'manage\_options' ) |
  | 14 |  | ) return; |
  |  | 10 | if ( |
  |  | 11 | empty( $codepeople\_promote\_banner\_plugins ) || |
  |  | 12 | ! is\_admin() || |
  |  | 13 | ! current\_user\_can( 'manage\_options' ) |
  |  | 14 | ) { |
  |  | 15 | return; |
  |  | 16 | } |
  | 15 | 17 |  |
  | 16 | 18 | $screen = get\_current\_screen(); |
  | 17 |  | if ( $screen->post\_type == 'post' || $screen->post\_type == 'page' ) return; |
  |  | 19 | if ( 'post' == $screen->post\_type || 'page' == $screen->post\_type ) { |
  |  | 20 | return; |
  |  | 21 | } |
  | 18 | 22 |  |
  | 19 | 23 | // Take action over the banner |
  | 20 |  | if(isset($\_POST['codepeople\_promote\_banner\_nonce']) && wp\_verify\_nonce($\_POST['codepeople\_promote\_banner\_nonce'], \_\_FILE\_\_)) |
  | 21 |  | { |
  | 22 |  | if( |
  | 23 |  | !empty($\_POST['codepeople\_promote\_banner\_plugin']) && |
  | 24 |  | !empty($codepeople\_promote\_banner\_plugins[$\_POST['codepeople\_promote\_banner\_plugin']]) |
  | 25 |  | ) |
  | 26 |  | { |
  | 27 |  | set\_transient( 'codepeople\_promote\_banner\_'.$\_POST['codepeople\_promote\_banner\_plugin'], -1, 0); |
  | 28 |  | if( |
  | 29 |  | !empty($\_POST['codepeople\_promote\_banner\_action']) && |
  | 30 |  | $\_POST['codepeople\_promote\_banner\_action'] == 'set-review' && |
  | 31 |  | !empty($codepeople\_promote\_banner\_plugins[$\_POST['codepeople\_promote\_banner\_plugin']]['plugin\_url']) |
  | 32 |  | ) |
  | 33 |  | { |
  | 34 |  | print '<script>document.location.href="'.str\_replace('&amp;','&',esc\_js($codepeople\_promote\_banner\_plugins[$\_POST['codepeople\_promote\_banner\_plugin']]['plugin\_url'])).'";</script>'; |
  |  | 24 | if ( isset( $\_POST['codepeople\_promote\_banner\_nonce'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['codepeople\_promote\_banner\_nonce'] ) ), \_\_FILE\_\_ ) ) { |
  |  | 25 | if ( |
  |  | 26 | ! empty( $\_POST['codepeople\_promote\_banner\_plugin'] ) && |
  |  | 27 | ! empty( $codepeople\_promote\_banner\_plugins[ $\_POST['codepeople\_promote\_banner\_plugin'] ] ) |
  |  | 28 | ) { |
  |  | 29 | set\_transient( 'codepeople\_promote\_banner\_' . sanitize\_text\_field( wp\_unslash( $\_POST['codepeople\_promote\_banner\_plugin'] ) ), -1, 0 ); |
  |  | 30 | if ( |
  |  | 31 | ! empty( $\_POST['codepeople\_promote\_banner\_action'] ) && |
  |  | 32 | 'set-review' == $\_POST['codepeople\_promote\_banner\_action'] && |
  |  | 33 | ! empty( $codepeople\_promote\_banner\_plugins[ $\_POST['codepeople\_promote\_banner\_plugin'] ]['plugin\_url'] ) |
  |  | 34 | ) { |
  |  | 35 | print '<script>document.location.href="' . esc\_attr( str\_replace( '&amp;', '&', esc\_js( $codepeople\_promote\_banner\_plugins[ sanitize\_text\_field( wp\_unslash( $\_POST['codepeople\_promote\_banner\_plugin'] ) ) ]['plugin\_url'] ) ) ) . '";</script>'; |
  | 35 | 36 | } |
  | 36 | 37 | } |
  | 37 | 38 | } |
  | 38 | 39 |  |
  | 39 |  | $minimum\_days = 86400~~\*~~7; |
  | 40 |  | $now = time(); |
  |  | 40 | $minimum\_days = 86400 \* 7; |
  |  | 41 | $now          = time(); |
  | 41 | 42 |  |
  | 42 |  | foreach($codepeople\_promote\_banner\_plugins as $plugin\_slug => $plugin\_data ) |
  | 43 |  | { |
  | 44 |  | $value = get\_transient( 'codepeople\_promote\_banner\_'.$plugin\_slug ); |
  | 45 |  | if( $value === false ) |
  | 46 |  | { |
  |  | 43 | foreach ( $codepeople\_promote\_banner\_plugins as $plugin\_slug => $plugin\_data ) { |
  |  | 44 | $value = get\_transient( 'codepeople\_promote\_banner\_' . $plugin\_slug ); |
  |  | 45 | if ( false === $value ) { |
  | 47 | 46 | $value = $now; |
  | 48 |  | set\_transient( 'codepeople\_promote\_banner\_'~~.~~$plugin\_slug, $value, 0 ); |
  |  | 47 | set\_transient( 'codepeople\_promote\_banner\_' . $plugin\_slug, $value, 0 ); |
  | 49 | 48 | } |
  | 50 | 49 |  |
  | 51 |  | if($minimum\_days <= abs($now-$value) && 0<$value\*1) |
  | 52 |  | { |
  |  | 50 | if ( $minimum\_days <= abs( $now - $value ) && 0 < $value \* 1 ) { |
  | 53 | 51 | ?> |
  | 54 | 52 | <style> |
  | […](/browser/corner-ad/trunk/banner.php?rev=2288762#L78) | […](/browser/corner-ad/trunk/banner.php?rev=2765630#L76) |  |
  | 78 | 76 | <div class="codepeople-review-banner-content"> |
  | 79 | 77 | <div class="codepeople-review-banner-text"> |
  | 80 |  | <p><strong>Want to help to the development of the "<?php print ~~$plugin\_data[ 'plugin\_name' ]~~; ?>" plugin?</strong> The main features of this plugin are provided free of charge. We need your help to continue developing it and adding new features. If you want to help with the development please <span style="color:#1582AB;font-weight:bold;">add a review to support it</span>. Thank you!</p> |
  |  | 78 | <p><strong>Want to help to the development of the "<?php print esc\_html( $plugin\_data['plugin\_name'] ); ?>" plugin?</strong> The main features of this plugin are provided free of charge. We need your help to continue developing it and adding new features. If you want to help with the development please <span style="color:#1582AB;font-weight:bold;">add a review to support it</span>. Thank you!</p> |
  | 81 | 79 | </div> |
  | 82 | 80 | <div class="codepeople-review-banner-buttons"> |
  | 83 | 81 | <form method="post" target="\_blank"> |
  | 84 | 82 | <button class="main-button" onclick="jQuery(this).closest('[id=\'codepeople-review-banner\']').hide();">Publish a Review</button> |
  | 85 |  | <input type="hidden" name="codepeople\_promote\_banner\_plugin" value="<?php echo esc\_attr(~~$plugin\_slug~~); ?>" /> |
  |  | 83 | <input type="hidden" name="codepeople\_promote\_banner\_plugin" value="<?php echo esc\_attr( $plugin\_slug ); ?>" /> |
  | 86 | 84 | <input type="hidden" name="codepeople\_promote\_banner\_action" value="set-review" /> |
  | 87 |  | <input type="hidden" name="codepeople\_promote\_banner\_nonce" value="<?php echo ~~wp\_create\_nonce(\_\_FILE\_\_~~); ?>" /> |
  |  | 85 | <input type="hidden" name="codepeople\_promote\_banner\_nonce" value="<?php echo esc\_attr( wp\_create\_nonce( \_\_FILE\_\_ ) ); ?>" /> |
  | 88 | 86 | </form> |
  | 89 | 87 | <form method="post"> |
  | 90 | 88 | <button class="no-thank-button">No Thanks</button> |
  | 91 |  | <input type="hidden" name="codepeople\_promote\_banner\_plugin" value="<?php echo esc\_attr(~~$plugin\_slug~~); ?>" /> |
  |  | 89 | <input type="hidden" name="codepeople\_promote\_banner\_plugin" value="<?php echo esc\_attr( $plugin\_slug ); ?>" /> |
  | 92 | 90 | <input type="hidden" name="codepeople\_promote\_banner\_action" value="not-thanks" /> |
  | 93 |  | <input type="hidden" name="codepeople\_promote\_banner\_nonce" value="<?php echo ~~wp\_create\_nonce(\_\_FILE\_\_~~); ?>" /> |
  |  | 91 | <input type="hidden" name="codepeople\_promote\_banner\_nonce" value="<?php echo esc\_attr( wp\_create\_nonce( \_\_FILE\_\_ ) ); ?>" /> |
  | 94 | 92 | </form> |
  | 95 | 93 | <div style="clear:both;display:block;"></div> |
* ## [corner-ad/trunk/corner-ad.php](/changeset/2765630/corner-ad/trunk/corner-ad.php?old=2698581&old_path=corner-ad%2Ftrunk%2Fcorner-ad.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/corner-ad.php")

  | [r2719671](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L4 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L4 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wordpress.dwbooster.com/content-tools/corner-ad |
  | 5 | 5 | Description: Corner Ad is a minimally invasive advertising display that uses any of your webpage's top corners - a position typically under-utilized by developers - and attracts users' attention by a cool visual effect imitating a page flip |
  | 6 |  | Version: 1.0.5~~3~~ |
  |  | 6 | Version: 1.0.54 |
  | 7 | 7 | Author: CodePeople |
  | 8 | 8 | Author URI: https://wordpress.dwbooster.com/content-tools/corner-ad |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L12) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L12) |  |
  | 12 | 12 |  |
  | 13 | 13 | require\_once 'banner.php'; |
  | 14 |  | $codepeople\_promote\_banner\_plugins[~~'codepeople-corner-ad'~~ ] = array( |
  |  | 14 | $codepeople\_promote\_banner\_plugins['codepeople-corner-ad'] = array( |
  | 15 | 15 | 'plugin\_name' => 'Corner Ad', |
  | 16 |  | 'plugin\_url'  => 'https://wordpress.org/support/plugin/corner-ad/reviews/#new-post' |
  |  | 16 | 'plugin\_url'  => 'https://wordpress.org/support/plugin/corner-ad/reviews/#new-post', |
  | 17 | 17 | ); |
  | 18 | 18 |  |
  | 19 | 19 | // CONST |
  | 20 |  | define(~~'CORNER\_AD\_PLUGIN\_VERSION', '1.0.53'~~); |
  | 21 |  | define(~~'CORNER\_AD\_PLUGIN\_DIR', dirname(\_\_FILE\_\_)~~); |
  | 22 |  | define(~~'CORNER\_AD\_PLUGIN\_URL', plugins\_url('', \_\_FILE\_\_)~~); |
  | 23 |  | define(~~'CORNER\_AD\_TD', 'corner-ad'~~); |
  | 24 |  | define(~~'CORNER\_AD\_TABLE', 'corner\_ad'~~); |
  | 25 |  | define(~~'CORNER\_AD\_IMG\_TABLE', 'corner\_ad\_img'~~); |
  | 26 |  |  |
  | 27 |  | ~~include CORNER\_AD\_PLUGIN\_DIR.~~'/includes/admin\_functions.php'; |
  |  | 20 | define( 'CORNER\_AD\_PLUGIN\_VERSION', '1.0.54' ); |
  |  | 21 | define( 'CORNER\_AD\_PLUGIN\_DIR', dirname( \_\_FILE\_\_ ) ); |
  |  | 22 | define( 'CORNER\_AD\_PLUGIN\_URL', plugins\_url( '', \_\_FILE\_\_ ) ); |
  |  | 23 | define( 'CORNER\_AD\_TD', 'corner-ad' ); |
  |  | 24 | define( 'CORNER\_AD\_TABLE', 'corner\_ad' ); |
  |  | 25 | define( 'CORNER\_AD\_IMG\_TABLE', 'corner\_ad\_img' ); |
  |  | 26 |  |
  |  | 27 | require CORNER\_AD\_PLUGIN\_DIR . '/includes/admin\_functions.php'; |
  | 28 | 28 |  |
  | 29 | 29 | // Loading the page builders connectors |
  | 30 |  | require\_once CORNER\_AD\_PLUGIN\_DIR~~.~~'/pagebuilders/builders.php'; |
  |  | 30 | require\_once CORNER\_AD\_PLUGIN\_DIR . '/pagebuilders/builders.php'; |
  | 31 | 31 | CPCA\_BUILDERS::run(); |
  | 32 | 32 |  |
  | 33 |  | add\_filter('option\_sbp\_settings', 'corner\_ad\_troubleshoot'); |
  | 34 |  | if(!function\_exists('corner\_ad\_troubleshoot')) |
  | 35 |  | { |
  | 36 |  | function corner\_ad\_troubleshoot($option) |
  | 37 |  | { |
  | 38 |  | if(!is\_admin()) |
  | 39 |  | { |
  |  | 33 | add\_filter( 'option\_sbp\_settings', 'corner\_ad\_troubleshoot' ); |
  |  | 34 | if ( ! function\_exists( 'corner\_ad\_troubleshoot' ) ) { |
  |  | 35 | function corner\_ad\_troubleshoot( $option ) { |
  |  | 36 | if ( ! is\_admin() ) { |
  | 40 | 37 | // Solves a conflict caused by the "Speed Booster Pack" plugin |
  | 41 |  | if(is\_array($option) && isset($option['jquery\_to\_footer'])) unset($option['jquery\_to\_footer']); |
  |  | 38 | if ( is\_array( $option ) && isset( $option['jquery\_to\_footer'] ) ) { |
  |  | 39 | unset( $option['jquery\_to\_footer'] ); |
  |  | 40 | } |
  | 42 | 41 | } |
  | 43 | 42 | return $option; |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L49) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L48) |  |
  | 49 | 48 | \*/ |
  | 50 | 49 | register\_activation\_hook( \_\_FILE\_\_, 'corner\_ad\_install' ); |
  | 51 |  | if(!function\_exists('corner\_ad\_install')){ |
  | 52 |  |  |
  | 53 |  | function \_corner\_ad\_update\_db() |
  | 54 |  | { |
  | 55 |  | if(get\_option('CORNER\_AD\_PLUGIN\_VERSION') == CORNER\_AD\_PLUGIN\_VERSION) return; |
  | 56 |  | update\_option('CORNER\_AD\_PLUGIN\_VERSION', CORNER\_AD\_PLUGIN\_VERSION); |
  | 57 |  |  |
  | 58 |  | global $wpdb; |
  | 59 |  |  |
  | 60 |  | $list = []; |
  | 61 |  | $columns = $wpdb->get\_results("SHOW columns FROM `".$wpdb->prefix.CORNER\_AD\_TABLE."`"); |
  | 62 |  | foreach( $columns as $column ) $list[$column->Field] = $column->Field; |
  | 63 |  |  |
  | 64 |  | if(empty($list['desktop'])) |
  | 65 |  | $wpdb->query("ALTER TABLE  `".$wpdb->prefix.CORNER\_AD\_TABLE."` ADD `desktop` TINYINT(1) NOT NULL DEFAULT 1;"); |
  | 66 |  |  |
  | 67 |  | if(empty($list['mobile'])) |
  | 68 |  | $wpdb->query("ALTER TABLE  `".$wpdb->prefix.CORNER\_AD\_TABLE."` ADD `mobile` TINYINT(1) NOT NULL DEFAULT 1;"); |
  | 69 |  |  |
  | 70 |  | } // End \_corner\_ad\_update\_db |
  |  | 50 | if ( ! function\_exists( 'corner\_ad\_install' ) ) { |
  |  | 51 |  |
  |  | 52 | function \_corner\_ad\_update\_db() { |
  |  | 53 | if ( get\_option( 'CORNER\_AD\_PLUGIN\_VERSION' ) == CORNER\_AD\_PLUGIN\_VERSION ) { |
  |  | 54 | return; |
  |  | 55 | } |
  |  | 56 | update\_option( 'CORNER\_AD\_PLUGIN\_VERSION', CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 57 |  |
  |  | 58 | global $wpdb; |
  |  | 59 |  |
  |  | 60 | $list    = array(); |
  |  | 61 | $columns = $wpdb->get\_results( 'SHOW columns FROM `' . $wpdb->prefix . CORNER\_AD\_TABLE . '`' ); |
  |  | 62 | foreach ( $columns as $column ) { |
  |  | 63 | $list[ $column->Field ] = $column->Field; |
  |  | 64 | } |
  |  | 65 |  |
  |  | 66 | if ( empty( $list['desktop'] ) ) { |
  |  | 67 | $wpdb->query( 'ALTER TABLE  `' . $wpdb->prefix . CORNER\_AD\_TABLE . '` ADD `desktop` TINYINT(1) NOT NULL DEFAULT 1;' ); |
  |  | 68 | } |
  |  | 69 |  |
  |  | 70 | if ( empty( $list['mobile'] ) ) { |
  |  | 71 | $wpdb->query( 'ALTER TABLE  `' . $wpdb->prefix . CORNER\_AD\_TABLE . '` ADD `mobile` TINYINT(1) NOT NULL DEFAULT 1;' ); |
  |  | 72 | } |
  |  | 73 |  |
  |  | 74 | } // End \_corner\_ad\_update\_db |
  | 71 | 75 |  |
  | 72 | 76 | function \_corner\_ad\_install() { |
  | 73 | 77 |  |
  | 74 |  | require\_once~~(ABSPATH . 'wp-admin/includes/upgrade.php')~~; |
  | 75 |  |  |
  | 76 |  | global $wpdb; |
  |  | 78 | require\_once ABSPATH . 'wp-admin/includes/upgrade.php'; |
  |  | 79 |  |
  |  | 80 | global $wpdb; |
  | 77 | 81 | $charset\_collate = $wpdb->get\_charset\_collate(); |
  | 78 | 82 |  |
  | 79 | 83 | $db\_queries = array(); |
  | 80 |  | // Create related table |
  | 81 |  | ~~$db\_queries[] = "CREATE TABLE ".$wpdb->prefix.CORNER\_AD\_TABLE.~~" |
  |  | 84 | // Create related table |
  |  | 85 | $db\_queries[] = 'CREATE TABLE ' . $wpdb->prefix . CORNER\_AD\_TABLE . " |
  | 82 | 86 | (id MEDIUMINT(9) NOT NULL AUTO\_INCREMENT, |
  | 83 | 87 | name VARCHAR(250) NOT NULL DEFAULT '', |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L97) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L101) |  |
  | 97 | 101 | ) $charset\_collate;"; |
  | 98 | 102 |  |
  | 99 |  | // Create related table |
  | 100 |  | ~~$db\_queries[] = "CREATE TABLE ".$wpdb->prefix.CORNER\_AD\_IMG\_TABLE.~~" |
  |  | 103 | // Create related table |
  |  | 104 | $db\_queries[] = 'CREATE TABLE ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . " |
  | 101 | 105 | (id MEDIUMINT(9) NOT NULL AUTO\_INCREMENT, |
  | 102 | 106 | ad MEDIUMINT(9) NOT NULL, |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L106) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L110) |  |
  | 106 | 110 | ) $charset\_collate;"; |
  | 107 | 111 |  |
  | 108 |  | dbDelta(~~$db\_queries~~); // Running the queries |
  | 109 |  |  |
  | 110 |  | // Set the image size required by the corner\_ad |
  | 111 |  | ~~//~~add\_image\_size( 'corner\_ad', 300, 300, true ); |
  | 112 |  | } // End +corner\_ad\_install |
  |  | 112 | dbDelta( $db\_queries ); // Running the queries |
  |  | 113 |  |
  |  | 114 | // Set the image size required by the corner\_ad |
  |  | 115 | // add\_image\_size( 'corner\_ad', 300, 300, true ); |
  |  | 116 | } // End +corner\_ad\_install |
  | 113 | 117 |  |
  | 114 | 118 | function corner\_ad\_install( $network\_wide ) { |
  | 115 | 119 | global $wpdb; |
  | 116 |  | if( function\_exists( 'is\_multisite' ) && is\_multisite() ) |
  | 117 |  | { |
  |  | 120 | if ( function\_exists( 'is\_multisite' ) && is\_multisite() ) { |
  | 118 | 121 | // check if it is a network activation - if so, run the activation function for each blog id |
  | 119 |  | if ($network\_wide) |
  | 120 |  | { |
  | 121 |  | $current\_blog = $wpdb->blogid; |
  |  | 122 | if ( $network\_wide ) { |
  |  | 123 | $current\_blog = $wpdb->blogid; |
  | 122 | 124 | // Get all blog ids |
  | 123 | 125 | $blog\_ids = $wpdb->get\_col( "SELECT blog\_id FROM $wpdb->blogs" ); |
  | 124 |  | foreach ( $blog\_ids as $blog\_id ) |
  | 125 |  | { |
  |  | 126 | foreach ( $blog\_ids as $blog\_id ) { |
  | 126 | 127 | switch\_to\_blog( $blog\_id ); |
  | 127 | 128 | \_corner\_ad\_install(); |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L132) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L133) |  |
  | 132 | 133 | } |
  | 133 | 134 | \_corner\_ad\_install(); |
  | 134 |  | } // End corner\_ad\_install |
  |  | 135 | } // End corner\_ad\_install |
  | 135 | 136 | } // End plugin activation |
  | 136 | 137 |  |
  | 137 | 138 | // A new blog has been created in a multisite WordPress |
  | 138 |  | add\_action( 'wpmu\_new\_blog', 'corner\_ad\_new\_blog', 10, 6); |
  | 139 |  |  |
  | 140 |  | function corner\_ad\_new\_blog($blog\_id, $user\_id, $domain, $path, $site\_id, $meta ) { |
  | 141 |  | global $wpdb; |
  | 142 |  | if ( is\_plugin\_active\_for\_network() ) |
  | 143 |  | { |
  | 144 |  | $current\_blog = $wpdb->blogid; |
  | 145 |  | switch\_to\_blog( $blog\_id ); |
  | 146 |  | \_corner\_ad\_install(); |
  | 147 |  | switch\_to\_blog( $current\_blog ); |
  | 148 |  | } |
  |  | 139 | add\_action( 'wpmu\_new\_blog', 'corner\_ad\_new\_blog', 10, 6 ); |
  |  | 140 |  |
  |  | 141 | function corner\_ad\_new\_blog( $blog\_id, $user\_id, $domain, $path, $site\_id, $meta ) { |
  |  | 142 | global $wpdb; |
  |  | 143 | if ( is\_plugin\_active\_for\_network() ) { |
  |  | 144 | $current\_blog = $wpdb->blogid; |
  |  | 145 | switch\_to\_blog( $blog\_id ); |
  |  | 146 | \_corner\_ad\_install(); |
  |  | 147 | switch\_to\_blog( $current\_blog ); |
  |  | 148 | } |
  | 149 | 149 | } |
  | 150 | 150 |  |
  | 151 | 151 | // Redirecting the user to the settings page of the plugin |
  | 152 | 152 | add\_action( 'activated\_plugin', 'corner\_ad\_redirect\_to\_settings', 10, 2 ); |
  | 153 |  | if(!function\_exists('corner\_ad\_redirect\_to\_settings')) |
  | 154 |  | { |
  | 155 |  | function corner\_ad\_redirect\_to\_settings($plugin, $network\_activation) |
  | 156 |  | { |
  | 157 |  | global $wpdb; |
  | 158 |  | if( |
  | 159 |  | $plugin == plugin\_basename( \_\_FILE\_\_ ) && |
  | 160 |  | (!isset($\_POST["action"]) || $\_POST["action"] != 'activate-selected') && |
  | 161 |  | (!isset($\_POST["action2"]) || $\_POST["action2"] != 'activate-selected') |
  | 162 |  | ) |
  | 163 |  | { |
  |  | 153 | if ( ! function\_exists( 'corner\_ad\_redirect\_to\_settings' ) ) { |
  |  | 154 | function corner\_ad\_redirect\_to\_settings( $plugin, $network\_activation ) { |
  |  | 155 | global $wpdb; |
  |  | 156 | if ( |
  |  | 157 | plugin\_basename( \_\_FILE\_\_ ) == $plugin && |
  |  | 158 | ( ! isset( $\_POST['action'] ) || 'activate-selected' != $\_POST['action'] ) && |
  |  | 159 | ( ! isset( $\_POST['action2'] ) || 'activate-selected' != $\_POST['action2'] ) |
  |  | 160 | ) { |
  | 164 | 161 | // If there is an add inserted go to the settings page of the plugin |
  | 165 |  | if($wpdb->get\_var("SELECT COUNT(id) FROM ".$wpdb->prefix.CORNER\_AD\_TABLE)) |
  | 166 |  | { |
  |  | 162 | if ( $wpdb->get\_var( 'SELECT COUNT(id) FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE ) ) { |
  | 167 | 163 | exit( wp\_redirect( admin\_url( 'options-general.php?page=corner-ad.php' ) ) ); |
  | 168 |  | } |
  | 169 |  | else |
  | 170 |  | { |
  |  | 164 | } else { |
  | 171 | 165 | // or go directly to create an ad |
  | 172 | 166 | exit( wp\_redirect( admin\_url( 'options-general.php?page=corner-ad.php&action=ad\_create' ) ) ); |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L178) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L172) |  |
  | 178 | 172 | // Feedback system |
  | 179 | 173 | require\_once 'feedback/cp-feedback.php'; |
  | 180 |  | new CP\_FEEDBACK(~~plugin\_basename( dirname(\_\_FILE\_\_) ), \_\_FILE\_\_, 'https://wordpress.dwbooster.com/contact-us'~~); |
  |  | 174 | new CP\_FEEDBACK( plugin\_basename( dirname( \_\_FILE\_\_ ) ), \_\_FILE\_\_, 'https://wordpress.dwbooster.com/contact-us' ); |
  | 181 | 175 |  |
  | 182 | 176 | /\* |
  | 183 | 177 | \*   Plugin initializing |
  | 184 | 178 | \*/ |
  | 185 |  | add\_action( 'init', 'corner\_ad\_init'); |
  | 186 |  | if~~(!function\_exists('corner\_ad\_init'))~~{ |
  | 187 |  | ~~function corner\_ad\_init()~~{ |
  | 188 |  |  |
  | 189 |  | \_corner\_ad\_update\_db(); |
  | 190 |  |  |
  | 191 |  | // Set the add shortcode |
  | 192 |  | ~~add\_shortcode('corner-ad', 'corner\_ad\_replace\_shortcode'~~); |
  | 193 |  | add\_image\_size( 'corner\_ad\_thumb', 100, 100, true ); |
  | 194 |  | add\_image\_size( 'corner\_ad', 500, 500, true ); |
  | 195 |  | add\_action(~~'wp\_footer', 'corner\_ad\_wp\_footer'~~); |
  | 196 |  | } // End corner\_ad\_init |
  |  | 179 | add\_action( 'init', 'corner\_ad\_init' ); |
  |  | 180 | if ( ! function\_exists( 'corner\_ad\_init' ) ) { |
  |  | 181 | function corner\_ad\_init() { |
  |  | 182 |  |
  |  | 183 | \_corner\_ad\_update\_db(); |
  |  | 184 |  |
  |  | 185 | // Set the add shortcode |
  |  | 186 | add\_shortcode( 'corner-ad', 'corner\_ad\_replace\_shortcode' ); |
  |  | 187 | add\_image\_size( 'corner\_ad\_thumb', 100, 100, true ); |
  |  | 188 | add\_image\_size( 'corner\_ad', 500, 500, true ); |
  |  | 189 | add\_action( 'wp\_footer', 'corner\_ad\_wp\_footer' ); |
  |  | 190 | } // End corner\_ad\_init |
  | 197 | 191 | } |
  | 198 | 192 |  |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L200) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L194) |  |
  | 200 | 194 | \*   Admin initionalizing |
  | 201 | 195 | \*/ |
  | 202 |  | add\_action(~~'admin\_init', 'corner\_ad\_admin\_init'~~); |
  | 203 |  | if~~(!function\_exists('corner\_ad\_admin\_init'))~~{ |
  | 204 |  | ~~function corner\_ad\_admin\_init()~~{ |
  | 205 |  | // Load the associated text domain |
  | 206 |  | ~~load\_plugin\_textdomain( CORNER\_AD\_TD~~, false, CORNER\_AD\_PLUGIN\_DIR . '/languages/' ); |
  | 207 |  |  |
  | 208 |  | // Set plugin links |
  | 209 |  | ~~$plugin = plugin\_basename(\_\_FILE\_\_~~); |
  | 210 |  | ~~add\_filter('plugin\_action\_links\_'.$plugin, 'corner\_ad\_links'~~); |
  | 211 |  |  |
  | 212 |  | // Set a new media button for corner ad insertion |
  | 213 |  | ~~add\_action('media\_buttons', 'corner\_ad\_media\_button', 100~~); |
  | 214 |  | } // End corner\_ad\_admin\_init |
  | 215 |  | } |
  | 216 |  |  |
  | 217 |  | if~~(!function\_exists('corner\_ad\_links'))~~{ |
  | 218 |  | ~~function corner\_ad\_links($links)~~{ |
  | 219 |  | // Help link |
  | 220 |  | ~~$custom\_link = '<a href="https://wordpress.org/support/plugin/corner-ad/#new-post" target="\_blank">'.\_\_('Help', CORNER\_AD\_TD).~~'</a>'; |
  | 221 |  | array\_unshift(~~$links, $custom\_link~~); |
  | 222 |  |  |
  | 223 |  | // Custom link |
  | 224 |  | ~~$custom\_link = '<a href="https://wordpress.dwbooster.com/contact-us" target="\_blank">'.\_\_('Request custom changes', CORNER\_AD\_TD).~~'</a>'; |
  | 225 |  | array\_unshift(~~$links, $custom\_link~~); |
  | 226 |  |  |
  | 227 |  | // Settings link |
  | 228 |  | ~~$settings\_link = '<a href="options-general.php?page=corner-ad.php">'.\_\_('Settings').~~'</a>'; |
  | 229 |  | array\_unshift(~~$links, $settings\_link~~); |
  |  | 196 | add\_action( 'admin\_init', 'corner\_ad\_admin\_init' ); |
  |  | 197 | if ( ! function\_exists( 'corner\_ad\_admin\_init' ) ) { |
  |  | 198 | function corner\_ad\_admin\_init() { |
  |  | 199 | // Load the associated text domain |
  |  | 200 | load\_plugin\_textdomain( 'corner-ad', false, CORNER\_AD\_PLUGIN\_DIR . '/languages/' ); |
  |  | 201 |  |
  |  | 202 | // Set plugin links |
  |  | 203 | $plugin = plugin\_basename( \_\_FILE\_\_ ); |
  |  | 204 | add\_filter( 'plugin\_action\_links\_' . $plugin, 'corner\_ad\_links' ); |
  |  | 205 |  |
  |  | 206 | // Set a new media button for corner ad insertion |
  |  | 207 | add\_action( 'media\_buttons', 'corner\_ad\_media\_button', 100 ); |
  |  | 208 | } // End corner\_ad\_admin\_init |
  |  | 209 | } |
  |  | 210 |  |
  |  | 211 | if ( ! function\_exists( 'corner\_ad\_links' ) ) { |
  |  | 212 | function corner\_ad\_links( $links ) { |
  |  | 213 | // Help link |
  |  | 214 | $custom\_link = '<a href="https://wordpress.org/support/plugin/corner-ad/#new-post" target="\_blank">' . \_\_( 'Help', 'corner-ad' ) . '</a>'; |
  |  | 215 | array\_unshift( $links, $custom\_link ); |
  |  | 216 |  |
  |  | 217 | // Custom link |
  |  | 218 | $custom\_link = '<a href="https://wordpress.dwbooster.com/contact-us" target="\_blank">' . \_\_( 'Request custom changes', 'corner-ad' ) . '</a>'; |
  |  | 219 | array\_unshift( $links, $custom\_link ); |
  |  | 220 |  |
  |  | 221 | // Settings link |
  |  | 222 | $settings\_link = '<a href="options-general.php?page=corner-ad.php">' . \_\_( 'Settings' ) . '</a>'; |
  |  | 223 | array\_unshift( $links, $settings\_link ); |
  | 230 | 224 |  |
  | 231 | 225 | return $links; |
  | 232 |  | } // End corner\_ad\_customization\_link |
  |  | 226 | } // End corner\_ad\_customization\_link |
  | 233 | 227 | } |
  | 234 | 228 |  |
  | 235 | 229 | // Set the settings menu option |
  | 236 |  | add\_action(~~'admin\_menu', 'corner\_ad\_settings\_menu'~~); |
  | 237 |  | if~~(!function\_exists('corner\_ad\_settings\_menu'))~~{ |
  | 238 |  | ~~function corner\_ad\_settings\_menu()~~{ |
  | 239 |  | // Add to admin\_menu |
  | 240 |  | add\_options\_page(~~'Corner AD', 'Corner AD', 'edit\_posts', basename(\_\_FILE\_\_), 'corner\_ad\_settings\_page'~~); |
  | 241 |  | } // End corner\_ad\_settings\_menu |
  | 242 |  | } |
  | 243 |  |  |
  | 244 |  | if~~(!function\_exists('corner\_ad\_settings\_page'))~~{ |
  | 245 |  | ~~function corner\_ad\_settings\_page()~~{ |
  | 246 |  | global $wpdb; |
  |  | 230 | add\_action( 'admin\_menu', 'corner\_ad\_settings\_menu' ); |
  |  | 231 | if ( ! function\_exists( 'corner\_ad\_settings\_menu' ) ) { |
  |  | 232 | function corner\_ad\_settings\_menu() { |
  |  | 233 | // Add to admin\_menu |
  |  | 234 | add\_options\_page( 'Corner AD', 'Corner AD', 'edit\_posts', basename( \_\_FILE\_\_ ), 'corner\_ad\_settings\_page' ); |
  |  | 235 | } // End corner\_ad\_settings\_menu |
  |  | 236 | } |
  |  | 237 |  |
  |  | 238 | if ( ! function\_exists( 'corner\_ad\_settings\_page' ) ) { |
  |  | 239 | function corner\_ad\_settings\_page() { |
  |  | 240 | global $wpdb; |
  | 247 | 241 | wp\_enqueue\_media(); |
  | 248 |  | ?> |
  | 249 |  | <div class="wrap"> |
  | 250 |  | <h1><?php \_e('Corner Ad', CORNER\_AD\_TD); ?></h1> |
  | 251 |  | <?php |
  | 252 |  | if(isset($\_REQUEST['action'])){ |
  | 253 |  | switch($\_REQUEST['action']){ |
  | 254 |  | case 'ad\_remove': |
  | 255 |  | if(isset($\_REQUEST['id'])){ |
  | 256 |  | if($wpdb->query($wpdb->prepare("DELETE FROM ".$wpdb->prefix.CORNER\_AD\_IMG\_TABLE." WHERE ad=%d", $\_REQUEST['id']))){ |
  | 257 |  | $wpdb->query($wpdb->prepare("DELETE FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." WHERE id=%d", $\_REQUEST['id'])); |
  | 258 |  | } |
  | 259 |  | } |
  | 260 |  | print corner\_ad\_settings\_page\_list(); |
  | 261 |  | break; |
  | 262 |  | case 'ad\_edit': |
  | 263 |  | case 'ad\_create': |
  | 264 |  | print corner\_ad\_settings\_page\_form(); |
  | 265 |  | break; |
  | 266 |  | case 'ad\_save': |
  | 267 |  | print corner\_ad\_settings\_page\_form(); |
  | 268 |  | break; |
  | 269 |  | default: |
  | 270 |  | print corner\_ad\_settings\_page\_list(); |
  | 271 |  | break; |
  | 272 |  | } |
  | 273 |  | }else{ |
  | 274 |  | print corner\_ad\_settings\_page\_list(); |
  | 275 |  | } |
  | 276 |  |  |
  | 277 |  | ?> |
  | 278 |  | </div> |
  | 279 |  | <?php |
  | 280 |  | } // End corner\_ad\_settings\_page |
  | 281 |  | } |
  | 282 |  |  |
  | 283 |  | if(!function\_exists('corner\_ad\_replace\_shortcode')){ |
  | 284 |  | function corner\_ad\_replace\_shortcode($attr){ |
  | 285 |  | global $wpdb, $corner\_ad\_inserted; |
  | 286 |  |  |
  | 287 |  |  |
  | 288 |  | if(!isset($corner\_ad\_inserted)){ |
  | 289 |  | if(empty($attr['id'])) $ad = $wpdb->get\_row("SELECT \* FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." WHERE ".(wp\_is\_mobile() ? "mobile=1" : "desktop=1")); |
  | 290 |  | else $ad = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." WHERE id=%d AND ".(wp\_is\_mobile() ? "mobile=1" : "desktop=1"), $attr['id'])); |
  | 291 |  |  |
  | 292 |  | if($ad) |
  | 293 |  | { |
  | 294 |  | $date = date('Y-m-d'); |
  | 295 |  |  |
  | 296 |  | if(!empty($ad->fromDate) && $ad->fromDate != '0000-00-00' && $date < $ad->fromDate) return ''; |
  | 297 |  | if(!empty($ad->toDate) && $ad->toDate != '0000-00-00'  && $ad->toDate < $date) return ''; |
  |  | 242 | ?> |
  |  | 243 | <div class="wrap"> |
  |  | 244 | <h1><?php esc\_html\_e( 'Corner Ad', 'corner-ad' ); ?></h1> |
  |  | 245 | <?php |
  |  | 246 | if ( isset( $\_REQUEST['action'] ) ) { |
  |  | 247 | switch ( $\_REQUEST['action'] ) { |
  |  | 248 | case 'ad\_remove': |
  |  | 249 | if ( isset( $\_REQUEST['id'] ) ) { |
  |  | 250 | if ( $wpdb->query( $wpdb->prepare( 'DELETE FROM ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . ' WHERE ad=%d', sanitize\_text\_field( wp\_unslash( $\_REQUEST['id'] ) ) ) ) ) { |
  |  | 251 | $wpdb->query( $wpdb->prepare( 'DELETE FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE id=%d', sanitize\_text\_field( wp\_unslash( $\_REQUEST['id'] ) ) ) ); |
  |  | 252 | } |
  |  | 253 | } |
  |  | 254 | print corner\_ad\_settings\_page\_list(); |
  |  | 255 | break; |
  |  | 256 | case 'ad\_edit': |
  |  | 257 | case 'ad\_create': |
  |  | 258 | print corner\_ad\_settings\_page\_form(); |
  |  | 259 | break; |
  |  | 260 | case 'ad\_save': |
  |  | 261 | print corner\_ad\_settings\_page\_form(); |
  |  | 262 | break; |
  |  | 263 | default: |
  |  | 264 | print corner\_ad\_settings\_page\_list(); |
  |  | 265 | break; |
  |  | 266 | } |
  |  | 267 | } else { |
  |  | 268 | print corner\_ad\_settings\_page\_list(); |
  |  | 269 | } |
  |  | 270 |  |
  |  | 271 | ?> |
  |  | 272 | </div> |
  |  | 273 | <?php |
  |  | 274 | } // End corner\_ad\_settings\_page |
  |  | 275 | } |
  |  | 276 |  |
  |  | 277 | if ( ! function\_exists( 'corner\_ad\_replace\_shortcode' ) ) { |
  |  | 278 | function corner\_ad\_replace\_shortcode( $attr ) { |
  |  | 279 | global $wpdb, $corner\_ad\_inserted; |
  |  | 280 |  |
  |  | 281 | if ( ! isset( $corner\_ad\_inserted ) ) { |
  |  | 282 | if ( empty( $attr['id'] ) ) { |
  |  | 283 | $ad = $wpdb->get\_row( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE ' . ( wp\_is\_mobile() ? 'mobile=1' : 'desktop=1' ) ); |
  |  | 284 | } else { |
  |  | 285 | $ad = $wpdb->get\_row( $wpdb->prepare( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE id=%d AND ' . ( wp\_is\_mobile() ? 'mobile=1' : 'desktop=1' ), $attr['id'] ) ); |
  |  | 286 | } |
  |  | 287 |  |
  |  | 288 | if ( $ad ) { |
  |  | 289 | $date = gmdate( 'Y-m-d' ); |
  |  | 290 |  |
  |  | 291 | if ( ! empty( $ad->fromDate ) && '0000-00-00' != $ad->fromDate && $date < $ad->fromDate ) { |
  |  | 292 | return ''; |
  |  | 293 | } |
  |  | 294 | if ( ! empty( $ad->toDate ) && '0000-00-00' != $ad->toDate && $ad->toDate < $date ) { |
  |  | 295 | return ''; |
  |  | 296 | } |
  | 298 | 297 |  |
  | 299 | 298 | $corner\_ad\_inserted = true; |
  | 300 |  | // Enqueue required files |
  |  | 299 | // Enqueue required files |
  | 301 | 300 | wp\_enqueue\_script( 'jquery' ); |
  | 302 |  | wp\_enqueue\_script( 'corner\_ad\_raphael\_script',  CORNER\_AD\_PLUGIN\_URL.'/js/raphael-min.js'); |
  | 303 |  | wp\_enqueue\_script( 'corner\_ad\_public\_script',  CORNER\_AD\_PLUGIN\_URL.'/js/cornerAd.min.js', array( 'jquery', 'corner\_ad\_raphael\_script' ), CORNER\_AD\_PLUGIN\_VERSION); |
  | 304 |  |  |
  | 305 |  | // Select the image |
  | 306 |  | $row = $wpdb->get\_row($wpdb->prepare("SELECT imgPath, thumbPath FROM ".$wpdb->prefix.CORNER\_AD\_IMG\_TABLE." WHERE ad=%d", $ad->id)); |
  | 307 |  |  |
  | 308 |  | if($row){ |
  | 309 |  | $img = corner\_ad\_get\_images($row->imgPath, ((!empty($row->thumbPath))? $row->thumbPath: '' ), true); |
  | 310 |  | } |
  | 311 |  |  |
  | 312 |  | $colorIn = $ad->colorIn; |
  | 313 |  | if(get\_option('corner\_ad\_analytics', 0)) $ga = esc\_js(get\_option('corner\_ad\_analytics\_tracking\_id', '')); |
  | 314 |  |  |
  | 315 |  | if(isset($ad->extra)) |
  | 316 |  | { |
  | 317 |  | $extra = json\_decode($ad->extra, true); |
  | 318 |  | } |
  |  | 301 | wp\_enqueue\_script( 'corner\_ad\_raphael\_script', CORNER\_AD\_PLUGIN\_URL . '/js/raphael-min.js', array(), CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 302 | wp\_enqueue\_script( 'corner\_ad\_public\_script', CORNER\_AD\_PLUGIN\_URL . '/js/cornerAd.min.js', array( 'jquery', 'corner\_ad\_raphael\_script' ), CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 303 |  |
  |  | 304 | // Select the image |
  |  | 305 | $row = $wpdb->get\_row( $wpdb->prepare( 'SELECT imgPath, thumbPath FROM ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . ' WHERE ad=%d', $ad->id ) ); |
  |  | 306 |  |
  |  | 307 | if ( $row ) { |
  |  | 308 | $img = corner\_ad\_get\_images( $row->imgPath, ( ( ! empty( $row->thumbPath ) ) ? $row->thumbPath : '' ), true ); |
  |  | 309 | } |
  |  | 310 |  |
  |  | 311 | $colorIn = $ad->colorIn; |
  |  | 312 | if ( get\_option( 'corner\_ad\_analytics', 0 ) ) { |
  |  | 313 | $ga = esc\_js( get\_option( 'corner\_ad\_analytics\_tracking\_id', '' ) ); |
  |  | 314 | } |
  |  | 315 |  |
  |  | 316 | if ( isset( $ad->extra ) ) { |
  |  | 317 | $extra = json\_decode( $ad->extra, true ); |
  |  | 318 | } |
  | 319 | 319 |  |
  | 320 | 320 | return "<script> |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L326) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L326) |  |
  | 326 | 326 | { |
  | 327 | 327 | alignTo:'tl', |
  | 328 |  | mirror:"~~.esc\_js(($ad->mirror == 1) ? 'true' : 'false').~~", |
  | 329 |  | colorIn:'"~~.esc\_js($colorIn).~~"', |
  | 330 |  | thumbPath:'"~~.esc\_js($img->thumb->url).~~"', |
  | 331 |  | imgPath:'"~~.esc\_js($img->large->url).~~"', |
  | 332 |  | adUrl:'"~~.esc\_js($ad->adURL).~~"', |
  | 333 |  | openIn:"~~.esc\_js(($ad->openIn) ? $ad->openIn : -1)."~~, |
  | 334 |  | closeIn:~~".esc\_js(($ad->closeIn) ? $ad->closeIn : -1).~~", |
  | 335 |  | target:'"~~.esc\_js($ad->target)."'".((!empty($ga)~~) ? ", |
  | 336 |  | ga:'"~~.$ga."'" : "").~~", |
  | 337 |  | ga\_category:'"~~.esc\_js(!empty($extra) && !empty($extra['ga\_category']) ? $extra['ga\_category'] : 'Corner Ad' ).~~"', |
  | 338 |  | ga\_action:'"~~.esc\_js(!empty($extra) && !empty($extra['ga\_action']) ? $extra['ga\_action'] : 'click' ).~~"', |
  | 339 |  | ga\_label:'"~~.esc\_js(!empty($extra) && !empty($extra['ga\_label']) ? $extra['ga\_label'] : '' ).~~"' |
  |  | 328 | mirror:" . esc\_js( ( 1 == $ad->mirror ) ? 'true' : 'false' ) . ", |
  |  | 329 | colorIn:'" . esc\_js( $colorIn ) . "', |
  |  | 330 | thumbPath:'" . esc\_js( $img->thumb->url ) . "', |
  |  | 331 | imgPath:'" . esc\_js( $img->large->url ) . "', |
  |  | 332 | adUrl:'" . esc\_js( $ad->adURL ) . "', |
  |  | 333 | openIn:" . esc\_js( ( $ad->openIn ) ? $ad->openIn : -1 ) . ', |
  |  | 334 | closeIn:' . esc\_js( ( $ad->closeIn ) ? $ad->closeIn : -1 ) . ", |
  |  | 335 | target:'" . esc\_js( $ad->target ) . "'" . ( ( ! empty( $ga ) ) ? ", |
  |  | 336 | ga:'" . $ga . "'" : '' ) . ", |
  |  | 337 | ga\_category:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_category'] ) ? $extra['ga\_category'] : 'Corner Ad' ) . "', |
  |  | 338 | ga\_action:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_action'] ) ? $extra['ga\_action'] : 'click' ) . "', |
  |  | 339 | ga\_label:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_label'] ) ? $extra['ga\_label'] : '' ) . "' |
  | 340 | 340 | } |
  | 341 | 341 | ); |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L349) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L349) |  |
  | 349 | 349 | { |
  | 350 | 350 | alignTo:'tl', |
  | 351 |  | mirror:"~~.esc\_js(($ad->mirror == 1) ? 'true' : 'false').~~", |
  | 352 |  | colorIn:'"~~.esc\_js($colorIn).~~"', |
  | 353 |  | thumbPath:'"~~.esc\_js($img->thumb->url).~~"', |
  | 354 |  | imgPath:'"~~.esc\_js($img->large->url).~~"', |
  | 355 |  | adUrl:'"~~.esc\_js($ad->adURL).~~"', |
  | 356 |  | openIn:"~~.esc\_js(($ad->openIn) ? $ad->openIn : -1)."~~, |
  | 357 |  | closeIn:~~".esc\_js(($ad->closeIn) ? $ad->closeIn : -1).~~", |
  | 358 |  | target:'"~~.esc\_js($ad->target)."'".((!empty($ga)~~) ? ", |
  | 359 |  | ga:'"~~.$ga."'" : "").~~", |
  | 360 |  | ga\_category:'"~~.esc\_js(!empty($extra) && !empty($extra['ga\_category']) ? $extra['ga\_category'] : 'Corner Ad' ).~~"', |
  | 361 |  | ga\_action:'"~~.esc\_js(!empty($extra) && !empty($extra['ga\_action']) ? $extra['ga\_action'] : 'click' ).~~"', |
  | 362 |  | ga\_label:'"~~.esc\_js(!empty($extra) && !empty($extra['ga\_label']) ? $extra['ga\_label'] : '' ).~~"' |
  |  | 351 | mirror:" . esc\_js( ( 1 == $ad->mirror ) ? 'true' : 'false' ) . ", |
  |  | 352 | colorIn:'" . esc\_js( $colorIn ) . "', |
  |  | 353 | thumbPath:'" . esc\_js( $img->thumb->url ) . "', |
  |  | 354 | imgPath:'" . esc\_js( $img->large->url ) . "', |
  |  | 355 | adUrl:'" . esc\_js( $ad->adURL ) . "', |
  |  | 356 | openIn:" . esc\_js( ( $ad->openIn ) ? $ad->openIn : -1 ) . ', |
  |  | 357 | closeIn:' . esc\_js( ( $ad->closeIn ) ? $ad->closeIn : -1 ) . ", |
  |  | 358 | target:'" . esc\_js( $ad->target ) . "'" . ( ( ! empty( $ga ) ) ? ", |
  |  | 359 | ga:'" . $ga . "'" : '' ) . ", |
  |  | 360 | ga\_category:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_category'] ) ? $extra['ga\_category'] : 'Corner Ad' ) . "', |
  |  | 361 | ga\_action:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_action'] ) ? $extra['ga\_action'] : 'click' ) . "', |
  |  | 362 | ga\_label:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_label'] ) ? $extra['ga\_label'] : '' ) . "' |
  | 363 | 363 | } |
  | 364 | 364 | ); |
  | […](/browser/corner-ad/trunk/corner-ad.php?rev=2698581#L367) | […](/browser/corner-ad/trunk/corner-ad.php?rev=2765630#L367) |  |
  | 367 | 367 | } |
  | 368 | 368 | </script>"; |
  | 369 |  | } |
  | 370 |  | } |
  | 371 |  |  |
  | 372 |  | return ''; |
  | 373 |  | } // End corner\_ad\_replace\_shortcode |
  | 374 |  | } |
  | 375 |  |  |
  | 376 |  | if(!function\_exists('corner\_ad\_media\_button')){ |
  | 377 |  | function corner\_ad\_media\_button(){ |
  | 378 |  | global $wpdb; |
  | 379 |  |  |
  | 380 |  | // Enqueue required files |
  | 381 |  | wp\_enqueue\_style('wp-jquery-ui-dialog'); |
  | 382 |  | wp\_enqueue\_script('corner\_ad\_insertion', CORNER\_AD\_PLUGIN\_URL.'/js/ca-insertion.js', array('jquery', 'jquery-ui-dialog')); |
  | 383 |  |  |
  | 384 |  | $ads = $wpdb->get\_results("SELECT id, name FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." ORDER BY name ASC;"); |
  | 385 |  | $list = ''; |
  | 386 |  | if($ads){ |
  | 387 |  | foreach($ads as $ad){ |
  | 388 |  | $list .= '<option value="'.esc\_attr($ad->id).'">'.esc\_html($ad->name).'</option>'; |
  | 389 |  | } |
  | 390 |  | } |
  | 391 |  |  |
  | 392 |  | wp\_localize\_script('corner\_ad\_insertion', 'corner\_ad', array('list' => $list)); |
  | 393 |  |  |
  | 394 |  | print '<a href="javascript:open\_insertion\_corner\_ad\_window();" title="'.esc\_attr(\_\_('Insert Corner Ad')).'"><img src="'.esc\_url(CORNER\_AD\_PLUGIN\_URL.'/images/corner-ad-icon.gif').'" alt="'.esc\_attr(\_\_('Insert Corner Ad')).'" /></a>'; |
  | 395 |  | } // End corner\_ad\_media\_button |
  | 396 |  | } |
  | 397 |  |  |
  | 398 |  | if(!function\_exists('corner\_ad\_wp\_footer')) |
  | 399 |  | { |
  | 400 |  | function corner\_ad\_wp\_footer() |
  | 401 |  | { |
  | 402 |  | $default\_ad = @intval(get\_option('corner\_ad\_default\_ad', 0)); |
  | 403 |  | $random\_ad  = @intval(get\_option('corner\_ad\_random\_ad', 0)); |
  | 404 |  | $context    = get\_option('corner\_ad\_context', 'everything'); |
  | 405 |  | $posttypes  = get\_option('corner\_ad\_posttypes', array()); |
  | 406 |  | if( |
  | 407 |  | ($default\_ad || $random\_ad) && |
  |  | 369 | } |
  |  | 370 | } |
  |  | 371 |  |
  |  | 372 | return ''; |
  |  | 373 | } // End corner\_ad\_replace\_shortcode |
  |  | 374 | } |
  |  | 375 |  |
  |  | 376 | if ( ! function\_exists( 'corner\_ad\_media\_button' ) ) { |
  |  | 377 | function corner\_ad\_media\_button() { |
  |  | 378 | global $wpdb; |
  |  | 379 |  |
  |  | 380 | // Enqueue required files |
  |  | 381 | wp\_enqueue\_style( 'wp-jquery-ui-dialog' ); |
  |  | 382 | wp\_enqueue\_script( 'corner\_ad\_insertion', CORNER\_AD\_PLUGIN\_URL . '/js/ca-insertion.js', array( 'jquery', 'jquery-ui-dialog' ), CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 383 |  |
  |  | 384 | $ads  = $wpdb->get\_results( 'SELECT id, name FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' ORDER BY name ASC;' ); |
  |  | 385 | $list = ''; |
  |  | 386 | if ( $ads ) { |
  |  | 387 | foreach ( $ads as $ad ) { |
  |  | 388 | $list .= '<option value="' . esc\_attr( $ad->id ) . '">' . esc\_html( $ad->name ) . '</option>'; |
  |  | 389 | } |
  |  | 390 | } |
  |  | 391 |  |
  |  | 392 | wp\_localize\_script( 'corner\_ad\_insertion', 'corner\_ad', array( 'list' => $list ) ); |
  |  | 393 |  |
  |  | 394 | print '<a href="javascript:open\_insertion\_corner\_ad\_window();" title="' . esc\_attr( \_\_( 'Insert Corner Ad' ) ) . '"><img src="' . esc\_url( CORNER\_AD\_PLUGIN\_URL . '/images/corner-ad-icon.gif' ) . '" alt="' . esc\_attr( \_\_( 'Insert Corner Ad' ) ) . '" /></a>'; |
  |  | 395 | } // End corner\_ad\_media\_button |
  |  | 396 | } |
  |  | 397 |  |
  |  | 398 | if ( ! function\_exists( 'corner\_ad\_wp\_footer' ) ) { |
  |  | 399 | function corner\_ad\_wp\_footer() { |
  |  | 400 | $default\_ad = @intval( get\_option( 'corner\_ad\_default\_ad', 0 ) ); |
  |  | 401 | $random\_ad  = @intval( get\_option( 'corner\_ad\_random\_ad', 0 ) ); |
  |  | 402 | $context    = get\_option( 'corner\_ad\_context', 'everything' ); |
  |  | 403 | $posttypes  = get\_option( 'corner\_ad\_posttypes', array() ); |
  |  | 404 | if ( |
  |  | 405 | ( $default\_ad || $random\_ad ) && |
  | 408 | 406 | ( |
  | 409 |  | ~~$context == 'everything'~~ || |
  | 410 |  | (~~$context == 'homepage' && is\_home()~~) || |
  | 411 |  | (~~$context == 'posttype' && in\_array(get\_post\_type(), $posttypes)~~) |
  |  | 407 | 'everything' == $context || |
  |  | 408 | ( 'homepage' == $context && is\_home() ) || |
  |  | 409 | ( 'posttype' == $context && in\_array( get\_post\_type(), $posttypes ) ) |
  | 412 | 410 | ) |
  | 413 |  | ) |
  | 414 |  | { |
  | 415 |  | if($random\_ad) |
  | 416 |  | { |
  |  | 411 | ) { |
  |  | 412 | if ( $random\_ad ) { |
  | 417 | 413 | global $wpdb; |
  | 418 |  | $ad ~~= $wpdb->get\_row("SELECT \* FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." WHERE ".(wp\_is\_mobile() ? "mobile=1" : "desktop=1")." ORDER BY RAND()"~~); |
  |  | 414 | $ad         = $wpdb->get\_row( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE ' . ( wp\_is\_mobile() ? 'mobile=1' : 'desktop=1' ) . ' ORDER BY RAND()' ); |
  | 419 | 415 | $default\_ad = $ad->id; |
  | 420 | 416 | } |
  | 421 | 417 |  |
  | 422 |  | if($default\_ad) print do\_shortcode('[corner-ad id="'.$default\_ad.'"]'); |
  |  | 418 | if ( $default\_ad ) { |
  |  | 419 | print do\_shortcode( '[corner-ad id="' . $default\_ad . '"]' ); |
  |  | 420 | } |
  | 423 | 421 | } |
  | 424 | 422 | } |
* ## [corner-ad/trunk/includes/admin\_functions.php](/changeset/2765630/corner-ad/trunk/includes/admin_functions.php?old=2675644&old_path=corner-ad%2Ftrunk%2Fincludes%2Fadmin_functions.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/includes/admin_functions.php")

  | [r2719671](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L3 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L3 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | /\* FUNCTIONS RELATED TO THE SETTINGS PAGE OF CORNER AD \*/ |
  | 4 | 4 |  |
  | 5 |  | if~~(!function\_exists('corner\_ad\_settings\_page\_list'))~~{ |
  | 6 |  | ~~function corner\_ad\_settings\_page\_list()~~{ |
  | 7 |  | wp\_enqueue\_script( 'corner\_ad\_admin\_script', ~~CORNER\_AD\_PLUGIN\_URL.'/js/ca-admin.js', array('jquery')~~); |
  |  | 5 | if ( ! function\_exists( 'corner\_ad\_settings\_page\_list' ) ) { |
  |  | 6 | function corner\_ad\_settings\_page\_list() { |
  |  | 7 | wp\_enqueue\_script( 'corner\_ad\_admin\_script', CORNER\_AD\_PLUGIN\_URL . '/js/ca-admin.js', array( 'jquery' ), CORNER\_AD\_PLUGIN\_VERSION ); |
  | 8 | 8 | wp\_localize\_script( |
  | 9 | 9 | 'corner\_ad\_admin\_script', |
  | 10 | 10 | 'corner\_ad\_default\_ad\_errors', |
  | 11 | 11 | array( |
  | 12 |  | 'posttype\_required' => \_\_(~~'As was selected the post type option for the "Display on" attribute, you must select at least a post type from the list', CORNER\_AD\_TD)~~ |
  |  | 12 | 'posttype\_required' => \_\_( 'As was selected the post type option for the "Display on" attribute, you must select at least a post type from the list', 'corner-ad' ), |
  | 13 | 13 | ) |
  | 14 | 14 | ); |
  | 15 |  | global $wpdb; |
  |  | 15 | global $wpdb; |
  | 16 | 16 | // Processing the submissions of default ad settnigs |
  | 17 |  | if(isset($\_POST['corner\_ad\_default\_ad\_nonce']) && wp\_verify\_nonce($\_POST['corner\_ad\_default\_ad\_nonce'], \_\_FILE\_\_)) |
  | 18 |  | { |
  |  | 17 | if ( isset( $\_POST['corner\_ad\_default\_ad\_nonce'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_default\_ad\_nonce'] ) ), \_\_FILE\_\_ ) ) { |
  | 19 | 18 | update\_option( |
  | 20 | 19 | 'corner\_ad\_default\_ad', |
  | 21 |  | (~~!empty($\_POST['corner\_ad\_default\_ad'])) ? @intval($\_POST['corner\_ad\_default\_ad']~~) : 0 |
  |  | 20 | ( ! empty( $\_POST['corner\_ad\_default\_ad'] ) ) ? @intval( $\_POST['corner\_ad\_default\_ad'] ) : 0 |
  | 22 | 21 | ); |
  | 23 | 22 | update\_option( |
  | 24 | 23 | 'corner\_ad\_random\_ad', |
  | 25 |  | (~~!empty($\_POST['corner\_ad\_random\_ad'])~~) ? 1 : 0 |
  |  | 24 | ( ! empty( $\_POST['corner\_ad\_random\_ad'] ) ) ? 1 : 0 |
  | 26 | 25 | ); |
  | 27 | 26 | update\_option( |
  | 28 | 27 | 'corner\_ad\_context', |
  | 29 | 28 | ( |
  | 30 |  | !~~empty($\_POST['corner\_ad\_context']~~) && |
  | 31 |  | in\_array(~~$\_POST['corner\_ad\_context'], array('everything', 'homepage', 'posttype')~~) |
  | 32 |  | ) ? ~~$\_POST['corner\_ad\_context']~~ : '' |
  |  | 29 | ! empty( $\_POST['corner\_ad\_context'] ) && |
  |  | 30 | in\_array( $\_POST['corner\_ad\_context'], array( 'everything', 'homepage', 'posttype' ) ) |
  |  | 31 | ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_context'] ) ) : '' |
  | 33 | 32 | ); |
  | 34 | 33 | update\_option( |
  | 35 | 34 | 'corner\_ad\_posttypes', |
  | 36 | 35 | ( |
  | 37 |  | isset($\_POST['corner\_ad\_posttype\_list']) && |
  | 38 |  | is\_array($\_POST['corner\_ad\_posttype\_list']) |
  | 39 |  | ) ? array\_map('sanitize\_text\_field', $\_POST['corner\_ad\_posttype\_list']) : array() |
  |  | 36 | isset( $\_POST['corner\_ad\_posttype\_list'] ) && |
  |  | 37 | is\_array( $\_POST['corner\_ad\_posttype\_list'] ) |
  |  | 38 | ) ? array\_map( |
  |  | 39 | function( $v ) { |
  |  | 40 | return sanitize\_text\_field( wp\_unslash( $v ) ); |
  |  | 41 | }, |
  |  | 42 | $\_POST['corner\_ad\_posttype\_list'] |
  |  | 43 | ) : array() |
  | 40 | 44 | ); |
  | 41 | 45 | } |
  | 42 | 46 |  |
  | 43 | 47 | // Processing the submissions of analytis settnigs |
  | 44 |  | if(isset($\_POST['corner\_ad\_analytics\_nonce']) && wp\_verify\_nonce($\_POST['corner\_ad\_analytics\_nonce'], \_\_FILE\_\_)) |
  | 45 |  | { |
  |  | 48 | if ( isset( $\_POST['corner\_ad\_analytics\_nonce'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_analytics\_nonce'] ) ), \_\_FILE\_\_ ) ) { |
  | 46 | 49 | update\_option( |
  | 47 | 50 | 'corner\_ad\_analytics', |
  | 48 |  | (~~!empty($\_POST['corner\_ad\_analytics'])~~) ? 1 : 0 |
  |  | 51 | ( ! empty( $\_POST['corner\_ad\_analytics'] ) ) ? 1 : 0 |
  | 49 | 52 | ); |
  | 50 | 53 | update\_option( |
  | 51 | 54 | 'corner\_ad\_analytics\_tracking\_id', |
  | 52 |  | ~~sanitize\_text\_field($\_POST['corner\_ad\_analytics\_tracking\_id'])~~ |
  |  | 55 | isset( $\_POST['corner\_ad\_analytics\_tracking\_id'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_analytics\_tracking\_id'] ) ) : '' |
  | 53 | 56 | ); |
  | 54 | 57 | } |
  | 55 | 58 |  |
  | 56 |  | ~~$ad = $wpdb->get\_row("SELECT \* FROM ".$wpdb->prefix.CORNER\_AD\_TABLE~~); |
  | 57 |  |  |
  | 58 |  | $output = ' |
  |  | 59 | $ad = $wpdb->get\_row( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE ); |
  |  | 60 |  |
  |  | 61 | $output = ' |
  | 59 | 62 | <div style="padding:10px; border: 1px solid #DADADA;margin-bottom:20px;text-align:center;"> |
  | 60 |  | <h2><a href="javascript:jQuery(\'.videoWrapper,.cornerAdVideoTutorialClosseButton\').toggle();">'~~.\_\_('>> Video Tutorial <<', CORNER\_AD\_TD).~~'</a> <a href="javascript:jQuery(\'.videoWrapper,.cornerAdVideoTutorialClosseButton\').toggle();" class="cornerAdVideoTutorialClosseButton" style="display:none;">[ X ]</a></h2> |
  |  | 63 | <h2><a href="javascript:jQuery(\'.videoWrapper,.cornerAdVideoTutorialClosseButton\').toggle();">' . esc\_html\_\_( '>> Video Tutorial <<', 'corner-ad' ) . '</a> <a href="javascript:jQuery(\'.videoWrapper,.cornerAdVideoTutorialClosseButton\').toggle();" class="cornerAdVideoTutorialClosseButton" style="display:none;">[ X ]</a></h2> |
  | 61 | 64 | <style>.videoWrapper {position: relative;padding-bottom: 56.25%;height: 0; display:none;} .videoWrapper iframe {position: absolute;top: 0;left: 0;width: 100%;height: 100%;}</style> |
  | 62 | 65 | <div class="videoWrapper"> |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L65) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L68) |  |
  | 65 | 68 | </div> |
  | 66 | 69 | <div class="postbox"> |
  | 67 |  | <h2 class="handle" style="padding:5px;"><span>'~~.\_\_('Select a Corner Ad or create a new one', CORNER\_AD\_TD).~~'</span></h2> |
  | 68 |  | <div class="inside"><p  style="border:1px solid #E6DB55;margin-bottom:10px;padding:5px;background-color: #FFFFE0;">'~~.\_\_('If you want test the premium version of Corner Ad go to the following links:<br/> <a href="https://demos.dwbooster.com/corner-ad/wp-login.php" target="\_blank">Administration area: Click to access the administration area demo</a><br/> <a href="https://demos.dwbooster.com/corner-ad/" target="\_blank">Public page: Click to access the Corner Ad</a><br><br><a href="https://wordpress.org/support/plugin/corner-ad/#new-post" target="\_blank">I\'ve a question</a>').~~' |
  |  | 70 | <h2 class="handle" style="padding:5px;"><span>' . esc\_html\_\_( 'Select a Corner Ad or create a new one', 'corner-ad' ) . '</span></h2> |
  |  | 71 | <div class="inside"><p  style="border:1px solid #E6DB55;margin-bottom:10px;padding:5px;background-color: #FFFFE0;">' . \_\_( 'If you want test the premium version of Corner Ad go to the following links:<br/> <a href="https://demos.dwbooster.com/corner-ad/wp-login.php" target="\_blank">Administration area: Click to access the administration area demo</a><br/> <a href="https://demos.dwbooster.com/corner-ad/" target="\_blank">Public page: Click to access the Corner Ad</a><br><br><a href="https://wordpress.org/support/plugin/corner-ad/#new-post" target="\_blank">I\'ve a question</a>' ) . ' |
  | 69 | 72 | </p>'; |
  | 70 | 73 |  |
  | 71 |  | ~~if($ad)~~{ |
  | 72 |  | ~~$create\_btn = '<div><input type="button" class="button-primary" onclick="alert(\'Only one Ad may be created in the free version of plugin\')" value="'.esc\_attr(\_\_('Create New Ad', CORNER\_AD\_TD)).~~'" /></div>'; |
  | 73 |  |  |
  | 74 |  | $output .= $create\_btn; |
  | 75 |  | $output .= '<table class="form-table"> |
  |  | 74 | if ( $ad ) { |
  |  | 75 | $create\_btn = '<div><input type="button" class="button-primary" onclick="alert(\'Only one Ad may be created in the free version of plugin\')" value="' . esc\_attr\_\_( 'Create New Ad', 'corner-ad' ) . '" /></div>'; |
  |  | 76 |  |
  |  | 77 | $output .= $create\_btn; |
  |  | 78 | $output .= '<table class="form-table"> |
  | 76 | 79 | <thead> |
  | 77 | 80 | <th style="white-space:nowrap;font-weight:bold;">Ad name</th><th style="font-weight:bold;">Actions</th><th style="font-weight:bold;">Shortcode</th><th style="white-space:nowrap;width:100%;font-weight:bold;">The Ad has been selected</th> |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L79) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L82) |  |
  | 79 | 82 | '; |
  | 80 | 83 |  |
  | 81 |  | ~~$output .= '<tr><td style="white-space:nowrap;">'.esc\_html($ad->name).'</td><td style="white-space:nowrap;"><a href="?page=corner-ad.php&action=ad\_edit&id='.esc\_attr($ad->id).'" class="button">'.\_\_('Edit', CORNER\_AD\_TD).'</a> <a href="?page=corner-ad.php&action=ad\_remove&id='.esc\_attr($ad->id).'" class="button">'.\_\_('Remove', CORNER\_AD\_TD).'</a> </td><td  style="white-space:nowrap;">[corner-ad id="'.esc\_attr($ad->id).~~'"]</td><td>Only available in the <a href="https://wordpress.dwbooster.com/content-tools/corner-ad" target="\_blank">commercial</a> version of plugin</td></tr>'; |
  | 82 |  |  |
  | 83 |  | $output .= '</table>'; |
  | 84 |  | ~~}else~~{ |
  | 85 |  | ~~$create\_btn = '<div><a href="?page=corner-ad.php&action=ad\_create" class="button-primary">'.\_\_('Create New Ad', CORNER\_AD\_TD).~~'</a></div>'; |
  | 86 |  | } |
  | 87 |  |  |
  | 88 |  | $output .= $create\_btn; |
  | 89 |  | ~~$output .=~~'</div></div>'; |
  |  | 84 | $output .= '<tr><td style="white-space:nowrap;">' . esc\_html( $ad->name ) . '</td><td style="white-space:nowrap;"><a href="?page=corner-ad.php&action=ad\_edit&id=' . esc\_attr( $ad->id ) . '" class="button">' . esc\_html\_\_( 'Edit', 'corner-ad' ) . '</a> <a href="?page=corner-ad.php&action=ad\_remove&id=' . esc\_attr( $ad->id ) . '" class="button">' . esc\_html\_\_( 'Remove', 'corner-ad' ) . '</a> </td><td  style="white-space:nowrap;">[corner-ad id="' . esc\_attr( $ad->id ) . '"]</td><td>Only available in the <a href="https://wordpress.dwbooster.com/content-tools/corner-ad" target="\_blank">commercial</a> version of plugin</td></tr>'; |
  |  | 85 |  |
  |  | 86 | $output .= '</table>'; |
  |  | 87 | } else { |
  |  | 88 | $create\_btn = '<div><a href="?page=corner-ad.php&action=ad\_create" class="button-primary">' . esc\_html\_\_( 'Create New Ad', 'corner-ad' ) . '</a></div>'; |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | $output .= $create\_btn; |
  |  | 92 | $output .= '</div></div>'; |
  | 90 | 93 |  |
  | 91 | 94 | // Configure the default visualization of ads |
  | 92 | 95 |  |
  | 93 |  | $default\_ad = get\_option(~~'corner\_ad\_default\_ad', 0~~); |
  | 94 |  | $random\_ad ~~= get\_option('corner\_ad\_random\_ad', 0~~); |
  | 95 |  | $context ~~= get\_option('corner\_ad\_context', 'everything'~~); |
  | 96 |  | $posttypes ~~= get\_option('corner\_ad\_posttypes', array()~~); |
  | 97 |  | $output .= '<div class="postbox"> |
  | 98 |  | <h3 class="handle" style="padding:5px;"><span>'~~.\_\_('Displaying Ads at Website\'s Scope', CORNER\_AD\_TD).~~'</span></h3> |
  |  | 96 | $default\_ad = get\_option( 'corner\_ad\_default\_ad', 0 ); |
  |  | 97 | $random\_ad  = get\_option( 'corner\_ad\_random\_ad', 0 ); |
  |  | 98 | $context    = get\_option( 'corner\_ad\_context', 'everything' ); |
  |  | 99 | $posttypes  = get\_option( 'corner\_ad\_posttypes', array() ); |
  |  | 100 | $output    .= '<div class="postbox"> |
  |  | 101 | <h3 class="handle" style="padding:5px;"><span>' . esc\_html\_\_( 'Displaying Ads at Website\'s Scope', 'corner-ad' ) . '</span></h3> |
  | 99 | 102 | <div class="inside"> |
  | 100 |  | <form action="'.admin\_url( 'options-general.php?page=corner-ad.php' ).'" name="corner\_ad\_default\_ad\_settings" method="post"> |
  | 101 |  | <p>'.\_\_('Select the Ad to be displayed by default in the following circumstances', CORNER\_AD\_TD).':</p>'; |
  | 102 |  | if($ad) |
  | 103 |  | { |
  | 104 |  |  |
  | 105 |  | $output .= '<div> |
  | 106 |  | <select aria-label="'.esc\_attr(\_\_('Ads list', CORNER\_AD\_TD)).'" name="corner\_ad\_default\_ad"> |
  |  | 103 | <form action="' . admin\_url( 'options-general.php?page=corner-ad.php' ) . '" name="corner\_ad\_default\_ad\_settings" method="post"> |
  |  | 104 | <p>' . esc\_html\_\_( 'Select the Ad to be displayed by default in the following circumstances', 'corner-ad' ) . ':</p>'; |
  |  | 105 | if ( $ad ) { |
  |  | 106 |  |
  |  | 107 | $output  .= '<div> |
  |  | 108 | <select aria-label="' . esc\_attr\_\_( 'Ads list', 'corner-ad' ) . '" name="corner\_ad\_default\_ad"> |
  | 107 | 109 | <option value="">' |
  | 108 |  | .~~esc\_html(\_\_('- Select an Ad -',CORNER\_AD\_TD)~~) |
  | 109 |  | .'</option>'; |
  | 110 |  | $selected = (~~$ad->id == $default\_ad~~) ? 'SELECTED' : ''; |
  | 111 |  | $output ~~.= '<option value="'.esc\_attr($ad->id).'" '.$selected.'>'.esc\_html($ad->name).~~'</option>'; |
  | 112 |  | $output .= ' |
  |  | 110 | . esc\_html( \_\_( '- Select an Ad -', 'corner-ad' ) ) |
  |  | 111 | . '</option>'; |
  |  | 112 | $selected = ( $ad->id == $default\_ad ) ? 'SELECTED' : ''; |
  |  | 113 | $output  .= '<option value="' . esc\_attr( $ad->id ) . '" ' . $selected . '>' . esc\_html( $ad->name ) . '</option>'; |
  |  | 114 | $output  .= ' |
  | 113 | 115 | </select> |
  | 114 |  | '~~.\_\_('- or -', CORNER\_AD\_TD).~~' |
  | 115 |  | <input aria-label="'~~.esc\_attr(\_\_('Random ad', CORNER\_AD\_TD)).'" type="checkbox" name="corner\_ad\_random\_ad" '.(($random\_ad != 0) ? 'CHECKED' : '').~~'> |
  | 116 |  | '~~.\_\_('Display a random AD', CORNER\_AD\_TD).~~' |
  |  | 116 | ' . esc\_html\_\_( '- or -', 'corner-ad' ) . ' |
  |  | 117 | <input aria-label="' . esc\_attr\_\_( 'Random ad', 'corner-ad' ) . '" type="checkbox" name="corner\_ad\_random\_ad" ' . ( ( 0 != $random\_ad ) ? 'CHECKED' : '' ) . '> |
  |  | 118 | ' . esc\_html\_\_( 'Display a random AD', 'corner-ad' ) . ' |
  | 117 | 119 | </div>'; |
  | 118 |  | } |
  | 119 |  | else |
  | 120 |  | { |
  | 121 |  | $output .= '<p style="font-size:1.2em; color:red; font-style:italic;">'.\_\_('You should create at least an Ad first (section above).',CORNER\_AD\_TD).'</p>'; |
  |  | 120 | } else { |
  |  | 121 | $output .= '<p style="font-size:1.2em; color:red; font-style:italic;">' . esc\_html\_\_( 'You should create at least an Ad first (section above).', 'corner-ad' ) . '</p>'; |
  | 122 | 122 | } |
  | 123 | 123 |  |
  | 124 | 124 | $output .= ' |
  | 125 |  | <p>'~~.\_\_('Display on', CORNER\_AD\_TD).~~':</p> |
  |  | 125 | <p>' . esc\_html\_\_( 'Display on', 'corner-ad' ) . ':</p> |
  | 126 | 126 | <div> |
  | 127 | 127 | <label> |
  | 128 |  | <input aria-label="'~~.esc\_attr(\_\_('Every page', CORNER\_AD\_TD)).'" type="radio" name="corner\_ad\_context" value="everything" '.(('everything' == $context) ? 'CHECKED' : '').~~' /> |
  | 129 |  | '~~.\_\_('Show the Ad on every page, post or section of website').~~' |
  |  | 128 | <input aria-label="' . esc\_attr\_\_( 'Every page', 'corner-ad' ) . '" type="radio" name="corner\_ad\_context" value="everything" ' . ( ( 'everything' == $context ) ? 'CHECKED' : '' ) . ' /> |
  |  | 129 | ' . esc\_html\_\_( 'Show the Ad on every page, post or section of website', 'corner-ad' ) . ' |
  | 130 | 130 | </label><br /> |
  | 131 | 131 | <label> |
  | 132 |  | <input aria-label="'~~.esc\_attr(\_\_('Homepage only', CORNER\_AD\_TD)).'" type="radio" name="corner\_ad\_context" value="homepage" '.(('homepage' == $context) ? 'CHECKED' : '').~~' /> |
  | 133 |  | '~~.\_\_('Show the Ad on the homepage only').~~' |
  |  | 132 | <input aria-label="' . esc\_attr\_\_( 'Homepage only', 'corner-ad' ) . '" type="radio" name="corner\_ad\_context" value="homepage" ' . ( ( 'homepage' == $context ) ? 'CHECKED' : '' ) . ' /> |
  |  | 133 | ' . esc\_html\_\_( 'Show the Ad on the homepage only', 'corner-ad' ) . ' |
  | 134 | 134 | </label><br /> |
  | 135 | 135 | <label> |
  | 136 |  | <input aria-label="'~~.esc\_attr(\_\_('Specific post type', CORNER\_AD\_TD)).'" type="radio" name="corner\_ad\_context" value="posttype" '.(('posttype' == $context) ? 'CHECKED' : '').~~' /> |
  | 137 |  | '~~.\_\_('Show the Ad with the following post types (select them from the following list)').~~': |
  |  | 136 | <input aria-label="' . esc\_attr\_\_( 'Specific post type', 'corner-ad' ) . '" type="radio" name="corner\_ad\_context" value="posttype" ' . ( ( 'posttype' == $context ) ? 'CHECKED' : '' ) . ' /> |
  |  | 137 | ' . esc\_html\_\_( 'Show the Ad with the following post types (select them from the following list)', 'corner-ad' ) . ': |
  | 138 | 138 | </label> |
  | 139 |  | <div class="corner-ad-post-types-list" style="display:'.(('posttype' == $context) ? 'block' : 'none').';margin-top:20px;"> |
  | 140 |  | <select aria-label="'.esc\_attr(\_\_('Post types list', CORNER\_AD\_TD)).'" name="corner\_ad\_posttype\_list[]" multiple rows="5">'; |
  | 141 |  |  |
  | 142 |  | //Read post types |
  | 143 |  | $posttypes\_list = get\_post\_types(array('public' => true)); |
  | 144 |  | foreach($posttypes\_list as $posttype\_name) |
  | 145 |  | { |
  | 146 |  | $posttype\_obj = get\_post\_type\_object($posttype\_name); |
  | 147 |  | $output .= '<option value="'.esc\_attr($posttype\_name).'" '.((in\_array($posttype\_name, $posttypes)) ? 'SELECTED' : '').'>'.esc\_html($posttype\_obj->labels->name).'</option>'; |
  |  | 139 | <div class="corner-ad-post-types-list" style="display:' . ( ( 'posttype' == $context ) ? 'block' : 'none' ) . ';margin-top:20px;"> |
  |  | 140 | <select aria-label="' . esc\_attr\_\_( 'Post types list', 'corner-ad' ) . '" name="corner\_ad\_posttype\_list[]" multiple rows="5">'; |
  |  | 141 |  |
  |  | 142 | // Read post types |
  |  | 143 | $posttypes\_list = get\_post\_types( array( 'public' => true ) ); |
  |  | 144 | foreach ( $posttypes\_list as $posttype\_name ) { |
  |  | 145 | $posttype\_obj = get\_post\_type\_object( $posttype\_name ); |
  |  | 146 | $output      .= '<option value="' . esc\_attr( $posttype\_name ) . '" ' . ( ( in\_array( $posttype\_name, $posttypes ) ) ? 'SELECTED' : '' ) . '>' . esc\_html( $posttype\_obj->labels->name ) . '</option>'; |
  | 148 | 147 | } |
  | 149 | 148 | $output .= ' |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L151) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L150) |  |
  | 151 | 150 | </div> |
  | 152 | 151 | </div>'; |
  | 153 |  | $output .= '<input type="hidden" name="corner\_ad\_default\_ad\_nonce" value="' . wp\_create\_nonce(~~\_\_FILE\_\_~~) . '" />'; |
  |  | 152 | $output .= '<input type="hidden" name="corner\_ad\_default\_ad\_nonce" value="' . wp\_create\_nonce( \_\_FILE\_\_ ) . '" />'; |
  | 154 | 153 | // Display submit button |
  | 155 |  | if($ad) |
  | 156 |  | { |
  | 157 |  | $output .= '<div style="margin-top:20px;"><input type="submit" class="button-primary corner-ad-default-ad-settings" value="'.\_\_('Save Changes', CORNER\_AD\_TD).'" /></div>'; |
  |  | 154 | if ( $ad ) { |
  |  | 155 | $output .= '<div style="margin-top:20px;"><input type="submit" class="button-primary corner-ad-default-ad-settings" value="' . esc\_attr\_\_( 'Save Changes', 'corner-ad' ) . '" /></div>'; |
  | 158 | 156 | } |
  | 159 | 157 |  |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L164) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L162) |  |
  | 164 | 162 | </div>'; |
  | 165 | 163 |  |
  | 166 |  | /\*\* Analytics \*~~\*~~/ |
  | 167 |  | $enabled\_analytics ~~= get\_option('corner\_ad\_analytics', 0~~); |
  | 168 |  | $analytics\_tracking\_id = get\_option(~~'corner\_ad\_analytics\_tracking\_id', ''~~); |
  | 169 |  | $output .= '<div class="postbox"> |
  | 170 |  | <h3 class="handle" style="padding:5px;"><span>'~~.\_\_('Integrate with Google Analytics', CORNER\_AD\_TD).~~'</span></h3> |
  |  | 164 | /\*\* Analytics \*/ |
  |  | 165 | $enabled\_analytics     = get\_option( 'corner\_ad\_analytics', 0 ); |
  |  | 166 | $analytics\_tracking\_id = get\_option( 'corner\_ad\_analytics\_tracking\_id', '' ); |
  |  | 167 | $output               .= '<div class="postbox"> |
  |  | 168 | <h3 class="handle" style="padding:5px;"><span>' . esc\_html\_\_( 'Integrate with Google Analytics', 'corner-ad' ) . '</span></h3> |
  | 171 | 169 | <div class="inside"> |
  | 172 |  | <form action="'~~.admin\_url( 'options-general.php?page=corner-ad.php' ).~~'" name="corner\_ad\_analytics\_settings" method="post"> |
  | 173 |  | <p><input aria-label="'~~.esc\_attr(\_\_('Analytics integration', CORNER\_AD\_TD)).'" type="checkbox" name="corner\_ad\_analytics" '.(($enabled\_analytics) ? 'CHECKED' : '').' /> '.\_\_('Registering the click events in Google Analytics', CORNER\_AD\_TD).~~'</p> |
  | 174 |  | <p>'~~.\_\_('Enter the Google Analytics Tracking Id', CORNER\_AD\_TD).~~':</p> |
  | 175 |  | <p><input aria-label="'~~.esc\_attr(\_\_('Analytics tracking id', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_analytics\_tracking\_id" value="'.esc\_attr($analytics\_tracking\_id).~~'" /></p> |
  | 176 |  | <div style="margin-top:20px;"><input type="submit" class="button-primary" value="'~~.\_\_('Save Changes', CORNER\_AD\_TD).~~'" /></div> |
  | 177 |  | <input type="hidden" name="corner\_ad\_analytics\_nonce" value="' . wp\_create\_nonce(~~\_\_FILE\_\_~~) . '" /> |
  |  | 170 | <form action="' . admin\_url( 'options-general.php?page=corner-ad.php' ) . '" name="corner\_ad\_analytics\_settings" method="post"> |
  |  | 171 | <p><input aria-label="' . esc\_attr\_\_( 'Analytics integration', 'corner-ad' ) . '" type="checkbox" name="corner\_ad\_analytics" ' . ( ( $enabled\_analytics ) ? 'CHECKED' : '' ) . ' /> ' . esc\_html\_\_( 'Registering the click events in Google Analytics', 'corner-ad' ) . '</p> |
  |  | 172 | <p>' . esc\_html\_\_( 'Enter the Google Analytics Tracking Id', 'corner-ad' ) . ':</p> |
  |  | 173 | <p><input aria-label="' . esc\_attr\_\_( 'Analytics tracking id', 'corner-ad' ) . '" type="text" name="corner\_ad\_analytics\_tracking\_id" value="' . esc\_attr( $analytics\_tracking\_id ) . '" /></p> |
  |  | 174 | <div style="margin-top:20px;"><input type="submit" class="button-primary" value="' . esc\_attr\_\_( 'Save Changes', 'corner-ad' ) . '" /></div> |
  |  | 175 | <input type="hidden" name="corner\_ad\_analytics\_nonce" value="' . wp\_create\_nonce( \_\_FILE\_\_ ) . '" /> |
  | 178 | 176 | </form> |
  | 179 | 177 | </div> |
  | 180 | 178 | </div>'; |
  | 181 | 179 |  |
  | 182 |  | return $output; |
  | 183 |  | } // End corner\_ad\_settings\_page\_list |
  |  | 180 | return $output; |
  |  | 181 | } // End corner\_ad\_settings\_page\_list |
  | 184 | 182 | } |
  | 185 | 183 |  |
  | 186 |  | if(!function\_exists('corner\_ad\_settings\_page\_form')){ |
  | 187 |  | function corner\_ad\_settings\_page\_form(){ |
  | 188 |  | global $wpdb; |
  | 189 |  |  |
  | 190 |  | if(!empty($\_POST)) $\_POST = stripslashes\_deep($\_POST); |
  | 191 |  |  |
  | 192 |  | $data; |
  | 193 |  | $error = array(); |
  | 194 |  | $id; |
  | 195 |  | $output = ''; |
  | 196 |  | $title = \_\_('Create or edit a Corner Ad', CORNER\_AD\_TD); |
  | 197 |  |  |
  | 198 |  | wp\_enqueue\_script( 'jquery'); |
  |  | 184 | if ( ! function\_exists( 'corner\_ad\_settings\_page\_form' ) ) { |
  |  | 185 | function corner\_ad\_settings\_page\_form() { |
  |  | 186 | global $wpdb; |
  |  | 187 |  |
  |  | 188 | if ( ! empty( $\_POST ) ) { |
  |  | 189 | $\_POST = stripslashes\_deep( $\_POST ); |
  |  | 190 | } |
  |  | 191 |  |
  |  | 192 | $data; |
  |  | 193 | $error = array(); |
  |  | 194 | $id; |
  |  | 195 | $output = ''; |
  |  | 196 | $title  = \_\_( 'Create or edit a Corner Ad', 'corner-ad' ); |
  |  | 197 |  |
  |  | 198 | wp\_enqueue\_script( 'jquery' ); |
  | 199 | 199 |  |
  | 200 | 200 | // Load the datepicker resources |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L203) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L203) |  |
  | 203 | 203 | wp\_enqueue\_style( |
  | 204 | 204 | 'plugin\_name-admin-ui-css', |
  | 205 |  | '//code.jquery.com/ui/' . $wp\_scripts->registered['jquery-ui-core']->ver . '/themes/smoothness/jquery-ui.css' |
  |  | 205 | '//code.jquery.com/ui/' . $wp\_scripts->registered['jquery-ui-core']->ver . '/themes/smoothness/jquery-ui.css', |
  |  | 206 | array(), |
  |  | 207 | CORNER\_AD\_PLUGIN\_VERSION |
  | 206 | 208 | ); |
  | 207 | 209 |  |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L211) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L213) |  |
  | 211 | 213 | wp\_enqueue\_style( 'thickbox' ); |
  | 212 | 214 | wp\_enqueue\_script( 'thickbox' ); |
  | 213 |  | wp\_enqueue\_script( 'corner\_ad\_admin\_script',  CORNER\_AD\_PLUGIN\_URL.'/js/ca-admin.js', array('jquery')); |
  | 214 |  |  |
  | 215 |  | if(isset($\_REQUEST['id'])){ |
  | 216 |  | $data = $wpdb->get\_row($wpdb->prepare("SELECT \* FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." WHERE id=%d", $\_REQUEST['id'])); |
  | 217 |  | if($data){ |
  | 218 |  | $id = $data->id; |
  | 219 |  | $corner\_ad\_name = $data->name; |
  | 220 |  | $corner\_ad\_alignTo = $data->alignTo; |
  | 221 |  | $corner\_ad\_mirror = $data->mirror; |
  | 222 |  | $corner\_ad\_colorIn = $data->colorIn; |
  | 223 |  | $corner\_ad\_openIn = $data->openIn; |
  | 224 |  | $corner\_ad\_closeIn = $data->closeIn; |
  | 225 |  | $corner\_ad\_adURL = $data->adURL; |
  | 226 |  | $corner\_ad\_target = $data->target; |
  | 227 |  | $corner\_ad\_desktop\_device = (!isset($data->desktop) || !empty($data->desktop)) ? 1 : 0; |
  | 228 |  | $corner\_ad\_mobile\_device = (!isset($data->mobile) || !empty($data->mobile)) ? 1 : 0; |
  | 229 |  | $corner\_ad\_from = (!empty($data->fromDate)) ? trim($data->fromDate) : ''; |
  | 230 |  | $corner\_ad\_to = (!empty($data->toDate)) ? trim($data->toDate) : ''; |
  | 231 |  | $corner\_ad\_extra = (!empty($data->extra)) ? json\_decode($data->extra, true) : []; |
  | 232 |  |  |
  | 233 |  | $corner\_ad\_imgPath = array(); |
  | 234 |  |  |
  | 235 |  | $result = $wpdb->get\_row($wpdb->prepare("SELECT imgPath, thumbPath FROM ".$wpdb->prefix.CORNER\_AD\_IMG\_TABLE." WHERE ad=%d", $id)); |
  | 236 |  | if($result){ |
  | 237 |  | $corner\_ad\_imgPath = $result->imgPath; |
  | 238 |  | $corner\_ad\_thumbPath = !empty( $result->thumbPath ) ? $result->thumbPath : ''; |
  | 239 |  | } |
  | 240 |  |  |
  | 241 |  | } |
  | 242 |  | } |
  | 243 |  |  |
  | 244 |  | if(isset($\_POST['corner\_ad\_edition\_nonce']) && wp\_verify\_nonce($\_POST['corner\_ad\_edition\_nonce'], \_\_FILE\_\_)) |
  | 245 |  | { |
  | 246 |  | // Check by column and add it |
  | 247 |  | call\_user\_func(function() { |
  | 248 |  | global $wpdb; |
  | 249 |  |  |
  | 250 |  | $add\_column = true; |
  | 251 |  | $columns = $wpdb->get\_results("SHOW columns FROM `".$wpdb->prefix.CORNER\_AD\_TABLE."`"); |
  | 252 |  | foreach( $columns as $column ) |
  | 253 |  | { |
  | 254 |  | if($column->Field == 'extra') |
  | 255 |  | { |
  | 256 |  | $add\_column = false; |
  | 257 |  | break; |
  | 258 |  | } |
  | 259 |  | } |
  | 260 |  | if($add\_column) |
  | 261 |  | { |
  | 262 |  | $sql = "ALTER TABLE  `".$wpdb->prefix.CORNER\_AD\_TABLE."` ADD `extra` TEXT"; |
  | 263 |  | $wpdb->query($sql); |
  | 264 |  | } |
  | 265 |  | }); |
  | 266 |  |  |
  | 267 |  | if(!empty($\_POST['corner\_ad\_name'])) |
  | 268 |  | $corner\_ad\_name = $\_POST['corner\_ad\_name']; |
  | 269 |  | else |
  | 270 |  | $error[] = \_\_('The Ad name is required', CORNER\_AD\_TD); |
  | 271 |  |  |
  | 272 |  | $corner\_ad\_alignTo = (isset($\_POST['corner\_ad\_alignTo']) && $\_POST['corner\_ad\_alignTo'] == 'tr') ? 'tr' : 'tl'; |
  | 273 |  | $corner\_ad\_mirror  = (isset($\_POST['corner\_ad\_mirror']))  ? 1 : 0; |
  | 274 |  | $corner\_ad\_colorIn = (isset($\_POST['corner\_ad\_colorIn'])) ? sanitize\_text\_field($\_POST['corner\_ad\_colorIn'])  : 'FFFFFF' ; |
  | 275 |  | $corner\_ad\_openIn  = (isset($\_POST['corner\_ad\_openIn']))  ? @intval($\_POST['corner\_ad\_openIn'])   : 0; |
  | 276 |  | $corner\_ad\_closeIn = (isset($\_POST['corner\_ad\_closeIn'])) ? @intval($\_POST['corner\_ad\_closeIn'])  : 0; |
  | 277 |  | $corner\_ad\_from    = (isset($\_POST['corner\_ad\_from'])) ? sanitize\_text\_field($\_POST['corner\_ad\_from'])  : ''; |
  | 278 |  | $corner\_ad\_to      = (isset($\_POST['corner\_ad\_to'])) ? sanitize\_text\_field($\_POST['corner\_ad\_to'])  : ''; |
  | 279 |  |  |
  | 280 |  | $corner\_ad\_extra   = [ |
  | 281 |  | 'ga\_category'   => sanitize\_text\_field($\_POST['corner\_ad\_ga\_category']), |
  | 282 |  | 'ga\_action'     => sanitize\_text\_field($\_POST['corner\_ad\_ga\_action']), |
  | 283 |  | 'ga\_label'      => sanitize\_text\_field($\_POST['corner\_ad\_ga\_label']), |
  | 284 |  | ]; |
  | 285 |  |  |
  | 286 |  | if(!empty($\_POST['corner\_ad\_imgPath'])){ |
  | 287 |  | $corner\_ad\_imgPath   = sanitize\_text\_field($\_POST['corner\_ad\_imgPath']); |
  | 288 |  | $corner\_ad\_thumbPath = ( !empty($\_POST['corner\_ad\_thumbPath']) ) ? sanitize\_text\_field($\_POST['corner\_ad\_thumbPath']) : $corner\_ad\_imgPath; |
  | 289 |  |  |
  | 290 |  | if( !empty( $corner\_ad\_imgPath ) ) |
  | 291 |  | { |
  |  | 215 | wp\_enqueue\_script( 'corner\_ad\_admin\_script', CORNER\_AD\_PLUGIN\_URL . '/js/ca-admin.js', array( 'jquery' ), CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 216 |  |
  |  | 217 | if ( isset( $\_REQUEST['id'] ) ) { |
  |  | 218 | $data = $wpdb->get\_row( $wpdb->prepare( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE id=%d', sanitize\_text\_field( wp\_unslash( $\_REQUEST['id'] ) ) ) ); |
  |  | 219 | if ( $data ) { |
  |  | 220 | $id                       = $data->id; |
  |  | 221 | $corner\_ad\_name           = $data->name; |
  |  | 222 | $corner\_ad\_alignTo        = $data->alignTo; |
  |  | 223 | $corner\_ad\_mirror         = $data->mirror; |
  |  | 224 | $corner\_ad\_colorIn        = $data->colorIn; |
  |  | 225 | $corner\_ad\_openIn         = $data->openIn; |
  |  | 226 | $corner\_ad\_closeIn        = $data->closeIn; |
  |  | 227 | $corner\_ad\_adURL          = $data->adURL; |
  |  | 228 | $corner\_ad\_target         = $data->target; |
  |  | 229 | $corner\_ad\_desktop\_device = ( ! isset( $data->desktop ) || ! empty( $data->desktop ) ) ? 1 : 0; |
  |  | 230 | $corner\_ad\_mobile\_device  = ( ! isset( $data->mobile ) || ! empty( $data->mobile ) ) ? 1 : 0; |
  |  | 231 | $corner\_ad\_from           = ( ! empty( $data->fromDate ) ) ? trim( $data->fromDate ) : ''; |
  |  | 232 | $corner\_ad\_to             = ( ! empty( $data->toDate ) ) ? trim( $data->toDate ) : ''; |
  |  | 233 | $corner\_ad\_extra          = ( ! empty( $data->extra ) ) ? json\_decode( $data->extra, true ) : array(); |
  |  | 234 |  |
  |  | 235 | $corner\_ad\_imgPath = array(); |
  |  | 236 |  |
  |  | 237 | $result = $wpdb->get\_row( $wpdb->prepare( 'SELECT imgPath, thumbPath FROM ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . ' WHERE ad=%d', $id ) ); |
  |  | 238 | if ( $result ) { |
  |  | 239 | $corner\_ad\_imgPath   = $result->imgPath; |
  |  | 240 | $corner\_ad\_thumbPath = ! empty( $result->thumbPath ) ? $result->thumbPath : ''; |
  |  | 241 | } |
  |  | 242 | } |
  |  | 243 | } |
  |  | 244 |  |
  |  | 245 | if ( isset( $\_POST['corner\_ad\_edition\_nonce'] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_edition\_nonce'] ) ), \_\_FILE\_\_ ) ) { |
  |  | 246 | // Check by column and add it |
  |  | 247 | call\_user\_func( |
  |  | 248 | function() { |
  |  | 249 | global $wpdb; |
  |  | 250 |  |
  |  | 251 | $add\_column = true; |
  |  | 252 | $columns    = $wpdb->get\_results( 'SHOW columns FROM `' . $wpdb->prefix . CORNER\_AD\_TABLE . '`' ); |
  |  | 253 | foreach ( $columns as $column ) { |
  |  | 254 | if ( 'extra' == $column->Field ) { |
  |  | 255 | $add\_column = false; |
  |  | 256 | break; |
  |  | 257 | } |
  |  | 258 | } |
  |  | 259 | if ( $add\_column ) { |
  |  | 260 | $sql = 'ALTER TABLE  `' . $wpdb->prefix . CORNER\_AD\_TABLE . '` ADD `extra` TEXT'; |
  |  | 261 | $wpdb->query( $sql ); |
  |  | 262 | } |
  |  | 263 | } |
  |  | 264 | ); |
  |  | 265 |  |
  |  | 266 | if ( ! empty( $\_POST['corner\_ad\_name'] ) ) { |
  |  | 267 | $corner\_ad\_name = sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_name'] ) ); |
  |  | 268 | } else { |
  |  | 269 | $error[] = esc\_html\_\_( 'The Ad name is required', 'corner-ad' ); |
  |  | 270 | } |
  |  | 271 |  |
  |  | 272 | $corner\_ad\_alignTo = ( isset( $\_POST['corner\_ad\_alignTo'] ) && 'tr' == $\_POST['corner\_ad\_alignTo'] ) ? 'tr' : 'tl'; |
  |  | 273 | $corner\_ad\_mirror  = ( isset( $\_POST['corner\_ad\_mirror'] ) ) ? 1 : 0; |
  |  | 274 | $corner\_ad\_colorIn = ( isset( $\_POST['corner\_ad\_colorIn'] ) ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_colorIn'] ) ) : 'FFFFFF'; |
  |  | 275 | $corner\_ad\_openIn  = ( isset( $\_POST['corner\_ad\_openIn'] ) && is\_numeric( $\_POST['corner\_ad\_openIn'] ) ) ? intval( $\_POST['corner\_ad\_openIn'] ) : 0; |
  |  | 276 | $corner\_ad\_closeIn = ( isset( $\_POST['corner\_ad\_closeIn'] ) && is\_numeric( $\_POST['corner\_ad\_closeIn'] ) ) ? intval( $\_POST['corner\_ad\_closeIn'] ) : 0; |
  |  | 277 | $corner\_ad\_from    = ( isset( $\_POST['corner\_ad\_from'] ) ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_from'] ) ) : ''; |
  |  | 278 | $corner\_ad\_to      = ( isset( $\_POST['corner\_ad\_to'] ) ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_to'] ) ) : ''; |
  |  | 279 |  |
  |  | 280 | $corner\_ad\_extra = array( |
  |  | 281 | 'ga\_category' => isset( $\_POST['corner\_ad\_ga\_category'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_ga\_category'] ) ) : '', |
  |  | 282 | 'ga\_action'   => isset( $\_POST['corner\_ad\_ga\_action'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_ga\_action'] ) ) : '', |
  |  | 283 | 'ga\_label'    => isset( $\_POST['corner\_ad\_ga\_label'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_ga\_label'] ) ) : '', |
  |  | 284 | ); |
  |  | 285 |  |
  |  | 286 | if ( ! empty( $\_POST['corner\_ad\_imgPath'] ) ) { |
  |  | 287 | $corner\_ad\_imgPath   = sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_imgPath'] ) ); |
  |  | 288 | $corner\_ad\_thumbPath = ( ! empty( $\_POST['corner\_ad\_thumbPath'] ) ) ? sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_thumbPath'] ) ) : $corner\_ad\_imgPath; |
  |  | 289 |  |
  |  | 290 | if ( ! empty( $corner\_ad\_imgPath ) ) { |
  | 292 | 291 | $img = corner\_ad\_get\_images( $corner\_ad\_imgPath, $corner\_ad\_thumbPath ); |
  | 293 | 292 |  |
  | 294 | 293 | // Large |
  | 295 |  | if( !empty( $img->large->id ) ) |
  | 296 |  | { |
  |  | 294 | if ( ! empty( $img->large->id ) ) { |
  | 297 | 295 | $img\_obj = wp\_get\_image\_editor( $img->large->url ); |
  | 298 |  | if~~( !is\_wp\_error( $img\_obj ) )~~{ |
  | 299 |  |  |
  | 300 |  | $imgSize = $img\_obj->get\_size(); |
  | 301 |  | $size ~~= min($imgSize['height'], $imgSize['width'], 500~~); |
  |  | 296 | if ( ! is\_wp\_error( $img\_obj ) ) { |
  |  | 297 |  |
  |  | 298 | $imgSize = $img\_obj->get\_size(); |
  |  | 299 | $size    = min( $imgSize['height'], $imgSize['width'], 500 ); |
  | 302 | 300 | add\_image\_size( 'corner\_ad', $size, $size, true ); |
  | 303 | 301 | } |
  | 304 |  | $img->large->file = get\_attached\_file(~~$img->large->id~~); |
  |  | 302 | $img->large->file = get\_attached\_file( $img->large->id ); |
  | 305 | 303 | wp\_update\_attachment\_metadata( $img->large->id, wp\_generate\_attachment\_metadata( $img->large->id, $img->large->file ) ); |
  | 306 | 304 | } |
  | 307 | 305 |  |
  | 308 | 306 | // Thumb |
  | 309 |  | if( !empty( $img->thumb->id ) ) |
  | 310 |  | { |
  |  | 307 | if ( ! empty( $img->thumb->id ) ) { |
  | 311 | 308 | $img\_obj = wp\_get\_image\_editor( $img->thumb->url ); |
  | 312 |  | if~~( !is\_wp\_error( $img\_obj ) )~~{ |
  | 313 |  |  |
  | 314 |  | $imgSize = $img\_obj->get\_size(); |
  | 315 |  | $size ~~= min($imgSize['height'], $imgSize['width'], 100~~); |
  |  | 309 | if ( ! is\_wp\_error( $img\_obj ) ) { |
  |  | 310 |  |
  |  | 311 | $imgSize = $img\_obj->get\_size(); |
  |  | 312 | $size    = min( $imgSize['height'], $imgSize['width'], 100 ); |
  | 316 | 313 | add\_image\_size( 'corner\_ad\_thumb', $size, $size, true ); |
  | 317 | 314 | } |
  | 318 |  | $img->thumb->file = get\_attached\_file(~~$img->thumb->id~~); |
  |  | 315 | $img->thumb->file = get\_attached\_file( $img->thumb->id ); |
  | 319 | 316 | wp\_update\_attachment\_metadata( $img->thumb->id, wp\_generate\_attachment\_metadata( $img->thumb->id, $img->thumb->file ) ); |
  | 320 | 317 | } |
  | 321 | 318 | } |
  | 322 |  | }else{ |
  | 323 |  | $error[] = \_\_('The Ad image is required', CORNER\_AD\_TD); |
  | 324 |  | } |
  | 325 |  |  |
  | 326 |  | if(!empty($\_POST['corner\_ad\_adURL'])) |
  | 327 |  | $corner\_ad\_adURL = sanitize\_text\_field($\_POST['corner\_ad\_adURL']); |
  | 328 |  | else |
  | 329 |  | $error[] = \_\_('The Ad link is required', CORNER\_AD\_TD); |
  | 330 |  | $corner\_ad\_target = (isset($\_POST['corner\_ad\_target']) && $\_POST['corner\_ad\_target'] == '\_blank') ? '\_blank' : '\_self'; |
  | 331 |  |  |
  | 332 |  | $corner\_ad\_desktop\_device = !empty($\_POST['corner\_ad\_desktop\_device']) ? 1 : 0; |
  | 333 |  | $corner\_ad\_mobile\_device = !empty($\_POST['corner\_ad\_mobile\_device']) ? 1 : 0; |
  | 334 |  |  |
  | 335 |  | if(count($error) == 0){ |
  | 336 |  | if(!empty($data)){ |
  | 337 |  | // Update |
  | 338 |  | $success = $wpdb->update( |
  | 339 |  | $wpdb->prefix.CORNER\_AD\_TABLE, |
  | 340 |  | array( |
  | 341 |  | 'name'    => $corner\_ad\_name, |
  | 342 |  | 'alignTo' => 'tl', |
  | 343 |  | 'mirror'  => $corner\_ad\_mirror, |
  | 344 |  | 'colorIn' => $corner\_ad\_colorIn, |
  | 345 |  | 'openIn'  => $corner\_ad\_openIn, |
  | 346 |  | 'closeIn' => $corner\_ad\_closeIn, |
  | 347 |  | 'adURL'   => $corner\_ad\_adURL, |
  | 348 |  | 'target'  => $corner\_ad\_target, |
  | 349 |  | 'desktop'   => $corner\_ad\_desktop\_device, |
  | 350 |  | 'mobile'    => $corner\_ad\_mobile\_device, |
  | 351 |  | 'fromDate'  => $corner\_ad\_from, |
  | 352 |  | 'toDate'    => $corner\_ad\_to, |
  | 353 |  | 'extra'     => json\_encode($corner\_ad\_extra) |
  | 354 |  | ), |
  | 355 |  | array( |
  | 356 |  | 'id'      => $id |
  | 357 |  | ), |
  | 358 |  | array('%s', '%s', '%d', '%s', '%d', '%d', '%s', '%s', '%d', '%d', '%s', '%s', '%s'), |
  | 359 |  | array('%d') |
  | 360 |  | ); |
  | 361 |  | // Remove associate images |
  | 362 |  | $wpdb->query($wpdb->prepare("DELETE FROM ".$wpdb->prefix.CORNER\_AD\_IMG\_TABLE." WHERE ad=%d", $id)); |
  | 363 |  |  |
  | 364 |  | if(!empty($corner\_ad\_imgPath)) |
  | 365 |  | $wpdb->insert( |
  | 366 |  | $wpdb->prefix.CORNER\_AD\_IMG\_TABLE, |
  | 367 |  | array( |
  | 368 |  | 'ad'      => $id, |
  | 369 |  | 'imgPath' => $corner\_ad\_imgPath, |
  | 370 |  | 'thumbPath' => $corner\_ad\_thumbPath |
  | 371 |  | ), |
  | 372 |  | array( '%d', '%s', '%s' ) |
  | 373 |  | ); |
  | 374 |  |  |
  | 375 |  | }elseif($wpdb->get\_var("SELECT COUNT(id) FROM ".$wpdb->prefix.CORNER\_AD\_TABLE) == 0){ |
  | 376 |  |  |
  | 377 |  | // Insert |
  | 378 |  | $success = $wpdb->insert( |
  | 379 |  | $wpdb->prefix.CORNER\_AD\_TABLE, |
  | 380 |  | array( |
  | 381 |  | 'name'    => $corner\_ad\_name, |
  | 382 |  | 'alignTo' => 'tl', |
  | 383 |  | 'mirror'  => $corner\_ad\_mirror, |
  | 384 |  | 'colorIn' => $corner\_ad\_colorIn, |
  | 385 |  | 'openIn'  => $corner\_ad\_openIn, |
  | 386 |  | 'closeIn' => $corner\_ad\_closeIn, |
  | 387 |  | 'adURL'   => $corner\_ad\_adURL, |
  | 388 |  | 'target'  => $corner\_ad\_target, |
  | 389 |  | 'desktop'   => $corner\_ad\_desktop\_device, |
  | 390 |  | 'mobile'    => $corner\_ad\_mobile\_device, |
  | 391 |  | 'fromDate'  => $corner\_ad\_from, |
  | 392 |  | 'toDate'    => $corner\_ad\_to, |
  | 393 |  | 'extra'     => json\_encode($corner\_ad\_extra) |
  | 394 |  | ), |
  | 395 |  | array('%s', '%s', '%d', '%s', '%d', '%d', '%s', '%s', '%d', '%d', '%s', '%s', '%s') |
  | 396 |  | ); |
  | 397 |  |  |
  | 398 |  | $id = $wpdb->insert\_id; |
  | 399 |  |  |
  | 400 |  | if(!empty($corner\_ad\_imgPath)) |
  | 401 |  | $wpdb->insert( |
  | 402 |  | $wpdb->prefix.CORNER\_AD\_IMG\_TABLE, |
  | 403 |  | array( |
  | 404 |  | 'ad'      => $id, |
  | 405 |  | 'imgPath' => $corner\_ad\_imgPath, |
  | 406 |  | 'thumbPath' => $corner\_ad\_thumbPath |
  | 407 |  | ), |
  | 408 |  | array( '%d', '%s', '%s' ) |
  | 409 |  | ); |
  | 410 |  | } |
  | 411 |  |  |
  | 412 |  | $output .= '<div class="notice notice-success"><div style="padding:20px;">'. |
  | 413 |  | \_\_('The corner Ad has been stored successfully', CORNER\_AD\_TD).'<br>'. |
  | 414 |  | \_\_('To use it insert the shortcode into the page/post content', CORNER\_AD\_TD).': <b>[corner-ad id="'.$id.'"]</b><br>'. |
  | 415 |  | \_\_('To inser the ads shortcode directly into the template files of the active theme, use the piece of code', CORNER\_AD\_TD).': <b>&lt;?php print do\_shortcode(\'[corner-ad id="'.$id.'"]\'); ?&gt;</b></div></div>'; |
  | 416 |  | } |
  | 417 |  | } |
  | 418 |  |  |
  | 419 |  |  |
  | 420 |  | $title = (isset($\_REQUEST['id'])) ? \_\_('Edit the Corner Ad', CORNER\_AD\_TD) : \_\_('Create a new Corner Ad', CORNER\_AD\_TD); |
  | 421 |  | if(count($error)){ |
  | 422 |  | $output .= '<div class="error settings-error">'.implode('<br />', $error).'</div>'; |
  | 423 |  | } |
  | 424 |  |  |
  | 425 |  | $output .=  ' |
  |  | 319 | } else { |
  |  | 320 | $error[] = esc\_html\_\_( 'The Ad image is required', 'corner-ad' ); |
  |  | 321 | } |
  |  | 322 |  |
  |  | 323 | if ( ! empty( $\_POST['corner\_ad\_adURL'] ) ) { |
  |  | 324 | $corner\_ad\_adURL = sanitize\_text\_field( wp\_unslash( $\_POST['corner\_ad\_adURL'] ) ); |
  |  | 325 | } else { |
  |  | 326 | $error[] = esc\_html\_\_( 'The Ad link is required', 'corner-ad' ); |
  |  | 327 | } |
  |  | 328 | $corner\_ad\_target = ( isset( $\_POST['corner\_ad\_target'] ) && '\_blank' == $\_POST['corner\_ad\_target'] ) ? '\_blank' : '\_self'; |
  |  | 329 |  |
  |  | 330 | $corner\_ad\_desktop\_device = ! empty( $\_POST['corner\_ad\_desktop\_device'] ) ? 1 : 0; |
  |  | 331 | $corner\_ad\_mobile\_device  = ! empty( $\_POST['corner\_ad\_mobile\_device'] ) ? 1 : 0; |
  |  | 332 |  |
  |  | 333 | if ( count( $error ) == 0 ) { |
  |  | 334 | if ( ! empty( $data ) ) { |
  |  | 335 | // Update |
  |  | 336 | $success = $wpdb->update( |
  |  | 337 | $wpdb->prefix . CORNER\_AD\_TABLE, |
  |  | 338 | array( |
  |  | 339 | 'name'     => $corner\_ad\_name, |
  |  | 340 | 'alignTo'  => 'tl', |
  |  | 341 | 'mirror'   => $corner\_ad\_mirror, |
  |  | 342 | 'colorIn'  => $corner\_ad\_colorIn, |
  |  | 343 | 'openIn'   => $corner\_ad\_openIn, |
  |  | 344 | 'closeIn'  => $corner\_ad\_closeIn, |
  |  | 345 | 'adURL'    => $corner\_ad\_adURL, |
  |  | 346 | 'target'   => $corner\_ad\_target, |
  |  | 347 | 'desktop'  => $corner\_ad\_desktop\_device, |
  |  | 348 | 'mobile'   => $corner\_ad\_mobile\_device, |
  |  | 349 | 'fromDate' => $corner\_ad\_from, |
  |  | 350 | 'toDate'   => $corner\_ad\_to, |
  |  | 351 | 'extra'    => json\_encode( $corner\_ad\_extra ), |
  |  | 352 | ), |
  |  | 353 | array( |
  |  | 354 | 'id' => $id, |
  |  | 355 | ), |
  |  | 356 | array( '%s', '%s', '%d', '%s', '%d', '%d', '%s', '%s', '%d', '%d', '%s', '%s', '%s' ), |
  |  | 357 | array( '%d' ) |
  |  | 358 | ); |
  |  | 359 | // Remove associate images |
  |  | 360 | $wpdb->query( $wpdb->prepare( 'DELETE FROM ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . ' WHERE ad=%d', $id ) ); |
  |  | 361 |  |
  |  | 362 | if ( ! empty( $corner\_ad\_imgPath ) ) { |
  |  | 363 | $wpdb->insert( |
  |  | 364 | $wpdb->prefix . CORNER\_AD\_IMG\_TABLE, |
  |  | 365 | array( |
  |  | 366 | 'ad'        => $id, |
  |  | 367 | 'imgPath'   => $corner\_ad\_imgPath, |
  |  | 368 | 'thumbPath' => $corner\_ad\_thumbPath, |
  |  | 369 | ), |
  |  | 370 | array( '%d', '%s', '%s' ) |
  |  | 371 | ); |
  |  | 372 | } |
  |  | 373 | } elseif ( $wpdb->get\_var( 'SELECT COUNT(id) FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE ) == 0 ) { |
  |  | 374 |  |
  |  | 375 | // Insert |
  |  | 376 | $success = $wpdb->insert( |
  |  | 377 | $wpdb->prefix . CORNER\_AD\_TABLE, |
  |  | 378 | array( |
  |  | 379 | 'name'     => $corner\_ad\_name, |
  |  | 380 | 'alignTo'  => 'tl', |
  |  | 381 | 'mirror'   => $corner\_ad\_mirror, |
  |  | 382 | 'colorIn'  => $corner\_ad\_colorIn, |
  |  | 383 | 'openIn'   => $corner\_ad\_openIn, |
  |  | 384 | 'closeIn'  => $corner\_ad\_closeIn, |
  |  | 385 | 'adURL'    => $corner\_ad\_adURL, |
  |  | 386 | 'target'   => $corner\_ad\_target, |
  |  | 387 | 'desktop'  => $corner\_ad\_desktop\_device, |
  |  | 388 | 'mobile'   => $corner\_ad\_mobile\_device, |
  |  | 389 | 'fromDate' => $corner\_ad\_from, |
  |  | 390 | 'toDate'   => $corner\_ad\_to, |
  |  | 391 | 'extra'    => json\_encode( $corner\_ad\_extra ), |
  |  | 392 | ), |
  |  | 393 | array( '%s', '%s', '%d', '%s', '%d', '%d', '%s', '%s', '%d', '%d', '%s', '%s', '%s' ) |
  |  | 394 | ); |
  |  | 395 |  |
  |  | 396 | $id = $wpdb->insert\_id; |
  |  | 397 |  |
  |  | 398 | if ( ! empty( $corner\_ad\_imgPath ) ) { |
  |  | 399 | $wpdb->insert( |
  |  | 400 | $wpdb->prefix . CORNER\_AD\_IMG\_TABLE, |
  |  | 401 | array( |
  |  | 402 | 'ad'        => $id, |
  |  | 403 | 'imgPath'   => $corner\_ad\_imgPath, |
  |  | 404 | 'thumbPath' => $corner\_ad\_thumbPath, |
  |  | 405 | ), |
  |  | 406 | array( '%d', '%s', '%s' ) |
  |  | 407 | ); |
  |  | 408 | } |
  |  | 409 | } |
  |  | 410 |  |
  |  | 411 | $output .= '<div class="notice notice-success"><div style="padding:20px;">' . |
  |  | 412 | \_\_( 'The corner Ad has been stored successfully', 'corner-ad' ) . '<br>' . |
  |  | 413 | \_\_( 'To use it insert the shortcode into the page/post content', 'corner-ad' ) . ': <b>[corner-ad id="' . $id . '"]</b><br>' . |
  |  | 414 | \_\_( 'To inser the ads shortcode directly into the template files of the active theme, use the piece of code', 'corner-ad' ) . ': <b>&lt;?php print do\_shortcode(\'[corner-ad id="' . $id . '"]\'); ?&gt;</b></div></div>'; |
  |  | 415 | } |
  |  | 416 | } |
  |  | 417 |  |
  |  | 418 | $title = ( isset( $\_REQUEST['id'] ) ) ? \_\_( 'Edit the Corner Ad', 'corner-ad' ) : \_\_( 'Create a new Corner Ad', 'corner-ad' ); |
  |  | 419 | if ( count( $error ) ) { |
  |  | 420 | $output .= '<div class="error settings-error">' . implode( '<br />', $error ) . '</div>'; |
  |  | 421 | } |
  |  | 422 |  |
  |  | 423 | $output .= ' |
  | 426 | 424 | <form action="options-general.php?page=corner-ad.php" method="post"> |
  | 427 |  | <input type="hidden" name="corner\_ad\_edition\_nonce" value="' . wp\_create\_nonce(~~\_\_FILE\_\_~~) . '" /> |
  |  | 425 | <input type="hidden" name="corner\_ad\_edition\_nonce" value="' . wp\_create\_nonce( \_\_FILE\_\_ ) . '" /> |
  | 428 | 426 | <input type="hidden" name="action" value="ad\_save" /> |
  | 429 |  | '~~.((!empty($id)) ? '<input type="hidden" name="id" value="'.esc\_attr($id).'">': '').~~' |
  |  | 427 | ' . ( ( ! empty( $id ) ) ? '<input type="hidden" name="id" value="' . esc\_attr( $id ) . '">' : '' ) . ' |
  | 430 | 428 | <div class="postbox"> |
  | 431 |  | <h2 class="handle" style="padding:5px;"><span>'~~.$title.~~'</span></h2> |
  |  | 429 | <h2 class="handle" style="padding:5px;"><span>' . $title . '</span></h2> |
  | 432 | 430 | <div class="inside"> |
  | 433 | 431 | <table class="form-table"> |
  | 434 | 432 | <tr valign="top"> |
  | 435 |  | <th>'~~.\_\_('Ad name', CORNER\_AD\_TD).~~'\*</th> |
  | 436 |  | <td> |
  | 437 |  | <input aria-label="'~~.esc\_attr(\_\_('Ad name', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_name" size="40" value="'.((isset($corner\_ad\_name)) ? esc\_attr($corner\_ad\_name) : '').~~'" /> |
  |  | 433 | <th>' . esc\_html\_\_( 'Ad name', 'corner-ad' ) . '\*</th> |
  |  | 434 | <td> |
  |  | 435 | <input aria-label="' . esc\_attr\_\_( 'Ad name', 'corner-ad' ) . '" type="text" name="corner\_ad\_name" size="40" value="' . ( ( isset( $corner\_ad\_name ) ) ? esc\_attr( $corner\_ad\_name ) : '' ) . '" /> |
  | 438 | 436 | </td> |
  | 439 | 437 | </tr> |
  | 440 | 438 | <tr valign="top"> |
  | 441 |  | <th>'~~.\_\_('Enter Ad link', CORNER\_AD\_TD).~~'\*</th> |
  | 442 |  | <td> |
  | 443 |  | <input aria-label="'~~.esc\_attr(\_\_('Ad link', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_adURL" size="40" value="'.((isset($corner\_ad\_adURL)) ? esc\_attr($corner\_ad\_adURL) : '').~~'" /> |
  | 444 |  | </td> |
  | 445 |  | </tr> |
  | 446 |  | <tr valign="top"> |
  | 447 |  | <th>'~~.\_\_('Open Ad in', CORNER\_AD\_TD).~~'</th> |
  | 448 |  | <td> |
  | 449 |  | <select aria-label="'~~.esc\_attr(\_\_('Open in self or blank', CORNER\_AD\_TD)).~~'" name="corner\_ad\_target"> |
  | 450 |  | <option value="\_blank" '~~.((isset($corner\_ad\_target) && $corner\_ad\_target == '\_blank') ? 'SELECTED' : '').'>'.\_\_('New page', CORNER\_AD\_TD).~~'</option> |
  | 451 |  | <option value="\_self" '~~.((isset($corner\_ad\_target) && $corner\_ad\_target == '\_self') ? 'SELECTED' : '').'>'.\_\_('Self page', CORNER\_AD\_TD).~~'</option> |
  |  | 439 | <th>' . esc\_html\_\_( 'Enter Ad link', 'corner-ad' ) . '\*</th> |
  |  | 440 | <td> |
  |  | 441 | <input aria-label="' . esc\_attr\_\_( 'Ad link', 'corner-ad' ) . '" type="text" name="corner\_ad\_adURL" size="40" value="' . ( ( isset( $corner\_ad\_adURL ) ) ? esc\_attr( $corner\_ad\_adURL ) : '' ) . '" /> |
  |  | 442 | </td> |
  |  | 443 | </tr> |
  |  | 444 | <tr valign="top"> |
  |  | 445 | <th>' . esc\_html\_\_( 'Open Ad in', 'corner-ad' ) . '</th> |
  |  | 446 | <td> |
  |  | 447 | <select aria-label="' . esc\_attr\_\_( 'Open in self or blank', 'corner-ad' ) . '" name="corner\_ad\_target"> |
  |  | 448 | <option value="\_blank" ' . ( ( isset( $corner\_ad\_target ) && '\_blank' == $corner\_ad\_target ) ? 'SELECTED' : '' ) . '>' . esc\_html\_\_( 'New page', 'corner-ad' ) . '</option> |
  |  | 449 | <option value="\_self" ' . ( ( isset( $corner\_ad\_target ) && '\_self' == $corner\_ad\_target ) ? 'SELECTED' : '' ) . '>' . esc\_html\_\_( 'Self page', 'corner-ad' ) . '</option> |
  | 452 | 450 | </select> |
  | 453 | 451 | </td> |
  | 454 | 452 | </tr> |
  | 455 | 453 | <tr valign="top"> |
  | 456 |  | <th>'~~.\_\_('Select Ad image', CORNER\_AD\_TD).~~'\*</th> |
  | 457 |  | <td><i>\*'~~.\_\_('It is recommended the use of square images greater than 400x400 pixels', CORNER\_AD\_TD).~~'</i>'; |
  | 458 |  |  |
  | 459 |  | $hasThumb = (~~!empty( $corner\_ad\_thumbPath ) && $corner\_ad\_thumbPath != $corner\_ad\_imgPath~~) ? true : false; |
  | 460 |  |  |
  | 461 |  | $output .= '                 <div> |
  | 462 |  | <input aria-label="'~~.esc\_attr(\_\_('Ad image', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_imgPath" size="40" value="'.((!empty($corner\_ad\_imgPath)) ? esc\_attr($corner\_ad\_imgPath) : '').'" /> <input type="button" class="corner\_ad\_button\_for\_upload button" value="'.esc\_attr(\_\_('Browse', CORNER\_AD\_TD)).~~'" /> <input type="button" class="corner\_ad\_button\_for\_add\_img\_field button" value="Add another one" /> <input type="button" class="corner\_ad\_button\_for\_rmv\_img\_field button" value="Remove the image" DISABLED /><br /> |
  | 463 |  | <input aria-label="'~~.esc\_attr(\_\_('Thumbnail image', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_thumbPath" size="40" value="'.($hasThumb ? esc\_attr($corner\_ad\_thumbPath) : '' ).'" placeholder="'.esc\_attr(\_\_( 'Thumbnail URL', CORNER\_AD\_TD)).'" '.(!$hasThumb ? 'style="display:none;"' : '' ).' /> <input type="button" class="corner\_ad\_button\_for\_upload button" value="'.esc\_attr(\_\_('Browse', CORNER\_AD\_TD)).'" '.(!$hasThumb ? 'style="display:none;"' : '' ).' /> <input type="checkbox" name="corner\_ad\_generateThum" '.(!$hasThumb ? 'CHECKED' : '' ).' class="corner\_ad\_thumb\_chk" />'.\_\_('Get the thumbnail of the Ad\'s image', CORNER\_AD\_TD).~~' |
  |  | 454 | <th>' . esc\_html\_\_( 'Select Ad image', 'corner-ad' ) . '\*</th> |
  |  | 455 | <td><i>\*' . esc\_html\_\_( 'It is recommended the use of square images greater than 400x400 pixels', 'corner-ad' ) . '</i>'; |
  |  | 456 |  |
  |  | 457 | $hasThumb = ( ! empty( $corner\_ad\_thumbPath ) && $corner\_ad\_thumbPath != $corner\_ad\_imgPath ) ? true : false; |
  |  | 458 |  |
  |  | 459 | $output .= '                 <div> |
  |  | 460 | <input aria-label="' . esc\_attr\_\_( 'Ad image', 'corner-ad' ) . '" type="text" name="corner\_ad\_imgPath" size="40" value="' . ( ( ! empty( $corner\_ad\_imgPath ) ) ? esc\_attr( $corner\_ad\_imgPath ) : '' ) . '" /> <input type="button" class="corner\_ad\_button\_for\_upload button" value="' . esc\_attr\_\_( 'Browse', 'corner-ad' ) . '" /> <input type="button" class="corner\_ad\_button\_for\_add\_img\_field button" value="Add another one" /> <input type="button" class="corner\_ad\_button\_for\_rmv\_img\_field button" value="Remove the image" DISABLED /><br /> |
  |  | 461 | <input aria-label="' . esc\_attr\_\_( 'Thumbnail image', 'corner-ad' ) . '" type="text" name="corner\_ad\_thumbPath" size="40" value="' . ( $hasThumb ? esc\_attr( $corner\_ad\_thumbPath ) : '' ) . '" placeholder="' . esc\_attr\_\_( 'Thumbnail URL', 'corner-ad' ) . '" ' . ( ! $hasThumb ? 'style="display:none;"' : '' ) . ' /> <input type="button" class="corner\_ad\_button\_for\_upload button" value="' . esc\_attr\_\_( 'Browse', 'corner-ad' ) . '" ' . ( ! $hasThumb ? 'style="display:none;"' : '' ) . ' /> <input type="checkbox" name="corner\_ad\_generateThum" ' . ( ! $hasThumb ? 'CHECKED' : '' ) . ' class="corner\_ad\_thumb\_chk" />' . esc\_html\_\_( 'Get the thumbnail of the Ad\'s image', 'corner-ad' ) . ' |
  | 464 | 462 | </div> |
  | 465 | 463 | <tr valign="top"> |
  | 466 |  | <th>'~~.\_\_('Select an audio file to play in background', CORNER\_AD\_TD).~~'</th> |
  | 467 |  | <td> |
  | 468 |  | <input aria-label="'~~.esc\_attr(\_\_('Ad audio', CORNER\_AD\_TD)).'" type="text" size="40" DISABLED /> <input type="button" value="'.esc\_attr(\_\_('Browse', CORNER\_AD\_TD)).~~'" DISABLED /> |
  |  | 464 | <th>' . esc\_html\_\_( 'Select an audio file to play in background', 'corner-ad' ) . '</th> |
  |  | 465 | <td> |
  |  | 466 | <input aria-label="' . esc\_attr\_\_( 'Ad audio', 'corner-ad' ) . '" type="text" size="40" DISABLED /> <input type="button" value="' . esc\_attr\_\_( 'Browse', 'corner-ad' ) . '" DISABLED /> |
  | 469 | 467 | The <a href="https://wordpress.dwbooster.com/content-tools/corner-ad" target="\_blank">commercial version</a> of plugin allows to select an audio file to play in background. |
  | 470 | 468 | </td> |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L472) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L470) |  |
  | 472 | 470 | '; |
  | 473 | 471 |  |
  | 474 |  | $corner\_ad\_from = (~~empty($corner\_ad\_from) || $corner\_ad\_from == '0000-00-00'~~) ? '' : $corner\_ad\_from; |
  | 475 |  | $corner\_ad\_to ~~= (empty($corner\_ad\_to) || $corner\_ad\_to == '0000-00-00'~~) ? '' : $corner\_ad\_to; |
  | 476 |  |  |
  | 477 |  | ~~$output .=~~  '              </td> |
  | 478 |  | </tr> |
  | 479 |  | <tr valign="top"> |
  | 480 |  | <th>'~~.\_\_('Set as mirror', CORNER\_AD\_TD).~~'</th> |
  | 481 |  | <td> |
  | 482 |  | <input aria-label="'~~.esc\_attr(\_\_('Set as mirror', CORNER\_AD\_TD)).'" type="checkbox" name="corner\_ad\_mirror" '.((!isset($corner\_ad\_mirror) || $corner\_ad\_mirror) ? 'checked' : '').~~' />                                  </td> |
  | 483 |  | </tr> |
  | 484 |  | <tr valign="top"> |
  | 485 |  | <th>'~~.\_\_('Use corner with color', CORNER\_AD\_TD).~~'</th> |
  | 486 |  | <td> |
  | 487 |  | <input aria-label="'~~.esc\_attr(\_\_('Color code', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_colorIn" id="corner\_ad\_colorIn" value="'.((isset($corner\_ad\_colorIn)) ? esc\_attr($corner\_ad\_colorIn) : '#FFFFFF').'" style="background-color:'.((isset($corner\_ad\_colorIn)) ? esc\_attr($corner\_ad\_colorIn) : '#FFFFFF').~~';" /> |
  |  | 472 | $corner\_ad\_from = ( empty( $corner\_ad\_from ) || '0000-00-00' == $corner\_ad\_from ) ? '' : $corner\_ad\_from; |
  |  | 473 | $corner\_ad\_to   = ( empty( $corner\_ad\_to ) || '0000-00-00' == $corner\_ad\_to ) ? '' : $corner\_ad\_to; |
  |  | 474 |  |
  |  | 475 | $output .= '              </td> |
  |  | 476 | </tr> |
  |  | 477 | <tr valign="top"> |
  |  | 478 | <th>' . esc\_html\_\_( 'Set as mirror', 'corner-ad' ) . '</th> |
  |  | 479 | <td> |
  |  | 480 | <input aria-label="' . esc\_attr\_\_( 'Set as mirror', 'corner-ad' ) . '" type="checkbox" name="corner\_ad\_mirror" ' . ( ( ! isset( $corner\_ad\_mirror ) || $corner\_ad\_mirror ) ? 'checked' : '' ) . ' />                                    </td> |
  |  | 481 | </tr> |
  |  | 482 | <tr valign="top"> |
  |  | 483 | <th>' . esc\_html\_\_( 'Use corner with color', 'corner-ad' ) . '</th> |
  |  | 484 | <td> |
  |  | 485 | <input aria-label="' . esc\_attr\_\_( 'Color code', 'corner-ad' ) . '" type="text" name="corner\_ad\_colorIn" id="corner\_ad\_colorIn" value="' . ( ( isset( $corner\_ad\_colorIn ) ) ? esc\_attr( $corner\_ad\_colorIn ) : '#FFFFFF' ) . '" style="background-color:' . ( ( isset( $corner\_ad\_colorIn ) ) ? esc\_attr( $corner\_ad\_colorIn ) : '#FFFFFF' ) . ';" /> |
  | 488 | 486 | <div id="corner\_ad\_colorIn\_picker"></div> |
  | 489 | 487 | </td> |
  | 490 | 488 | </tr> |
  | 491 | 489 | <tr valign="top"> |
  | 492 |  | <th>'~~.\_\_('Display Ad in corner', CORNER\_AD\_TD).~~'</th> |
  | 493 |  | <td> |
  | 494 |  | <select aria-label="'~~.esc\_attr(\_\_('Align to corner', CORNER\_AD\_TD)).~~'" name="corner\_ad\_alignTo" DISABLED> |
  | 495 |  | <option value="tl">'~~.\_\_('Top-Left', CORNER\_AD\_TD).~~'</option> |
  |  | 490 | <th>' . esc\_html\_\_( 'Display Ad in corner', 'corner-ad' ) . '</th> |
  |  | 491 | <td> |
  |  | 492 | <select aria-label="' . esc\_attr\_\_( 'Align to corner', 'corner-ad' ) . '" name="corner\_ad\_alignTo" DISABLED> |
  |  | 493 | <option value="tl">' . esc\_html\_\_( 'Top-Left', 'corner-ad' ) . '</option> |
  | 496 | 494 | </select> |
  | 497 | 495 | The free version of plugin allows to display the Ad only in the Left-Top corner only. The <a href="https://wordpress.dwbooster.com/content-tools/corner-ad" target="\_blank">commercial version</a> allows to select between the Left or Right top corner. |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L499) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L497) |  |
  | 499 | 497 | </tr> |
  | 500 | 498 | <tr valign="top"> |
  | 501 |  | <th>'~~.\_\_('Load Ad on device', CORNER\_AD\_TD).~~'</th> |
  | 502 |  | <td> |
  | 503 |  | <input type="checkbox" name="corner\_ad\_desktop\_device" '~~.(!isset($corner\_ad\_desktop\_device) || !empty($corner\_ad\_desktop\_device) ? 'CHECKED' : '').' />'.\_\_('Desktop', CORNER\_AD\_TD).~~' |
  |  | 499 | <th>' . esc\_html\_\_( 'Load Ad on device', 'corner-ad' ) . '</th> |
  |  | 500 | <td> |
  |  | 501 | <input type="checkbox" name="corner\_ad\_desktop\_device" ' . ( ! isset( $corner\_ad\_desktop\_device ) || ! empty( $corner\_ad\_desktop\_device ) ? 'CHECKED' : '' ) . ' />' . esc\_html\_\_( 'Desktop', 'corner-ad' ) . ' |
  | 504 | 502 | <br> |
  | 505 |  | <input type="checkbox" name="corner\_ad\_mobile\_device" '~~.(!isset($corner\_ad\_mobile\_device) || !empty($corner\_ad\_mobile\_device) ? 'CHECKED' : '').' />'.\_\_('Mobile', CORNER\_AD\_TD).~~' |
  | 506 |  | </td> |
  | 507 |  | </tr> |
  | 508 |  | <tr valign="top"> |
  | 509 |  | <th>'~~.\_\_('Open corner in', CORNER\_AD\_TD).~~'</th> |
  | 510 |  | <td><input aria-label="'~~.esc\_attr(\_\_('Time in seconds', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_openIn" value="'.((isset($corner\_ad\_openIn) && $corner\_ad\_openIn >0) ? esc\_attr($corner\_ad\_openIn) : '' ).'">'.\_\_('Seconds', CORNER\_AD\_TD).~~' |
  | 511 |  | </td> |
  | 512 |  | </tr> |
  | 513 |  | <tr valign="top"> |
  | 514 |  | <th>'~~.\_\_('Close corner in', CORNER\_AD\_TD).~~'</th> |
  | 515 |  | <td><input aria-label="'~~.esc\_attr(\_\_('Time in seconds', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_closeIn" value="'.((isset($corner\_ad\_closeIn) && $corner\_ad\_closeIn > 0) ? esc\_attr($corner\_ad\_closeIn) : '' ).'">'.\_\_('Seconds', CORNER\_AD\_TD).~~' |
  |  | 503 | <input type="checkbox" name="corner\_ad\_mobile\_device" ' . ( ! isset( $corner\_ad\_mobile\_device ) || ! empty( $corner\_ad\_mobile\_device ) ? 'CHECKED' : '' ) . ' />' . esc\_html\_\_( 'Mobile', 'corner-ad' ) . ' |
  |  | 504 | </td> |
  |  | 505 | </tr> |
  |  | 506 | <tr valign="top"> |
  |  | 507 | <th>' . esc\_html\_\_( 'Open corner in', 'corner-ad' ) . '</th> |
  |  | 508 | <td><input aria-label="' . esc\_attr\_\_( 'Time in seconds', 'corner-ad' ) . '" type="text" name="corner\_ad\_openIn" value="' . ( ( isset( $corner\_ad\_openIn ) && $corner\_ad\_openIn > 0 ) ? esc\_attr( $corner\_ad\_openIn ) : '' ) . '">' . esc\_html\_\_( 'Seconds', 'corner-ad' ) . ' |
  |  | 509 | </td> |
  |  | 510 | </tr> |
  |  | 511 | <tr valign="top"> |
  |  | 512 | <th>' . esc\_html\_\_( 'Close corner in', 'corner-ad' ) . '</th> |
  |  | 513 | <td><input aria-label="' . esc\_attr\_\_( 'Time in seconds', 'corner-ad' ) . '" type="text" name="corner\_ad\_closeIn" value="' . ( ( isset( $corner\_ad\_closeIn ) && $corner\_ad\_closeIn > 0 ) ? esc\_attr( $corner\_ad\_closeIn ) : '' ) . '">' . esc\_html\_\_( 'Seconds', 'corner-ad' ) . ' |
  | 516 | 514 | </td> |
  | 517 | 515 | </tr> |
  | 518 | 516 | <tr> |
  | 519 | 517 | <th colspan="2"> |
  | 520 |  | '~~.\_\_('Schedule', CORNER\_AD\_TD).~~' |
  |  | 518 | ' . esc\_html\_\_( 'Schedule', 'corner-ad' ) . ' |
  | 521 | 519 | <hr /> |
  | 522 |  | <div style="font-weight:normal;font-style:italic;">('~~.\_\_('The from and to attributes are optional, fill them only if you want to restrict the ad by date',CORNER\_AD\_TD).~~')</div> |
  |  | 520 | <div style="font-weight:normal;font-style:italic;">(' . esc\_html\_\_( 'The from and to attributes are optional, fill them only if you want to restrict the ad by date', 'corner-ad' ) . ')</div> |
  | 523 | 521 | </th> |
  | 524 | 522 | </tr> |
  | 525 | 523 | <tr valign="top"> |
  | 526 |  | <th>'~~.\_\_('From', CORNER\_AD\_TD).~~' |
  |  | 524 | <th>' . esc\_html\_\_( 'From', 'corner-ad' ) . ' |
  | 527 | 525 | </th> |
  | 528 |  | <td><input aria-label="'~~.esc\_attr(\_\_('From date', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_from" value="'.((!empty($corner\_ad\_from)) ? esc\_attr($corner\_ad\_from) : '' ).'" pattern="([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))" title="'.esc\_attr\_\_('Enter a valid date with the format: yyyy-mm-dd', CORNER\_AD\_TD).~~'"> |
  | 529 |  | </td> |
  | 530 |  | </tr> |
  | 531 |  | <tr valign="top"> |
  | 532 |  | <th>'~~.\_\_('To', CORNER\_AD\_TD).~~'</th> |
  | 533 |  | <td><input aria-label="'~~.esc\_attr(\_\_('To date', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_to" value="'.((!empty($corner\_ad\_to)) ? esc\_attr($corner\_ad\_to) : '' ).'" pattern="([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))" title="'.esc\_attr\_\_('Enter a valid date with the format: yyyy-mm-dd', CORNER\_AD\_TD).~~'"> |
  |  | 526 | <td><input aria-label="' . esc\_attr\_\_( 'From date', 'corner-ad' ) . '" type="text" name="corner\_ad\_from" value="' . ( ( ! empty( $corner\_ad\_from ) ) ? esc\_attr( $corner\_ad\_from ) : '' ) . '" pattern="([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))" title="' . esc\_attr\_\_( 'Enter a valid date with the format: yyyy-mm-dd', 'corner-ad' ) . '"> |
  |  | 527 | </td> |
  |  | 528 | </tr> |
  |  | 529 | <tr valign="top"> |
  |  | 530 | <th>' . esc\_html\_\_( 'To', 'corner-ad' ) . '</th> |
  |  | 531 | <td><input aria-label="' . esc\_attr\_\_( 'To date', 'corner-ad' ) . '" type="text" name="corner\_ad\_to" value="' . ( ( ! empty( $corner\_ad\_to ) ) ? esc\_attr( $corner\_ad\_to ) : '' ) . '" pattern="([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))" title="' . esc\_attr\_\_( 'Enter a valid date with the format: yyyy-mm-dd', 'corner-ad' ) . '"> |
  | 534 | 532 | </td> |
  | 535 | 533 | </tr> |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L538) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L536) |  |
  | 538 | 536 | </div>'; |
  | 539 | 537 |  |
  | 540 |  | // Google Analytics |
  | 541 |  | ~~$output .=~~  ' |
  |  | 538 | // Google Analytics |
  |  | 539 | $output .= ' |
  | 542 | 540 | <div class="postbox"> |
  | 543 |  | <h2 class="handle" style="padding:5px;"><span>'~~.\_\_('Google Analytics Integration', CORNER\_AD\_TD).~~'</span></h2> |
  |  | 541 | <h2 class="handle" style="padding:5px;"><span>' . esc\_html\_\_( 'Google Analytics Integration', 'corner-ad' ) . '</span></h2> |
  | 544 | 542 | <div class="inside"> |
  | 545 |  | <p>'~~.\_\_('Are you interested in how to add custom event tracking to your ads with Google Analytics? You can set up custom categories, labels, and actions for your ads clicks with Google Analytics. If Google Analytics Tracking Id was not entered, this section takes no action.', CORNER\_AD\_TD).~~'</p> |
  |  | 543 | <p>' . esc\_html\_\_( 'Are you interested in how to add custom event tracking to your ads with Google Analytics? You can set up custom categories, labels, and actions for your ads clicks with Google Analytics. If Google Analytics Tracking Id was not entered, this section takes no action.', 'corner-ad' ) . '</p> |
  | 546 | 544 | <table class="form-table"> |
  | 547 | 545 | <tr valign="top"> |
  | 548 |  | <th>'~~.\_\_('Google Analytics - event category', CORNER\_AD\_TD).~~'</th> |
  | 549 |  | <td> |
  | 550 |  | <input aria-label="'~~.esc\_attr(\_\_('category', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_ga\_category" size="40" value="'.esc\_attr(!empty($corner\_ad\_extra['ga\_category']) ? $corner\_ad\_extra['ga\_category'] : '').~~'" /> |
  |  | 546 | <th>' . esc\_html\_\_( 'Google Analytics - event category', 'corner-ad' ) . '</th> |
  |  | 547 | <td> |
  |  | 548 | <input aria-label="' . esc\_attr\_\_( 'category', 'corner-ad' ) . '" type="text" name="corner\_ad\_ga\_category" size="40" value="' . esc\_attr( ! empty( $corner\_ad\_extra['ga\_category'] ) ? $corner\_ad\_extra['ga\_category'] : '' ) . '" /> |
  | 551 | 549 | </td> |
  | 552 | 550 | </tr> |
  | 553 | 551 | <tr valign="top"> |
  | 554 |  | <th>'~~.\_\_('Google Analytics - event action', CORNER\_AD\_TD).~~'</th> |
  | 555 |  | <td> |
  | 556 |  | <input aria-label="'~~.esc\_attr(\_\_('action', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_ga\_action" size="40" value="'.esc\_attr(!empty($corner\_ad\_extra['ga\_action']) ? $corner\_ad\_extra['ga\_action'] : '').~~'" /> |
  |  | 552 | <th>' . esc\_html\_\_( 'Google Analytics - event action', 'corner-ad' ) . '</th> |
  |  | 553 | <td> |
  |  | 554 | <input aria-label="' . esc\_attr\_\_( 'action', 'corner-ad' ) . '" type="text" name="corner\_ad\_ga\_action" size="40" value="' . esc\_attr( ! empty( $corner\_ad\_extra['ga\_action'] ) ? $corner\_ad\_extra['ga\_action'] : '' ) . '" /> |
  | 557 | 555 | </td> |
  | 558 | 556 | </tr> |
  | 559 | 557 | <tr valign="top"> |
  | 560 |  | <th>'~~.\_\_('Google Analytics - event label', CORNER\_AD\_TD).~~'</th> |
  | 561 |  | <td> |
  | 562 |  | <input aria-label="'~~.esc\_attr(\_\_('label', CORNER\_AD\_TD)).'" type="text" name="corner\_ad\_ga\_label" size="40" value="'.esc\_attr(!empty($corner\_ad\_extra['ga\_label']) ? $corner\_ad\_extra['ga\_label'] : '').~~'" /> |
  |  | 558 | <th>' . esc\_html\_\_( 'Google Analytics - event label', 'corner-ad' ) . '</th> |
  |  | 559 | <td> |
  |  | 560 | <input aria-label="' . esc\_attr\_\_( 'label', 'corner-ad' ) . '" type="text" name="corner\_ad\_ga\_label" size="40" value="' . esc\_attr( ! empty( $corner\_ad\_extra['ga\_label'] ) ? $corner\_ad\_extra['ga\_label'] : '' ) . '" /> |
  | 563 | 561 | </td> |
  | 564 | 562 | </tr> |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L567) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L565) |  |
  | 567 | 565 | </div>'; |
  | 568 | 566 |  |
  | 569 |  | ~~$output .=~~  ' |
  | 570 |  | <div style="text-align:center"><input type="submit" value="'~~.esc\_attr(\_\_('Save Corner Ad', CORNER\_AD\_TD)).'" class="button-primary" /> <a href="options-general.php?page=corner-ad.php" class="button-secondary">'.\_\_('Back to the list', CORNER\_AD\_TD).~~'</a></div> |
  |  | 567 | $output .= ' |
  |  | 568 | <div style="text-align:center"><input type="submit" value="' . esc\_attr\_\_( 'Save Corner Ad', 'corner-ad' ) . '" class="button-primary" /> <a href="options-general.php?page=corner-ad.php" class="button-secondary">' . esc\_html\_\_( 'Back to the list', 'corner-ad' ) . '</a></div> |
  | 571 | 569 | </form> |
  | 572 | 570 | <script> |
  | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2675644#L578) | […](/browser/corner-ad/trunk/includes/admin_functions.php?rev=2765630#L576) |  |
  | 578 | 576 | </script> |
  | 579 | 577 | '; |
  | 580 |  | return $output; |
  | 581 |  | } // End corner\_ad\_settings\_page\_form |
  |  | 578 | return $output; |
  |  | 579 | } // End corner\_ad\_settings\_page\_form |
  | 582 | 580 | } |
  | 583 | 581 |  |
  | 584 |  | if (!function\_exists('corner\_ad\_get\_images')){ |
  | 585 |  | function corner\_ad\_process\_images( &$obj, $size = 'large' ) |
  | 586 |  | { |
  | 587 |  | global $wpdb; |
  | 588 |  | if(preg\_match('/attachment\_id=(\d+)/', $obj->url, $matches)) $obj->id = $matches[1]; |
  | 589 |  | else{ |
  | 590 |  | $id = $wpdb->get\_var($wpdb->prepare("SELECT id FROM ".$wpdb->prefix."posts WHERE guid='%s'", $obj->url)); |
  | 591 |  | if($id) $obj->id = $id; |
  | 592 |  | } |
  | 593 |  |  |
  | 594 |  | if( !empty( $obj->id ) ) |
  | 595 |  | { |
  | 596 |  | $resized = wp\_get\_attachment\_image\_src( $obj->id, $size ); |
  |  | 582 | if ( ! function\_exists( 'corner\_ad\_get\_images' ) ) { |
  |  | 583 | function corner\_ad\_process\_images( &$obj, $size = 'large' ) { |
  |  | 584 | global $wpdb; |
  |  | 585 | if ( preg\_match( '/attachment\_id=(\d+)/', $obj->url, $matches ) ) { |
  |  | 586 | $obj->id = $matches[1]; |
  |  | 587 | } else { |
  |  | 588 | $id = $wpdb->get\_var( $wpdb->prepare( 'SELECT id FROM ' . $wpdb->prefix . 'posts WHERE guid=%s', $obj->url ) ); |
  |  | 589 | if ( $id ) { |
  |  | 590 | $obj->id = $id; |
  |  | 591 | } |
  |  | 592 | } |
  |  | 593 |  |
  |  | 594 | if ( ! empty( $obj->id ) ) { |
  |  | 595 | $resized  = wp\_get\_attachment\_image\_src( $obj->id, $size ); |
  | 597 | 596 | $obj->url = $resized[0]; |
  | 598 | 597 | } |
  | 599 | 598 | } // End corner\_ad\_process\_images |
  | 600 | 599 |  |
  | 601 |  | ~~function corner\_ad\_get\_images($url, $thumbUrl, $to\_show = false )~~{ |
  | 602 |  | ~~$img = new stdClass~~; |
  | 603 |  | ~~$img->thumb = new stdClass~~; |
  | 604 |  | $img->large ~~= new stdClass~~; |
  | 605 |  | ~~$img->thumb->url = ( !empty($thumbUrl~~) ) ? $thumbUrl : $url; |
  | 606 |  | $img->large->url = $url; |
  |  | 600 | function corner\_ad\_get\_images( $url, $thumbUrl, $to\_show = false ) { |
  |  | 601 | $img             = new stdClass(); |
  |  | 602 | $img->thumb      = new stdClass(); |
  |  | 603 | $img->large      = new stdClass(); |
  |  | 604 | $img->thumb->url = ( ! empty( $thumbUrl ) ) ? $thumbUrl : $url; |
  |  | 605 | $img->large->url = $url; |
  | 607 | 606 | corner\_ad\_process\_images( $img->thumb, $to\_show ? 'corner\_ad\_thumb' : 'large' ); |
  | 608 | 607 | corner\_ad\_process\_images( $img->large, $to\_show ? 'corner\_ad' : 'large' ); |
  | 609 | 608 | return $img; |
  | 610 |  | } // End corner\_ad\_get\_images |
  |  | 609 | } // End corner\_ad\_get\_images |
  | 611 | 610 | } |
  | 612 |  | ~~?>~~ |
* ## [corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php](/changeset/2765630/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?old=2160390&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Fbeaverbuilder%2Fcornerad.inc.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2160390#L1 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2765630#L1 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  | require\_once dirname(~~\_\_FILE\_\_).~~'/cornerad/cornerad.php'; |
  |  | 2 | require\_once dirname( \_\_FILE\_\_ ) . '/cornerad/cornerad.php'; |
  | 3 | 3 |  |
  | 4 | 4 | // Get the forms list |
  | […](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2160390#L7) | […](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2765630#L7) |  |
  | 7 | 7 | $default = ''; |
  | 8 | 8 |  |
  | 9 |  | $rows = $wpdb->get\_results( "SELECT \* FROM ".$wpdb->prefix.CORNER\_AD\_TABLE ); |
  | 10 |  | foreach ($rows as $item) |
  | 11 |  | { |
  | 12 |  | $options[$item->id] = $item->name; |
  | 13 |  | if(empty($default)) $default = $item->id; |
  |  | 9 | $rows = $wpdb->get\_results( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE ); |
  |  | 10 | foreach ( $rows as $item ) { |
  |  | 11 | $options[ $item->id ] = $item->name; |
  |  | 12 | if ( empty( $default ) ) { |
  |  | 13 | $default = $item->id; |
  |  | 14 | } |
  | 14 | 15 | } |
  | 15 | 16 |  |
  | […](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2160390#L18) | […](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad.inc.php?rev=2765630#L19) |  |
  | 18 | 19 | array( |
  | 19 | 20 | 'cornerad-tab' => array( |
  | 20 |  | 'title'~~=> \_\_('Select the Ad to insert', CORNER\_AD\_TD~~), |
  |  | 21 | 'title'    => \_\_( 'Select the Ad to insert', 'corner-ad' ), |
  | 21 | 22 | 'sections' => array( |
  | 22 | 23 | 'cornerad-section' => array( |
  | 23 |  | 'title' ~~=> \_\_('Corner Ad', CORNER\_AD\_TD~~), |
  | 24 |  | 'fields'=> array( |
  | 25 |  | 'ad' => array( |
  | 26 |  | 'type' => 'select', |
  | 27 |  | 'label' ~~=> \_\_('Select Ad', CORNER\_AD\_TD~~), |
  | 28 |  | 'options' => $options, |
  | 29 |  | 'default' => $default, |
  |  | 24 | 'title'  => \_\_( 'Corner Ad', 'corner-ad' ), |
  |  | 25 | 'fields' => array( |
  |  | 26 | 'ad'           => array( |
  |  | 27 | 'type'    => 'select', |
  |  | 28 | 'label'   => \_\_( 'Select Ad', 'corner-ad' ), |
  |  | 29 | 'options' => $options, |
  |  | 30 | 'default' => $default, |
  | 30 | 31 | ), |
  | 31 | 32 | 'ad\_container' => array( |
  | 32 |  | 'type' => 'text', |
  | 33 |  | 'label' ~~=> \_\_('Ad container', CORNER\_AD\_TD~~), |
  | 34 |  | 'default' => 'body', |
  | 35 |  | 'description'~~=> \_\_('The Ad container affects only to the commercial version of the plugin', CORNER\_AD\_TD)~~ |
  |  | 33 | 'type'        => 'text', |
  |  | 34 | 'label'       => \_\_( 'Ad container', 'corner-ad' ), |
  |  | 35 | 'default'     => 'body', |
  |  | 36 | 'description' => \_\_( 'The Ad container affects only to the commercial version of the plugin', 'corner-ad' ), |
  | 36 | 37 | ), |
  | 37 |  | ) |
  | 38 |  | ) |
  | 39 |  | ) |
  | 40 |  | ) |
  |  | 38 | ), |
  |  | 39 | ), |
  |  | 40 | ), |
  |  | 41 | ), |
  | 41 | 42 | ) |
  | 42 | 43 | ); |
* ## [corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/cornerad.php](/changeset/2765630/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/cornerad.php?old=2160390&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Fbeaverbuilder%2Fcornerad%2Fcornerad.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/cornerad.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/cornerad.php?rev=2160390#L1 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/cornerad.php?rev=2765630#L1 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class CornerAdBeaver extends FLBuilderModule { |
  | 3 |  | public function \_\_construct() |
  | 4 |  | { |
  | 5 |  | $modules\_dir = dirname(\_\_FILE\_\_).'/'; |
  | 6 |  | $modules\_url = plugins\_url( '/', \_\_FILE\_\_ ).'/'; |
  |  | 3 | public function \_\_construct() { |
  |  | 4 | $modules\_dir = dirname( \_\_FILE\_\_ ) . '/'; |
  |  | 5 | $modules\_url  = plugins\_url( '/', \_\_FILE\_\_ ) . '/'; |
  | 7 | 6 |  |
  | 8 |  | parent::\_\_construct(array( |
  | 9 |  | 'name'            => \_\_( 'Corner Ad', CORNER\_AD\_TD ), |
  | 10 |  | 'description'     => \_\_( 'Inserts an Ad', CORNER\_AD\_TD ), |
  | 11 |  | 'group'           => \_\_( 'Corner Ad', CORNER\_AD\_TD ), |
  | 12 |  | 'category'        => \_\_( 'Corner Ad', CORNER\_AD\_TD ), |
  | 13 |  | 'dir'             => $modules\_dir, |
  | 14 |  | 'url'             => $modules\_url, |
  | 15 |  | 'partial\_refresh' => true |
  | 16 |  | )); |
  | 17 |  | } |
  |  | 7 | parent::\_\_construct( |
  |  | 8 | array( |
  |  | 9 | 'name'            => \_\_( 'Corner Ad', 'corner-ad' ), |
  |  | 10 | 'description'     => \_\_( 'Inserts an Ad', 'corner-ad' ), |
  |  | 11 | 'group'           => \_\_( 'Corner Ad', 'corner-ad' ), |
  |  | 12 | 'category'        => \_\_( 'Corner Ad', 'corner-ad' ), |
  |  | 13 | 'dir'             => $modules\_dir, |
  |  | 14 | 'url'             => $modules\_url, |
  |  | 15 | 'partial\_refresh' => true, |
  |  | 16 | ) |
  |  | 17 | ); |
  |  | 18 | } |
  | 18 | 19 | } |
* ## [corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/includes/frontend.php](/changeset/2765630/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/includes/frontend.php?old=2160390&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Fbeaverbuilder%2Fcornerad%2Fincludes%2Ffrontend.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/includes/frontend.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/includes/frontend.php?rev=2160390#L1 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/beaverbuilder/cornerad/includes/frontend.php?rev=2765630#L1 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  | $ad = @intval($settings->ad); |
  | 3 |  | if(!empty($ad)) |
  | 4 |  | { |
  | 5 |  | $output = '[corner-ad id="'.$ad.'"'; |
  |  | 2 | $ad = @intval( $settings->ad ); |
  |  | 3 | if ( ! empty( $ad ) ) { |
  |  | 4 | $output = '[corner-ad id="' . esc\_attr( $ad ) . '"'; |
  | 6 | 5 |  |
  | 7 |  | $container = sanitize\_text\_field($settings->ad\_container); |
  | 8 |  | if(!empty($container)) $output .= ' container="'.esc\_attr($container).'"'; |
  |  | 6 | $container = sanitize\_text\_field( $settings->ad\_container ); |
  |  | 7 | if ( ! empty( $container ) ) { |
  |  | 8 | $output .= ' container="' . esc\_attr( $container ) . '"'; |
  |  | 9 | } |
  | 9 | 10 |  |
  | 10 | 11 | $output .= ']'; |
* ## [corner-ad/trunk/pagebuilders/builders.php](/changeset/2765630/corner-ad/trunk/pagebuilders/builders.php?old=2160390&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Fbuilders.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/builders.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/builders.php?rev=2160390#L2 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/builders.php?rev=2765630#L2 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | /\*\* |
  | 3 | 3 | \* Main class to interace with the different Content Editors: CPCA\_BUILDERS class |
  | 4 |  | ~~\*~~ |
  | 5 | 4 | \*/ |
  | 6 |  | if(!class\_exists('CPCA\_BUILDERS')) |
  | 7 |  | { |
  | 8 |  | class CPCA\_BUILDERS |
  | 9 |  | { |
  |  | 5 | if ( ! class\_exists( 'CPCA\_BUILDERS' ) ) { |
  |  | 6 | class CPCA\_BUILDERS { |
  |  | 7 |  |
  | 10 | 8 | private static $\_instance; |
  | 11 | 9 |  |
  | 12 | 10 | private function \_\_construct(){} |
  | 13 |  | private static function instance() |
  | 14 |  | { |
  | 15 |  | if(!isset(self::$\_instance)) self::$\_instance = new self(); |
  |  | 11 | private static function instance() { |
  |  | 12 | if ( ! isset( self::$\_instance ) ) { |
  |  | 13 | self::$\_instance = new self(); |
  |  | 14 | } |
  | 16 | 15 | return self::$\_instance; |
  | 17 | 16 | } // End instance |
  | 18 | 17 |  |
  | 19 |  | public static function run() |
  | 20 |  | { |
  |  | 18 | public static function run() { |
  | 21 | 19 | $instance = self::instance(); |
  | 22 |  | add\_action(~~'init', array($instance, 'init')~~); |
  | 23 |  | add\_action(~~'after\_setup\_theme', array($instance, 'after\_setup\_theme')~~); |
  |  | 20 | add\_action( 'init', array( $instance, 'init' ) ); |
  |  | 21 | add\_action( 'after\_setup\_theme', array( $instance, 'after\_setup\_theme' ) ); |
  | 24 | 22 | } |
  | 25 | 23 |  |
  | 26 |  | public function init() |
  | 27 |  | { |
  |  | 24 | public function init() { |
  | 28 | 25 | $instance = self::instance(); |
  | 29 | 26 |  |
  | 30 | 27 | // Gutenberg |
  | 31 |  | add\_action( 'enqueue\_block\_editor\_assets', array(~~$instance,~~'gutenberg\_editor' ) ); |
  |  | 28 | add\_action( 'enqueue\_block\_editor\_assets', array( $instance, 'gutenberg\_editor' ) ); |
  | 32 | 29 |  |
  | 33 | 30 | // Elementor |
  | 34 |  | add\_action( 'elementor/widgets/widgets\_registered', array(~~$instance, 'elementor\_editor'~~) ); |
  | 35 |  | add\_action( 'elementor/elements/categories\_registered', array(~~$instance, 'elementor\_editor\_category'~~) ); |
  |  | 31 | add\_action( 'elementor/widgets/widgets\_registered', array( $instance, 'elementor\_editor' ) ); |
  |  | 32 | add\_action( 'elementor/elements/categories\_registered', array( $instance, 'elementor\_editor\_category' ) ); |
  | 36 | 33 |  |
  | 37 | 34 | // Beaver builder |
  | 38 |  | if(class\_exists('FLBuilder')) |
  | 39 |  | { |
  | 40 |  | include\_once dirname(\_\_FILE\_\_).'/beaverbuilder/cornerad.inc.php'; |
  |  | 35 | if ( class\_exists( 'FLBuilder' ) ) { |
  |  | 36 | include\_once dirname( \_\_FILE\_\_ ) . '/beaverbuilder/cornerad.inc.php'; |
  | 41 | 37 | } |
  | 42 | 38 | } // End init |
  | 43 | 39 |  |
  | 44 |  | public function after\_setup\_theme() |
  | 45 |  | { |
  | 46 |  | $instance = $instance = self::instance(); |
  |  | 40 | public function after\_setup\_theme() { |
  |  | 41 | $instance = self::instance(); |
  | 47 | 42 |  |
  | 48 | 43 | // SiteOrigin |
  | 49 |  | add\_filter(~~'siteorigin\_widgets\_widget\_folders', array($instance, 'siteorigin\_widgets\_collection')~~); |
  | 50 |  | add\_filter(~~'siteorigin\_panels\_widget\_dialog\_tabs', array($instance, 'siteorigin\_panels\_widget\_dialog\_tabs')~~); |
  |  | 44 | add\_filter( 'siteorigin\_widgets\_widget\_folders', array( $instance, 'siteorigin\_widgets\_collection' ) ); |
  |  | 45 | add\_filter( 'siteorigin\_panels\_widget\_dialog\_tabs', array( $instance, 'siteorigin\_panels\_widget\_dialog\_tabs' ) ); |
  | 51 | 46 | } // End after\_setup\_theme |
  | 52 | 47 |  |
  | […](/browser/corner-ad/trunk/pagebuilders/builders.php?rev=2160390#L56) | […](/browser/corner-ad/trunk/pagebuilders/builders.php?rev=2765630#L51) |  |
  | 56 | 51 | \* Loads the javascript resources to integrate the plugin with the Gutenberg editor |
  | 57 | 52 | \*/ |
  | 58 |  | public function gutenberg\_editor() |
  | 59 |  | { |
  |  | 53 | public function gutenberg\_editor() { |
  | 60 | 54 | global $wpdb; |
  | 61 | 55 |  |
  | 62 |  | $ads ~~= $wpdb->get\_results("SELECT id, name FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." ORDER BY name ASC;"~~); |
  |  | 56 | $ads  = $wpdb->get\_results( 'SELECT id, name FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' ORDER BY name ASC;' ); |
  | 63 | 57 | $list = ''; |
  | 64 |  | if~~($ads)~~{ |
  | 65 |  | foreach~~($ads as $ad)~~{ |
  | 66 |  | $list .= '<option value="'~~.esc\_attr($ad->id).'">'.esc\_html($ad->name).~~'</option>'; |
  |  | 58 | if ( $ads ) { |
  |  | 59 | foreach ( $ads as $ad ) { |
  |  | 60 | $list .= '<option value="' . esc\_attr( $ad->id ) . '">' . esc\_html( $ad->name ) . '</option>'; |
  | 67 | 61 | } |
  | 68 | 62 | } |
  | 69 | 63 |  |
  | 70 |  | wp\_enqueue\_script(~~'corner-ad-gutenberg-editor', plugin\_dir\_url(\_\_FILE\_\_).'gutenberg/ca-gutenberg.js'~~); |
  | 71 |  | wp\_localize\_script(~~'corner-ad-gutenberg-editor', 'corner\_ad', array('list' => $list)~~); |
  |  | 64 | wp\_enqueue\_script( 'corner-ad-gutenberg-editor', plugin\_dir\_url( \_\_FILE\_\_ ) . 'gutenberg/ca-gutenberg.js', array(), CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 65 | wp\_localize\_script( 'corner-ad-gutenberg-editor', 'corner\_ad', array( 'list' => $list ) ); |
  | 72 | 66 | } // End gutenberg\_editor |
  | 73 | 67 |  |
  | 74 | 68 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* ELEMENTOR \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
  | 75 | 69 |  |
  | 76 |  | public function elementor\_editor\_category() |
  | 77 |  | { |
  | 78 |  | require\_once dirname(\_\_FILE\_\_).'/elementor/elementor\_category.pb.php'; |
  |  | 70 | public function elementor\_editor\_category() { |
  |  | 71 | require\_once dirname( \_\_FILE\_\_ ) . '/elementor/elementor\_category.pb.php'; |
  | 79 | 72 | } // End elementor\_editor |
  | 80 | 73 |  |
  | 81 |  | public function elementor\_editor() |
  | 82 |  | { |
  | 83 |  | wp\_enqueue\_style('corner\_ad\_elementor', CORNER\_AD\_PLUGIN\_URL.'/pagebuilders/elementor/elementor.css'); |
  | 84 |  | require\_once dirname(\_\_FILE\_\_).'/elementor/elementor.pb.php'; |
  |  | 74 | public function elementor\_editor() { |
  |  | 75 | wp\_enqueue\_style( 'corner\_ad\_elementor', CORNER\_AD\_PLUGIN\_URL . '/pagebuilders/elementor/elementor.css', array(), CORNER\_AD\_PLUGIN\_VERSION ); |
  |  | 76 | require\_once dirname( \_\_FILE\_\_ ) . '/elementor/elementor.pb.php'; |
  | 85 | 77 | } // End elementor\_editor |
  | 86 | 78 |  |
  | 87 | 79 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* SITEORIGIN \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
  | 88 | 80 |  |
  | 89 |  | public function siteorigin\_widgets\_collection($folders) |
  | 90 |  | { |
  | 91 |  | $folders[] = dirname(\_\_FILE\_\_).'/siteorigin/'; |
  |  | 81 | public function siteorigin\_widgets\_collection( $folders ) { |
  |  | 82 | $folders[] = dirname( \_\_FILE\_\_ ) . '/siteorigin/'; |
  | 92 | 83 | return $folders; |
  | 93 | 84 | } // End siteorigin\_widgets\_collection |
  | 94 | 85 |  |
  | 95 |  | public function siteorigin\_panels\_widget\_dialog\_tabs($tabs) |
  | 96 |  | { |
  | 97 |  | $tabs[] = array( |
  | 98 |  | 'title' => \_\_('Corner Ad', CORNER\_AD\_TD), |
  | 99 |  | 'filter' => array( |
  | 100 |  | 'groups' => array('cp-corner-ad') |
  | 101 |  | ) |
  | 102 |  | ); |
  |  | 86 | public function siteorigin\_panels\_widget\_dialog\_tabs( $tabs ) { |
  |  | 87 | $tabs[] = array( |
  |  | 88 | 'title'  => \_\_( 'Corner Ad', 'corner-ad' ), |
  |  | 89 | 'filter' => array( |
  |  | 90 | 'groups' => array( 'cp-corner-ad' ), |
  |  | 91 | ), |
  |  | 92 | ); |
  | 103 | 93 |  |
  | 104 |  | return $tabs; |
  |  | 94 | return $tabs; |
  | 105 | 95 | } // End siteorigin\_panels\_widget\_dialog\_tabs |
  | 106 | 96 | } // End CPCA\_BUILDERS |
* ## [corner-ad/trunk/pagebuilders/elementor/elementor.pb.php](/changeset/2765630/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?old=2698581&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Felementor%2Felementor.pb.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/elementor/elementor.pb.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L6 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L6 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | } |
  | 7 | 7 |  |
  | 8 |  | class Elementor\_CPCornerAd\_Widget extends Widget\_Base |
  | 9 |  | { |
  | 10 |  | public function get\_name() |
  | 11 |  | { |
  |  | 8 | class Elementor\_CPCornerAd\_Widget extends Widget\_Base { |
  |  | 9 |  |
  |  | 10 | public function get\_name() { |
  | 12 | 11 | return 'corner-ad'; |
  | 13 | 12 | } // End get\_name |
  | 14 | 13 |  |
  | 15 |  | public function get\_title() |
  | 16 |  | { |
  |  | 14 | public function get\_title() { |
  | 17 | 15 | return 'Corner Ad'; |
  | 18 | 16 | } // End get\_title |
  | 19 | 17 |  |
  | 20 |  | public function get\_icon() |
  | 21 |  | { |
  |  | 18 | public function get\_icon() { |
  | 22 | 19 | return 'eicon-editor-external-link'; |
  | 23 | 20 | } // End get\_icon |
  | 24 | 21 |  |
  | 25 |  | public function get\_categories() |
  | 26 |  | { |
  |  | 22 | public function get\_categories() { |
  | 27 | 23 | return array( 'corner-ad-cat' ); |
  | 28 | 24 | } // End get\_categories |
  | 29 | 25 |  |
  | 30 |  | public function is\_reload\_preview\_required() |
  | 31 |  | { |
  |  | 26 | public function is\_reload\_preview\_required() { |
  | 32 | 27 | return false; |
  | 33 | 28 | } // End is\_reload\_preview\_required |
  | 34 | 29 |  |
  | 35 |  | protected function register\_controls() |
  | 36 |  | { |
  |  | 30 | protected function register\_controls() { |
  | 37 | 31 | global $wpdb; |
  | 38 | 32 |  |
  | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L40) | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L34) |  |
  | 40 | 34 | 'corner\_ad\_section', |
  | 41 | 35 | array( |
  | 42 |  | 'label' => \_\_( 'Corner Ad', ~~CORNER\_AD\_TD )~~ |
  |  | 36 | 'label' => \_\_( 'Corner Ad', 'corner-ad' ), |
  | 43 | 37 | ) |
  | 44 | 38 | ); |
  | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L47) | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L41) |  |
  | 47 | 41 | $default = ''; |
  | 48 | 42 |  |
  | 49 |  | $rows = $wpdb->get\_results("SELECT id, name FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." ORDER BY name ASC;"); |
  | 50 |  | foreach ($rows as $item) |
  | 51 |  | { |
  | 52 |  | $options[$item->id] = $item->name; |
  | 53 |  | if(empty($default)) $default = $item->id; |
  |  | 43 | $rows = $wpdb->get\_results( 'SELECT id, name FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' ORDER BY name ASC;' ); |
  |  | 44 | foreach ( $rows as $item ) { |
  |  | 45 | $options[ $item->id ] = $item->name; |
  |  | 46 | if ( empty( $default ) ) { |
  |  | 47 | $default = $item->id; |
  |  | 48 | } |
  | 54 | 49 | } |
  | 55 | 50 |  |
  | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L57) | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L52) |  |
  | 57 | 52 | 'ad', |
  | 58 | 53 | array( |
  | 59 |  | 'label' ~~=>  \_\_('Select an Ad', CORNER\_AD\_TABLE~~), |
  | 60 |  | 'type' => Controls\_Manager::SELECT, |
  |  | 54 | 'label'   => \_\_( 'Select an Ad', CORNER\_AD\_TABLE ), |
  |  | 55 | 'type'    => Controls\_Manager::SELECT, |
  | 61 | 56 | 'options' => $options, |
  | 62 |  | 'default' => $default |
  |  | 57 | 'default' => $default, |
  | 63 | 58 | ) |
  | 64 | 59 | ); |
  | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L67) | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L62) |  |
  | 67 | 62 | 'container', |
  | 68 | 63 | array( |
  | 69 |  | 'label' ~~=>  \_\_('Display the Ad relative to (Only available in the Professional version of the plugin)', CORNER\_AD\_TABLE~~), |
  | 70 |  | 'type' => Controls\_Manager::TEXT, |
  | 71 |  | 'input\_type' => 'text', |
  | 72 |  | 'classes' => 'ca-widefat', |
  | 73 |  | 'description'~~=> \_\_('(leave in blank to display the Ad relative to the webpage)', CORNER\_AD\_TABLE)~~ |
  |  | 64 | 'label'       => \_\_( 'Display the Ad relative to (Only available in the Professional version of the plugin)', CORNER\_AD\_TABLE ), |
  |  | 65 | 'type'        => Controls\_Manager::TEXT, |
  |  | 66 | 'input\_type'  => 'text', |
  |  | 67 | 'classes'     => 'ca-widefat', |
  |  | 68 | 'description' => \_\_( '(leave in blank to display the Ad relative to the webpage)', CORNER\_AD\_TABLE ), |
  | 74 | 69 | ) |
  | 75 | 70 | ); |
  | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L78) | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L73) |  |
  | 78 | 73 | } // End register\_controls |
  | 79 | 74 |  |
  | 80 |  | private function \_get\_shortcode() |
  | 81 |  | { |
  |  | 75 | private function \_get\_shortcode() { |
  | 82 | 76 | $settings = $this->get\_settings\_for\_display(); |
  | 83 |  | return '[corner-ad id="'~~.sanitize\_text\_field($settings['ad']).~~'"]'; |
  |  | 77 | return '[corner-ad id="' . esc\_attr( sanitize\_text\_field( wp\_unslash( $settings['ad'] ) ) ) . '"]'; |
  | 84 | 78 | } // End \_get\_shortcode |
  | 85 | 79 |  |
  | 86 |  | protected function render() |
  | 87 |  | { |
  |  | 80 | protected function render() { |
  | 88 | 81 | $shortcode = $this->\_get\_shortcode(); |
  | 89 |  | if( |
  | 90 |  | isset(~~$\_REQUEST['action']~~) && |
  |  | 82 | if ( |
  |  | 83 | isset( $\_REQUEST['action'] ) && |
  | 91 | 84 | ( |
  | 92 |  | ~~$\_REQUEST['action'] == 'elementor'~~ || |
  | 93 |  | ~~$\_REQUEST['action'] == 'elementor\_ajax'~~ |
  |  | 85 | 'elementor' == $\_REQUEST['action'] || |
  |  | 86 | 'elementor\_ajax' == $\_REQUEST['action'] |
  | 94 | 87 | ) |
  | 95 |  | ) |
  | 96 |  | { |
  |  | 88 | ) { |
  | 97 | 89 | print $shortcode; |
  | 98 |  | } |
  | 99 |  | else |
  | 100 |  | { |
  | 101 |  | print do\_shortcode(shortcode\_unautop($shortcode)); |
  |  | 90 | } else { |
  |  | 91 | print do\_shortcode( shortcode\_unautop( $shortcode ) ); |
  | 102 | 92 | } |
  | 103 | 93 |  |
  | 104 | 94 | } // End render |
  | 105 | 95 |  |
  | 106 |  | public function render\_plain\_content() |
  | 107 |  | { |
  |  | 96 | public function render\_plain\_content() { |
  | 108 | 97 | echo $this->\_get\_shortcode(); |
  | 109 | 98 | } // End render\_plain\_content |
  | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2698581#L112) | […](/browser/corner-ad/trunk/pagebuilders/elementor/elementor.pb.php?rev=2765630#L101) |  |
  | 112 | 101 |  |
  | 113 | 102 | // Register the widgets |
  | 114 |  | Plugin::instance()->widgets\_manager->register\_widget\_type( new Elementor\_CPCornerAd\_Widget ); |
  |  | 103 | Plugin::instance()->widgets\_manager->register\_widget\_type( new Elementor\_CPCornerAd\_Widget() ); |
* ## [corner-ad/trunk/pagebuilders/elementor/elementor\_category.pb.php](/changeset/2765630/corner-ad/trunk/pagebuilders/elementor/elementor_category.pb.php?old=2041689&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Felementor%2Felementor_category.pb.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/elementor/elementor_category.pb.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/elementor/elementor_category.pb.php?rev=2041689#L10 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/elementor/elementor_category.pb.php?rev=2765630#L10 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 10 | 10 | 'corner-ad-cat', |
  | 11 | 11 | array( |
  | 12 |  | 'title'~~=>~~'Corner Ad', |
  | 13 |  | 'icon' ~~=> 'fa fa-plug'~~ |
  |  | 12 | 'title' => 'Corner Ad', |
  |  | 13 | 'icon'  => 'fa fa-plug', |
  | 14 | 14 | ), |
  | 15 | 15 | 2 // position |
* ## [corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php](/changeset/2765630/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php?old=2675644&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Fsiteorigin%2Fsiteorigin-cpca%2Fsiteorigin-cpca.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php?rev=2675644#L6 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php?rev=2765630#L6 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | class SiteOrigin\_CPCA\_Shortcode extends SiteOrigin\_Widget |
  | 9 |  | { |
  | 10 |  | function \_\_construct() |
  | 11 |  | { |
  |  | 8 | class SiteOrigin\_CPCA\_Shortcode extends SiteOrigin\_Widget { |
  |  | 9 |  |
  |  | 10 | public function \_\_construct() { |
  | 12 | 11 | global $wpdb; |
  | 13 | 12 | $options = array(); |
  | 14 |  | $ads ~~= $wpdb->get\_results("SELECT id, name FROM ".$wpdb->prefix.CORNER\_AD\_TABLE." ORDER BY name ASC;"~~); |
  |  | 13 | $ads     = $wpdb->get\_results( 'SELECT id, name FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' ORDER BY name ASC;' ); |
  | 15 | 14 | $default = ''; |
  | 16 |  | if($ads) |
  | 17 |  | { |
  | 18 |  | foreach($ads as $ad) |
  | 19 |  | { |
  | 20 |  | $options[$ad->id] = esc\_html($ad->name); |
  | 21 |  | $default = $ad->id; |
  |  | 15 | if ( $ads ) { |
  |  | 16 | foreach ( $ads as $ad ) { |
  |  | 17 | $options[ $ad->id ] = esc\_html( $ad->name ); |
  |  | 18 | $default            = $ad->id; |
  | 22 | 19 | } |
  | 23 | 20 | } |
  | […](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php?rev=2675644#L25) | […](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/siteorigin-cpca.php?rev=2765630#L22) |  |
  | 25 | 22 | parent::\_\_construct( |
  | 26 | 23 | 'siteorigin-cpca-shortcode', |
  | 27 |  | \_\_(~~'Corner Ad', CORNER\_AD\_TD~~), |
  |  | 24 | \_\_( 'Corner Ad', 'corner-ad' ), |
  | 28 | 25 | array( |
  | 29 |  | 'description' ~~=> \_\_("Minimally invasive advertising display that uses any of your webpage's top corners", CORNER\_AD\_TD~~), |
  | 30 |  | 'panels\_groups' => array(~~'cp-corner-ad'~~), |
  | 31 |  | 'help'        => 'https://wordpress.dwbooster.com/content-tools/corner-ad', |
  |  | 26 | 'description'   => \_\_( "Minimally invasive advertising display that uses any of your webpage's top corners", 'corner-ad' ), |
  |  | 27 | 'panels\_groups' => array( 'cp-corner-ad' ), |
  |  | 28 | 'help'          => 'https://wordpress.dwbooster.com/content-tools/corner-ad', |
  | 32 | 29 | ), |
  | 33 | 30 | array(), |
  | 34 | 31 | array( |
  | 35 | 32 | 'ad' => array( |
  | 36 |  | 'type' => 'select', |
  | 37 |  | 'label'~~=> \_\_('Select the Ad', CORNER\_AD\_TD~~), |
  | 38 |  | 'options' => $options, |
  | 39 |  | 'default'~~=> $default~~ |
  |  | 33 | 'type'    => 'select', |
  |  | 34 | 'label'   => \_\_( 'Select the Ad', 'corner-ad' ), |
  |  | 35 | 'options' => $options, |
  |  | 36 | 'default' => $default, |
  | 40 | 37 | ), |
  | 41 | 38 | ), |
  | 42 |  | plugin\_dir\_path(~~\_\_FILE\_\_~~) |
  |  | 39 | plugin\_dir\_path( \_\_FILE\_\_ ) |
  | 43 | 40 | ); |
  | 44 | 41 | } // End \_\_construct |
  | 45 | 42 |  |
  | 46 |  | function get\_template\_name($instance) |
  | 47 |  | { |
  | 48 |  | return 'siteorigin-cpca-shortcode'; |
  | 49 |  | } // End get\_template\_name |
  |  | 43 | public function get\_template\_name( $instance ) { |
  |  | 44 | return 'siteorigin-cpca-shortcode'; |
  |  | 45 | } // End get\_template\_name |
  | 50 | 46 |  |
  | 51 |  | function get\_style\_name($instance) |
  | 52 |  | { |
  | 53 |  | return ''; |
  | 54 |  | } // End get\_style\_name |
  |  | 47 | public function get\_style\_name( $instance ) { |
  |  | 48 | return ''; |
  |  | 49 | } // End get\_style\_name |
  | 55 | 50 |  |
  | 56 | 51 | } // End Class SiteOrigin\_CPCA\_Shortcode |
  | 57 | 52 |  |
  | 58 | 53 | // Registering the widget |
  | 59 |  | siteorigin\_widget\_register(~~'siteorigin-cpca-shortcode', \_\_FILE\_\_, 'SiteOrigin\_CPCA\_Shortcode'~~); |
  |  | 54 | siteorigin\_widget\_register( 'siteorigin-cpca-shortcode', \_\_FILE\_\_, 'SiteOrigin\_CPCA\_Shortcode' ); |
* ## [corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php](/changeset/2765630/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php?old=2125437&old_path=corner-ad%2Ftrunk%2Fpagebuilders%2Fsiteorigin%2Fsiteorigin-cpca%2Ftpl%2Fsiteorigin-cpca-shortcode.php "Show the [2719671:2765630] differences restricted to corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php")

  | [r2719671](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php?rev=2125437#L1 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/pagebuilders/siteorigin/siteorigin-cpca/tpl/siteorigin-cpca-shortcode.php?rev=2765630#L1 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | <?php print !~~empty($instance['ad']) ? '[corner-ad id="'.sanitize\_text\_field($instance['ad']).~~'"]' : ''; |
  |  | 1 | <?php print ! empty( $instance['ad'] ) ? '[corner-ad id="' . sanitize\_text\_field( $instance['ad'] ) . '"]' : ''; |
* ## [corner-ad/trunk/readme.txt](/changeset/2765630/corner-ad/trunk/readme.txt?old=2719671&old_path=corner-ad%2Ftrunk%2Freadme.txt "Show the [2719671:2765630] differences restricted to corner-ad/trunk/readme.txt")

  | [r2719671](/browser/corner-ad/trunk/readme.txt?rev=2719671#L377 "Show revision 2719671 of this file in browser") | [r2765630](/browser/corner-ad/trunk/readme.txt?rev=2765630#L377 "Show revision 2765630 of this file in browser") |  |
  | --- | --- | --- |
  | 377 | 377 |  |
  | 378 | 378 | \* Modifies functions deprecated by the latest Elementor update. |
  |  | 379 |  |
  |  | 380 | = 1.0.54 = |
  |  | 381 |  |
  |  | 382 | \* Improves the plugin code and its security. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2765630&old=2719671&new_path=%2Fcorner-ad%2Ftrunk&old_path=%2Fcorner-ad%2Ftrunk)
* [Zip Archive](?format=zip&new=2765630&old=2719671&new_path=%2Fcorner-ad%2Ftrunk&old_path=%2Fcorner-ad%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_9fdaa0ca_20250114_181735.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcorner-ad%2Ftrunk%2Fcorner-ad.php%3Frev%3D2782613)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/corner-ad/trunk/corner-ad.php?rev=2776364 "Revision 2776364")
* [Latest Revision](/browser/corner-ad/trunk/corner-ad.php)
* [Next Revision](/browser/corner-ad/trunk/corner-ad.php?rev=2795204 "Revision 2795204") →
* [Blame](/browser/corner-ad/trunk/corner-ad.php?annotate=blame&rev=2782613 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/corner-ad/trunk/corner-ad.php?rev=2782613)

---

# [source:](/browser?rev=2782613&order=name "Go to repository root") [corner-ad](/browser/corner-ad?rev=2782613&order=name "View corner-ad")/[trunk](/browser/corner-ad/trunk?rev=2782613&order=name "View trunk")/[corner-ad.php](/browser/corner-ad/trunk/corner-ad.php?rev=2782613&order=name "View corner-ad.php") @ [2782613](/changeset/2782613/ "View changeset 2782613")

View diff against:

View revision:

| [Last change](/changeset/2782613/corner-ad/trunk/corner-ad.php "View differences") on this file since 2782613 was [2782613](/changeset/2782613/ "View changeset 2782613"), checked in by codepeople, [2 years ago](/timeline?from=2022-09-09T23%3A07%3A34Z&precision=second "See timeline at 09/09/2022 11:07:34 PM") |
| --- |
| New version 1.0.56 Modifications in the changelogs. |
| **File size:** 17.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: Corner Ad |
| [4](#L4) | Plugin URI: https://wordpress.dwbooster.com/content-tools/corner-ad |
| [5](#L5) | Description: Corner Ad is a minimally invasive advertising display that uses any of your webpage's top corners - a position typically under-utilized by developers - and attracts users' attention by a cool visual effect imitating a page flip |
| [6](#L6) | Version: 1.0.56 |
| [7](#L7) | Author: CodePeople |
| [8](#L8) | Author URI: https://wordpress.dwbooster.com/content-tools/corner-ad |
| [9](#L9) | Text Domain: corner-ad |
| [10](#L10) | License: GPLv2 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | require\_once 'banner.php'; |
| [14](#L14) | $codepeople\_promote\_banner\_plugins['codepeople-corner-ad'] = array( |
| [15](#L15) | 'plugin\_name' => 'Corner Ad', |
| [16](#L16) | 'plugin\_url'  => 'https://wordpress.org/support/plugin/corner-ad/reviews/#new-post', |
| [17](#L17) | ); |
| [18](#L18) |  |
| [19](#L19) | // CONST |
| [20](#L20) | define( 'CORNER\_AD\_PLUGIN\_VERSION', '1.0.56' ); |
| [21](#L21) | define( 'CORNER\_AD\_PLUGIN\_DIR', dirname( \_\_FILE\_\_ ) ); |
| [22](#L22) | define( 'CORNER\_AD\_PLUGIN\_URL', plugins\_url( '', \_\_FILE\_\_ ) ); |
| [23](#L23) | define( 'CORNER\_AD\_TD', 'corner-ad' ); |
| [24](#L24) | define( 'CORNER\_AD\_TABLE', 'corner\_ad' ); |
| [25](#L25) | define( 'CORNER\_AD\_IMG\_TABLE', 'corner\_ad\_img' ); |
| [26](#L26) |  |
| [27](#L27) | require CORNER\_AD\_PLUGIN\_DIR . '/includes/admin\_functions.php'; |
| [28](#L28) |  |
| [29](#L29) | // Loading the page builders connectors |
| [30](#L30) | require\_once CORNER\_AD\_PLUGIN\_DIR . '/pagebuilders/builders.php'; |
| [31](#L31) | CPCA\_BUILDERS::run(); |
| [32](#L32) |  |
| [33](#L33) | add\_filter( 'option\_sbp\_settings', 'corner\_ad\_troubleshoot' ); |
| [34](#L34) | if ( ! function\_exists( 'corner\_ad\_troubleshoot' ) ) { |
| [35](#L35) | function corner\_ad\_troubleshoot( $option ) { |
| [36](#L36) | if ( ! is\_admin() ) { |
| [37](#L37) | // Solves a conflict caused by the "Speed Booster Pack" plugin |
| [38](#L38) | if ( is\_array( $option ) && isset( $option['jquery\_to\_footer'] ) ) { |
| [39](#L39) | unset( $option['jquery\_to\_footer'] ); |
| [40](#L40) | } |
| [41](#L41) | } |
| [42](#L42) | return $option; |
| [43](#L43) | } // End corner\_ad\_troubleshoot |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Plugin activation |
| [48](#L48) | \*/ |
| [49](#L49) | register\_activation\_hook( \_\_FILE\_\_, 'corner\_ad\_install' ); |
| [50](#L50) | if ( ! function\_exists( 'corner\_ad\_install' ) ) { |
| [51](#L51) |  |
| [52](#L52) | function \_corner\_ad\_update\_db() { |
| [53](#L53) | if ( get\_option( 'CORNER\_AD\_PLUGIN\_VERSION' ) == CORNER\_AD\_PLUGIN\_VERSION ) { |
| [54](#L54) | return; |
| [55](#L55) | } |
| [56](#L56) | update\_option( 'CORNER\_AD\_PLUGIN\_VERSION', CORNER\_AD\_PLUGIN\_VERSION ); |
| [57](#L57) |  |
| [58](#L58) | global $wpdb; |
| [59](#L59) |  |
| [60](#L60) | $list    = array(); |
| [61](#L61) | $columns = $wpdb->get\_results( 'SHOW columns FROM `' . $wpdb->prefix . CORNER\_AD\_TABLE . '`' ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [62](#L62) | foreach ( $columns as $column ) { |
| [63](#L63) | $list[ $column->Field ] = $column->Field; |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | if ( empty( $list['desktop'] ) ) { |
| [67](#L67) | $wpdb->query( 'ALTER TABLE  `' . $wpdb->prefix . CORNER\_AD\_TABLE . '` ADD `desktop` TINYINT(1) NOT NULL DEFAULT 1;' ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | if ( empty( $list['mobile'] ) ) { |
| [71](#L71) | $wpdb->query( 'ALTER TABLE  `' . $wpdb->prefix . CORNER\_AD\_TABLE . '` ADD `mobile` TINYINT(1) NOT NULL DEFAULT 1;' ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) | } // End \_corner\_ad\_update\_db |
| [75](#L75) |  |
| [76](#L76) | function \_corner\_ad\_install() { |
| [77](#L77) |  |
| [78](#L78) | require\_once ABSPATH . 'wp-admin/includes/upgrade.php'; |
| [79](#L79) |  |
| [80](#L80) | global $wpdb; |
| [81](#L81) | $charset\_collate = $wpdb->get\_charset\_collate(); |
| [82](#L82) |  |
| [83](#L83) | $db\_queries = array(); |
| [84](#L84) | // Create related table |
| [85](#L85) | $db\_queries[] = 'CREATE TABLE ' . $wpdb->prefix . CORNER\_AD\_TABLE . " |
| [86](#L86) | (id MEDIUMINT(9) NOT NULL AUTO\_INCREMENT, |
| [87](#L87) | name VARCHAR(250) NOT NULL DEFAULT '', |
| [88](#L88) | alignTo CHAR(2) NOT NULL DEFAULT 'tr', |
| [89](#L89) | mirror TINYINT(1) NOT NULL DEFAULT 1, |
| [90](#L90) | colorIn VARCHAR(7) NOT NULL DEFAULT 'FFFFFF', |
| [91](#L91) | openIn INT NOT NULL DEFAULT 5, |
| [92](#L92) | closeIn INT NOT NULL DEFAULT 5, |
| [93](#L93) | adURL VARCHAR(250) NOT NULL DEFAULT '', |
| [94](#L94) | target VARCHAR(50) NOT NULL DEFAULT '\_blank', |
| [95](#L95) | stat INT NOT NULL DEFAULT 0, |
| [96](#L96) | desktop TINYINT(1) NOT NULL DEFAULT 1, |
| [97](#L97) | mobile TINYINT(1) NOT NULL DEFAULT 1, |
| [98](#L98) | fromDate DATE NULL, |
| [99](#L99) | toDate DATE NULL, |
| [100](#L100) | PRIMARY KEY id (id) |
| [101](#L101) | ) $charset\_collate;"; |
| [102](#L102) |  |
| [103](#L103) | // Create related table |
| [104](#L104) | $db\_queries[] = 'CREATE TABLE ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . " |
| [105](#L105) | (id MEDIUMINT(9) NOT NULL AUTO\_INCREMENT, |
| [106](#L106) | ad MEDIUMINT(9) NOT NULL, |
| [107](#L107) | imgPath VARCHAR(255) NOT NULL, |
| [108](#L108) | thumbPath VARCHAR(255) NULL, |
| [109](#L109) | PRIMARY KEY id (id) |
| [110](#L110) | ) $charset\_collate;"; |
| [111](#L111) |  |
| [112](#L112) | dbDelta( $db\_queries ); // Running the queries |
| [113](#L113) |  |
| [114](#L114) | // Set the image size required by the corner\_ad |
| [115](#L115) | // add\_image\_size( 'corner\_ad', 300, 300, true ); |
| [116](#L116) | } // End +corner\_ad\_install |
| [117](#L117) |  |
| [118](#L118) | function corner\_ad\_install( $network\_wide ) { |
| [119](#L119) | global $wpdb; |
| [120](#L120) | if ( function\_exists( 'is\_multisite' ) && is\_multisite() ) { |
| [121](#L121) | // check if it is a network activation - if so, run the activation function for each blog id |
| [122](#L122) | if ( $network\_wide ) { |
| [123](#L123) | $current\_blog = $wpdb->blogid; |
| [124](#L124) | // Get all blog ids |
| [125](#L125) | $blog\_ids = $wpdb->get\_col( "SELECT blog\_id FROM $wpdb->blogs" ); |
| [126](#L126) | foreach ( $blog\_ids as $blog\_id ) { |
| [127](#L127) | switch\_to\_blog( $blog\_id ); |
| [128](#L128) | \_corner\_ad\_install(); |
| [129](#L129) | } |
| [130](#L130) | switch\_to\_blog( $current\_blog ); |
| [131](#L131) | return; |
| [132](#L132) | } |
| [133](#L133) | } |
| [134](#L134) | \_corner\_ad\_install(); |
| [135](#L135) | } // End corner\_ad\_install |
| [136](#L136) | } // End plugin activation |
| [137](#L137) |  |
| [138](#L138) | // A new blog has been created in a multisite WordPress |
| [139](#L139) | add\_action( 'wpmu\_new\_blog', 'corner\_ad\_new\_blog', 10, 6 ); |
| [140](#L140) |  |
| [141](#L141) | function corner\_ad\_new\_blog( $blog\_id, $user\_id, $domain, $path, $site\_id, $meta ) { |
| [142](#L142) | global $wpdb; |
| [143](#L143) | if ( is\_plugin\_active\_for\_network() ) { |
| [144](#L144) | $current\_blog = $wpdb->blogid; |
| [145](#L145) | switch\_to\_blog( $blog\_id ); |
| [146](#L146) | \_corner\_ad\_install(); |
| [147](#L147) | switch\_to\_blog( $current\_blog ); |
| [148](#L148) | } |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | // Redirecting the user to the settings page of the plugin |
| [152](#L152) | add\_action( 'activated\_plugin', 'corner\_ad\_redirect\_to\_settings', 10, 2 ); |
| [153](#L153) | if ( ! function\_exists( 'corner\_ad\_redirect\_to\_settings' ) ) { |
| [154](#L154) | function corner\_ad\_redirect\_to\_settings( $plugin, $network\_activation ) { |
| [155](#L155) | global $wpdb; |
| [156](#L156) | if ( |
| [157](#L157) | plugin\_basename( \_\_FILE\_\_ ) == $plugin && |
| [158](#L158) | ( ! isset( $\_POST['action'] ) || 'activate-selected' != $\_POST['action'] ) && // phpcs:ignore WordPress.Security.NonceVerification |
| [159](#L159) | ( ! isset( $\_POST['action2'] ) || 'activate-selected' != $\_POST['action2'] ) // phpcs:ignore WordPress.Security.NonceVerification |
| [160](#L160) | ) { |
| [161](#L161) | // If there is an add inserted go to the settings page of the plugin |
| [162](#L162) | if ( $wpdb->get\_var( 'SELECT COUNT(id) FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE ) ) { // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [163](#L163) | wp\_redirect( esc\_url( admin\_url( 'options-general.php?page=corner-ad.php' ) ) ); |
| [164](#L164) | exit; |
| [165](#L165) | } else { |
| [166](#L166) | // or go directly to create an ad |
| [167](#L167) | wp\_redirect( admin\_url( 'options-general.php?page=corner-ad.php&action=ad\_create' ) ); |
| [168](#L168) | exit; |
| [169](#L169) | } |
| [170](#L170) | } |
| [171](#L171) | } |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | // Feedback system |
| [175](#L175) | require\_once 'feedback/cp-feedback.php'; |
| [176](#L176) | new CP\_FEEDBACK( plugin\_basename( dirname( \_\_FILE\_\_ ) ), \_\_FILE\_\_, 'https://wordpress.dwbooster.com/contact-us' ); |
| [177](#L177) |  |
| [178](#L178) | /\* |
| [179](#L179) | \*   Plugin initializing |
| [180](#L180) | \*/ |
| [181](#L181) | add\_action( 'init', 'corner\_ad\_init' ); |
| [182](#L182) | if ( ! function\_exists( 'corner\_ad\_init' ) ) { |
| [183](#L183) | function corner\_ad\_init() { |
| [184](#L184) |  |
| [185](#L185) | \_corner\_ad\_update\_db(); |
| [186](#L186) |  |
| [187](#L187) | // Set the add shortcode |
| [188](#L188) | add\_shortcode( 'corner-ad', 'corner\_ad\_replace\_shortcode' ); |
| [189](#L189) | add\_image\_size( 'corner\_ad\_thumb', 100, 100, true ); |
| [190](#L190) | add\_image\_size( 'corner\_ad', 500, 500, true ); |
| [191](#L191) | add\_action( 'wp\_footer', 'corner\_ad\_wp\_footer' ); |
| [192](#L192) | } // End corner\_ad\_init |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | /\* |
| [196](#L196) | \*   Admin initionalizing |
| [197](#L197) | \*/ |
| [198](#L198) | add\_action( 'admin\_init', 'corner\_ad\_admin\_init' ); |
| [199](#L199) | if ( ! function\_exists( 'corner\_ad\_admin\_init' ) ) { |
| [200](#L200) | function corner\_ad\_admin\_init() { |
| [201](#L201) | // Load the associated text domain |
| [202](#L202) | load\_plugin\_textdomain( 'corner-ad', false, CORNER\_AD\_PLUGIN\_DIR . '/languages/' ); |
| [203](#L203) |  |
| [204](#L204) | // Set plugin links |
| [205](#L205) | $plugin = plugin\_basename( \_\_FILE\_\_ ); |
| [206](#L206) | add\_filter( 'plugin\_action\_links\_' . $plugin, 'corner\_ad\_links' ); |
| [207](#L207) |  |
| [208](#L208) | // Set a new media button for corner ad insertion |
| [209](#L209) | add\_action( 'media\_buttons', 'corner\_ad\_media\_button', 100 ); |
| [210](#L210) | } // End corner\_ad\_admin\_init |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | if ( ! function\_exists( 'corner\_ad\_links' ) ) { |
| [214](#L214) | function corner\_ad\_links( $links ) { |
| [215](#L215) | // Help link |
| [216](#L216) | $custom\_link = '<a href="https://wordpress.org/support/plugin/corner-ad/#new-post" target="\_blank">' . \_\_( 'Help', 'corner-ad' ) . '</a>'; |
| [217](#L217) | array\_unshift( $links, $custom\_link ); |
| [218](#L218) |  |
| [219](#L219) | // Custom link |
| [220](#L220) | $custom\_link = '<a href="https://wordpress.dwbooster.com/contact-us" target="\_blank">' . \_\_( 'Request custom changes', 'corner-ad' ) . '</a>'; |
| [221](#L221) | array\_unshift( $links, $custom\_link ); |
| [222](#L222) |  |
| [223](#L223) | // Settings link |
| [224](#L224) | $settings\_link = '<a href="options-general.php?page=corner-ad.php">' . \_\_( 'Settings' ) . '</a>'; |
| [225](#L225) | array\_unshift( $links, $settings\_link ); |
| [226](#L226) |  |
| [227](#L227) | return $links; |
| [228](#L228) | } // End corner\_ad\_customization\_link |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | // Set the settings menu option |
| [232](#L232) | add\_action( 'admin\_menu', 'corner\_ad\_settings\_menu' ); |
| [233](#L233) | if ( ! function\_exists( 'corner\_ad\_settings\_menu' ) ) { |
| [234](#L234) | function corner\_ad\_settings\_menu() { |
| [235](#L235) | // Add to admin\_menu |
| [236](#L236) | add\_options\_page( 'Corner AD', 'Corner AD', 'edit\_posts', basename( \_\_FILE\_\_ ), 'corner\_ad\_settings\_page' ); |
| [237](#L237) | } // End corner\_ad\_settings\_menu |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | if ( ! function\_exists( 'corner\_ad\_settings\_page' ) ) { |
| [241](#L241) | function corner\_ad\_settings\_page() { |
| [242](#L242) | global $wpdb; |
| [243](#L243) | wp\_enqueue\_media(); |
| [244](#L244) | ?> |
| [245](#L245) | <div class="wrap"> |
| [246](#L246) | <h1><?php esc\_html\_e( 'Corner Ad', 'corner-ad' ); ?></h1> |
| [247](#L247) | <?php |
| [248](#L248) | if ( isset( $\_REQUEST['action'] ) ) { |
| [249](#L249) | switch ( $\_REQUEST['action'] ) { |
| [250](#L250) | case 'ad\_remove': |
| [251](#L251) | if ( isset( $\_REQUEST['id'] ) ) { |
| [252](#L252) | if ( $wpdb->query( $wpdb->prepare( 'DELETE FROM ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . ' WHERE ad=%d', sanitize\_text\_field( wp\_unslash( $\_REQUEST['id'] ) ) ) ) ) { // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [253](#L253) | $wpdb->query( $wpdb->prepare( 'DELETE FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE id=%d', sanitize\_text\_field( wp\_unslash( $\_REQUEST['id'] ) ) ) ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [254](#L254) | } |
| [255](#L255) | } |
| [256](#L256) | print corner\_ad\_settings\_page\_list(); // phpcs:ignore WordPress.Security.EscapeOutput |
| [257](#L257) | break; |
| [258](#L258) | case 'ad\_edit': |
| [259](#L259) | case 'ad\_create': |
| [260](#L260) | print corner\_ad\_settings\_page\_form(); // phpcs:ignore WordPress.Security.EscapeOutput |
| [261](#L261) | break; |
| [262](#L262) | case 'ad\_save': |
| [263](#L263) | print corner\_ad\_settings\_page\_form(); // phpcs:ignore WordPress.Security.EscapeOutput |
| [264](#L264) | break; |
| [265](#L265) | default: |
| [266](#L266) | print corner\_ad\_settings\_page\_list(); // phpcs:ignore WordPress.Security.EscapeOutput |
| [267](#L267) | break; |
| [268](#L268) | } |
| [269](#L269) | } else { |
| [270](#L270) | print corner\_ad\_settings\_page\_list(); // phpcs:ignore WordPress.Security.EscapeOutput |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | ?> |
| [274](#L274) | </div> |
| [275](#L275) | <?php |
| [276](#L276) | } // End corner\_ad\_settings\_page |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | if ( ! function\_exists( 'corner\_ad\_replace\_shortcode' ) ) { |
| [280](#L280) | function corner\_ad\_replace\_shortcode( $attr ) { |
| [281](#L281) | global $wpdb, $corner\_ad\_inserted; |
| [282](#L282) |  |
| [283](#L283) | if ( ! isset( $corner\_ad\_inserted ) ) { |
| [284](#L284) | if ( empty( $attr['id'] ) ) { |
| [285](#L285) | $ad = $wpdb->get\_row( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE ' . ( wp\_is\_mobile() ? 'mobile=1' : 'desktop=1' ) ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [286](#L286) | } else { |
| [287](#L287) | $ad = $wpdb->get\_row( $wpdb->prepare( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE id=%d AND ' . ( wp\_is\_mobile() ? 'mobile=1' : 'desktop=1' ), $attr['id'] ) ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | if ( $ad ) { |
| [291](#L291) | $date = gmdate( 'Y-m-d' ); |
| [292](#L292) |  |
| [293](#L293) | if ( ! empty( $ad->fromDate ) && '0000-00-00' != $ad->fromDate && $date < $ad->fromDate ) { |
| [294](#L294) | return ''; |
| [295](#L295) | } |
| [296](#L296) | if ( ! empty( $ad->toDate ) && '0000-00-00' != $ad->toDate && $ad->toDate < $date ) { |
| [297](#L297) | return ''; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | $corner\_ad\_inserted = true; |
| [301](#L301) | // Enqueue required files |
| [302](#L302) | wp\_enqueue\_script( 'jquery' ); |
| [303](#L303) | wp\_enqueue\_script( 'corner\_ad\_raphael\_script', CORNER\_AD\_PLUGIN\_URL . '/js/raphael-min.js', array(), CORNER\_AD\_PLUGIN\_VERSION ); |
| [304](#L304) | wp\_enqueue\_script( 'corner\_ad\_public\_script', CORNER\_AD\_PLUGIN\_URL . '/js/cornerAd.min.js', array( 'jquery', 'corner\_ad\_raphael\_script' ), CORNER\_AD\_PLUGIN\_VERSION ); |
| [305](#L305) |  |
| [306](#L306) | // Select the image |
| [307](#L307) | $row = $wpdb->get\_row( $wpdb->prepare( 'SELECT imgPath, thumbPath FROM ' . $wpdb->prefix . CORNER\_AD\_IMG\_TABLE . ' WHERE ad=%d', $ad->id ) ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [308](#L308) |  |
| [309](#L309) | if ( $row ) { |
| [310](#L310) | $img = corner\_ad\_get\_images( $row->imgPath, ( ( ! empty( $row->thumbPath ) ) ? $row->thumbPath : '' ), true ); |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | $colorIn = $ad->colorIn; |
| [314](#L314) | if ( get\_option( 'corner\_ad\_analytics', 0 ) ) { |
| [315](#L315) | $ga = esc\_js( get\_option( 'corner\_ad\_analytics\_tracking\_id', '' ) ); |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | if ( isset( $ad->extra ) ) { |
| [319](#L319) | $extra = json\_decode( $ad->extra, true ); |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | return "<script> |
| [323](#L323) | if(window.addEventListener){ |
| [324](#L324) | window.addEventListener( |
| [325](#L325) | 'load', |
| [326](#L326) | function(){ |
| [327](#L327) | printCornerAd( |
| [328](#L328) | { |
| [329](#L329) | alignTo:'tl', |
| [330](#L330) | mirror:" . esc\_js( ( 1 == $ad->mirror ) ? 'true' : 'false' ) . ", |
| [331](#L331) | colorIn:'" . esc\_js( $colorIn ) . "', |
| [332](#L332) | thumbPath:'" . esc\_js( $img->thumb->url ) . "', |
| [333](#L333) | imgPath:'" . esc\_js( $img->large->url ) . "', |
| [334](#L334) | adUrl:'" . esc\_js( $ad->adURL ) . "', |
| [335](#L335) | openIn:" . esc\_js( ( $ad->openIn ) ? $ad->openIn : -1 ) . ', |
| [336](#L336) | closeIn:' . esc\_js( ( $ad->closeIn ) ? $ad->closeIn : -1 ) . ", |
| [337](#L337) | target:'" . esc\_js( $ad->target ) . "'" . ( ( ! empty( $ga ) ) ? ", |
| [338](#L338) | ga:'" . $ga . "'" : '' ) . ", |
| [339](#L339) | ga\_category:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_category'] ) ? $extra['ga\_category'] : 'Corner Ad' ) . "', |
| [340](#L340) | ga\_action:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_action'] ) ? $extra['ga\_action'] : 'click' ) . "', |
| [341](#L341) | ga\_label:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_label'] ) ? $extra['ga\_label'] : '' ) . "' |
| [342](#L342) | } |
| [343](#L343) | ); |
| [344](#L344) | } |
| [345](#L345) | ); |
| [346](#L346) | }else{ |
| [347](#L347) | window.attachEvent( |
| [348](#L348) | 'onload', |
| [349](#L349) | function(){ |
| [350](#L350) | printCornerAd( |
| [351](#L351) | { |
| [352](#L352) | alignTo:'tl', |
| [353](#L353) | mirror:" . esc\_js( ( 1 == $ad->mirror ) ? 'true' : 'false' ) . ", |
| [354](#L354) | colorIn:'" . esc\_js( $colorIn ) . "', |
| [355](#L355) | thumbPath:'" . esc\_js( $img->thumb->url ) . "', |
| [356](#L356) | imgPath:'" . esc\_js( $img->large->url ) . "', |
| [357](#L357) | adUrl:'" . esc\_js( $ad->adURL ) . "', |
| [358](#L358) | openIn:" . esc\_js( ( $ad->openIn ) ? $ad->openIn : -1 ) . ', |
| [359](#L359) | closeIn:' . esc\_js( ( $ad->closeIn ) ? $ad->closeIn : -1 ) . ", |
| [360](#L360) | target:'" . esc\_js( $ad->target ) . "'" . ( ( ! empty( $ga ) ) ? ", |
| [361](#L361) | ga:'" . $ga . "'" : '' ) . ", |
| [362](#L362) | ga\_category:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_category'] ) ? $extra['ga\_category'] : 'Corner Ad' ) . "', |
| [363](#L363) | ga\_action:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_action'] ) ? $extra['ga\_action'] : 'click' ) . "', |
| [364](#L364) | ga\_label:'" . esc\_js( ! empty( $extra ) && ! empty( $extra['ga\_label'] ) ? $extra['ga\_label'] : '' ) . "' |
| [365](#L365) | } |
| [366](#L366) | ); |
| [367](#L367) | } |
| [368](#L368) | ); |
| [369](#L369) | } |
| [370](#L370) | </script>"; |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | return ''; |
| [375](#L375) | } // End corner\_ad\_replace\_shortcode |
| [376](#L376) | } |
| [377](#L377) |  |
| [378](#L378) | if ( ! function\_exists( 'corner\_ad\_media\_button' ) ) { |
| [379](#L379) | function corner\_ad\_media\_button() { |
| [380](#L380) | global $wpdb; |
| [381](#L381) |  |
| [382](#L382) | // Enqueue required files |
| [383](#L383) | wp\_enqueue\_style( 'wp-jquery-ui-dialog' ); |
| [384](#L384) | wp\_enqueue\_script( 'corner\_ad\_insertion', CORNER\_AD\_PLUGIN\_URL . '/js/ca-insertion.js', array( 'jquery', 'jquery-ui-dialog' ), CORNER\_AD\_PLUGIN\_VERSION ); |
| [385](#L385) |  |
| [386](#L386) | $ads  = $wpdb->get\_results( 'SELECT id, name FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' ORDER BY name ASC;' ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [387](#L387) | $list = ''; |
| [388](#L388) | if ( $ads ) { |
| [389](#L389) | foreach ( $ads as $ad ) { |
| [390](#L390) | $list .= '<option value="' . esc\_attr( $ad->id ) . '">' . esc\_html( $ad->name ) . '</option>'; |
| [391](#L391) | } |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | wp\_localize\_script( 'corner\_ad\_insertion', 'corner\_ad', array( 'list' => $list ) ); |
| [395](#L395) |  |
| [396](#L396) | print '<a href="javascript:open\_insertion\_corner\_ad\_window();" title="' . esc\_attr( \_\_( 'Insert Corner Ad' ) ) . '"><img src="' . esc\_url( CORNER\_AD\_PLUGIN\_URL . '/images/corner-ad-icon.gif' ) . '" alt="' . esc\_attr( \_\_( 'Insert Corner Ad' ) ) . '" /></a>'; |
| [397](#L397) | } // End corner\_ad\_media\_button |
| [398](#L398) | } |
| [399](#L399) |  |
| [400](#L400) | if ( ! function\_exists( 'corner\_ad\_wp\_footer' ) ) { |
| [401](#L401) | function corner\_ad\_wp\_footer() { |
| [402](#L402) | $default\_ad = @intval( get\_option( 'corner\_ad\_default\_ad', 0 ) ); |
| [403](#L403) | $random\_ad  = @intval( get\_option( 'corner\_ad\_random\_ad', 0 ) ); |
| [404](#L404) | $context    = get\_option( 'corner\_ad\_context', 'everything' ); |
| [405](#L405) | $posttypes  = get\_option( 'corner\_ad\_posttypes', array() ); |
| [406](#L406) | if ( |
| [407](#L407) | ( $default\_ad || $random\_ad ) && |
| [408](#L408) | ( |
| [409](#L409) | 'everything' == $context || |
| [410](#L410) | ( 'homepage' == $context && is\_home() ) || |
| [411](#L411) | ( 'posttype' == $context && in\_array( get\_post\_type(), $posttypes ) ) |
| [412](#L412) | ) |
| [413](#L413) | ) { |
| [414](#L414) | if ( $random\_ad ) { |
| [415](#L415) | global $wpdb; |
| [416](#L416) | $ad         = $wpdb->get\_row( 'SELECT \* FROM ' . $wpdb->prefix . CORNER\_AD\_TABLE . ' WHERE ' . ( wp\_is\_mobile() ? 'mobile=1' : 'desktop=1' ) . ' ORDER BY RAND()' ); // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
| [417](#L417) | $default\_ad = $ad->id; |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | if ( $default\_ad ) { |
| [421](#L421) | print do\_shortcode( '[corner-ad id="' . $default\_ad . '"]' ); |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/corner-ad/trunk/corner-ad.php?rev=2782613&format=txt)
* [Original Format](/export/2782613/corner-ad/trunk/corner-ad.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_6e57dee5_20250114_181801.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Corner Ad <= 1.0.56 - Cross-Site Request Forgery

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Corner Ad <= 1.0.56 - Cross-Site Request Forgery

8.8

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H)

| CVE | [CVE-2022-3427](https://www.cve.org/CVERecord?id=CVE-2022-3427) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | September 9, 2022 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The Corner Ad plugin for WordPress is vulnerable to Cross-Site Request Forgery in versions up to, and including, 1.0.56. This is due to missing or incorrect nonce validation on its corner\_ad\_settings\_page function. This makes it possible for unauthenticated attackers to trigger the deletion of ads via forged request granted they can trick a site administrator into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=2765630%40corner-ad%2Ftrunk&old=2719671%40corner-ad%2Ftrunk&sfp_email=&sfph_mail=)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/corner-ad/trunk/corner-ad.php?rev=2782613#L240)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcorner-ad%2Fcorner-ad-1056-cross-site-request-forgery&t=Corner%20Ad%20%3C%3D%201.0.56%20-%20Cross-Site%20Request%20Forgery "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcorner-ad%2Fcorner-ad-1056-cross-site-request-forgery&text=Corner%20Ad%20%3C%3D%201.0.56%20-%20Cross-Site%20Request%20Forgery "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcorner-ad%2Fcorner-ad-1056-cross-site-request-forgery "LinkedIn")
Email

## Vulnerability Details for Corner Ad

#### [Corner Ad](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/corner-ad)

| Software Type | Plugin |
| --- | --- |
| Software Slug | corner-ad [(view on wordpress.org)](https://wordpress.org/plugins/corner-ad) |
| Patched? | Yes |
| Remediation | Update to version 1.0.57, or a newer patched version |
| Affected Version | * <= 1.0.56 |
| Patched Version | * 1.0.57 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


