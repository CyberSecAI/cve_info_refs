=== Content from git.kernel.org_6d37e12f_20250114_212523.html ===


| [cgit logo](/) | [index](/) : [kernel/git/bpf/bpf-next.git](/pub/scm/linux/kernel/git/bpf/bpf-next.git/) | for-next master net |
| --- | --- | --- |
| BPF next kernel tree | BPF Group |

| [about](/pub/scm/linux/kernel/git/bpf/bpf-next.git/about/)[summary](/pub/scm/linux/kernel/git/bpf/bpf-next.git/)[refs](/pub/scm/linux/kernel/git/bpf/bpf-next.git/refs/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)[log](/pub/scm/linux/kernel/git/bpf/bpf-next.git/log/)[tree](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)[commit](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)[diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)[stats](/pub/scm/linux/kernel/git/bpf/bpf-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xu Kuohai <xukuohai@huawei.com> | 2022-10-11 08:01:04 -0400 |
| --- | --- | --- |
| committer | Andrii Nakryiko <andrii@kernel.org> | 2022-10-13 10:53:18 -0700 |
| commit | [0dc9254e03704c75f2ebc9cbef2ce4de83fba603](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603) ([patch](/pub/scm/linux/kernel/git/bpf/bpf-next.git/patch/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)) | |
| tree | [9241bdca95d8ad1589961a09e182f3e97a199567](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603) | |
| parent | [93c660ca40b5d2f7c1b1626e955a8e9fa30e0749](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749) ([diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603&id2=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)) | |
| download | [bpf-next-0dc9254e03704c75f2ebc9cbef2ce4de83fba603.tar.gz](/pub/scm/linux/kernel/git/bpf/bpf-next.git/snapshot/bpf-next-0dc9254e03704c75f2ebc9cbef2ce4de83fba603.tar.gz) | |

libbpf: Fix memory leak in parse\_usdt\_arg()In the arm64 version of parse\_usdt\_arg(), when sscanf returns 2, reg\_name
is allocated but not freed. Fix it.
Fixes: 0f8619929c57 ("libbpf: Usdt aarch64 arg parsing support")
Signed-off-by: Xu Kuohai <xukuohai@huawei.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Martin KaFai Lau <martin.lau@kernel.org>
Link: [https://lore.kernel.org/bpf/20221011120108.782373-3-xukuohai@huaweicloud.com](https://lore.kernel.org/bpf/20221011120108.782373-3-xukuohai%40huaweicloud.com)
[Diffstat](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)

| -rw-r--r-- | [tools/lib/bpf/usdt.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/tools/lib/bpf/usdt.c?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 7 deletions

| diff --git a/tools/lib/bpf/usdt.c b/tools/lib/bpf/usdt.cindex e83b497c224544..49f3c3b7f60954 100644--- a/[tools/lib/bpf/usdt.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/tools/lib/bpf/usdt.c?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)+++ b/[tools/lib/bpf/usdt.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/tools/lib/bpf/usdt.c?id=0dc9254e03704c75f2ebc9cbef2ce4de83fba603)@@ -1348,25 +1348,23 @@ static int calc\_pt\_regs\_off(const char \*reg\_name)  static int parse\_usdt\_arg(const char \*arg\_str, int arg\_num, struct usdt\_arg\_spec \*arg) {- char \*reg\_name = NULL;+ char reg\_name[16]; int arg\_sz, len, reg\_off; long off; - if (sscanf(arg\_str, " %d @ \[ %m[a-z0-9], %ld ] %n", &arg\_sz, &reg\_name, &off, &len) == 3) {+ if (sscanf(arg\_str, " %d @ \[ %15[a-z0-9], %ld ] %n", &arg\_sz, reg\_name, &off, &len) == 3) { /\* Memory dereference case, e.g., -4@[sp, 96] \*/ arg->arg\_type = USDT\_ARG\_REG\_DEREF; arg->val\_off = off; reg\_off = calc\_pt\_regs\_off(reg\_name);- free(reg\_name); if (reg\_off < 0) return reg\_off; arg->reg\_off = reg\_off;- } else if (sscanf(arg\_str, " %d @ \[ %m[a-z0-9] ] %n", &arg\_sz, &reg\_name, &len) == 2) {+ } else if (sscanf(arg\_str, " %d @ \[ %15[a-z0-9] ] %n", &arg\_sz, reg\_name, &len) == 2) { /\* Memory dereference case, e.g., -4@[sp] \*/ arg->arg\_type = USDT\_ARG\_REG\_DEREF; arg->val\_off = 0; reg\_off = calc\_pt\_regs\_off(reg\_name);- free(reg\_name); if (reg\_off < 0) return reg\_off; arg->reg\_off = reg\_off;@@ -1375,12 +1373,11 @@ static int parse\_usdt\_arg(const char \*arg\_str, int arg\_num, struct usdt\_arg\_spec arg->arg\_type = USDT\_ARG\_CONST; arg->val\_off = off; arg->reg\_off = 0;- } else if (sscanf(arg\_str, " %d @ %m[a-z0-9] %n", &arg\_sz, &reg\_name, &len) == 2) {+ } else if (sscanf(arg\_str, " %d @ %15[a-z0-9] %n", &arg\_sz, reg\_name, &len) == 2) { /\* Register read case, e.g., -8@x4 \*/ arg->arg\_type = USDT\_ARG\_REG; arg->val\_off = 0; reg\_off = calc\_pt\_regs\_off(reg\_name);- free(reg\_name); if (reg\_off < 0) return reg\_off; arg->reg\_off = reg\_off; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:24:00 +0000


