=== Content from git.kernel.org_962efb06_20250114_225552.html ===


| [cgit logo](/) | [index](/) : [kernel/git/bpf/bpf-next.git](/pub/scm/linux/kernel/git/bpf/bpf-next.git/) | for-next master net |
| --- | --- | --- |
| BPF next kernel tree | BPF Group |

| [about](/pub/scm/linux/kernel/git/bpf/bpf-next.git/about/)[summary](/pub/scm/linux/kernel/git/bpf/bpf-next.git/)[refs](/pub/scm/linux/kernel/git/bpf/bpf-next.git/refs/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)[log](/pub/scm/linux/kernel/git/bpf/bpf-next.git/log/)[tree](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)[commit](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)[diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)[stats](/pub/scm/linux/kernel/git/bpf/bpf-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xu Kuohai <xukuohai@huawei.com> | 2022-10-11 08:01:03 -0400 |
| --- | --- | --- |
| committer | Andrii Nakryiko <andrii@kernel.org> | 2022-10-13 10:53:03 -0700 |
| commit | [93c660ca40b5d2f7c1b1626e955a8e9fa30e0749](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749) ([patch](/pub/scm/linux/kernel/git/bpf/bpf-next.git/patch/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)) | |
| tree | [24cb3049d4106b324ba1543853dc05643d67c5d0](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749) | |
| parent | [de9c8d848d90cf2e53aced50b350827442ca5a4f](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=de9c8d848d90cf2e53aced50b350827442ca5a4f) ([diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749&id2=de9c8d848d90cf2e53aced50b350827442ca5a4f)) | |
| download | [bpf-next-93c660ca40b5d2f7c1b1626e955a8e9fa30e0749.tar.gz](/pub/scm/linux/kernel/git/bpf/bpf-next.git/snapshot/bpf-next-93c660ca40b5d2f7c1b1626e955a8e9fa30e0749.tar.gz) | |

libbpf: Fix use-after-free in btf\_dump\_name\_dupsASAN reports an use-after-free in btf\_dump\_name\_dups:
ERROR: AddressSanitizer: heap-use-after-free on address 0xffff927006db at pc 0xaaaab5dfb618 bp 0xffffdd89b890 sp 0xffffdd89b928
READ of size 2 at 0xffff927006db thread T0
#0 0xaaaab5dfb614 in \_\_interceptor\_strcmp.part.0 (test\_progs+0x21b614)
#1 0xaaaab635f144 in str\_equal\_fn tools/lib/bpf/btf\_dump.c:127
#2 0xaaaab635e3e0 in hashmap\_find\_entry tools/lib/bpf/hashmap.c:143
#3 0xaaaab635e72c in hashmap\_\_find tools/lib/bpf/hashmap.c:212
#4 0xaaaab6362258 in btf\_dump\_name\_dups tools/lib/bpf/btf\_dump.c:1525
#5 0xaaaab636240c in btf\_dump\_resolve\_name tools/lib/bpf/btf\_dump.c:1552
#6 0xaaaab6362598 in btf\_dump\_type\_name tools/lib/bpf/btf\_dump.c:1567
#7 0xaaaab6360b48 in btf\_dump\_emit\_struct\_def tools/lib/bpf/btf\_dump.c:912
#8 0xaaaab6360630 in btf\_dump\_emit\_type tools/lib/bpf/btf\_dump.c:798
#9 0xaaaab635f720 in btf\_dump\_\_dump\_type tools/lib/bpf/btf\_dump.c:282
#10 0xaaaab608523c in test\_btf\_dump\_incremental tools/testing/selftests/bpf/prog\_tests/btf\_dump.c:236
#11 0xaaaab6097530 in test\_btf\_dump tools/testing/selftests/bpf/prog\_tests/btf\_dump.c:875
#12 0xaaaab6314ed0 in run\_one\_test tools/testing/selftests/bpf/test\_progs.c:1062
#13 0xaaaab631a0a8 in main tools/testing/selftests/bpf/test\_progs.c:1697
#14 0xffff9676d214 in \_\_libc\_start\_main ../csu/libc-start.c:308
#15 0xaaaab5d65990 (test\_progs+0x185990)
0xffff927006db is located 11 bytes inside of 16-byte region [0xffff927006d0,0xffff927006e0)
freed by thread T0 here:
#0 0xaaaab5e2c7c4 in realloc (test\_progs+0x24c7c4)
#1 0xaaaab634f4a0 in libbpf\_reallocarray tools/lib/bpf/libbpf\_internal.h:191
#2 0xaaaab634f840 in libbpf\_add\_mem tools/lib/bpf/btf.c:163
#3 0xaaaab636643c in strset\_add\_str\_mem tools/lib/bpf/strset.c:106
#4 0xaaaab6366560 in strset\_\_add\_str tools/lib/bpf/strset.c:157
#5 0xaaaab6352d70 in btf\_\_add\_str tools/lib/bpf/btf.c:1519
#6 0xaaaab6353e10 in btf\_\_add\_field tools/lib/bpf/btf.c:2032
#7 0xaaaab6084fcc in test\_btf\_dump\_incremental tools/testing/selftests/bpf/prog\_tests/btf\_dump.c:232
#8 0xaaaab6097530 in test\_btf\_dump tools/testing/selftests/bpf/prog\_tests/btf\_dump.c:875
#9 0xaaaab6314ed0 in run\_one\_test tools/testing/selftests/bpf/test\_progs.c:1062
#10 0xaaaab631a0a8 in main tools/testing/selftests/bpf/test\_progs.c:1697
#11 0xffff9676d214 in \_\_libc\_start\_main ../csu/libc-start.c:308
#12 0xaaaab5d65990 (test\_progs+0x185990)
previously allocated by thread T0 here:
#0 0xaaaab5e2c7c4 in realloc (test\_progs+0x24c7c4)
#1 0xaaaab634f4a0 in libbpf\_reallocarray tools/lib/bpf/libbpf\_internal.h:191
#2 0xaaaab634f840 in libbpf\_add\_mem tools/lib/bpf/btf.c:163
#3 0xaaaab636643c in strset\_add\_str\_mem tools/lib/bpf/strset.c:106
#4 0xaaaab6366560 in strset\_\_add\_str tools/lib/bpf/strset.c:157
#5 0xaaaab6352d70 in btf\_\_add\_str tools/lib/bpf/btf.c:1519
#6 0xaaaab6353ff0 in btf\_add\_enum\_common tools/lib/bpf/btf.c:2070
#7 0xaaaab6354080 in btf\_\_add\_enum tools/lib/bpf/btf.c:2102
#8 0xaaaab6082f50 in test\_btf\_dump\_incremental tools/testing/selftests/bpf/prog\_tests/btf\_dump.c:162
#9 0xaaaab6097530 in test\_btf\_dump tools/testing/selftests/bpf/prog\_tests/btf\_dump.c:875
#10 0xaaaab6314ed0 in run\_one\_test tools/testing/selftests/bpf/test\_progs.c:1062
#11 0xaaaab631a0a8 in main tools/testing/selftests/bpf/test\_progs.c:1697
#12 0xffff9676d214 in \_\_libc\_start\_main ../csu/libc-start.c:308
#13 0xaaaab5d65990 (test\_progs+0x185990)
The reason is that the key stored in hash table name\_map is a string
address, and the string memory is allocated by realloc() function, when
the memory is resized by realloc() later, the old memory may be freed,
so the address stored in name\_map references to a freed memory, causing
use-after-free.
Fix it by storing duplicated string address in name\_map.
Fixes: 919d2b1dbb07 ("libbpf: Allow modification of BTF and add btf\_\_add\_str API")
Signed-off-by: Xu Kuohai <xukuohai@huawei.com>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Acked-by: Martin KaFai Lau <martin.lau@kernel.org>
Link: [https://lore.kernel.org/bpf/20221011120108.782373-2-xukuohai@huaweicloud.com](https://lore.kernel.org/bpf/20221011120108.782373-2-xukuohai%40huaweicloud.com)
[Diffstat](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)

| -rw-r--r-- | [tools/lib/bpf/btf\_dump.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/tools/lib/bpf/btf_dump.c?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 3 deletions

| diff --git a/tools/lib/bpf/btf\_dump.c b/tools/lib/bpf/btf\_dump.cindex e4da6de68d8f33..bf0cc0e986dd7b 100644--- a/[tools/lib/bpf/btf\_dump.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/tools/lib/bpf/btf_dump.c?id=de9c8d848d90cf2e53aced50b350827442ca5a4f)+++ b/[tools/lib/bpf/btf\_dump.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/tools/lib/bpf/btf_dump.c?id=93c660ca40b5d2f7c1b1626e955a8e9fa30e0749)@@ -219,6 +219,17 @@ static int btf\_dump\_resize(struct btf\_dump \*d) return 0; } +static void btf\_dump\_free\_names(struct hashmap \*map)+{+ size\_t bkt;+ struct hashmap\_entry \*cur;++ hashmap\_\_for\_each\_entry(map, cur, bkt)+ free((void \*)cur->key);++ hashmap\_\_free(map);+}+ void btf\_dump\_\_free(struct btf\_dump \*d) { int i;@@ -237,8 +248,8 @@ void btf\_dump\_\_free(struct btf\_dump \*d) free(d->cached\_names); free(d->emit\_queue); free(d->decl\_stack);- hashmap\_\_free(d->type\_names);- hashmap\_\_free(d->ident\_names);+ btf\_dump\_free\_names(d->type\_names);+ btf\_dump\_free\_names(d->ident\_names);  free(d); }@@ -1524,11 +1535,23 @@ static void btf\_dump\_emit\_type\_cast(struct btf\_dump \*d, \_\_u32 id, static size\_t btf\_dump\_name\_dups(struct btf\_dump \*d, struct hashmap \*name\_map, const char \*orig\_name) {+ char \*old\_name, \*new\_name; size\_t dup\_cnt = 0;+ int err;++ new\_name = strdup(orig\_name);+ if (!new\_name)+ return 1;  hashmap\_\_find(name\_map, orig\_name, (void \*\*)&dup\_cnt); dup\_cnt++;- hashmap\_\_set(name\_map, orig\_name, (void \*)dup\_cnt, NULL, NULL);++ err = hashmap\_\_set(name\_map, new\_name, (void \*)dup\_cnt,+ (const void \*\*)&old\_name, NULL);+ if (err)+ free(new\_name);++ free(old\_name);  return dup\_cnt; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:54:30 +0000


