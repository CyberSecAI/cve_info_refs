=== Content from gitlab.com_4178f4c7_20250115_100232.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# IP Group enforcement regression in the Package Registry

## üî• Problem

In <https://gitlab.com/gitlab-org/gitlab/-/issues/363863>, we fixed a [security](/gitlab-org/gitlab/-/issues?label_name=security "Issues related to the security of GitLab or its dependencies. Please report vulnerabilities responsibly per https://about.gitlab.com/security/disclosure/") vulnerability where the [group IP enforcement](https://docs.gitlab.com/ee/user/group/access_and_permissions.html#restrict-group-access-by-ip-address) was not properly respected by the Package Registry.

(A) The fix used there was quite simple: if there is an IP enforcement violation, then we simply remove *all* package registry permissions. See <https://gitlab.com/gitlab-org/gitlab/-/blob/8287b24dca55519deec457aea4b25846463b0e98/ee/app/policies/ee/project_policy.rb#L423> and <https://gitlab.com/gitlab-org/gitlab/-/blob/8287b24dca55519deec457aea4b25846463b0e98/ee/app/policies/ee/group_policy.rb#L415>.

(B) On the other hand, we have a community effort around this [issue](https://gitlab.com/gitlab-org/gitlab/-/issues/329253 "Feature specific permissions for the  Package Registry"). Among the changes, we needed to put more conditions on how `read_package` is evaluated and granted by policies. Because of this [rule](https://gitlab.com/gitlab-org/gitlab/-/blob/2d2f0bcb347a44cbe56fb579a101bf967f3f534a/app/policies/project_policy.rb#L636), we were forced there to [create](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/90963 "Extract 'read_package' rule into separate policy") package dedicated policies for [project](https://gitlab.com/gitlab-org/gitlab/-/blob/2d2f0bcb347a44cbe56fb579a101bf967f3f534a/app/policies/packages/policies/project_policy.rb) and [group](https://gitlab.com/gitlab-org/gitlab/-/blob/2d2f0bcb347a44cbe56fb579a101bf967f3f534a/app/policies/packages/policies/group_policy.rb). These policies are super simple: for `read_package` use my rules, for everything else, use the project/group policy.

(A) was deployed in [%15.3](/groups/gitlab-org/-/milestones/75) and (B) in [%15.4](/groups/gitlab-org/-/milestones/76).

Now guess what happens when (A) and (B) are together? Yeah, üí•

Group IP enforcement is again not respected from [%15.4](/groups/gitlab-org/-/milestones/76) for the `read_package` permission which is the one permission used when pulling packages.

In few words: this is a security issue regression.

## üöí Solution

* Update the package dedicated policies to properly deny `read_package` if a group ip violation is detected.
  + Defense in depth: go further and simply deny all `*_package` permissions.
  + ‚ö† the project policy was updated for [%15.6](/groups/gitlab-org/-/milestones/81) in [!100260 (merged)](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/100260 "Adapt PyPI API to consider the package registry access level"). So we don't need the changes for the project policy object in the `master` branch MR.
* Update the specs.
  + This went out of the radar of the specs because the group ip logic was assert on policy specs but this time around, we want to make sure that this regression can't pop up again.
  + For the above, simply add spec examples at the request specs level for the package registry. If possible for all package formats.

## üôè Thanks

Credits where they are due.

The above was [discovered](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/100260#note_1144516402 "Adapt PyPI API to consider the package registry access level") in a [Community contribution](/gitlab-org/gitlab/-/issues?label_name=Community+contribution "Issues that have been scheduled for an upcoming release and are actively being worked on by our community") (from `@wwwjon`) where a job failed on spec trying to pull a PyPI package from a group ip restricted project.

Edited Oct 26, 2022 by [Dzmitry (Dima) Meshcharakou](/dmeshcharakou)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_69d6b4a5_20250115_100229.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-3820.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-3820.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-3820.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-3820.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ü§ñ GitLab Bot ü§ñ's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "ü§ñ GitLab Bot ü§ñ")](/gitlab-bot)

  Jan 20, 2023

  [6cf4af7e](/gitlab-org/cves/-/commit/6cf4af7e99ac4e35f59b0f511032a3a530ce6200)
  [Publishing 0 updated advisories and 2 new advisories](/gitlab-org/cves/-/commit/6cf4af7e99ac4e35f59b0f511032a3a530ce6200)
  ¬∑
  6cf4af7e

  [ü§ñ GitLab Bot ü§ñ](/gitlab-bot) authored Jan 20, 2023

  6cf4af7e

  [Publishing 0 updated advisories and 2 new advisories](/gitlab-org/cves/-/commit/6cf4af7e99ac4e35f59b0f511032a3a530ce6200)
  [ü§ñ GitLab Bot ü§ñ](/gitlab-bot) authored Jan 20, 2023

Loading


