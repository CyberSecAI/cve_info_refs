=== Content from git.kernel.org_e4baa274_20250115_093851.html ===


| [cgit logo](/) | [index](/) : [kernel/git/pabeni/net-next.git](/pub/scm/linux/kernel/git/pabeni/net-next.git/) | main master |
| --- | --- | --- |
| pabeni net-next tree | Paolo Abeni |

| [about](/pub/scm/linux/kernel/git/pabeni/net-next.git/about/)[summary](/pub/scm/linux/kernel/git/pabeni/net-next.git/)[refs](/pub/scm/linux/kernel/git/pabeni/net-next.git/refs/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)[log](/pub/scm/linux/kernel/git/pabeni/net-next.git/log/)[tree](/pub/scm/linux/kernel/git/pabeni/net-next.git/tree/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)[commit](/pub/scm/linux/kernel/git/pabeni/net-next.git/commit/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)[diff](/pub/scm/linux/kernel/git/pabeni/net-next.git/diff/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)[stats](/pub/scm/linux/kernel/git/pabeni/net-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Martin Willi <martin@strongswan.org> | 2022-04-12 11:34:57 +0200 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-04-13 12:25:02 +0100 |
| commit | [e16b859872b87650bb55b12cca5a5fcdc49c1442](/pub/scm/linux/kernel/git/pabeni/net-next.git/commit/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442) ([patch](/pub/scm/linux/kernel/git/pabeni/net-next.git/patch/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)) | |
| tree | [d1b64ce77ef60d6eb9b7538d5252884d0d953704](/pub/scm/linux/kernel/git/pabeni/net-next.git/tree/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442) | |
| parent | [625e8cb8e0e7b9eb6566c5a6e4fa95fb9dad9d4e](/pub/scm/linux/kernel/git/pabeni/net-next.git/commit/?id=625e8cb8e0e7b9eb6566c5a6e4fa95fb9dad9d4e) ([diff](/pub/scm/linux/kernel/git/pabeni/net-next.git/diff/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442&id2=625e8cb8e0e7b9eb6566c5a6e4fa95fb9dad9d4e)) | |
| download | [net-next-e16b859872b87650bb55b12cca5a5fcdc49c1442.tar.gz](/pub/scm/linux/kernel/git/pabeni/net-next.git/snapshot/net-next-e16b859872b87650bb55b12cca5a5fcdc49c1442.tar.gz) | |

macvlan: Fix leaking skb in source mode with nodst optionThe MACVLAN receive handler clones skbs to all matching source MACVLAN
interfaces, before it passes the packet along to match on destination
based MACVLANs.
When using the MACVLAN nodst mode, passing the packet to destination based
MACVLANs is omitted and the handler returns with RX\_HANDLER\_CONSUMED.
However, the passed skb is not freed, leaking for any packet processed
with the nodst option.
Properly free the skb when consuming packets to fix that leak.
Fixes: 427f0c8c194b ("macvlan: Add nodst option to macvlan type source")
Signed-off-by: Martin Willi <martin@strongswan.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/pabeni/net-next.git/diff/?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)

| -rw-r--r-- | [drivers/net/macvlan.c](/pub/scm/linux/kernel/git/pabeni/net-next.git/diff/drivers/net/macvlan.c?id=e16b859872b87650bb55b12cca5a5fcdc49c1442) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/macvlan.c b/drivers/net/macvlan.cindex 069e8824c264ad..b00bc8173abea8 100644--- a/[drivers/net/macvlan.c](/pub/scm/linux/kernel/git/pabeni/net-next.git/tree/drivers/net/macvlan.c?id=625e8cb8e0e7b9eb6566c5a6e4fa95fb9dad9d4e)+++ b/[drivers/net/macvlan.c](/pub/scm/linux/kernel/git/pabeni/net-next.git/tree/drivers/net/macvlan.c?id=e16b859872b87650bb55b12cca5a5fcdc49c1442)@@ -460,8 +460,10 @@ static rx\_handler\_result\_t macvlan\_handle\_frame(struct sk\_buff \*\*pskb) return RX\_HANDLER\_CONSUMED; \*pskb = skb; eth = eth\_hdr(skb);- if (macvlan\_forward\_source(skb, port, eth->h\_source))+ if (macvlan\_forward\_source(skb, port, eth->h\_source)) {+ kfree\_skb(skb); return RX\_HANDLER\_CONSUMED;+ } src = macvlan\_hash\_lookup(port, eth->h\_source); if (src && src->mode != MACVLAN\_MODE\_VEPA && src->mode != MACVLAN\_MODE\_BRIDGE) {@@ -480,8 +482,10 @@ static rx\_handler\_result\_t macvlan\_handle\_frame(struct sk\_buff \*\*pskb) return RX\_HANDLER\_PASS; } - if (macvlan\_forward\_source(skb, port, eth->h\_source))+ if (macvlan\_forward\_source(skb, port, eth->h\_source)) {+ kfree\_skb(skb); return RX\_HANDLER\_CONSUMED;+ } if (macvlan\_passthru(port)) vlan = list\_first\_or\_null\_rcu(&port->vlans, struct macvlan\_dev, list); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:37:28 +0000


