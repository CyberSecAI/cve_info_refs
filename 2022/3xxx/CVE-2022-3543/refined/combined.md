=== Content from git.kernel.org_463f38e5_20250115_084636.html ===


| [cgit logo](/) | [index](/) : [kernel/git/bpf/bpf-next.git](/pub/scm/linux/kernel/git/bpf/bpf-next.git/) | for-next master net |
| --- | --- | --- |
| BPF next kernel tree | BPF Group |

| [about](/pub/scm/linux/kernel/git/bpf/bpf-next.git/about/)[summary](/pub/scm/linux/kernel/git/bpf/bpf-next.git/)[refs](/pub/scm/linux/kernel/git/bpf/bpf-next.git/refs/?id=7a62ed61367b8fd01bae1e18e30602c25060d824)[log](/pub/scm/linux/kernel/git/bpf/bpf-next.git/log/)[tree](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=7a62ed61367b8fd01bae1e18e30602c25060d824)[commit](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=7a62ed61367b8fd01bae1e18e30602c25060d824)[diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=7a62ed61367b8fd01bae1e18e30602c25060d824)[stats](/pub/scm/linux/kernel/git/bpf/bpf-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2022-09-29 08:52:04 -0700 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-10-03 08:00:50 +0100 |
| commit | [7a62ed61367b8fd01bae1e18e30602c25060d824](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=7a62ed61367b8fd01bae1e18e30602c25060d824) ([patch](/pub/scm/linux/kernel/git/bpf/bpf-next.git/patch/?id=7a62ed61367b8fd01bae1e18e30602c25060d824)) | |
| tree | [9dd20a39de2c2d6d0f157b47bb97a0aca2785810](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/?id=7a62ed61367b8fd01bae1e18e30602c25060d824) | |
| parent | [a91b750fd6629354460282bbf5146c01b05c4859](/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=a91b750fd6629354460282bbf5146c01b05c4859) ([diff](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=7a62ed61367b8fd01bae1e18e30602c25060d824&id2=a91b750fd6629354460282bbf5146c01b05c4859)) | |
| download | [bpf-next-7a62ed61367b8fd01bae1e18e30602c25060d824.tar.gz](/pub/scm/linux/kernel/git/bpf/bpf-next.git/snapshot/bpf-next-7a62ed61367b8fd01bae1e18e30602c25060d824.tar.gz) | |

af\_unix: Fix memory leaks of the whole sk due to OOB skb.syzbot reported a sequence of memory leaks, and one of them indicated we
failed to free a whole sk:
unreferenced object 0xffff8880126e0000 (size 1088):
comm "syz-executor419", pid 326, jiffies 4294773607 (age 12.609s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 7d 00 00 00 00 00 00 00 ........}.......
01 00 07 40 00 00 00 00 00 00 00 00 00 00 00 00 ...@............
backtrace:
[<000000006fefe750>] sk\_prot\_alloc+0x64/0x2a0 net/core/sock.c:1970
[<0000000074006db5>] sk\_alloc+0x3b/0x800 net/core/sock.c:2029
[<00000000728cd434>] unix\_create1+0xaf/0x920 net/unix/af\_unix.c:928
[<00000000a279a139>] unix\_create+0x113/0x1d0 net/unix/af\_unix.c:997
[<0000000068259812>] \_\_sock\_create+0x2ab/0x550 net/socket.c:1516
[<00000000da1521e1>] sock\_create net/socket.c:1566 [inline]
[<00000000da1521e1>] \_\_sys\_socketpair+0x1a8/0x550 net/socket.c:1698
[<000000007ab259e1>] \_\_do\_sys\_socketpair net/socket.c:1751 [inline]
[<000000007ab259e1>] \_\_se\_sys\_socketpair net/socket.c:1748 [inline]
[<000000007ab259e1>] \_\_x64\_sys\_socketpair+0x97/0x100 net/socket.c:1748
[<000000007dedddc1>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<000000007dedddc1>] do\_syscall\_64+0x38/0x90 arch/x86/entry/common.c:80
[<000000009456679f>] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
We can reproduce this issue by creating two AF\_UNIX SOCK\_STREAM sockets,
send()ing an OOB skb to each other, and close()ing them without consuming
the OOB skbs.
int skpair[2];
socketpair(AF\_UNIX, SOCK\_STREAM, 0, skpair);
send(skpair[0], "x", 1, MSG\_OOB);
send(skpair[1], "x", 1, MSG\_OOB);
close(skpair[0]);
close(skpair[1]);
Currently, we free an OOB skb in unix\_sock\_destructor() which is called via
\_\_sk\_free(), but it's too late because the receiver's unix\_sk(sk)->oob\_skb
is accounted against the sender's sk->sk\_wmem\_alloc and \_\_sk\_free() is
called only when sk->sk\_wmem\_alloc is 0.
In the repro sequences, we do not consume the OOB skb, so both two sk's
sock\_put() never reach \_\_sk\_free() due to the positive sk->sk\_wmem\_alloc.
Then, no one can consume the OOB skb nor call \_\_sk\_free(), and we finally
leak the two whole sk.
Thus, we must free the unconsumed OOB skb earlier when close()ing the
socket.
Fixes: 314001f0bf92 ("af\_unix: Add OOB support")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/?id=7a62ed61367b8fd01bae1e18e30602c25060d824)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/diff/net/unix/af_unix.c?id=7a62ed61367b8fd01bae1e18e30602c25060d824) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 6 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex bf338b782fc4c4..d686804119c991 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/net/unix/af_unix.c?id=a91b750fd6629354460282bbf5146c01b05c4859)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/bpf/bpf-next.git/tree/net/unix/af_unix.c?id=7a62ed61367b8fd01bae1e18e30602c25060d824)@@ -569,12 +569,6 @@ static void unix\_sock\_destructor(struct sock \*sk)  skb\_queue\_purge(&sk->sk\_receive\_queue); -#if IS\_ENABLED(CONFIG\_AF\_UNIX\_OOB)- if (u->oob\_skb) {- kfree\_skb(u->oob\_skb);- u->oob\_skb = NULL;- }-#endif DEBUG\_NET\_WARN\_ON\_ONCE(refcount\_read(&sk->sk\_wmem\_alloc)); DEBUG\_NET\_WARN\_ON\_ONCE(!sk\_unhashed(sk)); DEBUG\_NET\_WARN\_ON\_ONCE(sk->sk\_socket);@@ -620,6 +614,13 @@ static void unix\_release\_sock(struct sock \*sk, int embrion)  unix\_state\_unlock(sk); +#if IS\_ENABLED(CONFIG\_AF\_UNIX\_OOB)+ if (u->oob\_skb) {+ kfree\_skb(u->oob\_skb);+ u->oob\_skb = NULL;+ }+#endif+ wake\_up\_interruptible\_all(&u->peer\_wait);  if (skpair != NULL) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:45:13 +0000


