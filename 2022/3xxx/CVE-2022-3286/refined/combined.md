=== Content from gitlab.com_55a6ab31_20250114_190228.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-3286.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-3286.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-3286.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-3286.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ðŸ¤– GitLab Bot ðŸ¤–'s avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "ðŸ¤– GitLab Bot ðŸ¤–")](/gitlab-bot)

  Oct 17, 2022

  [02bfb3ca](/gitlab-org/cves/-/commit/02bfb3ca88a4630c7b0987ec7084fea78ed0cac1)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/02bfb3ca88a4630c7b0987ec7084fea78ed0cac1)
  Â·
  02bfb3ca

  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored Oct 17, 2022

  02bfb3ca

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/02bfb3ca88a4630c7b0987ec7084fea78ed0cac1)
  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored Oct 17, 2022

Loading



=== Content from gitlab.com_d7a03413_20250114_190229.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# IP allow-list bypass when using Deploy Keys/Tokens to access the Dependency Proxy

### ðŸ›¡ Context

This issue was discovered when investigating the blast radius of <https://gitlab.com/gitlab-com/gl-infra/production/-/issues/7149>.

All related issues are confidential so this one is confidential too.

### ðŸ”¥ Problem

Groups access can be restricted by IP. See <https://docs.gitlab.com/ee/user/group/#restrict-group-access-by-ip-address>.

That restriction doesn't seem to be applied with Deploy Token pulling images through the [Dependency Proxy](https://docs.gitlab.com/ee/user/packages/dependency_proxy/).

We had a similar issue with the Container Registry access. See <https://gitlab.com/gitlab-org/gitlab/-/issues/363651>.

### ðŸ‘£ Steps to reproduce

1. Have GDK ready with registry support and a premium tier license.
2. Create a Group.
3. [Enforce](https://docs.gitlab.com/ee/user/group/#restrict-group-access-by-ip-address) IP `200.200.200.200` or any IP that your computer **doesn't** have.
4. Create a Group deploy token.
5. [Set up](https://docs.gitlab.com/ee/user/packages/dependency_proxy/#authenticate-with-the-dependency-proxy) the Dependency Proxy.
6. [Pull](https://docs.gitlab.com/ee/user/packages/dependency_proxy/#use-the-dependency-proxy-for-docker-images) a dummy image (such as `alpine:latest`) through the Dependency Proxy.
   ```
   $ docker pull <dependency_proxy_prefix>/alpine:latest
   ```
7. The pull operation is allowed and works. ðŸ’¥

### ðŸš’ Solution

Apply a solution similar to <https://gitlab.com/gitlab-org/security/gitlab/-/merge_requests/2470>:

* The dependency proxy authentication service should check for the `read_dependency_proxy` permission on the group policy using the target group.
* The group policy should be updated with lines similar to [these](https://gitlab.com/gitlab-org/security/gitlab/-/blob/71d7efea986db9dcde62ab4b276c2658ae1b65d9/app/policies/project_policy.rb#L95-103).
  + Use that condition to allow `read_dependency_proxy`. Similar to [these](https://gitlab.com/gitlab-org/security/gitlab/-/blob/71d7efea986db9dcde62ab4b276c2658ae1b65d9/app/policies/project_policy.rb#L707).
* Update the EE group policy to prevent `read_dependency_proxy` when the IP restriction is [triggered](https://gitlab.com/gitlab-org/gitlab/-/blob/c85953604d45f9b804c211058a8d6300a52c3e1d/ee/app/policies/ee/group_policy.rb#L365-366).

Because this can break the dependency proxy access, we need to be cautions on how to deploy this. This is the same situation as in <https://gitlab.com/gitlab-org/security/gitlab/-/merge_requests/2470>, thus we can use the same approach on [deployment](https://gitlab.com/gitlab-org/security/gitlab/-/merge_requests/2470#airplane-deployment).

Edited Jul 13, 2022 by [David Fernandez](/10io)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


