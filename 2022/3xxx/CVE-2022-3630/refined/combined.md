=== Content from git.kernel.org_532a88ce_20250114_223308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/klassert/ipsec-next.git](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/) | master testing |
| --- | --- | --- |
| Steffen Klassert's ipsec-next networking tree | Steffen Klassert |

| [about](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/about/)[summary](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/)[refs](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/refs/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)[log](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/log/)[tree](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)[commit](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)[diff](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)[stats](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jeff Layton <jlayton@kernel.org> | 2022-08-05 06:42:45 -0400 |
| --- | --- | --- |
| committer | David Howells <dhowells@redhat.com> | 2022-08-09 14:13:55 +0100 |
| commit | [fb24771faf72a2fd62b3b6287af3c610c3ec9cf1](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1) ([patch](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/patch/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)) | |
| tree | [ca92f6258605d877ac7155f86ca95d1e0499f3cd](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1) | |
| parent | [3d7cb6b04c3f3115719235cc6866b10326de34cd](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/commit/?id=3d7cb6b04c3f3115719235cc6866b10326de34cd) ([diff](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1&id2=3d7cb6b04c3f3115719235cc6866b10326de34cd)) | |
| download | [ipsec-next-fb24771faf72a2fd62b3b6287af3c610c3ec9cf1.tar.gz](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/snapshot/ipsec-next-fb24771faf72a2fd62b3b6287af3c610c3ec9cf1.tar.gz) | |

fscache: don't leak cookie access refs if invalidation is in progress or failedIt's possible for a request to invalidate a fscache\_cookie will come in
while we're already processing an invalidation. If that happens we
currently take an extra access reference that will leak. Only call
\_\_fscache\_begin\_cookie\_access if the FSCACHE\_COOKIE\_DO\_INVALIDATE bit
was previously clear.
Also, ensure that we attempt to clear the bit when the cookie is
"FAILED" and put the reference to avoid an access leak.
Fixes: 85e4ea1049c7 ("fscache: Fix invalidation/lookup race")
Suggested-by: David Howells <dhowells@redhat.com>
Signed-off-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: David Howells <dhowells@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)

| -rw-r--r-- | [fs/fscache/cookie.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/diff/fs/fscache/cookie.c?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/fscache/cookie.c b/fs/fscache/cookie.cindex 74920826d8f674..26a6d395737a60 100644--- a/[fs/fscache/cookie.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/fs/fscache/cookie.c?id=3d7cb6b04c3f3115719235cc6866b10326de34cd)+++ b/[fs/fscache/cookie.c](/pub/scm/linux/kernel/git/klassert/ipsec-next.git/tree/fs/fscache/cookie.c?id=fb24771faf72a2fd62b3b6287af3c610c3ec9cf1)@@ -739,6 +739,9 @@ again\_locked: fallthrough;  case FSCACHE\_COOKIE\_STATE\_FAILED:+ if (test\_and\_clear\_bit(FSCACHE\_COOKIE\_DO\_INVALIDATE, &cookie->flags))+ fscache\_end\_cookie\_access(cookie, fscache\_access\_invalidate\_cookie\_end);+ if (atomic\_read(&cookie->n\_accesses) != 0) break; if (test\_bit(FSCACHE\_COOKIE\_DO\_RELINQUISH, &cookie->flags)) {@@ -1063,8 +1066,8 @@ void \_\_fscache\_invalidate(struct fscache\_cookie \*cookie, return;  case FSCACHE\_COOKIE\_STATE\_LOOKING\_UP:- \_\_fscache\_begin\_cookie\_access(cookie, fscache\_access\_invalidate\_cookie);- set\_bit(FSCACHE\_COOKIE\_DO\_INVALIDATE, &cookie->flags);+ if (!test\_and\_set\_bit(FSCACHE\_COOKIE\_DO\_INVALIDATE, &cookie->flags))+ \_\_fscache\_begin\_cookie\_access(cookie, fscache\_access\_invalidate\_cookie); fallthrough; case FSCACHE\_COOKIE\_STATE\_CREATING: spin\_unlock(&cookie->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:31:45 +0000


