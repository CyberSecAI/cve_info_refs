=== Content from github.com_f2aea50a_20250114_194321.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkareadita%2Fkavita%2Fcommit%2F9c31f7e7c81b919923cb2e3857439ec0d16243e4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkareadita%2Fkavita%2Fcommit%2F9c31f7e7c81b919923cb2e3857439ec0d16243e4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Kareadita%2FKavita)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Kareadita](/Kareadita)
/
**[Kavita](/Kareadita/Kavita)**
Public

* [Notifications](/login?return_to=%2FKareadita%2FKavita) You must be signed in to change notification settings
* [Fork
  367](/login?return_to=%2FKareadita%2FKavita)
* [Star
   6.9k](/login?return_to=%2FKareadita%2FKavita)

* [Code](/Kareadita/Kavita)
* [Issues
  162](/Kareadita/Kavita/issues)
* [Pull requests
  14](/Kareadita/Kavita/pulls)
* [Discussions](/Kareadita/Kavita/discussions)
* [Actions](/Kareadita/Kavita/actions)
* [Projects
  2](/Kareadita/Kavita/projects)
* [Wiki](/Kareadita/Kavita/wiki)
* [Security](/Kareadita/Kavita/security)
* [Insights](/Kareadita/Kavita/pulse)

Additional navigation options

* [Code](/Kareadita/Kavita)
* [Issues](/Kareadita/Kavita/issues)
* [Pull requests](/Kareadita/Kavita/pulls)
* [Discussions](/Kareadita/Kavita/discussions)
* [Actions](/Kareadita/Kavita/actions)
* [Projects](/Kareadita/Kavita/projects)
* [Wiki](/Kareadita/Kavita/wiki)
* [Security](/Kareadita/Kavita/security)
* [Insights](/Kareadita/Kavita/pulse)

## Commit

[Permalink](/Kareadita/Kavita/commit/9c31f7e7c81b919923cb2e3857439ec0d16243e4)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

v0.5.4.1 - Security Hotfix ([#1414](https://github.com/Kareadita/Kavita/pull/1414))

[Browse files](/Kareadita/Kavita/tree/9c31f7e7c81b919923cb2e3857439ec0d16243e4)
Browse the repository at this point in the history

```
* Updated our security file with our Huntr.

* Fixed a security vulnerability where through the API, an unauthorized user could delete/modify reading lists that did not belong to them.

Fixed a bug where when creating a reading list with the name of another users, the API would throw an exception (but reading list would still get created)

* Fixed a security vulnerability where through the API, an unauthorized user could delete/modify reading lists that did not belong to them.

Fixed a bug where when creating a reading list with the name of another users, the API would throw an exception (but reading list would still get created)

* Ensure all reading list apis are authorized

* Ensured all APIs require authentication, except those that explicitly don't. All APIs are default requiring Authentication.

Fixed a security vulnerability which would allow a user to take over an admin account.

* Fixed a bug where cover-upload would accept filenames that were not expected.

* Explicitly check that a user has access to the pdf file before we serve it back.

* Enabled lock out when invalid user auth occurs. After 5 invalid auths, the user account will be locked out for 10 mins.

* Version bump for hotfix release
```

* Loading branch information

[![@majora2007](https://avatars.githubusercontent.com/u/735851?s=40&v=4)](/majora2007)

[majora2007](/Kareadita/Kavita/commits?author=majora2007 "View all commits by majora2007")
authored
Aug 8, 2022

1 parent
[6d0b18c](/Kareadita/Kavita/commit/6d0b18c98fa088d8d967469aa556c5dd5f26d516)

commit 9c31f7e

 Show file tree

 Hide file tree

Showing
**16 changed files**
with
**171 additions**
and
**50 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* API

  + Controllers

    - API/Controllers/AccountController.cs
      [AccountController.cs](#diff-acd0f988134115c08bdb588219f6fff7e400ab249b35fa5fe02e8547a8b6155f)
    - API/Controllers/AdminController.cs
      [AdminController.cs](#diff-7b5d23a0bc4b2a6390e33ffa6a7997eabbb285221d72507a6490385b7f864c14)
    - API/Controllers/BaseApiController.cs
      [BaseApiController.cs](#diff-9e2521ab431063be296c48f1d83350ea666a1115be1796bd99523f869ae85044)
    - API/Controllers/FallbackController.cs
      [FallbackController.cs](#diff-0a1e0fdce5c28ddac5cbc04e7906219e05f37e0b2ba3f1ad16351ae797f1428b)
    - API/Controllers/ImageController.cs
      [ImageController.cs](#diff-eff3a75e32bfc227b052a27fe60c8b6202d9d2369aa4833392b06e0fb84b24e3)
    - API/Controllers/OPDSController.cs
      [OPDSController.cs](#diff-9d81ba6204bd8cc474e19bb084ab8839c7130dd0799dc31924ef146649abac0c)
    - API/Controllers/ReaderController.cs
      [ReaderController.cs](#diff-c952e780744f9ee8994dfce1aac5d9ab2cb491cd0e7d7ea4b9ea2ae86660cb59)
    - API/Controllers/ReadingListController.cs
      [ReadingListController.cs](#diff-569f38a4914e8801b5e4446b795bd4519c73cb470fe348a47933c6de44812c56)
    - API/Controllers/ThemeController.cs
      [ThemeController.cs](#diff-3bdac638fcbcf7a1c8249f2a78b9f18f849f404e71765b025aae5f7b2a010723)
    - API/Controllers/UploadController.cs
      [UploadController.cs](#diff-5663dcf200bb54bff5433a5966b2e88f74d9edf79cb87e0a5b4dc6798bec7976)
  + Data/Repositories

    - API/Data/Repositories/ReadingListRepository.cs
      [ReadingListRepository.cs](#diff-1a8215a08e2de2d44449dd7087c2cd10147a86e9447ae1c84c27adf12496c1dc)
  + Extensions

    - API/Extensions/IdentityServiceExtensions.cs
      [IdentityServiceExtensions.cs](#diff-298ab3cbf7cf3161f81b556907f91545928933b563adacfa6761dfdc90779558)
  + Services

    - API/Services/ImageService.cs
      [ImageService.cs](#diff-5c154a6dc2c34d4d35cb4f411291bcd41dddce3f840d5b81603d7362e67c7123)
* Kavita.Common

  + Kavita.Common/Kavita.Common.csproj
    [Kavita.Common.csproj](#diff-3836a0afe8eb70c0de5ffb2c4917416d7442f2accaa9dd21737a847aa0127de4)
* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* SECURITY.md
  [SECURITY.md](#diff-f6ed156e4bf5c791680662464b94ea5d753f219ee816b385f67870e2c0d7d4c7)

## There are no files selected for viewing

26 changes: 19 additions & 7 deletions

26
[API/Controllers/AccountController.cs](#diff-acd0f988134115c08bdb588219f6fff7e400ab249b35fa5fe02e8547a8b6155f "API/Controllers/AccountController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/AccountController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -70,13 +70,21 @@ public AccountController(UserManager<AppUser> userManager, |
|  |  | /// </summary> |
|  |  | /// <param name="resetPasswordDto"></param> |
|  |  | /// <returns></returns> |
|  |  | [AllowAnonymous] |
|  |  | [HttpPost("reset-password")] |
|  |  | public async Task<ActionResult> UpdatePassword(ResetPasswordDto resetPasswordDto) |
|  |  | { |
|  |  | // TODO: Log this request to Audit Table |
|  |  | \_logger.LogInformation("{UserName} is changing {ResetUser}'s password", User.GetUsername(), resetPasswordDto.UserName); |
|  |  | var user = await \_userManager.Users.SingleAsync(x => x.UserName == resetPasswordDto.UserName); |
|  |  |  |
|  |  | if (resetPasswordDto.UserName != User.GetUsername() && !(User.IsInRole(PolicyConstants.AdminRole) || User.IsInRole(PolicyConstants.ChangePasswordRole))) |
|  |  | var user = await \_userManager.Users.SingleOrDefaultAsync(x => x.UserName == resetPasswordDto.UserName); |
|  |  | if (user == null) return Ok(); // Don't report BadRequest as that would allow brute forcing to find accounts on system |
|  |  |  |
|  |  |  |
|  |  | if (resetPasswordDto.UserName == User.GetUsername() && !(User.IsInRole(PolicyConstants.ChangePasswordRole) || User.IsInRole(PolicyConstants.AdminRole))) |
|  |  | return Unauthorized("You are not permitted to this operation."); |
|  |  |  |
|  |  | if (resetPasswordDto.UserName != User.GetUsername() && !User.IsInRole(PolicyConstants.AdminRole)) |
|  |  | return Unauthorized("You are not permitted to this operation."); |
|  |  |  |
|  |  | var errors = await \_accountService.ChangeUserPassword(user, resetPasswordDto.Password); |
| Expand All | | @@ -94,6 +102,7 @@ public async Task<ActionResult> UpdatePassword(ResetPasswordDto resetPasswordDto |
|  |  | /// </summary> |
|  |  | /// <param name="registerDto"></param> |
|  |  | /// <returns></returns> |
|  |  | [AllowAnonymous] |
|  |  | [HttpPost("register")] |
|  |  | public async Task<ActionResult<UserDto>> RegisterFirstUser(RegisterDto registerDto) |
|  |  | { |
| Expand Down  Expand Up | | @@ -155,6 +164,7 @@ public async Task<ActionResult<UserDto>> RegisterFirstUser(RegisterDto registerD |
|  |  | /// </summary> |
|  |  | /// <param name="loginDto"></param> |
|  |  | /// <returns></returns> |
|  |  | [AllowAnonymous] |
|  |  | [HttpPost("login")] |
|  |  | public async Task<ActionResult<UserDto>> Login(LoginDto loginDto) |
|  |  | { |
| Expand All | | @@ -173,14 +183,14 @@ public async Task<ActionResult<UserDto>> Login(LoginDto loginDto) |
|  |  | "You are missing an email on your account. Please wait while we migrate your account."); |
|  |  | } |
|  |  |  |
|  |  | if (!validPassword) |
|  |  | var result = await \_signInManager |
|  |  | .CheckPasswordSignInAsync(user, loginDto.Password, true); |
|  |  |  |
|  |  | if (result.IsLockedOut) |
|  |  | { |
|  |  | return Unauthorized("Your credentials are not correct"); |
|  |  | return Unauthorized("You've been locked out from too many authorization attempts. Please wait 10 minutes."); |
|  |  | } |
|  |  |  |
|  |  | var result = await \_signInManager |
|  |  | .CheckPasswordSignInAsync(user, loginDto.Password, false); |
|  |  |  |
|  |  | if (!result.Succeeded) |
|  |  | { |
|  |  | return Unauthorized(result.IsNotAllowed ? "You must confirm your email first" : "Your credentials are not correct."); |
| Expand Down  Expand Up | | @@ -212,6 +222,7 @@ public async Task<ActionResult<UserDto>> Login(LoginDto loginDto) |
|  |  | /// </summary> |
|  |  | /// <param name="tokenRequestDto"></param> |
|  |  | /// <returns></returns> |
|  |  | [AllowAnonymous] |
|  |  | [HttpPost("refresh-token")] |
|  |  | public async Task<ActionResult<TokenRequestDto>> RefreshToken([FromBody] TokenRequestDto tokenRequestDto) |
|  |  | { |
| Expand Down  Expand Up | | @@ -462,6 +473,7 @@ await \_emailService.SendConfirmationEmail(new ConfirmationEmailDto() |
|  |  | return BadRequest("There was an error setting up your account. Please check the logs"); |
|  |  | } |
|  |  |  |
|  |  | [AllowAnonymous] |
|  |  | [HttpPost("confirm-email")] |
|  |  | public async Task<ActionResult<UserDto>> ConfirmEmail(ConfirmEmailDto dto) |
|  |  | { |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[API/Controllers/AdminController.cs](#diff-7b5d23a0bc4b2a6390e33ffa6a7997eabbb285221d72507a6490385b7f864c14 "API/Controllers/AdminController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/AdminController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,6 @@ |
|  |  | ﻿using System.Threading.Tasks; |
|  |  | using API.Entities; |
|  |  | using Microsoft.AspNetCore.Authorization; |
|  |  | using Microsoft.AspNetCore.Identity; |
|  |  | using Microsoft.AspNetCore.Mvc; |
|  |  |  |
| Expand All | | @@ -18,6 +19,7 @@ public AdminController(UserManager<AppUser> userManager) |
|  |  | /// Checks if an admin exists on the system. This is essentially a check to validate if the system has been setup. |
|  |  | /// </summary> |
|  |  | /// <returns></returns> |
|  |  | [AllowAnonymous] |
|  |  | [HttpGet("exists")] |
|  |  | public async Task<ActionResult<bool>> AdminExists() |
|  |  | { |
| Expand Down | |  |

6 changes: 4 additions & 2 deletions

6
[API/Controllers/BaseApiController.cs](#diff-9e2521ab431063be296c48f1d83350ea666a1115be1796bd99523f869ae85044 "API/Controllers/BaseApiController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/BaseApiController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,10 +1,12 @@ |
|  |  | ﻿using Microsoft.AspNetCore.Mvc; |
|  |  | ﻿using Microsoft.AspNetCore.Authorization; |
|  |  | using Microsoft.AspNetCore.Mvc; |
|  |  |  |
|  |  | namespace API.Controllers |
|  |  | { |
|  |  | [ApiController] |
|  |  | [Route("api/[controller]")] |
|  |  | [Authorize] |
|  |  | public class BaseApiController : ControllerBase |
|  |  | { |
|  |  | } |
|  |  | } |
|  |  | } |

32 changes: 17 additions & 15 deletions

32
[API/Controllers/FallbackController.cs](#diff-0a1e0fdce5c28ddac5cbc04e7906219e05f37e0b2ba3f1ad16351ae797f1428b "API/Controllers/FallbackController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/FallbackController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,24 +1,26 @@ |
|  |  | ﻿using System.IO; |
|  |  | using API.Services; |
|  |  | using Microsoft.AspNetCore.Authorization; |
|  |  | using Microsoft.AspNetCore.Mvc; |
|  |  |  |
|  |  | namespace API.Controllers |
|  |  | namespace API.Controllers; |
|  |  |  |
|  |  | [AllowAnonymous] |
|  |  | public class FallbackController : Controller |
|  |  | { |
|  |  | public class FallbackController : Controller |
|  |  | { |
|  |  | // ReSharper disable once S4487 |
|  |  | // ReSharper disable once NotAccessedField.Local |
|  |  | private readonly ITaskScheduler \_taskScheduler; |
|  |  | // ReSharper disable once S4487 |
|  |  | // ReSharper disable once NotAccessedField.Local |
|  |  | private readonly ITaskScheduler \_taskScheduler; |
|  |  |  |
|  |  | public FallbackController(ITaskScheduler taskScheduler) |
|  |  | { |
|  |  | // This is used to load TaskScheduler on startup without having to navigate to a Controller that uses. |
|  |  | \_taskScheduler = taskScheduler; |
|  |  | } |
|  |  | public FallbackController(ITaskScheduler taskScheduler) |
|  |  | { |
|  |  | // This is used to load TaskScheduler on startup without having to navigate to a Controller that uses. |
|  |  | \_taskScheduler = taskScheduler; |
|  |  | } |
|  |  |  |
|  |  | public ActionResult Index() |
|  |  | { |
|  |  | return PhysicalFile(Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "index.html"), "text/HTML"); |
|  |  | } |
|  |  | public ActionResult Index() |
|  |  | { |
|  |  | return PhysicalFile(Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "index.html"), "text/HTML"); |
|  |  | } |
|  |  | } |
|  |  |  |

2 changes: 2 additions & 0 deletions

2
[API/Controllers/ImageController.cs](#diff-eff3a75e32bfc227b052a27fe60c8b6202d9d2369aa4833392b06e0fb84b24e3 "API/Controllers/ImageController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/ImageController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -137,6 +137,8 @@ public async Task<ActionResult> GetBookmarkImage(int chapterId, int pageNum, str |
|  |  | [HttpGet("cover-upload")] |
|  |  | public ActionResult GetCoverUploadImage(string filename) |
|  |  | { |
|  |  | if (filename.Contains("..")) return BadRequest("Invalid Filename"); |
|  |  |  |
|  |  | var path = Path.Join(\_directoryService.TempDirectory, filename); |
|  |  | if (string.IsNullOrEmpty(path) || !\_directoryService.FileSystem.File.Exists(path)) return BadRequest($"File does not exist"); |
|  |  | var format = \_directoryService.FileSystem.Path.GetExtension(path).Replace(".", ""); |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[API/Controllers/OPDSController.cs](#diff-9d81ba6204bd8cc474e19bb084ab8839c7130dd0799dc31924ef146649abac0c "API/Controllers/OPDSController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/OPDSController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,10 +17,12 @@ |
|  |  | using API.Helpers; |
|  |  | using API.Services; |
|  |  | using Kavita.Common; |
|  |  | using Microsoft.AspNetCore.Authorization; |
|  |  | using Microsoft.AspNetCore.Mvc; |
|  |  |  |
|  |  | namespace API.Controllers; |
|  |  |  |
|  |  | [AllowAnonymous] |
|  |  | public class OpdsController : BaseApiController |
|  |  | { |
|  |  | private readonly IUnitOfWork \_unitOfWork; |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[API/Controllers/ReaderController.cs](#diff-c952e780744f9ee8994dfce1aac5d9ab2cb491cd0e7d7ea4b9ea2ae86660cb59 "API/Controllers/ReaderController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/ReaderController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -57,6 +57,11 @@ public async Task<ActionResult> GetPdf(int chapterId) |
|  |  | var chapter = await \_cacheService.Ensure(chapterId); |
|  |  | if (chapter == null) return BadRequest("There was an issue finding pdf file for reading"); |
|  |  |  |
|  |  | // Validate the user has access to the PDF |
|  |  | var series = await \_unitOfWork.SeriesRepository.GetSeriesForChapter(chapter.Id, |
|  |  | await \_unitOfWork.UserRepository.GetUserIdByUsernameAsync(User.GetUsername())); |
|  |  | if (series == null) return BadRequest("Invalid Access"); |
|  |  |  |
|  |  | try |
|  |  | { |
|  |  | var path = \_cacheService.GetCachedFile(chapter); |
| Expand Down | |  |

91 changes: 72 additions & 19 deletions

91
[API/Controllers/ReadingListController.cs](#diff-569f38a4914e8801b5e4446b795bd4519c73cb470fe348a47933c6de44812c56 "API/Controllers/ReadingListController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/ReadingListController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,15 +3,18 @@ |
|  |  | using System.Threading.Tasks; |
|  |  | using API.Comparators; |
|  |  | using API.Data; |
|  |  | using API.Data.Repositories; |
|  |  | using API.DTOs.ReadingLists; |
|  |  | using API.Entities; |
|  |  | using API.Extensions; |
|  |  | using API.Helpers; |
|  |  | using API.SignalR; |
|  |  | using Microsoft.AspNetCore.Authorization; |
|  |  | using Microsoft.AspNetCore.Mvc; |
|  |  |  |
|  |  | namespace API.Controllers |
|  |  | { |
|  |  | [Authorize] |
|  |  | public class ReadingListController : BaseApiController |
|  |  | { |
|  |  | private readonly IUnitOfWork \_unitOfWork; |
| Expand Down  Expand Up | | @@ -73,8 +76,18 @@ public async Task<ActionResult<IEnumerable<ReadingListItemDto>>> GetListForUser( |
|  |  | var userId = await \_unitOfWork.UserRepository.GetUserIdByUsernameAsync(User.GetUsername()); |
|  |  | var items = await \_unitOfWork.ReadingListRepository.GetReadingListItemDtosByIdAsync(readingListId, userId); |
|  |  | return Ok(items); |
|  |  | } |
|  |  |  |
|  |  | private async Task<AppUser?> UserHasReadingListAccess(int readingListId) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserByUsernameAsync(User.GetUsername(), |
|  |  | AppUserIncludes.ReadingLists); |
|  |  | if (user.ReadingLists.SingleOrDefault(rl => rl.Id == readingListId) == null && !await \_unitOfWork.UserRepository.IsUserAdminAsync(user)) |
|  |  | { |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | //return Ok(await \_unitOfWork.ReadingListRepository.AddReadingProgressModifiers(userId, items.ToList())); |
|  |  | return user; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -86,6 +99,11 @@ public async Task<ActionResult<IEnumerable<ReadingListItemDto>>> GetListForUser( |
|  |  | public async Task<ActionResult> UpdateListItemPosition(UpdateReadingListPosition dto) |
|  |  | { |
|  |  | // Make sure UI buffers events |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  | var items = (await \_unitOfWork.ReadingListRepository.GetReadingListItemsByIdAsync(dto.ReadingListId)).ToList(); |
|  |  | var item = items.Find(r => r.Id == dto.ReadingListItemId); |
|  |  | items.Remove(item); |
| Expand All | | @@ -112,10 +130,15 @@ public async Task<ActionResult> UpdateListItemPosition(UpdateReadingListPosition |
|  |  | [HttpPost("delete-item")] |
|  |  | public async Task<ActionResult> DeleteListItem(UpdateReadingListPosition dto) |
|  |  | { |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  |  |
|  |  | var readingList = await \_unitOfWork.ReadingListRepository.GetReadingListByIdAsync(dto.ReadingListId); |
|  |  | readingList.Items = readingList.Items.Where(r => r.Id != dto.ReadingListItemId).ToList(); |
|  |  |  |
|  |  |  |
|  |  | var index = 0; |
|  |  | foreach (var readingListItem in readingList.Items) |
|  |  | { |
| Expand All | | @@ -141,9 +164,14 @@ public async Task<ActionResult> DeleteListItem(UpdateReadingListPosition dto) |
|  |  | [HttpPost("remove-read")] |
|  |  | public async Task<ActionResult> DeleteReadFromList([FromQuery] int readingListId) |
|  |  | { |
|  |  | var userId = await \_unitOfWork.UserRepository.GetUserIdByUsernameAsync(User.GetUsername()); |
|  |  | var items = await \_unitOfWork.ReadingListRepository.GetReadingListItemDtosByIdAsync(readingListId, userId); |
|  |  | items = await \_unitOfWork.ReadingListRepository.AddReadingProgressModifiers(userId, items.ToList()); |
|  |  | var user = await UserHasReadingListAccess(readingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  |  |
|  |  | var items = await \_unitOfWork.ReadingListRepository.GetReadingListItemDtosByIdAsync(readingListId, user.Id); |
|  |  | items = await \_unitOfWork.ReadingListRepository.AddReadingProgressModifiers(user.Id, items.ToList()); |
|  |  |  |
|  |  | // Collect all Ids to remove |
|  |  | var itemIdsToRemove = items.Where(item => item.PagesRead == item.PagesTotal).Select(item => item.Id); |
| Expand Down  Expand Up | | @@ -176,15 +204,13 @@ public async Task<ActionResult> DeleteReadFromList([FromQuery] int readingListId |
|  |  | [HttpDelete] |
|  |  | public async Task<ActionResult> DeleteList([FromQuery] int readingListId) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserWithReadingListsByUsernameAsync(User.GetUsername()); |
|  |  | var isAdmin = await \_unitOfWork.UserRepository.IsUserAdminAsync(user); |
|  |  | var readingList = user.ReadingLists.SingleOrDefault(r => r.Id == readingListId); |
|  |  | if (readingList == null && !isAdmin) |
|  |  | var user = await UserHasReadingListAccess(readingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("User is not associated with this reading list"); |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  |  |
|  |  | readingList = await \_unitOfWork.ReadingListRepository.GetReadingListByIdAsync(readingListId); |
|  |  | var readingList = await \_unitOfWork.ReadingListRepository.GetReadingListByIdAsync(readingListId); |
|  |  |  |
|  |  | user.ReadingLists.Remove(readingList); |
|  |  |  |
| Expand Down  Expand Up | | @@ -213,13 +239,14 @@ public async Task<ActionResult<ReadingListDto>> CreateList(CreateReadingListDto |
|  |  | return BadRequest("A list of this name already exists"); |
|  |  | } |
|  |  |  |
|  |  | user.ReadingLists.Add(DbFactory.ReadingList(dto.Title, string.Empty, false)); |
|  |  | var readingList = DbFactory.ReadingList(dto.Title, string.Empty, false); |
|  |  | user.ReadingLists.Add(readingList); |
|  |  |  |
|  |  | if (!\_unitOfWork.HasChanges()) return BadRequest("There was a problem creating list"); |
|  |  |  |
|  |  | await \_unitOfWork.CommitAsync(); |
|  |  |  |
|  |  | return Ok(await \_unitOfWork.ReadingListRepository.GetReadingListDtoByTitleAsync(dto.Title)); |
|  |  | return Ok(await \_unitOfWork.ReadingListRepository.GetReadingListDtoByTitleAsync(user.Id, dto.Title)); |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -233,7 +260,11 @@ public async Task<ActionResult> UpdateList(UpdateReadingListDto dto) |
|  |  | var readingList = await \_unitOfWork.ReadingListRepository.GetReadingListByIdAsync(dto.ReadingListId); |
|  |  | if (readingList == null) return BadRequest("List does not exist"); |
|  |  |  |
|  |  |  |
|  |  | var user = await UserHasReadingListAccess(readingList.Id); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  |  |
|  |  | if (!string.IsNullOrEmpty(dto.Title)) |
|  |  | { |
| Expand Down  Expand Up | | @@ -277,7 +308,12 @@ await \_eventHub.SendMessageAsync(MessageFactory.CoverUpdate, |
|  |  | [HttpPost("update-by-series")] |
|  |  | public async Task<ActionResult> UpdateListBySeries(UpdateReadingListBySeriesDto dto) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserWithReadingListsByUsernameAsync(User.GetUsername()); |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  |  |
|  |  | var readingList = user.ReadingLists.SingleOrDefault(l => l.Id == dto.ReadingListId); |
|  |  | if (readingList == null) return BadRequest("Reading List does not exist"); |
|  |  | var chapterIdsForSeries = |
| Expand Down  Expand Up | | @@ -314,7 +350,11 @@ public async Task<ActionResult> UpdateListBySeries(UpdateReadingListBySeriesDto |
|  |  | [HttpPost("update-by-multiple")] |
|  |  | public async Task<ActionResult> UpdateListByMultiple(UpdateReadingListByMultipleDto dto) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserWithReadingListsByUsernameAsync(User.GetUsername()); |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  | var readingList = user.ReadingLists.SingleOrDefault(l => l.Id == dto.ReadingListId); |
|  |  | if (readingList == null) return BadRequest("Reading List does not exist"); |
|  |  |  |
| Expand Down  Expand Up | | @@ -354,7 +394,11 @@ public async Task<ActionResult> UpdateListByMultiple(UpdateReadingListByMultiple |
|  |  | [HttpPost("update-by-multiple-series")] |
|  |  | public async Task<ActionResult> UpdateListByMultipleSeries(UpdateReadingListByMultipleSeriesDto dto) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserWithReadingListsByUsernameAsync(User.GetUsername()); |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  | var readingList = user.ReadingLists.SingleOrDefault(l => l.Id == dto.ReadingListId); |
|  |  | if (readingList == null) return BadRequest("Reading List does not exist"); |
|  |  |  |
| Expand Down  Expand Up | | @@ -388,9 +432,14 @@ public async Task<ActionResult> UpdateListByMultipleSeries(UpdateReadingListByMu |
|  |  | [HttpPost("update-by-volume")] |
|  |  | public async Task<ActionResult> UpdateListByVolume(UpdateReadingListByVolumeDto dto) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserWithReadingListsByUsernameAsync(User.GetUsername()); |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  | var readingList = user.ReadingLists.SingleOrDefault(l => l.Id == dto.ReadingListId); |
|  |  | if (readingList == null) return BadRequest("Reading List does not exist"); |
|  |  |  |
|  |  | var chapterIdsForVolume = |
|  |  | (await \_unitOfWork.ChapterRepository.GetChaptersAsync(dto.VolumeId)).Select(c => c.Id).ToList(); |
|  |  |  |
| Expand Down  Expand Up | | @@ -419,7 +468,11 @@ public async Task<ActionResult> UpdateListByVolume(UpdateReadingListByVolumeDto |
|  |  | [HttpPost("update-by-chapter")] |
|  |  | public async Task<ActionResult> UpdateListByChapter(UpdateReadingListByChapterDto dto) |
|  |  | { |
|  |  | var user = await \_unitOfWork.UserRepository.GetUserWithReadingListsByUsernameAsync(User.GetUsername()); |
|  |  | var user = await UserHasReadingListAccess(dto.ReadingListId); |
|  |  | if (user == null) |
|  |  | { |
|  |  | return BadRequest("You do not have permissions on this reading list or the list doesn't exist"); |
|  |  | } |
|  |  | var readingList = user.ReadingLists.SingleOrDefault(l => l.Id == dto.ReadingListId); |
|  |  | if (readingList == null) return BadRequest("Reading List does not exist"); |
|  |  |  |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[API/Controllers/ThemeController.cs](#diff-3bdac638fcbcf7a1c8249f2a78b9f18f849f404e71765b025aae5f7b2a010723 "API/Controllers/ThemeController.cs")

Show comments

[View file](/Kareadita/Kavita/blob/9c31f7e7c81b919923cb2e3857439ec0d16243e4/API/Controllers/ThemeController.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,6 +24,7 @@ public ThemeController(IUnitOfWork unitOfWork, IThemeService themeService, ITask |
|  |  | \_taskScheduler = taskScheduler; |
|  |  | } |
|  |  |  |
|  |  | [AllowAnonymous] |
|  |  | [HttpGet] |
|  |  | public async Task<ActionResult<IEnumerable<SiteThemeDto>>> GetThemes() |
|  |  | { |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9c31f7e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkareadita%2Fkavita%2Fcommit%2F9c31f7e7c81b919923cb2e3857439ec0d16243e4) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from huntr.dev_d89d5a01_20250114_194321.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)
