=== Content from gitlab.com_7f491d6e_20250115_102806.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# CSP-bypass XSS in project settings page

**[HackerOne report #1588732](https://hackerone.com/reports/1588732)** by `yvvdwf` on 2022-06-01, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

This javascript [function](https://gitlab.com/gitlab-org/gitlab/-/blob/85fbd72dc08bcedcb9fe80fad4df798e9527ded8/app/assets/javascripts/projects/settings/access_dropdown.js#L534) is vulnerable:

```
  deployKeyRowHtml(key, isActive) {
    const isActiveClass = isActive || '';

    return `
      <li>
        <a href="#" class="${isActiveClass}">
          <strong>${key.title}</strong>
          <p>
            ${sprintf(
              __('Owned by %{image_tag}'),
              {
                image_tag: `<img src="${key.avatar_url}" class="avatar avatar-inline s26" width="30">`,
              },
              false,
            )}
            <strong class="dropdown-menu-user-full-name gl-display-inline">${escape(
              key.fullname,
            )}</strong>
            <span class="dropdown-menu-user-username gl-display-inline">${key.username}</span>
          </p>
        </a>
      </li>
    `;
  }
```

It is used to render a deployment key in a dropdown item. Because the deployment title is controlled by users, it can be any html content, such as, `<script>alert(document.domain)</script>`. Furthermore, the html content will be [rendered](https://gitlab.com/gitlab-org/gitlab/-/blob/85fbd72dc08bcedcb9fe80fad4df798e9527ded8/app/assets/javascripts/deprecated_jquery_dropdown/gl_dropdown.js#L396) using jQuery, so the `<script>` tag will be executed despise of CSP with `script-src`  having `'strict-dynamic'` value:

```
  renderMenu(html) {
    if (this.options.renderMenu) {
      return this.options.renderMenu(html);
    }
    return $('<ul>').append(html);
  }
```

##### Steps to reproduce

1. In an existing project or create a new one, goto `Settings`/`Repository`. Then fill the form in `Deploy keys` as the following:

* `Title`: `test <script>alert(document.domain)</script>`
* `Key`: `ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCkhkyrQJvb30Q5lLZzxeALqCyBrLOh+QzRYWh+gPGpqi2efyGMf5beN2zda66OI6DaclB31SJ0jYzaYKgKXQw7rzu/IYazONdy5lz5O2iUB2BkDzJYZ+BObTaTCjyDgSvNNuezUqNXXqoXftEMa1l0+FRSkTusH5F2P3JCV3Tf1BBQImrbDIpdc6ps+UxsiX7S/dT+7bNIVXblC8s8k+AK4CWsC2KmfMToK35pk+sa9JI+rb26hzv8IHA8n7cqXOmR5qAj2qX962p1kOLNXCyHJAKAIfRXCuDPbXiB+kjnu478eIcudOPveo3CK3G6hBI0hPSRfoyAUIubcddnnbhR`
* `Grant write permissions to this key`: Checked

Then click `Add key` button to save the form.

[![1.setting-deployment-key.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f5f4c8fb2ed38730f97f3e2e82ef9a0e3a708eb3/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31303065303039312d633536302d343435382d623838332d3862636336386638383637372f312e73657474696e672d6465706c6f796d656e742d6b65792e706e67)

**NOTE**:

* `Title` can be any HTML content that represents the attack payload. In the example above, we just show an alert containing the current domain.
* `Key` can be any valid SSH public key. In the example above, I give you a random key so that you can copy-paste into the form without the need to generate a key

2. Always in the `Settings`/`Repository` page, click on `Protected branches` link to expand its form
3. Click on the dropdown box under `Allowed to push` , you should see an alert that was generated when the payload above being executed

[![2.trigger-xss.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6215a23abd5e9fc7535265d936b5fce9750333fd/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62316331653031392d393735662d346362352d616663632d6565376666633933636564612f322e747269676765722d7873732e706e67)

**NOTE**:

* This is not self-XSS as any project maintainer can access to the settings page. Furthermore a victim can be added as a project maintainer without their explicit acceptation
* The Step 2 can be ignored by accessing directly within `#js-protected-branches-settings` on the url, for example, `https://gitlab.com/yvvdwf/xss/-/settings/repository#js-protected-branches-settings`

##### Impact

XSS with CSP bypass allows attacks to perform arbitrary malicious requests on behalf of victims on HTTP client side, such as, do an API request to access to private resources, etc.

##### Examples

<https://gitlab.com/yvvdwf/xss/-/settings/repository#js-protected-branches-settings>

##### What is the current *bug* behavior?

Deployment title is not sanitized

##### What is the expected *correct* behavior?

Deployment title should be sanitized

##### Output of checks

This bug happens on GitLab.com

#### Impact

XSS with CSP bypass allows attacks to perform arbitrary malicious requests on behalf of victims on HTTP client side, such as, do an API request to access to private resources, etc.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [1.setting-deployment-key.png](https://h1.sec.gitlab.net/a/100e0091-c560-4458-b883-8bcc68f88677/1.setting-deployment-key.png)
* [2.trigger-xss.png](https://h1.sec.gitlab.net/a/b1c1e019-975f-4cb5-afcc-ee7ffc93ceda/2.trigger-xss.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_b347a04b_20250115_102805.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-2230.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-2230.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-2230.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-2230.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Jul 01, 2022

  [04c8261f](/gitlab-org/cves/-/commit/04c8261f48d0715a10d74c9b1d15b7407892af45)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/04c8261f48d0715a10d74c9b1d15b7407892af45)
  ·
  04c8261f

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Jul 01, 2022

  04c8261f

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/04c8261f48d0715a10d74c9b1d15b7407892af45)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Jul 01, 2022

Loading


