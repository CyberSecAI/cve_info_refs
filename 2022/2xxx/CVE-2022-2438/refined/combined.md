=== Content from plugins.trac.wordpress.org_d744824d_20250114_235156.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2757773%2Fbroken-link-checker%2Ftrunk%2Fcore%2Fcore.php%3Fold%3D2605914%26old_path%3Dbroken-link-checker%252Ftrunk%252Fcore%252Fcore.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2605914/broken-link-checker/trunk/core/core.php?old=2757773&old_path=%2Fbroken-link-checker%2Ftrunk%2Fcore%2Fcore.php)

---

# Changes in [broken-link-checker/trunk/core/core.php](/browser/broken-link-checker/trunk/core/core.php?rev=2757773 "Show entry in browser") [[2605914:2757773]](/log/broken-link-checker/trunk/core/core.php?rev=2757773&stop_rev=2605914 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [broken-link-checker/trunk/core/core.php](/browser/broken-link-checker/trunk/core/core.php?rev=2757773 "Show entry in browser")
  (modified)
  ([148 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [broken-link-checker/trunk/core/core.php](/changeset/2757773/broken-link-checker/trunk/core/core.php?old=2605914&old_path=broken-link-checker%2Ftrunk%2Fcore%2Fcore.php "Show the [2605914:2757773] differences restricted to broken-link-checker/trunk/core/core.php")

  | [r2605914](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L431 "Show revision 2605914 of this file in browser") | [r2757773](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L431 "Show revision 2757773 of this file in browser") |  |
  | --- | --- | --- |
  | 431 | 431 | \* on the plugin list. |
  | 432 | 432 | \* |
  | 433 |  | \* @param array $links |
  |  | 433 | \* @param array  $links |
  | 434 | 434 | \* @param string $file |
  | 435 | 435 | \* @return array |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L494) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L494) |  |
  | 494 | 494 | $enabled\_post\_statuses = array(); |
  | 495 | 495 | } |
  | 496 |  | //At least one status must be enabled; defaults to "Published". |
  |  | 496 | // At least one status must be enabled; defaults to "Published". |
  | 497 | 497 | if ( empty( $enabled\_post\_statuses ) ) { |
  | 498 | 498 | $enabled\_post\_statuses = array( 'publish' ); |
  | 499 | 499 | } |
  | 500 | 500 |  |
  | 501 |  | //Did the user add/remove any post statuses? |
  |  | 501 | // Did the user add/remove any post statuses? |
  | 502 | 502 | $same\_statuses         = array\_intersect( $enabled\_post\_statuses, $this->conf->options['enabled\_post\_statuses'] ); |
  | 503 | 503 | $post\_statuses\_changed = ( count( $same\_statuses ) != count( $enabled\_post\_statuses ) ) |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L506) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L506) |  |
  | 506 | 506 | $this->conf->options['enabled\_post\_statuses'] = $enabled\_post\_statuses; |
  | 507 | 507 |  |
  | 508 |  | //The execution time limit must be above zero |
  |  | 508 | // The execution time limit must be above zero |
  | 509 | 509 | $new\_execution\_time = intval( $\_POST['max\_execution\_time'] ); |
  | 510 | 510 | if ( $new\_execution\_time > 0 ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L512) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L512) |  |
  | 512 | 512 | } |
  | 513 | 513 |  |
  | 514 |  | //The check threshold also must be > 0 |
  |  | 514 | // The check threshold also must be > 0 |
  | 515 | 515 | $new\_check\_threshold = intval( $\_POST['check\_threshold'] ); |
  | 516 | 516 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L533) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L533) |  |
  | 533 | 533 | $this->conf->options['exclusion\_list'] = array\_filter( |
  | 534 | 534 | preg\_split( |
  | 535 |  | '/[\s\r\n]+/', //split on newlines and whitespace |
  |  | 535 | '/[\s\r\n]+/', // split on newlines and whitespace |
  | 536 | 536 | $cleanPost['exclusion\_list'], |
  | 537 | 537 | -1, |
  | 538 |  | PREG\_SPLIT\_NO\_EMPTY //skip empty values |
  |  | 538 | PREG\_SPLIT\_NO\_EMPTY // skip empty values |
  | 539 | 539 | ) |
  | 540 | 540 | ); |
  | 541 | 541 |  |
  | 542 |  | //Parse the custom field list |
  |  | 542 | // Parse the custom field list |
  | 543 | 543 | $new\_custom\_fields = array\_filter( |
  | 544 | 544 | preg\_split( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L550) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L550) |  |
  | 550 | 550 | ); |
  | 551 | 551 |  |
  | 552 |  | //Calculate the difference between the old custom field list and the new one (used later) |
  |  | 552 | // Calculate the difference between the old custom field list and the new one (used later) |
  | 553 | 553 | $diff1                                = array\_diff( $new\_custom\_fields, $this->conf->options['custom\_fields'] ); |
  | 554 | 554 | $diff2                                = array\_diff( $this->conf->options['custom\_fields'], $new\_custom\_fields ); |
  | 555 | 555 | $this->conf->options['custom\_fields'] = $new\_custom\_fields; |
  | 556 | 556 |  |
  | 557 |  | //Parse the custom field list |
  |  | 557 | // Parse the custom field list |
  | 558 | 558 | $new\_acf\_fields = array\_filter( preg\_split( '/[\r\n]+/', $cleanPost['blc\_acf\_fields'], -1, PREG\_SPLIT\_NO\_EMPTY ) ); |
  | 559 | 559 |  |
  | 560 |  | //Calculate the difference between the old custom field list and the new one (used later) |
  |  | 560 | // Calculate the difference between the old custom field list and the new one (used later) |
  | 561 | 561 | $acf\_fields\_diff1                  = array\_diff( $new\_acf\_fields, $this->conf->options['acf\_fields'] ); |
  | 562 | 562 | $acf\_fields\_diff2                  = array\_diff( $this->conf->options['acf\_fields'], $new\_acf\_fields ); |
  | 563 | 563 | $this->conf->options['acf\_fields'] = $new\_acf\_fields; |
  | 564 | 564 |  |
  | 565 |  | //Turning off warnings turns existing warnings into "broken" links. |
  |  | 565 | // Turning off warnings turns existing warnings into "broken" links. |
  | 566 | 566 | $this->conf->options['blc\_post\_modified'] = ! empty( $\_POST['blc\_post\_modified'] ); |
  | 567 | 567 |  |
  | 568 |  | //Turning off warnings turns existing warnings into "broken" links. |
  |  | 568 | // Turning off warnings turns existing warnings into "broken" links. |
  | 569 | 569 | $warnings\_enabled = ! empty( $\_POST['warnings\_enabled'] ); |
  | 570 | 570 | if ( $this->conf->get( 'warnings\_enabled' ) && ! $warnings\_enabled ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L573) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L573) |  |
  | 573 | 573 | $this->conf->options['warnings\_enabled'] = $warnings\_enabled; |
  | 574 | 574 |  |
  | 575 |  | //HTTP timeout |
  |  | 575 | // HTTP timeout |
  | 576 | 576 | $new\_timeout = intval( $\_POST['timeout'] ); |
  | 577 | 577 | if ( $new\_timeout > 0 ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L579) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L579) |  |
  | 579 | 579 | } |
  | 580 | 580 |  |
  | 581 |  | //Server load limit |
  |  | 581 | // Server load limit |
  | 582 | 582 | if ( isset( $\_POST['server\_load\_limit'] ) ) { |
  | 583 | 583 | $this->conf->options['server\_load\_limit'] = floatval( $\_POST['server\_load\_limit'] ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L588) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L588) |  |
  | 588 | 588 | } |
  | 589 | 589 |  |
  | 590 |  | //Target resource usage (1% to 100%) |
  |  | 590 | // Target resource usage (1% to 100%) |
  | 591 | 591 | if ( isset( $\_POST['target\_resource\_usage'] ) ) { |
  | 592 | 592 | $usage                                        = floatval( $\_POST['target\_resource\_usage'] ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L595) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L595) |  |
  | 595 | 595 | } |
  | 596 | 596 |  |
  | 597 |  | //When to run the checker |
  |  | 597 | // When to run the checker |
  | 598 | 598 | $this->conf->options['run\_in\_dashboard'] = ! empty( $\_POST['run\_in\_dashboard'] ); |
  | 599 | 599 | $this->conf->options['run\_via\_cron']     = ! empty( $\_POST['run\_via\_cron'] ); |
  | 600 | 600 |  |
  | 601 |  | //youtube api |
  |  | 601 | // youtube api |
  | 602 | 602 | $this->conf->options['youtube\_api\_key'] = ! empty( $\_POST['youtube\_api\_key'] ) ? $\_POST['youtube\_api\_key'] : ''; |
  | 603 | 603 |  |
  | 604 |  | //Email notifications on/off |
  |  | 604 | // Email notifications on/off |
  | 605 | 605 | $email\_notifications              = ! empty( $\_POST['send\_email\_notifications'] ); |
  | 606 | 606 | $send\_authors\_email\_notifications = ! empty( $\_POST['send\_authors\_email\_notifications'] ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L631) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L631) |  |
  | 631 | 631 | } |
  | 632 | 632 |  |
  | 633 |  | //Link actions. The user can hide some of them to reduce UI clutter. |
  |  | 633 | // Link actions. The user can hide some of them to reduce UI clutter. |
  | 634 | 634 | $show\_link\_actions = array(); |
  | 635 | 635 | foreach ( array\_keys( $available\_link\_actions ) as $action ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L638) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L638) |  |
  | 638 | 638 | $this->conf->set( 'show\_link\_actions', $show\_link\_actions ); |
  | 639 | 639 |  |
  | 640 |  | //Logging. The plugin can log various events and results for debugging purposes. |
  |  | 640 | // Logging. The plugin can log various events and results for debugging purposes. |
  | 641 | 641 | $this->conf->options['logging\_enabled']         = ! empty( $\_POST['logging\_enabled'] ); |
  | 642 | 642 | $this->conf->options['custom\_log\_file\_enabled'] = ! empty( $\_POST['custom\_log\_file\_enabled'] ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L645) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L645) |  |
  | 645 | 645 | if ( $this->conf->options['custom\_log\_file\_enabled'] ) { |
  | 646 | 646 |  |
  | 647 |  | $log\_file = strval( $cleanPost['log\_file'] ); |
  | 648 |  | if ( ! file\_exists( $log\_file ) ) { |
  |  | 647 | $log\_file       = esc\_url\_raw( strval( $cleanPost['log\_file'] ) ); |
  |  | 648 | $file\_type\_data = wp\_check\_filetype( $log\_file ); |
  |  | 649 |  |
  |  | 650 | if ( substr( $log\_file, 0, 7 ) === 'phar://' || ! isset( $file\_type\_data['type'] ) || empty( $file\_type\_data['type'] ) ) { |
  |  | 651 | $log\_file = ''; |
  |  | 652 | } |
  |  | 653 |  |
  |  | 654 | if ( ! empty( $log\_file ) && ! file\_exists( $log\_file ) ) { |
  | 649 | 655 | if ( ! file\_exists( dirname( $log\_file ) ) ) { |
  | 650 | 656 | mkdir( dirname( $log\_file ), 0750, true ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L652) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L658) |  |
  | 652 | 658 | // Attempt to create the log file if not already there. |
  | 653 | 659 | if ( ! is\_file( $log\_file ) ) { |
  | 654 |  | //Add a .htaccess to hide the log file from site visitors. |
  |  | 660 | // Add a .htaccess to hide the log file from site visitors. |
  | 655 | 661 | file\_put\_contents( dirname( $log\_file ) . '/.htaccess', 'Deny from all' ); |
  | 656 | 662 | file\_put\_contents( $log\_file, '' ); |
  | 657 | 663 | } |
  | 658 | 664 | } |
  | 659 |  | //revert to default |
  |  | 665 |  |
  |  | 666 | // Revert to default. |
  | 660 | 667 | if ( ! is\_writable( $log\_file ) || ! is\_file( $log\_file ) ) { |
  | 661 | 668 | $this->conf->options['custom\_log\_file\_enabled'] = ''; |
  | 662 |  | $log\_directory = self::get\_default\_log\_directory(); |
  | 663 |  | $log\_file      = $log\_directory . '/' . self::get\_default\_log\_basename(); |
  |  | 669 | $log\_directory                                  = self::get\_default\_log\_directory(); |
  |  | 670 | $log\_file                                       = $log\_directory . '/' . self::get\_default\_log\_basename(); |
  | 664 | 671 | } |
  | 665 | 672 | } else { |
  | 666 |  | //Default log file is /wp-content/uploads/broken-link-checker/blc-log.txt |
  |  | 673 | // Default log file is /wp-content/uploads/broken-link-checker/blc-log.txt |
  | 667 | 674 | $log\_directory = self::get\_default\_log\_directory(); |
  | 668 | 675 | $log\_file      = $log\_directory . '/' . self::get\_default\_log\_basename(); |
  | 669 | 676 |  |
  | 670 |  | //Attempt to create the log directory. |
  |  | 677 | // Attempt to create the log directory. |
  | 671 | 678 | if ( ! is\_dir( $log\_directory ) ) { |
  | 672 | 679 | if ( mkdir( $log\_directory, 0750 ) ) { |
  | 673 |  | //Add a .htaccess to hide the log file from site visitors. |
  |  | 680 | // Add a .htaccess to hide the log file from site visitors. |
  | 674 | 681 | file\_put\_contents( $log\_directory . '/.htaccess', 'Deny from all' ); |
  | 675 | 682 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L677) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L684) |  |
  | 677 | 684 | } |
  | 678 | 685 |  |
  | 679 |  | $this->conf->options['log\_file'] = $log\_file; |
  |  | 686 | $this->conf->options['log\_file']     = $log\_file; |
  | 680 | 687 | $this->conf->options['clear\_log\_on'] = strval( $cleanPost['clear\_log\_on'] ); |
  | 681 | 688 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L685) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L692) |  |
  | 685 | 692 | } |
  | 686 | 693 |  |
  | 687 |  | //The log file must be writable. |
  |  | 694 | // The log file must be writable. |
  | 688 | 695 | if ( ! is\_writable( $log\_file ) || ! is\_file( $log\_file ) ) { |
  | 689 | 696 | $this->conf->options['logging\_enabled'] = false; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L691) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L698) |  |
  | 691 | 698 | } |
  | 692 | 699 |  |
  | 693 |  | //Make settings that affect our Cron events take effect immediately |
  |  | 700 | // Make settings that affect our Cron events take effect immediately |
  | 694 | 701 | $this->setup\_cron\_events(); |
  | 695 | 702 | $this->conf->save\_options(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L721) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L728) |  |
  | 721 | 728 | } |
  | 722 | 729 |  |
  | 723 |  | //Resynchronize posts when the user enables or disables post statuses. |
  |  | 730 | // Resynchronize posts when the user enables or disables post statuses. |
  | 724 | 731 | if ( $post\_statuses\_changed ) { |
  | 725 | 732 | $overlord                        = blcPostTypeOverlord::getInstance(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L732) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L739) |  |
  | 732 | 739 | } |
  | 733 | 740 |  |
  | 734 |  | //Redirect back to the settings page |
  |  | 741 | // Redirect back to the settings page |
  | 735 | 742 | $base\_url = remove\_query\_arg( array( '\_wpnonce', 'noheader', 'updated', 'error', 'action', 'message' ) ); |
  | 736 | 743 | wp\_redirect( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L744) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L751) |  |
  | 744 | 751 | } |
  | 745 | 752 |  |
  | 746 |  | //Show a confirmation message when settings are saved. |
  |  | 753 | // Show a confirmation message when settings are saved. |
  | 747 | 754 | if ( ! empty( $\_GET['settings-updated'] ) ) { |
  | 748 | 755 | echo '<div id="message" class="updated fade"><p><strong>',\_\_( 'Settings saved.', 'broken-link-checker' ), '</strong></p></div>'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L750) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L757) |  |
  | 750 | 757 | } |
  | 751 | 758 |  |
  | 752 |  | //Show one when recheck is started, too. |
  |  | 759 | // Show one when recheck is started, too. |
  | 753 | 760 | if ( ! empty( $\_GET['recheck-initiated'] ) ) { |
  | 754 | 761 | echo '<div id="message" class="updated fade"><p><strong>', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L757) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L764) |  |
  | 757 | 764 | } |
  | 758 | 765 |  |
  | 759 |  | //Cull invalid and missing modules |
  |  | 766 | // Cull invalid and missing modules |
  | 760 | 767 | $moduleManager->validate\_active\_modules(); |
  | 761 | 768 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L765) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L772) |  |
  | 765 | 772 | add\_filter( 'blc-module-settings-acf\_field', array( $this, 'make\_acf\_field\_input' ), 10, 2 ); |
  | 766 | 773 |  |
  | 767 |  | //Translate and markup-ify module headers for display |
  |  | 774 | // Translate and markup-ify module headers for display |
  | 768 | 775 | $modules = $moduleManager->get\_modules\_by\_category( '', true, true ); |
  | 769 | 776 |  |
  | 770 |  | //Output the custom broken link/removed link styles for example links |
  |  | 777 | // Output the custom broken link/removed link styles for example links |
  | 771 | 778 | printf( |
  | 772 | 779 | '<style type="text/css">%s %s</style>', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L844) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L851) |  |
  | 844 | 851 | <?php |
  | 845 | 852 |  |
  | 846 |  | //Output the debug info in a table |
  |  | 853 | // Output the debug info in a table |
  | 847 | 854 | foreach ( $debug as $key => $value ) { |
  | 848 | 855 | printf( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L939) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L946) |  |
  | 939 | 946 | printf( |
  | 940 | 947 | \_\_( 'Configure <a target="\_blank" href="%s">External Links</a> settings.', 'broken-link-checker' ), |
  | 941 |  | admin\_url('admin.php?page=wpel-settings-page' ) |
  |  | 948 | admin\_url( 'admin.php?page=wpel-settings-page' ) |
  | 942 | 949 | ); |
  | 943 | 950 | } else { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1105) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1112) |  |
  | 1105 | 1112 | name="youtube\_api\_key" |
  | 1106 | 1113 | id="youtube\_api\_key" |
  | 1107 |  | value="<?php echo $this->conf->options[~~'youtube\_api\_key'~~ ]; ?>" |
  |  | 1114 | value="<?php echo $this->conf->options['youtube\_api\_key']; ?>" |
  | 1108 | 1115 | class="regular-text ltr"> |
  | 1109 | 1116 | </label><br> |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1523) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1530) |  |
  | 1523 | 1530 |  |
  | 1524 | 1531 | <?php |
  | 1525 |  | //The various JS for this page is stored in a separate file for the purposes readability. |
  |  | 1532 | // The various JS for this page is stored in a separate file for the purposes readability. |
  | 1526 | 1533 | include dirname( $this->loader ) . '/includes/admin/options-page-js.php'; |
  | 1527 | 1534 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1568) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1575) |  |
  | 1568 | 1575 | ); |
  | 1569 | 1576 |  |
  | 1570 |  | //The plugin remembers the last open/closed state of module configuration boxes |
  |  | 1577 | // The plugin remembers the last open/closed state of module configuration boxes |
  | 1571 | 1578 | $box\_id = 'module-extra-settings-' . $module\_id; |
  | 1572 | 1579 | $show   = blcUtility::get\_cookie( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1596) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1603) |  |
  | 1596 | 1603 | \* |
  | 1597 | 1604 | \* @param string $module\_id Module ID. |
  | 1598 |  | \* @param array $module\_data Associative array of module data. |
  | 1599 |  | \* @param bool $active If true, the newly created checkbox will start out checked. |
  |  | 1605 | \* @param array  $module\_data Associative array of module data. |
  |  | 1606 | \* @param bool   $active If true, the newly created checkbox will start out checked. |
  | 1600 | 1607 | \* @return void |
  | 1601 | 1608 | \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1642) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1649) |  |
  | 1642 | 1649 | \* |
  | 1643 | 1650 | \* @param string $html Current extra HTML |
  | 1644 |  | \* @param array $current\_settings The current plugin configuration. |
  |  | 1651 | \* @param array  $current\_settings The current plugin configuration. |
  | 1645 | 1652 | \* @return string New extra HTML. |
  | 1646 | 1653 | \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1680) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1687) |  |
  | 1680 | 1687 | wp\_enqueue\_style( 'dashboard' ); |
  | 1681 | 1688 |  |
  | 1682 |  | wp\_enqueue\_style(~~'plugin-install'~~); |
  | 1683 |  | wp\_enqueue\_script(~~'plugin-install'~~); |
  |  | 1689 | wp\_enqueue\_style( 'plugin-install' ); |
  |  | 1690 | wp\_enqueue\_script( 'plugin-install' ); |
  | 1684 | 1691 |  |
  | 1685 | 1692 | add\_thickbox(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1697) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1704) |  |
  | 1697 | 1704 | $blc\_link\_query = blcLinkQuery::getInstance(); |
  | 1698 | 1705 |  |
  | 1699 |  | //Cull invalid and missing modules so that we don't get dummy links/instances showing up. |
  |  | 1706 | // Cull invalid and missing modules so that we don't get dummy links/instances showing up. |
  | 1700 | 1707 | $moduleManager = blcModuleManager::getInstance(); |
  | 1701 | 1708 | $moduleManager->validate\_active\_modules(); |
  | 1702 | 1709 |  |
  | 1703 | 1710 | if ( defined( 'BLC\_DEBUG' ) && constant( 'BLC\_DEBUG' ) ) { |
  | 1704 |  | //Make module headers translatable. They need to be formatted corrrectly and |
  | 1705 |  | //placed in a .php file to be visible to the script(s) that generate .pot files. |
  |  | 1711 | // Make module headers translatable. They need to be formatted corrrectly and |
  |  | 1712 | // placed in a .php file to be visible to the script(s) that generate .pot files. |
  | 1706 | 1713 | $code = $moduleManager->\_build\_header\_translation\_code(); |
  | 1707 | 1714 | file\_put\_contents( dirname( $this->loader ) . '/includes/extra-strings.php', $code ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1710) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1717) |  |
  | 1710 | 1717 | $action = ! empty( $\_POST['action'] ) ? $\_POST['action'] : ''; |
  | 1711 | 1718 | if ( intval( $action ) == -1 ) { |
  | 1712 |  | //Try the second bulk actions box |
  |  | 1719 | // Try the second bulk actions box |
  | 1713 | 1720 | $action = ! empty( $\_POST['action2'] ) ? $\_POST['action2'] : ''; |
  | 1714 | 1721 | } |
  | 1715 | 1722 |  |
  | 1716 |  | //Get the list of link IDs selected via checkboxes |
  |  | 1723 | // Get the list of link IDs selected via checkboxes |
  | 1717 | 1724 | $selected\_links = array(); |
  | 1718 | 1725 | if ( isset( $\_POST['selected\_links'] ) && is\_array( $\_POST['selected\_links'] ) ) { |
  | 1719 |  | //Convert all link IDs to integers (non-numeric entries are converted to zero) |
  |  | 1726 | // Convert all link IDs to integers (non-numeric entries are converted to zero) |
  | 1720 | 1727 | $selected\_links = array\_map( 'intval', $\_POST['selected\_links'] ); |
  | 1721 |  | //Remove all zeroes |
  |  | 1728 | // Remove all zeroes |
  | 1722 | 1729 | $selected\_links = array\_filter( $selected\_links ); |
  | 1723 | 1730 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1726) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1733) |  |
  | 1726 | 1733 | $msg\_class = 'updated'; |
  | 1727 | 1734 |  |
  | 1728 |  | //Run the selected bulk action, if any |
  |  | 1735 | // Run the selected bulk action, if any |
  | 1729 | 1736 | $force\_delete = false; |
  | 1730 | 1737 | switch ( $action ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1740) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1747) |  |
  | 1740 | 1747 | case 'bulk-delete-sources': |
  | 1741 | 1748 | $force\_delete = true; |
  | 1742 |  | //intentional fall through |
  |  | 1749 | // intentional fall through |
  | 1743 | 1750 | case 'bulk-trash-sources': |
  | 1744 | 1751 | list($message, $msg\_class) = $this->do\_bulk\_delete\_sources( $selected\_links, $force\_delete ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1776) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1783) |  |
  | 1776 | 1783 | $start\_time = microtime\_float(); |
  | 1777 | 1784 |  |
  | 1778 |  | //Load custom filters, if any |
  |  | 1785 | // Load custom filters, if any |
  | 1779 | 1786 | $blc\_link\_query->load\_custom\_filters(); |
  | 1780 | 1787 |  |
  | 1781 |  | //Calculate the number of links matching each filter |
  |  | 1788 | // Calculate the number of links matching each filter |
  | 1782 | 1789 | $blc\_link\_query->count\_filter\_results(); |
  | 1783 | 1790 |  |
  | 1784 |  | //Run the selected filter (defaults to displaying broken links) |
  |  | 1791 | // Run the selected filter (defaults to displaying broken links) |
  | 1785 | 1792 | $selected\_filter\_id = isset( $\_GET['filter\_id'] ) ? $\_GET['filter\_id'] : 'broken'; |
  | 1786 | 1793 | $current\_filter     = $blc\_link\_query->exec\_filter( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1793) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1800) |  |
  | 1793 | 1800 | ); |
  | 1794 | 1801 |  |
  | 1795 |  | //exec\_filter() returns an array with filter data, including the actual filter ID that was used. |
  |  | 1802 | // exec\_filter() returns an array with filter data, including the actual filter ID that was used. |
  | 1796 | 1803 | $filter\_id = $current\_filter['filter\_id']; |
  | 1797 | 1804 |  |
  | 1798 |  | //Error? |
  |  | 1805 | // Error? |
  | 1799 | 1806 | if ( empty( $current\_filter['links'] ) && ! empty( $wpdb->last\_error ) ) { |
  | 1800 | 1807 | printf( \_\_( 'Database error : %s', 'broken-link-checker' ), $wpdb->last\_error ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1814) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1821) |  |
  | 1814 | 1821 | $blc\_link\_query->print\_filter\_menu( $filter\_id ); |
  | 1815 | 1822 |  |
  | 1816 |  | //Display the "Search" form and associated buttons. |
  | 1817 |  | //The form requires the $filter\_id and $current\_filter variables to be set. |
  |  | 1823 | // Display the "Search" form and associated buttons. |
  |  | 1824 | // The form requires the $filter\_id and $current\_filter variables to be set. |
  | 1818 | 1825 | include dirname( $this->loader ) . '/includes/admin/search-form.php'; |
  | 1819 | 1826 |  |
  | 1820 |  | //If the user has decided to switch the table to a different mode (compact/full), |
  | 1821 |  | //save the new setting. |
  |  | 1827 | // If the user has decided to switch the table to a different mode (compact/full), |
  |  | 1828 | // save the new setting. |
  | 1822 | 1829 | if ( isset( $\_GET['compact'] ) ) { |
  | 1823 | 1830 | $this->conf->options['table\_compact'] = (bool) $\_GET['compact']; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1825) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1832) |  |
  | 1825 | 1832 | } |
  | 1826 | 1833 |  |
  | 1827 |  | //Display the links, if any |
  |  | 1834 | // Display the links, if any |
  | 1828 | 1835 | if ( $current\_filter['links'] && ( count( $current\_filter['links'] ) > 0 ) ) { |
  | 1829 | 1836 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1840) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1847) |  |
  | 1840 | 1847 | printf( '<!-- Total elapsed : %.4f seconds -->', microtime\_float() - $start\_time ); |
  | 1841 | 1848 |  |
  | 1842 |  | //Load assorted JS event handlers and other shinies |
  |  | 1849 | // Load assorted JS event handlers and other shinies |
  | 1843 | 1850 | include dirname( $this->loader ) . '/includes/admin/links-page-js.php'; |
  | 1844 | 1851 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1859) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1866) |  |
  | 1859 | 1866 | global $wpdb; |
  | 1860 | 1867 |  |
  | 1861 |  | //Create a custom filter! |
  |  | 1868 | // Create a custom filter! |
  | 1862 | 1869 | check\_admin\_referer( 'create-custom-filter' ); |
  | 1863 | 1870 | $msg\_class = 'updated'; |
  | 1864 | 1871 |  |
  | 1865 |  | //Filter name must be set |
  |  | 1872 | // Filter name must be set |
  | 1866 | 1873 | if ( empty( $\_POST['name'] ) ) { |
  | 1867 | 1874 | $message   = \_\_( 'You must enter a filter name!', 'broken-link-checker' ); |
  | 1868 | 1875 | $msg\_class = 'error'; |
  | 1869 |  | //Filter parameters (a search query) must also be set |
  |  | 1876 | // Filter parameters (a search query) must also be set |
  | 1870 | 1877 | } elseif ( empty( $\_POST['params'] ) ) { |
  | 1871 | 1878 | $message   = \_\_( 'Invalid search query.', 'broken-link-checker' ); |
  | 1872 | 1879 | $msg\_class = 'error'; |
  | 1873 | 1880 | } else { |
  | 1874 |  | //Save the new filter |
  |  | 1881 | // Save the new filter |
  | 1875 | 1882 | $name           = strip\_tags( strval( $\_POST['name'] ) ); |
  | 1876 | 1883 | $blc\_link\_query = blcLinkQuery::getInstance(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1878) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1885) |  |
  | 1878 | 1885 |  |
  | 1879 | 1886 | if ( $filter\_id ) { |
  | 1880 |  | //Saved |
  |  | 1887 | // Saved |
  | 1881 | 1888 | $message = sprintf( \_\_( 'Filter "%s" created', 'broken-link-checker' ), $name ); |
  | 1882 |  | //A little hack to make the filter active immediately |
  |  | 1889 | // A little hack to make the filter active immediately |
  | 1883 | 1890 | $\_GET['filter\_id'] = $filter\_id; |
  | 1884 | 1891 | } else { |
  | 1885 |  | //Error |
  |  | 1892 | // Error |
  | 1886 | 1893 | $message   = sprintf( \_\_( 'Database error : %s', 'broken-link-checker' ), $wpdb->last\_error ); |
  | 1887 | 1894 | $msg\_class = 'error'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1900) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1907) |  |
  | 1900 | 1907 | \*/ |
  | 1901 | 1908 | function do\_delete\_custom\_filter() { |
  | 1902 |  | //Delete an existing custom filter! |
  |  | 1909 | // Delete an existing custom filter! |
  | 1903 | 1910 | check\_admin\_referer( 'delete-custom-filter' ); |
  | 1904 | 1911 | $msg\_class = 'updated'; |
  | 1905 | 1912 |  |
  | 1906 |  | //Filter ID must be set |
  |  | 1913 | // Filter ID must be set |
  | 1907 | 1914 | if ( empty( $\_POST['filter\_id'] ) ) { |
  | 1908 | 1915 | $message   = \_\_( 'Filter ID not specified.', 'broken-link-checker' ); |
  | 1909 | 1916 | $msg\_class = 'error'; |
  | 1910 | 1917 | } else { |
  | 1911 |  | //Try to delete the filter |
  |  | 1918 | // Try to delete the filter |
  | 1912 | 1919 | $blc\_link\_query = blcLinkQuery::getInstance(); |
  | 1913 | 1920 | if ( $blc\_link\_query->delete\_custom\_filter( $\_POST['filter\_id'] ) ) { |
  | 1914 |  | //Success |
  |  | 1921 | // Success |
  | 1915 | 1922 | $message = \_\_( 'Filter deleted', 'broken-link-checker' ); |
  | 1916 | 1923 | } else { |
  | 1917 |  | //Either the ID is wrong or there was some other error |
  |  | 1924 | // Either the ID is wrong or there was some other error |
  | 1918 | 1925 | $message   = \_\_( 'Database error : %s', 'broken-link-checker' ); |
  | 1919 | 1926 | $msg\_class = 'error'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1931) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1938) |  |
  | 1931 | 1938 | \*/ |
  | 1932 | 1939 | function do\_bulk\_deredirect( $selected\_links ) { |
  | 1933 |  | //For all selected links, replace the URL with the final URL that it redirects to. |
  |  | 1940 | // For all selected links, replace the URL with the final URL that it redirects to. |
  | 1934 | 1941 |  |
  | 1935 | 1942 | $message   = ''; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1939) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1946) |  |
  | 1939 | 1946 |  |
  | 1940 | 1947 | if ( count( $selected\_links ) > 0 ) { |
  | 1941 |  | //Fetch all the selected links |
  |  | 1948 | // Fetch all the selected links |
  | 1942 | 1949 | $links = blc\_get\_links( |
  | 1943 | 1950 | array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L1951) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L1958) |  |
  | 1951 | 1958 | $failed\_links    = 0; |
  | 1952 | 1959 |  |
  | 1953 |  | //Deredirect all selected links |
  |  | 1960 | // Deredirect all selected links |
  | 1954 | 1961 | foreach ( $links as $link ) { |
  | 1955 | 1962 | $rez = $link->deredirect(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2005) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2012) |  |
  | 2005 | 2012 | $post = $\_POST; |
  | 2006 | 2013 | if ( function\_exists( 'wp\_magic\_quotes' ) ) { |
  | 2007 |  | $post = stripslashes\_deep( $post ); //Ceterum censeo, WP shouldn't mangle superglobals. |
  |  | 2014 | $post = stripslashes\_deep( $post ); // Ceterum censeo, WP shouldn't mangle superglobals. |
  | 2008 | 2015 | } |
  | 2009 | 2016 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2013) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2020) |  |
  | 2013 | 2020 | $case\_sensitive = ! empty( $post['case\_sensitive'] ); |
  | 2014 | 2021 |  |
  | 2015 |  | $delimiter = '`'; //Pick a char that's uncommon in URLs so that escaping won't usually be a problem |
  |  | 2022 | $delimiter = '`'; // Pick a char that's uncommon in URLs so that escaping won't usually be a problem |
  | 2016 | 2023 | if ( $use\_regex ) { |
  | 2017 | 2024 | $search = $delimiter . $this->escape\_regex\_delimiter( $search, $delimiter ) . $delimiter; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2020) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2027) |  |
  | 2020 | 2027 | } |
  | 2021 | 2028 | } elseif ( ! $case\_sensitive ) { |
  | 2022 |  | //str\_ireplace() would be more appropriate for case-insensitive, non-regexp replacement, |
  | 2023 |  | //but that's only available in PHP5. |
  |  | 2029 | // str\_ireplace() would be more appropriate for case-insensitive, non-regexp replacement, |
  |  | 2030 | // but that's only available in PHP5. |
  | 2024 | 2031 | $search    = $delimiter . preg\_quote( $search, $delimiter ) . $delimiter . 'i'; |
  | 2025 | 2032 | $use\_regex = true; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2027) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2034) |  |
  | 2027 | 2034 |  |
  | 2028 | 2035 | if ( count( $selected\_links ) > 0 ) { |
  | 2029 |  | set\_time\_limit( 300 ); //In case the user decides to edit hundreds of links at once |
  | 2030 |  |  |
  | 2031 |  | //Fetch all the selected links |
  |  | 2036 | set\_time\_limit( 300 ); // In case the user decides to edit hundreds of links at once |
  |  | 2037 |  |
  |  | 2038 | // Fetch all the selected links |
  | 2032 | 2039 | $links = blc\_get\_links( |
  | 2033 | 2040 | array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2042) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2049) |  |
  | 2042 | 2049 | $skipped\_links   = 0; |
  | 2043 | 2050 |  |
  | 2044 |  | //Edit the links |
  |  | 2051 | // Edit the links |
  | 2045 | 2052 | foreach ( $links as $link ) { |
  | 2046 | 2053 | if ( $use\_regex ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2133) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2140) |  |
  | 2133 | 2140 | \*/ |
  | 2134 | 2141 | function do\_bulk\_unlink( $selected\_links ) { |
  | 2135 |  | //Unlink all selected links. |
  |  | 2142 | // Unlink all selected links. |
  | 2136 | 2143 | $message   = ''; |
  | 2137 | 2144 | $msg\_class = 'updated'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2141) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2148) |  |
  | 2141 | 2148 | if ( count( $selected\_links ) > 0 ) { |
  | 2142 | 2149 |  |
  | 2143 |  | //Fetch all the selected links |
  |  | 2150 | // Fetch all the selected links |
  | 2144 | 2151 | $links = blc\_get\_links( |
  | 2145 | 2152 | array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2153) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2160) |  |
  | 2153 | 2160 | $failed\_links    = 0; |
  | 2154 | 2161 |  |
  | 2155 |  | //Unlink (delete) each one |
  |  | 2162 | // Unlink (delete) each one |
  | 2156 | 2163 | foreach ( $links as $link ) { |
  | 2157 | 2164 | $rez = $link->unlink(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2163) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2170) |  |
  | 2163 | 2170 | } |
  | 2164 | 2171 |  |
  | 2165 |  | //This message is slightly misleading - it doesn't account for the fact that |
  | 2166 |  | //a link can be present in more than one post. |
  |  | 2172 | // This message is slightly misleading - it doesn't account for the fact that |
  |  | 2173 | // a link can be present in more than one post. |
  | 2167 | 2174 | $message = sprintf( |
  | 2168 | 2175 | \_n( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2200) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2207) |  |
  | 2200 | 2207 | \* |
  | 2201 | 2208 | \* @param array $selected\_links An array of link IDs |
  | 2202 |  | \* @param bool $force\_delete Whether to bypass trash and force deletion. Defaults to false. |
  |  | 2209 | \* @param bool  $force\_delete Whether to bypass trash and force deletion. Defaults to false. |
  | 2203 | 2210 | \* @return array Confirmation message and its CSS class. |
  | 2204 | 2211 | \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2207) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2214) |  |
  | 2207 | 2214 | $msg\_class = 'updated'; |
  | 2208 | 2215 |  |
  | 2209 |  | //Delete posts, blogroll entries and any other link containers that contain any of the selected links. |
  |  | 2216 | // Delete posts, blogroll entries and any other link containers that contain any of the selected links. |
  | 2210 | 2217 | // |
  | 2211 |  | //Note that once all containers containing a particular link have been deleted, |
  | 2212 |  | //there is no need to explicitly delete the link record itself. The hooks attached to |
  | 2213 |  | //the actions that execute when something is deleted (e.g. "post\_deleted") will |
  | 2214 |  | //take care of that. |
  |  | 2218 | // Note that once all containers containing a particular link have been deleted, |
  |  | 2219 | // there is no need to explicitly delete the link record itself. The hooks attached to |
  |  | 2220 | // the actions that execute when something is deleted (e.g. "post\_deleted") will |
  |  | 2221 | // take care of that. |
  | 2215 | 2222 |  |
  | 2216 | 2223 | check\_admin\_referer( 'bulk-action' ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2219) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2226) |  |
  | 2219 | 2226 | $messages = array(); |
  | 2220 | 2227 |  |
  | 2221 |  | //Fetch all the selected links |
  |  | 2228 | // Fetch all the selected links |
  | 2222 | 2229 | $links = blc\_get\_links( |
  | 2223 | 2230 | array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2227) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2234) |  |
  | 2227 | 2234 | ); |
  | 2228 | 2235 |  |
  | 2229 |  | //Make a list of all containers associated with these links, with each container |
  | 2230 |  | //listed only once. |
  |  | 2236 | // Make a list of all containers associated with these links, with each container |
  |  | 2237 | // listed only once. |
  | 2231 | 2238 | $containers = array(); |
  | 2232 | 2239 | foreach ( $links as $link ) { /\* @var blcLink $link \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2238) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2245) |  |
  | 2238 | 2245 | } |
  | 2239 | 2246 |  |
  | 2240 |  | //Instantiate the containers |
  |  | 2247 | // Instantiate the containers |
  | 2241 | 2248 | $containers = blcContainerHelper::get\_containers( $containers ); |
  | 2242 | 2249 |  |
  | 2243 |  | //Delete/trash their associated entities |
  |  | 2250 | // Delete/trash their associated entities |
  | 2244 | 2251 | $deleted = array(); |
  | 2245 | 2252 | $skipped = array(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2260) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2267) |  |
  | 2260 | 2267 | } |
  | 2261 | 2268 |  |
  | 2262 |  | if ( is\_wp\_error( $rez ) ) { /\* @var WP\_Error $rez \*/ |
  | 2263 |  | //Record error messages for later display |
  |  | 2269 | if ( is\_wp\_error( $rez ) ) { /\* |
  |  | 2270 | @var WP\_Error $rez \*/ |
  |  | 2271 | // Record error messages for later display |
  | 2264 | 2272 | $messages[] = $rez->get\_error\_message(); |
  | 2265 | 2273 | $msg\_class  = 'error'; |
  | 2266 | 2274 | } else { |
  | 2267 |  | //Keep track of how many of each type were deleted. |
  |  | 2275 | // Keep track of how many of each type were deleted. |
  | 2268 | 2276 | $container\_type = $container->container\_type; |
  | 2269 | 2277 | if ( isset( $deleted[ $container\_type ] ) ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2275) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2283) |  |
  | 2275 | 2283 | } |
  | 2276 | 2284 |  |
  | 2277 |  | //Generate delete confirmation messages |
  |  | 2285 | // Generate delete confirmation messages |
  | 2278 | 2286 | foreach ( $deleted as $container\_type => $number ) { |
  | 2279 | 2287 | if ( $force\_delete ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2284) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2292) |  |
  | 2284 | 2292 | } |
  | 2285 | 2293 |  |
  | 2286 |  | //If some items couldn't be trashed, let the user know |
  |  | 2294 | // If some items couldn't be trashed, let the user know |
  | 2287 | 2295 | if ( count( $skipped ) > 0 ) { |
  | 2288 | 2296 | $message  = sprintf( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2327) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2335) |  |
  | 2327 | 2335 | global $wpdb; |
  | 2328 | 2336 |  |
  | 2329 |  | $message   = ''; |
  | 2330 |  | $msg\_class = 'updated'; |
  |  | 2337 | $message     = ''; |
  |  | 2338 | $msg\_class   = 'updated'; |
  | 2331 | 2339 | $total\_links = count( $selected\_links ); |
  | 2332 | 2340 | check\_admin\_referer( 'bulk-action' ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2334) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2342) |  |
  | 2334 | 2342 | if ( $total\_links > 0 ) { |
  | 2335 | 2343 | $placeholders = array\_fill( 0, $total\_links, '%d' ); |
  | 2336 |  | $format = implode( ', ', $placeholders ); |
  | 2337 |  | $query  = "UPDATE {$wpdb->prefix}blc\_links |
  |  | 2344 | $format       = implode( ', ', $placeholders ); |
  |  | 2345 | $query        = "UPDATE {$wpdb->prefix}blc\_links |
  | 2338 | 2346 | SET last\_check\_attempt = '0000-00-00 00:00:00' |
  | 2339 | 2347 | WHERE link\_id IN ( $format )"; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2378) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2386) |  |
  | 2378 | 2386 | $transactionManager->start(); |
  | 2379 | 2387 | foreach ( $selected\_links as $link\_id ) { |
  | 2380 |  | //Load the link |
  |  | 2388 | // Load the link |
  | 2381 | 2389 | $link = new blcLink( intval( $link\_id ) ); |
  | 2382 | 2390 |  |
  | 2383 |  | //Skip links that don't actually exist |
  |  | 2391 | // Skip links that don't actually exist |
  | 2384 | 2392 | if ( ! $link->valid() ) { |
  | 2385 | 2393 | continue; |
  | 2386 | 2394 | } |
  | 2387 | 2395 |  |
  | 2388 |  | //Skip links that weren't actually detected as broken |
  |  | 2396 | // Skip links that weren't actually detected as broken |
  | 2389 | 2397 | if ( ! $link->broken && ! $link->warning ) { |
  | 2390 | 2398 | continue; |
  | 2391 | 2399 | } |
  | 2392 | 2400 |  |
  | 2393 |  | //Make it appear "not broken" |
  |  | 2401 | // Make it appear "not broken" |
  | 2394 | 2402 | $link->broken             = false; |
  | 2395 | 2403 | $link->warning            = false; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2399) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2407) |  |
  | 2399 | 2407 |  |
  | 2400 | 2408 | $link->isOptionLinkChanged = true; |
  | 2401 |  | //Save the changes |
  |  | 2409 | // Save the changes |
  | 2402 | 2410 | if ( $link->save() ) { |
  | 2403 | 2411 | $processed\_links++; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2445) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2453) |  |
  | 2445 | 2453 | $transactionManager->start(); |
  | 2446 | 2454 | foreach ( $selected\_links as $link\_id ) { |
  | 2447 |  | //Load the link |
  |  | 2455 | // Load the link |
  | 2448 | 2456 | $link = new blcLink( intval( $link\_id ) ); |
  | 2449 | 2457 |  |
  | 2450 |  | //Skip links that don't actually exist |
  |  | 2458 | // Skip links that don't actually exist |
  | 2451 | 2459 | if ( ! $link->valid() ) { |
  | 2452 | 2460 | continue; |
  | 2453 | 2461 | } |
  | 2454 | 2462 |  |
  | 2455 |  | //We can only dismiss broken links and redirects. |
  |  | 2463 | // We can only dismiss broken links and redirects. |
  | 2456 | 2464 | if ( ! ( $link->broken || $link->warning || ( $link->redirect\_count > 0 ) ) ) { |
  | 2457 | 2465 | continue; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2462) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2470) |  |
  | 2462 | 2470 | $link->isOptionLinkChanged = true; |
  | 2463 | 2471 |  |
  | 2464 |  | //Save the changes |
  |  | 2472 | // Save the changes |
  | 2465 | 2473 | if ( $link->save() ) { |
  | 2466 | 2474 | $processed\_links++; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2515) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2523) |  |
  | 2515 | 2523 | } |
  | 2516 | 2524 |  |
  | 2517 |  | //Let the user hide the notice. |
  |  | 2525 | // Let the user hide the notice. |
  | 2518 | 2526 | $conf        = blc\_get\_configuration(); |
  | 2519 | 2527 | $notice\_name = 'show\_warnings\_section\_hint'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2560) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2568) |  |
  | 2560 | 2568 | \*/ |
  | 2561 | 2569 | function screen\_options\_html() { |
  | 2562 |  | //Update the links-per-page setting when "Apply" is clicked |
  |  | 2570 | // Update the links-per-page setting when "Apply" is clicked |
  | 2563 | 2571 | if ( isset( $\_POST['per\_page'] ) && is\_numeric( $\_POST['per\_page'] ) ) { |
  | 2564 | 2572 | check\_admin\_referer( 'screen-options-nonce', 'screenoptionnonce' ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2570) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2578) |  |
  | 2570 | 2578 | } |
  | 2571 | 2579 |  |
  | 2572 |  | //Let the user show/hide individual table columns |
  |  | 2580 | // Let the user show/hide individual table columns |
  | 2573 | 2581 | $html = '<h5>' . \_\_( 'Table columns', 'broken-link-checker' ) . '</h5>'; |
  | 2574 | 2582 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2622) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2630) |  |
  | 2622 | 2630 | $html     .= '</label>'; |
  | 2623 | 2631 |  |
  | 2624 |  | //Display a checkbox for turning colourful link status messages on/off |
  |  | 2632 | // Display a checkbox for turning colourful link status messages on/off |
  | 2625 | 2633 | $html .= sprintf( |
  | 2626 | 2634 | '<br/><label><input type="checkbox" id="table\_color\_code\_status" name="table\_color\_code\_status"%s> %s</label>', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2683) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2691) |  |
  | 2683 | 2691 | global $blclog; |
  | 2684 | 2692 |  |
  | 2685 |  | //Close the session to prevent lock-ups. |
  | 2686 |  | //PHP sessions are blocking. session\_start() will wait until all other scripts that are using the same session |
  | 2687 |  | //are finished. As a result, a long-running script that unintentionally keeps the session open can cause |
  | 2688 |  | //the entire site to "lock up" for the current user/browser. WordPress itself doesn't use sessions, but some |
  | 2689 |  | //plugins do, so we should explicitly close the session (if any) before starting the worker. |
  |  | 2693 | // Close the session to prevent lock-ups. |
  |  | 2694 | // PHP sessions are blocking. session\_start() will wait until all other scripts that are using the same session |
  |  | 2695 | // are finished. As a result, a long-running script that unintentionally keeps the session open can cause |
  |  | 2696 | // the entire site to "lock up" for the current user/browser. WordPress itself doesn't use sessions, but some |
  |  | 2697 | // plugins do, so we should explicitly close the session (if any) before starting the worker. |
  | 2690 | 2698 | if ( session\_id() != '' ) { |
  | 2691 | 2699 | session\_write\_close(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2693) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2701) |  |
  | 2693 | 2701 |  |
  | 2694 | 2702 | if ( ! $this->acquire\_lock() ) { |
  | 2695 |  | //FB::warn("Another instance of BLC is already working. Stop."); |
  |  | 2703 | // FB::warn("Another instance of BLC is already working. Stop."); |
  | 2696 | 2704 | $blclog->info( 'Another instance of BLC is already working. Stop.' ); |
  | 2697 | 2705 | return; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2699) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2707) |  |
  | 2699 | 2707 |  |
  | 2700 | 2708 | if ( $this->server\_too\_busy() ) { |
  | 2701 |  | //FB::warn("Server is too busy. Stop."); |
  |  | 2709 | // FB::warn("Server is too busy. Stop."); |
  | 2702 | 2710 | $blclog->warn( 'Server load is too high, stopping.' ); |
  | 2703 | 2711 | return; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2711) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2719) |  |
  | 2711 | 2719 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
  | 2712 | 2720 | Preparation |
  | 2713 |  | \*~~\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*~~/ |
  |  | 2721 | \*/ |
  | 2714 | 2722 | // Check for safe mode |
  | 2715 | 2723 | if ( blcUtility::is\_safe\_mode() ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2721) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2729) |  |
  | 2721 | 2729 | } else { |
  | 2722 | 2730 | // Do it the regular way |
  | 2723 |  | @set\_time\_limit( $max\_execution\_time \* 2 ); //x2 should be plenty, running any longer would mean a glitch. |
  | 2724 |  | } |
  | 2725 |  |  |
  | 2726 |  | //Don't stop the script when the connection is closed |
  |  | 2731 | @set\_time\_limit( $max\_execution\_time \* 2 ); // x2 should be plenty, running any longer would mean a glitch. |
  |  | 2732 | } |
  |  | 2733 |  |
  |  | 2734 | // Don't stop the script when the connection is closed |
  | 2727 | 2735 | ignore\_user\_abort( true ); |
  | 2728 | 2736 |  |
  | 2729 |  | //Close the connection as per http://www.php.net/manual/en/features.connection-handling.php#71172 |
  | 2730 |  | //This reduces resource usage. |
  | 2731 |  | //(Disable when debugging or you won't get the FirePHP output) |
  |  | 2737 | // Close the connection as per http://www.php.net/manual/en/features.connection-handling.php#71172 |
  |  | 2738 | // This reduces resource usage. |
  |  | 2739 | // (Disable when debugging or you won't get the FirePHP output) |
  | 2732 | 2740 | if ( |
  | 2733 | 2741 | ! headers\_sent() |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2735) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2743) |  |
  | 2735 | 2743 | && ( ! defined( 'BLC\_DEBUG' ) || ! constant( 'BLC\_DEBUG' ) ) |
  | 2736 | 2744 | ) { |
  | 2737 |  | @ob\_end\_clean(); //Discard the existing buffer, if any |
  |  | 2745 | @ob\_end\_clean(); // Discard the existing buffer, if any |
  | 2738 | 2746 | header( 'Connection: close' ); |
  | 2739 | 2747 | ob\_start(); |
  | 2740 |  | echo ( 'Connection closed' ); //This could be anything |
  |  | 2748 | echo ( 'Connection closed' ); // This could be anything |
  | 2741 | 2749 | $size = ob\_get\_length(); |
  | 2742 | 2750 | header( "Content-Length: $size" ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2745) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2753) |  |
  | 2745 | 2753 | } |
  | 2746 | 2754 |  |
  | 2747 |  | //Load modules for this context |
  |  | 2755 | // Load modules for this context |
  | 2748 | 2756 | $moduleManager = blcModuleManager::getInstance(); |
  | 2749 | 2757 | $moduleManager->load\_modules( 'work' ); |
  | 2750 | 2758 |  |
  | 2751 | 2759 | $target\_usage\_fraction = $this->conf->get( 'target\_resource\_usage', 0.25 ); |
  | 2752 |  | //Target usage must be between 1% and 100%. |
  |  | 2760 | // Target usage must be between 1% and 100%. |
  | 2753 | 2761 | $target\_usage\_fraction = max( min( $target\_usage\_fraction, 1 ), 0.01 ); |
  | 2754 | 2762 |  |
  | 2755 | 2763 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
  | 2756 | 2764 | Parse posts and bookmarks |
  | 2757 |  | \*~~\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*~~/ |
  |  | 2765 | \*/ |
  | 2758 | 2766 |  |
  | 2759 | 2767 | $orphans\_possible   = false; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2762) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2770) |  |
  | 2762 | 2770 | if ( $still\_need\_resynch ) { |
  | 2763 | 2771 |  |
  | 2764 |  | //FB::log("Looking for containers that need parsing..."); |
  |  | 2772 | // FB::log("Looking for containers that need parsing..."); |
  | 2765 | 2773 | $max\_containers\_per\_query = 50; |
  | 2766 | 2774 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2770) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2778) |  |
  | 2770 | 2778 |  |
  | 2771 | 2779 | while ( ! empty( $containers ) ) { |
  | 2772 |  | //FB::log($containers, 'Found containers'); |
  |  | 2780 | // FB::log($containers, 'Found containers'); |
  | 2773 | 2781 | $this->sleep\_to\_maintain\_ratio( $get\_containers\_time, $target\_usage\_fraction ); |
  | 2774 | 2782 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2776) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2784) |  |
  | 2776 | 2784 | $synch\_start\_time = microtime( true ); |
  | 2777 | 2785 |  |
  | 2778 |  | //FB::log($container, "Parsing container"); |
  |  | 2786 | // FB::log($container, "Parsing container"); |
  | 2779 | 2787 | $container->synch(); |
  | 2780 | 2788 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2789) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2797) |  |
  | 2789 | 2797 | ); |
  | 2790 | 2798 |  |
  | 2791 |  | //Check if we still have some execution time left |
  |  | 2799 | // Check if we still have some execution time left |
  | 2792 | 2800 | if ( $this->execution\_time() > $max\_execution\_time ) { |
  | 2793 |  | //FB::log('The allotted execution time has run out'); |
  |  | 2801 | // FB::log('The allotted execution time has run out'); |
  | 2794 | 2802 | blc\_cleanup\_links(); |
  | 2795 | 2803 | $this->release\_lock(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2797) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2805) |  |
  | 2797 | 2805 | } |
  | 2798 | 2806 |  |
  | 2799 |  | //Check if the server isn't overloaded |
  |  | 2807 | // Check if the server isn't overloaded |
  | 2800 | 2808 | if ( $this->server\_too\_busy() ) { |
  | 2801 |  | //FB::log('Server overloaded, bailing out.'); |
  |  | 2809 | // FB::log('Server overloaded, bailing out.'); |
  | 2802 | 2810 | blc\_cleanup\_links(); |
  | 2803 | 2811 | $this->release\_lock(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2805) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2813) |  |
  | 2805 | 2813 | } |
  | 2806 | 2814 |  |
  | 2807 |  | //Intentionally slow down parsing to reduce the load on the server. Basically, |
  | 2808 |  | //we work $target\_usage\_fraction of the time and sleep the rest of the time. |
  |  | 2815 | // Intentionally slow down parsing to reduce the load on the server. Basically, |
  |  | 2816 | // we work $target\_usage\_fraction of the time and sleep the rest of the time. |
  | 2809 | 2817 | $this->sleep\_to\_maintain\_ratio( $synch\_elapsed\_time, $target\_usage\_fraction ); |
  | 2810 | 2818 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2816) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2824) |  |
  | 2816 | 2824 | } |
  | 2817 | 2825 |  |
  | 2818 |  | //FB::log('No unparsed items found.'); |
  |  | 2826 | // FB::log('No unparsed items found.'); |
  | 2819 | 2827 | $still\_need\_resynch = false; |
  | 2820 | 2828 |  |
  | 2821 | 2829 | } else { |
  | 2822 |  | //FB::log('Resynch not required.'); |
  |  | 2830 | // FB::log('Resynch not required.'); |
  | 2823 | 2831 | } |
  | 2824 | 2832 |  |
  | 2825 | 2833 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
  | 2826 | 2834 | Resynch done? |
  | 2827 |  | \*~~\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*~~/ |
  |  | 2835 | \*/ |
  | 2828 | 2836 | if ( $this->conf->options['need\_resynch'] && ! $still\_need\_resynch ) { |
  | 2829 | 2837 | $this->conf->options['need\_resynch'] = $still\_need\_resynch; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2833) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2841) |  |
  | 2833 | 2841 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
  | 2834 | 2842 | Remove orphaned links |
  | 2835 |  | \*~~\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*~~/ |
  |  | 2843 | \*/ |
  | 2836 | 2844 |  |
  | 2837 | 2845 | if ( $orphans\_possible ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2845) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2853) |  |
  | 2845 | 2853 | } |
  | 2846 | 2854 |  |
  | 2847 |  | //Check if we still have some execution time left |
  |  | 2855 | // Check if we still have some execution time left |
  | 2848 | 2856 | if ( $this->execution\_time() > $max\_execution\_time ) { |
  | 2849 |  | //FB::log('The allotted execution time has run out'); |
  |  | 2857 | // FB::log('The allotted execution time has run out'); |
  | 2850 | 2858 | $blclog->info( 'The allotted execution time has run out.' ); |
  | 2851 | 2859 | $this->release\_lock(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2854) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2862) |  |
  | 2854 | 2862 |  |
  | 2855 | 2863 | if ( $this->server\_too\_busy() ) { |
  | 2856 |  | //FB::log('Server overloaded, bailing out.'); |
  |  | 2864 | // FB::log('Server overloaded, bailing out.'); |
  | 2857 | 2865 | $blclog->info( 'Server load too high, stopping.' ); |
  | 2858 | 2866 | $this->release\_lock(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2862) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2870) |  |
  | 2862 | 2870 | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
  | 2863 | 2871 | Check links |
  | 2864 |  | \*~~\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*~~/ |
  |  | 2872 | \*/ |
  | 2865 | 2873 | $max\_links\_per\_query = 30; |
  | 2866 | 2874 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2872) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2880) |  |
  | 2872 | 2880 | $this->sleep\_to\_maintain\_ratio( $get\_links\_time, $target\_usage\_fraction ); |
  | 2873 | 2881 |  |
  | 2874 |  | //Some unchecked links found |
  | 2875 |  | //FB::log("Checking ".count($links)." link(s)"); |
  |  | 2882 | // Some unchecked links found |
  |  | 2883 | // FB::log("Checking ".count($links)." link(s)"); |
  | 2876 | 2884 | $blclog->info( 'Checking ' . count( $links ) . ' link(s)' ); |
  | 2877 | 2885 |  |
  | 2878 |  | //Randomizing the array reduces the chances that we'll get several links to the same domain in a row. |
  |  | 2886 | // Randomizing the array reduces the chances that we'll get several links to the same domain in a row. |
  | 2879 | 2887 | shuffle( $links ); |
  | 2880 | 2888 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2883) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2891) |  |
  | 2883 | 2891 |  |
  | 2884 | 2892 | foreach ( $links as $link ) { |
  | 2885 |  | //Does this link need to be checked? Excluded links aren't checked, but their URLs are still |
  | 2886 |  | //tested periodically to see if they're still on the exclusion list. |
  |  | 2893 | // Does this link need to be checked? Excluded links aren't checked, but their URLs are still |
  |  | 2894 | // tested periodically to see if they're still on the exclusion list. |
  | 2887 | 2895 | if ( ! $this->is\_excluded( $link->url ) ) { |
  | 2888 |  | //Check the link. |
  | 2889 |  | //FB::log($link->url, "Checking link {$link->link\_id}"); |
  |  | 2896 | // Check the link. |
  |  | 2897 | // FB::log($link->url, "Checking link {$link->link\_id}"); |
  | 2890 | 2898 | $link->check( true ); |
  | 2891 | 2899 | } else { |
  | 2892 |  | //FB::info("The URL {$link->url} is excluded, skipping link {$link->link\_id}."); |
  |  | 2900 | // FB::info("The URL {$link->url} is excluded, skipping link {$link->link\_id}."); |
  | 2893 | 2901 | $link->last\_check\_attempt = time(); |
  | 2894 | 2902 | $link->save(); |
  | 2895 | 2903 | } |
  | 2896 | 2904 |  |
  | 2897 |  | //Check if we still have some execution time left |
  |  | 2905 | // Check if we still have some execution time left |
  | 2898 | 2906 | if ( $this->execution\_time() > $max\_execution\_time ) { |
  | 2899 | 2907 | $transactionManager->commit(); |
  | 2900 |  | //FB::log('The allotted execution time has run out'); |
  |  | 2908 | // FB::log('The allotted execution time has run out'); |
  | 2901 | 2909 | $blclog->info( 'The allotted execution time has run out.' ); |
  | 2902 | 2910 | $this->release\_lock(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2904) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2912) |  |
  | 2904 | 2912 | } |
  | 2905 | 2913 |  |
  | 2906 |  | //Check if the server isn't overloaded |
  |  | 2914 | // Check if the server isn't overloaded |
  | 2907 | 2915 | if ( $this->server\_too\_busy() ) { |
  | 2908 | 2916 | $transactionManager->commit(); |
  | 2909 |  | //FB::log('Server overloaded, bailing out.'); |
  |  | 2917 | // FB::log('Server overloaded, bailing out.'); |
  | 2910 | 2918 | $blclog->info( 'Server load too high, stopping.' ); |
  | 2911 | 2919 | $this->release\_lock(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2919) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2927) |  |
  | 2919 | 2927 | $get\_links\_time = microtime( true ) - $start; |
  | 2920 | 2928 | } |
  | 2921 |  | //FB::log('No links need to be checked right now.'); |
  |  | 2929 | // FB::log('No links need to be checked right now.'); |
  | 2922 | 2930 |  |
  | 2923 | 2931 | $this->release\_lock(); |
  | 2924 | 2932 | $blclog->info( 'work(): All done.' ); |
  | 2925 |  | //FB::log('All done.'); |
  |  | 2933 | // FB::log('All done.'); |
  | 2926 | 2934 | } |
  | 2927 | 2935 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2941) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2949) |  |
  | 2941 | 2949 | $sleep\_time = $elapsed\_time \* ( ( 1 / $ratio ) - 1 ); |
  | 2942 | 2950 | if ( $sleep\_time > 0.0001 ) { |
  | 2943 |  | /\*global $blclog; |
  |  | 2951 | /\* |
  |  | 2952 | global $blclog; |
  | 2944 | 2953 | $blclog->debug(sprintf( |
  | 2945 | 2954 | 'Task took %.2f ms, sleeping for %.2f ms', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2967) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2976) |  |
  | 2967 | 2976 | \* |
  | 2968 | 2977 | \* @param integer $max\_results The maximum number of links to return. Defaults to 0 = no limit. |
  | 2969 |  | \* @param bool $count\_only If true, only the number of found links will be returned, not the links themselves. |
  |  | 2978 | \* @param bool    $count\_only If true, only the number of found links will be returned, not the links themselves. |
  | 2970 | 2979 | \* @return int|blcLink[] |
  | 2971 | 2980 | \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L2976) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L2985) |  |
  | 2976 | 2985 | $recheck\_threshold = date( 'Y-m-d H:i:s', time() - $this->conf->options['recheck\_threshold'] );//phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
  | 2977 | 2986 |  |
  | 2978 |  | //FB::log('Looking for links to check (threshold : '.$check\_threshold.', recheck\_threshold : '.$recheck\_threshold.')...'); |
  | 2979 |  |  |
  | 2980 |  | //Select some links that haven't been checked for a long time or |
  | 2981 |  | //that are broken and need to be re-checked again. Links that are |
  | 2982 |  | //marked as "being checked" and have been that way for several minutes |
  | 2983 |  | //can also be considered broken/buggy, so those will be selected |
  | 2984 |  | //as well. |
  | 2985 |  |  |
  | 2986 |  | //Only check links that have at least one valid instance (i.e. an instance exists and |
  | 2987 |  | //it corresponds to one of the currently loaded container/parser types). |
  |  | 2987 | // FB::log('Looking for links to check (threshold : '.$check\_threshold.', recheck\_threshold : '.$recheck\_threshold.')...'); |
  |  | 2988 |  |
  |  | 2989 | // Select some links that haven't been checked for a long time or |
  |  | 2990 | // that are broken and need to be re-checked again. Links that are |
  |  | 2991 | // marked as "being checked" and have been that way for several minutes |
  |  | 2992 | // can also be considered broken/buggy, so those will be selected |
  |  | 2993 | // as well. |
  |  | 2994 |  |
  |  | 2995 | // Only check links that have at least one valid instance (i.e. an instance exists and |
  |  | 2996 | // it corresponds to one of the currently loaded container/parser types). |
  | 2988 | 2997 | $manager           = blcModuleManager::getInstance(); |
  | 2989 | 2998 | $loaded\_containers = $manager->get\_escaped\_ids( 'container' ); |
  | 2990 | 2999 | $loaded\_parsers    = $manager->get\_escaped\_ids( 'parser' ); |
  | 2991 | 3000 |  |
  | 2992 |  | //Note : This is a slow query, but AFAIK there is no way to speed it up. |
  | 2993 |  | //I could put an index on last\_check\_attempt, but that value is almost |
  | 2994 |  | //certainly unique for each row so it wouldn't be much better than a full table scan. |
  |  | 3001 | // Note : This is a slow query, but AFAIK there is no way to speed it up. |
  |  | 3002 | // I could put an index on last\_check\_attempt, but that value is almost |
  |  | 3003 | // certainly unique for each row so it wouldn't be much better than a full table scan. |
  | 2995 | 3004 | if ( $count\_only ) { |
  | 2996 | 3005 | $q = "SELECT COUNT(DISTINCT links.link\_id)\n"; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3031) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3040) |  |
  | 3031 | 3040 | ); |
  | 3032 | 3041 |  |
  | 3033 |  | //FB::log($link\_q, "Find links to check"); |
  | 3034 |  | //$blclog->debug("Find links to check: \n" . $link\_q); |
  | 3035 |  |  |
  | 3036 |  | //If we just need the number of links, retrieve it and return |
  |  | 3042 | // FB::log($link\_q, "Find links to check"); |
  |  | 3043 | // $blclog->debug("Find links to check: \n" . $link\_q); |
  |  | 3044 |  |
  |  | 3045 | // If we just need the number of links, retrieve it and return |
  | 3037 | 3046 | if ( $count\_only ) { |
  | 3038 | 3047 | return $wpdb->get\_var( $link\_q );//phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
  | 3039 | 3048 | } |
  | 3040 | 3049 |  |
  | 3041 |  | //Fetch the link data |
  |  | 3050 | // Fetch the link data |
  | 3042 | 3051 | $link\_data = $wpdb->get\_results( $link\_q, ARRAY\_A ); //phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared |
  | 3043 | 3052 | if ( empty( $link\_data ) ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3045) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3054) |  |
  | 3045 | 3054 | } |
  | 3046 | 3055 |  |
  | 3047 |  | //Instantiate blcLink objects for all fetched links |
  |  | 3056 | // Instantiate blcLink objects for all fetched links |
  | 3048 | 3057 | $links = array(); |
  | 3049 | 3058 | foreach ( $link\_data as $data ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3147) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3156) |  |
  | 3147 | 3156 | \*/ |
  | 3148 | 3157 | function ajax\_dashboard\_status() { |
  | 3149 |  | //Just display the full status. |
  |  | 3158 | // Just display the full status. |
  | 3150 | 3159 | $this->ajax\_full\_status(); |
  | 3151 | 3160 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3171) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3180) |  |
  | 3171 | 3180 | \* Returns an array with various status information about the plugin. Array key reference: |
  | 3172 | 3181 | \*  check\_threshold     - date/time; links checked before this threshold should be checked again. |
  | 3173 |  | \*   recheck\_threshold   - date/time; broken links checked before this threshold should be re-checked. |
  | 3174 |  | \*   known\_links         - the number of detected unique URLs (a misleading name, yes). |
  | 3175 |  | \*   known\_instances     - the number of detected link instances, i.e. actual link elements in posts and other places. |
  | 3176 |  | \*   broken\_links        - the number of detected broken links. |
  | 3177 |  | \*   unchecked\_links     - the number of URLs that need to be checked ASAP; based on check\_threshold and recheck\_threshold. |
  | 3178 |  | \* |
  | 3179 |  | \* @return array |
  | 3180 |  | \*/ |
  |  | 3182 | \*   recheck\_threshold   - date/time; broken links checked before this threshold should be re-checked. |
  |  | 3183 | \*   known\_links         - the number of detected unique URLs (a misleading name, yes). |
  |  | 3184 | \*   known\_instances     - the number of detected link instances, i.e. actual link elements in posts and other places. |
  |  | 3185 | \*   broken\_links        - the number of detected broken links. |
  |  | 3186 | \*   unchecked\_links     - the number of URLs that need to be checked ASAP; based on check\_threshold and recheck\_threshold. |
  |  | 3187 | \* |
  |  | 3188 | \* @return array |
  |  | 3189 | \*/ |
  | 3181 | 3190 | function get\_status() { |
  | 3182 | 3191 | $blc\_link\_query = blcLinkQuery::getInstance(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3205) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3214) |  |
  | 3205 | 3214 | check\_ajax\_referer( 'blc\_work' ); |
  | 3206 | 3215 |  |
  | 3207 |  | //Run the worker function |
  |  | 3216 | // Run the worker function |
  | 3208 | 3217 | $this->work(); |
  | 3209 | 3218 | die(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3221) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3230) |  |
  | 3221 | 3230 |  |
  | 3222 | 3231 | if ( isset( $\_POST['link\_id'] ) ) { |
  | 3223 |  | //Load the link |
  |  | 3232 | // Load the link |
  | 3224 | 3233 | $link = new blcLink( intval( $\_POST['link\_id'] ) ); |
  | 3225 | 3234 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3228) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3237) |  |
  | 3228 | 3237 | die(); |
  | 3229 | 3238 | } |
  | 3230 |  | //Make it appear "not broken" |
  |  | 3239 | // Make it appear "not broken" |
  | 3231 | 3240 | $link->broken             = false; |
  | 3232 | 3241 | $link->warning            = false; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3240) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3249) |  |
  | 3240 | 3249 | $transactionManager->start(); |
  | 3241 | 3250 |  |
  | 3242 |  | //Save the changes |
  |  | 3251 | // Save the changes |
  | 3243 | 3252 | if ( $link->save() ) { |
  | 3244 | 3253 | $transactionManager->commit(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3268) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3277) |  |
  | 3268 | 3277 |  |
  | 3269 | 3278 | if ( isset( $\_POST['link\_id'] ) ) { |
  | 3270 |  | //Load the link |
  |  | 3279 | // Load the link |
  | 3271 | 3280 | $link = new blcLink( intval( $\_POST['link\_id'] ) ); |
  | 3272 | 3281 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3278) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3287) |  |
  | 3278 | 3287 | $link->dismissed = $dismiss; |
  | 3279 | 3288 |  |
  | 3280 |  | //Save the changes |
  |  | 3289 | // Save the changes |
  | 3281 | 3290 | $link->isOptionLinkChanged = true; |
  | 3282 | 3291 | $transactionManager        = TransactionManager::getInstance(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3319) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3328) |  |
  | 3319 | 3328 | } |
  | 3320 | 3329 |  |
  | 3321 |  | //Load the link |
  |  | 3330 | // Load the link |
  | 3322 | 3331 | $link = new blcLink( intval( $\_POST['link\_id'] ) ); |
  | 3323 | 3332 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3332) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3341) |  |
  | 3332 | 3341 | } |
  | 3333 | 3342 |  |
  | 3334 |  | //Validate the new URL. |
  |  | 3343 | // Validate the new URL. |
  | 3335 | 3344 | $new\_url = stripslashes( $\_POST['new\_url'] ); |
  | 3336 | 3345 | $parsed  = @parse\_url( $new\_url ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3346) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3355) |  |
  | 3346 | 3355 |  |
  | 3347 | 3356 | if ( ! current\_user\_can( 'unfiltered\_html' ) ) { |
  | 3348 |  | //Disallow potentially dangerous URLs like "javascript:...". |
  |  | 3357 | // Disallow potentially dangerous URLs like "javascript:...". |
  | 3349 | 3358 | $protocols         = wp\_allowed\_protocols(); |
  | 3350 | 3359 | $good\_protocol\_url = wp\_kses\_bad\_protocol( $new\_url, $protocols ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3365) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3374) |  |
  | 3365 | 3374 | } |
  | 3366 | 3375 | if ( ! empty( $new\_text ) && ! current\_user\_can( 'unfiltered\_html' ) ) { |
  | 3367 |  | $new\_text = stripslashes( wp\_filter\_post\_kses( addslashes( $new\_text ) ) ); //wp\_filter\_post\_kses expects slashed data. |
  |  | 3376 | $new\_text = stripslashes( wp\_filter\_post\_kses( addslashes( $new\_text ) ) ); // wp\_filter\_post\_kses expects slashed data. |
  | 3368 | 3377 | } |
  | 3369 | 3378 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3407) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3416) |  |
  | 3407 | 3416 | 'errors'         => array(), |
  | 3408 | 3417 | ); |
  | 3409 |  | //url, status text, status code, link text, editable link text |
  |  | 3418 | // url, status text, status code, link text, editable link text |
  | 3410 | 3419 |  |
  | 3411 | 3420 | foreach ( $rez['errors'] as $error ) { /\*\* @var $error WP\_Error \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3434) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3443) |  |
  | 3434 | 3443 |  |
  | 3435 | 3444 | if ( isset( $\_POST['link\_id'] ) ) { |
  | 3436 |  | //Load the link |
  |  | 3445 | // Load the link |
  | 3437 | 3446 | $link = new blcLink( intval( $\_POST['link\_id'] ) ); |
  | 3438 | 3447 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3447) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3456) |  |
  | 3447 | 3456 | } |
  | 3448 | 3457 |  |
  | 3449 |  | //Try and unlink it |
  |  | 3458 | // Try and unlink it |
  | 3450 | 3459 | $rez = $link->unlink(); |
  | 3451 | 3460 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3515) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3524) |  |
  | 3515 | 3524 | } |
  | 3516 | 3525 |  |
  | 3517 |  | //The actual task is simple; it's error handling that's complicated. |
  |  | 3526 | // The actual task is simple; it's error handling that's complicated. |
  | 3518 | 3527 | $result = $link->deredirect(); |
  | 3519 | 3528 | if ( is\_wp\_error( $result ) ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3546) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3555) |  |
  | 3546 | 3555 | ); |
  | 3547 | 3556 |  |
  | 3548 |  | //Convert WP\_Error's to simple strings. |
  |  | 3557 | // Convert WP\_Error's to simple strings. |
  | 3549 | 3558 | if ( ! empty( $result['errors'] ) ) { |
  | 3550 | 3559 | foreach ( $result['errors'] as $error ) { /\*\* @var WP\_Error $error \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3596) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3605) |  |
  | 3596 | 3605 | $transactionManager->start(); |
  | 3597 | 3606 |  |
  | 3598 |  | //In case the immediate check fails, this will ensure the link is checked during the next work() run. |
  |  | 3607 | // In case the immediate check fails, this will ensure the link is checked during the next work() run. |
  | 3599 | 3608 | $link->last\_check\_attempt  = 0; |
  | 3600 | 3609 | $link->isOptionLinkChanged = true; |
  | 3601 | 3610 | $link->save(); |
  | 3602 | 3611 |  |
  | 3603 |  | //Check the link and save the results. |
  |  | 3612 | // Check the link and save the results. |
  | 3604 | 3613 | $link->check( true ); |
  | 3605 | 3614 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3625) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3634) |  |
  | 3625 | 3634 | } |
  | 3626 | 3635 |  |
  | 3627 |  | //FB::log("Loading link details via AJAX"); |
  |  | 3636 | // FB::log("Loading link details via AJAX"); |
  | 3628 | 3637 |  |
  | 3629 | 3638 | if ( isset( $\_GET['link\_id'] ) ) { |
  | 3630 |  | //FB::info("Link ID found in GET"); |
  |  | 3639 | // FB::info("Link ID found in GET"); |
  | 3631 | 3640 | $link\_id = intval( $\_GET['link\_id'] ); |
  | 3632 | 3641 | } elseif ( isset( $\_POST['link\_id'] ) ) { |
  | 3633 |  | //FB::info("Link ID found in POST"); |
  |  | 3642 | // FB::info("Link ID found in POST"); |
  | 3634 | 3643 | $link\_id = intval( $\_POST['link\_id'] ); |
  | 3635 | 3644 | } else { |
  | 3636 |  | //FB::error('Link ID not specified, you hacking bastard.'); |
  |  | 3645 | // FB::error('Link ID not specified, you hacking bastard.'); |
  | 3637 | 3646 | die( \_\_( 'Error : link ID not specified', 'broken-link-checker' ) ); |
  | 3638 | 3647 | } |
  | 3639 | 3648 |  |
  | 3640 |  | //Load the link. |
  |  | 3649 | // Load the link. |
  | 3641 | 3650 | $link = new blcLink( $link\_id ); |
  | 3642 | 3651 |  |
  | 3643 | 3652 | if ( ! $link->is\_new ) { |
  | 3644 |  | //FB::info($link, 'Link loaded'); |
  |  | 3653 | // FB::info($link, 'Link loaded'); |
  | 3645 | 3654 | if ( ! class\_exists( 'blcTablePrinter' ) ) { |
  | 3646 | 3655 | require dirname( $this->loader ) . '/includes/admin/table-printer.php'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3719) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3728) |  |
  | 3719 | 3728 | global $wpdb; |
  | 3720 | 3729 |  |
  | 3721 |  | //Collect some information that's useful for debugging |
  |  | 3730 | // Collect some information that's useful for debugging |
  | 3722 | 3731 | $debug = array(); |
  | 3723 | 3732 |  |
  | 3724 |  | //PHP version. Any one is fine as long as WP supports it. |
  |  | 3733 | // PHP version. Any one is fine as long as WP supports it. |
  | 3725 | 3734 | $debug[ \_\_( 'PHP version', 'broken-link-checker' ) ] = array( |
  | 3726 | 3735 | 'state' => 'ok', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3728) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3737) |  |
  | 3728 | 3737 | ); |
  | 3729 | 3738 |  |
  | 3730 |  | //MySQL version |
  |  | 3739 | // MySQL version |
  | 3731 | 3740 | $debug[ \_\_( 'MySQL version', 'broken-link-checker' ) ] = array( |
  | 3732 | 3741 | 'state' => 'ok', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3734) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3743) |  |
  | 3734 | 3743 | ); |
  | 3735 | 3744 |  |
  | 3736 |  | //CURL presence and version |
  |  | 3745 | // CURL presence and version |
  | 3737 | 3746 | if ( function\_exists( 'curl\_version' ) ) { |
  | 3738 | 3747 | $version = curl\_version(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3758) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3767) |  |
  | 3758 | 3767 | $debug[ \_\_( 'CURL version', 'broken-link-checker' ) ] = $data; |
  | 3759 | 3768 |  |
  | 3760 |  | //Snoopy presence |
  |  | 3769 | // Snoopy presence |
  | 3761 | 3770 | if ( class\_exists( 'WP\_Http' ) || file\_exists( ABSPATH . WPINC . '/class-http.php' ) ) { |
  | 3762 | 3771 | $data = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3765) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3774) |  |
  | 3765 | 3774 | ); |
  | 3766 | 3775 | } else { |
  | 3767 |  | //No Snoopy? This should never happen, but if it does we \*must\* have CURL. |
  |  | 3776 | // No Snoopy? This should never happen, but if it does we \*must\* have CURL. |
  | 3768 | 3777 | if ( function\_exists( 'curl\_init' ) ) { |
  | 3769 | 3778 | $data = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3781) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3790) |  |
  | 3781 | 3790 | $debug['Snoopy'] = $data; |
  | 3782 | 3791 |  |
  | 3783 |  | //Safe\_mode status |
  |  | 3792 | // Safe\_mode status |
  | 3784 | 3793 | if ( blcUtility::is\_safe\_mode() ) { |
  | 3785 | 3794 | $debug['Safe mode'] = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3795) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3804) |  |
  | 3795 | 3804 | } |
  | 3796 | 3805 |  |
  | 3797 |  | //Open\_basedir status |
  |  | 3806 | // Open\_basedir status |
  | 3798 | 3807 | if ( blcUtility::is\_open\_basedir() ) { |
  | 3799 | 3808 | $debug['open\_basedir'] = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3809) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3818) |  |
  | 3809 | 3818 | } |
  | 3810 | 3819 |  |
  | 3811 |  | //Default PHP execution time limit |
  |  | 3820 | // Default PHP execution time limit |
  | 3812 | 3821 | $debug['Default PHP execution time limit'] = array( |
  | 3813 | 3822 | 'state' => 'ok', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3815) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3824) |  |
  | 3815 | 3824 | ); |
  | 3816 | 3825 |  |
  | 3817 |  | //Database character set. Usually it's UTF-8. Setting it to something else can cause problems |
  | 3818 |  | //unless the site owner really knows what they're doing. |
  |  | 3826 | // Database character set. Usually it's UTF-8. Setting it to something else can cause problems |
  |  | 3827 | // unless the site owner really knows what they're doing. |
  | 3819 | 3828 | $charset = $wpdb->get\_charset\_collate(); |
  | 3820 | 3829 | $debug[ \_\_( 'Database character set', 'broken-link-checker' ) ] = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3823) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3832) |  |
  | 3823 | 3832 | ); |
  | 3824 | 3833 |  |
  | 3825 |  | //Resynch flag. |
  |  | 3834 | // Resynch flag. |
  | 3826 | 3835 | $debug['Resynch. flag'] = array( |
  | 3827 | 3836 | 'state' => 'ok', |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3829) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3838) |  |
  | 3829 | 3838 | ); |
  | 3830 | 3839 |  |
  | 3831 |  | //Synch records |
  |  | 3840 | // Synch records |
  | 3832 | 3841 | $synch\_records = intval( $wpdb->get\_var( "SELECT COUNT(\*) FROM {$wpdb->prefix}blc\_synch" ) ); |
  | 3833 | 3842 | $data          = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3841) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3850) |  |
  | 3841 | 3850 | $debug['Synch. records'] = $data; |
  | 3842 | 3851 |  |
  | 3843 |  | //Total links and instances (including invalid ones) |
  |  | 3852 | // Total links and instances (including invalid ones) |
  | 3844 | 3853 | $all\_links     = intval( $wpdb->get\_var( "SELECT COUNT(\*) FROM {$wpdb->prefix}blc\_links" ) ); |
  | 3845 | 3854 | $all\_instances = intval( $wpdb->get\_var( "SELECT COUNT(\*) FROM {$wpdb->prefix}blc\_instances" ) ); |
  | 3846 | 3855 |  |
  | 3847 |  | //Show the number of unparsed containers. Useful for debugging. For performance, |
  | 3848 |  | //this is only shown when we have no links/instances yet. |
  |  | 3856 | // Show the number of unparsed containers. Useful for debugging. For performance, |
  |  | 3857 | // this is only shown when we have no links/instances yet. |
  | 3849 | 3858 | if ( ( 0 == $all\_links ) && ( 0 == $all\_instances ) ) { |
  | 3850 | 3859 | $unparsed\_items          = intval( $wpdb->get\_var( "SELECT COUNT(\*) FROM {$wpdb->prefix}blc\_synch WHERE synched=0" ) ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3855) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3864) |  |
  | 3855 | 3864 | } |
  | 3856 | 3865 |  |
  | 3857 |  | //Links & instances |
  |  | 3866 | // Links & instances |
  | 3858 | 3867 | if ( ( $all\_links > 0 ) && ( $all\_instances > 0 ) ) { |
  | 3859 | 3868 | $debug['Link records'] = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3868) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3877) |  |
  | 3868 | 3877 | } |
  | 3869 | 3878 |  |
  | 3870 |  | //Email notifications. |
  |  | 3879 | // Email notifications. |
  | 3871 | 3880 | if ( $this->conf->options['last\_notification\_sent'] ) { |
  | 3872 | 3881 | $notificationDebug = array( |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3895) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3904) |  |
  | 3895 | 3904 | } |
  | 3896 | 3905 |  |
  | 3897 |  | //Installation log |
  |  | 3906 | // Installation log |
  | 3898 | 3907 | $logger           = new blcCachedOptionLogger( 'blc\_installation\_log' ); |
  | 3899 | 3908 | $installation\_log = $logger->get\_messages(); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3921) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3930) |  |
  | 3921 | 3930 | $send\_authors\_notifications = apply\_filters( 'blc\_allow\_send\_author\_email\_notification', $this->conf->options['send\_authors\_email\_notifications'] ); |
  | 3922 | 3931 |  |
  | 3923 |  | if ( ! ( $send\_notification || $send\_authors\_notifications ) ) { |
  |  | 3932 | if ( ! ( $send\_notification || $send\_authors\_notifications ) ) { |
  | 3924 | 3933 | return; |
  | 3925 | 3934 | } |
  | 3926 | 3935 |  |
  | 3927 |  | //Find links that have been detected as broken since the last sent notification. |
  |  | 3936 | // Find links that have been detected as broken since the last sent notification. |
  | 3928 | 3937 | $last\_notification = date( 'Y-m-d H:i:s', $this->conf->options['last\_notification\_sent'] );//phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
  | 3929 | 3938 | $where             = $wpdb->prepare( '( first\_failure >= %s )', $last\_notification ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3944) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3953) |  |
  | 3944 | 3953 | } |
  | 3945 | 3954 |  |
  | 3946 |  | //Send the admin/maintainer an email notification. |
  |  | 3955 | // Send the admin/maintainer an email notification. |
  | 3947 | 3956 | $email = $this->conf->get( 'notification\_email\_address' ); |
  | 3948 | 3957 | if ( empty( $email ) ) { |
  | 3949 |  | //Default to the admin email. |
  |  | 3958 | // Default to the admin email. |
  | 3950 | 3959 | $email = get\_option( 'admin\_email' ); |
  | 3951 | 3960 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3954) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3963) |  |
  | 3954 | 3963 | } |
  | 3955 | 3964 |  |
  | 3956 |  | //Send notifications to post authors |
  |  | 3965 | // Send notifications to post authors |
  | 3957 | 3966 | if ( $this->conf->options['send\_authors\_email\_notifications'] ) { |
  | 3958 | 3967 | $this->send\_authors\_notifications( $links ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L3964) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L3973) |  |
  | 3964 | 3973 |  |
  | 3965 | 3974 | function send\_admin\_notification( $links, $email ) { |
  | 3966 |  | //Prepare email message |
  |  | 3975 | // Prepare email message |
  | 3967 | 3976 | $subject = sprintf( |
  | 3968 | 3977 | \_\_( '[%s] Broken links detected', 'broken-link-checker' ), |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4016) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4025) |  |
  | 4016 | 4025 | $result .= "<p>$line</p>"; |
  | 4017 | 4026 |  |
  | 4018 |  | //Show up to $max\_displayed\_links broken link instances right in the email. |
  |  | 4027 | // Show up to $max\_displayed\_links broken link instances right in the email. |
  | 4019 | 4028 | $displayed = 0; |
  | 4020 | 4029 | foreach ( $instances as $instance ) { /\* @var blcLinkInstance $instance \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4034) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4043) |  |
  | 4034 | 4043 | } |
  | 4035 | 4044 |  |
  | 4036 |  | //Add a link to the "Broken Links" tab. |
  |  | 4045 | // Add a link to the "Broken Links" tab. |
  | 4037 | 4046 | if ( $add\_admin\_link ) { |
  | 4038 | 4047 | $result .= \_\_( 'You can see all broken links here:', 'broken-link-checker' ) . '<br>'; |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4044) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4053) |  |
  | 4044 | 4053 |  |
  | 4045 | 4054 | function send\_html\_email( $email\_address, $subject, $body ) { |
  | 4046 |  | //Need to override the default 'text/plain' content type to send a HTML email. |
  |  | 4055 | // Need to override the default 'text/plain' content type to send a HTML email. |
  | 4047 | 4056 | add\_filter( 'wp\_mail\_content\_type', array( $this, 'override\_mail\_content\_type' ) ); |
  | 4048 | 4057 |  |
  | 4049 |  | //Let auto-responders and similar software know this is an auto-generated email |
  | 4050 |  | //that they shouldn't respond to. |
  |  | 4058 | // Let auto-responders and similar software know this is an auto-generated email |
  |  | 4059 | // that they shouldn't respond to. |
  | 4051 | 4060 | $headers = array( 'Auto-Submitted: auto-generated' ); |
  | 4052 | 4061 |  |
  | 4053 | 4062 | $success = wp\_mail( $email\_address, $subject, $body, $headers ); |
  | 4054 | 4063 |  |
  | 4055 |  | //Remove the override so that it doesn't interfere with other plugins that might |
  | 4056 |  | //want to send normal plaintext emails. |
  |  | 4064 | // Remove the override so that it doesn't interfere with other plugins that might |
  |  | 4065 | // want to send normal plaintext emails. |
  | 4057 | 4066 | remove\_filter( 'wp\_mail\_content\_type', array( $this, 'override\_mail\_content\_type' ) ); |
  | 4058 | 4067 |  |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4142) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4151) |  |
  | 4142 | 4151 | function setup\_cron\_events() { |
  | 4143 | 4152 |  |
  | 4144 |  | //Link monitor |
  |  | 4153 | // Link monitor |
  | 4145 | 4154 | if ( $this->conf->options['run\_via\_cron'] ) { |
  | 4146 | 4155 | if ( ! wp\_next\_scheduled( 'blc\_cron\_check\_links' ) ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4151) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4160) |  |
  | 4151 | 4160 | } |
  | 4152 | 4161 |  |
  | 4153 |  | //Email notifications about broken links |
  |  | 4162 | // Email notifications about broken links |
  | 4154 | 4163 | if ( $this->conf->options['send\_email\_notifications'] || $this->conf->options['send\_authors\_email\_notifications'] ) { |
  | 4155 | 4164 | if ( ! wp\_next\_scheduled( 'blc\_cron\_email\_notifications' ) ) { |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4160) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4169) |  |
  | 4160 | 4169 | } |
  | 4161 | 4170 |  |
  | 4162 |  | //Run database maintenance every two weeks or so |
  |  | 4171 | // Run database maintenance every two weeks or so |
  | 4163 | 4172 | if ( ! wp\_next\_scheduled( 'blc\_cron\_database\_maintenance' ) ) { |
  | 4164 | 4173 | wp\_schedule\_event( time(), 'daily', 'blc\_cron\_database\_maintenance' ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4177) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4186) |  |
  | 4177 | 4186 | /\*\* |
  | 4178 | 4187 | \* Clear blc log file |
  |  | 4188 | \* |
  | 4179 | 4189 | \* @return void |
  | 4180 | 4190 | \*/ |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4182) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4192) |  |
  | 4182 | 4192 | $log\_file = $this->conf->options['log\_file']; |
  | 4183 | 4193 |  |
  | 4184 |  | //clear log file |
  |  | 4194 | // clear log file |
  | 4185 | 4195 | if ( is\_writable( $log\_file ) && is\_file( $log\_file ) ) { |
  | 4186 | 4196 | $handle = fopen( $log\_file, 'w' ); |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4202) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4212) |  |
  | 4202 | 4212 | $last\_modified\_gmt = isset( $postarr['blc\_post\_modified\_gmt'] ) ? $postarr['blc\_post\_modified\_gmt'] : ''; |
  | 4203 | 4213 |  |
  | 4204 |  |  |
  | 4205 | 4214 | // if is not enabled bail! |
  | 4206 |  | if( ! $this->conf->options['blc\_post\_modified'] ) { |
  |  | 4215 | if ( ! $this->conf->options['blc\_post\_modified'] ) { |
  | 4207 | 4216 | return $data; |
  | 4208 | 4217 | } |
  | 4209 | 4218 |  |
  | 4210 |  |  |
  | 4211 | 4219 | // only restore the post modified for BLC links |
  | 4212 |  | if( empty( $last\_modified ) || empty( $last\_modified\_gmt ) ) { |
  |  | 4220 | if ( empty( $last\_modified ) || empty( $last\_modified\_gmt ) ) { |
  | 4213 | 4221 | return $data; |
  | 4214 | 4222 | } |
  | […](/browser/broken-link-checker/trunk/core/core.php?rev=2605914#L4243) | […](/browser/broken-link-checker/trunk/core/core.php?rev=2757773#L4251) |  |
  | 4243 | 4251 | } |
  | 4244 | 4252 |  |
  | 4245 |  | }//~~class ends here~~ |
  |  | 4253 | }//end class |
  | 4246 | 4254 |  |
  | 4247 | 4255 | } // if class\_exists... |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2757773&old=2605914&new_path=%2Fbroken-link-checker%2Ftrunk%2Fcore%2Fcore.php&old_path=%2Fbroken-link-checker%2Ftrunk%2Fcore%2Fcore.php)
* [Zip Archive](?format=zip&new=2757773&old=2605914&new_path=%2Fbroken-link-checker%2Ftrunk%2Fcore%2Fcore.php&old_path=%2Fbroken-link-checker%2Ftrunk%2Fcore%2Fcore.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


