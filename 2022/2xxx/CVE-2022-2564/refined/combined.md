=== Content from github.com_c9cafd4a_20250114_191629.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fblob%2F51e758541763b6f14569744ced15cc23ab8b50c6%2Flib%2Fschema.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fblob%2F51e758541763b6f14569744ced15cc23ab8b50c6%2Flib%2Fschema.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Automattic%2Fmongoose)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Automattic](/Automattic)
/
**[mongoose](/Automattic/mongoose)**
Public

* [Notifications](/login?return_to=%2FAutomattic%2Fmongoose) You must be signed in to change notification settings
* [Fork
  3.9k](/login?return_to=%2FAutomattic%2Fmongoose)
* [Star
   27k](/login?return_to=%2FAutomattic%2Fmongoose)

* [Code](/Automattic/mongoose)
* [Issues
  225](/Automattic/mongoose/issues)
* [Pull requests
  2](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects
  0](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

Additional navigation options

* [Code](/Automattic/mongoose)
* [Issues](/Automattic/mongoose/issues)
* [Pull requests](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

## Files

 51e7585
## Breadcrumbs

1. [mongoose](/Automattic/mongoose/tree/51e758541763b6f14569744ced15cc23ab8b50c6)
2. /[lib](/Automattic/mongoose/tree/51e758541763b6f14569744ced15cc23ab8b50c6/lib)
/
# schema.js

Copy path Blame  Blame
## Latest commit

## History

[History](/Automattic/mongoose/commits/51e758541763b6f14569744ced15cc23ab8b50c6/lib/schema.js)2155 lines (1905 loc) · 62.1 KB 51e7585
## Breadcrumbs

1. [mongoose](/Automattic/mongoose/tree/51e758541763b6f14569744ced15cc23ab8b50c6)
2. /[lib](/Automattic/mongoose/tree/51e758541763b6f14569744ced15cc23ab8b50c6/lib)
/
# schema.js

Top
## File metadata and controls

* Code
* Blame

2155 lines (1905 loc) · 62.1 KB[Raw](https://github.com/Automattic/mongoose/raw/51e758541763b6f14569744ced15cc23ab8b50c6/lib/schema.js)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000'use strict';
/\*! \* Module dependencies. \*/
const EventEmitter = require('events').EventEmitter;const Kareem = require('kareem');const MongooseError = require('./error/mongooseError');const SchemaType = require('./schematype');const SchemaTypeOptions = require('./options/SchemaTypeOptions');const VirtualOptions = require('./options/VirtualOptions');const VirtualType = require('./virtualtype');const addAutoId = require('./helpers/schema/addAutoId');const get = require('./helpers/get');const getConstructorName = require('./helpers/getConstructorName');const getIndexes = require('./helpers/schema/getIndexes');const merge = require('./helpers/schema/merge');const mpath = require('mpath');const readPref = require('./driver').get().ReadPreference;const setupTimestamps = require('./helpers/timestamps/setupTimestamps');const utils = require('./utils');const validateRef = require('./helpers/populate/validateRef');
let MongooseTypes;
const queryHooks = require('./helpers/query/applyQueryMiddleware'). middlewareFunctions;const documentHooks = require('./helpers/model/applyHooks').middlewareFunctions;const hookNames = queryHooks.concat(documentHooks). reduce((s, hook) => s.add(hook), new Set());
let id = 0;
/\*\* \* Schema constructor. \* \* ####Example: \* \* const child = new Schema({ name: String }); \* const schema = new Schema({ name: String, age: Number, children: [child] }); \* const Tree = mongoose.model('Tree', schema); \* \* // setting schema options \* new Schema({ name: String }, { \_id: false, autoIndex: false }) \* \* ####Options: \* \* - [autoIndex](/docs/guide.html#autoIndex): bool - defaults to null (which means use the connection's autoIndex option) \* - [autoCreate](/docs/guide.html#autoCreate): bool - defaults to null (which means use the connection's autoCreate option) \* - [bufferCommands](/docs/guide.html#bufferCommands): bool - defaults to true \* - [bufferTimeoutMS](/docs/guide.html#bufferTimeoutMS): number - defaults to 10000 (10 seconds). If `bufferCommands` is enabled, the amount of time Mongoose will wait for connectivity to be restablished before erroring out. \* - [capped](/docs/guide.html#capped): bool - defaults to false \* - [collection](/docs/guide.html#collection): string - no default \* - [discriminatorKey](/docs/guide.html#discriminatorKey): string - defaults to `\_\_t` \* - [id](/docs/guide.html#id): bool - defaults to true \* - [\_id](/docs/guide.html#\_id): bool - defaults to true \* - [minimize](/docs/guide.html#minimize): bool - controls [document#toObject](#document\_Document-toObject) behavior when called manually - defaults to true \* - [read](/docs/guide.html#read): string \* - [writeConcern](/docs/guide.html#writeConcern): object - defaults to null, use to override [the MongoDB server's default write concern settings](https://docs.mongodb.com/manual/reference/write-concern/) \* - [shardKey](/docs/guide.html#shardKey): object - defaults to `null` \* - [strict](/docs/guide.html#strict): bool - defaults to true \* - [toJSON](/docs/guide.html#toJSON) - object - no default \* - [toObject](/docs/guide.html#toObject) - object - no default \* - [typeKey](/docs/guide.html#typeKey) - string - defaults to 'type' \* - [validateBeforeSave](/docs/guide.html#validateBeforeSave) - bool - defaults to `true` \* - [versionKey](/docs/guide.html#versionKey): string or object - defaults to "\_\_v" \* - [optimisticConcurrency](/docs/guide.html#optimisticConcurrency): bool - defaults to false. Set to true to enable [optimistic concurrency](https://thecodebarbarian.com/whats-new-in-mongoose-5-10-optimistic-concurrency.html). \* - [collation](/docs/guide.html#collation): object - defaults to null (which means use no collation) \* - [selectPopulatedPaths](/docs/guide.html#selectPopulatedPaths): boolean - defaults to `true` \* - [skipVersioning](/docs/guide.html#skipVersioning): object - paths to exclude from versioning \* - [timestamps](/docs/guide.html#timestamps): object or boolean - defaults to `false`. If true, Mongoose adds `createdAt` and `updatedAt` properties to your schema and manages those properties for you. \* \* ####Options for Nested Schemas: \* - `excludeIndexes`: bool - defaults to `false`. If `true`, skip building indexes on this schema's paths. \* \* ####Note: \* \* \_When nesting schemas, (`children` in the example above), always declare the child schema first before passing it into its parent.\_ \* \* @param {Object|Schema|Array} [definition] Can be one of: object describing schema paths, or schema to copy, or array of objects and schemas \* @param {Object} [options] \* @inherits NodeJS EventEmitter http://nodejs.org/api/events.html#events\_class\_events\_eventemitter \* @event `init`: Emitted after the schema is compiled into a `Model`. \* @api public \*/
function Schema(obj, options) { if (!(this instanceof Schema)) { return new Schema(obj, options); }
 this.obj = obj; this.paths = {}; this.aliases = {}; this.subpaths = {}; this.virtuals = {}; this.singleNestedPaths = {}; this.nested = {}; this.inherits = {}; this.callQueue = []; this.\_indexes = []; this.methods = {}; this.methodOptions = {}; this.statics = {}; this.tree = {}; this.query = {}; this.childSchemas = []; this.plugins = []; // For internal debugging. Do not use this to try to save a schema in MDB. this.$id = ++id; this.mapPaths = [];
 this.s = { hooks: new Kareem() };
 this.options = this.defaultOptions(options);
 // build paths if (Array.isArray(obj)) { for (const definition of obj) { this.add(definition); } } else if (obj) { this.add(obj); }
 // check if \_id's value is a subdocument (gh-2276) const \_idSubDoc = obj && obj.\_id && utils.isObject(obj.\_id);
 // ensure the documents get an auto \_id unless disabled const auto\_id = !this.paths['\_id'] && (this.options.\_id) && !\_idSubDoc;
 if (auto\_id) { addAutoId(this); }
 this.setupTimestamp(this.options.timestamps);}
/\*! \* Create virtual properties with alias field \*/function aliasFields(schema, paths) { paths = paths || Object.keys(schema.paths); for (const path of paths) { const options = get(schema.paths[path], 'options'); if (options == null) { continue; }
 const prop = schema.paths[path].path; const alias = options.alias;
 if (!alias) { continue; }
 if (typeof alias !== 'string') { throw new Error('Invalid value for alias option on ' + prop + ', got ' + alias); }
 schema.aliases[alias] = prop;
 schema. virtual(alias). get((function(p) { return function() { if (typeof this.get === 'function') { return this.get(p); } return this[p]; }; })(prop)). set((function(p) { return function(v) { return this.$set(p, v); }; })(prop)); }}
/\*! \* Inherit from EventEmitter. \*/Schema.prototype = Object.create(EventEmitter.prototype);Schema.prototype.constructor = Schema;Schema.prototype.instanceOfSchema = true;
/\*! \* ignore \*/
Object.defineProperty(Schema.prototype, '$schemaType', { configurable: false, enumerable: false, writable: true});
/\*\* \* Array of child schemas (from document arrays and single nested subdocs) \* and their corresponding compiled models. Each element of the array is \* an object with 2 properties: `schema` and `model`. \* \* This property is typically only useful for plugin authors and advanced users. \* You do not need to interact with this property at all to use mongoose. \* \* @api public \* @property childSchemas \* @memberOf Schema \* @instance \*/
Object.defineProperty(Schema.prototype, 'childSchemas', { configurable: false, enumerable: true, writable: true});
/\*\* \* The original object passed to the schema constructor \* \* ####Example: \* \* const schema = new Schema({ a: String }).add({ b: String }); \* schema.obj; // { a: String } \* \* @api public \* @property obj \* @memberOf Schema \* @instance \*/
Schema.prototype.obj;
/\*\* \* The paths defined on this schema. The keys are the top-level paths \* in this schema, and the values are instances of the SchemaType class. \* \* ####Example: \* const schema = new Schema({ name: String }, { \_id: false }); \* schema.paths; // { name: SchemaString { ... } } \* \* schema.add({ age: Number }); \* schema.paths; // { name: SchemaString { ... }, age: SchemaNumber { ... } } \* \* @api public \* @property paths \* @memberOf Schema \* @instance \*/
Schema.prototype.paths;
/\*\* \* Schema as a tree \* \* ####Example: \* { \* '\_id' : ObjectId \* , 'nested' : { \* 'key' : String \* } \* } \* \* @api private \* @property tree \* @memberOf Schema \* @instance \*/
Schema.prototype.tree;
/\*\* \* Returns a deep copy of the schema \* \* ####Example: \* \* const schema = new Schema({ name: String }); \* const clone = schema.clone(); \* clone === schema; // false \* clone.path('name'); // SchemaString { ... } \* \* @return {Schema} the cloned schema \* @api public \* @memberOf Schema \* @instance \*/
Schema.prototype.clone = function() { const Constructor = this.base == null ? Schema : this.base.Schema;
 const s = new Constructor({}, this.\_userProvidedOptions); s.base = this.base; s.obj = this.obj; s.options = utils.clone(this.options); s.callQueue = this.callQueue.map(function(f) { return f; }); s.methods = utils.clone(this.methods); s.methodOptions = utils.clone(this.methodOptions); s.statics = utils.clone(this.statics); s.query = utils.clone(this.query); s.plugins = Array.prototype.slice.call(this.plugins); s.\_indexes = utils.clone(this.\_indexes); s.s.hooks = this.s.hooks.clone();
 s.tree = utils.clone(this.tree); s.paths = utils.clone(this.paths); s.nested = utils.clone(this.nested); s.subpaths = utils.clone(this.subpaths); s.singleNestedPaths = utils.clone(this.singleNestedPaths); s.childSchemas = gatherChildSchemas(s);
 s.virtuals = utils.clone(this.virtuals); s.$globalPluginsApplied = this.$globalPluginsApplied; s.$isRootDiscriminator = this.$isRootDiscriminator; s.$implicitlyCreated = this.$implicitlyCreated; s.$id = ++id; s.$originalSchemaId = this.$id; s.mapPaths = [].concat(this.mapPaths);
 if (this.discriminatorMapping != null) { s.discriminatorMapping = Object.assign({}, this.discriminatorMapping); } if (this.discriminators != null) { s.discriminators = Object.assign({}, this.discriminators); }
 s.aliases = Object.assign({}, this.aliases);
 // Bubble up `init` for backwards compat s.on('init', v => this.emit('init', v));
 return s;};
/\*\* \* Returns a new schema that has the picked `paths` from this schema. \* \* This method is analagous to [Lodash's `pick()` function](https://lodash.com/docs/4.17.15#pick) for Mongoose schemas. \* \* ####Example: \* \* const schema = Schema({ name: String, age: Number }); \* // Creates a new schema with the same `name` path as `schema`, \* // but no `age` path. \* const newSchema = schema.pick(['name']); \* \* newSchema.path('name'); // SchemaString { ... } \* newSchema.path('age'); // undefined \* \* @param {Array} paths list of paths to pick \* @param {Object} [options] options to pass to the schema constructor. Defaults to `this.options` if not set. \* @return {Schema} \* @api public \*/
Schema.prototype.pick = function(paths, options) { const newSchema = new Schema({}, options || this.options); if (!Array.isArray(paths)) { throw new MongooseError('Schema#pick() only accepts an array argument, ' + 'got "' + typeof paths + '"'); }
 for (const path of paths) { if (this.nested[path]) { newSchema.add({ [path]: get(this.tree, path) }); } else { const schematype = this.path(path); if (schematype == null) { throw new MongooseError('Path `' + path + '` is not in the schema'); } newSchema.add({ [path]: schematype }); } }
 return newSchema;};
/\*\* \* Returns default options for this schema, merged with `options`. \* \* @param {Object} options \* @return {Object} \* @api private \*/
Schema.prototype.defaultOptions = function(options) { this.\_userProvidedOptions = options == null ? {} : utils.clone(options);
 const baseOptions = get(this, 'base.options', {}); options = utils.options({ strict: 'strict' in baseOptions ? baseOptions.strict : true, bufferCommands: true, capped: false, // { size, max, autoIndexId } versionKey: '\_\_v', optimisticConcurrency: false, minimize: true, autoIndex: null, discriminatorKey: '\_\_t', shardKey: null, read: null, validateBeforeSave: true, // the following are only applied at construction time \_id: true, id: true, typeKey: 'type' }, utils.clone(options));
 if (options.read) { options.read = readPref(options.read); }
 if (options.optimisticConcurrency && !options.versionKey) { throw new MongooseError('Must set `versionKey` if using `optimisticConcurrency`'); }
 return options;};
/\*\* \* Adds key path / schema type pairs to this schema. \* \* ####Example: \* \* const ToySchema = new Schema(); \* ToySchema.add({ name: 'string', color: 'string', price: 'number' }); \* \* const TurboManSchema = new Schema(); \* // You can also `add()` another schema and copy over all paths, virtuals, \* // getters, setters, indexes, methods, and statics. \* TurboManSchema.add(ToySchema).add({ year: Number }); \* \* @param {Object|Schema} obj plain object with paths to add, or another schema \* @param {String} [prefix] path to prefix the newly added paths with \* @return {Schema} the Schema instance \* @api public \*/
Schema.prototype.add = function add(obj, prefix) { if (obj instanceof Schema || (obj != null && obj.instanceOfSchema)) { merge(this, obj);
 return this; }
 // Special case: setting top-level `\_id` to false should convert to disabling // the `\_id` option. This behavior never worked before 5.4.11 but numerous // codebases use it (see gh-7516, gh-7512). if (obj.\_id === false && prefix == null) { this.options.\_id = false; }
 prefix = prefix || ''; // avoid prototype pollution if (prefix === '\_\_proto\_\_.' || prefix === 'constructor.' || prefix === 'prototype.') { return this; }
 const keys = Object.keys(obj);
 for (const key of keys) { const fullPath = prefix + key;
 if (obj[key] == null) { throw new TypeError('Invalid value for schema path `' + fullPath + '`, got value "' + obj[key] + '"'); } // Retain `\_id: false` but don't set it as a path, re: gh-8274. if (key === '\_id' && obj[key] === false) { continue; } if (obj[key] instanceof VirtualType || get(obj[key], 'constructor.name', null) === 'VirtualType') { this.virtual(obj[key]); continue; }
 if (Array.isArray(obj[key]) && obj[key].length === 1 && obj[key][0] == null) { throw new TypeError('Invalid value for schema Array path `' + fullPath + '`, got value "' + obj[key][0] + '"'); }
 if (!(utils.isPOJO(obj[key]) || obj[key] instanceof SchemaTypeOptions)) { // Special-case: Non-options definitely a path so leaf at this node // Examples: Schema instances, SchemaType instances if (prefix) { this.nested[prefix.substr(0, prefix.length - 1)] = true; } this.path(prefix + key, obj[key]); } else if (Object.keys(obj[key]).length < 1) { // Special-case: {} always interpreted as Mixed path so leaf at this node if (prefix) { this.nested[prefix.substr(0, prefix.length - 1)] = true; } this.path(fullPath, obj[key]); // mixed type } else if (!obj[key][this.options.typeKey] || (this.options.typeKey === 'type' && obj[key].type.type)) { // Special-case: POJO with no bona-fide type key - interpret as tree of deep paths so recurse // nested object { last: { name: String }} this.nested[fullPath] = true; this.add(obj[key], fullPath + '.'); } else { // There IS a bona-fide type key that may also be a POJO const \_typeDef = obj[key][this.options.typeKey]; if (utils.isPOJO(\_typeDef) && Object.keys(\_typeDef).length > 0) { // If a POJO is the value of a type key, make it a subdocument if (prefix) { this.nested[prefix.substr(0, prefix.length - 1)] = true; } const \_schema = new Schema(\_typeDef); const schemaWrappedPath = Object.assign({}, obj[key], { type: \_schema }); this.path(prefix + key, schemaWrappedPath); } else { // Either the type is non-POJO or we interpret it as Mixed anyway if (prefix) { this.nested[prefix.substr(0, prefix.length - 1)] = true; } this.path(prefix + key, obj[key]); } } }
 const addedKeys = Object.keys(obj). map(key => prefix ? prefix + key : key); aliasFields(this, addedKeys); return this;};
/\*\* \* Reserved document keys. \* \* Keys in this object are names that are warned in schema declarations \* because they have the potential to break Mongoose/ Mongoose plugins functionality. If you create a schema \* using `new Schema()` with one of these property names, Mongoose will log a warning. \* \* - \_posts \* - \_pres \* - collection \* - emit \* - errors \* - get \* - init \* - isModified \* - isNew \* - listeners \* - modelName \* - on \* - once \* - populated \* - prototype \* - remove \* - removeListener \* - save \* - schema \* - toObject \* - validate \* \* \_NOTE:\_ Use of these terms as method names is permitted, but play at your own risk, as they may be existing mongoose document methods you are stomping on. \* \* const schema = new Schema(..); \* schema.methods.init = function () {} // potentially breaking \*/
Schema.reserved = Object.create(null);Schema.prototype.reserved = Schema.reserved;
const reserved = Schema.reserved;// Core objectreserved['prototype'] =// EventEmitterreserved.emit =reserved.listeners =reserved.on =reserved.removeListener =
// document properties and functionsreserved.collection =reserved.errors =reserved.get =reserved.init =reserved.isModified =reserved.isNew =reserved.populated =reserved.remove =reserved.save =reserved.toObject =reserved.validate = 1;reserved.collection = 1;
/\*\* \* Gets/sets schema paths. \* \* Sets a path (if arity 2) \* Gets a path (if arity 1) \* \* ####Example \* \* schema.path('name') // returns a SchemaType \* schema.path('name', Number) // changes the schemaType of `name` to Number \* \* @param {String} path \* @param {Object} constructor \* @api public \*/
Schema.prototype.path = function(path, obj) { // Convert to '.$' to check subpaths re: gh-6405 const cleanPath = \_pathToPositionalSyntax(path); if (obj === undefined) { let schematype = \_getPath(this, path, cleanPath); if (schematype != null) { return schematype; }
 // Look for maps const mapPath = getMapPath(this, path); if (mapPath != null) { return mapPath; }
 // Look if a parent of this path is mixed schematype = this.hasMixedParent(cleanPath); if (schematype != null) { return schematype; }
 // subpaths? return /\.\d+\.?.\*$/.test(path) ? getPositionalPath(this, path) : undefined; }
 // some path names conflict with document methods const firstPieceOfPath = path.split('.')[0]; if (reserved[firstPieceOfPath] && !this.options.supressReservedKeysWarning) { const errorMessage = `\`${firstPieceOfPath}\` is a reserved schema pathname and may break some functionality. ` + 'You are allowed to use it, but use at your own risk. ' + 'To disable this warning pass `supressReservedKeysWarning` as a schema option.';
 console.warn(errorMessage); }
 if (typeof obj === 'object' && utils.hasUserDefinedProperty(obj, 'ref')) { validateRef(obj.ref, path); }
 // update the tree const subpaths = path.split(/\./); const last = subpaths.pop(); let branch = this.tree; let fullPath = '';
 for (const sub of subpaths) { fullPath = fullPath += (fullPath.length > 0 ? '.' : '') + sub; if (!branch[sub]) { this.nested[fullPath] = true; branch[sub] = {}; } if (typeof branch[sub] !== 'object') { const msg = 'Cannot set nested path `' + path + '`. ' + 'Parent path `' + fullPath + '` already set to type ' + branch[sub].name + '.'; throw new Error(msg); } branch = branch[sub]; }
 branch[last] = utils.clone(obj);
 this.paths[path] = this.interpretAsType(path, obj, this.options); const schemaType = this.paths[path];
 if (schemaType.$isSchemaMap) { // Maps can have arbitrary keys, so `$\*` is internal shorthand for "any key" // The '$' is to imply this path should never be stored in MongoDB so we // can easily build a regexp out of this path, and '\*' to imply "any key." const mapPath = path + '.$\*'; let \_mapType = { type: {} }; if (utils.hasUserDefinedProperty(obj, 'of')) { const isInlineSchema = utils.isPOJO(obj.of) && Object.keys(obj.of).length > 0 && !utils.hasUserDefinedProperty(obj.of, this.options.typeKey); \_mapType = isInlineSchema ? new Schema(obj.of) : obj.of; } if (utils.hasUserDefinedProperty(obj, 'ref')) { \_mapType = { type: \_mapType, ref: obj.ref }; }
 this.paths[mapPath] = this.interpretAsType(mapPath, \_mapType, this.options); this.mapPaths.push(this.paths[mapPath]); schemaType.$\_\_schemaType = this.paths[mapPath]; }
 if (schemaType.$isSingleNested) { for (const key of Object.keys(schemaType.schema.paths)) { this.singleNestedPaths[path + '.' + key] = schemaType.schema.paths[key]; } for (const key of Object.keys(schemaType.schema.singleNestedPaths)) { this.singleNestedPaths[path + '.' + key] = schemaType.schema.singleNestedPaths[key]; } for (const key of Object.keys(schemaType.schema.subpaths)) { this.singleNestedPaths[path + '.' + key] = schemaType.schema.subpaths[key]; } for (const key of Object.keys(schemaType.schema.nested)) { this.singleNestedPaths[path + '.' + key] = 'nested'; }
 Object.defineProperty(schemaType.schema, 'base', { configurable: true, enumerable: false, writable: false, value: this.base });
 schemaType.caster.base = this.base; this.childSchemas.push({ schema: schemaType.schema, model: schemaType.caster }); } else if (schemaType.$isMongooseDocumentArray) { Object.defineProperty(schemaType.schema, 'base', { configurable: true, enumerable: false, writable: false, value: this.base });
 schemaType.casterConstructor.base = this.base; this.childSchemas.push({ schema: schemaType.schema, model: schemaType.casterConstructor }); }
 if (schemaType.$isMongooseArray && schemaType.caster instanceof SchemaType) { let arrayPath = path; let \_schemaType = schemaType;
 const toAdd = []; while (\_schemaType.$isMongooseArray) { arrayPath = arrayPath + '.$';
 // Skip arrays of document arrays if (\_schemaType.$isMongooseDocumentArray) { \_schemaType.$embeddedSchemaType.\_arrayPath = arrayPath; \_schemaType.$embeddedSchemaType.\_arrayParentPath = path; \_schemaType = \_schemaType.$embeddedSchemaType.clone(); } else { \_schemaType.caster.\_arrayPath = arrayPath; \_schemaType.caster.\_arrayParentPath = path; \_schemaType = \_schemaType.caster.clone(); }
 \_schemaType.path = arrayPath; toAdd.push(\_schemaType); }
 for (const \_schemaType of toAdd) { this.subpaths[\_schemaType.path] = \_schemaType; } }
 if (schemaType.$isMongooseDocumentArray) { for (const key of Object.keys(schemaType.schema.paths)) { const \_schemaType = schemaType.schema.paths[key]; this.subpaths[path + '.' + key] = \_schemaType; if (typeof \_schemaType === 'object' && \_schemaType != null) { \_schemaType.$isUnderneathDocArray = true; } } for (const key of Object.keys(schemaType.schema.subpaths)) { const \_schemaType = schemaType.schema.subpaths[key]; this.subpaths[path + '.' + key] = \_schemaType; if (typeof \_schemaType === 'object' && \_schemaType != null) { \_schemaType.$isUnderneathDocArray = true; } } for (const key of Object.keys(schemaType.schema.singleNestedPaths)) { const \_schemaType = schemaType.schema.singleNestedPaths[key]; this.subpaths[path + '.' + key] = \_schemaType; if (typeof \_schemaType === 'object' && \_schemaType != null) { \_schemaType.$isUnderneathDocArray = true; } } }
 return this;};
/\*! \* ignore \*/
function gatherChildSchemas(schema) { const childSchemas = [];
 for (const path of Object.keys(schema.paths)) { const schematype = schema.paths[path]; if (schematype.$isMongooseDocumentArray || schematype.$isSingleNested) { childSchemas.push({ schema: schematype.schema, model: schematype.caster }); } }
 return childSchemas;}
/\*! \* ignore \*/
function \_getPath(schema, path, cleanPath) { if (schema.paths.hasOwnProperty(path)) { return schema.paths[path]; } if (schema.subpaths.hasOwnProperty(cleanPath)) { return schema.subpaths[cleanPath]; } if (schema.singleNestedPaths.hasOwnProperty(cleanPath) && typeof schema.singleNestedPaths[cleanPath] === 'object') { return schema.singleNestedPaths[cleanPath]; }
 return null;}
/\*! \* ignore \*/
function \_pathToPositionalSyntax(path) { if (!/\.\d+/.test(path)) { return path; } return path.replace(/\.\d+\./g, '.$.').replace(/\.\d+$/, '.$');}
/\*! \* ignore \*/
function getMapPath(schema, path) { if (schema.mapPaths.length === 0) { return null; } for (const val of schema.mapPaths) { const \_path = val.path; const re = new RegExp('^' + \_path.replace(/\.\$\\*/g, '\\.[^.]+') + '$'); if (re.test(path)) { return schema.paths[\_path]; } }
 return null;}
/\*\* \* The Mongoose instance this schema is associated with \* \* @property base \* @api private \*/
Object.defineProperty(Schema.prototype, 'base', { configurable: true, enumerable: false, writable: true, value: null});
/\*\* \* Converts type arguments into Mongoose Types. \* \* @param {String} path \* @param {Object} obj constructor \* @api private \*/
Schema.prototype.interpretAsType = function(path, obj, options) { if (obj instanceof SchemaType) { if (obj.path === path) { return obj; } const clone = obj.clone(); clone.path = path; return clone; }
 // If this schema has an associated Mongoose object, use the Mongoose object's // copy of SchemaTypes re: gh-7158 gh-6933 const MongooseTypes = this.base != null ? this.base.Schema.Types : Schema.Types;
 if (!utils.isPOJO(obj) && !(obj instanceof SchemaTypeOptions)) { const constructorName = utils.getFunctionName(obj.constructor); if (constructorName !== 'Object') { const oldObj = obj; obj = {}; obj[options.typeKey] = oldObj; } }
 // Get the type making sure to allow keys named "type" // and default to mixed if not specified. // { type: { type: String, default: 'freshcut' } } let type = obj[options.typeKey] && (options.typeKey !== 'type' || !obj.type.type) ? obj[options.typeKey] : {}; let name;
 if (utils.isPOJO(type) || type === 'mixed') { return new MongooseTypes.Mixed(path, obj); }
 if (Array.isArray(type) || type === Array || type === 'array' || type === MongooseTypes.Array) { // if it was specified through { type } look for `cast` let cast = (type === Array || type === 'array') ? obj.cast || obj.of : type[0];
 if (cast && cast.instanceOfSchema) { if (!(cast instanceof Schema)) { throw new TypeError('Schema for array path `' + path + '` is from a different copy of the Mongoose module. Please make sure you\'re using the same version ' + 'of Mongoose everywhere with `npm list mongoose`.'); } return new MongooseTypes.DocumentArray(path, cast, obj); } if (cast && cast[options.typeKey] && cast[options.typeKey].instanceOfSchema) { if (!(cast[options.typeKey] instanceof Schema)) { throw new TypeError('Schema for array path `' + path + '` is from a different copy of the Mongoose module. Please make sure you\'re using the same version ' + 'of Mongoose everywhere with `npm list mongoose`.'); } return new MongooseTypes.DocumentArray(path, cast[options.typeKey], obj, cast); }
 if (Array.isArray(cast)) { return new MongooseTypes.Array(path, this.interpretAsType(path, cast, options), obj); }
 if (typeof cast === 'string') { cast = MongooseTypes[cast.charAt(0).toUpperCase() + cast.substring(1)]; } else if (cast && (!cast[options.typeKey] || (options.typeKey === 'type' && cast.type.type)) && utils.isPOJO(cast)) { if (Object.keys(cast).length) { // The `minimize` and `typeKey` options propagate to child schemas // declared inline, like `{ arr: [{ val: { $type: String } }] }`. // See gh-3560 const childSchemaOptions = { minimize: options.minimize }; if (options.typeKey) { childSchemaOptions.typeKey = options.typeKey; } // propagate 'strict' option to child schema if (options.hasOwnProperty('strict')) { childSchemaOptions.strict = options.strict; } if (this.\_userProvidedOptions.hasOwnProperty('\_id')) { childSchemaOptions.\_id = this.\_userProvidedOptions.\_id; } else if (Schema.Types.DocumentArray.defaultOptions.\_id != null) { childSchemaOptions.\_id = Schema.Types.DocumentArray.defaultOptions.\_id; } const childSchema = new Schema(cast, childSchemaOptions); childSchema.$implicitlyCreated = true; return new MongooseTypes.DocumentArray(path, childSchema, obj); } else { // Special case: empty object becomes mixed return new MongooseTypes.Array(path, MongooseTypes.Mixed, obj); } }
 if (cast) { type = cast[options.typeKey] && (options.typeKey !== 'type' || !cast.type.type) ? cast[options.typeKey] : cast;
 name = typeof type === 'string' ? type : type.schemaName || utils.getFunctionName(type);
 // For Jest 26+, see #10296 if (name === 'ClockDate') { name = 'Date'; }
 if (!MongooseTypes.hasOwnProperty(name)) { throw new TypeError('Invalid schema configuration: ' + `\`${name}\` is not a valid type within the array \`${path}\`.` + 'See http://bit.ly/mongoose-schematypes for a list of valid schema types.'); } }
 return new MongooseTypes.Array(path, cast || MongooseTypes.Mixed, obj, options); }
 if (type && type.instanceOfSchema) {[View remainder of file in raw view](https://github.com/Automattic/mongoose/raw/51e758541763b6f14569744ced15cc23ab8b50c6/lib/schema.js)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_53986264_20250114_191630.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fcompare%2F6.4.5...6.4.6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fcompare%2F6.4.5...6.4.6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcompare%2Fshow&source=header-repo&source_repo=Automattic%2Fmongoose)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Automattic](/Automattic)
/
**[mongoose](/Automattic/mongoose)**
Public

* [Notifications](/login?return_to=%2FAutomattic%2Fmongoose) You must be signed in to change notification settings
* [Fork
  3.9k](/login?return_to=%2FAutomattic%2Fmongoose)
* [Star
   27k](/login?return_to=%2FAutomattic%2Fmongoose)

* [Code](/Automattic/mongoose)
* [Issues
  225](/Automattic/mongoose/issues)
* [Pull requests
  2](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects
  0](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

Additional navigation options

* [Code](/Automattic/mongoose)
* [Issues](/Automattic/mongoose/issues)
* [Pull requests](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

[Permalink](https://github.com/Automattic/mongoose/compare/Automattic%3Abc302f4...Automattic%3A5449ab9)
# Comparing changes

 Choose two branches to see what’s changed or to start a new pull request.
If you need to, you can also  compare across forks
 or
[learn more about diff comparisons](https://docs.github.com/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-comparing-branches-in-pull-requests#three-dot-and-two-dot-git-diff-comparisons).

# Open a pull request

 Create a new pull request by comparing changes across two branches. If you need to, you can also  compare across forks
.
[Learn more about diff comparisons here](https://docs.github.com/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-comparing-branches-in-pull-requests#three-dot-and-two-dot-git-diff-comparisons).

*base repository:*
Automattic/mongoose

Failed to load repositories. Confirm that selected base ref is valid, then try again.

 Loading

*base:*
6.4.5

Choose a base ref

Branches
Tags

Could not load branches

Nothing to show

 Loading

[{{ refName }}
default](/Automattic/mongoose/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...6.4.6)

Could not load tags

Nothing to show

[{{ refName }}
default](/Automattic/mongoose/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...6.4.6)

 Loading

...

*head repository:*
Automattic/mongoose

Failed to load repositories. Confirm that selected head ref is valid, then try again.

 Loading

*compare:*
6.4.6

Choose a head ref

Branches
Tags

Could not load branches

Nothing to show

 Loading

[{{ refName }}
default](/Automattic/mongoose/compare/6.4.5...%7B%7B%20urlEncodedRefName%20%7D%7D)

Could not load tags

Nothing to show

[{{ refName }}
default](/Automattic/mongoose/compare/6.4.5...%7B%7B%20urlEncodedRefName%20%7D%7D)

 Loading

3
contributors

[Commits
35](#commits_bucket)
[Files changed
35](#files_bucket)

 Loading

 Loading

### This comparison is taking too long to generate.

Unfortunately it looks like we can’t render this comparison for you right now. It might be too big, or there might be something weird with your repository.

You can try running this command locally to see the comparison on your machine:

`git diff 6.4.5...6.4.6`

  Retry

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from huntr.dev_17e261bf_20250114_191631.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)

=== Content from github.com_b1fa2cdf_20250114_191630.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fautomattic%2Fmongoose%2Fcommit%2Fa45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fautomattic%2Fmongoose%2Fcommit%2Fa45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Automattic%2Fmongoose)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Automattic](/Automattic)
/
**[mongoose](/Automattic/mongoose)**
Public

* [Notifications](/login?return_to=%2FAutomattic%2Fmongoose) You must be signed in to change notification settings
* [Fork
  3.9k](/login?return_to=%2FAutomattic%2Fmongoose)
* [Star
   27k](/login?return_to=%2FAutomattic%2Fmongoose)

* [Code](/Automattic/mongoose)
* [Issues
  225](/Automattic/mongoose/issues)
* [Pull requests
  2](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects
  0](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

Additional navigation options

* [Code](/Automattic/mongoose)
* [Issues](/Automattic/mongoose/issues)
* [Pull requests](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

## Commit

[Permalink](/Automattic/mongoose/commit/a45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(schema): disallow setting \_\_proto\_\_ when creating schema with dot…

[Browse files](/Automattic/mongoose/tree/a45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8)
Browse the repository at this point in the history

```
…ted properties

Fix [#12085](https://github.com/Automattic/mongoose/issues/12085)
```

* Loading branch information

[![@vkarpov15](https://avatars.githubusercontent.com/u/1620265?s=40&v=4)](/vkarpov15)

[vkarpov15](/Automattic/mongoose/commits?author=vkarpov15 "View all commits by vkarpov15")
committed
Jul 19, 2022

1 parent
[bc302f4](/Automattic/mongoose/commit/bc302f4667d62eadc8841a1946d5eefe9353f459)

commit a45cfb6

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**17 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* lib

  + lib/schema.js
    [schema.js](#diff-ffadab0ba7a844f70b864530afe444d3684ca96212ca5b3e3bcd72291e535123)
* test

  + test/schema.test.js
    [schema.test.js](#diff-7d289728ae6f90276c804692fb857968b19133795d42f75657b37db284a2be09)

## There are no files selected for viewing

7 changes: 7 additions & 0 deletions

7
[lib/schema.js](#diff-ffadab0ba7a844f70b864530afe444d3684ca96212ca5b3e3bcd72291e535123 "lib/schema.js")

Show comments

[View file](/Automattic/mongoose/blob/a45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8/lib/schema.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -554,6 +554,10 @@ Schema.prototype.add = function add(obj, prefix) { |
|  |  | const keys = Object.keys(obj); |
|  |  | const typeKey = this.options.typeKey; |
|  |  | for (const key of keys) { |
|  |  | if (utils.specialProperties.has(key)) { |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | const fullPath = prefix + key; |
|  |  | const val = obj[key]; |
|  |  |  |
| Expand Down  Expand Up | | @@ -854,6 +858,9 @@ Schema.prototype.path = function(path, obj) { |
|  |  | let fullPath = ''; |
|  |  |  |
|  |  | for (const sub of subpaths) { |
|  |  | if (utils.specialProperties.has(sub)) { |
|  |  | throw new Error('Cannot set special property `' + sub + '` on a schema'); |
|  |  | } |
|  |  | fullPath = fullPath += (fullPath.length > 0 ? '.' : '') + sub; |
|  |  | if (!branch[sub]) { |
|  |  | this.nested[fullPath] = true; |
| Expand Down | |  |

10 changes: 10 additions & 0 deletions

10
[test/schema.test.js](#diff-7d289728ae6f90276c804692fb857968b19133795d42f75657b37db284a2be09 "test/schema.test.js")

Show comments

[View file](/Automattic/mongoose/blob/a45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8/test/schema.test.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2792,4 +2792,14 @@ describe('schema', function() { |
|  |  | }); |
|  |  | }, /Cannot use schema-level projections.\*subdocument\_mapping.not\_selected/); |
|  |  | }); |
|  |  |  |
|  |  | it('disallows setting special properties with `add()` or constructor (gh-12085)', async function() { |
|  |  | const maliciousPayload = '{"\_\_proto\_\_.toString": "Number"}'; |
|  |  |  |
|  |  | assert.throws(() => { |
|  |  | mongoose.Schema(JSON.parse(maliciousPayload)); |
|  |  | }, /\_\_proto\_\_/); |
|  |  |  |
|  |  | assert.ok({}.toString()); |
|  |  | }); |
|  |  | }); |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a45cfb6`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fautomattic%2Fmongoose%2Fcommit%2Fa45cfb6b0ce0067ae9794cfa80f7917e1fb3c6f8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


