=== Content from git.kernel.org_3e686aa5_20250115_093606.html ===


| [cgit logo](/) | [index](/) : [kernel/git/bpf/bpf.git](/pub/scm/linux/kernel/git/bpf/bpf.git/) | master |
| --- | --- | --- |
| BPF kernel tree | BPF Group |

| [about](/pub/scm/linux/kernel/git/bpf/bpf.git/about/)[summary](/pub/scm/linux/kernel/git/bpf/bpf.git/)[refs](/pub/scm/linux/kernel/git/bpf/bpf.git/refs/?id=86f44fcec22c)[log](/pub/scm/linux/kernel/git/bpf/bpf.git/log/)[tree](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/?id=86f44fcec22c)[commit](/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=86f44fcec22c)[diff](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/?id=86f44fcec22c)[stats](/pub/scm/linux/kernel/git/bpf/bpf.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexei Starovoitov <ast@kernel.org> | 2022-08-08 20:58:09 -0700 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2022-08-10 09:43:07 -0700 |
| commit | [86f44fcec22ce2979507742bc53db8400e454f46](/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=86f44fcec22ce2979507742bc53db8400e454f46) ([patch](/pub/scm/linux/kernel/git/bpf/bpf.git/patch/?id=86f44fcec22ce2979507742bc53db8400e454f46)) | |
| tree | [b583467f4aa9b030f49db5feab726942c681fb19](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/?id=86f44fcec22c) | |
| parent | [aada476655461a9ab491d8298a415430cdd10278](/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=aada476655461a9ab491d8298a415430cdd10278) ([diff](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/?id=86f44fcec22c&id2=aada476655461a9ab491d8298a415430cdd10278)) | |
| download | [bpf-86f44fcec22c.tar.gz](/pub/scm/linux/kernel/git/bpf/bpf.git/snapshot/bpf-86f44fcec22c.tar.gz) | |

bpf: Disallow bpf programs call prog\_run command.The verifier cannot perform sufficient validation of bpf\_attr->test.ctx\_in
pointer, therefore bpf programs should not be allowed to call BPF\_PROG\_RUN
command from within the program.
To fix this issue split bpf\_sys\_bpf() bpf helper into normal kern\_sys\_bpf()
kernel function that can only be used by the kernel light skeleton directly.
Reported-by: YiFei Zhu <zhuyifei@google.com>
Fixes: b1d18a7574d0 ("bpf: Extend sys\_bpf commands for bpf\_syscall programs.")
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/?id=86f44fcec22c)

| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/kernel/bpf/syscall.c?id=86f44fcec22c) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [tools/lib/bpf/skel\_internal.h](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/tools/lib/bpf/skel_internal.h?id=86f44fcec22c) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 16 insertions, 8 deletions

| diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 7dc3f80036310d..a1cb0bdc5ad646 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/kernel/bpf/syscall.c?id=aada476655461a9ab491d8298a415430cdd10278)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/kernel/bpf/syscall.c?id=86f44fcec22ce2979507742bc53db8400e454f46)@@ -5071,9 +5071,6 @@ static bool syscall\_prog\_is\_valid\_access(int off, int size,  BPF\_CALL\_3(bpf\_sys\_bpf, int, cmd, union bpf\_attr \*, attr, u32, attr\_size) {- struct bpf\_prog \* \_\_maybe\_unused prog;- struct bpf\_tramp\_run\_ctx \_\_maybe\_unused run\_ctx;- switch (cmd) { case BPF\_MAP\_CREATE: case BPF\_MAP\_UPDATE\_ELEM:@@ -5083,6 +5080,18 @@ BPF\_CALL\_3(bpf\_sys\_bpf, int, cmd, union bpf\_attr \*, attr, u32, attr\_size) case BPF\_LINK\_CREATE: case BPF\_RAW\_TRACEPOINT\_OPEN: break;+ default:+ return -EINVAL;+ }+ return \_\_sys\_bpf(cmd, KERNEL\_BPFPTR(attr), attr\_size);+}++int kern\_sys\_bpf(int cmd, union bpf\_attr \*attr, unsigned int size)+{+ struct bpf\_prog \* \_\_maybe\_unused prog;+ struct bpf\_tramp\_run\_ctx \_\_maybe\_unused run\_ctx;++ switch (cmd) { #ifdef CONFIG\_BPF\_JIT /\* \_\_bpf\_prog\_enter\_sleepable used by trampoline and JIT \*/ case BPF\_PROG\_TEST\_RUN: if (attr->test.data\_in || attr->test.data\_out ||@@ -5113,11 +5122,10 @@ BPF\_CALL\_3(bpf\_sys\_bpf, int, cmd, union bpf\_attr \*, attr, u32, attr\_size) return 0; #endif default:- return -EINVAL;+ return \_\_\_\_bpf\_sys\_bpf(cmd, attr, size); }- return \_\_sys\_bpf(cmd, KERNEL\_BPFPTR(attr), attr\_size); }-EXPORT\_SYMBOL(bpf\_sys\_bpf);+EXPORT\_SYMBOL(kern\_sys\_bpf);  static const struct bpf\_func\_proto bpf\_sys\_bpf\_proto = { .func = bpf\_sys\_bpf,diff --git a/tools/lib/bpf/skel\_internal.h b/tools/lib/bpf/skel\_internal.hindex bd6f4505e7b1e5..70adf7b119b99e 100644--- a/[tools/lib/bpf/skel\_internal.h](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/tools/lib/bpf/skel_internal.h?id=aada476655461a9ab491d8298a415430cdd10278)+++ b/[tools/lib/bpf/skel\_internal.h](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/tools/lib/bpf/skel_internal.h?id=86f44fcec22ce2979507742bc53db8400e454f46)@@ -66,13 +66,13 @@ struct bpf\_load\_and\_run\_opts { const char \*errstr; }; -long bpf\_sys\_bpf(\_\_u32 cmd, void \*attr, \_\_u32 attr\_size);+long kern\_sys\_bpf(\_\_u32 cmd, void \*attr, \_\_u32 attr\_size);  static inline int skel\_sys\_bpf(enum bpf\_cmd cmd, union bpf\_attr \*attr, unsigned int size) { #ifdef \_\_KERNEL\_\_- return bpf\_sys\_bpf(cmd, attr, size);+ return kern\_sys\_bpf(cmd, attr, size); #else return syscall(\_\_NR\_bpf, cmd, attr, size); #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:34:44 +0000



=== Content from lore.kernel.org_1e2a3e19_20250115_093607.html ===

```
[bpf.vger.kernel.org archive mirror](../../?t=20220817232018)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e0f4a42bdb4075cf928c70757267d6bbe1a64cdeb) [PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON
@ 2022-08-16 20:55 YiFei Zhu
  2022-08-16 20:55 ` [[PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation](#mb286466f89a2dad33e7cf2ba399e8947c131cc42) YiFei Zhu
  2022-08-17 22:30 ` [[PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON](#m4ded7c2d1b3c6da8f54c767089a40741799bfa6e) patchwork-bot+netdevbpf
  [0 siblings, 2 replies; 5+ messages in thread](#r0f4a42bdb4075cf928c70757267d6bbe1a64cdeb)
From: YiFei Zhu @ 2022-08-16 20:55 UTC ([permalink](../../20220816205517.682470-1-zhuyifei%40google.com/) / [raw](../../20220816205517.682470-1-zhuyifei%40google.com/raw))
  To: [bpf](../../../bpf/?t=20220816205545)
  Cc: Alexei Starovoitov, Jinghao Jia, Daniel Borkmann,
	Alexei Starovoitov, Andrii Nakryiko, Song Liu, Stanislav Fomichev,
	Jason Zhang, Jann Horn, mvle, zohar, tyxu.uiuc, security

The verifier cannot perform sufficient validation of any pointers
passed into bpf_attr and treats them as integers rather than pointers.
The helper will then read from arbitrary pointers passed into it.
Restrict the helper to CAP_PERFMON since the security model in
BPF of arbitrary kernel read is CAP_BPF + CAP_PERFMON.

Fixes: af2ac3e13e45 ("bpf: Prepare bpf syscall to be used from kernel and user space.")
Signed-off-by: YiFei Zhu <zhuyifei@google.com>
---
 [kernel/bpf/syscall.c](#Z2e.:..:20220816205517.682470-1-zhuyifei::40google.com:1kernel:bpf:syscall.c) | 2 +-
 1 file [changed](#e0f4a42bdb4075cf928c70757267d6bbe1a64cdeb), 1 insertion(+), 1 deletion(-)

[diff](#iZ2e.:..:20220816205517.682470-1-zhuyifei::40google.com:1kernel:bpf:syscall.c) --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
index a4d40d98428a..27760627370d 100644
--- a/kernel/bpf/syscall.c
+++ b/kernel/bpf/syscall.c
@@ -5197,7 +5197,7 @@ syscall_prog_func_proto(enum bpf_func_id func_id, const struct bpf_prog *prog)
 {
 	switch (func_id) {
 	case BPF_FUNC_sys_bpf:
-		return &bpf_sys_bpf_proto;
+		return !perfmon_capable() ? NULL : &bpf_sys_bpf_proto;
 	case BPF_FUNC_btf_find_by_name_kind:
 		return &bpf_btf_find_by_name_kind_proto;
 	case BPF_FUNC_sys_close:
--
2.37.1.595.g718a3a8f04-goog

[^](#m0f4a42bdb4075cf928c70757267d6bbe1a64cdeb) [permalink](../../20220816205517.682470-1-zhuyifei%40google.com/) [raw](../../20220816205517.682470-1-zhuyifei%40google.com/raw) [reply](../../20220816205517.682470-1-zhuyifei%40google.com/#R) [related](../../20220816205517.682470-1-zhuyifei%40google.com/#related)	[[flat](../../20220816205517.682470-1-zhuyifei%40google.com/T/#u)|[nested](../../20220816205517.682470-1-zhuyifei%40google.com/t/#u)] [5+ messages in thread](#r0f4a42bdb4075cf928c70757267d6bbe1a64cdeb)
```

---

```
[*](#eb286466f89a2dad33e7cf2ba399e8947c131cc42) [PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation
  2022-08-16 20:55 [[PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON](#m0f4a42bdb4075cf928c70757267d6bbe1a64cdeb) YiFei Zhu
@ 2022-08-16 20:55 ` YiFei Zhu
  2022-08-17 22:30   ` [Daniel Borkmann](#m223f4ad85d6f44fa59fe927cf609066b4c5a4385)
  2022-08-17 22:30 ` [[PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON](#m4ded7c2d1b3c6da8f54c767089a40741799bfa6e) patchwork-bot+netdevbpf
  [1 sibling, 1 reply; 5+ messages in thread](#rb286466f89a2dad33e7cf2ba399e8947c131cc42)
From: YiFei Zhu @ 2022-08-16 20:55 UTC ([permalink](../../20220816205517.682470-2-zhuyifei%40google.com/) / [raw](../../20220816205517.682470-2-zhuyifei%40google.com/raw))
  To: [bpf](../../../bpf/?t=20220816205549)
  Cc: Alexei Starovoitov, Jinghao Jia, Daniel Borkmann,
	Alexei Starovoitov, Andrii Nakryiko, Song Liu, Stanislav Fomichev,
	Jason Zhang, Jann Horn, mvle, zohar, tyxu.uiuc, security

Recursive invocation should not happen after commit 86f44fcec22c
("bpf: Disallow bpf programs call prog_run command."), unlike what
is suggested in the comment. The only way to I can see this
condition trigger is if userspace fetches an fd of a kernel-loaded
lskel and attempt to race the kernel to execute that lskel... which
also shouldn't happen under normal circumstances.

To make this "should never happen" explicit, clarify this in the
comment and add a WARN_ON.

Fixes: 86f44fcec22c ("bpf: Disallow bpf programs call prog_run command.")
Signed-off-by: YiFei Zhu <zhuyifei@google.com>
---
 [kernel/bpf/syscall.c](#Z2e.:..:20220816205517.682470-2-zhuyifei::40google.com:1kernel:bpf:syscall.c) | 4 ++--
 1 file [changed](#eb286466f89a2dad33e7cf2ba399e8947c131cc42), 2 insertions(+), 2 deletions(-)

[diff](#iZ2e.:..:20220816205517.682470-2-zhuyifei::40google.com:1kernel:bpf:syscall.c) --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
index 27760627370d..9cac9402c0bf 100644
--- a/kernel/bpf/syscall.c
+++ b/kernel/bpf/syscall.c
@@ -5119,8 +5119,8 @@ int kern_sys_bpf(int cmd, union bpf_attr *attr, unsigned int size)

 		run_ctx.bpf_cookie = 0;
 		run_ctx.saved_run_ctx = NULL;
-		if (!__bpf_prog_enter_sleepable(prog, &run_ctx)) {
-			/* recursion detected */
+		if (WARN_ON(!__bpf_prog_enter_sleepable(prog, &run_ctx))) {
+			/* recursion detected, should never happen */
 			bpf_prog_put(prog);
 			return -EBUSY;
 		}
--
2.37.1.595.g718a3a8f04-goog

[^](#mb286466f89a2dad33e7cf2ba399e8947c131cc42) [permalink](../../20220816205517.682470-2-zhuyifei%40google.com/) [raw](../../20220816205517.682470-2-zhuyifei%40google.com/raw) [reply](../../20220816205517.682470-2-zhuyifei%40google.com/#R) [related](../../20220816205517.682470-2-zhuyifei%40google.com/#related)	[[flat](../../20220816205517.682470-2-zhuyifei%40google.com/T/#u)|[nested](../../20220816205517.682470-2-zhuyifei%40google.com/t/#u)] [5+ messages in thread](#rb286466f89a2dad33e7cf2ba399e8947c131cc42)
```

---

```
[*](#e4ded7c2d1b3c6da8f54c767089a40741799bfa6e) Re: [PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON
  2022-08-16 20:55 [[PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON](#m0f4a42bdb4075cf928c70757267d6bbe1a64cdeb) YiFei Zhu
  2022-08-16 20:55 ` [[PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation](#mb286466f89a2dad33e7cf2ba399e8947c131cc42) YiFei Zhu
@ 2022-08-17 22:30 ` patchwork-bot+netdevbpf
  [1 sibling, 0 replies; 5+ messages in thread](#r4ded7c2d1b3c6da8f54c767089a40741799bfa6e)
From: patchwork-bot+netdevbpf @ 2022-08-17 22:30 UTC ([permalink](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/) / [raw](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/raw))
  To: YiFei Zhu
  Cc: [bpf](../../../bpf/?t=20220817223018), alexei.starovoitov, jinghao7, daniel, ast, andrii, song, sdf,
	jdz, jannh, mvle, zohar, tyxu.uiuc, security

Hello:

This series was applied to bpf/bpf.git (master)
by Daniel Borkmann <daniel@iogearbox.net>:

On Tue, 16 Aug 2022 20:55:16 +0000 you wrote:
> The verifier cannot perform sufficient validation of any pointers
> passed into bpf_attr and treats them as integers rather than pointers.
> The helper will then read from arbitrary pointers passed into it.
> Restrict the helper to CAP_PERFMON since the security model in
> BPF of arbitrary kernel read is CAP_BPF + CAP_PERFMON.
>
> Fixes: af2ac3e13e45 ("bpf: Prepare bpf syscall to be used from kernel and user space.")
> Signed-off-by: YiFei Zhu <zhuyifei@google.com>
>
> [...]

Here is the summary with links:
  - [bpf,1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON
    <https://git.kernel.org/bpf/bpf/c/14b20b784f59>
  - [bpf,2/2] bpf: Add WARN_ON for recursive prog_run invocation
    (no matching commit)

You are awesome, thank you!
--
Deet-doot-dot, I am a bot.
<https://korg.docs.kernel.org/patchwork/pwbot.html>

[^](#m4ded7c2d1b3c6da8f54c767089a40741799bfa6e) [permalink](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/) [raw](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/raw) [reply](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/#R)	[[flat](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/T/#u)|[nested](../../166077541474.7079.5119695287194972054.git-patchwork-notify%40kernel.org/t/#u)] [5+ messages in thread](#r4ded7c2d1b3c6da8f54c767089a40741799bfa6e)
```

---

```
[*](#e223f4ad85d6f44fa59fe927cf609066b4c5a4385) Re: [PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation
  2022-08-16 20:55 ` [[PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation](#mb286466f89a2dad33e7cf2ba399e8947c131cc42) YiFei Zhu
@ 2022-08-17 22:30   ` Daniel Borkmann
  2022-08-17 23:20     ` [YiFei Zhu](#m9fba412fb5dfc2cc6f99002e710e4c0324d199e4)
  [0 siblings, 1 reply; 5+ messages in thread](#r223f4ad85d6f44fa59fe927cf609066b4c5a4385)
From: Daniel Borkmann @ 2022-08-17 22:30 UTC ([permalink](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/) / [raw](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/raw))
  To: YiFei Zhu, [bpf](../../../bpf/?t=20220817223031)
  Cc: Alexei Starovoitov, Jinghao Jia, Alexei Starovoitov,
	Andrii Nakryiko, Song Liu, Stanislav Fomichev, Jason Zhang,
	Jann Horn, mvle, zohar, tyxu.uiuc, security

On 8/16/22 10:55 PM, YiFei Zhu wrote:
> Recursive invocation should not happen after commit 86f44fcec22c
> ("bpf: Disallow bpf programs call prog_run command."), unlike what
> is suggested in the comment. The only way to I can see this
> condition trigger is if userspace fetches an fd of a kernel-loaded
> lskel and attempt to race the kernel to execute that lskel... which
> also shouldn't happen under normal circumstances.
>
> To make this "should never happen" explicit, clarify this in the
> comment and add a WARN_ON.
>
> Fixes: 86f44fcec22c ("bpf: Disallow bpf programs call prog_run command.")
> Signed-off-by: YiFei Zhu <zhuyifei@google.com>
> ---
>   kernel/bpf/syscall.c | 4 ++--
>   1 file changed, 2 insertions(+), 2 deletions(-)
>
> diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
> index 27760627370d..9cac9402c0bf 100644
> --- a/kernel/bpf/syscall.c
> +++ b/kernel/bpf/syscall.c
> @@ -5119,8 +5119,8 @@ int kern_sys_bpf(int cmd, union bpf_attr *attr, unsigned int size)
>
>   		run_ctx.bpf_cookie = 0;
>   		run_ctx.saved_run_ctx = NULL;
> -		if (!__bpf_prog_enter_sleepable(prog, &run_ctx)) {
> -			/* recursion detected */
> +		if (WARN_ON(!__bpf_prog_enter_sleepable(prog, &run_ctx))) {
> +			/* recursion detected, should never happen */

Pushed out commit 1/2, thanks! I think this one causes more confusion than value,
imho, for example in your commit log you state that it could trigger when attempting
to race, in the comment you state "should never happen". Which one is it? Also, if
we can recover gracefully in this case, what should the user do with the warn (I
guess worst case warn_on_once), but still?

Thanks,
Daniel

[^](#m223f4ad85d6f44fa59fe927cf609066b4c5a4385) [permalink](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/) [raw](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/raw) [reply](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/#R)	[[flat](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/T/#u)|[nested](../../cd514394-7712-ee0d-5c85-c6c7f62cec8e%40iogearbox.net/t/#u)] [5+ messages in thread](#r223f4ad85d6f44fa59fe927cf609066b4c5a4385)
```

---

```
[*](#e9fba412fb5dfc2cc6f99002e710e4c0324d199e4) Re: [PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation
  2022-08-17 22:30   ` [Daniel Borkmann](#m223f4ad85d6f44fa59fe927cf609066b4c5a4385)
@ 2022-08-17 23:20     ` YiFei Zhu
  [0 siblings, 0 replies; 5+ messages in thread](#r9fba412fb5dfc2cc6f99002e710e4c0324d199e4)
From: YiFei Zhu @ 2022-08-17 23:20 UTC ([permalink](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/) / [raw](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/raw))
  To: Daniel Borkmann
  Cc: [bpf](../../../bpf/?t=20220817232018), Alexei Starovoitov, Jinghao Jia, Alexei Starovoitov,
	Andrii Nakryiko, Song Liu, Stanislav Fomichev, Jason Zhang,
	Jann Horn, mvle, zohar, tyxu.uiuc, security

On Wed, Aug 17, 2022 at 3:30 PM Daniel Borkmann <daniel@iogearbox.net> wrote:
>
> On 8/16/22 10:55 PM, YiFei Zhu wrote:
> > Recursive invocation should not happen after commit 86f44fcec22c
> > ("bpf: Disallow bpf programs call prog_run command."), unlike what
> > is suggested in the comment. The only way to I can see this
> > condition trigger is if userspace fetches an fd of a kernel-loaded
> > lskel and attempt to race the kernel to execute that lskel... which
> > also shouldn't happen under normal circumstances.
> >
> > To make this "should never happen" explicit, clarify this in the
> > comment and add a WARN_ON.
> >
> > Fixes: 86f44fcec22c ("bpf: Disallow bpf programs call prog_run command.")
> > Signed-off-by: YiFei Zhu <zhuyifei@google.com>
> > ---
> >   kernel/bpf/syscall.c | 4 ++--
> >   1 file changed, 2 insertions(+), 2 deletions(-)
> >
> > diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c
> > index 27760627370d..9cac9402c0bf 100644
> > --- a/kernel/bpf/syscall.c
> > +++ b/kernel/bpf/syscall.c
> > @@ -5119,8 +5119,8 @@ int kern_sys_bpf(int cmd, union bpf_attr *attr, unsigned int size)
> >
> >               run_ctx.bpf_cookie = 0;
> >               run_ctx.saved_run_ctx = NULL;
> > -             if (!__bpf_prog_enter_sleepable(prog, &run_ctx)) {
> > -                     /* recursion detected */
> > +             if (WARN_ON(!__bpf_prog_enter_sleepable(prog, &run_ctx))) {
> > +                     /* recursion detected, should never happen */
>
> Pushed out commit 1/2, thanks! I think this one causes more confusion than value,
> imho, for example in your commit log you state that it could trigger when attempting
> to race, in the comment you state "should never happen". Which one is it? Also, if
> we can recover gracefully in this case, what should the user do with the warn (I
> guess worst case warn_on_once), but still?

I mean, why would anyone attempt to race this... smells more like an
exploitation attempt (though realistically only possible by someone
with root). I see the original comment talks about a BPF SYSCALL prog
invoking, directly or indirectly, itself (hence the "recursion
detected"), and this should be no longer possible at all after
86f44fcec22c.

As for "what should the user do with the warn", the direct result of
this is a module load failure, considering kern_sys_bpf is only used
by kernel lskels AFAIK. However, since the lskel loader has been
executed, the lskel loader may have successfully loaded whatever it
would load anyways, despite the apparent error code from module load,
depending on what stage in the lskel the race happened. I'm not sure
what the user should really do in this circumstance, but I think
something should be logged at least to tell the user something really
wrong is going on. I'm considering BUG_ON in this case but I think
that does more harm than good (since that'd kill the process in the
middle of a module load). Please correct me if I'm wrong.

This is assuming the kernel is working as it is expected to, no memory
corruption shenanigans.

YiFei Zhu

> Thanks,
> Daniel

[^](#m9fba412fb5dfc2cc6f99002e710e4c0324d199e4) [permalink](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/) [raw](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/raw) [reply](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/#R)	[[flat](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/T/#u)|[nested](../../CAA-VZP%3DwFZqrqDVZEm765GR8SpjcAhAj%2B1XGJOgDpwDAXjrxpw%40mail.gmail.com/t/#u)] [5+ messages in thread](#r9fba412fb5dfc2cc6f99002e710e4c0324d199e4)
```

---

```
end of thread, other threads:[[~2022-08-17 23:20 UTC](../../?t=20220817232018) | [newest](../../)]

Thread overview: 5+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-08-16 20:55 [[PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON](#m0f4a42bdb4075cf928c70757267d6bbe1a64cdeb) YiFei Zhu
2022-08-16 20:55 ` [[PATCH bpf 2/2] bpf: Add WARN_ON for recursive prog_run invocation](#mb286466f89a2dad33e7cf2ba399e8947c131cc42) YiFei Zhu
2022-08-17 22:30   ` [Daniel Borkmann](#m223f4ad85d6f44fa59fe927cf609066b4c5a4385)
2022-08-17 23:20     ` [YiFei Zhu](#m9fba412fb5dfc2cc6f99002e710e4c0324d199e4)
2022-08-17 22:30 ` [[PATCH bpf 1/2] bpf: Restrict bpf_sys_bpf to CAP_PERFMON](#m4ded7c2d1b3c6da8f54c767089a40741799bfa6e) patchwork-bot+netdevbpf

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

