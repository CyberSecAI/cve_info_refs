=== Content from huntr.dev_07da45ec_20250114_204334.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by¬†[Protect AI](https://protectai.com/)¬†and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

¬© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)

=== Content from github.com_b66cd0fd_20250114_204333.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Foctoprint%2Foctoprint%2Fcommit%2F40e6217ac1a85cc5ed592873ae49db01d3005da4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Foctoprint%2Foctoprint%2Fcommit%2F40e6217ac1a85cc5ed592873ae49db01d3005da4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=OctoPrint%2FOctoPrint)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[OctoPrint](/OctoPrint)
/
**[OctoPrint](/OctoPrint/OctoPrint)**
Public

* [Notifications](/login?return_to=%2FOctoPrint%2FOctoPrint) You must be signed in to change notification settings
* [Fork
  1.7k](/login?return_to=%2FOctoPrint%2FOctoPrint)
* [Star
   8.4k](/login?return_to=%2FOctoPrint%2FOctoPrint)

* [Code](/OctoPrint/OctoPrint)
* [Issues
  268](/OctoPrint/OctoPrint/issues)
* [Pull requests
  3](/OctoPrint/OctoPrint/pulls)
* [Actions](/OctoPrint/OctoPrint/actions)
* [Wiki](/OctoPrint/OctoPrint/wiki)
* [Security](/OctoPrint/OctoPrint/security)
* [Insights](/OctoPrint/OctoPrint/pulse)

Additional navigation options

* [Code](/OctoPrint/OctoPrint)
* [Issues](/OctoPrint/OctoPrint/issues)
* [Pull requests](/OctoPrint/OctoPrint/pulls)
* [Actions](/OctoPrint/OctoPrint/actions)
* [Wiki](/OctoPrint/OctoPrint/wiki)
* [Security](/OctoPrint/OctoPrint/security)
* [Insights](/OctoPrint/OctoPrint/pulse)

## Commit

[Permalink](/OctoPrint/OctoPrint/commit/40e6217ac1a85cc5ed592873ae49db01d3005da4)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

üîí Make session handling more secure

[Browse files](/OctoPrint/OctoPrint/tree/40e6217ac1a85cc5ed592873ae49db01d3005da4)
Browse the repository at this point in the history

```
* üîíÔ∏è Tie remember_me cookie to password hash

That way when the password gets changed,
existing cookies automatically get
invalidated.

* üîíÔ∏è Invalidate user sessions on password change

This will require a user to log in again after
their password is changed, either by themselves
or through an admin.

This is a slight change in behaviour compared
to before, but makes sure password changes
are enforced across all existing sessions.

* ‚ôªÔ∏è remember_key_for_user => signature_key_for_user

* üîíÔ∏è Invalidate sessions after 15min of inactivity

The server has been keeping track of login
session for a while, but now it also only
considers such (active login) sessions fresh
that have been active within the past 15min.

That way, a session cookie's lifetime is now
also restricted server side. An active
socket connection suffices to keep the
session alive, as do any other requests
using the cookie.

As the session tracking happens in-memory,
all sessions will become invalid on server
restart. However, if the remember me cookie
is set, after server restart a passive
login will succeed.

* üîíÔ∏è Limit remember_me validity to 90 days

So far that was only done through the cookie
duration, and with a year to boot. Now we
encode the creation date into the cookie
and check against that, if it exceeds the
cookie duration the cookie is considered
unset.

Will prevent reuse of ancient remember me
cookies (and force the user to login at
least once every 90d).

* üíö Fix unit tests

New cookie handling requires a faked flask
config object.

Related: <https://huntr.dev/bounties/d27d232b-2578-4b32-b3b4-74aabdadf629/>
```

* Loading branch information

[![@foosel](https://avatars.githubusercontent.com/u/83657?s=40&v=4)](/foosel)

[foosel](/OctoPrint/OctoPrint/commits?author=foosel "View all commits by foosel")
authored
Sep 1, 2022

1 parent
[b83b574](/OctoPrint/OctoPrint/commit/b83b57406eebca60432fbdcb54f8e7791b377e5b)

commit 40e6217

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**175 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/octoprint

  + access

    - src/octoprint/access/users.py
      [users.py](#diff-809f46c7239f40bfd341a2b880790aa00cfa9471c98959404d180df480e4c1f0)
  + server

    - src/octoprint/server/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-a6ff99e912a99c577d9ab63ef6e1cad949b7ea59594f07eda8c9a8ca9c5a5338)
    - api

      * src/octoprint/server/api/\_\_init\_\_.py
        [\_\_init\_\_.py](#diff-51af0933a84a9c3c2e2afc6a780531da8c626dd0e816a735b2152c82afb65756)
    - util

      * src/octoprint/server/util/flask.py
        [flask.py](#diff-a31ff4a1f17a73d33ed4254e4997ff55c86e8cf5c61c32bea9fdf75cf5b16e76)
      * src/octoprint/server/util/sockjs.py
        [sockjs.py](#diff-7d90fa164ca6071d7309f4f9735e3b82cfeb8b1554c4c4560a7666df53cdae7a)
  + static/js/app/viewmodels

    - src/octoprint/static/js/app/viewmodels/usersettings.js
      [usersettings.js](#diff-a2e885bff932940550679bf03be3b3971a88541ac659743afe3972ad0cd3edbe)
  + templates/dialogs/usersettings

    - src/octoprint/templates/dialogs/usersettings/access.jinja2
      [access.jinja2](#diff-10d0b2d467692b00a576aff61216aa25b2363616dd5f01824420a3c010d04189)
* tests/server/util

  + tests/server/util/test\_flask.py
    [test\_flask.py](#diff-13f69964feedff5ee600b3e678911d181e6e81d97191589b678b2eb1a771d679)

## There are no files selected for viewing

37 changes: 27 additions & 10 deletions

37
[src/octoprint/access/users.py](#diff-809f46c7239f40bfd341a2b880790aa00cfa9471c98959404d180df480e4c1f0 "src/octoprint/access/users.py")

Show comments

[View file](/OctoPrint/OctoPrint/blob/40e6217ac1a85cc5ed592873ae49db01d3005da4/src/octoprint/access/users.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -127,11 +127,9 @@ def \_cleanup\_sessions(self): |
|  |  | for session, user in list(self.\_session\_users\_by\_session.items()): |
|  |  | if not isinstance(user, SessionUser): |
|  |  | continue |
|  |  | if user.created + (24 \* 60 \* 60) < time.monotonic(): |
|  |  | if user.touched + (15 \* 60) < time.monotonic(): |
|  |  | self.\_logger.info( |
|  |  | "Cleaning up user session {} for user {}".format( |
|  |  | session, user.get\_id() |
|  |  | ) |
|  |  | f"Cleaning up user session {session} for user {user.get\_id()}" |
|  |  | ) |
|  |  | self.logout\_user(user, stale=True) |
|  |  |  |
| Expand Down  Expand Up | | @@ -176,6 +174,9 @@ def check\_password(self, username, password): |
|  |  | # old hash doesn't match either, wrong password |
|  |  | return False |
|  |  |  |
|  |  | def signature\_key\_for\_user(self, username, salt=None): |
|  |  | return self.create\_password\_hash(username, salt=salt) |
|  |  |  |
|  |  | def add\_user(self, username, password, active, permissions, groups, overwrite=False): |
|  |  | pass |
|  |  |  |
| Expand Down  Expand Up | | @@ -227,29 +228,38 @@ def remove\_user(self, username): |
|  |  | del self.\_sessionids\_by\_userid[username] |
|  |  |  |
|  |  | def validate\_user\_session(self, userid, session): |
|  |  | self.\_cleanup\_sessions() |
|  |  |  |
|  |  | if session in self.\_session\_users\_by\_session: |
|  |  | user = self.\_session\_users\_by\_session[session] |
|  |  | return userid == user.get\_id() |
|  |  |  |
|  |  | return False |
|  |  |  |
|  |  | def find\_user(self, userid=None, session=None): |
|  |  | def find\_user(self, userid=None, session=None, fresh=False): |
|  |  | self.\_cleanup\_sessions() |
|  |  |  |
|  |  | if session is not None and session in self.\_session\_users\_by\_session: |
|  |  | user = self.\_session\_users\_by\_session[session] |
|  |  | if userid is None or userid == user.get\_id(): |
|  |  | user.touch() |
|  |  | return user |
|  |  |  |
|  |  | return None |
|  |  |  |
|  |  | def find\_sessions\_for(self, matcher): |
|  |  | self.\_cleanup\_sessions() |
|  |  |  |
|  |  | result = [] |
|  |  | for user in self.get\_all\_users(): |
|  |  | if matcher(user): |
|  |  | try: |
|  |  | session\_ids = self.\_sessionids\_by\_userid[user.get\_id()] |
|  |  | for session\_id in session\_ids: |
|  |  | try: |
|  |  | result.append(self.\_session\_users\_by\_session[session\_id]) |
|  |  | session\_user = self.\_session\_users\_by\_session[session\_id] |
|  |  | session\_user.touch() |
|  |  | result.append(session\_user) |
|  |  | except KeyError: |
|  |  | # unknown session after all |
|  |  | continue |
| Expand Down  Expand Up | | @@ -780,6 +790,14 @@ def change\_user\_password(self, username, password): |
|  |  | self.\_dirty = True |
|  |  | self.\_save() |
|  |  |  |
|  |  | self.\_trigger\_on\_user\_modified(user) |
|  |  |  |
|  |  | def signature\_key\_for\_user(self, username, salt=None): |
|  |  | if username not in self.\_users: |
|  |  | raise UnknownUser(username) |
|  |  | user = self.\_users[username] |
|  |  | return UserManager.create\_password\_hash(username + user.\_passwordHash, salt=salt) |
|  |  |  |
|  |  | def change\_user\_setting(self, username, key, value): |
|  |  | if username not in self.\_users: |
|  |  | raise UnknownUser(username) |
| Expand Down  Expand Up | | @@ -845,10 +863,10 @@ def remove\_user(self, username): |
|  |  | self.\_dirty = True |
|  |  | self.\_save() |
|  |  |  |
|  |  | def find\_user(self, userid=None, apikey=None, session=None): |
|  |  | def find\_user(self, userid=None, apikey=None, session=None, fresh=False): |
|  |  | user = UserManager.find\_user(self, userid=userid, session=session) |
|  |  |  |
|  |  | if user is not None: |
|  |  | if user is not None or (session and fresh): |
|  |  | return user |
|  |  |  |
|  |  | if userid is not None: |
| Expand Down  Expand Up | | @@ -1383,8 +1401,7 @@ def \_\_init\_\_(self, user): |
|  |  | wrapt.ObjectProxy.\_\_init\_\_(self, user) |
|  |  |  |
|  |  | self.\_self\_session = "".join("%02X" % z for z in bytes(uuid.uuid4().bytes)) |
|  |  | self.\_self\_created = time.monotonic() |
|  |  | self.\_self\_touched = time.monotonic() |
|  |  | self.\_self\_created = self.\_self\_touched = time.monotonic() |
|  |  |  |
|  |  | @property |
|  |  | def session(self): |
| Expand Down | |  |

21 changes: 18 additions & 3 deletions

21
[src/octoprint/server/\_\_init\_\_.py](#diff-a6ff99e912a99c577d9ab63ef6e1cad949b7ea59594f07eda8c9a8ca9c5a5338 "src/octoprint/server/__init__.py")

Show comments

[View file](/OctoPrint/OctoPrint/blob/40e6217ac1a85cc5ed592873ae49db01d3005da4/src/octoprint/server/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -130,7 +130,7 @@ |
|  |  | loginFromApiKeyRequestHandler, |
|  |  | requireLoginRequestHandler, |
|  |  | ) |
|  |  | from octoprint.server.util.flask import PreemptiveCache |
|  |  | from octoprint.server.util.flask import PreemptiveCache, validate\_session\_signature |
|  |  | from octoprint.settings import settings |
|  |  |  |
|  |  | VERSION = \_\_version\_\_ |
| Expand Down  Expand Up | | @@ -187,12 +187,25 @@ def load\_user(id): |
|  |  | else: |
|  |  | sessionid = None |
|  |  |  |
|  |  | if session and "usersession.signature" in session: |
|  |  | sessionsig = session["usersession.signature"] |
|  |  | else: |
|  |  | sessionsig = "" |
|  |  |  |
|  |  | if sessionid: |
|  |  | user = userManager.find\_user(userid=id, session=sessionid) |
|  |  | # session["\_fresh"] is False if the session comes from a remember me cookie, |
|  |  | # True if it came from a use of the login dialog |
|  |  | user = userManager.find\_user( |
|  |  | userid=id, session=sessionid, fresh=session.get("\_fresh", False) |
|  |  | ) |
|  |  | else: |
|  |  | user = userManager.find\_user(userid=id) |
|  |  |  |
|  |  | if user and user.is\_active: |
|  |  | if ( |
|  |  | user |
|  |  | and user.is\_active |
|  |  | and (not sessionid or validate\_session\_signature(sessionsig, id, sessionid)) |
|  |  | ): |
|  |  | return user |
|  |  |  |
|  |  | return None |
| Expand Down  Expand Up | | @@ -1366,7 +1379,9 @@ def \_setup\_app(self, app): |
|  |  |  |
|  |  | app.config["TEMPLATES\_AUTO\_RELOAD"] = True |
|  |  | app.config["JSONIFY\_PRETTYPRINT\_REGULAR"] = False |
|  |  | app.config["REMEMBER\_COOKIE\_DURATION"] = 90 \* 24 \* 60 \* 60 # 90 days |
|  |  | app.config["REMEMBER\_COOKIE\_HTTPONLY"] = True |
|  |  | # REMEMBER\_COOKIE\_SECURE will be taken care of by our custom cookie handling |
|  |  |  |
|  |  | # we must not set this before TEMPLATES\_AUTO\_RELOAD is set to True or that won't take |
|  |  | app.debug = self.\_debug |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[src/octoprint/server/api/\_\_init\_\_.py](#diff-51af0933a84a9c3c2e2afc6a780531da8c626dd0e816a735b2152c82afb65756 "src/octoprint/server/api/__init__.py")

Show comments

[View file](/OctoPrint/OctoPrint/blob/40e6217ac1a85cc5ed592873ae49db01d3005da4/src/octoprint/server/api/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -38,6 +38,7 @@ |
|  |  | limit, |
|  |  | no\_firstrun\_access, |
|  |  | passive\_login, |
|  |  | session\_signature, |
|  |  | ) |
|  |  | from octoprint.settings import settings as s |
|  |  | from octoprint.settings import valid\_boolean\_trues |
| Expand Down  Expand Up | | @@ -312,6 +313,9 @@ def login(): |
|  |  |  |
|  |  | user = octoprint.server.userManager.login\_user(user) |
|  |  | session["usersession.id"] = user.session |
|  |  | session["usersession.signature"] = session\_signature( |
|  |  | username, user.session |
|  |  | ) |
|  |  | g.user = user |
|  |  |  |
|  |  | login\_user(user, remember=remember) |
| Expand Down | |  |

98 changes: 91 additions & 7 deletions

98
[src/octoprint/server/util/flask.py](#diff-a31ff4a1f17a73d33ed4254e4997ff55c86e8cf5c61c32bea9fdf75cf5b16e76 "src/octoprint/server/util/flask.py")

Show comments

[View file](/OctoPrint/OctoPrint/blob/40e6217ac1a85cc5ed592873ae49db01d3005da4/src/octoprint/server/util/flask.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -5,11 +5,13 @@ |
|  |  | \_\_copyright\_\_ = "Copyright (C) 2014 The OctoPrint Project - Released under terms of the AGPLv3 License" |
|  |  |  |
|  |  | import functools |
|  |  | import hashlib |
|  |  | import hmac |
|  |  | import logging |
|  |  | import os |
|  |  | import threading |
|  |  | import time |
|  |  | from datetime import datetime |
|  |  | from datetime import datetime, timedelta |
|  |  | from typing import Union |
|  |  |  |
|  |  | import flask |
| Expand All | | @@ -23,6 +25,9 @@ |
|  |  | import webassets.updater |
|  |  | import webassets.utils |
|  |  | from cachelib import BaseCache |
|  |  | from flask import current\_app |
|  |  | from flask\_login import COOKIE\_NAME as REMEMBER\_COOKIE\_NAME |
|  |  | from flask\_login.utils import decode\_cookie, encode\_cookie |
|  |  | from werkzeug.local import LocalProxy |
|  |  | from werkzeug.utils import cached\_property |
|  |  |  |
| Expand Down  Expand Up | | @@ -422,6 +427,49 @@ def host\_to\_server\_and\_port(host, scheme): |
|  |  | # ~~ request and response versions |
|  |  |  |
|  |  |  |
|  |  | def encode\_remember\_me\_cookie(value): |
|  |  | from octoprint.server import userManager |
|  |  |  |
|  |  | name = value.split("|")[0] |
|  |  | try: |
|  |  | remember\_key = userManager.signature\_key\_for\_user( |
|  |  | name, salt=current\_app.config["SECRET\_KEY"] |
|  |  | ) |
|  |  | timestamp = datetime.utcnow().timestamp() |
|  |  | return encode\_cookie(f"{name}|{timestamp}", key=remember\_key) |
|  |  | except Exception: |
|  |  | pass |
|  |  |  |
|  |  | return "" |
|  |  |  |
|  |  |  |
|  |  | def decode\_remember\_me\_cookie(value): |
|  |  | from octoprint.server import userManager |
|  |  |  |
|  |  | parts = value.split("|") |
|  |  | if len(parts) == 3: |
|  |  | name, created, \_ = parts |
|  |  |  |
|  |  | try: |
|  |  | # valid signature? |
|  |  | signature\_key = userManager.signature\_key\_for\_user( |
|  |  | name, salt=current\_app.config["SECRET\_KEY"] |
|  |  | ) |
|  |  | cookie = decode\_cookie(value, key=signature\_key) |
|  |  | if cookie: |
|  |  | # still valid? |
|  |  | if ( |
|  |  | datetime.fromtimestamp(float(created)) |
|  |  | + timedelta(seconds=current\_app.config["REMEMBER\_COOKIE\_DURATION"]) |
|  |  | > datetime.utcnow() |
|  |  | ): |
|  |  | return encode\_cookie(name) |
|  |  | except Exception: |
|  |  | pass |
|  |  |  |
|  |  | raise ValueError("Invalid remember me cookie") |
|  |  |  |
|  |  |  |
|  |  | class OctoPrintFlaskRequest(flask.Request): |
|  |  | environment\_wrapper = staticmethod(lambda x: x) |
|  |  |  |
| Expand All | | @@ -437,10 +485,23 @@ def cookies(self): |
|  |  | result = {} |
|  |  | desuffixed = {} |
|  |  | for key, value in cookies.items(): |
|  |  | if key.endswith(self.cookie\_suffix): |
|  |  | desuffixed[key[: -len(self.cookie\_suffix)]] = value |
|  |  | else: |
|  |  | result[key] = value |
|  |  |  |
|  |  | def process\_value(k, v): |
|  |  | if k == current\_app.config.get( |
|  |  | "REMEMBER\_COOKIE\_NAME", REMEMBER\_COOKIE\_NAME |
|  |  | ): |
|  |  | return decode\_remember\_me\_cookie(v) |
|  |  | return v |
|  |  |  |
|  |  | try: |
|  |  | if key.endswith(self.cookie\_suffix): |
|  |  | key = key[: -len(self.cookie\_suffix)] |
|  |  | desuffixed[key] = process\_value(key, value) |
|  |  | else: |
|  |  | result[key] = process\_value(key, value) |
|  |  | except ValueError: |
|  |  | # ignore broken cookies |
|  |  | pass |
|  |  |  |
|  |  | result.update(desuffixed) |
|  |  | return result |
| Expand Down  Expand Up | | @@ -471,7 +532,7 @@ def cookie\_suffix(self): |
|  |  |  |
|  |  |  |
|  |  | class OctoPrintFlaskResponse(flask.Response): |
|  |  | def set\_cookie(self, key, \*args, \*\*kwargs): |
|  |  | def set\_cookie(self, key, value="", \*args, \*\*kwargs): |
|  |  | # restrict cookie path to script root |
|  |  | kwargs["path"] = flask.request.script\_root + kwargs.get("path", "/") |
|  |  |  |
| Expand All | | @@ -490,9 +551,13 @@ def set\_cookie(self, key, \*args, \*\*kwargs): |
|  |  | # set secure if necessary |
|  |  | kwargs["secure"] = settings().getBoolean(["server", "cookies", "secure"]) |
|  |  |  |
|  |  | # tie account properties to remember me cookie (e.g. current password hash) |
|  |  | if key == current\_app.config.get("REMEMBER\_COOKIE\_NAME", REMEMBER\_COOKIE\_NAME): |
|  |  | value = encode\_remember\_me\_cookie(value) |
|  |  |  |
|  |  | # add request specific cookie suffix to name |
|  |  | flask.Response.set\_cookie( |
|  |  | self, key + flask.request.cookie\_suffix, \*args, \*\*kwargs |
|  |  | self, key + flask.request.cookie\_suffix, value=value, \*args, \*\*kwargs |
|  |  | ) |
|  |  |  |
|  |  | def delete\_cookie(self, key, path="/", domain=None): |
| Expand Down  Expand Up | | @@ -608,6 +673,9 @@ def login(u): |
|  |  | ) |
|  |  | if hasattr(u, "session"): |
|  |  | flask.session["usersession.id"] = u.session |
|  |  | flask.session["usersession.signature"] = session\_signature( |
|  |  | u.get\_id(), u.session |
|  |  | ) |
|  |  | flask.g.user = u |
|  |  |  |
|  |  | eventManager().fire(Events.USER\_LOGGED\_IN, payload={"username": u.get\_id()}) |
| Expand Down  Expand Up | | @@ -1832,3 +1900,19 @@ def default(self, obj): |
|  |  | return JsonEncoding.encode(obj) |
|  |  | except TypeError: |
|  |  | return flask.json.JSONEncoder.default(self, obj) |
|  |  |  |
|  |  |  |
|  |  | ##~~ Session signing |
|  |  |  |
|  |  |  |
|  |  | def session\_signature(user, session): |
|  |  | from octoprint.server import userManager |
|  |  |  |
|  |  | key = userManager.signature\_key\_for\_user(user, salt=current\_app.config["SECRET\_KEY"]) |
|  |  | return hmac.new( |
|  |  | key.encode("utf-8"), session.encode("utf-8"), hashlib.sha512 |
|  |  | ).hexdigest() |
|  |  |  |
|  |  |  |
|  |  | def validate\_session\_signature(sig, user, session): |
|  |  | return hmac.compare\_digest(sig, session\_signature(user, session)) |

16 changes: 15 additions & 1 deletion

16
[src/octoprint/server/util/sockjs.py](#diff-7d90fa164ca6071d7309f4f9735e3b82cfeb8b1554c4c4560a7666df53cdae7a "src/octoprint/server/util/sockjs.py")

Show comments

[View file](/OctoPrint/OctoPrint/blob/40e6217ac1a85cc5ed592873ae49db01d3005da4/src/octoprint/server/util/sockjs.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,9 +21,10 @@ |
|  |  | import octoprint.vendor.sockjs.tornado.util |
|  |  | from octoprint.access.groups import GroupChangeListener |
|  |  | from octoprint.access.permissions import Permissions |
|  |  | from octoprint.access.users import LoginStatusListener |
|  |  | from octoprint.access.users import LoginStatusListener, SessionUser |
|  |  | from octoprint.events import Events |
|  |  | from octoprint.settings import settings |
|  |  | from octoprint.util import RepeatedTimer |
|  |  | from octoprint.util.json import dumps as json\_dumps |
|  |  | from octoprint.util.version import get\_python\_version\_string |
|  |  |  |
| Expand Down  Expand Up | | @@ -173,13 +174,24 @@ def \_\_init\_\_( |
|  |  | self.\_subscriptions\_active = False |
|  |  | self.\_subscriptions = {"state": False, "plugins": [], "events": []} |
|  |  |  |
|  |  | self.\_keep\_alive = RepeatedTimer( |
|  |  | 60, self.\_keep\_alive\_callback, condition=lambda: self.\_authed |
|  |  | ) |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_get\_remote\_address(info): |
|  |  | forwarded\_for = info.headers.get("X-Forwarded-For") |
|  |  | if forwarded\_for is not None: |
|  |  | return forwarded\_for.split(",")[0] |
|  |  | return info.ip |
|  |  |  |
|  |  | def \_keep\_alive\_callback(self): |
|  |  | if not self.\_authed: |
|  |  | return |
|  |  | if not isinstance(self.\_user, SessionUser): |
|  |  | return |
|  |  | self.\_user.touch() |
|  |  |  |
|  |  | def \_\_str\_\_(self): |
|  |  | if self.\_remoteAddress: |
|  |  | return f"{self!r} connected to {self.\_remoteAddress}" |
| Expand Down  Expand Up | | @@ -716,6 +728,8 @@ def \_on\_login(self, user): |
|  |  | ) |
|  |  | self.\_authed = True |
|  |  |  |
|  |  | self.\_keep\_alive.start() |
|  |  |  |
|  |  | for name, hook in self.\_authed\_hooks.items(): |
|  |  | try: |
|  |  | hook(self, self.\_user) |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[src/octoprint/static/js/app/viewmodels/usersettings.js](#diff-a2e885bff932940550679bf03be3b3971a88541ac659743afe3972ad0cd3edbe "src/octoprint/static/js/app/viewmodels/usersettings.js")

Show comments

[View file](/OctoPrint/OctoPrint/blob/40e6217ac1a85cc5ed592873ae49db01d3005da4/src/octoprint/static/js/app/viewmodels/usersettings.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -88,7 +88,7 @@ $(function () { |
|  |  |  |
|  |  | self.userSettingsDialog.trigger("beforeSave"); |
|  |  |  |
|  |  | function process() { |
|  |  | function saveSettings() { |
|  |  | var settings = { |
|  |  | interface: { |
|  |  | language: self.interface\_language() |
| Expand All | | @@ -110,15 +110,15 @@ $(function () { |
|  |  | self.access\_currentPassword() |
|  |  | ) |
|  |  | .done(function () { |
|  |  | process(); |
|  |  | saveSettings(); |
|  |  | }) |
|  |  | .fail(function (xhr) { |
|  |  | if (xhr.status === 403) { |
|  |  | self.access\_currentPasswordMismatch(true); |
|  |  | } |
|  |  | }); |
|  |  | } else { |
|  |  | process(); |
|  |  | saveSettings(); |
|  |  | } |
|  |  | }; |
|  |  |  |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `40e6217`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Foctoprint%2Foctoprint%2Fcommit%2F40e6217ac1a85cc5ed592873ae49db01d3005da4) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


