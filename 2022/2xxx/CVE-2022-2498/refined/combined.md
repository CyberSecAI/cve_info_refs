=== Content from gitlab.com_db72c5fb_20250115_090923.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2022](/gitlab-org/cves/-/tree/master/2022)
* [**CVE-2022-2498.json**](/gitlab-org/cves/-/blob/master/2022/CVE-2022-2498.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2022/CVE-2022-2498.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2022/CVE-2022-2498.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ GitLab Bot 's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 " GitLab Bot ")](/gitlab-bot)

  Aug 03, 2022

  [65a75989](/gitlab-org/cves/-/commit/65a759891e508d27c4ec8e7000950d54fd3ec1ca)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/65a759891e508d27c4ec8e7000950d54fd3ec1ca)
  繚
  65a75989

  [ GitLab Bot ](/gitlab-bot) authored Aug 03, 2022

  65a75989

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/65a759891e508d27c4ec8e7000950d54fd3ec1ca)
  [ GitLab Bot ](/gitlab-bot) authored Aug 03, 2022

Loading



=== Content from gitlab.com_17f1b0e9_20250115_090924.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Attacker can access owner and other members private projects and other problems in pipeline subscriptions

**[HackerOne report #966824](https://hackerone.com/reports/966824)** by `vaib25vicky` on 2020-08-25, assigned to [@rchan-gitlab](/rchan-gitlab "Ron Chan"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Pipeline subscribe allows you to trigger pipeline in your project when upstream project pipeline gets succeeded for new tags. BUT this feature has some logic flaws for example:

* User with dev access to upstream project can add upstream project to his project pipeline subscription and when his access is removed from upstream project , the subscription still stays and owner dont have any option to remove the subscription

[![ps.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/de05e55759d015dde7c30949ca0d6d494eb37c29/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30613934316632332d383231612d343664612d613038642d3564363861323765393238332f70732e706e67)

So, even he is removed he can still snoop into the project as well as access other members private projects

* There is no permission message given to owner when dev add the project to his personal project in pipeline subscriptions. So, he can easily add upstream project as subscription to his project without owner/maintainer permission
* Since, attacker has added the project to his personal project pipeline subscription he can access owner or other members private data who can create tags in the upstream project.

  When owner will creates a tag, pipeline will run in upstream project and then pipeline will run in attacker's project where he has setup the pipeline subscription and created `.gitlab-ci.yml`  that uses `$CI_JOB_TOKEN`
* Attacker achieved this by first adding the owner(victim) in his own project so when pipeline in upstream project succeeds a new pipeline will trigger in the attacker's project where triggerer will be the owner(victim) and in this whole process, he wont have any clue about this attack.

##### Steps to reproduce

(keeps all projects public)

* Assume a test project where there is an owner and some devs who are working together
* `Dev1`(attacker) creates a personal project and add owner project to his pipeline subscription `settings/ci_cd`
* `Dev1` creates a `.gitlab-ci.yml` file in his project

```
image: &#34;ruby:2.6&#34;

rspec:
  script:
    - git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/victim/private_repo_name.git
    - cd private_repo_name
    - ls -lah .
    - cat README.md

```

* `Dev1` adds owner to his project as member with maintainer permission (so he can write to protected branch or we can add him as dev and remove protection).
* As an owner create a tag in upstream project, this will trigger a new pipeline and after pipeline is successfully finished. A new pipeline will trigger in the attacker's project by the owner without his consent and attacker gain access to his private data like projects, member only repositories, registry, etc.

##### Impact

The pipeline subscription needs more careful consideration because this feature can provide more harm than good. The doc also don't give more information about it. This feature can be abused by malicious user as I explained above and can grant him access to owner and other members of the project private data without their consent. For this attack to happen he only need to wait until someone creates a tag in upstream project.

##### What is the current *bug* behavior?

Pipeline subscription can be abused by an attacker to gain access to owner and other members private projects, member only repositories, registry, etc.

One more bug is that when user is removed from upstream project his subscription didn't remove and owner dont have any option to remove it too.

##### What is the expected *correct* behavior?

There are no. of ways we can fix it, here are some of my recommendations

* Ask owner of the upstream project before adding the project to someone project pipeline subscriptions
* Makes doc more clear regarding the usage, security and permissions
* When user is remove from upstream project then either remove subscriptions created by him or provide a button to the owner so that he can remove the subscription

##### Output of checks

This bug happens on GitLab.com. Probably instance too (please check)

#### Impact

Attacker can access owner and other members private data without their consent by abusing pipeline subscriptions.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [ps.png](https://h1.sec.gitlab.net/a/0a941f23-821a-46da-a08d-5d68a27e9283/ps.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

## Proposed solution

When a downstream pipeline (from a subscription) is triggered we should not use [the upstream pipeline user](https://gitlab.com/gitlab-org/gitlab/-/blob/4559463feacc3b43af7ae03f82ee53959934abfb/ee/app/services/ci/trigger_downstream_subscription_service.rb#L7) but the author of the subscription. This mitigates the attack because `git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/victim/private_repo_name.git` would be executed with the attacker permissions and not the victim one.

The problem is that we don't track *who* creates the subscription and the user we display in the subscriptions table is the project owner. I think we should:

1. start tracking the author in a new `ci_subscriptions_projects.author_id` for newly created subscriptions.
2. When triggering the downstream pipeline use `subscription.author || downstream_project.creator` so we can default to the project creator.
3. Display the subscription author in the list of subscriptions.

This should make it irrelevant the following problem:

> when his access is removed from upstream project, the subscription still stays and owner dont have any option to remove the subscription.

Since the downstream pipeline would run with the subscription's author permissions (attacker) and not the upstream pipeline user (the owner / victim). When the author is not available we could use the downstream project creator. If the project creator has left the project, another maintainer could remove the subscription and recreate it. Then new pipelines will run with the new subscription's author permissions.

A similar solution had already been drafted in <https://gitlab.com/gitlab-org/security/gitlab/-/merge_requests/2361>.

Note regarding `git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/victim/private_repo_name.git`. With [#328553 (closed)](https://gitlab.com/gitlab-org/gitlab/-/issues/328553 "Enable secure bot authorization workflows with CI_JOB_TOKEN") being implemented, it could be sufficient to prevent such data leak.

The CI Job token runs in the context (scope) of the attacker's project. For `victim/private_repo_name` to be accessible it must be added to the job token scope of the attacker's project. The attacker must have at least `read_project` access in order to do that. In this case having the project setting enabled for CI job token scope would have been sufficient.

Edited Jun 14, 2022 by [Fabio Pitino](/fabiopitino)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


