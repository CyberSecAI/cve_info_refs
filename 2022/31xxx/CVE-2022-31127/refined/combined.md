=== Content from next-auth.js.org_e227f704_20250114_221339.html ===

Skip to main contentNextAuth.js is becoming Auth.js! üéâ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/getting-started/upgrade-v4)
* [v3](/v3/getting-started/introduction)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
* [Providers](/providers/)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk ‚Üí](https://go.clerk.com/DefS1u4)

* Getting Started
* Upgrade Guide (v4)
Version: v4On this page
# Upgrade Guide (v4)

NextAuth.js version 4 includes a few breaking changes from the last major version (3.x). So we're here to help you upgrade your applications as smoothly as possible. It should be possible to upgrade from any version of 3.x to the latest 4 release by following the next few migration steps.

note

Version 4 has been released to GA üö®

We encourage users to try it out and report any and all issues they come across.

You can upgrade to the new version by running:

* npm
* yarn
* pnpm

```
npm install next-auth
```
```
yarn add next-auth
```
```
pnpm add next-auth
```
## `next-auth/jwt`[‚Äã](#next-authjwt "Direct link to heading")

We no longer have a default export in `next-auth/jwt`.
To comply with this, change the following:

```
- import jwt from "next-auth/jwt"
+ import { getToken } from "next-auth/jwt"

```
## `next-auth/react`[‚Äã](#next-authreact "Direct link to heading")

We've renamed the client-side import source to `next-auth/react`. To comply with this change, you will simply have to rename anywhere you were using `next-auth/client`.

For example:

```
- import { useSession } from "next-auth/client"
+ import { useSession } from "next-auth/react"

```

We've also made the following changes to the names of the exports:

* `setOptions`: Not exposed anymore, use [`SessionProvider` props](https://next-auth.js.org/getting-started/client#options)
* `options`: Not exposed anymore, [use `SessionProvider` props](https://next-auth.js.org/getting-started/client#options)
* `session`: Renamed to `getSession`
* `providers`: Renamed to `getProviders`
* `csrfToken`: Renamed to `getCsrfToken`
* `signin`: Renamed to `signIn`
* `signout`: Renamed to `signOut`
* `Provider`: Renamed to `SessionProvider`

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.12>

## `SessionProvider`[‚Äã](#sessionprovider "Direct link to heading")

Version 4 makes using the `SessionProvider` mandatory. This means that you will have to wrap any part of your application using `useSession` in this provider, if you were not doing so already. The `SessionProvider` has also undergone a few further changes:

* `Provider` is renamed to `SessionProvider`
* The options prop is now flattened as the props of SessionProvider.
* `keepAlive` has been renamed to `refetchInterval`.
* `clientMaxAge` has been removed in favor of `refetchInterval`, as they overlap in functionality, with the difference that `refetchInterval` will keep re-fetching the session periodically in the background.

The best practice for wrapping your app in Providers is to do so in your `pages/_app.jsx` file.

An example use-case with these new changes:

```
import { SessionProvider } from "next-auth/react"

export default function App({
  Component,
  pageProps: { session, ...pageProps },
}) {
  return (
    // `session` comes from `getServerSideProps` or `getInitialProps`.
    // Avoids flickering/session loading on first load.
    <SessionProvider session={session} refetchInterval={5 * 60}>
      <Component {...pageProps} />
    </SessionProvider>
  )
}

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.12>

## Providers[‚Äã](#providers "Direct link to heading")

Providers now need to be imported individually.

```
- import Provider from "next-auth/providers"
- Providers.Auth0({...})
- Providers.Google({...})
+ import Auth0Provider from "next-auth/providers/auth0"
+ import GoogleProvider from "next-auth/providers/google"
+ Auth0Provider({...})
+ GoogleProvider({...})

```

1. The `AzureADB2C` provider has been renamed `AzureAD`.
2. The `Basecamp` provider has been removed, see explanation [here](https://github.com/basecamp/api/blob/master/sections/authentication.md#on-authenticating-users-via-oauth).
3. The GitHub provider by default now will not request full write access to user profiles. If you need this scope, please add `user` to the scope option manually.

The following new options are available when defining your Providers in the configuration:

1. `authorization` (replaces `authorizationUrl`, `authorizationParams`, `scope`)
2. `token` replaces (`accessTokenUrl`, `headers`, `params`)
3. `userinfo` (replaces `profileUrl`)
4. `issuer`(replaces `domain`)

For more details on their usage, please see [options](/configuration/providers/oauth#options) section of the OAuth Provider documentation.

When submitting a new OAuth provider to the repository, the `profile` callback is expected to only return these fields from now on: `id`, `name`, `email`, and `image`. If any of these are missing values, they should be set to `null`.

Also worth noting is that `id` is expected to be returned as a `string` type (For example if your provider returns it as a number, you can cast it by using the `.toString()` method). This makes the returned profile object comply across all providers/accounts/adapters, and hopefully cause less confusion in the future.

Implemented in: [#2411](https://github.com/nextauthjs/next-auth/pull/2411)
Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.20>

## `useSession` Hook[‚Äã](#usesession-hook "Direct link to heading")

The `useSession` hook has been updated to return an object. This allows you to test states much more cleanly with the new `status` option.

```
- const [ session, loading ] = useSession()
+ const { data: session, status } = useSession()
+ const loading = status === "loading"

```

[Check the docs](https://next-auth.js.org/getting-started/client#usesession) for the possible values of both `session.status` and `session.data`.

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.18>

## Named Parameters[‚Äã](#named-parameters "Direct link to heading")

We have changed the arguments to our callbacks to the named parameters pattern. This way you don't have to use dummy `_` placeholders or other tricks.

### Callbacks[‚Äã](#callbacks "Direct link to heading")

The signatures for the callback methods now look like this:

```
- signIn(user, account, profileOrEmailOrCredentials)
+ signIn({ user, account, profile, email, credentials })

```
```
- redirect(url, baseUrl)
+ redirect({ url, baseUrl })

```
```
- session(session, tokenOrUser)
+ session({ session, token, user })

```
```
- jwt(token, user, account, OAuthProfile, isNewUser)
+ jwt({ token, user, account, profile, isNewUser })

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.17>

### Events[‚Äã](#events "Direct link to heading")

Two event signatures have changed to also use the named parameters pattern, `signOut` and `updateUser`.

```
// [...nextauth].js
...
events: {
- signOut(tokenOrSession),
+ signOut({ token, session }), // token if using JWT, session if DB persisted sessions.
- updateUser(user)
+ updateUser({ user })
}

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.20>

## JWT configuration[‚Äã](#jwt-configuration "Direct link to heading")

We have removed some of the [configuration options](/configuration/options) when using JSON Web Tokens, [here's the PR](https://github.com/nextauthjs/next-auth/pull/3039) for more context.

```
export default NextAuth({
  // ...
  jwt: {
    secret,
    maxAge,
-   encryptionKey
-   signingKey
-   encryptionKey
-   verificationOptions
    encode({
        token
        secret
        maxAge
-       signingKey
-       signingOptions
-       encryptionKey
-       encryptionOptions
-       encryption
    }) {},
    decode({
        token
        secret
-       maxAge
-       signingKey
-       verificationKey
-       verificationOptions
-       encryptionKey
-       decryptionKey
-       decryptionOptions
-       encryption
    }) {}
  }
})

```
## Logger API[‚Äã](#logger-api "Direct link to heading")

The logger API has been simplified to use at most two parameters, where the second is usually an object (`metadata`) containing an `error` object. If you are not using the logger settings you can ignore this change.

```
// [...nextauth.js]
import log from "some-logger-service"
...
logger: {
- error(code, ...message) {},
+ error(code, metadata) {},
- warn(code, ...message) {},
+ warn(code) {}
- debug(code, ...message) {}
+ debug(code, metadata) {}
}

```

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.19>

## `nodemailer`[‚Äã](#nodemailer "Direct link to heading")

Like `typeorm` and `prisma`, [`nodemailer`](https://npmjs.com/package/nodemailer) is no longer included as a dependency by default. If you are using the Email provider you must install it in your project manually, or use any other Email library in the [`sendVerificationRequest`](/configuration/providers/email#options-1#:~:text=sendVerificationRequest) callback. This reduces bundle size for those not actually using the Email provider. Remember, when using the Email provider, it is mandatory to also use a database adapter due to the fact that verification tokens need to be persisted longer term for the magic link functionality to work.

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.2>

## Theme[‚Äã](#theme "Direct link to heading")

We have added some basic customization options to our built-in pages like `signin`, `signout`, etc.

These can be set under the `theme` configuration key. This used to be a string which only controlled the color scheme option. Now it is an object with the following options:

```
theme: {
  colorScheme: "auto", // "auto" | "dark" | "light"
  brandColor: "", // Hex color value
  logo: "" // Absolute URL to logo image
}

```

The hope is that with some minimal configuration / customization options, users won't immediately feel the need to replace the built-in pages with their own.

More details and screenshots of the new theme options can be found under [configuration/pages](https://next-auth.js.org/configuration/pages#theming).

Introduced in [#2788](https://github.com/nextauthjs/next-auth/pull/2788)

## Session[‚Äã](#session "Direct link to heading")

The `session.jwt: boolean` option has been renamed to `session.strategy: "jwt" | "database"`. The goal is to make the user's options more intuitive:

1. No adapter, `strategy: "jwt"`: This is the default. The session is saved in a cookie and never persisted anywhere.
2. With Adapter, `strategy: "database"`: If an Adapter is defined, this will be the implicit setting. No user config is needed.
3. With Adapter, `strategy: "jwt"`: The user can explicitly instruct `next-auth` to use JWT even if a database is available. This can result in faster lookups in compromise of lowered security. Read more about: <https://next-auth.js.org/faq#json-web-tokens>

Example:

```
session: {
- jwt: true,
+ strategy: "jwt",
}

```

Introduced in [#3144](https://github.com/nextauthjs/next-auth/pull/3144)

## Adapters[‚Äã](#adapters "Direct link to heading")

Most importantly, the core `next-auth` package no longer ships with `typeorm` or any other database adapter by default. This brings the default bundle size down significantly for those not needing to persist user data to a database.

You can find the official Adapters in the `packages` directory in the primary monorepo ([nextauthjs/next-auth](https://github.com/nextauthjs/next-auth)). Although you can still [create your own](/tutorials/creating-a-database-adapter) with a new, [simplified Adapter API](https://github.com/nextauthjs/next-auth/pull/2361).

If you have a database that was created with a `3.x.x` or earlier version of NextAuth.js, you will need to run a migration to update the schema to the new version 4 database model. See the bottom of this migration guide for database specific migration examples.

1. If you use the built-in TypeORM or Prisma adapters, these have been removed from the core `next-auth` package. Thankfully the migration is easy; you just need to install the external packages for your database and change the import in your `[...nextauth].js`.

The `database` option has been removed, you must now do the following instead:

```
// [...nextauth].js
import NextAuth from "next-auth"
+ import { TypeORMLegacyAdapter } from "@next-auth/typeorm-legacy-adapter"

...
export default NextAuth({
-  database: "yourconnectionstring",
+  adapter: TypeORMLegacyAdapter("yourconnectionstring")
})

```

2. The `prisma-legacy` adapter has been removed, please use the [`@next-auth/prisma-adapter`](https://npmjs.com/package/%40next-auth/prisma-adapter) instead.
3. The `typeorm-legacy` adapter has been upgraded to use the newer adapter API, but has retained the `typeorm-legacy` name. We aim to migrate this to individual lighter weight adapters for each database type in the future, or switch out `typeorm`.
4. MongoDB has been moved to its own adapter under `@next-auth/mongodb-adapter`. See the [MongoDB Adapter docs](https://authjs.dev/getting-started/adapters/mongodb).

Introduced in <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.8> and [#2361](https://github.com/nextauthjs/next-auth/pull/2361)

### Adapter API[‚Äã](#adapter-api "Direct link to heading")

**This does not require any changes from the user - these are adapter specific changes only**

The Adapter API has been rewritten and significantly simplified in NextAuth.js v4. The adapters now have less work to do as some functionality has been migrated to the core of NextAuth, like hashing the [verification token](https://authjs.dev/concepts/database-models#verificationtoken).

If you are an adapter maintainer or are interested in writing your own adapter, you can find more information about this change in [#2361](https://github.com/nextauthjs/next-auth/pull/2361) and release <https://github.com/nextauthjs/next-auth/releases/tag/v4.0.0-next.22>.

### Schema changes[‚Äã](#schema-changes "Direct link to heading")

The way we save data with adapters have slightly changed. With the new Adapter API, we wanted to make it easier to extend your database with additional fields. For example if your User needs an extra `phone` field, it should be enough to add that to your database's schema, and no changes will be necessary in your adapter.

* `created_at`/`createdAt` and `updated_at`/`updatedAt` fields are removed from all Models.
* `user_id`/`userId` consistently named `userId`.
* `compound_id`/`compoundId` is removed from Account.
* `access_token`/`accessToken` is removed from Session.
* `email_verified`/`emailVerified` on User is consistently named `emailVerified`.
* `provider_id`/`providerId` renamed to `provider` on Account
* `provider_type`/`providerType` renamed to `type` on Account
* `provider_account_id`/`providerAccountId` on Account is consistently named `providerAccountId`
* `access_token_expires`/`accessTokenExpires` on Account renamed to `expires_at`
* New fields on Account: `token_type`, `scope`, `id_token`, `session_state`
* `verification_requests` table has been renamed to `verification_tokens`

See the changes
```

```
User {
  id
  name
  email
+ emailVerified
- email_verified
  image
-  created_at
-  updated_at
}

Account {
  id
- compound_id
- user_id
+ userId
-  provider_type
+ type
- provider_id
+ provider
- provider_account_id
+ providerAccountId
  refresh_token
  access_token
- access_token_expires
+ expires_in
+ expires_at
+ token_type
+ scope
+ id_token
+ session_state
- created_at
- updated_at
}

Session {
  id
  userId
  expires
  sessionToken
- access_token
- created_at
- updated_at
}

VerificationToken {
  id
  token
  expires
  identifier
-  created_at
-  updated_at
}

```

```

For more info, see the [Models page](https://authjs.dev/concepts/database-models).

### Database migration[‚Äã](#database-migration "Direct link to heading")

NextAuth.js v4 has a slightly different database schema compared to v3. If you're using any of our adapters and want to upgrade, you can use on of the below schemas.

They are designed to be run directly against the database itself. So instead of having one in Prisma syntax, one in TypeORM syntax, etc. we've decided to just make one for each underlying database type. i.e. one for Postgres, one for MySQL, one for MongoDB, etc.

#### MySQL[‚Äã](#mysql "Direct link to heading")

```
/* ACCOUNT */
ALTER TABLE accounts
CHANGE "access_token_expires" "expires_at" int
CHANGE "user_id" "userId" varchar(255)
ADD CONSTRAINT fk_user_id FOREIGN KEY (userId) REFERENCES users(id)
RENAME COLUMN "provider_id" "provider"
RENAME COLUMN "provider_account_id" "providerAccountId"
DROP COLUMN "provider_type"
DROP COLUMN "compound_id"
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

ADD COLUMN "token_type" varchar(255) NULL
ADD COLUMN "scope" varchar(255) NULL
ADD COLUMN "id_token" varchar(255) NULL
ADD COLUMN "session_state" varchar(255) NULL

/* Note: These are only needed if you're going to be using the old Twitter OAuth 1.0 provider. */
ADD COLUMN "oauth_token_secret" varchar(255) NULL
ADD COLUMN "oauth_token" varchar(255) NULL

/* USER */
ALTER TABLE users
RENAME COLUMN "email_verified" "emailVerified"
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

/* SESSION */
ALTER TABLE sessions
RENAME COLUMN "session_token" "sessionToken"
CHANGE "user_id" "userId" varchar(255)
ADD CONSTRAINT fk_user_id FOREIGN KEY (userId) REFERENCES users(id)
DROP COLUMN "access_token"
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

/* VERIFICATION REQUESTS */
ALTER TABLE verification_requests RENAME verification_tokens
ALTER TABLE verification_tokens
DROP COLUMN id
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
DROP COLUMN "created_at"
DROP COLUMN "updated_at"

```
#### Postgres[‚Äã](#postgres "Direct link to heading")

```
/* ACCOUNT */
ALTER TABLE accounts RENAME COLUMN "user_id" TO "userId";
ALTER TABLE accounts RENAME COLUMN "provider_id" TO "provider";
ALTER TABLE accounts RENAME COLUMN "provider_account_id" TO "providerAccountId";
ALTER TABLE accounts RENAME COLUMN "access_token_expires" TO "expires_at";
ALTER TABLE accounts RENAME COLUMN "provider_type" TO "type";

/* Do conversion of TIMESTAMPTZ to BIGINT */
ALTER TABLE accounts ALTER COLUMN "expires_at" TYPE TEXT USING CAST(extract(epoch FROM "expires_at") AS BIGINT)*1000;

/* Keep id as SERIAL with autoincrement when using ORM. Using new v4 uuid format won't work because of incompatibility */
/* ALTER TABLE accounts ALTER COLUMN "id" TYPE TEXT; */
/* ALTER TABLE accounts ALTER COLUMN "userId" TYPE TEXT; */
ALTER TABLE accounts ALTER COLUMN "type" TYPE TEXT;
ALTER TABLE accounts ALTER COLUMN "provider" TYPE TEXT;
ALTER TABLE accounts ALTER COLUMN "providerAccountId" TYPE TEXT;

ALTER TABLE accounts ADD CONSTRAINT fk_user_id FOREIGN KEY ("userId") REFERENCES users(id);
ALTER TABLE accounts
DROP COLUMN IF EXISTS "compound_id";
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE accounts
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

ALTER TABLE accounts
ADD COLUMN IF NOT EXISTS "token_type" TEXT NULL,
ADD COLUMN IF NOT EXISTS "scope" TEXT NULL,
ADD COLUMN IF NOT EXISTS "id_token" TEXT NULL,
ADD COLUMN IF NOT EXISTS "session_state" TEXT NULL;
/* Note: These are only needed if you're going to be using the old Twitter OAuth 1.0 provider. */
/* ALTER TABLE accounts
ADD COLUMN IF NOT EXISTS "oauth_token_secret" TEXT NULL,
ADD COLUMN IF NOT EXISTS "oauth_token" TEXT NULL; */

/* USER */
ALTER TABLE users RENAME COLUMN "email_verified" TO "emailVerified";

/* Keep id as SERIAL with autoincrement when using ORM. Using new v4 uuid format won't work because of incompatibility */
/* ALTER TABLE users ALTER COLUMN "id" TYPE TEXT; */
ALTER TABLE users ALTER COLUMN "name" TYPE TEXT;
ALTER TABLE users ALTER COLUMN "email" TYPE TEXT;
ALTER TABLE users ALTER COLUMN "image" TYPE TEXT;
/* Do conversion of TIMESTAMPTZ to BIGINT and then TEXT */
ALTER TABLE users ALTER COLUMN "emailVerified" TYPE TEXT USING CAST(CAST(extract(epoch FROM "emailVerified") AS BIGINT)*1000 AS TEXT);
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE users
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

/* SESSION */
ALTER TABLE sessions RENAME COLUMN "session_token" TO "sessionToken";
ALTER TABLE sessions RENAME COLUMN "user_id" TO "userId";

/* Keep id as SERIAL with autoincrement when using ORM. Using new v4 uuid format won't work because of incompatibility */
/* ALTER TABLE sessions ALTER COLUMN "id" TYPE TEXT; */
/* ALTER TABLE sessions ALTER COLUMN "userId" TYPE TEXT; */
ALTER TABLE sessions ALTER COLUMN "sessionToken" TYPE TEXT;
ALTER TABLE sessions ADD CONSTRAINT fk_user_id FOREIGN KEY ("userId") REFERENCES users(id);
/* Do conversion of TIMESTAMPTZ to BIGINT and then TEXT */
ALTER TABLE sessions ALTER COLUMN "expires" TYPE TEXT USING CAST(CAST(extract(epoch FROM "expires") AS BIGINT)*1000 AS TEXT);
ALTER TABLE sessions DROP COLUMN IF EXISTS "access_token";
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE sessions
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

/* VERIFICATION REQUESTS */
ALTER TABLE verification_requests RENAME TO verification_tokens;
/* Keep id as ORM needs it */
/* ALTER TABLE verification_tokens DROP COLUMN IF EXISTS id; */
ALTER TABLE verification_tokens ALTER COLUMN "identifier" TYPE TEXT;
ALTER TABLE verification_tokens ALTER COLUMN "token" TYPE TEXT;
/* Do conversion of TIMESTAMPTZ to BIGINT and then TEXT */
ALTER TABLE verification_tokens ALTER COLUMN "expires" TYPE TEXT USING CAST(CAST(extract(epoch FROM "expires") AS BIGINT)*1000 AS TEXT);
/* The following two timestamp columns have never been necessary for NextAuth.js to function, but can be kept if you want */
ALTER TABLE verification_tokens
DROP COLUMN IF EXISTS "created_at",
DROP COLUMN IF EXISTS "updated_at";

```
#### MongoDB[‚Äã](#mongodb "Direct link to heading")

MongoDB is a document database and as such new fields will be automatically populated. You do, however, need to update the names of existing fields which are going to be reused.

```
db.getCollection('accounts').updateMany({}, {
  $rename: {
    "provider_id": "provider",
    "provider_account_id": "providerAccountId",
    "user_id": "userId",
    "access_token_expires": "expires_at"
  }
})
db.getCollection('users').updateMany({}, {
  $rename: {
    "email_verified": "emailVerified"
  }
})
db.getCollection('sessions').updateMany({}, {
  $rename: {
    "session_token": "sessionToken",
    "user_id": "userId"
  }
})

```
## Missing `secret`[‚Äã](#missing-secret "Direct link to heading")

NextAuth.js used to generate a secret for convenience, when the user did not define one. This might have been useful in development, but can be a concern in production. We have always been clear about that in the docs, but from now on, if you forget to define a `secret` property in production, we will show the user an error page. Read more about this option [here](https://next-auth.js.org/configuration/options#secret)

You can generate a secret to be placed in the `secret` configuration option via the following command:

```
$ openssl rand -base64 32

```

Therefore, your NextAuth.js config should look something like this:

/pages/api/auth/[...nextauth].js
```
...
export default NextAuth({
  ...
  providers: [...],
  secret: "LlKq6ZtYbr+hTC073mAmAh9/h2HwMfsFo4hrfCx5mLg=",
  ...
})

```

Introduced in [#3143](https://github.com/nextauthjs/next-auth/issues/3143)

## Session `strategy`[‚Äã](#session-strategy "Direct link to heading")

We have always supported two different session strategies. The first being our most popular and default strategy - the JWT based one. The second is the database adapter persisted session strategy. Both have their advantages/disadvantages, you can learn more about them on the [FAQ](https://next-auth.js.org/faq) page.

Previously, the way you configured this was through the `jwt: boolean` flag in the `session` option. The names `session` and `jwt` might have been a bit overused in the options, and so for a clearer message, we renamed this option to `strategy: "jwt" | "database"`, it is still in the `session` object. This will hopefully better indicate the purpose of this option as well as make very explicit which type of session you are going to use.

See the [`session` option docs](https://next-auth.js.org/configuration/options#session) for more details.

Introduced in [#3144](https://github.com/nextauthjs/next-auth/pull/3144)

## Summary[‚Äã](#summary "Direct link to heading")

We hope this migration goes smoothly for each and every one of you! If you have any questions or get stuck anywhere, feel free to create [a new issue](https://github.com/nextauthjs/next-auth/issues/new) on GitHub.

[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/getting-started/upgrade-to-v4.md)Last updated on **Oct 24, 2024** by **Bal√°zs Orb√°n**[PreviousTypeScript](/getting-started/typescript)[NextInitialization](/configuration/initialization)

* [`next-auth/jwt`](#next-authjwt)
* [`next-auth/react`](#next-authreact)
* [`SessionProvider`](#sessionprovider)
* [Providers](#providers)
* [`useSession` Hook](#usesession-hook)
* [Named Parameters](#named-parameters)
  + [Callbacks](#callbacks)
  + [Events](#events)
* [JWT configuration](#jwt-configuration)
* [Logger API](#logger-api)
* [`nodemailer`](#nodemailer)
* [Theme](#theme)
* [Session](#session)
* [Adapters](#adapters)
  + [Adapter API](#adapter-api)
  + [Schema changes](#schema-changes)
  + [Database migration](#database-migration)
* [Missing `secret`](#missing-secret)
* [Session `strategy`](#session-strategy)
* [Summary](#summary)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js ¬© Iain Collins 2025



=== Content from github.com_a8256c1b_20250114_221337.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Freleases%2Ftag%2Fnext-auth%2540v4.9.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Freleases%2Ftag%2Fnext-auth%2540v4.9.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth/tree/next-auth%40v4.9.0)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  98](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth/tree/next-auth%40v4.9.0)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

1. [Releases](/nextauthjs/next-auth/releases)
2. [next-auth@v4.9.0](/nextauthjs/next-auth/releases/tag/next-auth%40v4.9.0)

# next-auth@v4.9.0

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/nextauthjs/next-auth/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...next-auth%40v4.9.0)

 Loading

[View all tags](/nextauthjs/next-auth/tags)

![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)
[balazsorban44](/balazsorban44)
released this
06 Jul 09:49

¬∑
[2264 commits](/nextauthjs/next-auth/compare/next-auth%40v4.9.0...main)
to main
since this release

[next-auth@v4.9.0](/nextauthjs/next-auth/tree/next-auth%40v4.9.0)

[`2adfade`](/nextauthjs/next-auth/commit/2adfadefdc14aad9fbd19d9534e9261f9bff8ede)

## Features

* **providers**: allow styling e-mail through `theme` option ([#4841](https://github.com/nextauthjs/next-auth/pull/4841)) ([ae834f1](https://github.com/nextauthjs/next-auth/commit/ae834f1e08a4a9915665eecb9479c74c6b039c9c))

## Bugfixes

* show experimental api warning only in dev and only once ([#4816](https://github.com/nextauthjs/next-auth/pull/4816))

 Assets
2

 Loading

 üëç
11
 SeonghoJin, magicspon, VladSez, HT-Moh, fredericoo, joaquimp, ThomasLarge, wobsoriano, ThangHuuVu, nerdjfpb, and heyBett reacted with thumbs up emoji

All reactions

* üëç
  11 reactions

 11 people reacted

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_6be737a0_20250114_221339.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-pgjx-7f9g-9463)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-pgjx-7f9g-9463)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  98](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

# Improper handling of email input

High

[balazsorban44](/balazsorban44)
published
GHSA-pgjx-7f9g-9463
Jul 6, 2022

## Package

npm

next-auth
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<3.29.8, <4.9.0

## Patched versions

3.29.8, 4.9.0

## Description

### Impact

An attacker can pass a compromised input to the e-mail [signin endpoint](https://next-auth.js.org/getting-started/rest-api#post-apiauthsigninprovider) that contains some malicious HTML, tricking the e-mail server to send it to the user, so they can perform a phishing attack. Eg.: `balazs@email.com, <a href="http://attacker.com">Before signing in, claim your money!</a>`. This was previously sent to `balazs@email.com`, and the content of the email containing a link to the attacker's site was rendered in the HTML. This has been remedied in the following releases, by simply not rendering that e-mail in the HTML, since it should be obvious to the receiver what e-mail they used:

next-auth v3 users before version 3.29.8 are impacted. (We recommend upgrading to v4, as v3 is considered unmaintained. See our [migration guide](https://next-auth.js.org/getting-started/upgrade-v4))

next-auth v4 users before version 4.8.0 are impacted.

### Patches

We've released patches for this vulnerability in:

* v3 - `3.29.8`
* v4 - `4.9.0`

You can do:

```
npm i next-auth@latest
# or
yarn add next-auth@latest
#
pnpm add next-auth@latest
```

(This will update to the latest v4 version, but you can change `latest` to `3` if you want to stay on v3. This is not recommended.)

### Workarounds

If for some reason you cannot upgrade, the workaround requires you to sanitize the `email` parameter that is passed to `sendVerificationRequest` and rendered in the HTML. If you haven't created a custom `sendVerificationRequest`, you only need to upgrade. Otherwise, make sure to either exclude `email` from the HTML body or efficiently sanitize it. Check out <https://next-auth.js.org/providers/email#customizing-emails>

### References

Related documentation:

* <https://next-auth.js.org/providers/email#customizing-emails>
* <https://next-auth.js.org/getting-started/upgrade-v4>

A test case has been added so this kind of issue will be checked before publishing. See: <https://github.com/nextauthjs/next-auth/blob/cd6ccfde898037290ae949d500ace8a378376cd8/packages/next-auth/tests/email.test.ts>

### For more information

If you have any concerns, we request responsible disclosure, outlined here: <https://next-auth.js.org/security#reporting-a-vulnerability>

### Timeline

The issue was reported 2022 June 29th, a response was sent out to the reporter in less than 1 hour, and after identifying the issue a patch was published within 4 working days.

### Severity

High

### CVE ID

CVE-2022-31127

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

### Credits

* [![@Sandiipmaity](https://avatars.githubusercontent.com/u/87218974?s=40&v=4)](/Sandiipmaity)
  [Sandiipmaity](/Sandiipmaity)
  Analyst

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_0a940e76_20250114_221336.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fae834f1e08a4a9915665eecb9479c74c6b039c9c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fae834f1e08a4a9915665eecb9479c74c6b039c9c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  98](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

## Commit

[Permalink](/nextauthjs/next-auth/commit/ae834f1e08a4a9915665eecb9479c74c6b039c9c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

feat(providers): allow styling e-mail through `theme` option ([#4841](https://github.com/nextauthjs/next-auth/pull/4841))

[Browse files](/nextauthjs/next-auth/tree/ae834f1e08a4a9915665eecb9479c74c6b039c9c)
Browse the repository at this point in the history

```
* fix(core): move email handling

* fix: don' use `replaceAll`

* feat(providers): re-use `theme` for e-mail

* docs: mention `theme` option for email

* fix: don't render user e-mail in the email HTML body

* docs: add missing comma

* refactor: fix lint

* refactor: fix lint
```

* Loading branch information

[![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)](/balazsorban44)

[balazsorban44](/nextauthjs/next-auth/commits?author=balazsorban44 "View all commits by balazsorban44")
authored
Jul 5, 2022

1 parent
[4d4c276](/nextauthjs/next-auth/commit/4d4c276627740c203704e2e3482bdc77d9959476)

commit ae834f1

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**127 additions**
and
**169 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* apps/dev/pages/api/auth

  + apps/dev/pages/api/auth/[...nextauth].ts
    [[...nextauth].ts](#diff-176477c90c3049aa7c86ee0af505cd80f96b08515db3cd3310b253b131cb1fa8)
* docs/docs

  + configuration

    - docs/docs/configuration/options.md
      [options.md](#diff-5fb526039d9b27ebe7d520c32b9a1faf785fa222f0073306080f83c0fcc9f216)
  + providers

    - docs/docs/providers/email.md
      [email.md](#diff-9fd2bdabe5f31e886e0bf09cc1c2bb21f2acff4a8d779ea428ac21e9bc844bf8)
* packages/next-auth

  + src

    - core

      * packages/next-auth/src/core/init.ts
        [init.ts](#diff-50eb6f57ffd57f183df203813940ab95d520095a64b6b9af018c366adcddc715)
      * lib/email

        + packages/next-auth/src/core/lib/email/signin.ts
          [signin.ts](#diff-72ce0597eb9a0c57656adacb95ae106ec868f9577bee1832519b4897f1cb5c76)
      * routes

        + packages/next-auth/src/core/routes/signin.ts
          [signin.ts](#diff-6a7efa6186a272beb387ed043cc3deed13326bbe69da4eb3dc8d8b9549e4ebd0)
      * packages/next-auth/src/core/types.ts
        [types.ts](#diff-4a09ba4be6baf319f19fb95085e3c72cb52ab694f013b67ddb8861042a0f9b69)
    - providers

      * packages/next-auth/src/providers/email.ts
        [email.ts](#diff-1264518d917ff39a9d7362665d98f20c8cdd39803b3e6739316d6944145b62e7)
  + tests

    - packages/next-auth/tests/email.test.ts
      [email.test.ts](#diff-6e0abe4205b8cefd15b75b369cfaa74251ebc08d6311245d3aa9ed5977274d2a)

## There are no files selected for viewing

5 changes: 4 additions & 1 deletion

5
[apps/dev/pages/api/auth/[...nextauth].ts](#diff-176477c90c3049aa7c86ee0af505cd80f96b08515db3cd3310b253b131cb1fa8 "apps/dev/pages/api/auth/[...nextauth].ts")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/apps/dev/pages/api/auth/%5B...nextauth%5D.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -46,7 +46,10 @@ import BoxyHQSAMLProvider from "next-auth/providers/boxyhq-saml" |
|  |  | // }) |
|  |  | // const adapter = FaunaAdapter(client) |
|  |  | export const authOptions: NextAuthOptions = { |
|  |  | // adapter, |
|  |  | // adapter: { |
|  |  | // getUserByEmail: (email) => ({ id: "1", email, emailVerified: null }), |
|  |  | // createVerificationToken: (token) => token, |
|  |  | // } as any, |
|  |  | providers: [ |
|  |  | // E-mail |
|  |  | // Start fake e-mail server with `npm run start:email` |
| Expand Down | |  |

5 changes: 4 additions & 1 deletion

5
[docs/docs/configuration/options.md](#diff-5fb526039d9b27ebe7d520c32b9a1faf785fa222f0073306080f83c0fcc9f216 "docs/docs/configuration/options.md")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/docs/docs/configuration/options.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -366,11 +366,14 @@ Changes the color scheme theme of [pages](/configuration/pages) as well as allow |
|  |  |  |
|  |  | In addition, you can define a logo URL in `theme.logo` which will be rendered above the main card in the default signin/signout/error/verify-request pages, as well as a `theme.brandColor` which will affect the accent color of these pages. |
|  |  |  |
|  |  | The sign-in button's background color will match the `brandColor` and defaults to `"#346df1"`. The text color is `#fff` by default, but if your brand color gives a weak contrast, correct it with the `buttonText` color option. |
|  |  |  |
|  |  | ```js |
|  |  | theme: { |
|  |  | colorScheme: "auto", // "auto" | "dark" | "light" |
|  |  | brandColor: "", // Hex color code |
|  |  | logo: "" // Absolute URL to image |
|  |  | logo: "", // Absolute URL to image |
|  |  | buttonText: "" // Hex color code |
|  |  | } |
|  |  | ``` |
|  |  |  |
| Expand Down | |  |

91 changes: 49 additions & 42 deletions

91
[docs/docs/providers/email.md](#diff-9fd2bdabe5f31e886e0bf09cc1c2bb21f2acff4a8d779ea428ac21e9bc844bf8 "docs/docs/providers/email.md")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/docs/docs/providers/email.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -124,67 +124,74 @@ providers: [ |
|  |  | The following code shows the complete source for the built-in `sendVerificationRequest()` method: |
|  |  |  |
|  |  | ```js |
|  |  | import nodemailer from "nodemailer" |
|  |  | import { createTransport } from "nodemailer" |
|  |  |  |
|  |  | async function sendVerificationRequest({ |
|  |  | identifier: email, |
|  |  | url, |
|  |  | provider: { server, from }, |
|  |  | }) { |
|  |  | async function sendVerificationRequest(params) { |
|  |  | const { identifier, url, provider, theme } = params |
|  |  | const { host } = new URL(url) |
|  |  | const transport = nodemailer.createTransport(server) |
|  |  | await transport.sendMail({ |
|  |  | to: email, |
|  |  | from, |
|  |  | // NOTE: You are not required to use `nodemailer`, use whatever you want. |
|  |  | const transport = createTransport(provider.server) |
|  |  | const result = await transport.sendMail({ |
|  |  | to: identifier, |
|  |  | from: provider.from, |
|  |  | subject: `Sign in to ${host}`, |
|  |  | text: text({ url, host }), |
|  |  | html: html({ url, host, email }), |
|  |  | html: html({ url, host, theme }), |
|  |  | }) |
|  |  | const failed = result.rejected.concat(result.pending).filter(Boolean) |
|  |  | if (failed.length) { |
|  |  | throw new Error(`Email(s) (${failed.join(", ")}) could not be sent`) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Email HTML body |
|  |  | function html({ url, host, email }: Record<"url" | "host" | "email", string>) { |
|  |  | // Insert invisible space into domains and email address to prevent both the |
|  |  | // email address and the domain from being turned into a hyperlink by email |
|  |  | // clients like Outlook and Apple mail, as this is confusing because it seems |
|  |  | // like they are supposed to click on their email address to sign in. |
|  |  | const escapedEmail = `${email.replace(/\./g, "&#8203;.")}` |
|  |  | const escapedHost = `${host.replace(/\./g, "&#8203;.")}` |
|  |  |  |
|  |  | // Some simple styling options |
|  |  | const backgroundColor = "#f9f9f9" |
|  |  | const textColor = "#444444" |
|  |  | const mainBackgroundColor = "#ffffff" |
|  |  | const buttonBackgroundColor = "#346df1" |
|  |  | const buttonBorderColor = "#346df1" |
|  |  | const buttonTextColor = "#ffffff" |
|  |  | /\*\* |
|  |  | \* Email HTML body |
|  |  | \* Insert invisible space into domains from being turned into a hyperlink by email |
|  |  | \* clients like Outlook and Apple mail, as this is confusing because it seems |
|  |  | \* like they are supposed to click on it to sign in. |
|  |  | \* |
|  |  | \* @note We don't add the email address to avoid needing to escape it, if you do, remember to sanitize it! |
|  |  | \*/ |
|  |  | function html(params: { url: string; host: string; theme: Theme }) { |
|  |  | const { url, host, theme } = params |
|  |  |  |
|  |  | const escapedHost = host.replace(/\./g, "&#8203;.") |
|  |  |  |
|  |  | const brandColor = theme.brandColor || "#346df1" |
|  |  | const color = { |
|  |  | background: "#f9f9f9", |
|  |  | text: "#444", |
|  |  | mainBackground: "#fff", |
|  |  | buttonBackground: brandColor, |
|  |  | buttonBorder: brandColor, |
|  |  | buttonText: theme.buttonText || "#fff", |
|  |  | } |
|  |  |  |
|  |  | return ` |
|  |  | <body style="background: ${backgroundColor};"> |
|  |  | <table width="100%" border="0" cellspacing="0" cellpadding="0"> |
|  |  | <body style="background: ${color.background};"> |
|  |  | <table width="100%" border="0" cellspacing="20" cellpadding="0" |
|  |  | style="background: ${color.mainBackground}; max-width: 600px; margin: auto; border-radius: 10px;"> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 10px 0px 20px 0px; font-size: 22px; font-family: Helvetica, Arial, sans-serif; color: ${textColor};"> |
|  |  | <strong>${escapedHost}</strong> |
|  |  | </td> |
|  |  | </tr> |
|  |  | </table> |
|  |  | <table width="100%" border="0" cellspacing="20" cellpadding="0" style="background: ${mainBackgroundColor}; max-width: 600px; margin: auto; border-radius: 10px;"> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 10px 0px 0px 0px; font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${textColor};"> |
|  |  | Sign in as <strong>${escapedEmail}</strong> |
|  |  | <td align="center" |
|  |  | style="padding: 10px 0px; font-size: 22px; font-family: Helvetica, Arial, sans-serif; color: ${color.text};"> |
|  |  | Sign in to <strong>${escapedHost}</strong> |
|  |  | </td> |
|  |  | </tr> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 20px 0;"> |
|  |  | <table border="0" cellspacing="0" cellpadding="0"> |
|  |  | <tr> |
|  |  | <td align="center" style="border-radius: 5px;" bgcolor="${buttonBackgroundColor}"><a href="${url}" target="\_blank" style="font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${buttonTextColor}; text-decoration: none; border-radius: 5px; padding: 10px 20px; border: 1px solid ${buttonBorderColor}; display: inline-block; font-weight: bold;">Sign in</a></td> |
|  |  | <td align="center" style="border-radius: 5px;" bgcolor="${color.buttonBackground}"><a href="${url}" |
|  |  | target="\_blank" |
|  |  | style="font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${color.buttonText}; text-decoration: none; border-radius: 5px; padding: 10px 20px; border: 1px solid ${color.buttonBorder}; display: inline-block; font-weight: bold;">Sign |
|  |  | in</a></td> |
|  |  | </tr> |
|  |  | </table> |
|  |  | </td> |
|  |  | </tr> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 0px 0px 10px 0px; font-size: 16px; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: ${textColor};"> |
|  |  | <td align="center" |
|  |  | style="padding: 0px 0px 10px 0px; font-size: 16px; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: ${color.text};"> |
|  |  | If you did not request this email you can safely ignore it. |
|  |  | </td> |
|  |  | </tr> |
| Expand All | | @@ -193,8 +200,8 @@ function html({ url, host, email }: Record<"url" | "host" | "email", string>) { |
|  |  | ` |
|  |  | } |
|  |  |  |
|  |  | // Email Text body (fallback for email clients that don't render HTML, e.g. feature phones) |
|  |  | function text({ url, host }: Record<"url" | "host", string>) { |
|  |  | /\*\* Email Text body (fallback for email clients that don't render HTML, e.g. feature phones) \*/ |
|  |  | function text({ url, host }: { url: string; host: string }) { |
|  |  | return `Sign in to ${host}\n${url}\n\n` |
|  |  | } |
|  |  | ``` |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[packages/next-auth/src/core/init.ts](#diff-50eb6f57ffd57f183df203813940ab95d520095a64b6b9af018c366adcddc715 "packages/next-auth/src/core/init.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/packages/next-auth/src/core/init.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -62,6 +62,7 @@ export async function init({ |
|  |  | colorScheme: "auto", |
|  |  | logo: "", |
|  |  | brandColor: "", |
|  |  | buttonText: "", |
|  |  | }, |
|  |  | // Custom options override defaults |
|  |  | ...userOptions, |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[packages/next-auth/src/core/lib/email/signin.ts](#diff-72ce0597eb9a0c57656adacb95ae106ec868f9577bee1832519b4897f1cb5c76 "packages/next-auth/src/core/lib/email/signin.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/packages/next-auth/src/core/lib/email/signin.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,7 +10,7 @@ export default async function email( |
|  |  | identifier: string, |
|  |  | options: InternalOptions<"email"> |
|  |  | ) { |
|  |  | const { url, adapter, provider, logger, callbackUrl } = options |
|  |  | const { url, adapter, provider, logger, callbackUrl, theme } = options |
|  |  |  |
|  |  | // Generate token |
|  |  | const token = |
| Expand Down  Expand Up | | @@ -42,6 +42,7 @@ export default async function email( |
|  |  | expires, |
|  |  | url: \_url, |
|  |  | provider, |
|  |  | theme, |
|  |  | }) |
|  |  | } catch (error) { |
|  |  | logger.error("SEND\_VERIFICATION\_EMAIL\_ERROR", { |
| Expand Down | |  |

11 changes: 1 addition & 10 deletions

11
[packages/next-auth/src/core/routes/signin.ts](#diff-6a7efa6186a272beb387ed043cc3deed13326bbe69da4eb3dc8d8b9549e4ebd0 "packages/next-auth/src/core/routes/signin.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/packages/next-auth/src/core/routes/signin.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,19 +37,10 @@ export default async function signin(params: { |
|  |  | \* it solves. We treat email addresses as all lower case. If anyone |
|  |  | \* complains about this we can make strict RFC 2821 compliance an option. |
|  |  | \*/ |
|  |  | let email = body?.email?.toLowerCase() |
|  |  | const email = body?.email?.toLowerCase() |
|  |  |  |
|  |  | if (!email) return { redirect: `${url}/error?error=EmailSignin` } |
|  |  |  |
|  |  | email = email |
|  |  | .split(",")[0] |
|  |  | .trim() |
|  |  | .replaceAll("&", "&amp;") |
|  |  | .replaceAll("<", "&lt;") |
|  |  | .replaceAll(">", "&gt;") |
|  |  | .replaceAll('"', "&quot;") |
|  |  | .replaceAll("'", "&#x27;") |
|  |  |  |
|  |  | // Verified in `assertConfig` |
|  |  | // eslint-disable-next-line @typescript-eslint/no-non-null-assertion |
|  |  | const { getUserByEmail } = adapter! |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[packages/next-auth/src/core/types.ts](#diff-4a09ba4be6baf319f19fb95085e3c72cb52ab694f013b67ddb8861042a0f9b69 "packages/next-auth/src/core/types.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/packages/next-auth/src/core/types.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -217,6 +217,7 @@ export interface Theme { |
|  |  | colorScheme: "auto" | "dark" | "light" |
|  |  | logo?: string |
|  |  | brandColor?: string |
|  |  | buttonText?: string |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

120 changes: 65 additions & 55 deletions

120
[packages/next-auth/src/providers/email.ts](#diff-1264518d917ff39a9d7362665d98f20c8cdd39803b3e6739316d6944145b62e7 "packages/next-auth/src/providers/email.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/ae834f1e08a4a9915665eecb9479c74c6b039c9c/packages/next-auth/src/providers/email.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,6 +3,16 @@ import { createTransport } from "nodemailer" |
|  |  | import type { CommonProviderOptions } from "." |
|  |  | import type { Options as SMTPConnectionOptions } from "nodemailer/lib/smtp-connection" |
|  |  | import type { Awaitable } from ".." |
|  |  | import type { Theme } from "../core/types" |
|  |  |  |
|  |  | export interface SendVerificationRequestParams { |
|  |  | identifier: string |
|  |  | url: string |
|  |  | expires: Date |
|  |  | provider: EmailConfig |
|  |  | token: string |
|  |  | theme: Theme |
|  |  | } |
|  |  |  |
|  |  | export interface EmailConfig extends CommonProviderOptions { |
|  |  | type: "email" |
| Expand All | | @@ -16,13 +26,10 @@ export interface EmailConfig extends CommonProviderOptions { |
|  |  | \* @default 86400 |
|  |  | \*/ |
|  |  | maxAge?: number |
|  |  | sendVerificationRequest: (params: { |
|  |  | identifier: string |
|  |  | url: string |
|  |  | expires: Date |
|  |  | provider: EmailConfig |
|  |  | token: string |
|  |  | }) => Awaitable<void> |
|  |  | /\*\* [Documentation](https://next-auth.js.org/providers/email#customizing-emails) \*/ |
|  |  | sendVerificationRequest: ( |
|  |  | params: SendVerificationRequestParams |
|  |  | ) => Awaitable<void> |
|  |  | /\*\* |
|  |  | \* By default, we are generating a random verification token. |
|  |  | \* You can make it predictable or modify it as you like with this method. |
| Expand Down  Expand Up | | @@ -56,78 +63,81 @@ export default function Email(options: EmailUserConfig): EmailConfig { |
|  |  | type: "email", |
|  |  | name: "Email", |
|  |  | // Server can be an SMTP connection string or a nodemailer config object |
|  |  | server: { |
|  |  | host: "localhost", |
|  |  | port: 25, |
|  |  | auth: { |
|  |  | user: "", |
|  |  | pass: "", |
|  |  | }, |
|  |  | }, |
|  |  | server: { host: "localhost", port: 25, auth: { user: "", pass: "" } }, |
|  |  | from: "NextAuth <no-reply@example.com>", |
|  |  | maxAge: 24 \* 60 \* 60, |
|  |  | async sendVerificationRequest({ |
|  |  | identifier: email, |
|  |  | url, |
|  |  | provider: { server, from }, |
|  |  | }) { |
|  |  | async sendVerificationRequest(params) { |
|  |  | const { identifier, url, provider, theme } = params |
|  |  | const { host } = new URL(url) |
|  |  | const transport = createTransport(server) |
|  |  | await transport.sendMail({ |
|  |  | to: email, |
|  |  | from, |
|  |  | const transport = createTransport(provider.server) |
|  |  | const result = await transport.sendMail({ |
|  |  | to: identifier, |
|  |  | from: provider.from, |
|  |  | subject: `Sign in to ${host}`, |
|  |  | text: text({ url, host }), |
|  |  | html: html({ url, host, email }), |
|  |  | html: html({ url, host, theme }), |
|  |  | }) |
|  |  | const failed = result.rejected.concat(result.pending).filter(Boolean) |
|  |  | if (failed.length) { |
|  |  | throw new Error(`Email(s) (${failed.join(", ")}) could not be sent`) |
|  |  | } |
|  |  | }, |
|  |  | options, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Email HTML body |
|  |  | function html({ url, host, email }: Record<"url" | "host" | "email", string>) { |
|  |  | // Insert invisible space into domains and email address to prevent both the |
|  |  | // email address and the domain from being turned into a hyperlink by email |
|  |  | // clients like Outlook and Apple mail, as this is confusing because it seems |
|  |  | // like they are supposed to click on their email address to sign in. |
|  |  | const escapedEmail = `${email.replace(/\./g, "&#8203;.")}` |
|  |  | const escapedHost = `${host.replace(/\./g, "&#8203;.")}` |
|  |  | /\*\* |
|  |  | \* Email HTML body |
|  |  | \* Insert invisible space into domains from being turned into a hyperlink by email |
|  |  | \* clients like Outlook and Apple mail, as this is confusing because it seems |
|  |  | \* like they are supposed to click on it to sign in. |
|  |  | \* |
|  |  | \* @note We don't add the email address to avoid needing to escape it, if you do, remember to sanitize it! |
|  |  | \*/ |
|  |  | function html(params: { url: string; host: string; theme: Theme }) { |
|  |  | const { url, host, theme } = params |
|  |  |  |
|  |  | const escapedHost = host.replace(/\./g, "&#8203;.") |
|  |  |  |
|  |  | // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing |
|  |  | const brandColor = theme.brandColor || "#346df1" |
|  |  | // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing |
|  |  | const buttonText = theme.buttonText || "#fff" |
|  |  |  |
|  |  | // Some simple styling options |
|  |  | const backgroundColor = "#f9f9f9" |
|  |  | const textColor = "#444444" |
|  |  | const mainBackgroundColor = "#ffffff" |
|  |  | const buttonBackgroundColor = "#346df1" |
|  |  | const buttonBorderColor = "#346df1" |
|  |  | const buttonTextColor = "#ffffff" |
|  |  | const color = { |
|  |  | background: "#f9f9f9", |
|  |  | text: "#444", |
|  |  | mainBackground: "#fff", |
|  |  | buttonBackground: brandColor, |
|  |  | buttonBorder: brandColor, |
|  |  | buttonText, |
|  |  | } |
|  |  |  |
|  |  | return ` |
|  |  | <body style="background: ${backgroundColor};"> |
|  |  | <table width="100%" border="0" cellspacing="0" cellpadding="0"> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 10px 0px 20px 0px; font-size: 22px; font-family: Helvetica, Arial, sans-serif; color: ${textColor};"> |
|  |  | <strong>${escapedHost}</strong> |
|  |  | </td> |
|  |  | </tr> |
|  |  | </table> |
|  |  | <table width="100%" border="0" cellspacing="20" cellpadding="0" style="background: ${mainBackgroundColor}; max-width: 600px; margin: auto; border-radius: 10px;"> |
|  |  | <body style="background: ${color.background};"> |
|  |  | <table width="100%" border="0" cellspacing="20" cellpadding="0" |
|  |  | style="background: ${color.mainBackground}; max-width: 600px; margin: auto; border-radius: 10px;"> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 10px 0px 0px 0px; font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${textColor};"> |
|  |  | Sign in as <strong>${escapedEmail}</strong> |
|  |  | <td align="center" |
|  |  | style="padding: 10px 0px; font-size: 22px; font-family: Helvetica, Arial, sans-serif; color: ${color.text};"> |
|  |  | Sign in to <strong>${escapedHost}</strong> |
|  |  | </td> |
|  |  | </tr> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 20px 0;"> |
|  |  | <table border="0" cellspacing="0" cellpadding="0"> |
|  |  | <tr> |
|  |  | <td align="center" style="border-radius: 5px;" bgcolor="${buttonBackgroundColor}"><a href="${url}" target="\_blank" style="font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${buttonTextColor}; text-decoration: none; border-radius: 5px; padding: 10px 20px; border: 1px solid ${buttonBorderColor}; display: inline-block; font-weight: bold;">Sign in</a></td> |
|  |  | <td align="center" style="border-radius: 5px;" bgcolor="${color.buttonBackground}"><a href="${url}" |
|  |  | target="\_blank" |
|  |  | style="font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${color.buttonText}; text-decoration: none; border-radius: 5px; padding: 10px 20px; border: 1px solid ${color.buttonBorder}; display: inline-block; font-weight: bold;">Sign |
|  |  | in</a></td> |
|  |  | </tr> |
|  |  | </table> |
|  |  | </td> |
|  |  | </tr> |
|  |  | <tr> |
|  |  | <td align="center" style="padding: 0px 0px 10px 0px; font-size: 16px; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: ${textColor};"> |
|  |  | <td align="center" |
|  |  | style="padding: 0px 0px 10px 0px; font-size: 16px; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: ${color.text};"> |
|  |  | If you did not request this email you can safely ignore it. |
|  |  | </td> |
|  |  | </tr> |
| Expand All | | @@ -136,7 +146,7 @@ function html({ url, host, email }: Record<"url" | "host" | "email", string>) { |
|  |  | ` |
|  |  | } |
|  |  |  |
|  |  | // Email Text body (fallback for email clients that don't render HTML, e.g. feature phones) |
|  |  | function text({ url, host }: Record<"url" | "host", string>) { |
|  |  | /\*\* Email Text body (fallback for email clients that don't render HTML, e.g. feature phones) \*/ |
|  |  | function text({ url, host }: { url: string; host: string }) { |
|  |  | return `Sign in to ${host}\n${url}\n\n` |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 1 comment on commit `ae834f1`

[![@vercel](https://avatars.githubusercontent.com/in/8329?s=80&v=4)](/apps/vercel)

Copy link

### @vercel **[vercel](/apps/vercel) bot** commented on `[ae834f1](/nextauthjs/next-auth/commit/ae834f1e08a4a9915665eecb9479c74c6b039c9c)` [Jul 5, 2022](#commitcomment-77735271)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Successfully deployed to the following URLs:

## next-auth ‚Äì ./

[next-auth-nextauthjs.vercel.app](https://next-auth-nextauthjs.vercel.app)

[www.next-auth.js.org](https://www.next-auth.js.org)

[next-auth-git-main-nextauthjs.vercel.app](https://next-auth-git-main-nextauthjs.vercel.app)

[next-auth.js.org](https://next-auth.js.org)

[next-auth-phi-two.vercel.app](https://next-auth-phi-two.vercel.app)

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fae834f1e08a4a9915665eecb9479c74c6b039c9c) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from next-auth.js.org_5b91058d_20250114_221340.html ===

Skip to main contentNextAuth.js is becoming Auth.js! üéâ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/providers/email)
* [v3](/v3/providers/email)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
* [Providers](/providers/)
  + [42 School](/providers/42-school)
  + [Apple](/providers/apple)
  + [Atlassian](/providers/atlassian)
  + [Auth0](/providers/auth0)
  + [Authentik](/providers/authentik)
  + [Azure Active Directory B2C](/providers/azure-ad-b2c)
  + [Azure Active Directory](/providers/azure-ad)
  + [Battle.net](/providers/battle.net)
  + [Box](/providers/box)
  + [BoxyHQ SAML](/providers/boxyhq-saml)
  + [Bungie](/providers/bungie)
  + [Amazon Cognito](/providers/cognito)
  + [Coinbase](/providers/coinbase)
  + [Credentials](/providers/credentials)
  + [Discord](/providers/discord)
  + [Dropbox](/providers/dropbox)
  + [DuendeIdentityServer6](/providers/duende-identityserver6)
  + [Email](/providers/email)
  + [EVE Online](/providers/eveonline)
  + [Facebook](/providers/facebook)
  + [FACEIT](/providers/faceit)
  + [Foursquare](/providers/foursquare)
  + [Freshbooks](/providers/freshbooks)
  + [FusionAuth](/providers/fusionauth)
  + [GitHub](/providers/github)
  + [GitLab](/providers/gitlab)
  + [Google](/providers/google)
  + [HubSpot](/providers/hubspot)
  + [IdentityServer4](/providers/identity-server4)
  + [Overview](/providers/)
  + [Instagram](/providers/instagram)
  + [Kakao](/providers/kakao)
  + [Keycloak](/providers/keycloak)
  + [LINE](/providers/line)
  + [LinkedIn](/providers/linkedin)
  + [Mailchimp](/providers/mailchimp)
  + [Mail.ru](/providers/mailru)
  + [Medium](/providers/medium)
  + [Naver](/providers/naver)
  + [Netlify](/providers/netlify)
  + [Okta](/providers/okta)
  + [OneLogin](/providers/onelogin)
  + [Osso](/providers/osso)
  + [osu!](/providers/osu)
  + [Patreon](/providers/patreon)
  + [Pinterest](/providers/pinterest)
  + [Pipedrive](/providers/pipedrive)
  + [Reddit](/providers/reddit)
  + [Salesforce](/providers/salesforce)
  + [Slack](/providers/slack)
  + [Spotify](/providers/spotify)
  + [Strava](/providers/strava)
  + [Todoist](/providers/todoist)
  + [Trakt](/providers/trakt)
  + [Twitch](/providers/twitch)
  + [Twitter](/providers/twitter)
  + [United Effects](/providers/united-effects)
  + [VK](/providers/vk)
  + [Wikimedia](/providers/wikimedia)
  + [WordPress.com](/providers/wordpress)
  + [WorkOS](/providers/workos)
  + [Yandex](/providers/yandex)
  + [Zitadel](/providers/zitadel)
  + [Zoho](/providers/zoho)
  + [Zoom](/providers/zoom)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk ‚Üí](https://go.clerk.com/DefS1u4)

* [Providers](/providers/)
* Email
Version: v4On this page
# Email

## Overview[‚Äã](#overview "Direct link to heading")

The Email provider uses email to send "magic links" that can be used to sign in, you will likely have seen these if you have used services like Slack before.

Adding support for signing in via email in addition to one or more OAuth services provides a way for users to sign in if they lose access to their OAuth account (e.g. if it is locked or deleted).

The Email provider can be used in conjunction with (or instead of) one or more OAuth providers.

### How it works[‚Äã](#how-it-works "Direct link to heading")

On initial sign in, a **Verification Token** is sent to the email address provided. By default this token is valid for 24 hours. If the Verification Token is used within that time (i.e. by clicking on the link in the email) an account is created for the user and they are signed in.

If someone provides the email address of an *existing account* when signing in, an email is sent and they are signed into the account associated with that email address when they follow the link in the email.

tip

The Email Provider can be used with both JSON Web Tokens and database sessions, but you **must** configure a database to use it. It is not possible to enable email sign in without using a database.

## Options[‚Äã](#options "Direct link to heading")

The **Email Provider** comes with a set of default options:

* [Email Provider options](https://github.com/nextauthjs/next-auth/blob/v4/packages/next-auth/src/providers/email.ts)

You can override any of the options to suit your own use case.

## Configuration[‚Äã](#configuration "Direct link to heading")

NextAuth.js lets you send emails either via HTTP or SMTP.

### HTTP[‚Äã](#http "Direct link to heading")

Check out our [HTTP-based Email Provider](https://authjs.dev/guides/configuring-http-email) guide.

### SMTP[‚Äã](#smtp "Direct link to heading")

1. NextAuth.js does not include `nodemailer` as a dependency, so you'll need to install it yourself if you want to use the Email Provider. Run `npm install nodemailer` or `yarn add nodemailer`.
2. You will need an SMTP account; ideally for one of the [services known to work with `nodemailer`](https://community.nodemailer.com/2-0-0-beta/setup-smtp/well-known-services/).
3. There are two ways to configure the SMTP server connection.

You can either use a connection string or a `nodemailer` configuration object or transport.

2.1 **Using a connection string**

Create an `.env` file to the root of your project and add the connection string and email address.

.env
```
    EMAIL_SERVER=smtp://username:password@smtp.example.com:587
    EMAIL_FROM=noreply@example.com

```

Now you can add the email provider like this:

pages/api/auth/[...nextauth].js
```
import EmailProvider from "next-auth/providers/email";
...
providers: [
  EmailProvider({
    server: process.env.EMAIL_SERVER,
    from: process.env.EMAIL_FROM
  }),
],

```

2.2 **Using a configuration object**

In your `.env` file in the root of your project simply add the configuration object options individually:

.env
```
EMAIL_SERVER_USER=username
EMAIL_SERVER_PASSWORD=password
EMAIL_SERVER_HOST=smtp.example.com
EMAIL_SERVER_PORT=587
EMAIL_FROM=noreply@example.com

```

Now you can add the provider settings to the NextAuth.js options object in the Email Provider.

pages/api/auth/[...nextauth].js
```
import EmailProvider from "next-auth/providers/email";
...
providers: [
  EmailProvider({
    server: {
      host: process.env.EMAIL_SERVER_HOST,
      port: process.env.EMAIL_SERVER_PORT,
      auth: {
        user: process.env.EMAIL_SERVER_USER,
        pass: process.env.EMAIL_SERVER_PASSWORD
      }
    },
    from: process.env.EMAIL_FROM
  }),
],

```

3. Do not forget to setup one of the database [adapters](https://authjs.dev/getting-started/database) for storing the Email verification token.
4. You can now sign in with an email address at `/api/auth/signin`.

A user account (i.e. an entry in the Users table) will not be created for the user until the first time they verify their email address. If an email address is already associated with an account, the user will be signed in to that account when they use the link in the email.

## Customizing emails[‚Äã](#customizing-emails "Direct link to heading")

You can fully customize the sign in email that is sent by passing a custom function as the `sendVerificationRequest` option to `EmailProvider()`.

e.g.

pages/api/auth/[...nextauth].js
```
import EmailProvider from "next-auth/providers/email";
...
providers: [
  EmailProvider({
    server: process.env.EMAIL_SERVER,
    from: process.env.EMAIL_FROM,
    sendVerificationRequest({
      identifier: email,
      url,
      provider: { server, from },
    }) {
      /* your function */
    },
  }),
]

```

The following code shows the complete source for the built-in `sendVerificationRequest()` method:

```
import { createTransport } from "nodemailer"

async function sendVerificationRequest(params) {
  const { identifier, url, provider, theme } = params
  const { host } = new URL(url)
  // NOTE: You are not required to use `nodemailer`, use whatever you want.
  const transport = createTransport(provider.server)
  const result = await transport.sendMail({
    to: identifier,
    from: provider.from,
    subject: `Sign in to ${host}`,
    text: text({ url, host }),
    html: html({ url, host, theme }),
  })
  const failed = result.rejected.concat(result.pending).filter(Boolean)
  if (failed.length) {
    throw new Error(`Email(s) (${failed.join(", ")}) could not be sent`)
  }
}

/**
 * Email HTML body
 * Insert invisible space into domains from being turned into a hyperlink by email
 * clients like Outlook and Apple mail, as this is confusing because it seems
 * like they are supposed to click on it to sign in.
 *
 * @note We don't add the email address to avoid needing to escape it, if you do, remember to sanitize it!
 */
function html(params: { url: string, host: string, theme: Theme }) {
  const { url, host, theme } = params

  const escapedHost = host.replace(/\./g, "&#8203;.")

  const brandColor = theme.brandColor || "#346df1"
  const color = {
    background: "#f9f9f9",
    text: "#444",
    mainBackground: "#fff",
    buttonBackground: brandColor,
    buttonBorder: brandColor,
    buttonText: theme.buttonText || "#fff",
  }

  return `
<body style="background: ${color.background};">
  <table width="100%" border="0" cellspacing="20" cellpadding="0"
    style="background: ${color.mainBackground}; max-width: 600px; margin: auto; border-radius: 10px;">
    <tr>
      <td align="center"
        style="padding: 10px 0px; font-size: 22px; font-family: Helvetica, Arial, sans-serif; color: ${color.text};">
        Sign in to <strong>${escapedHost}</strong>
      </td>
    </tr>
    <tr>
      <td align="center" style="padding: 20px 0;">
        <table border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td align="center" style="border-radius: 5px;" bgcolor="${color.buttonBackground}"><a href="${url}"
                target="_blank"
                style="font-size: 18px; font-family: Helvetica, Arial, sans-serif; color: ${color.buttonText}; text-decoration: none; border-radius: 5px; padding: 10px 20px; border: 1px solid ${color.buttonBorder}; display: inline-block; font-weight: bold;">Sign
                in</a></td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td align="center"
        style="padding: 0px 0px 10px 0px; font-size: 16px; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: ${color.text};">
        If you did not request this email you can safely ignore it.
      </td>
    </tr>
  </table>
</body>
`
}

/** Email Text body (fallback for email clients that don't render HTML, e.g. feature phones) */
function text({ url, host }: { url: string, host: string }) {
  return `Sign in to ${host}\n${url}\n\n`
}

```
tip

If you want to generate great looking email client compatible HTML with React, check out <https://mjml.io>

## Customizing the Verification Token[‚Äã](#customizing-the-verification-token "Direct link to heading")

By default, we are generating a random verification token. You can define a `generateVerificationToken` method in your provider options if you want to override it:

pages/api/auth/[...nextauth].js
```
providers: [
  EmailProvider({
    async generateVerificationToken() {
      return "ABC123"
    }
  })
],

```
## Normalizing the email address[‚Äã](#normalizing-the-email-address "Direct link to heading")

By default, NextAuth.js will normalize the email address. It treats values as case-insensitive (which is technically not compliant to the [RFC 2821 spec](https://datatracker.ietf.org/doc/html/rfc2821), but in practice this causes more problems than it solves, eg. when looking up users by e-mail from databases.) and also removes any secondary email address that was passed in as a comma-separated list. You can apply your own normalization via the `normalizeIdentifier` method on the `EmailProvider`. The following example shows the default behavior:

```
EmailProvider({
  // ...
  normalizeIdentifier(identifier: string): string {
    // Get the first two elements only,
    // separated by `@` from user input.
    let [local, domain] = identifier.toLowerCase().trim().split("@")
    // The part before "@" can contain a ","
    // but we remove it on the domain part
    domain = domain.split(",")[0]
    return `${local}@${domain}`

    // You can also throw an error, which will redirect the user
    // to the error page with error=EmailSignin in the URL
    // if (identifier.split("@").length > 2) {
    //   throw new Error("Only one email allowed")
    // }
  },
})

```
danger

Always make sure this returns a single e-mail address, even if multiple ones were passed in.

## Sending Magic Links To Existing Users[‚Äã](#sending-magic-links-to-existing-users "Direct link to heading")

You can ensure that only existing users are sent a magic login link. You will need to grab the email the user entered and check your database to see if the email already exists in the "User" collection in your database. If it exists, it will send the user a magic link but otherwise, you can send the user to another page, such as "/register".

pages/api/auth/[...nextauth].js
```
import User from "../../../models/User";
import db from "../../../utils/db";
...
callbacks: {
  async signIn({ user, account, email }) {
    await db.connect();
    const userExists = await User.findOne({
      email: user.email,  //the user object has an email property, which contains the email the user entered.
    });
    if (userExists) {
      return true;   //if the email exists in the User collection, email them a magic login link
    } else {
      return "/register";
    }
  },
 ...

```
[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/providers/email.md)Last updated on **Oct 24, 2024** by **Bal√°zs Orb√°n**[PreviousDuendeIdentityServer6](/providers/duende-identityserver6)[NextEVE Online](/providers/eveonline)

* [Overview](#overview)
  + [How it works](#how-it-works)
* [Options](#options)
* [Configuration](#configuration)
  + [HTTP](#http)
  + [SMTP](#smtp)
* [Customizing emails](#customizing-emails)
* [Customizing the Verification Token](#customizing-the-verification-token)
* [Normalizing the email address](#normalizing-the-email-address)
* [Sending Magic Links To Existing Users](#sending-magic-links-to-existing-users)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js ¬© Iain Collins 2025


