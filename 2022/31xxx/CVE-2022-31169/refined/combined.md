=== Content from github.com_cf2bbc07_20250114_194302.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F2ba4bce5cc719e5a74e571a534424614e62ecc41)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F2ba4bce5cc719e5a74e571a534424614e62ecc41)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=bytecodealliance%2Fwasmtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bytecodealliance](/bytecodealliance)
/
**[wasmtime](/bytecodealliance/wasmtime)**
Public

* [Notifications](/login?return_to=%2Fbytecodealliance%2Fwasmtime) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)
* [Star
   15.7k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)

* [Code](/bytecodealliance/wasmtime)
* [Issues
  707](/bytecodealliance/wasmtime/issues)
* [Pull requests
  76](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

Additional navigation options

* [Code](/bytecodealliance/wasmtime)
* [Issues](/bytecodealliance/wasmtime/issues)
* [Pull requests](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

## Commit

[Permalink](/bytecodealliance/wasmtime/commit/2ba4bce5cc719e5a74e571a534424614e62ecc41)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-7f6x-jwh5-m9r4](https://github.com/advisories/GHSA-7f6x-jwh5-m9r4 "GHSA-7f6x-jwh5-m9r4")

[Browse files](/bytecodealliance/wasmtime/tree/2ba4bce5cc719e5a74e571a534424614e62ecc41)
Browse the repository at this point in the history

```
Copyright (c) 2022, Arm Limited.
```

* Loading branch information

[![@akirilov-arm](https://avatars.githubusercontent.com/u/65777466?s=40&v=4)](/akirilov-arm)

[akirilov-arm](/bytecodealliance/wasmtime/commits?author=akirilov-arm "View all commits by akirilov-arm")
authored
Jul 20, 2022

1 parent
[2154c63](/bytecodealliance/wasmtime/commit/2154c63de94e0372bca5a596c3eaf90147c922d1)

commit 2ba4bce

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**170 additions**
and
**56 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* cranelift

  + codegen/src/isa/aarch64

    - cranelift/codegen/src/isa/aarch64/inst.isle
      [inst.isle](#diff-0a9b4a6974b778d68232f02d520456c3a4a4549062cb1567492f20ee46279109)
    - inst

      * cranelift/codegen/src/isa/aarch64/inst/imms.rs
        [imms.rs](#diff-5a0a2669d65348a5ef97009c6527b0b7febf9212ca48d4e7c84be5a52ba27d18)
    - cranelift/codegen/src/isa/aarch64/lower.isle
      [lower.isle](#diff-5bc20f196817da365d65c1f613ea53687a89eebb5d918066c6c7e800b3ca190d)
    - lower

      * cranelift/codegen/src/isa/aarch64/lower/isle.rs
        [isle.rs](#diff-79bd41880a0865ec497e566b167cdff1fd6ff0fbec760e2e412b14c6c8d23e93)
  + filetests/filetests

    - isa/aarch64

      * cranelift/filetests/filetests/isa/aarch64/arithmetic.clif
        [arithmetic.clif](#diff-47c68a6abb5ec501a891c324280979b4e1c62a651ff335d2a812640721fbac33)
    - runtests

      * cranelift/filetests/filetests/runtests/arithmetic.clif
        [arithmetic.clif](#diff-8d2c2026b5034d919273422e98fa710bfa1c768a25ab758f49590acfc8cf005b)

## There are no files selected for viewing

53 changes: 28 additions & 25 deletions

53
[cranelift/codegen/src/isa/aarch64/inst.isle](#diff-0a9b4a6974b778d68232f02d520456c3a4a4549062cb1567492f20ee46279109 "cranelift/codegen/src/isa/aarch64/inst.isle")

Show comments

[View file](/bytecodealliance/wasmtime/blob/2ba4bce5cc719e5a74e571a534424614e62ecc41/cranelift/codegen/src/isa/aarch64/inst.isle)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1325,12 +1325,6 @@ |
|  |  |  |
|  |  | ;; Extractor helpers for various immmediate constants ;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
|  |  | (decl move\_wide\_const\_from\_u64 (MoveWideConst) u64) |
|  |  | (extern extractor move\_wide\_const\_from\_u64 move\_wide\_const\_from\_u64) |
|  |  |  |
|  |  | (decl move\_wide\_const\_from\_negated\_u64 (MoveWideConst) u64) |
|  |  | (extern extractor move\_wide\_const\_from\_negated\_u64 move\_wide\_const\_from\_negated\_u64) |
|  |  |  |
|  |  | (decl pure imm\_logic\_from\_u64 (Type u64) ImmLogic) |
|  |  | (extern constructor imm\_logic\_from\_u64 imm\_logic\_from\_u64) |
|  |  |  |
| Expand Down  Expand Up | | @@ -2025,27 +2019,36 @@ |
|  |  |  |
|  |  | ;; Immediate value helpers ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
|  |  | (decl imm (Type u64) Reg) |
|  |  |  |
|  |  | ;; 16-bit immediate (shifted by 0, 16, 32 or 48 bits) in MOVZ |
|  |  | (rule (imm (integral\_ty \_ty) (move\_wide\_const\_from\_u64 n)) |
|  |  | (movz n (OperandSize.Size64))) |
|  |  |  |
|  |  | ;; 16-bit immediate (shifted by 0, 16, 32 or 48 bits) in MOVN |
|  |  | (rule (imm (integral\_ty \_ty) (move\_wide\_const\_from\_negated\_u64 n)) |
|  |  | (movn n (OperandSize.Size64))) |
|  |  |  |
|  |  | ;; Weird logical-instruction immediate in ORI using zero register |
|  |  | (rule (imm (integral\_ty \_ty) k) |
|  |  | (if-let n (imm\_logic\_from\_u64 $I64 k)) |
|  |  | (orr\_imm $I64 (zero\_reg) n)) |
|  |  |  |
|  |  | (decl load\_constant64\_full (u64) Reg) |
|  |  | ;; Type of extension performed by an immediate helper |
|  |  | (type ImmExtend |
|  |  | (enum |
|  |  | (Sign) |
|  |  | (Zero))) |
|  |  |  |
|  |  | ;; Arguments: |
|  |  | ;; \* Immediate type |
|  |  | ;; \* Way to extend the immediate value to the full width of the destination |
|  |  | ;; register |
|  |  | ;; \* Immediate value - only the bits that fit within the type are used and |
|  |  | ;; extended, while the rest are ignored |
|  |  | ;; |
|  |  | ;; Note that, unlike the convention in the AArch64 backend, this helper leaves |
|  |  | ;; all bits in the destination register in a defined state, i.e. smaller types |
|  |  | ;; such as `I8` are either sign- or zero-extended. |
|  |  | (decl imm (Type ImmExtend u64) Reg) |
|  |  |  |
|  |  | ;; Weird logical-instruction immediate in ORI using zero register; to simplify, |
|  |  | ;; we only match when we are zero-extending the value. |
|  |  | (rule (imm (integral\_ty ty) (ImmExtend.Zero) k) |
|  |  | (if-let n (imm\_logic\_from\_u64 ty k)) |
|  |  | (orr\_imm ty (zero\_reg) n)) |
|  |  |  |
|  |  | (decl load\_constant64\_full (Type ImmExtend u64) Reg) |
|  |  | (extern constructor load\_constant64\_full load\_constant64\_full) |
|  |  |  |
|  |  | ;; Fallback for integral 64-bit constants that uses lots of `movk` |
|  |  | (rule (imm (integral\_ty \_ty) n) |
|  |  | (load\_constant64\_full n)) |
|  |  | ;; Fallback for integral 64-bit constants |
|  |  | (rule (imm (integral\_ty ty) extend n) |
|  |  | (load\_constant64\_full ty extend n)) |
|  |  |  |
|  |  | ;; Sign extension helpers ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[cranelift/codegen/src/isa/aarch64/inst/imms.rs](#diff-5a0a2669d65348a5ef97009c6527b0b7febf9212ca48d4e7c84be5a52ba27d18 "cranelift/codegen/src/isa/aarch64/inst/imms.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/2ba4bce5cc719e5a74e571a534424614e62ecc41/cranelift/codegen/src/isa/aarch64/inst/imms.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -618,6 +618,10 @@ impl MoveWideConst { |
|  |  | }) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | pub fn zero() -> MoveWideConst { |
|  |  | MoveWideConst { bits: 0, shift: 0 } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Advanced SIMD modified immediate as used by MOVI/MVNI. |
| Expand Down | |  |

30 changes: 15 additions & 15 deletions

30
[cranelift/codegen/src/isa/aarch64/lower.isle](#diff-5bc20f196817da365d65c1f613ea53687a89eebb5d918066c6c7e800b3ca190d "cranelift/codegen/src/isa/aarch64/lower.isle")

Show comments

[View file](/bytecodealliance/wasmtime/blob/2ba4bce5cc719e5a74e571a534424614e62ecc41/cranelift/codegen/src/isa/aarch64/lower.isle)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,20 +7,20 @@ |
|  |  | ;;;; Rules for `iconst` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
|  |  | (rule (lower (has\_type ty (iconst (u64\_from\_imm64 n)))) |
|  |  | (imm ty n)) |
|  |  | (imm ty (ImmExtend.Zero) n)) |
|  |  |  |
|  |  | ;;;; Rules for `bconst` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
|  |  | (rule (lower (has\_type ty (bconst $false))) |
|  |  | (imm ty 0)) |
|  |  | (imm ty (ImmExtend.Zero) 0)) |
|  |  |  |
|  |  | (rule (lower (has\_type ty (bconst $true))) |
|  |  | (imm ty 1)) |
|  |  | (imm ty (ImmExtend.Zero) 1)) |
|  |  |  |
|  |  | ;;;; Rules for `null` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
|  |  | (rule (lower (has\_type ty (null))) |
|  |  | (imm ty 0)) |
|  |  | (imm ty (ImmExtend.Zero) 0)) |
|  |  |  |
|  |  | ;;;; Rules for `iadd` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
| Expand Down  Expand Up | | @@ -533,7 +533,7 @@ |
|  |  | ;; move it into a register. |
|  |  | (rule (put\_nonzero\_in\_reg\_zext64 (and (value\_type ty) |
|  |  | (iconst (nonzero\_u64\_from\_imm64 n)))) |
|  |  | (imm ty n)) |
|  |  | (imm ty (ImmExtend.Zero) n)) |
|  |  |  |
|  |  | ;;;; Rules for `sdiv` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
| Expand Down  Expand Up | | @@ -568,7 +568,7 @@ |
|  |  | ;; Special case for `sdiv` where no checks are needed due to division by a |
|  |  | ;; constant meaning the checks are always passed. |
|  |  | (rule (lower (has\_type (fits\_in\_64 ty) (sdiv x (iconst (safe\_divisor\_from\_imm64 y))))) |
|  |  | (a64\_sdiv $I64 (put\_in\_reg\_sext64 x) (imm ty y))) |
|  |  | (a64\_sdiv $I64 (put\_in\_reg\_sext64 x) (imm ty (ImmExtend.Sign) y))) |
|  |  |  |
|  |  | ;; Helper for placing a `Value` into a `Reg` and validating that it's nonzero. |
|  |  | (decl put\_nonzero\_in\_reg\_sext64 (Value) Reg) |
| Expand All | | @@ -579,7 +579,7 @@ |
|  |  | ;; not zero we can skip the zero check. |
|  |  | (rule (put\_nonzero\_in\_reg\_sext64 (and (value\_type ty) |
|  |  | (iconst (nonzero\_u64\_from\_imm64 n)))) |
|  |  | (imm ty n)) |
|  |  | (imm ty (ImmExtend.Sign) n)) |
|  |  |  |
|  |  | ;;;; Rules for `urem` and `srem` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
| Expand Down  Expand Up | | @@ -646,14 +646,14 @@ |
|  |  | ;; Conversion to 128-bit needs a zero-extension of the lower bits and the upper |
|  |  | ;; bits are all zero. |
|  |  | (rule (lower (has\_type $I128 (uextend x))) |
|  |  | (value\_regs (put\_in\_reg\_zext64 x) (imm $I64 0))) |
|  |  | (value\_regs (put\_in\_reg\_zext64 x) (imm $I64 (ImmExtend.Zero) 0))) |
|  |  |  |
|  |  | ;; Like above where vector extraction automatically zero-extends extending to |
|  |  | ;; i128 only requires generating a 0 constant for the upper bits. |
|  |  | (rule (lower (has\_type $I128 |
|  |  | (uextend (extractlane vec @ (value\_type in) |
|  |  | (u8\_from\_uimm8 lane))))) |
|  |  | (value\_regs (mov\_from\_vec (put\_in\_reg vec) lane (vector\_size in)) (imm $I64 0))) |
|  |  | (value\_regs (mov\_from\_vec (put\_in\_reg vec) lane (vector\_size in)) (imm $I64 (ImmExtend.Zero) 0))) |
|  |  |  |
|  |  | ;;;; Rules for `sextend` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1037,7 +1037,7 @@ |
|  |  | (rule (lower (has\_type $I128 (rotl x y))) |
|  |  | (let ((val ValueRegs x) |
|  |  | (amt Reg (value\_regs\_get y 0)) |
|  |  | (neg\_amt Reg (sub $I64 (imm $I64 128) amt)) |
|  |  | (neg\_amt Reg (sub $I64 (imm $I64 (ImmExtend.Zero) 128) amt)) |
|  |  | (lshift ValueRegs (lower\_shl128 val amt)) |
|  |  | (rshift ValueRegs (lower\_ushr128 val neg\_amt))) |
|  |  | (value\_regs |
| Expand Down  Expand Up | | @@ -1121,7 +1121,7 @@ |
|  |  | (rule (lower (has\_type $I128 (rotr x y))) |
|  |  | (let ((val ValueRegs x) |
|  |  | (amt Reg (value\_regs\_get y 0)) |
|  |  | (neg\_amt Reg (sub $I64 (imm $I64 128) amt)) |
|  |  | (neg\_amt Reg (sub $I64 (imm $I64 (ImmExtend.Zero) 128) amt)) |
|  |  | (rshift ValueRegs (lower\_ushr128 val amt)) |
|  |  | (lshift ValueRegs (lower\_shl128 val neg\_amt)) |
|  |  | (hi Reg (orr $I64 (value\_regs\_get rshift 1) (value\_regs\_get lshift 1))) |
| Expand Down  Expand Up | | @@ -1176,7 +1176,7 @@ |
|  |  | (let ((hi\_clz Reg (a64\_clz $I64 (value\_regs\_get val 1))) |
|  |  | (lo\_clz Reg (a64\_clz $I64 (value\_regs\_get val 0))) |
|  |  | (tmp Reg (lsr\_imm $I64 hi\_clz (imm\_shift\_from\_u8 6)))) |
|  |  | (value\_regs (madd $I64 lo\_clz tmp hi\_clz) (imm $I64 0)))) |
|  |  | (value\_regs (madd $I64 lo\_clz tmp hi\_clz) (imm $I64 (ImmExtend.Zero) 0)))) |
|  |  |  |
|  |  | ;;;; Rules for `ctz` ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1228,7 +1228,7 @@ |
|  |  | (maybe\_lo Reg (with\_flags\_reg |
|  |  | (cmp64\_imm hi\_cls (u8\_into\_imm12 63)) |
|  |  | (csel (Cond.Eq) lo\_sign\_bits (zero\_reg))))) |
|  |  | (value\_regs (add $I64 maybe\_lo hi\_cls) (imm $I64 0)))) |
|  |  | (value\_regs (add $I64 maybe\_lo hi\_cls) (imm $I64 (ImmExtend.Zero) 0)))) |
|  |  |  |
|  |  | (rule (lower (has\_type ty (cls x))) |
|  |  | (a64\_cls ty x)) |
| Expand All | | @@ -1242,7 +1242,7 @@ |
|  |  | (let ((val ValueRegs x) |
|  |  | (in\_lo Reg (value\_regs\_get val 0)) |
|  |  | (dst\_lo Reg (and\_imm $I32 in\_lo (u64\_into\_imm\_logic $I32 1))) |
|  |  | (dst\_hi Reg (imm $I64 0))) |
|  |  | (dst\_hi Reg (imm $I64 (ImmExtend.Zero) 0))) |
|  |  | (value\_regs dst\_lo dst\_hi))) |
|  |  |  |
|  |  | (rule (lower (bint x)) |
| Expand Down  Expand Up | | @@ -1337,7 +1337,7 @@ |
|  |  | (tmp Reg (mov\_to\_vec tmp\_half (value\_regs\_get val 1) 1 (VectorSize.Size64x2))) |
|  |  | (nbits Reg (vec\_cnt tmp (VectorSize.Size8x16))) |
|  |  | (added Reg (addv nbits (VectorSize.Size8x16)))) |
|  |  | (value\_regs (mov\_from\_vec added 0 (VectorSize.Size8x16)) (imm $I64 0)))) |
|  |  | (value\_regs (mov\_from\_vec added 0 (VectorSize.Size8x16)) (imm $I64 (ImmExtend.Zero) 0)))) |
|  |  |  |
|  |  | (rule (lower (has\_type $I8X16 (popcnt x))) |
|  |  | (vec\_cnt x (VectorSize.Size8x16))) |
| Expand Down | |  |

52 changes: 40 additions & 12 deletions

52
[cranelift/codegen/src/isa/aarch64/lower/isle.rs](#diff-79bd41880a0865ec497e566b167cdff1fd6ff0fbec760e2e412b14c6c8d23e93 "cranelift/codegen/src/isa/aarch64/lower/isle.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/2ba4bce5cc719e5a74e571a534424614e62ecc41/cranelift/codegen/src/isa/aarch64/lower/isle.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -75,20 +75,12 @@ where |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn move\_wide\_const\_from\_u64(&mut self, n: u64) -> Option<MoveWideConst> { |
|  |  | MoveWideConst::maybe\_from\_u64(n) |
|  |  | } |
|  |  |  |
|  |  | fn move\_wide\_const\_from\_negated\_u64(&mut self, n: u64) -> Option<MoveWideConst> { |
|  |  | MoveWideConst::maybe\_from\_u64(!n) |
|  |  | } |
|  |  |  |
|  |  | fn imm\_logic\_from\_u64(&mut self, ty: Type, n: u64) -> Option<ImmLogic> { |
|  |  | let ty = if ty.bits() < 32 { I32 } else { ty }; |
|  |  | ImmLogic::maybe\_from\_u64(n, ty) |
|  |  | } |
|  |  |  |
|  |  | fn imm\_logic\_from\_imm64(&mut self, ty: Type, n: Imm64) -> Option<ImmLogic> { |
|  |  | let ty = if ty.bits() < 32 { I32 } else { ty }; |
|  |  | self.imm\_logic\_from\_u64(ty, n.bits() as u64) |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -136,7 +128,45 @@ where |
|  |  | /// |
|  |  | /// The logic here is nontrivial enough that it's not really worth porting |
|  |  | /// this over to ISLE. |
|  |  | fn load\_constant64\_full(&mut self, value: u64) -> Reg { |
|  |  | fn load\_constant64\_full( |
|  |  | &mut self, |
|  |  | ty: Type, |
|  |  | extend: &generated\_code::ImmExtend, |
|  |  | value: u64, |
|  |  | ) -> Reg { |
|  |  | let bits = ty.bits(); |
|  |  | let value = if bits < 64 { |
|  |  | if \*extend == generated\_code::ImmExtend::Sign { |
|  |  | let shift = 64 - bits; |
|  |  | let value = value as i64; |
|  |  |  |
|  |  | ((value << shift) >> shift) as u64 |
|  |  | } else { |
|  |  | value & !(u64::MAX << bits) |
|  |  | } |
|  |  | } else { |
|  |  | value |
|  |  | }; |
|  |  | let rd = self.temp\_writable\_reg(I64); |
|  |  |  |
|  |  | if value == 0 { |
|  |  | self.emit(&MInst::MovWide { |
|  |  | op: MoveWideOp::MovZ, |
|  |  | rd, |
|  |  | imm: MoveWideConst::zero(), |
|  |  | size: OperandSize::Size64, |
|  |  | }); |
|  |  | return rd.to\_reg(); |
|  |  | } else if value == u64::MAX { |
|  |  | self.emit(&MInst::MovWide { |
|  |  | op: MoveWideOp::MovN, |
|  |  | rd, |
|  |  | imm: MoveWideConst::zero(), |
|  |  | size: OperandSize::Size64, |
|  |  | }); |
|  |  | return rd.to\_reg(); |
|  |  | }; |
|  |  |  |
|  |  | // If the top 32 bits are zero, use 32-bit `mov` operations. |
|  |  | let (num\_half\_words, size, negated) = if value >> 32 == 0 { |
|  |  | (2, OperandSize::Size32, (!value << 32) >> 32) |
| Expand All | | @@ -152,8 +182,6 @@ where |
|  |  | let ignored\_halfword = if first\_is\_inverted { 0xffff } else { 0 }; |
|  |  | let mut first\_mov\_emitted = false; |
|  |  |  |
|  |  | let rd = self.temp\_writable\_reg(I64); |
|  |  |  |
|  |  | for i in 0..num\_half\_words { |
|  |  | let imm16 = (value >> (16 \* i)) & 0xffff; |
|  |  | if imm16 != ignored\_halfword { |
| Expand Down | |  |

8 changes: 4 additions & 4 deletions

8
[cranelift/filetests/filetests/isa/aarch64/arithmetic.clif](#diff-47c68a6abb5ec501a891c324280979b4e1c62a651ff335d2a812640721fbac33 "cranelift/filetests/filetests/isa/aarch64/arithmetic.clif")

Show comments

[View file](/bytecodealliance/wasmtime/blob/2ba4bce5cc719e5a74e571a534424614e62ecc41/cranelift/filetests/filetests/isa/aarch64/arithmetic.clif)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -74,7 +74,7 @@ block0(v0: i64): |
|  |  | } |
|  |  |  |
|  |  | ; block0: |
|  |  | ; orr x3, xzr, #2 |
|  |  | ; movz w3, #2 |
|  |  | ; sdiv x0, x0, x3 |
|  |  | ; ret |
|  |  |  |
| Expand Down  Expand Up | | @@ -150,7 +150,7 @@ block0(v0: i32): |
|  |  |  |
|  |  | ; block0: |
|  |  | ; sxtw x3, w0 |
|  |  | ; orr x5, xzr, #2 |
|  |  | ; movz w5, #2 |
|  |  | ; sdiv x0, x3, x5 |
|  |  | ; ret |
|  |  |  |
| Expand All | | @@ -176,7 +176,7 @@ block0(v0: i32): |
|  |  |  |
|  |  | ; block0: |
|  |  | ; mov w3, w0 |
|  |  | ; orr x5, xzr, #2 |
|  |  | ; orr w5, wzr, #2 |
|  |  | ; udiv x0, x3, x5 |
|  |  | ; ret |
|  |  |  |
| Expand Down  Expand Up | | @@ -460,7 +460,7 @@ block0(v0: i64): |
|  |  | } |
|  |  |  |
|  |  | ; block0: |
|  |  | ; orr x3, xzr, #2 |
|  |  | ; movz w3, #2 |
|  |  | ; sdiv x5, x0, x3 |
|  |  | ; msub x0, x5, x3, x0 |
|  |  | ; ret |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2ba4bce`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F2ba4bce5cc719e5a74e571a534424614e62ecc41) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a06fdbbc_20250114_194303.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fsecurity%2Fadvisories%2FGHSA-7f6x-jwh5-m9r4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fsecurity%2Fadvisories%2FGHSA-7f6x-jwh5-m9r4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=bytecodealliance%2Fwasmtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bytecodealliance](/bytecodealliance)
/
**[wasmtime](/bytecodealliance/wasmtime)**
Public

* [Notifications](/login?return_to=%2Fbytecodealliance%2Fwasmtime) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)
* [Star
   15.7k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)

* [Code](/bytecodealliance/wasmtime)
* [Issues
  707](/bytecodealliance/wasmtime/issues)
* [Pull requests
  76](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

Additional navigation options

* [Code](/bytecodealliance/wasmtime)
* [Issues](/bytecodealliance/wasmtime/issues)
* [Pull requests](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

# Miscompilation of constant values in division on AArch64

Moderate

[alexcrichton](/alexcrichton)
published
GHSA-7f6x-jwh5-m9r4
Jul 20, 2022

## Package

cargo

cranelift-codegen
([Rust](/advisories?query=ecosystem%3Arust))

## Affected versions

< 0.85.1

## Patched versions

>= 0.85.2

cargo

wasmtime
([Rust](/advisories?query=ecosystem%3Arust))

< 0.38.1

>= 0.38.2

## Description

### Impact

There was a bug in Wasmtime's code generator, Cranelift, for AArch64 targets where constant divisors could result in incorrect division results at runtime. The translation rules for constants did not take into account whether sign- or zero-extension should happen, which resulted in an incorrect value being placed into a register when a division was encountered. For example, a constant 32-bit unsigned divisor of `0xfffffffe` would be incorrectly sign-extended to 64-bits to `0xfffffffffffffffe`. Any kind of division of operands smaller than 64 bits is implemented with a 64-bit division instruction which would then result in an incorrect result because the divisor was larger than expected.

The impact of this bug is that programs executing within the WebAssembly sandbox would not behave according to the WebAssembly specification. This means that it is hypothetically possible for execution within the sandbox to go awry and WebAssembly programs could produce unexpected results. This should not impact hosts executing WebAssembly, but does affect the correctness of guest programs.

This bug was found with differential fuzzing of Wasmtime against other engines on the AArch64 platform. Fuzzing on AArch64 is not regularly performed at this time and the Wasmtime team is investigating how best to continuously fuzz AArch64 in the same manner as x86\_64.

### Patches

This bug has been patched and users should upgrade to Wasmtime version 0.38.2.

### Workarounds

If upgrading is not an option at this time, direct users of Cranelift that control the exact Cranelift instructions being compiled can avoid the vulnerability by explicitly extending constant divisors to 64 bits using either the `sextend.i64` or the `uextend.i64` operation.

Note, though, that this issue only affects the AArch64 targets. Other platforms are not affected.

### For more information

If you have any questions or comments about this advisory:

* Reach out to us on [the Bytecode Alliance Zulip chat](https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime)
* Open an issue in [the bytecodealliance/wasmtime repository](https://github.com/bytecodealliance/wasmtime/)

### Severity

Moderate

### CVE ID

CVE-2022-31169

### Weaknesses

No CWEs

### Credits

* [![@akirilov-arm](https://avatars.githubusercontent.com/u/65777466?s=40&v=4)](/akirilov-arm)
  [akirilov-arm](/akirilov-arm)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


