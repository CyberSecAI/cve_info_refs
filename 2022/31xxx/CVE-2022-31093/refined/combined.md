=== Content from github.com_b3188621_20250114_201248.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-g5fm-jp9v-2432)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fsecurity%2Fadvisories%2FGHSA-g5fm-jp9v-2432)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  98](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

# Improper Handling of `callbackUrl` parameter in next-auth

High

[balazsorban44](/balazsorban44)
published
GHSA-g5fm-jp9v-2432
Jun 20, 2022

## Package

npm

next-auth
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<3.29.5, <4.5.0

## Patched versions

3.29.5, 4.5.0

## Description

### Impact

An attacker can send a request to an app using NextAuth.js with an invalid `callbackUrl` query parameter, which internally we convert to a `URL` object. The URL instantiation would fail due to a malformed URL being passed into the constructor, causing it to throw an unhandled error which led to our **API route handler timing out and logging in to fail**. This has been remedied in the following releases:

next-auth v3 users before version 3.29.5 are impacted. (We recommend upgrading to v4, as v3 is considered unmaintained. See our [migration guide](https://next-auth.js.org/getting-started/upgrade-v4))

next-auth v4 users before version 4.5.0 are impacted.

### Patches

We've released patches for this vulnerability in:

* v3 - `3.29.5`
* v4 - `4.5.0`

You can do:

```
npm i next-auth@latest
```

or

```
yarn add next-auth@latest
```

or

```
pnpm add next-auth@latest
```

(This will update to the latest v4 version, but you can change `latest` to `3` if you want to stay on v3. This is not recommended.)

### Workarounds

If for some reason you cannot upgrade, the workaround requires you to rely on [Advanced Initialization](https://next-auth.js.org/configuration/initialization#advanced-initialization). Here is an example:

**Before:**

```
// pages/api/auth/[...nextauth].js
import NextAuth from "next-auth"

export default NextAuth(/* your config */)
```

**After:**

```
// pages/api/auth/[...nextauth].js
import NextAuth from "next-auth"

function isValidHttpUrl(url) {
  try {
    return /^https?:/.test(url).protocol
  } catch {
    return false;
  }
}

export default async function handler(req, res) {
  if (
    req.query.callbackUrl &&
    !isValidHttpUrl(req.query.callbackUrl)
  ) {
   return res.status(500).send('');
  }

  return await NextAuth(req, res, /* your config */)
}
```
### References

This vulnerability was discovered not long after [GHSA-q2mx-j4x2-2h74](https://github.com/nextauthjs/next-auth/security/advisories/GHSA-q2mx-j4x2-2h74 "GHSA-q2mx-j4x2-2h74") was published and is very similar in nature.

Related documentation:

* <https://next-auth.js.org/getting-started/client#specifying-a-callbackurl>
* <https://next-auth.js.org/configuration/callbacks#redirect-callback>

A test case has been added so this kind of issue will be checked before publishing. See: [e498483](https://github.com/nextauthjs/next-auth/commit/e498483b23273d1bfc81be68339607f88d411bd6)

### For more information

If you have any concerns, we request responsible disclosure, outlined here: <https://next-auth.js.org/security#reporting-a-vulnerability>

### Timeline

The issue was reported 2022 June 10th, a response was sent out to the reporter in less than 2 hours, and a patch was published within 3 hours.

### Severity

High

### CVE ID

CVE-2022-31093

### Weaknesses

[CWE-233](/advisories?query=cwe%3A233)

### Credits

* [![@stensrud](https://avatars.githubusercontent.com/u/1352216?s=40&v=4)](/stensrud)
  [stensrud](/stensrud)
  Analyst

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_7b221be1_20250114_201246.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2F25517b73153332d948114bacdff3b5908de91d85)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2F25517b73153332d948114bacdff3b5908de91d85)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  98](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

## Commit

[Permalink](/nextauthjs/next-auth/commit/25517b73153332d948114bacdff3b5908de91d85)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: handle invalid `callbackUrl`

[Browse files](/nextauthjs/next-auth/tree/25517b73153332d948114bacdff3b5908de91d85)
Browse the repository at this point in the history

* Loading branch information

[![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)](/balazsorban44)

[balazsorban44](/nextauthjs/next-auth/commits?author=balazsorban44 "View all commits by balazsorban44")
committed
Jun 10, 2022

1 parent
[4daa63d](/nextauthjs/next-auth/commit/4daa63d5e12dda9249c1c65384c4ec479dbd37c7)

commit 25517b7

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**48 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/docs

  + docs/docs/errors.md
    [errors.md](#diff-39869ce258a38460b65f6d61da1ad6c5620d0e822a4467fa1f32c49aaa6d9657)
* packages/next-auth/src/core

  + packages/next-auth/src/core/errors.ts
    [errors.ts](#diff-d2fd2cb3136d7f9d4e7b7495498db54cc42ad3f0f6bb845927c4d4016ddbe744)
  + packages/next-auth/src/core/index.ts
    [index.ts](#diff-b4cf7de61e33aa1565dafbfb2055f1348e5ff117a484f2ce4721c31e71517065)
  + lib

    - packages/next-auth/src/core/lib/assert.ts
      [assert.ts](#diff-11c18f5d5462958d785f76ad282270842ad99f7191fd617f1c8b2d8b825c6984)
    - packages/next-auth/src/core/lib/cookie.ts
      [cookie.ts](#diff-dae435eedf08084aacfa79eeadaf0cfd33bd17d16ae215646864a6d2869395b7)

## There are no files selected for viewing

10 changes: 7 additions & 3 deletions

10
[docs/docs/errors.md](#diff-39869ce258a38460b65f6d61da1ad6c5620d0e822a4467fa1f32c49aaa6d9657 "docs/docs/errors.md")

Show comments

[View file](/nextauthjs/next-auth/blob/25517b73153332d948114bacdff3b5908de91d85/docs/docs/errors.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -99,7 +99,7 @@ This is required to store the verification token. Please see the [email provider |
|  |  |  |
|  |  | The Credentials Provider can only be used if JSON Web Tokens are used for sessions. |
|  |  |  |
|  |  | JSON Web Tokens are used for Sessions by default if you have not specified a database. However, if you are using a database, then Database Sessions are enabled by default and you need to [explicitly enable JWT Sessions](https://next-auth.js.org/configuration/options#session) to use the Credentials Provider. |
|  |  | JSON Web Tokens are used for Sessions by default if you have not specified a database. However, if you are using a database, then Database Sessions are enabled by default and you need to [explicitly enable JWT Sessions](/configuration/options#session) to use the Credentials Provider. |
|  |  |  |
|  |  | If you are using a Credentials Provider, NextAuth.js will not persist users or sessions in a database - user accounts used with the Credentials Provider must be created and managed outside of NextAuth.js. |
|  |  |  |
| Expand All | | @@ -119,13 +119,17 @@ The default `code\_challenge\_method` is `"S256"`. This is currently not configura |
|  |  | > If the client is capable of using "S256", it MUST use "S256", as |
|  |  | S256" is Mandatory To Implement (MTI) on the server. |
|  |  |  |
|  |  | #### INVALID\_CALLBACK\_URL\_ERROR |
|  |  |  |
|  |  | The `callbackUrl` provided was either invalid or not defined. See [specifying a `callbackUrl`](/getting-started/client#specifying-a-callbackurl) for more information. |
|  |  |  |
|  |  | --- |
|  |  |  |
|  |  | ### Session Handling |
|  |  |  |
|  |  | #### JWT\_SESSION\_ERROR |
|  |  |  |
|  |  | https://next-auth.js.org/errors#jwt\_session\_error JWKKeySupport: the key does not support HS512 verify algorithm |
|  |  | JWKKeySupport: the key does not support HS512 verify algorithm |
|  |  |  |
|  |  | The algorithm used for generating your key isn't listed as supported. You can generate a HS512 key using |
|  |  |  |
| Expand Down  Expand Up | | @@ -161,7 +165,7 @@ Make sure the file is there and the filename is written correctly. |
|  |  |  |
|  |  | #### NO\_SECRET |
|  |  |  |
|  |  | In production, we expect you to define a `secret` property in your configuration. In development, this is shown as a warning for convenience. [Read more](https://next-auth.js.org/configuration/options#secret) |
|  |  | In production, we expect you to define a `secret` property in your configuration. In development, this is shown as a warning for convenience. [Read more](/configuration/options#secret) |
|  |  |  |
|  |  | #### oauth\_callback\_error expected 200 OK with body but no body was returned |
|  |  |  |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[packages/next-auth/src/core/errors.ts](#diff-d2fd2cb3136d7f9d4e7b7495498db54cc42ad3f0f6bb845927c4d4016ddbe744 "packages/next-auth/src/core/errors.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/25517b73153332d948114bacdff3b5908de91d85/packages/next-auth/src/core/errors.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -63,6 +63,11 @@ export class UnsupportedStrategy extends UnknownError { |
|  |  | code = "CALLBACK\_CREDENTIALS\_JWT\_ERROR" |
|  |  | } |
|  |  |  |
|  |  | export class InvalidCallbackUrl extends UnknownError { |
|  |  | name = "InvalidCallbackUrl" |
|  |  | code = "INVALID\_CALLBACK\_URL\_ERROR" |
|  |  | } |
|  |  |  |
|  |  | type Method = (...args: any[]) => Promise<any> |
|  |  |  |
|  |  | export function upperSnake(s: string) { |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[packages/next-auth/src/core/index.ts](#diff-b4cf7de61e33aa1565dafbfb2055f1348e5ff117a484f2ce4721c31e71517065 "packages/next-auth/src/core/index.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/25517b73153332d948114bacdff3b5908de91d85/packages/next-auth/src/core/index.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -108,7 +108,8 @@ export async function NextAuthHandler< |
|  |  | let signinUrl = `${pages.signIn}${ |
|  |  | pages.signIn.includes("?") ? "&" : "?" |
|  |  | }callbackUrl=${encodeURIComponent(options.callbackUrl)}` |
|  |  | if (error) signinUrl = `${signinUrl}&error=${encodeURIComponent(error)}` |
|  |  | if (error) |
|  |  | signinUrl = `${signinUrl}&error=${encodeURIComponent(error)}` |
|  |  | return { redirect: signinUrl, cookies } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

33 changes: 33 additions & 0 deletions

33
[packages/next-auth/src/core/lib/assert.ts](#diff-11c18f5d5462958d785f76ad282270842ad99f7191fd617f1c8b2d8b825c6984 "packages/next-auth/src/core/lib/assert.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/25517b73153332d948114bacdff3b5908de91d85/packages/next-auth/src/core/lib/assert.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,7 +4,10 @@ import { |
|  |  | MissingAuthorize, |
|  |  | MissingSecret, |
|  |  | UnsupportedStrategy, |
|  |  | InvalidCallbackUrl, |
|  |  | } from "../errors" |
|  |  | import parseUrl from "../../lib/parse-url" |
|  |  | import { defaultCookies } from "./cookie" |
|  |  |  |
|  |  | import type { NextAuthHandlerParams } from ".." |
|  |  | import type { WarningCode } from "../../lib/logger" |
| Expand All | | @@ -18,6 +21,14 @@ type ConfigError = |
|  |  |  |
|  |  | let twitterWarned = false |
|  |  |  |
|  |  | function isValidHttpUrl(url: string) { |
|  |  | try { |
|  |  | return /^https?:/.test(new URL(url).protocol) |
|  |  | } catch { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Verify that the user configured `next-auth` correctly. |
|  |  | \* Good place to mention deprecations as well. |
| Expand All | | @@ -44,8 +55,30 @@ export function assertConfig( |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | const callbackUrlParam = req.query?.callbackUrl as string | undefined |
|  |  |  |
|  |  | if (callbackUrlParam && !isValidHttpUrl(callbackUrlParam)) { |
|  |  | return new InvalidCallbackUrl( |
|  |  | `Invalid callback URL. Received: ${callbackUrlParam}` |
|  |  | ) |
|  |  | } |
|  |  |  |
|  |  | if (!req.host) return "NEXTAUTH\_URL" |
|  |  |  |
|  |  | const url = parseUrl(req.host) |
|  |  |  |
|  |  | const { callbackUrl: defaultCallbackUrl } = defaultCookies( |
|  |  | options.useSecureCookies ?? url.base.startsWith("https://") |
|  |  | ) |
|  |  | const callbackUrlCookie = |
|  |  | req.cookies?.[options.cookies?.callbackUrl?.name ?? defaultCallbackUrl.name] |
|  |  |  |
|  |  | if (callbackUrlCookie && !isValidHttpUrl(callbackUrlCookie)) { |
|  |  | return new InvalidCallbackUrl( |
|  |  | `Invalid callback URL. Received: ${callbackUrlCookie}` |
|  |  | ) |
|  |  | } |
|  |  |  |
|  |  | let hasCredentials, hasEmail |
|  |  | let hasTwitterOAuth2 |
|  |  |  |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[packages/next-auth/src/core/lib/cookie.ts](#diff-dae435eedf08084aacfa79eeadaf0cfd33bd17d16ae215646864a6d2869395b7 "packages/next-auth/src/core/lib/cookie.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/25517b73153332d948114bacdff3b5908de91d85/packages/next-auth/src/core/lib/cookie.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -68,6 +68,7 @@ export function defaultCookies(useSecureCookies: boolean): CookiesOptions { |
|  |  | callbackUrl: { |
|  |  | name: `${cookiePrefix}next-auth.callback-url`, |
|  |  | options: { |
|  |  | httpOnly: true, |
|  |  | sameSite: "lax", |
|  |  | path: "/", |
|  |  | secure: useSecureCookies, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 1 comment on commit `25517b7`

[![@vercel](https://avatars.githubusercontent.com/in/8329?s=80&v=4)](/apps/vercel)

Copy link

### @vercel **[vercel](/apps/vercel) bot** commented on `[25517b7](/nextauthjs/next-auth/commit/25517b73153332d948114bacdff3b5908de91d85)` [Jun 10, 2022](#commitcomment-75789859)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Successfully deployed to the following URLs:

## next-auth â€“ ./

[next-auth-nextauthjs.vercel.app](https://next-auth-nextauthjs.vercel.app)

[www.next-auth.js.org](https://www.next-auth.js.org)

[next-auth-git-main-nextauthjs.vercel.app](https://next-auth-git-main-nextauthjs.vercel.app)

[next-auth-phi-two.vercel.app](https://next-auth-phi-two.vercel.app)

[next-auth.js.org](https://next-auth.js.org)

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2F25517b73153332d948114bacdff3b5908de91d85) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_53706f1f_20250114_201246.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fe498483b23273d1bfc81be68339607f88d411bd6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fe498483b23273d1bfc81be68339607f88d411bd6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=nextauthjs%2Fnext-auth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nextauthjs](/nextauthjs)
/
**[next-auth](/nextauthjs/next-auth)**
Public

* [Notifications](/login?return_to=%2Fnextauthjs%2Fnext-auth) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)
* [Star
   25.6k](/login?return_to=%2Fnextauthjs%2Fnext-auth)

* [Code](/nextauthjs/next-auth)
* [Issues
  308](/nextauthjs/next-auth/issues)
* [Pull requests
  98](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects
  0](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

Additional navigation options

* [Code](/nextauthjs/next-auth)
* [Issues](/nextauthjs/next-auth/issues)
* [Pull requests](/nextauthjs/next-auth/pulls)
* [Discussions](/nextauthjs/next-auth/discussions)
* [Actions](/nextauthjs/next-auth/actions)
* [Projects](/nextauthjs/next-auth/projects)
* [Security](/nextauthjs/next-auth/security)
* [Insights](/nextauthjs/next-auth/pulse)

## Commit

[Permalink](/nextauthjs/next-auth/commit/e498483b23273d1bfc81be68339607f88d411bd6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

test: add test for invalid `callbackUrl` handling

[Browse files](/nextauthjs/next-auth/tree/e498483b23273d1bfc81be68339607f88d411bd6)
Browse the repository at this point in the history

* Loading branch information

[![@balazsorban44](https://avatars.githubusercontent.com/u/18369201?s=40&v=4)](/balazsorban44)

[balazsorban44](/nextauthjs/next-auth/commits?author=balazsorban44 "View all commits by balazsorban44")
committed
Jun 20, 2022

1 parent
[7cf4956](/nextauthjs/next-auth/commit/7cf49566a6327ae99a3def6d20b28c3786c7368c)

commit e498483

Showing
**1 changed file**
with
**16 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

16 changes: 16 additions & 0 deletions

16
[packages/next-auth/tests/assert.test.ts](#diff-36bd69acd3c930952696246baa18a9020a845cd6978bdc85ecaa2ec11a72651f "packages/next-auth/tests/assert.test.ts")

Show comments

[View file](/nextauthjs/next-auth/blob/e498483b23273d1bfc81be68339607f88d411bd6/packages/next-auth/tests/assert.test.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,6 +13,22 @@ it("Show error page if secret is not defined", async () => { |
|  |  | expect(log.error).toBeCalledWith("NO\_SECRET", expect.anything()) |
|  |  | }) |
|  |  |  |
|  |  | it("Should show configuration error page on invalid `callbackUrl`", async () => { |
|  |  | const { res, log } = await handler( |
|  |  | { providers: [] }, |
|  |  | { prod: true, params: { callbackUrl: "invalid-callback" } } |
|  |  | ) |
|  |  |  |
|  |  | expect(res.status).toBe(500) |
|  |  | expect(res.html).toMatch(/there is a problem with the server configuration./i) |
|  |  | expect(res.html).toMatch(/check the server logs for more information./i) |
|  |  |  |
|  |  | expect(log.error).toBeCalledWith( |
|  |  | "INVALID\_CALLBACK\_URL\_ERROR", |
|  |  | expect.anything() |
|  |  | ) |
|  |  | }) |
|  |  |  |
|  |  | it("Allow relative `callbackUrl`", async () => { |
|  |  | const { res, log } = await handler( |
|  |  | { providers: [] }, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e498483`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnextauthjs%2Fnext-auth%2Fcommit%2Fe498483b23273d1bfc81be68339607f88d411bd6) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from next-auth.js.org_f01cc3e6_20250114_201249.html ===

Skip to main contentNextAuth.js is becoming Auth.js! ðŸŽ‰ We're creating Authentication for the Web. Everyone included. You are looking at the NextAuth.js (v4) documentation. For the new documentation go to [authjs.dev](https://authjs.dev).[![NextAuth Logo](/img/logo/logo-xs.png)![NextAuth Logo](/img/logo/logo-xs.png)**NextAuth.js**](/)[Documentation](/getting-started/introduction)[Tutorials](/tutorials)[FAQ](/faq)[Security](/security)[v4](/getting-started/introduction)

* [v4](/configuration/initialization)
* [v3](/v3/getting-started/introduction)
* [All Releases](https://github.com/nextauthjs/next-auth/releases)
[npm](https://www.npmjs.com/package/next-auth)[GitHub](https://github.com/nextauthjs/next-auth)Search

* [Getting Started](/getting-started/introduction)
  + [Introduction](/getting-started/introduction)
  + [Getting Started](/getting-started/example)
  + [Client API](/getting-started/client)
  + [REST API](/getting-started/rest-api)
  + [TypeScript](/getting-started/typescript)
  + [Upgrade Guide (v4)](/getting-started/upgrade-v4)
* [Configuration](/configuration/initialization)
  + [Initialization](/configuration/initialization)
  + [Options](/configuration/options)
  + [Providers](/configuration/providers/oauth)
  + [Databases](/configuration/databases)
  + [Pages](/configuration/pages)
  + [Callbacks](/configuration/callbacks)
  + [Events](/configuration/events)
  + [Next.js](/configuration/nextjs)
* [Providers](/providers/)
* [Adapters](/adapters)
* [Warnings](/warnings)
* [Errors](/errors)
* [Deployment](/deployment)
* [Guides](/guides/)
* SponsoredLooking for a
  hosted alternative?[Try Clerk â†’](https://go.clerk.com/DefS1u4)

* Configuration
* Initialization
Version: v4On this page
# Initialization

The main entry point of NextAuth.js is the `NextAuth` method that you import from `next-auth`. It handles different types of requests, as defined in the [REST API](/getting-started/rest-api) section.

info

NextAuth.js cannot use the run [Edge Runtime](https://nextjs.org/docs/api-reference/edge-runtime) for initialization. The upcoming [`@auth/nextjs` library](https://authjs.dev/reference/next-auth) (which will replace `next-auth`) on the other hand will be fully compatible.

You can initialize NextAuth.js in a few different ways.

## Simple initialization[â€‹](#simple-initialization "Direct link to heading")

### API Routes (`pages`)[â€‹](#api-routes-pages "Direct link to heading")

In Next.js, you can define an API route that will catch all requests that begin with a certain path. Conveniently, this is called [Catch all API routes](https://nextjs.org/docs/api-routes/dynamic-api-routes#catch-all-api-routes).

When you define a `/pages/api/auth/[...nextauth]` JS/TS file, you instruct NextAuth.js that every API request beginning with `/api/auth/*` should be handled by the code written in the `[...nextauth]` file.

/pages/api/auth/[...nextauth].ts
```
import NextAuth from "next-auth"

export default NextAuth({
  ...
})

```

Here, you only need to pass your [options](/configuration/options) to `NextAuth`, and `NextAuth` does the rest.

This is the preferred initialization in tutorials/other parts of the documentation, as it simplifies the code and reduces potential errors in the authentication flow.

### Route Handlers (`app/`)[â€‹](#route-handlers-app "Direct link to heading")

[Next.js 13.2](https://nextjs.org/blog/next-13-2#custom-route-handlers) introduced [Route Handlers](https://beta.nextjs.org/docs/routing/route-handlers), the preferred way to handle REST-like requests in App Router (`app/`).

You can initialize NextAuth.js with a Route Handler too, very similar to API Routes.

/app/api/auth/[...nextauth]/route.ts
```
import NextAuth from "next-auth"

const handler = NextAuth({
  ...
})

export { handler as GET, handler as POST }

```

Internally, NextAuth.js detects that it is being initialized in a Route Handler (by understanding that it is passed a Web [`Request` instance](https://developer.mozilla.org/en-US/docs/Web/API/Request)), and will return a handler that returns a [`Response` instance](https://developer.mozilla.org/en-US/docs/Web/API/Response). A Route Handler file expects you to export some named handler functions that handle a request and return a response. NextAuth.js needs the `GET` and `POST` handlers to function properly, so we export those two.

info

Technically, in a Route Handler, the `api/` prefix is not necessary, but we decided to keep it required for an easier migration.

## Advanced initialization[â€‹](#advanced-initialization "Direct link to heading")

info

The following describes the advanced initialization with API Routes, but everything will apply similarily when using [Route Handlers](https://beta.nextjs.org/docs/routing/route-handlers) too.
Instead, `NextAuth` will receive the first two arguments of a Route Handler, and the third argument will be the [auth options](/configuration/options)

If you have a specific use case and need to make NextAuth.js do something slightly different than what it is designed for, keep in mind, the `[...nextauth].ts` config file is just **a regular [API Route](https://nextjs.org/docs/api-routes/introduction)**.

That said, you can initialize NextAuth.js like this:

/pages/api/auth/[...nextauth].ts
```
import type { NextApiRequest, NextApiResponse } from "next"
import NextAuth from "next-auth"

export default async function auth(req: NextApiRequest, res: NextApiResponse) {
  // Do whatever you want here, before the request is passed down to `NextAuth`
  return await NextAuth(req, res, {
    ...
  })
}

```

The `...` section will still be your [options](/configuration/options), but you now have the possibility to execute/modify certain things on the request.

You could for example log the request, add headers, read `query` or `body` parameters, whatever you would do in an API route.

tip

Since this is a catch-all route, remember to check what kind of NextAuth.js "action" is running. Compare the REST API with the `req.query.nextauth` parameter.

For example to execute something on the "callback" action when the request is a POST method, you can check for `req.query.nextauth.includes("callback") && req.method === "POST"`

note

`NextAuth` will implicitly close the response (by calling `res.end`, `res.send` or similar), so you should not run code **after** `NextAuth` in the function body. Using `return NextAuth` makes sure you don't forget that.

Any variable you create this way will be available in the `NextAuth` options as well, since they are in the same scope.

/pages/api/auth/[...nextauth].ts
```
import type { NextApiRequest, NextApiResponse } from "next"
import NextAuth from "next-auth"

export default async function auth(req: NextApiRequest, res: NextApiResponse) {

  if(req.query.nextauth.includes("callback") && req.method === "POST") {
    console.log(
      "Handling callback request from my Identity Provider",
      req.body
    )
  }

  // Get a custom cookie value from the request
  const someCookie = req.cookies["some-custom-cookie"]

  return await NextAuth(req, res, {
    ...
    callbacks: {
      session({ session, token }) {
        // Return a cookie value as part of the session
        // This is read when `req.query.nextauth.includes("session") && req.method === "GET"`
        session.someCookie = someCookie
        return session
      }
    }
  })
}

```

A practical example could be to not show a certain provider on the default sign-in page, but still be able to sign in with it. (The idea is taken from [this discussion](https://github.com/nextauthjs/next-auth/discussions/3133)):

/pages/api/auth/[...nextauth].ts
```
import NextAuth from "next-auth"
import CredentialsProvider from "next-auth/providers/credentials"
import GoogleProvider from "next-auth/providers/google"

export default async function auth(req, res) {
  const providers = [
    CredentialsProvider(...),
    GoogleProvider(...),
  ]

  const isDefaultSigninPage = req.method === "GET" && req.query.nextauth.includes("signin")

  // Will hide the `GoogleProvider` when you visit `/api/auth/signin`
  if (isDefaultSigninPage) providers.pop()

  return await NextAuth(req, res, {
    providers,
    ...
  })
}

```

For more details on all available actions and which methods are supported, please check out the [REST API documentation](/getting-started/rest-api) or the appropriate area in [the source code](https://github.com/nextauthjs/next-auth/blob/v4/packages/next-auth/src/core/index.ts)

This way of initializing `NextAuth` is very powerful, but should be used sparingly.

danger

Changing parts of the request that is essential to `NextAuth` to do its job - like messing with the [default cookies](/configuration/options#cookies) - can have unforeseen consequences, and have the potential to introduce security holes if done incorrectly. Only change those if you understand consequences.

[Edit this page](https://github.com/nextauthjs/next-auth/edit/v4/docs/docs/configuration/initialization.md)Last updated on **Oct 24, 2024** by **BalÃ¡zs OrbÃ¡n**[PreviousUpgrade Guide (v4)](/getting-started/upgrade-v4)[NextOptions](/configuration/options)

* [Simple initialization](#simple-initialization)
  + [API Routes (`pages`)](#api-routes-pages)
  + [Route Handlers (`app/`)](#route-handlers-app)
* [Advanced initialization](#advanced-initialization)
About NextAuth.js

* [Introduction](/getting-started/introduction)
Download

* [GitHub](https://github.com/nextauthjs/next-auth)
* [NPM](https://www.npmjs.com/package/next-auth)
Acknowledgements

* [Contributors](/contributors)
* [Sponsors](/sponsors)
* [Images by unDraw](https://undraw.co/)
NextAuth.js Â© Iain Collins 2025


