=== Content from www.zenity.io_6a3ed079_20250115_092007.html ===


* [Need security to keep up with AI Skills? Learn about our AISPM solution](https://www.zenity.io/company-overview/newsroom/company-news/zenity-introduces-the-first-comprehensive-ai-security-posture-management-solution-to-govern-microsoft-fabric-ai-skills/)

[![](https://www.zenity.io/wp-content/uploads/2023/12/zenity-logo.svg)](https://www.zenity.io/)

* [Agentic AI](https://www.zenity.io/agentic-ai/ "Agentic AI")
* [Platform](/platform/ "Platform")
* Use Cases

  By Business Need

  [Generative AI![](https://www.zenity.io/wp-content/uploads/2023/12/AI.svg)](/use-cases/business-needs/gen-ai/)
  [Citizen Development![](https://www.zenity.io/wp-content/uploads/2023/12/Citizen-Dev.svg)](/use-cases/business-needs/citizen-development/)
  [Security![](https://www.zenity.io/wp-content/uploads/2023/12/Security.svg)](/use-cases/business-needs/security/)
  [Compliance![](https://www.zenity.io/wp-content/uploads/2023/12/Compliance.svg)](/use-cases/business-needs/compliance/)
  [Business Continuity![](https://www.zenity.io/wp-content/uploads/2023/12/Buisness-Continuity.svg)](/use-cases/business-needs/business-continuity/)

  By Platform

  [Microsoft 365 Copilot![](https://www.zenity.io/wp-content/uploads/2023/12/copilot-e1722605822566.png)](https://www.zenity.io/use-cases/platform/copilot-for-m365/)
  [Power Platform![](https://www.zenity.io/wp-content/uploads/2023/12/Microsoft-Power-Platform.svg)](/use-cases/platform/power-platform/)
  [Copilot Studio![](https://www.zenity.io/wp-content/uploads/2023/12/Microsoft.svg)](/use-cases/platform/microsoft-copilot-studio/)
  [Salesforce![](https://www.zenity.io/wp-content/uploads/2023/12/Salesforce.svg)](/use-cases/platform/salesforce/)
  [Service Now![](https://www.zenity.io/wp-content/uploads/2023/12/ServiceNow.svg)](/use-cases/platform/servicenow/)

  By Business Type

  [Healthcare![](https://www.zenity.io/wp-content/uploads/2023/12/Healthcare.svg)](/use-cases/business-type/healthcare/)
  [Financial Services![](https://www.zenity.io/wp-content/uploads/2023/12/Financial-Services.svg)](/use-cases/business-type/financial-services/)
  [Technology![](https://www.zenity.io/wp-content/uploads/2023/12/Tech.svg)](/use-cases/business-type/technology/)
  [Retail & Manufacturing![](https://www.zenity.io/wp-content/uploads/2023/12/Retail.svg)](/use-cases/business-type/retail-manufacturing/)

  + [Explore all use cases](/use-cases/)
* [Resources](/resources/ "Resources")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/ebooks.svg)eBooks](/resources/ebooks/ "eBooks")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/White-Papers.svg)White Papers](/resources/white-papers/ "White Papers")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Case-Studies.svg)Case Studies](/resources/case-studies/ "Case Studies")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Videos.svg)Videos](/resources/videos/ "Videos")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Webinar.svg)Webinars](/resources/webinars/ "Webinars")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Glossary.svg)Glossary](/glossary/ "Glossary")
* Company
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/About.svg)About Us](/company/ "About Us")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Careers.svg)Careers](/careers/ "Careers")
  + [![](https://www.zenity.io/wp-content/uploads/2024/10/Events.svg)Events](https://www.zenity.io/resources/events/ "Events")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/White-Papers.svg)Zenity Security Assessment Hub](https://www.zenity.io/zenity-security-assessment-hub/ "Zenity Security Assessment Hub")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/News.svg)News](/company/newsroom/ "News")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Careers.svg)Partners](https://www.zenity.io/partners/ "Partners")
  + [![](https://www.zenity.io/wp-content/uploads/2023/12/Contact.svg)Contact](/company/contact/ "Contact")
  + [![](https://www.zenity.io/wp-content/uploads/2024/02/TrustCenter.svg)Trust Center](/company/trust-center/ "Trust Center")
* Blogs
  + [Zenity Blog](https://www.zenity.io/blog/ "Zenity Blog")
  + [Zenity Labs Blog](https://labs.zenity.io/ "Zenity Labs Blog")

* [Log in](https://docs.zenity.io/UserGuide/ZenityUG/)
* [Book a demo](https://www.zenity.io/book-a-demo/)

* [Log in](https://docs.zenity.io/UserGuide/ZenityUG/)
* [Book a demo](https://www.zenity.io/book-a-demo/)

[Home](https://www.zenity.io/) [Blog](https://www.zenity.io/blog/) ZAPESCAPE: Vulnerability Disclosure

Research

# ZAPESCAPE: Vulnerability Disclosure

![](https://secure.gravatar.com/avatar/675cbba825516401615c1f355075014d?s=96&r=g)
Michael Bargury
Sep 19th, 2022

![](https://www.zenity.io/wp-content/uploads/2024/02/5-1.png)

Date: March 16th 2022

Severity: High

Security impact: Privilege Escalation, Data Leakage, Data Manipulation

## Intro

This document is the vulnerability disclosure report once the vulnerability was discovered. For a description of the vulnerability, its impact and what should you do next, please refer to ZAPESCAPE: Organization-wide control over Code by Zapier

## Summary

The Code by Zapier app allows users to execute Python or JavaScript code as part of their zap. Our research exposes that this feature relies on an AWS Lambda instance shared by the entire Zapier account, and demonstrates how any user in that account, no matter their privileges, can gain full control over that Lambda instance, granting them access to code, input and secrets that belong to other users within that account.

## Reproduction steps

### Step 1: Set Up an Endpoint to Exfiltrate Data

The endpoint will receive data, code and secrets exfiltrated from Zapier. For ease of use, we recommend using <https://webhook.site/>, which provides a dedicated endpoint viewable in the browser.

The website will generate a unique webhook for you to use. In this case, we got the unique url: https://webhook.site/0f340ac4-fd2b-4a4e-a0d4-0d973b2057a3.

### Step 2: Create a Zap and add Code by Zapier

Create a new Zap. You can use a private Zap to [avoid anyone including admins](https://zapier.com/help/account/companies/data-privacy-in-zapier-for-companies-accounts#step-1) from detecting your malicious Zap. Choose any trigger. We used “Schedule by Zapier” and configured it to run hourly. Test your trigger.

When prompted to create an Action, choose “Code by Zapier” with Action Event “Run Python”.

The full Zap:

### Step 3: Use a Malicious Payload to Take Control Over the Account’s Lambda instance

Insert the exfiltration URL to the code below. We have already done so with our unique URL from step 1 to the code.

Replace the “code” section with the payload below. The code is explained in detail later on.

![](https://www.zenity.io/wp-content/uploads/2024/02/Screen-Shot-2022-09-21-at-15.11.17-807x1024.png)

In short, the code above replaces the Lambda runtime with our own malicious runtime version, and then invokes the Lambda Runtime API to process the current event and any future event, until Lambda’s cache gets recycled. Every time the code above is executed, the attacker gains full control over the entire account’s Lambda instance for several minutes. Of course, an attacker could set up a Zapier schedule to run this code every 10-15 minutes, thus gaining semi-persistency over the account’s Lambda instance.

### Step 4: Zapier will Send Data, Code and Secrets to your Exfiltration URL

While our malicious runtime is handling events instead of AWS’s native runtime, we can do whatever we want. To demonstrate this capability, we introduce a malicious runtime which calls the method before handling any new event, and then continues to execute as a normal AWS’s runtime:

![](https://www.zenity.io/wp-content/uploads/2024/02/Screen-Shot-2022-09-21-at-15.14.49-1024x376.png)

[Malicious *bootstrap.py*](https://github.com/zenitysec/lambda-persistency-poc/blob/6d4e75a40750b8ab4c4a6cc70b61c316d8dc5359/external_process_poc/twist_runtime.py#L372)

This produces a stream of data sent to our exfiltration URL by Zapier. The data contains the entire Lambda event, including

* Code by Zapier input
* The code used by the Code by Zapier action, including any secrets used, in particular those used by “Store by Zapier” or its Python client “StoreClient”.

On the Exfiltration Endpoint, we see:

### Step 5: Run a Benign Zap

To see the attack in action, log in to Zapier with another user of that same Zapier account. Run any Zap that uses “Code by Zapier”, and watch the exfiltration URL for data leaked from Zapier. Once you trigger the Zap, Zapier would immediately send the Action input and code to the exfiltration URL.

### Step 6: Automate to Maintain Access

Lambda environments are short-lived. Once the malicious code at step 4 is executed, the malicious runtime will process any event instead of the AWS runtime for as long as Lambda’s cache is not invalidated. Note that this could include several minutes where the original Lambda instance which processed the malicious payload has already terminated, but its cache is still valid. This means that each time the malicious code is executed, the attacker gains full access for several minutes. Our experiments show this to be 10-15 minutes.

To maintain access, an attacker could set up the malicious Zap to run every 10 or even 5 minutes, via a native schedule trigger or a webhook trigger to be triggered with another scheduler.

This allows the attacker to maintain full access for the vast majority of events processed by “Code by Zapier”.

## Further details

### Vulnerability Scope

This vulnerability enables gaining full control over the “Code by Zapier” runtime environment for the entire account. It is executable by ANY account user, no matter their role. The exploit could be introduced through a private Zap, which would ensure the attacker would not be detected, since [admins would have no visibility into private Zaps](https://zapier.com/help/account/companies/data-privacy-in-zapier-for-companies-accounts#step-1) other than knowing that they exist (even not the names).

Our research shows that “Code by Zapier” runs on an AWS Lambda function shared between the entire Zapier account with ARN “arn:aws:lambda:us-east-1:996097627176:function:prd-mngd-lmbd\_paidcodeapipy37\_ac”. We were able to demonstrate this vulnerability in all Zapier tiers. Note that in the Free Tier, the Lambda ARN is slightly different, where paidcodeapipy37 is replaced with codeapipy37.

What can attackers do with this vulnerability? Really, anything they want within the scope of the Lambda function. The attacker is practically the function for the time of the attack. This includes:

* Exfiltrating Code by Zapier input and code (which most likely contains secrets, including those used by “Store by Zapier” or its Python client *“StoraClient”*).
* Steal AWS credentials – AWS passes an invoked role to Lambda via environment variables. In this case, Zapier’s lambda handler (stored at “*/var/task/lambda\_handler.py*”) is actively deleting the following environment variables to avoid leakage: ’AWS\_ACCESS\_KEY\_ID’, ‘AWS\_SECURITY\_TOKEN’, ‘AWS\_SESSION\_TOKEN’, ‘AWS\_SECRET\_ACCESS\_KEY’. Of course, an attack with full control over the lambda runtime can replace Zapier’s lambda handler to disable deletion of those secrets, and steal them anyway.
* Manipulate the output of “Code by Zapier” to whatever the attacker would like.
* Use Zapier infrastructure for malicious purposes (e.g. DDOS).
* Steal secrets passed to *“StoreClient”* by replacing *from store\_api import StoreClient* a malicious wrapper that sends the secret to an exfiltration endpoint. See Root Cause Analysis for context of this import command.

Note that since Zapier provides a separate Lambda function instance for each Zapier account, this vulnerability is scoped to intra-account privilege escalation.

### Root Cause Analysis

Our research exposes that “Code by Zapier” runs input code with the following method:

![](https://www.zenity.io/wp-content/uploads/2024/02/Screen-Shot-2022-09-21-at-15.18.06-1009x1024.png)

Extracted from Zapier Lambda environment, */var/task/lambda\_handler.py*

Using the *exec* command without any limitation is extremely dangerous, and allows the attacker to, among other actions, spawn subprocesses, query the OS (as we did), communicate with the Lambda Runtime API (as done by the malicious code in step 2), and more.

## Mitigation

To mitigate the issue, we identify two options. One solution would be for Zapier to provide a separate Lambda function instance for each user, thus avoiding one user gaining control over another user’s Lambda environment. Another solution would be to avoid using *exec* entirely, or more realistically to limit the scope of exec so it cannot spawn subprocesses or query the entire OS. We also recommend denying usage of the Python *inspect* module, which lets an attacker analyze the Python call stack for reconnaissance.

## Additional Information – Recon

In order to demonstrate these capabilities, we first needed to use a few different commands for reconnaissance of the “Code by Zapier” environment. Using the Python *inspect* module, we explored to call stack to discover  */var/task/lambda\_handler.py*, Zapier’s Lambda handler and */var/task/secret\_store.py*, Zapier’s wrapper around [*https://store.zapier.com*](https://store.zapier.com). We were also able to peek into the caller stack, namely */var/runtime/bootstrap.py*, to query the event and context objects, which are supposedly hidden from the *exec* command as seen in lambda\_handler.py code above.

## References

For more information about using RCE to gain full access over a Lambda function instance, see [Gaining Persistency on Vulnerable Lambdas](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/).

## Subscribe to Newsletter

Keep informed of all the latest news and notes within the world of securing and governing citizen development

## Thanks for registering to the Zenity newsletter.

#### We are sure that you will like it and are looking forward to seeing you again soon.

## Related posts

![](https://www.zenity.io/wp-content/uploads/2024/06/Product-Announcement-Version-1-11-1024x538.png)

June 24th, 2024

[#### Building Apps at Scale in Power Platform? Not for the Faint of Heart… or CoE Security](https://www.zenity.io/blog/security/building-apps-at-scale-in-power-platform-not-for-the-faint-of-heart-or-coe-security/)
Introduction Enterprises are racing to adopt AI copilots and low-code/no-code platforms to innovate and maximize efficiency by placing powerful technology and development tools in the hands of all business users. While the productivity gains are enormous, so are the security risks, as the nature of these copilots and low-code platforms results in a surge of…

Blog

![](https://www.zenity.io/wp-content/uploads/2024/06/Product-Announcement-Version-1-10-1024x538.png)

June 18th, 2024

[#### Inherent Data Leakage in Microsoft Fabric Business-Led Development](https://www.zenity.io/blog/research/inherent-data-leakage-in-microsoft-fabric-business-led-development/)
Microsoft Fabric is an end-to-end analytics and data platform that covers a wide range of functionality, including data movement, processing, ingestion, transformation, real-time event routing, and report building. The platform allows business users of all technical backgrounds to create, process, and store data and build powerful business tools from a unified platform.  Unfortunately, Fabric users…

Blog

![](https://www.zenity.io/wp-content/uploads/2024/02/Product-Announcement-Version-1-1-1024x538.png)

February 23rd, 2024

[#### What a Vulnerability in Salesforce Apex Code Means for You](https://www.zenity.io/blog/security/what-a-vulnerability-in-salesforce-apex-code-means-for-you/)
The obfuscated nature of custom Apex code that is used in internal Salesforce instances and apps (i.e. Lightning, Lightning Communities) is at the root of the problem. As people are building their own apps and automations, there are also a variety of settings, steps, and configurations that need to happen that are often missed due to the lack of a software development lifecycle that takes place across Salesforce, and other low-code platforms like it.

Blog

* Platform
  + [Platform Overview](/platform/)
* [Use Cases](/use-cases/)
  + By Business Need
    - [Agentic AI](https://www.zenity.io/agentic-ai/)
    - [Generative AI](/use-cases/business-needs/gen-ai/)
    - [Citizen Development](/use-cases/business-needs/citizen-development/)
    - [Security](/use-cases/business-needs/security/)
    - [Compliance](/use-cases/business-needs/compliance/)
    - [Business Continuity](/use-cases/business-needs/business-continuity/)
  + By Business Type
    - [Healthcare](/use-cases/business-type/healthcare/)
    - [Financial Services](/use-cases/business-type/financial-services/)
    - [Technology](/use-cases/business-type/technology/)
    - [Retail & Manufacturing](/use-cases/business-type/retail-manufacturing/)
* + By Platform
    - [Microsoft 365 Copilot](https://www.zenity.io/use-cases/platform/copilot-for-m365/)
    - [Power Platform](/use-cases/platform/power-platform/)
    - [Copilot Studio](/use-cases/platform/microsoft-copilot-studio/)
    - [Salesforce](/use-cases/platform/salesforce/)
    - [Service Now](/use-cases/platform/servicenow/)
* [Resources](/resources/)
  + [eBooks](/resources/ebooks/)
  + [White Papers](/resources/white-papers/)
  + [Case Studies](/resources/case-studies/)
  + [Videos](/resources/videos/)
  + [Webinar](/resources/webinars/)
  + [Zenity Security Assessment Hub](https://www.zenity.io/zenity-security-assessment-hub/)
  + [Glossary](/glossary/)
* Company
  + [About Us](/company/)
  + [Careers](/careers/)
  + [Events](https://www.zenity.io/resources/events/)
  + [Partners](https://www.zenity.io/partners/)
  + [News](/company/newsroom/)
  + [Contact](/company/contact/)
  + [Trust Center](/company/trust-center/)

![](https://www.zenity.io/wp-content/uploads/2023/12/footer-logo.svg)

* [Terms and Conditions](/terms-and-conditions/)
* [Privacy Policy](/privacy-policy/)
* [Cookies Policy](/cookies-policy/)

Copyright © Zenity LTD. | All rights Reserved 2024


