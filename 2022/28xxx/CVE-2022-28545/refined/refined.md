The provided content relates to CVE-2022-28545.

Based on the provided diffs, here's a breakdown of the vulnerabilities and fixes:

**Vulnerability 1: Stored XSS in attachment filenames (commit 8ff4468)**

*   **Root Cause:** The `attach_add` function in `install/forum_data/src/attach.inc.t` was not properly sanitizing the attachment filename before storing it in the database. This allowed an attacker to inject malicious HTML or JavaScript into the filename, which could then be executed when the filename is displayed.
*   **Weaknesses/Vulnerabilities:** Stored Cross-Site Scripting (XSS)
*   **Impact of Exploitation:** An attacker could inject malicious scripts into the attachment filename, which would then execute in the browser of any user who viewed the attachment list. This could lead to session hijacking, data theft, or other malicious activities.
*   **Attack Vectors:** The attacker needs to be able to upload an attachment with a crafted filename containing malicious code.
*   **Required Attacker Capabilities/Position:** The attacker must be able to upload files, which usually requires being a logged-in user.
*   **Fix:** The fix involves applying `htmlspecialchars()` to the attachment's name before it is inserted into the database:
    ```diff
    --- a/install/forum_data/src/attach.inc.t
    +++ b/install/forum_data/src/attach.inc.t
    @@ -26,7 +26,7 @@
     function attach_add($at, $owner, $attach_opt=0, $ext=0)
     {
      $id = db_qid('INSERT INTO {SQL_TABLE_PREFIX}attach (location, message_id, original_name, owner, attach_opt, mime_type,fsize) '.
    -	q_limit('SELECT null AS location, 0 AS message_id, '. \_esc($at['name']) .' AS original_name, '. $owner .' AS owner, '. $attach_opt .' AS attach_opt, id AS mime_type, '. $at['size'] .' AS fsize
    +	q_limit('SELECT null AS location, 0 AS message_id, '. \_esc(htmlspecialchars($at['name'])) .' AS original_name, '. $owner .' AS owner, '. $attach_opt .' AS attach_opt, id AS mime_type, '. $at['size'] .' AS fsize
      FROM {SQL_TABLE_PREFIX}mime WHERE fl_ext IN(\'*\', '. \_esc(strtolower(substr(strrchr($at['name'], '.'), 1))) .')
      ORDER BY fl_ext DESC'
      , 1)
    ```

**Vulnerability 2: XSS in email subject (commit aed6966)**

*   **Root Cause:** The email subject was not being properly sanitized before being used in the email header, potentially allowing an attacker to inject malicious HTML or Javascript through the email subject. Specifically, an earlier attempt to prevent XSS using `html_entity_decode` had been removed and wasn't replaced.
*   **Weaknesses/Vulnerabilities:** Cross-Site Scripting (XSS)
*  **Impact of Exploitation:** An attacker could inject malicious scripts into the email subject, which would then execute in the email client of any user who received the email. This could potentially lead to phishing attacks, session hijacking, or other malicious activities. Note that this is dependent on email client behavior which may or may not render HTML in subjects.
*   **Attack Vectors:** An attacker needs to be able to send an email, either through direct mail functionality on the site or via other means that allow modification of the email subject, with a crafted subject containing malicious code.
*   **Required Attacker Capabilities/Position:** The attacker must be able to trigger the sending of an email.
*   **Fix:**  The fix involves:
    1. Reinstating the use of `html_entity_decode` on the subject when handling non-encoded subjects.
    2. Applying `htmlspecialchars()` to the subject within the `encode_subject` function to prevent XSS, and using that function everywhere the subject is used:
    ```diff
    --- a/install/forum_data/src/iemail.inc.t
    +++ b/install/forum_data/src/iemail.inc.t
    @@ -35,6 +35,13 @@
      function encode_subject($text)
      {
      /* HTML entities check. */
    + if (strpos($subj, '&') !== false) {
    +  $subj = html_entity_decode($subj);
    + }
    +
    + $text = htmlspecialchars($text); // Prevent XSS like <img src="1" onerror="alert()">
    +
      if (preg_match('![\x7f-\xff]!', $text)) {
          $text = '=?{TEMPLATE: iemail_CHARSET}?B?'. base64_encode($text) .'?=';
      }
    @@ -51,11 +58,6 @@
        return 0;
      }
    
    - /* HTML entities check. */
    - if (strpos($subj, '&') !== false) {
    -  $subj = html_entity_decode($subj);
    - }
    -
      if ($header) {
          $header = "\n" . str_replace("\r", '', $header);
      }
    @@ -66,14 +68,14 @@
      $addronly = preg_replace('/.\*</', '<', $from); // RFC 2822 Return-Path: <...>
      $header = 'From: '. $from ."\nReturn-Path: ". $addronly ."\nUser-Agent: FUDforum/". $GLOBALS['FORUM_VERSION'] . $extra_header . $header;
    
    - $subj = encode_subject($subj);
      $body = str_replace("\r", '', $body);
      if ($munge_newlines) {
          $body = str_replace('\n', "\n", $body);
      }
    +  $subj = encode_subject($subj);
    
      // Call PRE mail plugins.
      if (defined('plugins')) {
    @@ -88,7 +90,7 @@
      }
      $smtp = new fud_smtp;
      $smtp->msg = str_replace(array('\n', "\n."), array("\n", "\n.."), $body);
    - $smtp->subject = encode_subject($subj);
    + $smtp->subject = $subj;
      $smtp->to = $to;
      $smtp->from = $from;
      $smtp->headers = $header;
    ```