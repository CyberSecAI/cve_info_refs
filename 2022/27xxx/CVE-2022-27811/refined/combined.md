=== Content from gitlab.gnome.org_a2436992_20250114_205323.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

# Cannot import PDF if filename contains some special chars

PDF cannot be imported if the filename contains some special characters, such as quotation marks.

## Steps to reproduce

1. Download sample file:

```
$ wget https://www.oreilly.com/openbook/beosprog/book/ch01.pdf
```

2. Rename the file or create a symlink for it

```
$ ln -s ch01.pdf "Joaquim \"jrocha\" Rocha - 'top secret' files.pdf"
```

```
$ ls Joaquim*
Joaquim "jrocha" Rocha - 'top secret' files.pdf
```

3. `File` → `Import PDF` → `Open`

## Excepted results

Importing PDF.

## Actual results

Nothing happened.

## Temporary patch

```
diff --git a/src/ocrfeeder/util/lib.py b/src/ocrfeeder/util/lib.py
index 7766230..fa828fb 100644
--- a/src/ocrfeeder/util/lib.py
+++ b/src/ocrfeeder/util/lib.py
@@ -18,6 +18,7 @@
 ###########################################################################

 import os
+import re
 import mimetypes
 from PIL import Image
 import tempfile
@@ -42,19 +43,54 @@ def getIconOrLabel(icon_name, label_text, icon_size = Gtk.IconSize.SMALL_TOOLBAR
         label = None
     return icon, label

+def getSafeGhostscriptPath(file_path):
+    return re.sub(r'[^\w !#$%&()*+,./:;<=>?@\[\\\]^_`{|}~-]', '_', file_path)
+
+def getSafeGhostscriptInputFilename(file_name):
+    return re.sub(r'[/]', '_', getSafeGhostscriptPath(file_name))
+
+def getSafeGhostscriptOutputBasename(file_name):
+    return re.sub(r'[%]', '_', getSafeGhostscriptInputFilename(file_name))
+
 def convertPdfToImages(pdf_file, temp_dir = '/tmp'):
-    dir_name = tempfile.mkdtemp(dir = temp_dir)
+    if not os.path.isfile(pdf_file):
+        debug('Unable to convert PDF: File does not exist: %s', pdf_file)
+        return None
+    try:
+       dir_name = tempfile.mkdtemp(dir = temp_dir)
+    except:
+        debug('Unable to convert PDF: Cannot create temp dir in: %s', temp_dir)
+        return None
     debug('Converting PDF: %s to image', pdf_file)
     resolution = 300
-    file_name = os.path.splitext(os.path.basename(pdf_file))[0]
-    command = 'gs -SDEVICE=jpeg -r%(resolution)sx%(resolution)s -sPAPERSIZE=letter ' \
-              '-sOutputFile="%(temp_name)s/%(file_name)s_%%04d.jpg" ' \
-              '-dNOPAUSE -dBATCH -- "%(pdf_file)s"' % \
+    size = 'letter'
+    file_name = os.path.basename(pdf_file)
+    base_name = os.path.splitext(file_name)[0]
+    pdf_path = pdf_file
+    file_name_safe = getSafeGhostscriptInputFilename(file_name)
+    base_name_safe = getSafeGhostscriptOutputBasename(base_name)
+    pdf_file_safe = getSafeGhostscriptPath(pdf_file)
+    if pdf_file != pdf_file_safe:
+        try:
+            pdf_path = os.path.join(dir_name, file_name_safe)
+            os.symlink(pdf_file, pdf_path)
+        except:
+            debug('Unable to convert PDF: Cannot create temp symlink in: %s', dir_name)
+            return None
+    command = 'gs -SDEVICE=jpeg -r%(resolution)sx%(resolution)s -sPAPERSIZE=%(size)s ' \
+              '-sOutputFile=\'%(temp_name)s/%(file_name)s_%%04d.jpg\' ' \
+              '-dNOPAUSE -dBATCH -- \'%(pdf_file)s\'' % \
               {'temp_name': dir_name,
-               'file_name': file_name,
-               'pdf_file': pdf_file,
-               'resolution': resolution}
+               'file_name': base_name_safe,
+               'pdf_file': pdf_path,
+               'resolution': resolution,
+               'size': size}
     os.popen(command).read()
+    if pdf_file != pdf_file_safe:
+        try:
+            os.unlink(pdf_path)
+        except:
+            debug('PDF conversion warning: Cannot remove temp symlink: %s', pdf_path)
     return dir_name

 def getImagesFromFolder(folder):
```

PR is on the way.

Assignee
Loading

Time tracking
Loading



=== Content from gitlab.gnome.org_66da7912_20250114_205321.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

**Commit
5286120c**

authored
Mar 08, 2020
by
**[![scx's avatar](https://secure.gravatar.com/avatar/b05be641f24fdc3f80b5a72b4500517750badd7be5525485434f3fc042b31af5?s=96&d=identicon "scx")](/scx)
[scx](/scx)**
Committed by
[Joaquim Rocha](/jrocha)
Mar 08, 2020

[Browse files](/GNOME/ocrfeeder/-/tree/5286120c8bc8b7ba74e0f9b19b5262b509f38cee)

### Handle special chars in filenames when importing PDF files

```

Some special characters (e.g. quotes) in the filename cause gs to fail.
What's worse, gs interprets the escape character as a real character.
This means that it cannot handle all Unix files on its own.
We need to create a temp symlink as a workaround for gs limitations.

Fixes [#20](/GNOME/ocrfeeder/-/issues/20 "Cannot import PDF if filename contains some special chars")
```

parent
[ee750690](/GNOME/ocrfeeder/-/commit/ee7506905fac7331f00e009ccad0031a298b5c1d)

Loading

Loading

Loading

* [Changes
  1](/GNOME/ocrfeeder/-/commit/5286120c8bc8b7ba74e0f9b19b5262b509f38cee)

[Hide whitespace changes](/GNOME/ocrfeeder/-/commit/5286120c8bc8b7ba74e0f9b19b5262b509f38cee?action=show&controller=projects%2Fcommit&id=5286120c8bc8b7ba74e0f9b19b5262b509f38cee&namespace_id=GNOME&project_id=ocrfeeder&w=1)
[Inline](/GNOME/ocrfeeder/-/commit/5286120c8bc8b7ba74e0f9b19b5262b509f38cee?view=inline)
[Side-by-side](/GNOME/ocrfeeder/-/commit/5286120c8bc8b7ba74e0f9b19b5262b509f38cee?view=parallel)

Loading

* [RenWal](/RenWal)
  @RenWal

  mentioned in merge request [!13 (merged)](/GNOME/ocrfeeder/-/merge_requests/13 "Do not invoke commands through shell.")

  ·

  [Mar 13, 2022](#note_1407586)

  mentioned in merge request [!13 (merged)](/GNOME/ocrfeeder/-/merge_requests/13 "Do not invoke commands through shell.")

  mentioned in merge request !13

  Toggle commit list
* [RenWal](/RenWal)
  @RenWal

  mentioned in commit [9209bce8](/GNOME/ocrfeeder/-/commit/9209bce8afaf6fde19cdac7f5eaea1b744c3e79e "Do not invoke commands through shell. Fixes #82")

  ·

  [Mar 14, 2022](#note_1408649)

  mentioned in commit [9209bce8](/GNOME/ocrfeeder/-/commit/9209bce8afaf6fde19cdac7f5eaea1b744c3e79e "Do not invoke commands through shell. Fixes #82")

  mentioned in commit 9209bce8afaf6fde19cdac7f5eaea1b744c3e79e

  Toggle commit list

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



=== Content from gitlab.gnome.org_dcd979f8_20250114_205324.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

# Do not invoke commands through shell.

Code

* Review changes
* Check out branch
* ---
* Download
* [Patches](/GNOME/ocrfeeder/-/merge_requests/13.patch)
* [Plain diff](/GNOME/ocrfeeder/-/merge_requests/13.diff)

[RenWal](/RenWal) requested to merge  [RenWal/ocrfeeder:fix-command-injection](/RenWal/ocrfeeder/-/tree/fix-command-injection "RenWal/ocrfeeder:fix-command-injection")
 into [master](/GNOME/ocrfeeder/-/tree/master "master") Mar 13, 2022

* [Overview
  1](/GNOME/ocrfeeder/-/merge_requests/13)
* [Commits
  2](/GNOME/ocrfeeder/-/merge_requests/13/commits)
* [Pipelines
  0](/GNOME/ocrfeeder/-/merge_requests/13/pipelines)
* [Changes
  2](/GNOME/ocrfeeder/-/merge_requests/13/diffs)

Expand

Executing shell commands through mechanisms such as os.system() or
subprocess.run(shell=True) with user-controllable input is prone to
arbitrary shell command injection. In this particular case, a malicious
actor controlling any input name, either in PDF or image form, can
force ocrfeeder to execute shell commands embedded in the file name.
While a workaround for [#20 (closed)](/GNOME/ocrfeeder/-/issues/20 "Cannot import PDF if filename contains some special chars"), mentioning problems opening files with
special characters, was introduced in [5286120c](/GNOME/ocrfeeder/-/commit/5286120c8bc8b7ba74e0f9b19b5262b509f38cee "Handle special chars in filenames when importing PDF files"), this was not applied to
every subprocess invocation. Furthermore, it is good practice to make
use of the parameterization of arguments available in the subprocess
package instead of relying on character escaping alone, avoiding shell
invocation completely. This minimizes the attack surface.

Fixes #82

## Merge request reports

Assignee
Loading

Reviewers
Loading

Request review fromRequest review fromLoading

Time tracking
Loading

Loading


