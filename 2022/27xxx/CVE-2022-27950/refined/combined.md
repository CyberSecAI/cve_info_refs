=== Content from github.com_4f0da977_20250115_093712.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F817b8b9c5396d2b2d92311b46719aad5d3339dbe)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F817b8b9c5396d2b2d92311b46719aad5d3339dbe)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/817b8b9c5396d2b2d92311b46719aad5d3339dbe)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

HID: elo: fix memory leak in elo\_probe

[Browse files](/torvalds/linux/tree/817b8b9c5396d2b2d92311b46719aad5d3339dbe)
Browse the repository at this point in the history

```
When hid_parse() in elo_probe() fails, it forgets to call usb_put_dev to
decrease the refcount.

Fix this by adding usb_put_dev() in the error handling code of elo_probe().

Fixes: [fbf4272](https://github.com/torvalds/linux/commit/fbf42729d0e91332e8ce75a1ecce08b8a2dab9c1) ("HID: elo: update the reference count of the usb device structure")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Dongliang Mu <mudongliangabcd@gmail.com>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
```

* Loading branch information

[![@mudongliang](https://avatars.githubusercontent.com/u/6214861?s=40&v=4)](/mudongliang)

[mudongliang](/torvalds/linux/commits?author=mudongliang "View all commits by mudongliang")
authored and
Jiri Kosina
committed
Jan 24, 2022

1 parent
[e26a780](/torvalds/linux/commit/e26a78057c25dd56f112d536319c38735ed92ba4)

commit 817b8b9

Showing
**1 changed file**
with
**1 addition**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[drivers/hid/hid-elo.c](#diff-64e5845d322298e6fc61e8af83c883804a8a7538123f0d22c552035988c9237a "drivers/hid/hid-elo.c")

Show comments

[View file](/torvalds/linux/blob/817b8b9c5396d2b2d92311b46719aad5d3339dbe/drivers/hid/hid-elo.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -262,6 +262,7 @@ static int elo\_probe(struct hid\_device \*hdev, const struct hid\_device\_id \*id) |
|  |  |  |
|  |  | return 0; |
|  |  | err\_free: |
|  |  | usb\_put\_dev(udev); |
|  |  | kfree(priv); |
|  |  | return ret; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `817b8b9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F817b8b9c5396d2b2d92311b46719aad5d3339dbe) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from cdn.kernel.org_116365fe_20250115_093711.html ===
commit f40e0f7a433b029c8cbe2cdfa6b3210e31053e27
Author: Greg Kroah-Hartman
Date: Wed Feb 23 12:06:08 2022 +0100
Linux 5.16.11
Link: https://lore.kernel.org/r/20220221084934.836145070@linuxfoundation.org
Tested-by: Jeffrin Jose T
Tested-by: Ronald Warsow
Tested-by: Shuah Khan
Tested-by: Zan Aziz
Tested-by: Florian Fainelli
Tested-by: Bagas Sanjaya
Tested-by: Rudi Heitbaum
Tested-by: Jon Hunter
Tested-by: Ron Economos
Tested-by: Justin M. Forbes
Tested-by: Slade Watkins
Signed-off-by: Greg Kroah-Hartman
commit 8dda603d71692c2c6e112c39a3b535107306b047
Author: Jing Leng
Date: Fri Feb 11 17:27:36 2022 +0800
kconfig: fix failing to generate auto.conf
[ Upstream commit 1b9e740a81f91ae338b29ed70455719804957b80 ]
When the KCONFIG\_AUTOCONFIG is specified (e.g. export \
KCONFIG\_AUTOCONFIG=output/config/auto.conf), the directory of
include/config/ will not be created, so kconfig can't create deps
files in it and auto.conf can't be generated.
Signed-off-by: Jing Leng
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit 310bef8a2b2dd6c2f14e7c76965bff9ccedc2a9a
Author: Marc St-Amand
Date: Wed Feb 9 15:13:25 2022 +0530
net: macb: Align the dma and coherent dma masks
[ Upstream commit 37f7860602b5b2d99fc7465f6407f403f5941988 ]
Single page and coherent memory blocks can use different DMA masks
when the macb accesses physical memory directly. The kernel is clever
enough to allocate pages that fit into the requested address width.
When using the ARM SMMU, the DMA mask must be the same for single
pages and big coherent memory blocks. Otherwise the translation
tables turn into one big mess.
[ 74.959909] macb ff0e0000.ethernet eth0: DMA bus error: HRESP not OK
[ 74.959989] arm-smmu fd800000.smmu: Unhandled context fault: fsr=0x402, iova=0x3165687460, fsynr=0x20001, cbfrsynra=0x877, cb=1
[ 75.173939] macb ff0e0000.ethernet eth0: DMA bus error: HRESP not OK
[ 75.173955] arm-smmu fd800000.smmu: Unhandled context fault: fsr=0x402, iova=0x3165687460, fsynr=0x20001, cbfrsynra=0x877, cb=1
Since using the same DMA mask does not hurt direct 1:1 physical
memory mappings, this commit always aligns DMA and coherent masks.
Signed-off-by: Marc St-Amand
Signed-off-by: Harini Katakam
Acked-by: Nicolas Ferre
Tested-by: Conor Dooley
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4bb1c991370a205aa34bfa46bebcf5b67c9aaecc
Author: Slark Xiao
Date: Wed Feb 9 10:47:17 2022 +0800
net: usb: qmi\_wwan: Add support for Dell DW5829e
[ Upstream commit 8ecbb179286cbc91810c16caeb3396e06305cd0c ]
Dell DW5829e same as DW5821e except the CAT level.
DW5821e supports CAT16 but DW5829e supports CAT9.
Also, DW5829e includes normal and eSIM type.
Please see below test evidence:
T: Bus=04 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 5 Spd=5000 MxCh= 0
D: Ver= 3.10 Cls=ef(misc ) Sub=02 Prot=01 MxPS= 9 #Cfgs= 1
P: Vendor=413c ProdID=81e6 Rev=03.18
S: Manufacturer=Dell Inc.
S: Product=DW5829e Snapdragon X20 LTE
S: SerialNumber=0123456789ABCDEF
C: #Ifs= 6 Cfg#= 1 Atr=a0 MxPwr=896mA
I: If#=0x0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi\_wwan
I: If#=0x1 Alt= 0 #EPs= 1 Cls=03(HID ) Sub=00 Prot=00 Driver=usbhid
I: If#=0x2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x5 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
T: Bus=04 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 7 Spd=5000 MxCh= 0
D: Ver= 3.10 Cls=ef(misc ) Sub=02 Prot=01 MxPS= 9 #Cfgs= 1
P: Vendor=413c ProdID=81e4 Rev=03.18
S: Manufacturer=Dell Inc.
S: Product=DW5829e-eSIM Snapdragon X20 LTE
S: SerialNumber=0123456789ABCDEF
C: #Ifs= 6 Cfg#= 1 Atr=a0 MxPwr=896mA
I: If#=0x0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi\_wwan
I: If#=0x1 Alt= 0 #EPs= 1 Cls=03(HID ) Sub=00 Prot=00 Driver=usbhid
I: If#=0x2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x5 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
Signed-off-by: Slark Xiao
Acked-by: Bjørn Mork
Link: https://lore.kernel.org/r/20220209024717.8564-1-slark\_xiao@163.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit aea1b3490c21d7675cab28bf45559caa7c5b1a57
Author: Dmytro Laktyushkin
Date: Thu Jan 27 11:55:49 2022 -0500
drm/amd/display: fix yellow carp wm clamping
[ Upstream commit 60fdf98a774eee244a4e00c34a9e7729b61d0f44 ]
Fix clamping to match register field size
Reviewed-by: Charlene Liu
Acked-by: Jasdeep Dhillon
Signed-off-by: Dmytro Laktyushkin
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit ea39981ac36457e6f17eef3a27df70f8955261bb
Author: Roman Li
Date: Wed Feb 2 14:30:09 2022 -0500
drm/amd/display: Cap pflip irqs per max otg number
[ Upstream commit 328e34a5ad227399391891d454043e5d73e598d2 ]
[Why]
pflip interrupt order are mapped 1 to 1 to otg id.
e.g. if irq\_src=26 corresponds to otg0 then 27->otg1, 28->otg2...
Linux DM registers pflip interrupts per number of crtcs.
In fused pipe case crtc numbers can be less than otg id.
e.g. if one pipe out of 3(otg#0-2) is fused adev->mode\_info.num\_crtc=2
so DM only registers irq\_src 26,27.
This is a bug since if pipe#2 remains unfused DM never gets
otg2 pflip interrupt (irq\_src=28)
That may results in gfx failure due to pflip timeout.
[How]
Register pflip interrupts per max num of otg instead of num\_crtc
Signed-off-by: Roman Li
Reviewed-by: Nicholas Kazlauskas
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit e464ce42eda1e571655b559b65f72d686bc6b4c2
Author: Aaron Liu
Date: Sat Jan 29 09:21:31 2022 +0800
drm/amdgpu: add utcl2\_harvest to gc 10.3.1
[ Upstream commit a072312f43c33ea02ad88bff3375f650684a6f24 ]
Confirmed with hardware team, there is harvesting for gc 10.3.1.
Signed-off-by: Aaron Liu
Reviewed-by: Huang Rui
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit a0a01794bfa3079da91dd948f2b905edaa00de7b
Author: Mario Limonciello
Date: Tue Jan 25 15:49:47 2022 -0600
display/amd: decrease message verbosity about watermarks table failure
[ Upstream commit 03ad3093c7c069d6ab4403730009ebafeea9ee37 ]
A number of BIOS versions have a problem with the watermarks table not
being configured properly. This manifests as a very scary looking warning
during resume from s0i3. This should be harmless in most cases and is well
understood, so decrease the assertion to a clearer warning about the problem.
Reviewed-by: Harry Wentland
Signed-off-by: Mario Limonciello
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit d29c76daa948dcb4baa62bc6c8a08929bf33e688
Author: JaeSang Yoo
Date: Wed Feb 9 04:54:22 2022 +0900
tracing: Fix tp\_printk option related with tp\_printk\_stop\_on\_boot
[ Upstream commit 3203ce39ac0b2a57a84382ec184c7d4a0bede175 ]
The kernel parameter "tp\_printk\_stop\_on\_boot" starts with "tp\_printk" which is
the same as another kernel parameter "tp\_printk". If "tp\_printk" setup is
called before the "tp\_printk\_stop\_on\_boot", it will override the latter
and keep it from being set.
This is similar to other kernel parameter issues, such as:
Commit 745a600cf1a6 ("um: console: Ignore console= option")
or init/do\_mounts.c:45 (setup function of "ro" kernel param)
Fix it by checking for a "\_" right after the "tp\_printk" and if that
exists do not process the parameter.
Link: https://lkml.kernel.org/r/20220208195421.969326-1-jsyoo5b@gmail.com
Signed-off-by: JaeSang Yoo
[ Fixed up change log and added space after if condition ]
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Sasha Levin
commit 5569efe954d647f6bb1ded4d024a3259778d37fd
Author: Sascha Hauer
Date: Wed Jan 26 15:55:24 2022 +0100
drm/rockchip: dw\_hdmi: Do not leave clock enabled in error case
[ Upstream commit c0cfbb122275da1b726481de5a8cffeb24e6322b ]
The driver returns an error when devm\_phy\_optional\_get() fails leaving
the previously enabled clock turned on. Change order and enable the
clock only after the phy has been acquired.
Signed-off-by: Sascha Hauer
Signed-off-by: Heiko Stuebner
Link: https://patchwork.freedesktop.org/patch/msgid/20220126145549.617165-3-s.hauer@pengutronix.de
Signed-off-by: Sasha Levin
commit 2526d4d8b209dc5ac1fbeb468149774888b2a141
Author: Dan Aloni
Date: Tue Jan 25 22:06:46 2022 +0200
xprtrdma: fix pointer derefs in error cases of rpcrdma\_ep\_create
[ Upstream commit a9c10b5b3b67b3750a10c8b089b2e05f5e176e33 ]
If there are failures then we must not leave the non-NULL pointers with
the error value, otherwise `rpcrdma\_ep\_destroy` gets confused and tries
free them, resulting in an Oops.
Signed-off-by: Dan Aloni
Acked-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 1190ec3de8d09b279ef4af34a1bab6e63add5d73
Author: Jae Hyun Yoo
Date: Tue Feb 1 17:31:18 2022 +1030
soc: aspeed: lpc-ctrl: Block error printing on probe defer cases
[ Upstream commit 301a5d3ad2432d7829f59432ca0a93a6defbb9a1 ]
Add a checking code when it gets -EPROBE\_DEFER while getting a clock
resource. In this case, it doesn't need to print out an error message
because the probing will be re-visited.
Signed-off-by: Jae Hyun Yoo
Signed-off-by: Joel Stanley
Reviewed-by: Andrew Jeffery
Reviewed-by: Iwona Winiarska
Link: https://lore.kernel.org/r/20211104173709.222912-1-jae.hyun.yoo@intel.com
Link: https://lore.kernel.org/r/20220201070118.196372-1-joel@jms.id.au'
Signed-off-by: Arnd Bergmann
Signed-off-by: Sasha Levin
commit 0291f56bde5970d1878a8c0298356b4eec7d8fe1
Author: Zoltán Böszörményi
Date: Fri Feb 4 13:57:50 2022 +0100
ata: libata-core: Disable TRIM on M88V29
[ Upstream commit c8ea23d5fa59f28302d4e3370c75d9c308e64410 ]
This device is a CF card, or possibly an SSD in CF form factor.
It supports NCQ and high speed DMA.
While it also advertises TRIM support, I/O errors are reported
when the discard mount option fstrim is used. TRIM also fails
when disabling NCQ and not just as an NCQ command.
TRIM must be disabled for this device.
Signed-off-by: Zoltán Böszörményi
Signed-off-by: Damien Le Moal
Signed-off-by: Sasha Levin
commit 037a7acbe871c43949fc0e138b8feb2bbc1c07e1
Author: Brenda Streiff
Date: Fri Jan 28 16:01:28 2022 -0600
kconfig: let 'shell' return enough output for deep path names
[ Upstream commit 8a4c5b2a6d8ea079fa36034e8167de87ab6f8880 ]
The 'shell' built-in only returns the first 256 bytes of the command's
output. In some cases, 'shell' is used to return a path; by bumping up
the buffer size to 4096 this lets us capture up to PATH\_MAX.
The specific case where I ran into this was due to commit 1e860048c53e
("gcc-plugins: simplify GCC plugin-dev capability test"). After this
change, we now use `$(shell,$(CC) -print-file-name=plugin)` to return
a path; if the gcc path is particularly long, then the path ends up
truncated at the 256 byte mark, which makes the HAVE\_GCC\_PLUGINS
depends test always fail.
Signed-off-by: Brenda Streiff
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit 0c430ff95116c4a635e651d9be9e4e8e1163bc5d
Author: Mario Limonciello
Date: Fri Jan 28 14:35:03 2022 -0600
ACPI: PM: Revert "Only mark EC GPE for wakeup on Intel systems"
[ Upstream commit d6ebb17ccc7b37872a32bc25b4a21f1e5af8c7e3 ]
Testing on various upcoming OEM systems shows commit 7b167c4cb48e ("ACPI:
PM: Only mark EC GPE for wakeup on Intel systems") was short
sighted and the symptoms were indicative of other problems. Some OEMs
do have the dedicated GPIOs for the power button but also rely upon
an interrupt to the EC SCI to let the lid work.
The original commit showed spurious activity on Lenovo systems:
\* On both Lenovo T14 and P14s the keyboard wakeup doesn't work, and
sometimes the power button event doesn't work.
This was confirmed on my end at that time.
However further development in the kernel showed that the issue was
actually the IRQ for the GPIO controller was also shared with the EC SCI.
This was actually fixed by commit 2d54067fcd23 ("pinctrl: amd: Fix
wakeups when IRQ is shared with SCI").
The original commit also showed problems with AC adapter:
\* On HP 635 G7 detaching or attaching AC during suspend will cause
the system not to wakeup
\* On Asus vivobook to prevent detaching AC causing resume problems
\* On Lenovo 14ARE05 to prevent detaching AC causing resume problems
\* On HP ENVY x360 to prevent detaching AC causing resume problems
Detaching AC adapter causing problems appears to have been a problem
because the EC SCI went off to notify the OS of the power adapter change
but the SCI was ignored and there was no other way to wake up this system
since GPIO controller wasn't properly enabled. The wakeups were fixed by
enabling the GPIO controller in commit acd47b9f28e5 ("pinctrl: amd: Handle
wake-up interrupt").
I've confirmed on a variety of OEM notebooks with the following test
1) echo 1 | sudo tee /sys/power/pm\_debug\_messages
2) sudo systemctl suspend
3) unplug AC adapter, make sure system is still asleep
4) wake system from lid (which is provided by ACPI SCI on some of them)
5) dmesg
a) see the EC GPE dispatched, timekeeping for X seconds (matching ~time
until AC adapter plug out)
b) see timekeeping for Y seconds until woke (matching ~time from AC
adapter until lid event)
6) Look at /sys/kernel/debug/amd\_pmc/s0ix\_stats
"Time (in us) in S0i3" = X + Y - firmware processing time
Signed-off-by: Mario Limonciello
Tested-by: Kai-Heng Feng
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit 91821a6eba7f089ab897e8251d9f152dcb1e50c3
Author: Shakeel Butt
Date: Mon Jan 24 21:17:36 2022 -0800
mm: io\_uring: allow oom-killer from io\_uring\_setup
[ Upstream commit 0a3f1e0beacf6cc8ae5f846b0641c1df476e83d6 ]
On an overcommitted system which is running multiple workloads of
varying priorities, it is preferred to trigger an oom-killer to kill a
low priority workload than to let the high priority workload receiving
ENOMEMs. On our memory overcommitted systems, we are seeing a lot of
ENOMEMs instead of oom-kills because io\_uring\_setup callchain is using
\_\_GFP\_NORETRY gfp flag which avoids the oom-killer. Let's remove it and
allow the oom-killer to kill a lower priority job.
Signed-off-by: Shakeel Butt
Link: https://lore.kernel.org/r/20220125051736.2981459-1-shakeelb@google.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 6b611b501581fe3a957e8131ef8b4656a420aacb
Author: Axel Rasmussen
Date: Thu Jan 27 14:11:15 2022 -0800
selftests: fixup build warnings in pidfd / clone3 tests
[ Upstream commit e2aa5e650b07693477dff554053605976789fd68 ]
These are some trivial fixups, which were needed to build the tests with
clang and -Werror. The following issues are fixed:
- Remove various unused variables.
- In child\_poll\_leader\_exit\_test, clang isn't smart enough to realize
syscall(SYS\_exit, 0) won't return, so it complains we never return
from a non-void function. Add an extra exit(0) to appease it.
- In test\_pidfd\_poll\_leader\_exit, ret may be branched on despite being
uninitialized, if we have !use\_waitpid. Initialize it to zero to get
the right behavior in that case.
Signed-off-by: Axel Rasmussen
Acked-by: Christian Brauner
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 3cfc79b41381780ef745d696520260238c1cf9fc
Author: Axel Rasmussen
Date: Thu Jan 27 13:29:51 2022 -0800
pidfd: fix test failure due to stack overflow on some arches
[ Upstream commit 4cbd93c3c110447adc66cb67c08af21f939ae2d7 ]
When running the pidfd\_fdinfo\_test on arm64, it fails for me. After some
digging, the reason is that the child exits due to SIGBUS, because it
overflows the 1024 byte stack we've reserved for it.
To fix the issue, increase the stack size to 8192 bytes (this number is
somewhat arbitrary, and was arrived at through experimentation -- I kept
doubling until the failure no longer occurred).
Also, let's make the issue easier to debug. wait\_for\_pid() returns an
ambiguous value: it may return -1 in all of these cases:
1. waitpid() itself returned -1
2. waitpid() returned success, but we found !WIFEXITED(status).
3. The child process exited, but it did so with a -1 exit code.
There's no way for the caller to tell the difference. So, at least log
which occurred, so the test runner can debug things.
While debugging this, I found that we had !WIFEXITED(), because the
child exited due to a signal. This seems like a reasonably common case,
so also print out whether or not we have WIFSIGNALED(), and the
associated WTERMSIG() (if any). This lets us see the SIGBUS I'm fixing
clearly when it occurs.
Finally, I'm suspicious of allocating the child's stack on our stack.
man clone(2) suggests that the correct way to do this is with mmap(),
and in particular by setting MAP\_STACK. So, switch to doing it that way
instead.
Signed-off-by: Axel Rasmussen
Acked-by: Christian Brauner
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 698c40c66f58d2451d0ea9e09ef5f4bb905cbe25
Author: Christian Hewitt
Date: Wed Jan 26 04:49:54 2022 +0000
arm64: dts: meson-g12: drop BL32 region from SEI510/SEI610
[ Upstream commit f26573e2bc9dfd551a0d5c6971f18cc546543312 ]
The BL32/TEE reserved-memory region is now inherited from the common
family dtsi (meson-g12-common) so we can drop it from board files.
Signed-off-by: Christian Hewitt
Reviewed-by: Neil Armstrong
Reviewed-by: Kevin Hilman
Signed-off-by: Neil Armstrong
Link: https://lore.kernel.org/r/20220126044954.19069-4-christianshewitt@gmail.com
Signed-off-by: Sasha Levin
commit 53c83d711dd79edc5403ae36bcb2b33815c9fb33
Author: Christian Hewitt
Date: Wed Jan 26 04:49:53 2022 +0000
arm64: dts: meson-g12: add ATF BL32 reserved-memory region
[ Upstream commit 08982a1b3aa2611c9c711d24825c9002d28536f4 ]
Add an additional reserved memory region for the BL32 trusted firmware
present in many devices that boot from Amlogic vendor u-boot.
Signed-off-by: Christian Hewitt
Reviewed-by: Neil Armstrong
Reviewed-by: Kevin Hilman
Signed-off-by: Neil Armstrong
Link: https://lore.kernel.org/r/20220126044954.19069-3-christianshewitt@gmail.com
Signed-off-by: Sasha Levin
commit af1365e8b41f5475f5905ffe8dfdbd2407fb1116
Author: Christian Hewitt
Date: Wed Jan 26 04:49:52 2022 +0000
arm64: dts: meson-gx: add ATF BL32 reserved-memory region
[ Upstream commit 76577c9137456febb05b0e17d244113196a98968 ]
Add an additional reserved memory region for the BL32 trusted firmware
present in many devices that boot from Amlogic vendor u-boot.
Suggested-by: Mateusz Krzak
Signed-off-by: Christian Hewitt
Reviewed-by: Neil Armstrong
Reviewed-by: Kevin Hilman
Signed-off-by: Neil Armstrong
Link: https://lore.kernel.org/r/20220126044954.19069-2-christianshewitt@gmail.com
Signed-off-by: Sasha Levin
commit eddef98207d678f21261c2bd07da55938680df4e
Author: Max Kellermann
Date: Mon Feb 21 11:03:13 2022 +0100
lib/iov\_iter: initialize "flags" in new pipe\_buffer
commit 9d2231c5d74e13b2a0546fee6737ee4446017903 upstream.
The functions copy\_page\_to\_iter\_pipe() and push\_pipe() can both
allocate a new pipe\_buffer, but the "flags" member initializer is
missing.
Fixes: 241699cd72a8 ("new iov\_iter flavour: pipe-backed")
To: Alexander Viro
To: linux-fsdevel@vger.kernel.org
To: linux-kernel@vger.kernel.org
Cc: stable@vger.kernel.org
Signed-off-by: Max Kellermann
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 6fb73a685c92f33be650677c671e4b75e8b6fa6b
Author: Namjae Jeon
Date: Sun Jan 30 18:31:01 2022 +0900
ksmbd: don't align last entry offset in smb2 query directory
[ Upstream commit 04e260948a160d3b7d622bf4c8a96fa4577c09bd ]
When checking smb2 query directory packets from other servers,
OutputBufferLength is different with ksmbd. Other servers add an unaligned
next offset to OutputBufferLength for the last entry.
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit 28b5031a071fb7421cc7fcefdc9ef2418b8c2dd1
Author: Namjae Jeon
Date: Sun Jan 30 18:28:56 2022 +0900
ksmbd: fix same UniqueId for dot and dotdot entries
[ Upstream commit 97550c7478a2da93e348d8c3075d92cddd473a78 ]
ksmbd sets the inode number to UniqueId. However, the same UniqueId for
dot and dotdot entry is set to the inode number of the parent inode.
This patch set them using the current inode and parent inode.
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit 5d71ab7b01d3d0bcdd1241e8e497c1b3aa053844
Author: Florian Westphal
Date: Fri Jan 28 13:13:32 2022 +0100
netfilter: conntrack: don't refresh sctp entries in closed state
[ Upstream commit 77b337196a9d87f3d6bb9b07c0436ecafbffda1e ]
Vivek Thrivikraman reported:
An SCTP server application which is accessed continuously by client
application.
When the session disconnects the client retries to establish a connection.
After restart of SCTP server application the session is not established
because of stale conntrack entry with connection state CLOSED as below.
(removing this entry manually established new connection):
sctp 9 CLOSED src=10.141.189.233 [..] [ASSURED]
Just skip timeout update of closed entries, we don't want them to
stay around forever.
Reported-and-tested-by: Vivek Thrivikraman
Closes: https://bugzilla.netfilter.org/show\_bug.cgi?id=1579
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit fe0c95903a68300cb2385aee4dd8934a302ce9e9
Author: Nick Desaulniers
Date: Wed Feb 2 12:55:53 2022 -0800
x86/bug: Merge annotate\_reachable() into \_BUG\_FLAGS() asm
[ Upstream commit bfb1a7c91fb7758273b4a8d735313d9cc388b502 ]
In \_\_WARN\_FLAGS(), we had two asm statements (abbreviated):
asm volatile("ud2");
asm volatile(".pushsection .discard.reachable");
These pair of statements are used to trigger an exception, but then help
objtool understand that for warnings, control flow will be restored
immediately afterwards.
The problem is that volatile is not a compiler barrier. GCC explicitly
documents this:
> Note that the compiler can move even volatile asm instructions
> relative to other code, including across jump instructions.
Also, no clobbers are specified to prevent instructions from subsequent
statements from being scheduled by compiler before the second asm
statement. This can lead to instructions from subsequent statements
being emitted by the compiler before the second asm statement.
Providing a scheduling model such as via -march= options enables the
compiler to better schedule instructions with known latencies to hide
latencies from data hazards compared to inline asm statements in which
latencies are not estimated.
If an instruction gets scheduled by the compiler between the two asm
statements, then objtool will think that it is not reachable, producing
a warning.
To prevent instructions from being scheduled in between the two asm
statements, merge them.
Also remove an unnecessary unreachable() asm annotation from BUG() in
favor of \_\_builtin\_unreachable(). objtool is able to track that the ud2
from BUG() terminates control flow within the function.
Link: https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Volatile
Link: https://github.com/ClangBuiltLinux/linux/issues/1483
Signed-off-by: Nick Desaulniers
Signed-off-by: Josh Poimboeuf
Link: https://lore.kernel.org/r/20220202205557.2260694-1-ndesaulniers@google.com
Signed-off-by: Sasha Levin
commit 0fd667004c8132cc0b3cbff31d33cfea7dc75697
Author: Guo Ren
Date: Sun Jan 30 21:56:34 2022 +0800
irqchip/sifive-plic: Add missing thead,c900-plic match string
[ Upstream commit 1d4df649cbb4b26d19bea38ecff4b65b10a1bbca ]
The thead,c900-plic has been used in opensbi to distinguish
PLIC [1]. Although PLICs have the same behaviors in Linux,
they are different hardware with some custom initializing in
firmware(opensbi).
Qute opensbi patch commit-msg by Samuel:
The T-HEAD PLIC implementation requires setting a delegation bit
to allow access from S-mode. Now that the T-HEAD PLIC has its own
compatible string, set this bit automatically from the PLIC driver,
instead of reaching into the PLIC's MMIO space from another driver.
[1]: https://github.com/riscv-software-src/opensbi/commit/78c2b19218bd62653b9fb31623a42ced45f38ea6
Signed-off-by: Guo Ren
Cc: Anup Patel
Cc: Marc Zyngier
Cc: Palmer Dabbelt
Cc: Samuel Holland
Cc: Thomas Gleixner
Tested-by: Samuel Holland
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20220130135634.1213301-3-guoren@kernel.org
Signed-off-by: Sasha Levin
commit d4aeecd071dc278d479ecde82e1d35c9f3bad51c
Author: Wan Jiabing
Date: Fri Jan 7 10:50:50 2022 +0800
phy: phy-mtk-tphy: Fix duplicated argument in phy-mtk-tphy
[ Upstream commit 46e994717807f4b935c44d81dde9dd8bcd9a4f5d ]
Fix following coccicheck warning:
./drivers/phy/mediatek/phy-mtk-tphy.c:994:6-29: duplicated argument
to && or ||
The efuse\_rx\_imp is duplicate. Here should be efuse\_tx\_imp.
Signed-off-by: Wan Jiabing
Acked-by: Chunfeng Yun
Link: https://lore.kernel.org/r/20220107025050.787720-1-wanjiabing@vivo.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 3f09310ec5b33540bd1d6d4663d112a8eb1ed8f4
Author: Padmanabha Srinivasaiah
Date: Fri Dec 31 20:54:03 2021 +0100
staging: vc04\_services: Fix RCU dereference check
[ Upstream commit 0cea730cac824edf78ffd3302938ed5fe2b9d50d ]
In service\_callback path RCU dereferenced pointer struct vchiq\_service
need to be accessed inside rcu read-critical section.
Also userdata/user\_service part of vchiq\_service is accessed around
different synchronization mechanism, getting an extra reference to a
pointer keeps sematics simpler and avoids prolonged graceperiod.
Accessing vchiq\_service with rcu\_read\_[lock/unlock] fixes below issue.
[ 32.201659] =============================
[ 32.201664] WARNING: suspicious RCU usage
[ 32.201670] 5.15.11-rt24-v8+ #3 Not tainted
[ 32.201680] -----------------------------
[ 32.201685] drivers/staging/vc04\_services/interface/vchiq\_arm/vchiq\_core.h:529 suspicious rcu\_dereference\_check() usage!
[ 32.201695]
[ 32.201695] other info that might help us debug this:
[ 32.201695]
[ 32.201700]
[ 32.201700] rcu\_scheduler\_active = 2, debug\_locks = 1
[ 32.201708] no locks held by vchiq-slot/0/98.
[ 32.201715]
[ 32.201715] stack backtrace:
[ 32.201723] CPU: 1 PID: 98 Comm: vchiq-slot/0 Not tainted 5.15.11-rt24-v8+ #3
[ 32.201733] Hardware name: Raspberry Pi 4 Model B Rev 1.4 (DT)
[ 32.201739] Call trace:
[ 32.201742] dump\_backtrace+0x0/0x1b8
[ 32.201772] show\_stack+0x20/0x30
[ 32.201784] dump\_stack\_lvl+0x8c/0xb8
[ 32.201799] dump\_stack+0x18/0x34
[ 32.201808] lockdep\_rcu\_suspicious+0xe4/0xf8
[ 32.201817] service\_callback+0x124/0x400
[ 32.201830] slot\_handler\_func+0xf60/0x1e20
[ 32.201839] kthread+0x19c/0x1a8
[ 32.201849] ret\_from\_fork+0x10/0x20
Tested-by: Stefan Wahren
Signed-off-by: Padmanabha Srinivasaiah
Link: https://lore.kernel.org/r/20211231195406.5479-1-treasure4paddy@gmail.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 35cd1e78f8ac045cf557cbd017c8397f082e309d
Author: Al Cooper
Date: Wed Dec 1 13:06:51 2021 -0500
phy: usb: Leave some clocks running during suspend
[ Upstream commit 42fed57046fc74586d7058bd51a1c10ac9c690cb ]
The PHY client driver does a phy\_exit() call on suspend or rmmod and
the PHY driver needs to know the difference because some clocks need
to be kept running for suspend but can be shutdown on unbind/rmmod
(or if there are no PHY clients at all).
The fix is to use a PM notifier so the driver can tell if a PHY
client is calling exit() because of a system suspend or a driver
unbind/rmmod.
Signed-off-by: Al Cooper
Acked-by: Florian Fainelli
Link: https://lore.kernel.org/r/20211201180653.35097-2-alcooperx@gmail.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 4210b4adf0dc22db3c319e447ec5dcc5cace1adf
Author: Ye Guojin
Date: Tue Nov 16 06:27:26 2021 +0000
ARM: OMAP2+: adjust the location of put\_device() call in omapdss\_init\_of
[ Upstream commit 34596ba380b03d181e24efd50e2f21045bde3696 ]
This was found by coccicheck:
./arch/arm/mach-omap2/display.c, 272, 1-7, ERROR missing put\_device;
call of\_find\_device\_by\_node on line 258, but without a corresponding
object release within this function.
Move the put\_device() call before the if judgment.
Reported-by: Zeal Robot
Signed-off-by: Ye Guojin
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit 3f6278b438492a4d61e1fe357060ca9135add75d
Author: Wan Jiabing
Date: Thu Oct 14 04:57:19 2021 -0400
ARM: OMAP2+: hwmod: Add of\_node\_put() before break
[ Upstream commit 80c469a0a03763f814715f3d12b6f3964c7423e8 ]
Fix following coccicheck warning:
./arch/arm/mach-omap2/omap\_hwmod.c:753:1-23: WARNING: Function
for\_each\_matching\_node should have of\_node\_put() before break
Early exits from for\_each\_matching\_node should decrement the
node reference counter.
Signed-off-by: Wan Jiabing
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit 05db67f3f47bf8a0bc1b254e58dc974ba8c61e57
Author: Jim Mattson
Date: Wed Feb 2 17:48:13 2022 -0800
KVM: x86/pmu: Use AMD64\_RAW\_EVENT\_MASK for PERF\_TYPE\_RAW
[ Upstream commit 710c476514313c74045c41c0571bb5178fd16e3d ]
AMD's event select is 3 nybbles, with the high nybble in bits 35:32 of
a PerfEvtSeln MSR. Don't mask off the high nybble when configuring a
RAW perf event.
Fixes: ca724305a2b0 ("KVM: x86/vPMU: Implement AMD vPMU code for KVM")
Signed-off-by: Jim Mattson
Message-Id: <20220203014813.2130559-2-jmattson@google.com>
Reviewed-by: David Dunn
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 6ea9f898abac8ff503a82497830d9a533961b041
Author: Jim Mattson
Date: Wed Feb 2 17:48:12 2022 -0800
KVM: x86/pmu: Don't truncate the PerfEvtSeln MSR when creating a perf event
[ Upstream commit b8bfee85f1307426e0242d654f3a14c06ef639c5 ]
AMD's event select is 3 nybbles, with the high nybble in bits 35:32 of
a PerfEvtSeln MSR. Don't drop the high nybble when setting up the
config field of a perf\_event\_attr structure for a call to
perf\_event\_create\_kernel\_counter().
Fixes: ca724305a2b0 ("KVM: x86/vPMU: Implement AMD vPMU code for KVM")
Reported-by: Stephane Eranian
Signed-off-by: Jim Mattson
Message-Id: <20220203014813.2130559-1-jmattson@google.com>
Reviewed-by: David Dunn
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 48504d0e0b1042258b1f7eb57083ff16498fd019
Author: Like Xu
Date: Tue Nov 30 15:42:17 2021 +0800
KVM: x86/pmu: Refactoring find\_arch\_event() to pmc\_perf\_hw\_id()
[ Upstream commit 7c174f305cbee6bdba5018aae02b84369e7ab995 ]
The find\_arch\_event() returns a "unsigned int" value,
which is used by the pmc\_reprogram\_counter() to
program a PERF\_TYPE\_HARDWARE type perf\_event.
The returned value is actually the kernel defined generic
perf\_hw\_id, let's rename it to pmc\_perf\_hw\_id() with simpler
incoming parameters for better self-explanation.
Signed-off-by: Like Xu
Message-Id: <20211130074221.93635-3-likexu@tencent.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 92e25b637cd4e010f776c86e4810300e773eac5c
Author: Miaoqian Lin
Date: Fri Feb 4 01:30:08 2022 +0800
Drivers: hv: vmbus: Fix memory leak in vmbus\_add\_channel\_kobj
[ Upstream commit 8bc69f86328e87a0ffa79438430cc82f3aa6a194 ]
kobject\_init\_and\_add() takes reference even when it fails.
According to the doc of kobject\_init\_and\_add()：
If this function returns an error, kobject\_put() must be called to
properly clean up the memory associated with the object.
Fix memory leak by calling kobject\_put().
Fixes: c2e5df616e1a ("vmbus: add per-channel sysfs info")
Signed-off-by: Miaoqian Lin
Reviewed-by: Juan Vazquez
Link: https://lore.kernel.org/r/20220203173008.43480-1-linmq006@gmail.com
Signed-off-by: Wei Liu
Signed-off-by: Sasha Levin
commit 50a37fd45bbdba319768062394598496198d3462
Author: Miaoqian Lin
Date: Thu Dec 30 07:27:51 2021 +0000
mtd: rawnand: ingenic: Fix missing put\_device in ingenic\_ecc\_get
[ Upstream commit ba1b71b008e97fd747845ff3a818420b11bbe830 ]
If of\_find\_device\_by\_node() succeeds, ingenic\_ecc\_get() doesn't have
a corresponding put\_device(). Thus add put\_device() to fix the exception
handling.
Fixes: 15de8c6efd0e ("mtd: rawnand: ingenic: Separate top-level and SoC specific code")
Signed-off-by: Miaoqian Lin
Reviewed-by: Paul Cercueil
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20211230072751.21622-1-linmq006@gmail.com
Signed-off-by: Sasha Levin
commit 80dad7483e3940dc9d9d55f8b34d1f4ba85a505e
Author: Dongliang Mu
Date: Sat Jan 22 17:48:26 2022 +0800
HID: elo: fix memory leak in elo\_probe
[ Upstream commit 817b8b9c5396d2b2d92311b46719aad5d3339dbe ]
When hid\_parse() in elo\_probe() fails, it forgets to call usb\_put\_dev to
decrease the refcount.
Fix this by adding usb\_put\_dev() in the error handling code of elo\_probe().
Fixes: fbf42729d0e9 ("HID: elo: update the reference count of the usb device structure")
Reported-by: syzkaller
Signed-off-by: Dongliang Mu
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit c20f90fe009ffdccba826d2ee839e5d55118a2bf
Author: Cheng Jui Wang
Date: Thu Feb 10 18:50:11 2022 +0800
lockdep: Correct lock\_classes index mapping
commit 28df029d53a2fd80c1b8674d47895648ad26dcfb upstream.
A kernel exception was hit when trying to dump /proc/lockdep\_chains after
lockdep report "BUG: MAX\_LOCKDEP\_CHAIN\_HLOCKS too low!":
Unable to handle kernel paging request at virtual address 00054005450e05c3
...
00054005450e05c3] address between user and kernel address ranges
...
pc : [0xffffffece769b3a8] string+0x50/0x10c
lr : [0xffffffece769ac88] vsnprintf+0x468/0x69c
...
Call trace:
string+0x50/0x10c
vsnprintf+0x468/0x69c
seq\_printf+0x8c/0xd8
print\_name+0x64/0xf4
lc\_show+0xb8/0x128
seq\_read\_iter+0x3cc/0x5fc
proc\_reg\_read\_iter+0xdc/0x1d4
The cause of the problem is the function lock\_chain\_get\_class() will
shift lock\_classes index by 1, but the index don't need to be shifted
anymore since commit 01bb6f0af992 ("locking/lockdep: Change the range
of class\_idx in held\_lock struct") already change the index to start
from 0.
The lock\_classes[-1] located at chain\_hlocks array. When printing
lock\_classes[-1] after the chain\_hlocks entries are modified, the
exception happened.
The output of lockdep\_chains are incorrect due to this problem too.
Fixes: f611e8cf98ec ("lockdep: Take read/write status in consideration when generate chainkey")
Signed-off-by: Cheng Jui Wang
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Boqun Feng
Link: https://lore.kernel.org/r/20220210105011.21712-1-cheng-jui.wang@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit 30303c7370f28113b6720b5bab9d8ec6f394d8dc
Author: Rafał Miłecki
Date: Tue Feb 15 08:27:35 2022 +0100
i2c: brcmstb: fix support for DSL and CM variants
commit 834cea3a252ed4847db076a769ad9efe06afe2d5 upstream.
DSL and CM (Cable Modem) support 8 B max transfer size and have a custom
DT binding for that reason. This driver was checking for a wrong
"compatible" however which resulted in an incorrect setup.
Fixes: e2e5a2c61837 ("i2c: brcmstb: Adding support for CM and DSL SoCs")
Signed-off-by: Rafał Miłecki
Acked-by: Florian Fainelli
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit 63517576d6d6aea30413a49823833b4ba5566da9
Author: Jesse Brandeburg
Date: Fri Feb 11 09:14:18 2022 -0800
ice: enable parsing IPSEC SPI headers for RSS
commit 86006f996346e8a5a1ea80637ec949ceeea4ecbc upstream.
The COMMS package can enable the hardware parser to recognize IPSEC
frames with ESP header and SPI identifier. If this package is available
and configured for loading in /lib/firmware, then the driver will
succeed in enabling this protocol type for RSS.
This in turn allows the hardware to hash over the SPI and use it to pick
a consistent receive queue for the same secure flow. Without this all
traffic is steered to the same queue for multiple traffic threads from
the same IP address. For that reason this is marked as a fix, as the
driver supports the model, but it wasn't enabled.
If the package is not available, adding this type will fail, but the
failure is ignored on purpose as it has no negative affect.
Fixes: c90ed40cefe1 ("ice: Enable writing hardware filtering tables")
Signed-off-by: Jesse Brandeburg
Tested-by: Gurucharan G  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d24f874d6e56fc33a612f3c1f19670fd81f6805a
Author: Charles Keepax
Date: Thu Feb 10 17:20:51 2022 +0000
ASoC: wm\_adsp: Correct control read size when parsing compressed buffer
commit a887f9c7a4d37a8e874ba8415a42a92a1b5139fc upstream.
When parsing the compressed stream the whole buffer descriptor is
now read in a single cs\_dsp\_coeff\_read\_ctrl; on older firmwares
this descriptor is just 4 bytes but on more modern firmwares it is
24 bytes. The current code reads the full 24 bytes regardless, this
was working but reading junk for the last 20 bytes. However commit
f444da38ac92 ("firmware: cs\_dsp: Add offset to cs\_dsp read/write")
added a size check into cs\_dsp\_coeff\_read\_ctrl, causing the older
firmwares to now return an error.
Update the code to only read the amount of data appropriate for
the firmware loaded.
Fixes: 04ae08596737 ("ASoC: wm\_adsp: Switch to using wm\_coeff\_read\_ctrl for compressed buffers")
Signed-off-by: Charles Keepax
Link: https://lore.kernel.org/r/20220210172053.22782-1-ckeepax@opensource.cirrus.com
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit bfe2e9ad9e3bd48ec110eeabc4aa96f9647c17ed
Author: Mike Christie
Date: Tue Feb 8 12:54:48 2022 -0600
scsi: qedi: Fix ABBA deadlock in qedi\_process\_tmf\_resp() and qedi\_process\_cmd\_cleanup\_resp()
commit f10f582d28220f50099d3f561116256267821429 upstream.
This fixes a deadlock added with commit b40f3894e39e ("scsi: qedi: Complete
TMF works before disconnect")
Bug description from Jia-Ju Bai:
qedi\_process\_tmf\_resp()
spin\_lock(&session->back\_lock); --> Line 201 (Lock A)
spin\_lock(&qedi\_conn->tmf\_work\_lock); --> Line 230 (Lock B)
qedi\_process\_cmd\_cleanup\_resp()
spin\_lock\_bh(&qedi\_conn->tmf\_work\_lock); --> Line 752 (Lock B)
spin\_lock\_bh(&conn->session->back\_lock); --> Line 784 (Lock A)
When qedi\_process\_tmf\_resp() and qedi\_process\_cmd\_cleanup\_resp() are
concurrently executed, the deadlock can occur.
This patch fixes the deadlock by not holding the tmf\_work\_lock in
qedi\_process\_cmd\_cleanup\_resp while holding the back\_lock. The
tmf\_work\_lock is only needed while we remove the tmf\_work from the
work\_list.
Link: https://lore.kernel.org/r/20220208185448.6206-1-michael.christie@oracle.com
Fixes: b40f3894e39e ("scsi: qedi: Complete TMF works before disconnect")
Cc: Manish Rangankar
Cc: Nilesh Javali
Reported-by: TOTE Robot
Reported-by: Jia-Ju Bai
Signed-off-by: Mike Christie
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit bc8167d53b7cbed96d5c2274bd7b92c4c9af1105
Author: Waiman Long
Date: Tue Feb 8 11:39:12 2022 -0500
copy\_process(): Move fd\_install() out of sighand->siglock critical section
commit ddc204b517e60ae64db34f9832dc41dafa77c751 upstream.
I was made aware of the following lockdep splat:
[ 2516.308763] =====================================================
[ 2516.309085] WARNING: HARDIRQ-safe -> HARDIRQ-unsafe lock order detected
[ 2516.309433] 5.14.0-51.el9.aarch64+debug #1 Not tainted
[ 2516.309703] -----------------------------------------------------
[ 2516.310149] stress-ng/153663 [HC0[0]:SC0[0]:HE0:SE1] is trying to acquire:
[ 2516.310512] ffff0000e422b198 (&newf->file\_lock){+.+.}-{2:2}, at: fd\_install+0x368/0x4f0
[ 2516.310944]
and this task is already holding:
[ 2516.311248] ffff0000c08140d8 (&sighand->siglock){-.-.}-{2:2}, at: copy\_process+0x1e2c/0x3e80
[ 2516.311804] which would create a new lock dependency:
[ 2516.312066] (&sighand->siglock){-.-.}-{2:2} -> (&newf->file\_lock){+.+.}-{2:2}
[ 2516.312446]
but this new dependency connects a HARDIRQ-irq-safe lock:
[ 2516.312983] (&sighand->siglock){-.-.}-{2:2}
:
[ 2516.330700] Possible interrupt unsafe locking scenario:
[ 2516.331075] CPU0 CPU1
[ 2516.331328] ---- ----
[ 2516.331580] lock(&newf->file\_lock);
[ 2516.331790] local\_irq\_disable();
[ 2516.332231] lock(&sighand->siglock);
[ 2516.332579] lock(&newf->file\_lock);
[ 2516.332922]
[ 2516.333069] lock(&sighand->siglock);
[ 2516.333291]
\*\*\* DEADLOCK \*\*\*
[ 2516.389845]
stack backtrace:
[ 2516.390101] CPU: 3 PID: 153663 Comm: stress-ng Kdump: loaded Not tainted 5.14.0-51.el9.aarch64+debug #1
[ 2516.390756] Hardware name: QEMU KVM Virtual Machine, BIOS 0.0.0 02/06/2015
[ 2516.391155] Call trace:
[ 2516.391302] dump\_backtrace+0x0/0x3e0
[ 2516.391518] show\_stack+0x24/0x30
[ 2516.391717] dump\_stack\_lvl+0x9c/0xd8
[ 2516.391938] dump\_stack+0x1c/0x38
[ 2516.392247] print\_bad\_irq\_dependency+0x620/0x710
[ 2516.392525] check\_irq\_usage+0x4fc/0x86c
[ 2516.392756] check\_prev\_add+0x180/0x1d90
[ 2516.392988] validate\_chain+0x8e0/0xee0
[ 2516.393215] \_\_lock\_acquire+0x97c/0x1e40
[ 2516.393449] lock\_acquire.part.0+0x240/0x570
[ 2516.393814] lock\_acquire+0x90/0xb4
[ 2516.394021] \_raw\_spin\_lock+0xe8/0x154
[ 2516.394244] fd\_install+0x368/0x4f0
[ 2516.394451] copy\_process+0x1f5c/0x3e80
[ 2516.394678] kernel\_clone+0x134/0x660
[ 2516.394895] \_\_do\_sys\_clone3+0x130/0x1f4
[ 2516.395128] \_\_arm64\_sys\_clone3+0x5c/0x7c
[ 2516.395478] invoke\_syscall.constprop.0+0x78/0x1f0
[ 2516.395762] el0\_svc\_common.constprop.0+0x22c/0x2c4
[ 2516.396050] do\_el0\_svc+0xb0/0x10c
[ 2516.396252] el0\_svc+0x24/0x34
[ 2516.396436] el0t\_64\_sync\_handler+0xa4/0x12c
[ 2516.396688] el0t\_64\_sync+0x198/0x19c
[ 2517.491197] NET: Registered PF\_ATMPVC protocol family
[ 2517.491524] NET: Registered PF\_ATMSVC protocol family
[ 2591.991877] sched: RT throttling activated
One way to solve this problem is to move the fd\_install() call out of
the sighand->siglock critical section.
Before commit 6fd2fe494b17 ("copy\_process(): don't use ksys\_close()
on cleanups"), the pidfd installation was done without holding both
the task\_list lock and the sighand->siglock. Obviously, holding these
two locks are not really needed to protect the fd\_install() call.
So move the fd\_install() call down to after the releases of both locks.
Link: https://lore.kernel.org/r/20220208163912.1084752-1-longman@redhat.com
Fixes: 6fd2fe494b17 ("copy\_process(): don't use ksys\_close() on cleanups")
Reviewed-by: "Eric W. Biederman"
Signed-off-by: Waiman Long
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit d7de1e4820c5a42441ff7276174c8c0e63575c1b
Author: Christophe JAILLET
Date: Sat Feb 5 07:58:44 2022 +0100
dmaengine: ptdma: Fix the error handling path in pt\_core\_init()
commit 3c62fd3406e0b2277c76a6984d3979c7f3f1d129 upstream.
In order to free resources correctly in the error handling path of
pt\_core\_init(), 2 goto's have to be switched. Otherwise, some resources
will leak and we will try to release things that have not been allocated
yet.
Also move a dev\_err() to a place where it is more meaningful.
Fixes: fa5d823b16a9 ("dmaengine: ptdma: Initial driver for the AMD PTDMA")
Signed-off-by: Christophe JAILLET
Acked-by: Sanjay R Mehta
Reviewed-by: Dan Carpenter
Link: https://lore.kernel.org/r/41a963a35173f89c874f5c44df5530dc09fea8da.1644044244.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 213d0381893c29f80c7294318fe0a791db65791e
Author: Vladimir Zapolskiy
Date: Thu Feb 3 18:47:03 2022 +0200
i2c: qcom-cci: don't put a device tree node before i2c\_add\_adapter()
commit 02a4a69667a2ad32f3b52ca906f19628fbdd8a01 upstream.
There is a minor chance for a race, if a pointer to an i2c-bus subnode
is stored and then reused after releasing its reference, and it would
be sufficient to get one more reference under a loop over children
subnodes.
Fixes: e517526195de ("i2c: Add Qualcomm CCI I2C driver")
Signed-off-by: Vladimir Zapolskiy
Reviewed-by: Robert Foss
Reviewed-by: Bjorn Andersson
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit 9b4fb30066ebaffeee080c6d9fd7fc82f42c8c59
Author: Vladimir Zapolskiy
Date: Thu Feb 3 18:47:00 2022 +0200
i2c: qcom-cci: don't delete an unregistered adapter
commit a0d48505a1d68e27220369e2dd1e3573a2f362d2 upstream.
If i2c\_add\_adapter() fails to add an I2C adapter found on QCOM CCI
controller, on error path i2c\_del\_adapter() is still called.
Fortunately there is a sanity check in the I2C core, so the only
visible implication is a printed debug level message:
i2c-core: attempting to delete unregistered adapter [Qualcomm-CCI]
Nevertheless it would be reasonable to correct the probe error path.
Fixes: e517526195de ("i2c: Add Qualcomm CCI I2C driver")
Signed-off-by: Vladimir Zapolskiy
Reviewed-by: Robert Foss
Reviewed-by: Bjorn Andersson
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit b0808c66e759a98bcc85559e8c7a7710f0ed6196
Author: Christian Brauner
Date: Thu Feb 3 14:14:05 2022 +0100
tests: fix idmapped mount\_setattr test
commit d1c56bfdaca465bd1d0e913053a9c5cafe8b6a6c upstream.
The test treated zero as a successful run when it really should treat
non-zero as a successful run. A mount's idmapping can't change once it
has been attached to the filesystem.
Link: https://lore.kernel.org/r/20220203131411.3093040-2-brauner@kernel.org
Fixes: 01eadc8dd96d ("tests: add mount\_setattr() selftests")
Cc: Seth Forshee
Cc: Christoph Hellwig
Cc: linux-fsdevel@vger.kernel.org
Reviewed-by: Christoph Hellwig
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit 08d0fbef9f3bb8764ea87718bc19fae26b224487
Author: Jiasheng Jiang
Date: Tue Jan 11 09:12:39 2022 +0800
dmaengine: sh: rcar-dmac: Check for error num after dma\_set\_max\_seg\_size
commit da2ad87fba0891576aadda9161b8505fde81a84d upstream.
As the possible failure of the dma\_set\_max\_seg\_size(), it should be
better to check the return value of the dma\_set\_max\_seg\_size().
Fixes: 97d49c59e219 ("dmaengine: rcar-dmac: set scatter/gather max segment size")
Reported-by: Geert Uytterhoeven
Signed-off-by: Jiasheng Jiang
Reviewed-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/20220111011239.452837-1-jiasheng@iscas.ac.cn
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 544e0968be59a9aad5933e3be671292fd7cc5fc5
Author: Miaoqian Lin
Date: Sat Jan 8 08:53:36 2022 +0000
dmaengine: stm32-dmamux: Fix PM disable depth imbalance in stm32\_dmamux\_probe
commit e831c7aba950f3ae94002b10321279654525e5ec upstream.
The pm\_runtime\_enable will increase power disable depth.
If the probe fails, we should use pm\_runtime\_disable() to balance
pm\_runtime\_enable().
Fixes: 4f3ceca254e0 ("dmaengine: stm32-dmamux: Add PM Runtime support")
Signed-off-by: Miaoqian Lin
Reviewed-by: Amelie Delaunay
Link: https://lore.kernel.org/r/20220108085336.11992-1-linmq006@gmail.com
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 2ffddbecc2bdcb5e4feb8d744085242294080aff
Author: Jiasheng Jiang
Date: Thu Jan 6 11:09:39 2022 +0800
dmaengine: sh: rcar-dmac: Check for error num after setting mask
commit 2d21543efe332cd8c8f212fb7d365bc8b0690bfa upstream.
Because of the possible failure of the dma\_supported(), the
dma\_set\_mask\_and\_coherent() may return error num.
Therefore, it should be better to check it and return the error if
fails.
Fixes: dc312349e875 ("dmaengine: rcar-dmac: Widen DMA mask to 40 bits")
Signed-off-by: Jiasheng Jiang
Reviewed-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/20220106030939.2644320-1-jiasheng@iscas.ac.cn
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 132de3a6cc19680bdd0d28cd5b79f91d0edb132f
Author: Eric Dumazet
Date: Tue Feb 15 15:53:05 2022 -0800
net: sched: limit TC\_ACT\_REPEAT loops
commit 5740d068909676d4bdb5c9c00c37a83df7728909 upstream.
We have been living dangerously, at the mercy of malicious users,
abusing TC\_ACT\_REPEAT, as shown by this syzpot report [1].
Add an arbitrary limit (32) to the number of times an action can
return TC\_ACT\_REPEAT.
v2: switch the limit to 32 instead of 10.
Use net\_warn\_ratelimited() instead of pr\_err\_once().
[1] (C repro available on demand)
rcu: INFO: rcu\_preempt self-detected stall on CPU
rcu: 1-...!: (10500 ticks this GP) idle=021/1/0x4000000000000000 softirq=5592/5592 fqs=0
(t=10502 jiffies g=5305 q=190)
rcu: rcu\_preempt kthread timer wakeup didn't happen for 10502 jiffies! g5305 f0x0 RCU\_GP\_WAIT\_FQS(5) ->state=0x402
rcu: Possible timer handling issue on cpu=0 timer-softirq=3527
rcu: rcu\_preempt kthread starved for 10505 jiffies! g5305 f0x0 RCU\_GP\_WAIT\_FQS(5) ->state=0x402 ->cpu=0
rcu: Unless rcu\_preempt kthread gets sufficient CPU time, OOM is now expected behavior.
rcu: RCU grace-period kthread stack dump:
task:rcu\_preempt state:I stack:29344 pid: 14 ppid: 2 flags:0x00004000
Call Trace:
context\_switch kernel/sched/core.c:4986 [inline]
\_\_schedule+0xab2/0x4db0 kernel/sched/core.c:6295
schedule+0xd2/0x260 kernel/sched/core.c:6368
schedule\_timeout+0x14a/0x2a0 kernel/time/timer.c:1881
rcu\_gp\_fqs\_loop+0x186/0x810 kernel/rcu/tree.c:1963
rcu\_gp\_kthread+0x1de/0x320 kernel/rcu/tree.c:2136
kthread+0x2e9/0x3a0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295

rcu: Stack dump where RCU GP kthread last ran:
Sending NMI from CPU 1 to CPUs 0:
NMI backtrace for cpu 0
CPU: 0 PID: 3646 Comm: syz-executor358 Not tainted 5.17.0-rc3-syzkaller-00149-gbf8e59fd315f #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:rep\_nop arch/x86/include/asm/vdso/processor.h:13 [inline]
RIP: 0010:cpu\_relax arch/x86/include/asm/vdso/processor.h:18 [inline]
RIP: 0010:pv\_wait\_head\_or\_lock kernel/locking/qspinlock\_paravirt.h:437 [inline]
RIP: 0010:\_\_pv\_queued\_spin\_lock\_slowpath+0x3b8/0xb40 kernel/locking/qspinlock.c:508
Code: 48 89 eb c6 45 01 01 41 bc 00 80 00 00 48 c1 e9 03 83 e3 07 41 be 01 00 00 00 48 b8 00 00 00 00 00 fc ff df 4c 8d 2c 01 eb 0c  90 41 83 ec 01 0f 84 72 04 00 00 41 0f b6 45 00 38 d8 7f 08 84
RSP: 0018:ffffc9000283f1b0 EFLAGS: 00000206
RAX: 0000000000000003 RBX: 0000000000000000 RCX: 1ffff1100fc0071e
RDX: 0000000000000001 RSI: 0000000000000201 RDI: 0000000000000000
RBP: ffff88807e0038f0 R08: 0000000000000001 R09: ffffffff8ffbf9ff
R10: 0000000000000001 R11: 0000000000000001 R12: 0000000000004c1e
R13: ffffed100fc0071e R14: 0000000000000001 R15: ffff8880b9c3aa80
FS: 00005555562bf300(0000) GS:ffff8880b9c00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007ffdbfef12b8 CR3: 00000000723c2000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
pv\_queued\_spin\_lock\_slowpath arch/x86/include/asm/paravirt.h:591 [inline]
queued\_spin\_lock\_slowpath arch/x86/include/asm/qspinlock.h:51 [inline]
queued\_spin\_lock include/asm-generic/qspinlock.h:85 [inline]
do\_raw\_spin\_lock+0x200/0x2b0 kernel/locking/spinlock\_debug.c:115
spin\_lock\_bh include/linux/spinlock.h:354 [inline]
sch\_tree\_lock include/net/sch\_generic.h:610 [inline]
sch\_tree\_lock include/net/sch\_generic.h:605 [inline]
prio\_tune+0x3b9/0xb50 net/sched/sch\_prio.c:211
prio\_init+0x5c/0x80 net/sched/sch\_prio.c:244
qdisc\_create.constprop.0+0x44a/0x10f0 net/sched/sch\_api.c:1253
tc\_modify\_qdisc+0x4c5/0x1980 net/sched/sch\_api.c:1660
rtnetlink\_rcv\_msg+0x413/0xb80 net/core/rtnetlink.c:5594
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2494
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x539/0x7e0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x904/0xe00 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:725
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2413
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2467
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2496
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f7ee98aae99
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 41 15 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 c0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffdbfef12d8 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00007ffdbfef1300 RCX: 00007f7ee98aae99
RDX: 0000000000000000 RSI: 0000000020000000 RDI: 0000000000000003
RBP: 0000000000000000 R08: 000000000000000d R09: 000000000000000d
R10: 000000000000000d R11: 0000000000000246 R12: 00007ffdbfef12f0
R13: 00000000000f4240 R14: 000000000004ca47 R15: 00007ffdbfef12e4

INFO: NMI handler (nmi\_cpu\_backtrace\_handler) took too long to run: 2.293 msecs
NMI backtrace for cpu 1
CPU: 1 PID: 3260 Comm: kworker/1:3 Not tainted 5.17.0-rc3-syzkaller-00149-gbf8e59fd315f #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: mld mld\_ifc\_work
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
nmi\_cpu\_backtrace.cold+0x47/0x144 lib/nmi\_backtrace.c:111
nmi\_trigger\_cpumask\_backtrace+0x1b3/0x230 lib/nmi\_backtrace.c:62
trigger\_single\_cpu\_backtrace include/linux/nmi.h:164 [inline]
rcu\_dump\_cpu\_stacks+0x25e/0x3f0 kernel/rcu/tree\_stall.h:343
print\_cpu\_stall kernel/rcu/tree\_stall.h:604 [inline]
check\_cpu\_stall kernel/rcu/tree\_stall.h:688 [inline]
rcu\_pending kernel/rcu/tree.c:3919 [inline]
rcu\_sched\_clock\_irq.cold+0x5c/0x759 kernel/rcu/tree.c:2617
update\_process\_times+0x16d/0x200 kernel/time/timer.c:1785
tick\_sched\_handle+0x9b/0x180 kernel/time/tick-sched.c:226
tick\_sched\_timer+0x1b0/0x2d0 kernel/time/tick-sched.c:1428
\_\_run\_hrtimer kernel/time/hrtimer.c:1685 [inline]
\_\_hrtimer\_run\_queues+0x1c0/0xe50 kernel/time/hrtimer.c:1749
hrtimer\_interrupt+0x31c/0x790 kernel/time/hrtimer.c:1811
local\_apic\_timer\_interrupt arch/x86/kernel/apic/apic.c:1086 [inline]
\_\_sysvec\_apic\_timer\_interrupt+0x146/0x530 arch/x86/kernel/apic/apic.c:1103
sysvec\_apic\_timer\_interrupt+0x8e/0xc0 arch/x86/kernel/apic/apic.c:1097

asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20 arch/x86/include/asm/idtentry.h:638
RIP: 0010:\_\_sanitizer\_cov\_trace\_const\_cmp4+0xc/0x70 kernel/kcov.c:286
Code: 00 00 00 48 89 7c 30 e8 48 89 4c 30 f0 4c 89 54 d8 20 48 89 10 5b c3 0f 1f 80 00 00 00 00 41 89 f8 bf 03 00 00 00 4c 8b 14 24 <89> f1 65 48 8b 34 25 00 70 02 00 e8 14 f9 ff ff 84 c0 74 4b 48 8b
RSP: 0018:ffffc90002c5eea8 EFLAGS: 00000246
RAX: 0000000000000007 RBX: ffff88801c625800 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000003
RBP: ffff8880137d3100 R08: 0000000000000000 R09: 0000000000000000
R10: ffffffff874fcd88 R11: 0000000000000000 R12: ffff88801d692dc0
R13: ffff8880137d3104 R14: 0000000000000000 R15: ffff88801d692de8
tcf\_police\_act+0x358/0x11d0 net/sched/act\_police.c:256
tcf\_action\_exec net/sched/act\_api.c:1049 [inline]
tcf\_action\_exec+0x1a6/0x530 net/sched/act\_api.c:1026
tcf\_exts\_exec include/net/pkt\_cls.h:326 [inline]
route4\_classify+0xef0/0x1400 net/sched/cls\_route.c:179
\_\_tcf\_classify net/sched/cls\_api.c:1549 [inline]
tcf\_classify+0x3e8/0x9d0 net/sched/cls\_api.c:1615
prio\_classify net/sched/sch\_prio.c:42 [inline]
prio\_enqueue+0x3a7/0x790 net/sched/sch\_prio.c:75
dev\_qdisc\_enqueue+0x40/0x300 net/core/dev.c:3668
\_\_dev\_xmit\_skb net/core/dev.c:3756 [inline]
\_\_dev\_queue\_xmit+0x1f61/0x3660 net/core/dev.c:4081
neigh\_hh\_output include/net/neighbour.h:533 [inline]
neigh\_output include/net/neighbour.h:547 [inline]
ip\_finish\_output2+0x14dc/0x2170 net/ipv4/ip\_output.c:228
\_\_ip\_finish\_output net/ipv4/ip\_output.c:306 [inline]
\_\_ip\_finish\_output+0x396/0x650 net/ipv4/ip\_output.c:288
ip\_finish\_output+0x32/0x200 net/ipv4/ip\_output.c:316
NF\_HOOK\_COND include/linux/netfilter.h:296 [inline]
ip\_output+0x196/0x310 net/ipv4/ip\_output.c:430
dst\_output include/net/dst.h:451 [inline]
ip\_local\_out+0xaf/0x1a0 net/ipv4/ip\_output.c:126
iptunnel\_xmit+0x628/0xa50 net/ipv4/ip\_tunnel\_core.c:82
geneve\_xmit\_skb drivers/net/geneve.c:966 [inline]
geneve\_xmit+0x10c8/0x3530 drivers/net/geneve.c:1077
\_\_netdev\_start\_xmit include/linux/netdevice.h:4683 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4697 [inline]
xmit\_one net/core/dev.c:3473 [inline]
dev\_hard\_start\_xmit+0x1eb/0x920 net/core/dev.c:3489
\_\_dev\_queue\_xmit+0x2985/0x3660 net/core/dev.c:4116
neigh\_hh\_output include/net/neighbour.h:533 [inline]
neigh\_output include/net/neighbour.h:547 [inline]
ip6\_finish\_output2+0xf7a/0x14f0 net/ipv6/ip6\_output.c:126
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:191 [inline]
\_\_ip6\_finish\_output+0x61e/0xe90 net/ipv6/ip6\_output.c:170
ip6\_finish\_output+0x32/0x200 net/ipv6/ip6\_output.c:201
NF\_HOOK\_COND include/linux/netfilter.h:296 [inline]
ip6\_output+0x1e4/0x530 net/ipv6/ip6\_output.c:224
dst\_output include/net/dst.h:451 [inline]
NF\_HOOK include/linux/netfilter.h:307 [inline]
NF\_HOOK include/linux/netfilter.h:301 [inline]
mld\_sendpack+0x9a3/0xe40 net/ipv6/mcast.c:1826
mld\_send\_cr net/ipv6/mcast.c:2127 [inline]
mld\_ifc\_work+0x71c/0xdc0 net/ipv6/mcast.c:2659
process\_one\_work+0x9ac/0x1650 kernel/workqueue.c:2307
worker\_thread+0x657/0x1110 kernel/workqueue.c:2454
kthread+0x2e9/0x3a0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295

----------------
Code disassembly (best guess):
0: 48 89 eb mov %rbp,%rbx
3: c6 45 01 01 movb $0x1,0x1(%rbp)
7: 41 bc 00 80 00 00 mov $0x8000,%r12d
d: 48 c1 e9 03 shr $0x3,%rcx
11: 83 e3 07 and $0x7,%ebx
14: 41 be 01 00 00 00 mov $0x1,%r14d
1a: 48 b8 00 00 00 00 00 movabs $0xdffffc0000000000,%rax
21: fc ff df
24: 4c 8d 2c 01 lea (%rcx,%rax,1),%r13
28: eb 0c jmp 0x36
\* 2a: f3 90 pause <-- trapping instruction
2c: 41 83 ec 01 sub $0x1,%r12d
30: 0f 84 72 04 00 00 je 0x4a8
36: 41 0f b6 45 00 movzbl 0x0(%r13),%eax
3b: 38 d8 cmp %bl,%al
3d: 7f 08 jg 0x47
3f: 84 .byte 0x84
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Acked-by: Jamal Hadi Salim
Cc: Cong Wang
Cc: Jiri Pirko
Reported-by: syzbot
Link: https://lore.kernel.org/r/20220215235305.3272331-1-eric.dumazet@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 5f68f27d1dd2b88e060c49de4a95534abdeacd30
Author: Eric W. Biederman
Date: Mon Feb 14 09:40:25 2022 -0600
ucounts: Move RLIMIT\_NPROC handling after set\_user
commit c923a8e7edb010da67424077cbf1a6f1396ebd2e upstream.
During set\*id() which cred->ucounts to charge the the current process
to is not known until after set\_cred\_ucounts. So move the
RLIMIT\_NPROC checking into a new helper flag\_nproc\_exceeded and call
flag\_nproc\_exceeded after set\_cred\_ucounts.
This is very much an arbitrary subset of the places where we currently
change the RLIMIT\_NPROC accounting, designed to preserve the existing
logic.
Fixing the existing logic will be the subject of another series of
changes.
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20220216155832.680775-4-ebiederm@xmission.com
Fixes: 21d1c5e386bc ("Reimplement RLIMIT\_NPROC on top of ucounts")
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit 6f6e8ccbc58be755bd9b36eb3f366be5cdd86e4e
Author: Eric W. Biederman
Date: Fri Feb 11 13:57:44 2022 -0600
rlimit: Fix RLIMIT\_NPROC enforcement failure caused by capability calls in set\_user
commit c16bdeb5a39ffa3f32b32f812831a2092d2a3061 upstream.
Solar Designer  wrote:
> I'm not aware of anyone actually running into this issue and reporting
> it. The systems that I personally know use suexec along with rlimits
> still run older/distro kernels, so would not yet be affected.
>
> So my mention was based on my understanding of how suexec works, and
> code review. Specifically, Apache httpd has the setting RLimitNPROC,
> which makes it set RLIMIT\_NPROC:
>
> https://httpd.apache.org/docs/2.4/mod/core.html#rlimitnproc
>
> The above documentation for it includes:
>
> "This applies to processes forked from Apache httpd children servicing
> requests, not the Apache httpd children themselves. This includes CGI
> scripts and SSI exec commands, but not any processes forked from the
> Apache httpd parent, such as piped logs."
>
> In code, there are:
>
> ./modules/generators/mod\_cgid.c: ( (cgid\_req.limits.limit\_nproc\_set) && ((rc = apr\_procattr\_limit\_set(procattr, APR\_LIMIT\_NPROC,
> ./modules/generators/mod\_cgi.c: ((rc = apr\_procattr\_limit\_set(procattr, APR\_LIMIT\_NPROC,
> ./modules/filters/mod\_ext\_filter.c: rv = apr\_procattr\_limit\_set(procattr, APR\_LIMIT\_NPROC, conf->limit\_nproc);
>
> For example, in mod\_cgi.c this is in run\_cgi\_child().
>
> I think this means an httpd child sets RLIMIT\_NPROC shortly before it
> execs suexec, which is a SUID root program. suexec then switches to the
> target user and execs the CGI script.
>
> Before 2863643fb8b9, the setuid() in suexec would set the flag, and the
> target user's process count would be checked against RLIMIT\_NPROC on
> execve(). After 2863643fb8b9, the setuid() in suexec wouldn't set the
> flag because setuid() is (naturally) called when the process is still
> running as root (thus, has those limits bypass capabilities), and
> accordingly execve() would not check the target user's process count
> against RLIMIT\_NPROC.
In commit 2863643fb8b9 ("set\_user: add capability check when
rlimit(RLIMIT\_NPROC) exceeds") capable calls were added to set\_user to
make it more consistent with fork. Unfortunately because of call site
differences those capable calls were checking the credentials of the
user before set\*id() instead of after set\*id().
This breaks enforcement of RLIMIT\_NPROC for applications that set the
rlimit and then call set\*id() while holding a full set of
capabilities. The capabilities are only changed in the new credential
in security\_task\_fix\_setuid().
The code in apache suexec appears to follow this pattern.
Commit 909cc4ae86f3 ("[PATCH] Fix two bugs with process limits
(RLIMIT\_NPROC)") where this check was added describes the targes of this
capability check as:
2/ When a root-owned process (e.g. cgiwrap) sets up process limits and then
calls setuid, the setuid should fail if the user would then be running
more than rlim\_cur[RLIMIT\_NPROC] processes, but it doesn't. This patch
adds an appropriate test. With this patch, and per-user process limit
imposed in cgiwrap really works.
So the original use case of this check also appears to match the broken
pattern.
Restore the enforcement of RLIMIT\_NPROC by removing the bad capable
checks added in set\_user. This unfortunately restores the
inconsistent state the code has been in for the last 11 years, but
dealing with the inconsistencies looks like a larger problem.
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/all/20210907213042.GA22626@openwall.com/
Link: https://lkml.kernel.org/r/20220212221412.GA29214@openwall.com
Link: https://lkml.kernel.org/r/20220216155832.680775-1-ebiederm@xmission.com
Fixes: 2863643fb8b9 ("set\_user: add capability check when rlimit(RLIMIT\_NPROC) exceeds")
History-Tree: https://git.kernel.org/pub/scm/linux/kernel/git/tglx/history.git
Reviewed-by: Solar Designer
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit 4ac77eb2b7050adb0f9fd07471dff30db0b5ac79
Author: Eric W. Biederman
Date: Wed Feb 9 20:03:19 2022 -0600
ucounts: Enforce RLIMIT\_NPROC not RLIMIT\_NPROC+1
commit 8f2f9c4d82f24f172ae439e5035fc1e0e4c229dd upstream.
Michal Koutný  wrote:
> It was reported that v5.14 behaves differently when enforcing
> RLIMIT\_NPROC limit, namely, it allows one more task than previously.
> This is consequence of the commit 21d1c5e386bc ("Reimplement
> RLIMIT\_NPROC on top of ucounts") that missed the sharpness of
> equality in the forking path.
This can be fixed either by fixing the test or by moving the increment
to be before the test. Fix it my moving copy\_creds which contains
the increment before is\_ucounts\_overlimit.
In the case of CLONE\_NEWUSER the ucounts in the task\_cred changes.
The function is\_ucounts\_overlimit needs to use the final version of
the ucounts for the new process. Which means moving the
is\_ucounts\_overlimit test after copy\_creds is necessary.
Both the test in fork and the test in set\_user were semantically
changed when the code moved to ucounts. The change of the test in
fork was bad because it was before the increment. The test in
set\_user was wrong and the change to ucounts fixed it. So this
fix only restores the old behavior in one lcation not two.
Link: https://lkml.kernel.org/r/20220204181144.24462-1-mkoutny@suse.com
Link: https://lkml.kernel.org/r/20220216155832.680775-2-ebiederm@xmission.com
Cc: stable@vger.kernel.org
Reported-by: Michal Koutný
Reviewed-by: Michal Koutný
Fixes: 21d1c5e386bc ("Reimplement RLIMIT\_NPROC on top of ucounts")
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit ce6c0486317269b3e914a0af51a8ef2011ee0c81
Author: Eric W. Biederman
Date: Wed Feb 9 18:09:41 2022 -0600
ucounts: Handle wrapping in is\_ucounts\_overlimit
commit 0cbae9e24fa7d6c6e9f828562f084da82217a0c5 upstream.
While examining is\_ucounts\_overlimit and reading the various messages
I realized that is\_ucounts\_overlimit fails to deal with counts that
may have wrapped.
Being wrapped should be a transitory state for counts and they should
never be wrapped for long, but it can happen so handle it.
Cc: stable@vger.kernel.org
Fixes: 21d1c5e386bc ("Reimplement RLIMIT\_NPROC on top of ucounts")
Link: https://lkml.kernel.org/r/20220216155832.680775-5-ebiederm@xmission.com
Reviewed-by: Shuah Khan
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit 0c6c4d6d9e52387b58529ee4125e8448c270b088
Author: Eric W. Biederman
Date: Wed Feb 9 16:22:20 2022 -0600
ucounts: Base set\_cred\_ucounts changes on the real user
commit a55d07294f1e9b576093bdfa95422f8119941e83 upstream.
Michal Koutný  wrote:
> Tasks are associated to multiple users at once. Historically and as per
> setrlimit(2) RLIMIT\_NPROC is enforce based on real user ID.
>
> The commit 21d1c5e386bc ("Reimplement RLIMIT\_NPROC on top of ucounts")
> made the accounting structure "indexed" by euid and hence potentially
> account tasks differently.
>
> The effective user ID may be different e.g. for setuid programs but
> those are exec'd into already existing task (i.e. below limit), so
> different accounting is moot.
>
> Some special setresuid(2) users may notice the difference, justifying
> this fix.
I looked at cred->ucount and it is only used for rlimit operations
that were previously stored in cred->user. Making the fact
cred->ucount can refer to a different user from cred->user a bug,
affecting all uses of cred->ulimit not just RLIMIT\_NPROC.
Fix set\_cred\_ucounts to always use the real uid not the effective uid.
Further simplify set\_cred\_ucounts by noticing that set\_cred\_ucounts
somehow retained a draft version of the check to see if alloc\_ucounts
was needed that checks the new->user and new->user\_ns against the
current\_real\_cred(). Remove that draft version of the check.
All that matters for setting the cred->ucounts are the user\_ns and uid
fields in the cred.
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20220207121800.5079-4-mkoutny@suse.com
Link: https://lkml.kernel.org/r/20220216155832.680775-3-ebiederm@xmission.com
Reported-by: Michal Koutný
Reviewed-by: Michal Koutný
Fixes: 21d1c5e386bc ("Reimplement RLIMIT\_NPROC on top of ucounts")
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit 99dbf35385d857f83a254c180bebff30bd79de53
Author: Andy Lutomirski
Date: Mon Feb 14 13:05:49 2022 +0100
x86/ptrace: Fix xfpregs\_set()'s incorrect xmm clearing
commit 44cad52cc14ae10062f142ec16ede489bccf4469 upstream.
xfpregs\_set() handles 32-bit REGSET\_XFP and 64-bit REGSET\_FP. The actual
code treats these regsets as modern FX state (i.e. the beginning part of
XSTATE). The declarations of the regsets thought they were the legacy
i387 format. The code thought they were the 32-bit (no xmm8..15) variant
of XSTATE and, for good measure, made the high bits disappear by zeroing
the wrong part of the buffer. The latter broke ptrace, and everything
else confused anyone trying to understand the code. In particular, the
nonsense definitions of the regsets confused me when I wrote this code.
Clean this all up. Change the declarations to match reality (which
shouldn't change the generated code, let alone the ABI) and fix
xfpregs\_set() to clear the correct bits and to only do so for 32-bit
callers.
Fixes: 6164331d15f7 ("x86/fpu: Rewrite xfpregs\_set()")
Reported-by: Luís Ferreira
Signed-off-by: Andy Lutomirski
Signed-off-by: Borislav Petkov
Cc:
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215524
Link: https://lore.kernel.org/r/YgpFnZpF01WwR8wU@zn.tnic
Signed-off-by: Greg Kroah-Hartman
commit 624c164cb4f3e33e57a639b5ac76bc0bd5a6d9b5
Author: Eliav Farber
Date: Thu Jan 13 10:06:19 2022 +0000
EDAC: Fix calculation of returned address and next offset in edac\_align\_ptr()
commit f8efca92ae509c25e0a4bd5d0a86decea4f0c41e upstream.
Do alignment logic properly and use the "ptr" local variable for
calculating the remainder of the alignment.
This became an issue because struct edac\_mc\_layer has a size that is not
zero modulo eight, and the next offset that was prepared for the private
data was unaligned, causing an alignment exception.
The patch in Fixes: which broke this actually wanted to "what we
actually care about is the alignment of the actual pointer that's about
to be returned." But it didn't check that alignment.
Use the correct variable "ptr" for that.
[ bp: Massage commit message. ]
Fixes: 8447c4d15e35 ("edac: Do alignment logic properly in edac\_align\_ptr()")
Signed-off-by: Eliav Farber
Signed-off-by: Borislav Petkov
Cc:
Link: https://lore.kernel.org/r/20220113100622.12783-2-farbere@amazon.com
Signed-off-by: Greg Kroah-Hartman
commit dc426f86c7c8ce08d41b8cf4757a05c25e70fcf9
Author: James Smart
Date: Sat Feb 12 08:31:20 2022 -0800
scsi: lpfc: Fix pt2pt NVMe PRLI reject LOGO loop
commit 7f4c5a26f735dea4bbc0eb8eb9da99cda95a8563 upstream.
When connected point to point, the driver does not know the FC4's supported
by the other end. In Fabrics, it can query the nameserver. Thus the driver
must send PRLIs for the FC4s it supports and enable support based on the
acc(ept) or rej(ect) of the respective FC4 PRLI. Currently the driver
supports SCSI and NVMe PRLIs.
Unfortunately, although the behavior is per standard, many devices have
come to expect only SCSI PRLIs. In this particular example, the NVMe PRLI
is properly RJT'd but the target decided that it must LOGO after seeing the
unexpected NVMe PRLI. The LOGO causes the sequence to restart and login is
now in an infinite failure loop.
Fix the problem by having the driver, on a pt2pt link, remember NVMe PRLI
accept or reject status across logout as long as the link stays "up". When
retrying login, if the prior NVMe PRLI was rejected, it will not be sent on
the next login.
Link: https://lore.kernel.org/r/20220212163120.15385-1-jsmart2021@gmail.com
Cc:  # v5.4+
Reviewed-by: Ewan D. Milne
Signed-off-by: James Smart
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 813ec08ecfee9d3fac570e775ef1050275dbc1ec
Author: david regan
Date: Wed Jan 26 23:43:44 2022 +0100
mtd: rawnand: brcmnand: Fixed incorrect sub-page ECC status
commit 36415a7964711822e63695ea67fede63979054d9 upstream.
The brcmnand driver contains a bug in which if a page (example 2k byte)
is read from the parallel/ONFI NAND and within that page a subpage (512
byte) has correctable errors which is followed by a subpage with
uncorrectable errors, the page read will return the wrong status of
correctable (as opposed to the actual status of uncorrectable.)
The bug is in function brcmnand\_read\_by\_pio where there is a check for
uncorrectable bits which will be preempted if a previous status for
correctable bits is detected.
The fix is to stop checking for bad bits only if we already have a bad
bits status.
Fixes: 27c5b17cd1b1 ("mtd: nand: add NAND driver "library" for Broadcom STB NAND controller")
Signed-off-by: david regan
Reviewed-by: Florian Fainelli
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/trinity-478e0c09-9134-40e8-8f8c-31c371225eda-1643237024774@3c-app-mailcom-lxa02
Signed-off-by: Greg Kroah-Hartman
commit 0d9cbbf9acf5130018dfe75000430c72e8d1dc80
Author: Dan Carpenter
Date: Fri Jan 21 14:55:05 2022 +0300
mtd: phram: Prevent divide by zero bug in phram\_setup()
commit 3e3765875b1b8864898603768fd5c93eeb552211 upstream.
The problem is that "erasesize" is a uint64\_t type so it might be
non-zero but the lower 32 bits are zero so when it's truncated,
"(uint32\_t)erasesize", then that value is zero. This leads to a
divide by zero bug.
Avoid the bug by delaying the divide until after we have validated
that "erasesize" is non-zero and within the uint32\_t range.
Fixes: dc2b3e5cbc80 ("mtd: phram: use div\_u64\_rem to stop overwrite len in phram\_setup")
Signed-off-by: Dan Carpenter
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20220121115505.GI1978@kadam
Signed-off-by: Greg Kroah-Hartman
commit 1b37889f9a151d26a3fb0d3870f6e1046dee2e24
Author: Ansuel Smith
Date: Sun Jan 16 04:22:11 2022 +0100
mtd: parsers: qcom: Fix missing free for pparts in cleanup
commit 3dd8ba961b9356c4113b96541c752c73d98fef70 upstream.
Mtdpart doesn't free pparts when a cleanup function is declared.
Add missing free for pparts in cleanup function for smem to fix the
leak.
Fixes: 10f3b4d79958 ("mtd: parsers: qcom: Fix leaking of partition name")
Signed-off-by: Ansuel Smith
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20220116032211.9728-2-ansuelsmth@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit a2995fe23095ceda2dc382fbe057f5e164595548
Author: Ansuel Smith
Date: Sun Jan 16 04:22:10 2022 +0100
mtd: parsers: qcom: Fix kernel panic on skipped partition
commit 65d003cca335cabc0160d3cd7daa689eaa9dd3cd upstream.
In the event of a skipped partition (case when the entry name is empty)
the kernel panics in the cleanup function as the name entry is NULL.
Rework the parser logic by first checking the real partition number and
then allocate the space and set the data for the valid partitions.
The logic was also fundamentally wrong as with a skipped partition, the
parts number returned was incorrect by not decreasing it for the skipped
partitions.
Fixes: 803eb124e1a6 ("mtd: parsers: Add Qcom SMEM parser")
Signed-off-by: Ansuel Smith
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20220116032211.9728-1-ansuelsmth@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit c2ca95fd312181b243ea6e54fa519b2f2a6ca067
Author: Bryan O'Donoghue
Date: Mon Jan 3 03:03:15 2022 +0000
mtd: rawnand: qcom: Fix clock sequencing in qcom\_nandc\_probe()
commit 5c23b3f965bc9ee696bf2ed4bdc54d339dd9a455 upstream.
Interacting with a NAND chip on an IPQ6018 I found that the qcomsmem NAND
partition parser was returning -EPROBE\_DEFER waiting for the main smem
driver to load.
This caused the board to reset. Playing about with the probe() function
shows that the problem lies in the core clock being switched off before the
nandc\_unalloc() routine has completed.
If we look at how qcom\_nandc\_remove() tears down allocated resources we see
the expected order is
qcom\_nandc\_unalloc(nandc);
clk\_disable\_unprepare(nandc->aon\_clk);
clk\_disable\_unprepare(nandc->core\_clk);
dma\_unmap\_resource(&pdev->dev, nandc->base\_dma, resource\_size(res),
DMA\_BIDIRECTIONAL, 0);
Tweaking probe() to both bring up and tear-down in that order removes the
reset if we end up deferring elsewhere.
Fixes: c76b78d8ec05 ("mtd: nand: Qualcomm NAND controller driver")
Signed-off-by: Bryan O'Donoghue
Reviewed-by: Manivannan Sadhasivam
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20220103030316.58301-2-bryan.odonoghue@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 0da8318e1d826f4d0df37026f3ea1a99a5fce293
Author: Christoph Hellwig
Date: Thu Feb 17 08:52:31 2022 +0100
block: fix surprise removal for drivers calling blk\_set\_queue\_dying
commit 7a5428dcb7902700b830e912feee4e845df7c019 upstream.
Various block drivers call blk\_set\_queue\_dying to mark a disk as dead due
to surprise removal events, but since commit 8e141f9eb803 that doesn't
work given that the GD\_DEAD flag needs to be set to stop I/O.
Replace the driver calls to blk\_set\_queue\_dying with a new (and properly
documented) blk\_mark\_disk\_dead API, and fold blk\_set\_queue\_dying into the
only remaining caller.
Fixes: 8e141f9eb803 ("block: drain file system I/O on del\_gendisk")
Reported-by: Markus Blöchl
Signed-off-by: Christoph Hellwig
Reviewed-by: Sagi Grimberg
Link: https://lore.kernel.org/r/20220217075231.1140-1-hch@lst.de
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit ee421a75a740d6d8579fb1426141312313287de2
Author: Linus Torvalds
Date: Tue Feb 15 15:28:00 2022 -0800
tty: n\_tty: do not look ahead for EOL character past the end of the buffer
commit 3593030761630e09200072a4bd06468892c27be3 upstream.
Daniel Gibson reports that the n\_tty code gets line termination wrong in
very specific cases:
"If you feed a line with exactly 64 chars + terminating newline, and
directly afterwards (without reading) another line into a pseudo
terminal, the the first read() on the other side will return the 64
char line \*without\* terminating newline, and the next read() will
return the missing terminating newline AND the complete next line (if
it fits in the buffer)"
and bisected the behavior to commit 3b830a9c34d5 ("tty: convert
tty\_ldisc\_ops 'read()' function to take a kernel pointer").
Now, digging deeper, it turns out that the behavior isn't exactly new:
what changed in commit 3b830a9c34d5 was that the tty line discipline
.read() function is now passed an intermediate kernel buffer rather than
the final user space buffer.
And that intermediate kernel buffer is 64 bytes in size - thus that
special case with exactly 64 bytes plus terminating newline.
The same problem did exist before, but historically the boundary was not
the 64-byte chunk, but the user-supplied buffer size, which is obviously
generally bigger (and potentially bigger than N\_TTY\_BUF\_SIZE, which
would hide the issue entirely).
The reason is that the n\_tty canon\_copy\_from\_read\_buf() code would look
ahead for the EOL character one byte further than it would actually
copy. It would then decide that it had found the terminator, and unmark
it as an EOL character - which in turn explains why the next read
wouldn't then be terminated by it.
Now, the reason it did all this in the first place is related to some
historical and pretty obscure EOF behavior, see commit ac8f3bf8832a
("n\_tty: Fix poll() after buffer-limited eof push read") and commit
40d5e0905a03 ("n\_tty: Fix EOF push handling").
And the reason for the EOL confusion is that we treat EOF as a special
EOL condition, with the EOL character being NUL (aka "\_\_DISABLED\_CHAR"
in the kernel sources).
So that EOF look-ahead also affects the normal EOL handling.
This patch just removes the look-ahead that causes problems, because EOL
is much more critical than the historical "EOF in the middle of a line
that coincides with the end of the buffer" handling ever was.
Now, it is possible that we should indeed re-introduce the "look at next
character to see if it's a EOF" behavior, but if so, that should be done
not at the kernel buffer chunk boundary in canon\_copy\_from\_read\_buf(),
but at a higher level, when we run out of the user buffer.
In particular, the place to do that would be at the top of
'n\_tty\_read()', where we check if it's a continuation of a previously
started read, and there is no more buffer space left, we could decide to
just eat the \_\_DISABLED\_CHAR at that point.
But that would be a separate patch, because I suspect nobody actually
cares, and I'd like to get a report about it before bothering.
Fixes: 3b830a9c34d5 ("tty: convert tty\_ldisc\_ops 'read()' function to take a kernel pointer")
Fixes: ac8f3bf8832a ("n\_tty: Fix poll() after buffer-limited eof push read")
Fixes: 40d5e0905a03 ("n\_tty: Fix EOF push handling")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215611
Reported-and-tested-by: Daniel Gibson
Cc: Peter Hurley
Cc: Greg Kroah-Hartman
Cc: Jiri Slaby
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 855e613993c0f02ad62d834535e156787ce2edbf
Author: Trond Myklebust
Date: Tue Feb 15 18:05:18 2022 -0500
NFS: Do not report writeback errors in nfs\_getattr()
commit d19e0183a88306acda07f4a01fedeeffe2a2a06b upstream.
The result of the writeback, whether it is an ENOSPC or an EIO, or
anything else, does not inhibit the NFS client from reporting the
correct file timestamps.
Fixes: 79566ef018f5 ("NFS: Getattr doesn't require data sync semantics")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit aab7d08fd5126be9bdc9e9fa5b56cf2385872a5e
Author: Trond Myklebust
Date: Tue Feb 8 13:38:23 2022 -0500
NFS: LOOKUP\_DIRECTORY is also ok with symlinks
commit e0caaf75d443e02e55e146fd75fe2efc8aed5540 upstream.
Commit ac795161c936 (NFSv4: Handle case where the lookup of a directory
fails) [1], part of Linux since 5.17-rc2, introduced a regression, where
a symbolic link on an NFS mount to a directory on another NFS does not
resolve(?) the first time it is accessed:
Reported-by: Paul Menzel
Fixes: ac795161c936 ("NFSv4: Handle case where the lookup of a directory fails")
Signed-off-by: Trond Myklebust
Tested-by: Donald Buczek
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 36143d0d3d3767710b00b54c8e2242d8611fc463
Author: Trond Myklebust
Date: Tue Feb 8 12:14:44 2022 -0500
NFS: Remove an incorrect revalidation in nfs4\_update\_changeattr\_locked()
commit 9d047bf68fe8cdb4086deaf4edd119731a9481ed upstream.
In nfs4\_update\_changeattr\_locked(), we don't need to set the
NFS\_INO\_REVAL\_PAGECACHE flag, because we already know the value of the
change attribute, and we're already flagging the size. In fact, this
forces us to revalidate the change attribute a second time for no good
reason.
This extra flag appears to have been introduced as part of the xattr
feature, when update\_changeattr\_locked() was converted for use by the
xattr code.
Fixes: 1b523ca972ed ("nfs: modify update\_changeattr to deal with regular files")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 268b7ce29d22d78c730175639fec9d4443bb6e7a
Author: Laibin Qiu
Date: Sat Jan 22 19:10:45 2022 +0800
block/wbt: fix negative inflight counter when remove scsi device
commit e92bc4cd34de2ce454bdea8cd198b8067ee4e123 upstream.
Now that we disable wbt by set WBT\_STATE\_OFF\_DEFAULT in
wbt\_disable\_default() when switch elevator to bfq. And when
we remove scsi device, wbt will be enabled by wbt\_enable\_default.
If it become false positive between wbt\_wait() and wbt\_track()
when submit write request.
The following is the scenario that triggered the problem.
T1 T2 T3
elevator\_switch\_mq
bfq\_init\_queue
wbt\_disable\_default <= Set
rwb->enable\_state (OFF)
Submit\_bio
blk\_mq\_make\_request
rq\_qos\_throttle
<= rwb->enable\_state (OFF)
scsi\_remove\_device
sd\_remove
del\_gendisk
blk\_unregister\_queue
elv\_unregister\_queue
wbt\_enable\_default
<= Set rwb->enable\_state (ON)
q\_qos\_track
<= rwb->enable\_state (ON)
^^^^^^ this request will mark WBT\_TRACKED without inflight add and will
lead to drop rqw->inflight to -1 in wbt\_done() which will trigger IO hung.
Fix this by move wbt\_enable\_default() from elv\_unregister to
bfq\_exit\_queue(). Only re-enable wbt when bfq exit.
Fixes: 76a8040817b4b ("blk-wbt: make sure throttle is enabled properly")
Remove oneline stale comment, and kill one oneshot local variable.
Signed-off-by: Ming Lei
Reviewed-by: Christoph Hellwig
Link: https://lore.kernel.org/linux-block/20211214133103.551813-1-qiulaibin@huawei.com/
Signed-off-by: Laibin Qiu
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 880982dbc4df3e084c19d04fa6f74ad19b69cbe7
Author: Stephen Boyd
Date: Wed Feb 9 15:25:20 2022 -0800
ASoC: qcom: Actually clear DMA interrupt register for HDMI
commit c8d251f51ee61df06ee0e419348d8c9160bbfb86 upstream.
In commit da0363f7bfd3 ("ASoC: qcom: Fix for DMA interrupt clear reg
overwriting") we changed regmap\_write() to regmap\_update\_bits() so that
we can avoid overwriting bits that we didn't intend to modify.
Unfortunately this change breaks the case where a register is writable
but not readable, which is exactly how the HDMI irq clear register is
designed (grep around LPASS\_HDMITX\_APP\_IRQCLEAR\_REG to see how it's
write only). That's because regmap\_update\_bits() tries to read the
register from the hardware and if it isn't readable it looks in the
regmap cache to see what was written there last time to compare against
what we want to write there. Eventually, we're unable to modify this
register at all because the bits that we're trying to set are already
set in the cache.
This is doubly bad for the irq clear register because you have to write
the bit to clear an interrupt. Given the irq is level triggered, we see
an interrupt storm upon plugging in an HDMI cable and starting audio
playback. The irq storm is so great that performance degrades
significantly, leading to CPU soft lockups.
Fix it by using regmap\_write\_bits() so that we really do write the bits
in the clear register that we want to. This brings the number of irqs
handled by lpass\_dma\_interrupt\_handler() down from ~150k/sec to ~10/sec.
Fixes: da0363f7bfd3 ("ASoC: qcom: Fix for DMA interrupt clear reg overwriting")
Cc: Srinivasa Rao Mandadapu
Cc: Srinivas Kandagatla
Signed-off-by: Stephen Boyd
Link: https://lore.kernel.org/r/20220209232520.4017634-1-swboyd@chromium.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit ce38a92097f74b6db3aa30431fd45b405cc1fa55
Author: Martin Povišer
Date: Fri Feb 4 10:53:01 2022 +0100
ASoC: tas2770: Insert post reset delay
commit 307f31452078792aab94a729fce33200c6e42dc4 upstream.
Per TAS2770 datasheet there must be a 1 ms delay from reset to first
command. So insert delays into the driver where appropriate.
Fixes: 1a476abc723e ("tas2770: add tas2770 smart PA kernel driver")
Signed-off-by: Martin Povišer
Link: https://lore.kernel.org/r/20220204095301.5554-1-povik+lin@cutebit.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit d69d98d8edf90e25e4e09930dd36dd6d09dd6768
Author: Bart Van Assche
Date: Fri Dec 3 15:19:42 2021 -0800
scsi: ufs: Fix a deadlock in the error handler
commit 945c3cca05d78351bba29fa65d93834cb7934c7b upstream.
The following deadlock has been observed on a test setup:
- All tags allocated
- The SCSI error handler calls ufshcd\_eh\_host\_reset\_handler()
- ufshcd\_eh\_host\_reset\_handler() queues work that calls
ufshcd\_err\_handler()
- ufshcd\_err\_handler() locks up as follows:
Workqueue: ufs\_eh\_wq\_0 ufshcd\_err\_handler.cfi\_jt
Call trace:
\_\_switch\_to+0x298/0x5d8
\_\_schedule+0x6cc/0xa94
schedule+0x12c/0x298
blk\_mq\_get\_tag+0x210/0x480
\_\_blk\_mq\_alloc\_request+0x1c8/0x284
blk\_get\_request+0x74/0x134
ufshcd\_exec\_dev\_cmd+0x68/0x640
ufshcd\_verify\_dev\_init+0x68/0x35c
ufshcd\_probe\_hba+0x12c/0x1cb8
ufshcd\_host\_reset\_and\_restore+0x88/0x254
ufshcd\_reset\_and\_restore+0xd0/0x354
ufshcd\_err\_handler+0x408/0xc58
process\_one\_work+0x24c/0x66c
worker\_thread+0x3e8/0xa4c
kthread+0x150/0x1b4
ret\_from\_fork+0x10/0x30
Fix this lockup by making ufshcd\_exec\_dev\_cmd() allocate a reserved
request.
Link: https://lore.kernel.org/r/20211203231950.193369-10-bvanassche@acm.org
Tested-by: Bean Huo
Reviewed-by: Adrian Hunter
Reviewed-by: Bean Huo
Signed-off-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 84fdbb039ec82654228d49d4453ccd2cf5a418f7
Author: Bart Van Assche
Date: Fri Dec 3 15:19:38 2021 -0800
scsi: ufs: Remove dead code
commit d77ea8226b3be23b0b45aa42851243b62a27bda1 upstream.
Commit 7252a3603015 ("scsi: ufs: Avoid busy-waiting by eliminating tag
conflicts") guarantees that 'tag' is not in use by any SCSI command.
Remove the check that returns early if a conflict occurs.
Link: https://lore.kernel.org/r/20211203231950.193369-6-bvanassche@acm.org
Tested-by: Bean Huo
Reviewed-by: Bean Huo
Acked-by: Avri Altman
Signed-off-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 934c8c95bfb8a10fc52b70ac8dd654c709e9366c
Author: Jon Maloy
Date: Tue Feb 15 21:00:09 2022 -0500
tipc: fix wrong notification node addresses
commit c08e58438d4a709fb451b6d7d33432cc9907a2a8 upstream.
The previous bug fix had an unfortunate side effect that broke
distribution of binding table entries between nodes. The updated
tipc\_sock\_addr struct is also used further down in the same
function, and there the old value is still the correct one.
Fixes: 032062f363b4 ("tipc: fix wrong publisher node address in link publications")
Signed-off-by: Jon Maloy
Link: https://lore.kernel.org/r/20220216020009.3404578-1-jmaloy@redhat.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit e124fe29c7994469e5c48cc71d8579024747aa14
Author: Steve French
Date: Sat Feb 12 01:54:14 2022 -0600
smb3: fix snapshot mount option
commit 9405b5f8b20c2bfa6523a555279a0379640dc136 upstream.
The conversion to the new API broke the snapshot mount option
due to 32 vs. 64 bit type mismatch
Fixes: 24e0a1eff9e2 ("cifs: switch to new mount api")
Cc: stable@vger.kernel.org # 5.11+
Reported-by:
Acked-by: Ronnie Sahlberg
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 58d3111eafce9e4398654b07f0b1dac27f26ee5b
Author: Christian Eggers
Date: Tue Jan 25 09:16:19 2022 +0100
mtd: rawnand: gpmi: don't leak PM reference in error path
commit 9161f365c91614e5a3f5c6dcc44c3b1b33bc59c0 upstream.
If gpmi\_nfc\_apply\_timings() fails, the PM runtime usage counter must be
dropped.
Reported-by: Pavel Machek
Fixes: f53d4c109a66 ("mtd: rawnand: gpmi: Add ERR007117 protection for nfc\_apply\_timings")
Signed-off-by: Christian Eggers
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20220125081619.6286-1-ceggers@arri.de
Signed-off-by: Greg Kroah-Hartman
commit 2b61859fc259916366aeb76dc5c8f4a01d9633e4
Author: Anders Roxell
Date: Fri Feb 11 01:51:13 2022 +0100
powerpc/lib/sstep: fix 'ptesync' build error
commit fe663df7825811358531dc2e8a52d9eaa5e3515e upstream.
Building tinyconfig with gcc (Debian 11.2.0-16) and assembler (Debian
2.37.90.20220207) the following build error shows up:
{standard input}: Assembler messages:
{standard input}:2088: Error: unrecognized opcode: `ptesync'
make[3]: \*\*\* [/builds/linux/scripts/Makefile.build:287: arch/powerpc/lib/sstep.o] Error 1
Add the 'ifdef CONFIG\_PPC64' around the 'ptesync' in function
'emulate\_update\_regs()' to like it is in 'analyse\_instr()'. Since it looks like
it got dropped inadvertently by commit 3cdfcbfd32b9 ("powerpc: Change
analyse\_instr so it doesn't modify \*regs").
A key detail is that analyse\_instr() will never recognise lwsync or
ptesync on 32-bit (because of the existing ifdef), and as a result
emulate\_update\_regs() should never be called with an op specifying
either of those on 32-bit. So removing them from emulate\_update\_regs()
should be a nop in terms of runtime behaviour.
Fixes: 3cdfcbfd32b9 ("powerpc: Change analyse\_instr so it doesn't modify \*regs")
Cc: stable@vger.kernel.org # v4.14+
Suggested-by: Arnd Bergmann
Signed-off-by: Anders Roxell
[mpe: Add last paragraph of change log mentioning analyse\_instr() details]
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20220211005113.1361436-1-anders.roxell@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 9273f93c3f2d17d41e0300eb116847124899f6cb
Author: Christophe Leroy
Date: Tue Dec 7 06:10:05 2021 +0000
powerpc/603: Fix boot failure with DEBUG\_PAGEALLOC and KFENCE
commit 9bb162fa26ed76031ed0e7dbc77ccea0bf977758 upstream.
Allthough kernel text is always mapped with BATs, we still have
inittext mapped with pages, so TLB miss handling is required
when CONFIG\_DEBUG\_PAGEALLOC or CONFIG\_KFENCE is set.
The final solution should be to set a BAT that also maps inittext
but that BAT then needs to be cleared at end of init, and it will
require more changes to be able to do it properly.
As DEBUG\_PAGEALLOC or KFENCE are debugging, performance is not a big
deal so let's fix it simply for now to enable easy stable application.
Fixes: 035b19a15a98 ("powerpc/32s: Always map kernel text and rodata with BATs")
Cc: stable@vger.kernel.org # v5.11+
Reported-by: Maxime Bizon
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/aea33b4813a26bdb9378b5f273f00bd5d4abe240.1638857364.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 225e7bc47a120d3bb2406ad88d405c75075260bb
Author: Woody Suwalski
Date: Wed Feb 9 16:05:09 2022 -0500
ACPI: processor: idle: fix lockup regression on 32-bit ThinkPad T40
commit bfe55a1f7fd6bfede16078bf04c6250fbca11588 upstream.
Add and ACPI idle power level limit for 32-bit ThinkPad T40.
There is a regression on T40 introduced by commit d6b88ce2, starting
with kernel 5.16:
commit d6b88ce2eb9d2698eb24451eb92c0a1649b17bb1
Author: Richard Gong
Date:   Wed Sep 22 08:31:16 2021 -0500
ACPI: processor idle: Allow playing dead in C3 state
The above patch is trying to enter C3 state during init, what is causing
a T40 system freeze. I have not found a similar issue on any other of my
32-bit machines.
The fix is to add another exception to the processor\_power\_dmi\_table[] list.
As a result the dmesg shows as expected:
[2.155398] ACPI: IBM ThinkPad T40 detected - limiting to C2 max\_cstate. Override with "processor.max\_cstate=9"
[2.155404] ACPI: processor limited to max C-state 2
The fix is trivial and affects only vintage T40 systems.
Fixes: d6b88ce2eb9d ("CPI: processor idle: Allow playing dead in C3 state")
Signed-off-by: Woody Suwalski
Reviewed-by: Hans de Goede
Cc: 5.16+  # 5.16+
[ rjw: New subject ]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit cd387fb7bed0c6adb50ba281e4bb80b599b828f0
Author: Steve French
Date: Wed Feb 16 13:23:53 2022 -0600
cifs: fix confusing unneeded warning message on smb2.1 and earlier
commit 53923e0fe2098f90f339510aeaa0e1413ae99a16 upstream.
When mounting with SMB2.1 or earlier, even with nomultichannel, we
log the confusing warning message:
"CIFS: VFS: multichannel is not supported on this protocol version, use 3.0 or above"
Fix this so that we don't log this unless they really are trying
to mount with multichannel.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=215608
Reported-by: Kim Scarborough
Cc: stable@vger.kernel.org # 5.11+
Reviewed-by: Paulo Alcantara (SUSE)
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 1a195b0177ec18151bc5c56e37419eda2fbd8260
Author: Amir Goldstein
Date: Mon Jan 3 16:50:25 2022 +0200
cifs: fix set of group SID via NTSD xattrs
commit dd5a927e411836eaef44eb9b00fece615e82e242 upstream.
'setcifsacl -g ' silently fails to set the group SID on server.
Actually, the bug existed since commit 438471b67963 ("CIFS: Add support
for setting owner info, dos attributes, and create time"), but this fix
will not apply cleanly to kernel versions <= v5.10.
Fixes: 3970acf7ddb9 ("SMB3: Add support for getting and setting SACLs")
Cc: stable@vger.kernel.org # 5.11+
Signed-off-by: Amir Goldstein
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit a06d52d22644f4cd278855442209a54a4998af2d
Author: Mark Brown
Date: Tue Feb 1 15:56:29 2022 +0000
ASoC: ops: Fix stereo change notifications in snd\_soc\_put\_xr\_sx()
commit 2b7c46369f09c358164d31d17e5695185403185e upstream.
When writing out a stereo control we discard the change notification from
the first channel, meaning that events are only generated based on changes
to the second channel. Ensure that we report a change if either channel
has changed.
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220201155629.120510-5-broonie@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit e8ee1a1b6ef51da12f24ba3ad6d8b4020960159f
Author: Mark Brown
Date: Tue Feb 1 15:56:27 2022 +0000
ASoC: ops: Fix stereo change notifications in snd\_soc\_put\_volsw\_sx()
commit 7f3d90a3519680dfa23e750f80bfdefc0f5eda4a upstream.
When writing out a stereo control we discard the change notification from
the first channel, meaning that events are only generated based on changes
to the second channel. Ensure that we report a change if either channel
has changed.
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220201155629.120510-3-broonie@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit cfeaa7bae8bbdfa3f264cd6bf6b9e6a589fea083
Author: Mark Brown
Date: Tue Feb 1 15:56:28 2022 +0000
ASoC: ops: Fix stereo change notifications in snd\_soc\_put\_volsw\_range()
commit 650204ded3703b5817bd4b6a77fa47d333c4f902 upstream.
When writing out a stereo control we discard the change notification from
the first channel, meaning that events are only generated based on changes
to the second channel. Ensure that we report a change if either channel
has changed.
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220201155629.120510-4-broonie@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit d163624f7667e83a234c03a972a7bd75f325a4d7
Author: Mark Brown
Date: Tue Feb 1 15:56:26 2022 +0000
ASoC: ops: Fix stereo change notifications in snd\_soc\_put\_volsw()
commit 564778d7b1ea465f9487eedeece7527a033549c5 upstream.
When writing out a stereo control we discard the change notification from
the first channel, meaning that events are only generated based on changes
to the second channel. Ensure that we report a change if either channel
has changed.
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220201155629.120510-2-broonie@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 958fad1d55cf3ce4fd1b6e08e4177159d87af38c
Author: Takashi Iwai
Date: Mon Feb 14 11:00:20 2022 +0100
ALSA: hda: Fix missing codec probe on Shenker Dock 15
commit dd8e5b161d7fb9cefa1f1d6e35a39b9e1563c8d3 upstream.
By some unknown reason, BIOS on Shenker Dock 15 doesn't set up the
codec mask properly for the onboard audio. Let's set the forced codec
mask to enable the codec discovery.
Reported-by: dmummenschanz@web.de
Cc:
Link: https://lore.kernel.org/r/trinity-f018660b-95c9-442b-a2a8-c92a56eb07ed-1644345967148@3c-app-webde-bap22
Link: https://lore.kernel.org/r/20220214100020.8870-2-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit d5d78e3d2ce9c68384ae849326e34d4c7e54f241
Author: Takashi Iwai
Date: Mon Feb 14 11:00:19 2022 +0100
ALSA: hda: Fix regression on forced probe mask option
commit 6317f7449348a897483a2b4841f7a9190745c81b upstream.
The forced probe mask via probe\_mask 0x100 bit doesn't work any longer
as expected since the bus init code was moved and it's clearing the
codec\_mask value that was set beforehand. This patch fixes the
long-time regression by moving the check\_probe\_mask() call.
Fixes: a41d122449be ("ALSA: hda - Embed bus into controller object")
Reported-by: dmummenschanz@web.de
Cc:
Link: https://lore.kernel.org/r/trinity-f018660b-95c9-442b-a2a8-c92a56eb07ed-1644345967148@3c-app-webde-bap22
Link: https://lore.kernel.org/r/20220214100020.8870-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit bda6c8f72fc6ee3363ad749a85711bb78199867d
Author: Takashi Iwai
Date: Mon Feb 14 14:04:10 2022 +0100
ALSA: hda/realtek: Fix deadlock by COEF mutex
commit 2a845837e3d0ddaed493b4c5c4643d7f0542804d upstream.
The recently introduced coef\_mutex for Realtek codec seems causing a
deadlock when the relevant code is invoked from the power-off state;
then the HD-audio core tries to power-up internally, and this kicks
off the codec runtime PM code that tries to take the same coef\_mutex.
In order to avoid the deadlock, do the temporary power up/down around
the coef\_mutex acquisition and release. This assures that the
power-up sequence runs before the mutex, hence no re-entrance will
happen.
Fixes: b837a9f5ab3b ("ALSA: hda: realtek: Fix race at concurrent COEF updates")
Reported-and-tested-by: Julian Wollrath
Cc:
Link: https://lore.kernel.org/r/20220214132838.4db10fca@schienar
Link: https://lore.kernel.org/r/20220214130410.21230-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 861e505b6e8217e1385652e158a5b3d082ffe4bb
Author: Yu Huang
Date: Sun Feb 13 00:08:33 2022 +0800
ALSA: hda/realtek: Add quirk for Legion Y9000X 2019
commit c07f2c7b45413a9e50ba78630fda04ecfa17b4f2 upstream.
Legion Y9000X 2019 has the same speaker with Y9000X 2020,
but with a different quirk address. Add one quirk entry
to make the speaker work on Y9000X 2019 too.
Signed-off-by: Yu Huang
Cc:
Link: https://lore.kernel.org/r/20220212160835.165065-1-diwang90@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 3a2d391a5c960331b215e7bac6045cbdbd3ccad7
Author: Takashi Iwai
Date: Thu Feb 10 13:33:44 2022 +0100
ALSA: memalloc: invalidate SG pages before sync
commit 3e16dc50d77dc3494275a241fac250c94bf45206 upstream.
It seems that calling invalidate\_kernel\_vmap\_range() is more correct
to be called before dma\_sync\_\*(), judging from the other thread:
https://lore.kernel.org/all/20220111085958.GA22795@lst.de/
Although this won't matter much in practice, let's fix the call order
for consistency.
Fixes: a25684a95646 ("ALSA: memalloc: Support for non-contiguous page allocation")
Reported-by: Ezequiel Garcia
Cc:
Link: https://lore.kernel.org/r/20220210123344.8756-3-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8372d3aa96893d46d57c2c0fe28a913d2d421acb
Author: Takashi Iwai
Date: Thu Feb 10 13:33:43 2022 +0100
ALSA: memalloc: Fix dma\_need\_sync() checks
commit 8e1741c658996a16bd096e077dae0da2460a997f upstream.
dma\_need\_sync() checks each DMA address. Fix the incorrect usages
for non-contiguous and non-coherent page allocations.
Fortunately, there are no actual call sites that need manual syncs
yet.
Fixes: a25684a95646 ("ALSA: memalloc: Support for non-contiguous page allocation")
Fixes: 73325f60e2ed ("ALSA: memalloc: Support for non-coherent page allocation")
Cc:
Reported-by: Ezequiel Garcia
Link: https://lore.kernel.org/r/20220210123344.8756-2-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 6a45035b42efefa83ff34d866e6fe1d34a670aed
Author: Matteo Martelli
Date: Fri Feb 11 23:49:13 2022 +0100
ALSA: usb-audio: revert to IMPLICIT\_FB\_FIXED\_DEV for M-Audio FastTrack Ultra
commit 19d20c7a29bf2e46ff1ab8e8c4fcd2da8a4f38e2 upstream.
Commit 83b7dcbc51c930fc2079ab6c6fc9d719768321f1 introduced a generic
implicit feedback parser, which fails to execute for M-Audio FastTrack
Ultra sound cards. The issue is with the ENDPOINT\_SYNCTYPE check in
add\_generic\_implicit\_fb() where the SYNCTYPE is ADAPTIVE instead of ASYNC.
The reason is that the sync type of the FastTrack output endpoints are
set to adaptive in the quirks table since commit
65f04443c96dbda11b8fff21d6390e082846aa3c.
Fixes: 83b7dcbc51c9 ("ALSA: usb-audio: Add generic implicit fb parsing")
Signed-off-by: Matteo Martelli
Cc:
Link: https://lore.kernel.org/r/20220211224913.20683-2-matteomartelli3@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8f868f822c5980061e572b3540bb7f8804be0624
Author: Takashi Iwai
Date: Mon Feb 14 13:57:11 2022 +0100
ALSA: usb-audio: Don't abort resume upon errors
commit 9a5adeb28b77416446658e75bdef3bbe5fb92a83 upstream.
The default mixer resume code treats the errors at restoring the
modified mixer items as a fatal error, and it returns back to the
caller. This ends up in the resume failure, and the device will be
come unavailable, although basically those errors are intermittent and
can be safely ignored.
The problem itself has been present from the beginning, but it didn't
hit usually because the code tries to resume only the modified items.
But now with the recent commit to forcibly initialize each item at the
probe time, the problem surfaced more often, hence it appears as a
regression.
This patch fixes the regression simply by ignoring the errors at
resume.
Fixes: b96681bd5827 ("ALSA: usb-audio: Initialize every feature unit once at probe time")
Cc:
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=215561
Link: https://lore.kernel.org/r/20220214125711.20531-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit f5471b6b2d088d1d93ba72407f1df880d09f9c27
Author: Joakim Tjernlund
Date: Mon Feb 14 18:56:43 2022 +0100
arm64: Correct wrong label in macro \_\_init\_el2\_gicv3
commit 4f6de676d94ee8ddfc2e7e7cd935fc7cb2feff3a upstream.
In commit:
114945d84a30a5fe ("arm64: Fix labels in el2\_setup macros")
We renamed a label from '1' to '.Lskip\_gicv3\_\@', but failed to update
a branch to it, which now targets a later label also called '1'.
The branch is taken rarely, when GICv3 is present but SRE is disabled
at EL3, causing a boot-time crash.
Update the caller to the new label name.
Fixes: 114945d84a30 ("arm64: Fix labels in el2\_setup macros")
Cc:  # 5.12.x
Signed-off-by: Joakim Tjernlund
Link: https://lore.kernel.org/r/20220214175643.21931-1-joakim.tjernlund@infinera.com
Reviewed-by: Mark Rutland
Reviewed-by: Marc Zyngier
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 52e84872e587187d44b84c2044e0b5cc84a5fe11
Author: Muhammad Usama Anjum
Date: Thu Feb 10 22:13:23 2022 +0500
selftests/exec: Add non-regular to TEST\_GEN\_PROGS
commit a7e793a867ae312cecdeb6f06cceff98263e75dd upstream.
non-regular file needs to be compiled and then copied to the output
directory. Remove it from TEST\_PROGS and add it to TEST\_GEN\_PROGS. This
removes error thrown by rsync when non-regular object isn't found:
rsync: [sender] link\_stat "/linux/tools/testing/selftests/exec/non-regular" failed: No such file or directory (2)
rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1333) [sender=3.2.3]
Fixes: 0f71241a8e32 ("selftests/exec: add file type errno tests")
Reported-by: "kernelci.org bot"
Signed-off-by: Muhammad Usama Anjum
Reviewed-by: Shuah Khan
Reviewed-by: Kees Cook
Signed-off-by: Shuah Khan
Signed-off-by: Greg Kroah-Hartman
commit 40c1ff40decabe8236e7c610c068bc041927cbbe
Author: Arnaldo Carvalho de Melo
Date: Wed Feb 16 16:01:00 2022 -0300
perf bpf: Defer freeing string after possible strlen() on it
commit 31ded1535e3182778a1d0e5c32711f55da3bc512 upstream.
This was detected by the gcc in Fedora Rawhide's gcc:
50 11.01 fedora:rawhide : FAIL gcc version 12.0.1 20220205 (Red Hat 12.0.1-0) (GCC)
inlined from 'bpf\_\_config\_obj' at util/bpf-loader.c:1242:9:
util/bpf-loader.c:1225:34: error: pointer 'map\_opt' may be used after 'free' [-Werror=use-after-free]
1225 | \*key\_scan\_pos += strlen(map\_opt);
| ^~~~~~~~~~~~~~~
util/bpf-loader.c:1223:9: note: call to 'free' here
1223 | free(map\_name);
| ^~~~~~~~~~~~~~
cc1: all warnings being treated as errors
So do the calculations on the pointer before freeing it.
Fixes: 04f9bf2bac72480c ("perf bpf-loader: Add missing '\*' for key\_scan\_pos")
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Wang ShaoBo
Link: https://lore.kernel.org/lkml/Yg1VtQxKrPpS3uNA@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit e9895a29ecb314dfc7947e6eb2de15cfbceb5b25
Author: Oleksandr Mazur
Date: Tue Feb 15 18:53:03 2022 +0200
net: bridge: multicast: notify switchdev driver whenever MC processing gets disabled
commit c832962ac972082b3a1f89775c9d4274c8cb5670 upstream.
Whenever bridge driver hits the max capacity of MDBs, it disables
the MC processing (by setting corresponding bridge option), but never
notifies switchdev about such change (the notifiers are called only upon
explicit setting of this option, through the registered netlink interface).
This could lead to situation when Software MDB processing gets disabled,
but this event never gets offloaded to the underlying Hardware.
Fix this by adding a notify message in such case.
Fixes: 147c1e9b902c ("switchdev: bridge: Offload multicast disabled")
Signed-off-by: Oleksandr Mazur
Acked-by: Nikolay Aleksandrov
Link: https://lore.kernel.org/r/20220215165303.31908-1-oleksandr.mazur@plvision.eu
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit c98bed60cdd7f22237ae256cc9c1c3087206b8a2
Author: Vladimir Oltean
Date: Tue Feb 15 01:42:00 2022 +0200
net: mscc: ocelot: fix use-after-free in ocelot\_vlan\_del()
commit ef57640575406f57f5b3393cf57f457b0ace837e upstream.
ocelot\_vlan\_member\_del() will free the struct ocelot\_bridge\_vlan, so if
this is the same as the port's pvid\_vlan which we access afterwards,
what we're accessing is freed memory.
Fix the bug by determining whether to clear ocelot\_port->pvid\_vlan prior
to calling ocelot\_vlan\_member\_del().
Fixes: d4004422f6f9 ("net: mscc: ocelot: track the port pvid using a pointer")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 54abd5725db8e452ef3ed5748e3cc07be10a128b
Author: Radu Bulie
Date: Mon Feb 14 19:45:34 2022 +0200
dpaa2-eth: Initialize mutex used in one step timestamping path
commit 07dd44852be89386ab12210df90a2d78779f3bff upstream.
1588 Single Step Timestamping code path uses a mutex to
enforce atomicity for two events:
- update of ptp single step register
- transmit ptp event packet
Before this patch the mutex was not initialized. This
caused unexpected crashes in the Tx function.
Fixes: c55211892f463 ("dpaa2-eth: support PTP Sync packet one-step timestamping")
Signed-off-by: Radu Bulie
Reviewed-by: Ioana Ciornei
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 554a76e7dcc9f25db75ee7eeefc85e1be424f601
Author: Tom Rix
Date: Mon Feb 14 07:41:39 2022 -0800
dpaa2-switch: fix default return of dpaa2\_switch\_flower\_parse\_mirror\_key
commit 2a36ed7c1cd55742503bed81d2cc0ea83bd0ad0c upstream.
Clang static analysis reports this representative problem
dpaa2-switch-flower.c:616:24: warning: The right operand of '=='
is a garbage value
tmp->cfg.vlan\_id == vlan) {
^ ~~~~
vlan is set in dpaa2\_switch\_flower\_parse\_mirror\_key(). However
this function can return success without setting vlan. So
change the default return to -EOPNOTSUPP.
Fixes: 0f3faece5808 ("dpaa2-switch: add VLAN based mirroring")
Signed-off-by: Tom Rix
Reviewed-by: Ioana Ciornei
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ca941e56f48e41b2fb0d74599bb9b8f1ec0a9323
Author: Jon Maloy
Date: Sun Feb 13 20:38:52 2022 -0500
tipc: fix wrong publisher node address in link publications
commit 032062f363b4bf02b1d547f329aa5d97b6a17410 upstream.
When a link comes up we add its presence to the name table to make it
possible for users to subscribe for link up/down events. However, after
a previous call signature change the binding is wrongly published with
the peer node as publishing node, instead of the own node as it should
be. This has the effect that the command 'tipc name table show' will
list the link binding (service type 2) with node scope and a peer node
as originator, something that obviously is impossible.
We correct this bug here.
Fixes: 50a3499ab853 ("tipc: simplify signature of tipc\_namtbl\_publish()")
Signed-off-by: Jon Maloy
Link: https://lore.kernel.org/r/20220214013852.2803940-1-jmaloy@redhat.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit c4c7dee21fda1c1e096f2a9aed56ee7345b0cd27
Author: Gatis Peisenieks
Date: Fri Feb 11 08:51:23 2022 +0200
atl1c: fix tx timeout after link flap on Mikrotik 10/25G NIC
commit bf8e59fd315f304eb538546e35de6dc603e4709f upstream.
If NIC had packets in tx queue at the moment link down event
happened, it could result in tx timeout when link got back up.
Since device has more than one tx queue we need to reset them
accordingly.
Fixes: 057f4af2b171 ("atl1c: add 4 RX/TX queue support for Mikrotik 10/25G NIC")
Signed-off-by: Gatis Peisenieks
Link: https://lore.kernel.org/r/20220211065123.4187615-1-gatis@mikrotik.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit bd6a09eaf34567505f7c23c87578084addcc4fdb
Author: DENG Qingfang
Date: Wed Feb 9 22:39:47 2022 +0800
net: phy: mediatek: remove PHY mode check on MT7531
commit 525b108e6d95b643eccbd84fb10aa9aa101b18dd upstream.
The function mt7531\_phy\_mode\_supported in the DSA driver set supported
mode to PHY\_INTERFACE\_MODE\_GMII instead of PHY\_INTERFACE\_MODE\_INTERNAL
for the internal PHY, so this check breaks the PHY initialization:
mt7530 mdio-bus:00 wan (uninitialized): failed to connect to PHY: -EINVAL
Remove the check to make it work again.
Reported-by: Hauke Mehrtens
Fixes: e40d2cca0189 ("net: phy: add MediaTek Gigabit Ethernet PHY driver")
Signed-off-by: DENG Qingfang
Acked-by: Arınç ÜNAL
Tested-by: Hauke Mehrtens
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f00b6c976ae0dfbd9b891175f713f59095d23842
Author: Wen Gu
Date: Wed Feb 9 22:10:53 2022 +0800
net/smc: Avoid overwriting the copies of clcsock callback functions
commit 1de9770d121ee9294794cca0e0be8fbfa0134ee8 upstream.
The callback functions of clcsock will be saved and replaced during
the fallback. But if the fallback happens more than once, then the
copies of these callback functions will be overwritten incorrectly,
resulting in a loop call issue:
clcsk->sk\_error\_report
|- smc\_fback\_error\_report() <------------------------------|
|- smc\_fback\_forward\_wakeup() | (loop)
|- clcsock\_callback() (incorrectly overwritten) |
|- smc->clcsk\_error\_report() ------------------|
So this patch fixes the issue by saving these function pointers only
once in the fallback and avoiding overwriting.
Reported-by: syzbot+4de3c0e8a263e1e499bc@syzkaller.appspotmail.com
Fixes: 341adeec9ada ("net/smc: Forward wakeup to smc socket waitqueue after fallback")
Link: https://lore.kernel.org/r/0000000000006d045e05d78776f6@google.com
Signed-off-by: Wen Gu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 754db970b075490448ce7d0a5716224339314873
Author: Kees Cook
Date: Sun Feb 13 10:24:43 2022 -0800
libsubcmd: Fix use-after-free for realloc(..., 0)
commit 52a9dab6d892763b2a8334a568bd4e2c1a6fde66 upstream.
GCC 12 correctly reports a potential use-after-free condition in the
xrealloc helper. Fix the warning by avoiding an implicit "free(ptr)"
when size == 0:
In file included from help.c:12:
In function 'xrealloc',
inlined from 'add\_cmdname' at help.c:24:2: subcmd-util.h:56:23: error: pointer may be used after 'realloc' [-Werror=use-after-free]
56 | ret = realloc(ptr, size);
| ^~~~~~~~~~~~~~~~~~
subcmd-util.h:52:21: note: call to 'realloc' here
52 | void \*ret = realloc(ptr, size);
| ^~~~~~~~~~~~~~~~~~
subcmd-util.h:58:31: error: pointer may be used after 'realloc' [-Werror=use-after-free]
58 | ret = realloc(ptr, 1);
| ^~~~~~~~~~~~~~~
subcmd-util.h:52:21: note: call to 'realloc' here
52 | void \*ret = realloc(ptr, size);
| ^~~~~~~~~~~~~~~~~~
Fixes: 2f4ce5ec1d447beb ("perf tools: Finalize subcmd independence")
Reported-by: Valdis Klētnieks
Signed-off-by: Kees Kook
Tested-by: Valdis Klētnieks
Tested-by: Justin M. Forbes
Acked-by: Josh Poimboeuf
Cc: linux-hardening@vger.kernel.org
Cc: Valdis Klētnieks
Link: http://lore.kernel.org/lkml/20220213182443.4037039-1-keescook@chromium.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 9704b5e18c17b71c8ff4e1409674ea8c202045ca
Author: Danie du Toit
Date: Thu Feb 17 14:48:20 2022 +0200
nfp: flower: netdev offload check for ip6gretap
commit 7dbcda584eaa5bdb4a281c379207dacc1a5e6081 upstream.
IPv6 GRE tunnels are not being offloaded, this is caused by a missing
netdev offload check. The functionality of IPv6 GRE tunnel offloading
was previously added but this check was not included. Adding the
ip6gretap check allows IPv6 GRE tunnels to be offloaded correctly.
Fixes: f7536ffb0986 ("nfp: flower: Allow ipv6gretap interface for offloading")
Signed-off-by: Danie du Toit
Signed-off-by: Louis Peens
Signed-off-by: Simon Horman
Link: https://lore.kernel.org/r/20220217124820.40436-1-louis.peens@corigine.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit be95a2b5064cdcf14f9254a8e09cecff65e9630c
Author: Eric Dumazet
Date: Mon Feb 14 11:15:53 2022 -0800
bonding: fix data-races around agg\_select\_timer
commit 9ceaf6f76b203682bb6100e14b3d7da4c0bedde8 upstream.
syzbot reported that two threads might write over agg\_select\_timer
at the same time. Make agg\_select\_timer atomic to fix the races.
BUG: KCSAN: data-race in bond\_3ad\_initiate\_agg\_selection / bond\_3ad\_state\_machine\_handler
read to 0xffff8881242aea90 of 4 bytes by task 1846 on cpu 1:
bond\_3ad\_state\_machine\_handler+0x99/0x2810 drivers/net/bonding/bond\_3ad.c:2317
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
worker\_thread+0x616/0xa70 kernel/workqueue.c:2454
kthread+0x1bf/0x1e0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30
write to 0xffff8881242aea90 of 4 bytes by task 25910 on cpu 0:
bond\_3ad\_initiate\_agg\_selection+0x18/0x30 drivers/net/bonding/bond\_3ad.c:1998
bond\_open+0x658/0x6f0 drivers/net/bonding/bond\_main.c:3967
\_\_dev\_open+0x274/0x3a0 net/core/dev.c:1407
dev\_open+0x54/0x190 net/core/dev.c:1443
bond\_enslave+0xcef/0x3000 drivers/net/bonding/bond\_main.c:1937
do\_set\_master net/core/rtnetlink.c:2532 [inline]
do\_setlink+0x94f/0x2500 net/core/rtnetlink.c:2736
\_\_rtnl\_newlink net/core/rtnetlink.c:3414 [inline]
rtnl\_newlink+0xfeb/0x13e0 net/core/rtnetlink.c:3529
rtnetlink\_rcv\_msg+0x745/0x7e0 net/core/rtnetlink.c:5594
netlink\_rcv\_skb+0x14e/0x250 net/netlink/af\_netlink.c:2494
rtnetlink\_rcv+0x18/0x20 net/core/rtnetlink.c:5612
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x602/0x6d0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x728/0x850 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg net/socket.c:725 [inline]
\_\_\_\_sys\_sendmsg+0x39a/0x510 net/socket.c:2413
\_\_\_sys\_sendmsg net/socket.c:2467 [inline]
\_\_sys\_sendmsg+0x195/0x230 net/socket.c:2496
\_\_do\_sys\_sendmsg net/socket.c:2505 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2503 [inline]
\_\_x64\_sys\_sendmsg+0x42/0x50 net/socket.c:2503
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
value changed: 0x00000050 -> 0x0000004f
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 25910 Comm: syz-executor.1 Tainted: G W 5.17.0-rc4-syzkaller-dirty #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Jay Vosburgh
Cc: Veaceslav Falico
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9d06f489b9e901580159e21fdc29f73df7ed08dc
Author: Eric Dumazet
Date: Sun Feb 13 11:06:07 2022 -0800
crypto: af\_alg - get rid of alg\_memory\_allocated
commit 25206111512de994dfc914f5b2972a22aa904ef3 upstream.
alg\_memory\_allocated does not seem to be really used.
alg\_proto does have a .memory\_allocated field, but no
corresponding .sysctl\_mem.
This means sk\_has\_account() returns true, but all sk\_prot\_mem\_limits()
users will trigger a NULL dereference [1].
THis was not a problem until SO\_RESERVE\_MEM addition.
general protection fault, probably for non-canonical address 0xdffffc0000000001: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000008-0x000000000000000f]
CPU: 1 PID: 3591 Comm: syz-executor153 Not tainted 5.17.0-rc3-syzkaller-00316-gb81b1829e7e3 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:sk\_prot\_mem\_limits include/net/sock.h:1523 [inline]
RIP: 0010:sock\_reserve\_memory+0x1d7/0x330 net/core/sock.c:1000
Code: 08 00 74 08 48 89 ef e8 27 20 bb f9 4c 03 7c 24 10 48 8b 6d 00 48 83 c5 08 48 89 e8 48 c1 e8 03 48 b9 00 00 00 00 00 fc ff df <80> 3c 08 00 74 08 48 89 ef e8 fb 1f bb f9 48 8b 6d 00 4c 89 ff 48
RSP: 0018:ffffc90001f1fb68 EFLAGS: 00010202
RAX: 0000000000000001 RBX: ffff88814aabc000 RCX: dffffc0000000000
RDX: 0000000000000001 RSI: 0000000000000008 RDI: ffffffff90e18120
RBP: 0000000000000008 R08: dffffc0000000000 R09: fffffbfff21c3025
R10: fffffbfff21c3025 R11: 0000000000000000 R12: ffffffff8d109840
R13: 0000000000001002 R14: 0000000000000001 R15: 0000000000000001
FS: 0000555556e08300(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc74416f130 CR3: 0000000073d9e000 CR4: 00000000003506e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
sock\_setsockopt+0x14a9/0x3a30 net/core/sock.c:1446
\_\_sys\_setsockopt+0x5af/0x980 net/socket.c:2176
\_\_do\_sys\_setsockopt net/socket.c:2191 [inline]
\_\_se\_sys\_setsockopt net/socket.c:2188 [inline]
\_\_x64\_sys\_setsockopt+0xb1/0xc0 net/socket.c:2188
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fc7440fddc9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 51 15 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 c0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe98f07968 EFLAGS: 00000246 ORIG\_RAX: 0000000000000036
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007fc7440fddc9
RDX: 0000000000000049 RSI: 0000000000000001 RDI: 0000000000000004
RBP: 0000000000000000 R08: 0000000000000004 R09: 00007ffe98f07990
R10: 0000000020000000 R11: 0000000000000246 R12: 00007ffe98f0798c
R13: 00007ffe98f079a0 R14: 00007ffe98f079e0 R15: 0000000000000000

Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:sk\_prot\_mem\_limits include/net/sock.h:1523 [inline]
RIP: 0010:sock\_reserve\_memory+0x1d7/0x330 net/core/sock.c:1000
Code: 08 00 74 08 48 89 ef e8 27 20 bb f9 4c 03 7c 24 10 48 8b 6d 00 48 83 c5 08 48 89 e8 48 c1 e8 03 48 b9 00 00 00 00 00 fc ff df <80> 3c 08 00 74 08 48 89 ef e8 fb 1f bb f9 48 8b 6d 00 4c 89 ff 48
RSP: 0018:ffffc90001f1fb68 EFLAGS: 00010202
RAX: 0000000000000001 RBX: ffff88814aabc000 RCX: dffffc0000000000
RDX: 0000000000000001 RSI: 0000000000000008 RDI: ffffffff90e18120
RBP: 0000000000000008 R08: dffffc0000000000 R09: fffffbfff21c3025
R10: fffffbfff21c3025 R11: 0000000000000000 R12: ffffffff8d109840
R13: 0000000000001002 R14: 0000000000000001 R15: 0000000000000001
FS: 0000555556e08300(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc74416f130 CR3: 0000000073d9e000 CR4: 00000000003506e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
Fixes: 2bb2f5fb21b0 ("net: add new socket option SO\_RESERVE\_MEM")
Signed-off-by: Eric Dumazet
Cc: Wei Wang
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 18b57afacdc8dc1fa0d1a3c3a15a1d5a599159fa
Author: Eric Dumazet
Date: Fri Feb 11 12:06:23 2022 -0800
net\_sched: add \_\_rcu annotation to netdev->qdisc
commit 5891cd5ec46c2c2eb6427cb54d214b149635dd0e upstream.
syzbot found a data-race [1] which lead me to add \_\_rcu
annotations to netdev->qdisc, and proper accessors
to get LOCKDEP support.
[1]
BUG: KCSAN: data-race in dev\_activate / qdisc\_lookup\_rcu
write to 0xffff888168ad6410 of 8 bytes by task 13559 on cpu 1:
attach\_default\_qdiscs net/sched/sch\_generic.c:1167 [inline]
dev\_activate+0x2ed/0x8f0 net/sched/sch\_generic.c:1221
\_\_dev\_open+0x2e9/0x3a0 net/core/dev.c:1416
\_\_dev\_change\_flags+0x167/0x3f0 net/core/dev.c:8139
rtnl\_configure\_link+0xc2/0x150 net/core/rtnetlink.c:3150
\_\_rtnl\_newlink net/core/rtnetlink.c:3489 [inline]
rtnl\_newlink+0xf4d/0x13e0 net/core/rtnetlink.c:3529
rtnetlink\_rcv\_msg+0x745/0x7e0 net/core/rtnetlink.c:5594
netlink\_rcv\_skb+0x14e/0x250 net/netlink/af\_netlink.c:2494
rtnetlink\_rcv+0x18/0x20 net/core/rtnetlink.c:5612
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x602/0x6d0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x728/0x850 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg net/socket.c:725 [inline]
\_\_\_\_sys\_sendmsg+0x39a/0x510 net/socket.c:2413
\_\_\_sys\_sendmsg net/socket.c:2467 [inline]
\_\_sys\_sendmsg+0x195/0x230 net/socket.c:2496
\_\_do\_sys\_sendmsg net/socket.c:2505 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2503 [inline]
\_\_x64\_sys\_sendmsg+0x42/0x50 net/socket.c:2503
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
read to 0xffff888168ad6410 of 8 bytes by task 13560 on cpu 0:
qdisc\_lookup\_rcu+0x30/0x2e0 net/sched/sch\_api.c:323
\_\_tcf\_qdisc\_find+0x74/0x3a0 net/sched/cls\_api.c:1050
tc\_del\_tfilter+0x1c7/0x1350 net/sched/cls\_api.c:2211
rtnetlink\_rcv\_msg+0x5ba/0x7e0 net/core/rtnetlink.c:5585
netlink\_rcv\_skb+0x14e/0x250 net/netlink/af\_netlink.c:2494
rtnetlink\_rcv+0x18/0x20 net/core/rtnetlink.c:5612
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x602/0x6d0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x728/0x850 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg net/socket.c:725 [inline]
\_\_\_\_sys\_sendmsg+0x39a/0x510 net/socket.c:2413
\_\_\_sys\_sendmsg net/socket.c:2467 [inline]
\_\_sys\_sendmsg+0x195/0x230 net/socket.c:2496
\_\_do\_sys\_sendmsg net/socket.c:2505 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2503 [inline]
\_\_x64\_sys\_sendmsg+0x42/0x50 net/socket.c:2503
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x44/0xd0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
value changed: 0xffffffff85dee080 -> 0xffff88815d96ec00
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 13560 Comm: syz-executor.2 Not tainted 5.17.0-rc3-syzkaller-00116-gf1baf68e1383-dirty #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Fixes: 470502de5bdb ("net: sched: unlock rules update API")
Signed-off-by: Eric Dumazet
Cc: Vlad Buslov
Reported-by: syzbot
Cc: Jamal Hadi Salim
Cc: Cong Wang
Cc: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 234ffe4e4854858e3a2a3a457b622bb043bc10c2
Author: Eric Dumazet
Date: Thu Feb 10 09:13:31 2022 -0800
drop\_monitor: fix data-race in dropmon\_net\_event / trace\_napi\_poll\_hit
commit dcd54265c8bc14bd023815e36e2d5f9d66ee1fee upstream.
trace\_napi\_poll\_hit() is reading stat->dev while another thread can write
on it from dropmon\_net\_event()
Use READ\_ONCE()/WRITE\_ONCE() here, RCU rules are properly enforced already,
we only have to take care of load/store tearing.
BUG: KCSAN: data-race in dropmon\_net\_event / trace\_napi\_poll\_hit
write to 0xffff88816f3ab9c0 of 8 bytes by task 20260 on cpu 1:
dropmon\_net\_event+0xb8/0x2b0 net/core/drop\_monitor.c:1579
notifier\_call\_chain kernel/notifier.c:84 [inline]
raw\_notifier\_call\_chain+0x53/0xb0 kernel/notifier.c:392
call\_netdevice\_notifiers\_info net/core/dev.c:1919 [inline]
call\_netdevice\_notifiers\_extack net/core/dev.c:1931 [inline]
call\_netdevice\_notifiers net/core/dev.c:1945 [inline]
unregister\_netdevice\_many+0x867/0xfb0 net/core/dev.c:10415
ip\_tunnel\_delete\_nets+0x24a/0x280 net/ipv4/ip\_tunnel.c:1123
vti\_exit\_batch\_net+0x2a/0x30 net/ipv4/ip\_vti.c:515
ops\_exit\_list net/core/net\_namespace.c:173 [inline]
cleanup\_net+0x4dc/0x8d0 net/core/net\_namespace.c:597
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
worker\_thread+0x616/0xa70 kernel/workqueue.c:2454
kthread+0x1bf/0x1e0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30
read to 0xffff88816f3ab9c0 of 8 bytes by interrupt on cpu 0:
trace\_napi\_poll\_hit+0x89/0x1c0 net/core/drop\_monitor.c:292
trace\_napi\_poll include/trace/events/napi.h:14 [inline]
\_\_napi\_poll+0x36b/0x3f0 net/core/dev.c:6366
napi\_poll net/core/dev.c:6432 [inline]
net\_rx\_action+0x29e/0x650 net/core/dev.c:6519
\_\_do\_softirq+0x158/0x2de kernel/softirq.c:558
do\_softirq+0xb1/0xf0 kernel/softirq.c:459
\_\_local\_bh\_enable\_ip+0x68/0x70 kernel/softirq.c:383
\_\_raw\_spin\_unlock\_bh include/linux/spinlock\_api\_smp.h:167 [inline]
\_raw\_spin\_unlock\_bh+0x33/0x40 kernel/locking/spinlock.c:210
spin\_unlock\_bh include/linux/spinlock.h:394 [inline]
ptr\_ring\_consume\_bh include/linux/ptr\_ring.h:367 [inline]
wg\_packet\_decrypt\_worker+0x73c/0x780 drivers/net/wireguard/receive.c:506
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
worker\_thread+0x616/0xa70 kernel/workqueue.c:2454
kthread+0x1bf/0x1e0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30
value changed: 0xffff88815883e000 -> 0x0000000000000000
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 26435 Comm: kworker/0:1 Not tainted 5.17.0-rc1-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: wg-crypt-wg2 wg\_packet\_decrypt\_worker
Fixes: 4ea7e38696c7 ("dropmon: add ability to detect when hardware dropsrxpackets")
Signed-off-by: Eric Dumazet
Cc: Neil Horman
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1dd3ecbec5f606b2a526c47925c8634b1a6bb81e
Author: Tom Rix
Date: Mon Feb 14 18:05:41 2022 -0800
mctp: fix use after free
commit 7e5b6a5c8c44310784c88c1c198dde79f6402f7b upstream.
Clang static analysis reports this problem
route.c:425:4: warning: Use of memory after it is freed
trace\_mctp\_key\_acquire(key);
^~~~~~~~~~~~~~~~~~~~~~~~~~~
When mctp\_key\_add() fails, key is freed but then is later
used in trace\_mctp\_key\_acquire(). Add an else statement
to use the key only when mctp\_key\_add() is successful.
Fixes: 4f9e1ba6de45 ("mctp: Add tracepoints for tag/key handling")
Signed-off-by: Tom Rix
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ea1f85fa2cb77360ee1460aa4ccb4eb204947c64
Author: Zhang Changzhong
Date: Wed Feb 16 22:18:08 2022 +0800
bonding: force carrier update when releasing slave
commit a6ab75cec1e461f8a35559054c146c21428430b8 upstream.
In \_\_bond\_release\_one(), bond\_set\_carrier() is only called when bond
device has no slave. Therefore, if we remove the up slave from a master
with two slaves and keep the down slave, the master will remain up.
Fix this by moving bond\_set\_carrier() out of if (!bond\_has\_slaves(bond))
statement.
Reproducer:
$ insmod bonding.ko mode=0 miimon=100 max\_bonds=2
$ ifconfig bond0 up
$ ifenslave bond0 eth0 eth1
$ ifconfig eth0 down
$ ifenslave -d bond0 eth1
$ cat /proc/net/bonding/bond0
Fixes: ff59c4563a8d ("[PATCH] bonding: support carrier state for master")
Signed-off-by: Zhang Changzhong
Acked-by: Jay Vosburgh
Link: https://lore.kernel.org/r/1645021088-38370-1-git-send-email-zhangchangzhong@huawei.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 092dc9d6876133ca84fb49cf610786f59e49cf68
Author: Xin Long
Date: Wed Feb 16 00:20:52 2022 -0500
ping: fix the dif and sdif check in ping\_lookup
commit 35a79e64de29e8d57a5989aac57611c0cd29e13e upstream.
When 'ping' changes to use PING socket instead of RAW socket by:
# sysctl -w net.ipv4.ping\_group\_range="0 100"
There is another regression caused when matching sk\_bound\_dev\_if
and dif, RAW socket is using inet\_iif() while PING socket lookup
is using skb->dev->ifindex, the cmd below fails due to this:
# ip link add dummy0 type dummy
# ip link set dummy0 up
# ip addr add 192.168.111.1/24 dev dummy0
# ping -I dummy0 192.168.111.1 -c1
The issue was also reported on:
https://github.com/iputils/iputils/issues/104
But fixed in iputils in a wrong way by not binding to device when
destination IP is on device, and it will cause some of kselftests
to fail, as Jianlin noticed.
This patch is to use inet(6)\_iif and inet(6)\_sdif to get dif and
sdif for PING socket, and keep consistent with RAW socket.
Fixes: c319b4d76b9e ("net: ipv4: add IPPROTO\_ICMP socket kind")
Reported-by: Jianlin Shi
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0268fec09bfa27934bfdd12e9f38435d50a6188e
Author: Miquel Raynal
Date: Tue Feb 1 19:06:26 2022 +0100
net: ieee802154: ca8210: Fix lifs/sifs periods
commit bdc120a2bcd834e571ce4115aaddf71ab34495de upstream.
These periods are expressed in time units (microseconds) while 40 and 12
are the number of symbol durations these periods will last. We need to
multiply them both with the symbol\_duration in order to get these
values in microseconds.
Fixes: ded845a781a5 ("ieee802154: Add CA8210 IEEE 802.15.4 device driver")
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/r/20220201180629.93410-2-miquel.raynal@bootlin.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit d8a5a3d7f4ce8dc4142893f56d06201ead4a862b
Author: Mans Rullgard
Date: Wed Feb 16 20:48:18 2022 +0000
net: dsa: lan9303: add VLAN IDs to master device
commit 430065e2671905ac675f97b7af240cc255964e93 upstream.
If the master device does VLAN filtering, the IDs used by the switch
must be added for any frames to be received. Do this in the
port\_enable() function, and remove them in port\_disable().
Fixes: a1292595e006 ("net: dsa: add new DSA switch driver for the SMSC-LAN9303")
Signed-off-by: Mans Rullgard
Reviewed-by: Florian Fainelli
Reviewed-by: Vladimir Oltean
Link: https://lore.kernel.org/r/20220216204818.28746-1-mans@mansr.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit a960e6d6499af56244047472bef1b89d57b2c9ed
Author: Mans Rullgard
Date: Wed Feb 16 12:46:34 2022 +0000
net: dsa: lan9303: handle hwaccel VLAN tags
commit 017b355bbdc6620fd8fe05fe297f553ce9d855ee upstream.
Check for a hwaccel VLAN tag on rx and use it if present. Otherwise,
use \_\_skb\_vlan\_pop() like the other tag parsers do. This fixes the case
where the VLAN tag has already been consumed by the master.
Fixes: a1292595e006 ("net: dsa: add new DSA switch driver for the SMSC-LAN9303")
Signed-off-by: Mans Rullgard
Reviewed-by: Vladimir Oltean
Link: https://lore.kernel.org/r/20220216124634.23123-1-mans@mansr.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit c61f599b8d33adfa256126a6695c734c0de331cb
Author: Alexey Khoroshilov
Date: Tue Feb 15 13:42:48 2022 +0300
net: dsa: lantiq\_gswip: fix use after free in gswip\_remove()
commit 8c6ae46150a453f8ae9a6cd49b45f354f478587d upstream.
of\_node\_put(priv->ds->slave\_mii\_bus->dev.of\_node) should be
done before mdiobus\_free(priv->ds->slave\_mii\_bus).
Signed-off-by: Alexey Khoroshilov
Fixes: 0d120dfb5d67 ("net: dsa: lantiq\_gswip: don't use devres for mdiobus")
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/1644921768-26477-1-git-send-email-khoroshilov@ispras.ru
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit b9bbab40939c0dcdc130cef2c11fdf0f411790aa
Author: Vladimir Oltean
Date: Fri Feb 11 19:45:06 2022 +0200
net: dsa: mv88e6xxx: flush switchdev FDB workqueue before removing VLAN
commit a2614140dc0f467a83aa3bb4b6ee2d6480a76202 upstream.
mv88e6xxx is special among DSA drivers in that it requires the VTU to
contain the VID of the FDB entry it modifies in
mv88e6xxx\_port\_db\_load\_purge(), otherwise it will return -EOPNOTSUPP.
Sometimes due to races this is not always satisfied even if external
code does everything right (first deletes the FDB entries, then the
VLAN), because DSA commits to hardware FDB entries asynchronously since
commit c9eb3e0f8701 ("net: dsa: Add support for learning FDB through
notification").
Therefore, the mv88e6xxx driver must close this race condition by
itself, by asking DSA to flush the switchdev workqueue of any FDB
deletions in progress, prior to exiting a VLAN.
Fixes: c9eb3e0f8701 ("net: dsa: Add support for learning FDB through notification")
Reported-by: Rafael Richter
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d37f10f6665d8bb4beea00deca48ae8f38f1dc9b
Author: Mans Rullgard
Date: Wed Feb 9 14:54:54 2022 +0000
net: dsa: lan9303: fix reset on probe
commit 6bb9681a43f34f2cab4aad6e2a02da4ce54d13c5 upstream.
The reset input to the LAN9303 chip is active low, and devicetree
gpio handles reflect this. Therefore, the gpio should be requested
with an initial state of high in order for the reset signal to be
asserted. Other uses of the gpio already use the correct polarity.
Fixes: a1292595e006 ("net: dsa: add new DSA switch driver for the SMSC-LAN9303")
Signed-off-by: Mans Rullgard
Reviewed-by: Andrew Lunn
Reviewed-by: Florian Fianelil
Link: https://lore.kernel.org/r/20220209145454.19749-1-mans@mansr.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit c979f792a2baf6d0f3419587668a1a6eba46a3d2
Author: Johannes Berg
Date: Tue Feb 1 14:09:51 2022 +0100
cfg80211: fix race in netlink owner interface destruction
commit f0a6fd1527067da537e9c48390237488719948ed upstream.
My previous fix here to fix the deadlock left a race where
the exact same deadlock (see the original commit referenced
below) can still happen if cfg80211\_destroy\_ifaces() already
runs while nl80211\_netlink\_notify() is still marking some
interfaces as nl\_owner\_dead.
The race happens because we have two loops here - first we
dev\_close() all the netdevs, and then we destroy them. If we
also have two netdevs (first one need only be a wdev though)
then we can find one during the first iteration, close it,
and go to the second iteration -- but then find two, and try
to destroy also the one we didn't close yet.
Fix this by only iterating once.
Reported-by: Toke Høiland-Jørgensen
Fixes: ea6b2098dd02 ("cfg80211: fix locking in netlink owner interface destruction")
Tested-by: Toke Høiland-Jørgensen
Link: https://lore.kernel.org/r/20220201130951.22093-1-johannes@sipsolutions.net
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit ebeba9791f6261b710121d2d57958f0ec903319f
Author: Phil Elwell
Date: Tue Jan 18 15:45:14 2022 +0000
brcmfmac: firmware: Fix crash in brcm\_alt\_fw\_path
commit 665408f4c3a5c83e712871daa062721624b2b79e upstream.
The call to brcm\_alt\_fw\_path in brcmf\_fw\_get\_firmwares is not protected
by a check to the validity of the fwctx->req->board\_type pointer. This
results in a crash in strlcat when, for example, the WLAN chip is found
in a USB dongle.
Prevent the crash by adding the necessary check.
See: https://github.com/raspberrypi/linux/issues/4833
Fixes: 5ff013914c62 ("brcmfmac: firmware: Allow per-board firmware binaries")
Signed-off-by: Phil Elwell
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20220118154514.3245524-1-phil@raspberrypi.com
Signed-off-by: Greg Kroah-Hartman
commit ee67ed34baee97848a2b510a8ef702205cf6bdc6
Author: Jiasheng Jiang
Date: Wed Jan 5 16:15:59 2022 +0800
mac80211: mlme: check for null after calling kmemdup
commit a72c01a94f1d285a274219d36e2a17b4846c0615 upstream.
As the possible failure of the alloc, the ifmgd->assoc\_req\_ies might be
NULL pointer returned from kmemdup().
Therefore it might be better to free the skb and return error in order
to fail the association, like ieee80211\_assoc\_success().
Also, the caller, ieee80211\_do\_assoc(), needs to deal with the return
value from ieee80211\_send\_assoc().
Fixes: 4d9ec73d2b78 ("cfg80211: Report Association Request frame IEs in association events")
Signed-off-by: Jiasheng Jiang
Link: https://lore.kernel.org/r/20220105081559.2387083-1-jiasheng@iscas.ac.cn
[fix some paths to be errors, not success]
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit a181e663b29291b87dd1f036b05ea1df2b37c4ed
Author: Jonas Gorski
Date: Wed Feb 16 10:46:34 2022 -0800
Revert "net: ethernet: bgmac: Use devm\_platform\_ioremap\_resource\_byname"
commit 6aba04ee3263669b335458c4cf4c7d97d6940229 upstream.
This reverts commit 3710e80952cf2dc48257ac9f145b117b5f74e0a5.
Since idm\_base and nicpm\_base are still optional resources not present
on all platforms, this breaks the driver for everything except Northstar
2 (which has both).
The same change was already reverted once with 755f5738ff98 ("net:
broadcom: fix a mistake about ioremap resource").
So let's do it again.
Fixes: 3710e80952cf ("net: ethernet: bgmac: Use devm\_platform\_ioremap\_resource\_byname")
Signed-off-by: Jonas Gorski
[florian: Added comments to explain the resources are optional]
Signed-off-by: Florian Fainelli
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20220216184634.2032460-1-f.fainelli@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 3cef0e916ebc9a07c9504dbecdc501cf607b2fa2
Author: Willem de Bruijn
Date: Tue Feb 15 11:00:37 2022 -0500
ipv6: per-netns exclusive flowlabel checks
commit 0b0dff5b3b98c5c7ce848151df9da0b3cdf0cc8b upstream.
Ipv6 flowlabels historically require a reservation before use.
Optionally in exclusive mode (e.g., user-private).
Commit 59c820b2317f ("ipv6: elide flowlabel check if no exclusive
leases exist") introduced a fastpath that avoids this check when no
exclusive leases exist in the system, and thus any flowlabel use
will be granted.
That allows skipping the control operation to reserve a flowlabel
entirely. Though with a warning if the fast path fails:
This is an optimization. Robust applications still have to revert to
requesting leases if the fast path fails due to an exclusive lease.
Still, this is subtle. Better isolate network namespaces from each
other. Flowlabels are per-netns. Also record per-netns whether
exclusive leases are in use. Then behavior does not change based on
activity in other netns.
Changes
v2
- wrap in IS\_ENABLED(CONFIG\_IPV6) to avoid breakage if disabled
Fixes: 59c820b2317f ("ipv6: elide flowlabel check if no exclusive leases exist")
Link: https://lore.kernel.org/netdev/MWHPR2201MB1072BCCCFCE779E4094837ACD0329@MWHPR2201MB1072.namprd22.prod.outlook.com/
Reported-by: Congyu Liu
Signed-off-by: Willem de Bruijn
Tested-by: Congyu Liu
Link: https://lore.kernel.org/r/20220215160037.1976072-1-willemdebruijn.kernel@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 27f567c84f446048670376827e356f9c92033bf9
Author: Ignat Korchagin
Date: Fri Feb 11 17:30:42 2022 +0000
ipv6: mcast: use rcu-safe version of ipv6\_get\_lladdr()
commit 26394fc118d6115390bd5b3a0fb17096271da227 upstream.
Some time ago 8965779d2c0e ("ipv6,mcast: always hold idev->lock before mca\_lock")
switched ipv6\_get\_lladdr() to \_\_ipv6\_get\_lladdr(), which is rcu-unsafe
version. That was OK, because idev->lock was held for these codepaths.
In 88e2ca308094 ("mld: convert ifmcaddr6 to RCU") these external locks were
removed, so we probably need to restore the original rcu-safe call.
Otherwise, we occasionally get a machine crashed/stalled with the following
in dmesg:
[ 3405.966610][T230589] general protection fault, probably for non-canonical address 0xdead00000000008c: 0000 [#1] SMP NOPTI
[ 3405.982083][T230589] CPU: 44 PID: 230589 Comm: kworker/44:3 Tainted: G O 5.15.19-cloudflare-2022.2.1 #1
[ 3405.998061][T230589] Hardware name: SUPA-COOL-SERV
[ 3406.009552][T230589] Workqueue: mld mld\_ifc\_work
[ 3406.017224][T230589] RIP: 0010:\_\_ipv6\_get\_lladdr+0x34/0x60
[ 3406.025780][T230589] Code: 57 10 48 83 c7 08 48 89 e5 48 39 d7 74 3e 48 8d 82 38 ff ff ff eb 13 48 8b 90 d0 00 00 00 48 8d 82 38 ff ff ff 48 39 d7 74 22 <66> 83 78 32 20 77 1b 75 e4 89 ca 23 50 2c 75 dd 48 8b 50 08 48 8b
[ 3406.055748][T230589] RSP: 0018:ffff94e4b3fc3d10 EFLAGS: 00010202
[ 3406.065617][T230589] RAX: dead00000000005a RBX: ffff94e4b3fc3d30 RCX: 0000000000000040
[ 3406.077477][T230589] RDX: dead000000000122 RSI: ffff94e4b3fc3d30 RDI: ffff8c3a31431008
[ 3406.089389][T230589] RBP: ffff94e4b3fc3d10 R08: 0000000000000000 R09: 0000000000000000
[ 3406.101445][T230589] R10: ffff8c3a31430000 R11: 000000000000000b R12: ffff8c2c37887100
[ 3406.113553][T230589] R13: ffff8c3a39537000 R14: 00000000000005dc R15: ffff8c3a31431000
[ 3406.125730][T230589] FS: 0000000000000000(0000) GS:ffff8c3b9fc80000(0000) knlGS:0000000000000000
[ 3406.138992][T230589] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 3406.149895][T230589] CR2: 00007f0dfea1db60 CR3: 000000387b5f2000 CR4: 0000000000350ee0
[ 3406.162421][T230589] Call Trace:
[ 3406.170235][T230589]
[ 3406.177736][T230589] mld\_newpack+0xfe/0x1a0
[ 3406.186686][T230589] add\_grhead+0x87/0xa0
[ 3406.195498][T230589] add\_grec+0x485/0x4e0
[ 3406.204310][T230589] ? newidle\_balance+0x126/0x3f0
[ 3406.214024][T230589] mld\_ifc\_work+0x15d/0x450
[ 3406.223279][T230589] process\_one\_work+0x1e6/0x380
[ 3406.232982][T230589] worker\_thread+0x50/0x3a0
[ 3406.242371][T230589] ? rescuer\_thread+0x360/0x360
[ 3406.252175][T230589] kthread+0x127/0x150
[ 3406.261197][T230589] ? set\_kthread\_struct+0x40/0x40
[ 3406.271287][T230589] ret\_from\_fork+0x22/0x30
[ 3406.280812][T230589]
[ 3406.288937][T230589] Modules linked in: ... [last unloaded: kheaders]
[ 3406.476714][T230589] ---[ end trace 3525a7655f2f3b9e ]---
Fixes: 88e2ca308094 ("mld: convert ifmcaddr6 to RCU")
Reported-by: David Pinilla Caparros
Signed-off-by: Ignat Korchagin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d5e80a1840121ba727e1ca92c2cc4234e2390d2b
Author: Eric Dumazet
Date: Wed Feb 16 09:32:17 2022 -0800
ipv6: fix data-race in fib6\_info\_hw\_flags\_set / fib6\_purge\_rt
commit d95d6320ba7a51d61c097ffc3bcafcf70283414e upstream.
Because fib6\_info\_hw\_flags\_set() is called without any synchronization,
all accesses to gi6->offload, fi->trap and fi->offload\_failed
need some basic protection like READ\_ONCE()/WRITE\_ONCE().
BUG: KCSAN: data-race in fib6\_info\_hw\_flags\_set / fib6\_purge\_rt
read to 0xffff8881087d5886 of 1 bytes by task 13953 on cpu 0:
fib6\_drop\_pcpu\_from net/ipv6/ip6\_fib.c:1007 [inline]
fib6\_purge\_rt+0x4f/0x580 net/ipv6/ip6\_fib.c:1033
fib6\_del\_route net/ipv6/ip6\_fib.c:1983 [inline]
fib6\_del+0x696/0x890 net/ipv6/ip6\_fib.c:2028
\_\_ip6\_del\_rt net/ipv6/route.c:3876 [inline]
ip6\_del\_rt+0x83/0x140 net/ipv6/route.c:3891
\_\_ipv6\_dev\_ac\_dec+0x2b5/0x370 net/ipv6/anycast.c:374
ipv6\_dev\_ac\_dec net/ipv6/anycast.c:387 [inline]
\_\_ipv6\_sock\_ac\_close+0x141/0x200 net/ipv6/anycast.c:207
ipv6\_sock\_ac\_close+0x79/0x90 net/ipv6/anycast.c:220
inet6\_release+0x32/0x50 net/ipv6/af\_inet6.c:476
\_\_sock\_release net/socket.c:650 [inline]
sock\_close+0x6c/0x150 net/socket.c:1318
\_\_fput+0x295/0x520 fs/file\_table.c:280
\_\_\_\_fput+0x11/0x20 fs/file\_table.c:313
task\_work\_run+0x8e/0x110 kernel/task\_work.c:164
tracehook\_notify\_resume include/linux/tracehook.h:189 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:175 [inline]
exit\_to\_user\_mode\_prepare+0x160/0x190 kernel/entry/common.c:207
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:289 [inline]
syscall\_exit\_to\_user\_mode+0x20/0x40 kernel/entry/common.c:300
do\_syscall\_64+0x50/0xd0 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
write to 0xffff8881087d5886 of 1 bytes by task 1912 on cpu 1:
fib6\_info\_hw\_flags\_set+0x155/0x3b0 net/ipv6/route.c:6230
nsim\_fib6\_rt\_hw\_flags\_set drivers/net/netdevsim/fib.c:668 [inline]
nsim\_fib6\_rt\_add drivers/net/netdevsim/fib.c:691 [inline]
nsim\_fib6\_rt\_insert drivers/net/netdevsim/fib.c:756 [inline]
nsim\_fib6\_event drivers/net/netdevsim/fib.c:853 [inline]
nsim\_fib\_event drivers/net/netdevsim/fib.c:886 [inline]
nsim\_fib\_event\_work+0x284f/0x2cf0 drivers/net/netdevsim/fib.c:1477
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
worker\_thread+0x616/0xa70 kernel/workqueue.c:2454
kthread+0x2c7/0x2e0 kernel/kthread.c:327
ret\_from\_fork+0x1f/0x30
value changed: 0x22 -> 0x2a
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 1912 Comm: kworker/1:3 Not tainted 5.16.0-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: events nsim\_fib\_event\_work
Fixes: 0c5fcf9e249e ("IPv6: Add "offload failed" indication to routes")
Fixes: bb3c4ab93e44 ("ipv6: Add "offload" and "trap" indications to routes")
Signed-off-by: Eric Dumazet
Cc: Amit Cohen
Cc: Ido Schimmel
Reported-by: syzbot
Link: https://lore.kernel.org/r/20220216173217.3792411-2-eric.dumazet@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 7ab65ea30c174e3a7e1bb4fe9cd92cc2625002e7
Author: Eric Dumazet
Date: Wed Feb 16 09:32:16 2022 -0800
ipv4: fix data races in fib\_alias\_hw\_flags\_set
commit 9fcf986cc4bc6a3a39f23fbcbbc3a9e52d3c24fd upstream.
fib\_alias\_hw\_flags\_set() can be used by concurrent threads,
and is only RCU protected.
We need to annotate accesses to following fields of struct fib\_alias:
offload, trap, offload\_failed
Because of READ\_ONCE()WRITE\_ONCE() limitations, make these
field u8.
BUG: KCSAN: data-race in fib\_alias\_hw\_flags\_set / fib\_alias\_hw\_flags\_set
read to 0xffff888134224a6a of 1 bytes by task 2013 on cpu 1:
fib\_alias\_hw\_flags\_set+0x28a/0x470 net/ipv4/fib\_trie.c:1050
nsim\_fib4\_rt\_hw\_flags\_set drivers/net/netdevsim/fib.c:350 [inline]
nsim\_fib4\_rt\_add drivers/net/netdevsim/fib.c:367 [inline]
nsim\_fib4\_rt\_insert drivers/net/netdevsim/fib.c:429 [inline]
nsim\_fib4\_event drivers/net/netdevsim/fib.c:461 [inline]
nsim\_fib\_event drivers/net/netdevsim/fib.c:881 [inline]
nsim\_fib\_event\_work+0x1852/0x2cf0 drivers/net/netdevsim/fib.c:1477
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
process\_scheduled\_works kernel/workqueue.c:2370 [inline]
worker\_thread+0x7df/0xa70 kernel/workqueue.c:2456
kthread+0x1bf/0x1e0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30
write to 0xffff888134224a6a of 1 bytes by task 4872 on cpu 0:
fib\_alias\_hw\_flags\_set+0x2d5/0x470 net/ipv4/fib\_trie.c:1054
nsim\_fib4\_rt\_hw\_flags\_set drivers/net/netdevsim/fib.c:350 [inline]
nsim\_fib4\_rt\_add drivers/net/netdevsim/fib.c:367 [inline]
nsim\_fib4\_rt\_insert drivers/net/netdevsim/fib.c:429 [inline]
nsim\_fib4\_event drivers/net/netdevsim/fib.c:461 [inline]
nsim\_fib\_event drivers/net/netdevsim/fib.c:881 [inline]
nsim\_fib\_event\_work+0x1852/0x2cf0 drivers/net/netdevsim/fib.c:1477
process\_one\_work+0x3f6/0x960 kernel/workqueue.c:2307
process\_scheduled\_works kernel/workqueue.c:2370 [inline]
worker\_thread+0x7df/0xa70 kernel/workqueue.c:2456
kthread+0x1bf/0x1e0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30
value changed: 0x00 -> 0x02
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 4872 Comm: kworker/0:0 Not tainted 5.17.0-rc3-syzkaller-00188-g1d41d2e82623-dirty #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: events nsim\_fib\_event\_work
Fixes: 90b93f1b31f8 ("ipv4: Add "offload" and "trap" indications to routes")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Reviewed-by: Ido Schimmel
Link: https://lore.kernel.org/r/20220216173217.3792411-1-eric.dumazet@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 3c6c41ec991e8a7fff36bfa36c80c164aba33995
Author: Hangbin Liu
Date: Thu Feb 10 17:50:56 2022 +0800
selftests: netfilter: disable rp\_filter on router
commit bbe4c0896d25009a7c86285d2ab024eed4374eea upstream.
Some distros may enable rp\_filter by default. After ns1 change addr to
10.0.2.99 and set default router to 10.0.2.1, while the connected router
address is still 10.0.1.1. The router will not reply the arp request
from ns1. Fix it by setting the router's veth0 rp\_filter to 0.
Before the fix:
# ./nft\_fib.sh
PASS: fib expression did not cause unwanted packet drops
Netns nsrouter-HQkDORO2 fib counter doesn't match expected packet count of 1 for 1.1.1.1
table inet filter {
chain prerouting {
type filter hook prerouting priority filter; policy accept;
ip daddr 1.1.1.1 fib saddr . iif oif missing counter packets 0 bytes 0 drop
ip6 daddr 1c3::c01d fib saddr . iif oif missing counter packets 0 bytes 0 drop
}
}
After the fix:
# ./nft\_fib.sh
PASS: fib expression did not cause unwanted packet drops
PASS: fib expression did drop packets for 1.1.1.1
PASS: fib expression did drop packets for 1c3::c01d
Fixes: 82944421243e ("selftests: netfilter: add fib test case")
Signed-off-by: Yi Chen
Signed-off-by: Hangbin Liu
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 303679a39c72986d895aae668fa34a7dbf8da2a8
Author: Pablo Neira Ayuso
Date: Thu Feb 10 10:06:42 2022 +0100
netfilter: nft\_synproxy: unregister hooks on init error path
commit 2b4e5fb4d3776c391e40fb33673ba946dd96012d upstream.
Disable the IPv4 hooks if the IPv6 hooks fail to be registered.
Fixes: ad49d86e07a4 ("netfilter: nf\_tables: Add synproxy support")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 5d0bc1ff054a54e3200982250161f257cbb31480
Author: Hangbin Liu
Date: Wed Feb 9 16:25:51 2022 +0800
selftests: netfilter: fix exit value for nft\_concat\_range
commit 2e71ec1a725a794a16e3862791ed43fe5ba6a06b upstream.
When the nft\_concat\_range test failed, it exit 1 in the code
specifically.
But when part of, or all of the test passed, it will failed the
[ ${passed} -eq 0 ] check and thus exit with 1, which is the same
exit value with failure result. Fix it by exit 0 when passed is not 0.
Fixes: 611973c1e06f ("selftests: netfilter: Introduce tests for sets with range concatenation")
Signed-off-by: Hangbin Liu
Reviewed-by: Stefano Brivio
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 09117ad796a073a0fef0809a408c3562109943a2
Author: Luca Coelho
Date: Fri Jan 28 14:48:51 2022 +0200
iwlwifi: mvm: don't send SAR GEO command for 3160 devices
commit 5f06f6bf8d816578c390a2b8a485d40adcca4749 upstream.
SAR GEO offsets are not supported on 3160 devices. The code was
refactored and caused us to start sending the command anyway, which
causes a FW assertion failure. Fix that only considering this feature
supported on FW API with major version is 17 if the device is not
3160.
Additionally, fix the caller of iwl\_mvm\_sar\_geo\_init() so that it
checks for the return value, which it was ignoring.
Reported-by: Len Brown
Signed-off-by: Luca Coelho
Fixes: 78a19d5285d9 ("iwlwifi: mvm: Read the PPAG and SAR tables at INIT stage")
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20220128144623.96f683a89b42.I14e2985bfd7ddd8a8d83eb1869b800c0e7f30db4@changeid
Signed-off-by: Greg Kroah-Hartman
commit d4e1375e07f5f999e088b1bdacf68f47ef11e5d9
Author: Miri Korenblit
Date: Fri Jan 28 14:30:51 2022 +0200
iwlwifi: fix iwl\_legacy\_rate\_to\_fw\_idx
commit 973f02c932b0be41a26bb9bdf38b7b92721611d2 upstream.
There are a couple of bugs in this function:
1. It is declared as a non-static function, even though
it's only used in one file.
2. Its return value should be of type u32 but it returns
(in some cases) -1.
Fix them by making this function static and returning an
error value of type unsigned.
In addition, we're assigning the return value of this function
as the legacy rate even if the function returned an error value.
Fix this by assigning the lowest rate in this case.
Signed-off-by: Miri Korenblit
Reported-by: Ye Guojin
Reported-by: Zeal Robot
Fixes: 9998f81e4ba5 ("iwlwifi: mvm: convert old rate & flags to the new format.")
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20220128142706.5612eeb9d6d0.I992e10d93fc22919b2bc42daad087ee1b5d6f014@changeid
Signed-off-by: Greg Kroah-Hartman
commit e1c236ffdc9b0c006bed766d5df26167360f69c8
Author: Miri Korenblit
Date: Fri Jan 28 14:30:50 2022 +0200
iwlwifi: mvm: fix condition which checks the version of rate\_n\_flags
commit be8287c9b8326d767429c8371bbc78b33f6efe13 upstream.
We're checking the FW version of TX\_CMD in order to decide whether to
convert rate\_n\_flags from the old format to the new one. If the API
is smaller or equal to 6 we should convert it. Currently we're
converting if the API version is greater than 6. Fix it.
Signed-off-by: Miri Korenblit
Fixes: dc52fac37c87 ("iwlwifi: mvm: Support new TX\_RSP and COMPRESSED\_BA\_RES versions")
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20220128142706.a264ac51d106.I228ba1317cdcbfef931c09d280d701fcad9048d2@changeid
Signed-off-by: Greg Kroah-Hartman
commit e3e1669fff2e12b11d921d25e6ca9cf1f32a51ad
Author: Johannes Berg
Date: Fri Jan 28 14:30:53 2022 +0200
iwlwifi: pcie: gen2: fix locking when "HW not ready"
commit 4c29c1e27a1e178a219b3877d055e6dd643bdfda upstream.
If we run into this error path, we shouldn't unlock the mutex
since it's not locked since. Fix this in the gen2 code as well.
Fixes: eda50cde58de ("iwlwifi: pcie: add context information support")
Signed-off-by: Johannes Berg
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20220128142706.b8b0dfce16ef.Ie20f0f7b23e5911350a2766524300d2915e7b677@changeid
Signed-off-by: Greg Kroah-Hartman
commit 142d79d846ad1b4de39f3a0d02b133123174061a
Author: Johannes Berg
Date: Fri Jan 28 14:30:52 2022 +0200
iwlwifi: pcie: fix locking when "HW not ready"
commit e9848aed147708a06193b40d78493b0ef6abccf2 upstream.
If we run into this error path, we shouldn't unlock the mutex
since it's not locked since. Fix this.
Fixes: a6bd005fe92d ("iwlwifi: pcie: fix RF-Kill vs. firmware load race")
Signed-off-by: Johannes Berg
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20220128142706.5d16821d1433.Id259699ddf9806459856d6aefbdbe54477aecffd@changeid
Signed-off-by: Greg Kroah-Hartman
commit 1f933389a56ae56c6beef1c4441380d49e4d9e15
Author: Matthew Auld
Date: Wed Feb 9 11:16:52 2022 +0000
drm/i915/ttm: tweak priority hint selection
commit 0bdc0a0699929c814a8aecd55d2accb8c11beae2 upstream.
For some reason we are selecting PRIO\_HAS\_PAGES when we don't have
mm.pages, and vice versa.
v2(Thomas):
- Add missing fixes tag
Fixes: 213d50927763 ("drm/i915/ttm: Introduce a TTM i915 gem object backend")
Signed-off-by: Matthew Auld
Cc: Thomas Hellström
Reviewed-by: Thomas Hellström
Link: https://patchwork.freedesktop.org/patch/msgid/20220209111652.468762-1-matthew.auld@intel.com
(cherry picked from commit ba2c5d15022a565da187d90e2fe44768e33e5034)
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Greg Kroah-Hartman
commit 483d2a0bf3591a32a9b286570da0cef164e2bd9a
Author: Siva Mullati
Date: Fri Jan 7 15:22:35 2022 +0530
drm/i915/gvt: Make DRM\_I915\_GVT depend on X86
commit d72d69abfdb6e0375981cfdda8eb45143f12c77d upstream.
GVT is not supported on non-x86 platforms, So add
dependency of X86 on config parameter DRM\_I915\_GVT.
Fixes: 0ad35fed618c ("drm/i915: gvt: Introduce the basic architecture of GVT-g")
Signed-off-by: Siva Mullati
Signed-off-by: Zhi Wang
Link: http://patchwork.freedesktop.org/patch/msgid/20220107095235.243448-1-siva.mullati@intel.com
Reviewed-by: Zhi Wang
Signed-off-by: Zhi Wang
Signed-off-by: Greg Kroah-Hartman
commit 4229a20955127e95bbe20876434d24ed3d4bf354
Author: Robin Murphy
Date: Wed Oct 13 10:36:54 2021 -0400
drm/cma-helper: Set VM\_DONTEXPAND for mmap
commit 59f39bfa6553d598cb22f694d45e89547f420d85 upstream.
drm\_gem\_cma\_mmap() cannot assume every implementation of dma\_mmap\_wc()
will end up calling remap\_pfn\_range() (which happens to set the relevant
vma flag, among others), so in order to make sure expectations around
VM\_DONTEXPAND are met, let it explicitly set the flag like most other
GEM mmap implementations do.
This avoids repeated warnings on a small minority of systems where the
display is behind an IOMMU, and has a simple driver which does not
override drm\_gem\_cma\_default\_funcs. Arm hdlcd is an in-tree affected
driver. Out-of-tree, the Apple DCP driver is affected; this fix is
required for DCP to be mainlined.
[Alyssa: Update commit message.]
Fixes: c40069cb7bd6 ("drm: add mmap() to drm\_gem\_object\_funcs")
Acked-by: Daniel Vetter
Signed-off-by: Robin Murphy
Signed-off-by: Alyssa Rosenzweig
Link: https://patchwork.freedesktop.org/patch/msgid/20211013143654.39031-1-alyssa@rosenzweig.io
Signed-off-by: Greg Kroah-Hartman
commit f333857e0f857d69aea6c1fb49fbfb7cfdb69b1b
Author: Jens Wiklander
Date: Thu Jan 27 15:29:39 2022 +0100
optee: use driver internal tee\_context for some rpc
commit aceeafefff736057e8f93f19bbfbef26abd94604 upstream.
Adds a driver private tee\_context by moving the tee\_context in struct
optee\_notif to struct optee. This tee\_context was previously used when
doing internal calls to secure world to deliver notification.
The new driver internal tee\_context is now also when allocating driver
private shared memory. This decouples the shared memory object from its
original tee\_context. This is needed when the life time of such a memory
allocation outlives the client tee\_context.
This patch fixes the problem described below:
The addition of a shutdown hook by commit f25889f93184 ("optee: fix tee out
of memory failure seen during kexec reboot") introduced a kernel shutdown
regression that can be triggered after running the OP-TEE xtest suites.
Once the shutdown hook is called it is not possible to communicate any more
with the supplicant process because the system is not scheduling task any
longer. Thus if the optee driver shutdown path receives a supplicant RPC
request from the OP-TEE we will deadlock the kernel's shutdown.
Fixes: f25889f93184 ("optee: fix tee out of memory failure seen during kexec reboot")
Fixes: 217e0250cccb ("tee: use reference counting for tee\_context")
Reported-by: Lars Persson
Cc: stable@vger.kernel.org
Reviewed-by: Sumit Garg
[JW: backport to 5.16-stable + update commit message]
Signed-off-by: Jens Wiklander
Signed-off-by: Greg Kroah-Hartman
commit b07508c74408b6704812812255ef37ff4ede0a61
Author: Jens Wiklander
Date: Mon Oct 4 16:11:52 2021 +0200
tee: export teedev\_open() and teedev\_close\_context()
[ Upstream commit 1e2c3ef0496e72ba9001da5fd1b7ed56ccb30597 ]
Exports the two functions teedev\_open() and teedev\_close\_context() in
order to make it easier to create a driver internal struct tee\_context.
Reviewed-by: Sumit Garg
Signed-off-by: Jens Wiklander
Signed-off-by: Sasha Levin
commit addd62a8cb6fa90aa322365c62487da61f6baab8
Author: Seth Forshee
Date: Thu Feb 17 08:13:12 2022 -0600
vsock: remove vsock from connected table when connect is interrupted by a signal
commit b9208492fcaecff8f43915529ae34b3bcb03877c upstream.
vsock\_connect() expects that the socket could already be in the
TCP\_ESTABLISHED state when the connecting task wakes up with a signal
pending. If this happens the socket will be in the connected table, and
it is not removed when the socket state is reset. In this situation it's
common for the process to retry connect(), and if the connection is
successful the socket will be added to the connected table a second
time, corrupting the list.
Prevent this by calling vsock\_remove\_connected() if a signal is received
while waiting for a connection. This is harmless if the socket is not in
the connected table, and if it is in the table then removing it will
prevent list corruption from a double add.
Note for backporting: this patch requires d5afa82c977e ("vsock: correct
removal of socket from the list"), which is in all current stable trees
except 4.9.y.
Fixes: d021c344051a ("VSOCK: Introduce VM Sockets")
Signed-off-by: Seth Forshee
Reviewed-by: Stefano Garzarella
Link: https://lore.kernel.org/r/20220217141312.2297547-1-sforshee@digitalocean.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 331ea6834e8fec480670b84d38d11a555547b52b
Author: Ville Syrjälä
Date: Mon Feb 7 15:27:00 2022 +0200
drm/i915: Fix mbus join config lookup
commit 8d9d2a723d64b650f2e6423024ccb4a33f0cdc40 upstream.
The bogus loop from compute\_dbuf\_slices() was copied into
check\_mbus\_joined() as well. So this lookup is wrong as well.
Fix it.
Cc: stable@vger.kernel.org
Fixes: f4dc00863226 ("drm/i915/adl\_p: MBUS programming")
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20220207132700.481-2-ville.syrjala@linux.intel.com
Reviewed-by: Jani Nikula
(cherry picked from commit 053f2b85631316a9226f6340c1c0fd95634f7a5b)
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Greg Kroah-Hartman
commit 3ed9dabaa5d90eee4356aecd2ffbf7b8ebaabf6c
Author: Ville Syrjälä
Date: Mon Feb 7 15:26:59 2022 +0200
drm/i915: Fix dbuf slice config lookup
commit 698bef8ff5d2edea5d1c9d6e5adf1bfed1e8a106 upstream.
Apparently I totally fumbled the loop condition when I
removed the ARRAY\_SIZE() stuff from the dbuf slice config
lookup. Comparing the loop index with the active\_pipes bitmask
is utter nonsense, what we want to do is check to see if the
mask is zero or not.
Note that the code actually ended up working correctly despite
the fumble, up until commit eef173954432 ("drm/i915: Allow
!join\_mbus cases for adlp+ dbuf configuration") when things
broke for real.
Cc: stable@vger.kernel.org
Fixes: 05e8155afe35 ("drm/i915: Use a sentinel to terminate the dbuf slice arrays")
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20220207132700.481-1-ville.syrjala@linux.intel.com
Reviewed-by: Jani Nikula
(cherry picked from commit a28fde308c3c1c174249ff9559b57f24e6850086)
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Greg Kroah-Hartman
commit fdc3fb04080a0a7a5a9067881647fafc3fca5e64
Author: Jani Nikula
Date: Thu Feb 10 12:36:42 2022 +0200
drm/i915/opregion: check port number bounds for SWSCI display power state
commit ea958422291de248b9e2eaaeea36004e84b64043 upstream.
The mapping from enum port to whatever port numbering scheme is used by
the SWSCI Display Power State Notification is odd, and the memory of it
has faded. In any case, the parameter only has space for ports numbered
[0..4], and UBSAN reports bit shift beyond it when the platform has port
F or more.
Since the SWSCI functionality is supposed to be obsolete for new
platforms (i.e. ones that might have port F or more), just bail out
early if the mapped and mangled port number is beyond what the Display
Power State Notification can support.
Fixes: 9c4b0a683193 ("drm/i915: add opregion function to notify bios of encoder enable/disable")
Cc:  # v3.13+
Cc: Ville Syrjälä
Cc: Lucas De Marchi
Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/4800
Signed-off-by: Jani Nikula
Reviewed-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/cc363f42d6b5a5932b6d218fefcc8bdfb15dbbe5.1644489329.git.jani.nikula@intel.com
(cherry picked from commit 24a644ebbfd3b13cda702f98907f9dd123e34bf9)
Signed-off-by: Tvrtko Ursulin
Signed-off-by: Greg Kroah-Hartman
commit 214f3b66800d17af047fa5130de90aea9533d22d
Author: Rajib Mahapatra
Date: Thu Feb 10 18:46:40 2022 +0530
drm/amdgpu: skipping SDMA hw\_init and hw\_fini for S0ix.
commit f8f4e2a518347063179def4e64580b2d28233d03 upstream.
[Why]
SDMA ring buffer test failed if suspend is aborted during
S0i3 resume.
[How]
If suspend is aborted for some reason during S0i3 resume
cycle, it follows SDMA ring test failing and errors in amdgpu
resume. For RN/CZN/Picasso, SMU saves and restores SDMA
registers during S0ix cycle. So, skipping SDMA suspend and
resume from driver solves the issue. This time, the system
is able to resume gracefully even the suspend is aborted.
Reviewed-by: Mario Limonciello
Reviewed-by: Alex Deucher
Signed-off-by: Rajib Mahapatra
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 156385b0346f97f9fe61b202ce28a3f86588b1ff
Author: Yifan Zhang
Date: Fri Feb 11 17:58:08 2022 +0800
drm/amd/pm: correct the sequence of sending gpu reset msg
commit 9c4f59ea3f865693150edf0c91d1cc6b451360dd upstream.
the 2nd parameter should be smu msg type rather than asic msg index.
Fixes: 7d38d9dc4ecc ("drm/amdgpu: add mode2 reset support for yellow carp")
Signed-off-by: Yifan Zhang
Acked-by: Aaron Liu
Reviewed-by: Huang Rui
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit cf02b335060790ccc09fd674c9e1051b9c1a4d4b
Author: Ville Syrjälä
Date: Wed Feb 9 11:19:27 2022 +0200
drm/atomic: Don't pollute crtc\_state->mode\_blob with error pointers
commit 439cf34c8e0a8a33d8c15a31be1b7423426bc765 upstream.
Make sure we don't assign an error pointer to crtc\_state->mode\_blob
as that will break all kinds of places that assume either NULL or a
valid pointer (eg. drm\_property\_blob\_put()).
Cc: stable@vger.kernel.org
Reported-by: fuyufan
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20220209091928.14766-1-ville.syrjala@linux.intel.com
Acked-by: Maxime Ripard
Signed-off-by: Greg Kroah-Hartman
commit 986d3994c0c814e82093dd869b4fdff7601ba351
Author: Nicholas Bishop
Date: Fri Feb 11 14:57:39 2022 -0500
drm/radeon: Fix backlight control on iMac 12,1
commit 364438fd629f7611a84c8e6d7de91659300f1502 upstream.
The iMac 12,1 does not use the gmux driver for backlight, so the radeon
backlight device is needed to set the brightness.
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1838
Signed-off-by: Nicholas Bishop
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit fa758ee2735173f59a607fdba78879efe91984ce
Author: AngeloGioacchino Del Regno
Date: Mon Jan 31 09:55:20 2022 +0100
drm/mediatek: mtk\_dsi: Avoid EPROBE\_DEFER loop with external bridge
commit 647474b8d980256b26b1cd112d7333a4dbd4260a upstream.
DRM bridge drivers are now attaching their DSI device at probe time,
which requires us to register our DSI host in order to let the bridge
to probe: this recently started producing an endless -EPROBE\_DEFER
loop on some machines that are using external bridges, like the
parade-ps8640, found on the ACER Chromebook R13.
Now that the DSI hosts/devices probe sequence is documented, we can
do adjustments to the mtk\_dsi driver as to both fix now and make sure
to avoid this situation in the future: for this, following what is
documented in drm\_bridge.c, move the mtk\_dsi component\_add() to the
mtk\_dsi\_ops.attach callback and delete it in the detach callback;
keeping in mind that we are registering a drm\_bridge for our DSI,
which is only used/attached if the DSI Host is bound, it wouldn't
make sense to keep adding our bridge at probe time (as it would
be useless to have it if mtk\_dsi\_ops.attach() fails!), so also move
that one to the dsi host attach function (and remove it in detach).
Cc:  # 5.15.x
Signed-off-by: AngeloGioacchino Del Regno
Reviewed-by: Andrzej Hajda
Reviewed-by: Jagan Teki
Tested-by: Nícolas F. R. A. Prado
Signed-off-by: Chun-Kuang Hu
Signed-off-by: Greg Kroah-Hartman
commit 9958b9cbb22145295ee1ffaea0904c383da2c05d
Author: Johannes Berg
Date: Tue Feb 8 11:47:30 2022 +0100
iwlwifi: fix use-after-free
commit bea2662e7818e15d7607d17d57912ac984275d94 upstream.
If no firmware was present at all (or, presumably, all of the
firmware files failed to parse), we end up unbinding by calling
device\_release\_driver(), which calls remove(), which then in
iwlwifi calls iwl\_drv\_stop(), freeing the 'drv' struct. However
the new code I added will still erroneously access it after it
was freed.
Set 'failure=false' in this case to avoid the access, all data
was already freed anyway.
Cc: stable@vger.kernel.org
Reported-by: Stefan Agner
Reported-by: Wolfgang Walter
Reported-by: Jason Self
Reported-by: Dominik Behr
Reported-by: Marek Marczykowski-Górecki
Fixes: ab07506b0454 ("iwlwifi: fix leaks/bad data after failed firmware load")
Signed-off-by: Johannes Berg
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20220208114728.e6b514cf4c85.Iffb575ca2a623d7859b542c33b2a507d01554251@changeid
Signed-off-by: Greg Kroah-Hartman
commit db24310ec6e6ee9c640f496888db9b189b6c9f14
Author: Luca Coelho
Date: Fri Jan 28 14:48:50 2022 +0200
iwlwifi: remove deprecated broadcast filtering feature
commit 92883a524ae918736a7b8acef98698075507b8c1 upstream.
This feature has been deprecated and should not be used anymore. With
newer firmwares, namely \*-67.ucode and above, trying to use it causes an
assertion failure in the FW, similar to this:
[Tue Jan 11 20:05:24 2022] iwlwifi 0000:04:00.0: 0x00001062 | ADVANCED\_SYSASSERT
In order to prevent this feature from being used, remove it entirely
and get rid of the Kconfig option that
enables it (IWLWIFI\_BCAST\_FILTERING).
Fixes: cbaa6aeedee5 ("iwlwifi: bump FW API to 67 for AX devices")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215488
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20220128144623.9241e049f13e.Ia4f282813ca2ddd24c13427823519113f2bbebf2@changeid
Signed-off-by: Greg Kroah-Hartman
commit b51eca406c10c87c84497da7595fe4403e027d21
Author: Maxim Levitsky
Date: Mon Feb 7 17:54:20 2022 +0200
KVM: x86: nSVM: mark vmcb01 as dirty when restoring SMM saved state
commit e8efa4ff00374d2e6f47f6e4628ca3b541c001af upstream.
While usually, restoring the smm state makes the KVM enter
the nested guest thus a different vmcb (vmcb02 vs vmcb01),
KVM should still mark it as dirty, since hardware
can in theory cache multiple vmcbs.
Failure to do so, combined with lack of setting the
nested\_run\_pending (which is fixed in the next patch),
might make KVM re-enter vmcb01, which was just exited from,
with completely different set of guest state registers
(SMM vs non SMM) and without proper dirty bits set,
which results in the CPU reusing stale IDTR pointer
which leads to a guest shutdown on any interrupt.
On the real hardware this usually doesn't happen,
but when running nested, L0's KVM does check and
honour few dirty bits, causing this issue to happen.
This patch fixes boot of hyperv and SMM enabled
windows VM running nested on KVM.
Signed-off-by: Maxim Levitsky
Cc: stable@vger.kernel.org
Message-Id: <20220207155447.840194-4-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 352193edda48e08e8824a7ece09aec830a603cfe
Author: Maxim Levitsky
Date: Mon Feb 7 17:54:19 2022 +0200
KVM: x86: nSVM: fix potential NULL derefernce on nested migration
commit e1779c2714c3023e4629825762bcbc43a3b943df upstream.
Turns out that due to review feedback and/or rebases
I accidentally moved the call to nested\_svm\_load\_cr3 to be too early,
before the NPT is enabled, which is very wrong to do.
KVM can't even access guest memory at that point as nested NPT
is needed for that, and of course it won't initialize the walk\_mmu,
which is main issue the patch was addressing.
Fix this for real.
Fixes: 232f75d3b4b5 ("KVM: nSVM: call nested\_svm\_load\_cr3 on nested state load")
Cc: stable@vger.kernel.org
Signed-off-by: Maxim Levitsky
Message-Id: <20220207155447.840194-3-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 4685f0820e9d33bbc05642aafe99025b45a52aa7
Author: Maxim Levitsky
Date: Mon Feb 7 17:54:18 2022 +0200
KVM: x86: SVM: don't passthrough SMAP/SMEP/PKE bits in !NPT && !gCR0.PG case
commit c53bbe2145f51d3bc0438c2db02e737b9b598bf3 upstream.
When the guest doesn't enable paging, and NPT/EPT is disabled, we
use guest't paging CR3's as KVM's shadow paging pointer and
we are technically in direct mode as if we were to use NPT/EPT.
In direct mode we create SPTEs with user mode permissions
because usually in the direct mode the NPT/EPT doesn't
need to restrict access based on guest CPL
(there are MBE/GMET extenstions for that but KVM doesn't use them).
In this special "use guest paging as direct" mode however,
and if CR4.SMAP/CR4.SMEP are enabled, that will make the CPU
fault on each access and KVM will enter endless loop of page faults.
Since page protection doesn't have any meaning in !PG case,
just don't passthrough these bits.
The fix is the same as was done for VMX in commit:
commit 656ec4a4928a ("KVM: VMX: fix SMEP and SMAP without EPT")
This fixes the boot of windows 10 without NPT for good.
(Without this patch, BSP boots, but APs were stuck in endless
loop of page faults, causing the VM boot with 1 CPU)
Signed-off-by: Maxim Levitsky
Cc: stable@vger.kernel.org
Message-Id: <20220207155447.840194-2-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 614b4c65b3f79511f1372a7302afc304cd8f5490
Author: Maxim Levitsky
Date: Mon Feb 7 17:54:21 2022 +0200
KVM: x86: nSVM/nVMX: set nested\_run\_pending on VM entry which is a result of RSM
commit 759cbd59674a6c0aec616a3f4f0740ebd3f5fbef upstream.
While RSM induced VM entries are not full VM entries,
they still need to be followed by actual VM entry to complete it,
unlike setting the nested state.
This patch fixes boot of hyperv and SMM enabled
windows VM running nested on KVM, which fail due
to this issue combined with lack of dirty bit setting.
Signed-off-by: Maxim Levitsky
Cc: stable@vger.kernel.org
Message-Id: <20220207155447.840194-5-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit d3785d31b7c8ccd35a6c1a76357c59d847eba47c
Author: David Woodhouse
Date: Mon Oct 25 14:29:01 2021 +0100
KVM: x86/xen: Fix runstate updates to be atomic when preempting vCPU
commit fcb732d8f8cf6084f8480015ad41d25fb023a4dd upstream.
There are circumstances whem kvm\_xen\_update\_runstate\_guest() should not
sleep because it ends up being called from \_\_schedule() when the vCPU
is preempted:
[ 222.830825] kvm\_xen\_update\_runstate\_guest+0x24/0x100
[ 222.830878] kvm\_arch\_vcpu\_put+0x14c/0x200
[ 222.830920] kvm\_sched\_out+0x30/0x40
[ 222.830960] \_\_schedule+0x55c/0x9f0
To handle this, make it use the same trick as \_\_kvm\_xen\_has\_interrupt(),
of using the hva from the gfn\_to\_hva\_cache directly. Then it can use
pagefault\_disable() around the accesses and just bail out if the page
is absent (which is unlikely).
I almost switched to using a gfn\_to\_pfn\_cache here and bailing out if
kvm\_map\_gfn() fails, like kvm\_steal\_time\_set\_preempted() does — but on
closer inspection it looks like kvm\_map\_gfn() will \*always\* fail in
atomic context for a page in IOMEM, which means it will silently fail
to make the update every single time for such guests, AFAICT. So I
didn't do it that way after all. And will probably fix that one too.
Cc: stable@vger.kernel.org
Fixes: 30b5c851af79 ("KVM: x86/xen: Add support for vCPU runstate information")
Signed-off-by: David Woodhouse
Message-Id:
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 1474f22c5c7e604121ee517c9f805dd759e625c4
Author: Jason A. Donenfeld
Date: Fri Jan 28 23:44:03 2022 +0100
random: wake up /dev/random writers after zap
[ Upstream commit 042e293e16e3aa9794ce60c29f5b7b0c8170f933 ]
When account() is called, and the amount of entropy dips below
random\_write\_wakeup\_bits, we wake up the random writers, so that they
can write some more in. However, the RNDZAPENTCNT/RNDCLEARPOOL ioctl
sets the entropy count to zero -- a potential reduction just like
account() -- but does not unblock writers. This commit adds the missing
logic to that ioctl to unblock waiting writers.
Reviewed-by: Dominik Brodowski
Signed-off-by: Jason A. Donenfeld
Signed-off-by: Sasha Levin
commit e37b6b90f7500eb97fb804624627f9deab461acc
Author: Kees Cook
Date: Thu Feb 3 12:17:54 2022 -0800
gcc-plugins/stackleak: Use noinstr in favor of notrace
[ Upstream commit dcb85f85fa6f142aae1fe86f399d4503d49f2b60 ]
While the stackleak plugin was already using notrace, objtool is now a
bit more picky. Update the notrace uses to noinstr. Silences the
following objtool warnings when building with:
CONFIG\_DEBUG\_ENTRY=y
CONFIG\_STACK\_VALIDATION=y
CONFIG\_VMLINUX\_VALIDATION=y
CONFIG\_GCC\_PLUGIN\_STACKLEAK=y
vmlinux.o: warning: objtool: do\_syscall\_64()+0x9: call to stackleak\_track\_stack() leaves .noinstr.text section
vmlinux.o: warning: objtool: do\_int80\_syscall\_32()+0x9: call to stackleak\_track\_stack() leaves .noinstr.text section
vmlinux.o: warning: objtool: exc\_general\_protection()+0x22: call to stackleak\_track\_stack() leaves .noinstr.text section
vmlinux.o: warning: objtool: fixup\_bad\_iret()+0x20: call to stackleak\_track\_stack() leaves .noinstr.text section
vmlinux.o: warning: objtool: do\_machine\_check()+0x27: call to stackleak\_track\_stack() leaves .noinstr.text section
vmlinux.o: warning: objtool: .text+0x5346e: call to stackleak\_erase() leaves .noinstr.text section
vmlinux.o: warning: objtool: .entry.text+0x143: call to stackleak\_erase() leaves .noinstr.text section
vmlinux.o: warning: objtool: .entry.text+0x10eb: call to stackleak\_erase() leaves .noinstr.text section
vmlinux.o: warning: objtool: .entry.text+0x17f9: call to stackleak\_erase() leaves .noinstr.text section
Note that the plugin's addition of calls to stackleak\_track\_stack() from
noinstr functions is expected to be safe, as it isn't runtime
instrumentation and is self-contained.
Cc: Alexander Popov
Suggested-by: Peter Zijlstra
Signed-off-by: Kees Cook
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit a7159692b508feb9e7fa7e96a4164f453204c0b6
Author: Igor Pylypiv
Date: Thu Jan 27 15:39:53 2022 -0800
Revert "module, async: async\_synchronize\_full() on module init iff async is used"
[ Upstream commit 67d6212afda218d564890d1674bab28e8612170f ]
This reverts commit 774a1221e862b343388347bac9b318767336b20b.
We need to finish all async code before the module init sequence is
done. In the reverted commit the PF\_USED\_ASYNC flag was added to mark a
thread that called async\_schedule(). Then the PF\_USED\_ASYNC flag was
used to determine whether or not async\_synchronize\_full() needs to be
invoked. This works when modprobe thread is calling async\_schedule(),
but it does not work if module dispatches init code to a worker thread
which then calls async\_schedule().
For example, PCI driver probing is invoked from a worker thread based on
a node where device is attached:
if (cpu < nr\_cpu\_ids)
error = work\_on\_cpu(cpu, local\_pci\_probe, &ddi);
else
error = local\_pci\_probe(&ddi);
We end up in a situation where a worker thread gets the PF\_USED\_ASYNC
flag set instead of the modprobe thread. As a result,
async\_synchronize\_full() is not invoked and modprobe completes without
waiting for the async code to finish.
The issue was discovered while loading the pm80xx driver:
(scsi\_mod.scan=async)
modprobe pm80xx worker
...
do\_init\_module()
...
pci\_call\_probe()
work\_on\_cpu(local\_pci\_probe)
local\_pci\_probe()
pm8001\_pci\_probe()
scsi\_scan\_host()
async\_schedule()
worker->flags |= PF\_USED\_ASYNC;
...
< return from worker >
...
if (current->flags & PF\_USED\_ASYNC) <--- false
async\_synchronize\_full();
Commit 21c3c5d28007 ("block: don't request module during elevator init")
fixed the deadlock issue which the reverted commit 774a1221e862
("module, async: async\_synchronize\_full() on module init iff async is
used") tried to fix.
Since commit 0fdff3ec6d87 ("async, kmod: warn on synchronous
request\_module() from async workers") synchronous module loading from
async is not allowed.
Given that the original deadlock issue is fixed and it is no longer
allowed to call synchronous request\_module() from async we can remove
PF\_USED\_ASYNC flag to make module init consistently invoke
async\_synchronize\_full() unless async module probe is requested.
Signed-off-by: Igor Pylypiv
Reviewed-by: Changyuan Lyu
Reviewed-by: Luis Chamberlain
Acked-by: Tejun Heo
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 673894aa77a83672930f338d1e369d30464c0c08
Author: Jan Beulich
Date: Tue Feb 1 11:57:16 2022 +0100
x86/Xen: streamline (and fix) PV CPU enumeration
[ Upstream commit e25a8d959992f61b64a58fc62fb7951dc6f31d1f ]
This started out with me noticing that "dom0\_max\_vcpus=" with
larger than the number of physical CPUs reported through ACPI tables
would not bring up the "excess" vCPU-s. Addressing this is the primary
purpose of the change; CPU maps handling is being tidied only as far as
is necessary for the change here (with the effect of also avoiding the
setting up of too much per-CPU infrastructure, i.e. for CPUs which can
never come online).
Noticing that xen\_fill\_possible\_map() is called way too early, whereas
xen\_filter\_cpu\_maps() is called too late (after per-CPU areas were
already set up), and further observing that each of the functions serves
only one of Dom0 or DomU, it looked like it was better to simplify this.
Use the .get\_smp\_config hook instead, uniformly for Dom0 and DomU.
xen\_fill\_possible\_map() can be dropped altogether, while
xen\_filter\_cpu\_maps() is re-purposed but not otherwise changed.
Signed-off-by: Jan Beulich
Reviewed-by: Boris Ostrovsky
Link: https://lore.kernel.org/r/2dbd5f0a-9859-ca2d-085e-a02f7166c610@suse.com
Signed-off-by: Juergen Gross
Signed-off-by: Sasha Levin
commit 3daeb3d9374426c4acd3f68f64f7f4b39760991e
Author: Christian König
Date: Fri Jan 28 13:21:10 2022 +0100
drm/amdgpu: fix logic inversion in check
[ Upstream commit e8ae38720e1a685fd98cfa5ae118c9d07b45ca79 ]
We probably never trigger this, but the logic inside the check is
inverted.
Signed-off-by: Christian König
Reviewed-by: Felix Kuehling
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit f2917009162dbf75ef6373464aa7d583e57accda
Author: Mario Limonciello
Date: Tue Jan 25 21:37:57 2022 -0600
drm/amd: Only run s3 or s0ix if system is configured properly
[ Upstream commit 04ef860469fda6a646dc841190d05b31fae68e8c ]
This will cause misconfigured systems to not run the GPU suspend
routines.
\* In APUs that are properly configured system will go into s2idle.
\* In APUs that are intended to be S3 but user selects
s2idle the GPU will stay fully powered for the suspend.
\* In APUs that are intended to be s2idle and system misconfigured
the GPU will stay fully powered for the suspend.
\* In systems that are intended to be s2idle, but AMD dGPU is also
present, the dGPU will go through S3
Signed-off-by: Mario Limonciello
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 73e682d985331ecd7fe0d83dbc24db37cde60d32
Author: Mario Limonciello
Date: Tue Jan 25 21:35:09 2022 -0600
drm/amd: add support to check whether the system is set to s3
[ Upstream commit f52a2b8badbd24faf73a13c9c07fdb9d07352944 ]
This will be used to help make decisions on what to do in
misconfigured systems.
v2: squash in semicolon fix from Stephen Rothwell
Signed-off-by: Mario Limonciello
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 3132b1d27f57ac09163c526d93e41d1a15118f90
Author: Steen Hegelund
Date: Wed Feb 2 09:30:39 2022 +0100
net: sparx5: do not refer to skb after passing it on
[ Upstream commit 81eb8b0b18789e647e65579303529fd52d861cc2 ]
Do not try to use any SKB fields after the packet has been passed up in the
receive stack.
Reported-by: kernel test robot
Reported-by: Dan Carpenter
Signed-off-by: Steen Hegelund
Link: https://lore.kernel.org/r/20220202083039.3774851-1-steen.hegelund@microchip.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit ea86027ac467a055849c4945906f799e7f65ab99
Author: Sagi Grimberg
Date: Tue Feb 1 14:54:21 2022 +0200
nvme-rdma: fix possible use-after-free in transport error\_recovery work
[ Upstream commit b6bb1722f34bbdbabed27acdceaf585d300c5fd2 ]
While nvme\_rdma\_submit\_async\_event\_work is checking the ctrl and queue
state before preparing the AER command and scheduling io\_work, in order
to fully prevent a race where this check is not reliable the error
recovery work must flush async\_event\_work before continuing to destroy
the admin queue after setting the ctrl state to RESETTING such that
there is no race .submit\_async\_event and the error recovery handler
itself changing the ctrl state.
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
commit bb0d8fb35c4ff00a503c2c4dca4cce8d102a21c4
Author: Sagi Grimberg
Date: Tue Feb 1 14:54:20 2022 +0200
nvme-tcp: fix possible use-after-free in transport error\_recovery work
[ Upstream commit ff9fc7ebf5c06de1ef72a69f9b1ab40af8b07f9e ]
While nvme\_tcp\_submit\_async\_event\_work is checking the ctrl and queue
state before preparing the AER command and scheduling io\_work, in order
to fully prevent a race where this check is not reliable the error
recovery work must flush async\_event\_work before continuing to destroy
the admin queue after setting the ctrl state to RESETTING such that
there is no race .submit\_async\_event and the error recovery handler
itself changing the ctrl state.
Tested-by: Chris Leech
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
commit 9e956a2596ae276124ef0d96829c013dd0faf861
Author: Sagi Grimberg
Date: Tue Feb 1 14:54:19 2022 +0200
nvme: fix a possible use-after-free in controller reset during load
[ Upstream commit 0fa0f99fc84e41057cbdd2efbfe91c6b2f47dd9d ]
Unlike .queue\_rq, in .submit\_async\_event drivers may not check the ctrl
readiness for AER submission. This may lead to a use-after-free
condition that was observed with nvme-tcp.
The race condition may happen in the following scenario:
1. driver executes its reset\_ctrl\_work
2. -> nvme\_stop\_ctrl - flushes ctrl async\_event\_work
3. ctrl sends AEN which is received by the host, which in turn
schedules AEN handling
4. teardown admin queue (which releases the queue socket)
5. AEN processed, submits another AER, calling the driver to submit
6. driver attempts to send the cmd
==> use-after-free
In order to fix that, add ctrl state check to validate the ctrl
is actually able to accept the AER submission.
This addresses the above race in controller resets because the driver
during teardown should:
1. change ctrl state to RESETTING
2. flush async\_event\_work (as well as other async work elements)
So after 1,2, any other AER command will find the
ctrl state to be RESETTING and bail out without submitting the AER.
Signed-off-by: Sagi Grimberg
Signed-off-by: Sasha Levin
commit 1478f5f11add8b70287b0ace3e7dec34eed0f257
Author: Christian Brauner
Date: Mon Jan 31 15:48:54 2022 +0100
mailmap: update Christian Brauner's email address
[ Upstream commit 1a2beb3d5a0b4051067ecf49ea799bee340e0e7c ]
At least one of the addresses will stop functioning after February.
Signed-off-by: Christian Brauner
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 08cb8590098c90578c4d115c55ee0a62a5f661ad
Author: Mario Limonciello
Date: Tue Jan 11 14:00:26 2022 -0600
drm/amd: Warn users about potential s0ix problems
[ Upstream commit a6ed2035878e5ad2e43ed175d8812ac9399d6c40 ]
On some OEM setups users can configure the BIOS for S3 or S2idle.
When configured to S3 users can still choose 's2idle' in the kernel by
using `/sys/power/mem\_sleep`. Before commit 6dc8265f9803 ("drm/amdgpu:
always reset the asic in suspend (v2)"), the GPU would crash. Now when
configured this way, the system should resume but will use more power.
As such, adjust the `amdpu\_acpi\_is\_s0ix function` to warn users about
potential power consumption issues during their first attempt at
suspending.
Reported-by: Bjoren Dasse
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/1824
Reviewed-by: Alex Deucher
Signed-off-by: Mario Limonciello
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit f61f9fccb2cb4bb275674a79d638704db6bc2171
Author: John Garry
Date: Thu Jan 27 21:12:52 2022 +0800
scsi: pm8001: Fix use-after-free for aborted SSP/STP sas\_task
[ Upstream commit df7abcaa1246e2537ab4016077b5443bb3c09378 ]
Currently a use-after-free may occur if a sas\_task is aborted by the upper
layer before we handle the I/O completion in mpi\_ssp\_completion() or
mpi\_sata\_completion().
In this case, the following are the two steps in handling those I/O
completions:
- Call complete() to inform the upper layer handler of completion of
the I/O.
- Release driver resources associated with the sas\_task in
pm8001\_ccb\_task\_free() call.
When complete() is called, the upper layer may free the sas\_task. As such,
we should not touch the associated sas\_task afterwards, but we do so in the
pm8001\_ccb\_task\_free() call.
Fix by swapping the complete() and pm8001\_ccb\_task\_free() calls ordering.
Link: https://lore.kernel.org/r/1643289172-165636-4-git-send-email-john.garry@huawei.com
Reviewed-by: Damien Le Moal
Acked-by: Jack Wang
Signed-off-by: John Garry
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 510b21442c3a2e3ecc071ba3e666b320e7acdd61
Author: John Garry
Date: Thu Jan 27 21:12:51 2022 +0800
scsi: pm8001: Fix use-after-free for aborted TMF sas\_task
[ Upstream commit 61f162aa4381845acbdc7f2be4dfb694d027c018 ]
Currently a use-after-free may occur if a TMF sas\_task is aborted before we
handle the IO completion in mpi\_ssp\_completion(). The abort occurs due to
timeout.
When the timeout occurs, the SAS\_TASK\_STATE\_ABORTED flag is set and the
sas\_task is freed in pm8001\_exec\_internal\_tmf\_task().
However, if the I/O completion occurs later, the I/O completion still
thinks that the sas\_task is available. Fix this by clearing the ccb->task
if the TMF times out - the I/O completion handler does nothing if this
pointer is cleared.
Link: https://lore.kernel.org/r/1643289172-165636-3-git-send-email-john.garry@huawei.com
Reviewed-by: Damien Le Moal
Acked-by: Jack Wang
Signed-off-by: John Garry
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 631b25c811eb12ad22b341fa84fee52a94769d60
Author: Ming Lei
Date: Thu Jan 27 23:37:33 2022 +0800
scsi: core: Reallocate device's budget map on queue depth change
[ Upstream commit edb854a3680bacc9ef9b91ec0c5ff6105886f6f3 ]
We currently use ->cmd\_per\_lun as initial queue depth for setting up the
budget\_map. Martin Wilck reported that it is common for the queue\_depth to
be subsequently updated in slave\_configure() based on detected hardware
characteristics.
As a result, for some drivers, the static host template settings for
cmd\_per\_lun and can\_queue won't actually get used in practice. And if the
default values are used to allocate the budget\_map, memory may be consumed
unnecessarily.
Fix the issue by reallocating the budget\_map after ->slave\_configure()
returns. At that time the device queue\_depth should accurately reflect what
the hardware needs.
Link: https://lore.kernel.org/r/20220127153733.409132-1-ming.lei@redhat.com
Cc: Bart Van Assche
Reported-by: Martin Wilck
Suggested-by: Martin Wilck
Tested-by: Martin Wilck
Reviewed-by: Martin Wilck
Reviewed-by: Bart Van Assche
Signed-off-by: Ming Lei
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 54061f3a5e21562a8d1991e2babd853c4cbc09f2
Author: Vincenzo Frascino
Date: Mon Jan 31 11:34:05 2022 +0000
kselftest: Fix vdso\_test\_abi return status
[ Upstream commit ec049891b2dc16591813eacaddc476b3d27c8c14 ]
vdso\_test\_abi contains a batch of tests that verify the validity of the
vDSO ABI.
When a vDSO symbol is not found the relevant test is skipped reporting
KSFT\_SKIP. All the tests return values are then added in a single
variable which is checked to verify failures. This approach can have
side effects which result in reporting the wrong kselftest exit status.
Fix vdso\_test\_abi verifying the return code of each test separately.
Cc: Shuah Khan
Cc: Andy Lutomirski
Cc: Thomas Gleixner
Reported-by: Cristian Marussi
Signed-off-by: Vincenzo Frascino
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 0016bdcda1ea16782da1abe6dc73fc5431270e4e
Author: Ajish Koshy
Date: Mon Jan 24 13:52:55 2022 +0530
scsi: pm80xx: Fix double completion for SATA devices
[ Upstream commit c26b85ea16365079be8d206b20556a60a0c69ad4 ]
Current code handles completions for SATA devices in mpi\_sata\_completion()
and mpi\_sata\_event().
However, at the time when any SATA event happens, for almost all the event
types, the command is still in the target. It is therefore incorrect to
complete the task in sata\_event().
There are some events for which we get sata\_completions, some need recovery
procedure and others abort. All the tasks must be completed via
sata\_completion() path.
Removed the task done related code from sata\_events(). For tasks where we
don't get completions, let top layer call abort() to abort the command post
timeout.
Link: https://lore.kernel.org/r/20220124082255.86223-1-Ajish.Koshy@microchip.com
Acked-by: Jack Wang
Co-developed-by: Viswas G
Signed-off-by: Viswas G
Signed-off-by: Ajish Koshy
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 6e33e7e8e7bf6c0b38bdaca414f6c401246bdee3
Author: Darrick J. Wong
Date: Sun Jan 30 08:53:16 2022 -0800
quota: make dquot\_quota\_sync return errors from ->sync\_fs
[ Upstream commit dd5532a4994bfda0386eb2286ec00758cee08444 ]
Strangely, dquot\_quota\_sync ignores the return code from the ->sync\_fs
call, which means that quotacalls like Q\_SYNC never see the error. This
doesn't seem right, so fix that.
Signed-off-by: Darrick J. Wong
Reviewed-by: Jan Kara
Reviewed-by: Christoph Hellwig
Acked-by: Christian Brauner
Signed-off-by: Sasha Levin
commit 8d5197ada884cb376336404349ade0b0a42d996f
Author: Darrick J. Wong
Date: Sun Jan 30 08:53:16 2022 -0800
vfs: make sync\_filesystem return errors from ->sync\_fs
[ Upstream commit 5679897eb104cec9e99609c3f045a0c20603da4c ]
Strangely, sync\_filesystem ignores the return code from the ->sync\_fs
call, which means that syscalls like syncfs(2) never see the error.
This doesn't seem right, so fix that.
Signed-off-by: Darrick J. Wong
Reviewed-by: Jan Kara
Reviewed-by: Christoph Hellwig
Acked-by: Christian Brauner
Signed-off-by: Sasha Levin
commit e12500092be21a4be29bab0284a3b442c04794a3
Author: Darrick J. Wong
Date: Sun Jan 30 08:53:16 2022 -0800
vfs: make freeze\_super abort when sync\_filesystem returns error
[ Upstream commit 2719c7160dcfaae1f73a1c0c210ad3281c19022e ]
If we fail to synchronize the filesystem while preparing to freeze the
fs, abort the freeze.
Signed-off-by: Darrick J. Wong
Reviewed-by: Jan Kara
Reviewed-by: Christoph Hellwig
Acked-by: Christian Brauner
Signed-off-by: Sasha Levin
commit 85ee2f739406ed6f4069ca0425ff29a559c7728e
Author: Julian Braha
Date: Mon Jan 17 01:25:57 2022 -0500
pinctrl: bcm63xx: fix unmet dependency on REGMAP for GPIO\_REGMAP
[ Upstream commit 3a5286955bf5febc3d151bcb2c5e272e383b64aa ]
When PINCTRL\_BCM63XX is selected,
and REGMAP is not selected,
Kbuild gives the following warning:
WARNING: unmet direct dependencies detected for GPIO\_REGMAP
Depends on [n]: GPIOLIB [=y] && REGMAP [=n]
Selected by [y]:
- PINCTRL\_BCM63XX [=y] && PINCTRL [=y]
This is because PINCTRL\_BCM63XX
selects GPIO\_REGMAP without selecting or depending on
REGMAP, despite GPIO\_REGMAP depending on REGMAP.
This unmet dependency bug was detected by Kismet,
a static analysis tool for Kconfig. Please advise
if this is not the appropriate solution.
Signed-off-by: Julian Braha
Link: https://lore.kernel.org/r/20220117062557.89568-1-julianbraha@gmail.com
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit c5a59cdaef94d41e16a5fa047f0d4a6318af5f08
Author: Shyam Prasad N
Date: Sat Jan 29 09:32:33 2022 +0000
cifs: unlock chan\_lock before calling cifs\_put\_tcp\_session
[ Upstream commit 489f710a738e24d887823a010b8b206b4124e26f ]
While removing an smb session, we need to free up the
tcp session for each channel for that session. We were
doing this with chan\_lock held. This results in a
cyclic dependency with cifs\_tcp\_ses\_lock.
For now, unlock the chan\_lock temporarily before calling
cifs\_put\_tcp\_session. This should not cause any problem
for now, since we do not remove channels anywhere else.
And this code segment will not be called by two threads.
When we do implement the code for removing channels, we
will need to execute proper ref counting here.
Signed-off-by: Shyam Prasad N
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit 1e1f02d36d3e73f4a24e8c95c50a796bc3662d09
Author: Duoming Zhou
Date: Fri Jan 28 12:47:15 2022 +0800
ax25: improve the incomplete fix to avoid UAF and NPD bugs
[ Upstream commit 4e0f718daf97d47cf7dec122da1be970f145c809 ]
The previous commit 1ade48d0c27d ("ax25: NPD bug when detaching
AX25 device") introduce lock\_sock() into ax25\_kill\_by\_device to
prevent NPD bug. But the concurrency NPD or UAF bug will occur,
when lock\_sock() or release\_sock() dereferences the ax25\_cb->sock.
The NULL pointer dereference bug can be shown as below:
ax25\_kill\_by\_device() | ax25\_release()
| ax25\_destroy\_socket()
| ax25\_cb\_del()
... | ...
| ax25->sk=NULL;
lock\_sock(s->sk); //(1) |
s->ax25\_dev = NULL; | ...
release\_sock(s->sk); //(2) |
... |
The root cause is that the sock is set to null before dereference
site (1) or (2). Therefore, this patch extracts the ax25\_cb->sock
in advance, and uses ax25\_list\_lock to protect it, which can synchronize
with ax25\_cb\_del() and ensure the value of sock is not null before
dereference sites.
The concurrency UAF bug can be shown as below:
ax25\_kill\_by\_device() | ax25\_release()
| ax25\_destroy\_socket()
... | ...
| sock\_put(sk); //FREE
lock\_sock(s->sk); //(1) |
s->ax25\_dev = NULL; | ...
release\_sock(s->sk); //(2) |
... |
The root cause is that the sock is released before dereference
site (1) or (2). Therefore, this patch uses sock\_hold() to increase
the refcount of sock and uses ax25\_list\_lock to protect it, which
can synchronize with ax25\_cb\_del() in ax25\_destroy\_socket() and
ensure the sock wil not be released before dereference sites.
Signed-off-by: Duoming Zhou
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 48a9df030cf904fd2ed0352cf3fcfbbf8d6e29f3
Author: Cristian Marussi
Date: Wed Jan 26 10:27:19 2022 +0000
selftests: skip mincore.check\_file\_mmap when fs lacks needed support
[ Upstream commit dae1d8ac31896988e7313384c0370176a75e9b45 ]
Report mincore.check\_file\_mmap as SKIP instead of FAIL if the underlying
filesystem lacks support of O\_TMPFILE or fallocate since such failures
are not really related to mincore functionality.
Cc: Ricardo Cañuelo
Signed-off-by: Cristian Marussi
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 84a917fd224834394541372e0470c74a305e7479
Author: Cristian Marussi
Date: Wed Jan 26 10:27:23 2022 +0000
selftests: openat2: Skip testcases that fail with EOPNOTSUPP
[ Upstream commit ac9e0a250bb155078601a5b999aab05f2a04d1ab ]
Skip testcases that fail since the requested valid flags combination is not
supported by the underlying filesystem.
Cc: Aleksa Sarai
Signed-off-by: Cristian Marussi
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 460940d471baea965d0f13793f545c72a9f0cca8
Author: Cristian Marussi
Date: Wed Jan 26 10:27:22 2022 +0000
selftests: openat2: Add missing dependency in Makefile
[ Upstream commit ea3396725aa143dd42fe388cb67e44c90d2fb719 ]
Add a dependency on header helpers.h to the main target; while at that add
to helpers.h also a missing include for bool types.
Cc: Aleksa Sarai
Signed-off-by: Cristian Marussi
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 881d7c02bc43680954dd12e2790917ac55499f98
Author: Cristian Marussi
Date: Wed Jan 26 10:27:21 2022 +0000
selftests: openat2: Print also errno in failure messages
[ Upstream commit e051cdf655fa016692008a446a060eff06222bb5 ]
In E\_func() macro, on error, print also errno in order to aid debugging.
Cc: Aleksa Sarai
Signed-off-by: Cristian Marussi
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit eebef21bada827bd6a19e787dc314f89554f12b0
Author: Yang Xu
Date: Thu Jan 27 17:11:37 2022 +0800
selftests/zram: Adapt the situation that /dev/zram0 is being used
[ Upstream commit 01dabed20573804750af5c7bf8d1598a6bf7bf6e ]
If zram-generator package is installed and works, then we can not remove
zram module because zram swap is being used. This case needs a clean zram
environment, change this test by using hot\_add/hot\_remove interface. So
even zram device is being used, we still can add zram device and remove
them in cleanup.
The two interface was introduced since kernel commit 6566d1a32bf7("zram:
add dynamic device add/remove functionality") in v4.2-rc1. If kernel
supports these two interface, we use hot\_add/hot\_remove to slove this
problem, if not, just check whether zram is being used or built in, then
skip it on old kernel.
Signed-off-by: Yang Xu
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 0086fefa6aa07d5583e3bf57d3e00176d229728a
Author: Yang Xu
Date: Thu Jan 27 17:11:36 2022 +0800
selftests/zram01.sh: Fix compression ratio calculation
[ Upstream commit d18da7ec3719559d6e74937266d0416e6c7e0b31 ]
zram01 uses `free -m` to measure zram memory usage. The results are no
sense because they are polluted by all running processes on the system.
We Should only calculate the free memory delta for the current process.
So use the third field of /sys/block/zram/mm\_stat to measure memory
usage instead. The file is available since kernel 4.1.
orig\_data\_size(first): uncompressed size of data stored in this disk.
compr\_data\_size(second): compressed size of data stored in this disk
mem\_used\_total(third): the amount of memory allocated for this disk
Also remove useless zram cleanup call in zram\_fill\_fs and so we don't
need to cleanup zram twice if fails.
Signed-off-by: Yang Xu
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit c966a56404d99a602a0978ea3ff604a01e5dd23b
Author: Yang Xu
Date: Thu Jan 27 17:11:35 2022 +0800
selftests/zram: Skip max\_comp\_streams interface on newer kernel
[ Upstream commit fc4eb486a59d70bd35cf1209f0e68c2d8b979193 ]
Since commit 43209ea2d17a ("zram: remove max\_comp\_streams internals"), zram
has switched to per-cpu streams. Even kernel still keep this interface for
some reasons, but writing to max\_comp\_stream doesn't take any effect. So
skip it on newer kernel ie 4.7.
The code that comparing kernel version is from xfstests testsuite ext4/053.
Signed-off-by: Yang Xu
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 1c72f04d52b7200bb83426a9bed378668271ea4a
Author: Miquel Raynal
Date: Tue Jan 25 13:14:23 2022 +0100
net: ieee802154: at86rf230: Stop leaking skb's
[ Upstream commit e5ce576d45bf72fd0e3dc37eff897bfcc488f6a9 ]
Upon error the ieee802154\_xmit\_complete() helper is not called. Only
ieee802154\_wake\_queue() is called manually. In the Tx case we then leak
the skb structure.
Free the skb structure upon error before returning when appropriate.
As the 'is\_tx = 0' cannot be moved in the complete handler because of a
possible race between the delay in switching to STATE\_RX\_AACK\_ON and a
new interrupt, we introduce an intermediate 'was\_tx' boolean just for
this purpose.
There is no Fixes tag applying here, many changes have been made on this
area and the issue kind of always existed.
Suggested-by: Alexander Aring
Signed-off-by: Miquel Raynal
Acked-by: Alexander Aring
Link: https://lore.kernel.org/r/20220125121426.848337-4-miquel.raynal@bootlin.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Sasha Levin
commit 7e5561815c0db8e01c2589e0f766fdea885dbdec
Author: Florian Westphal
Date: Sun Jan 23 15:45:54 2022 +0100
selftests: netfilter: reduce zone stress test running time
[ Upstream commit c858620d2ae3489409af593f005a48a8a324da3d ]
This selftests needs almost 3 minutes to complete, reduce the
insertes zones to 1000. Test now completes in about 20 seconds.
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit af7bc9011b99fb77340d8bfdbaebf57ce42df271
Author: Li Zhijian
Date: Fri Dec 17 17:29:55 2021 +0800
kselftest: signal all child processes
[ Upstream commit 92d25637a3a45904292c93f1863c6bbda4e3e38f ]
We have some many cases that will create child process as well, such as
pidfd\_wait. Previously, we will signal/kill the parent process when it
is time out, but this signal will not be sent to its child process. In
such case, if child process doesn't terminate itself, ksefltest framework
will hang forever.
Here we group all its child processes so that kill() can signal all of
them in timeout.
Fixed change log: Shuah Khan
Suggested-by: yang xu
Signed-off-by: Li Zhijian
Acked-by: Christian Brauner
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit dbd5d2aaf62d9d09661dce95ee02dd061b41fce5
Author: Nícolas F. R. A. Prado
Date: Wed Jan 12 14:41:42 2022 -0500
selftests: rtc: Increase test timeout so that all tests run
[ Upstream commit f034cc1301e7d83d4ec428dd6b8ffb57ca446efb ]
The timeout setting for the rtc kselftest is currently 90 seconds. This
setting is used by the kselftest runner to stop running a test if it
takes longer than the assigned value.
However, two of the test cases inside rtc set alarms. These alarms are
set to the next beginning of the minute, so each of these test cases may
take up to, in the worst case, 60 seconds.
In order to allow for all test cases in rtc to run, even in the worst
case, when using the kselftest runner, the timeout value should be
increased to at least 120. Set it to 180, so there's some additional
slack.
Correct operation can be tested by running the following command right
after the start of a minute (low second count), and checking that all
test cases run:
./run\_kselftest.sh -c rtc
Signed-off-by: Nícolas F. R. A. Prado
Acked-by: Alexandre Belloni
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit dfdbb3149932e965e5c991695d12f9835b6e5f61
Author: Michał Winiarski
Date: Thu Jan 13 00:36:57 2022 +0100
kunit: tool: Import missing importlib.abc
[ Upstream commit 235528072f28b3b0a1446279b7eaddda36dbf743 ]
Python 3.10.0 contains:
9e09849d20 ("bpo-41006: importlib.util no longer imports typing (GH-20938)")
It causes importlib.util to no longer import importlib.abs, which leads
to the following error when trying to use kunit with qemu:
AttributeError: module 'importlib' has no attribute 'abc'. Did you mean: '\_abc'?
Add the missing import.
Signed-off-by: Michał Winiarski
Reviewed-by: Daniel Latypov
Reviewed-by: Brendan Higgins
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit d20e2d23cca48c11007292a8740d9eabb186530f
Author: Mario Limonciello
Date: Thu Jan 20 11:44:39 2022 -0600
platform/x86: amd-pmc: Correct usage of SMU version
[ Upstream commit b8fb0d9b47660ddb8a8256412784aad7cee9f21a ]
Yellow carp has been outputting versions like `1093.24.0`, but this
is supposed to be 69.24.0. That is the MSB is being interpreted
incorrectly.
The MSB is not part of the major version, but has generally been
treated that way thus far. It's actually the program, and used to
distinguish between two programs from a similar family but different
codebase.
Link: https://patchwork.freedesktop.org/patch/469993/
Signed-off-by: Mario Limonciello
Link: https://lore.kernel.org/r/20220120174439.12770-1-mario.limonciello@amd.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit b78facc7d4889e471370800685af613daf579eb7
Author: Srinivas Pandruvada
Date: Tue Jan 11 18:25:21 2022 -0800
platform/x86: ISST: Fix possible circular locking dependency detected
[ Upstream commit 17da2d5f93692086dd096a975225ffd5622d0bf8 ]
As reported:
[ 256.104522] ======================================================
[ 256.113783] WARNING: possible circular locking dependency detected
[ 256.120093] 5.16.0-rc6-yocto-standard+ #99 Not tainted
[ 256.125362] ------------------------------------------------------
[ 256.131673] intel-speed-sel/844 is trying to acquire lock:
[ 256.137290] ffffffffc036f0d0 (punit\_misc\_dev\_lock){+.+.}-{3:3}, at: isst\_if\_open+0x18/0x90 [isst\_if\_common]
[ 256.147171]
[ 256.147171] but task is already holding lock:
[ 256.153135] ffffffff8ee7cb50 (misc\_mtx){+.+.}-{3:3}, at: misc\_open+0x2a/0x170
[ 256.160407]
[ 256.160407] which lock already depends on the new lock.
[ 256.160407]
[ 256.168712]
[ 256.168712] the existing dependency chain (in reverse order) is:
[ 256.176327]
[ 256.176327] -> #1 (misc\_mtx){+.+.}-{3:3}:
[ 256.181946] lock\_acquire+0x1e6/0x330
[ 256.186265] \_\_mutex\_lock+0x9b/0x9b0
[ 256.190497] mutex\_lock\_nested+0x1b/0x20
[ 256.195075] misc\_register+0x32/0x1a0
[ 256.199390] isst\_if\_cdev\_register+0x65/0x180 [isst\_if\_common]
[ 256.205878] isst\_if\_probe+0x144/0x16e [isst\_if\_mmio]
...
[ 256.241976]
[ 256.241976] -> #0 (punit\_misc\_dev\_lock){+.+.}-{3:3}:
[ 256.248552] validate\_chain+0xbc6/0x1750
[ 256.253131] \_\_lock\_acquire+0x88c/0xc10
[ 256.257618] lock\_acquire+0x1e6/0x330
[ 256.261933] \_\_mutex\_lock+0x9b/0x9b0
[ 256.266165] mutex\_lock\_nested+0x1b/0x20
[ 256.270739] isst\_if\_open+0x18/0x90 [isst\_if\_common]
[ 256.276356] misc\_open+0x100/0x170
[ 256.280409] chrdev\_open+0xa5/0x1e0
...
The call sequence suggested that misc\_device /dev file can be opened
before misc device is yet to be registered, which is done only once.
Here punit\_misc\_dev\_lock was used as common lock, to protect the
registration by multiple ISST HW drivers, one time setup, prevent
duplicate registry of misc device and prevent load/unload when device
is open.
We can split into locks:
- One which just prevent duplicate call to misc\_register() and one
time setup. Also never call again if the misc\_register() failed or
required one time setup is failed. This lock is not shared with
any misc device callbacks.
- The other lock protects registry, load and unload of HW drivers.
Sequence in isst\_if\_cdev\_register()
- Register callbacks under punit\_misc\_dev\_open\_lock
- Call isst\_misc\_reg() which registers misc\_device on the first
registry which is under punit\_misc\_dev\_reg\_lock, which is not
shared with callbacks.
Sequence in isst\_if\_cdev\_unregister
Just opposite of isst\_if\_cdev\_register
Reported-and-tested-by: Liwei Song
Signed-off-by: Srinivas Pandruvada
Link: https://lore.kernel.org/r/20220112022521.54669-1-srinivas.pandruvada@linux.intel.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 1a346d95a32ef4af655ab60ea2fd9f5b30fd10b6
Author: Yuka Kawajiri
Date: Wed Jan 12 00:40:21 2022 +0900
platform/x86: touchscreen\_dmi: Add info for the RWC NANOTE P8 AY07J 2-in-1
[ Upstream commit 512eb73cfd1208898cf10cb06094e0ee0bb53b58 ]
Add touchscreen info for RWC NANOTE P8 (AY07J) 2-in-1.
Signed-off-by: Yuka Kawajiri
Link: https://lore.kernel.org/r/20220111154019.4599-1-yukx00@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 9cf466b47c104a449d29b50e0678ee149eff10a6
Author: Julian Braha
Date: Mon Jan 17 00:03:24 2022 -0500
ASoC: mediatek: fix unmet dependency on GPIOLIB for SND\_SOC\_DMIC
[ Upstream commit 579b2c8f72d974f27d85bbd53846f34675ee3b01 ]
When SND\_SOC\_MT8195\_MT6359\_RT1011\_RT5682 is selected,
and GPIOLIB is not selected,
Kbuild gives the following warning:
WARNING: unmet direct dependencies detected for SND\_SOC\_DMIC
Depends on [n]: SOUND [=y] && !UML && SND [=y] && SND\_SOC [=y] && GPIOLIB [=n]
Selected by [y]:
- SND\_SOC\_MT8195\_MT6359\_RT1011\_RT5682 [=y] && SOUND [=y] && !UML && SND [=y] && SND\_SOC [=y] && I2C [=y] && SND\_SOC\_MT8195 [=y] && MTK\_PMIC\_WRAP [=y]
This is because SND\_SOC\_MT8195\_MT6359\_RT1011\_RT5682
selects SND\_SOC\_DMIC without selecting or depending on
GPIOLIB, depsite SND\_SOC\_DMIC depending on GPIOLIB.
This unmet dependency bug was detected by Kismet,
a static analysis tool for Kconfig. Please advise
if this is not the appropriate solution.
Signed-off-by: Julian Braha
Reviewed-by: Tzung-Bi Shih
Link: https://lore.kernel.org/r/20220117050324.68371-1-julianbraha@gmail.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 103b77296fee74e5ac3d3bbfda88cb26b220d85c
Author: Qu Wenruo
Date: Tue Feb 8 14:54:05 2022 +0800
btrfs: defrag: don't try to defrag extents which are under writeback
commit 0d1ffa2228cb34f485f8fe927f134b82a0ea62ae upstream.
Once we start writeback (have called btrfs\_run\_delalloc\_range()), we
allocate an extent, create an extent map point to that extent, with a
generation of (u64)-1, created the ordered extent and then clear the
DELALLOC bit from the range in the inode's io tree.
Such extent map can pass the first call of defrag\_collect\_targets(), as
its generation is (u64)-1, meets any possible minimal generation check.
And the range will not have DELALLOC bit, also passing the DELALLOC bit
check.
It will only be re-checked in the second call of
defrag\_collect\_targets(), which will wait for writeback.
But at that stage we have already spent our time waiting for some IO we
may or may not want to defrag.
Let's reject such extents early so we won't waste our time.
CC: stable@vger.kernel.org # 5.16
Reviewed-by: Filipe Manana
Signed-off-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 685de079846f7851aef8029f235ae20bd9dc3a4b
Author: Dāvis Mosāns
Date: Sat Feb 5 20:48:23 2022 +0200
btrfs: send: in case of IO error log it
commit 2e7be9db125a0bf940c5d65eb5c40d8700f738b5 upstream.
Currently if we get IO error while doing send then we abort without
logging information about which file caused issue. So log it to help
with debugging.
CC: stable@vger.kernel.org # 4.9+
Signed-off-by: Dāvis Mosāns
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 4c784cfd11842aaee39c0926317bed6153cdce24
Author: Qu Wenruo
Date: Sun Jan 30 20:53:15 2022 +0800
btrfs: don't hold CPU for too long when defragging a file
commit ea0eba69a2a8125229b1b6011644598039bc53aa upstream.
There is a user report about "btrfs filesystem defrag" causing 120s
timeout problem.
For btrfs\_defrag\_file() it will iterate all file extents if called from
defrag ioctl, thus it can take a long time.
There is no reason not to release the CPU during such a long operation.
Add cond\_resched() after defragged one cluster.
CC: stable@vger.kernel.org # 5.16
Link: https://lore.kernel.org/linux-btrfs/10e51417-2203-f0a4-2021-86c8511cc367@gmx.com
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 3b4ff4eae3756954dc2ea4e80bcbdba9104ca1e0
Author: Alex Henrie
Date: Sun Jan 16 16:01:58 2022 -0700
HID: apple: Set the tilde quirk flag on the Wellspring 5 and later
commit e26a78057c25dd56f112d536319c38735ed92ba4 upstream.
Markus reports that his 2011 MacBook with a German ISO keyboard (USB
product code 05ac:0246, HID country code 13) has the tilde key quirk.
Seeing as all of the standalone Apple ISO keyboards since about 2008
have the quirk, it seems reasonable to assume that once the integrated
laptop keyboards started having the quirk, they likewise never stopped
having it.
Reported-by: Markus Wageringel
Signed-off-by: Alex Henrie
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 253f43f7a8796a48b5ad47d6da5106041df9d5f5
Author: Andy Shevchenko
Date: Mon Feb 7 17:16:39 2022 +0200
parisc: Add ioread64\_lo\_hi() and iowrite64\_lo\_hi()
commit 18a1d5e1945385d9b5adc3fe11427ce4a9d2826e upstream.
It's a followup to the previous commit f15309d7ad5d ("parisc: Add
ioread64\_hi\_lo() and iowrite64\_hi\_lo()") which does only half of
the job. Add the rest, so we won't get a new kernel test robot
reports.
Fixes: f15309d7ad5d ("parisc: Add ioread64\_hi\_lo() and iowrite64\_hi\_lo()")
Signed-off-by: Andy Shevchenko
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 103f097ef6b5f8e2c1ae2b4cb4428f7ba1fc85aa
Author: Long Li
Date: Wed Jan 26 17:43:34 2022 -0800
PCI: hv: Fix NUMA node assignment when kernel boots with custom NUMA topology
commit 3149efcdf2c6314420c418dfc94de53bfd076b1f upstream.
When kernel boots with a NUMA topology with some NUMA nodes offline, the PCI
driver should only set an online NUMA node on the device. This can happen
during KDUMP where some NUMA nodes are not made online by the KDUMP kernel.
This patch also fixes the case where kernel is booting with "numa=off".
Fixes: 999dd956d838 ("PCI: hv: Add support for protocol 1.3 and support PCI\_BUS\_RELATIONS2")
Signed-off-by: Long Li
Reviewed-by: Michael Kelley
Tested-by: Purna Pavan Chandra Aekkaladevi
Acked-by: Lorenzo Pieralisi
Link: https://lore.kernel.org/r/1643247814-15184-1-git-send-email-longli@linuxonhyperv.com
Signed-off-by: Wei Liu
Signed-off-by: Greg Kroah-Hartman
commit c03644b6af922b837f19fd275b679bfc5e7d5f30
Author: Basavaraj Natikar
Date: Tue Feb 8 17:51:09 2022 +0530
HID: amd\_sfh: Correct the structure field name
commit aa0b724a2bf041036e56cbb3b4b3afde7c5e7c9e upstream.
Misinterpreted intr\_enable field name. Hence correct the structure
field name accordingly to reflect the functionality.
Fixes: f264481ad614 ("HID: amd\_sfh: Extend driver capabilities for multi-generation support")
Signed-off-by: Basavaraj Natikar
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 3373c026b19cec12b18de0ccdf6a2307d3867d1b
Author: Muhammad Usama Anjum
Date: Thu Feb 10 22:23:51 2022 +0500
selftests: kvm: Remove absent target file
commit 0316dbb9a017d3231f86e0188376f067ec26a59c upstream.
There is no vmx\_pi\_mmio\_test file. Remove it to get rid of error while
creation of selftest archive:
rsync: [sender] link\_stat "/kselftest/kvm/x86\_64/vmx\_pi\_mmio\_test" failed: No such file or directory (2)
rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1333) [sender=3.2.3]
Fixes: 6a58150859fd ("selftest: KVM: Add intra host migration tests")
Reported-by: "kernelci.org bot"
Signed-off-by: Muhammad Usama Anjum
Message-Id: <20220210172352.1317554-1-usama.anjum@collabora.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit c8d3f17a8e426cc720d52ffd25202b2fab8f9d6e
Author: Basavaraj Natikar
Date: Mon Jan 31 22:48:32 2022 +0530
HID: amd\_sfh: Increase sensor command timeout
commit a7072c01c3ac3ae6ecd08fa7b43431cfc8ed331f upstream.
HPD sensors take more time to initialize. Hence increasing sensor
command timeout to get response with status within a max timeout.
Fixes: 173709f50e98 ("HID: amd\_sfh: Add command response to check command status")
Signed-off-by: Basavaraj Natikar
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 7df9a8f076be266d22b659b604753d318dffa081
Author: Daniel Thompson
Date: Fri Jan 28 17:46:25 2022 +0000
HID: i2c-hid: goodix: Fix a lockdep splat
commit 2787710f73fcce4a9bdab540aaf1aef778a27462 upstream.
I'm was on the receiving end of a lockdep splat from this driver and after
scratching my head I couldn't be entirely sure it was a false positive
given we would also have to think about whether the regulator locking is
safe (since the notifier is called whilst holding regulator locks which
are also needed for regulator\_is\_enabled() ).
Regardless of whether it is a real bug or not, the mutex isn't needed.
We can use reference counting tricks instead to avoid races with the
notifier calls.
The observed splat follows:
------------------------------------------------------
kworker/u16:3/127 is trying to acquire lock:
ffff00008021fb20 (&ihid\_goodix->regulator\_mutex){+.+.}-{4:4}, at: ihid\_goodix\_vdd\_notify+0x30/0x94
but task is already holding lock:
ffff0000835c60c0 (&(&rdev->notifier)->rwsem){++++}-{4:4}, at: blocking\_notifier\_call\_chain+0x30/0x70
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&(&rdev->notifier)->rwsem){++++}-{4:4}:
down\_write+0x68/0x8c
blocking\_notifier\_chain\_register+0x54/0x70
regulator\_register\_notifier+0x1c/0x24
devm\_regulator\_register\_notifier+0x58/0x98
i2c\_hid\_of\_goodix\_probe+0xdc/0x158
i2c\_device\_probe+0x25d/0x270
really\_probe+0x174/0x2cc
\_\_driver\_probe\_device+0xc0/0xd8
driver\_probe\_device+0x50/0xe4
\_\_device\_attach\_driver+0xa8/0xc0
bus\_for\_each\_drv+0x9c/0xc0
\_\_device\_attach\_async\_helper+0x6c/0xbc
async\_run\_entry\_fn+0x38/0x100
process\_one\_work+0x294/0x438
worker\_thread+0x180/0x258
kthread+0x120/0x130
ret\_from\_fork+0x10/0x20
-> #0 (&ihid\_goodix->regulator\_mutex){+.+.}-{4:4}:
\_\_lock\_acquire+0xd24/0xfe8
lock\_acquire+0x288/0x2f4
\_\_mutex\_lock+0xa0/0x338
mutex\_lock\_nested+0x3c/0x5c
ihid\_goodix\_vdd\_notify+0x30/0x94
notifier\_call\_chain+0x6c/0x8c
blocking\_notifier\_call\_chain+0x48/0x70
\_notifier\_call\_chain.isra.0+0x18/0x20
\_regulator\_enable+0xc0/0x178
regulator\_enable+0x40/0x7c
goodix\_i2c\_hid\_power\_up+0x18/0x20
i2c\_hid\_core\_power\_up.isra.0+0x1c/0x2c
i2c\_hid\_core\_probe+0xd8/0x3d4
i2c\_hid\_of\_goodix\_probe+0x14c/0x158
i2c\_device\_probe+0x25c/0x270
really\_probe+0x174/0x2cc
\_\_driver\_probe\_device+0xc0/0xd8
driver\_probe\_device+0x50/0xe4
\_\_device\_attach\_driver+0xa8/0xc0
bus\_for\_each\_drv+0x9c/0xc0
\_\_device\_attach\_async\_helper+0x6c/0xbc
async\_run\_entry\_fn+0x38/0x100
process\_one\_work+0x294/0x438
worker\_thread+0x180/0x258
kthread+0x120/0x130
ret\_from\_fork+0x10/0x20
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&(&rdev->notifier)->rwsem);
lock(&ihid\_goodix->regulator\_mutex);
lock(&(&rdev->notifier)->rwsem);
lock(&ihid\_goodix->regulator\_mutex);
\*\*\* DEADLOCK \*\*\*
Signed-off-by: Daniel Thompson
Fixes: 18eeef46d359 ("HID: i2c-hid: goodix: Tie the reset line to true state of the regulator")
Reviewed-by: Douglas Anderson
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit d50ccc785d41ea3b36cb9d1c2b7ab59dc5b339f8
Author: Basavaraj Natikar
Date: Mon Jan 31 22:48:33 2022 +0530
HID: amd\_sfh: Add illuminance mask to limit ALS max value
commit 91aaea527bc3b707c5d3208cde035421ed54f79c upstream.
ALS illuminance value present only in first 15 bits from SFH firmware
for V2 platforms. Hence added a mask of 15 bit to limit ALS max
illuminance values to get correct illuminance value.
Fixes: 0aad9c95eb9a ("HID: amd\_sfh: Extend ALS support for newer AMD platform")
Signed-off-by: Basavaraj Natikar
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit d187eeb02d18446e5e54ed6bcbf8b47e6551daea
Author: Linus Torvalds
Date: Thu Feb 17 08:57:47 2022 -0800
mm: don't try to NUMA-migrate COW pages that have other uses
commit 80d47f5de5e311cbc0d01ebb6ee684e8f4c196c6 upstream.
Oded Gabbay reports that enabling NUMA balancing causes corruption with
his Gaudi accelerator test load:
"All the details are in the bug, but the bottom line is that somehow,
this patch causes corruption when the numa balancing feature is
enabled AND we don't use process affinity AND we use GUP to pin pages
so our accelerator can DMA to/from system memory.
Either disabling numa balancing, using process affinity to bind to
specific numa-node or reverting this patch causes the bug to
disappear"
and Oded bisected the issue to commit 09854ba94c6a ("mm: do\_wp\_page()
simplification").
Now, the NUMA balancing shouldn't actually be changing the writability
of a page, and as such shouldn't matter for COW. But it appears it
does. Suspicious.
However, regardless of that, the condition for enabling NUMA faults in
change\_pte\_range() is nonsensical. It uses "page\_mapcount(page)" to
decide if a COW page should be NUMA-protected or not, and that makes
absolutely no sense.
The number of mappings a page has is irrelevant: not only does GUP get a
reference to a page as in Oded's case, but the other mappings migth be
paged out and the only reference to them would be in the page count.
Since we should never try to NUMA-balance a page that we can't move
anyway due to other references, just fix the code to use 'page\_count()'.
Oded confirms that that fixes his issue.
Now, this does imply that something in NUMA balancing ends up changing
page protections (other than the obvious one of making the page
inaccessible to get the NUMA faulting information). Otherwise the COW
simplification wouldn't matter - since doing the GUP on the page would
make sure it's writable.
The cause of that permission change would be good to figure out too,
since it clearly results in spurious COW events - but fixing the
nonsensical test that just happened to work before is obviously the
CorrectThing(tm) to do regardless.
Fixes: 09854ba94c6a ("mm: do\_wp\_page() simplification")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=215616
Link: https://lore.kernel.org/all/CAFCwf10eNmwq2wD71xjUhqkvv5+\_pJMR1nPug2RqNDcFT4H86Q@mail.gmail.com/
Reported-and-tested-by: Oded Gabbay
Cc: David Hildenbrand
Cc: Peter Xu
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit cccf23c660cc96c5687335d73cad103e983e6165
Author: Christian Löhle
Date: Fri Feb 4 15:11:37 2022 +0000
mmc: block: fix read single on recovery logic
commit 54309fde1a352ad2674ebba004a79f7d20b9f037 upstream.
On reads with MMC\_READ\_MULTIPLE\_BLOCK that fail,
the recovery handler will use MMC\_READ\_SINGLE\_BLOCK for
each of the blocks, up to MMC\_READ\_SINGLE\_RETRIES times each.
The logic for this is fixed to never report unsuccessful reads
as success to the block layer.
On command error with retries remaining, blk\_update\_request was
called with whatever value error was set last to.
In case it was last set to BLK\_STS\_OK (default), the read will be
reported as success, even though there was no data read from the device.
This could happen on a CRC mismatch for the response,
a card rejecting the command (e.g. again due to a CRC mismatch).
In case it was last set to BLK\_STS\_IOERR, the error is reported correctly,
but no retries will be attempted.
Fixes: 81196976ed946c ("mmc: block: Add blk-mq support")
Cc: stable@vger.kernel.org
Signed-off-by: Christian Loehle
Reviewed-by: Adrian Hunter
Link: https://lore.kernel.org/r/bc706a6ab08c4fe2834ba0c05a804672@hyperstone.com
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit d56ad67085acbbf3b97705a6ed8603619bcf19cd
Author: John David Anglin
Date: Thu Jan 27 22:33:41 2022 +0000
parisc: Fix sglist access in ccio-dma.c
commit d7da660cab47183cded65e11b64497d0f56c6edf upstream.
This patch implements the same bug fix to ccio-dma.c as to sba\_iommu.c.
It ensures that only the allocated entries of the sglist are accessed.
Signed-off-by: John David Anglin
Cc: stable@vger.kernel.org
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit e40ae3133ed87d6d526f3c8fc6a5f9a2d72dcdbf
Author: John David Anglin
Date: Wed Jan 26 20:39:05 2022 +0000
parisc: Fix data TLB miss in sba\_unmap\_sg
commit b7d6f44a0fa716a82969725516dc0b16bc7cd514 upstream.
Rolf Eike Beer reported the following bug:
[1274934.746891] Bad Address (null pointer deref?): Code=15 (Data TLB miss fault) at addr 0000004140000018
[1274934.746891] CPU: 3 PID: 5549 Comm: cmake Not tainted 5.15.4-gentoo-parisc64 #4
[1274934.746891] Hardware name: 9000/785/C8000
[1274934.746891]
[1274934.746891] YZrvWESTHLNXBCVMcbcbcbcbOGFRQPDI
[1274934.746891] PSW: 00001000000001001111111000001110 Not tainted
[1274934.746891] r00-03 000000ff0804fe0e 0000000040bc9bc0 00000000406760e4 0000004140000000
[1274934.746891] r04-07 0000000040b693c0 0000004140000000 000000004a2b08b0 0000000000000001
[1274934.746891] r08-11 0000000041f98810 0000000000000000 000000004a0a7000 0000000000000001
[1274934.746891] r12-15 0000000040bddbc0 0000000040c0cbc0 0000000040bddbc0 0000000040bddbc0
[1274934.746891] r16-19 0000000040bde3c0 0000000040bddbc0 0000000040bde3c0 0000000000000007
[1274934.746891] r20-23 0000000000000006 000000004a368950 0000000000000000 0000000000000001
[1274934.746891] r24-27 0000000000001fff 000000000800000e 000000004a1710f0 0000000040b693c0
[1274934.746891] r28-31 0000000000000001 0000000041f988b0 0000000041f98840 000000004a171118
[1274934.746891] sr00-03 00000000066e5800 0000000000000000 0000000000000000 00000000066e5800
[1274934.746891] sr04-07 0000000000000000 0000000000000000 0000000000000000 0000000000000000
[1274934.746891]
[1274934.746891] IASQ: 0000000000000000 0000000000000000 IAOQ: 00000000406760e8 00000000406760ec
[1274934.746891] IIR: 48780030 ISR: 0000000000000000 IOR: 0000004140000018
[1274934.746891] CPU: 3 CR30: 00000040e3a9c000 CR31: ffffffffffffffff
[1274934.746891] ORIG\_R28: 0000000040acdd58
[1274934.746891] IAOQ[0]: sba\_unmap\_sg+0xb0/0x118
[1274934.746891] IAOQ[1]: sba\_unmap\_sg+0xb4/0x118
[1274934.746891] RP(r2): sba\_unmap\_sg+0xac/0x118
[1274934.746891] Backtrace:
[1274934.746891] [<00000000402740cc>] dma\_unmap\_sg\_attrs+0x6c/0x70
[1274934.746891] [<000000004074d6bc>] scsi\_dma\_unmap+0x54/0x60
[1274934.746891] [<00000000407a3488>] mptscsih\_io\_done+0x150/0xd70
[1274934.746891] [<0000000040798600>] mpt\_interrupt+0x168/0xa68
[1274934.746891] [<0000000040255a48>] \_\_handle\_irq\_event\_percpu+0xc8/0x278
[1274934.746891] [<0000000040255c34>] handle\_irq\_event\_percpu+0x3c/0xd8
[1274934.746891] [<000000004025ecb4>] handle\_percpu\_irq+0xb4/0xf0
[1274934.746891] [<00000000402548e0>] generic\_handle\_irq+0x50/0x70
[1274934.746891] [<000000004019a254>] call\_on\_stack+0x18/0x24
[1274934.746891]
[1274934.746891] Kernel panic - not syncing: Bad Address (null pointer deref?)
The bug is caused by overrunning the sglist and incorrectly testing
sg\_dma\_len(sglist) before nents. Normally this doesn't cause a crash,
but in this case sglist crossed a page boundary. This occurs in the
following code:
while (sg\_dma\_len(sglist) && nents--) {
The fix is simply to test nents first and move the decrement of nents
into the loop.
Reported-by: Rolf Eike Beer
Signed-off-by: John David Anglin
Cc: stable@vger.kernel.org
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit a3bb19a267681738d785b7b66ff397e93bed801a
Author: John David Anglin
Date: Sat Jan 22 18:19:49 2022 +0000
parisc: Drop \_\_init from map\_pages declaration
commit 9129886b88185962538180625ca8051362b01327 upstream.
With huge kernel pages, we randomly eat a SPARC in map\_pages(). This
is fixed by dropping \_\_init from the declaration.
However, map\_pages references the \_\_init routine memblock\_alloc\_try\_nid
via memblock\_alloc. Thus, it needs to be marked with \_\_ref.
memblock\_alloc is only called before the kernel text is set to readonly.
The \_\_ref on free\_initmem is no longer needed.
Comment regarding map\_pages being in the init section is removed.
Signed-off-by: John David Anglin
Cc: stable@vger.kernel.org # v5.4+
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 3d4fd4a2147442b8b71b3e99da979a9127968671
Author: Randy Dunlap
Date: Mon Feb 14 10:00:19 2022 -0800
serial: parisc: GSC: fix build when IOSAPIC is not set
commit 6e8793674bb0d1135ca0e5c9f7e16fecbf815926 upstream.
There is a build error when using a kernel .config file from
'kernel test robot' for a different build problem:
hppa64-linux-ld: drivers/tty/serial/8250/8250\_gsc.o: in function `.LC3':
(.data.rel.ro+0x18): undefined reference to `iosapic\_serial\_irq'
when:
CONFIG\_GSC=y
CONFIG\_SERIO\_GSCPS2=y
CONFIG\_SERIAL\_8250\_GSC=y
CONFIG\_PCI is not set
and hence PCI\_LBA is not set.
IOSAPIC depends on PCI\_LBA, so IOSAPIC is not set/enabled.
Make the use of iosapic\_serial\_irq() conditional to fix the build error.
Signed-off-by: Randy Dunlap
Reported-by: kernel test robot
Cc: "James E.J. Bottomley"
Cc: Helge Deller
Cc: linux-parisc@vger.kernel.org
Cc: Greg Kroah-Hartman
Cc: linux-serial@vger.kernel.org
Cc: Jiri Slaby
Cc: Johan Hovold
Suggested-by: Helge Deller
Signed-off-by: Helge Deller
Cc: stable@vger.kernel.org
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 96b795abc7e6e28ea66465f079fcadba12e33fd9
Author: Helge Deller
Date: Sun Feb 13 22:29:25 2022 +0100
parisc: Show error if wrong 32/64-bit compiler is being used
commit b160628e9ebcdc85d0db9d7f423c26b3c7c179d0 upstream.
It happens quite often that people use the wrong compiler to build the
kernel:
make ARCH=parisc -> builds the 32-bit kernel
make ARCH=parisc64 -> builds the 64-bit kernel
This patch adds a sanity check which errors out with an instruction how
use the correct ARCH= option.
Signed-off-by: Helge Deller
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Greg Kroah-Hartman
commit 9da5ebb93206b34b9f7400f8b6971a9aaf50e4c6
Author: Sean Christopherson
Date: Fri Feb 4 21:41:55 2022 +0000
Revert "svm: Add warning message for AVIC IPI invalid target"
commit dd4589eee99db8f61f7b8f7df1531cad3f74a64d upstream.
Remove a WARN on an "AVIC IPI invalid target" exit, the WARN is trivial
to trigger from guest as it will fail on any destination APIC ID that
doesn't exist from the guest's perspective.
Don't bother recording anything in the kernel log, the common tracepoint
for kvm\_avic\_incomplete\_ipi() is sufficient for debugging.
This reverts commit 37ef0c4414c9743ba7f1af4392f0a27a99649f2a.
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Message-Id: <20220204214205.3306634-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 3a9da267fdf4ec3f2b0a990251dd855894af4986
Author: Sergio Costas
Date: Fri Feb 4 10:01:17 2022 +0100
HID:Add support for UGTABLET WP5540
commit fd5dd6acd8f823ea804f76d3af64fa1be9d5fb78 upstream.
This patch adds support for the UGTABLET WP5540 digitizer tablet
devices. Without it, the pen moves the cursor, but neither the
buttons nor the tap sensor in the tip do work.
Signed-off-by: Sergio Costas
Link: https://lore.kernel.org/r/63dece1d-91ca-1b1b-d90d-335be66896be@gmail.com
Cc: stable@vger.kernel.org
Signed-off-by: Benjamin Tissoires
Signed-off-by: Greg Kroah-Hartman
commit 80b7205cd539bd20f65d6fa1b09bdec2a3fd6a45
Author: Hao Luo
Date: Wed Feb 16 14:52:09 2022 -0800
bpf/selftests: Test PTR\_TO\_RDONLY\_MEM
commit 9497c458c10b049438ef6e6ddda898edbc3ec6a8 upstream.
This test verifies that a ksym of non-struct can not be directly
updated.
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Acked-by: Andrii Nakryiko
Link: https://lore.kernel.org/bpf/20211217003152.48334-10-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 4a6c35debbd46d796c81eb3ffcd6c747e76ec7a3
Author: Hao Luo
Date: Wed Feb 16 14:52:08 2022 -0800
bpf: Add MEM\_RDONLY for helper args that are pointers to rdonly mem.
commit 216e3cd2f28dbbf1fe86848e0e29e6693b9f0a20 upstream.
Some helper functions may modify its arguments, for example,
bpf\_d\_path, bpf\_get\_stack etc. Previously, their argument types
were marked as ARG\_PTR\_TO\_MEM, which is compatible with read-only
mem types, such as PTR\_TO\_RDONLY\_BUF. Therefore it's legitimate,
but technically incorrect, to modify a read-only memory by passing
it into one of such helper functions.
This patch tags the bpf\_args compatible with immutable memory with
MEM\_RDONLY flag. The arguments that don't have this flag will be
only compatible with mutable memory types, preventing the helper
from modifying a read-only memory. The bpf\_args that have
MEM\_RDONLY are compatible with both mutable memory and immutable
memory.
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-9-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 199cdd057eb747b36a193ecf96d2452e36643163
Author: Hao Luo
Date: Wed Feb 16 14:52:07 2022 -0800
bpf: Make per\_cpu\_ptr return rdonly PTR\_TO\_MEM.
commit 34d3a78c681e8e7844b43d1a2f4671a04249c821 upstream.
Tag the return type of {per, this}\_cpu\_ptr with RDONLY\_MEM. The
returned value of this pair of helpers is kernel object, which
can not be updated by bpf programs. Previously these two helpers
return PTR\_OT\_MEM for kernel objects of scalar type, which allows
one to directly modify the memory. Now with RDONLY\_MEM tagging,
the verifier will reject programs that write into RDONLY\_MEM.
Fixes: 63d9b80dcf2c ("bpf: Introducte bpf\_this\_cpu\_ptr()")
Fixes: eaa6bcb71ef6 ("bpf: Introduce bpf\_per\_cpu\_ptr()")
Fixes: 4976b718c355 ("bpf: Introduce pseudo\_btf\_id")
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-8-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 6f6edc4211b379ef6de25d9182148c7ca26ffcfb
Author: Hao Luo
Date: Wed Feb 16 14:52:06 2022 -0800
bpf: Convert PTR\_TO\_MEM\_OR\_NULL to composable types.
commit cf9f2f8d62eca810afbd1ee6cc0800202b000e57 upstream.
Remove PTR\_TO\_MEM\_OR\_NULL and replace it with PTR\_TO\_MEM combined with
flag PTR\_MAYBE\_NULL.
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-7-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit e982070f8970bb62e69ed7c9cafff886ed200349
Author: Hao Luo
Date: Wed Feb 16 14:52:05 2022 -0800
bpf: Introduce MEM\_RDONLY flag
commit 20b2aff4bc15bda809f994761d5719827d66c0b4 upstream.
This patch introduce a flag MEM\_RDONLY to tag a reg value
pointing to read-only memory. It makes the following changes:
1. PTR\_TO\_RDWR\_BUF -> PTR\_TO\_BUF
2. PTR\_TO\_RDONLY\_BUF -> PTR\_TO\_BUF | MEM\_RDONLY
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-6-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 77459bc4d5e2c6f24db845780b4d9d60cf82d06a
Author: Hao Luo
Date: Wed Feb 16 14:52:04 2022 -0800
bpf: Replace PTR\_TO\_XXX\_OR\_NULL with PTR\_TO\_XXX | PTR\_MAYBE\_NULL
commit c25b2ae136039ffa820c26138ed4a5e5f3ab3841 upstream.
We have introduced a new type to make bpf\_reg composable, by
allocating bits in the type to represent flags.
One of the flags is PTR\_MAYBE\_NULL which indicates a pointer
may be NULL. This patch switches the qualified reg\_types to
use this flag. The reg\_types changed in this patch include:
1. PTR\_TO\_MAP\_VALUE\_OR\_NULL
2. PTR\_TO\_SOCKET\_OR\_NULL
3. PTR\_TO\_SOCK\_COMMON\_OR\_NULL
4. PTR\_TO\_TCP\_SOCK\_OR\_NULL
5. PTR\_TO\_BTF\_ID\_OR\_NULL
6. PTR\_TO\_MEM\_OR\_NULL
7. PTR\_TO\_RDONLY\_BUF\_OR\_NULL
8. PTR\_TO\_RDWR\_BUF\_OR\_NULL
[haoluo: backport notes
There was a reg\_type\_may\_be\_null() in adjust\_ptr\_min\_max\_vals() in
5.16.x, but didn't exist in the upstream commit. This backport
converted that reg\_type\_may\_be\_null() to type\_may\_be\_null() as well.]
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/r/20211217003152.48334-5-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 5b33e437dc6a02e3298858ca8591096f36b1421d
Author: Hao Luo
Date: Wed Feb 16 14:52:03 2022 -0800
bpf: Replace RET\_XXX\_OR\_NULL with RET\_XXX | PTR\_MAYBE\_NULL
commit 3c4807322660d4290ac9062c034aed6b87243861 upstream.
We have introduced a new type to make bpf\_ret composable, by
reserving high bits to represent flags.
One of the flag is PTR\_MAYBE\_NULL, which indicates a pointer
may be NULL. When applying this flag to ret\_types, it means
the returned value could be a NULL pointer. This patch
switches the qualified arg\_types to use this flag.
The ret\_types changed in this patch include:
1. RET\_PTR\_TO\_MAP\_VALUE\_OR\_NULL
2. RET\_PTR\_TO\_SOCKET\_OR\_NULL
3. RET\_PTR\_TO\_TCP\_SOCK\_OR\_NULL
4. RET\_PTR\_TO\_SOCK\_COMMON\_OR\_NULL
5. RET\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL
6. RET\_PTR\_TO\_MEM\_OR\_BTF\_ID\_OR\_NULL
7. RET\_PTR\_TO\_BTF\_ID\_OR\_NULL
This patch doesn't eliminate the use of these names, instead
it makes them aliases to 'RET\_PTR\_TO\_XXX | PTR\_MAYBE\_NULL'.
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-4-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit bcd98af3eb7527f6ba39c976cbcf4454fa1106e1
Author: Hao Luo
Date: Wed Feb 16 14:52:02 2022 -0800
bpf: Replace ARG\_XXX\_OR\_NULL with ARG\_XXX | PTR\_MAYBE\_NULL
commit 48946bd6a5d695c50b34546864b79c1f910a33c1 upstream.
We have introduced a new type to make bpf\_arg composable, by
reserving high bits of bpf\_arg to represent flags of a type.
One of the flags is PTR\_MAYBE\_NULL which indicates a pointer
may be NULL. When applying this flag to an arg\_type, it means
the arg can take NULL pointer. This patch switches the
qualified arg\_types to use this flag. The arg\_types changed
in this patch include:
1. ARG\_PTR\_TO\_MAP\_VALUE\_OR\_NULL
2. ARG\_PTR\_TO\_MEM\_OR\_NULL
3. ARG\_PTR\_TO\_CTX\_OR\_NULL
4. ARG\_PTR\_TO\_SOCKET\_OR\_NULL
5. ARG\_PTR\_TO\_ALLOC\_MEM\_OR\_NULL
6. ARG\_PTR\_TO\_STACK\_OR\_NULL
This patch does not eliminate the use of these arg\_types, instead
it makes them an alias to the 'ARG\_XXX | PTR\_MAYBE\_NULL'.
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-3-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 6c1fcae43eaff81fa3a6902f1c677f2cd882b416
Author: Hao Luo
Date: Wed Feb 16 14:52:01 2022 -0800
bpf: Introduce composable reg, ret and arg types.
commit d639b9d13a39cf15639cbe6e8b2c43eb60148a73 upstream.
There are some common properties shared between bpf reg, ret and arg
values. For instance, a value may be a NULL pointer, or a pointer to
a read-only memory. Previously, to express these properties, enumeration
was used. For example, in order to test whether a reg value can be NULL,
reg\_type\_may\_be\_null() simply enumerates all types that are possibly
NULL. The problem of this approach is that it's not scalable and causes
a lot of duplication. These properties can be combined, for example, a
type could be either MAYBE\_NULL or RDONLY, or both.
This patch series rewrites the layout of reg\_type, arg\_type and
ret\_type, so that common properties can be extracted and represented as
composable flag. For example, one can write
ARG\_PTR\_TO\_MEM | PTR\_MAYBE\_NULL
which is equivalent to the previous
ARG\_PTR\_TO\_MEM\_OR\_NULL
The type ARG\_PTR\_TO\_MEM are called "base type" in this patch. Base
types can be extended with flags. A flag occupies the higher bits while
base types sits in the lower bits.
This patch in particular sets up a set of macro for this purpose. The
following patches will rewrite arg\_types, ret\_types and reg\_types
respectively.
Signed-off-by: Hao Luo
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20211217003152.48334-2-haoluo@google.com
Cc: stable@vger.kernel.org # 5.16.x
Signed-off-by: Greg Kroah-Hartman
commit 9ae6fa4791a92476440797d8b083ca8168bfc620
Author: Ben Skeggs
Date: Thu Feb 25 14:54:59 2021 +1000
drm/nouveau/pmu/gm200-: use alternate falcon reset sequence
commit 4cdd2450bf739bada353e82d27b00db9af8c3001 upstream.
Signed-off-by: Ben Skeggs
Reviewed-by: Karol Herbst
Signed-off-by: Karol Herbst
Link: https://gitlab.freedesktop.org/drm/nouveau/-/merge\_requests/10
Signed-off-by: Greg Kroah-Hartman


=== Content from git.kernel.org_dd8c646a_20250115_093712.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dongliang Mu <mudongliangabcd@gmail.com> | 2022-01-22 17:48:26 +0800 |
| --- | --- | --- |
| committer | Jiri Kosina <jkosina@suse.cz> | 2022-01-24 09:03:21 +0100 |
| commit | [817b8b9c5396d2b2d92311b46719aad5d3339dbe](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)) | |
| tree | [7ef55414bc457869230f3304dd049eacb0133ad1](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe) | |
| parent | [e26a78057c25dd56f112d536319c38735ed92ba4](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e26a78057c25dd56f112d536319c38735ed92ba4) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe&id2=e26a78057c25dd56f112d536319c38735ed92ba4)) | |
| download | [linux-817b8b9c5396d2b2d92311b46719aad5d3339dbe.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-817b8b9c5396d2b2d92311b46719aad5d3339dbe.tar.gz) | |

HID: elo: fix memory leak in elo\_probeWhen hid\_parse() in elo\_probe() fails, it forgets to call usb\_put\_dev to
decrease the refcount.
Fix this by adding usb\_put\_dev() in the error handling code of elo\_probe().
Fixes: fbf42729d0e9 ("HID: elo: update the reference count of the usb device structure")
Reported-by: syzkaller <syzkaller@googlegroups.com>
Signed-off-by: Dongliang Mu <mudongliangabcd@gmail.com>
Signed-off-by: Jiri Kosina <jkosina@suse.cz>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)

| -rw-r--r-- | [drivers/hid/hid-elo.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/hid/hid-elo.c?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/hid/hid-elo.c b/drivers/hid/hid-elo.cindex 8e960d7b233b3a..9b42b0cdeef06b 100644--- a/[drivers/hid/hid-elo.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/hid/hid-elo.c?id=e26a78057c25dd56f112d536319c38735ed92ba4)+++ b/[drivers/hid/hid-elo.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/hid/hid-elo.c?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe)@@ -262,6 +262,7 @@ static int elo\_probe(struct hid\_device \*hdev, const struct hid\_device\_id \*id)  return 0; err\_free:+ usb\_put\_dev(udev); kfree(priv); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:35:49 +0000



=== Content from www.openwall.com_df00485b_20250115_093713.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2022/03/11/1) [[next>]](../../../2022/03/14/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAD-N9QVuufAueZc5jeC0agddo3gE05YLjLOT4-q0n2wGJtMf=w@mail.gmail.com>
Date: Sun, 13 Mar 2022 20:59:49 +0800
From: Dongliang Mu <mudongliangabcd@...il.com>
To: oss-security@...ts.openwall.com
Subject: Memory leak in Linux HID-elo driver

Hi oss-security,

There is one memory leak in Linux HID driver, introduced in v5.13.0.
When hid_parse in elo_probe fails, it forgets to call usb_put_dev to
decrease the refcount, leading to memory leak in the Linux kernel.

This is fixed by 817b8b9c5396 [1] and already backported to Linux
stable 5.15 and 5.16.

I am not sure how to request one CVE on the CVE request webpage. Any
help would be appreciated.

[1] <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=817b8b9c5396d2b2d92311b46719aad5d3339dbe>
[2] <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fbf42729d0e91332e8ce75a1ecce08b8a2dab9c1>

--
My best regards to you.

     No System Is Safe!
     Dongliang Mu

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


