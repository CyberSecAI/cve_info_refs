=== Content from lore.kernel.org_3c8bb58e_20250115_100424.html ===

```
[All of lore.kernel.org](../?t=20220526082827)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Jincheng Wang <jc.w4ng@gmail.com>
To: [u-boot@lists.denx.de](../../u-boot/?t=20220526082827)
Subject: [Out of bounds write vulnerability in the sqfs_readdir() function](#r)
Date: Thu, 26 May 2022 16:28:07 +0800	[[thread overview]](#r)
Message-ID: <CALO=DHFB+yBoXxVr5KcsK0iFdg+e7ywko4-e+72kjbcS8JBfPw@mail.gmail.com> (<raw>)

[[-- Attachment #1: Type: text/plain, Size: 1458 bytes --]](1-a.txt)

Hello u-boot list,

I found the sqfs_readdir() function is vulnerable to Out-of-Bound write,
which will cause arbitrary code execution.

```
int sqfs_readdir(struct fs_dir_stream *fs_dirs, struct fs_dirent **dentp)
{
......
/* Set entry name */

strncpy(dent->name, dirs->entry->name, dirs->entry->name_size + 1);
dent->name[dirs->entry->name_size + 1] = '\0';

offset = dirs->entry->name_size + 1 + SQFS_ENTRY_BASE_LENGTH;
dirs->entry_count--;
.......
}

struct squashfs_dir_stream {
struct fs_dir_stream fs_dirs;
struct fs_dirent dentp;
size_t size;
int entry_count;
struct squashfs_directory_header *dir_header;
struct squashfs_directory_entry *entry;
......
};

static int sqfs_search_dir(struct squashfs_dir_stream *dirs, char
**token_list,
  int token_count, u32 *m_list, int m_count)
{
......
while (!sqfs_readdir(dirsp, &dent)) {
ret = strcmp(dent->name, token_list[j]);
if (!ret)
break;
free(dirs->entry);
dirs->entry = NULL;
}
......
}

```

The sqfs_readdir() function  use strncpy to  set entry name, while the type
of dirs->entry->name_size is defined as "u16" in the struct
squashfs_directory_entry
and dent->name
is defined as "char[256]" in the struct fs_dirent.

We can overwrite *dirs_header and *entry in the struct squashfs_dir_stream,
so that  we can use the sqfs_search_dir() function to free a fake
chunk which causes arbitrary code execution.
You can see the Poc in the attachment.

     host bind 0 test4.sqfs
     ls host 0 /dirs

[[-- Attachment #2: test4.sqfs --]
[-- Type: application/octet-stream, Size: 4096 bytes --]](2-test4.sqfs)

```

---

```
[next](../20220601141842.GF25375%40bill-the-cat/)             [reply](#R)other threads:[[~2022-05-26  8:28 UTC](../?t=20220526082827)|[newest](../)]

Thread overview: 2+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2022-05-26  8:28 [Jincheng Wang [this message]](#t)
2022-06-01 14:18 ` [Out of bounds write vulnerability in the sqfs_readdir() function](../20220601141842.GF25375%40bill-the-cat/) Tom Rini

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to='CALO=DHFB+yBoXxVr5KcsK0iFdg+e7ywko4-e+72kjbcS8JBfPw@mail.gmail.com' \
    --to=jc.w4ng@gmail.com \
    --cc=u-boot@lists.denx.de \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```


=== Content from lore.kernel.org_ab368f6e_20250115_100423.html ===

```
[All of lore.kernel.org](../?t=20220609140221)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Miquel Raynal <miquel.raynal@bootlin.com>
To: [u-boot@lists.denx.de](../../u-boot/?t=20220609140221)
Cc: Thomas Petazzoni <thomas.petazzoni@bootlin.com>,
	Joao Marcos Costa <joaomarcos.costa@bootlin.com>,
	Miquel Raynal <miquel.raynal@bootlin.com>,
	Jincheng Wang <jc.w4ng@gmail.com>
Subject: [[PATCH v2] fs/squashfs: sqfs_read: Prevent arbitrary code execution](#r)
Date: Thu,  9 Jun 2022 16:02:06 +0200	[[thread overview]](#r)
Message-ID: <20220609140206.297405-1-miquel.raynal@bootlin.com> (<raw>)

Following Jincheng's report, an out-of-band write leading to arbitrary
code execution is possible because on one side the squashfs logic
accepts directory names up to 65535 bytes (u16), while U-Boot fs logic
accepts directory names up to 255 bytes long.

Prevent such an exploit from happening by capping directory name sizes
to 255. Use a define for this purpose so that developers can link the
limitation to its source and eventually kill it some day by dynamically
allocating this array (if ever desired).

Link: [https://lore.kernel.org/all/CALO=DHFB+yBoXxVr5KcsK0iFdg+e7ywko4-e+72kjbcS8JBfPw@mail.gmail.com](https://lore.kernel.org/all/CALO%3DDHFB%2ByBoXxVr5KcsK0iFdg%2Be7ywko4-e%2B72kjbcS8JBfPw%40mail.gmail.com)
Reported-by: Jincheng Wang <jc.w4ng@gmail.com>
Signed-off-by: Miquel Raynal <miquel.raynal@bootlin.com>
---

Changes in v2:
* Jincheng reported in private that there was a problem with small name
  sizes, the last byte was lost. The reason is, dirs->entry->name_size
  contains the length of the string minus one (and excluding the
  trailing '\0'). The previous implementation had this handled correctly
  but my initial fix did not kept the "+ 1" in place because it felt
  wrong but is actually necessary. This information is actually
  available in a comment a bit above in this file.

 [fs/squashfs/sqfs.c](#Z31fs:squashfs:sqfs.c) | 8 +++++---
 [include/fs.h](#Z31include:fs.h)       | 4 +++-
 2 files [changed](#related), 8 insertions(+), 4 deletions(-)

[diff](#iZ31fs:squashfs:sqfs.c) --git a/fs/squashfs/sqfs.c b/fs/squashfs/sqfs.c
index b4484fa17f5..3f1030057c4 100644
--- a/fs/squashfs/sqfs.c
+++ b/fs/squashfs/sqfs.c
@@ -976,6 +976,7 @@ int sqfs_readdir(struct fs_dir_stream *fs_dirs, struct fs_dirent **dentp)
 	int i_number, offset = 0, ret;
 	struct fs_dirent *dent;
 	unsigned char *ipos;
+	u16 name_size;

 	dirs = (struct squashfs_dir_stream *)fs_dirs;
 	if (!dirs->size) {
@@ -1058,9 +1059,10 @@ int sqfs_readdir(struct fs_dir_stream *fs_dirs, struct fs_dirent **dentp)
 		return -SQFS_STOP_READDIR;
 	}

-	/* Set entry name */
-	strncpy(dent->name, dirs->entry->name, dirs->entry->name_size + 1);
-	dent->name[dirs->entry->name_size + 1] = '\0';
+	/* Set entry name (capped at FS_DIRENT_NAME_LEN which is a U-Boot limitation) */
+	name_size = min_t(u16, dirs->entry->name_size + 1, FS_DIRENT_NAME_LEN - 1);
+	strncpy(dent->name, dirs->entry->name, name_size);
+	dent->name[name_size] = '\0';

 	offset = dirs->entry->name_size + 1 + SQFS_ENTRY_BASE_LENGTH;
 	dirs->entry_count--;
[diff](#iZ31include:fs.h) --git a/include/fs.h b/include/fs.h
index b43f16a692f..2195dc172ec 100644
--- a/include/fs.h
+++ b/include/fs.h
@@ -174,6 +174,8 @@ int fs_write(const char *filename, ulong addr, loff_t offset, loff_t len,
 #define FS_DT_REG  8         /* regular file */
 #define FS_DT_LNK  10        /* symbolic link */

+#define FS_DIRENT_NAME_LEN 256
+
 /**
  * struct fs_dirent - directory entry
  *
@@ -194,7 +196,7 @@ struct fs_dirent {
 	/** change_time:	time of last modification */
 	struct rtc_time change_time;
 	/** name:		file name */
-	char name[256];
+	char name[FS_DIRENT_NAME_LEN];
 };

 /* Note: fs_dir_stream should be treated as opaque to the user of fs layer */
--
2.34.1

```

---

```
[next](../CALO%3DDHFrFCN33ci107Z_XDDA_WtEK20YtWaJz1zsJyAecUFhpA%40mail.gmail.com/)             [reply](#R)	other threads:[[~2022-06-09 14:02 UTC](../?t=20220609140221)|[newest](../)]

Thread overview: 3+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2022-06-09 14:02 [Miquel Raynal [this message]](#t)
2022-06-10  2:17 ` [[PATCH v2] fs/squashfs: sqfs_read: Prevent arbitrary code execution](../CALO%3DDHFrFCN33ci107Z_XDDA_WtEK20YtWaJz1zsJyAecUFhpA%40mail.gmail.com/) Jincheng Wang
2022-06-17 13:17 ` [Tom Rini](../20220617131705.GO2484912%40bill-the-cat/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:b4484fa17f dfblob:3f1030057c dfblob:b43f16a692
dfblob:2195dc172e )
 OR (
bs:"[PATCH v2] fs/squashfs: sqfs_read: Prevent arbitrary code execution" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20220609140206.297405-1-miquel.raynal@bootlin.com \
    --to=miquel.raynal@bootlin.com \
    --cc=jc.w4ng@gmail.com \
    --cc=joaomarcos.costa@bootlin.com \
    --cc=thomas.petazzoni@bootlin.com \
    --cc=u-boot@lists.denx.de \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

