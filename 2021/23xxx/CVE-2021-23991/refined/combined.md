=== Content from bugzilla.mozilla.org_28a23bd7_20250114_193629.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1673240)
* [XML](/show_bug.cgi?ctype=xml&id=1673240)

Closed
[Bug 1673240](/show_bug.cgi?id=1673240)
(CVE-2021-23991)

Opened 4 years ago
Closed 4 years ago

# RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)

## Categories

### (MailNews Core :: Security: OpenPGP, defect, P1)

[Product:](/describecomponents.cgi?product=MailNews%20Core)

MailNews Core
▾

MailNews Core
Mail and news components common to Thunderbird and SeaMonkey
[See Open Bugs in This Product](/buglist.cgi?product=MailNews%20Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=MailNews%20Core)
Watch This Product

[Component:](/describecomponents.cgi?product=MailNews%20Core&component=Security%3A%20OpenPGP#Security%3A%20OpenPGP)

Security: OpenPGP
▾

MailNews Core :: Security: OpenPGP
OpenPGP is about all aspects related to encrypted or signed email messages using the OpenPGP protocol.
[See Open Bugs in This Component](/buglist.cgi?product=MailNews%20Core&component=Security%3A%20OpenPGP&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=MailNews%20Core&component=Security%3A%20OpenPGP&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=MailNews%20Core&component=Security%3A%20OpenPGP)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

78

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

## Tracking

### (thunderbird\_esr78+ fixed)

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

88 Branch

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| thunderbird\_esr78 | [+](/buglist.cgi?f1=cf_tracking_thunderbird_esr78&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_thunderbird_esr78&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| relnote-thunderbird |  | --- |
| thunderbird\_esr78 | + | fixed |
| seamonkey2.53 | --- | --- |
| seamonkey2.57esr | --- | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| thunderbird133 | --- | --- |
| thunderbird134 | --- | --- |
| thunderbird135 | --- | --- |
| thunderbird136 | --- | --- |

## People

### (Reporter: wsmwk, Assigned: KaiE)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/d11b5b0a468ed960df1fde3c304d3580?d=mm&size=40)  [KaiE](/user_profile?user_id=36541)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/976cc55d51282c1c46821f8451605062?d=mm&size=40)  [wsmwk](/user_profile?user_id=29811)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/d11b5b0a468ed960df1fde3c304d3580?d=mm&size=40)  [KaiE](/user_profile?user_id=36541)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[RNP-01-audit](/show_bug.cgi?id=1671735 "RESOLVED FIXED - Audit-Report RNP & Thunderbird Integration 08.2020 (tracking)")

Dependency [tree](/showdependencytree.cgi?id=1673240&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1673240)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[CVE-2021-23993](/show_bug.cgi?id=1666360 "RESOLVED FIXED - rnp trips over subkeys with invalid self signatures")

[github.com/rnpgp/rnp/issues/1214](https://github.com/rnpgp/rnp/issues/1214 "https://github.com/rnpgp/rnp/issues/1214")

## Details

### (Keywords: sec-high, Whiteboard: [RNP][fixed-in-rnp][needs tb adjustments])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2021-23991

[Keywords:](/describekeywords.cgi)

[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[RNP][fixed-in-rnp][needs tb adjustments]

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | wanted-thunderbird |  |
| --- | --- | --- |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | relnote |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files, 1 obsolete file)

| [bug1673240\_subkey\_check.patch](/attachment.cgi?id=9187335)  [4 years ago](#c1)  [Magnus Melin [:mkmelin]](/user_profile?user_id=101158)   2.97 KB, patch | KaiE : [feedback-](#c13 "4 years ago") | [Details](/attachment.cgi?id=9187335&action=edit) | [Diff](/attachment.cgi?id=9187335&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1673240&attachment=9187335) |
| --- | --- | --- |
| [Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin](/attachment.cgi?id=9210268)  [4 years ago](#c14)  [Kai Engert [:KaiE:]](/user_profile?user_id=36541)   48 bytes, text/x-phabricator-request | wsmwk : [approval-comm-esr78+](#c20 "4 years ago") | [Details](/attachment.cgi?id=9210268&action=edit) | [Review](/attachment.cgi?id=9210268) |
| [Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin](/attachment.cgi?id=9210693)  [4 years ago](#c16)  [Kai Engert [:KaiE:]](/user_profile?user_id=36541)   48 bytes, text/x-phabricator-request | wsmwk : [approval-comm-esr78+](#c25 "4 years ago") | [Details](/attachment.cgi?id=9210693&action=edit) | [Review](/attachment.cgi?id=9210693) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Wayne Mery (:wsmwk)](/user_profile?user_id=29811)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1673240#c0)• 4 years ago |
|  | |

It was found that Thunderbird allows importing primary keys and subkeys that are not bound to a valid cryptographically secure signature. Additionally, Thunderbird automatically imports detected, attached PGP primary keys with an already trusted fingerprint, as it has an extended expiry time. This introduces the risk of attackers obtaining a primary key with an extended or unset expiry time of a trusted person, while it has not yet been imported into the PGP key ring of the victim.

The attackers can abuse this by adding a malicious subkey, which has been used by Thunderbird for email encryption, signature verification and key certification. Although the subkey is flagged as invalid by RNP, it is silently accepted and imported by Thunderbird as soon as the user opens the attacker’s mail.

***Affected File:***

comm/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js

***Affected Code:***

```
commonProcessAttachedKey(keyData, isBinaryAutocrypt) {
  let errorMsgObj = {};
  let preview = EnigmailKey.getKeyListFromKeyBlock(
     keyData,
     [...]
  );
  [...]
  for (let newKey of preview) {
     let oldKey = EnigmailKeyRing.getKeyById(newKey.fpr);
     if (!oldKey) {
        [...]
        continue;
      }
      [...]
      let newHasNewValidity =
          oldKey.expiryTime < newKey.expiryTime ||
          (oldKey.keyTrust != "r" && newKey.keyTrust == "r");
      if (!newHasNewValidity)
          continue;
      [...]
      !EnigmailKeyRing.importKeyDataSilent(
         window,
         keyData,
         isBinaryAutocrypt,
         "0x" + newKey.fpr
       )
  [...]

```

It is advised that the validity of the PGP keys returned from the RNP library is respected by Thunderbird and actions ensue accordingly. Additionally, Cure53 recommends for trusted primary keys not getting automatically imported. Instead, the user should be informed and asked about importing the new key. It is crucial to alert the user about every new subkey and user-identity which is about to be newly trusted.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a1528306_1689)• 4 years ago |

Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Magnus Melin [:mkmelin]](/user_profile?user_id=101158) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1673240#c1)• 4 years ago |
|  | |

Attached patch

[bug1673240\_subkey\_check.patch](attachment.cgi?id=9187335&action=diff) (obsolete)
— [Details](attachment.cgi?id=9187335&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1673240&attachment=9187335)

WIP, though I think this is the gist of it.

I don't know how to generate a key with invalid subKeys, so no idea if it works.

[Attachment #9187335](/attachment.cgi?id=9187335&action=edit "bug1673240_subkey_check.patch") -
Flags: feedback?(kaie)

|  | [Wayne Mery (:wsmwk)](/user_profile?user_id=29811)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a1552599_29811)• 4 years ago |

[status-thunderbird\_esr78](/buglist.cgi?f1=cf_status_thunderbird_esr78&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_thunderbird_esr78&o1=equals&v1=affected)
[tracking-thunderbird\_esr78](/buglist.cgi?f1=cf_tracking_thunderbird_esr78&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_thunderbird_esr78&o1=equals&v1=%2B)Priority: -- → P1

|  | [Nickolay Olshevsky](/user_profile?user_id=665047) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1673240#c2)• 4 years ago |
|  | |

New RNP API would be added as this issue will be resolved: <https://github.com/rnpgp/rnp/issues/1214>

Basically, before doing any manipulations with public keys/subkeys, those should be checked for validity. While we do that internally, still API is not exposed via FFI yet.

|  | [Magnus Melin [:mkmelin]](/user_profile?user_id=101158) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a1559882_101158)• 4 years ago |

See Also: → <https://github.com/rnpgp/rnp/issues/1214>

|  | [Magnus Melin [:mkmelin]](/user_profile?user_id=101158) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a7429031_101158)• 4 years ago |

Whiteboard: [RNP][fixed-in-rnp][needs tb adjustments]

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1673240#c3)• 4 years ago |
|  | |

I've read this problem report many times, and I still think it is confusing.

I think it's necessary that I state my assumptions, and ask questions, and get those clarified, before we can figure out how to fix this issue.

During development, we had the need to increase our compatibility with existing keys. So I had asked the RNP team to relax restrictions, and allow a wider keys to be imported.

I think it's necessary to distinguish between "having a key available in the key store" and "querying key attributes" and "using a key for operations".

My assumptions:

* each public key defines a primary key
* for each subkey, there must be a signature of the primary key, which confirms the subkey was added by the owner of the primary key
* for each user id, there must be a signature of the primary key, which confirms the user id was added by the owner of the primary key
* for each validity time change, there must be a signature of the primary key, which confirms the change was made by the owner of the primary key
* RNP may import/store a public key, even if there are bad signatures
* if the application asks RNP for a list of subkeys, RNP will check the subkey, and only return a subkey if it has a valid signature by the primary key
* if the application asks RNP for a list of used IDs, RNP will check the user IDs, and only return a user ID if it has a valid signature by the primary key
* if the application asks RNP for the key's validity time, RNP will only return information that has been confirmed with a valid signature by the primary key

Are these assumptions correct?

Could you please comment on each item, which ones are correct or not?

For any of the above, did the RNP behavior change after the security audit?

Flags: needinfo?(o.nickolay)

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1673240#c4)• 4 years ago |
|  | |

Maybe I will find some answers in the bugs that Neal has reported. I have to study them in detail.

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1673240#c5)• 4 years ago |
|  | |

(In reply to Kai Engert (:KaiE:) from [comment #3](/show_bug.cgi?id=1673240#c3 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)"))

> * if the application asks RNP for a list of user IDs, RNP will check the user IDs, and only return a user ID if it has a valid signature by the primary key

IIUC, [bug 1666236](/show_bug.cgi?id=1666236 "RESOLVED INVALID") reports that my assumption was incorrect. RNP returned user IDs despite a missing or bad signature.

[Bug 1666236](/show_bug.cgi?id=1666236 "RESOLVED INVALID") links two RNP tickets, and both have been marked as fixed in November 2020. We recently updated Thunderbird to v0.14.0 from January 2021.

|  | [Nickolay Olshevsky](/user_profile?user_id=665047) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1673240#c6)• 4 years ago |
|  | |

Since this was originally posted RNP's API was updated with a number of functions allowing to check key/subkey/userid/signature validities.

> each public key defines a primary key

And it considered as valid if it has at least one valid self-signature, and it doesn't expire key. There is one edge case, caused by 'stripped' keys, i.e. keys without userids and certifications. In this case key also considered as valid if it has subkey with valid subkey binding signature.

API function to check validity status: `rnp_key_is_valid()`. Also there is a function `rnp_key_valid_till()`, which return timestamp till which key was considered as valid. This is to distinguish the case of emails, signed 3 years ago, with the key which expired or revoked 1 year ago.

> for each subkey, there must be a signature of the primary key, which confirms the subkey was added by the owner of the primary key

Subkey is considered as valid by RNP if it has at least one non-expiring subkey binding signature, and primary key is valid as well. Validity may be checked via the same `rnp_key_is_valid()` function. `rnp_key_valid_till()` also apply here.

> for each user id, there must be a signature of the primary key, which confirms the user id was added by the owner of the primary key

Yeah, this is called self-certification. Also this signature includes information about the key usage - preferred algorithms, key expiration, flags and so on.

This may lead to confusion if the key has multiple userids with different preferences, or direct-key signatures (i.e. signatures which tells some information about the key itself). So, in exotic situations, key preferences would depend on which userid was used to found this key.

To check userid validity you may use function `rnp_uid_is_valid()`. Please note that functions `rnp_key_get_uid_*` will list all uids, including invalid ones. However, `rnp_locate_key()` will search for the key only via valid uids.

> for each validity time change, there must be a signature of the primary key, which confirms the change was made by the owner of the primary key

Yes, usual practice is to add additional signature with extended expiration time. As far as I remember there is no strict MUST in RFC on which signatures take in account in such case, but it is recommended to check the most recent signature. I.e. if one year ago you set key expiration time to 5 years, and yesterday to 1 year, then it should expire in 1 year instead of the 4. While we have `rnp_key_get_expiration()`, you still may walk through all the sigs and override default decision.

> RNP may import/store a public key, even if there are bad signatures

Yes, we do not remove anything automatically giving flexibility to the library user. However, you still may use functions `rnp_key_remove_signature()`, `rnp_key_remove_uid()` or `rnp_key_remove_signatures()` to cleanup the key. This functions were added recently and will be available in v0.15.0 release.

> if the application asks RNP for a list of subkeys, RNP will check the subkey, and only return a subkey if it has a valid signature by the primary key

No, it will return all subkeys and you should check validity via `rnp_key_is_valid()`

> if the application asks RNP for a list of used IDs, RNP will check the user IDs, and only return a user ID if it has a valid signature by the primary key

No, it will return all the uids and you should call `rnp_uid_is_valid()` to check it.

> if the application asks RNP for the key's validity time, RNP will only return information that has been confirmed with a valid signature by the primary key

That's right. But still there may be different edge cases, like different validity times for different userids or direct-key sigs. We have some issues to behave in other way in such cases, but didn't get to those yet. For these cases key validity/expiration may vary depending on which userid was used to find a key.

Hope this helps, feel free to ask for more details. Actually, as for me, OpenPGP standard in some places is too flexible and allows too much freedom of interpretation.

Flags: needinfo?(o.nickolay)

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1673240#c7)• 4 years ago |
|  | |

Thanks for the explanation.

Regarding user IDs, I think TB should completely ignore user IDs that don't pass signature checks.

However, in its key management user interface, TB wants to show the user ID of an expired key. This can allow the user to identify an expired key, select it, and request to extend the expiration.

This means, I need to be able to ask RNP: Is time the only reason why the user ID is invalid? Does the user ID pass all other validity checks?

rnp\_uid\_is\_valid doesn't answer this question.

If TB hides all user IDs that rnp\_uid\_is\_valid describes as invalid, then the user interface cannot show any user ID for expired keys - which makes it difficult for the user to identify a key that they might want to extend.

For subkeys, you are offering rnp\_key\_valid\_till. I think this provides the answer I need for subkeys. If the timestamp returned by rnp\_key\_valid\_till is nonzero, then in my understanding, the subkey passes all signature checks.

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1673240#c8)• 4 years ago |
|  | |

Maybe the following approach is mostly ok. If the primary key is expired or revoked, but the primary key was valid at some time (rnp\_key\_valid\_till returns nonzero), then TB could use rnp\_key\_get\_primary\_uid, and show the result, regardless of the uid validity.

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1673240#c9)• 4 years ago |
|  | |

The plan from [comment 8](/show_bug.cgi?id=1673240#c8 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)") doesn't work, because rnp\_key\_get\_primary\_uid returns failure if all user IDs are expired.

|  | [Nickolay Olshevsky](/user_profile?user_id=665047) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1673240#c10)• 4 years ago |
|  | |

Hi Kai,

> This means, I need to be able to ask RNP: Is time the only reason why the user ID is invalid? Does the user ID pass all other validity checks?

To confirm this you may iterate through userid signatures, filter out self-sig, and call `rnp_signature_is_valid()` on it. It will return RNP\_SUCCESS if signature is valid (despite the key expiration). The same could be done on the subkey. I have some plans on adding functions `rnp_uid_latest_selfsig()`/`rnp_key_latest_binding()` to make this easier.

I.e. even if uid/key are expired, self-signatures are still valid (however, they may also be marked as expiring).

> The plan from [comment 8](/show_bug.cgi?id=1673240#c8 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)") doesn't work, because rnp\_key\_get\_primary\_uid returns failure if all user IDs are expired.

Yeah, sorry, forgot to mention this in the first comment. If there are no valid signatures on the uid, primary flag is dropped.

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1673240#c11)• 4 years ago |
|  | |

Thanks Nickolay, that works!

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1673240#c12)• 4 years ago |
|  | |

Let's summarize.

This bug reports, we may automatically import keys with invalid data, and use that invalid data.

The reported suggestion was, don't import automatically.

However, not importing automatically is contrary to the intended convenience mechanism, so I'd like to use a different fix.

Also, because the user is allowed to use keys manually, preventing automatic import wouldn't be a complete fix against using manipulated keys.

The report is correct, we automatically import an updated key with new subkeys.

It is correct that the TB code level would automatically accept the use of a new subkey, without checking the subkey's validity at the TB level.

This could be abused to trick TB into using a different encryption key, when sending an encrypted message.

I suggest to fix it by using the recently added new RNP API rnp\_valid\_till.

We already limit use only subkeys for encryption that are not revoked and are not expired.

By calling rnp\_valid\_till, and additional requiring that a subkey must have been valid at some time, we ensure that only subkeys certified by the key owner will be used.

Regarding user IDs:

It is correct, we currently display inalid user IDs, based on Nickolay's explanation.

However, we don't automatically trust/accept new user IDs.

At the time the user views the details for a key, we store the acceptance setting for each email address reported on screen.

We don't update the list of accepted email address, unless the user views the key details again (which would then show an updated list of email addresses) and confirms the acceptance settings again.

Nevertheless, we should disallow the use of invalid user IDs (and their email addresses).

The suggestion is to only allow accepting user IDs that carry a valid self signature, as reported by rnp\_uid\_is\_valid.

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1673240#c13)• 4 years ago |
|  | |

Comment on [attachment 9187335](/attachment.cgi?id=9187335 "bug1673240_subkey_check.patch") [[details]](/attachment.cgi?id=9187335&action=edit "bug1673240_subkey_check.patch") [[diff]](/attachment.cgi?id=9187335&action=diff "bug1673240_subkey_check.patch") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1673240&attachment=9187335)

[bug1673240](/show_bug.cgi?id=1673240 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)")\_subkey\_check.patch

I think this isn't the right approach to solve the issue. We need to treat keys based on their properties, and the new RNP APIs make that possible. I have a patch in hand that prevents the use of invalid keys, as also reported in [bug 1666236](/show_bug.cgi?id=1666236 "RESOLVED INVALID") and [bug 1666360](/show_bug.cgi?id=1666360 "RESOLVED FIXED - rnp trips over subkeys with invalid self signatures"). If a key has only bad properties, it won't be imported as a consequence.

[Attachment #9187335](/attachment.cgi?id=9187335&action=edit "bug1673240_subkey_check.patch") -
Flags: feedback?(kaie) → feedback-

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a12526951_36541)• 4 years ago |

Assignee: nobody → kaie

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a12526972_36541)• 4 years ago |

[Attachment #9187335](/attachment.cgi?id=9187335&action=edit "bug1673240_subkey_check.patch") -
Attachment is obsolete: true

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1673240#c14)• 4 years ago |
|  | |

Attached file
[Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin](attachment.cgi?id=9210268)
— [Details](attachment.cgi?id=9210268&action=edit)

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1673240#c15)• 4 years ago |
|  | |

Adding Neal to CC, because he independently found related issues, and I'd like to fix the issues in this bug.

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a12777080_36541)• 4 years ago |

See Also: → [CVE-2021-23993](/show_bug.cgi?id=1666360 "RESOLVED FIXED - rnp trips over subkeys with invalid self signatures")

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1673240#c16)• 4 years ago |
|  | |

Attached file
[Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin](attachment.cgi?id=9210693)
— [Details](attachment.cgi?id=9210693&action=edit)

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1673240#c17)• 4 years ago |
|  | |

Neal, thank you very much for contributing test keys in [bug 1666236](/show_bug.cgi?id=1666236 "RESOLVED INVALID") and [bug 1666360](/show_bug.cgi?id=1666360 "RESOLVED FIXED - rnp trips over subkeys with invalid self signatures"). I'm adding these keys to the Thunderbird test suite, and have added automated tests.

The tests fail without the fix from this bug, and work with the fix.

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a12782080_600971)• 4 years ago |

[Attachment #9210268](/attachment.cgi?id=9210268&action=edit "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin") -
Attachment description: Bug 1673240 - Prevent the use of invalid OpenPGP keys and user IDs. r=mkmelin → Bug 1673240 - Use new RNP APIs to check key validity. r=mkmelin

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a12782136_600971)• 4 years ago |

[Attachment #9210268](/attachment.cgi?id=9210268&action=edit "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin") -
Attachment description: Bug 1673240 - Use new RNP APIs to check key validity. r=mkmelin → Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a12808472_36541)• 4 years ago |

Target Milestone: --- → 88 Branch

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1673240#c18)• 4 years ago |
|  | |

Comment on [attachment 9210268](/attachment.cgi?id=9210268 "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin") [[details]](/attachment.cgi?id=9210268&action=edit "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin")

[Bug 1673240](/show_bug.cgi?id=1673240 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)") - Use new RNP APIs for checking key validity. r=mkmelin

[Approval Request Comment]

Regression caused by (bug #): no

User impact if declined: invalid keys are allowed

Testing completed (on c-c, etc.):

Risk to taking this patch (and alternatives if risky): low, should only affect scenarios that need to fail

[Attachment #9210268](/attachment.cgi?id=9210268&action=edit "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin") -
Flags: approval-comm-esr78?

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1673240#c19)• 4 years ago |
|  | |

<https://hg.mozilla.org/comm-central/rev/5f3efef0a3b5e117e38e2e6b42c4ac5921a65bfe>

Status: NEW → RESOLVEDClosed: 4 years agoResolution: --- → FIXED

|  | [Wayne Mery (:wsmwk)](/user_profile?user_id=29811)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1673240#c20)• 4 years ago |
|  | |

Comment on [attachment 9210268](/attachment.cgi?id=9210268 "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin") [[details]](/attachment.cgi?id=9210268&action=edit "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin")

[Bug 1673240](/show_bug.cgi?id=1673240 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)") - Use new RNP APIs for checking key validity. r=mkmelin

[Triage Comment]

Approved for esr78

[Attachment #9210268](/attachment.cgi?id=9210268&action=edit "Bug 1673240 - Use new RNP APIs for checking key validity. r=mkmelin") -
Flags: approval-comm-esr78? → approval-comm-esr78+

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1673240#c21)• 4 years ago |
|  | |

<https://hg.mozilla.org/releases/comm-esr78/rev/f29328195e9166a13653ba4862a96cd2a7e38a16>

78.9.1

[status-thunderbird\_esr78](/buglist.cgi?f1=cf_status_thunderbird_esr78&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_thunderbird_esr78&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_thunderbird_esr78&o1=equals&v1=fixed)

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1673240#c22)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1673240&comment_id=15349604 "1 revision") |
|  | |

Suggested CVE text:

```
CVE-??:
     title: An attacker may use Thunderbird's OpenPGP key refresh mechanism to
poison an existing key
     impact: moderate
     reporter: Cure53
     description: |
       If a Thunderbird user has previously imported Alice's OpenPGP key, and
Alice has extended the validity period of her key, but Alice's updated key has
not yet been imported, an attacker may send an email containing a crafted
version of Alice's key with an invalid subkey, Thunderbird might subsequently
attempt to use the invalid subkey, and will fail to send encrypted email to
Alice.
     bugs:
       - url: 1673240

```

Note we still allow the automatic import, but the invalid key details will no longer result in DoS.

Edit: fixed the bug number

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a14193191_578488)• 4 years ago |

Alias: CVE-2021-23991

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1673240#c23)• 4 years ago |
|  | |

Comment on [attachment 9210693](/attachment.cgi?id=9210693 "Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin") [[details]](/attachment.cgi?id=9210693&action=edit "Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin")

[Bug 1673240](/show_bug.cgi?id=1673240 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)") - Add tests using test keys contributed by Neal Walfield. r=mkmelin

tests only

[Attachment #9210693](/attachment.cgi?id=9210693&action=edit "Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin") -
Flags: approval-comm-esr78?

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1673240#c24)• 4 years ago |
|  | |

tests landed into c-c:

<https://hg.mozilla.org/comm-central/rev/5d9bce96055f4c4bca69ec574c1597e71280b4c4>

|  | [Wayne Mery (:wsmwk)](/user_profile?user_id=29811)  Reporter |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1673240#c25)• 4 years ago |
|  | |

Comment on [attachment 9210693](/attachment.cgi?id=9210693 "Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin") [[details]](/attachment.cgi?id=9210693&action=edit "Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin")

[Bug 1673240](/show_bug.cgi?id=1673240 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)") - Add tests using test keys contributed by Neal Walfield. r=mkmelin

[Triage Comment]

Approved for esr78

[Attachment #9210693](/attachment.cgi?id=9210693&action=edit "Bug 1673240 - Add tests using test keys contributed by Neal Walfield. r=mkmelin") -
Flags: approval-comm-esr78? → approval-comm-esr78+

|  | [Kai Engert [:KaiE:]](/user_profile?user_id=36541)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1673240#c26)• 4 years ago |
|  | |

tests landed into 78.10

<https://hg.mozilla.org/releases/comm-esr78/rev/d25b83da0e46e61f20a149ffe0445cd9899067be>

|  | [neal](/user_profile?user_id=651911) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1673240#c27)• 4 years ago |
|  | |

I've read this a few times now and, like Kai, I'm having trouble understanding the issue. I apologize for what may appear as nits, but in a discussion like this it is important to be precise and use accepted terminology.

(In reply to Wayne Mery (:wsmwk) from [comment #0](/show_bug.cgi?id=1673240#c0 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)"))

> It was found that Thunderbird allows importing primary keys and subkeys that are not bound to a valid cryptographically secure signature.

What does this mean? In OpenPGP primary keys and subkeys are not bound to signatures. A signature binds a component (e.g., a subkey or a User ID) to the primary key. Slightly simplified, a certificate is a primary key (which solely determines the certificate's fingerprint), binding signatures made by the primary key, and components for which there are valid binding signatures made by the primary key. The validity of a primary key is determined by the trust model (web of trust, direct trust, TB's "key acceptance"). The validity of a component is derived from any signatures that the primary key makes over the component; the primary key is the certificate's trust root. In other words, if there is a valid binding signature over a subkey made by the primary key, the subkey is *de jure* associated with the primary key; a signature is the sufficient and necessary proof that the entity that controls the key (certificate plus secret key material) wants the component to be part of the certificate.

Note: subkeys cannot stand alone.

> Additionally, Thunderbird automatically imports detected, attached PGP primary keys with an already trusted fingerprint, as it has an extended expiry time. This introduces the risk of attackers obtaining a primary key with an extended or unset expiry time of a trusted person, while it has not yet been imported into the PGP key ring of the victim.

I don't understand what is being claimed here :/.

Why is the primary important here: "PGP primary keys"? Is the implication that Thunderbird is ignoring the rest of the certificate?

What is a trusted fingerprint? I think what is meant is an authenticated certificate.

What does it mean to have an extended expiry time? Some component has a new binding signature, whose expiration time has been extended?

What does "while it has not yet been imported" mean?

It sounds like: "Thunderbird automatically imports certificates under certain conditions. An attacker may automatically import a new version of the certificate, and a victim may not." Please confirm or correct my understanding. If I understood correctly, what's the risk there?

> The attackers can abuse this by adding a malicious subkey, which has been used by Thunderbird for email encryption, signature verification and key certification.

Guessing again: "An attacker can add an invalid subkey to a certificate, and the victim's Thunderbird may import it, and use it"

> Although the subkey is flagged as invalid by RNP, it is silently accepted and imported by Thunderbird as soon as the user opens the attacker’s mail.

Subkeys are not independent objects. If a subkey is not bound to a primary key via a valid binding signature, then the OpenPGP implementation should ignore it. If it doesn't, then the OpenPGP implementation is broken.

Justus reported this to RNP on July 13, 2018:

> Critical vulnerability in RNP, Ribose's fork of Netpgp.
>
> ## Overview
>
> RNP fails to validate subkey bindings, allowing malicious parties to
>
> add or replace subkeys, even if the authenticity of the key is
>
> verified by comparing fingerprints, or other means like the web of
>
> trust. This allows an attacker that is able to control a victims
>
> network traffic to read messages encrypted using RNP.
>
> ## Impact
>
> OpenPGP implementations need to aquire the transferable public key
>
> (TPK) of the peers one wants to communicate with. This happens when
>
> establishing a new peer, and periodically to refresh ones copy of the
>
> TPK to get new keys, certificates, or revocations.
>
> If an attacker controlling the victims network traffic is able to
>
> modify the TPK in flight. Due to the missing signature verification,
>
> she can replace the encryption subkey present in the TPK with her own.
>
> Key verification, like comparing key fingerprints, is ineffective
>
> because it is done on the primary key, which is not changed.
>
> If the victim now encrypts a message using the attackers encryption
>
> key, the attacker can intercept the message, read it, re-encrypt it
>
> with the original encryption key, and send it to the intended
>
> recipient. The confidentiality of the message has been compromised.
>
> Like subkey bindings, the following signatures are likely also
>
> affected: user-id bindings, user-attribute bindings, revocations of
>
> any kind.

Ronald acknowledged the issue and indicated that they would fix it by the end of the week. As far as I know, a report about the vulnerability was never published.

Anyway, that RNP flags a subkey as invalid is good. That Thunderbird has to check if the subkey is valid before using it is deeply dangerous. A context that requires a key should only accept a valid key. Or, in the very least, be opt-in instead of opt-out.

Thunderbird *should* aggressively import certificates. It should be up to the OpenPGP implementation, in this case RNP, to authenticate the components using the primary key as the trust anchor.

Thunderbird should *not* treat the keyring as a curated keyring; it is a cache. If a binding between an identifier (email) and a certificate can be authenticated by the trust model, then the certificate should be used. Otherwise, it should be ignored.

> It is advised that the validity of the PGP keys returned from the RNP library is respected by Thunderbird and actions ensue accordingly.

If RNP exposes invalid subkeys to Thunderbird, then it is indeed Thunderbird's responsibility to add a check that they are valid before using them. But, I don't see what that has to do with importing invalid components, and why that is risky, or what expiry has to do with any of this.

> Additionally, Cure53 recommends for trusted primary keys not getting automatically imported. Instead, the user should be informed and asked about importing the new key. It is crucial to alert the user about every new subkey and user-identity which is about to be newly trusted.

This is horribly, horribly wrong. Do not ask the user about importing new certificates. Subkeys and User IDs are authenticated via binding signatures. The user cannot make an informed choice. Do not make the OpenPGP support less usable then it already is.

Finally, it's disappointing that no proof of concept was provided.

|  | [neal](/user_profile?user_id=651911) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1673240#c28)• 4 years ago |
|  | |

(In reply to Kai Engert (:KaiE:) from [comment #7](/show_bug.cgi?id=1673240#c7 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)"))

> Regarding user IDs, I think TB should completely ignore user IDs that don't pass signature checks.

This depends on the context.

If you are going to use a User ID in a security-relevant context (pretty much all contexts that matter to users!), the only User IDs that are relevant are those that are authenticated. Interestingly, this normally has *nothing* to do with whether a User ID also has a self signature. Let me repeat that: a self-signed User ID is not more or less authenticated that a User ID that is not self signed. Consider. Let's assume that I'm using a CA as a trust anchor. If that CA certifies the binding between the User ID "<alice@example.org>" and certificate 0xABCD, then that is what I care about; "<alice@example.org>" is authenticated for 0xABCD. The certificate doesn't even need to have a self signature for that User ID! This is perhaps surprising, because current tooling gives an elevated status to self signed User IDs. But, that is primarily due to a deeper problem: the available authentication mechanisms are inadequate not only in Thunderbird, but also in the broader ecosystem.

There are two places in Thunderbird where it makes sense to show self-signed User IDs and not User IDs that are not self signed. First, when accepting a certificate, it makes sense to provide the self-signed user ids as a suggestion similar to how Android's address book uses the name field of a vcard as the suggested contact's name. Second, the keyring manager is a low-level tool, which lists all of the keys in the local cache. If an authenticated User ID is not available for a certificate, it should display: "Allegedly: Self-signed User ID".

Well, we're not there. So, yes, today, Thunderbird should only show self signed User IDs.

> However, in its key management user interface, TB wants to show the user ID of an expired key. This can allow the user to identify an expired key, select it, and request to extend the expiration.
>
> This means, I need to be able to ask RNP: Is time the only reason why the user ID is invalid? Does the user ID pass all other validity checks?

This is spot on and identifies an important issue that the RNP API overlooks again and again: context is essential. See also [this bug report](https://github.com/rnpgp/rnp/issues/1483).

> rnp\_uid\_is\_valid doesn't answer this question.
>
> If TB hides all user IDs that rnp\_uid\_is\_valid describes as invalid, then the user interface cannot show any user ID for expired keys - which makes it difficult for the user to identify a key that they might want to extend.

Interestingly, we also want to show revoked keys. Say I have an old key, which I've revoked. I still want to be able to use it to decrypt messages. Or, say a certificate has been soft revoked (e.g., retired), and I want to check a signature. That should still be possible.

> For subkeys, you are offering rnp\_key\_valid\_till. I think this provides the answer I need for subkeys. If the timestamp returned by rnp\_key\_valid\_till is nonzero, then in my understanding, the subkey passes all signature checks.

Unfortunately I don't think it does. See the referenced bug.

|  | [neal](/user_profile?user_id=651911) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1673240#c29)• 4 years ago |
|  | |

(In reply to Nickolay Olshevsky from [comment #10](/show_bug.cgi?id=1673240#c10 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)"))

> Yeah, sorry, forgot to mention this in the first comment. If there are no valid signatures on the uid, primary flag is dropped.

This is unfortunate. A certificate should always have exactly one primary User ID unless there are no self-signed User IDs. If all self signed User IDs are revoked or expired, then a revoked or expired User ID should be used. This is important, because the Primary User IDs self signature provides information about the primary key and certificate, e.g., key expiration, key flags, etc.

|  | [Wayne Mery (:wsmwk)](/user_profile?user_id=29811)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1673240#a19628279_29811)• 4 years ago |

Group: mail-core-security

|  | [u617804](/user_profile?user_id=617804) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1673240#c30)• 4 years ago |
|  | |

(In reply to neal from [comment #27](/show_bug.cgi?id=1673240#c27 "RESOLVED FIXED - RNP-01-014 WP1 Thunderbird: Key manipulation via uncertified Auto-Import (Medium)"))

> This is horribly, horribly wrong. Do not ask the user about importing new certificates. Subkeys and User IDs are authenticated via binding signatures. The user cannot make an informed choice. Do not make the OpenPGP support less usable then it already is.

That's what I thought, too, when reading the Cure53 report.

You need to [log in](/show_bug.cgi?id=1673240&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Magnus Melin [:mkmelin]](/user_profile?user_id=101158)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.mozilla.org_2dccd29d_20250114_193632.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2021-13

## Security Vulnerabilities fixed in Thunderbird 78.9.1

Announced
April 8, 2021
Impact
moderate
Products
Thunderbird
Fixed in

* Thunderbird 78.9.1

**Note**: This advisory was updated April 20, 2021 to include CVE-2021-29949 which was also fixed in this release.

#### [#CVE-2021-23991: An attacker may use Thunderbird's OpenPGP key refresh mechanism to poison an existing key](#CVE-2021-23991)

Reporter
Cure53
Impact
moderate
##### Description

If a Thunderbird user has previously imported Alice's OpenPGP key, and Alice has extended the validity period of her key, but Alice's updated key has not yet been imported, an attacker may send an email containing a crafted version of Alice's key with an invalid subkey, Thunderbird might subsequently attempt to use the invalid subkey, and will fail to send encrypted email to Alice.

##### References

* [Bug 1673240](https://bugzilla.mozilla.org/show_bug.cgi?id=1673240)

#### [#CVE-2021-23992: A crafted OpenPGP key with an invalid user ID could be used to confuse the user](#CVE-2021-23992)

Reporter
Neal Walfield
Impact
moderate
##### Description

Thunderbird did not check if the user ID associated with an OpenPGP key has a valid self signature. An attacker may create a crafted version of an OpenPGP key, by either replacing the original user ID, or by adding another user ID. If Thunderbird imports and accepts the crafted key, the Thunderbird user may falsely conclude that the false user ID belongs to the correspondent.

##### References

* [Bug 1666236](https://bugzilla.mozilla.org/show_bug.cgi?id=1666236)

#### [#CVE-2021-23993: Inability to send encrypted OpenPGP email after importing a crafted OpenPGP key](#CVE-2021-23993)

Reporter
Neal Walfield
Impact
moderate
##### Description

An attacker may perform a DoS attack to prevent a user from sending encrypted email to a correspondent. If an attacker creates a crafted OpenPGP key with a subkey that has an invalid self signature, and the Thunderbird user imports the crafted key, then Thunderbird may try to use the invalid subkey, but the RNP library rejects it from being used, causing encryption to fail.

##### References

* [Bug 1666360](https://bugzilla.mozilla.org/show_bug.cgi?id=1666360)

#### [#CVE-2021-29949: Thunderbird might execute an alternative OTR library](#CVE-2021-29949)

Reporter
Tuan Vu Pham
Impact
low
##### Description

When loading the shared library that provides the OTR protocol implementation, Thunderbird will initially attempt to open it using a filename that isn't distributed by Thunderbird. If a computer has already been infected with a malicious library of the alternative filename, and the malicious library has been copied to a directory that is contained in the search path for executable libraries, then Thunderbird will load the incorrect library.

##### References

* [Bug 1682101](https://bugzilla.mozilla.org/show_bug.cgi?id=1682101)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)


