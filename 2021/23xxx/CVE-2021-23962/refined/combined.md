=== Content from www.mozilla.org_7358fcf7_20250115_090621.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2021-03

## Security Vulnerabilities fixed in Firefox 85

Announced
January 26, 2021
Impact
high
Products
Firefox
Fixed in

* Firefox 85

#### [#CVE-2021-23953: Cross-origin information leakage via redirected PDF requests](#CVE-2021-23953)

Reporter
Rob Wu
Impact
high
##### Description

If a user clicked into a specifically crafted PDF, the PDF reader could be confused into leaking cross-origin information, when said information is served as chunked data.

##### References

* [Bug 1683940](https://bugzilla.mozilla.org/show_bug.cgi?id=1683940)

#### [#CVE-2021-23954: Type confusion when using logical assignment operators in JavaScript switch statements](#CVE-2021-23954)

Reporter
Gary Kwong
Impact
high
##### Description

Using the new logical assignment operators in a JavaScript switch statement could have caused a type confusion, leading to a memory corruption and a potentially exploitable crash.

##### References

* [Bug 1684020](https://bugzilla.mozilla.org/show_bug.cgi?id=1684020)

#### [#CVE-2021-23955: Clickjacking across tabs through misusing requestPointerLock](#CVE-2021-23955)

Reporter
Irvan Kurniawan
Impact
high
##### Description

The browser could have been confused into transferring a pointer lock state into another tab, which could have lead to clickjacking attacks.

##### References

* [Bug 1684837](https://bugzilla.mozilla.org/show_bug.cgi?id=1684837)

#### [#CVE-2021-23956: File picker dialog could have been used to disclose a complete directory](#CVE-2021-23956)

Reporter
Abdulrahman Alqabandi
Impact
moderate
##### Description

An ambiguous file picker design could have confused users who intended to select and upload a single file into uploading a whole directory. This was addressed by adding a new prompt.

##### References

* [Bug 1338637](https://bugzilla.mozilla.org/show_bug.cgi?id=1338637)

#### [#CVE-2021-23957: Iframe sandbox could have been bypassed on Android via the intent URL scheme](#CVE-2021-23957)

Reporter
Eliya Stein
Impact
moderate
##### Description

Navigations through the Android-specific `intent` URL scheme could have been misused to escape iframe sandbox.
*Note: This issue only affected Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1584582](https://bugzilla.mozilla.org/show_bug.cgi?id=1584582)

#### [#CVE-2021-23958: Screen sharing permission leaked across tabs](#CVE-2021-23958)

Reporter
Jan-Ivar Bruaroey
Impact
moderate
##### Description

The browser could have been confused into transferring a screen sharing state into another tab, which would leak unintended information.

##### References

* [Bug 1642747](https://bugzilla.mozilla.org/show_bug.cgi?id=1642747)

#### [#CVE-2021-23959: Cross-Site Scripting in error pages on Firefox for Android](#CVE-2021-23959)

Reporter
Muneaki Nishimura
Impact
moderate
##### Description

An XSS bug in internal error pages could have led to various spoofing attacks, including other error pages and the address bar.
*Note: This issue only affected Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1659035](https://bugzilla.mozilla.org/show_bug.cgi?id=1659035)

#### [#CVE-2021-23960: Use-after-poison for incorrectly redeclared JavaScript variables during GC](#CVE-2021-23960)

Reporter
Irvan Kurniawan
Impact
moderate
##### Description

Performing garbage collection on re-declared JavaScript variables resulted in a user-after-poison, and a potentially exploitable crash.

##### References

* [Bug 1675755](https://bugzilla.mozilla.org/show_bug.cgi?id=1675755)

#### [#CVE-2021-23961: More internal network hosts could have been probed by a malicious webpage](#CVE-2021-23961)

Reporter
Samy Kamkar, Ben Seri, and Gregory Vishnepolsky
Impact
moderate
##### Description

Further techniques that built on the slipstream research combined with a malicious webpage could have exposed both an internal network's hosts as well as services running on the user's local machine.

##### References

* [Bug 1677940](https://bugzilla.mozilla.org/show_bug.cgi?id=1677940)

#### [#CVE-2021-23962: Use-after-poison in "nsTreeBodyFrame::RowCountChanged"](#CVE-2021-23962)

Reporter
Chiaki ISHIKAWA
Impact
low
##### Description

Incorrect use of the `RowCountChanged` method could have led to a user-after-poison and a potentially exploitable crash.

##### References

* [Bug 1677194](https://bugzilla.mozilla.org/show_bug.cgi?id=1677194)

#### [#CVE-2021-23963: Permission prompt inaccessible after asking for additional permissions](#CVE-2021-23963)

Reporter
Paul Zühlcke
Impact
low
##### Description

When sharing geolocation during an active WebRTC share, Firefox could have reset the webRTC sharing state in the user interface, leading to loss of control over the currently granted permission

##### References

* [Bug 1680793](https://bugzilla.mozilla.org/show_bug.cgi?id=1680793)

#### [#CVE-2021-23964: Memory safety bugs fixed in Firefox 85 and Firefox ESR 78.7](#CVE-2021-23964)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Andrew McCreight, Tyson Smith, Jesse Schwartzentruber, Jon Coppeard, Byron Campen, André Bargull, Steve Fink, Jason Kratzer, Christian Holler, Alexis Beingessner reported memory safety bugs present in Firefox 84 and Firefox ESR 78.6. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 85 and Firefox ESR 78.7](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1662507%2C1666285%2C1673526%2C1674278%2C1674835%2C1675097%2C1675844%2C1675868%2C1677590%2C1677888%2C1680410%2C1681268%2C1682068%2C1682938%2C1683736%2C1685260%2C1685925)

#### [#CVE-2021-23965: Memory safety bugs fixed in Firefox 85](#CVE-2021-23965)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Sebastian Hengst, Christian Holler, Tyson Smith reported memory safety bugs present in Firefox 84. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 85](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1670378%2C1673555%2C1676812%2C1678582%2C1684497)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_ff9012da_20250115_090620.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1677194)
* [XML](/show_bug.cgi?ctype=xml&id=1677194)

Closed
[Bug 1677194](/show_bug.cgi?id=1677194)
(CVE-2021-23962)

Opened 4 years ago
Closed 4 years ago

# ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)

## Categories

### (Core :: Layout, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Layout#Layout)

Layout
▾

Core :: Layout

Issues in Layout that do not fit into any other Layout component or which span multiple Layout components.

Bugs related to the top level presentation objects (pres shell, pres context, and document viewer), the frame constructor, and the base frame classes, as well as general issues with alignment and sizing, all belong here.

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Layout&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Layout&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Layout)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

85 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr78 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=wontfix) |
| firefox83 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox83&o1=equals&v1=wontfix) |
| firefox84 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox84&o1=equals&v1=wontfix) |
| firefox85 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox85&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr78 |  | wontfix |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox83 |  | wontfix |
| firefox84 |  | wontfix |
| firefox85 |  | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: ishikawa, Assigned: ishikawa)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/72bd216fb7996e1571c307d45a70add2?d=mm&size=40)  [ishikawa](/user_profile?user_id=32503)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/72bd216fb7996e1571c307d45a70add2?d=mm&size=40)  [ishikawa](/user_profile?user_id=32503)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/cd9b85b2e112bd7941b21ad03f42604e?d=mm&size=40)  [dholbert](/user_profile?user_id=278074)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

5 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: csectype-framepoisoning, sec-low, Whiteboard: [post-critsmash-triage][adv-main85+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2021-23962

[Keywords:](/describekeywords.cgi)

[csectype-framepoisoning](/buglist.cgi?keywords=csectype-framepoisoning&resolution=---),
[sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main85+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [btot](/user_profile?user_id=553429) | [qe-verify](#a827364_553429 "4 years ago") | - |
| --- | --- | --- |
| [btot](/user_profile?user_id=553429) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files, 1 obsolete file)

| [ASAN error log for use-after-poison](/attachment.cgi?id=9187752)  [4 years ago](#c0)  [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)   17.81 KB, text/plain |  | [Details](/attachment.cgi?id=9187752&action=edit) |
| --- | --- | --- |
| [verbose log.](/attachment.cgi?id=9188482)  [4 years ago](#c7)  [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)   20.32 KB, text/plain |  | [Details](/attachment.cgi?id=9188482&action=edit) |
| [1677194.patch patch to fix the issue.](/attachment.cgi?id=9188712)  [4 years ago](#c14)  [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)   1.33 KB, patch |  | [Details](/attachment.cgi?id=9188712&action=edit) | [Diff](/attachment.cgi?id=9188712&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712) |
| [Patch, take two.](/attachment.cgi?id=9188843)  [4 years ago](#c19)  [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)   1.18 KB, patch | emilio : [review+](#c20 "4 years ago") | [Details](/attachment.cgi?id=9188843&action=edit) | [Diff](/attachment.cgi?id=9188843&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188843) |
| [advisory.txt](/attachment.cgi?id=9198156)  [4 years ago](#c25)  [Frederik Braun [:freddy]](/user_profile?user_id=428608)   217 bytes, text/plain |  | [Details](/attachment.cgi?id=9198156&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1677194#c0)• 4 years ago |
|  | |

Attached file
[ASAN error log for use-after-poison](attachment.cgi?id=9187752)
— [Details](attachment.cgi?id=9187752&action=edit)

I noticed a use-after-poison error when I ran

ASAN-version of C-C TB under its mochitest test suite

locally.

The full log is attached.

The line numbers may be slightly off due to local patches.

The error is detected during

test\_delete\_last\_message\_from\_virtual\_folder\_closes\_message\_displays test

in

comm/mail/test/browser/folder-display/browser\_deletionFromVirtualFolders.js

I think it relates to

nsTreeBodyFreame::RowCountChanged() <- the user

NS\_NewBoxFrame() <- allocator

So I am choosing the component accordingly, but maybe I am wrong.

```
208:45.77 TEST_START: comm/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js
208:45.77 GECKO(95056) Chrome file doesn't exist: /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/_tests/testing/mochitest/browser/comm/mail/test/browser/folder-display/head.js
208:45.78 INFO Entering test bound setupModule
...
209:27.67 INFO Entering test bound test_delete_last_message_from_virtual_folder_closes_message_displays
...
209:27.78 GECKO(95056) ==95056==ERROR: AddressSanitizer: use-after-poison on address 0x62500006376c at pc 0x7f527a848909 bp 0x7ffcb55a9f90 sp 0x7ffcb55a9f88
209:27.78 GECKO(95056) READ of size 4 at 0x62500006376c thread T0
209:28.58 GECKO(95056) error: address range table at offset 0xd50 has an invalid tuple (length = 0) at offset 0xd60
209:28.96 GECKO(95056)	   #0 0x7f527a848908 in nsTreeBodyFrame::RowCountChanged(int, int) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/xul/tree/nsTreeBodyFrame.cpp:1606:7
209:28.97 GECKO(95056)	   #1 0x7f526c12a0ab in nsMsgDBView::NoteChange(unsigned int, int, int) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgDBView.cpp:5951:16
209:28.97 GECKO(95056)	   #2 0x7f526c0fdfa4 in nsMsgDBView::RemoveByIndex(unsigned int) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgDBView.cpp:3001:5
209:28.97 GECKO(95056)	   #3 0x7f526c29c082 in nsMsgThreadedDBView::RemoveByIndex(unsigned int) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgThreadedDBView.cpp:869:25
209:28.97 GECKO(95056)	   #4 0x7f526c128fd0 in nsMsgDBView::OnHdrDeleted(nsIMsgDBHdr*, unsigned int, int, nsIDBChangeListener*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgDBView.cpp:5844:5
209:28.98 GECKO(95056)	   #5 0x7f526c17f91b in nsMsgGroupView::OnHdrDeleted(nsIMsgDBHdr*, unsigned int, int, nsIDBChangeListener*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgGroupView.cpp:636:25
209:28.98 GECKO(95056)	   #6 0x7f526c25eb47 in nsMsgQuickSearchDBView::OnHdrDeleted(nsIMsgDBHdr*, unsigned int, int, nsIDBChangeListener*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgQuickSearchDBView.cpp:798:31
209:28.99 GECKO(95056)	   #7 0x7f526c5508e4 in nsMsgDatabase::NotifyHdrDeletedAll(nsIMsgDBHdr*, unsigned int, int, nsIDBChangeListener*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/db/msgdb/src/nsMsgDatabase.cpp:817:3
209:28.99 GECKO(95056)	   #8 0x7f526c55f2bd in nsMsgDatabase::DeleteHeader(nsIMsgDBHdr*, nsIDBChangeListener*, bool, bool) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/db/msgdb/src/nsMsgDatabase.cpp:1844:5
209:28.99 GECKO(95056)	   #9 0x7f526c9f1925 in nsMsgLocalMailFolder::DeleteMessages(nsIArray*, nsIMsgWindow*, bool, bool, nsIMsgCopyServiceListener*, bool) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/local/src/nsLocalMailFolder.cpp:1063:25
209:29.00 GECKO(95056)	   #10 0x7f526ca1616d in nsMsgLocalMailFolder::EndMove(bool) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/local/src/nsLocalMailFolder.cpp:2699:21
209:29.00 GECKO(95056)	   #11 0x7f526bf58669 in nsCopyMessageStreamListener::EndCopy(nsISupports*, nsresult) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsCopyMessageStreamListener.cpp:135:39
209:29.00 GECKO(95056)	   #12 0x7f526bf5928d in nsCopyMessageStreamListener::OnStopRequest(nsIRequest*, nsresult) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsCopyMessageStreamListener.cpp:155:10
209:29.00 GECKO(95056)	   #13 0x7f526c22dcad in nsMsgProtocol::OnStopRequest(nsIRequest*, nsresult) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgProtocol.cpp:387:29
209:29.00 GECKO(95056)	   #14 0x7f526ca4b636 in nsMailboxProtocol::OnStopRequest(nsIRequest*, nsresult) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/local/src/nsMailboxProtocol.cpp:400:18
209:29.02 GECKO(95056)	   #15 0x7f526d73210d in nsInputStreamPump::OnStateStop() /NEW-SSD/NREF-COMM-CENTRAL/mozilla/netwerk/base/nsInputStreamPump.cpp:649:16
209:29.02 GECKO(95056)	   #16 0x7f526d72fec5 in nsInputStreamPump::OnInputStreamReady(nsIAsyncInputStream*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/netwerk/base/nsInputStreamPump.cpp:397:21
209:29.02 GECKO(95056)	   #17 0x7f526d732bfc in non-virtual thunk to nsInputStreamPump::OnInputStreamReady(nsIAsyncInputStream*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/netwerk/base/nsInputStreamPump.cpp
209:29.03 GECKO(95056)	   #18 0x7f526d1a04d8 in mozilla::SlicedInputStream::OnInputStreamReady(nsIAsyncInputStream*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/io/SlicedInputStream.cpp:416:22
209:29.04 GECKO(95056)	   #19 0x7f526d21c23d in nsInputStreamReadyEvent::Run() /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/io/nsStreamUtils.cpp:94:20
209:29.05 GECKO(95056)	   #20 0x7f526d2da356 in mozilla::RunnableTask::Run() /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/threads/TaskController.cpp:450:16
209:29.05 GECKO(95056)	   #21 0x7f526d2cb29f in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/threads/TaskController.cpp:720:26
209:29.05 GECKO(95056)	   #22 0x7f526d2c84ab in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/threads/TaskController.cpp:579:15
209:29.05 GECKO(95056)	   #23 0x7f526d2c8afd in mozilla::TaskController::ProcessPendingMTTask(bool) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/threads/TaskController.cpp:373:36
209:29.05 GECKO(95056)	   #24 0x7f526d2cc9a9 in operator() /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/threads/TaskController.cpp:123:37
209:29.05 GECKO(95056)	   #25 0x7f526d2cc9a9 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_4>::Run() /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/include/nsThreadUtils.h:577:5
209:29.08 GECKO(95056)	   #26 0x7f526d30e5ec in nsThread::ProcessNextEvent(bool, bool*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/threads/nsThread.cpp:1197:14
209:29.08 GECKO(95056)	   #27 0x7f526d3904c1 in NS_InvokeByIndex /NEW-SSD/NREF-COMM-CENTRAL/mozilla/xpcom/reflect/xptcall/md/unix/xptcinvoke_asm_x86_64_unix.S:101
209:29.10 GECKO(95056)	   #28 0x7f526feae752 in Invoke /NEW-SSD/NREF-COMM-CENTRAL/mozilla/js/xpconnect/src/XPCWrappedNative.cpp:1620:10
209:29.10 GECKO(95056)	   #29 0x7f526feae752 in CallMethodHelper::Call() /NEW-SSD/NREF-COMM-CENTRAL/mozilla/js/xpconnect/src/XPCWrappedNative.cpp:1176:19
209:29.10 GECKO(95056)	   #30 0x7f526fe6f2b3 in XPCWrappedNative::CallMethod(XPCCallContext&, XPCWrappedNative::CallMode) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/js/xpconnect/src/XPCWrappedNative.cpp:1142:23
209:29.10 GECKO(95056)	   #31 0x7f526fe73043 in XPC_WN_CallMethod(JSContext*, unsigned int, JS::Value*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/js/xpconnect/src/XPCWrappedNativeJSOps.cpp:925:10
209:29.10 GECKO(95056)	   #32 0x178b5a98e80e  (<unknown module>)

```

Full log is attached.

Just in case, I am setting security flag. Please clear it as people see fit.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a290491_1689)• 4 years ago |

Group: core-security → layout-core-securityKeywords: [csectype-framepoisoning](/buglist.cgi?keywords=csectype-framepoisoning&resolution=---)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1677194#c1)• 4 years ago |
|  | |

Seems like [this](https://searchfox.org/mozilla-central/rev/ff82c973f8ccb0475ec32439e9ec07014b3a681f/layout/xul/tree/nsTreeBodyFrame.cpp#1601-1604) can flush layout and kill the frame.

So easy fix would be to add an `AutoWeakFrame` around it and check it.

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1677194#c2)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1677194&comment_id=15136456 "1 revision") |
|  | |

(In reply to Emilio Cobos Álvarez (:emilio) from [comment #1](/show_bug.cgi?id=1677194#c1 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> Seems like [this](https://searchfox.org/mozilla-central/rev/ff82c973f8ccb0475ec32439e9ec07014b3a681f/layout/xul/tree/nsTreeBodyFrame.cpp#1601-1604) can flush layout and kill the frame.
>
> So easy fix would be to add an `AutoWeakFrame` around it and check it.

I am not familiar with layout code:

But I see that either |mView| or |sel| is invalid and points at a location inside released heap.

I think it is unlikely that |mView| is wrong.

```
  // Adjust our selection.
  nsCOMPtr<nsITreeSelection> sel;
  mView->GetSelection(getter_AddRefs(sel)); <===  I take |sel| becomes the invalid pointer.
  if (sel) sel->AdjustSelection(aIndex, aCount);

```

I do hit selection-count related assertions, etc. during C-C TB during testing for some time , and I have been wondering how that can happen.

It would be great that at least this particular problem can be eliminated.

BTW, shouldn't the code be better like the following?

```
  nsCOMPtr<nsITreeSelection> sel = nullptr;
 nsresult rc =  mView->GetSelection(getter_AddRefs(sel)); <===  I take |sel| becomes the invalid pointer.
  if (NS_OK(rc) && sel) sel->AdjustSelection(aIndex, aCount);

```

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1677194#c3)• 4 years ago |
|  | |

I assume 'this' becomes invalid when nsTreeBodyFrame::RowCountChanged is called. That is the frame emilio mentioned.

Perhaps something like.

AutoWeakFrame weakFrame(this);

nsCOMPtr<nsITreeView> view = mView;

view->GetSelection(...);

NS\_ENSURE\_STATE(weakFrame.IsAlive());

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1677194#c4)• 4 years ago |
|  | |

Let me see if the above outline modifies the behavior of the ASAN test.

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1677194#c5)• 4 years ago |
|  | |

I have a question. See the comment.

(In reply to Olli Pettay [:smaug] from [comment #3](/show_bug.cgi?id=1677194#c3 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> I assume 'this' becomes invalid when nsTreeBodyFrame::RowCountChanged is called. That is the frame emilio mentioned.
>
> Perhaps something like.
>
> AutoWeakFrame weakFrame(this);
>
> nsCOMPtr<nsITreeView> view = mView;
>
> view->GetSelection(...);
>
> <==== This is |view->| and NOT |mView->| as in the original, correct?
>
> NS\_ENSURE\_STATE(weakFrame.IsAlive());

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1677194#c6)• 4 years ago |
|  | |

The following patch does not eliminate the issue.

We still get the similar ASAN error.

```
diff --git a/layout/xul/tree/nsTreeBodyFrame.cpp b/layout/xul/tree/nsTreeBodyFrame.cpp
--- a/layout/xul/tree/nsTreeBodyFrame.cpp
+++ b/layout/xul/tree/nsTreeBodyFrame.cpp
@@ -1593,20 +1593,28 @@ nsresult nsTreeBodyFrame::RowCountChange
   if (aCount == 0 || !mView) return NS_OK;  // Nothing to do.

 #ifdef ACCESSIBILITY
   if (PresShell::IsAccessibilityActive()) {
     FireRowCountChangedEvent(aIndex, aCount);
   }
 #endif  // #ifdef ACCESSIBILITY

-  // Adjust our selection.
-  nsCOMPtr<nsITreeSelection> sel;
-  mView->GetSelection(getter_AddRefs(sel));
-  if (sel) sel->AdjustSelection(aIndex, aCount);
+  // Validate pointer. Bug 1677194
+  AutoWeakFrame weakFrame(this);
+  nsCOMPtr<nsITreeView> view = mView;
+
+  // Adjust our selection. Note the use of |view| instead of |mView|
+  nsCOMPtr<nsITreeSelection> sel = nullptr;
+  nsresult rc = view->GetSelection(getter_AddRefs(sel));
+
+  // Check
+  NS_ENSURE_STATE(weakFrame.IsAlive());
+
+  if (NS_SUCCEEDED(rc) && sel) sel->AdjustSelection(aIndex, aCount);

   if (mUpdateBatchNest) return NS_OK;

   mRowCount += aCount;
 #ifdef DEBUG
   int32_t rowCount = mRowCount;
   mView->GetRowCount(&rowCount);
   NS_ASSERTION(
ishikawa@ip030:/NREF-COMM-CENTRAL/mozilla$

```

Shouldn't we add a similar check for |sel| just before the following line to see if |sel| is valid?

But I am not sure what that check is like.

```
  if (NS_SUCCEEDED(rc) && sel) sel->AdjustSelection(aIndex, aCount);

```

Well, if |sel| is invalid, there has been a path that screws up the internal data structure to return an invalid pointer value in |sel| though.

Oh, BTW, the switched use of |view->| and |mView->| do not make any differences as far as the ASAN error is concerned.

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1677194#c7)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1677194&comment_id=15136915 "1 revision") |
|  | |

Attached file
[verbose log.](attachment.cgi?id=9188482)
— [Details](attachment.cgi?id=9188482&action=edit)

So the problematic pointer value was used to read 4 bytes at

0x625001200e44.

BTW, at the time of the error.

this = 0x625001200d10

The memory area was allocated by the following chain of functions, and it was 8KB at the allocation time.

(Too bad, ASAN doesn't say when the area was poisoned after free?)

although the area is very close to the area pointed at by |this|,

it may not be related. I am not sure.

```

 1:50.87 GECKO(518898) 0x625001200e44 is located 5444 bytes inside of 8192-byte region [0x6250011ff900,0x625001201900)
 1:50.87 GECKO(518898) allocated by thread T0 here:
 1:50.93 GECKO(518898)     #0 0x55a5d5f1376d in malloc (/NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/bin/thunderbird+0x16176d)
 1:50.93 GECKO(518898)     #1 0x7f44b8ff2728 in AllocateChunk /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/include/mozilla/ArenaAllocator.h:171:15
 1:50.93 GECKO(518898)     #2 0x7f44b8ff2728 in InternalAllocate /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/include/mozilla/ArenaAllocator.h:205:25
 1:50.93 GECKO(518898)     #3 0x7f44b8ff2728 in mozilla::ArenaAllocator<8192ul, 8ul>::Allocate(unsigned long, std::nothrow_t const&) /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/include/mozilla/ArenaAllocator.h:67:12
 1:50.93 GECKO(518898)     #4 0x7f44c5ccf2c7 in Allocate /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/include/mozilla/ArenaAllocator.h:71:15
 1:50.93 GECKO(518898)     #5 0x7f44c5ccf2c7 in nsPresArena<8192ul, mozilla::ArenaObjectID, 176ul>::Allocate(mozilla::ArenaObjectID, unsigned long) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/base/nsPresArena.cpp:100:16
 1:50.93 GECKO(518898)     #6 0x7f44c670c13a in AllocateByObjectID /NEW-SSD/ASAN-OBJ-DIR/objdir-tb3/dist/include/mozilla/PresShell.h:260:32
 1:50.93 GECKO(518898)     #7 0x7f44c670c13a in operator new /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.h:103:39
 1:50.93 GECKO(518898)     #8 0x7f44c670c13a in mozilla::FrameLayerBuilder::StoreDataForFrame(nsPaintedDisplayItem*, mozilla::layers::Layer*, mozilla::LayerState, mozilla::DisplayItemData*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.cpp:5504:34
 1:50.93 GECKO(518898)     #9 0x7f44c670de1b in mozilla::FrameLayerBuilder::AddPaintedDisplayItem(mozilla::PaintedLayerData*, mozilla::AssignedDisplayItem&, mozilla::layers::Layer*) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.cpp:5370:14
 1:50.93 GECKO(518898)     #10 0x7f44c66dce8d in FinishPaintedLayerData<(lambda at /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.cpp:3144:52)> /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.cpp:3501:20
 1:50.93 GECKO(518898)     #11 0x7f44c66dce8d in mozilla::PaintedLayerDataNode::PopAllPaintedLayerData() /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.cpp:3144:23
 1:50.93 GECKO(518898)     #12 0x7f44c66db420 in mozilla::PaintedLayerDataNode::Finish(bool) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/painting/FrameLayerBuilder.cpp:3113:3

   ....  see attached log for full trace ...

```

The attached log was produced by the following patch.

```
diff --git a/layout/xul/tree/nsTreeBodyFrame.cpp b/layout/xul/tree/nsTreeBodyFrame.cpp
--- a/layout/xul/tree/nsTreeBodyFrame.cpp
+++ b/layout/xul/tree/nsTreeBodyFrame.cpp
@@ -1593,20 +1593,36 @@ nsresult nsTreeBodyFrame::RowCountChange
   if (aCount == 0 || !mView) return NS_OK;  // Nothing to do.

 #ifdef ACCESSIBILITY
   if (PresShell::IsAccessibilityActive()) {
     FireRowCountChangedEvent(aIndex, aCount);
   }
 #endif  // #ifdef ACCESSIBILITY

-  // Adjust our selection.
-  nsCOMPtr<nsITreeSelection> sel;
-  mView->GetSelection(getter_AddRefs(sel));
-  if (sel) sel->AdjustSelection(aIndex, aCount);
+  // Validate pointer. Bug 1677194
+  AutoWeakFrame weakFrame(this);
+  nsCOMPtr<nsITreeView> view = mView;
+
+  // Adjust our selection. Note the use of |view| instead of |mView|
+  nsCOMPtr<nsITreeSelection> sel = nullptr;
+#if DEBUG
+  printf("RowCountChanged(): view = %p, sel = %p, this = %p\n", (void *) view, (void *) sel, (void *) this);
+  fflush(stdout);
+#endif
+  nsresult rc = view->GetSelection(getter_AddRefs(sel));
+  // Check
+  NS_ENSURE_STATE(weakFrame.IsAlive());
+
+#if DEBUG
+  printf("RowCountChanged(): view = %p, sel = %p, this = %p\n", (void *) view, (void *) sel, (void *) this);
+  fflush(stdout);
+#endif
+
+  if (NS_SUCCEEDED(rc) && sel) sel->AdjustSelection(aIndex, aCount);

   if (mUpdateBatchNest) return NS_OK;

   mRowCount += aCount;
 #ifdef DEBUG
   int32_t rowCount = mRowCount;
   mView->GetRowCount(&rowCount);
   NS_ASSERTION(

```

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1677194#c8)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1677194&comment_id=15136926 "4 revisions") |
|  | |

|this| is a valid pointer as far as weakFrame.IsAlive() check is concerned, I think.

Yet, pointer to (((char\*)this) + 0x134) [ = 0x625001200e44.] points at an area already poisoned.

Wait. 0x134 (hex) = 308.

308 / 8 = 38.

According to the memory block status reported by ASAN (each byte signifies 8 bytes of user memory.),

we count back 38 bytes from the problematic location ([f7]).

From the status info, we find that |this| points at an already poisoned area.

weakFrame returns true |IsAlive()|.

Something is amiss here, isn't it?

```

 1:51.06 GECKO(518898) Shadow bytes around the buggy address:
 1:51.06 GECKO(518898)   0x0c4a80238170: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a80238180: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a80238190: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a802381a0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7  <--- |this| seems to point at somewhere here.
...............................................................xxx
 1:51.06 GECKO(518898)   0x0c4a802381b0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898) =>0x0c4a802381c0: f7 f7 f7 f7 f7 f7 f7 f7[f7]f7 f7 f7 f7 f7 f7 f7  <=== invalid read
 1:51.06 GECKO(518898)   0x0c4a802381d0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a802381e0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a802381f0: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a80238200: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898)   0x0c4a80238210: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
 1:51.06 GECKO(518898) Shadow byte legend (one shadow byte represents 8 application bytes):

```

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1677194#c9)• 4 years ago |
|  | |

no, your patch is wrong, is the `AdjustSelection` call what kills `this`. So you need to `NS_ENSURE_STATE(weakFrame.IsAlive());` after that.

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1677194#c10)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1677194&comment_id=15137062 "2 revisions") |
|  | |

Oh, I see. Let me try again.

Well, though, it looks to me that the incorrect access reported by ASAN already occurs by that time, so

I am not sure what we should do about it.

Aha, now I see it. The problem could also happen at the reference of mUpdateBatchNest. That can be solved by the check.

(If not, the symptom noticed here may have already been caused by some free/poison action without invalidating a pointer value in a a variable (or two?)

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1677194#c11)• 4 years ago |
|  | |

The added check after AdjustSelection() seems to eliminate the issue.

I will re-run the whole xpcshelltest for both mochitest and xpcshelltest of ASAN version of C-C TB to see if this introduces new error or something.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1677194#c12)• 4 years ago |
|  | |

Please clear the sec-low to trigger a re-triage if you find that the freed/poisoned object is anything that is not an nsIFrame.

Keywords: [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a446676_32503)• 4 years ago |

Assignee: nobody → ishikawa

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1677194#c13)• 4 years ago |
|  | |

(In reply to Daniel Veditz [:dveditz] from [comment #12](/show_bug.cgi?id=1677194#c12 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> Please clear the sec-low to trigger a re-triage if you find that the freed/poisoned object is anything that is not an nsIFrame.

I think the problem was caused by the access to

|mUpdateBatchNest|, i.e. this ->mUpdateBatchNest.

It is a bit hard to figure out exactly where the pointer points at a block since the

ASAN compilation seems to align variables a bit differently from ordinary compilation

to make it easy to detect invalid access to

variables by separating them apart, etc. unless they are the members of an array.

valgrind would have made it easy to verify this, but

unfortunately, mochitest of TB does not run under valgrind currently.

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1677194#c14)• 4 years ago |
|  | |

Attached patch

[1677194.patch patch to fix the issue.](attachment.cgi?id=9188712&action=diff) (obsolete)
— [Details](attachment.cgi?id=9188712&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712)

Patch attached.

Push job tested on tryserver for C-C TB build and test with the patch

<https://treeherder.mozilla.org/jobs?repo=try-comm-central&revision=80a6150ff18ea26585282a11f4b25da5c9811613>

I am not worried about windows failure because others get busted, too.

Please see the job status under comm-central repos. You will see windows not doing good there.

[Attachment #9188712](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") -
Flags: review?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1677194#c15)• 4 years ago |
|  | |

Comment on [attachment 9188712](/attachment.cgi?id=9188712 "1677194.patch patch to fix the issue.") [[details]](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") [[diff]](/attachment.cgi?id=9188712&action=diff "1677194.patch patch to fix the issue.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712)
1677194.patch patch to fix the issue.
Review of [attachment 9188712](/attachment.cgi?id=9188712 "1677194.patch patch to fix the issue.") [[details]](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") [[diff]](/attachment.cgi?id=9188712&action=diff "1677194.patch patch to fix the issue.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712):
-----------------------------------------------------------------
Looks good, but I'd like to see the bits below fixed before granting r+, thanks!
::: layout/xul/tree/nsTreeBodyFrame.cpp
@@ +1597,5 @@
> FireRowCountChangedEvent(aIndex, aCount);
> }
> #endif // #ifdef ACCESSIBILITY
>
> + // Validate pointer. [Bug 1677194](/show_bug.cgi?id=1677194 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)")
I'd just remove the comment. Blame is for this.
@@ +1599,5 @@
> #endif // #ifdef ACCESSIBILITY
>
> + // Validate pointer. [Bug 1677194](/show_bug.cgi?id=1677194 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)")
> + AutoWeakFrame weakFrame(this);
> + nsCOMPtr<nsITreeView> view = mView;
I don't think you need this local fwiw. But anyhow no big deal.
@@ +1602,5 @@
> + AutoWeakFrame weakFrame(this);
> + nsCOMPtr<nsITreeView> view = mView;
> +
> + // Adjust our selection. Note the use of |view| instead of |mView|
> + nsCOMPtr<nsITreeSelection> sel = nullptr;
Trailing space, and useless `= nullptr`.
@@ +1603,5 @@
> + nsCOMPtr<nsITreeView> view = mView;
> +
> + // Adjust our selection. Note the use of |view| instead of |mView|
> + nsCOMPtr<nsITreeSelection> sel = nullptr;
> + nsresult rc = view->GetSelection(getter\_AddRefs(sel));
no need to check `rc` (and also should be called `rv`). `sel` will never be non-null if it fails, so the code as it was was fine.
@@ +1607,5 @@
> + nsresult rc = view->GetSelection(getter\_AddRefs(sel));
> +
> + if (NS\_SUCCEEDED(rc) && sel) sel->AdjustSelection(aIndex, aCount);
> +
> + // Check
Useless comment.
[Attachment #9188712](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") -
Flags: review?(emilio)

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1677194#c16)• 4 years ago |
|  | |

Will do.(In reply to Emilio Cobos Álvarez (:emilio) from [comment #15](/show_bug.cgi?id=1677194#c15 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> Comment on [attachment 9188712](/attachment.cgi?id=9188712 "1677194.patch patch to fix the issue.") [[details]](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") [[diff]](/attachment.cgi?id=9188712&action=diff "1677194.patch patch to fix the issue.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712)
>
> 1677194.patch patch to fix the issue.
>
> ## Review of [attachment 9188712](/attachment.cgi?id=9188712 "1677194.patch patch to fix the issue.") [[details]](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") [[diff]](/attachment.cgi?id=9188712&action=diff "1677194.patch patch to fix the issue.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712):
>
> Looks good, but I'd like to see the bits below fixed before granting r+,
>
> thanks!

Will do.

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1677194#c17)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1677194&comment_id=15138977 "1 revision") |
|  | |

(In reply to ISHIKAWA, Chiaki from [comment #13](/show_bug.cgi?id=1677194#c13 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> (In reply to Daniel Veditz [:dveditz] from [comment #12](/show_bug.cgi?id=1677194#c12 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))
>
> > Please clear the sec-low to trigger a re-triage if you find that the freed/poisoned object is anything that is not an nsIFrame.
>
> I think the problem was caused by the access to
>
> |mUpdateBatchNest|, i.e. this ->mUpdateBatchNest.
>
> It is a bit hard to figure out exactly where the pointer points at a block since the
>
> ASAN compilation seems to align variables a bit differently from ordinary compilation
>
> to make it easy to detect invalid access to
>
> variables by separating them apart, etc. unless they are the members of an array.
>
> valgrind would have made it easy to verify this, but
>
> unfortunately, mochitest of TB does not run under valgrind currently.

Silly me, I can simply print out the address of |mUpdateBatchNest| and let the original bug to occur and recorded by ASAN binary, then compare the addresses.

Bingo.

The problematic address is indeed &mUpdateBatchNest.

```
 1:57.14 GECKO(727918) {streamdebug} closing: outputStream (= 0x606001459288 )->Close() 'before possible Close()' in ChangeFlags  at line 990 of /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/local/src/nsMsgBrkMBoxStore.cpp
 1:57.14 GECKO(727918) {streamdebug} value: outputStream = 0x606001459288 'setting to nullptr' in ChangeFlags  at line 996 of /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/local/src/nsMsgBrkMBoxStore.cpp
 1:57.14 GECKO(727918) &mUpdateBatchNest = 0x6250005745b4
 1:57.14 GECKO(727918) &mUpdateBatchNest = 0x6250018c559c
 1:57.14 GECKO(727918) =================================================================
 1:57.14 GECKO(727918) ==727918==ERROR: AddressSanitizer: use-after-poison on address 0x6250018c559c at pc 0x7f3a7d08c90a bp 0x7fffdacf1c10 sp 0x7fffdacf1c08
 1:57.14 GECKO(727918) READ of size 4 at 0x6250018c559c thread T0
 1:57.20 GECKO(727918) error: address range table at offset 0xd50 has an invalid tuple (length = 0) at offset 0xd60
 1:57.20 GECKO(727918)     #0 0x7f3a7d08c909 in nsTreeBodyFrame::RowCountChanged(int, int) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/layout/xul/tree/nsTreeBodyFrame.cpp:1614:7
 1:57.20 GECKO(727918)     #1 0x7f3a6e92c12b in nsMsgDBView::NoteChange(unsigned int, int, int) /NEW-SSD/NREF-COMM-CENTRAL/mozilla/comm/mailnews/base/src/nsMsgDBView.cpp:5951:16

```

I am clearing sec-low keyword.

Keywords: [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1677194#c18)• 4 years ago |
|  | |

Ah, I misundestood the suggestion. I am resetting sec-low flag!

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a473092_32503)• 4 years ago |

Keywords: [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1677194#c19)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1677194&comment_id=15139505 "1 revision") |
|  | |

Attached patch

[Patch, take two.](attachment.cgi?id=9188843&action=diff)
— [Details](attachment.cgi?id=9188843&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188843)

Revsied patch.

(In reply to Emilio Cobos Álvarez (:emilio) from [comment #15](/show_bug.cgi?id=1677194#c15 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> Comment on [attachment 9188712](/attachment.cgi?id=9188712 "1677194.patch patch to fix the issue.") [[details]](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") [[diff]](/attachment.cgi?id=9188712&action=diff "1677194.patch patch to fix the issue.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712)
>
> 1677194.patch patch to fix the issue.
>
> ## Review of [attachment 9188712](/attachment.cgi?id=9188712 "1677194.patch patch to fix the issue.") [[details]](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") [[diff]](/attachment.cgi?id=9188712&action=diff "1677194.patch patch to fix the issue.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188712):
>
> Looks good, but I'd like to see the bits below fixed before granting r+,
>
> thanks!

Thank you.

> ::: layout/xul/tree/nsTreeBodyFrame.cpp
>
> @@ +1597,5 @@
>
> > ```
> >  FireRowCountChangedEvent(aIndex, aCount);
> >
> > ```
> >
> > }
> >
> > #endif // #ifdef ACCESSIBILITY
> >
> > * // Validate pointer. [Bug 1677194](/show_bug.cgi?id=1677194 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)")
>
> I'd just remove the comment. Blame is for this.

Removed. I am from an older generation who needed to dealt with communication break down, or other problems often.

Having the comments IN THE SOURCE FILE was useful. But I removed the comment.

> @@ +1599,5 @@
>
> > #endif // #ifdef ACCESSIBILITY
> >
> > * // Validate pointer. [Bug 1677194](/show_bug.cgi?id=1677194 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)")
> > * AutoWeakFrame weakFrame(this);
> > * nsCOMPtr<nsITreeView> view = mView;
>
> I don't think you need this local fwiw. But anyhow no big deal.

I just followed the previous comment and so left this as is.

I did not know what I was doing. :-)

> @@ +1602,5 @@
>
> > * AutoWeakFrame weakFrame(this);
> > * nsCOMPtr<nsITreeView> view = mView;
> > * // Adjust our selection. Note the use of |view| instead of |mView|
> > * nsCOMPtr<nsITreeSelection> sel = nullptr;
>
> Trailing space, and useless `= nullptr`.

Taken care of.

> @@ +1603,5 @@
>
> > * nsCOMPtr<nsITreeView> view = mView;
> > * // Adjust our selection. Note the use of |view| instead of |mView|
> > * nsCOMPtr<nsITreeSelection> sel = nullptr;
> > * nsresult rc = view->GetSelection(getter\_AddRefs(sel));
>
> no need to check `rc` (and also should be called `rv`). `sel` will never be
>
> non-null if it fails, so the code as it was was fine.
>
> @@ +1607,5 @@
>
> > * nsresult rc = view->GetSelection(getter\_AddRefs(sel));
> > * if (NS\_SUCCEEDED(rc) && sel) sel->AdjustSelection(aIndex, aCount);

Reverted to the original.

> > * // Check
>
> Useless comment.

Took out.

tryserver run:

try-comm-central:

<https://treeherder.mozilla.org/jobs?repo=try-comm-central&revision=4a86f4fcf258f3eb6083e0bc76f34eff9f52381a>

(I am not worried with windows issues. They are in comm-central runs as well.)

It does not introduce new bugs, and it certainly does NOT trigger the ASAN error anymore.

[Attachment #9188712](/attachment.cgi?id=9188712&action=edit "1677194.patch patch to fix the issue.") -
Attachment is obsolete: true
[Attachment #9188843](/attachment.cgi?id=9188843&action=edit "Patch, take two.") -
Flags: review?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1677194#c20)• 4 years ago |
|  | |

Comment on [attachment 9188843](/attachment.cgi?id=9188843 "Patch, take two.") [[details]](/attachment.cgi?id=9188843&action=edit "Patch, take two.") [[diff]](/attachment.cgi?id=9188843&action=diff "Patch, take two.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188843)
Patch, take two.
Review of [attachment 9188843](/attachment.cgi?id=9188843 "Patch, take two.") [[details]](/attachment.cgi?id=9188843&action=edit "Patch, take two.") [[diff]](/attachment.cgi?id=9188843&action=diff "Patch, take two.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1677194&attachment=9188843):
-----------------------------------------------------------------
Looks good, thanks!
::: layout/xul/tree/nsTreeBodyFrame.cpp
@@ +1600,5 @@
>
> + AutoWeakFrame weakFrame(this);
> + nsCOMPtr<nsITreeView> view = mView;
> +
> + // Adjust our selection. Note the use of |view| instead of |mView|
I don't think the distinction between `view` and `mView` is relevant, either should work as long as they're kept alive. So the second part of the comment doesn't look terribly useful either, but fine :)
[Attachment #9188843](/attachment.cgi?id=9188843&action=edit "Patch, take two.") -
Flags: review?(emilio) → review+

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1677194#c21)• 4 years ago |
|  | |

Thank you.

As you may have realized, I submit TB patches now and then, but I have not done M-C patch submission using the latest submission tool.

Will someone take care of the landing the patch?

Or I can possibly do it, but I am not sure where to start.

Flags: needinfo?(emilio)

|  | [Emilio Cobos Álvarez (:emilio)](/user_profile?user_id=546716) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1677194#c22)• 4 years ago |
|  | |

Landed manually: <https://hg.mozilla.org/integration/autoland/rev/d467ba314d3c3c167b3e32864dd601f523b868ff>

The official workflow uses phabricator, see <https://firefox-source-docs.mozilla.org/contributing/contribution_quickref.html#to-submit-a-patch>

Flags: needinfo?(emilio)

|  | [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1677194#c23)• 4 years ago |
|  | |

(In reply to Emilio Cobos Álvarez (:emilio) from [comment #22](/show_bug.cgi?id=1677194#c22 "RESOLVED FIXED - ASAN error, use-after-poison, nsTreeBodyFrame::RowCountChanged(int, int)"))

> Landed manually: <https://hg.mozilla.org/integration/autoland/rev/d467ba314d3c3c167b3e32864dd601f523b868ff>
>
> The official workflow uses phabricator, see <https://firefox-source-docs.mozilla.org/contributing/contribution_quickref.html#to-submit-a-patch>

Thank you.

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1677194#c24)• 4 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/d467ba314d3c>

Group: layout-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 4 years ago
[status-firefox85](/buglist.cgi?f1=cf_status_firefox85&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox85&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 85 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a807337_75935)• 4 years ago |

[status-firefox83](/buglist.cgi?f1=cf_status_firefox83&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox83&o1=equals&v1=wontfix)
[status-firefox-esr78](/buglist.cgi?f1=cf_status_firefox_esr78&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=wontfix)

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a827208_553429)• 4 years ago |

Whiteboard: [post-critsmash-triage]

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a827364_553429)• 4 years ago |

Flags: qe-verify-

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a1477018_75935)• 4 years ago |

[status-firefox84](/buglist.cgi?f1=cf_status_firefox84&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox84&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox84&o1=equals&v1=wontfix)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a5836253_428608)• 4 years ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main85+r]

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a5853745_428608)• 4 years ago |

Whiteboard: [post-critsmash-triage][adv-main85+r] → [post-critsmash-triage][adv-main85+]

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1677194#c25)• 4 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9198156)
— [Details](attachment.cgi?id=9198156&action=edit)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a5920103_428608)• 4 years ago |

Alias: CVE-2021-23962

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1677194#a32354950_1689)• 3 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1677194&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [ISHIKAWA, Chiaki (back from day job exhibition event.)](/user_profile?user_id=32503)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


