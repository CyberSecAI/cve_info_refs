=== Content from discuss.hashicorp.com_ca58894e_20250114_215213.html ===


[HashiCorp Discuss](/)

# [HCSEC-2021-09 - Vault’s PKI Engine CRL May Exclude Revoked But Unexpired Certificates After Tidy](/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461)

[Security](/c/security/52)

[security-vault](https://discuss.hashicorp.com/tag/security-vault)

[jfinnigan](https://discuss.hashicorp.com/u/jfinnigan)

April 21, 2021, 8:29pm

1

**Bulletin ID:** HCSEC-2021-09

**Affected Products / Versions:** Vault and Vault Enterprise 1.5.1 and newer; fixed in 1.5.8, 1.6.4, and 1.7.1.

**Publication Date:** April 21, 2021

**Summary**

Vault and Vault Enterprise (“Vault”) PKI Secrets Engine tidy functionality may cause Vault to exclude revoked-but-unexpired certificates from the Vault CRL. This vulnerability, CVE-2021-29653, was fixed in Vault and Vault Enterprise 1.5.8, 1.6.4, and 1.7.1.

**Background**

The Vault [PKI Secrets Engine](https://www.vaultproject.io/docs/secrets/pki) generates dynamic X.509 certificates, supported by Vault’s built-in authentication and authorization mechanisms. Vault provides API endpoints for [certification generation](https://www.vaultproject.io/api/secret/pki#generate-certificate) and [certificate revocation](https://www.vaultproject.io/api/secret/pki#revoke-certificate), among other PKI actions. Vault also exposes a [certificate revocation list](https://www.vaultproject.io/api/secret/pki#read-crl) (CRL) that can be used to enforce certificate revocation.

The PKI Secrets Engine’s [tidy](https://www.vaultproject.io/api/secret/pki#tidy) endpoint allows tidying up the storage backend and/or CRL by removing certificates that have expired and are past a certain buffer period beyond their expiration time. The [tidy\_revoked\_certs](https://www.vaultproject.io/api/secret/pki#tidy_revoked_certs) parameter, which defaults to false, can be set to true to expire all revoked and expired certificates, removing them both from the CRL and from storage.

**Details**

It was discovered that a change to the tidy\_revoked\_certs logic, released in Vault 1.5.1, had an unintended effect of removing revoked-but-unexpired certificates from Vault’s CRL. Environments that utilize this feature may have such certificates excluded from their CRL after a tidy operation and subsequently treated as valid since they are no longer in the CRL and not yet past their NotAfter value.

The tidy\_revoked\_certificates logic for Vault 1.5.1 permanently removed the revoked certificates from Vault storage and, even when the update is applied, a correct CRL cannot be regenerated.

Exposure to this issue requires several conditions to be met:

1. Use the PKI Secrets Engine provided by Vault 1.5.1 or newer.
2. Use the PKI engine’s [certificate revocation mechanism](https://www.vaultproject.io/api/secret/pki#revoke-certificate).
3. Use and enforce the PKI engine’s [certificate revocation list](https://www.vaultproject.io/api/secret/pki#read-crl).
4. Use the PKI engine’s [tidy mechanism](https://www.vaultproject.io/api/secret/pki#tidy), with tidy\_revoked\_certs parameter set to non-default true.

Condition 1 may be investigated by obtaining the current Vault version through the web UI or the /sys/health endpoint. Conditions 2, 3, and 4 may be investigated by reviewing Vault audit or Vault supporting infrastructure (eg. load balancer) logs for usage of the certificate revocation, CRL, and tidy API endpoints (/pki/revoke, /pki/crl, and /pki/tidy).

Even with all conditions met, exposure will be environment-dependent and will vary depending on PKI design, PKI certificate use case, and certificate TTL.

**Remediation**

Customers should review their Vault environment for the conditions noted above, evaluate the risk associated with this issue, and consider upgrading to Vault Enterprise 1.5.8 / 1.6.4 / 1.7.1 or newer. Please refer to [Upgrading Vault](https://www.vaultproject.io/docs/upgrading) for general guidance and version-specific upgrade notes.

Customers for whom the four conditions noted above are true should consider exposure in the context of their environment and PKI design. For example, if all conditions above have been met in an environment where long-lived certificates have been issued and subsequently revoked, and the exclusion of these certificates from the CRL presents unacceptable risk, then it may be necessary to rotate root and/or intermediate CAs to force invalidation of those certificates.

More generally, customers using the PKI secrets engine should consider the lifetime of certificates being issued. By keeping TTLs relatively short, revocations are less likely to be needed, keeping CRLs short and helping the secrets engine scale to large workloads. The Vault documentation contains [guidance](https://www.vaultproject.io/docs/secrets/pki#keep-certificate-lifetimes-short-for-crl-s-sake) on this topic.

**Acknowledgement**

This issue was identified by an external party who reported it to HashiCorp.

*We deeply appreciate any effort to discover and disclose security vulnerabilities responsibly. For information about security at HashiCorp and the reporting of security vulnerabilities, please see <https://hashicorp.com/security>.*

[show post in topic](/t/hcsec-2021-09-vault-s-pki-engine-crl-may-exclude-revoked-but-unexpired-certificates-after-tidy/23461#post_1)

### Related topics

| Topic |  | Replies | Views | Activity |
| --- | --- | --- | --- | --- |
| [PKI tidy removes revoked but not expired certificate](https://discuss.hashicorp.com/t/pki-tidy-removes-revoked-but-not-expired-certificate/22411)  [Vault](/c/vault/30) | 0 | 327 | March 23, 2021 |
| [PKI tidy didn't remove revoked certificates](https://discuss.hashicorp.com/t/pki-tidy-didnt-remove-revoked-certificates/38449)  [Vault](/c/vault/30) | 8 | 3074 | April 21, 2022 |
| [HCSEC-2023-11 - Vault’s PKI Issuer Endpoint Did Not Correctly Authorize Access to Issuer Metadata](https://discuss.hashicorp.com/t/hcsec-2023-11-vault-s-pki-issuer-endpoint-did-not-correctly-authorize-access-to-issuer-metadata/52079)  [Security](/c/security/52) [security-vault](https://discuss.hashicorp.com/tag/security-vault) | 0 | 6250 | March 30, 2023 |
| [HCSEC-2022-24 - Vault's TLS Cert Auth Method Only Loaded CRL After First Request](https://discuss.hashicorp.com/t/hcsec-2022-24-vaults-tls-cert-auth-method-only-loaded-crl-after-first-request/45483)  [Security](/c/security/52) [security-vault](https://discuss.hashicorp.com/tag/security-vault) | 0 | 6817 | October 12, 2022 |
| [HCSEC-2021-15 - Vault Renewed Nearly-Expired Leases With Incorrect Non-Expiring TTLs](https://discuss.hashicorp.com/t/hcsec-2021-15-vault-renewed-nearly-expired-leases-with-incorrect-non-expiring-ttls/24603)  [Security](/c/security/52) [security-vault](https://discuss.hashicorp.com/tag/security-vault) | 1 | 8347 | June 2, 2021 |

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](https://meta.discourse.org/privacy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled


