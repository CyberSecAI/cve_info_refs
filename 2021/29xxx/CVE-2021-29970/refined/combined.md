=== Content from bugzilla.mozilla.org_9e91faba_20250114_191051.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1709976)
* [XML](/show_bug.cgi?ctype=xml&id=1709976)

Closed
[Bug 1709976](/show_bug.cgi?id=1709976)
(CVE-2021-29970)

Opened 4 years ago
Closed 4 years ago

# AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]

## Categories

### (Core :: Disability Access APIs, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Disability%20Access%20APIs#Disability%20Access%20APIs)

Disability Access APIs
▾

Core :: Disability Access APIs
Description: This component relates to bugs in our support for accessibility APIs on the various platforms. Accessibility APIs allow 3rd party products, such as screen readers used by visually impaired users, to communicate with our content and UI. The APIs we support specifically are MSAA on Windows and
ATK on UNIX/Linux (Apple has not yet published specs for an accessibility API on OS X). This component is not for keyboard, focus or any accessibility bugs other than those relating to the APIs we export.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Disability%20Access%20APIs&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Disability%20Access%20APIs&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Disability%20Access%20APIs)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

91 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Score | --- |
| a11y-review | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr78 | [90+](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=equals&v1=90%2B) | [verified](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=verified) |
| firefox88 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox88&o1=equals&v1=wontfix) |
| firefox89 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox89&o1=equals&v1=wontfix) |
| firefox90 | [+](/buglist.cgi?f1=cf_tracking_firefox90&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox90&o1=equals&v1=verified) |
| firefox91 | [+](/buglist.cgi?f1=cf_tracking_firefox91&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox91&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr78 | 90+ | verified |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox88 |  | wontfix |
| firefox89 |  | wontfix |
| firefox90 | + | verified |
| firefox91 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sourc7, Assigned: eeejay)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/61cc67b9e21c81cd289bea0f592cebfe?d=mm&size=40)  [eeejay](/user_profile?user_id=291675)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/1f6e740893c5a41879a277dd0b0a0c4a?d=mm&size=40)  [sourc7](/user_profile?user_id=537720)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/ca7c4bb800037e8d453a5f369f33201c?d=mm&size=40)  [morgan](/user_profile?user_id=618000)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

11 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: csectype-uaf, reporter-external, sec-high, Whiteboard: [reporter-external] [client-bounty-form] [verif?][sec-survey][adv-main90+][adv-esr78.12+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2021-29970

[Keywords:](/describekeywords.cgi)

[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?][sec-survey][adv-main90+][adv-esr78.12+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [tjr](/user_profile?user_id=578488) | [sec-bounty](#a3423729_578488 "4 years ago") | + |
| --- | --- | --- |
| [tjr](/user_profile?user_id=578488) | sec-bounty | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

[[@ nsRefreshDriver::RemoveRefreshObserver ]](https://crash-stats.mozilla.org/signature/?signature=nsRefreshDriver%3A%3ARemoveRefreshObserver)

[[@ mozilla::detail::MutexImpl::lock ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3Adetail%3A%3AMutexImpl%3A%3Alock)

[[@ mozilla::PresShell::RemoveRefreshObserver ]](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3APresShell%3A%3ARemoveRefreshObserver)

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (12 files, 7 obsolete files)

| [asan.archlinux.txt](/attachment.cgi?id=9220726)  [4 years ago](#c0)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   42.35 KB, text/plain |  | [Details](/attachment.cgi?id=9220726&action=edit) |
| --- | --- | --- |
| [asan.windows10.txt](/attachment.cgi?id=9220728)  [4 years ago](#c1)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   13.30 KB, text/plain |  | [Details](/attachment.cgi?id=9220728&action=edit) |
| [launcher.bundle.html](/attachment.cgi?id=9221225)  [4 years ago](#c7)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   671 bytes, text/html |  | [Details](/attachment.cgi?id=9221225&action=edit) |
| [testcase.reload.html](/attachment.cgi?id=9221226)  [4 years ago](#c8)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   331 bytes, text/html |  | [Details](/attachment.cgi?id=9221226&action=edit) |
| [testcase.main.html](/attachment.cgi?id=9221227)  [4 years ago](#c9)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   279 bytes, text/html |  | [Details](/attachment.cgi?id=9221227&action=edit) |
| [Firefox - UAF in DocAccessible::Shutdown - e10s enabled launcher.mp4](/attachment.cgi?id=9221231)  [4 years ago](#c10)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   4.70 MB, video/mp4 |  | [Details](/attachment.cgi?id=9221231&action=edit) |
| [Firefox - UAF in DocAccessible::Shutdown - e10s disabled.mp4](/attachment.cgi?id=9221234)  [4 years ago](#c11)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1.63 MB, video/mp4 |  | [Details](/attachment.cgi?id=9221234&action=edit) |
| [asan.e10senabled.txt](/attachment.cgi?id=9221235)  [4 years ago](#c12)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   20.48 KB, text/plain |  | [Details](/attachment.cgi?id=9221235&action=edit) |
| [asan.e10sdisabled.txt](/attachment.cgi?id=9221236)  [4 years ago](#c13)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   15.23 KB, text/plain |  | [Details](/attachment.cgi?id=9221236&action=edit) |
| [valgrind.txt](/attachment.cgi?id=9223074)  [4 years ago](#c35)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   19.37 KB, text/plain |  | [Details](/attachment.cgi?id=9223074&action=edit) |
| [Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie](/attachment.cgi?id=9223266)  [4 years ago](#c41)  [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)   48 bytes, text/x-phabricator-request | tjr : [approval-mozilla-beta+](#c60 "4 years ago")  tjr : [approval-mozilla-esr78+](#c60 "4 years ago")  tjr : [sec-approval+](#c60 "4 years ago") | [Details](/attachment.cgi?id=9223266&action=edit) | [Review](/attachment.cgi?id=9223266) |
| [launcher.bundlewfx.html](/attachment.cgi?id=9223279)  [4 years ago](#c48)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   521 bytes, text/html |  | [Details](/attachment.cgi?id=9223279&action=edit) |
| [Firefox - UAF in DocAccessibleShutdown - Windows 10 with Narrator.mp4](/attachment.cgi?id=9223280)  [4 years ago](#c49)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1.12 MB, video/mp4 |  | [Details](/attachment.cgi?id=9223280&action=edit) |
| [launcher.bundle.html](/attachment.cgi?id=9224282)  [4 years ago](#c54)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   643 bytes, text/html |  | [Details](/attachment.cgi?id=9224282&action=edit) |
| [testcase.main.html](/attachment.cgi?id=9224283)  [4 years ago](#c55)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   247 bytes, text/html |  | [Details](/attachment.cgi?id=9224283&action=edit) |
| [Firefox - UAF in DocAccessibleShutdown with one-click - Windows 10 using Microsoft Narrator.mp4](/attachment.cgi?id=9224295)  [4 years ago](#c57)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   495.23 KB, video/mp4 |  | [Details](/attachment.cgi?id=9224295&action=edit) |
| [Firefox 89.0.2 - RemoveRefreshObserver Crash.mp4](/attachment.cgi?id=9229735)  [4 years ago](#c67)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   785.93 KB, video/mp4 |  | [Details](/attachment.cgi?id=9229735&action=edit) |
| [advisory.txt](/attachment.cgi?id=9230315)  [4 years ago](#c69)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   256 bytes, text/plain |  | [Details](/attachment.cgi?id=9230315&action=edit) |
| [advisory.txt](/attachment.cgi?id=9230331)  [4 years ago](#c70)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   258 bytes, text/plain |  | [Details](/attachment.cgi?id=9230331&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1709976#c0)• 4 years ago |
|  | |

Attached file
[asan.archlinux.txt](attachment.cgi?id=9220726)
— [Details](attachment.cgi?id=9220726&action=edit)

While fuzzing on Firefox ASan fuzzing build, the tab crashed on Arch Linux with `SUMMARY: AddressSanitizer: heap-use-after-free RefPtr.h:286:27 in get` and Windows 10 with `heap-use-after-free gecko/layout/base/PresShell.cpp:9914 in mozilla::PresShell::RemoveRefreshObserver`

The testcase is still intermittent it require `FuzzingFunctions.enableAccessibility()` function and few interaction. Currently I'm still refactor the code in hope it able to reproduce easily. I'll attach the testcase once I'm done with it =).

## Reproduced on

* Firefox Nightly 90.0a1 (m-c-20210506092558-fuzzing-asan-opt) (64-bit) on Arch Linux
* Firefox Nightly 90.0a1 (m-c-20210506214311-fuzzing-asan-opt) (64-bit) on Windows 10

## ASan

### Arch Linux

```
=================================================================
==1607538==ERROR: AddressSanitizer: heap-use-after-free on address 0x622000051170 at pc 0x7fbf691d93a9 bp 0x7ffc02fc2f20 sp 0x7ffc02fc2f18
READ of size 8 at 0x622000051170 thread T0 (Web Content)
    #0 0x7fbf691d93a8 in get /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:286:27
    #1 0x7fbf691d93a8 in operator nsPresContext * /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:299:12
    #2 0x7fbf691d93a8 in GetPresContext /builds/worker/workspace/obj-build/dist/include/mozilla/PresShell.h:285:50
    #3 0x7fbf691d93a8 in mozilla::PresShell::RemoveRefreshObserver(nsARefreshObserver*, mozilla::FlushType) /builds/worker/checkouts/gecko/layout/base/PresShell.cpp:9913:32
    #4 0x7fbf6c554c63 in mozilla::a11y::NotificationController::Shutdown() /builds/worker/checkouts/gecko/accessible/base/NotificationController.cpp:82:19
    #5 0x7fbf6c5af1ef in mozilla::a11y::DocAccessible::Shutdown() /builds/worker/checkouts/gecko/accessible/generic/DocAccessible.cpp:397:30
    #6 0x7fbf6c5ab4ed in Unlink /builds/worker/checkouts/gecko/accessible/generic/LocalAccessible.cpp:93:8
    #7 0x7fbf6c5ab4ed in mozilla::a11y::DocAccessible::cycleCollection::Unlink(void*) /builds/worker/checkouts/gecko/accessible/generic/DocAccessible.cpp:140:1
    #8 0x7fbf6128d1e5 in nsCycleCollector::CollectWhite() /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3081:26
    #9 0x7fbf6128ffa3 in nsCycleCollector::Collect(ccType, js::SliceBudget&, nsICycleCollectorListener*, bool) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3435:26
    #10 0x7fbf6129319d in nsCycleCollector_collect(nsICycleCollectorListener*) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3910:28
    #11 0x7fbf64a42e5e in nsJSContext::CycleCollectNow(nsICycleCollectorListener*) /builds/worker/checkouts/gecko/dom/base/nsJSEnvironment.cpp:1411:3
    #12 0x7fbf66081c82 in mozilla::dom::FuzzingFunctions_Binding::cycleCollect(JSContext*, unsigned int, JS::Value*) /builds/worker/workspace/obj-build/dom/bindings/FuzzingFunctionsBinding.cpp:96:3
    #13 0x7fbf6d0e6022 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:427:13
    #14 0x7fbf6d0e6022 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512:12
    #15 0x7fbf6d0cd7c5 in CallFromStack /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:576:10
    #16 0x7fbf6d0cd7c5 in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227:16
    #17 0x7fbf6d0b6e36 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396:13
    #18 0x7fbf6d0e615b in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544:13
    #19 0x7fbf6d0e7d5b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589:8
    #20 0x7fbf6d953f62 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849:10
    #21 0x7fbf65e76ad4 in mozilla::dom::EventHandlerNonNull::Call(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::Event&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/EventHandlerBinding.cpp:279:37
    #22 0x7fbf66b21961 in void mozilla::dom::EventHandlerNonNull::Call<nsCOMPtr<mozilla::dom::EventTarget> >(nsCOMPtr<mozilla::dom::EventTarget> const&, mozilla::dom::Event&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/EventHandlerBinding.h:365:12
    #23 0x7fbf66b1fda3 in mozilla::JSEventHandler::HandleEvent(mozilla::dom::Event*) /builds/worker/checkouts/gecko/dom/events/JSEventHandler.cpp:201:12
    #24 0x7fbf66ae8cf8 in mozilla::EventListenerManager::HandleEventSubType(mozilla::EventListenerManager::Listener*, mozilla::dom::Event*, mozilla::dom::EventTarget*) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1114:22
    #25 0x7fbf66aea287 in mozilla::EventListenerManager::HandleEventInternal(nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event**, mozilla::dom::EventTarget*, nsEventStatus*, bool) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1305:17
    #26 0x7fbf66ad79ae in mozilla::EventTargetChainItem::HandleEvent(mozilla::EventChainPostVisitor&, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:354:17
    #27 0x7fbf66ad6440 in mozilla::EventTargetChainItem::HandleEventTargetChain(nsTArray<mozilla::EventTargetChainItem>&, mozilla::EventChainPostVisitor&, mozilla::EventDispatchingCallback*, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:592:14
    #28 0x7fbf66ada48d in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:1099:11
    #29 0x7fbf66adfc99 in mozilla::EventDispatcher::DispatchDOMEvent(nsISupports*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsPresContext*, nsEventStatus*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp
    #30 0x7fbf64a33d3a in nsINode::DispatchEvent(mozilla::dom::Event&, mozilla::dom::CallerType, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/nsINode.cpp:1331:17
    #31 0x7fbf6450d1cf in nsContentUtils::DispatchEvent(mozilla::dom::Document*, nsISupports*, nsTSubstring<char16_t> const&, mozilla::CanBubble, mozilla::Cancelable, mozilla::Composed, mozilla::Trusted, bool*, mozilla::ChromeOnlyDispatch) /builds/worker/checkouts/gecko/dom/base/nsContentUtils.cpp:4301:28
    #32 0x7fbf6450cf13 in nsContentUtils::DispatchTrustedEvent(mozilla::dom::Document*, nsISupports*, nsTSubstring<char16_t> const&, mozilla::CanBubble, mozilla::Cancelable, mozilla::Composed, bool*) /builds/worker/checkouts/gecko/dom/base/nsContentUtils.cpp:4271:10
    #33 0x7fbf648f9975 in DispatchTrustedEvent /builds/worker/workspace/obj-build/dist/include/nsContentUtils.h:1453:12
    #34 0x7fbf648f9975 in MaybeDispatchSelectstartEvent(nsRange const&, bool, mozilla::dom::Document*) /builds/worker/checkouts/gecko/dom/base/Selection.cpp:825:5
    #35 0x7fbf648f91f2 in mozilla::dom::Selection::AddRangesForUserSelectableNodes(nsRange*, int*, mozilla::dom::Selection::DispatchSelectstartEvent) /builds/worker/checkouts/gecko/dom/base/Selection.cpp:890:41
    #36 0x7fbf6490040b in mozilla::dom::Selection::AddRangeAndSelectFramesAndNotifyListeners(nsRange&, mozilla::dom::Document*, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Selection.cpp:1936:14
    #37 0x7fbf649001e5 in mozilla::dom::Selection::AddRangeAndSelectFramesAndNotifyListeners(nsRange&, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Selection.cpp:1895:10
    #38 0x7fbf64905493 in mozilla::dom::Selection::SetStartAndEndInternal(mozilla::dom::Selection::InLimiter, mozilla::RangeBoundaryBase<nsINode*, nsIContent*> const&, mozilla::RangeBoundaryBase<nsINode*, nsIContent*> const&, nsDirection, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Selection.cpp:3461:3
    #39 0x7fbf649051b9 in mozilla::dom::Selection::SelectAllChildren(nsINode&, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Selection.cpp:2676:3
    #40 0x7fbf68edce90 in mozilla::HTMLEditor::SelectAllInternal() /builds/worker/checkouts/gecko/editor/libeditor/HTMLEditor.cpp:3972:18
    #41 0x7fbf68e26bc2 in mozilla::EditorBase::SelectAll() /builds/worker/checkouts/gecko/editor/libeditor/EditorBase.cpp:1083:17
    #42 0x7fbf64773a31 in mozilla::dom::Document::ExecCommand(nsTSubstring<char16_t> const&, bool, nsTSubstring<char16_t> const&, nsIPrincipal&, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Document.cpp:5293:37
    #43 0x7fbf65eb0e1c in mozilla::dom::Document_Binding::execCommand(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /builds/worker/workspace/obj-build/dom/bindings/DocumentBinding.cpp:3471:36
    #44 0x7fbf6633b4c9 in bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3260:13
    #45 0x7fbf6d0e6022 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:427:13
    #46 0x7fbf6d0e6022 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512:12
    #47 0x7fbf6d0cd7c5 in CallFromStack /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:576:10
    #48 0x7fbf6d0cd7c5 in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227:16
    #49 0x7fbf6d0b6e36 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396:13
    #50 0x7fbf6d0e615b in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544:13
    #51 0x7fbf6d0e7d5b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589:8
    #52 0x7fbf6d953f62 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849:10
    #53 0x7fbf65e797a9 in mozilla::dom::EventListener::HandleEvent(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::Event&, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/EventListenerBinding.cpp:58:8
    #54 0x7fbf66ae9168 in void mozilla::dom::EventListener::HandleEvent<mozilla::dom::EventTarget*>(mozilla::dom::EventTarget* const&, mozilla::dom::Event&, mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/EventListenerBinding.h:65:12
    #55 0x7fbf66ae8c60 in mozilla::EventListenerManager::HandleEventSubType(mozilla::EventListenerManager::Listener*, mozilla::dom::Event*, mozilla::dom::EventTarget*) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1108:43
    #56 0x7fbf66aea287 in mozilla::EventListenerManager::HandleEventInternal(nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event**, mozilla::dom::EventTarget*, nsEventStatus*, bool) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1305:17
    #57 0x7fbf66ad79ae in mozilla::EventTargetChainItem::HandleEvent(mozilla::EventChainPostVisitor&, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:354:17
    #58 0x7fbf66ad6440 in mozilla::EventTargetChainItem::HandleEventTargetChain(nsTArray<mozilla::EventTargetChainItem>&, mozilla::EventChainPostVisitor&, mozilla::EventDispatchingCallback*, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:592:14
    #59 0x7fbf66ada48d in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:1099:11
    #60 0x7fbf66adfc99 in mozilla::EventDispatcher::DispatchDOMEvent(nsISupports*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsPresContext*, nsEventStatus*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp
    #61 0x7fbf64a33d3a in nsINode::DispatchEvent(mozilla::dom::Event&, mozilla::dom::CallerType, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/nsINode.cpp:1331:17
    #62 0x7fbf66af6a33 in mozilla::dom::EventTarget::DispatchEvent(mozilla::dom::Event&) /builds/worker/checkouts/gecko/dom/events/EventTarget.cpp:177:13
    #63 0x7fbf66a6985c in mozilla::AsyncEventDispatcher::Run() /builds/worker/checkouts/gecko/dom/events/AsyncEventDispatcher.cpp:69:12
    #64 0x7fbf64518ca4 in nsContentUtils::RemoveScriptBlocker() /builds/worker/checkouts/gecko/dom/base/nsContentUtils.cpp:5682:17
    #65 0x7fbf64487569 in mozAutoDocUpdate::~mozAutoDocUpdate() /builds/worker/checkouts/gecko/dom/base/mozAutoDocUpdate.h:36:7
    #66 0x7fbf647e8d27 in mozilla::dom::Element::SetAttr(int, nsAtom*, nsAtom*, nsTSubstring<char16_t> const&, nsIPrincipal*, bool) /builds/worker/checkouts/gecko/dom/base/Element.cpp:2362:1
    #67 0x7fbf647e85f6 in SetAttr /builds/worker/workspace/obj-build/dist/include/mozilla/dom/Element.h:942:12
    #68 0x7fbf647e85f6 in mozilla::dom::Element::SetAttribute(nsTSubstring<char16_t> const&, nsTSubstring<char16_t> const&, nsIPrincipal*, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Element.cpp:1421:14
    #69 0x7fbf65f2f7a5 in mozilla::dom::Element_Binding::setAttribute(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /builds/worker/workspace/obj-build/dom/bindings/ElementBinding.cpp:1366:24
    #70 0x7fbf6633b4c9 in bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3260:13
    #71 0x7fbf6d0e6022 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:427:13
    #72 0x7fbf6d0e6022 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512:12
    #73 0x7fbf6d0cd7c5 in CallFromStack /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:576:10
    #74 0x7fbf6d0cd7c5 in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227:16
    #75 0x7fbf6d0b6e36 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396:13
    #76 0x7fbf6d0e615b in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544:13
    #77 0x7fbf6d0e7d5b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589:8
    #78 0x7fbf6d953f62 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849:10
    #79 0x7fbf65e797a9 in mozilla::dom::EventListener::HandleEvent(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::Event&, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/EventListenerBinding.cpp:58:8
    #80 0x7fbf66ae9168 in void mozilla::dom::EventListener::HandleEvent<mozilla::dom::EventTarget*>(mozilla::dom::EventTarget* const&, mozilla::dom::Event&, mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/EventListenerBinding.h:65:12
    #81 0x7fbf66ae8c60 in mozilla::EventListenerManager::HandleEventSubType(mozilla::EventListenerManager::Listener*, mozilla::dom::Event*, mozilla::dom::EventTarget*) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1108:43
    #82 0x7fbf66aea287 in mozilla::EventListenerManager::HandleEventInternal(nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event**, mozilla::dom::EventTarget*, nsEventStatus*, bool) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1305:17
    #83 0x7fbf66ad79ae in mozilla::EventTargetChainItem::HandleEvent(mozilla::EventChainPostVisitor&, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:354:17
    #84 0x7fbf66ad61d1 in mozilla::EventTargetChainItem::HandleEventTargetChain(nsTArray<mozilla::EventTargetChainItem>&, mozilla::EventChainPostVisitor&, mozilla::EventDispatchingCallback*, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:556:16
    #85 0x7fbf66ada48d in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:1099:11
    #86 0x7fbf66adfc99 in mozilla::EventDispatcher::DispatchDOMEvent(nsISupports*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsPresContext*, nsEventStatus*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp
    #87 0x7fbf64a33d3a in nsINode::DispatchEvent(mozilla::dom::Event&, mozilla::dom::CallerType, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/nsINode.cpp:1331:17
    #88 0x7fbf66af6a33 in mozilla::dom::EventTarget::DispatchEvent(mozilla::dom::Event&) /builds/worker/checkouts/gecko/dom/events/EventTarget.cpp:177:13
    #89 0x7fbf66a6985c in mozilla::AsyncEventDispatcher::Run() /builds/worker/checkouts/gecko/dom/events/AsyncEventDispatcher.cpp:69:12
    #90 0x7fbf64518ca4 in nsContentUtils::RemoveScriptBlocker() /builds/worker/checkouts/gecko/dom/base/nsContentUtils.cpp:5682:17
    #91 0x7fbf64787e68 in mozilla::dom::Document::EndUpdate() /builds/worker/checkouts/gecko/dom/base/Document.cpp:7582:3
    #92 0x7fbf64487526 in mozAutoDocUpdate::~mozAutoDocUpdate() /builds/worker/checkouts/gecko/dom/base/mozAutoDocUpdate.h:34:18
    #93 0x7fbf647e8d27 in mozilla::dom::Element::SetAttr(int, nsAtom*, nsAtom*, nsTSubstring<char16_t> const&, nsIPrincipal*, bool) /builds/worker/checkouts/gecko/dom/base/Element.cpp:2362:1
    #94 0x7fbf647e868a in mozilla::dom::Element::SetAttribute(nsTSubstring<char16_t> const&, nsTSubstring<char16_t> const&, nsIPrincipal*, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/Element.cpp:1426:12
    #95 0x7fbf65f2f7a5 in mozilla::dom::Element_Binding::setAttribute(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /builds/worker/workspace/obj-build/dom/bindings/ElementBinding.cpp:1366:24
    #96 0x7fbf6633b4c9 in bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3260:13
    #97 0x7fbf6d0e6022 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:427:13
    #98 0x7fbf6d0e6022 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512:12
    #99 0x7fbf6d0cd7c5 in CallFromStack /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:576:10
    #100 0x7fbf6d0cd7c5 in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227:16
    #101 0x7fbf6d0b6e36 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396:13
    #102 0x7fbf6d0e615b in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544:13
    #103 0x7fbf6d0e7d5b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589:8
    #104 0x7fbf6d953f62 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849:10
    #105 0x7fbf65e797a9 in mozilla::dom::EventListener::HandleEvent(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::Event&, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/EventListenerBinding.cpp:58:8
    #106 0x7fbf66ae9168 in void mozilla::dom::EventListener::HandleEvent<mozilla::dom::EventTarget*>(mozilla::dom::EventTarget* const&, mozilla::dom::Event&, mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/EventListenerBinding.h:65:12
    #107 0x7fbf66ae8c60 in mozilla::EventListenerManager::HandleEventSubType(mozilla::EventListenerManager::Listener*, mozilla::dom::Event*, mozilla::dom::EventTarget*) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1108:43
    #108 0x7fbf66aea287 in mozilla::EventListenerManager::HandleEventInternal(nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event**, mozilla::dom::EventTarget*, nsEventStatus*, bool) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1305:17
    #109 0x7fbf66ad79ae in mozilla::EventTargetChainItem::HandleEvent(mozilla::EventChainPostVisitor&, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:354:17
    #110 0x7fbf66ad61d1 in mozilla::EventTargetChainItem::HandleEventTargetChain(nsTArray<mozilla::EventTargetChainItem>&, mozilla::EventChainPostVisitor&, mozilla::EventDispatchingCallback*, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:556:16
    #111 0x7fbf66ada48d in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:1099:11
    #112 0x7fbf66adfc99 in mozilla::EventDispatcher::DispatchDOMEvent(nsISupports*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsPresContext*, nsEventStatus*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp
    #113 0x7fbf64a33d3a in nsINode::DispatchEvent(mozilla::dom::Event&, mozilla::dom::CallerType, mozilla::ErrorResult&) /builds/worker/checkouts/gecko/dom/base/nsINode.cpp:1331:17
    #114 0x7fbf66af6a33 in mozilla::dom::EventTarget::DispatchEvent(mozilla::dom::Event&) /builds/worker/checkouts/gecko/dom/events/EventTarget.cpp:177:13
    #115 0x7fbf66a6985c in mozilla::AsyncEventDispatcher::Run() /builds/worker/checkouts/gecko/dom/events/AsyncEventDispatcher.cpp:69:12
    #116 0x7fbf64518ca4 in nsContentUtils::RemoveScriptBlocker() /builds/worker/checkouts/gecko/dom/base/nsContentUtils.cpp:5682:17
    #117 0x7fbf64787e68 in mozilla::dom::Document::EndUpdate() /builds/worker/checkouts/gecko/dom/base/Document.cpp:7582:3
    #118 0x7fbf64487526 in mozAutoDocUpdate::~mozAutoDocUpdate() /builds/worker/checkouts/gecko/dom/base/mozAutoDocUpdate.h:34:18
    #119 0x7fbf647e8d27 in mozilla::dom::Element::SetAttr(int, nsAtom*, nsAtom*, nsTSubstring<char16_t> const&, nsIPrincipal*, bool) /builds/worker/checkouts/gecko/dom/base/Element.cpp:2362:1
    #120 0x7fbf6612e991 in SetAttr /builds/worker/workspace/obj-build/dist/include/mozilla/dom/Element.h:938:12
    #121 0x7fbf6612e991 in SetAttr /builds/worker/workspace/obj-build/dist/include/mozilla/dom/Element.h:934:12
    #122 0x7fbf6612e991 in SetAttr /builds/worker/workspace/obj-build/dist/include/mozilla/dom/Element.h:1573:14
    #123 0x7fbf6612e991 in SetHTMLAttr /builds/worker/checkouts/gecko/dom/html/nsGenericHTMLElement.h:733:5
    #124 0x7fbf6612e991 in SetDraggable /builds/worker/checkouts/gecko/dom/html/nsGenericHTMLElement.h:105:5
    #125 0x7fbf6612e991 in mozilla::dom::HTMLElement_Binding::set_draggable(JSContext*, JS::Handle<JSObject*>, void*, JSJitSetterCallArgs) /builds/worker/workspace/obj-build/dom/bindings/HTMLElementBinding.cpp:732:24
    #126 0x7fbf66336b64 in bool mozilla::dom::binding_detail::GenericSetter<mozilla::dom::binding_detail::NormalThisPolicy>(JSContext*, unsigned int, JS::Value*) /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3208:8
    #127 0x7fbf6d0e6022 in CallJSNative /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:427:13
    #128 0x7fbf6d0e6022 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512:12
    #129 0x7fbf6d0e7d5b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589:8
    #130 0x7fbf6d0e9573 in js::CallSetter(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::Handle<JS::Value>) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:729:10
    #131 0x7fbf6d5ebd91 in SetExistingProperty(JSContext*, JS::Handle<JS::PropertyKey>, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::Handle<js::NativeObject*>, js::PropertyResult const&, JS::ObjectOpResult&) /builds/worker/checkouts/gecko/js/src/vm/NativeObject.cpp:2661:8
    #132 0x7fbf6d5e8570 in bool js::NativeSetProperty<(js::QualifiedBool)1>(JSContext*, JS::Handle<js::NativeObject*>, JS::Handle<JS::PropertyKey>, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::ObjectOpResult&) /builds/worker/checkouts/gecko/js/src/vm/NativeObject.cpp:2695:14
    #133 0x7fbf6d0cde92 in SetProperty /builds/worker/checkouts/gecko/js/src/vm/ObjectOperations-inl.h:300:10
    #134 0x7fbf6d0cde92 in SetPropertyOperation /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:262:10
    #135 0x7fbf6d0cde92 in Interpret(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3003:12
    #136 0x7fbf6d0b6e36 in js::RunScript(JSContext*, js::RunState&) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396:13
    #137 0x7fbf6d0e615b in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544:13
    #138 0x7fbf6d0e7d5b in js::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, js::AnyInvokeArgs const&, JS::MutableHandle<JS::Value>, js::CallReason) /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589:8
    #139 0x7fbf6d953f62 in JS::Call(JSContext*, JS::Handle<JS::Value>, JS::Handle<JS::Value>, JS::HandleValueArray const&, JS::MutableHandle<JS::Value>) /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849:10
    #140 0x7fbf65e76ad4 in mozilla::dom::EventHandlerNonNull::Call(mozilla::dom::BindingCallContext&, JS::Handle<JS::Value>, mozilla::dom::Event&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&) /builds/worker/workspace/obj-build/dom/bindings/EventHandlerBinding.cpp:279:37
    #141 0x7fbf66b21961 in void mozilla::dom::EventHandlerNonNull::Call<nsCOMPtr<mozilla::dom::EventTarget> >(nsCOMPtr<mozilla::dom::EventTarget> const&, mozilla::dom::Event&, JS::MutableHandle<JS::Value>, mozilla::ErrorResult&, char const*, mozilla::dom::CallbackObject::ExceptionHandling, JS::Realm*) /builds/worker/workspace/obj-build/dist/include/mozilla/dom/EventHandlerBinding.h:365:12
    #142 0x7fbf66b1fda3 in mozilla::JSEventHandler::HandleEvent(mozilla::dom::Event*) /builds/worker/checkouts/gecko/dom/events/JSEventHandler.cpp:201:12
    #143 0x7fbf66ae8cf8 in mozilla::EventListenerManager::HandleEventSubType(mozilla::EventListenerManager::Listener*, mozilla::dom::Event*, mozilla::dom::EventTarget*) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1114:22
    #144 0x7fbf66aea287 in mozilla::EventListenerManager::HandleEventInternal(nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event**, mozilla::dom::EventTarget*, nsEventStatus*, bool) /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1305:17
    #145 0x7fbf66ad79ae in mozilla::EventTargetChainItem::HandleEvent(mozilla::EventChainPostVisitor&, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:354:17
    #146 0x7fbf66ad61d1 in mozilla::EventTargetChainItem::HandleEventTargetChain(nsTArray<mozilla::EventTargetChainItem>&, mozilla::EventChainPostVisitor&, mozilla::EventDispatchingCallback*, mozilla::ELMCreationDetector&) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:556:16
    #147 0x7fbf66ada48d in mozilla::EventDispatcher::Dispatch(nsISupports*, nsPresContext*, mozilla::WidgetEvent*, mozilla::dom::Event*, nsEventStatus*, mozilla::EventDispatchingCallback*, nsTArray<mozilla::dom::EventTarget*>*) /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:1099:11
    #148 0x7fbf6926b436 in nsDocumentViewer::LoadComplete(nsresult) /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:1084:7
    #149 0x7fbf6c3e3277 in nsDocShell::EndPageLoad(nsIWebProgress*, nsIChannel*, nsresult) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:6501:20
    #150 0x7fbf6c3e2563 in nsDocShell::OnStateChange(nsIWebProgress*, nsIRequest*, unsigned int, nsresult) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:5891:7
    #151 0x7fbf6c3e44ef in non-virtual thunk to nsDocShell::OnStateChange(nsIWebProgress*, nsIRequest*, unsigned int, nsresult) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp
    #152 0x7fbf634d69f9 in nsDocLoader::DoFireOnStateChange(nsIWebProgress*, nsIRequest*, int&, nsresult) /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:1348:3
    #153 0x7fbf634d5774 in nsDocLoader::doStopDocumentLoad(nsIRequest*, nsresult) /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:954:14
    #154 0x7fbf634d26b3 in nsDocLoader::DocLoaderIsEmpty(bool, mozilla::Maybe<nsresult> const&) /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:773:9
    #155 0x7fbf634d4604 in nsDocLoader::OnStopRequest(nsIRequest*, nsresult) /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:656:5
    #156 0x7fbf6c41c0af in nsDocShell::OnStopRequest(nsIRequest*, nsresult) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:13628:23
    #157 0x7fbf6172ef4e in mozilla::net::nsLoadGroup::NotifyRemovalObservers(nsIRequest*, nsresult) /builds/worker/checkouts/gecko/netwerk/base/nsLoadGroup.cpp:625:22
    #158 0x7fbf61731713 in mozilla::net::nsLoadGroup::RemoveRequest(nsIRequest*, nsISupports*, nsresult) /builds/worker/checkouts/gecko/netwerk/base/nsLoadGroup.cpp:529:10
    #159 0x7fbf647aa4f0 in mozilla::dom::Document::DoUnblockOnload() /builds/worker/checkouts/gecko/dom/base/Document.cpp:11309:18
    #160 0x7fbf64829caf in mozilla::dom::nsUnblockOnloadEvent::Run() /builds/worker/checkouts/gecko/dom/base/Document.cpp:11263:11
    #161 0x7fbf6141961f in mozilla::SchedulerGroup::Runnable::Run() /builds/worker/checkouts/gecko/xpcom/threads/SchedulerGroup.cpp:143:20
    #162 0x7fbf6145d2f2 in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:482:16
    #163 0x7fbf61429d00 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:766:26
    #164 0x7fbf61427807 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:621:15
    #165 0x7fbf61427c5d in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:405:36
    #166 0x7fbf61466ca1 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:138:37
    #167 0x7fbf61466ca1 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_0>::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:534:5
    #168 0x7fbf61444628 in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1159:16
    #169 0x7fbf6144f3dc in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:548:10
    #170 0x7fbf625f334f in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85:21
    #171 0x7fbf624fdb71 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:335:10
    #172 0x7fbf624fdb71 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:328:3
    #173 0x7fbf624fdb71 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:310:3
    #174 0x7fbf68c6dc37 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #175 0x7fbf6ce946df in XRE_RunAppShell() /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:911:20
    #176 0x7fbf624fdb71 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:335:10
    #177 0x7fbf624fdb71 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:328:3
    #178 0x7fbf624fdb71 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:310:3
    #179 0x7fbf6ce940b8 in XRE_InitChildProcess(int, char**, XREChildData const*) /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:743:34
    #180 0x55c9d35ba5bd in content_process_main(mozilla::Bootstrap*, int, char**) /builds/worker/checkouts/gecko/browser/app/../../ipc/contentproc/plugin-container.cpp:57:28
    #181 0x55c9d35ba9ed in main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:313:18
    #182 0x7fbf821c6b24 in __libc_start_main (/usr/lib/libc.so.6+0x27b24)
    #183 0x55c9d350b8b9 in _start (/tmp/m-c-20210506092558-fuzzing-asan-opt/firefox+0x5b8b9)

0x622000051170 is located 112 bytes inside of 4968-byte region [0x622000051100,0x622000052468)
freed by thread T0 (Web Content) here:
    #0 0x55c9d35866c2 in free /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cpp:127:3
    #1 0x7fbf691948d9 in operator delete /builds/worker/workspace/obj-build/dist/include/mozilla/cxxalloc.h:51:10
    #2 0x7fbf691948d9 in mozilla::PresShell::Release() /builds/worker/checkouts/gecko/layout/base/PresShell.cpp:889:1
    #3 0x7fbf68fe4119 in ~nsCOMPtr_base /builds/worker/workspace/obj-build/dist/include/nsCOMPtr.h:328:7
    #4 0x7fbf68fe4119 in mozilla::TextServicesDocument::~TextServicesDocument() /builds/worker/checkouts/gecko/editor/spellchecker/TextServicesDocument.cpp:78:1
    #5 0x7fbf68ff3350 in DeleteCycleCollectable /builds/worker/checkouts/gecko/editor/spellchecker/TextServicesDocument.cpp:81:1
    #6 0x7fbf68ff3350 in mozilla::TextServicesDocument::cycleCollection::DeleteCycleCollectable(void*) /builds/worker/checkouts/gecko/editor/spellchecker/TextServicesDocument.h:77:3
    #7 0x7fbf612a7fd5 in SnowWhiteKiller::Visit(nsPurpleBuffer&, nsPurpleBufferEntry*) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:2451:9
    #8 0x7fbf612892f6 in void nsPurpleBuffer::VisitEntries<SnowWhiteKiller>(SnowWhiteKiller&) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:939:23
    #9 0x7fbf61289bbe in nsCycleCollector::FreeSnowWhiteWithBudget(js::SliceBudget&) /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:2619:14
    #10 0x7fbf632ddae3 in AsyncFreeSnowWhite::Run() /builds/worker/checkouts/gecko/js/xpconnect/src/XPCJSRuntime.cpp:145:9
    #11 0x7fbf6145bdb9 in IdleRunnableWrapper::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:364:22
    #12 0x7fbf6145d2f2 in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:482:16
    #13 0x7fbf61429d00 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:766:26
    #14 0x7fbf6142799d in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:644:15
    #15 0x7fbf61427c5d in mozilla::TaskController::ProcessPendingMTTask(bool) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:405:36
    #16 0x7fbf61466ca1 in operator() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:138:37
    #17 0x7fbf61466ca1 in mozilla::detail::RunnableFunction<mozilla::TaskController::InitializeInternal()::$_0>::Run() /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:534:5
    #18 0x7fbf61444628 in nsThread::ProcessNextEvent(bool, bool*) /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1159:16
    #19 0x7fbf6144f3dc in NS_ProcessNextEvent(nsIThread*, bool) /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:548:10
    #20 0x7fbf625f334f in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate*) /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85:21
    #21 0x7fbf624fdb71 in RunInternal /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:335:10
    #22 0x7fbf624fdb71 in RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:328:3
    #23 0x7fbf624fdb71 in MessageLoop::Run() /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:310:3
    #24 0x7fbf68c6dc37 in nsBaseAppShell::Run() /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137:27
    #25 0x7fbf6ce946df in XRE_RunAppShell() /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:911:20

previously allocated by thread T0 (Web Content) here:
    #0 0x55c9d358692d in malloc /builds/worker/fetches/llvm-project/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cpp:145:3
    #1 0x55c9d35c0a4d in moz_xmalloc /builds/worker/checkouts/gecko/memory/mozalloc/mozalloc.cpp:52:15
    #2 0x7fbf6477e6d1 in operator new /builds/worker/workspace/obj-build/dist/include/mozilla/cxxalloc.h:33:10
    #3 0x7fbf6477e6d1 in mozilla::dom::Document::CreatePresShell(nsPresContext*, nsViewManager*) /builds/worker/checkouts/gecko/dom/base/Document.cpp:6600:33
    #4 0x7fbf692685c5 in nsDocumentViewer::InitPresentationStuff(bool) /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:705:27
    #5 0x7fbf69268089 in nsDocumentViewer::InitInternal(nsIWidget*, nsISupports*, mozilla::dom::WindowGlobalChild*, mozilla::gfx::IntRectTyped<mozilla::gfx::UnknownUnits> const&, bool, bool, bool) /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:910:10
    #6 0x7fbf69267557 in nsDocumentViewer::Init(nsIWidget*, mozilla::gfx::IntRectTyped<mozilla::gfx::UnknownUnits> const&, mozilla::dom::WindowGlobalChild*) /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:681:10
    #7 0x7fbf6c3e05dc in nsDocShell::SetupNewViewer(nsIContentViewer*, mozilla::dom::WindowGlobalChild*) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:8242:7
    #8 0x7fbf6c3df65e in nsDocShell::Embed(nsIContentViewer*, mozilla::dom::WindowGlobalChild*, bool, bool) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:5766:17
    #9 0x7fbf6c3a6c65 in nsDocShell::CreateContentViewer(nsTSubstring<char> const&, nsIRequest*, nsIStreamListener**) /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:8055:3
    #10 0x7fbf6c3a4c45 in nsDSURIContentListener::DoContent(nsTSubstring<char> const&, bool, nsIRequest*, nsIStreamListener**, bool*) /builds/worker/checkouts/gecko/docshell/base/nsDSURIContentListener.cpp:178:20
    #11 0x7fbf634e08e5 in nsDocumentOpenInfo::TryContentListener(nsIURIContentListener*, nsIChannel*) /builds/worker/checkouts/gecko/uriloader/base/nsURILoader.cpp:597:18
    #12 0x7fbf634de040 in nsDocumentOpenInfo::DispatchContent(nsIRequest*, nsISupports*) /builds/worker/checkouts/gecko/uriloader/base/nsURILoader.cpp:276:9
    #13 0x7fbf634dcf64 in nsDocumentOpenInfo::OnStartRequest(nsIRequest*) /builds/worker/checkouts/gecko/uriloader/base/nsURILoader.cpp:154:8
    #14 0x7fbf61fdee4d in mozilla::net::HttpChannelChild::DoOnStartRequest(nsIRequest*, nsISupports*) /builds/worker/checkouts/gecko/netwerk/protocol/http/HttpChannelChild.cpp:575:20
    #15 0x7fbf61fdda52 in mozilla::net::HttpChannelChild::OnStartRequest(mozilla::net::nsHttpResponseHead const&, bool const&, mozilla::net::nsHttpHeaderArray const&, mozilla::net::HttpChannelOnStartRequestArgs const&) /builds/worker/checkouts/gecko/netwerk/protocol/http/HttpChannelChild.cpp:506:3
    #16 0x7fbf622cf479 in mozilla::net::ChannelEventQueue::FlushQueue() /builds/worker/checkouts/gecko/netwerk/ipc/ChannelEventQueue.cpp:90:12
    #17 0x7fbf6231a647 in mozilla::net::ChannelEventQueue::ResumeInternal()::CompleteResumeRunnable::Run() /builds/worker/checkouts/gecko/netwerk/ipc/ChannelEventQueue.cpp:148:17
    #18 0x7fbf6145d2f2 in mozilla::RunnableTask::Run() /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:482:16
    #19 0x7fbf61429d00 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:766:26
    #20 0x7fbf61427807 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal(mozilla::detail::BaseAutoLock<mozilla::Mutex&> const&) /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:621:15

SUMMARY: AddressSanitizer: heap-use-after-free /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:286:27 in get
Shadow bytes around the buggy address:
  0x0c44800021d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c44800021e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c44800021f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c4480002200: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c4480002210: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c4480002220: fd fd fd fd fd fd fd fd fd fd fd fd fd fd[fd]fd
  0x0c4480002230: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c4480002240: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c4480002250: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c4480002260: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c4480002270: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==1607538==ABORTING

```
### Windows 10

```
=================================================================
==3420==ERROR: AddressSanitizer: heap-use-after-free on address 0x129b11675970 at pc 0x7ffd203f44df bp 0x00f7383f4f00 sp 0x00f7383f4f48
READ of size 8 at 0x129b11675970 thread T0
    #0 0x7ffd203f44de in mozilla::PresShell::RemoveRefreshObserver /builds/worker/checkouts/gecko/layout/base/PresShell.cpp:9914
    #1 0x7ffd2359999a in mozilla::a11y::NotificationController::Shutdown /builds/worker/checkouts/gecko/accessible/base/NotificationController.cpp:81
    #2 0x7ffd23619b22 in mozilla::a11y::DocAccessible::Shutdown /builds/worker/checkouts/gecko/accessible/generic/DocAccessible.cpp:397
    #3 0x7ffd23615021 in mozilla::a11y::DocAccessible::cycleCollection::Unlink /builds/worker/checkouts/gecko/accessible/generic/DocAccessible.cpp:140
    #4 0x7ffd165b5580 in nsCycleCollector::CollectWhite /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3081
    #5 0x7ffd165b8abf in nsCycleCollector::Collect /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3435
    #6 0x7ffd165bce7b in nsCycleCollector_collect /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3910
    #7 0x7ffd1a4c82ef in nsJSContext::CycleCollectNow /builds/worker/checkouts/gecko/dom/base/nsJSEnvironment.cpp:1411
    #8 0x7ffd1c435b20 in mozilla::dom::FuzzingFunctions_Binding::cycleCollect /builds/worker/workspace/obj-build/dom/bindings/FuzzingFunctionsBinding.cpp:96
    #9 0x7ffd24373705 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512
    #10 0x7ffd2435fbbe in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227
    #11 0x7ffd2434569a in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396
    #12 0x7ffd243739f5 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544
    #13 0x7ffd24376368 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589
    #14 0x7ffd24db97fb in JS::Call /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849
    #15 0x7ffd1c1194cd in mozilla::dom::EventHandlerNonNull::Call /builds/worker/workspace/obj-build/dom/bindings/EventHandlerBinding.cpp:279
    #16 0x7ffd1d3521c6 in mozilla::JSEventHandler::HandleEvent /builds/worker/checkouts/gecko/dom/events/JSEventHandler.cpp:201
    #17 0x7ffd1d3085e0 in mozilla::EventListenerManager::HandleEventSubType /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1113
    #18 0x7ffd1d30a34c in mozilla::EventListenerManager::HandleEventInternal /builds/worker/checkouts/gecko/dom/events/EventListenerManager.cpp:1304
    #19 0x7ffd1d2ef856 in mozilla::EventTargetChainItem::HandleEvent /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:354
    #20 0x7ffd1d2ed9da in mozilla::EventTargetChainItem::HandleEventTargetChain /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:556
    #21 0x7ffd1d2f4093 in mozilla::EventDispatcher::Dispatch /builds/worker/checkouts/gecko/dom/events/EventDispatcher.cpp:1099
    #22 0x7ffd204c31b8 in nsDocumentViewer::LoadComplete /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:1084
    #23 0x7ffd233b8c1a in nsDocShell::EndPageLoad /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:6501
    #24 0x7ffd233b7d15 in nsDocShell::OnStateChange /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:5891
    #25 0x7ffd18a0621a in nsDocLoader::DoFireOnStateChange /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:1348
    #26 0x7ffd18a04cb6 in nsDocLoader::doStopDocumentLoad /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:954
    #27 0x7ffd18a005b9 in nsDocLoader::DocLoaderIsEmpty /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:773
    #28 0x7ffd18a03289 in nsDocLoader::OnStopRequest /builds/worker/checkouts/gecko/uriloader/base/nsDocLoader.cpp:656
    #29 0x7ffd233fefca in nsDocShell::OnStopRequest /builds/worker/checkouts/gecko/docshell/base/nsDocShell.cpp:13628
    #30 0x7ffd16b5a506 in mozilla::net::nsLoadGroup::NotifyRemovalObservers /builds/worker/checkouts/gecko/netwerk/base/nsLoadGroup.cpp:625
    #31 0x7ffd16b5d361 in mozilla::net::nsLoadGroup::RemoveRequest /builds/worker/checkouts/gecko/netwerk/base/nsLoadGroup.cpp:529
    #32 0x7ffd1a160451 in mozilla::dom::Document::DoUnblockOnload /builds/worker/checkouts/gecko/dom/base/Document.cpp:11309
    #33 0x7ffd1a101ddb in mozilla::dom::Document::UnblockOnload /builds/worker/checkouts/gecko/dom/base/Document.cpp:11239
    #34 0x7ffd1a132fa1 in mozilla::dom::Document::DispatchContentLoadedEvents /builds/worker/checkouts/gecko/dom/base/Document.cpp:7774
    #35 0x7ffd165fe97a in mozilla::detail::RunnableMethodImpl<nsMemoryReporterManager *,nsresult (nsMemoryReporterManager::*)(),1,mozilla::RunnableKind::Standard>::Run /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:1201
    #36 0x7ffd167ab8d6 in mozilla::SchedulerGroup::Runnable::Run /builds/worker/checkouts/gecko/xpcom/threads/SchedulerGroup.cpp:143
    #37 0x7ffd168048fd in mozilla::RunnableTask::Run /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:482
    #38 0x7ffd167c2359 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:766
    #39 0x7ffd167be64e in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:621
    #40 0x7ffd167beb60 in mozilla::TaskController::ProcessPendingMTTask /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:405
    #41 0x7ffd1680e6f1 in mozilla::detail::RunnableFunction<`lambda at /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:138:7'>::Run /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:534
    #42 0x7ffd167e667f in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1159
    #43 0x7ffd167f69ec in NS_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:548
    #44 0x7ffd17aed25e in mozilla::ipc::MessagePump::Run /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85
    #45 0x7ffd17a272c5 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:328
    #46 0x7ffd17a27095 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:310
    #47 0x7ffd1fb520da in nsBaseAppShell::Run /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:137
    #48 0x7ffd1fd370fb in nsAppShell::Run /builds/worker/checkouts/gecko/widget/windows/nsAppShell.cpp:603
    #49 0x7ffd2408a844 in XRE_RunAppShell /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:911
    #50 0x7ffd17a272c5 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:328
    #51 0x7ffd17a27095 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:310
    #52 0x7ffd24089cbd in XRE_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:743
    #53 0x7ff78e6c1f3d in NS_internal_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:313
    #54 0x7ff78e6c14d4 in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:131
    #55 0x7ff78e7bf2d7 in __scrt_common_main_seh f:\dd\vctools\crt\vcstartup\src\startup\exe_common.inl:288
    #56 0x7ffdbe077033 in BaseThreadInitThunk+0x13 (C:\Windows\System32\KERNEL32.DLL+0x180017033)
    #57 0x7ffdbfbc2650 in RtlUserThreadStart+0x20 (C:\Windows\SYSTEM32\ntdll.dll+0x180052650)

0x129b11675970 is located 112 bytes inside of 5000-byte region [0x129b11675900,0x129b11676c88)
freed by thread T0 here:
    #0 0x7ffd6d4d5afb in free Z:\task_1619604322\fetches\llvm-project\llvm\projects\compiler-rt\lib\asan\asan_malloc_win.cpp:82
    #1 0x7ffd203921db in mozilla::PresShell::Release /builds/worker/checkouts/gecko/layout/base/PresShell.cpp:889
    #2 0x7ffd204c9ad6 in nsDocumentViewer::DestroyPresShell /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:3572
    #3 0x7ffd204c0d77 in nsDocumentViewer::Hide /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:2193
    #4 0x7ffd27a60671 in XPTC__InvokebyIndex+0x71 (C:\Users\susah\git\grizzly-framework\browser\m-c-20210506214311-fuzzing-asan-opt\xul.dll+0x191630671)
    #5 0x7ffd18808b6a in XPCWrappedNative::CallMethod /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1143
    #6 0x7ffd1880f04a in XPC_WN_CallMethod /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNativeJSOps.cpp:925
    #7 0x7ffd24373705 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512
    #8 0x7ffd2435fbbe in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227
    #9 0x7ffd2434569a in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396
    #10 0x7ffd243739f5 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544
    #11 0x7ffd24376368 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589
    #12 0x7ffd2485c596 in js::fun_apply /builds/worker/checkouts/gecko/js/src/vm/JSFunction.cpp:1150
    #13 0x7ffd24373705 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512
    #14 0x7ffd2435fbbe in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227
    #15 0x7ffd2434569a in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396
    #16 0x7ffd243739f5 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544
    #17 0x7ffd24376368 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589
    #18 0x7ffd24db97fb in JS::Call /builds/worker/checkouts/gecko/js/src/jsapi.cpp:2849

previously allocated by thread T0 here:
    #0 0x7ffd6d4d5c0b in malloc Z:\task_1619604322\fetches\llvm-project\llvm\projects\compiler-rt\lib\asan\asan_malloc_win.cpp:98
    #1 0x7ffd8fe6139d in moz_xmalloc /builds/worker/checkouts/gecko/memory/mozalloc/mozalloc.cpp:52
    #2 0x7ffd1a123d69 in mozilla::dom::Document::CreatePresShell /builds/worker/checkouts/gecko/dom/base/Document.cpp:6600
    #3 0x7ffd204bee13 in nsDocumentViewer::InitPresentationStuff /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:705
    #4 0x7ffd204cc51d in nsDocumentViewer::Show /builds/worker/checkouts/gecko/layout/base/nsDocumentViewer.cpp:2131
    #5 0x7ffd27a60671 in XPTC__InvokebyIndex+0x71 (C:\Users\susah\git\grizzly-framework\browser\m-c-20210506214311-fuzzing-asan-opt\xul.dll+0x191630671)
    #6 0x7ffd18808b6a in XPCWrappedNative::CallMethod /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNative.cpp:1143
    #7 0x7ffd1880f04a in XPC_WN_CallMethod /builds/worker/checkouts/gecko/js/xpconnect/src/XPCWrappedNativeJSOps.cpp:925
    #8 0x7ffd24373705 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512
    #9 0x7ffd2435fbbe in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227
    #10 0x7ffd2434569a in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396
    #11 0x7ffd243739f5 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544
    #12 0x7ffd24376368 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589
    #13 0x7ffd2485c596 in js::fun_apply /builds/worker/checkouts/gecko/js/src/vm/JSFunction.cpp:1150
    #14 0x7ffd24373705 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:512
    #15 0x7ffd2435fbbe in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3227
    #16 0x7ffd2434569a in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:396
    #17 0x7ffd243739f5 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:544
    #18 0x7ffd24376368 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:589

SUMMARY: AddressSanitizer: heap-use-after-free /builds/worker/checkouts/gecko/layout/base/PresShell.cpp:9914 in mozilla::PresShell::RemoveRefreshObserver
Shadow bytes around the buggy address:
  0x04aa738cead0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceae0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceaf0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceb00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceb10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x04aa738ceb20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa[fa]fa
  0x04aa738ceb30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceb40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceb50: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceb60: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04aa738ceb70: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==3420==ABORTING

```
Flags: sec-bounty?

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1709976#c1)• 4 years ago |
|  | |

Attached file
[asan.windows10.txt](attachment.cgi?id=9220728)
— [Details](attachment.cgi?id=9220728&action=edit)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1709976#c2)• 4 years ago |
|  | |

It looks like NotificationController::Shutdown is being called on a freed mPressShell.

Group: firefox-core-security → dom-core-securityComponent: Security → Disability Access APIsKeywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---)Product: Firefox → Core

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1709976#c3)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1709976&comment_id=15399325 "1 revision") |
|  | |

Just looking at the stack, it kind of looks like mPresShell should be rooted on this line in nsDocumentViewer::LoadComplete: `EventDispatcher::Dispatch(window, mPresContext, &event, nullptr, &status);`. There's an earlier scope in this method that holds a strong stack ref to the pres shell with the comment "Hold strong ref because this could conceivably run script" but I'm not sure why it wouldn't be needed here.

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1709976#c4)• 4 years ago |
|  | |

What puzzles me about this is that PresShell::Destroy should call DocAccessible::Shutdown. So, if NotificationController has a freed PresShell, that means PresShell::Destroy never got called? Or a DocAccessible was somehow created with a freed PresShell? Or a DocAccessible was created with a PresShell after the PresShell was destroyed (but before it was freed)?

It's probably worth at least adding an assertion to the DocAccessible constructor to ensure it never gets passed a destroyed PresShell.

See also [bug 1502338](/show_bug.cgi?id=1502338 "RESOLVED WORKSFORME - Crash in nsAccessibilityService::GetRootDocumentAccessible").

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1709976#c5)• 4 years ago |
|  | |

It is possible that the test case is doing something weird like calling FuzzingFunctions.enableAccessibility() during an event or something. Hopefully if we get a test case it will shed some light on the situation.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1709976#c6)• 4 years ago |
|  | |

Alright I've refactored the code, it require responsive design mode + multiple fast click to trigger the UAF. I think it's still possible to trigger the UAF without RDM which is interesting to find out.

There are 3 ways to trigger the crash, with `./mach run` (e10s enabled) and `./mach run --disable-e10s` (e10s disabled). On e10s disabled, it doesn't require launcher or reload to trigger the crash (which is more easy to trigger).

## Steps to Reproduce:

### e10s enabled (with launcher):

1. Open Firefox with fuzzing build (ac\_add\_options --enable-fuzzing)
2. Go to about:config
3. Set `fuzzing.enabled` to `true`
4. Set `dom.disable_open_during_load` to `false`
5. Restart Firefox
6. Visit attached launcher.bundle.html
7. Click "Launch" button
8. Repeatedly click the text then simultaneously press ctrl+shift+m every ~2s
9. After repeated tries, the tab is crashed

### e10s enabled (close the tab):

1. Open Firefox with fuzzing build (ac\_add\_options --enable-fuzzing)
2. Go to about:config
3. Set `fuzzing.enabled` to `true`
4. Restart Firefox
5. Visit attached testcase.main.html
6. Click "Launch" button
7. Repeatedly click the text then simultaneously press ctrl+shift+m every ~2s
8. After trying for a few seconds, close the tab
9. ASan will show heap-use-after-free

### e10s disabled:

1. Open Firefox with fuzzing build (ac\_add\_options --enable-fuzzing) then `./mach run --disable-e10s`
2. Go to about:config
3. Set `fuzzing.enabled` to `true`
4. Visit attached testcase.main.html
5. Repeatedly click the text then simultaneously press ctrl+shift+m every ~2s
6. The tab is crashed.

(I also will attach steps to reproduce video to demonstrate the crash)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1709976#c7)• 4 years ago |
|  | |

Attached file
[launcher.bundle.html](attachment.cgi?id=9221225) (obsolete)
— [Details](attachment.cgi?id=9221225&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1709976#c8)• 4 years ago |
|  | |

Attached file
[testcase.reload.html](attachment.cgi?id=9221226) (obsolete)
— [Details](attachment.cgi?id=9221226&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1709976#c9)• 4 years ago |
|  | |

Attached file
[testcase.main.html](attachment.cgi?id=9221227) (obsolete)
— [Details](attachment.cgi?id=9221227&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1709976#c10)• 4 years ago |
|  | |

Attached video
[Firefox - UAF in DocAccessible::Shutdown - e10s enabled launcher.mp4](attachment.cgi?id=9221231) (obsolete)
— [Details](attachment.cgi?id=9221231&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1709976#c11)• 4 years ago |
|  | |

Attached video
[Firefox - UAF in DocAccessible::Shutdown - e10s disabled.mp4](attachment.cgi?id=9221234)
— [Details](attachment.cgi?id=9221234&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1709976#c12)• 4 years ago |
|  | |

Attached file
[asan.e10senabled.txt](attachment.cgi?id=9221235)
— [Details](attachment.cgi?id=9221235&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1709976#c13)• 4 years ago |
|  | |

Attached file
[asan.e10sdisabled.txt](attachment.cgi?id=9221236)
— [Details](attachment.cgi?id=9221236&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1709976#c14)• 4 years ago |
|  | |

This could be more of a fuzzing harness problem than something that could be reproduced in the wild, given that fuzzing hook function wasn't really designed to be called at random times repeatedly, and wouldn't be in a real web page.

but needs more investigation to be sure of that.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1709976#c15)• 4 years ago |
|  | |

(In reply to Daniel Veditz [:dveditz] from [comment #14](/show_bug.cgi?id=1709976#c14 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> This could be more of a fuzzing harness problem than something that could be reproduced in the wild, given that fuzzing hook function wasn't really designed to be called at random times repeatedly, and wouldn't be in a real web page.
>
> but needs more investigation to be sure of that.

I've installed NVDA on Windows 10, then run the launcher.bundle.html (with steps to reproduce above) on Firefox 90.0a1 (2021-05-12) (64-bit) official build, the Firefox crashes on the first try with signature mozilla::PresShell::RemoveRefreshObserver (as on attached ASan stack above).

Hereby the crash reports: <https://crash-stats.mozilla.org/report/index/4bad5f58-da2c-4262-b017-7f82a0210512>

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1709976#c16)• 4 years ago |
|  | |

In the crash report above, one of the CPU registers shows "0xe5e5e5e5e5e5e5e5" indicating UAF.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1709976#c17)• 4 years ago |
|  | |

I can also reproduce this on Arch Linux with [Orca screen reader](https://wiki.gnome.org/Projects/Orca) activated using Firefox Nightly 90.0a1 (2021-05-17) (64-bit) (Official Build) then run launcher.bundle.html without FuzzingFunctions.enableAccessibility() on the code.

Interestingly I got 3 different crash reports as follows:

1. [[@ nsRefreshDriver::RemoveRefreshObserver ] SIGSEGV at 0xe5e5e5e5e5e5e5e5 -> 0x0](https://crash-stats.mozilla.org/report/index/ed721add-78b9-47d9-8b61-de5690210517#tab-details)
2. [[@ nsRefreshDriver::RemoveRefreshObserver ] SIGSEGV /SEGV\_MAPERR at 0xcad00000000](https://crash-stats.mozilla.org/report/index/55bb6e2c-e7ff-4243-834f-17ea30210517#tab-details)
3. [[@ nsFrameSelection::GetSelection ] SIGSEGV /SEGV\_MAPERR at 0x40db1bf0](https://crash-stats.mozilla.org/report/index/f389a059-1df7-445e-9adc-4241f0210517#tab-details)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1709976#c18)• 4 years ago |
|  | |

(In reply to Irvan Kurniawan (:sourc7) from [comment #15](/show_bug.cgi?id=1709976#c15 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> I've installed NVDA on Windows 10, then run the launcher.bundle.html (with steps to reproduce above) on Firefox 90.0a1 (2021-05-12) (64-bit) official build, the Firefox crashes on the first try with signature mozilla::PresShell::RemoveRefreshObserver (as on attached ASan stack above).

It turns out that I also able to reproduce this when using [Microsoft Narrator](https://support.microsoft.com/en-us/windows/start-or-stop-narrator-99c201e7-fa7a-9b0b-f947-dee965c1375b) (Windows built in screen reader).

I'm sure that as long the Accessibility shows `Activated: true` on `about:support` it able to reproduce on Firefox official build (same as using `FuzzingFunctions.enableAccessibility()` on Firefox fuzzing build)

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1709976#c19)• 4 years ago |
|  | |

I can't reproduce this here with the NVDA screen reader despite many attempts. :(

I can think of some assertions we could add, but that's probably not helpful because catching local build assertions in content processes is currently really difficult, at least on Windows. I guess we could land some diagnostic assertions to try to catch the problem on crash-stats, but that might expose the bug.

In addition to my thoughts in [comment 4](/show_bug.cgi?id=1709976#c4 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"), I wonder whether somehow a second DocAccessible is being created for the same PresShell. If that happens, PresShell::SetDocAccessible would get called, overriding its DocAccessible. When the PresShell gets destroyed, it would shut down the second DocAccessible, but not the first, leaving the first with a destroyed DocSAccessible. That said, I don't see how a second DocAccessible could be created; we always ask the PresShell for its DocAccessible before creating a new one.

:dveditz, do you think it'd make sense to land these as DIAGNOSTIC\_ASSERTs? If so, how should I go about doing that without exposing a potential UAF?

Flags: needinfo?(dveditz)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1709976#c20)• 4 years ago |
|  | |

(In reply to James Teh [:Jamie] from [comment #19](/show_bug.cgi?id=1709976#c19 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> In addition to my thoughts in [comment 4](/show_bug.cgi?id=1709976#c4 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"), I wonder whether somehow a second DocAccessible is being created for the same PresShell. If that happens, PresShell::SetDocAccessible would get called, overriding its DocAccessible. When the PresShell gets destroyed, it would shut down the second DocAccessible, but not the first, leaving the first with a destroyed DocSAccessible. That said, I don't see how a second DocAccessible could be created; we always ask the PresShell for its DocAccessible before creating a new one.

In another testcase it throw assertion as follow `Assertion failure: !mDocument->GetPresShell() (Where did this shell come from?), at layout/base/PresShell.cpp:4121`.

From the assertion message, I think it's related to this bug. I also found the assertion and UAF occur because of combination of ctrl+shift+m and mouse click. Without mouse click the `RemoveRefreshObserver` won't use the freed `mPressShell`.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1709976#c21)• 4 years ago |
|  | |

(In reply to Irvan Kurniawan (:sourc7) from [comment #20](/show_bug.cgi?id=1709976#c20 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> In another testcase it throw assertion as follow `Assertion failure: !mDocument->GetPresShell() (Where did this shell come from?), at layout/base/PresShell.cpp:4121`.
>
> From the assertion message, I think it's related to this bug. I also found the assertion and UAF occur because of combination of ctrl+shift+m and mouse click. Without mouse click the `RemoveRefreshObserver` won't use the freed `mPressShell`.

Hmm, I'm not sure whether it is related or not, hereby the signature report for [mozilla::PresShell::DoFlushPendingNotifications](https://crash-stats.mozilla.org/signature/?signature=mozilla%3A%3APresShell%3A%3ADoFlushPendingNotifications&date=%3E%3D2021-05-12T21%3A44%3A00.000Z&date=%3C2021-05-19T21%3A44%3A00.000Z&_columns=date&_columns=product&_columns=version&_columns=build_id&_columns=platform&_columns=reason&_columns=address&_columns=install_time&_columns=startup_crash&_sort=-date&page=1).

I think someone who knows about `PresShell` could look into this bug, hopefully it will solve this problem too.

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1709976#c22)• 4 years ago |
|  | |

If you're able to see assertions, perhaps I can provide a patch which adds assertions I'd like to verify for the accessibility crash?

```
diff --git a/accessible/generic/DocAccessible.cpp b/accessible/generic/DocAccessible.cpp
index c7411cb66f724..e19674c6d9556 100644
--- a/accessible/generic/DocAccessible.cpp
+++ b/accessible/generic/DocAccessible.cpp
@@ -98,6 +98,10 @@ DocAccessible::DocAccessible(dom::Document* aDocument,
   mDoc = this;

   MOZ_ASSERT(mPresShell, "should have been given a pres shell");
+  MOZ_ASSERT(!mPresShell->IsDestroying(),
+      "Should never get a destroying PresShell");
+  MOZ_ASSERT(!mPresShell->GetDocAccessible(),
+      "PresShell shouldn't already have a DocAccessible");
   mPresShell->SetDocAccessible(this);
 }

```

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1709976#c23)• 4 years ago |
|  | |

(In reply to James Teh [:Jamie] from [comment #22](/show_bug.cgi?id=1709976#c22 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> If you're able to see assertions, perhaps I can provide a patch which adds assertions I'd like to verify for the accessibility crash?
>
> ```
> diff --git a/accessible/generic/DocAccessible.cpp b/accessible/generic/DocAccessible.cpp
> index c7411cb66f724..e19674c6d9556 100644
> --- a/accessible/generic/DocAccessible.cpp
> +++ b/accessible/generic/DocAccessible.cpp
> @@ -98,6 +98,10 @@ DocAccessible::DocAccessible(dom::Document* aDocument,
>    mDoc = this;
>
>    MOZ_ASSERT(mPresShell, "should have been given a pres shell");
> +  MOZ_ASSERT(!mPresShell->IsDestroying(),
> +      "Should never get a destroying PresShell");
> +  MOZ_ASSERT(!mPresShell->GetDocAccessible(),
> +      "PresShell shouldn't already have a DocAccessible");
>    mPresShell->SetDocAccessible(this);
>  }
>
>
> ```

Sorry I forgot to add, the assertion on [comment 20](/show_bug.cgi?id=1709976#c20 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]") is from another testcase, it not required Accessiblity and more easily triggered just by switch to Responsive Design Mode (ctrl+shift+m) then click the text. I'm still not sure whether that related or not, but it give a clue as `PresShell` is also on the stack.

Thanks for the patch, I've added both assertion to my Firefox ASan build, but unfortunately the browser still crashes with heap-use-after-free.

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1709976#c24)• 4 years ago |
|  | |

Okay. Thanks for trying it. In that case, no point in landing these assertions for this bug.

Back to the drawing board.

Flags: needinfo?(dveditz)

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1709976#c25)• 4 years ago |
|  | |

Oh, I see the assertions in [comment 20](/show_bug.cgi?id=1709976#c20 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]") are DIAGNOSTIC\_ASSERTs. Do ASan builds have debug asserts enabled? It might be worth changing the MOZ\_ASSERTs in my patch to MOZ\_DIAGNOSTIC\_ASSERT.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1709976#c26)• 4 years ago |
|  | |

The usual ASan builds are opt, so they don't have MOZ\_ASSERT enabled.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1709976#c27)• 4 years ago |
|  | |

(In reply to James Teh [:Jamie] from [comment #25](/show_bug.cgi?id=1709976#c25 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> Oh, I see the assertions in [comment 20](/show_bug.cgi?id=1709976#c20 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]") are DIAGNOSTIC\_ASSERTs. Do ASan builds have debug asserts enabled? It might be worth changing the MOZ\_ASSERTs in my patch to MOZ\_DIAGNOSTIC\_ASSERT.

Still same, it still crash with heap-use-after-free.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1709976#c28)• 4 years ago |
|  | |

Alright I've captured the UAF with RR, here the pernosco debugging session link: <https://pernos.co/debug/2EryKI_CiVGymWBqd-qw-A/index.html>

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1709976#c29)• 4 years ago |
|  | |

Thanks.

Eitan, Pernosco is still mostly unusable with a screen reader. :( Would you mind taking a look at this?

Flags: needinfo?(eitan)

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1709976#c30)• 4 years ago |
|  | |

A DocAccessible is not supposed to outlive its PresShell. The DocAccessible indirectly holds a weak ref to the PresShell (via NotificationController). When the doc is constructed, it passes its pointer to its PresShell so that when the PresShell is destroyed it will shutdown the doc, and thus a weak reference is assumed to be safe.

This crash happens when a doc is shutdown after its presshell is destroyed. This happens because a doc is constructed, and sets its reference on its presshell via `SetDocAccessible`, but then when the doc is inserted into its outerdoc, the previous doc is shutdown, and calls `SetDocAccessible` with nullptr on the same PresShell. So the PresShell never has a valid reverence to the current DocAccessible. This typically is not a problem unless the PresShell is destroyed before the DocAccessible is shutdown, which is what happens here.

Flags: needinfo?(eitan)

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1709976#c31)• 4 years ago |
|  | |

(In reply to Eitan Isaacson [:eeejay] from [comment #30](/show_bug.cgi?id=1709976#c30 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> but then when the doc is inserted into its outerdoc, the previous doc is shutdown,

But how did we create a new doc for that PresShell without shutting the other one down first? As I understand it, that's never supposed to happen. DocManager::GetDocAccessible always checks for an existing DocAccessible on the PresShell first.

Even if a doc is bound to its OuterDoc late, we just bind the doc; we don't create a new one.

Flags: needinfo?(eitan)

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1709976#c32)• 4 years ago |
|  | |

A DOM document is not guaranteed to have the same presshell thru its entire lifetime, see `Document::CreatePresShell` and `Document::DeletePresShell`. So if the DocManager tries to find a DocAccessilble with a Document that had its PresShell swapped, it will fail. This will create a new DocAccessible.

Flags: needinfo?(eitan)

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1709976#c33)• 4 years ago |
|  | |

To add to that, you would think PresShell::Destroy would be called on the old presshell to shutdown the previous DocAccessible, but that seems to not be the case.

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1709976#c34)• 4 years ago |
|  | |

Right... and that's the really problematic piece here. If that's the cause of the problem, why isn't PresShell::Destroy being called? And if that's intentional, where else are we supposed to shut down the DocAccessible?

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1709976#c35)• 4 years ago |
|  | |

Attached file
[valgrind.txt](attachment.cgi?id=9223074)
— [Details](attachment.cgi?id=9223074&action=edit)

From Valgrind report it show 2 invalid read and 1 invalid write on following function:

* Invalid read of size 8 on `mozilla::PresShell::RemoveRefreshObserver` -> `GetPresContext`
* Invalid read of size 8 on `mozilla::a11y::SelectionManager::RemoveDocSelectionListener` -> `nsFrameSelection`
* Invalid write of size 8 on `mozilla::a11y::DocAccessible::Shutdown()`-> `SetDocAccessible`

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1709976#c36)• 4 years ago |
|  | |

(In reply to Eitan Isaacson [:eeejay] from [comment #30](/show_bug.cgi?id=1709976#c30 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> This happens because a doc is constructed, and sets its reference on its presshell via `SetDocAccessible`

If there were a previous doc, this should have triggered the assertion I suggested adding in [comment 22](/show_bug.cgi?id=1709976#c22 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"), but it didn't.

We could also try this assertion, but I don't think it'll help if the other one didn't:

```
diff --git a/accessible/generic/DocAccessible.cpp b/accessible/generic/DocAccessible.cpp
index e19674c6d9556..20486bf7fdcc9 100644
--- a/accessible/generic/DocAccessible.cpp
+++ b/accessible/generic/DocAccessible.cpp
@@ -415,6 +415,8 @@ void DocAccessible::Shutdown() {
     MOZ_ASSERT(!mParent, "Parent has to be null!");
   }

+  MOZ_ASSERT(mPresShell->GetDocAccessible() == this,
+      "PresShell should reference this DocAccessible");
   mPresShell->SetDocAccessible(nullptr);
   mPresShell = nullptr;  // Avoid reentrancy

```

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1709976#c37)• 4 years ago |
|  | |

(Of course, if testing with an opt build, that should be MOZ\_DIAGNOSTIC\_ASSERT)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1709976#c38)• 4 years ago |
|  | |

(In reply to James Teh [:Jamie] from [comment #36](/show_bug.cgi?id=1709976#c36 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> (In reply to Eitan Isaacson [:eeejay] from [comment #30](/show_bug.cgi?id=1709976#c30 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))
>
> > This happens because a doc is constructed, and sets its reference on its presshell via `SetDocAccessible`
>
> If there were a previous doc, this should have triggered the assertion I suggested adding in [comment 22](/show_bug.cgi?id=1709976#c22 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"), but it didn't.
>
> We could also try this assertion, but I don't think it'll help if the other one didn't:
>
> ```
> diff --git a/accessible/generic/DocAccessible.cpp b/accessible/generic/DocAccessible.cpp
> index e19674c6d9556..20486bf7fdcc9 100644
> --- a/accessible/generic/DocAccessible.cpp
> +++ b/accessible/generic/DocAccessible.cpp
> @@ -415,6 +415,8 @@ void DocAccessible::Shutdown() {
>      MOZ_ASSERT(!mParent, "Parent has to be null!");
>    }
>
> +  MOZ_ASSERT(mPresShell->GetDocAccessible() == this,
> +      "PresShell should reference this DocAccessible");
>    mPresShell->SetDocAccessible(nullptr);
>    mPresShell = nullptr;  // Avoid reentrancy
>
>
> ```

I've added the assertion using `MOZ_DIAGNOSTIC_ASSERT` on ASan build, but unfortunately it still crashes with UAF on `RemoveRefreshObserver`.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1709976#c39)• 4 years ago |
|  | |

In the Arch Linux and Windows 10 when using debug build it hit assertion as follow:

`Assertion failure: ObserverCount() == mEarlyRunners.Length() (observers, except pending selection scrolls, should have been unregistered), at /builds/worker/checkouts/gecko/layout/base/nsRefreshDriver.cpp:1153`

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1709976#c40)• 4 years ago |
|  | |

OK. I was just kidding about all that and I was way off. Looks like yes indeed presshell/docacc pairs get out of sync, that is why docaccessibles keep on getting created when there should already be a live one.

But i needed to figure out the origin of the mixup.. looks like during the Destroy method of a presshell, its DocAccessible is correctly shut down, but if there is a selection change that needs to get flushed it happens via `MaybeReleaseCapturingContent` in the PresShell's destroy method after the current DocAccessible was shut down. This triggers our selection manager to spawn a new DocAccessible in the Destroy phase of the presshell, and things get out of whack.

This shouldn't happen because the old DocAccessible's shutdown should remove the doc's/presshell's selection listeners. But this isn't the case because we add special control listeners via `SetControlSelectionListener` and don't clear those outside of focus changes. I think those should be cleared in doc shutdown as well.

This is a similar issue to [bug 1330739](/show_bug.cgi?id=1330739 "RESOLVED FIXED - crash near null and potential UAF [@mozilla::a11y::DocManager::CreateDocOrRootAccessible]"), I think the weak references might still be of use there in case of SelectionManager/DocManager shutdown.

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=1709976#c41)• 4 years ago |
|  | |

Attached file
[Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie](attachment.cgi?id=9223266)
— [Details](attachment.cgi?id=9223266&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a1543395_600971)• 4 years ago |

Assignee: nobody → eitanStatus: NEW → ASSIGNED

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=1709976#c42)• 4 years ago |
|  | |

Since this crash is hard to reproduce, i would rely on the reporter to verify that this is actually remedied.

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=1709976#c43)• 4 years ago |
|  | |

(In reply to Eitan Isaacson [:eeejay] from [comment #40](/show_bug.cgi?id=1709976#c40 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> This triggers our selection manager to spawn a new DocAccessible in the Destroy phase of the presshell, and things get out of whack.

That was the purpose of the mPresShell->IsDestroying() assertion I suggested, but it turns out that mIsDestroying is set pretty late in PresShell::Destroy(), *after* the DocAccessible is shut down and MaybeReleaseCapturingContent is called. Ug.

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=1709976#c44)• 4 years ago |
|  | |

I didn't realize that was your suggestion. I thought of moving it earlier but don't know what that would screw with.

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=1709976#c45)• 4 years ago |
|  | |

Irvan,

Is there a chance you can try this patch and verify it remedies the issue?

Flags: needinfo?(susah.yak)

|  | [James Teh [:Jamie] (away returning 28 Jan)](/user_profile?user_id=219126) |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=1709976#c46)• 4 years ago |
|  | |

(In reply to Eitan Isaacson [:eeejay] from [comment #44](/show_bug.cgi?id=1709976#c44 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> I didn't realize that was your suggestion.

It was earlier in the bug; see [comment 22](/show_bug.cgi?id=1709976#c22 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"). Anyway, this wouldn't have fixed the bug; it just would have made it easier to catch. :)

Thanks for figuring this out (and patching it).

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=1709976#c47)• 4 years ago |
|  | |

(In reply to Eitan Isaacson [:eeejay] from [comment #45](/show_bug.cgi?id=1709976#c45 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> Irvan,
>
> Is there a chance you can try this patch and verify it remedies the issue?

Thanks! It finally solve the issue!

After applied the [patch](https://phabricator.services.mozilla.com/D115839) (on Arch Linux), I no longer able to reproduce the crash, and on debug build it no longer hit the assertion on [comment 39](/show_bug.cgi?id=1709976#c39 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]").

Flags: needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=1709976#c48)• 4 years ago |
|  | |

Attached file
[launcher.bundlewfx.html](attachment.cgi?id=9223279) (obsolete)
— [Details](attachment.cgi?id=9223279&action=edit)

(In reply to Eitan Isaacson [:eeejay] from [comment #42](/show_bug.cgi?id=1709976#c42 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> Since this crash is hard to reproduce, i would rely on the reporter to verify that this is actually remedied.

Eitan, can you reproduce with steps to reproduce below:

1. Open Microsoft Narrator
2. Open Firefox Nightly
3. Go to about:config
4. Set `dom.disable_open_during_load` to `false` (to disable pop-up blocker)
5. Visit attached launcher.bundlewfx.html
6. Click "Launch" button
7. Repeatedly fast click the text as possible (my click per second: 7) then simultaneously press ctrl+shift+m every ~1s (as on attached video below)
8. The tab will crashed.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=1709976#c49)• 4 years ago |
|  | |

Attached video
[Firefox - UAF in DocAccessibleShutdown - Windows 10 with Narrator.mp4](attachment.cgi?id=9223280) (obsolete)
— [Details](attachment.cgi?id=9223280&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a1576005_537720)• 4 years ago |

Summary: AddressSanitizer: heap-use-after-free in [mozilla::PresShell::RemoveRefreshObserver] and [@ get] → AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=1709976#c50)• 4 years ago |
|  | |

Given the user interaction required to mostly-reliably trigger this race this is `sec-moderate` in severity

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=1709976#c51)• 4 years ago |
|  | |

Comment on [attachment 9223266](/attachment.cgi?id=9223266 "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") [[details]](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie")

[Bug 1709976](/show_bug.cgi?id=1709976 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]") - Remove selection listeners from shutting down PresShell. r?Jamie

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Not at all. This fixes an issue well before any potential UAF.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**:
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: Since this patch has no test coverage, and since this is a hard to reproduce UAF I propose that this shouldn't be backported.
* **How likely is this patch to cause regressions; how much testing does it need?**:
[Attachment #9223266](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") -
Flags: sec-approval?

|  | [Julien Cristau [:jcristau]](/user_profile?user_id=580382) |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=1709976#c52)• 4 years ago |
|  | |

The sec-moderate rating means you can land without sec-approval.

Flags: needinfo?(eitan)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=1709976#c53)• 4 years ago |
|  | |

(In reply to Eitan Isaacson [:eeejay] from [comment #51](/show_bug.cgi?id=1709976#c51 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> * **If not, how different, hard to create, and risky will they be?**: Since this patch has no test coverage, and since this is a hard to reproduce UAF I propose that this shouldn't be backported.

Glady! I found new test case that gets triggered by pressing ctrl+shift+m then just with 1-click which is very easy to reproduce. I'll attach the new testcase in a moment.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=1709976#c54)• 4 years ago |
|  | |

Attached file
[launcher.bundle.html](attachment.cgi?id=9224282)
— [Details](attachment.cgi?id=9224282&action=edit)

Hereby I attach the new testcase "launcher.bundle.html" which triggers UAF more easily and reliably (works every time).

When in responsive design mode then one click inside RDM viewport it will crash with use-after-free.

## Steps to reproduce

### e10s enabled:

1. Visit attached launcher.bundle.html
2. Click "Launch Testcase"
3. After switched to new window, press `Ctrl` + `Shift` + `M` to switch to Responsive Design Mode
4. Click duration section on `<audio>` element or click anywhere inside RDM viewport
5. The tab will crash with use-after-free

### e10s disabled:

1. Visit attached testcase.main.html
2. Press `Ctrl` + `Shift` + `M` to switch to Responsive Design Mode
3. Click duration section on `<audio>` element or click anywhere inside RDM viewport
4. The tab will crash with use-after-free
[Attachment #9221225](/attachment.cgi?id=9221225&action=edit "launcher.bundle.html") -
Attachment is obsolete: true
[Attachment #9223279](/attachment.cgi?id=9223279&action=edit "launcher.bundlewfx.html") -
Attachment is obsolete: true

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=1709976#c55)• 4 years ago |
|  | |

Attached file
[testcase.main.html](attachment.cgi?id=9224283)
— [Details](attachment.cgi?id=9224283&action=edit)

[Attachment #9221226](/attachment.cgi?id=9221226&action=edit "testcase.reload.html") -
Attachment is obsolete: true
[Attachment #9221227](/attachment.cgi?id=9221227&action=edit "testcase.main.html") -
Attachment is obsolete: true

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=1709976#c56)• 4 years ago |
|  | |

Sorry I forgot to mention [on new STR above](https://bugzilla.mozilla.org/show_bug.cgi?id=1709976#c54), it require screen reader e.g. Microsoft Narrator, NVDA (on Windows 10), or Orca (on Linux) to activate `Accesibility Activated: true` on `about:support` in order to reproduce the UAF.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=1709976#c57)• 4 years ago |
|  | |

Attached video
[Firefox - UAF in DocAccessibleShutdown with one-click - Windows 10 using Microsoft Narrator.mp4](attachment.cgi?id=9224295)
— [Details](attachment.cgi?id=9224295&action=edit)

[Attachment #9221231](/attachment.cgi?id=9221231&action=edit "Firefox - UAF in DocAccessible::Shutdown - e10s enabled launcher.mp4") -
Attachment is obsolete: true
[Attachment #9223280](/attachment.cgi?id=9223280&action=edit "Firefox - UAF in DocAccessibleShutdown - Windows 10 with Narrator.mp4") -
Attachment is obsolete: true

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a2267426_1689)• 4 years ago |

Crash Signature: [@ nsRefreshDriver::RemoveRefreshObserver ]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a2269092_1689)• 4 years ago |

Crash Signature: [@ nsRefreshDriver::RemoveRefreshObserver ] → [@ nsRefreshDriver::RemoveRefreshObserver ]
[@ mozilla::detail::MutexImpl::lock ]
[@ mozilla::PresShell::RemoveRefreshObserver ]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a2269151_1689)• 4 years ago |

Type: task → defect
[status-firefox88](/buglist.cgi?f1=cf_status_firefox88&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox88&o1=equals&v1=wontfix)
[status-firefox89](/buglist.cgi?f1=cf_status_firefox89&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox89&o1=equals&v1=wontfix)
[status-firefox90](/buglist.cgi?f1=cf_status_firefox90&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox90&o1=equals&v1=affected)
[status-firefox91](/buglist.cgi?f1=cf_status_firefox91&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox91&o1=equals&v1=affected)
[status-firefox-esr78](/buglist.cgi?f1=cf_status_firefox_esr78&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=affected)
[tracking-firefox90](/buglist.cgi?f1=cf_tracking_firefox90&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox90&o1=equals&v1=%2B)
[tracking-firefox91](/buglist.cgi?f1=cf_tracking_firefox91&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox91&o1=equals&v1=%2B)
[tracking-firefox-esr78](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=isnotempty):
--- → [91+](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=equals&v1=91%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=1709976#c58)• 4 years ago |
|  | |

> * **Which older supported branches are affected by this flaw?**:
> * **If not all supported branches, which bug introduced the flaw?**: None

Presumably all branches are affected based on those answers, and I did reproduce a crash on ESR and Release.

> * **Do you have backports for the affected branches?**: No
> * **If not, how different, hard to create, and risky will they be?**: Since this patch has no test coverage, and since this is a hard to reproduce UAF I propose that this shouldn't be backported.

The code being patched is identical to what's on ESR-78 and Release so it should apply easily, though I can't say whether other relevant context changed around it. It was not hard to reproduce the crash with Irvan's latest testcases. They were very consistent, though less obviously UAF crashes in a release build. The ESR-78 crash behavior was different from the others -- it hung up my browser (partially responsive but mostly dead) and I had to force-kill it from the task manager. The ultimately reported crash had the same signature though -- presumably sent from the crashing tab before the browser became unresponsive as a whole.

ESR-78: [bp-a4946ab8-9039-468c-b580-d10880210602](https://crash-stats.mozilla.org/report/index/a4946ab8-9039-468c-b580-d10880210602)

Release (88.0.1): [bp-cc018aad-9d65-4b2d-84d5-729300210602](https://crash-stats.mozilla.org/report/index/cc018aad-9d65-4b2d-84d5-729300210602)

Nightly: [bp-a3a23889-d9f0-4294-b0d3-29c240210602](https://crash-stats.mozilla.org/report/index/a3a23889-d9f0-4294-b0d3-29c240210602)

It would be easy to verify the fix if this is backported, but I don't know about regressions.

> * **How likely is this patch to cause regressions; how much testing does it need?**:

This is an important question to get your opinion on.

[status-firefox89](/buglist.cgi?f1=cf_status_firefox89&o1=isnotempty):
[wontfix](/buglist.cgi?f1=cf_status_firefox89&o1=equals&v1=wontfix) → [affected](/buglist.cgi?f1=cf_status_firefox89&o1=equals&v1=affected)
[tracking-firefox-esr78](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=isnotempty):
[91+](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=equals&v1=91%2B) → ---

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=1709976#c59)• 4 years ago |
|  | |

I think the chance that this patch causes a regression is very small but isn't 0. Maybe we can uplift to release, and wait a bit before ESR?

Flags: needinfo?(eitan)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=1709976#c60)• 4 years ago |
|  | |

Comment on [attachment 9223266](/attachment.cgi?id=9223266 "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") [[details]](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie")

[Bug 1709976](/show_bug.cgi?id=1709976 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]") - Remove selection listeners from shutting down PresShell. r?Jamie

Approved to land and uplift. I'm not sure about delaying the ESR patch one release; we try to avoid doing that.

[Attachment #9223266](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") -
Flags: sec-approval?
[Attachment #9223266](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") -
Flags: sec-approval+
[Attachment #9223266](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") -
Flags: approval-mozilla-esr78+
[Attachment #9223266](/attachment.cgi?id=9223266&action=edit "Bug 1709976 - Remove selection listeners from shutting down PresShell. r?Jamie") -
Flags: approval-mozilla-beta+

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=1709976#c61)• 4 years ago |
|  | |

Remove selection listeners from shutting down PresShell. r=Jamie

<https://hg.mozilla.org/integration/autoland/rev/65d3494db521b3d15112c092d0647a2899808381>

<https://hg.mozilla.org/mozilla-central/rev/65d3494db521>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 4 years ago
[status-firefox91](/buglist.cgi?f1=cf_status_firefox91&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox91&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox91&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 91 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a2940259_75935)• 4 years ago |

[status-firefox89](/buglist.cgi?f1=cf_status_firefox89&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox89&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox89&o1=equals&v1=wontfix)
[tracking-firefox-esr78](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=isnotempty):
--- → [90+](/buglist.cgi?f1=cf_tracking_firefox_esr78&o1=equals&v1=90%2B)

|  | [Julien Cristau [:jcristau]](/user_profile?user_id=580382) |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=1709976#c62)• 4 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/81a6b75e5224>

[status-firefox90](/buglist.cgi?f1=cf_status_firefox90&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox90&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox90&o1=equals&v1=fixed)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=1709976#c63)• 4 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr78/rev/1c6290c3e4e1>

[status-firefox-esr78](/buglist.cgi?f1=cf_status_firefox_esr78&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=1709976#c64)• 4 years ago |
|  | |

Somewhere around 4.7% of users (beta users, at least) have accessibility enabled: [https://telemetry.mozilla.org/new-pipeline/dist.html#!cumulative=0&end\_date=2021-06-08&include\_spill=0&keys=\_\_none\_\_!\_\_none\_\_!\_\_none\_\_&max\_channel\_version=beta%252F90&measure=A11Y\_INSTANTIATED\_FLAG&min\_channel\_version=beta%252F88&processType=\*&product=Firefox&sanitize=1&sort\_by\_value=0&sort\_keys=submissions&start\_date=2021-05-31&table=0&trim=1&use\_submission\_date=0](https://telemetry.mozilla.org/new-pipeline/dist.html#!cumulative=0&end_date=2021-06-08&include_spill=0&keys=__none__!__none__!__none__&max_channel_version=beta%252F90&measure=A11Y_INSTANTIATED_FLAG&min_channel_version=beta%252F88&processType=*&product=Firefox&sanitize=1&sort_by_value=0&sort_keys=submissions&start_date=2021-05-31&table=0&trim=1&use_submission_date=0)

That's several million people every day so seems worth calling this one sec-high after all.

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---) → [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a3423729_578488)• 4 years ago |

Flags: sec-bounty? → sec-bounty+

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=1709976#c65)• 4 years ago |
|  | |

As part of a security bug pattern analysis, we are requesting your help with a high level analysis of this bug. It is our hope to develop static analysis (or potentially runtime/dynamic analysis) in the future to identify classes of bugs.

Please visit [this google form](https://docs.google.com/forms/d/e/1FAIpQLSe9uRXuoMK6tRglbNL5fpXbun_oEb6_xC2zpuE_CKA_GUjrvA/viewform?usp=pp_url&entry.2124261401=https%3A%2F%2Fbugzilla.mozilla.org%2Fshow_bug.cgi%3Fid%3D1709976) to reply.

Flags: needinfo?(eitan)Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?][sec-survey]

|  | [Eitan Isaacson [:eeejay]](/user_profile?user_id=291675)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a3519862_291675)• 4 years ago |

Flags: needinfo?(eitan)

|  | [Cornel Ionce [:noni] [Hubs QA]](/user_profile?user_id=458186) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a4884543_458186)• 4 years ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify+

|  | [Rares Doghi, Desktop QA](/user_profile?user_id=615351) |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=1709976#c66)• 4 years ago |
|  | |

Hi Irvan, I have been using your steps from [Comment 54](/show_bug.cgi?id=1709976#c54 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]") and your attached test case in order to verify the fix in our latest Nightly Asan Fuzzing build i got from :

<https://treeherder.mozilla.org/jobs?repo=mozilla-central&selectedTaskRun=NCAkqN8eTBuc7_dJsX3f7Q.0>

I started Narrator on Windows 10 and opened the ASAN Fuzzing Build (here tried both ways with fuzzing.enabled = true/false ) and loaded the attached case in a new tab.

Clicked Launch Testcase wich opened the audio player in a new tab.

Hit Ctrl Shift M in order to start RDM and click the seek bar for the audio a few times

Tab Crashed

Please also note that I was able to reproduce the Tab crash in older Nightly asan fuzzing builds.

I also tried this with Beta 90.0b1 and Firefox didn't crash it would just close the tab , also tried the same thing with non asan Fuzzing builds , normal builds would not crash, they would just close the tab.

Am I missing some steps ? or Prefs I might need to set before launching the test case ? Is the Expected result to simply Close the Tab ? or it's suppose to keep the tab open without crashing it ?

Flags: needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=1709976#c67)• 4 years ago |
|  | |

Attached video
[Firefox 89.0.2 - RemoveRefreshObserver Crash.mp4](attachment.cgi?id=9229735)
— [Details](attachment.cgi?id=9229735&action=edit)

(In reply to Rares Doghi from [comment #66](/show_bug.cgi?id=1709976#c66 "VERIFIED FIXED - AddressSanitizer: heap-use-after-free in [@ mozilla::PresShell::RemoveRefreshObserver]"))

> I also tried this with Beta 90.0b1 and Firefox didn't crash it would just close the tab , also tried the same thing with non asan Fuzzing builds , normal builds would not crash, they would just close the tab.
>
> Am I missing some steps ? or Prefs I might need to set before launching the test case ? Is the Expected result to simply Close the Tab ? or it's suppose to keep the tab open without crashing it ?

I still able to reproduce this in Firefox 89.0.2 (64-bit) on Windows 10 (video attached), make sure to click the duration section (0:00 / 0:00) (not the seek bar section) or the white page section as on attached video. I hope this helps!

Flags: needinfo?(susah.yak)

|  | [Rares Doghi, Desktop QA](/user_profile?user_id=615351) |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=1709976#c68)• 4 years ago |
|  | |

Thank you Irvan, I was able to reproduce the issue in older builds and Verify the fix in ESR 78.12.0esr, Beta 90.0b12 and our latest Nightly build on Windows 10 using Narrator and Ubuntu 20.04 using Screen Reader (orca)

Status: RESOLVED → VERIFIED
[status-firefox90](/buglist.cgi?f1=cf_status_firefox90&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox90&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox90&o1=equals&v1=verified)
[status-firefox91](/buglist.cgi?f1=cf_status_firefox91&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox91&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox91&o1=equals&v1=verified)
[status-firefox-esr78](/buglist.cgi?f1=cf_status_firefox_esr78&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=verified)Flags: qe-verify+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a5251972_578488)• 4 years ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?][sec-survey] → [reporter-external] [client-bounty-form] [verif?][sec-survey][adv-main90+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a5252506_578488)• 4 years ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?][sec-survey][adv-main90+] → [reporter-external] [client-bounty-form] [verif?][sec-survey][adv-main90+][adv-esr78.12+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=1709976#c69)• 4 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9230315) (obsolete)
— [Details](attachment.cgi?id=9230315&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=1709976#c70)• 4 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9230331)
— [Details](attachment.cgi?id=9230331&action=edit)

[Attachment #9230315](/attachment.cgi?id=9230315&action=edit "advisory.txt") -
Attachment is obsolete: true

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a5451215_578488)• 4 years ago |

Alias: CVE-2021-29970

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a17306821_1689)• 3 years ago |

Group: core-security-release

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1709976#a96743557_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1709976&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from security.gentoo.org_067c0658_20250114_191052.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Mozilla Thunderbird: Multiple Vulnerabilities — GLSA **202208-14**

Multiple vulnerabilities have been found in Mozilla Thunderbird, the worst of which could result in the arbitrary execution of code.

### Affected packages

| Package | **mail-client/thunderbird** on all architectures |
| --- | --- |
| Affected versions | < **91.12.0** |
| Unaffected versions | >= **91.12.0** |

| Package | **mail-client/thunderbird-bin** on all architectures |
| --- | --- |
| Affected versions | < **91.12.0** |
| Unaffected versions | >= **91.12.0** |

### Background

Mozilla Thunderbird is a popular open-source email client from the Mozilla project.

### Description

Multiple vulnerabilities have been discovered in Mozilla Thunderbird. Please review the CVE identifiers referenced below for details.

### Impact

Please review the referenced CVE identifiers for details.

### Workaround

There is no known workaround at this time.

### Resolution

All Mozilla Thunderbird users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=mail-client/thunderbird-91.12.0"

```

All Mozilla Thunderbird binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=mail-client/thunderbird-bin-91.12.0"

```
### References

* [CVE-2021-4129](https://nvd.nist.gov/vuln/detail/CVE-2021-4129)
* [CVE-2021-4140](https://nvd.nist.gov/vuln/detail/CVE-2021-4140)
* [CVE-2021-29967](https://nvd.nist.gov/vuln/detail/CVE-2021-29967)
* [CVE-2021-29969](https://nvd.nist.gov/vuln/detail/CVE-2021-29969)
* [CVE-2021-29970](https://nvd.nist.gov/vuln/detail/CVE-2021-29970)
* [CVE-2021-29976](https://nvd.nist.gov/vuln/detail/CVE-2021-29976)
* [CVE-2021-29980](https://nvd.nist.gov/vuln/detail/CVE-2021-29980)
* [CVE-2021-29984](https://nvd.nist.gov/vuln/detail/CVE-2021-29984)
* [CVE-2021-29985](https://nvd.nist.gov/vuln/detail/CVE-2021-29985)
* [CVE-2021-29986](https://nvd.nist.gov/vuln/detail/CVE-2021-29986)
* [CVE-2021-29988](https://nvd.nist.gov/vuln/detail/CVE-2021-29988)
* [CVE-2021-29989](https://nvd.nist.gov/vuln/detail/CVE-2021-29989)
* [CVE-2021-30547](https://nvd.nist.gov/vuln/detail/CVE-2021-30547)
* [CVE-2021-38492](https://nvd.nist.gov/vuln/detail/CVE-2021-38492)
* [CVE-2021-38493](https://nvd.nist.gov/vuln/detail/CVE-2021-38493)
* [CVE-2021-38495](https://nvd.nist.gov/vuln/detail/CVE-2021-38495)
* [CVE-2021-38503](https://nvd.nist.gov/vuln/detail/CVE-2021-38503)
* [CVE-2021-38504](https://nvd.nist.gov/vuln/detail/CVE-2021-38504)
* [CVE-2021-38506](https://nvd.nist.gov/vuln/detail/CVE-2021-38506)
* [CVE-2021-38507](https://nvd.nist.gov/vuln/detail/CVE-2021-38507)
* [CVE-2021-38508](https://nvd.nist.gov/vuln/detail/CVE-2021-38508)
* [CVE-2021-38509](https://nvd.nist.gov/vuln/detail/CVE-2021-38509)
* [CVE-2021-40529](https://nvd.nist.gov/vuln/detail/CVE-2021-40529)
* [CVE-2021-43528](https://nvd.nist.gov/vuln/detail/CVE-2021-43528)
* [CVE-2021-43529](https://nvd.nist.gov/vuln/detail/CVE-2021-43529)
* [CVE-2021-43536](https://nvd.nist.gov/vuln/detail/CVE-2021-43536)
* [CVE-2021-43537](https://nvd.nist.gov/vuln/detail/CVE-2021-43537)
* [CVE-2021-43538](https://nvd.nist.gov/vuln/detail/CVE-2021-43538)
* [CVE-2021-43539](https://nvd.nist.gov/vuln/detail/CVE-2021-43539)
* [CVE-2021-43541](https://nvd.nist.gov/vuln/detail/CVE-2021-43541)
* [CVE-2021-43542](https://nvd.nist.gov/vuln/detail/CVE-2021-43542)
* [CVE-2021-43543](https://nvd.nist.gov/vuln/detail/CVE-2021-43543)
* [CVE-2021-43545](https://nvd.nist.gov/vuln/detail/CVE-2021-43545)
* [CVE-2021-43546](https://nvd.nist.gov/vuln/detail/CVE-2021-43546)
* [CVE-2022-0566](https://nvd.nist.gov/vuln/detail/CVE-2022-0566)
* [CVE-2022-1196](https://nvd.nist.gov/vuln/detail/CVE-2022-1196)
* [CVE-2022-1197](https://nvd.nist.gov/vuln/detail/CVE-2022-1197)
* [CVE-2022-1520](https://nvd.nist.gov/vuln/detail/CVE-2022-1520)
* [CVE-2022-1529](https://nvd.nist.gov/vuln/detail/CVE-2022-1529)
* [CVE-2022-1802](https://nvd.nist.gov/vuln/detail/CVE-2022-1802)
* [CVE-2022-1834](https://nvd.nist.gov/vuln/detail/CVE-2022-1834)
* [CVE-2022-2200](https://nvd.nist.gov/vuln/detail/CVE-2022-2200)
* [CVE-2022-2226](https://nvd.nist.gov/vuln/detail/CVE-2022-2226)
* [CVE-2022-22737](https://nvd.nist.gov/vuln/detail/CVE-2022-22737)
* [CVE-2022-22738](https://nvd.nist.gov/vuln/detail/CVE-2022-22738)
* [CVE-2022-22739](https://nvd.nist.gov/vuln/detail/CVE-2022-22739)
* [CVE-2022-22740](https://nvd.nist.gov/vuln/detail/CVE-2022-22740)
* [CVE-2022-22741](https://nvd.nist.gov/vuln/detail/CVE-2022-22741)
* [CVE-2022-22742](https://nvd.nist.gov/vuln/detail/CVE-2022-22742)
* [CVE-2022-22743](https://nvd.nist.gov/vuln/detail/CVE-2022-22743)
* [CVE-2022-22745](https://nvd.nist.gov/vuln/detail/CVE-2022-22745)
* [CVE-2022-22747](https://nvd.nist.gov/vuln/detail/CVE-2022-22747)
* [CVE-2022-22748](https://nvd.nist.gov/vuln/detail/CVE-2022-22748)
* [CVE-2022-22751](https://nvd.nist.gov/vuln/detail/CVE-2022-22751)
* [CVE-2022-22754](https://nvd.nist.gov/vuln/detail/CVE-2022-22754)
* [CVE-2022-22756](https://nvd.nist.gov/vuln/detail/CVE-2022-22756)
* [CVE-2022-22759](https://nvd.nist.gov/vuln/detail/CVE-2022-22759)
* [CVE-2022-22760](https://nvd.nist.gov/vuln/detail/CVE-2022-22760)
* [CVE-2022-22761](https://nvd.nist.gov/vuln/detail/CVE-2022-22761)
* [CVE-2022-22763](https://nvd.nist.gov/vuln/detail/CVE-2022-22763)
* [CVE-2022-22764](https://nvd.nist.gov/vuln/detail/CVE-2022-22764)
* [CVE-2022-24713](https://nvd.nist.gov/vuln/detail/CVE-2022-24713)
* [CVE-2022-26381](https://nvd.nist.gov/vuln/detail/CVE-2022-26381)
* [CVE-2022-26383](https://nvd.nist.gov/vuln/detail/CVE-2022-26383)
* [CVE-2022-26384](https://nvd.nist.gov/vuln/detail/CVE-2022-26384)
* [CVE-2022-26386](https://nvd.nist.gov/vuln/detail/CVE-2022-26386)
* [CVE-2022-26387](https://nvd.nist.gov/vuln/detail/CVE-2022-26387)
* [CVE-2022-26485](https://nvd.nist.gov/vuln/detail/CVE-2022-26485)
* [CVE-2022-26486](https://nvd.nist.gov/vuln/detail/CVE-2022-26486)
* [CVE-2022-28281](https://nvd.nist.gov/vuln/detail/CVE-2022-28281)
* [CVE-2022-28282](https://nvd.nist.gov/vuln/detail/CVE-2022-28282)
* [CVE-2022-28285](https://nvd.nist.gov/vuln/detail/CVE-2022-28285)
* [CVE-2022-28286](https://nvd.nist.gov/vuln/detail/CVE-2022-28286)
* [CVE-2022-28289](https://nvd.nist.gov/vuln/detail/CVE-2022-28289)
* [CVE-2022-29909](https://nvd.nist.gov/vuln/detail/CVE-2022-29909)
* [CVE-2022-29911](https://nvd.nist.gov/vuln/detail/CVE-2022-29911)
* [CVE-2022-29912](https://nvd.nist.gov/vuln/detail/CVE-2022-29912)
* [CVE-2022-29913](https://nvd.nist.gov/vuln/detail/CVE-2022-29913)
* [CVE-2022-29914](https://nvd.nist.gov/vuln/detail/CVE-2022-29914)
* [CVE-2022-29916](https://nvd.nist.gov/vuln/detail/CVE-2022-29916)
* [CVE-2022-29917](https://nvd.nist.gov/vuln/detail/CVE-2022-29917)
* [CVE-2022-31736](https://nvd.nist.gov/vuln/detail/CVE-2022-31736)
* [CVE-2022-31737](https://nvd.nist.gov/vuln/detail/CVE-2022-31737)
* [CVE-2022-31738](https://nvd.nist.gov/vuln/detail/CVE-2022-31738)
* [CVE-2022-31740](https://nvd.nist.gov/vuln/detail/CVE-2022-31740)
* [CVE-2022-31741](https://nvd.nist.gov/vuln/detail/CVE-2022-31741)
* [CVE-2022-31742](https://nvd.nist.gov/vuln/detail/CVE-2022-31742)
* [CVE-2022-31747](https://nvd.nist.gov/vuln/detail/CVE-2022-31747)
* [CVE-2022-34468](https://nvd.nist.gov/vuln/detail/CVE-2022-34468)
* [CVE-2022-34470](https://nvd.nist.gov/vuln/detail/CVE-2022-34470)
* [CVE-2022-34472](https://nvd.nist.gov/vuln/detail/CVE-2022-34472)
* [CVE-2022-34478](https://nvd.nist.gov/vuln/detail/CVE-2022-34478)
* [CVE-2022-34479](https://nvd.nist.gov/vuln/detail/CVE-2022-34479)
* [CVE-2022-34481](https://nvd.nist.gov/vuln/detail/CVE-2022-34481)
* [CVE-2022-34484](https://nvd.nist.gov/vuln/detail/CVE-2022-34484)
* [CVE-2022-36318](https://nvd.nist.gov/vuln/detail/CVE-2022-36318)
* [CVE-2022-36319](https://nvd.nist.gov/vuln/detail/CVE-2022-36319)
* MOZ-2021-0007
* MOZ-2021-0008

**Release date**

August 10, 2022

**Latest revision**

August 10, 2022: 1

**Severity**

high

**Exploitable**

remote

**Bugzilla entries**

* [794085](https://bugs.gentoo.org/show_bug.cgi?id=794085)
* [802759](https://bugs.gentoo.org/show_bug.cgi?id=802759)
* [807943](https://bugs.gentoo.org/show_bug.cgi?id=807943)
* [811912](https://bugs.gentoo.org/show_bug.cgi?id=811912)
* [813501](https://bugs.gentoo.org/show_bug.cgi?id=813501)
* [822294](https://bugs.gentoo.org/show_bug.cgi?id=822294)
* [828539](https://bugs.gentoo.org/show_bug.cgi?id=828539)
* [831040](https://bugs.gentoo.org/show_bug.cgi?id=831040)
* [833520](https://bugs.gentoo.org/show_bug.cgi?id=833520)
* [834805](https://bugs.gentoo.org/show_bug.cgi?id=834805)
* [845057](https://bugs.gentoo.org/show_bug.cgi?id=845057)
* [846596](https://bugs.gentoo.org/show_bug.cgi?id=846596)
* [849047](https://bugs.gentoo.org/show_bug.cgi?id=849047)
* [857048](https://bugs.gentoo.org/show_bug.cgi?id=857048)
* [864577](https://bugs.gentoo.org/show_bug.cgi?id=864577)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from www.mozilla.org_c3ac9c70_20250114_191053.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2021-28

## Security Vulnerabilities fixed in Firefox 90

Announced
July 13, 2021
Impact
high
Products
Firefox
Fixed in

* Firefox 90

#### [#CVE-2021-29970: Use-after-free in accessibility features of a document](#CVE-2021-29970)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A malicious webpage could have triggered a use-after-free, memory corruption, and a potentially exploitable crash.
*This bug only affected Firefox when accessibility was enabled.*

##### References

* [Bug 1709976](https://bugzilla.mozilla.org/show_bug.cgi?id=1709976)

#### [#CVE-2021-29971: Granted permissions only compared host; omitting scheme and port on Android](#CVE-2021-29971)

Reporter
Arturo Mejia
Impact
high
##### Description

If a user had granted a permission to a webpage and saved that grant, any webpage running on the same host - irrespective of scheme or port - would be granted that permission.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1713638](https://bugzilla.mozilla.org/show_bug.cgi?id=1713638)

#### [#CVE-2021-30547: Out of bounds write in ANGLE](#CVE-2021-30547)

Reporter
(Unknown)
Impact
high
##### Description

An out of bounds write in ANGLE could have allowed an attacker to corrupt memory leading to a potentially exploitable crash.

##### References

* [Bug 1715766](https://bugzilla.mozilla.org/show_bug.cgi?id=1715766)

#### [#CVE-2021-29972: Use of out-of-date library included use-after-free vulnerability](#CVE-2021-29972)

Reporter
Irvan Kurniawan
Impact
moderate
##### Description

A user-after-free vulnerability was found via testing, and traced to an out-of-date Cairo library. Updating the library resolved the issue, and may have remediated other, unknown security vulnerabilities as well.

##### References

* [Bug 1696816](https://bugzilla.mozilla.org/show_bug.cgi?id=1696816)

#### [#CVE-2021-29973: Password autofill on HTTP websites was enabled without user interaction on Android](#CVE-2021-29973)

Reporter
Wladimir Palant working with Include Security
Impact
moderate
##### Description

Password autofill was enabled without user interaction on insecure websites on Firefox for Android. This was corrected to require user interaction with the page before a user's password would be entered by the browser's autofill functionality.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1701932](https://bugzilla.mozilla.org/show_bug.cgi?id=1701932)

#### [#CVE-2021-29974: HSTS errors could be overridden when network partitioning was enabled](#CVE-2021-29974)

Reporter
Peter Gerber
Impact
moderate
##### Description

When network partitioning was enabled, e.g. as a result of Enhanced Tracking Protection settings, a TLS error page would allow the user to override an error on a domain which had specified HTTP Strict Transport Security (which implies that the error should not be override-able.) This issue did not affect the network connections, and they were correctly upgraded to HTTPS automatically.

##### References

* [Bug 1704843](https://bugzilla.mozilla.org/show_bug.cgi?id=1704843)

#### [#CVE-2021-29975: Text message could be overlaid on top of another website](#CVE-2021-29975)

Reporter
Irvan Kurniawan
Impact
moderate
##### Description

Through a series of DOM manipulations, a message, over which the attacker had control of the text but not HTML or formatting, could be overlaid on top of another domain (with the new domain correctly shown in the address bar) resulting in possible user confusion.

##### References

* [Bug 1713259](https://bugzilla.mozilla.org/show_bug.cgi?id=1713259)

#### [#CVE-2021-29976: Memory safety bugs fixed in Firefox 90 and Firefox ESR 78.12](#CVE-2021-29976)

Reporter
Mozilla developers
Impact
high
##### Description

Mozilla developers Emil Ghitta, Tyson Smith, Valentin Gosu, Olli Pettay, and Randell Jesup reported memory safety bugs present in Firefox 89 and Firefox ESR 78.11. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 90 and Firefox ESR 78.12](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1700895%2C1703334%2C1706910%2C1711576%2C1714391)

#### [#CVE-2021-29977: Memory safety bugs fixed in Firefox 90](#CVE-2021-29977)

Reporter
Mozilla developers
Impact
high
##### Description

Mozilla developers Andrew McCreight, Tyson Smith, Christian Holler, and Gabriele Svelto reported memory safety bugs present in Firefox 89. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 90](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1665836%2C1686138%2C1704316%2C1706314%2C1709931%2C1712084%2C1712357%2C1714066)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from www.mozilla.org_c6eee617_20250114_191054.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2021-29

## Security Vulnerabilities fixed in Firefox ESR 78.12

Announced
July 13, 2021
Impact
high
Products
Firefox ESR
Fixed in

* Firefox ESR 78.12

#### [#CVE-2021-29970: Use-after-free in accessibility features of a document](#CVE-2021-29970)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A malicious webpage could have triggered a use-after-free, memory corruption, and a potentially exploitable crash.
*This bug only affected Firefox when accessibility was enabled.*

##### References

* [Bug 1709976](https://bugzilla.mozilla.org/show_bug.cgi?id=1709976)

#### [#CVE-2021-30547: Out of bounds write in ANGLE](#CVE-2021-30547)

Reporter
(Unknown)
Impact
high
##### Description

An out of bounds write in ANGLE could have allowed an attacker to corrupt memory leading to a potentially exploitable crash.

##### References

* [Bug 1715766](https://bugzilla.mozilla.org/show_bug.cgi?id=1715766)

#### [#CVE-2021-29976: Memory safety bugs fixed in Firefox 90 and Firefox ESR 78.12](#CVE-2021-29976)

Reporter
Mozilla developers
Impact
high
##### Description

Mozilla developers Valentin Gosu, Randell Jesup, Emil Ghitta, Tyson Smith, and Olli Pettay reported memory safety bugs present in Firefox 89 and Firefox ESR 78.11. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 90 and Firefox ESR 78.12](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1700895%2C1703334%2C1706910%2C1711576%2C1714391)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from security.gentoo.org_ffa2d904_20250114_191051.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Mozilla Firefox: Multiple vulnerabilities — GLSA **202202-03**

Multiple vulnerabilities have been found in Mozilla Firefox, the worst of which could result in the arbitrary execution of code.

### Affected packages

| Package | **www-client/firefox** on all architectures |
| --- | --- |
| Affected versions | < **97.0** |
| Unaffected versions | >= **91.6.0**>= **97.0** |

| Package | **www-client/firefox-bin** on all architectures |
| --- | --- |
| Affected versions | < **97.0** |
| Unaffected versions | >= **91.6.0**>= **97.0** |

### Background

Mozilla Firefox is a popular open-source web browser from the Mozilla project.

### Description

Multiple vulnerabilities have been discovered in Mozilla Firefox. Please review the CVE identifiers referenced below for details.

### Impact

Please review the referenced CVE identifiers for details.

### Workaround

There is no known workaround at this time.

### Resolution

All Mozilla Firefox ESR users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-91.6.0:esr"

```

All Mozilla Firefox ESR binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-91.6.0:esr"

```

All Mozilla Firefox users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-97.0:rapid"

```

All Mozilla Firefox binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-97.0:rapid"

```
### References

* [CVE-2021-29970](https://nvd.nist.gov/vuln/detail/CVE-2021-29970)
* [CVE-2021-29972](https://nvd.nist.gov/vuln/detail/CVE-2021-29972)
* [CVE-2021-29974](https://nvd.nist.gov/vuln/detail/CVE-2021-29974)
* [CVE-2021-29975](https://nvd.nist.gov/vuln/detail/CVE-2021-29975)
* [CVE-2021-29976](https://nvd.nist.gov/vuln/detail/CVE-2021-29976)
* [CVE-2021-29977](https://nvd.nist.gov/vuln/detail/CVE-2021-29977)
* [CVE-2021-29980](https://nvd.nist.gov/vuln/detail/CVE-2021-29980)
* [CVE-2021-29981](https://nvd.nist.gov/vuln/detail/CVE-2021-29981)
* [CVE-2021-29982](https://nvd.nist.gov/vuln/detail/CVE-2021-29982)
* [CVE-2021-29984](https://nvd.nist.gov/vuln/detail/CVE-2021-29984)
* [CVE-2021-29985](https://nvd.nist.gov/vuln/detail/CVE-2021-29985)
* [CVE-2021-29986](https://nvd.nist.gov/vuln/detail/CVE-2021-29986)
* [CVE-2021-29987](https://nvd.nist.gov/vuln/detail/CVE-2021-29987)
* [CVE-2021-29988](https://nvd.nist.gov/vuln/detail/CVE-2021-29988)
* [CVE-2021-29989](https://nvd.nist.gov/vuln/detail/CVE-2021-29989)
* [CVE-2021-29990](https://nvd.nist.gov/vuln/detail/CVE-2021-29990)
* [CVE-2021-30547](https://nvd.nist.gov/vuln/detail/CVE-2021-30547)
* [CVE-2021-38491](https://nvd.nist.gov/vuln/detail/CVE-2021-38491)
* [CVE-2021-38493](https://nvd.nist.gov/vuln/detail/CVE-2021-38493)
* [CVE-2021-38495](https://nvd.nist.gov/vuln/detail/CVE-2021-38495)
* [CVE-2021-38503](https://nvd.nist.gov/vuln/detail/CVE-2021-38503)
* [CVE-2021-38504](https://nvd.nist.gov/vuln/detail/CVE-2021-38504)
* [CVE-2021-38506](https://nvd.nist.gov/vuln/detail/CVE-2021-38506)
* [CVE-2021-38507](https://nvd.nist.gov/vuln/detail/CVE-2021-38507)
* [CVE-2021-38508](https://nvd.nist.gov/vuln/detail/CVE-2021-38508)
* [CVE-2021-38509](https://nvd.nist.gov/vuln/detail/CVE-2021-38509)
* [CVE-2021-4129](https://nvd.nist.gov/vuln/detail/CVE-2021-4129)
* [CVE-2021-4140](https://nvd.nist.gov/vuln/detail/CVE-2021-4140)
* [CVE-2021-43536](https://nvd.nist.gov/vuln/detail/CVE-2021-43536)
* [CVE-2021-43537](https://nvd.nist.gov/vuln/detail/CVE-2021-43537)
* [CVE-2021-43538](https://nvd.nist.gov/vuln/detail/CVE-2021-43538)
* [CVE-2021-43539](https://nvd.nist.gov/vuln/detail/CVE-2021-43539)
* [CVE-2021-43540](https://nvd.nist.gov/vuln/detail/CVE-2021-43540)
* [CVE-2021-43541](https://nvd.nist.gov/vuln/detail/CVE-2021-43541)
* [CVE-2021-43542](https://nvd.nist.gov/vuln/detail/CVE-2021-43542)
* [CVE-2021-43543](https://nvd.nist.gov/vuln/detail/CVE-2021-43543)
* [CVE-2021-43545](https://nvd.nist.gov/vuln/detail/CVE-2021-43545)
* [CVE-2021-43546](https://nvd.nist.gov/vuln/detail/CVE-2021-43546)
* [CVE-2022-0511](https://nvd.nist.gov/vuln/detail/CVE-2022-0511)
* [CVE-2022-22737](https://nvd.nist.gov/vuln/detail/CVE-2022-22737)
* [CVE-2022-22738](https://nvd.nist.gov/vuln/detail/CVE-2022-22738)
* [CVE-2022-22739](https://nvd.nist.gov/vuln/detail/CVE-2022-22739)
* [CVE-2022-22740](https://nvd.nist.gov/vuln/detail/CVE-2022-22740)
* [CVE-2022-22741](https://nvd.nist.gov/vuln/detail/CVE-2022-22741)
* [CVE-2022-22742](https://nvd.nist.gov/vuln/detail/CVE-2022-22742)
* [CVE-2022-22743](https://nvd.nist.gov/vuln/detail/CVE-2022-22743)
* [CVE-2022-22745](https://nvd.nist.gov/vuln/detail/CVE-2022-22745)
* [CVE-2022-22747](https://nvd.nist.gov/vuln/detail/CVE-2022-22747)
* [CVE-2022-22748](https://nvd.nist.gov/vuln/detail/CVE-2022-22748)
* [CVE-2022-22751](https://nvd.nist.gov/vuln/detail/CVE-2022-22751)
* [CVE-2022-22753](https://nvd.nist.gov/vuln/detail/CVE-2022-22753)
* [CVE-2022-22754](https://nvd.nist.gov/vuln/detail/CVE-2022-22754)
* [CVE-2022-22755](https://nvd.nist.gov/vuln/detail/CVE-2022-22755)
* [CVE-2022-22756](https://nvd.nist.gov/vuln/detail/CVE-2022-22756)
* [CVE-2022-22757](https://nvd.nist.gov/vuln/detail/CVE-2022-22757)
* [CVE-2022-22758](https://nvd.nist.gov/vuln/detail/CVE-2022-22758)
* [CVE-2022-22759](https://nvd.nist.gov/vuln/detail/CVE-2022-22759)
* [CVE-2022-22760](https://nvd.nist.gov/vuln/detail/CVE-2022-22760)
* [CVE-2022-22761](https://nvd.nist.gov/vuln/detail/CVE-2022-22761)
* [CVE-2022-22762](https://nvd.nist.gov/vuln/detail/CVE-2022-22762)
* [CVE-2022-22763](https://nvd.nist.gov/vuln/detail/CVE-2022-22763)
* [CVE-2022-22764](https://nvd.nist.gov/vuln/detail/CVE-2022-22764)
* MOZ-2021-0004
* MOZ-2021-0005
* MOZ-2021-0006
* MOZ-2021-0007
* MOZ-2021-0008

**Release date**

February 21, 2022

**Latest revision**

February 21, 2022: 1

**Severity**

high

**Exploitable**

remote

**Bugzilla entries**

* [802768](https://bugs.gentoo.org/show_bug.cgi?id=802768)
* [807947](https://bugs.gentoo.org/show_bug.cgi?id=807947)
* [813498](https://bugs.gentoo.org/show_bug.cgi?id=813498)
* [821385](https://bugs.gentoo.org/show_bug.cgi?id=821385)
* [828538](https://bugs.gentoo.org/show_bug.cgi?id=828538)
* [831039](https://bugs.gentoo.org/show_bug.cgi?id=831039)
* [832992](https://bugs.gentoo.org/show_bug.cgi?id=832992)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from www.mozilla.org_6c2d2cfa_20250114_191055.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2021-30

## Security Vulnerabilities fixed in Thunderbird 78.12

Announced
July 13, 2021
Impact
high
Products
Thunderbird
Fixed in

* Thunderbird 78.12

#### [#CVE-2021-29969: IMAP server responses sent by a MITM prior to STARTTLS could be processed](#CVE-2021-29969)

Reporter
Damian Poddebniak and Fabian Ising
Impact
high
##### Description

If Thunderbird was configured to use STARTTLS for an IMAP connection, and an attacker injected IMAP server responses prior to the completion of the STARTTLS handshake, then Thunderbird didn't ignore the injected data. This could have resulted in Thunderbird showing incorrect information, for example the attacker could have tricked Thunderbird to show folders that didn't exist on the IMAP server.

##### References

* [Bug 1682370](https://bugzilla.mozilla.org/show_bug.cgi?id=1682370)

#### [#CVE-2021-29970: Use-after-free in accessibility features of a document](#CVE-2021-29970)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A malicious webpage could have triggered a use-after-free, memory corruption, and a potentially exploitable crash.
*This bug only affected Thunderbird when accessibility was enabled.*

##### References

* [Bug 1709976](https://bugzilla.mozilla.org/show_bug.cgi?id=1709976)

#### [#CVE-2021-30547: Out of bounds write in ANGLE](#CVE-2021-30547)

Reporter
(Unknown)
Impact
high
##### Description

An out of bounds write in ANGLE could have allowed an attacker to corrupt memory leading to a potentially exploitable crash.

##### References

* [Bug 1715766](https://bugzilla.mozilla.org/show_bug.cgi?id=1715766)

#### [#CVE-2021-29976: Memory safety bugs fixed in Thunderbird 78.12](#CVE-2021-29976)

Reporter
Mozilla developers
Impact
high
##### Description

Mozilla developers Valentin Gosu, Randell Jesup, Emil Ghitta, Tyson Smith, and Olli Pettay reported memory safety bugs present in Thunderbird 78.11. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Thunderbird 78.12](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1700895%2C1703334%2C1706910%2C1711576%2C1714391)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)


