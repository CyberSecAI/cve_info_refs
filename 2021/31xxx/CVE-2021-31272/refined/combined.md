=== Content from github.com_b622c53a_20250115_090936.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fpull%2F5713%2Fcommits%2F3844e8569689dd476064a0759d704bc64fb3ca2c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fpull%2F5713%2Fcommits%2F3844e8569689dd476064a0759d704bc64fb3ca2c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=SerenityOS%2Fserenity)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SerenityOS](/SerenityOS)
/
**[serenity](/SerenityOS/serenity)**
Public

* [Notifications](/login?return_to=%2FSerenityOS%2Fserenity) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2FSerenityOS%2Fserenity)
* [Star
   31k](/login?return_to=%2FSerenityOS%2Fserenity)

* [Code](/SerenityOS/serenity)
* [Issues
  716](/SerenityOS/serenity/issues)
* [Pull requests
  17](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

Additional navigation options

* [Code](/SerenityOS/serenity)
* [Issues](/SerenityOS/serenity/issues)
* [Pull requests](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)
to your account

# Userland: Fix tar/unzip directory traversal vulnerability #5713

 Closed

[bblenard](/bblenard)
wants to merge
2
commits into
[SerenityOS:master](/SerenityOS/serenity/tree/master "SerenityOS/serenity:master")
from
[bblenard:fix\_archive\_directory\_traversal\_bugs](/bblenard/serenity/tree/fix_archive_directory_traversal_bugs "bblenard/serenity:fix_archive_directory_traversal_bugs")

[Conversation
27](/SerenityOS/serenity/pull/5713)
[Commits
2](/SerenityOS/serenity/pull/5713/commits)
[Checks
0](/SerenityOS/serenity/pull/5713/checks)
[Files changed](/SerenityOS/serenity/pull/5713/files)

 Closed

# [Userland: Fix tar/unzip directory traversal vulnerability](#top) #5713

 Show file tree

 Hide file tree

Changes from **1 commit**

Commits

[Show all changes

2 commits](/SerenityOS/serenity/pull/5713/files)
Select commit
Hold shift + click to select a range

[`f0dc652`
AK: Make LexicalPath directory aware

Mar 18, 2021](/SerenityOS/serenity/pull/5713/commits/f0dc652928e832a094d47182f77de277ac043a5f)
[`3844e85`
Userland: Fix tar/unzip directory traversal vulnerability

Mar 18, 2021](/SerenityOS/serenity/pull/5713/commits/3844e8569689dd476064a0759d704bc64fb3ca2c)

**File filter**

### Filter by extension

Filter by extension

.cpp
(2)

All 1 file type selected

---

Viewed files

[Clear filters](/SerenityOS/serenity/pull/5713/commits/3844e8569689dd476064a0759d704bc64fb3ca2c)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

* Userland/Utilities

  + Userland/Utilities/tar.cpp
    [tar.cpp](#diff-ec1bbd5f5c12b6cdce87f8a36f19e380434dbc1e7c124e8bcecad5c05e25774f)
  + Userland/Utilities/unzip.cpp
    [unzip.cpp](#diff-a30ac4b33bced1f0b07abc7fa4fa8540df4897f9438db124a4808541eeda3014)

 [Prev](/SerenityOS/serenity/pull/5713/commits/f0dc652928e832a094d47182f77de277ac043a5f)Previous commit

Next

Userland: Fix tar/unzip directory traversal vulnerability

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

* Loading branch information

Baron Lenardson
committed
Mar 18, 2021

commit 3844e8569689dd476064a0759d704bc64fb3ca2c

## There are no files selected for viewing

48 changes: 47 additions & 1 deletion

48
[Userland/Utilities/tar.cpp](#diff-ec1bbd5f5c12b6cdce87f8a36f19e380434dbc1e7c124e8bcecad5c05e25774f "Userland/Utilities/tar.cpp")

Show comments

[View file](/bblenard/serenity/blob/3844e8569689dd476064a0759d704bc64fb3ca2c/Userland/Utilities/tar.cpp)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -59,6 +59,18 @@ int main(int argc, char\*\* argv) |
|  |  | args\_parser.add\_positional\_argument(paths, "Paths", "PATHS", Core::ArgsParser::Required::No); |
|  |  | args\_parser.parse(argc, argv); |
|  |  |  |
|  |  | // Currently tar doesn't support extracting to a specified location. If that is implemented the target path |
|  |  | // should be unveiled with rwc instead of the current directory. |
|  |  | StringBuilder target\_path\_raw; |
|  |  | target\_path\_raw.append(realpath(".", nullptr)); |
|  |  | target\_path\_raw.append("/"); |
|  |  | LexicalPath target\_path(target\_path\_raw.to\_string()); |
|  |  | auto target\_path\_string = target\_path.string(); |
|  |  | if (unveil(target\_path\_string.characters(), "rwc") < 0) { |
|  |  | perror("unveil"); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | if (create + extract + list != 1) { |
|  |  | warnln("exactly one of -c, -x, and -t can be used"); |
|  |  | return 1; |
| Expand All | | @@ -68,6 +80,16 @@ int main(int argc, char\*\* argv) |
|  |  | auto file = Core::File::standard\_input(); |
|  |  |  |
|  |  | if (archive\_file) { |
|  |  | // make sure we can read the archive path |
|  |  | auto archive\_file\_path = realpath(archive\_file, nullptr); |
|  |  | if (unveil(archive\_file\_path, "r") < 0) { |
|  |  | perror("unveil"); |
|  |  | return 1; |
|  |  | } |
|  |  | if (unveil(nullptr, nullptr) < 0) { |
|  |  | perror("unveil"); |
|  |  | return 1; |
|  |  | } |
|  |  | auto maybe\_file = Core::File::open(archive\_file, Core::IODevice::OpenMode::ReadOnly); |
|  |  | if (maybe\_file.is\_error()) { |
|  |  | warnln("Core::File::open: {}", maybe\_file.error()); |
| Expand All | | @@ -86,14 +108,38 @@ int main(int argc, char\*\* argv) |
|  |  | warnln("the provided file is not a well-formatted ustar file"); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | for (; !tar\_stream.finished(); tar\_stream.advance()) { |
|  |  | auto file\_name = tar\_stream.header().file\_name(); |
|  |  |  |
|  |  | if (list || verbose) |
|  |  | outln("{}", tar\_stream.header().file\_name()); |
|  |  | outln("{}", file\_name); |
|  |  |  |
|  |  | if (extract) { |
|  |  | Tar::TarFileStream file\_stream = tar\_stream.file\_contents(); |
|  |  |  |
|  |  | const Tar::Header& header = tar\_stream.header(); |
|  |  |  |
|  |  | // determine where the archive intends to write a file |
|  |  | StringBuilder destination\_path\_raw; |
|  |  | if (file\_name[0] != '/') { |
|  |  | destination\_path\_raw.append(target\_path\_string); |
|  |  | destination\_path\_raw.append("/"); |
|  |  | } |
|  |  | destination\_path\_raw.append(file\_name); |
|  |  | LexicalPath destination\_path(destination\_path\_raw.to\_string()); |
|  |  |  |
|  |  | if (!(destination\_path.string().starts\_with(target\_path\_string))) { |
|  |  | fprintf(stderr, "File %s path is outside of current working directory, skipping\n", file\_name.to\_string().characters()); |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // Ignore tars containing target path. |
|  |  | // This will prevent mkdir from failing later when it probably shouldn't |
|  |  | if (destination\_path.string() == target\_path\_string) { |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | switch (header.type\_flag()) { |
|  |  | case Tar::NormalFile: |
|  |  | case Tar::AlternateNormalFile: { |
| Expand Down | |  |

48 changes: 46 additions & 2 deletions

48
[Userland/Utilities/unzip.cpp](#diff-a30ac4b33bced1f0b07abc7fa4fa8540df4897f9438db124a4808541eeda3014 "Userland/Utilities/unzip.cpp")

Show comments

[View file](/bblenard/serenity/blob/3844e8569689dd476064a0759d704bc64fb3ca2c/Userland/Utilities/unzip.cpp)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,12 +24,14 @@ |
|  |  | \* OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. |
|  |  | \*/ |
|  |  |  |
|  |  | #include <AK/LexicalPath.h> |
|  |  | #include <AK/MappedFile.h> |
|  |  | #include <AK/NumberFormat.h> |
|  |  | #include <LibCore/ArgsParser.h> |
|  |  | #include <LibCore/File.h> |
|  |  | #include <string.h> |
|  |  | #include <sys/stat.h> |
|  |  | #include <unistd.h> |
|  |  |  |
|  |  | static const u8 central\_directory\_file\_header\_sig[] = "\x50\x4b\x01\x02"; |
|  |  |  |
| Expand Down  Expand Up | | @@ -62,7 +64,7 @@ static bool find\_next\_central\_directory(off\_t file\_size, const MappedFile& file, |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | static bool unpack\_file\_for\_central\_directory\_index(off\_t central\_directory\_index, const MappedFile& file) |
|  |  | static bool unpack\_file\_for\_central\_directory\_index(off\_t central\_directory\_index, const MappedFile& file, const AK::String target\_path) |
|  |  | { |
|  |  | enum CentralFileDirectoryHeaderOffsets { |
|  |  | CFDHCompressionMethodOffset = 10, |
| Expand Down  Expand Up | | @@ -120,6 +122,25 @@ static bool unpack\_file\_for\_central\_directory\_index(off\_t central\_directory\_inde |
|  |  | return false; |
|  |  | file\_name[file\_name\_length] = '\0'; |
|  |  |  |
|  |  | // determine where the archive intends to write a file |
|  |  | StringBuilder destination\_path\_raw; |
|  |  | if (file\_name[0] != '/') { |
|  |  | destination\_path\_raw.append(target\_path); |
|  |  | destination\_path\_raw.append("/"); |
|  |  | } |
|  |  | destination\_path\_raw.append(file\_name); |
|  |  | LexicalPath destination\_path(destination\_path\_raw.to\_string()); |
|  |  | if (!(destination\_path.string().starts\_with(target\_path))) { |
|  |  | fprintf(stderr, "File %s path is outside of current working directory, skipping\n", file\_name); |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // Ignore zips containing target path. |
|  |  | // This will prevent mkdir from failing later when it probably shouldn't |
|  |  | if (destination\_path.string() == target\_path) { |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | if (file\_name[file\_name\_length - 1] == '/') { |
|  |  | if (mkdir(file\_name, 0755) < 0) { |
|  |  | perror("mkdir"); |
| Expand Down  Expand Up | | @@ -162,6 +183,29 @@ int main(int argc, char\*\* argv) |
|  |  | args\_parser.add\_positional\_argument(path, "File to unzip", "path", Core::ArgsParser::Required::Yes); |
|  |  | args\_parser.parse(argc, argv); |
|  |  |  |
|  |  | StringBuilder target\_path\_raw; |
|  |  | // Currently unzip doesn't support extracting to a specified location. If that is implemented the target\_path |
|  |  | // should be replaced with the target path from the command line arguements instead of "." |
|  |  | target\_path\_raw.append(realpath(".", nullptr)); |
|  |  | target\_path\_raw.append("/"); |
|  |  | LexicalPath target\_path(target\_path\_raw.to\_string()); |
|  |  | auto target\_path\_string = target\_path.string(); |
|  |  | if (unveil(target\_path\_string.characters(), "rwc") < 0) { |
|  |  | perror("unveil"); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | auto zip\_path = realpath(path, nullptr); |
|  |  | if (unveil(zip\_path, "r") < 0) { |
|  |  | perror("unveil"); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | if (unveil(nullptr, nullptr) < 0) { |
|  |  | perror("unveil"); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
| **bblenard** marked this conversation as resolved.   Show resolved  Hide resolved | | |
|  |  | String zip\_file\_path { path }; |
|  |  |  |
|  |  | struct stat st; |
| Expand Down  Expand Up | | @@ -192,7 +236,7 @@ int main(int argc, char\*\* argv) |
|  |  |  |
|  |  | off\_t index = 0; |
|  |  | while (find\_next\_central\_directory(st.st\_size, mapped\_file, index, index)) { |
|  |  | bool success = unpack\_file\_for\_central\_directory\_index(index, mapped\_file); |
|  |  | bool success = unpack\_file\_for\_central\_directory\_index(index, mapped\_file, target\_path\_string); |
|  |  | if (!success) { |
|  |  | printf("Could not find local file header for a file.\n"); |
|  |  | return 4; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d5be6861_20250115_090929.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fissues%2F3991)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fissues%2F3991)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=SerenityOS%2Fserenity)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SerenityOS](/SerenityOS)
/
**[serenity](/SerenityOS/serenity)**
Public

* [Notifications](/login?return_to=%2FSerenityOS%2Fserenity) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2FSerenityOS%2Fserenity)
* [Star
   31k](/login?return_to=%2FSerenityOS%2Fserenity)

* [Code](/SerenityOS/serenity)
* [Issues
  716](/SerenityOS/serenity/issues)
* [Pull requests
  17](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

Additional navigation options

* [Code](/SerenityOS/serenity)
* [Issues](/SerenityOS/serenity/issues)
* [Pull requests](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# tar: Directory traversal vulnerability may lead to command execution / privilege escalation #3991

Open

[bcoles](/bcoles) opened this issue
Nov 8, 2020
· 17 comments

Open

# [tar: Directory traversal vulnerability may lead to command execution / privilege escalation](#top) #3991

[bcoles](/bcoles) opened this issue
Nov 8, 2020
· 17 comments

Labels
[security](/SerenityOS/serenity/labels/security)

## Comments

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issue-738367257)

| ``` $ cat shellrc  /bin/id $ ./evilarc.py -f evil.tar.gz -o unix -p etc shellrc Creating evil.tar.gz containing ../../../../../../../../etc/shellrc  ```  [lol](https://user-images.githubusercontent.com/434827/98456555-2bb48900-21d3-11eb-882e-56e1278050a8.png)  Most of the file system is mounted read-only. However, we can overwrite `/etc/shellrc` to gain privileges next time `root` uses `/bin/sh`. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723528349)

| Worth noting that this could also be used to gain command execution on the host, or elevate privileges to the `anon` user from a lower privileged user, in the event that `anon` extracts a malicious `tar` file.  `anon` does not have permission to write to `/etc/`, but so long as the `/home/anon/.config` directory exists, we could write a malicious `Terminal.ini` to `/home/anon/.config/Terminal.ini` with an arbitrary command in the `Command=` option.  ``` $ cat Terminal.ini  [Startup] Command=/bin/id [Window] Opacity=255 AudibleBeep=0 ScrollLength=4 $ ./evilarc.py -f evil.tar.gz -o unix -p home/anon/.config Terminal.ini  Creating evil.tar.gz containing ../../../../../../../../home/anon/.config/Terminal.ini  ```  [lol](https://user-images.githubusercontent.com/434827/98456698-eee99180-21d4-11eb-8b42-6545cad8ef70.png)  ``` Terminal(183): Load config file from /home/anon/.config/Terminal.ini WindowServer(15): Decoding a ShareableBitmap with shbuf_id=100, size=[16x16] [FinalizerTask(3:3)]: Scheduler[0]: Reaped unparented process utmpupdate(185), exit status: 0 Shell(184): Job entry "/bin/id" deleted in 241 ms [FinalizerTask(3:3)]: Scheduler[0]: Reaped unparented process Shell(184), exit status: 0 Terminal(183): TerminalWidget: EOF on master pty, firing on_command_exit hook. Terminal(183): Exiting terminal, updating utmp  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=40&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)
[bcoles](/bcoles)
changed the title
~~tar: Directory traversal vulnerability may lead to privilege escalation~~
tar: Directory traversal vulnerability may lead to command execution / privilege escalation
[Nov 8, 2020](#event-3970428549)

[![@Lubrsi](https://avatars.githubusercontent.com/u/25595356?s=80&u=0cdae0ed152fad96bf1ed7f16b97a2361d428ca9&v=4)](/Lubrsi)

Copy link

Member

### **[Lubrsi](/Lubrsi)** commented [Nov 8, 2020](#issuecomment-723528535) • edited Loading

| R.I.P. for Andreas's $5 (<http://serenityos.org/bounty/>) |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=40&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)
[bcoles](/bcoles)
mentioned this issue
[Nov 8, 2020](#ref-issue-738369090)

[unzip: Directory traversal vulnerability may lead to command execution / privilege escalation
#3992](/SerenityOS/serenity/issues/3992)

Open

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723529994)

| R.I.P. for Andreas's $5 (<http://serenityos.org/bounty/>)  I suppose that depends whether Andreas believes this is of sufficient criticality to warrant an exception to the bug bounty rules.  Exploitation via this technique seems fairly likely; however, this doesn't qualify for bounty as it requires user interaction. There's nothing in userland (or `Applications`, or `Services`) which makes use of `tar` / `unzip` by default (some of the Ports might, but vulnerabilities in the Ports also do not qualify).  Although the bug bounty rules are a bit unfair due to the "unfinished" nature of the project. A lot more attack surface will be opened up once Serenity is used as a legitimate "everyday" OS (as per the project goals).  For example, everything except `/bin/` is mounted no `suid`, and `/bin/` is mounted read-only. This seems unlikely in a production deployment. Also, it is likely that installing software natively within Serenity will eventually result in some dodgy software blindly running `unzip` / `tar` on untrusted files. Similarly, [#1624](https://github.com/SerenityOS/serenity/issues/1624) was a potentially devastating bug, but not exploitable in the default configuration. |
| --- |

All reactions

Sorry, something went wrong.

[![@Lubrsi](https://avatars.githubusercontent.com/u/25595356?s=80&u=0cdae0ed152fad96bf1ed7f16b97a2361d428ca9&v=4)](/Lubrsi)

Copy link

Member

### **[Lubrsi](/Lubrsi)** commented [Nov 8, 2020](#issuecomment-723532201) • edited Loading

| `Remote bugs must be exploitable with an unmodified "default setup" of SerenityOS. Bugs in programs that are not started by default don't qualify.`  I'm not sure if the "bugs in programs that are not started by default" applies here since it's in the same line as "Remote bugs". But, it would be best to get Andreas's clarification. |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723532683) • edited Loading

| `Remote bugs must be exploitable with an unmodified "default setup" of SerenityOS. Bugs in programs that are not started by default don't qualify.`  I'm not sure if the "bugs in programs that are not started by default" applies here since it's in the same line as "Remote bugs". But, it would be best to get Andreas's clarification.  I believe the intention of that statement was to prevent bounty claims in services such as TelnetService (ie, [#1735](https://github.com/SerenityOS/serenity/issues/1735)), especially as it does not currently support authentication, or non-default software (ie, Ports). |
| --- |

All reactions

Sorry, something went wrong.

[![@alimpfard](https://avatars.githubusercontent.com/u/14001776?s=80&u=2e764556595cfc5ab584fef34c679086953fe011&v=4)](/alimpfard)

Copy link

Member

### **[alimpfard](/alimpfard)** commented [Nov 8, 2020](#issuecomment-723538595)

| I don't understand the problem here (aside from `tar` not warning about weird paths). `/etc` is mounted `rw`, so provided you have write access, nothing will stop you from writing to it; same for `$HOME/.config`.  while `tar` should refuse to extract to absolute paths or whatever else, how is the fact that the user is allowed to write to something they have write access to so wrong? `echo "alias cat=echo" >> ~/.shellrc` might as well be considered haxx? |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723539697)

| I don't understand the problem here (aside from `tar` not warning about weird paths).  That's the problem. Not only should `tar` warn, it should outright reject the file (by default).  `/etc` is mounted `rw`, so provided you have write access, nothing will stop you from writing to it; same for `$HOME/.config`.  Agreed.  while `tar` should refuse to extract to absolute paths ...  That's the problem.  ... or whatever else, how is the fact that the user is allowed to write to something they have write access to so wrong?  Image you download some software in a compressed zip/tar archive. You extract the software without the verbose flag and prepare to enjoy your totally-not-malicious software. Or perhaps you enable verbose output, but the output flies by so fast that you don't notice anything strange. Without warning, a file has been written to a parent directory without your knowledge.  For exactly this reason, modern zip/tar software will refuse to extract files if the destination path traverses outside the working directory (by default).  ``` [2020-11-08 02:02:58] root@kali:/var/www/html/evilarc# ./evilarc.py -f evil.tar.gz -o unix -p etc shellrc Creating evil.tar.gz containing ../../../../../../../../etc/shellrc [2020-11-08 02:03:06] root@kali:/var/www/html/evilarc# tar zxvf evil.tar.gz  tar: Removing leading `../../../../../../../../' from member names tar: ../../../../../../../../etc/shellrc: Member name contains '..' tar: Exiting with failure status due to previous errors [2020-11-08 02:03:16] root@kali:/var/www/html/evilarc# ls -la /etc/shellrc ls: cannot access '/etc/shellrc': No such file or directory  ```  `echo "alias cat=echo" >> ~/.shellrc` might as well be considered haxx?  It sure is, presuming of course that you can make the user do that without their knowledge. That seems like a tall order. But if you've figured out mind control please tell me your secret. |
| --- |

 👍
1
 alimpfard reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@alimpfard](https://avatars.githubusercontent.com/u/14001776?s=80&u=2e764556595cfc5ab584fef34c679086953fe011&v=4)](/alimpfard)

Copy link

Member

### **[alimpfard](/alimpfard)** commented [Nov 8, 2020](#issuecomment-723540148)

| Not sure how that leads to privilege escalation, but I do agree with `tar` refusing to extract to such paths |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723540338)

| Also, it is not just users that are effected. Any software that downloads then decompresses a malicious archive using the userland `tar` / `unzip` utilities would be affected. This is a possible scenario for software during software updates, or installing plugins, or perhaps during the installation process while fetching and building dependencies.  Similarly, any server software (such as web applications) which permits the user to upload a file, then subsequently decompresses the file using the userland `tar` / `unzip` utilities would be affected. Decompressing uploaded compressed archives is a common practice, although this is usually (best) performed with compression libraries, rather than forking out to userland utilities.  No software currently included with Serenity performs these actions (that I'm aware of). |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723541796)

| Not sure how that leads to privilege escalation, but I do agree with `tar` refusing to extract to such paths  Fair call. Given that there really isn't much attack surface or usable functionality, and Serenity is basically a single user system due to the lack of login/logoff functionality, privilege escalation (to `anon` or to `root`) sounded like a good idea at the time.  In reality, this is more likely to be exploited to gain a foothold on the system by tricking a user into extracting the contents of a malicious compressed file.  The underlying issue is directory traversal leading to arbitrary file write (depending on file system permissions for the user). In terms of impact, you're correct that, in practice, command execution is a better title and more realistic scenario than privilege escalation.  Given that this is effectively a local file exploit (rather than remote) and most likely requires some form of social engineering ("here, open this"), and due to the lack of attackable functionality, I had a few scenarios in mind:   * leave a malicious `.tar.gz` file lying around (`free-stuff!.tar.gz`) and see if a higher privileged user opens it. * if a user was in the habit of storing their files somewhere on the file system that is world writable, a lower privileged user could overwrite the file with a malicious file. * man-in-the-middle (due to inconsistent use and support of TLS throughout Serenity) replace a `.tar.gz` file with a malicious file during download. * trick a user into downloading and extracting a malicious archive.   An academic exercise at this stage of system development given the limited environment. |
| --- |

All reactions

Sorry, something went wrong.

[![@awesomekling](https://avatars.githubusercontent.com/u/5954907?s=80&u=9d67d26e5a088f31ffff42f60d8d70a6b61c4942&v=4)](/awesomekling)

Copy link

Contributor

### **[awesomekling](/awesomekling)** commented [Nov 8, 2020](#issuecomment-723546074)

| Let's not play the game of calling everything a security vulnerability. |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723547206)

| Let's not play the game of calling everything a security vulnerability.  Strange response. Here's some light reading for you to peruse with your morning coffee:   * <https://snyk.io/blog/behind-the-disclosure-the-zip-slip-vulnerability/> * <https://github.com/snyk/zip-slip-vulnerability> * <https://www.google.com/search?q=zipslip+vulnerbaility> |
| --- |

All reactions

Sorry, something went wrong.

[![@awesomekling](https://avatars.githubusercontent.com/u/5954907?s=80&u=9d67d26e5a088f31ffff42f60d8d70a6b61c4942&v=4)](/awesomekling)

Copy link

Contributor

### **[awesomekling](/awesomekling)** commented [Nov 8, 2020](#issuecomment-723547575)

| Sorry, I'm just not a fan of the extreme hyperbole. These are just bugs and we can fix them. :) |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723550772)

| Sorry, I'm just not a fan of the extreme hyperbole.  I posted an issue to describe an issue, clearly demonstrating why it is an issue with accompanying screenshots.  I didn't say it was critical. I didn't say it was urgent. I didn't say it was likely. I didn't claim a bug bounty.  No hyperbole. Cause and effect.  Most software has vulnerabilities. This isn't an attack on you or your ego or your skills or your project.  These are just bugs and we can fix them. :)  These are just bugs and we can fix them. :) |
| --- |

All reactions

Sorry, something went wrong.

[![@awesomekling](https://avatars.githubusercontent.com/u/5954907?s=80&u=9d67d26e5a088f31ffff42f60d8d70a6b61c4942&v=4)](/awesomekling)

Copy link

Contributor

### **[awesomekling](/awesomekling)** commented [Nov 8, 2020](#issuecomment-723551185)

| Hmm, let me start over, I sound like such a grump.. Thank you [@bcoles](https://github.com/bcoles) for finding and documenting these issues, we should definitely fix them!  I had an unnecessarily strong reaction to the "may lead to command execution / privilege escalation" suffix in the bug titles, which to me felt like noise added for dramatic effect. I'm sorry about that. |
| --- |

 👍
2
 bcoles and huglovefan reacted with thumbs up emoji
 ❤️
2
 bcoles and smopucilowski reacted with heart emoji

All reactions

* 👍
  2 reactions
* ❤️
  2 reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issuecomment-723551602)

| [@awesomekling](https://github.com/awesomekling) thanks friend :) |
| --- |

 👍
1
 awesomekling reacted with thumbs up emoji
 ❤️
2
 awesomekling and smopucilowski reacted with heart emoji

All reactions

* 👍
  1 reaction
* ❤️
  2 reactions

Sorry, something went wrong.

[![@linusg](https://avatars.githubusercontent.com/u/19366641?s=40&u=75e32dda8a03cbd14d984e60b3352deaf7b38243&v=4)](/linusg)
[linusg](/linusg)
added
the
[security](/SerenityOS/serenity/labels/security)
label
[Dec 12, 2020](#event-4104478524)

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 10, 2021](#ref-commit-7165ec7)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9 "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[7165ec7](/bblenard/serenity/commit/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=40&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)
[bblenard](/bblenard)
mentioned this issue
[Mar 10, 2021](#ref-pullrequest-826908875)

[Userland: Fix tar/unzip directory traversal vulnerability
#5713](/SerenityOS/serenity/pull/5713)
 Closed

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

### **[bblenard](/bblenard)** commented [Mar 10, 2021](#issuecomment-794705964)

| Opened a PR to fix this issue. Trying to get my feet wet with Serenity/C++ so let me know if I'm doing something silly :) |
| --- |

All reactions

Sorry, something went wrong.

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 10, 2021](#ref-commit-bec265a)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/bec265a189db32dacb469954e69b713ef88f4d1b "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[bec265a](/bblenard/serenity/commit/bec265a189db32dacb469954e69b713ef88f4d1b)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 12, 2021](#ref-commit-ff15c7c)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/ff15c7c3453f92ee12710ce2c16ccfca4574edfd "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[ff15c7c](/bblenard/serenity/commit/ff15c7c3453f92ee12710ce2c16ccfca4574edfd)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 18, 2021](#ref-commit-2063dd9)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/2063dd9175327efb9a990b4fb61aeedf4c269f7e "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[2063dd9](/bblenard/serenity/commit/2063dd9175327efb9a990b4fb61aeedf4c269f7e)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 18, 2021](#ref-commit-3844e85)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/3844e8569689dd476064a0759d704bc64fb3ca2c "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[3844e85](/bblenard/serenity/commit/3844e8569689dd476064a0759d704bc64fb3ca2c)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fissues%2F3991)

Assignees

No one assigned

Labels

[security](/SerenityOS/serenity/labels/security)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Userland: Fix tar/unzip directory traversal vulnerability](/SerenityOS/serenity/pull/5713)
 [bblenard/serenity](/bblenard/serenity)

6 participants

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=52&v=4)](/bcoles) [![@awesomekling](https://avatars.githubusercontent.com/u/5954907?s=52&v=4)](/awesomekling) [![@alimpfard](https://avatars.githubusercontent.com/u/14001776?s=52&v=4)](/alimpfard) [![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=52&v=4)](/bblenard) [![@linusg](https://avatars.githubusercontent.com/u/19366641?s=52&v=4)](/linusg) [![@Lubrsi](https://avatars.githubusercontent.com/u/25595356?s=52&v=4)](/Lubrsi)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_08fed866_20250115_090931.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fissues%2F3992)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fissues%2F3992)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=SerenityOS%2Fserenity)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SerenityOS](/SerenityOS)
/
**[serenity](/SerenityOS/serenity)**
Public

* [Notifications](/login?return_to=%2FSerenityOS%2Fserenity) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2FSerenityOS%2Fserenity)
* [Star
   31k](/login?return_to=%2FSerenityOS%2Fserenity)

* [Code](/SerenityOS/serenity)
* [Issues
  716](/SerenityOS/serenity/issues)
* [Pull requests
  17](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

Additional navigation options

* [Code](/SerenityOS/serenity)
* [Issues](/SerenityOS/serenity/issues)
* [Pull requests](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# unzip: Directory traversal vulnerability may lead to command execution / privilege escalation #3992

Open

[bcoles](/bcoles) opened this issue
Nov 8, 2020
· 3 comments

Open

# [unzip: Directory traversal vulnerability may lead to command execution / privilege escalation](#top) #3992

[bcoles](/bcoles) opened this issue
Nov 8, 2020
· 3 comments

Labels
[security](/SerenityOS/serenity/labels/security)

## Comments

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Nov 8, 2020](#issue-738369090)

| Same issue as [#3991](https://github.com/SerenityOS/serenity/issues/3991) in `tar`.  [lol](https://user-images.githubusercontent.com/434827/98456848-bd24fa80-21d5-11eb-949a-a50ea347cb82.png)  This could also be used to gain command execution on the host, or elevate privileges to the `anon` user from a lower privileged user, in the event that `anon` extracts a malicious tar file.  Command execution via `/etc/shellrc` (as `root`) or `/home/anon/.config/Terminal.ini` (as `anon`). |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@linusg](https://avatars.githubusercontent.com/u/19366641?s=40&u=75e32dda8a03cbd14d984e60b3352deaf7b38243&v=4)](/linusg)
[linusg](/linusg)
added
the
[security](/SerenityOS/serenity/labels/security)
label
[Dec 12, 2020](#event-4104464899)

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 10, 2021](#ref-commit-7165ec7)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9 "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[7165ec7](/bblenard/serenity/commit/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=40&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)
[bblenard](/bblenard)
mentioned this issue
[Mar 10, 2021](#ref-pullrequest-826908875)

[Userland: Fix tar/unzip directory traversal vulnerability
#5713](/SerenityOS/serenity/pull/5713)
 Closed

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

### **[bblenard](/bblenard)** commented [Mar 10, 2021](#issuecomment-794707023)

| Also commented on [this issue](https://github.com/SerenityOS/serenity/issues/3991) but I'll cross post here:  Opened a PR to fix this issue. Trying to get my feet wet with Serenity/C++ so let me know if I'm doing something silly :) |
| --- |

All reactions

Sorry, something went wrong.

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 10, 2021](#ref-commit-bec265a)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/bec265a189db32dacb469954e69b713ef88f4d1b "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[bec265a](/bblenard/serenity/commit/bec265a189db32dacb469954e69b713ef88f4d1b)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 12, 2021](#ref-commit-ff15c7c)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/ff15c7c3453f92ee12710ce2c16ccfca4574edfd "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[ff15c7c](/bblenard/serenity/commit/ff15c7c3453f92ee12710ce2c16ccfca4574edfd)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 18, 2021](#ref-commit-2063dd9)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/2063dd9175327efb9a990b4fb61aeedf4c269f7e "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[2063dd9](/bblenard/serenity/commit/2063dd9175327efb9a990b4fb61aeedf4c269f7e)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[bblenard](/bblenard)
pushed a commit
to bblenard/serenity
that referenced
this issue
[Mar 18, 2021](#ref-commit-3844e85)

`[Userland: Fix tar/unzip directory traversal vulnerability](/bblenard/serenity/commit/3844e8569689dd476064a0759d704bc64fb3ca2c "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
…

`[3844e85](/bblenard/serenity/commit/3844e8569689dd476064a0759d704bc64fb3ca2c)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

[![@tbhaxor](https://avatars.githubusercontent.com/u/28386721?s=80&u=3c0d60d6a7ac1d4e640b2dc670ebd6a07c114f45&v=4)](/tbhaxor)

Copy link

Contributor

### **[tbhaxor](/tbhaxor)** commented [Nov 6, 2023](#issuecomment-1795479274)

| [@bcoles](https://github.com/bcoles) out of curiosity, the last `sh` command is not clear to me.  Calling sh from already elevated shell would spawn elevated shell which is an intended behaviour. I could get more clarity, if you would reveal the contents of the file you dropped here. |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

Author

### **[bcoles](/bcoles)** commented [Nov 7, 2023](#issuecomment-1797069398)

| [@bcoles](https://github.com/bcoles) out of curiosity, the last `sh` command is not clear to me.  Calling sh from already elevated shell would spawn elevated shell which is an intended behaviour. I could get more clarity, if you would reveal the contents of the file you dropped here.  Refer to [#3991](https://github.com/SerenityOS/serenity/issues/3991). |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fissues%2F3992)

Assignees

No one assigned

Labels

[security](/SerenityOS/serenity/labels/security)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Userland: Fix tar/unzip directory traversal vulnerability](/SerenityOS/serenity/pull/5713)
 [bblenard/serenity](/bblenard/serenity)

4 participants

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=52&v=4)](/bcoles) [![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=52&v=4)](/bblenard) [![@linusg](https://avatars.githubusercontent.com/u/19366641?s=52&v=4)](/linusg) [![@tbhaxor](https://avatars.githubusercontent.com/u/28386721?s=52&v=4)](/tbhaxor)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3da642f7_20250115_090934.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fpull%2F5713)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fpull%2F5713)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=SerenityOS%2Fserenity)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SerenityOS](/SerenityOS)
/
**[serenity](/SerenityOS/serenity)**
Public

* [Notifications](/login?return_to=%2FSerenityOS%2Fserenity) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2FSerenityOS%2Fserenity)
* [Star
   31k](/login?return_to=%2FSerenityOS%2Fserenity)

* [Code](/SerenityOS/serenity)
* [Issues
  716](/SerenityOS/serenity/issues)
* [Pull requests
  17](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

Additional navigation options

* [Code](/SerenityOS/serenity)
* [Issues](/SerenityOS/serenity/issues)
* [Pull requests](/SerenityOS/serenity/pulls)
* [Actions](/SerenityOS/serenity/actions)
* [Security](/SerenityOS/serenity/security)
* [Insights](/SerenityOS/serenity/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FSerenityOS%2Fserenity%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Userland: Fix tar/unzip directory traversal vulnerability #5713

 Closed

[bblenard](/bblenard)
wants to merge
2
commits into
[SerenityOS:master](/SerenityOS/serenity/tree/master "SerenityOS/serenity:master")
from
[bblenard:fix\_archive\_directory\_traversal\_bugs](/bblenard/serenity/tree/fix_archive_directory_traversal_bugs "bblenard/serenity:fix_archive_directory_traversal_bugs")

 Closed

# [Userland: Fix tar/unzip directory traversal vulnerability](#top) #5713

[bblenard](/bblenard)
wants to merge
2
commits into
[SerenityOS:master](/SerenityOS/serenity/tree/master "SerenityOS/serenity:master")
from
[bblenard:fix\_archive\_directory\_traversal\_bugs](/bblenard/serenity/tree/fix_archive_directory_traversal_bugs "bblenard/serenity:fix_archive_directory_traversal_bugs")

[Conversation
27](/SerenityOS/serenity/pull/5713)
[Commits
2](/SerenityOS/serenity/pull/5713/commits)
[Checks
0](/SerenityOS/serenity/pull/5713/checks)
[Files changed](/SerenityOS/serenity/pull/5713/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![bblenard](https://avatars.githubusercontent.com/u/15173997?s=60&v=4)](/bblenard)

Copy link

### @bblenard **[bblenard](/bblenard)** commented [Mar 10, 2021](#issue-826908875)

This change validates the filenames within a tar/zip archive during

extraction. If the filename within a the archive is outside of the

current working directory the file will be skipped and not extracted

onto the host system.

Closes [#3991](https://github.com/SerenityOS/serenity/issues/3991)

Closes [#3992](https://github.com/SerenityOS/serenity/issues/3992)

Sorry, something went wrong.

All reactions

 [![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=40&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)
[bblenard](/bblenard)
[force-pushed](/SerenityOS/serenity/compare/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9..bec265a189db32dacb469954e69b713ef88f4d1b)
the
fix\_archive\_directory\_traversal\_bugs

branch
from
[`7165ec7`](/SerenityOS/serenity/commit/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9) to
[`bec265a`](/SerenityOS/serenity/commit/bec265a189db32dacb469954e69b713ef88f4d1b)  [Compare](/SerenityOS/serenity/compare/7165ec792b0a7be477b8d1e9e16dadfd3fb9edd9..bec265a189db32dacb469954e69b713ef88f4d1b)
[March 10, 2021 01:53](#event-4432732198)

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 10, 2021](#issuecomment-794728867)

| I had a quick read over the code, but haven't tested.  In the `tar` patch, it looks like there's no validation on the file name beyond this check:  ``` if (!file_name.starts_with(current_path.to_string())) ```  Wouldn't this still allow traversal, as a filename of `/my/current/path/../../../../../something/else` still technically starts with `/my/current/path` ?  The approach for `unzip` looks better; however, it uses `realpath`.  I started on a patch for this ages ago (see testing code below). The issue I ran into is that `realpath` only work on paths which exist, and some paths won't exist prior to extraction. IIRC, this was an issue when the compressed archive contained directories as the directory had not yet been created.  ``` diff --git a/Userland/unzip.cpp b/Userland/unzip.cpp index 2617c353d..bb67a83bc 100644 --- a/Userland/unzip.cpp +++ b/Userland/unzip.cpp @@ -28,9 +28,13 @@  #include <AK/NumberFormat.h>  #include <LibCore/ArgsParser.h>  #include <LibCore/File.h> +#include <limits.h> +#include <stdlib.h>  #include <string.h>  #include <sys/stat.h> +#include <unistd.h>   +bool verbose = false;  static const u8 central_directory_file_header_sig[] = "\x50\x4b\x01\x02";    static bool seek_and_read(u8* buffer, const MappedFile& file, off_t seek_to, size_t bytes_to_read) @@ -120,31 +124,54 @@ static bool unpack_file_for_central_directory_index(off_t central_directory_inde          return false;      file_name[file_name_length] = '\0';   -    if (file_name[file_name_length - 1] == '/') { -        if (mkdir(file_name, 0755) < 0) { +    if (strlen(file_name) > PATH_MAX) { +        fprintf(stderr, "Warning: skipped file path (length %lu exceeds %d): %s\n", strlen(file_name), PATH_MAX, file_name); +        return false; +    } + +    char output_directory[PATH_MAX]; +    // FIXME: change once output directory (-d) is supported +    getcwd(output_directory, sizeof(output_directory)); + +    char file_path[PATH_MAX]; +    //realpath(String::format("%s/%s", output_directory, file_name).characters(), file_path); +    realpath(file_name, file_path); +    printf("OUT: %s\n", output_directory); +    printf("path: %s\n", file_path); + +    if (strncmp(output_directory, file_path, strlen(output_directory)) != 0) { +        fprintf(stderr, "Warning: ignored path traversal: %s\n", file_path); +        //fprintf(stderr, "Warning: ignored path traversal: %s\n", file_name); +        return false; +    } + +    if (verbose) +        printf(" extracting: %s\n", file_path); + +    if (file_path[strlen(file_path) - 1] == '/') { +        if (mkdir(file_path, 0755) < 0) {              perror("mkdir");              return false;          }      } else { -        auto new_file = Core::File::construct(String { file_name }); +        auto new_file = Core::File::construct(String { file_path });          if (!new_file->open(Core::IODevice::WriteOnly)) { -            fprintf(stderr, "Can't write file %s: %s\n", file_name, new_file->error_string()); +            fprintf(stderr, "Can't write file %s: %s\n", file_path, new_file->error_string());              return false;          }   -        printf(" extracting: %s\n", file_name);          u8 raw_file_contents[compressed_file_size]; -        if (!seek_and_read(raw_file_contents, file, local_file_header_index + LFHFileNameBaseOffset + file_name_length + extra_field_length, compressed_file_size)) +        if (!seek_and_read(raw_file_contents, file, local_file_header_index + LFHFileNameBaseOffset + strlen(file_path) + extra_field_length, compressed_file_size))              return false;            // FIXME: Try to uncompress data here. We're just ignoring it as no decompression methods are implemented yet.          if (!new_file->write(raw_file_contents, compressed_file_size)) { -            fprintf(stderr, "Can't write file contents in %s: %s\n", file_name, new_file->error_string()); +            fprintf(stderr, "Can't write file contents in %s: %s\n", file_path, new_file->error_string());              return false;          }            if (!new_file->close()) { -            fprintf(stderr, "Can't close file %s: %s\n", file_name, new_file->error_string()); +            fprintf(stderr, "Can't close file %s: %s\n", file_path, new_file->error_string());              return false;          }      } @@ -159,6 +186,7 @@ int main(int argc, char** argv)        Core::ArgsParser args_parser;      args_parser.add_option(map_size_limit, "Maximum chunk size to map", "map-size-limit", 0, "size"); +    args_parser.add_option(verbose, "Verbose output", "verbose", 'v');      args_parser.add_positional_argument(path, "File to unzip", "path", Core::ArgsParser::Required::Yes);      args_parser.parse(argc, argv);   ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 10, 2021](#issuecomment-794736665)

| IIRC, this was an issue when the compressed archive contained directories as the directory had not yet been created.  Confirmed. I tested the `unzip` patch in this PR and ran into the same issue when the compressed zip file contains a directory, even when there's no traversal shenanigans at play.  [unzip](https://user-images.githubusercontent.com/434827/110564413-df894d80-81a0-11eb-8b39-e1db9467aaee.png)  ``` user@ubuntu:~/Desktop/serenity$ unzip -l Base/home/anon/asdf.zip  Archive:  Base/home/anon/asdf.zip   Length      Date    Time    Name ---------  ---------- -----   ----         0  2020-11-15 09:42   test/        77  2020-11-15 09:42   test/Terminal.ini ---------                     -------        77                     2 files user@ubuntu:~/Desktop/serenity$   ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 10, 2021](#issuecomment-794743198) • edited Loading

| 🤦 While cleaning up my code I must have accidentally removed the realpath call in tar. So yes you are right tar is still borked.  My testing wasn't good enough to catch the other issue you pointed out so thanks for mentioning it. I'll have to take this one back to the drawing board and see how to fix this.  My testing: [serenity](https://user-images.githubusercontent.com/15173997/110565157-a1921800-8113-11eb-902f-2b194b8990f9.png) |
| --- |

 👍
1
 bcoles reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 10, 2021](#issuecomment-794749647)

| My testing wasn't good enough to catch the other issue you pointed out so thanks for mentioning it. I'll have to take this one back to the drawing board and see how to fix this.  Using `realpath` is good and the correct approach (better than trying to perform string matching on `..` or using `starts_with`, both of which are doomed to failure).  Unfortunately this issue is more complex than it appears on the surface. It [the unzip patch] definitely resolves the issue, but it does so by breaking existing functionality. I got about as far as you did before I decided it was someone else's problem - good luck :P |
| --- |

All reactions

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 10, 2021](#issuecomment-794760317)

| We might be in luck! I have to look this over but implementing this was going to be my next idea. Looks like its already been done though (maybe still have to review)   [serenity/AK/LexicalPath.cpp](https://github.com/SerenityOS/serenity/blob/54f643659895ffbfc4b961f729ed5ed8f0cce37a/AK/LexicalPath.cpp#L41)  Line 41 in [54f6436](/SerenityOS/serenity/commit/54f643659895ffbfc4b961f729ed5ed8f0cce37a)   |  | void LexicalPath::canonicalize() | | --- | --- | |
| --- | --- | --- |

 👍
1
 bcoles reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 10, 2021](#issuecomment-794791402)

| [@bcoles](https://github.com/bcoles) although I think using Lexical path could work I'm wondering if a cleaner solution would be to utilize `unveil` instead. If we just unveil our current working directory for `rwc` I would think unzip / tar should fail if there is a funky archive. I'll give that a try too but I'm curious on your thoughts? |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 10, 2021](#issuecomment-794796526)

| [@bcoles](https://github.com/bcoles) although I think using Lexical path could work I'm wondering if a cleaner solution would be to utilize `unveil` instead. If we just unveil our current working directory for `rwc` I would think unzip / tar should fail if there is a funky archive. I'll give that a try too but I'm curious on your thoughts?  `unveil` is a good idea but I don't consider that the cleanest approach.  The paths should still be canonicalized appropriately. A combination would be best.  I forsee no immediate issues with using `unveil`. This will need to support writing to a user-specified output directory if one is provided (not sure if `tar` and `unzip` support these yet). There may also need to be support for temporary files created during extraction (maybe). |
| --- |

 👍
1
 bblenard reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

 [![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=40&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)
[bblenard](/bblenard)
[force-pushed](/SerenityOS/serenity/compare/bec265a189db32dacb469954e69b713ef88f4d1b..ff15c7c3453f92ee12710ce2c16ccfca4574edfd)
the
fix\_archive\_directory\_traversal\_bugs

branch
from
[`bec265a`](/SerenityOS/serenity/commit/bec265a189db32dacb469954e69b713ef88f4d1b) to
[`ff15c7c`](/SerenityOS/serenity/commit/ff15c7c3453f92ee12710ce2c16ccfca4574edfd)  [Compare](/SerenityOS/serenity/compare/bec265a189db32dacb469954e69b713ef88f4d1b..ff15c7c3453f92ee12710ce2c16ccfca4574edfd)
[March 12, 2021 02:32](#event-4448421752)

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 12, 2021](#issuecomment-797192617)

| Hopefully that fixes the issue properly now. I wasn't able to verify with a non malicious zip because I couldn't figure out how to make one that passed `VERIFY(compression_method == None);` 🤦 not sure what I was doing wrong but tested with a non malicious tar archive so I'm fairly confident. Below is what I did to test  [serenity](https://user-images.githubusercontent.com/15173997/110883536-42660c00-82a9-11eb-8bb4-757e58fc2e02.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 12, 2021](#issuecomment-797193117)

| Also I'm not 100% sold on the design of my code but wasn't sure how I would make it better so feel free to rip that apart :) |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 12, 2021](#issuecomment-797193857) • edited Loading

| I wasn't able to verify with a non malicious zip because I couldn't figure out how to make one  You'll need to create the ZIP on the host then copy it to the filesystem. Every directory in `Base` is copied to the filesystem during `ninja image` as part of `build-root-filesystem.sh`.  ``` mkdir test echo 'hello friends' > test/hello zip -r hello.zip test mv hello.zip $SERENITY_ROOT/Base/home/anon/hello.zip  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 12, 2021](#issuecomment-797194830)

| I wasn't able to verify with a non malicious zip because I couldn't figure out how to make one  You'll need to create the ZIP on the host then copy it to the filesystem. Every directory in `Base` is copied to the filesystem during `ninja image` as part of `build-root-filesystem.sh`.  ``` mkdir test echo 'hello friends' > test/hello zip -r hello.zip test mv hello.zip $SERENITY_ROOT/Base/home/anon/hello.zip  ```  Thats good to know! I've been using a simple http server to download things with `pro`. That being said I tried to create a zip on my host with `zip -r....` but it `unzip` on serenity complained, which is strange since thats how you are creating the zips |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 12, 2021](#issuecomment-797201248)

| I wasn't able to verify with a non malicious zip because I couldn't figure out how to make one  You'll need to create the ZIP on the host then copy it to the filesystem. Every directory in `Base` is copied to the filesystem during `ninja image` as part of `build-root-filesystem.sh`.  ``` mkdir test echo 'hello friends' > test/hello zip -r hello.zip test mv hello.zip $SERENITY_ROOT/Base/home/anon/hello.zip  ```  Thats good to know! I've been using a simple http server to download things with `pro`. That being said I tried to create a zip on my host with `zip -r....` but it `unzip` on serenity complained, which is strange since thats how you are creating the zips  What does "complained" mean ? I suggest that the complaint is a result of your changes to `unzip`.  [unzip hello.zip](https://user-images.githubusercontent.com/434827/110885733-7ee24800-833b-11eb-9edd-5b6aebdfe48f.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 12, 2021](#issuecomment-797203584) • edited Loading

| It happens on a clean master build too. [@bcoles](https://github.com/bcoles) are you in the IRC channel because I could ping you there :)  [clean-master](https://user-images.githubusercontent.com/15173997/110886368-244eda80-82ae-11eb-8639-9afdcd1e1830.png)  Edit:  Worked out the issue on IRC, I didn't read the error I was getting 🤦 and was able to verify creating a zip without compression decompressed fine  [works](https://user-images.githubusercontent.com/15173997/110888840-a3dea880-82b2-11eb-920d-85835835188e.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 12, 2021](#issuecomment-797494032)

| For reference, this was [discussed on IRC](https://freenode.logbot.info/serenityos/20210312#c7224779) and the issue with decompression was resolved (and was unrelated to the patches in this PR). |
| --- |

All reactions

Sorry, something went wrong.

[![bcoles](https://avatars.githubusercontent.com/u/434827?s=60&v=4)](/bcoles)

**[bcoles](/bcoles)**
reviewed
[Mar 12, 2021](#pullrequestreview-610775708)

 [View reviewed changes](/SerenityOS/serenity/pull/5713/files)

Copy link

Collaborator

### @bcoles **[bcoles](/bcoles)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I had a look at the `unzip` patch only. My commentary may also apply to `tar`.

Sorry, something went wrong.

All reactions

[Userland/Utilities/unzip.cpp](/SerenityOS/serenity/pull/5713/files#diff-a30ac4b33bced1f0b07abc7fa4fa8540df4897f9438db124a4808541eeda3014)
Outdated

Comment on lines
190
 to
205

|  |  | fprintf(stderr, "PATH unveil\n"); |
| --- | --- | --- |
|  |  | perror("unveil"); |

Copy link

Collaborator

### @bcoles **[bcoles](/bcoles)** [Mar 12, 2021](#discussion_r593167072)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Using both `fprintf` and `perror` seems redundant. Simply `perror("unveil")` is sufficient.

Sorry, something went wrong.

All reactions

[Userland/Utilities/unzip.cpp](/SerenityOS/serenity/pull/5713/files#diff-a30ac4b33bced1f0b07abc7fa4fa8540df4897f9438db124a4808541eeda3014)

Show resolved

Hide resolved

[Userland/Utilities/unzip.cpp](/SerenityOS/serenity/pull/5713/files#diff-a30ac4b33bced1f0b07abc7fa4fa8540df4897f9438db124a4808541eeda3014)
Outdated

Comment on lines
224
 to
229

|  |  | StringBuilder target\_path; |
| --- | --- | --- |
|  |  | // Currently unzip doesn't support extracting to a specified location. If that is implemented the target\_path |
|  |  | // should be replaced with the target path from the command line arguements instead of "." |
|  |  | target\_path.append(realpath(".", nullptr)); |
|  |  | target\_path.append("/"); |
|  |  | auto target\_path\_string = target\_path.to\_string(); |

Copy link

Collaborator

### @bcoles **[bcoles](/bcoles)** [Mar 12, 2021](#discussion_r593173836)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The `target_path` is effectively the same as `cwd` which is defined and unveiled earlier. `target_path` is a more future-proof name and it would make sense to group these together and use the same variable.

This way, if someone adds support for decompressing to a user-specified directory (ie, `unzip -d /output/path`) in the future, they only need to change one line as there's no hard coded assumption of operating in the working directory.

Sorry, something went wrong.

All reactions

[Userland/Utilities/unzip.cpp](/SerenityOS/serenity/pull/5713/files#diff-a30ac4b33bced1f0b07abc7fa4fa8540df4897f9438db124a4808541eeda3014)
Outdated

Comment on lines
183
 to
194

|  |  | fprintf(stderr, "CWD unveil\n"); |
| --- | --- | --- |
|  |  | perror("unveil"); |

Copy link

Collaborator

### @bcoles **[bcoles](/bcoles)** [Mar 12, 2021](#discussion_r593174786)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Using both `fprintf` and `perror` seems redundant. Simply `perror("unveil")` is sufficient.

Sorry, something went wrong.

All reactions

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 12, 2021](#issuecomment-797514997)

| I tried the patched `tar` utility on an old `.tar.gz` file I had lying around (after first decompressing with `gunzip`) which results in some unexpected output.  [tar -v -x -f php.tar](https://user-images.githubusercontent.com/434827/110950419-efb74d80-8397-11eb-826e-0a8d51139cf4.png)  An archive containing `./` is certainly unusual, but the output stating that it is not within the target directory is also a lie. Perhaps there should be a hard coded rejection for `./` entries with an appropriate error message.  On the other hand, `tar` on Ubuntu silently ignores it. For reference, here's the output for Ubuntu:  ``` user@ubuntu:~/test$ tar --list -f php.tar  ./ ./README ./index.php ./lang/ ./lang/english.php ./lang/german.php ./lang/polish.php ./lang/rus-1251.php ./lang/rus-koi8r.php ./themes/ ./themes/black-green.php ./themes/black-orange.php ./themes/default.php user@ubuntu:~/test$ tar xvf php.tar  ./ ./README tar: ./README: implausibly old time stamp -9223372036854775808 ./index.php tar: ./index.php: implausibly old time stamp -9223372036854775808 ./lang/ ./lang/english.php tar: ./lang/english.php: implausibly old time stamp -9223372036854775808 ./lang/german.php tar: ./lang/german.php: implausibly old time stamp -9223372036854775808 ./lang/polish.php tar: ./lang/polish.php: implausibly old time stamp -9223372036854775808 ./lang/rus-1251.php tar: ./lang/rus-1251.php: implausibly old time stamp -9223372036854775808 ./lang/rus-koi8r.php tar: ./lang/rus-koi8r.php: implausibly old time stamp -9223372036854775808 ./themes/ tar: ./lang: implausibly old time stamp -9223372036854775808 ./themes/black-green.php tar: ./themes/black-green.php: implausibly old time stamp -9223372036854775808 ./themes/black-orange.php tar: ./themes/black-orange.php: implausibly old time stamp -9223372036854775808 ./themes/default.php tar: ./themes/default.php: implausibly old time stamp -9223372036854775808 tar: ./themes: implausibly old time stamp -9223372036854775808 tar: .: implausibly old time stamp -9223372036854775808 user@ubuntu:~/test$ ls -la total 96 drwxr-xr-x  4 user user  4096 Dec 13  1901 . drwxr-xr-x 21 user user  4096 Mar 12 06:07 .. -rw-r--r--  1 user user 24508 Dec 13  1901 index.php drwxr-xr-x  2 user user  4096 Dec 13  1901 lang -rw-r--r--  1 user user 51200 Mar 12 05:57 php.tar -rw-r--r--  1 user user  1300 Dec 13  1901 README drwxr-xr-x  2 user user  4096 Dec 13  1901 themes user@ubuntu:~/test$   ```  On the other other hand, perhaps this is outside the scope of this PR. |
| --- |

All reactions

Sorry, something went wrong.

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 17, 2021](#issuecomment-801502703)

| I think its in scope. The issue you saw was from some sloppy programming on my part. The issue happens because I use the following check to determine if a file is in the target path  ``` if (!destination_path.string().starts_with(target_path_string)) {  ```  The reason you see this error is because for `./` the destination path ends up being `/path/to/some/folder` and the `target_path_string` is `/path/to/some/folder/`. I intentionally add the `/` to the target path because I wanted a way to ensure you were extracting under the target directory and not to a path that shares the same prefix but I don't know if that is a realistic thing to worry about. |
| --- |

All reactions

Sorry, something went wrong.

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=80&u=1fe0601f243e1627c6f738027d2e71b90dad989d&v=4)](/bcoles)

Copy link

Collaborator

### **[bcoles](/bcoles)** commented [Mar 17, 2021](#issuecomment-801509380)

| The reason you see this error is because for `./` the destination path ends up being `/path/to/some/folder` and the `target_path_string` is `/path/to/some/folder/`. I intentionally add the `/` to the target path because I wanted a way to ensure you were extracting under the target directory and not to a path that shares the same prefix but I don't know if that is a realistic thing to worry about.  It is a realistic thing to worry about, but you should be able to use the canonicalized path for the `starts_with` comparison, ensuring `/some/path/./ == /some/path/`. |
| --- |

All reactions

Sorry, something went wrong.

`[AK: Make LexicalPath directory aware](/SerenityOS/serenity/pull/5713/commits/f0dc652928e832a094d47182f77de277ac043a5f "AK: Make LexicalPath directory aware

This change makes LexicalPath objects directory aware. This allows
programs to resolve directory paths that contain special characters
without having to juggle appending a '/'. This doesn't matter a ton but
it helps when coding things that are checking paths.")`
 …

`[f0dc652](/SerenityOS/serenity/pull/5713/commits/f0dc652928e832a094d47182f77de277ac043a5f)`

```
This change makes LexicalPath objects directory aware. This allows
programs to resolve directory paths that contain special characters
without having to juggle appending a '/'. This doesn't matter a ton but
it helps when coding things that are checking paths.
```

 [![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=40&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)
[bblenard](/bblenard)
[force-pushed](/SerenityOS/serenity/compare/ff15c7c3453f92ee12710ce2c16ccfca4574edfd..2063dd9175327efb9a990b4fb61aeedf4c269f7e)
the
fix\_archive\_directory\_traversal\_bugs

branch
from
[`ff15c7c`](/SerenityOS/serenity/commit/ff15c7c3453f92ee12710ce2c16ccfca4574edfd) to
[`2063dd9`](/SerenityOS/serenity/commit/2063dd9175327efb9a990b4fb61aeedf4c269f7e)  [Compare](/SerenityOS/serenity/compare/ff15c7c3453f92ee12710ce2c16ccfca4574edfd..2063dd9175327efb9a990b4fb61aeedf4c269f7e)
[March 18, 2021 01:56](#event-4473378317)

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=80&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)

Copy link

Author

### **[bblenard](/bblenard)** commented [Mar 18, 2021](#issuecomment-801558972)

| Hopefully I'm getting close with this now. I did make an ease of use change to LexicalPath. If that isn't an acceptable change I would love to hear some ideas on how to handle archive file paths that share prefixes with the target path but are not the same directory. For example  `archive file path`: `/some/path_right_here` `target file path`:`/some/path`  [serenity](https://user-images.githubusercontent.com/15173997/111562016-6fac3180-8763-11eb-9e9b-3251557e0dab.png) |
| --- |

All reactions

Sorry, something went wrong.

`[Userland: Fix tar/unzip directory traversal vulnerability](/SerenityOS/serenity/pull/5713/commits/3844e8569689dd476064a0759d704bc64fb3ca2c "Userland: Fix tar/unzip directory traversal vulnerability

This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes #3991
Closes #3992")`
 …

`[3844e85](/SerenityOS/serenity/pull/5713/commits/3844e8569689dd476064a0759d704bc64fb3ca2c)`

```
This change validates the filenames within a tar/zip archive during
extraction. If the filename within a the archive is outside of the
current working directory the file will be skipped and not extracted
onto the host system.

Closes [SerenityOS#3991](https://github.com/SerenityOS/serenity/issues/3991)
Closes [SerenityOS#3992](https://github.com/SerenityOS/serenity/issues/3992)
```

 [![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=40&u=3b9977a135607788529f491331084c2806ec3343&v=4)](/bblenard)
[bblenard](/bblenard)
[force-pushed](/SerenityOS/serenity/compare/2063dd9175327efb9a990b4fb61aeedf4c269f7e..3844e8569689dd476064a0759d704bc64fb3ca2c)
the
fix\_archive\_directory\_traversal\_bugs

branch
from
[`2063dd9`](/SerenityOS/serenity/commit/2063dd9175327efb9a990b4fb61aeedf4c269f7e) to
[`3844e85`](/SerenityOS/serenity/commit/3844e8569689dd476064a0759d704bc64fb3ca2c)  [Compare](/SerenityOS/serenity/compare/2063dd9175327efb9a990b4fb61aeedf4c269f7e..3844e8569689dd476064a0759d704bc64fb3ca2c)
[March 18, 2021 23:57](#event-4479244621)

[![@linusg](https://avatars.githubusercontent.com/u/19366641?s=80&u=75e32dda8a03cbd14d984e60b3352deaf7b38243&v=4)](/linusg)

Copy link

Member

### **[linusg](/linusg)** commented [Apr 14, 2021](#issuecomment-819902277)

| [@bblenard](https://github.com/bblenard) there are two merge conflicts, please rebase this PR :) |
| --- |

All reactions

Sorry, something went wrong.

[![@stale](https://avatars.githubusercontent.com/in/1724?s=80&v=4)](/apps/stale)

Copy link

### **[stale](/apps/stale) bot** commented [May 5, 2021](#issuecomment-833113961)

| This pull request has been automatically marked as stale because it has not had recent activity. It will be closed in 7 days if no further activity occurs. Thank you for your contributions! |
| --- |

All reactions

Sorry, something went wrong.

[![@stale](https://avatars.githubusercontent.com/in/1724?s=40&v=4)](/apps/stale)
[stale](/apps/stale)
bot
added
the
[stale](/SerenityOS/serenity/labels/stale)
label
[May 5, 2021](#event-4692026224)

[![@stale](https://avatars.githubusercontent.com/in/1724?s=80&v=4)](/apps/stale)

Copy link

### **[stale](/apps/stale) bot** commented [May 13, 2021](#issuecomment-840182618)

| This pull request has been closed because it has not had recent activity. Feel free to re-open if you wish to still contribute these changes. Thank you for your contributions! |
| --- |

All reactions

Sorry, something went wrong.

[![@stale](https://avatars.githubusercontent.com/in/1724?s=40&v=4)](/apps/stale)
[stale](/apps/stale)
bot
closed this
[May 13, 2021](#event-4739291120)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FSerenityOS%2Fserenity%2Fpull%2F5713)

Reviewers

[![@bcoles](https://avatars.githubusercontent.com/u/434827?s=40&v=4)](/bcoles) [bcoles](/bcoles)

bcoles left review comments

Assignees

No one assigned

Labels

[stale](/SerenityOS/serenity/labels/stale)

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [unzip: Directory traversal vulnerability may lead to command execution / privilege escalation](https://github.com/SerenityOS/serenity/issues/3992)

 [tar: Directory traversal vulnerability may lead to command execution / privilege escalation](https://github.com/SerenityOS/serenity/issues/3991)

3 participants

[![@bblenard](https://avatars.githubusercontent.com/u/15173997?s=52&v=4)](/bblenard) [![@bcoles](https://avatars.githubusercontent.com/u/434827?s=52&v=4)](/bcoles) [![@linusg](https://avatars.githubusercontent.com/u/19366641?s=52&v=4)](/linusg)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


