The provided content relates to CVE-2021-43266.

**Root cause of vulnerability:**
The vulnerability stems from insufficient sanitization of collection names during PDF export in Mahara. The `text_to_filename` function does not adequately remove special characters, allowing for command injection. Specifically, the function `preg_replace('#["()\*/:<>?\\| ]+#', '-', ...)` replaces the characters `["()\*/:<>?\\| ]` with hyphens, but it does not remove backticks or other command injection characters.

**Weaknesses/vulnerabilities present:**
- Command injection vulnerability in PDF export functionality.
- Insufficient sanitization of user-controlled input (collection names).
- Use of `exec` function with user-provided input.

**Impact of exploitation:**
- Code execution on the server.
- Potential privilege escalation.
- Possible denial of service.
- The attacker can gain a reverse shell.
- The attacker can execute arbitrary commands, potentially impacting the entire server.

**Attack vectors:**
- A malicious user creates a collection with a specially crafted name containing command injection payloads.
- An administrator triggers the vulnerability by performing a bulk PDF export that includes the user's collection.

**Required attacker capabilities/position:**
- A normal user account is sufficient to create a collection with a malicious name.
- An administrator must initiate the PDF export.

**Additional Details:**
- The vulnerability was initially reported in bug report [1942903](https://bugs.launchpad.net/mahara/+bug/1942903).
- A follow-up bug report [1949527](https://bugs.launchpad.net/mahara/+bug/1949527) was created to address an incomplete fix that still allowed command injection using backticks, though limited in scope.
- The vulnerability is present in Mahara versions before 20.04.5, 20.10.3, 21.04.2, and 21.10.0 and also in versions before 20.10.4, 21.04.3, and 21.10.1
- The fix involves further sanitization and it was suggested to use a whitelist approach instead of removing potentially malicious characters to avoid future issues.
- The original exploit used a `sleep` command to demonstrate the vulnerability and a more advanced attack used a curl command for a reverse shell.
- Patches were created and committed to the various affected branches to resolve the vulnerability.