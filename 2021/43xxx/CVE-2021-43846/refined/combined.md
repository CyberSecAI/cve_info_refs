=== Content from github.com_b22512bf_20250115_085402.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fsecurity%2Fadvisories%2FGHSA-h3fg-h5v3-vf8m)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fsecurity%2Fadvisories%2FGHSA-h3fg-h5v3-vf8m)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=solidusio%2Fsolidus)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[solidusio](/solidusio)
/
**[solidus](/solidusio/solidus)**
Public

* [Notifications](/login?return_to=%2Fsolidusio%2Fsolidus) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fsolidusio%2Fsolidus)
* [Star
   5.1k](/login?return_to=%2Fsolidusio%2Fsolidus)

* [Code](/solidusio/solidus)
* [Issues
  89](/solidusio/solidus/issues)
* [Pull requests
  39](/solidusio/solidus/pulls)
* [Discussions](/solidusio/solidus/discussions)
* [Actions](/solidusio/solidus/actions)
* [Projects
  1](/solidusio/solidus/projects)
* [Wiki](/solidusio/solidus/wiki)
* [Security](/solidusio/solidus/security)
* [Insights](/solidusio/solidus/pulse)

Additional navigation options

* [Code](/solidusio/solidus)
* [Issues](/solidusio/solidus/issues)
* [Pull requests](/solidusio/solidus/pulls)
* [Discussions](/solidusio/solidus/discussions)
* [Actions](/solidusio/solidus/actions)
* [Projects](/solidusio/solidus/projects)
* [Wiki](/solidusio/solidus/wiki)
* [Security](/solidusio/solidus/security)
* [Insights](/solidusio/solidus/pulse)

# CSRF forgery protection bypass for Spree::OrdersController#populate

Low

[waiting-for-dev](/waiting-for-dev)
published
GHSA-h3fg-h5v3-vf8m
Dec 20, 2021

## Package

bundler

solidus\_frontend
([RubyGems](/advisories?query=ecosystem%3Arubygems))

## Affected versions

< 3.1.5, < 3.0.5, < 2.11.14

## Patched versions

3.1.5, 3.0.5, 2.11.14

## Description

### Impact

CSRF vulnerability that allows a malicious site to add an item to the user's cart without their knowledge.

All `solidus_frontend` versions are affected. If you're using your own storefront, please, follow along to make sure you're not affected.

To reproduce the issue:

* Pick the id for a variant with available stock. From the rails console:

  ```
  Spree::Variant.in_stock.pluck(:id)
  ```

  Say we pick variant id `2`.
* Launch your application, for instance, on `http://localhost:3000`:

  ```
  bin/rails server
  ```
* Open your browser dev tools.
* Click on whatever link in your store.
* Copy the value of the `Cookie` request header sent for the previous request from your browser dev tools.
* Execute the following, using your previously selected variant id and the value of the `Cookie` header (notice how it doesn't contain any authentication token):

  ```
  curl -X POST -d "variant_id=2&quantity=1" -H "Cookie: guest_token=eyJfcmFpbHMiOnsibWVzc2FnZSI6IklrWlRVMWRQWnpKMVZVdFNXRzlPVW1aaWJHTjZZa0VpIiwiZXhwIjpudWxsLCJwdXIiOiJjb29raWUuZ3Vlc3RfdG9rZW4ifX0%3D--5006ba5d346f621c760a29b6a797bf351d17d1b8; _sandbox_session=vhutu5%2FL9NmWrUpGc3DxrFA%2FFsQD1dHn1cNsD7nvE84zcjWf17Af4%2F%2F2Vab3md71b6KTb9NP6WktdXktpwH4eU01jEGIBXG5%2BMzW5nL0nb4W269qk1io4LYljvoOg8%2BZVll7oJCVkJLKKh0sSoS0Kg8j%2FCHHs%2BsShohP%2BGnA%2Bfr9Ub8H6HofpSmloSpsfHHygmX0ho03fEgzHJ4DD5wJctaNKwg7NhVikHh5kgIPPHl84OGCgv3p2oe9jR19HTxOKq7BtyvDd7XZsecWhkcfS8BPnvDDUWZG6qpAEFI5kWo81KkpSJ%2Bp6Q1HOo8%3D--n3G2vgaDG7VS%2B%2FhF--ZTjxBAkfGG3hpr4GRQ2S1Q%3D%3D; __profilin=p%3Dt" http://localhost:3000/orders/populate
  ```
* Reload your browser and look at how your cart got updated.

### Patches

Please, upgrade `solidus` to versions `3.1.5`, `3.0.5` or `2.11.14`.

After upgrading, make sure you read the "Upgrade notes" section below.

### Upgrade notes

The patch adds CSRF token verification to the "Add to cart" action. Adding forgery protection to a form that missed it can have some side effects.

#### `InvalidAuthenticityToken` errors

If you're using the `:exception` strategy, it's likely that after upgrading, you'll see more `ActionController::InvalidAuthenticityToken` errors popping out in your logs. Due to browser-side cache, a form can be re-rendered and sent without any attached request cookie (for instance, when re-opening a mobile browser). That will cause an authentication error, as the sent token won't match with the one in the session (none in this case). That's a known problem in the Rails community (see [rails/rails#21948](https://github.com/rails/rails/issues/21948)), and, at this point, there's no perfect solution.

Any attempt to mitigate the issue should be seen at the application level. For an excellent survey of all the available options, take a look at <https://github.com/betagouv/demarches-simplifiees.fr/blob/5b4f7f9ae9eaf0ac94008b62f7047e4714626cf9/doc/adr-csrf-forgery.md>. The latter is a third-party link. As the information is relevant here, we're going to copy it below, but it should be clear that all the credit goes to [@kemenaran](https://github.com/kemenaran):

> # Protecting against request forgery using CRSF tokens
>
> ## Context
>
> Rails has CSRF protection enabled by default, to protect against POST-based CSRF attacks.
>
> To protect from this, Rails stores two copies of a random token (the so-named CSRF token) on each request:
>
> * one copy embedded in each HTML page,
> * another copy in the user session.
>
> When performing a POST request, Rails checks that the two copies match – and otherwise denies the request. This protects against an attacker that would generate a form secretly pointing to our website: the attacker can't read the token in the session, and so can't post a form with a valid token.
>
> The problem is that, much more often, this has false positives. There are several cases for that, including:
>
> 1. The web browser (often mobile) loads a page containing a form, then is closed by the user. Later, when the browser is re-opened, it restores the page from the cache. But the session cookie has expired, and so is not restored – so the copy of the CSRF token stored in the session is missing. When the user submits the form, they get an "InvalidAuthenticityToken" exception.
> 2. The user attempts to fill a form, and gets an error message (usually in response to a POST request). They close the browser. When the browser is re-opened, it attempts to restore the page. On Chrome this is blocked by the browser, because the browser denies retrying a (probably non-idempotent) POST request. Safari however happily retries the POST request – but without sending any cookies (in an attempt to avoid having unexpected side-effects). So the copy of the CSRF token in the session is missing (because no cookie was sent), and the user get an "InvalidAuthenticityToken" exception.
>
> ## Options considered
>
> ### Extend the session cookie duration
>
> We can configure the session cookie to be valid for a longer time (like 2 weeks).
>
> Pros:
>
> * It solves 1., because when the browser restores the page, the session cookie is still valid.
>
> Cons:
>
> * Users would be signed-in for a much longer time by default, which has unacceptable security implications.
> * It doesn't solve 2. (because Safari doesn't send any cookie when restoring a page from a POST request)
>
> ### Change the cache parameters
>
> We can send a HTTP cache header stating 'Cache-Control: no-store, no-cache'. This instructs the browser to never keep any copy of the page, and to always make a request to the server to restore it.
>
> This solution was attempted during a year in production, and solved 1. – but also introduced another type of InvalidAuthenticityToken errors. In that scenario, the user attempts to fill a form, and gets an error message (usually in response to a POST request). They then navigate on another domain (like France Connect), then hit the "Back" button. Crossing back the domain boundary may cause the browser to either block the request or retry an invalid POST request.
>
> Pros:
>
> * It solves 1., because on relaunch the browser requests a fresh page again (instead of serving it from its cache), thus retrieving a fresh session and a fresh matching CSRF token.
>
> Cons:
>
> * It doesn't solve 2.
> * It causes another type of InvalidAuthenticityToken errors.
>
> ### Using a null-session strategy
>
> We can change the default protect\_from\_forgery strategy to :null\_session. This makes the current request use an empty session for the request duration.
>
> Pros:
>
> * It kind of solves 1., by redirecting to a "Please sign-in" page when a stale form is submitted.
>
> Cons:
>
> * The user is asked to sign-in only after filling and submitting the form, losing their time and data
> * The user will not be redirected to their original page after signing-in
> * It has potential security implications: as the (potentically malicious) request runs anyway, variables cached by a controller before the Null session is created may allow the form submission to succeed anyway (<https://www.veracode.com/blog/managing-appsec/when-rails-protectfromforgery-fails>)
>
> ### Using a reset-session strategy
>
> We can change the default protect\_from\_forgery strategy to :reset\_session. This clears the user session permanently, logging them out until they log in again.
>
> Pros:
>
> * It kind of solves 1., by redirecting to a "Please sign-in" page when a stale form is submitted.
>
> Cons:
>
> * A forgery error in a browser tab will disconnect the user in all its open tabs
> * It has potential security implications: as the (potentically malicious) request runs anyway, variables cached by a controller before the Null session is created may allow the form submission to succeed anyway (<https://www.veracode.com/blog/managing-appsec/when-rails-protectfromforgery-fails>)
> * It allows an attacker to disconnect an user on demand, which is not only inconvenient, but also has security implication (the attacker could then log the user on it's own attacker account, pretending to be the user account)
>
> ### Redirect to login form
>
> When a forgery error occurs, we can instead redirect to the login form.
>
> Pros:
>
> * It kind of solves 1., by redirecting to a "Please sign-in" page when a stale form is submitted (but the user data is lost).
> * It kind of solves 2., by redirecting to a "Please sign-in" page when a previously POSTed form is reloaded.
>
> Cons:
>
> * Not all forms require authentication – so for public forms there is no point redirecting to the login form.
> * The user will not be redirected to their original page after signing-in (because setting the redirect path is a state-changing action, and it is dangerous to let an unauthorized request changing the state – an attacker could control the path where an user is automatically redirected to.)
> * The implementation is finicky, and may introduce security errors. For instance, a naive implementation that catches the exception and redirect\_to the sign-in page will prevent Devise from running a cleanup code – which means the user will still be logged, and the CSRF protection is bypassed. However a well-tested implementation that lets Devise code run should avoid these pittfalls.
>
> ### Using a long-lived cookie for CSRF tokens
>
> Instead of storing the CSRF token in the session cookie (which is deleted when the browser is closed), we can instead store it in a longer-lived cookie. For this we need to patch Rails.
>
> Pros:
>
> * It solves 1., because when the user submits a stale form, even if the session cookie because stale, the long-lived CSRF cookie is still valid.
>
> Cons:
>
> * It doesn't solve 2., because when Safari retries a POST request, it sends none of the cookies (not even long-lived ones).
> * Patching Rails may introduce security issues (now or in the future)

#### Broken behavior due to session expiration + template cache

Although pretty unlikely, you should make sure that your current setup for cache/session expiration is compatible. The upgrade can break the addition of products to the cart if both:

* The "Add to cart" form is being cached (usually along with the variant information).
* A user session is reset at every or every few requests.

The token validation depends on the issuing and consuming sessions being the same. If a product page is cached with the token in it, it can become stale on a subsequent rendering if the session changes.

To check that you're safe, after having upgraded locally, go through the following steps:

* Enable cache on dev mode:

  ```
  bin/rails dev:cache
  ```
* Visit the page for a variant with stock.
* Reload that page several times.
* Click on the "Add to cart" button.
* Remember to rerun `bin/rails dev:cache` to turn off cache again.

No error or session reset should happen.

Otherwise, you can try with:

* Revisiting how your session gets expired.
* Changing the caching strategy to exclude the token.

#### Using weaker CSRF protection strategies

It's also important to understand that a complete fix will only be in place when using the `:exception` forgery protection strategy. The `solidus_frontend` engine can't do pretty much anything otherwise. Using weaker CSRF strategies should be an informed and limited decision made by the application team. After the upgrade:

* An app using `:null_session` should also be safe, but there will be side effects. That strategy runs with a null object session. As such, no order and no user is found on it. A new `cart` state order is created in the database, associated with no user. Next time the user visits the site, they won't find any difference in its cart state.
* An app using `:reset_session` is not entirely safe. That strategy resets the session. That means that registered users will be logged out. Next time a user visits, they'll see the cart with the items added during the CSRF attack, although it won't be associated with their account in the case of registered users.

#### Reversing the update

If you still want to deploy the upgraded version before changing your application code (if the latter is needed), you can add the following workaround to your `config/application.rb` (however, take into account that you'll keep being vulnerable):

```
config.after_initialize do
  Spree::OrdersController.skip_before_action :verify_authenticity_token, only: [:populate]
end
```
### Workarounds

If an upgrade is not an option, you can work around the issue by adding the following to `config/application.rb`:

```
config.after_initialize do
  Spree::OrdersController.protect_from_forgery with: ApplicationController.forgery_protection_strategy.name.demodulize.underscore.to_sym, only: [:populate]
end
```

However, go through the same safety check detailed on "Upgrade notes" above.

### References

* [CSRF on the Rails guides](https://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf)
* [How CSRF tokens are generated and validated on Rails](https://medium.com/rubyinside/a-deep-dive-into-csrf-protection-in-rails-19fa0a42c0ef)
* [Solidus security](https://solidus.io/security/)

### For more information

If you have any questions or comments about this advisory:

* Open an [issue](https://github.com/solidusio/solidus/issues) or a [discussion](https://github.com/solidusio/solidus/discussions) in Solidus.
* Email us at security@solidus.io
* Contact the core team on [Slack](http://slack.solidus.io/)

### Severity

Low

### CVE ID

CVE-2021-43846

### Weaknesses

[CWE-352](/advisories?query=cwe%3A352)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_1eefaf33_20250115_085401.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fcommit%2Fa1b9bf7f24f9b8684fc4d943eacb02b1926c77c6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fcommit%2Fa1b9bf7f24f9b8684fc4d943eacb02b1926c77c6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=solidusio%2Fsolidus)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[solidusio](/solidusio)
/
**[solidus](/solidusio/solidus)**
Public

* [Notifications](/login?return_to=%2Fsolidusio%2Fsolidus) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fsolidusio%2Fsolidus)
* [Star
   5.1k](/login?return_to=%2Fsolidusio%2Fsolidus)

* [Code](/solidusio/solidus)
* [Issues
  89](/solidusio/solidus/issues)
* [Pull requests
  39](/solidusio/solidus/pulls)
* [Discussions](/solidusio/solidus/discussions)
* [Actions](/solidusio/solidus/actions)
* [Projects
  1](/solidusio/solidus/projects)
* [Wiki](/solidusio/solidus/wiki)
* [Security](/solidusio/solidus/security)
* [Insights](/solidusio/solidus/pulse)

Additional navigation options

* [Code](/solidusio/solidus)
* [Issues](/solidusio/solidus/issues)
* [Pull requests](/solidusio/solidus/pulls)
* [Discussions](/solidusio/solidus/discussions)
* [Actions](/solidusio/solidus/actions)
* [Projects](/solidusio/solidus/projects)
* [Wiki](/solidusio/solidus/wiki)
* [Security](/solidusio/solidus/security)
* [Insights](/solidusio/solidus/pulse)

## Commit

[Permalink](/solidusio/solidus/commit/a1b9bf7f24f9b8684fc4d943eacb02b1926c77c6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-h3fg-h5v3-vf8m](https://github.com/advisories/GHSA-h3fg-h5v3-vf8m "GHSA-h3fg-h5v3-vf8m")

[Browse files](/solidusio/solidus/tree/a1b9bf7f24f9b8684fc4d943eacb02b1926c77c6)
Browse the repository at this point in the history

```
Protect `Spree::OrdersController#populate` against CSRF attacks
```

* Loading branch information

[![@waiting-for-dev](https://avatars.githubusercontent.com/u/52650?s=40&v=4)](/waiting-for-dev)

[waiting-for-dev](/solidusio/solidus/commits?author=waiting-for-dev "View all commits by waiting-for-dev")
authored
Dec 20, 2021

2 parents
[c6b8926](/solidusio/solidus/commit/c6b892696881f88d209efaedd8bb378e8261953f)
+
[4d17cac](/solidusio/solidus/commit/4d17cacf066d9492fc04eb3a0b16084b47376d81)

commit a1b9bf7

Showing
**1 changed file**
with
**0 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

1 change: 0 additions & 1 deletion

1
[frontend/app/controllers/spree/orders\_controller.rb](#diff-2ac8a41b7bb2344ac4178b1af73af512e1e2f227d76474495bf7829082bd52e9 "frontend/app/controllers/spree/orders_controller.rb")

Show comments

[View file](/solidusio/solidus/blob/a1b9bf7f24f9b8684fc4d943eacb02b1926c77c6/frontend/app/controllers/spree/orders_controller.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,7 +10,6 @@ class OrdersController < Spree::StoreController |
|  |  | before\_action :assign\_order, only: :update |
|  |  | # note: do not lock the #edit action because that's where we redirect when we fail to acquire a lock |
|  |  | around\_action :lock\_order, only: :update |
|  |  | skip\_before\_action :verify\_authenticity\_token, only: [:populate] |
|  |  |  |
|  |  | def show |
|  |  | @order = Spree::Order.find\_by!(number: params[:id]) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a1b9bf7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fcommit%2Fa1b9bf7f24f9b8684fc4d943eacb02b1926c77c6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0e5d988b_20250115_085359.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fcommit%2F4d17cacf066d9492fc04eb3a0b16084b47376d81)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fcommit%2F4d17cacf066d9492fc04eb3a0b16084b47376d81)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=solidusio%2Fsolidus)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[solidusio](/solidusio)
/
**[solidus](/solidusio/solidus)**
Public

* [Notifications](/login?return_to=%2Fsolidusio%2Fsolidus) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fsolidusio%2Fsolidus)
* [Star
   5.1k](/login?return_to=%2Fsolidusio%2Fsolidus)

* [Code](/solidusio/solidus)
* [Issues
  89](/solidusio/solidus/issues)
* [Pull requests
  39](/solidusio/solidus/pulls)
* [Discussions](/solidusio/solidus/discussions)
* [Actions](/solidusio/solidus/actions)
* [Projects
  1](/solidusio/solidus/projects)
* [Wiki](/solidusio/solidus/wiki)
* [Security](/solidusio/solidus/security)
* [Insights](/solidusio/solidus/pulse)

Additional navigation options

* [Code](/solidusio/solidus)
* [Issues](/solidusio/solidus/issues)
* [Pull requests](/solidusio/solidus/pulls)
* [Discussions](/solidusio/solidus/discussions)
* [Actions](/solidusio/solidus/actions)
* [Projects](/solidusio/solidus/projects)
* [Wiki](/solidusio/solidus/wiki)
* [Security](/solidusio/solidus/security)
* [Insights](/solidusio/solidus/pulse)

## Commit

[Permalink](/solidusio/solidus/commit/4d17cacf066d9492fc04eb3a0b16084b47376d81)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Protect `Spree::OrdersController#populate` against CSRF attacks

[Browse files](/solidusio/solidus/tree/4d17cacf066d9492fc04eb3a0b16084b47376d81)
Browse the repository at this point in the history

```
See
[GHSA-h3fg-h5v3-vf8m](https://github.com/solidusio/solidus/security/advisories/GHSA-h3fg-h5v3-vf8m "GHSA-h3fg-h5v3-vf8m")
for all the details.

Some time ago, all order actions were left out of CSRF protection (see
[95ea570](https://github.com/solidusio/solidus/commit/95ea57058ab1c5e722b327b10747cd41e68a4deb)). The reason given was that the
authentication token got stale after the second rendering because the
product page is cached. That was limited to `#populate` in
[cb79754](https://github.com/solidusio/solidus/commit/cb797542c6948ef33d2cc9e6076c88f4cc927fb2) (see also
[spree/spree#5601](https://github.com/spree/spree/pull/5601)).

However, those assumptions are not correct. Although the authenticity
token changes at every request, that doesn't mean that the old ones are
no longer valid. The variation comes from a one-time pad added to a
session-dependant token (and meant to avoid timing attacks). However,
before validation, that one-time pad is removed. That means the token
remains valid as long as the session has not been reset. Think about
submitting a form from one browser tab after opening another with the
same URL. Even if both tokens differ, the submission from the first tab
will still be valid. You can read
<https://medium.com/rubyinside/a-deep-dive-into-csrf-protection-in-rails-19fa0a42c0ef>
for an in-deep understanding.

The initial confusion could come because of
[rails/rails#21948](https://github.com/rails/rails/issues/21948). Due to browser-side cache,
a form can be re-rendered and sent without any attached request cookie.
That will cause an authentication error, as the sent token won't match
with the one in the session (none in this case). There's no perfect
solution for that, and all partial fixes should be seen at the
application level. From our side, we must provide a safe default. For an
excellent survey of all the available options, take a look at
<https://github.com/betagouv/demarches-simplifiees.fr/blob/5b4f7f9ae9eaf0ac94008b62f7047e4714626cf9/doc/adr-csrf-forgery.md>.
The information given in that link is third-party but it's very
relevant here. For that reason we've copied it in the security advisory
(see link above), but all the credit goes to [@kemenaran](https://github.com/kemenaran).
```

* Loading branch information

[![@waiting-for-dev](https://avatars.githubusercontent.com/u/52650?s=40&v=4)](/waiting-for-dev)

[waiting-for-dev](/solidusio/solidus/commits?author=waiting-for-dev "View all commits by waiting-for-dev")
committed
Dec 14, 2021

1 parent
[f4b6de0](/solidusio/solidus/commit/f4b6de0872e1d2270d17671c7f1632d5bb33ee47)

commit 4d17cac

Showing
**1 changed file**
with
**0 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

1 change: 0 additions & 1 deletion

1
[frontend/app/controllers/spree/orders\_controller.rb](#diff-2ac8a41b7bb2344ac4178b1af73af512e1e2f227d76474495bf7829082bd52e9 "frontend/app/controllers/spree/orders_controller.rb")

Show comments

[View file](/solidusio/solidus/blob/4d17cacf066d9492fc04eb3a0b16084b47376d81/frontend/app/controllers/spree/orders_controller.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,7 +10,6 @@ class OrdersController < Spree::StoreController |
|  |  | before\_action :assign\_order, only: :update |
|  |  | # note: do not lock the #edit action because that's where we redirect when we fail to acquire a lock |
|  |  | around\_action :lock\_order, only: :update |
|  |  | skip\_before\_action :verify\_authenticity\_token, only: [:populate] |
|  |  |  |
|  |  | def show |
|  |  | @order = Spree::Order.find\_by!(number: params[:id]) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4d17cac`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsolidusio%2Fsolidus%2Fcommit%2F4d17cacf066d9492fc04eb3a0b16084b47376d81) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


