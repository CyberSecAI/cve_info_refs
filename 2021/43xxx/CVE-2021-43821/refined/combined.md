=== Content from github.com_4e04630c_20250114_194452.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fsecurity%2Fadvisories%2FGHSA-59g4-hpg3-3gcp)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fsecurity%2Fadvisories%2FGHSA-59g4-hpg3-3gcp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=opencast%2Fopencast)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[opencast](/opencast)
/
**[opencast](/opencast/opencast)**
Public

* [Notifications](/login?return_to=%2Fopencast%2Fopencast) You must be signed in to change notification settings
* [Fork
  237](/login?return_to=%2Fopencast%2Fopencast)
* [Star
   409](/login?return_to=%2Fopencast%2Fopencast)

* [Code](/opencast/opencast)
* [Issues
  228](/opencast/opencast/issues)
* [Pull requests
  65](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

Additional navigation options

* [Code](/opencast/opencast)
* [Issues](/opencast/opencast/issues)
* [Pull requests](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

# Files Accessible to External Parties

Critical

[gregorydlogan](/gregorydlogan)
published
GHSA-59g4-hpg3-3gcp
Dec 14, 2021

## Package

maven

opencast-ingest-service-impl
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

< 10.6

## Patched versions

10.6, 11.0

## Description

Opencast before version 10.6 allows references to local file URLs in ingested media packages, allowing attackers to include local files from Opencast's host machines and making them available via the web interface.

### Impact

Before Opencast 10.6, Opencast would [open and include local files during ingests](https://github.com/opencast/opencast/blob/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java#L1587). Attackers could exploit this to include most local files the process has read access to, extracting secrets from the host machine.

For example, to expose the `custom.properties` of develop.opencast.org via the asset manager, an attacker could have run:

```
curl -f -i -u admin:opencast \
  https://develop.opencast.org/ingest/addMediaPackage/fast \
  -F 'flavor=presenter/source'\
  -F mediaUri=file:///srv/opencast/opencast-dist-allinone/etc/custom.properties\
  -F title="custom.properties"

```

An attacker would need to have the privileges required to add new media to exploit this. But these are often widely given.

### Patches

The issue has been fixed in Opencast 10.6 and 11.0.

### Workarounds

You can mitigate this issue by narrowing down the read access Opencast has to files on the file system using UNIX permissions or mandatory access control systems like SELinux. This cannot prevent access to files Opencast needs to read though and we highly recommend updating.

### References

* [Example of problematic code](https://github.com/opencast/opencast/blob/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java#L1587).
* [Patch fixing the issue](https://github.com/opencast/opencast/commit/65c46b9d3e8f045c544881059923134571897764)

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [our issue tracker](https://github.com/opencast/opencast/issues)
* Email us at security@opencast.org

### Severity

Critical

### CVE ID

CVE-2021-43821

### Weaknesses

[CWE-552](/advisories?query=cwe%3A552)

### Credits

* [![@gregorydlogan](https://avatars.githubusercontent.com/u/5639561?s=40&v=4)](/gregorydlogan)
  [gregorydlogan](/gregorydlogan)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_32259597_20250114_194451.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fcommit%2F65c46b9d3e8f045c544881059923134571897764)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fcommit%2F65c46b9d3e8f045c544881059923134571897764)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=opencast%2Fopencast)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[opencast](/opencast)
/
**[opencast](/opencast/opencast)**
Public

* [Notifications](/login?return_to=%2Fopencast%2Fopencast) You must be signed in to change notification settings
* [Fork
  237](/login?return_to=%2Fopencast%2Fopencast)
* [Star
   409](/login?return_to=%2Fopencast%2Fopencast)

* [Code](/opencast/opencast)
* [Issues
  228](/opencast/opencast/issues)
* [Pull requests
  65](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

Additional navigation options

* [Code](/opencast/opencast)
* [Issues](/opencast/opencast/issues)
* [Pull requests](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

## Commit

[Permalink](/opencast/opencast/commit/65c46b9d3e8f045c544881059923134571897764)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-59g4-hpg3-3gcp](https://github.com/advisories/GHSA-59g4-hpg3-3gcp "GHSA-59g4-hpg3-3gcp")

[Browse files](/opencast/opencast/tree/65c46b9d3e8f045c544881059923134571897764)
Browse the repository at this point in the history

```
Ensure local files are not addable
```

* Loading branch information

[![@gregorydlogan](https://avatars.githubusercontent.com/u/5639561?s=40&v=4)](/gregorydlogan)

[gregorydlogan](/opencast/opencast/commits?author=gregorydlogan "View all commits by gregorydlogan")
authored
Dec 13, 2021

2 parents
[776d558](/opencast/opencast/commit/776d5588f39c61eb04c03bb955416c4f77629d51)
+
[d881ba6](/opencast/opencast/commit/d881ba613267086bb7d41b81a0440d12b9941154)

commit 65c46b9

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**14 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* modules/ingest-service-impl/src

  + main/java/org/opencastproject/ingest/impl

    - modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java
      [IngestServiceImpl.java](#diff-440028b22e68aececb1f33b4329f57618ffb172db087f0413d720b9da3893f1a)
  + test/java/org/opencastproject/ingest/impl

    - modules/ingest-service-impl/src/test/java/org/opencastproject/ingest/impl/IngestServiceImplTest.java
      [IngestServiceImplTest.java](#diff-80df6b1d2af39b85eb56e96ece9b615b291a089e0ac0984f1b973dfb9633e676)

## There are no files selected for viewing

7 changes: 6 additions & 1 deletion

7
[.../ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java](#diff-440028b22e68aececb1f33b4329f57618ffb172db087f0413d720b9da3893f1a "modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java")

Show comments

[View file](/opencast/opencast/blob/65c46b9d3e8f045c544881059923134571897764/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -315,6 +315,8 @@ public class IngestServiceImpl extends AbstractJobProducer implements IngestServ |
|  |  | private boolean skipCatalogs = DEFAULT\_SKIP; |
|  |  | private boolean skipAttachments = DEFAULT\_SKIP; |
|  |  |  |
|  |  | protected boolean testMode = false; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Creates a new ingest service instance. |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -1601,8 +1603,11 @@ protected URI addContentToRepo(MediaPackage mp, String elementId, URI uri) throw |
|  |  | throw new IOException(uri + " returns http " + httpStatusCode); |
|  |  | } |
|  |  | in = response.getEntity().getContent(); |
|  |  | } else { |
|  |  | //If it does not start with file, or we're in test mode (ie, to allow arbitrary file:// access) |
|  |  | } else if (!uri.toString().startsWith("file") || testMode) { |
|  |  | in = uri.toURL().openStream(); |
|  |  | } else { |
|  |  | throw new IOException("Refusing to fetch files from the local filesystem"); |
|  |  | } |
|  |  | String fileName = FilenameUtils.getName(uri.getPath()); |
|  |  | if (isBlank(FilenameUtils.getExtension(fileName))) |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[...est-service-impl/src/test/java/org/opencastproject/ingest/impl/IngestServiceImplTest.java](#diff-80df6b1d2af39b85eb56e96ece9b615b291a089e0ac0984f1b973dfb9633e676 "modules/ingest-service-impl/src/test/java/org/opencastproject/ingest/impl/IngestServiceImplTest.java")

Show comments

[View file](/opencast/opencast/blob/65c46b9d3e8f045c544881059923134571897764/modules/ingest-service-impl/src/test/java/org/opencastproject/ingest/impl/IngestServiceImplTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -344,6 +344,7 @@ protected CloseableHttpClient getNoAuthHttpClient() { |
|  |  | Dictionary<String, String> p = new Hashtable<>(); |
|  |  | p.put(IngestServiceImpl.DOWNLOAD\_SOURCE, "http://localhost.\*|http://www.test.com/.\*"); |
|  |  | service.updated(p); |
|  |  | service.testMode = true; |
|  |  | } |
|  |  |  |
|  |  | @After |
| Expand Down  Expand Up | | @@ -491,6 +492,13 @@ public void testAuthWhitelist() throws Exception { |
|  |  | testAuthWhitelist("http://www.example.org/testfile", "http://localhost.\*", true, false, true); |
|  |  | //Matching regex |
|  |  | testAuthWhitelist("http://www.example.org/testfile", "http://localhost.\*|http://www.example.org/.\*", false, true, true); |
|  |  |  |
|  |  | //Local filesystem should be actively rejected. This file needs to \*not\* be in the resources directory (look in the impl for why), and needs to be readable by the user running the test |
|  |  | //NB: This is a horrible, horrible hack, but it's the only way I can think of to get \*out\* of test-classes. If you try and ../ your way up above that getResource NPEs, as expected. |
|  |  | testAuthWhitelist(getClass().getResource("./../../../../").toURI().resolve("../../pom.xml").toString(), ".\*", true, false, false); |
|  |  | //Test to ensure we can't use '..' to get around filters. Removing the ".." works as expected, see below |
|  |  | testAuthWhitelist(getClass().getResource("./../impl/IngestServiceImplTest.class").toURI().toString(), ".\*", true, false, false); |
|  |  | testAuthWhitelist(getClass().getResource("./IngestServiceImplTest.class").toURI().toString(), ".\*", false, false, false); |
|  |  | } |
|  |  |  |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `65c46b9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fcommit%2F65c46b9d3e8f045c544881059923134571897764) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_695d37ca_20250114_194450.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fblob%2F69952463971cf578363e3b97d8edaf334ff51253%2Fmodules%2Fingest-service-impl%2Fsrc%2Fmain%2Fjava%2Forg%2Fopencastproject%2Fingest%2Fimpl%2FIngestServiceImpl.java)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fblob%2F69952463971cf578363e3b97d8edaf334ff51253%2Fmodules%2Fingest-service-impl%2Fsrc%2Fmain%2Fjava%2Forg%2Fopencastproject%2Fingest%2Fimpl%2FIngestServiceImpl.java)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=opencast%2Fopencast)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[opencast](/opencast)
/
**[opencast](/opencast/opencast)**
Public

* [Notifications](/login?return_to=%2Fopencast%2Fopencast) You must be signed in to change notification settings
* [Fork
  237](/login?return_to=%2Fopencast%2Fopencast)
* [Star
   409](/login?return_to=%2Fopencast%2Fopencast)

* [Code](/opencast/opencast)
* [Issues
  228](/opencast/opencast/issues)
* [Pull requests
  65](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

Additional navigation options

* [Code](/opencast/opencast)
* [Issues](/opencast/opencast/issues)
* [Pull requests](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

## Files

 6995246
## Breadcrumbs

1. [opencast](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253)
2. /[modules](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules)
3. /[ingest-service-impl](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl)
4. /[src](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src)
5. /[main](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main)
6. /[java](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java)
7. /[org](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org)
8. /[opencastproject](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject)
9. /[ingest](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest)
10. /[impl](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl)
/
# IngestServiceImpl.java

Copy path Blame  Blame
## Latest commit

## History

[History](/opencast/opencast/commits/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java)1915 lines (1734 loc) · 79.3 KB 6995246
## Breadcrumbs

1. [opencast](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253)
2. /[modules](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules)
3. /[ingest-service-impl](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl)
4. /[src](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src)
5. /[main](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main)
6. /[java](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java)
7. /[org](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org)
8. /[opencastproject](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject)
9. /[ingest](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest)
10. /[impl](/opencast/opencast/tree/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl)
/
# IngestServiceImpl.java

Top
## File metadata and controls

* Code
* Blame

1915 lines (1734 loc) · 79.3 KB[Raw](https://github.com/opencast/opencast/raw/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\*\* \* Licensed to The Apereo Foundation under one or more contributor license \* agreements. See the NOTICE file distributed with this work for additional \* information regarding copyright ownership. \* \* \* The Apereo Foundation licenses this file to you under the Educational \* Community License, Version 2.0 (the "License"); you may not use this file \* except in compliance with the License. You may obtain a copy of the License \* at: \* \* http://opensource.org/licenses/ecl2.txt \* \* Unless required by applicable law or agreed to in writing, software \* distributed under the License is distributed on an "AS IS" BASIS, WITHOUT \* WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the \* License for the specific language governing permissions and limitations under \* the License. \* \*/
package org.opencastproject.ingest.impl;
import static org.apache.commons.lang3.StringUtils.isBlank;import static org.opencastproject.util.JobUtil.waitForJob;import static org.opencastproject.util.data.Monadics.mlist;import static org.opencastproject.util.data.Option.none;
import org.opencastproject.capture.CaptureParameters;import org.opencastproject.ingest.api.IngestException;import org.opencastproject.ingest.api.IngestService;import org.opencastproject.ingest.impl.jmx.IngestStatistics;import org.opencastproject.inspection.api.MediaInspectionService;import org.opencastproject.job.api.AbstractJobProducer;import org.opencastproject.job.api.Job;import org.opencastproject.job.api.Job.Status;import org.opencastproject.mediapackage.EName;import org.opencastproject.mediapackage.MediaPackage;import org.opencastproject.mediapackage.MediaPackageBuilderFactory;import org.opencastproject.mediapackage.MediaPackageElement;import org.opencastproject.mediapackage.MediaPackageElementFlavor;import org.opencastproject.mediapackage.MediaPackageElementParser;import org.opencastproject.mediapackage.MediaPackageElements;import org.opencastproject.mediapackage.MediaPackageException;import org.opencastproject.mediapackage.MediaPackageParser;import org.opencastproject.mediapackage.MediaPackageSupport;import org.opencastproject.mediapackage.Track;import org.opencastproject.mediapackage.identifier.IdImpl;import org.opencastproject.metadata.dublincore.DCMIPeriod;import org.opencastproject.metadata.dublincore.DublinCore;import org.opencastproject.metadata.dublincore.DublinCoreCatalog;import org.opencastproject.metadata.dublincore.DublinCoreCatalogService;import org.opencastproject.metadata.dublincore.DublinCoreValue;import org.opencastproject.metadata.dublincore.EncodingSchemeUtils;import org.opencastproject.scheduler.api.SchedulerException;import org.opencastproject.scheduler.api.SchedulerService;import org.opencastproject.security.api.OrganizationDirectoryService;import org.opencastproject.security.api.SecurityService;import org.opencastproject.security.api.TrustedHttpClient;import org.opencastproject.security.api.UnauthorizedException;import org.opencastproject.security.api.UserDirectoryService;import org.opencastproject.series.api.SeriesService;import org.opencastproject.serviceregistry.api.ServiceRegistry;import org.opencastproject.serviceregistry.api.ServiceRegistryException;import org.opencastproject.smil.api.util.SmilUtil;import org.opencastproject.util.ConfigurationException;import org.opencastproject.util.IoSupport;import org.opencastproject.util.LoadUtil;import org.opencastproject.util.MimeTypes;import org.opencastproject.util.NotFoundException;import org.opencastproject.util.ProgressInputStream;import org.opencastproject.util.XmlSafeParser;import org.opencastproject.util.XmlUtil;import org.opencastproject.util.data.Function;import org.opencastproject.util.data.Option;import org.opencastproject.util.data.functions.Misc;import org.opencastproject.util.jmx.JmxUtil;import org.opencastproject.workflow.api.WorkflowDatabaseException;import org.opencastproject.workflow.api.WorkflowDefinition;import org.opencastproject.workflow.api.WorkflowException;import org.opencastproject.workflow.api.WorkflowInstance;import org.opencastproject.workflow.api.WorkflowService;import org.opencastproject.workingfilerepository.api.WorkingFileRepository;
import com.entwinemedia.fn.Stream;import com.entwinemedia.fn.data.Opt;import com.google.common.cache.Cache;import com.google.common.cache.CacheBuilder;
import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;import org.apache.commons.compress.archivers.zip.ZipArchiveInputStream;import org.apache.commons.io.FilenameUtils;import org.apache.commons.io.IOUtils;import org.apache.commons.lang3.BooleanUtils;import org.apache.commons.lang3.StringUtils;import org.apache.cxf.jaxrs.ext.multipart.ContentDisposition;import org.apache.http.Header;import org.apache.http.HttpResponse;import org.apache.http.auth.AuthScope;import org.apache.http.auth.UsernamePasswordCredentials;import org.apache.http.client.CredentialsProvider;import org.apache.http.client.config.AuthSchemes;import org.apache.http.client.methods.HttpGet;import org.apache.http.impl.client.BasicCredentialsProvider;import org.apache.http.impl.client.CloseableHttpClient;import org.apache.http.impl.client.HttpClientBuilder;import org.osgi.service.cm.ManagedService;import org.osgi.service.component.ComponentContext;import org.osgi.service.component.annotations.Activate;import org.osgi.service.component.annotations.Component;import org.osgi.service.component.annotations.Deactivate;import org.osgi.service.component.annotations.Reference;import org.osgi.service.component.annotations.ReferenceCardinality;import org.osgi.service.component.annotations.ReferencePolicy;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.xml.sax.SAXException;
import java.beans.PropertyChangeEvent;import java.beans.PropertyChangeListener;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStream;import java.io.InputStreamReader;import java.net.URI;import java.nio.charset.StandardCharsets;import java.util.Arrays;import java.util.Date;import java.util.Dictionary;import java.util.HashMap;import java.util.HashSet;import java.util.List;import java.util.Map;import java.util.Map.Entry;import java.util.Objects;import java.util.Set;import java.util.UUID;import java.util.concurrent.TimeUnit;
import javax.management.ObjectInstance;
/\*\* \* Creates and augments Opencast MediaPackages. Stores media into the Working File Repository. \*/@Component( immediate = true, service = { IngestService.class, ManagedService.class }, property = { "service.description=Ingest Service", "service.pid=org.opencastproject.ingest.impl.IngestServiceImpl" })public class IngestServiceImpl extends AbstractJobProducer implements IngestService, ManagedService {
 /\*\* The logger \*/ private static final Logger logger = LoggerFactory.getLogger(IngestServiceImpl.class);
 /\*\* The source SMIL name \*/ private static final String PARTIAL\_SMIL\_NAME = "source\_partial.smil";
 /\*\* The configuration key that defines the default workflow definition \*/ protected static final String WORKFLOW\_DEFINITION\_DEFAULT = "org.opencastproject.workflow.default.definition";
 /\*\* The workflow configuration property prefix \*\*/ protected static final String WORKFLOW\_CONFIGURATION\_PREFIX = "org.opencastproject.workflow.config.";
 /\*\* The key for the legacy mediapackage identifier \*/ public static final String LEGACY\_MEDIAPACKAGE\_ID\_KEY = "org.opencastproject.ingest.legacy.mediapackage.id";
 public static final String JOB\_TYPE = "org.opencastproject.ingest";
 /\*\* Methods that ingest zips create jobs with this operation type \*/ public static final String INGEST\_ZIP = "zip";
 /\*\* Methods that ingest tracks directly create jobs with this operation type \*/ public static final String INGEST\_TRACK = "track";
 /\*\* Methods that ingest tracks from a URI create jobs with this operation type \*/ public static final String INGEST\_TRACK\_FROM\_URI = "uri-track";
 /\*\* Methods that ingest attachments directly create jobs with this operation type \*/ public static final String INGEST\_ATTACHMENT = "attachment";
 /\*\* Methods that ingest attachments from a URI create jobs with this operation type \*/ public static final String INGEST\_ATTACHMENT\_FROM\_URI = "uri-attachment";
 /\*\* Methods that ingest catalogs directly create jobs with this operation type \*/ public static final String INGEST\_CATALOG = "catalog";
 /\*\* Methods that ingest catalogs from a URI create jobs with this operation type \*/ public static final String INGEST\_CATALOG\_FROM\_URI = "uri-catalog";
 /\*\* The approximate load placed on the system by ingesting a file \*/ public static final float DEFAULT\_INGEST\_FILE\_JOB\_LOAD = 0.2f;
 /\*\* The approximate load placed on the system by ingesting a zip file \*/ public static final float DEFAULT\_INGEST\_ZIP\_JOB\_LOAD = 0.2f;
 /\*\* The key to look for in the service configuration file to override the {@link DEFAULT\_INGEST\_FILE\_JOB\_LOAD} \*/ public static final String FILE\_JOB\_LOAD\_KEY = "job.load.ingest.file";
 /\*\* The key to look for in the service configuration file to override the {@link DEFAULT\_INGEST\_ZIP\_JOB\_LOAD} \*/ public static final String ZIP\_JOB\_LOAD\_KEY = "job.load.ingest.zip";
 /\*\* The source to download from \*/ public static final String DOWNLOAD\_SOURCE = "org.opencastproject.download.source";
 /\*\* The user for download from external sources \*/ public static final String DOWNLOAD\_USER = "org.opencastproject.download.user";
 /\*\* The password for download from external sources \*/ public static final String DOWNLOAD\_PASSWORD = "org.opencastproject.download.password";
 /\*\* By default, do not allow event ingest to modify existing series metadata \*/ public static final boolean DEFAULT\_ALLOW\_SERIES\_MODIFICATIONS = false;
 /\*\* The default is to preserve existing Opencast flavors during ingest. \*/ public static final boolean DEFAULT\_ALLOW\_ONLY\_NEW\_FLAVORS = true;
 /\*\* The default is not to automatically skip attachments and catalogs from capture agent \*/ public static final boolean DEFAULT\_SKIP = false;
 /\*\* The maximum length of filenames ingested by Opencast \*/ public static final int FILENAME\_LENGTH\_MAX = 75;
 /\*\* Managed Property key to allow Opencast series modification during ingest \* Deprecated, the param potentially causes an update chain reaction for all \* events associated to that series, for each ingest \*/ @Deprecated public static final String MODIFY\_OPENCAST\_SERIES\_KEY = "org.opencastproject.series.overwrite";
 /\*\* Managed Property key to allow new flavors of ingested attachments and catalogs \* to be added to the existing Opencast mediapackage. But, not catalogs and attachments \* that would overwrite existing ones in Opencast. \*/ public static final String ADD\_ONLY\_NEW\_FLAVORS\_KEY = "add.only.new.catalogs.attachments.for.existing.events";
 /\*\* Control if catalogs sent by capture agents for scheduled events are skipped. \*/ public static final String SKIP\_CATALOGS\_KEY = "skip.catalogs.for.existing.events";
 /\*\* Control if attachments sent by capture agents for scheduled events are skipped. \*/ public static final String SKIP\_ATTACHMENTS\_KEY = "skip.attachments.for.existing.events";
 /\*\* The approximate load placed on the system by ingesting a file \*/ private float ingestFileJobLoad = DEFAULT\_INGEST\_FILE\_JOB\_LOAD;
 /\*\* The approximate load placed on the system by ingesting a zip file \*/ private float ingestZipJobLoad = DEFAULT\_INGEST\_ZIP\_JOB\_LOAD;
 /\*\* The user for download from external sources \*/ private static String downloadUser = DOWNLOAD\_USER;
 /\*\* The password for download from external sources \*/ private static String downloadPassword = DOWNLOAD\_PASSWORD;
 /\*\* The external source dns name \*/ private static String downloadSource = DOWNLOAD\_SOURCE;
 /\*\* The JMX business object for ingest statistics \*/ private IngestStatistics ingestStatistics = new IngestStatistics();
 /\*\* The JMX bean object instance \*/ private ObjectInstance registerMXBean;
 /\*\* The workflow service \*/ private WorkflowService workflowService;
 /\*\* The working file repository \*/ private WorkingFileRepository workingFileRepository;
 /\*\* The http client \*/ private TrustedHttpClient httpClient;
 /\*\* The series service \*/ private SeriesService seriesService;
 /\*\* The dublin core service \*/ private DublinCoreCatalogService dublinCoreService;
 /\*\* The opencast service registry \*/ private ServiceRegistry serviceRegistry;
 /\*\* The security service \*/ protected SecurityService securityService = null;
 /\*\* The user directory service \*/ protected UserDirectoryService userDirectoryService = null;
 /\*\* The organization directory service \*/ protected OrganizationDirectoryService organizationDirectoryService = null;
 /\*\* The scheduler service \*/ private SchedulerService schedulerService = null;
 /\*\* The media inspection service \*/ private MediaInspectionService mediaInspectionService = null;
 /\*\* The default workflow identifier, if one is configured \*/ protected String defaultWorkflowDefinionId;
 /\*\* The partial track start time map \*/ private Cache<String, Long> partialTrackStartTimes = CacheBuilder.newBuilder().expireAfterWrite(1, TimeUnit.DAYS) .build();
 /\*\* Option to overwrite matching flavors (e.g. series and episode metadata) on ingest, \* tracks are always taken on ingest \*/ protected boolean isAddOnlyNew = DEFAULT\_ALLOW\_ONLY\_NEW\_FLAVORS; protected boolean isAllowModifySeries = DEFAULT\_ALLOW\_SERIES\_MODIFICATIONS;
 private boolean skipCatalogs = DEFAULT\_SKIP; private boolean skipAttachments = DEFAULT\_SKIP;
 /\*\* \* Creates a new ingest service instance. \*/ public IngestServiceImpl() { super(JOB\_TYPE); }
 /\*\* \* OSGI callback for activating this component \* \* @param cc \* the osgi component context \*/ @Override @Activate public void activate(ComponentContext cc) { super.activate(cc); logger.info("Ingest Service started."); defaultWorkflowDefinionId = StringUtils.trimToNull(cc.getBundleContext().getProperty(WORKFLOW\_DEFINITION\_DEFAULT)); if (defaultWorkflowDefinionId == null) { defaultWorkflowDefinionId = "schedule-and-upload"; } registerMXBean = JmxUtil.registerMXBean(ingestStatistics, "IngestStatistics"); }
 /\*\* \* Callback from OSGi on service deactivation. \*/ @Deactivate public void deactivate() { JmxUtil.unregisterMXBean(registerMXBean); }
 /\*\* \* {@inheritDoc} \* \* @see org.osgi.service.cm.ManagedService#updated(java.util.Dictionary) \* Retrieve ManagedService configuration, including option to overwrite series \*/ @Override public void updated(Dictionary<String, ?> properties) throws ConfigurationException {
 if (properties == null) { logger.info("No configuration available, using defaults"); return; }
 downloadPassword = StringUtils.trimToEmpty((String)properties.get(DOWNLOAD\_PASSWORD)); downloadUser = StringUtils.trimToEmpty(((String) properties.get(DOWNLOAD\_USER))); downloadSource = StringUtils.trimToEmpty(((String) properties.get(DOWNLOAD\_SOURCE)));
 skipAttachments = BooleanUtils.toBoolean(Objects.toString(properties.get(SKIP\_ATTACHMENTS\_KEY), BooleanUtils.toStringTrueFalse(DEFAULT\_SKIP))); skipCatalogs = BooleanUtils.toBoolean(Objects.toString(properties.get(SKIP\_CATALOGS\_KEY), BooleanUtils.toStringTrueFalse(DEFAULT\_SKIP))); logger.debug("Skip attachments sent by agents for scheduled events: {}", skipAttachments); logger.debug("Skip metadata catalogs sent by agents for scheduled events: {}", skipCatalogs);
 ingestFileJobLoad = LoadUtil.getConfiguredLoadValue(properties, FILE\_JOB\_LOAD\_KEY, DEFAULT\_INGEST\_FILE\_JOB\_LOAD, serviceRegistry); ingestZipJobLoad = LoadUtil.getConfiguredLoadValue(properties, ZIP\_JOB\_LOAD\_KEY, DEFAULT\_INGEST\_ZIP\_JOB\_LOAD, serviceRegistry);
 isAllowModifySeries = BooleanUtils.toBoolean(Objects.toString(properties.get(MODIFY\_OPENCAST\_SERIES\_KEY), BooleanUtils.toStringTrueFalse(DEFAULT\_ALLOW\_SERIES\_MODIFICATIONS))); isAddOnlyNew = BooleanUtils.toBoolean(Objects.toString(properties.get(ADD\_ONLY\_NEW\_FLAVORS\_KEY), BooleanUtils.toStringTrueFalse(DEFAULT\_ALLOW\_ONLY\_NEW\_FLAVORS))); logger.info("Only allow new flavored catalogs and attachments on ingest:'{}'", isAddOnlyNew); logger.info("Allowing series modification:'{}'", isAllowModifySeries); }
 /\*\* \* Sets the trusted http client \* \* @param httpClient \* the http client \*/ @Reference public void setHttpClient(TrustedHttpClient httpClient) { this.httpClient = httpClient; }
 /\*\* \* Sets the service registry \* \* @param serviceRegistry \* the serviceRegistry to set \*/ @Reference public void setServiceRegistry(ServiceRegistry serviceRegistry) { this.serviceRegistry = serviceRegistry; }
 /\*\* \* Sets the media inspection service \* \* @param mediaInspectionService \* the media inspection service to set \*/ @Reference public void setMediaInspectionService(MediaInspectionService mediaInspectionService) { this.mediaInspectionService = mediaInspectionService; }
 public WorkflowInstance addZippedMediaPackage(InputStream zipStream) throws IngestException, IOException, MediaPackageException { try { return addZippedMediaPackage(zipStream, null, null); } catch (NotFoundException e) { throw new IllegalStateException("A not found exception was thrown without a lookup"); } }
 @Override public WorkflowInstance addZippedMediaPackage(InputStream zipStream, String wd, Map<String, String> workflowConfig) throws MediaPackageException, IOException, IngestException, NotFoundException { try { return addZippedMediaPackage(zipStream, wd, workflowConfig, null); } catch (UnauthorizedException e) { throw new IllegalStateException(e); } }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addZippedMediaPackage(java.io.InputStream, java.lang.String, \* java.util.Map, java.lang.Long) \*/ @Override public WorkflowInstance addZippedMediaPackage(InputStream zipStream, String workflowDefinitionId, Map<String, String> workflowConfig, Long workflowInstanceId) throws MediaPackageException, IOException, IngestException, NotFoundException, UnauthorizedException { // Start a job synchronously. We can't keep the open input stream waiting around. Job job = null;
 if (StringUtils.isNotBlank(workflowDefinitionId)) { try { workflowService.getWorkflowDefinitionById(workflowDefinitionId); } catch (WorkflowDatabaseException e) { throw new IngestException(e); } catch (NotFoundException nfe) { logger.warn("Workflow definition {} not found, using default workflow {} instead", workflowDefinitionId, defaultWorkflowDefinionId); workflowDefinitionId = defaultWorkflowDefinionId; } }
 if (workflowInstanceId != null) { logger.warn("Deprecated method! Ingesting zipped mediapackage with workflow {}", workflowInstanceId); } else { logger.info("Ingesting zipped mediapackage"); }
 ZipArchiveInputStream zis = null; Set<String> collectionFilenames = new HashSet<>(); try { // We don't need anybody to do the dispatching for us. Therefore we need to make sure that the job is never in // QUEUED state but set it to INSTANTIATED in the beginning and then manually switch it to RUNNING. job = serviceRegistry.createJob(JOB\_TYPE, INGEST\_ZIP, null, null, false, ingestZipJobLoad); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job);
 // Create the working file target collection for this ingest operation String wfrCollectionId = Long.toString(job.getId());
 zis = new ZipArchiveInputStream(zipStream); ZipArchiveEntry entry; MediaPackage mp = null; Map<String, URI> uris = new HashMap<>(); // Sequential number to append to file names so that, if two files have the same // name, one does not overwrite the other (see MH-9688) int seq = 1; // Folder name to compare with next one to figure out if there's a root folder String folderName = null; // Indicates if zip has a root folder or not, initialized as true boolean hasRootFolder = true; // While there are entries write them to a collection while ((entry = zis.getNextZipEntry()) != null) { try { if (entry.isDirectory() || entry.getName().contains("\_\_MACOSX")) continue;
 if (entry.getName().endsWith("manifest.xml") || entry.getName().endsWith("index.xml")) { // Build the media package final InputStream is = new ZipEntryInputStream(zis, entry.getSize()); mp = MediaPackageParser.getFromXml(IOUtils.toString(is, StandardCharsets.UTF\_8)); } else { logger.info("Storing zip entry {}/{} in working file repository collection '{}'", job.getId(), entry.getName(), wfrCollectionId); // Since the directory structure is not being mirrored, makes sure the file // name is different than the previous one(s) by adding a sequential number String fileName = FilenameUtils.getBaseName(entry.getName()) + "\_" + seq++ + "." + FilenameUtils.getExtension(entry.getName()); URI contentUri = workingFileRepository.putInCollection(wfrCollectionId, fileName, new ZipEntryInputStream(zis, entry.getSize())); collectionFilenames.add(fileName); // Key is the zip entry name as it is String key = entry.getName(); uris.put(key, contentUri); ingestStatistics.add(entry.getSize()); logger.info("Zip entry {}/{} stored at {}", job.getId(), entry.getName(), contentUri); // Figures out if there's a root folder. Does entry name starts with a folder? int pos = entry.getName().indexOf('/'); if (pos == -1) { // No, we can conclude there's no root folder hasRootFolder = false; } else if (hasRootFolder && folderName != null && !folderName.equals(entry.getName().substring(0, pos))) { // Folder name different from previous so there's no root folder hasRootFolder = false; } else if (folderName == null) { // Just initialize folder name folderName = entry.getName().substring(0, pos); } } } catch (IOException e) { logger.warn("Unable to process zip entry {}: {}", entry.getName(), e); throw e; } }
 if (mp == null) throw new MediaPackageException("No manifest found in this zip");
 // Determine the mediapackage identifier if (mp.getIdentifier() == null || isBlank(mp.getIdentifier().toString())) mp.setIdentifier(IdImpl.fromUUID());
 String mediaPackageId = mp.getIdentifier().toString();
 logger.info("Ingesting mediapackage {} is named '{}'", mediaPackageId, mp.getTitle());
 // Make sure there are tracks in the mediapackage if (mp.getTracks().length == 0) { logger.warn("Mediapackage {} has no media tracks", mediaPackageId); }
 // Update the element uris to point to their working file repository location for (MediaPackageElement element : mp.elements()) { // Key has root folder name if there is one URI uri = uris.get((hasRootFolder ? folderName + "/" : "") + element.getURI().toString());
 if (uri == null) throw new MediaPackageException("Unable to map element name '" + element.getURI() + "' to workspace uri"); logger.info("Ingested mediapackage element {}/{} located at {}", mediaPackageId, element.getIdentifier(), uri); URI dest = workingFileRepository.moveTo(wfrCollectionId, FilenameUtils.getName(uri.toString()), mediaPackageId, element.getIdentifier(), FilenameUtils.getName(element.getURI().toString())); element.setURI(dest);
 // TODO: This should be triggered somehow instead of being handled here if (MediaPackageElements.SERIES.equals(element.getFlavor())) { logger.info("Ingested mediapackage {} contains updated series information", mediaPackageId); updateSeries(element.getURI()); } }
 // Now that all elements are in place, start with ingest logger.info("Initiating processing of ingested mediapackage {}", mediaPackageId); WorkflowInstance workflowInstance = ingest(mp, workflowDefinitionId, workflowConfig, workflowInstanceId); logger.info("Ingest of mediapackage {} done", mediaPackageId); job.setStatus(Job.Status.FINISHED); return workflowInstance; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (MediaPackageException e) { job.setStatus(Job.Status.FAILED, Job.FailureReason.DATA); throw e; } catch (Exception e) { if (e instanceof IngestException) throw (IngestException) e; throw new IngestException(e); } finally { IOUtils.closeQuietly(zis); finallyUpdateJob(job); for (String filename : collectionFilenames) { workingFileRepository.deleteFromCollection(Long.toString(job.getId()), filename, true); } } }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#createMediaPackage() \*/ @Override public MediaPackage createMediaPackage() throws MediaPackageException, ConfigurationException { MediaPackage mediaPackage; try { mediaPackage = MediaPackageBuilderFactory.newInstance().newMediaPackageBuilder().createNew(); } catch (MediaPackageException e) { logger.error("INGEST:Failed to create media package " + e.getLocalizedMessage()); throw e; } mediaPackage.setDate(new Date()); logger.info("Created mediapackage {}", mediaPackage); return mediaPackage; }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#createMediaPackage() \*/ @Override public MediaPackage createMediaPackage(String mediaPackageId) throws MediaPackageException, ConfigurationException { MediaPackage mediaPackage; try { mediaPackage = MediaPackageBuilderFactory.newInstance().newMediaPackageBuilder() .createNew(new IdImpl(mediaPackageId)); } catch (MediaPackageException e) { logger.error("INGEST:Failed to create media package " + e.getLocalizedMessage()); throw e; } mediaPackage.setDate(new Date()); logger.info("Created mediapackage {}", mediaPackage); return mediaPackage; }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addTrack(java.net.URI, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addTrack(URI uri, MediaPackageElementFlavor flavor, MediaPackage mediaPackage) throws IOException, IngestException { String[] tags = null; return this.addTrack(uri, flavor, tags, mediaPackage);
 }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addTrack(java.net.URI, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, String[] , \* org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addTrack(URI uri, MediaPackageElementFlavor flavor, String[] tags, MediaPackage mediaPackage) throws IOException, IngestException { Job job = null; try { job = serviceRegistry .createJob( JOB\_TYPE, INGEST\_TRACK\_FROM\_URI, Arrays.asList(uri.toString(), flavor == null ? null : flavor.toString(), MediaPackageParser.getAsXml(mediaPackage)), null, false, ingestFileJobLoad); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); String elementId = UUID.randomUUID().toString(); logger.info("Start adding track {} from URL {} on mediapackage {}", elementId, uri, mediaPackage); URI newUrl = addContentToRepo(mediaPackage, elementId, uri); MediaPackage mp = addContentToMediaPackage(mediaPackage, elementId, newUrl, MediaPackageElement.Type.Track, flavor); if (tags != null && tags.length > 0) { MediaPackageElement trackElement = mp.getTrack(elementId); for (String tag : tags) { logger.info("Adding Tag: " + tag + " to Element: " + elementId); trackElement.addTag(tag); } }
 job.setStatus(Job.Status.FINISHED); logger.info("Successful added track {} on mediapackage {} at URL {}", elementId, mediaPackage, newUrl); return mp; } catch (IOException e) { throw e; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (NotFoundException e) { throw new IngestException("Unable to update ingest job", e); } finally { finallyUpdateJob(job); } }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addTrack(java.io.InputStream, java.lang.String, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addTrack(InputStream in, String fileName, MediaPackageElementFlavor flavor, MediaPackage mediaPackage) throws IOException, IngestException { String[] tags = null; return this.addTrack(in, fileName, flavor, tags, mediaPackage); }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addTrack(java.io.InputStream, java.lang.String, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addTrack(InputStream in, String fileName, MediaPackageElementFlavor flavor, String[] tags, MediaPackage mediaPackage) throws IOException, IngestException { Job job = null; try { job = serviceRegistry.createJob(JOB\_TYPE, INGEST\_TRACK, null, null, false, ingestFileJobLoad); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); String elementId = UUID.randomUUID().toString(); logger.info("Start adding track {} from input stream on mediapackage {}", elementId, mediaPackage); if (fileName.length() > FILENAME\_LENGTH\_MAX) { final String extension = "." + FilenameUtils.getExtension(fileName); final int length = Math.max(0, FILENAME\_LENGTH\_MAX - extension.length()); fileName = fileName.substring(0, length) + extension; } URI newUrl = addContentToRepo(mediaPackage, elementId, fileName, in); MediaPackage mp = addContentToMediaPackage(mediaPackage, elementId, newUrl, MediaPackageElement.Type.Track, flavor); if (tags != null && tags.length > 0) { MediaPackageElement trackElement = mp.getTrack(elementId); for (String tag : tags) { logger.debug("Adding tag `{}` to element {}", tag, elementId); trackElement.addTag(tag); } }
 job.setStatus(Job.Status.FINISHED); logger.info("Successful added track {} on mediapackage {} at URL {}", elementId, mediaPackage, newUrl); return mp; } catch (IOException e) { throw e; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (NotFoundException e) { throw new IngestException("Unable to update ingest job", e); } finally { finallyUpdateJob(job); } }
 @Override public MediaPackage addPartialTrack(URI uri, MediaPackageElementFlavor flavor, long startTime, MediaPackage mediaPackage) throws IOException, IngestException { Job job = null; try { job = serviceRegistry.createJob( JOB\_TYPE, INGEST\_TRACK\_FROM\_URI, Arrays.asList(uri.toString(), flavor == null ? null : flavor.toString(), MediaPackageParser.getAsXml(mediaPackage)), null, false); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); String elementId = UUID.randomUUID().toString(); logger.info("Start adding partial track {} from URL {} on mediapackage {}", elementId, uri, mediaPackage); URI newUrl = addContentToRepo(mediaPackage, elementId, uri); MediaPackage mp = addContentToMediaPackage(mediaPackage, elementId, newUrl, MediaPackageElement.Type.Track, flavor); job.setStatus(Job.Status.FINISHED); // store startTime partialTrackStartTimes.put(elementId, startTime); logger.debug("Added start time {} for track {}", startTime, elementId); logger.info("Successful added partial track {} on mediapackage {} at URL {}", elementId, mediaPackage, newUrl); return mp; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (NotFoundException e) { throw new IngestException("Unable to update ingest job", e); } finally { finallyUpdateJob(job); } }
 @Override public MediaPackage addPartialTrack(InputStream in, String fileName, MediaPackageElementFlavor flavor, long startTime, MediaPackage mediaPackage) throws IOException, IngestException { Job job = null; try { job = serviceRegistry.createJob(JOB\_TYPE, INGEST\_TRACK, null, null, false); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); String elementId = UUID.randomUUID().toString(); logger.info("Start adding partial track {} from input stream on mediapackage {}", elementId, mediaPackage); URI newUrl = addContentToRepo(mediaPackage, elementId, fileName, in); MediaPackage mp = addContentToMediaPackage(mediaPackage, elementId, newUrl, MediaPackageElement.Type.Track, flavor); job.setStatus(Job.Status.FINISHED); // store startTime partialTrackStartTimes.put(elementId, startTime); logger.debug("Added start time {} for track {}", startTime, elementId); logger.info("Successful added partial track {} on mediapackage {} at URL {}", elementId, mediaPackage, newUrl); return mp; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (NotFoundException e) { throw new IngestException("Unable to update ingest job", e); } finally { finallyUpdateJob(job); } }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addCatalog(java.net.URI, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addCatalog(URI uri, MediaPackageElementFlavor flavor, MediaPackage mediaPackage) throws IOException, IngestException { Job job = null; try { job = serviceRegistry.createJob(JOB\_TYPE, INGEST\_CATALOG\_FROM\_URI, Arrays.asList(uri.toString(), flavor.toString(), MediaPackageParser.getAsXml(mediaPackage)), null, false, ingestFileJobLoad); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); String elementId = UUID.randomUUID().toString(); logger.info("Start adding catalog {} from URL {} on mediapackage {}", elementId, uri, mediaPackage); URI newUrl = addContentToRepo(mediaPackage, elementId, uri); if (MediaPackageElements.SERIES.equals(flavor)) { updateSeries(uri); } MediaPackage mp = addContentToMediaPackage(mediaPackage, elementId, newUrl, MediaPackageElement.Type.Catalog, flavor); job.setStatus(Job.Status.FINISHED); logger.info("Successful added catalog {} on mediapackage {} at URL {}", elementId, mediaPackage, newUrl); return mp; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (NotFoundException e) { throw new IngestException("Unable to update ingest job", e); } finally { finallyUpdateJob(job); } }
 /\*\* \* Updates the persistent representation of a series based on a potentially modified dublin core document. \* \* @param uri \* the URI to the dublin core document containing series metadata. \* @return \* true, if the series is created or overwritten, false if the existing series remains intact. \* @throws IOException if the series catalog was not found \* @throws IngestException if any other exception was encountered \*/ protected boolean updateSeries(URI uri) throws IOException, IngestException { HttpResponse response = null; InputStream in = null; boolean isUpdated = false; try { HttpGet getDc = new HttpGet(uri); response = httpClient.execute(getDc); in = response.getEntity().getContent(); DublinCoreCatalog dc = dublinCoreService.load(in); String id = dc.getFirst(DublinCore.PROPERTY\_IDENTIFIER); if (id == null) { logger.warn("Series dublin core document contains no identifier, rejecting ingested series cagtalog."); } else { try { try { seriesService.getSeries(id); if (isAllowModifySeries) { // Update existing series seriesService.updateSeries(dc); isUpdated = true; logger.debug("Ingest is overwriting the existing series {} with the ingested series", id); } else { logger.debug("Series {} already exists. Ignoring series catalog from ingest.", id); } } catch (NotFoundException e) { logger.info("Creating new series {} with default ACL", id); seriesService.updateSeries(dc); isUpdated = true; }
 } catch (Exception e) { throw new IngestException(e); } } in.close(); } catch (IOException e) { logger.error("Error updating series from DublinCoreCatalog: {}", e.getMessage()); } finally { IOUtils.closeQuietly(in); httpClient.close(response); } return isUpdated; }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addCatalog(java.io.InputStream, java.lang.String, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addCatalog(InputStream in, String fileName, MediaPackageElementFlavor flavor, MediaPackage mediaPackage) throws IOException, IngestException { return addCatalog(in, fileName, flavor, null, mediaPackage); }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addCatalog(java.io.InputStream, java.lang.String, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addCatalog(InputStream in, String fileName, MediaPackageElementFlavor flavor, String[] tags, MediaPackage mediaPackage) throws IOException, IngestException, IllegalArgumentException { Job job = null; try { job = serviceRegistry.createJob(JOB\_TYPE, INGEST\_CATALOG, null, null, false, ingestFileJobLoad); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); final String elementId = UUID.randomUUID().toString(); final String mediaPackageId = mediaPackage.getIdentifier().toString(); logger.info("Start adding catalog {} from input stream on mediapackage {}", elementId, mediaPackageId); final URI newUrl = addContentToRepo(mediaPackage, elementId, fileName, in);
 final boolean isJSON; try (InputStream inputStream = workingFileRepository.get(mediaPackageId, elementId)) { try (BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream, StandardCharsets.UTF\_8))) { // Exception for current BBB integration and Extron SMP351 which is ingesting a JSON array/object as catalog int firstChar = reader.read(); isJSON = firstChar == '[' || firstChar == '{'; } }
 if (isJSON) { logger.warn("Input catalog seems to be JSON. This is a mistake and will fail in future Opencast versions." + "You will likely want to ingest this as a media package attachment instead."); } else { // Verify XML is not corrupted try { XmlSafeParser.parse(workingFileRepository.get(mediaPackageId, elementId)); } catch (SAXException e) { workingFileRepository.delete(mediaPackageId, elementId); throw new IllegalArgumentException("Catalog XML is invalid", e); } }
 if (MediaPackageElements.SERIES.equals(flavor)) { updateSeries(newUrl); } MediaPackage mp = addContentToMediaPackage(mediaPackage, elementId, newUrl, MediaPackageElement.Type.Catalog, flavor); if (tags != null && tags.length > 0) { MediaPackageElement trackElement = mp.getCatalog(elementId); for (String tag : tags) { logger.info("Adding tag {} to element {}", tag, elementId); trackElement.addTag(tag); } }
 job.setStatus(Job.Status.FINISHED); logger.info("Successful added catalog {} on mediapackage {} at URL {}", elementId, mediaPackage, newUrl); return mp; } catch (ServiceRegistryException e) { throw new IngestException(e); } catch (NotFoundException e) { throw new IngestException("Unable to update ingest job", e); } finally { finallyUpdateJob(job); } }
 /\*\* \* {@inheritDoc} \* \* @see org.opencastproject.ingest.api.IngestService#addAttachment(java.net.URI, \* org.opencastproject.mediapackage.MediaPackageElementFlavor, org.opencastproject.mediapackage.MediaPackage) \*/ @Override public MediaPackage addAttachment(URI uri, MediaPackageElementFlavor flavor, MediaPackage mediaPackage) throws IOException, IngestException { Job job = null; try { job = serviceRegistry.createJob(JOB\_TYPE, INGEST\_ATTACHMENT\_FROM\_URI, Arrays.asList(uri.toString(), flavor.toString(), MediaPackageParser.getAsXml(mediaPackage)), null, false, ingestFileJobLoad); job.setStatus(Status.RUNNING); job = serviceRegistry.updateJob(job); String elementId = UUID.randomUUID().toString(); logger.info("Start adding attachment {} from URL {} on mediapackage {}", elementId, uri, mediaPackage);[View remainder of file in raw view](https://github.com/opencast/opencast/raw/69952463971cf578363e3b97d8edaf334ff51253/modules/ingest-service-impl/src/main/java/org/opencastproject/ingest/impl/IngestServiceImpl.java)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


