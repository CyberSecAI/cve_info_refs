=== Content from appcheck-ng.com_62f58cc2_20250115_084632.html ===

[Skip to content](#content)
[![](https://appcheck-ng.com/wp-content/uploads/2023/06/logo.png)](https://appcheck-ng.com)

* [Home](https://appcheck-ng.com/)
* Services
  + [Web Application Scanning](https://appcheck-ng.com/web-application-scanning/)
  + [Infrastructure Scanning](https://appcheck-ng.com/infrastructure-scanning/)
  + [API Security Scanning](https://appcheck-ng.com/api-security-scanning/)
  + [CMS Security Scanning](https://appcheck-ng.com/cms-security-scanning/)
  + [Single Page Application Scanning](https://appcheck-ng.com/single-page-application-security-scanning/)
* [Security Blog](https://appcheck-ng.com/security-blog/)
* [Case Studies](https://appcheck-ng.com/case-studies/)
* [Get Help](https://appcheck-ng.com/get-help/)
  + [Documentation](https://appcheck-ng.com/get-help/documentation/)
  + [Downloads](https://appcheck-ng.com/get-help/downloads/)
  + [Contact Support](https://appcheck-ng.com/contact-support/)
* [Become a partner](https://appcheck-ng.com/more/become-a-partner/)
* More
  + [About Us](https://appcheck-ng.com/about-us/)
    - [Our Story](/about-us/)
  + [Careers](https://appcheck-ng.com/more/careers/)
  + [Contact](https://appcheck-ng.com/contact/)
* [Start your free trial](#StartYourFreeTrial)

* [Home](https://appcheck-ng.com/)
* Services
  + [Web Application Scanning](https://appcheck-ng.com/web-application-scanning/)
  + [Infrastructure Scanning](https://appcheck-ng.com/infrastructure-scanning/)
  + [API Security Scanning](https://appcheck-ng.com/api-security-scanning/)
  + [CMS Security Scanning](https://appcheck-ng.com/cms-security-scanning/)
  + [Single Page Application Scanning](https://appcheck-ng.com/single-page-application-security-scanning/)
* [Security Blog](https://appcheck-ng.com/security-blog/)
* [Case Studies](https://appcheck-ng.com/case-studies/)
* [Get Help](https://appcheck-ng.com/get-help/)
  + [Documentation](https://appcheck-ng.com/get-help/documentation/)
  + [Downloads](https://appcheck-ng.com/get-help/downloads/)
  + [Contact Support](https://appcheck-ng.com/contact-support/)
* [Become a partner](https://appcheck-ng.com/more/become-a-partner/)
* More
  + [About Us](https://appcheck-ng.com/about-us/)
    - [Our Story](/about-us/)
  + [Careers](https://appcheck-ng.com/more/careers/)
  + [Contact](https://appcheck-ng.com/contact/)
* [Start your free trial](#StartYourFreeTrial)

* [Security Alerts](https://appcheck-ng.com/category/security-alerts/)

* October 25, 2021

# Security Advisory: Duplicate Post WordPress Plugin SQL Injection Vulnerability (CVE-2021-43408)

The AppCheck Research team identified a security flaw within the “Duplicate Post” WordPress plugin. The plugin has been downloaded 155,421 times at the time of writing. This blog post details the finding along with remediation advice.

The AppCheck Research team identified a security flaw within the “Duplicate Post” WordPress plugin. The plugin has been downloaded 155,421 times at the time of writing. This blog post details the finding along with remediation advice.

### Summary

The “Duplicate Post” WordPress plugin up to and including version 1.1.9 is vulnerable to SQL Injection.

SQL injection vulnerabilities occur when client supplied data is included within an SQL Query insecurely. SQL Injection can typically be exploited to read, modify and delete SQL table data. In many cases it also possible to exploit features of SQL server to execute system commands and/or access the local file system.

You can read more about SQL injection here; <https://appcheck-ng.com/an-introduction-to-sql-injection-sqli/>

This particular vulnerability can be exploited by any authenticated user who has been granted access to use the Duplicate Post plugin. By default, this is limited to Administrators, however the plugin presents the option to permit access to the Editor, Author, Contributor and Subscriber roles.

### Technical Analysis

The vulnerability occurs in the ***posthander.php*** file within the ***cdp\_insert\_post function*** (line 512 for version 1.1.9):

```
function cdp_insert_post($id, $data, $times, $areWePro, $isChild = false, $p_ids = null, $site) {

    // Get WordPress database
    global $wpdb;

    // Create empty array for new id(s) and error(s)
    $results = array('ids' => array(), 'error' => 0, 'counter' => 0);

    // Get Counter value
    $prefix = (($site != -1) ? $wpdb->get_blog_prefix($site) : $wpdb->get_blog_prefix());
    $newestId = $wpdb->get_results("SELECT post_id FROM {$prefix}postmeta WHERE meta_key = '_cdp_origin' AND meta_value = {$id} ORDER BY post_id DESC LIMIT 1", ARRAY_A); // <-- {$id} is controlled by the attacker

```

The “$id” parameter passed into the function is included within the SQL statement without proper sanitization. This call can be reached via the registered “**wp\_ajax\_cdp\_action\_handling**” WordPress Ajax callback.

Note that the “id” parameter is passed through the “cdp\_sanitize\_array” function, this applies the *sanitize\_text\_field* function recursively to each item within the array which effectively escapes any quote characters in the string. However, the vulnerable code places the tainted value within the SQL statement where an integer is expected, rather than within a quoted string. Therefore, to manipulate the SQL statement the attacker would only need to avoid using quote characters in the injected payload (e.g. using char() functions) but does not need them to perform the injection attack.

The following HTTP request can be used to recreate the vulnerability. In this example the MySQL “sleep” function is used to trigger a measurable time delay of 9 or more seconds. This value can then be changed to a higher or lower value to confirm execution of the injected SQL statement:

```
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: 192.168.88.176
Content-Length: 229
Accept: */*
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.88.176
Referer: http://192.168.88.176/wp-admin/edit.php
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: wordpress_3d2361ff3a8f0d..(truncated)
Connection: close

action=cdp_action_handling&token=cdp&f=copy_post&origin=tooltip&id%5B%5D=1%20and%20(select*from(select(sleep(9)))a)--%20&data%5Btype%5D=copy-quick&data%5Btimes%5D=1&data%5Bsite%5D=-1&data%5Bprofile%5D=default&data%5Bswap%5D=false

```
###

### Remediation

The vendor has released an updated version (1.2.0) to remediate the flaw. This can be downloaded from https://wordpress.org/plugins/copy-delete-posts/

###

### Timeline

**19/10/2021** – AppCheck reported the flaw to the vendor

**19/10/2021** – Updated released within the hour.

###

### Acknowlegements

AppCheck would like to thank [*Copy Delete Posts*](https://wordpress.org/plugins/copy-delete-posts/) for resolving this issue so quickly. An amazing turn around by any standard.

#### Get started with Appcheck

No software to download or install.

Contact us or call us 0113 887 8380

[Start your free trial](#elementor-action%3Aaction%3Dpopup%3Aopen%26settings%3DeyJpZCI6IjEzOTUiLCJ0b2dnbGUiOmZhbHNlfQ%3D%3D)

### Further Reading

* Research

* [June 28, 2023](https://appcheck-ng.com/2023/06/28/)

# [Deep Dive: Logging](https://appcheck-ng.com/deep-dive-logging/)

* Security Alerts

* [December 20, 2024](https://appcheck-ng.com/2024/12/20/)

# [Known Actively Exploited Vulnerabilities Round-up (13.12.24-19.12.24)](https://appcheck-ng.com/known-actively-exploited-vulnerabilities-round-up-13-12-24-19-12-24/)

* Security Alerts

* [December 13, 2024](https://appcheck-ng.com/2024/12/13/)

# [Known Actively Exploited Vulnerabilities Round-up (06.12.24-12.12.24)](https://appcheck-ng.com/known-actively-exploited-vulnerabilities-round-up-06-12-24-12-12-24/)

* Technical Updates

* [December 12, 2024](https://appcheck-ng.com/2024/12/12/)

# [Palo Alto Networks Monthly Security Round-up Nov-Dec 2024](https://appcheck-ng.com/palo-alto-networks-monthly-security-round-up-nov-dec-2024/)

* Security Alerts

* [December 11, 2024](https://appcheck-ng.com/2024/12/11/)

# [Microsoft Patch Tuesday – December 10th 2024](https://appcheck-ng.com/microsoft-patch-tuesday-december-10th-2024/)

* Security Alerts

* [December 6, 2024](https://appcheck-ng.com/2024/12/06/)

# [Known Actively Exploited Vulnerabilities Round-up (29.11.24-05.12.24)](https://appcheck-ng.com/known-actively-exploited-vulnerabilities-round-up-29-11-24-05-12-24/)

* Security Alerts

* [November 29, 2024](https://appcheck-ng.com/2024/11/29/)

# [Known Actively Exploited Vulnerabilities Round-up (22.11.24-28.11.24)](https://appcheck-ng.com/known-actively-exploited-vulnerabilities-round-up-22-11-24-28-11-24/)

![](https://appcheck-ng.com/wp-content/uploads/2024/02/Appcheck_logo_icon.svg)

## About Appcheck

AppCheck is a software security vendor based in the UK, offering a leading security scanning platform that automates the discovery of security flaws within organisations websites, applications, network and cloud infrastructure. AppCheck are authorized by te Common Vulnerabilities and Exposures (CVE) Program aas a CVE Numbering Authority (CNA)

## Put us to the test.Try AppCheck for free

No software to download or install.

Contact us or call us 0113 887 8380

Start your free trial

[![](https://appcheck-ng.com/wp-content/uploads/2023/06/logo.png)](https://appcheck-ng.com)

[![](https://appcheck-ng.com/wp-content/uploads/2023/06/iso_badge.jpg)](https://appcheck-ng.com/wp-content/uploads/2024/11/ISO-27001-_-2013-Certificate-1.pdf)

##### Services

* [Web App Scanning](https://appcheck-ng.com/web-application-scanning/)
* [Single Page App Scanning](https://appcheck-ng.com/single-page-application-security-scanning/)
* [CMS Security Scanning](https://appcheck-ng.com/cms-security-scanning/)
* [Infrastructure Scanning](https://appcheck-ng.com/infrastructure-scanning/)
* [API Security Scanning](https://appcheck-ng.com/api-security-scanning/)
* [DAST](https://appcheck-ng.com/dast/)
* [Vulnerability Scanning](https://appcheck-ng.com/vulnerability-scanner/)
* [External Vulnerability Scanner](https://appcheck-ng.com/external-vulnerability-scanning/)
* [Automated Penetration Testing](https://appcheck-ng.com/automated-penetration-testing/)

* [Web App Scanning](https://appcheck-ng.com/web-application-scanning/)
* [Single Page App Scanning](https://appcheck-ng.com/single-page-application-security-scanning/)
* [CMS Security Scanning](https://appcheck-ng.com/cms-security-scanning/)
* [Infrastructure Scanning](https://appcheck-ng.com/infrastructure-scanning/)
* [API Security Scanning](https://appcheck-ng.com/api-security-scanning/)
* [DAST](https://appcheck-ng.com/dast/)
* [Vulnerability Scanning](https://appcheck-ng.com/vulnerability-scanner/)
* [External Vulnerability Scanner](https://appcheck-ng.com/external-vulnerability-scanning/)
* [Automated Penetration Testing](https://appcheck-ng.com/automated-penetration-testing/)

##### Company

* [About Us](https://appcheck-ng.com/about-us/)
* [AppCheck Privacy Policy](https://appcheck-ng.com/privacy-policy/)
* [Cookie Policy](https://appcheck-ng.com/cookie-policy/)
* [Compliance Information](https://appcheck-ng.com/compliance/)
* [Existing Customer?](https://scanner.appcheck-ng.com/)

* [About Us](https://appcheck-ng.com/about-us/)
* [AppCheck Privacy Policy](https://appcheck-ng.com/privacy-policy/)
* [Cookie Policy](https://appcheck-ng.com/cookie-policy/)
* [Compliance Information](https://appcheck-ng.com/compliance/)
* [Existing Customer?](https://scanner.appcheck-ng.com/)

##### Resources

* [Brochure](https://appcheck-ng.com/wp-content/uploads/2023/10/AppCheck-Brochure.pdf)
* [AppCheck Benefits Overview](https://appcheck-ng.com/wp-content/uploads/2023/10/AppCheck-Benefits.pdf)
* [OWASP Top 10](/wp-content/uploads/2023/06/AppCheck_OWASP_Top10_2021.pdf)
* [Sample Report](/wp-content/uploads/2023/06/AppCheck_Sample_Report.pdf)
* [Start Your Trial](#StartYourFreeTrial)

* [Brochure](https://appcheck-ng.com/wp-content/uploads/2023/10/AppCheck-Brochure.pdf)
* [AppCheck Benefits Overview](https://appcheck-ng.com/wp-content/uploads/2023/10/AppCheck-Benefits.pdf)
* [OWASP Top 10](/wp-content/uploads/2023/06/AppCheck_OWASP_Top10_2021.pdf)
* [Sample Report](/wp-content/uploads/2023/06/AppCheck_Sample_Report.pdf)
* [Start Your Trial](#StartYourFreeTrial)

##### Keep in touch

email

 I agree to receive information and commercial offers about AppCheck Ltd.
 Submit

AppCheck Ltd. is a company registered in England and Wales with company number 06888174

## Start your free trial

Simply complete the form and we’ll send you all you need to activate AppCheck and undertake your FREE scan.

**Your details**
Full Name

Company Name

Work Email

Telephone

Where did you hear about AppCheck?

**IP Addresses**
Please enter your IP address ranges

**URLs**
Please enter full URLs for your web applications, and both http and https where appropriate

 I have read and agreed to our [Privacy Policy](/privacy-policy/)
 I agree to receive information and commercial offers about AppCheck Ltd.

Submit

# Get in touch



=== Content from plugins.trac.wordpress.org_87d6b6ff_20250115_084657.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcopy-delete-posts%2Ftags%2F1.2.0%2Fpost%2Fhandler.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/copy-delete-posts/tags/1.2.0/post/handler.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/copy-delete-posts/tags/1.2.0/post/handler.php)

---

# [source:](/browser?order=name "Go to repository root") [copy-delete-posts](/browser/copy-delete-posts?order=name "View copy-delete-posts")/[tags](/browser/copy-delete-posts/tags?order=name "View tags")/[1.2.0](/browser/copy-delete-posts/tags/1.2.0?order=name "View 1.2.0")/[post](/browser/copy-delete-posts/tags/1.2.0/post?order=name "View post")/[handler.php](/browser/copy-delete-posts/tags/1.2.0/post/handler.php?order=name "View handler.php")

View diff against:

View revision:

| [Last change](/changeset/2619826/copy-delete-posts/tags/1.2.0/post/handler.php "View differences") on this file was [2619826](/changeset/2619826/ "View changeset 2619826"), checked in by iclyde, [3 years ago](/timeline?from=2021-10-26T04%3A40%3A05Z&precision=second "See timeline at 10/26/2021 04:40:05 AM") |
| --- |
| Version 1.2.1 |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 45.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Copy & Delete Posts – Post requests handler file. |
| [5](#L5) | \* |
| [6](#L6) | \* @package CDP |
| [7](#L7) | \* @subpackage PostHandler |
| [8](#L8) | \* @author CopyDeletePosts |
| [9](#L9) | \* @since 1.0.0 |
| [10](#L10) | \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \*/ |
| [11](#L11) | /\*\* –– \*\*\ |
| [12](#L12) | \* Main handler + It will also sanitize and verify that request a little bit. |
| [13](#L13) | \* @since 1.0.0 |
| [14](#L14) | \*/ |
| [15](#L15) | add\_action('wp\_ajax\_cdp\_action\_handling', function () { |
| [16](#L16) | if (isset($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) === 'xmlhttprequest') { |
| [17](#L17) | if (isset($\_POST['token']) && $\_POST['token'] == 'cdp' && isset($\_POST['f']) && is\_admin()) { |
| [18](#L18) |  |
| [19](#L19) | // Expand execution time |
| [20](#L20) | if (intval(ini\_get('max\_execution\_time')) < 7200) |
| [21](#L21) | set\_time\_limit(0); |
| [22](#L22) |  |
| [23](#L23) | // Get WP-Plugin path |
| [24](#L24) | $premium\_plugin = 'copy-delete-posts-premium/copy-delete-posts-premium.php'; |
| [25](#L25) | $premium\_dir = WP\_PLUGIN\_DIR . '/' . 'copy-delete-posts-premium'; |
| [26](#L26) | $pplugin\_path = $premium\_dir . '/handler/premium.php'; |
| [27](#L27) |  |
| [28](#L28) | // Load premium content if the plugin is here |
| [29](#L29) | if (is\_dir($premium\_dir) && is\_plugin\_active($premium\_plugin)) |
| [30](#L30) | require\_once($pplugin\_path); |
| [31](#L31) |  |
| [32](#L32) | // Is premium function |
| [33](#L33) | $areWePro = is\_plugin\_active($premium\_plugin); |
| [34](#L34) |  |
| [35](#L35) | // Get user roles and check if the role is permmited to use plugin |
| [36](#L36) | $access = false; |
| [37](#L37) | $current\_user = wp\_get\_current\_user(); |
| [38](#L38) | $access\_roles = get\_option('\_cdp\_globals'); |
| [39](#L39) | if (!isset($access\_roles['roles'])) |
| [40](#L40) | $access\_roles = array(); |
| [41](#L41) | foreach ($current\_user->roles as $role => $name) |
| [42](#L42) | if ($name == 'administrator' || (isset($access\_roles['roles'][$name]) && $access\_roles['roles'][$name] == 'true')) { |
| [43](#L43) | $access = true; |
| [44](#L44) | break; |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | // Check user permission |
| [48](#L48) | if ($access === true) { |
| [49](#L49) |  |
| [50](#L50) | // Pointers |
| [51](#L51) | if ($\_POST['f'] == 'no\_intro') |
| [52](#L52) | cdp\_add\_new\_no\_intro(); |
| [53](#L53) | else if ($\_POST['f'] == 'intro\_again') |
| [54](#L54) | cdp\_add\_new\_intro(); |
| [55](#L55) | else if ($\_POST['f'] == 'save\_options') |
| [56](#L56) | cdp\_save\_plugin\_options($areWePro); |
| [57](#L57) | else if ($\_POST['f'] == 'copy\_post') |
| [58](#L58) | cdp\_insert\_new\_post($areWePro); |
| [59](#L59) | else if ($\_POST['f'] == 'get\_settings') |
| [60](#L60) | cdp\_get\_profile(); |
| [61](#L61) | else if ($\_POST['f'] == 'get\_all\_settings') |
| [62](#L62) | cdp\_get\_all\_profiles(); |
| [63](#L63) | else if ($\_POST['f'] == 'save\_profiles' && $areWePro) |
| [64](#L64) | cdp\_save\_profile\_set(); |
| [65](#L65) | else if ($\_POST['f'] == 'get\_all\_posts') |
| [66](#L66) | cdp\_get\_all\_posts(); |
| [67](#L67) | else if ($\_POST['f'] == 'delete\_them') |
| [68](#L68) | cdp\_delete\_posts(); |
| [69](#L69) | else if ($\_POST['f'] == 'get\_formatted\_time' && $areWePro) |
| [70](#L70) | cdp\_formatted\_time(); |
| [71](#L71) | else if ($\_POST['f'] == 'set\_default\_profile') |
| [72](#L72) | cdp\_set\_default\_profile(); |
| [73](#L73) | else if ($\_POST['f'] == 'get\_default\_profile') |
| [74](#L74) | cdp\_get\_default\_profile(); |
| [75](#L75) | else if ($\_POST['f'] == 'clear\_crons') |
| [76](#L76) | cdp\_clear\_all\_crons(); |
| [77](#L77) | else if ($\_POST['f'] == 'i\_saw\_this\_noti') |
| [78](#L78) | cdp\_set\_noti\_as\_seen(); |
| [79](#L79) | else if ($\_POST['f'] == 'try\_to\_hide\_the\_tasks') |
| [80](#L80) | cdp\_just\_hide\_task(); |
| [81](#L81) | else if ($\_POST['f'] == 'try\_to\_kill\_the\_tasks') |
| [82](#L82) | cdp\_just\_kill\_task(); |
| [83](#L83) | else if ($\_POST['f'] == 'give\_me\_current\_tasks') |
| [84](#L84) | cdp\_just\_get\_tasks(); |
| [85](#L85) | else if ($\_POST['f'] == 'hide\_cron\_notice') |
| [86](#L86) | cdp\_hide\_perf\_notice(); |
| [87](#L87) | else if ($\_POST['f'] == 'review\_dismiss') |
| [88](#L88) | cdp\_review(); |
| [89](#L89) | else if ($\_POST['f'] == 'debug\_function') |
| [90](#L90) | cdp\_debug\_function(); |
| [91](#L91) | else if ($\_POST['f'] == 'delete\_success\_img') |
| [92](#L92) | delete\_option('\_cdp\_show\_copy'); |
| [93](#L93) | else if ($\_POST['f'] == 'save\_redi\_state' && $areWePro) |
| [94](#L94) | cdpp\_save\_redi\_state(); |
| [95](#L95) | else if ($\_POST['f'] == 'multi\_redi\_importer' && $areWePro) |
| [96](#L96) | cdpp\_redis\_importer(); |
| [97](#L97) | else if ($\_POST['f'] == 'save\_redirections' && $areWePro) |
| [98](#L98) | cdpp\_save\_redirections(); |
| [99](#L99) | else if ($\_POST['f'] == 'delete\_redirect' && $areWePro) |
| [100](#L100) | cdpp\_delete\_redirection(); |
| [101](#L101) | else if ($\_POST['f'] == 'switch\_redirects' && $areWePro) |
| [102](#L102) | cdpp\_switch\_redirects(); |
| [103](#L103) | else if ($\_POST['f'] == 'get\_authors' && $areWePro) |
| [104](#L104) | cdpp\_get\_authors(); |
| [105](#L105) | else if ($\_POST['f'] == 'get\_curr\_time' && $areWePro) |
| [106](#L106) | cdpp\_get\_curr\_s\_time(); |
| [107](#L107) | else if ($\_POST['f'] == 'get\_post\_export' && $areWePro) |
| [108](#L108) | cdpp\_get\_for\_export(); |
| [109](#L109) | else if ($\_POST['f'] == 'import\_posts' && $areWePro) |
| [110](#L110) | cdpp\_take\_for\_import(); |
| [111](#L111) | else if ($\_POST['f'] == 'save\_aci' && $areWePro) |
| [112](#L112) | cdpp\_save\_cleanup\_settings(); |
| [113](#L113) | else if ($\_POST['f'] == 'get\_aci' && $areWePro) |
| [114](#L114) | cdpp\_get\_cleanup\_settings(); |
| [115](#L115) | else if ($\_POST['f'] == 'turn\_off\_aci' && $areWePro) |
| [116](#L116) | cdpp\_turn\_the\_acii\_off(); |
| [117](#L117) | else if ($\_POST['f'] == 'i\_love\_squirrels' && $areWePro) |
| [118](#L118) | cdpp\_squirrel(); |
| [119](#L119) | else |
| [120](#L120) | echo 'error'; |
| [121](#L121) | } else |
| [122](#L122) | echo 'error'; |
| [123](#L123) | } else |
| [124](#L124) | echo 'no\_access'; |
| [125](#L125) | } else |
| [126](#L126) | echo 'no\_access'; |
| [127](#L127) |  |
| [128](#L128) | wp\_die(); |
| [129](#L129) | }); |
| [130](#L130) | /\*\* –– \* \*/ |
| [131](#L131) |  |
| [132](#L132) | /\*\* –– \*\*\ |
| [133](#L133) | \* This function will be fired when user don't want to see intro – never again. |
| [134](#L134) | \* @since 1.0.6 |
| [135](#L135) | \*/ |
| [136](#L136) | function cdp\_review() { |
| [137](#L137) |  |
| [138](#L138) | // Option |
| [139](#L139) | $method = sanitize\_text\_field($\_POST['decision']); |
| [140](#L140) |  |
| [141](#L141) | // Get user id and array from db |
| [142](#L142) | $user\_id = get\_current\_user\_id(); |
| [143](#L143) | $already = get\_option('\_cdp\_review', false); |
| [144](#L144) |  |
| [145](#L145) | // Create if not exists |
| [146](#L146) | if ($already == false) |
| [147](#L147) | $already = array('installed' => time(), 'users' => array()); |
| [148](#L148) |  |
| [149](#L149) | // Set dismiss |
| [150](#L150) | $already['users'][$user\_id] = array(); |
| [151](#L151) | $already['users'][$user\_id]['dismiss'] = (($method == 'remind') ? time() : true); |
| [152](#L152) |  |
| [153](#L153) | // Add option to datbase if not exit. |
| [154](#L154) | $opt = update\_option('\_cdp\_review', $already); |
| [155](#L155) |  |
| [156](#L156) | // Return success |
| [157](#L157) | echo json\_encode(array('status' => 'success')); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | /\*\* –– \* \*/ |
| [161](#L161) |  |
| [162](#L162) | /\*\* –– \*\*\ |
| [163](#L163) | \* This function will be fired when user don't want to see intro – never again. |
| [164](#L164) | \* @since 1.0.0 |
| [165](#L165) | \*/ |
| [166](#L166) | function cdp\_add\_new\_no\_intro() { |
| [167](#L167) |  |
| [168](#L168) | // Get user id and array from db |
| [169](#L169) | $user\_id = get\_current\_user\_id(); |
| [170](#L170) | $already = get\_option('\_cdp\_no\_intro'); |
| [171](#L171) |  |
| [172](#L172) | // Check if it's first time that user checked this option. |
| [173](#L173) | if (!$already) |
| [174](#L174) | $already = array($user\_id); |
| [175](#L175) |  |
| [176](#L176) | // If it already exists just add another user. |
| [177](#L177) | else if (!in\_array($user\_id, $already)) |
| [178](#L178) | array\_push($already, $user\_id); |
| [179](#L179) |  |
| [180](#L180) | // If the user already exists exit. |
| [181](#L181) | else |
| [182](#L182) | exit; |
| [183](#L183) |  |
| [184](#L184) | // Add option to datbase if not exit. |
| [185](#L185) | $opt = update\_option('\_cdp\_no\_intro', $already); |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | /\*\* –– \* \*/ |
| [189](#L189) |  |
| [190](#L190) | /\*\* –– \*\*\ |
| [191](#L191) | \* This function will be fired when user want to see intro – again. |
| [192](#L192) | \* @since 1.0.0 |
| [193](#L193) | \*/ |
| [194](#L194) | function cdp\_add\_new\_intro() { |
| [195](#L195) |  |
| [196](#L196) | // Get user id and array from db |
| [197](#L197) | $user\_id = get\_current\_user\_id(); |
| [198](#L198) | $already = get\_option('\_cdp\_no\_intro'); |
| [199](#L199) |  |
| [200](#L200) | // Check if it's first time that user checked this option. |
| [201](#L201) | if ($already && in\_array($user\_id, $already)) |
| [202](#L202) | unset($already[array\_search($user\_id, $already, true)]); |
| [203](#L203) |  |
| [204](#L204) | // If the user no exists exit. |
| [205](#L205) | else |
| [206](#L206) | exit; |
| [207](#L207) |  |
| [208](#L208) | // Add option to database if not exit. |
| [209](#L209) | $opt = update\_option('\_cdp\_no\_intro', $already); |
| [210](#L210) | } |
| [211](#L211) |  |
| [212](#L212) | /\*\* –– \* \*/ |
| [213](#L213) |  |
| [214](#L214) | /\*\* –– \*\*\ |
| [215](#L215) | \* This function will be fired when user want to save plugin options – again. |
| [216](#L216) | \* @since 1.0.0 |
| [217](#L217) | \*/ |
| [218](#L218) | function cdp\_save\_plugin\_options($areWePro) { |
| [219](#L219) |  |
| [220](#L220) | // Get the info about our professionalness |
| [221](#L221) | $areWePro = $areWePro; |
| [222](#L222) |  |
| [223](#L223) | // Get new options and current profile. |
| [224](#L224) | $options = ((isset($\_POST['options'])) ? cdp\_sanitize\_array($\_POST['options']) : false); |
| [225](#L225) | $entire = ((isset($\_POST['entire'])) ? cdp\_sanitize\_array($\_POST['entire']) : false); |
| [226](#L226) | $profile = ((isset($\_POST['profile'])) ? sanitize\_text\_field($\_POST['profile']) : false); |
| [227](#L227) |  |
| [228](#L228) | // Get current options and profiles. |
| [229](#L229) | $a\_or = get\_option('\_cdp\_profiles'); |
| [230](#L230) | $already = get\_option('\_cdp\_profiles'); |
| [231](#L231) | $g\_or = get\_option('\_cdp\_globals'); |
| [232](#L232) | $globals = get\_option('\_cdp\_globals'); |
| [233](#L233) |  |
| [234](#L234) | // Check if it's first time – create array. |
| [235](#L235) | if (!is\_array($already)) |
| [236](#L236) | $already = array(); |
| [237](#L237) | if (!is\_array($globals)) |
| [238](#L238) | $globals = array(); |
| [239](#L239) |  |
| [240](#L240) | // Add display name for this profile |
| [241](#L241) | $profile = preg\_replace('/\s+/', '\_', trim(strtolower($profile))); |
| [242](#L242) |  |
| [243](#L243) | // Write new settings for this profile. |
| [244](#L244) | $already[$profile] = $options; |
| [245](#L245) | $already[$profile]['usmplugin'] = 'false'; |
| [246](#L246) | $already[$profile]['yoast'] = 'false'; |
| [247](#L247) | $already[$profile]['woo'] = 'false'; |
| [248](#L248) | if ($areWePro) |
| [249](#L249) | $already[$profile] = cdpp\_filter\_premium\_opts($already, $options, $profile); |
| [250](#L250) |  |
| [251](#L251) | if (!isset($already[$profile]['names']['display']) || (strlen(trim($already[$profile]['names']['display'])) <= 0)) |
| [252](#L252) | $already[$profile]['names']['display'] = $profile; |
| [253](#L253) | $globals = $entire; |
| [254](#L254) |  |
| [255](#L255) | // Check if there is default profile |
| [256](#L256) | if (!array\_key\_exists('default', $already) || !array\_key\_exists('title', $already['default'])) { |
| [257](#L257) | $already['default'] = array(); |
| [258](#L258) |  |
| [259](#L259) | if (function\_exists('cdp\_default\_options')) |
| [260](#L260) | $already['default'] = cdp\_default\_options(); |
| [261](#L261) | if (function\_exists('cdp\_default\_global\_options')) |
| [262](#L262) | $globals['others'] = cdp\_default\_global\_options(); |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | // Add new options to database. |
| [266](#L266) | $s1 = update\_option('\_cdp\_globals', $globals); |
| [267](#L267) | $s2 = update\_option('\_cdp\_profiles', $already); |
| [268](#L268) |  |
| [269](#L269) | // Check if success while uploading |
| [270](#L270) | if (($s1 || $s2) || ($globals == $g\_or) || ($already == $a\_or)) |
| [271](#L271) | echo 'success'; |
| [272](#L272) | else |
| [273](#L273) | echo 'error'; |
| [274](#L274) | } |
| [275](#L275) |  |
| [276](#L276) | /\*\* –– \* \*/ |
| [277](#L277) |  |
| [278](#L278) | /\*\* –– \*\*\ |
| [279](#L279) | \* This function will be fired when user want to save plugin options – again. |
| [280](#L280) | \* @since 1.0.0 |
| [281](#L281) | \*/ |
| [282](#L282) | function cdp\_insert\_new\_post($areWePro = false) { |
| [283](#L283) |  |
| [284](#L284) | // Performance copy time start |
| [285](#L285) | $timein = microtime(true); |
| [286](#L286) |  |
| [287](#L287) | // Create output array which will be returned to requester |
| [288](#L288) | $output = array('status' => 'success'); |
| [289](#L289) |  |
| [290](#L290) | // Get ID(s) of post(s) |
| [291](#L291) | $ids = ((isset($\_POST['id'])) ? cdp\_sanitize\_array($\_POST['id']) : false); |
| [292](#L292) |  |
| [293](#L293) | // Get all important pieces of information from requester |
| [294](#L294) | $data = ((isset($\_POST['data'])) ? cdp\_sanitize\_array($\_POST['data']) : false); |
| [295](#L295) | $site = isset($\_POST['data']['site']) ? sanitize\_text\_field($\_POST['data']['site']) : false; |
| [296](#L296) | $times = isset($\_POST['data']['times']) ? sanitize\_text\_field($\_POST['data']['times']) : 1; |
| [297](#L297) | $swap = isset($\_POST['data']['swap']) ? sanitize\_text\_field($\_POST['data']['swap']) : false; |
| [298](#L298) | $profile = isset($\_POST['data']['profile']) ? sanitize\_text\_field($\_POST['data']['profile']) : 'default'; |
| [299](#L299) | $origin = isset($\_POST['origin']) ? sanitize\_text\_field($\_POST['origin']) : false; |
| [300](#L300) | $custom = isset($\_POST['data']['custom']) ? cdp\_sanitize\_array($\_POST['data']['custom']) : false; |
| [301](#L301) |  |
| [302](#L302) | // Load default options for selected profile |
| [303](#L303) | $defaults = get\_option('\_cdp\_profiles')[$profile]; |
| [304](#L304) |  |
| [305](#L305) | // Settings for this copy |
| [306](#L306) | $settings = (($data['type'] != 'copy-quick' && $custom != false) ? $custom : $defaults); |
| [307](#L307) | if (!isset($settings['names'])) |
| [308](#L308) | $settings['names'] = $defaults['names']; |
| [309](#L309) |  |
| [310](#L310) | // Convert string to boolean – only for much less code later |
| [311](#L311) | foreach ($settings as $setting => $val) |
| [312](#L312) | if ($setting != 'names') |
| [313](#L313) | $settings[$setting] = (($val == 'true') ? true : false); |
| [314](#L314) |  |
| [315](#L315) | /\*\* |
| [316](#L316) | \* This local function filters post data by user settings |
| [317](#L317) | \* @param $post (array of wordpress post/page data) |
| [318](#L318) | \* @param $settings (array of preselected settings of profile or by user) |
| [319](#L319) | \* @return array with insert ready values for wordpress post || false on wrong $post |
| [320](#L320) | \*/ |
| [321](#L321) | function cdp\_filter\_post($post, $swap, $opt, $settings, $taxonomies = false, $areWePro) { |
| [322](#L322) |  |
| [323](#L323) | // If $post has wrong format return false |
| [324](#L324) | if (!(is\_array($post) || is\_object($post))) |
| [325](#L325) | return false; |
| [326](#L326) |  |
| [327](#L327) | // Array for formatted and prepared taxonomy |
| [328](#L328) | $ft = array(); |
| [329](#L329) | $buin = array('link\_category', 'nav\_menu', 'post\_tag', 'category', 'post\_format'); |
| [330](#L330) |  |
| [331](#L331) | // Loop thorugh all taxonomies from post |
| [332](#L332) | foreach ($taxonomies as $taxonomy) { |
| [333](#L333) |  |
| [334](#L334) | // Set the name to shorted variable |
| [335](#L335) | $tn = $taxonomy->taxonomy; |
| [336](#L336) |  |
| [337](#L337) | // Check if it's private taxonomy and if it's set in options |
| [338](#L338) | if ($tn == 'link\_category' && !$settings['link\_category']) |
| [339](#L339) | continue; |
| [340](#L340) | if ($tn == 'nav\_menu' && !$settings['nav\_menu']) |
| [341](#L341) | continue; |
| [342](#L342) | if ($tn == 'post\_tag' && !$settings['post\_tag']) |
| [343](#L343) | continue; |
| [344](#L344) | if ($tn == 'category' && !$settings['category']) |
| [345](#L345) | continue; |
| [346](#L346) | if ($tn == 'post\_format' && !$settings['format']) |
| [347](#L347) | continue; |
| [348](#L348) |  |
| [349](#L349) | // Don't copy custom taxonomy if it's not checked |
| [350](#L350) | if (!in\_array($tn, $buin) && !$settings['taxonomy']) |
| [351](#L351) | continue; |
| [352](#L352) |  |
| [353](#L353) | // Push next term of existing taxonomy |
| [354](#L354) | if (isset($ft[$tn])) |
| [355](#L355) | array\_push($ft[$tn], $taxonomy->term\_id); |
| [356](#L356) |  |
| [357](#L357) | // Create new taxonomy and push new term |
| [358](#L358) | else { |
| [359](#L359) | $ft[$tn] = array(); |
| [360](#L360) | array\_push($ft[$tn], $taxonomy->term\_id); |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | // Create array with required values and contant values |
| [365](#L365) | $new = array( |
| [366](#L366) | 'post\_title' => ($settings['title'] ? cdp\_create\_title($post['post\_title'], $settings['names'], $post['ID'], $areWePro) : \_\_('Untitled Copy', 'copy-delete-posts')), |
| [367](#L367) | 'post\_date' => ($settings['date'] ? $post['post\_date'] : current\_time('mysql')), |
| [368](#L368) | 'post\_status' => ($settings['status'] ? $post['post\_status'] : 'draft'), |
| [369](#L369) | 'post\_author' => ($settings['author'] ? $post['post\_author'] : wp\_get\_current\_user()->ID), |
| [370](#L370) | 'post\_content' => ($settings['content']) ? $post['post\_content'] : ' ', |
| [371](#L371) | 'comment\_status' => $post['comment\_status'], // that's additional element which cannot be edited by user |
| [372](#L372) | 'post\_parent' => $post['post\_parent'] // that's additional element which cannot be edited by user |
| [373](#L373) | ); |
| [374](#L374) |  |
| [375](#L375) | // Converter |
| [376](#L376) | if ((($opt == '2' && $swap == 'true') || $swap == 'true') && $areWePro && function\_exists('cdpp\_post\_converter')) |
| [377](#L377) | $new['post\_type'] = cdpp\_post\_converter($post['post\_type']); |
| [378](#L378) | else |
| [379](#L379) | $new['post\_type'] = $post['post\_type']; |
| [380](#L380) |  |
| [381](#L381) | // Add optional values of post – depending on settings |
| [382](#L382) | if ($settings['slug']) |
| [383](#L383) | $new['post\_name'] = $post['post\_name']; |
| [384](#L384) | if ($settings['excerpt']) |
| [385](#L385) | $new['post\_excerpt'] = $post['post\_excerpt']; |
| [386](#L386) | if ($settings['template']) |
| [387](#L387) | $new['page\_template'] = $post['page\_template']; |
| [388](#L388) | if ($settings['password']) |
| [389](#L389) | $new['post\_password'] = $post['post\_password']; |
| [390](#L390) | if ($settings['menu\_order']) |
| [391](#L391) | $new['menu\_order'] = $post['menu\_order']; |
| [392](#L392) | if ($settings['category']) |
| [393](#L393) | $new['post\_category'] = $post['post\_category']; |
| [394](#L394) | if ($settings['post\_tag']) |
| [395](#L395) | $new['tags\_input'] = $post['tags\_input']; |
| [396](#L396) | if ($taxonomies != false) |
| [397](#L397) | $new['tax\_input'] = $ft; |
| [398](#L398) |  |
| [399](#L399) | // Return filtered data of current post |
| [400](#L400) | return $new; |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | /\*\* |
| [404](#L404) | \* This local function filters post data by user settings |
| [405](#L405) | \* @param $metas (array of wordpress post/page meta data) |
| [406](#L406) | \* @param $settings (array of preselected settings of profile or by user) |
| [407](#L407) | \* @return array with metadata values for post || false on wrong $metas |
| [408](#L408) | \*/ |
| [409](#L409) | function cdp\_filter\_meta($metas, $settings, $id, $areWePro, $site, $title) { |
| [410](#L410) |  |
| [411](#L411) | // If $metas has wrong format return false |
| [412](#L412) | if (!(is\_array($metas) || is\_object($metas))) |
| [413](#L413) | return false; |
| [414](#L414) |  |
| [415](#L415) | // Create empty array for filtered meta data |
| [416](#L416) | $prepared = array( |
| [417](#L417) | // Add or replace ours copy tracker |
| [418](#L418) | array('\_cdp\_origin' => $id), |
| [419](#L419) | array('\_cdp\_origin\_site' => $site), |
| [420](#L420) | array('\_cdp\_origin\_title' => $title), |
| [421](#L421) | array('\_cdp\_counter' => '0') |
| [422](#L422) | ); |
| [423](#L423) |  |
| [424](#L424) | // Iterate through every meta index |
| [425](#L425) | foreach ($metas as $meta => $vals) { |
| [426](#L426) |  |
| [427](#L427) | // Conditions |
| [428](#L428) | $a = ($areWePro && function\_exists('cdpp\_check\_yoast')) ? cdpp\_check\_yoast($settings, $meta) : false; |
| [429](#L429) | $b = ($areWePro && function\_exists('cdpp\_check\_usm')) ? cdpp\_check\_usm($settings, $meta) : false; |
| [430](#L430) | $c = ($areWePro && function\_exists('cdpp\_check\_woo')) ? cdpp\_check\_woo($settings, $meta, $id) : false; |
| [431](#L431) | $d = ($settings['f\_image'] && $meta == '\_thumbnail\_id') ? true : false; |
| [432](#L432) | $e = (mb\_substr($meta, 0, 4) == '\_wp\_') ? true : false; |
| [433](#L433) | $f = ($meta == '\_thumbnail\_id' && $settings['f\_image']) ? true : false; |
| [434](#L434) | $g = ($meta == '\_cdp\_origin') ? true : false; |
| [435](#L435) | $h = (mb\_substr($meta, 0, 11) == '\_elementor\_') ? true : false; |
| [436](#L436) | // $i = (isset($settings['all\_metadata']) && $settings['all\_metadata'] == 'true') ? true : false; |
| [437](#L437) |  |
| [438](#L438) | // If any of above condition is true pass the meta tag |
| [439](#L439) | if ($a || $b || $c || $d || $e || $f || $g || $h /\*|| $i\*/) { |
| [440](#L440) |  |
| [441](#L441) | // Prepare data and insert filtered to results |
| [442](#L442) | foreach ($vals as $val) |
| [443](#L443) | array\_push($prepared, array($meta => $val)); |
| [444](#L444) |  |
| [445](#L445) | } else { |
| [446](#L446) |  |
| [447](#L447) | // error\_log(print\_r($vals, true)); |
| [448](#L448) |  |
| [449](#L449) | } |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) | // Return results |
| [453](#L453) | return $prepared; |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* This local function format title by user settings |
| [458](#L458) | \* @param $title (string) |
| [459](#L459) | \* @param $settings (array of name settings preselected in profile) |
| [460](#L460) | \* @return string formated title |
| [461](#L461) | \*/ |
| [462](#L462) | function cdp\_create\_title($title, $settings, $id, $areWePro) { |
| [463](#L463) |  |
| [464](#L464) | // Date formats |
| [465](#L465) | $date\_format = intval($settings['format']); |
| [466](#L466) |  |
| [467](#L467) | // Get right format |
| [468](#L468) | if ($date\_format == 1) |
| [469](#L469) | $date\_format = 'm/d/Y'; |
| [470](#L470) | else if ($date\_format == 2) |
| [471](#L471) | $date\_format = 'd/m/Y'; |
| [472](#L472) | else { |
| [473](#L473) | if ($areWePro && function\_exists('cdpp\_custom\_date')) |
| [474](#L474) | $date\_format = cdpp\_custom\_date($settings); |
| [475](#L475) | else |
| [476](#L476) | $date\_format = 'd/m/Y'; |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | // Create date and time replacements |
| [480](#L480) | $curr = current\_time('timestamp', true); |
| [481](#L481) | $date = date($date\_format, $curr); |
| [482](#L482) | $time = date('H:i:s', $curr); |
| [483](#L483) |  |
| [484](#L484) | // Concat whole title with prefix and suffix |
| [485](#L485) | $new\_title = $settings['prefix'] . ' ' . $title . ' ' . $settings['suffix']; |
| [486](#L486) |  |
| [487](#L487) | // Make replace of placeholders |
| [488](#L488) | $new\_title = str\_replace('[CurrentDate]', $date, $new\_title); |
| [489](#L489) | $new\_title = str\_replace('[CurrentTime]', $time, $new\_title); |
| [490](#L490) |  |
| [491](#L491) | // Return formatted title |
| [492](#L492) | return $new\_title; |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* This local function inserts whole post into database |
| [497](#L497) | \* @param $data (array prepared by cdp\_filter\_post function) |
| [498](#L498) | \* @param $times (int how many times should this function copy post) |
| [499](#L499) | \* @return array of new inserted post(s) and error status |
| [500](#L500) | \* Structure of return array: { ids: [$ids], error: (count of errors) } |
| [501](#L501) | \*/ |
| [502](#L502) | function cdp\_insert\_post($id, $data, $times, $areWePro, $isChild = false, $p\_ids = null, $site) { |
| [503](#L503) |  |
| [504](#L504) | // Get Wordpress database |
| [505](#L505) | global $wpdb; |
| [506](#L506) |  |
| [507](#L507) | // Create empty array for new id(s) and error(s) |
| [508](#L508) | $results = array('ids' => array(), 'error' => 0, 'counter' => 0); |
| [509](#L509) |  |
| [510](#L510) | // Prevent SQL injection |
| [511](#L511) | if (!is\_numeric($id)) { |
| [512](#L512) |  |
| [513](#L513) | echo json\_encode(array('status' => 'error', 'message' => \_\_('Invalid ID argument.', 'copy-delete-posts'))); |
| [514](#L514) | exit; |
| [515](#L515) |  |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | // And just in case |
| [519](#L519) | $id = esc\_sql(intval($id)); |
| [520](#L520) |  |
| [521](#L521) | // Get Counter value |
| [522](#L522) | $prefix = (($site != -1) ? $wpdb->get\_blog\_prefix($site) : $wpdb->get\_blog\_prefix()); |
| [523](#L523) | $newestId = $wpdb->get\_results("SELECT post\_id FROM {$prefix}postmeta WHERE meta\_key = '\_cdp\_origin' AND meta\_value = {$id} ORDER BY post\_id DESC LIMIT 1", ARRAY\_A); |
| [524](#L524) | $newestId = ((array\_key\_exists(0, $newestId)) ? (intval($newestId[0]['post\_id'])) : false); |
| [525](#L525) | if (isset($newestId) && $newestId != false && $newestId > 0) |
| [526](#L526) | $counter = $wpdb->get\_results("SELECT meta\_value AS 'Counter' FROM {$prefix}postmeta WHERE meta\_key = '\_cdp\_counter' AND post\_id = {$newestId} ORDER BY post\_id DESC", ARRAY\_A)[0]['Counter']; |
| [527](#L527) | else |
| [528](#L528) | $counter = 1; |
| [529](#L529) |  |
| [530](#L530) | $base\_title = $data['post\_title']; |
| [531](#L531) | $counter = intval($counter) + 1; |
| [532](#L532) |  |
| [533](#L533) | // Handle multisite for premium |
| [534](#L534) | if ($areWePro && function\_exists('cdpp\_handle\_multisite')) |
| [535](#L535) | cdpp\_handle\_multisite($site); |
| [536](#L536) |  |
| [537](#L537) | // Loop for each post iteration |
| [538](#L538) | for ($i = 0; $i < $times; ++$i) { |
| [539](#L539) |  |
| [540](#L540) | // Change parent if it's child |
| [541](#L541) | if ($isChild) |
| [542](#L542) | $data['post\_parent'] = $p\_ids['posts'][$i]; |
| [543](#L543) |  |
| [544](#L544) | // Replace title with Counter if multiple copies |
| [545](#L545) | $data['post\_title'] = str\_replace('[Counter]', ($counter + $i), $base\_title); |
| [546](#L546) |  |
| [547](#L547) | // Insert post with filtered data |
| [548](#L548) | $new = wp\_insert\_post($data, true); |
| [549](#L549) |  |
| [550](#L550) | // Check if the post is inserted successfully and append array |
| [551](#L551) | if (is\_numeric($new)) |
| [552](#L552) | array\_push($results['ids'], $new); |
| [553](#L553) | else |
| [554](#L554) | $results['error'] ++; |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) | // Handle multisite for premium fix |
| [558](#L558) | if ($areWePro && function\_exists('cdpp\_handle\_multisite\_after')) |
| [559](#L559) | cdpp\_handle\_multisite\_after($site); |
| [560](#L560) |  |
| [561](#L561) | // Set first counter number for future |
| [562](#L562) | $results['counter'] = $counter; |
| [563](#L563) |  |
| [564](#L564) | // Return array with results |
| [565](#L565) | return $results; |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | /\*\* |
| [569](#L569) | \* This local function filter and adds missing meta to added post |
| [570](#L570) | \* @param $ids (array of post ids) |
| [571](#L571) | \* @param $metas (filtered meta data with cdp\_filter\_meta function) |
| [572](#L572) | \* @return array structure below |
| [573](#L573) | \* { ids: { [id] => [failed times]}, error: { [id] => [failed times]} } |
| [574](#L574) | \*/ |
| [575](#L575) | function cdp\_insert\_post\_meta($ids, $metas, $areWePro, $counter, $site) { |
| [576](#L576) |  |
| [577](#L577) | // Handle multisite for premium |
| [578](#L578) | if ($areWePro && function\_exists('cdpp\_handle\_multisite')) |
| [579](#L579) | cdpp\_handle\_multisite($site); |
| [580](#L580) |  |
| [581](#L581) | // Create empty array for new id(s) and error(s) |
| [582](#L582) | $results = array('ids' => array(), 'error' => array()); |
| [583](#L583) |  |
| [584](#L584) | // Iterate through every inserted post |
| [585](#L585) | foreach ($ids as $id) { |
| [586](#L586) |  |
| [587](#L587) | // Iterate through every meta tag |
| [588](#L588) | foreach ($metas as $meta\_id => $meta) { |
| [589](#L589) |  |
| [590](#L590) | // Get individual data from metas array |
| [591](#L591) | foreach ($meta as $key => $val) { |
| [592](#L592) |  |
| [593](#L593) | // Replace the counter with dynamic value |
| [594](#L594) | if ($key == '\_cdp\_counter') |
| [595](#L595) | $val = $counter; |
| [596](#L596) |  |
| [597](#L597) | // Insert meta tag |
| [598](#L598) | $res = add\_post\_meta($id, $key, $val); |
| [599](#L599) |  |
| [600](#L600) | // Check if the insert was successfull |
| [601](#L601) | if ($res != false) { |
| [602](#L602) | if (!isset($results['ids'][$id])) |
| [603](#L603) | $results['ids'][$id] = []; |
| [604](#L604) | array\_push($results['ids'][$id], array($key, $val)); |
| [605](#L605) | } else { |
| [606](#L606) | if (!isset($results['error'][$id])) |
| [607](#L607) | $results['error'][$id] = []; |
| [608](#L608) | array\_push($results['error'][$id], array($key, $val)); |
| [609](#L609) | } |
| [610](#L610) | } |
| [611](#L611) | } |
| [612](#L612) |  |
| [613](#L613) | // Iterate the counter |
| [614](#L614) | $counter++; |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | // Fix multisite handler |
| [618](#L618) | if ($areWePro && function\_exists('cdpp\_handle\_multisite\_after')) |
| [619](#L619) | cdpp\_handle\_multisite\_after($site); |
| [620](#L620) |  |
| [621](#L621) | // Return the results |
| [622](#L622) | return $results; |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | /\*\* |
| [626](#L626) | \* This local function search for childs and catch their IDs |
| [627](#L627) | \* @param $id string/int (post id) |
| [628](#L628) | \* @return array of child(s) ID(s) |
| [629](#L629) | \*/ |
| [630](#L630) | function cdp\_check\_childs($id) { |
| [631](#L631) | $childs = []; |
| [632](#L632) | $childrens = get\_children(array('post\_parent' => $id)); |
| [633](#L633) |  |
| [634](#L634) | foreach ($childrens as $i => $child) |
| [635](#L635) | array\_push($childs, $child->ID); |
| [636](#L636) |  |
| [637](#L637) | return $childs; |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | /\*\* |
| [641](#L641) | \* This local function copies original attachments |
| [642](#L642) | \* @param $path string (path to original file) |
| [643](#L643) | \* @return string path to new file |
| [644](#L644) | \*/ |
| [645](#L645) | function cdp\_copy\_attachment($path = '', $destination) { |
| [646](#L646) | if ($path == '') |
| [647](#L647) | return false; |
| [648](#L648) |  |
| [649](#L649) | $dirname = $destination; |
| [650](#L650) | $name = basename($path); |
| [651](#L651) | $actual\_name = pathinfo($name, PATHINFO\_FILENAME); |
| [652](#L652) | $original\_name = $actual\_name; |
| [653](#L653) | $extension = pathinfo($name, PATHINFO\_EXTENSION); |
| [654](#L654) |  |
| [655](#L655) | $i = 1; |
| [656](#L656) | while (file\_exists($dirname . '/' . $actual\_name . "." . $extension)) { |
| [657](#L657) | $actual\_name = (string) $original\_name . '-' . $i; |
| [658](#L658) | $name = $actual\_name . '.' . $extension; |
| [659](#L659) | $i++; |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | copy($path, $dirname . '/' . $name); |
| [663](#L663) | return $dirname . '/' . $name; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | /\*\* |
| [667](#L667) | \* This local function gets copy and insert attachments |
| [668](#L668) | \* @param $id int/string of post |
| [669](#L669) | \* @return array of inserted attachments |
| [670](#L670) | \*/ |
| [671](#L671) | function cdp\_insert\_attachments($id, $inserted\_posts, $areWePro, $site) { |
| [672](#L672) | $inserts = array(); |
| [673](#L673) | $media = get\_attached\_media('', $id); |
| [674](#L674) |  |
| [675](#L675) | // Handle multisite for premium |
| [676](#L676) | if ($areWePro && function\_exists('cdpp\_handle\_multisite')) |
| [677](#L677) | cdpp\_handle\_multisite($site); |
| [678](#L678) |  |
| [679](#L679) | // Fix wordpress multisite path |
| [680](#L680) | add\_filter('upload\_dir', 'cdp\_fix\_upload\_paths'); |
| [681](#L681) | $wp\_upload\_dir = wp\_upload\_dir(); |
| [682](#L682) | remove\_filter('upload\_dir', 'cdp\_fix\_upload\_paths'); |
| [683](#L683) |  |
| [684](#L684) | // Handle multisite for premium fix |
| [685](#L685) | if ($areWePro && function\_exists('cdpp\_handle\_multisite\_after')) |
| [686](#L686) | cdpp\_handle\_multisite\_after($site); |
| [687](#L687) |  |
| [688](#L688) | foreach ($media as $i => $m) { |
| [689](#L689) | if (get\_attached\_file($m->ID) == '') |
| [690](#L690) | continue; |
| [691](#L691) | $path = cdp\_copy\_attachment(get\_attached\_file($m->ID), $wp\_upload\_dir['path']); |
| [692](#L692) |  |
| [693](#L693) | $filename = $path; |
| [694](#L694) | $parent\_post\_id = $inserted\_posts['ids'][0]; |
| [695](#L695) |  |
| [696](#L696) | $filetype = wp\_check\_filetype(basename($filename), null); |
| [697](#L697) |  |
| [698](#L698) | // Handle multisite for premium |
| [699](#L699) | if ($areWePro && function\_exists('cdpp\_handle\_multisite')) |
| [700](#L700) | cdpp\_handle\_multisite($site); |
| [701](#L701) |  |
| [702](#L702) | $attachment = array( |
| [703](#L703) | 'guid' => $wp\_upload\_dir['url'] . '/' . basename($filename), |
| [704](#L704) | 'post\_mime\_type' => $filetype['type'], |
| [705](#L705) | 'post\_title' => preg\_replace('/\.[^.]+$/', '', basename($filename)), |
| [706](#L706) | 'post\_content' => '', |
| [707](#L707) | 'post\_status' => 'inherit' |
| [708](#L708) | ); |
| [709](#L709) |  |
| [710](#L710) | $attach\_id = wp\_insert\_attachment($attachment, $filename, $parent\_post\_id); |
| [711](#L711) | array\_push($inserts, array('url' => wp\_get\_attachment\_url($attach\_id), 'id' => $attach\_id)); |
| [712](#L712) |  |
| [713](#L713) | $attach\_data = wp\_generate\_attachment\_metadata($attach\_id, $filename); |
| [714](#L714) | wp\_update\_attachment\_metadata($attach\_id, $attach\_data); |
| [715](#L715) |  |
| [716](#L716) | // Handle multisite for premium fix |
| [717](#L717) | if ($areWePro && function\_exists('cdpp\_handle\_multisite\_after')) |
| [718](#L718) | cdpp\_handle\_multisite\_after($site); |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | return $inserts; |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | /\*\* |
| [725](#L725) | \* This local function gets comments and copy them |
| [726](#L726) | \* @param $id int/string of base post |
| [727](#L727) | \* @param $dests array of post ids where the comms from $id should be copied |
| [728](#L728) | \* @return array of inserted comments |
| [729](#L729) | \*/ |
| [730](#L730) | function cdp\_copy\_comments($id, $dests) { |
| [731](#L731) | $comments = get\_comments(array('post\_id' => $id)); |
| [732](#L732) | $curr = current\_time('mysql'); |
| [733](#L733) | $all\_inserts = array(); |
| [734](#L734) | $all\_inserts['fix\_try'] = array(); |
| [735](#L735) | $all\_inserts['olds'] = ''; |
| [736](#L736) |  |
| [737](#L737) | foreach ($dests as $dest) { |
| [738](#L738) | $p = 0; |
| [739](#L739) | $olds = array(); |
| [740](#L740) |  |
| [741](#L741) | $cm1 = $comments; |
| [742](#L742) | foreach ($cm1 as $i => $c) { |
| [743](#L743) | $c = $c->to\_array(); |
| [744](#L744) | $old\_id = $c['comment\_ID']; |
| [745](#L745) | $parent = $c['comment\_parent']; |
| [746](#L746) |  |
| [747](#L747) | $c['comment\_date'] = $curr; |
| [748](#L748) | $c['comment\_date\_gmt'] = $curr; |
| [749](#L749) | $c['comment\_post\_ID'] = $dest; |
| [750](#L750) | $c['comment\_parent'] = 0; |
| [751](#L751) | if ($parent != "0") |
| [752](#L752) | $p++; |
| [753](#L753) |  |
| [754](#L754) | $new\_id = @wp\_insert\_comment($c); |
| [755](#L755) |  |
| [756](#L756) | $olds[$old\_id] = array('new' => $new\_id, 'old\_parent\_id' => $parent); |
| [757](#L757) | array\_push($all\_inserts, array('old' => $old\_id, 'new' => $new\_id, 'parent' => $parent)); |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | if ($p != 0) { |
| [761](#L761) | $cm2 = $comments; |
| [762](#L762) | foreach ($cm2 as $j => $m) { |
| [763](#L763) | if ($m->comment\_parent != "0" && $olds[$m->comment\_ID]['old\_parent\_id'] == $m->comment\_parent) { |
| [764](#L764) | $post = get\_comment($olds[$m->comment\_ID]['new']); |
| [765](#L765) | $post = $post->to\_array(); |
| [766](#L766) | $post['comment\_parent'] = $olds[$m->comment\_parent]['new']; |
| [767](#L767) | wp\_update\_comment($post); |
| [768](#L768) | } |
| [769](#L769) | } |
| [770](#L770) | } |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | return $all\_inserts; |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | // Main code for this duplication – for each id (post) do whole process |
| [777](#L777) | function cdp\_process\_ids($ids, $swap, $settings, $times, $site, $areWePro, $g, $isChild = false, $p\_ids = null) { |
| [778](#L778) |  |
| [779](#L779) | // Make it clear |
| [780](#L780) | $globals = cdp\_default\_global\_options(); |
| [781](#L781) | if ($g != false) |
| [782](#L782) | $globals = $g; |
| [783](#L783) | $g = $globals['others']; |
| [784](#L784) |  |
| [785](#L785) | // Return data storage |
| [786](#L786) | $output = []; |
| [787](#L787) | $new\_posts = array('parents' => array(), 'childs' => array(), 'ids' => array()); |
| [788](#L788) |  |
| [789](#L789) | // Iterate each id |
| [790](#L790) | foreach ($ids as $id) { |
| [791](#L791) |  |
| [792](#L792) | // Get post data and meta data |
| [793](#L793) | $post = get\_post($id)->to\_array(); |
| [794](#L794) | $meta = get\_post\_custom($id); |
| [795](#L795) | $taxonomies = wp\_get\_object\_terms($id, get\_taxonomies()); |
| [796](#L796) |  |
| [797](#L797) | // Check if this post type is allowed to copy |
| [798](#L798) | $type = $post['post\_type']; |
| [799](#L799) | if ($g['cdp-content-pages'] == 'false' && $type == 'page') |
| [800](#L800) | continue; |
| [801](#L801) | if ($g['cdp-content-posts'] == 'false' && $type == 'post') |
| [802](#L802) | continue; |
| [803](#L803) | if ($g['cdp-content-custom'] == 'false' && ($type != 'page' && $type != 'post')) |
| [804](#L804) | continue; |
| [805](#L805) |  |
| [806](#L806) | // Post converting? |
| [807](#L807) | $pConv = false; |
| [808](#L808) | if (array\_key\_exists('postConverter', $globals)) |
| [809](#L809) | $pConv = $globals['postConverter']; |
| [810](#L810) |  |
| [811](#L811) | // Run process and validate response |
| [812](#L812) | $childrens = cdp\_check\_childs($id); // if sizeof($this) == has childs |
| [813](#L813) | $post\_data = cdp\_filter\_post($post, $swap, $pConv, $settings, $taxonomies, $areWePro, $swap); // can be false |
| [814](#L814) | $meta\_data = cdp\_filter\_meta($meta, $settings, $id, $areWePro, $site, $post\_data['post\_title']); // can be false |
| [815](#L815) | $inserted\_posts = cdp\_insert\_post($id, $post\_data, $times, $areWePro, $isChild, $p\_ids, $site); // $res['error'] must be == 0 |
| [816](#L816) | $inserted\_metas = cdp\_insert\_post\_meta($inserted\_posts['ids'], $meta\_data, $areWePro, $inserted\_posts['counter'], $site); // sizeof($res['error']) must be == 0 |
| [817](#L817) | // Comments copy |
| [818](#L818) | if ($settings['comments']) |
| [819](#L819) | $inserted\_comments = cdp\_copy\_comments($id, $inserted\_posts['ids']); |
| [820](#L820) | $cms = get\_comments(array('post\_id' => $id)); |
| [821](#L821) |  |
| [822](#L822) | // Post format |
| [823](#L823) | if ($settings['format']) |
| [824](#L824) | foreach ($inserted\_posts['ids'] as $i => $tid) |
| [825](#L825) | $isReFormat = set\_post\_format($tid, get\_post\_format($id)); |
| [826](#L826) |  |
| [827](#L827) | // Featured image copy |
| [828](#L828) | if ($settings['attachments']) |
| [829](#L829) | $inserted\_attachments = cdp\_insert\_attachments($id, $inserted\_posts, $areWePro, $site); |
| [830](#L830) | else |
| [831](#L831) | $inserted\_attachments = false; |
| [832](#L832) |  |
| [833](#L833) | // Copy childrens recursively if exist |
| [834](#L834) | if ($settings['children'] && sizeof($childrens) > 0) { |
| [835](#L835) | $child\_helpers = array('posts' => $inserted\_posts['ids']); |
| [836](#L836) | $inserted\_childs = cdp\_process\_ids($childrens, $swap, $settings, $times, $site, $areWePro, $globals, true, $child\_helpers); |
| [837](#L837) | array\_push($new\_posts['childs'], array($id => $inserted\_childs['$new\_posts']['ids'])); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | // Add new inserted IDs |
| [841](#L841) | foreach ($inserted\_posts['ids'] as $i\_id) |
| [842](#L842) | array\_push($new\_posts['parents'], $i\_id); |
| [843](#L843) |  |
| [844](#L844) | // Merge for easier read |
| [845](#L845) | $new\_posts['ids'] = array\_merge($new\_posts['ids'], $new\_posts['parents'], $new\_posts['childs']); |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | // Return all data to main request |
| [849](#L849) | return array('$output' => $output, '$new\_posts' => $new\_posts); |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | // Run the machine for selected post(s) |
| [853](#L853) | $g = get\_option('\_cdp\_globals', false); |
| [854](#L854) | $new\_insertions = cdp\_process\_ids($ids, $swap, $settings, $times, $site, $areWePro, $g); |
| [855](#L855) |  |
| [856](#L856) | // Handle multisite for premium |
| [857](#L857) | if ($areWePro && function\_exists('cdpp\_handle\_multisite')) |
| [858](#L858) | cdpp\_handle\_multisite($site); |
| [859](#L859) |  |
| [860](#L860) | $pConv = false; |
| [861](#L861) | if (array\_key\_exists('postConverter', $g) && $areWePro) |
| [862](#L862) | $pConv = (($g['postConverter'] === '2' || $g['postConverter'] === 2) ? true : false); |
| [863](#L863) |  |
| [864](#L864) | // Output link if it's edited post |
| [865](#L865) | $aCop = ((array\_key\_exists('afterCopy', $g)) ? $g['afterCopy'] : '1'); |
| [866](#L866) | if (($data['type'] == 'copy-custom-link' || $aCop == '2')) |
| [867](#L867) | $output['link'] = get\_edit\_post\_link($new\_insertions['$new\_posts']['parents'][0], 'x'); |
| [868](#L868) |  |
| [869](#L869) | if ($pConv == true && !($data['type'] == 'copy-custom-link' || $aCop == '2')) |
| [870](#L870) | $output['link'] = 'pConv'; |
| [871](#L871) | else |
| [872](#L872) | update\_option('\_cdp\_show\_copy', true); |
| [873](#L873) |  |
| [874](#L874) | // Handle multisite for premium fix |
| [875](#L875) | if ($areWePro && function\_exists('cdpp\_handle\_multisite\_after')) |
| [876](#L876) | cdpp\_handle\_multisite\_after($site); |
| [877](#L877) |  |
| [878](#L878) | // Check performance by time |
| [879](#L879) | $copyTime = microtime(true) - $timein; |
| [880](#L880) | $copyTimePerOne = $copyTime / $times; |
| [881](#L881) |  |
| [882](#L882) | // Set only if had good performance all the time |
| [883](#L883) | $isSlowPerf = true; |
| [884](#L884) | if (get\_option('cdp\_latest\_slow\_performance', false) == false) { |
| [885](#L885) | $isSlowPerf = false; |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) | // Check if the copy time of one page was slower than 0.051 of second |
| [889](#L889) | if ($copyTimePerOne > 0.051) { |
| [890](#L890) | $isSlowPerf = true; |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | // Set the performance status |
| [894](#L894) | update\_option('cdp\_latest\_slow\_performance', $isSlowPerf); |
| [895](#L895) |  |
| [896](#L896) | // Update history with logs |
| [897](#L897) | $logs = get\_option('cdp\_copy\_logs\_times', array()); |
| [898](#L898) | if (sizeof($logs) >= 50) { |
| [899](#L899) | $logs = array\_slice($logs, 0, 48); |
| [900](#L900) | } |
| [901](#L901) | $logs = array\_values($logs); |
| [902](#L902) | array\_unshift($logs, array('amount' => $times, 'time' => $copyTime, 'perOne' => $copyTimePerOne, 'data' => time(), 'memory' => memory\_get\_usage(), 'peak' => memory\_get\_peak\_usage(true))); |
| [903](#L903) | update\_option('cdp\_copy\_logs\_times', $logs); |
| [904](#L904) |  |
| [905](#L905) | echo json\_encode(cdp\_sanitize\_array($output)); |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | /\*\* –– \* \*/ |
| [909](#L909) |  |
| [910](#L910) | /\*\* –– \*\*\ |
| [911](#L911) | \* This function will return profile information for presets. |
| [912](#L912) | \* @return object of settings by requested profile |
| [913](#L913) | \* @since 1.0.0 |
| [914](#L914) | \*/ |
| [915](#L915) | function cdp\_get\_profile() { |
| [916](#L916) |  |
| [917](#L917) | if (function\_exists('cdpp\_get\_all\_profiles')) |
| [918](#L918) | cdpp\_get\_profile(); |
| [919](#L919) | else { |
| [920](#L920) |  |
| [921](#L921) | // Search for the settings of profile |
| [922](#L922) | $settings = get\_option('\_cdp\_profiles')['default']; |
| [923](#L923) |  |
| [924](#L924) | // Display those settings |
| [925](#L925) | echo json\_encode(cdp\_sanitize\_array($settings)); |
| [926](#L926) | } |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | /\*\* –– \* \*/ |
| [930](#L930) |  |
| [931](#L931) | /\*\* –– \*\*\ |
| [932](#L932) | \* This function will return all profile information for manager. |
| [933](#L933) | \* @return object of settings by requested profile |
| [934](#L934) | \* @since 1.0.0 |
| [935](#L935) | \*/ |
| [936](#L936) | function cdp\_get\_all\_profiles() { |
| [937](#L937) |  |
| [938](#L938) | if (function\_exists('cdpp\_get\_all\_profiles')) |
| [939](#L939) | cdpp\_get\_all\_profiles(); |
| [940](#L940) | else |
| [941](#L941) | cdp\_get\_profile(); |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | /\*\* –– \* \*/ |
| [945](#L945) |  |
| [946](#L946) | /\*\* –– \*\*\ |
| [947](#L947) | \* This function will return all not trashed posts |
| [948](#L948) | \* @return object of posts and success or fail message |
| [949](#L949) | \*/ |
| [950](#L950) | function cdp\_get\_all\_posts() { |
| [951](#L951) | $output = array(); |
| [952](#L952) |  |
| [953](#L953) | $args = array( |
| [954](#L954) | 'numberposts' => -1, |
| [955](#L955) | 'post\_type' => 'post', |
| [956](#L956) | 'post\_status' => 'publish,private,draft,future,pending,inherit,sticky' |
| [957](#L957) | ); |
| [958](#L958) |  |
| [959](#L959) | $output['posts'] = get\_posts($args); |
| [960](#L960) | $args['post\_type'] = 'page'; |
| [961](#L961) | $output['pages'] = get\_posts($args); |
| [962](#L962) | $output['custom'] = array(); |
| [963](#L963) |  |
| [964](#L964) | $post\_types = get\_post\_types(array('public' => true, '\_builtin' => false)); |
| [965](#L965) |  |
| [966](#L966) | if (sizeof($post\_types) > 0) |
| [967](#L967) | $output['custom'] = get\_posts(array( |
| [968](#L968) | 'post\_type' => $post\_types, |
| [969](#L969) | 'numberposts' => -1, |
| [970](#L970) | 'post\_status' => 'publish,private,draft,future,pending,inherit,sticky' |
| [971](#L971) | )); |
| [972](#L972) |  |
| [973](#L973) | $output['meta'] = array(); |
| [974](#L974) | foreach ($output['posts'] as $k => $p) |
| [975](#L975) | $output['meta'][$p->ID] = get\_post\_meta($p->ID); |
| [976](#L976) | foreach ($output['pages'] as $k => $p) |
| [977](#L977) | $output['meta'][$p->ID] = get\_post\_meta($p->ID); |
| [978](#L978) | foreach ($output['custom'] as $k => $p) |
| [979](#L979) | $output['meta'][$p->ID] = get\_post\_meta($p->ID); |
| [980](#L980) |  |
| [981](#L981) | echo json\_encode(cdp\_sanitize\_array($output)); |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | /\*\* –– \* \*/ |
| [985](#L985) |  |
| [986](#L986) | /\*\* –– \*\*\ |
| [987](#L987) | \* This function will delete all posts in array PERMANENTLY! |
| [988](#L988) | \* @return object of success message or error |
| [989](#L989) | \*/ |
| [990](#L990) | function cdp\_delete\_posts() { |
| [991](#L991) | $ids = ((isset($\_POST['ids'])) ? cdp\_sanitize\_array($\_POST['ids']) : false); // ids to delete |
| [992](#L992) | $throttling = sanitize\_text\_field($\_POST['throttling']); // throttling if enabeld |
| [993](#L993) | $thc = sanitize\_text\_field($\_POST['thc']); // throttling count if enabeld |
| [994](#L994) | $thrs = sanitize\_text\_field($\_POST['thrs']) == 'true' ? true : false; // trash or not? |
| [995](#L995) | $redi = sanitize\_text\_field($\_POST['redi']) == 'true' ? true : false; // redirect if enabled |
| [996](#L996) | $auit = sanitize\_text\_field($\_POST['auit']) == 'true' ? true : false; // auit if enabled |
| [997](#L997) | $auitd = ((isset($\_POST['auitd'])) ? cdp\_sanitize\_array($\_POST['auitd']) : false); // auitd if auit enabled |
| [998](#L998) |  |
| [999](#L999) | $prepared\_ids = array(); |
| [1000](#L1000) | $inGroup = 0; |
| [1001](#L1001) | $curr = current\_time('timestamp'); |
| [1002](#L1002) | $token = uniqid($curr, true); |
| [1003](#L1003) | $cdp\_cron = get\_option('\_cdp\_crons'); |
| [1004](#L1004) | $site = is\_multisite() ? get\_current\_blog\_id() : '-1'; |
| [1005](#L1005) | if ($cdp\_cron == false) |
| [1006](#L1006) | $cdp\_cron = array(); |
| [1007](#L1007) | $cdp\_cron[$token] = array( |
| [1008](#L1008) | 'start' => $curr, |
| [1009](#L1009) | 'ids' => $ids, |
| [1010](#L1010) | 'done' => false, |
| [1011](#L1011) | 'shown' => false, |
| [1012](#L1012) | 'f' => 'delete', |
| [1013](#L1013) | 'del\_size' => sizeof($ids), |
| [1014](#L1014) | 'handler' => 'cdp\_cron\_delete', |
| [1015](#L1015) | 'auit' => $auit, |
| [1016](#L1016) | 'auitd' => $auitd |
| [1017](#L1017) | ); |
| [1018](#L1018) | $cdp\_cron[$token]['tasks'] = array(); |
| [1019](#L1019) | $cdp\_cron[$token]['args'] = array(); |
| [1020](#L1020) |  |
| [1021](#L1021) | if ($throttling == '1' && $thc && intval($thc) >= 1 && intval($thc) <= 10240) { |
| [1022](#L1022) |  |
| [1023](#L1023) | $inGroup = ceil(intval($thc) / 30); |
| [1024](#L1024) |  |
| [1025](#L1025) | for ($i = 0, $k = 2; $i < sizeof($ids); $i = $i + $inGroup, $k++) |
| [1026](#L1026) | $cdp\_cron[$token]['tasks']["-$k"] = false; |
| [1027](#L1027) |  |
| [1028](#L1028) | update\_option('\_cdp\_crons', $cdp\_cron); |
| [1029](#L1029) | for ($i = 0, $k = 2; $i < sizeof($ids); $i = $i + $inGroup, $k++) { |
| [1030](#L1030) | $tg = array(); |
| [1031](#L1031) | $tt = array('tsk' => "-" . $k, 'token' => $token); |
| [1032](#L1032) |  |
| [1033](#L1033) | for ($j = $i; $j < ($i + $inGroup); $j++) |
| [1034](#L1034) | if (isset($ids[$j])) |
| [1035](#L1035) | array\_push($tg, $ids[$j]); |
| [1036](#L1036) |  |
| [1037](#L1037) | array\_push($prepared\_ids, $tg); |
| [1038](#L1038) | $time = $k \* 2; |
| [1039](#L1039) | $args = array(array('ids' => $tg, 'site' => $site, 'trash' => $thrs, 'token' => $tt)); |
| [1040](#L1040) | wp\_schedule\_single\_event(strtotime("+$time seconds"), 'cdp\_cron\_delete', $args); |
| [1041](#L1041) | array\_push($cdp\_cron[$token]['args'], $args); |
| [1042](#L1042) | } |
| [1043](#L1043) | } else { |
| [1044](#L1044) |  |
| [1045](#L1045) | $cdp\_cron[$token]['tasks']["-0"] = false; |
| [1046](#L1046) | update\_option('\_cdp\_crons', $cdp\_cron); |
| [1047](#L1047) | $tt = array('tsk' => "-0", 'token' => $token); |
| [1048](#L1048) | $args = array(array('ids' => $ids, 'site' => $site, 'trash' => $thrs, 'token' => $tt)); |
| [1049](#L1049) | wp\_schedule\_single\_event(strtotime('+2 seconds'), 'cdp\_cron\_delete', $args); |
| [1050](#L1050) | array\_push($cdp\_cron[$token]['args'], $args); |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | echo json\_encode(array('status' => 'success', 'token' => cdp\_sanitize\_array($token))); |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | /\*\* –– \* \*/ |
| [1057](#L1057) |  |
| [1058](#L1058) | /\*\* –– \*\*\ |
| [1059](#L1059) | \* This function will delete all posts in array PERMANENTLY! |
| [1060](#L1060) | \* @return object of success message or error |
| [1061](#L1061) | \*/ |
| [1062](#L1062) | function cdp\_clear\_all\_crons() { |
| [1063](#L1063) | $cdp\_cron = get\_option('\_cdp\_crons'); |
| [1064](#L1064) |  |
| [1065](#L1065) | foreach ($cdp\_cron as $cron => $val) { |
| [1066](#L1066) | if (array\_key\_exists('done', $val)) { |
| [1067](#L1067) | if ($val['done'] != true) { |
| [1068](#L1068) | echo json\_encode(array( |
| [1069](#L1069) | 'status' => 'fail', |
| [1070](#L1070) | 'type' => 'warning', |
| [1071](#L1071) | 'msg' => \_\_('You can\'t clear messages when tasks are in progress, please firstly kill tasks or wait till the end.', 'copy-delete-posts') |
| [1072](#L1072) | )); |
| [1073](#L1073) | return; |
| [1074](#L1074) | } |
| [1075](#L1075) | } |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | $cdp\_cron = delete\_option('\_cdp\_crons'); |
| [1079](#L1079) | echo json\_encode(array('status' => 'success')); |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | /\*\* –– \* \*/ |
| [1083](#L1083) |  |
| [1084](#L1084) | /\*\* –– \*\*\ |
| [1085](#L1085) | \* Local function which sets default profile for user |
| [1086](#L1086) | \* @return Boolean |
| [1087](#L1087) | \*/ |
| [1088](#L1088) | function cdp\_set\_default\_profile() { |
| [1089](#L1089) | $curr = get\_option('\_cdp\_preselections'); |
| [1090](#L1090) | $id = get\_current\_user\_id(); |
| [1091](#L1091) | $new = array(); |
| [1092](#L1092) | $selection = ((isset($\_POST['selection'])) ? cdp\_sanitize\_array($\_POST['selection']) : false); |
| [1093](#L1093) | if ($curr && !is\_object($curr) || $curr == false) |
| [1094](#L1094) | $new = array($id => $selection); |
| [1095](#L1095) | else { |
| [1096](#L1096) | $new = $curr; |
| [1097](#L1097) | $new[$id] = $selection; |
| [1098](#L1098) | } |
| [1099](#L1099) | $stat = update\_option('\_cdp\_preselections', $new); |
| [1100](#L1100) | echo cdp\_sanitize\_array($stat); |
| [1101](#L1101) | } |
| [1102](#L1102) |  |
| [1103](#L1103) | /\*\* –– \* \*/ |
| [1104](#L1104) |  |
| [1105](#L1105) | /\*\* –– \*\*\ |
| [1106](#L1106) | \* Local function which gets default profile for user |
| [1107](#L1107) | \* @return String |
| [1108](#L1108) | \*/ |
| [1109](#L1109) | function cdp\_get\_default\_profile() { |
| [1110](#L1110) | echo(esc\_html(get\_option('\_cdp\_preselections')[get\_current\_user\_id()])); |
| [1111](#L1111) | } |
| [1112](#L1112) |  |
| [1113](#L1113) | /\*\* –– \* \*/ |
| [1114](#L1114) |  |
| [1115](#L1115) | /\*\* –– \*\*\ |
| [1116](#L1116) | \* This function will set as seen notification! |
| [1117](#L1117) | \* @return object of success message — WARNING: ALWAYS |
| [1118](#L1118) | \*/ |
| [1119](#L1119) | function cdp\_set\_noti\_as\_seen() { |
| [1120](#L1120) | if (wp\_doing\_cron()) |
| [1121](#L1121) | return; |
| [1122](#L1122) |  |
| [1123](#L1123) | $token = ((isset($\_POST['noti\_token'])) ? sanitize\_text\_field($\_POST['noti\_token']) : false); |
| [1124](#L1124) | $cdp\_cron = get\_option('\_cdp\_crons', array()); |
| [1125](#L1125) | $cdp\_cron[$token]['shown'] = true; |
| [1126](#L1126) | update\_option('\_cdp\_crons', $cdp\_cron); |
| [1127](#L1127) |  |
| [1128](#L1128) | echo json\_encode(array('status' => 'success')); |
| [1129](#L1129) | } |
| [1130](#L1130) |  |
| [1131](#L1131) | /\*\* –– \* \*/ |
| [1132](#L1132) |  |
| [1133](#L1133) | /\*\* –– \*\*\ |
| [1134](#L1134) | \* This function will delete task from the history! |
| [1135](#L1135) | \* @return object of success message or fail |
| [1136](#L1136) | \*/ |
| [1137](#L1137) | function cdp\_just\_hide\_task() { |
| [1138](#L1138) | $token = ((isset($\_POST['task'])) ? sanitize\_text\_field($\_POST['task']) : false); |
| [1139](#L1139) | $cdp\_cron = get\_option('\_cdp\_crons', array()); |
| [1140](#L1140) | unset($cdp\_cron[$token]); |
| [1141](#L1141) | $res = update\_option('\_cdp\_crons', $cdp\_cron); |
| [1142](#L1142) |  |
| [1143](#L1143) | if ($res) |
| [1144](#L1144) | echo json\_encode(array('status' => 'success')); |
| [1145](#L1145) | else |
| [1146](#L1146) | echo json\_encode(array('status' => 'fail', 'type' => 'error', 'msg' => \_\_('We can\'t hide this task now, – maybe it\'t already hidden. Please try again later.', 'copy-delete-posts'))); |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | /\*\* –– \* \*/ |
| [1150](#L1150) |  |
| [1151](#L1151) | /\*\* –– \*\*\ |
| [1152](#L1152) | \* This function will kill task from the cron! |
| [1153](#L1153) | \* @return object of success message or fail |
| [1154](#L1154) | \*/ |
| [1155](#L1155) | function cdp\_just\_kill\_task() { |
| [1156](#L1156) | $token = ((isset($\_POST['task'])) ? sanitize\_text\_field($\_POST['task']) : false); |
| [1157](#L1157) | $cdp\_cron = get\_option('\_cdp\_crons', array()); |
| [1158](#L1158) | $handler = $cdp\_cron[$token]['handler']; |
| [1159](#L1159) | $args = (array\_key\_exists('args', $cdp\_cron[$token]) ? $cdp\_cron[$token]['args'] : array()); |
| [1160](#L1160) |  |
| [1161](#L1161) | if ($cdp\_cron[$token]['done'] != false) { |
| [1162](#L1162) | echo json\_encode(array('status' => 'fail', 'type' => 'error', 'msg' => \_\_('This task has already ended this work, please wait for list refresh and try again.', 'copy-delete-posts'))); |
| [1163](#L1163) | return; |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | $status = true; |
| [1167](#L1167) | $res = false; |
| [1168](#L1168) | foreach ($args as $arg => $val) { |
| [1169](#L1169) | $sres = wp\_clear\_scheduled\_hook($handler, $val); |
| [1170](#L1170) | if ($sres == false) |
| [1171](#L1171) | $status = false; |
| [1172](#L1172) | } |
| [1173](#L1173) |  |
| [1174](#L1174) | if ($cdp\_cron[$token]['done'] != false) |
| [1175](#L1175) | $status = true; |
| [1176](#L1176) |  |
| [1177](#L1177) | if ($status == true) { |
| [1178](#L1178) | unset($cdp\_cron[$token]); |
| [1179](#L1179) | $res = update\_option('\_cdp\_crons', $cdp\_cron); |
| [1180](#L1180) | } |
| [1181](#L1181) |  |
| [1182](#L1182) | if ($status || $res) |
| [1183](#L1183) | echo json\_encode(array('status' => 'success')); |
| [1184](#L1184) | else |
| [1185](#L1185) | echo json\_encode(array('status' => 'fail', 'type' => 'error', 'msg' => \_\_('We can\'t confirm that we killed this task now, please try again later or check if it\'t killed.', 'copy-delete-posts'))); |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | /\*\* –– \* \*/ |
| [1189](#L1189) |  |
| [1190](#L1190) | /\*\* –– \*\*\ |
| [1191](#L1191) | \* This function will catch current cron tasks! |
| [1192](#L1192) | \* @return object of tasks or fail |
| [1193](#L1193) | \*/ |
| [1194](#L1194) | function cdp\_just\_get\_tasks() { |
| [1195](#L1195) | $cdp\_cron = get\_option('\_cdp\_crons', false); |
| [1196](#L1196) |  |
| [1197](#L1197) | if ($cdp\_cron) |
| [1198](#L1198) | echo json\_encode(array('status' => 'success', 'tasks' => cdp\_sanitize\_array($cdp\_cron))); |
| [1199](#L1199) | else |
| [1200](#L1200) | echo json\_encode(array('status' => 'fail', 'type' => 'error', 'msg' => \_\_('We couldn\'t catch current tasks, please try again later.', 'copy-delete-posts'))); |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | /\*\* –– \* \*/ |
| [1204](#L1204) |  |
| [1205](#L1205) | /\*\* –– \*\*\ |
| [1206](#L1206) | \* This function will remove performance notice |
| [1207](#L1207) | \* @return void |
| [1208](#L1208) | \*/ |
| [1209](#L1209) | function cdp\_hide\_perf\_notice() { |
| [1210](#L1210) | update\_option('cdp\_dismiss\_perf\_notice', true); |
| [1211](#L1211) | update\_option('cdp\_latest\_slow\_performance', false); |
| [1212](#L1212) | echo json\_encode(array('status' => 'success')); |
| [1213](#L1213) | } |
| [1214](#L1214) |  |
| [1215](#L1215) | /\*\* –– \* \*/ |
| [1216](#L1216) |  |
| [1217](#L1217) | /\*\* –– \*\*\ |
| [1218](#L1218) | \* This function is just for debug have fun with it! |
| [1219](#L1219) | \* It can be fired by function cdp\_totally\_know\_what\_i\_am\_doing('really'); |
| [1220](#L1220) | \* It won't work in production mode so dont even try it, if you're not me ~ Mikołaj :P |
| [1221](#L1221) | \* @return mixed |
| [1222](#L1222) | \*/ |
| [1223](#L1223) | function cdp\_debug\_function() { |
| [1224](#L1224) |  |
| [1225](#L1225) | // require\_once('C:/Developer/Web/wordpress/wp-content/plugins/copy-delete-posts-premium/classes/methods.php'); |
| [1226](#L1226) | // $settings = get\_option('cdpp\_aci\_settings', false); |
| [1227](#L1227) | // $meth = new CDP\_Premium($settings); |
| [1228](#L1228) | // $posts = $meth->load\_posts($settings['scan']); |
| [1229](#L1229) | // $filtred = $meth->filter\_posts($posts); |
| [1230](#L1230) |  |
| [1231](#L1231) | $cdp\_cron = get\_option('\_cdp\_crons', false); |
| [1232](#L1232) | $things\_to\_debug = array( |
| [1233](#L1233) | '$cdp\_cron' => $cdp\_cron |
| [1234](#L1234) | ); |
| [1235](#L1235) | var\_export($things\_to\_debug); |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | /\*\* –– \*\*/ |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/copy-delete-posts/tags/1.2.0/post/handler.php?format=txt)
* [Original Format](/export/3222687/copy-delete-posts/tags/1.2.0/post/handler.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


