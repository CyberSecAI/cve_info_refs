=== Content from github.com_d845e26a_20250115_083555.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore%2Fblob%2Fv5.6.4.13%2FASCOfficePPTXFile%2FEditor%2FBinaryFileReaderWriter.cpp)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore%2Fblob%2Fv5.6.4.13%2FASCOfficePPTXFile%2FEditor%2FBinaryFileReaderWriter.cpp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ONLYOFFICE%2Fcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[core](/ONLYOFFICE/core)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fcore) You must be signed in to change notification settings
* [Fork
  226](/login?return_to=%2FONLYOFFICE%2Fcore)
* [Star
   295](/login?return_to=%2FONLYOFFICE%2Fcore)

* [Code](/ONLYOFFICE/core/tree/v5.6.4.13)
* [Pull requests
  11](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/core/tree/v5.6.4.13)
* [Pull requests](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

## Files

 v5.6.4.13
## Breadcrumbs

1. [core](/ONLYOFFICE/core/tree/v5.6.4.13)
2. /[ASCOfficePPTXFile](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile)
3. /[Editor](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/Editor)
/
# BinaryFileReaderWriter.cpp

Copy path Blame  Blame
## Latest commit

## History

[History](/ONLYOFFICE/core/commits/v5.6.4.13/ASCOfficePPTXFile/Editor/BinaryFileReaderWriter.cpp)2058 lines (1803 loc) · 61.4 KB v5.6.4.13
## Breadcrumbs

1. [core](/ONLYOFFICE/core/tree/v5.6.4.13)
2. /[ASCOfficePPTXFile](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile)
3. /[Editor](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/Editor)
/
# BinaryFileReaderWriter.cpp

Top
## File metadata and controls

* Code
* Blame

2058 lines (1803 loc) · 61.4 KB[Raw](https://github.com/ONLYOFFICE/core/raw/refs/tags/v5.6.4.13/ASCOfficePPTXFile/Editor/BinaryFileReaderWriter.cpp)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000﻿/\* \* (c) Copyright Ascensio System SIA 2010-2019 \* \* This program is a free software product. You can redistribute it and/or \* modify it under the terms of the GNU Affero General Public License (AGPL) \* version 3 as published by the Free Software Foundation. In accordance with \* Section 7(a) of the GNU AGPL its Section 15 shall be amended to the effect \* that Ascensio System SIA expressly excludes the warranty of non-infringement \* of any third-party rights. \* \* This program is distributed WITHOUT ANY WARRANTY; without even the implied \* warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. For \* details, see the GNU AGPL at: http://www.gnu.org/licenses/agpl-3.0.html \* \* You can contact Ascensio System SIA at 20A-12 Ernesta Birznieka-Upisha \* street, Riga, Latvia, EU, LV-1050. \* \* The interactive user interfaces in modified source and object code versions \* of the Program must display Appropriate Legal Notices, as required under \* Section 5 of the GNU AGPL version 3. \* \* Pursuant to Section 7(b) of the License you must retain the original Product \* logo when distributing the program. Pursuant to Section 7(e) we decline to \* grant you any rights under trademark law for use of our trademarks. \* \* All the Product's GUI elements, including illustrations and icon sets, as \* well as technical writing content are licensed under the terms of the \* Creative Commons Attribution-ShareAlike 4.0 International. See the License \* terms at http://creativecommons.org/licenses/by-sa/4.0/legalcode \* \*/#include "BinaryFileReaderWriter.h"#include "BinReaderWriterDefines.h"
#include "../../Common/DocxFormat/Source/Base/Nullable.h"#include "../../Common/DocxFormat/Source/DocxFormat/WritingElement.h"
#include "../../Common/DocxFormat/Source/DocxFormat/Media/OleObject.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/ActiveX.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/Video.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/Audio.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/VbaProject.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/JsaProject.h"
#include "../../Common/Base64.h"
#include "./imagemanager.h"#include "./XmlWriter.h"#include "./FontPicker.h"#include "../../ASCOfficeDocxFile2/DocWrapper/DocxSerializer.h"
#include "../../DesktopEditor/common/File.h"#include "../../DesktopEditor/common/Directory.h"#include "../PPTXFormat/FileContainer.h"#include <iostream>
#define BYTE\_SIZEOF sizeof(BYTE)#define UINT16\_SIZEOF sizeof(\_UINT16)#define UINT32\_SIZEOF sizeof(\_UINT32)#define DOUBLE\_SIZEOF sizeof(double)
#define CHAR\_SIZEOF sizeof(CHAR)#define INT16\_SIZEOF sizeof(\_INT16)#define INT32\_SIZEOF sizeof(\_INT32)#define INT64\_SIZEOF sizeof(\_INT64)
#define DOUBLE\_MAIN 10000
#if defined(\_WIN32) || defined (\_WIN64) #include "../../Common/DocxFormat/Source/Base/unicode\_util.h"#endif
namespace NSBinPptxRW{ template <typename T,unsigned S> inline unsigned arraysize(const T (&v)[S]) { return S; }
 CCommonWriter::CCommonWriter() { m\_pNativePicker = NULL; m\_pFontPicker = NULL; m\_bDeleteFontPicker = true; m\_pMediaManager = new NSShapeImageGen::CMediaManager(); } CCommonWriter::~CCommonWriter() { m\_pNativePicker = NULL; if(m\_bDeleteFontPicker) RELEASEOBJECT(m\_pFontPicker); RELEASEOBJECT(m\_pMediaManager); } void CCommonWriter::CreateFontPicker(COfficeFontPicker\* pPicker) { if(m\_bDeleteFontPicker) RELEASEOBJECT(m\_pFontPicker); m\_pNativePicker = NULL; if (pPicker != NULL) { m\_pFontPicker = pPicker; m\_bDeleteFontPicker = false; } else { m\_pFontPicker = new COfficeFontPicker(); m\_bDeleteFontPicker = true; }
 m\_pNativePicker = m\_pFontPicker->GetNativePicker(); } void CCommonWriter::CheckFontPicker() { if (NULL == m\_pFontPicker) CreateFontPicker(NULL); }
 CImageManager2::CImageManager2() : m\_mapImages(), m\_lIndexNextImage(0), m\_lIndexCounter(0) { m\_nDocumentType = XMLWRITER\_DOC\_TYPE\_PPTX; m\_pContentTypes = new OOX::CContentTypes(); } CImageManager2::~CImageManager2() { delete m\_pContentTypes; } void CImageManager2::Clear() { m\_mapImages.clear(); m\_lIndexNextImage = 0; m\_lIndexCounter = 0; } void CImageManager2::SetDstFolder(const std::wstring& strDst) { m\_strDstFolder = strDst; m\_strDstMedia = m\_strDstFolder + FILE\_SEPARATOR\_STR + \_T("media"); m\_strDstEmbed = m\_strDstFolder + FILE\_SEPARATOR\_STR + \_T("embeddings");
 NSDirectory::CreateDirectory(m\_strDstMedia); NSDirectory::CreateDirectory(m\_strDstEmbed); } std::wstring CImageManager2::GetDstFolder() { return m\_strDstFolder; } void CImageManager2::SetDstMedia(const std::wstring& strDst) { m\_strDstMedia = strDst; } std::wstring CImageManager2::GetDstMedia() { return m\_strDstMedia; } void CImageManager2::SetDstEmbed(const std::wstring& strDst) { m\_strDstEmbed = strDst; } std::wstring CImageManager2::GetDstEmbed() { return m\_strDstEmbed; } int CImageManager2::IsDisplayedImage(const std::wstring& strInput) { int nRes = 0; //шаблон display[N]image.ext std::wstring sFind1 = \_T("display"); int nIndex1 = (int)strInput.find(sFind1); if(-1 != nIndex1) { if(nIndex1 + sFind1.length() < strInput.length()) { wchar\_t cRes1 = strInput[nIndex1 + sFind1.length()]; if('1' <= cRes1 && cRes1 <= '9') { wchar\_t cRes2 = strInput[nIndex1 + sFind1.length() + 1];  int nImageIndex = nIndex1 + (int)sFind1.length() + 1; if (std::wstring::npos != strInput.find(\_T("image"), nImageIndex)) { nRes = cRes1 - '0'; if('0' <= cRes2 && cRes2 <= '9') { nRes = nRes \* 10 + (cRes2 - '0'); }  }
 }
 } } return nRes; } \_imageManager2Info CImageManager2::GenerateMedia(const std::wstring& strInput) { std::map<std::wstring, \_imageManager2Info>::const\_iterator pPair = m\_mapImages.find(strInput);
 if (pPair != m\_mapImages.end()) { return pPair->second; }
 \_imageManager2Info oImageManagerInfo = GenerateMediaExec(strInput);  m\_mapImages[strInput] = oImageManagerInfo;
 return oImageManagerInfo; } \_imageManager2Info CImageManager2::GenerateImage(const std::wstring& strInput, NSCommon::smart\_ptr<OOX::File> & additionalFile, const std::wstring& oleData, std::wstring strBase64Image) { if (IsNeedDownload(strInput)) return DownloadImage(strInput);
 std::map<std::wstring, \_imageManager2Info>::const\_iterator pPair = m\_mapImages.find ((strBase64Image.empty()) ? strInput : strBase64Image);
 if (pPair != m\_mapImages.end()) { smart\_ptr<OOX::Media> mediaFile = additionalFile.smart\_dynamic\_cast<OOX::Media>(); if (mediaFile.IsInit()) mediaFile->set\_filename(pPair->second.sFilepathAdditional, false);
 return pPair->second; }
 std::wstring strExts = \_T(".jpg"); //use GetFileName to avoid defining '.' in the directory as extension std::wstring strFileName = NSFile::GetFileName(strInput); int nIndexExt = (int)strFileName.rfind(wchar\_t('.')); if (-1 != nIndexExt) strExts = strFileName.substr(nIndexExt);
 int typeAdditional = 0; std::wstring strAdditional; std::wstring strImage = strInput;
 int nDisplayType = IsDisplayedImage(strInput); if (0 != nDisplayType) { OOX::CPath oPath = strInput;  std::wstring strFolder = oPath.GetDirectory(); std::wstring strFileName = oPath.GetFilename();
 strFileName.erase(strFileName.length() - 4, 4);
 if(0 != (nDisplayType & 1)) { std::wstring strVector = strFolder + strFileName + \_T(".wmf"); if (OOX::CSystemUtility::IsFileExist(strVector)) { strImage = strVector; strExts = \_T(".wmf"); } } if(0 != (nDisplayType & 2)) { std::wstring strVector = strFolder + strFileName + L".emf"; if (OOX::CSystemUtility::IsFileExist(strVector)) { m\_pContentTypes->AddDefault(L"emf"); strImage = strVector; strExts = L".emf"; } } if(0 != (nDisplayType & 4)) { smart\_ptr<OOX::OleObject> oleFile = additionalFile.smart\_dynamic\_cast<OOX::OleObject>(); if (oleFile.IsInit()) { if (OOX::CSystemUtility::IsFileExist(oleFile->filename()) == false) { typeAdditional = 1;  std::wstring strOle = strFolder + strFileName + oleFile->filename().GetExtention(); if (OOX::CSystemUtility::IsFileExist(strOle)) { m\_pContentTypes->AddDefault(oleFile->filename().GetExtention(false)); strAdditional = strOle; } else { strOle = strFolder + strFileName + L".bin"; if (OOX::CSystemUtility::IsFileExist(strOle)) strAdditional = strOle; } } } } if(0 != (nDisplayType & 8)) { smart\_ptr<OOX::Media> mediaFile = additionalFile.smart\_dynamic\_cast<OOX::Media>(); if (mediaFile.IsInit()) { if (OOX::CSystemUtility::IsFileExist(mediaFile->filename()) == false) { typeAdditional = 2;
 if (!mediaFile->IsExternal()) { std::wstring strMedia = strFolder + strFileName + mediaFile->filename().GetExtention(); if (OOX::CSystemUtility::IsFileExist(strMedia)) { m\_pContentTypes->AddDefault(mediaFile->filename().GetExtention(false)); strAdditional = strMedia; } else { strMedia = strFolder + strFileName;  if (mediaFile.is<OOX::Audio>()) strMedia += L".wav"; if (mediaFile.is<OOX::Video>()) strMedia += L".avi";  if (OOX::CSystemUtility::IsFileExist(strMedia)) strAdditional = strMedia; } } } } } } if (!strExts.empty()) { m\_pContentTypes->AddDefault(strExts.substr(1)); }
 if (oleData.empty() == false) { //plugins data - generate ole typeAdditional = 1; }
 \_imageManager2Info oImageManagerInfo = GenerateImageExec(strImage, strExts, strAdditional, typeAdditional, oleData);
 if (!oImageManagerInfo.sFilepathAdditional.empty())  { smart\_ptr<OOX::Media> mediaFile = additionalFile.smart\_dynamic\_cast<OOX::Media>(); if (mediaFile.IsInit()) { mediaFile->set\_filename(oImageManagerInfo.sFilepathAdditional, false); } }  if (strBase64Image.empty()) m\_mapImages[strInput] = oImageManagerInfo; else m\_mapImages [strBase64Image] = oImageManagerInfo; return oImageManagerInfo; } bool CImageManager2::WriteOleData(const std::wstring& sFilePath, const std::wstring& sData) { bool bRes = false; //EncodingMode.unparsed https://github.com/tonyqus/npoi/blob/master/main/POIFS/FileSystem/Ole10Native.cs POLE::Storage oStorage(sFilePath.c\_str()); if(oStorage.open(true, true)) { //CompObj Stream BYTE dataCompObj[] = {0x01,0x00,0xfe,0xff,0x03,0x0a,0x00,0x00,0xff,0xff,0xff,0xff,0x0c,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x0c,0x00,0x00,0x00,0x4f,0x4c,0x45,0x20,0x50,0x61,0x63,0x6b,0x61,0x67,0x65,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x50,0x61,0x63,0x6b,0x61,0x67,0x65,0x00,0xf4,0x39,0xb2,0x71,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}; POLE::Stream oStream1(&oStorage, L"\001CompObj", true, arraysize(dataCompObj)); oStream1.write(dataCompObj, arraysize(dataCompObj)); oStream1.flush(); //ObjInfo Stream BYTE dataObjInfo[] = {0x00,0x00,0x03,0x00,0x0d,0x00}; POLE::Stream oStream2(&oStorage, L"\003ObjInfo", true, arraysize(dataObjInfo)); oStream2.write(dataObjInfo, arraysize(dataObjInfo)); oStream2.flush(); //Ole10Native Stream std::string sDataUtf8 = NSFile::CUtf8Converter::GetUtf8StringFromUnicode2(sData.c\_str(), (LONG)sData.size()); BYTE head[] = {0x00,0x00,0x00,0x00}; //LittleEndian  unsigned char\* aData = (unsigned char\*)sDataUtf8.c\_str();  \_UINT32 nDataSize = (\_UINT32)sDataUtf8.size();
 memcpy(head, &nDataSize, sizeof(\_UINT32));
 POLE::Stream oStream(&oStorage, L"\001Ole10Native", true, arraysize(head) + nDataSize); oStream.write(head, arraysize(head)); oStream.write(aData, nDataSize); oStream.flush();
 oStorage.close(); bRes = true; } return bRes; } \_imageManager2Info CImageManager2::GenerateMediaExec(const std::wstring& strInput) { OOX::CPath oPathOutput; \_imageManager2Info oImageManagerInfo;  std::wstring strExts; std::wstring strMedia = L"media" + std::to\_wstring(++m\_lIndexNextImage);  int pos = (int)strInput.rfind(L"."); if (pos >= 0)  { strExts = strInput.substr(pos); m\_pContentTypes->AddDefault(strExts.substr(1)); }
 oPathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strMedia + strExts;
 if (oPathOutput.GetPath() != strInput && NSFile::CFileBinary::Exists(strInput)) { NSFile::CFileBinary::Copy(strInput, oPathOutput.GetPath()); oImageManagerInfo.sFilepathImage = oPathOutput.GetPath(); } return oImageManagerInfo; } \_imageManager2Info CImageManager2::GenerateImageExec(const std::wstring& strInput, const std::wstring& sExts, const std::wstring& strAdditionalImage, int nAdditionalType, const std::wstring& oleData) { OOX::CPath oPathOutput; \_imageManager2Info oImageManagerInfo;  std::wstring strExts = sExts; std::wstring strImage = L"image" + std::to\_wstring(++m\_lIndexNextImage);  if ((\_T(".jpg") == strExts) || (\_T(".jpeg") == strExts) || (\_T(".png") == strExts) || (\_T(".emf") == strExts) || (\_T(".wmf") == strExts)) { oPathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strImage + strExts;
 if (oPathOutput.GetPath() != strInput && NSFile::CFileBinary::Exists(strInput)) { NSFile::CFileBinary::Copy(strInput, oPathOutput.GetPath()); oImageManagerInfo.sFilepathImage = oPathOutput.GetPath(); } } else { // content types!!! strExts = \_T(".png"); oPathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strImage + strExts; SaveImageAsPng(strInput, oPathOutput.GetPath()); oImageManagerInfo.sFilepathImage = oPathOutput.GetPath(); }   if ((!strAdditionalImage.empty() || !oleData.empty() ) && (nAdditionalType == 1)) { std::wstring strAdditionalExt = L".bin";
 int pos = (int)strAdditionalImage.rfind(L"."); if (pos >= 0) strAdditionalExt = strAdditionalImage.substr(pos);
 std::wstring strImageAdditional = L"oleObject" + std::to\_wstring(++m\_lIndexCounter) + strAdditionalExt;  OOX::CPath pathOutput = m\_strDstEmbed + FILE\_SEPARATOR\_STR + strImageAdditional;  std::wstring strAdditionalImageOut = pathOutput.GetPath();  if(!oleData.empty()) { WriteOleData(strAdditionalImageOut, oleData); oImageManagerInfo.sFilepathAdditional = strAdditionalImageOut; } else if (NSFile::CFileBinary::Exists(strAdditionalImage)) { NSFile::CFileBinary::Copy(strAdditionalImage, strAdditionalImageOut); oImageManagerInfo.sFilepathAdditional = strAdditionalImageOut; }
 } else if (!strAdditionalImage.empty() && nAdditionalType == 2) {  std::wstring strAdditionalExt;
 int pos = (int)strAdditionalImage.rfind(L"."); if (pos >= 0) strAdditionalExt = strAdditionalImage.substr(pos);
 std::wstring strImageAdditional = L"media" + std::to\_wstring(++m\_lIndexCounter) + strAdditionalExt;  OOX::CPath pathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strImageAdditional;  std::wstring strAdditionalImageOut = pathOutput.GetPath();
 if (NSFile::CFileBinary::Exists(strAdditionalImage)) { NSFile::CFileBinary::Copy(strAdditionalImage, strAdditionalImageOut); oImageManagerInfo.sFilepathAdditional = strAdditionalImageOut; } }
 return oImageManagerInfo; } void CImageManager2::SaveImageAsPng(const std::wstring& strFileSrc, const std::wstring& strFileDst) { CBgraFrame oBgraFrame; if(oBgraFrame.OpenFile(strFileSrc)) oBgraFrame.SaveFile(strFileDst, \_CXIMAGE\_FORMAT\_PNG); }
 void CImageManager2::SaveImageAsJPG(const std::wstring& strFileSrc, const std::wstring& strFileDst) { CBgraFrame oBgraFrame; if(oBgraFrame.OpenFile(strFileSrc)) oBgraFrame.SaveFile(strFileDst, \_CXIMAGE\_FORMAT\_JPG); }
 bool CImageManager2::IsNeedDownload(const std::wstring& strFile) { size\_t n1 = strFile.find(\_T("www")); size\_t n2 = strFile.find(\_T("http")); size\_t n3 = strFile.find(\_T("ftp")); size\_t n4 = strFile.find(\_T("https://"));
 //если nI сранивать не с 0, то будут проблемы //потому что в инсталяции мы кладем файлы в /var/www... if (0 == n1 || 0 == n2 || 0 == n3 || 0 == n4) return true; return false; } \_imageManager2Info CImageManager2::DownloadImage(const std::wstring& strUrl) { std::map<std::wstring, \_imageManager2Info>::const\_iterator pPair = m\_mapImages.find (strUrl);
 if (pPair != m\_mapImages.end()) return pPair->second;
 std::wstring strExts = \_T(".jpg"); int nIndexExt = (int)strUrl.rfind(wchar\_t('.')); if (-1 != nIndexExt) strExts = strUrl.substr(nIndexExt);
 std::wstring strImage;  int nDisplayType = IsDisplayedImage(strUrl);  if(0 != nDisplayType) { std::wstring strInputMetafile = strUrl.substr(0, strUrl.length() - strExts.length()); std::wstring sDownloadRes;
 if(0 != (nDisplayType & 1)) { strImage = DownloadImageExec(strInputMetafile + \_T(".wmf")); strExts = \_T(".wmf"); } else if(0 != (nDisplayType & 2)) { strImage = DownloadImageExec(strInputMetafile + \_T(".emf")); strExts = \_T(".emf"); } else { strImage = DownloadImageExec(strUrl); } } else { strImage = DownloadImageExec(strUrl); }
 if (!strExts.empty()) { m\_pContentTypes->AddDefault(strExts.substr(1)); }
 \_imageManager2Info oImageManagerInfo; if (!strImage.empty()) { oImageManagerInfo = GenerateImageExec(strImage, strExts, L"", 0, L""); CDirectory::DeleteFile(strImage); }
 m\_mapImages[strUrl] = oImageManagerInfo; return oImageManagerInfo; } std::wstring CImageManager2::DownloadImageExec(const std::wstring& strFile) {#ifndef DISABLE\_FILE\_DOWNLOADER CFileDownloader oDownloader(strFile, false);
 if ( oDownloader.DownloadSync() ) { return oDownloader.GetFilePath(); }#endif return \_T(""); }
 CBinaryFileWriter::CSeekTableEntry::CSeekTableEntry() { Type = 0; SeekPos = 0; } BYTE\* CBinaryFileWriter::GetBuffer() { return m\_pStreamData; } \_UINT32 CBinaryFileWriter::GetPosition() { return m\_lPosition; } void CBinaryFileWriter::SetPosition(const \_UINT32& lPosition) { m\_lPosition = lPosition; m\_pStreamCur = m\_pStreamData + m\_lPosition; } void CBinaryFileWriter::Skip(const \_UINT32& lSize) { CheckBufferSize(lSize);
 m\_lPosition += lSize; m\_pStreamCur = m\_pStreamData + m\_lPosition; } double CBinaryFileWriter::GetShapeHeight() { if (m\_lCyCurShape == 0) return -1; return (double)m\_lCyCurShape / 36000; //mm } double CBinaryFileWriter::GetShapeWidth() { if (m\_lCyCurShape == 0) return -1; return (double)m\_lCxCurShape / 36000; } double CBinaryFileWriter::GetShapeY() { return (double)m\_lYCurShape / 36000; } double CBinaryFileWriter::GetShapeX() { return (double)m\_lXCurShape / 36000; //mm } void CBinaryFileWriter::ClearCurShapePositionAndSizes() { m\_lXCurShape = 0; m\_lYCurShape = 0;  m\_lCxCurShape = 0; m\_lCyCurShape = 0; } void CBinaryFileWriter::Clear() { m\_lSize = 0; m\_lPosition = 0;
 m\_pStreamData = NULL; m\_pStreamCur = NULL;
 m\_lStackPosition = 0; memset(m\_arStack, 0, MAX\_STACK\_SIZE \* sizeof(\_UINT32));
 m\_lCxCurShape = 0; m\_lCyCurShape = 0;
 m\_lXCurShape = 0; m\_lYCurShape = 0; }
 void CBinaryFileWriter::SetMainDocument(BinDocxRW::CDocxSerializer\* pMainDoc) { m\_pMainDocument = pMainDoc; }
 void CBinaryFileWriter::ClearNoAttack() { m\_lPosition = 0; m\_pStreamCur = m\_pStreamData;
 m\_lStackPosition = 0; memset(m\_arStack, 0, MAX\_STACK\_SIZE \* sizeof(\_UINT32)); }
 void CBinaryFileWriter::CheckBufferSize(\_UINT32 lPlus) { if (NULL != m\_pStreamData) { size\_t nNewSize = m\_lPosition + lPlus;
 if (nNewSize >= m\_lSize) { while (nNewSize >= m\_lSize) { m\_lSize \*= 2; }
 BYTE\* pNew = new BYTE[m\_lSize]; memcpy(pNew, m\_pStreamData, m\_lPosition);
 RELEASEARRAYOBJECTS(m\_pStreamData); m\_pStreamData = pNew;
 m\_pStreamCur = m\_pStreamData + m\_lPosition; } } else { m\_lSize = 1024 \* 1024; // 1Mb m\_pStreamData = new BYTE[m\_lSize];
 m\_lPosition = 0; m\_pStreamCur = m\_pStreamData;
 CheckBufferSize(lPlus); } }
 void CBinaryFileWriter::WriteBYTE(const BYTE& lValue) {  CheckBufferSize(BYTE\_SIZEOF);
 \*m\_pStreamCur = lValue;  m\_lPosition += BYTE\_SIZEOF; m\_pStreamCur += BYTE\_SIZEOF; } void CBinaryFileWriter::WriteSBYTE(const signed char& lValue) { CheckBufferSize(BYTE\_SIZEOF);
 if (lValue < 0) \*m\_pStreamCur = (lValue + 256); else \*m\_pStreamCur = lValue; m\_lPosition += BYTE\_SIZEOF; m\_pStreamCur += BYTE\_SIZEOF; } void CBinaryFileWriter::WriteBOOL(const bool& bValue) {  WriteBYTE((bValue == true) ? 1 : 0); } void CBinaryFileWriter::WriteUSHORT(const \_UINT16& lValue) { CheckBufferSize(UINT16\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_UINT16));#else \*((\_UINT16\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += UINT16\_SIZEOF; m\_pStreamCur += UINT16\_SIZEOF; } void CBinaryFileWriter::WriteSHORT(const \_INT16& lValue) { CheckBufferSize(INT16\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT16));#else \*((\_INT16\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT16\_SIZEOF; m\_pStreamCur += INT16\_SIZEOF; } void CBinaryFileWriter::WriteULONG(const \_UINT32& lValue) { CheckBufferSize(UINT32\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_UINT32));#else \*((\_UINT32\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += UINT32\_SIZEOF; m\_pStreamCur += UINT32\_SIZEOF; } void CBinaryFileWriter::WriteLONG(const \_INT32& lValue) { CheckBufferSize(INT32\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT32));#else \*((\_INT32\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT32\_SIZEOF; m\_pStreamCur += INT32\_SIZEOF; } void CBinaryFileWriter::WriteLONG64(const \_INT64& lValue) { CheckBufferSize(INT64\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT64));#else \*((\_INT64\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT64\_SIZEOF; m\_pStreamCur += INT64\_SIZEOF; } void CBinaryFileWriter::WriteINT(const \_INT32& lValue) { CheckBufferSize(INT32\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT32));#else \*((\_INT32\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT32\_SIZEOF; m\_pStreamCur += INT32\_SIZEOF; } void CBinaryFileWriter::WriteDouble64(const double& dValue) { \_INT64 \_val = (\_INT64)(dValue \* 100000); WriteLONG64(\_val); } void CBinaryFileWriter::WriteDouble(const double& dValue) { \_INT64 \_val = (\_INT64)(dValue \* 100000);
 if (\_val > 0x7fffffff) { WriteLONG(0x7fffffff); } else if ( \_val < -0x7fffffff) { WriteLONG(-0x7fffffff); }  else { WriteLONG((long)\_val); } } void CBinaryFileWriter::WriteDoubleReal(const double& dValue) { CheckBufferSize(DOUBLE\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &dValue, sizeof(double));#else \*((double\*)m\_pStreamCur) = dValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += DOUBLE\_SIZEOF; m\_pStreamCur += DOUBLE\_SIZEOF; } void CBinaryFileWriter::WriteBYTEArray(const BYTE\* pBuffer, size\_t len) { CheckBufferSize((\_UINT32)len); memcpy(m\_pStreamCur, pBuffer, len); m\_lPosition += (\_UINT32)len; m\_pStreamCur += len; } void CBinaryFileWriter::WriteStringA(std::string& sBuffer) { \_UINT32 lSize = (\_UINT32)sBuffer.length(); \_UINT32 lSizeMem = lSize \* sizeof(char);
 CheckBufferSize(UINT32\_SIZEOF + lSizeMem);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lSizeMem, sizeof(\_UINT32));#else \*((\_UINT32\*)m\_pStreamCur) = lSizeMem; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += UINT32\_SIZEOF; m\_pStreamCur += UINT32\_SIZEOF;
 memcpy(m\_pStreamCur, sBuffer.c\_str(), lSizeMem);  m\_lPosition += lSizeMem; m\_pStreamCur += lSizeMem; } void CBinaryFileWriter::WriteStringW(std::wstring& sBuffer) { \_WriteStringWithLength(sBuffer.c\_str(), (\_UINT32)sBuffer.length(), true); } void CBinaryFileWriter::WriteStringW(const std::wstring& sBuffer) { \_WriteStringWithLength(sBuffer.c\_str(), (\_UINT32)sBuffer.length(), true); } void CBinaryFileWriter::WriteStringW2(std::wstring& sBuffer) { \_WriteStringWithLength(sBuffer.c\_str(), (\_UINT32)sBuffer.length(), false); } void CBinaryFileWriter::WriteStringW3(std::wstring& sBuffer) { \_WriteString(sBuffer.c\_str(), (\_UINT32)sBuffer.length()); } void CBinaryFileWriter::WriteStringW3(const std::wstring& sBuffer) { \_WriteString(sBuffer.c\_str(), (\_UINT32)sBuffer.length()); } void CBinaryFileWriter::WriteStringW4(const std::wstring& sBuffer) { \_WriteString(sBuffer.c\_str(), (\_UINT32)sBuffer.length()); } void CBinaryFileWriter::WriteStringUtf8(const std::wstring& sBuffer) { BYTE\* pData = NULL; LONG lLen = 0;
 NSFile::CUtf8Converter::GetUtf8StringFromUnicode(sBuffer.c\_str(), (LONG)sBuffer.length(), pData, lLen, false);
 WriteBYTEArray(pData, lLen);
 RELEASEARRAYOBJECTS(pData); } CBinaryFileWriter::CBinaryFileWriter() { m\_pMainDocument = NULL; m\_pCommon = new CCommonWriter(); //m\_pCommonRels = new NSCommon::smart\_ptr<PPTX::CCommonRels>(); m\_pCurrentContainer = new NSCommon::smart\_ptr<OOX::IFileContainer>(); m\_pTheme = new NSCommon::smart\_ptr<PPTX::Theme>(); m\_pClrMap = new NSCommon::smart\_ptr<PPTX::Logic::ClrMap>();  Clear(); } CBinaryFileWriter::~CBinaryFileWriter() { RELEASEARRAYOBJECTS (m\_pStreamData); RELEASEOBJECT (m\_pCommon); //RELEASEOBJECT (m\_pCommonRels); RELEASEOBJECT (m\_pCurrentContainer);  RELEASEOBJECT (m\_pTheme); RELEASEOBJECT (m\_pClrMap); }
 void CBinaryFileWriter::StartRecord(\_INT32 lType) { m\_arStack[m\_lStackPosition] = m\_lPosition + 5; // sizeof(BYTE) + sizeof(\_UINT32) m\_lStackPosition++; WriteBYTE((BYTE)lType); WriteULONG(0); } void CBinaryFileWriter::EndRecord() { m\_lStackPosition--;
 \_UINT32 size\_record = m\_lPosition - m\_arStack[m\_lStackPosition]; (\*(\_UINT32\*)(m\_pStreamData + m\_arStack[m\_lStackPosition] - 4)) = size\_record ; }
 void CBinaryFileWriter::StartMainRecord(\_INT32 lType) { CSeekTableEntry oEntry; oEntry.Type = lType; oEntry.SeekPos = m\_lPosition; m\_arMainTables.push\_back(oEntry); //StartRecord(lType); }
 void CBinaryFileWriter::WriteReserved(size\_t lCount) { CheckBufferSize((\_UINT32)lCount); memset(m\_pStreamCur, 0, lCount); m\_pStreamCur += lCount; m\_lPosition += (\_UINT32)lCount; }
 void CBinaryFileWriter::WriteMainPart(\_UINT32 nStartPos) { BYTE\* pData = m\_pStreamData + nStartPos; size\_t nCount = m\_arMainTables.size();
 for (size\_t i = 0; i < nCount; i++) { \*pData = (BYTE)m\_arMainTables[i].Type; ++pData;#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(pData, &m\_arMainTables[i].SeekPos, sizeof(\_INT32));#else \*((\_INT32\*)pData) = m\_arMainTables[i].SeekPos; // EXC\_ARM\_DA\_ALIGN on ios#endif pData += 4; } }
 void CBinaryFileWriter::WriteString1(int type, const std::wstring& val) { BYTE bType = (BYTE)type; WriteBYTE(bType);
 std::wstring\* s = const\_cast<std::wstring\*>(&val); \_WriteStringWithLength(s->c\_str(), (\_UINT32)s->length(), false); } void CBinaryFileWriter::WriteString2(int type, const NSCommon::nullable\_string& val) { if (val.is\_init()) WriteString1(type, \*val); } void CBinaryFileWriter::WriteString(const std::wstring& val) { std::wstring\* s = const\_cast<std::wstring\*>(&val); \_WriteStringWithLength(s->c\_str(), (\_UINT32)s->length(), false); }
 void CBinaryFileWriter::WriteStringData(const WCHAR\* pData, \_UINT32 len) { \_WriteStringWithLength(pData, len, false); }
 void CBinaryFileWriter::WriteString1Data(int type, const WCHAR\* pData, \_UINT32 len) { BYTE bType = (BYTE)type; WriteBYTE(bType);
 \_WriteStringWithLength(pData, len, false); }
 void CBinaryFileWriter::WriteBool1(int type, const bool& val) { BYTE bType = (BYTE)type; WriteBYTE(bType); WriteBYTE((val == true) ? 1 : 0); } void CBinaryFileWriter::WriteBool2(int type, const NSCommon::nullable\_bool& val) { if (val.is\_init()) WriteBool1(type, \*val); }
 void CBinaryFileWriter::WriteInt1(int type, const int& val) { BYTE bType = (BYTE)type; WriteBYTE(bType); WriteINT(val); }[View remainder of file in raw view](https://github.com/ONLYOFFICE/core/raw/refs/tags/v5.6.4.13/ASCOfficePPTXFile/Editor/BinaryFileReaderWriter.cpp)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_61a30c32_20250115_083549.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2FDocumentServer)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2FDocumentServer)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ONLYOFFICE%2FDocumentServer)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[DocumentServer](/ONLYOFFICE/DocumentServer)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2FDocumentServer) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FONLYOFFICE%2FDocumentServer)
* [Star
   5k](/login?return_to=%2FONLYOFFICE%2FDocumentServer)

ONLYOFFICE Docs is a free collaborative online office suite comprising viewers and editors for texts, spreadsheets and presentations, forms and PDF, fully compatible with Office Open XML formats: .docx, .xlsx, .pptx and enabling collaborative editing in real time.

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### License

[AGPL-3.0 license](/ONLYOFFICE/DocumentServer/blob/master/LICENSE.txt)

[5k
stars](/ONLYOFFICE/DocumentServer/stargazers) [1.1k
forks](/ONLYOFFICE/DocumentServer/forks) [Branches](/ONLYOFFICE/DocumentServer/branches) [Tags](/ONLYOFFICE/DocumentServer/tags) [Activity](/ONLYOFFICE/DocumentServer/activity)
 [Star](/login?return_to=%2FONLYOFFICE%2FDocumentServer)

 [Notifications](/login?return_to=%2FONLYOFFICE%2FDocumentServer) You must be signed in to change notification settings

* [Code](/ONLYOFFICE/DocumentServer)
* [Issues
  921](/ONLYOFFICE/DocumentServer/issues)
* [Pull requests
  1](/ONLYOFFICE/DocumentServer/pulls)
* [Discussions](/ONLYOFFICE/DocumentServer/discussions)
* [Actions](/ONLYOFFICE/DocumentServer/actions)
* [Wiki](/ONLYOFFICE/DocumentServer/wiki)
* [Security](/ONLYOFFICE/DocumentServer/security)
* [Insights](/ONLYOFFICE/DocumentServer/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/DocumentServer)
* [Issues](/ONLYOFFICE/DocumentServer/issues)
* [Pull requests](/ONLYOFFICE/DocumentServer/pulls)
* [Discussions](/ONLYOFFICE/DocumentServer/discussions)
* [Actions](/ONLYOFFICE/DocumentServer/actions)
* [Wiki](/ONLYOFFICE/DocumentServer/wiki)
* [Security](/ONLYOFFICE/DocumentServer/security)
* [Insights](/ONLYOFFICE/DocumentServer/pulse)

# ONLYOFFICE/DocumentServer

    master[Branches](/ONLYOFFICE/DocumentServer/branches)[Tags](/ONLYOFFICE/DocumentServer/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[492 Commits](/ONLYOFFICE/DocumentServer/commits/master/) | | |
| [.github](/ONLYOFFICE/DocumentServer/tree/master/.github ".github") | | [.github](/ONLYOFFICE/DocumentServer/tree/master/.github ".github") |  |  |
| [core @ 029e6c6](/ONLYOFFICE/core/tree/029e6c6df762cc84a0597033e47411c2563ab37f "core") | | [core @ 029e6c6](/ONLYOFFICE/core/tree/029e6c6df762cc84a0597033e47411c2563ab37f "core") |  |  |
| [core-fonts @ d5d80e6](/ONLYOFFICE/core-fonts/tree/d5d80e6ae15800ccf31e1c4dbb1ae3385992e0c2 "core-fonts") | | [core-fonts @ d5d80e6](/ONLYOFFICE/core-fonts/tree/d5d80e6ae15800ccf31e1c4dbb1ae3385992e0c2 "core-fonts") |  |  |
| [dictionaries @ 25e1e98](/ONLYOFFICE/dictionaries/tree/25e1e985e4cc71be39812a120a14b6f07095266d "dictionaries") | | [dictionaries @ 25e1e98](/ONLYOFFICE/dictionaries/tree/25e1e985e4cc71be39812a120a14b6f07095266d "dictionaries") |  |  |
| [sdkjs @ e37d97e](/ONLYOFFICE/sdkjs/tree/e37d97e2810d0e6b19f41a7f989f279fb566943d "sdkjs") | | [sdkjs @ e37d97e](/ONLYOFFICE/sdkjs/tree/e37d97e2810d0e6b19f41a7f989f279fb566943d "sdkjs") |  |  |
| [server @ 03f49f8](/ONLYOFFICE/server/tree/03f49f8e954a9b76736cb62ecf970d916d135ba5 "server") | | [server @ 03f49f8](/ONLYOFFICE/server/tree/03f49f8e954a9b76736cb62ecf970d916d135ba5 "server") |  |  |
| [web-apps @ e6e56e8](/ONLYOFFICE/web-apps/tree/e6e56e8a5ebafad8e730eaec67595d9b8a848f03 "web-apps") | | [web-apps @ e6e56e8](/ONLYOFFICE/web-apps/tree/e6e56e8a5ebafad8e730eaec67595d9b8a848f03 "web-apps") |  |  |
| [.aspell.en.pws](/ONLYOFFICE/DocumentServer/blob/master/.aspell.en.pws ".aspell.en.pws") | | [.aspell.en.pws](/ONLYOFFICE/DocumentServer/blob/master/.aspell.en.pws ".aspell.en.pws") |  |  |
| [.gitmodules](/ONLYOFFICE/DocumentServer/blob/master/.gitmodules ".gitmodules") | | [.gitmodules](/ONLYOFFICE/DocumentServer/blob/master/.gitmodules ".gitmodules") |  |  |
| [.markdownlint.json](/ONLYOFFICE/DocumentServer/blob/master/.markdownlint.json ".markdownlint.json") | | [.markdownlint.json](/ONLYOFFICE/DocumentServer/blob/master/.markdownlint.json ".markdownlint.json") |  |  |
| [.mrconfig](/ONLYOFFICE/DocumentServer/blob/master/.mrconfig ".mrconfig") | | [.mrconfig](/ONLYOFFICE/DocumentServer/blob/master/.mrconfig ".mrconfig") |  |  |
| [CHANGELOG.md](/ONLYOFFICE/DocumentServer/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/ONLYOFFICE/DocumentServer/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [LICENSE.txt](/ONLYOFFICE/DocumentServer/blob/master/LICENSE.txt "LICENSE.txt") | | [LICENSE.txt](/ONLYOFFICE/DocumentServer/blob/master/LICENSE.txt "LICENSE.txt") |  |  |
| [ROADMAP.md](/ONLYOFFICE/DocumentServer/blob/master/ROADMAP.md "ROADMAP.md") | | [ROADMAP.md](/ONLYOFFICE/DocumentServer/blob/master/ROADMAP.md "ROADMAP.md") |  |  |
| [Readme.md](/ONLYOFFICE/DocumentServer/blob/master/Readme.md "Readme.md") | | [Readme.md](/ONLYOFFICE/DocumentServer/blob/master/Readme.md "Readme.md") |  |  |
| [mr-update.sh](/ONLYOFFICE/DocumentServer/blob/master/mr-update.sh "mr-update.sh") | | [mr-update.sh](/ONLYOFFICE/DocumentServer/blob/master/mr-update.sh "mr-update.sh") |  |  |
| View all files | | |

## Repository files navigation

* README
* AGPL-3.0 license

[![License](https://camo.githubusercontent.com/1720e1c42dd5a9a5cfaed3a4abec210e929921fa9271e404263661daf3c7905b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d474e552532304147504c25323056332d677265656e2e7376673f7374796c653d666c6174)](https://www.gnu.org/licenses/agpl-3.0.en.html) [![Release](https://camo.githubusercontent.com/ddb8bd81a4d6fc7401d08bb36c122c29e3e0a2674f9db7b305bbc96123478f9d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f52656c656173652d76382e312e312d626c75652e7376673f7374796c653d666c6174)](https://camo.githubusercontent.com/ddb8bd81a4d6fc7401d08bb36c122c29e3e0a2674f9db7b305bbc96123478f9d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f52656c656173652d76382e312e312d626c75652e7376673f7374796c653d666c6174)

## Overview

[ONLYOFFICE Docs](https://www.onlyoffice.com/office-suite.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS)\* is a free collaborative online office suite comprising viewers and editors for texts, spreadsheets and presentations, forms and PDF, fully compatible with Office Open XML formats: .docx, .xlsx, .pptx and enabling collaborative editing in real time.

ONLYOFFICE Docs can be used as a part of [ONLYOFFICE Workspace](https://www.onlyoffice.com/workspace.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubCS) or with [third-party sync&share solutions](https://www.onlyoffice.com/all-connectors.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS) (e.g. Nextcloud, ownCloud, Seafile) to enable collaborative editing within their interface.

It has three editions - [Community, Enterprise, and Developer](#onlyoffice-docs-editions).

\* Starting from version 6.0, Document Server is distributed under a new name - ONLYOFFICE Docs.

## Components

ONLYOFFICE Docs contains the following components:

* [server](https://github.com/ONLYOFFICE/server) - the backend server software layer which is the base for all other components of ONLYOFFICE Docs.
* [core](https://github.com/ONLYOFFICE/core) - server core components of ONLYOFFICE Docs which enable the conversion between the most popular office document formats (DOC, DOCX, ODT, RTF, TXT, PDF, HTML, EPUB, XPS, DjVu, XLS, XLSX, ODS, CSV, PPT, PPTX, ODP).
* [sdkjs](https://github.com/ONLYOFFICE/sdkjs) - JavaScript SDK for the ONLYOFFICE Docs which contains API for all the included components client-side interaction.
* [web-apps](https://github.com/ONLYOFFICE/web-apps) - the frontend for ONLYOFFICE Docs which builds the program interface and allows the user create, edit, save and export text, spreadsheet and presentation documents using the common interface of a document editor.
* [dictionaries](https://github.com/ONLYOFFICE/dictionaries) - the dictionaries of various languages used for spellchecking in ONLYOFFICE Docs.

## Plugins

ONLYOFFICE Docs offer support for plugins allowing developers to add specific features to the editors that are not directly related to the OOXML format. For more information see [our API](https://api.onlyoffice.com/plugin/basic) or visit github [plugins repo](https://github.com/ONLYOFFICE/onlyoffice.github.io).

## Functionality

ONLYOFFICE Docs includes the following editors:

* [ONLYOFFICE Document Editor](https://www.onlyoffice.com/document-editor.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE Spreadsheet Editor](https://www.onlyoffice.com/spreadsheet-editor.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE Presentation Editor](https://www.onlyoffice.com/presentation-editor.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE Form Creator](https://www.onlyoffice.com/form-creator.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE PDF editor, reader & converter](https://www.onlyoffice.com/pdf-reader.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)

The editors allow you to create, edit, save and export text, spreadsheet and presentation documents and additionally have the features:

* Collaborative editing
* Hieroglyph support
* Reviewing
* Spell-checking

## ONLYOFFICE Docs editions

ONLYOFFICE offers different versions of its online document editors that can be deployed on your own servers.

ONLYOFFICE Docs (packaged as Document Server):

* Community Edition (`onlyoffice-documentserver` package)
* Enterprise Edition (`onlyoffice-documentserver-ee` package)
* Developer Edition (`onlyoffice-documentserver-de` package)

The table below will help you to make the right choice.

| Pricing and licensing | Community Edition | Enterprise Edition | Developer Edition |
| --- | --- | --- | --- |
|  | [Get it now](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-community) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-enterprise) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-developer) |
| Cost | FREE | [Go to the pricing page](https://www.onlyoffice.com/docs-enterprise-prices.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS) | [Go to the pricing page](https://www.onlyoffice.com/developer-edition-prices.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS) |
| Simultaneous connections | up to 20 maximum | As in chosen pricing plan | As in chosen pricing plan |
| Number of users | up to 20 recommended | As in chosen pricing plan | As in chosen pricing plan |
| Clusterization | - | + | + |
| License | GNU AGPL v.3 | Proprietary | Proprietary |
| **Support** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Documentation | [Help Center](https://helpcenter.onlyoffice.com/installation/docs-community-index.aspx) | [Help Center](https://helpcenter.onlyoffice.com/installation/docs-enterprise-index.aspx) | [Help Center](https://helpcenter.onlyoffice.com/installation/docs-developer-index.aspx) |
| Standard support | [GitHub](https://github.com/ONLYOFFICE/DocumentServer/issues) or paid | One year support included | One year support included |
| Premium support | Contact Us | Contact Us | Contact Us |
| **Services** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Conversion Service | + | + | + |
| Document Builder Service | + | + | + |
| **Interface** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Tabbed interface | + | + | + |
| Dark theme | + | + | + |
| 125%, 150%, 175%, 200% scaling | + | + | + |
| White label | - | - | + |
| Integrated test example (node.js) | + | + | + |
| Mobile web editors | - | +\*\* | +\*\* |
| **Plugins & Macros** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Plugins | + | + | + |
| Macros | + | + | + |
| **Collaborative capabilities** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Two co-editing modes | + | + | + |
| Comments | + | + | + |
| Built-in chat | + | + | + |
| Review and tracking changes | + | + | + |
| Display modes of tracking changes | + | + | + |
| Version history | + | + | + |
| **Document Editor features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Font and paragraph formatting | + | + | + |
| Object insertion | + | + | + |
| Adding Content control | + | + | + |
| Editing Content control | + | + | + |
| Layout tools | + | + | + |
| Table of contents | + | + | + |
| Navigation panel | + | + | + |
| Mail Merge | + | + | + |
| Comparing Documents | + | + | + |
| **Spreadsheet Editor features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Font and paragraph formatting | + | + | + |
| Object insertion | + | + | + |
| Functions, formulas, equations | + | + | + |
| Table templates | + | + | + |
| Pivot tables | + | + | + |
| Data validation | + | + | + |
| Conditional formatting | + | + | + |
| Sparklines | + | + | + |
| Sheet Views | + | + | + |
| **Presentation Editor features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Font and paragraph formatting | + | + | + |
| Object insertion | + | + | + |
| Transitions | + | + | + |
| Animations | + | + | + |
| Presenter mode | + | + | + |
| Notes | + | + | + |
| **Form creator features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Adding form fields | + | + | + |
| Form preview | + | + | + |
| Saving as PDF | + | + | + |
| **Working with PDF** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Text annotations (highlight, underline, cross out) | + | + | + |
| Comments | + | + | + |
| Freehand drawings | + | + | + |
| Form filling | + | + | + |
| **Security features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| End-to-end encryption via Private Rooms\*\*\* | + | + | - |
|  | [Get it now](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-community) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-enterprise) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-developer) |

\*\* If supported by DMS

\*\*\* End-to-end encryption via Private Rooms requires ONLYOFFICE Workspace

## How to Install on a local server

The easiest way to install ONLYOFFICE Docs is to use **the Docker image** ([the official source code](https://github.com/ONLYOFFICE/Docker-DocumentServer))

* [Installing ONLYOFFICE Docs Docker](https://helpcenter.onlyoffice.com/installation/docs-community-install-docker.aspx)
* [Installing ONLYOFFICE Docs for Linux](https://helpcenter.onlyoffice.com/installation/docs-community-install-ubuntu.aspx)
* [Installing ONLYOFFICE Docs for Windows](https://helpcenter.onlyoffice.com/installation/docs-community-install-windows.aspx)

## How to Build

Instructions for building ONLYOFFICE Docs for a local server from source code are in [our helpcenter](https://helpcenter.onlyoffice.com/installation/docs-community-compile.aspx).

## License

ONLYOFFICE Docs is licensed under the GNU Affero Public License, version 3.0. See [LICENSE](https://onlyo.co/38YZGJh) for more information.

## User Feedback and Support

If you have any problems with or questions about ONLYOFFICE Docs, please visit our official forum to find answers to your questions: [forum.onlyoffice.com](https://forum.onlyoffice.com) or you can ask and answer ONLYOFFICE development questions on [Stack Overflow](https://stackoverflow.com/questions/tagged/onlyoffice).

## About

ONLYOFFICE Docs is a free collaborative online office suite comprising viewers and editors for texts, spreadsheets and presentations, forms and PDF, fully compatible with Office Open XML formats: .docx, .xlsx, .pptx and enabling collaborative editing in real time.

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### Topics

[nodejs](/topics/nodejs "Topic: nodejs")
[node](/topics/node "Topic: node")
[presentation](/topics/presentation "Topic: presentation")
[excel](/topics/excel "Topic: excel")
[word](/topics/word "Topic: word")
[xlsx](/topics/xlsx "Topic: xlsx")
[xls](/topics/xls "Topic: xls")
[spreadsheet](/topics/spreadsheet "Topic: spreadsheet")
[collaboration](/topics/collaboration "Topic: collaboration")
[office](/topics/office "Topic: office")
[docx](/topics/docx "Topic: docx")
[node-js](/topics/node-js "Topic: node-js")
[pptx](/topics/pptx "Topic: pptx")
[collaborative](/topics/collaborative "Topic: collaborative")
[doc](/topics/doc "Topic: doc")
[ods](/topics/ods "Topic: ods")
[odp](/topics/odp "Topic: odp")
[odt](/topics/odt "Topic: odt")
[ppt](/topics/ppt "Topic: ppt")
[onlyoffice](/topics/onlyoffice "Topic: onlyoffice")

### Resources

[Readme](#readme-ov-file)
### License

[AGPL-3.0 license](#AGPL-3.0-1-ov-file)

[Activity](/ONLYOFFICE/DocumentServer/activity)
[Custom properties](/ONLYOFFICE/DocumentServer/custom-properties)
### Stars

[**5k**
stars](/ONLYOFFICE/DocumentServer/stargazers)
### Watchers

[**175**
watching](/ONLYOFFICE/DocumentServer/watchers)
### Forks

[**1.1k**
forks](/ONLYOFFICE/DocumentServer/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2FDocumentServer&report=ONLYOFFICE+%28user%29)

## [Releases 102](/ONLYOFFICE/DocumentServer/releases)

[ONLYOFFICE-DocumentServer-8.2.2
Latest

Nov 28, 2024](/ONLYOFFICE/DocumentServer/releases/tag/v8.2.2)
[+ 101 releases](/ONLYOFFICE/DocumentServer/releases)

## [Contributors 17](/ONLYOFFICE/DocumentServer/graphs/contributors)

* [![@agolybev](https://avatars.githubusercontent.com/u/8861642?s=64&v=4)](https://github.com/agolybev)
* [![@ShockwaveNN](https://avatars.githubusercontent.com/u/668524?s=64&v=4)](https://github.com/ShockwaveNN)
* [![@trofim24](https://avatars.githubusercontent.com/u/1764789?s=64&v=4)](https://github.com/trofim24)
* [![@DenisDeeSign](https://avatars.githubusercontent.com/u/15816249?s=64&v=4)](https://github.com/DenisDeeSign)
* [![@papacarlo](https://avatars.githubusercontent.com/u/22055467?s=64&v=4)](https://github.com/papacarlo)
* [![@hellonadya](https://avatars.githubusercontent.com/u/29226935?s=64&v=4)](https://github.com/hellonadya)
* [![@github-actions[bot]](https://avatars.githubusercontent.com/in/15368?s=64&v=4)](https://github.com/apps/github-actions)
* [![@svetlana81](https://avatars.githubusercontent.com/u/22791605?s=64&v=4)](https://github.com/svetlana81)
* [![@ivanovnikolay](https://avatars.githubusercontent.com/u/1043943?s=64&v=4)](https://github.com/ivanovnikolay)
* [![@alexeybannov](https://avatars.githubusercontent.com/u/8578518?s=64&v=4)](https://github.com/alexeybannov)
* [![@andrewaeva](https://avatars.githubusercontent.com/u/3368345?s=64&v=4)](https://github.com/andrewaeva)
* [![@heatray](https://avatars.githubusercontent.com/u/5289615?s=64&v=4)](https://github.com/heatray)
* [![@sallakarppinen](https://avatars.githubusercontent.com/u/5364212?s=64&v=4)](https://github.com/sallakarppinen)
* [![@JMoVS](https://avatars.githubusercontent.com/u/7354506?s=64&v=4)](https://github.com/JMoVS)

[+ 3 contributors](/ONLYOFFICE/DocumentServer/graphs/contributors)

## Languages

* [Shell
  100.0%](/ONLYOFFICE/DocumentServer/search?l=shell)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4f940c4f_20250115_083559.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore%2Fblob%2Fv5.6.4.13%2FASCOfficePPTXFile%2FEditor%2FBinaryFileReaderWriter.cpp)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore%2Fblob%2Fv5.6.4.13%2FASCOfficePPTXFile%2FEditor%2FBinaryFileReaderWriter.cpp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ONLYOFFICE%2Fcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[core](/ONLYOFFICE/core)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fcore) You must be signed in to change notification settings
* [Fork
  226](/login?return_to=%2FONLYOFFICE%2Fcore)
* [Star
   295](/login?return_to=%2FONLYOFFICE%2Fcore)

* [Code](/ONLYOFFICE/core/tree/v5.6.4.13)
* [Pull requests
  11](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/core/tree/v5.6.4.13)
* [Pull requests](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

## Files

 v5.6.4.13
## Breadcrumbs

1. [core](/ONLYOFFICE/core/tree/v5.6.4.13)
2. /[ASCOfficePPTXFile](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile)
3. /[Editor](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/Editor)
/
# BinaryFileReaderWriter.cpp

Copy path Blame  Blame
## Latest commit

## History

[History](/ONLYOFFICE/core/commits/v5.6.4.13/ASCOfficePPTXFile/Editor/BinaryFileReaderWriter.cpp)2058 lines (1803 loc) · 61.4 KB v5.6.4.13
## Breadcrumbs

1. [core](/ONLYOFFICE/core/tree/v5.6.4.13)
2. /[ASCOfficePPTXFile](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile)
3. /[Editor](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/Editor)
/
# BinaryFileReaderWriter.cpp

Top
## File metadata and controls

* Code
* Blame

2058 lines (1803 loc) · 61.4 KB[Raw](https://github.com/ONLYOFFICE/core/raw/refs/tags/v5.6.4.13/ASCOfficePPTXFile/Editor/BinaryFileReaderWriter.cpp)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000﻿/\* \* (c) Copyright Ascensio System SIA 2010-2019 \* \* This program is a free software product. You can redistribute it and/or \* modify it under the terms of the GNU Affero General Public License (AGPL) \* version 3 as published by the Free Software Foundation. In accordance with \* Section 7(a) of the GNU AGPL its Section 15 shall be amended to the effect \* that Ascensio System SIA expressly excludes the warranty of non-infringement \* of any third-party rights. \* \* This program is distributed WITHOUT ANY WARRANTY; without even the implied \* warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. For \* details, see the GNU AGPL at: http://www.gnu.org/licenses/agpl-3.0.html \* \* You can contact Ascensio System SIA at 20A-12 Ernesta Birznieka-Upisha \* street, Riga, Latvia, EU, LV-1050. \* \* The interactive user interfaces in modified source and object code versions \* of the Program must display Appropriate Legal Notices, as required under \* Section 5 of the GNU AGPL version 3. \* \* Pursuant to Section 7(b) of the License you must retain the original Product \* logo when distributing the program. Pursuant to Section 7(e) we decline to \* grant you any rights under trademark law for use of our trademarks. \* \* All the Product's GUI elements, including illustrations and icon sets, as \* well as technical writing content are licensed under the terms of the \* Creative Commons Attribution-ShareAlike 4.0 International. See the License \* terms at http://creativecommons.org/licenses/by-sa/4.0/legalcode \* \*/#include "BinaryFileReaderWriter.h"#include "BinReaderWriterDefines.h"
#include "../../Common/DocxFormat/Source/Base/Nullable.h"#include "../../Common/DocxFormat/Source/DocxFormat/WritingElement.h"
#include "../../Common/DocxFormat/Source/DocxFormat/Media/OleObject.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/ActiveX.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/Video.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/Audio.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/VbaProject.h"#include "../../Common/DocxFormat/Source/DocxFormat/Media/JsaProject.h"
#include "../../Common/Base64.h"
#include "./imagemanager.h"#include "./XmlWriter.h"#include "./FontPicker.h"#include "../../ASCOfficeDocxFile2/DocWrapper/DocxSerializer.h"
#include "../../DesktopEditor/common/File.h"#include "../../DesktopEditor/common/Directory.h"#include "../PPTXFormat/FileContainer.h"#include <iostream>
#define BYTE\_SIZEOF sizeof(BYTE)#define UINT16\_SIZEOF sizeof(\_UINT16)#define UINT32\_SIZEOF sizeof(\_UINT32)#define DOUBLE\_SIZEOF sizeof(double)
#define CHAR\_SIZEOF sizeof(CHAR)#define INT16\_SIZEOF sizeof(\_INT16)#define INT32\_SIZEOF sizeof(\_INT32)#define INT64\_SIZEOF sizeof(\_INT64)
#define DOUBLE\_MAIN 10000
#if defined(\_WIN32) || defined (\_WIN64) #include "../../Common/DocxFormat/Source/Base/unicode\_util.h"#endif
namespace NSBinPptxRW{ template <typename T,unsigned S> inline unsigned arraysize(const T (&v)[S]) { return S; }
 CCommonWriter::CCommonWriter() { m\_pNativePicker = NULL; m\_pFontPicker = NULL; m\_bDeleteFontPicker = true; m\_pMediaManager = new NSShapeImageGen::CMediaManager(); } CCommonWriter::~CCommonWriter() { m\_pNativePicker = NULL; if(m\_bDeleteFontPicker) RELEASEOBJECT(m\_pFontPicker); RELEASEOBJECT(m\_pMediaManager); } void CCommonWriter::CreateFontPicker(COfficeFontPicker\* pPicker) { if(m\_bDeleteFontPicker) RELEASEOBJECT(m\_pFontPicker); m\_pNativePicker = NULL; if (pPicker != NULL) { m\_pFontPicker = pPicker; m\_bDeleteFontPicker = false; } else { m\_pFontPicker = new COfficeFontPicker(); m\_bDeleteFontPicker = true; }
 m\_pNativePicker = m\_pFontPicker->GetNativePicker(); } void CCommonWriter::CheckFontPicker() { if (NULL == m\_pFontPicker) CreateFontPicker(NULL); }
 CImageManager2::CImageManager2() : m\_mapImages(), m\_lIndexNextImage(0), m\_lIndexCounter(0) { m\_nDocumentType = XMLWRITER\_DOC\_TYPE\_PPTX; m\_pContentTypes = new OOX::CContentTypes(); } CImageManager2::~CImageManager2() { delete m\_pContentTypes; } void CImageManager2::Clear() { m\_mapImages.clear(); m\_lIndexNextImage = 0; m\_lIndexCounter = 0; } void CImageManager2::SetDstFolder(const std::wstring& strDst) { m\_strDstFolder = strDst; m\_strDstMedia = m\_strDstFolder + FILE\_SEPARATOR\_STR + \_T("media"); m\_strDstEmbed = m\_strDstFolder + FILE\_SEPARATOR\_STR + \_T("embeddings");
 NSDirectory::CreateDirectory(m\_strDstMedia); NSDirectory::CreateDirectory(m\_strDstEmbed); } std::wstring CImageManager2::GetDstFolder() { return m\_strDstFolder; } void CImageManager2::SetDstMedia(const std::wstring& strDst) { m\_strDstMedia = strDst; } std::wstring CImageManager2::GetDstMedia() { return m\_strDstMedia; } void CImageManager2::SetDstEmbed(const std::wstring& strDst) { m\_strDstEmbed = strDst; } std::wstring CImageManager2::GetDstEmbed() { return m\_strDstEmbed; } int CImageManager2::IsDisplayedImage(const std::wstring& strInput) { int nRes = 0; //шаблон display[N]image.ext std::wstring sFind1 = \_T("display"); int nIndex1 = (int)strInput.find(sFind1); if(-1 != nIndex1) { if(nIndex1 + sFind1.length() < strInput.length()) { wchar\_t cRes1 = strInput[nIndex1 + sFind1.length()]; if('1' <= cRes1 && cRes1 <= '9') { wchar\_t cRes2 = strInput[nIndex1 + sFind1.length() + 1];  int nImageIndex = nIndex1 + (int)sFind1.length() + 1; if (std::wstring::npos != strInput.find(\_T("image"), nImageIndex)) { nRes = cRes1 - '0'; if('0' <= cRes2 && cRes2 <= '9') { nRes = nRes \* 10 + (cRes2 - '0'); }  }
 }
 } } return nRes; } \_imageManager2Info CImageManager2::GenerateMedia(const std::wstring& strInput) { std::map<std::wstring, \_imageManager2Info>::const\_iterator pPair = m\_mapImages.find(strInput);
 if (pPair != m\_mapImages.end()) { return pPair->second; }
 \_imageManager2Info oImageManagerInfo = GenerateMediaExec(strInput);  m\_mapImages[strInput] = oImageManagerInfo;
 return oImageManagerInfo; } \_imageManager2Info CImageManager2::GenerateImage(const std::wstring& strInput, NSCommon::smart\_ptr<OOX::File> & additionalFile, const std::wstring& oleData, std::wstring strBase64Image) { if (IsNeedDownload(strInput)) return DownloadImage(strInput);
 std::map<std::wstring, \_imageManager2Info>::const\_iterator pPair = m\_mapImages.find ((strBase64Image.empty()) ? strInput : strBase64Image);
 if (pPair != m\_mapImages.end()) { smart\_ptr<OOX::Media> mediaFile = additionalFile.smart\_dynamic\_cast<OOX::Media>(); if (mediaFile.IsInit()) mediaFile->set\_filename(pPair->second.sFilepathAdditional, false);
 return pPair->second; }
 std::wstring strExts = \_T(".jpg"); //use GetFileName to avoid defining '.' in the directory as extension std::wstring strFileName = NSFile::GetFileName(strInput); int nIndexExt = (int)strFileName.rfind(wchar\_t('.')); if (-1 != nIndexExt) strExts = strFileName.substr(nIndexExt);
 int typeAdditional = 0; std::wstring strAdditional; std::wstring strImage = strInput;
 int nDisplayType = IsDisplayedImage(strInput); if (0 != nDisplayType) { OOX::CPath oPath = strInput;  std::wstring strFolder = oPath.GetDirectory(); std::wstring strFileName = oPath.GetFilename();
 strFileName.erase(strFileName.length() - 4, 4);
 if(0 != (nDisplayType & 1)) { std::wstring strVector = strFolder + strFileName + \_T(".wmf"); if (OOX::CSystemUtility::IsFileExist(strVector)) { strImage = strVector; strExts = \_T(".wmf"); } } if(0 != (nDisplayType & 2)) { std::wstring strVector = strFolder + strFileName + L".emf"; if (OOX::CSystemUtility::IsFileExist(strVector)) { m\_pContentTypes->AddDefault(L"emf"); strImage = strVector; strExts = L".emf"; } } if(0 != (nDisplayType & 4)) { smart\_ptr<OOX::OleObject> oleFile = additionalFile.smart\_dynamic\_cast<OOX::OleObject>(); if (oleFile.IsInit()) { if (OOX::CSystemUtility::IsFileExist(oleFile->filename()) == false) { typeAdditional = 1;  std::wstring strOle = strFolder + strFileName + oleFile->filename().GetExtention(); if (OOX::CSystemUtility::IsFileExist(strOle)) { m\_pContentTypes->AddDefault(oleFile->filename().GetExtention(false)); strAdditional = strOle; } else { strOle = strFolder + strFileName + L".bin"; if (OOX::CSystemUtility::IsFileExist(strOle)) strAdditional = strOle; } } } } if(0 != (nDisplayType & 8)) { smart\_ptr<OOX::Media> mediaFile = additionalFile.smart\_dynamic\_cast<OOX::Media>(); if (mediaFile.IsInit()) { if (OOX::CSystemUtility::IsFileExist(mediaFile->filename()) == false) { typeAdditional = 2;
 if (!mediaFile->IsExternal()) { std::wstring strMedia = strFolder + strFileName + mediaFile->filename().GetExtention(); if (OOX::CSystemUtility::IsFileExist(strMedia)) { m\_pContentTypes->AddDefault(mediaFile->filename().GetExtention(false)); strAdditional = strMedia; } else { strMedia = strFolder + strFileName;  if (mediaFile.is<OOX::Audio>()) strMedia += L".wav"; if (mediaFile.is<OOX::Video>()) strMedia += L".avi";  if (OOX::CSystemUtility::IsFileExist(strMedia)) strAdditional = strMedia; } } } } } } if (!strExts.empty()) { m\_pContentTypes->AddDefault(strExts.substr(1)); }
 if (oleData.empty() == false) { //plugins data - generate ole typeAdditional = 1; }
 \_imageManager2Info oImageManagerInfo = GenerateImageExec(strImage, strExts, strAdditional, typeAdditional, oleData);
 if (!oImageManagerInfo.sFilepathAdditional.empty())  { smart\_ptr<OOX::Media> mediaFile = additionalFile.smart\_dynamic\_cast<OOX::Media>(); if (mediaFile.IsInit()) { mediaFile->set\_filename(oImageManagerInfo.sFilepathAdditional, false); } }  if (strBase64Image.empty()) m\_mapImages[strInput] = oImageManagerInfo; else m\_mapImages [strBase64Image] = oImageManagerInfo; return oImageManagerInfo; } bool CImageManager2::WriteOleData(const std::wstring& sFilePath, const std::wstring& sData) { bool bRes = false; //EncodingMode.unparsed https://github.com/tonyqus/npoi/blob/master/main/POIFS/FileSystem/Ole10Native.cs POLE::Storage oStorage(sFilePath.c\_str()); if(oStorage.open(true, true)) { //CompObj Stream BYTE dataCompObj[] = {0x01,0x00,0xfe,0xff,0x03,0x0a,0x00,0x00,0xff,0xff,0xff,0xff,0x0c,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x0c,0x00,0x00,0x00,0x4f,0x4c,0x45,0x20,0x50,0x61,0x63,0x6b,0x61,0x67,0x65,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x50,0x61,0x63,0x6b,0x61,0x67,0x65,0x00,0xf4,0x39,0xb2,0x71,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}; POLE::Stream oStream1(&oStorage, L"\001CompObj", true, arraysize(dataCompObj)); oStream1.write(dataCompObj, arraysize(dataCompObj)); oStream1.flush(); //ObjInfo Stream BYTE dataObjInfo[] = {0x00,0x00,0x03,0x00,0x0d,0x00}; POLE::Stream oStream2(&oStorage, L"\003ObjInfo", true, arraysize(dataObjInfo)); oStream2.write(dataObjInfo, arraysize(dataObjInfo)); oStream2.flush(); //Ole10Native Stream std::string sDataUtf8 = NSFile::CUtf8Converter::GetUtf8StringFromUnicode2(sData.c\_str(), (LONG)sData.size()); BYTE head[] = {0x00,0x00,0x00,0x00}; //LittleEndian  unsigned char\* aData = (unsigned char\*)sDataUtf8.c\_str();  \_UINT32 nDataSize = (\_UINT32)sDataUtf8.size();
 memcpy(head, &nDataSize, sizeof(\_UINT32));
 POLE::Stream oStream(&oStorage, L"\001Ole10Native", true, arraysize(head) + nDataSize); oStream.write(head, arraysize(head)); oStream.write(aData, nDataSize); oStream.flush();
 oStorage.close(); bRes = true; } return bRes; } \_imageManager2Info CImageManager2::GenerateMediaExec(const std::wstring& strInput) { OOX::CPath oPathOutput; \_imageManager2Info oImageManagerInfo;  std::wstring strExts; std::wstring strMedia = L"media" + std::to\_wstring(++m\_lIndexNextImage);  int pos = (int)strInput.rfind(L"."); if (pos >= 0)  { strExts = strInput.substr(pos); m\_pContentTypes->AddDefault(strExts.substr(1)); }
 oPathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strMedia + strExts;
 if (oPathOutput.GetPath() != strInput && NSFile::CFileBinary::Exists(strInput)) { NSFile::CFileBinary::Copy(strInput, oPathOutput.GetPath()); oImageManagerInfo.sFilepathImage = oPathOutput.GetPath(); } return oImageManagerInfo; } \_imageManager2Info CImageManager2::GenerateImageExec(const std::wstring& strInput, const std::wstring& sExts, const std::wstring& strAdditionalImage, int nAdditionalType, const std::wstring& oleData) { OOX::CPath oPathOutput; \_imageManager2Info oImageManagerInfo;  std::wstring strExts = sExts; std::wstring strImage = L"image" + std::to\_wstring(++m\_lIndexNextImage);  if ((\_T(".jpg") == strExts) || (\_T(".jpeg") == strExts) || (\_T(".png") == strExts) || (\_T(".emf") == strExts) || (\_T(".wmf") == strExts)) { oPathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strImage + strExts;
 if (oPathOutput.GetPath() != strInput && NSFile::CFileBinary::Exists(strInput)) { NSFile::CFileBinary::Copy(strInput, oPathOutput.GetPath()); oImageManagerInfo.sFilepathImage = oPathOutput.GetPath(); } } else { // content types!!! strExts = \_T(".png"); oPathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strImage + strExts; SaveImageAsPng(strInput, oPathOutput.GetPath()); oImageManagerInfo.sFilepathImage = oPathOutput.GetPath(); }   if ((!strAdditionalImage.empty() || !oleData.empty() ) && (nAdditionalType == 1)) { std::wstring strAdditionalExt = L".bin";
 int pos = (int)strAdditionalImage.rfind(L"."); if (pos >= 0) strAdditionalExt = strAdditionalImage.substr(pos);
 std::wstring strImageAdditional = L"oleObject" + std::to\_wstring(++m\_lIndexCounter) + strAdditionalExt;  OOX::CPath pathOutput = m\_strDstEmbed + FILE\_SEPARATOR\_STR + strImageAdditional;  std::wstring strAdditionalImageOut = pathOutput.GetPath();  if(!oleData.empty()) { WriteOleData(strAdditionalImageOut, oleData); oImageManagerInfo.sFilepathAdditional = strAdditionalImageOut; } else if (NSFile::CFileBinary::Exists(strAdditionalImage)) { NSFile::CFileBinary::Copy(strAdditionalImage, strAdditionalImageOut); oImageManagerInfo.sFilepathAdditional = strAdditionalImageOut; }
 } else if (!strAdditionalImage.empty() && nAdditionalType == 2) {  std::wstring strAdditionalExt;
 int pos = (int)strAdditionalImage.rfind(L"."); if (pos >= 0) strAdditionalExt = strAdditionalImage.substr(pos);
 std::wstring strImageAdditional = L"media" + std::to\_wstring(++m\_lIndexCounter) + strAdditionalExt;  OOX::CPath pathOutput = m\_strDstMedia + FILE\_SEPARATOR\_STR + strImageAdditional;  std::wstring strAdditionalImageOut = pathOutput.GetPath();
 if (NSFile::CFileBinary::Exists(strAdditionalImage)) { NSFile::CFileBinary::Copy(strAdditionalImage, strAdditionalImageOut); oImageManagerInfo.sFilepathAdditional = strAdditionalImageOut; } }
 return oImageManagerInfo; } void CImageManager2::SaveImageAsPng(const std::wstring& strFileSrc, const std::wstring& strFileDst) { CBgraFrame oBgraFrame; if(oBgraFrame.OpenFile(strFileSrc)) oBgraFrame.SaveFile(strFileDst, \_CXIMAGE\_FORMAT\_PNG); }
 void CImageManager2::SaveImageAsJPG(const std::wstring& strFileSrc, const std::wstring& strFileDst) { CBgraFrame oBgraFrame; if(oBgraFrame.OpenFile(strFileSrc)) oBgraFrame.SaveFile(strFileDst, \_CXIMAGE\_FORMAT\_JPG); }
 bool CImageManager2::IsNeedDownload(const std::wstring& strFile) { size\_t n1 = strFile.find(\_T("www")); size\_t n2 = strFile.find(\_T("http")); size\_t n3 = strFile.find(\_T("ftp")); size\_t n4 = strFile.find(\_T("https://"));
 //если nI сранивать не с 0, то будут проблемы //потому что в инсталяции мы кладем файлы в /var/www... if (0 == n1 || 0 == n2 || 0 == n3 || 0 == n4) return true; return false; } \_imageManager2Info CImageManager2::DownloadImage(const std::wstring& strUrl) { std::map<std::wstring, \_imageManager2Info>::const\_iterator pPair = m\_mapImages.find (strUrl);
 if (pPair != m\_mapImages.end()) return pPair->second;
 std::wstring strExts = \_T(".jpg"); int nIndexExt = (int)strUrl.rfind(wchar\_t('.')); if (-1 != nIndexExt) strExts = strUrl.substr(nIndexExt);
 std::wstring strImage;  int nDisplayType = IsDisplayedImage(strUrl);  if(0 != nDisplayType) { std::wstring strInputMetafile = strUrl.substr(0, strUrl.length() - strExts.length()); std::wstring sDownloadRes;
 if(0 != (nDisplayType & 1)) { strImage = DownloadImageExec(strInputMetafile + \_T(".wmf")); strExts = \_T(".wmf"); } else if(0 != (nDisplayType & 2)) { strImage = DownloadImageExec(strInputMetafile + \_T(".emf")); strExts = \_T(".emf"); } else { strImage = DownloadImageExec(strUrl); } } else { strImage = DownloadImageExec(strUrl); }
 if (!strExts.empty()) { m\_pContentTypes->AddDefault(strExts.substr(1)); }
 \_imageManager2Info oImageManagerInfo; if (!strImage.empty()) { oImageManagerInfo = GenerateImageExec(strImage, strExts, L"", 0, L""); CDirectory::DeleteFile(strImage); }
 m\_mapImages[strUrl] = oImageManagerInfo; return oImageManagerInfo; } std::wstring CImageManager2::DownloadImageExec(const std::wstring& strFile) {#ifndef DISABLE\_FILE\_DOWNLOADER CFileDownloader oDownloader(strFile, false);
 if ( oDownloader.DownloadSync() ) { return oDownloader.GetFilePath(); }#endif return \_T(""); }
 CBinaryFileWriter::CSeekTableEntry::CSeekTableEntry() { Type = 0; SeekPos = 0; } BYTE\* CBinaryFileWriter::GetBuffer() { return m\_pStreamData; } \_UINT32 CBinaryFileWriter::GetPosition() { return m\_lPosition; } void CBinaryFileWriter::SetPosition(const \_UINT32& lPosition) { m\_lPosition = lPosition; m\_pStreamCur = m\_pStreamData + m\_lPosition; } void CBinaryFileWriter::Skip(const \_UINT32& lSize) { CheckBufferSize(lSize);
 m\_lPosition += lSize; m\_pStreamCur = m\_pStreamData + m\_lPosition; } double CBinaryFileWriter::GetShapeHeight() { if (m\_lCyCurShape == 0) return -1; return (double)m\_lCyCurShape / 36000; //mm } double CBinaryFileWriter::GetShapeWidth() { if (m\_lCyCurShape == 0) return -1; return (double)m\_lCxCurShape / 36000; } double CBinaryFileWriter::GetShapeY() { return (double)m\_lYCurShape / 36000; } double CBinaryFileWriter::GetShapeX() { return (double)m\_lXCurShape / 36000; //mm } void CBinaryFileWriter::ClearCurShapePositionAndSizes() { m\_lXCurShape = 0; m\_lYCurShape = 0;  m\_lCxCurShape = 0; m\_lCyCurShape = 0; } void CBinaryFileWriter::Clear() { m\_lSize = 0; m\_lPosition = 0;
 m\_pStreamData = NULL; m\_pStreamCur = NULL;
 m\_lStackPosition = 0; memset(m\_arStack, 0, MAX\_STACK\_SIZE \* sizeof(\_UINT32));
 m\_lCxCurShape = 0; m\_lCyCurShape = 0;
 m\_lXCurShape = 0; m\_lYCurShape = 0; }
 void CBinaryFileWriter::SetMainDocument(BinDocxRW::CDocxSerializer\* pMainDoc) { m\_pMainDocument = pMainDoc; }
 void CBinaryFileWriter::ClearNoAttack() { m\_lPosition = 0; m\_pStreamCur = m\_pStreamData;
 m\_lStackPosition = 0; memset(m\_arStack, 0, MAX\_STACK\_SIZE \* sizeof(\_UINT32)); }
 void CBinaryFileWriter::CheckBufferSize(\_UINT32 lPlus) { if (NULL != m\_pStreamData) { size\_t nNewSize = m\_lPosition + lPlus;
 if (nNewSize >= m\_lSize) { while (nNewSize >= m\_lSize) { m\_lSize \*= 2; }
 BYTE\* pNew = new BYTE[m\_lSize]; memcpy(pNew, m\_pStreamData, m\_lPosition);
 RELEASEARRAYOBJECTS(m\_pStreamData); m\_pStreamData = pNew;
 m\_pStreamCur = m\_pStreamData + m\_lPosition; } } else { m\_lSize = 1024 \* 1024; // 1Mb m\_pStreamData = new BYTE[m\_lSize];
 m\_lPosition = 0; m\_pStreamCur = m\_pStreamData;
 CheckBufferSize(lPlus); } }
 void CBinaryFileWriter::WriteBYTE(const BYTE& lValue) {  CheckBufferSize(BYTE\_SIZEOF);
 \*m\_pStreamCur = lValue;  m\_lPosition += BYTE\_SIZEOF; m\_pStreamCur += BYTE\_SIZEOF; } void CBinaryFileWriter::WriteSBYTE(const signed char& lValue) { CheckBufferSize(BYTE\_SIZEOF);
 if (lValue < 0) \*m\_pStreamCur = (lValue + 256); else \*m\_pStreamCur = lValue; m\_lPosition += BYTE\_SIZEOF; m\_pStreamCur += BYTE\_SIZEOF; } void CBinaryFileWriter::WriteBOOL(const bool& bValue) {  WriteBYTE((bValue == true) ? 1 : 0); } void CBinaryFileWriter::WriteUSHORT(const \_UINT16& lValue) { CheckBufferSize(UINT16\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_UINT16));#else \*((\_UINT16\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += UINT16\_SIZEOF; m\_pStreamCur += UINT16\_SIZEOF; } void CBinaryFileWriter::WriteSHORT(const \_INT16& lValue) { CheckBufferSize(INT16\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT16));#else \*((\_INT16\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT16\_SIZEOF; m\_pStreamCur += INT16\_SIZEOF; } void CBinaryFileWriter::WriteULONG(const \_UINT32& lValue) { CheckBufferSize(UINT32\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_UINT32));#else \*((\_UINT32\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += UINT32\_SIZEOF; m\_pStreamCur += UINT32\_SIZEOF; } void CBinaryFileWriter::WriteLONG(const \_INT32& lValue) { CheckBufferSize(INT32\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT32));#else \*((\_INT32\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT32\_SIZEOF; m\_pStreamCur += INT32\_SIZEOF; } void CBinaryFileWriter::WriteLONG64(const \_INT64& lValue) { CheckBufferSize(INT64\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT64));#else \*((\_INT64\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT64\_SIZEOF; m\_pStreamCur += INT64\_SIZEOF; } void CBinaryFileWriter::WriteINT(const \_INT32& lValue) { CheckBufferSize(INT32\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lValue, sizeof(\_INT32));#else \*((\_INT32\*)m\_pStreamCur) = lValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += INT32\_SIZEOF; m\_pStreamCur += INT32\_SIZEOF; } void CBinaryFileWriter::WriteDouble64(const double& dValue) { \_INT64 \_val = (\_INT64)(dValue \* 100000); WriteLONG64(\_val); } void CBinaryFileWriter::WriteDouble(const double& dValue) { \_INT64 \_val = (\_INT64)(dValue \* 100000);
 if (\_val > 0x7fffffff) { WriteLONG(0x7fffffff); } else if ( \_val < -0x7fffffff) { WriteLONG(-0x7fffffff); }  else { WriteLONG((long)\_val); } } void CBinaryFileWriter::WriteDoubleReal(const double& dValue) { CheckBufferSize(DOUBLE\_SIZEOF);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &dValue, sizeof(double));#else \*((double\*)m\_pStreamCur) = dValue; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += DOUBLE\_SIZEOF; m\_pStreamCur += DOUBLE\_SIZEOF; } void CBinaryFileWriter::WriteBYTEArray(const BYTE\* pBuffer, size\_t len) { CheckBufferSize((\_UINT32)len); memcpy(m\_pStreamCur, pBuffer, len); m\_lPosition += (\_UINT32)len; m\_pStreamCur += len; } void CBinaryFileWriter::WriteStringA(std::string& sBuffer) { \_UINT32 lSize = (\_UINT32)sBuffer.length(); \_UINT32 lSizeMem = lSize \* sizeof(char);
 CheckBufferSize(UINT32\_SIZEOF + lSizeMem);#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(m\_pStreamCur, &lSizeMem, sizeof(\_UINT32));#else \*((\_UINT32\*)m\_pStreamCur) = lSizeMem; // EXC\_ARM\_DA\_ALIGN on ios#endif m\_lPosition += UINT32\_SIZEOF; m\_pStreamCur += UINT32\_SIZEOF;
 memcpy(m\_pStreamCur, sBuffer.c\_str(), lSizeMem);  m\_lPosition += lSizeMem; m\_pStreamCur += lSizeMem; } void CBinaryFileWriter::WriteStringW(std::wstring& sBuffer) { \_WriteStringWithLength(sBuffer.c\_str(), (\_UINT32)sBuffer.length(), true); } void CBinaryFileWriter::WriteStringW(const std::wstring& sBuffer) { \_WriteStringWithLength(sBuffer.c\_str(), (\_UINT32)sBuffer.length(), true); } void CBinaryFileWriter::WriteStringW2(std::wstring& sBuffer) { \_WriteStringWithLength(sBuffer.c\_str(), (\_UINT32)sBuffer.length(), false); } void CBinaryFileWriter::WriteStringW3(std::wstring& sBuffer) { \_WriteString(sBuffer.c\_str(), (\_UINT32)sBuffer.length()); } void CBinaryFileWriter::WriteStringW3(const std::wstring& sBuffer) { \_WriteString(sBuffer.c\_str(), (\_UINT32)sBuffer.length()); } void CBinaryFileWriter::WriteStringW4(const std::wstring& sBuffer) { \_WriteString(sBuffer.c\_str(), (\_UINT32)sBuffer.length()); } void CBinaryFileWriter::WriteStringUtf8(const std::wstring& sBuffer) { BYTE\* pData = NULL; LONG lLen = 0;
 NSFile::CUtf8Converter::GetUtf8StringFromUnicode(sBuffer.c\_str(), (LONG)sBuffer.length(), pData, lLen, false);
 WriteBYTEArray(pData, lLen);
 RELEASEARRAYOBJECTS(pData); } CBinaryFileWriter::CBinaryFileWriter() { m\_pMainDocument = NULL; m\_pCommon = new CCommonWriter(); //m\_pCommonRels = new NSCommon::smart\_ptr<PPTX::CCommonRels>(); m\_pCurrentContainer = new NSCommon::smart\_ptr<OOX::IFileContainer>(); m\_pTheme = new NSCommon::smart\_ptr<PPTX::Theme>(); m\_pClrMap = new NSCommon::smart\_ptr<PPTX::Logic::ClrMap>();  Clear(); } CBinaryFileWriter::~CBinaryFileWriter() { RELEASEARRAYOBJECTS (m\_pStreamData); RELEASEOBJECT (m\_pCommon); //RELEASEOBJECT (m\_pCommonRels); RELEASEOBJECT (m\_pCurrentContainer);  RELEASEOBJECT (m\_pTheme); RELEASEOBJECT (m\_pClrMap); }
 void CBinaryFileWriter::StartRecord(\_INT32 lType) { m\_arStack[m\_lStackPosition] = m\_lPosition + 5; // sizeof(BYTE) + sizeof(\_UINT32) m\_lStackPosition++; WriteBYTE((BYTE)lType); WriteULONG(0); } void CBinaryFileWriter::EndRecord() { m\_lStackPosition--;
 \_UINT32 size\_record = m\_lPosition - m\_arStack[m\_lStackPosition]; (\*(\_UINT32\*)(m\_pStreamData + m\_arStack[m\_lStackPosition] - 4)) = size\_record ; }
 void CBinaryFileWriter::StartMainRecord(\_INT32 lType) { CSeekTableEntry oEntry; oEntry.Type = lType; oEntry.SeekPos = m\_lPosition; m\_arMainTables.push\_back(oEntry); //StartRecord(lType); }
 void CBinaryFileWriter::WriteReserved(size\_t lCount) { CheckBufferSize((\_UINT32)lCount); memset(m\_pStreamCur, 0, lCount); m\_pStreamCur += lCount; m\_lPosition += (\_UINT32)lCount; }
 void CBinaryFileWriter::WriteMainPart(\_UINT32 nStartPos) { BYTE\* pData = m\_pStreamData + nStartPos; size\_t nCount = m\_arMainTables.size();
 for (size\_t i = 0; i < nCount; i++) { \*pData = (BYTE)m\_arMainTables[i].Type; ++pData;#if defined(\_IOS) || defined(\_\_ANDROID\_\_) memcpy(pData, &m\_arMainTables[i].SeekPos, sizeof(\_INT32));#else \*((\_INT32\*)pData) = m\_arMainTables[i].SeekPos; // EXC\_ARM\_DA\_ALIGN on ios#endif pData += 4; } }
 void CBinaryFileWriter::WriteString1(int type, const std::wstring& val) { BYTE bType = (BYTE)type; WriteBYTE(bType);
 std::wstring\* s = const\_cast<std::wstring\*>(&val); \_WriteStringWithLength(s->c\_str(), (\_UINT32)s->length(), false); } void CBinaryFileWriter::WriteString2(int type, const NSCommon::nullable\_string& val) { if (val.is\_init()) WriteString1(type, \*val); } void CBinaryFileWriter::WriteString(const std::wstring& val) { std::wstring\* s = const\_cast<std::wstring\*>(&val); \_WriteStringWithLength(s->c\_str(), (\_UINT32)s->length(), false); }
 void CBinaryFileWriter::WriteStringData(const WCHAR\* pData, \_UINT32 len) { \_WriteStringWithLength(pData, len, false); }
 void CBinaryFileWriter::WriteString1Data(int type, const WCHAR\* pData, \_UINT32 len) { BYTE bType = (BYTE)type; WriteBYTE(bType);
 \_WriteStringWithLength(pData, len, false); }
 void CBinaryFileWriter::WriteBool1(int type, const bool& val) { BYTE bType = (BYTE)type; WriteBYTE(bType); WriteBYTE((val == true) ? 1 : 0); } void CBinaryFileWriter::WriteBool2(int type, const NSCommon::nullable\_bool& val) { if (val.is\_init()) WriteBool1(type, \*val); }
 void CBinaryFileWriter::WriteInt1(int type, const int& val) { BYTE bType = (BYTE)type; WriteBYTE(bType); WriteINT(val); }[View remainder of file in raw view](https://github.com/ONLYOFFICE/core/raw/refs/tags/v5.6.4.13/ASCOfficePPTXFile/Editor/BinaryFileReaderWriter.cpp)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a835991f_20250115_083550.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ONLYOFFICE%2Fcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[core](/ONLYOFFICE/core)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fcore) You must be signed in to change notification settings
* [Fork
  226](/login?return_to=%2FONLYOFFICE%2Fcore)
* [Star
   295](/login?return_to=%2FONLYOFFICE%2Fcore)

Server core components which are a part of ONLYOFFICE Document Server

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### License

[AGPL-3.0 license](/ONLYOFFICE/core/blob/master/LICENSE.txt)

[295
stars](/ONLYOFFICE/core/stargazers) [226
forks](/ONLYOFFICE/core/forks) [Branches](/ONLYOFFICE/core/branches) [Tags](/ONLYOFFICE/core/tags) [Activity](/ONLYOFFICE/core/activity)
 [Star](/login?return_to=%2FONLYOFFICE%2Fcore)

 [Notifications](/login?return_to=%2FONLYOFFICE%2Fcore) You must be signed in to change notification settings

* [Code](/ONLYOFFICE/core)
* [Pull requests
  11](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/core)
* [Pull requests](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

# ONLYOFFICE/core

    master[Branches](/ONLYOFFICE/core/branches)[Tags](/ONLYOFFICE/core/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[19,075 Commits](/ONLYOFFICE/core/commits/master/) | | |
| [.github/workflows](/ONLYOFFICE/core/tree/master/.github/workflows "This path skips through empty directories") | | [.github/workflows](/ONLYOFFICE/core/tree/master/.github/workflows "This path skips through empty directories") |  |  |
| [Common](/ONLYOFFICE/core/tree/master/Common "Common") | | [Common](/ONLYOFFICE/core/tree/master/Common "Common") |  |  |
| [DesktopEditor](/ONLYOFFICE/core/tree/master/DesktopEditor "DesktopEditor") | | [DesktopEditor](/ONLYOFFICE/core/tree/master/DesktopEditor "DesktopEditor") |  |  |
| [DjVuFile](/ONLYOFFICE/core/tree/master/DjVuFile "DjVuFile") | | [DjVuFile](/ONLYOFFICE/core/tree/master/DjVuFile "DjVuFile") |  |  |
| [DocxRenderer](/ONLYOFFICE/core/tree/master/DocxRenderer "DocxRenderer") | | [DocxRenderer](/ONLYOFFICE/core/tree/master/DocxRenderer "DocxRenderer") |  |  |
| [EpubFile](/ONLYOFFICE/core/tree/master/EpubFile "EpubFile") | | [EpubFile](/ONLYOFFICE/core/tree/master/EpubFile "EpubFile") |  |  |
| [Fb2File](/ONLYOFFICE/core/tree/master/Fb2File "Fb2File") | | [Fb2File](/ONLYOFFICE/core/tree/master/Fb2File "Fb2File") |  |  |
| [HtmlFile](/ONLYOFFICE/core/tree/master/HtmlFile "HtmlFile") | | [HtmlFile](/ONLYOFFICE/core/tree/master/HtmlFile "HtmlFile") |  |  |
| [HtmlFile2](/ONLYOFFICE/core/tree/master/HtmlFile2 "HtmlFile2") | | [HtmlFile2](/ONLYOFFICE/core/tree/master/HtmlFile2 "HtmlFile2") |  |  |
| [HtmlRenderer](/ONLYOFFICE/core/tree/master/HtmlRenderer "HtmlRenderer") | | [HtmlRenderer](/ONLYOFFICE/core/tree/master/HtmlRenderer "HtmlRenderer") |  |  |
| [MsBinaryFile](/ONLYOFFICE/core/tree/master/MsBinaryFile "MsBinaryFile") | | [MsBinaryFile](/ONLYOFFICE/core/tree/master/MsBinaryFile "MsBinaryFile") |  |  |
| [OOXML](/ONLYOFFICE/core/tree/master/OOXML "OOXML") | | [OOXML](/ONLYOFFICE/core/tree/master/OOXML "OOXML") |  |  |
| [OdfFile](/ONLYOFFICE/core/tree/master/OdfFile "OdfFile") | | [OdfFile](/ONLYOFFICE/core/tree/master/OdfFile "OdfFile") |  |  |
| [OfficeCryptReader](/ONLYOFFICE/core/tree/master/OfficeCryptReader "OfficeCryptReader") | | [OfficeCryptReader](/ONLYOFFICE/core/tree/master/OfficeCryptReader "OfficeCryptReader") |  |  |
| [OfficeUtils](/ONLYOFFICE/core/tree/master/OfficeUtils "OfficeUtils") | | [OfficeUtils](/ONLYOFFICE/core/tree/master/OfficeUtils "OfficeUtils") |  |  |
| [PdfFile](/ONLYOFFICE/core/tree/master/PdfFile "PdfFile") | | [PdfFile](/ONLYOFFICE/core/tree/master/PdfFile "PdfFile") |  |  |
| [RtfFile](/ONLYOFFICE/core/tree/master/RtfFile "RtfFile") | | [RtfFile](/ONLYOFFICE/core/tree/master/RtfFile "RtfFile") |  |  |
| [Test](/ONLYOFFICE/core/tree/master/Test "Test") | | [Test](/ONLYOFFICE/core/tree/master/Test "Test") |  |  |
| [TxtFile](/ONLYOFFICE/core/tree/master/TxtFile "TxtFile") | | [TxtFile](/ONLYOFFICE/core/tree/master/TxtFile "TxtFile") |  |  |
| [UnicodeConverter](/ONLYOFFICE/core/tree/master/UnicodeConverter "UnicodeConverter") | | [UnicodeConverter](/ONLYOFFICE/core/tree/master/UnicodeConverter "UnicodeConverter") |  |  |
| [X2tConverter](/ONLYOFFICE/core/tree/master/X2tConverter "X2tConverter") | | [X2tConverter](/ONLYOFFICE/core/tree/master/X2tConverter "X2tConverter") |  |  |
| [XpsFile](/ONLYOFFICE/core/tree/master/XpsFile "XpsFile") | | [XpsFile](/ONLYOFFICE/core/tree/master/XpsFile "XpsFile") |  |  |
| [.gitattributes](/ONLYOFFICE/core/blob/master/.gitattributes ".gitattributes") | | [.gitattributes](/ONLYOFFICE/core/blob/master/.gitattributes ".gitattributes") |  |  |
| [.gitignore](/ONLYOFFICE/core/blob/master/.gitignore ".gitignore") | | [.gitignore](/ONLYOFFICE/core/blob/master/.gitignore ".gitignore") |  |  |
| [3DPARTY.md](/ONLYOFFICE/core/blob/master/3DPARTY.md "3DPARTY.md") | | [3DPARTY.md](/ONLYOFFICE/core/blob/master/3DPARTY.md "3DPARTY.md") |  |  |
| [CHANGELOG.md](/ONLYOFFICE/core/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/ONLYOFFICE/core/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [LICENSE.txt](/ONLYOFFICE/core/blob/master/LICENSE.txt "LICENSE.txt") | | [LICENSE.txt](/ONLYOFFICE/core/blob/master/LICENSE.txt "LICENSE.txt") |  |  |
| [Readme.md](/ONLYOFFICE/core/blob/master/Readme.md "Readme.md") | | [Readme.md](/ONLYOFFICE/core/blob/master/Readme.md "Readme.md") |  |  |
| View all files | | |

## Repository files navigation

* README
* AGPL-3.0 license

[![License](https://camo.githubusercontent.com/1720e1c42dd5a9a5cfaed3a4abec210e929921fa9271e404263661daf3c7905b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d474e552532304147504c25323056332d677265656e2e7376673f7374796c653d666c6174)](https://www.gnu.org/licenses/agpl-3.0.en.html) [![x2tconverter](https://camo.githubusercontent.com/ad2fd2f7337786e26442a0e793c7f4800b668e9385d36fc28ed370c4a490a0b8/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f783274636f6e7665727465722d76322e302e322e3337362d626c75652e7376673f7374796c653d666c6174)](https://camo.githubusercontent.com/ad2fd2f7337786e26442a0e793c7f4800b668e9385d36fc28ed370c4a490a0b8/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f783274636f6e7665727465722d76322e302e322e3337362d626c75652e7376673f7374796c653d666c6174) [![Platforms Windows | OS X | Linux](https://camo.githubusercontent.com/57ed1b4cb5ffd2dd945414fd07dbe9866e62782082001bef0514274264185932/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f506c6174666f726d732d57696e646f77732532302537432532304f53253230582532302537432532304c696e75782532302d6c69676874677261792e7376673f7374796c653d666c6174)](https://camo.githubusercontent.com/57ed1b4cb5ffd2dd945414fd07dbe9866e62782082001bef0514274264185932/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f506c6174666f726d732d57696e646f77732532302537432532304f53253230582532302537432532304c696e75782532302d6c69676874677261792e7376673f7374796c653d666c6174)

## Core

Server core components which are a part of [ONLYOFFICE Document Server](https://github.com/ONLYOFFICE/DocumentServer) and [ONLYOFFICE Desktop Editors](https://github.com/ONLYOFFICE/DesktopEditors). Enable the conversion between the most popular office document formats: DOC, DOCX, ODT, RTF, TXT, PDF, HTML, EPUB, XPS, DjVu, XLS, XLSX, ODS, CSV, PPT, PPTX, ODP.

## Project Information

Official website: [http://www.onlyoffice.com](http://onlyoffice.com "http://www.onlyoffice.com")

Code repository: [https://github.com/ONLYOFFICE/core](https://github.com/ONLYOFFICE/core "https://github.com/ONLYOFFICE/core")

SaaS version: [https://www.onlyoffice.com/cloud-office.aspx](https://www.onlyoffice.com/cloud-office.aspx "https://www.onlyoffice.com/cloud-office.aspx")

## User Feedback and Support

If you have any problems with or questions about [ONLYOFFICE Document Server](https://github.com/ONLYOFFICE/DocumentServer), please visit our official forum to find answers to your questions: [forum.onlyoffice.com](https://forum.onlyoffice.com) or you can ask and answer ONLYOFFICE development questions on [Stack Overflow](http://stackoverflow.com/questions/tagged/onlyoffice).

## License

Core is released under an GNU AGPL v3.0 license. See the LICENSE file for more information.

## About

Server core components which are a part of ONLYOFFICE Document Server

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### Topics

[converter](/topics/converter "Topic: converter")
[v8](/topics/v8 "Topic: v8")
[cpp](/topics/cpp "Topic: cpp")

### Resources

[Readme](#readme-ov-file)
### License

[AGPL-3.0 license](#AGPL-3.0-1-ov-file)

[Activity](/ONLYOFFICE/core/activity)
[Custom properties](/ONLYOFFICE/core/custom-properties)
### Stars

[**295**
stars](/ONLYOFFICE/core/stargazers)
### Watchers

[**38**
watching](/ONLYOFFICE/core/watchers)
### Forks

[**226**
forks](/ONLYOFFICE/core/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore&report=ONLYOFFICE+%28user%29)

## [Releases](/ONLYOFFICE/core/releases)

[9,642
tags](/ONLYOFFICE/core/tags)

## [Packages 0](/orgs/ONLYOFFICE/packages?repo_name=core)

No packages published

## [Contributors 44](/ONLYOFFICE/core/graphs/contributors)

* [![@K0R0L](https://avatars.githubusercontent.com/u/16754960?s=64&v=4)](https://github.com/K0R0L)
* [![@ElenaSubbotina](https://avatars.githubusercontent.com/u/17923067?s=64&v=4)](https://github.com/ElenaSubbotina)
* [![@SylaiseElvenan](https://avatars.githubusercontent.com/u/37101627?s=64&v=4)](https://github.com/SylaiseElvenan)
* [![@konovalovsergey](https://avatars.githubusercontent.com/u/17902399?s=64&v=4)](https://github.com/konovalovsergey)
* [![@PolyakovKirill](https://avatars.githubusercontent.com/u/67578284?s=64&v=4)](https://github.com/PolyakovKirill)
* [![@IvanAlekseevich28](https://avatars.githubusercontent.com/u/45149118?s=64&v=4)](https://github.com/IvanAlekseevich28)
* [![@RIMINMIR](https://avatars.githubusercontent.com/u/70960170?s=64&v=4)](https://github.com/RIMINMIR)
* [![@agolybev](https://avatars.githubusercontent.com/u/8861642?s=64&v=4)](https://github.com/agolybev)
* [![@alexeymusinov](https://avatars.githubusercontent.com/u/17567171?s=64&v=4)](https://github.com/alexeymusinov)
* [![@EnergyFlexus](https://avatars.githubusercontent.com/u/37239071?s=64&v=4)](https://github.com/EnergyFlexus)
* [![@KirillovIlya](https://avatars.githubusercontent.com/u/17902914?s=64&v=4)](https://github.com/KirillovIlya)
* [![@VikulovDmitry](https://avatars.githubusercontent.com/u/7170923?s=64&v=4)](https://github.com/VikulovDmitry)
* [![@SergeyKirillov](https://avatars.githubusercontent.com/u/8087664?s=64&v=4)](https://github.com/SergeyKirillov)
* [![@kom-a](https://avatars.githubusercontent.com/u/29620514?s=64&v=4)](https://github.com/kom-a)

[+ 30 contributors](/ONLYOFFICE/core/graphs/contributors)

## Languages

* [C++
  54.7%](/ONLYOFFICE/core/search?l=c%2B%2B)
* [C
  30.2%](/ONLYOFFICE/core/search?l=c)
* [HTML
  10.8%](/ONLYOFFICE/core/search?l=html)
* [C#
  1.1%](/ONLYOFFICE/core/search?l=c%23)
* [Python
  0.6%](/ONLYOFFICE/core/search?l=python)
* [Shell
  0.5%](/ONLYOFFICE/core/search?l=shell)
* Other
  2.1%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_020a0cb0_20250115_083601.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore%2Fblob%2Fv5.6.4.13%2FASCOfficePPTXFile%2FPPTXFormat%2FLogic%2FFills%2FBlipFill.cpp)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fcore%2Fblob%2Fv5.6.4.13%2FASCOfficePPTXFile%2FPPTXFormat%2FLogic%2FFills%2FBlipFill.cpp)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ONLYOFFICE%2Fcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[core](/ONLYOFFICE/core)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fcore) You must be signed in to change notification settings
* [Fork
  226](/login?return_to=%2FONLYOFFICE%2Fcore)
* [Star
   295](/login?return_to=%2FONLYOFFICE%2Fcore)

* [Code](/ONLYOFFICE/core/tree/v5.6.4.13)
* [Pull requests
  11](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/core/tree/v5.6.4.13)
* [Pull requests](/ONLYOFFICE/core/pulls)
* [Actions](/ONLYOFFICE/core/actions)
* [Security](/ONLYOFFICE/core/security)
* [Insights](/ONLYOFFICE/core/pulse)

## Files

 v5.6.4.13
## Breadcrumbs

1. [core](/ONLYOFFICE/core/tree/v5.6.4.13)
2. /[ASCOfficePPTXFile](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile)
3. /[PPTXFormat](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat)
4. /[Logic](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat/Logic)
5. /[Fills](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat/Logic/Fills)
/
# BlipFill.cpp

Copy path Blame  Blame
## Latest commit

## History

[History](/ONLYOFFICE/core/commits/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat/Logic/Fills/BlipFill.cpp)445 lines (383 loc) · 12.2 KB v5.6.4.13
## Breadcrumbs

1. [core](/ONLYOFFICE/core/tree/v5.6.4.13)
2. /[ASCOfficePPTXFile](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile)
3. /[PPTXFormat](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat)
4. /[Logic](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat/Logic)
5. /[Fills](/ONLYOFFICE/core/tree/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat/Logic/Fills)
/
# BlipFill.cpp

Top
## File metadata and controls

* Code
* Blame

445 lines (383 loc) · 12.2 KB[Raw](https://github.com/ONLYOFFICE/core/raw/refs/tags/v5.6.4.13/ASCOfficePPTXFile/PPTXFormat/Logic/Fills/BlipFill.cpp)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445﻿/\* \* (c) Copyright Ascensio System SIA 2010-2019 \* \* This program is a free software product. You can redistribute it and/or \* modify it under the terms of the GNU Affero General Public License (AGPL) \* version 3 as published by the Free Software Foundation. In accordance with \* Section 7(a) of the GNU AGPL its Section 15 shall be amended to the effect \* that Ascensio System SIA expressly excludes the warranty of non-infringement \* of any third-party rights. \* \* This program is distributed WITHOUT ANY WARRANTY; without even the implied \* warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. For \* details, see the GNU AGPL at: http://www.gnu.org/licenses/agpl-3.0.html \* \* You can contact Ascensio System SIA at 20A-12 Ernesta Birznieka-Upisha \* street, Riga, Latvia, EU, LV-1050. \* \* The interactive user interfaces in modified source and object code versions \* of the Program must display Appropriate Legal Notices, as required under \* Section 5 of the GNU AGPL version 3. \* \* Pursuant to Section 7(b) of the License you must retain the original Product \* logo when distributing the program. Pursuant to Section 7(e) we decline to \* grant you any rights under trademark law for use of our trademarks. \* \* All the Product's GUI elements, including illustrations and icon sets, as \* well as technical writing content are licensed under the terms of the \* Creative Commons Attribution-ShareAlike 4.0 International. See the License \* terms at http://creativecommons.org/licenses/by-sa/4.0/legalcode \* \*/#include "BlipFill.h"
#include "../../../../Common/DocxFormat/Source/SystemUtility/File.h"#include "../../../../DesktopEditor/common/File.h"namespace PPTX{ namespace Logic {
 void BlipFill::fromXML(XmlUtils::CXmlLiteReader& oReader) { m\_namespace = XmlUtils::GetNamespace(oReader.GetName());  ReadAttributes( oReader );
 if ( oReader.IsEmptyNode() ) return;
 int nCurDepth = oReader.GetDepth(); while( oReader.ReadNextSiblingNode( nCurDepth ) ) { std::wstring strName = XmlUtils::GetNameNoNS(oReader.GetName()); if (\_T("blip") == strName) blip = oReader; else if (\_T("srcRect") == strName) srcRect = oReader; else if (\_T("tile") == strName) tile = oReader; else if (\_T("stretch") == strName) stretch = oReader; } } void BlipFill::fromXML(XmlUtils::CXmlNode& node) { m\_namespace = XmlUtils::GetNamespace(node.GetName());
 XmlMacroReadAttributeBase(node, L"dpi", dpi); XmlMacroReadAttributeBase(node, L"rotWithShape", rotWithShape);
 XmlUtils::CXmlNodes oNodes; if (node.GetNodes(\_T("\*"), oNodes)) { int nCount = oNodes.GetCount(); for (int i = 0; i < nCount; ++i) { XmlUtils::CXmlNode oNode; oNodes.GetAt(i, oNode);
 std::wstring strName = XmlUtils::GetNameNoNS(oNode.GetName()); if (\_T("blip") == strName) { if (!blip.IsInit())  blip = oNode; } else if (\_T("srcRect") == strName) { if (!srcRect.IsInit())  srcRect = oNode; } else if (\_T("tile") == strName) { if (!tile.IsInit())  tile = oNode; } else if (\_T("stretch") == strName) { if (!stretch.IsInit())  stretch = oNode; } } }
 FillParentPointersForChilds(); }
 std::wstring BlipFill::toXML() const { XmlUtils::CAttribute oAttr; oAttr.Write(\_T("dpi"), dpi); oAttr.Write(\_T("rotWithShape"), rotWithShape);
 XmlUtils::CNodeValue oValue; oValue.WriteNullable(blip); oValue.WriteNullable(srcRect); oValue.WriteNullable(tile); oValue.WriteNullable(stretch);
 std::wstring strName = (\_T("") == m\_namespace) ? \_T("blipFill") : (m\_namespace + \_T(":blipFill")); return XmlUtils::CreateNode(strName, oAttr, oValue); }
 void BlipFill::toXmlWriter(NSBinPptxRW::CXmlWriter\* pWriter) const { std::wstring strName = (\_T("") == m\_namespace) ? \_T("blipFill") : (m\_namespace + \_T(":blipFill")); pWriter->StartNode(strName);
 pWriter->StartAttributes(); pWriter->WriteAttribute(\_T("dpi"), dpi); pWriter->WriteAttribute(\_T("rotWithShape"), rotWithShape); pWriter->EndAttributes();
 pWriter->Write(blip);  if (srcRect.is\_init()) { pWriter->StartNode(\_T("a:srcRect"));
 pWriter->StartAttributes(); pWriter->WriteAttribute(\_T("l"), srcRect->l); pWriter->WriteAttribute(\_T("t"), srcRect->t); pWriter->WriteAttribute(\_T("r"), srcRect->r); pWriter->WriteAttribute(\_T("b"), srcRect->b); pWriter->EndAttributes();
 pWriter->EndNode(\_T("a:srcRect")); }
 pWriter->Write(tile); pWriter->Write(stretch);
 pWriter->EndNode(strName); }
 void BlipFill::toPPTY(NSBinPptxRW::CBinaryFileWriter\* pWriter) const { pWriter->StartRecord(FILL\_TYPE\_BLIP);
 pWriter->WriteBYTE(NSBinPptxRW::g\_nodeAttributeStart); pWriter->WriteInt2(0, dpi); pWriter->WriteBool2(1, rotWithShape); pWriter->WriteBYTE(NSBinPptxRW::g\_nodeAttributeEnd);
 pWriter->WriteRecord2(0, blip); pWriter->WriteRecord2(1, srcRect); pWriter->WriteRecord2(2, tile); pWriter->WriteRecord2(3, stretch);
 pWriter->EndRecord(); } void BlipFill::fromPPTY(NSBinPptxRW::CBinaryFileReader\* pReader) { pReader->Skip(4); // len BYTE \_type = pReader->GetUChar(); // FILL\_TYPE\_BLIP LONG \_e = pReader->GetPos() + pReader->GetLong() + 4;
 pReader->Skip(1);
 while (true) { BYTE \_at = pReader->GetUChar\_TypeNode(); if (\_at == NSBinPptxRW::g\_nodeAttributeEnd) break;
 switch (\_at) { case 0: dpi = pReader->GetLong(); break; case 1: rotWithShape = pReader->GetBool(); break; default: break; } }
 while (pReader->GetPos() < \_e) { BYTE rec = pReader->GetUChar();
 switch (rec) { case 0: { LONG \_s2 = pReader->GetPos(); LONG \_e2 = \_s2 + pReader->GetLong() + 4;
 pReader->Skip(1);
 while (true) { BYTE \_at = pReader->GetUChar\_TypeNode(); if (NSBinPptxRW::g\_nodeAttributeEnd == \_at) break;
 if (\_at == 0) pReader->Skip(1); }
 while (pReader->GetPos() < \_e2) { BYTE \_t = pReader->GetUChar();
 switch (\_t) { case 0: case 1: { // id. embed / link pReader->Skip(4); break; } case 10: case 11: { // id. embed / link pReader->GetString2(); break; } case 2: { if (!blip.is\_init()) blip = new PPTX::Logic::Blip();  pReader->Skip(4); ULONG count\_effects = pReader->GetULong(); for (ULONG \_eff = 0; \_eff < count\_effects; ++\_eff) { pReader->Skip(1); // type
 blip->Effects.push\_back(UniEffect()); blip->Effects.back().fromPPTY(pReader);
 if (false == blip->Effects.back().is\_init()) { blip->Effects.pop\_back(); } }  }break; case 3: { pReader->Skip(6); // len + start attributes + type
 // ------------------- std::wstring strImagePath = pReader->GetString2();
 std::wstring strOrigBase64; std::wstring strTempFile ;
 bool bIsUrl = false;  if (0 == strImagePath.find(\_T("data:"))) { bool bBase64 = false;  strOrigBase64 = strImagePath; int nFind = (int)strImagePath.find(\_T(","));
 std::wstring sImageExtension;
 std::wstring sFormatDataString = XmlUtils::GetLower(strImagePath.substr(5,nFind-5)); { int nFind1 = (int)sFormatDataString.find(\_T("base64")); if (nFind1 >=0 ) bBase64 = true;  nFind1 = (int)sFormatDataString.find(\_T("image/")); if (nFind1 >= 0) { int nFind2 = (int)sFormatDataString.find(\_T(";")); if (nFind2 < 0) nFind2 = (int)sFormatDataString.length();  sImageExtension = sFormatDataString.substr(nFind1 + 6, nFind2 - 6 - nFind1); } } strImagePath.erase(0, nFind + 1);
 std::string \_\_s = std::string(strImagePath.begin(), strImagePath.end()); int len = (int)\_\_s.length(); BYTE\* pDstBuffer = NULL; int dstLen = 0;
 if (true)//(bBase64) { bBase64 = true; int dstLenTemp = Base64::Base64DecodeGetRequiredLength(len);
 pDstBuffer = new BYTE[dstLenTemp]; dstLen = dstLenTemp; Base64::Base64Decode(\_\_s.c\_str(), len, pDstBuffer, &dstLen); } else { pDstBuffer = (BYTE\*) \_\_s.c\_str(); dstLen = len; } CImageFileFormatChecker checker; std::wstring detectImageExtension = checker.DetectFormatByData(pDstBuffer, dstLen);
 if (false == detectImageExtension.empty()) { if (sImageExtension.empty()) sImageExtension = detectImageExtension;
 //папки media может не быть в случае, когда все картинки base64(поскольку файл временный, папку media не создаем) std::wstring tempFilePath = pReader->m\_strFolder + FILE\_SEPARATOR\_STR;  OOX::CPath pathTemp = NSFile::CFileBinary::CreateTempFileWithUniqueName(tempFilePath, \_T("img")) + \_T(".") + sImageExtension;
 CFile oTempFile; oTempFile.CreateFile(pathTemp.GetPath()); oTempFile.WriteFile((void\*)pDstBuffer, (DWORD)dstLen); oTempFile.CloseFile();  strImagePath = strTempFile =pathTemp.GetPath(); // strTempFile для удаления } else {// бяка strImagePath.clear(); } if (bBase64) { RELEASEARRAYOBJECTS(pDstBuffer); } } else { if (0 != strImagePath.find(\_T("http:")) && 0 != strImagePath.find(\_T("https:")) && 0 != strImagePath.find(\_T("ftp:")) && 0 != strImagePath.find(\_T("file:"))) { if (0 == strImagePath.find(\_T("theme"))) { strImagePath = pReader->m\_strFolderExternalThemes + FILE\_SEPARATOR\_STR + strImagePath; } else { strImagePath = pReader->m\_strFolder + FILE\_SEPARATOR\_STR + \_T("media") + FILE\_SEPARATOR\_STR + strImagePath; } } else bIsUrl = true; } // -------------------  //в случае url не надо нормализовать путь if(!bIsUrl) { OOX::CPath pathUrl = strImagePath; strImagePath = pathUrl.GetPath(); }
 NSBinPptxRW::\_relsGeneratorInfo oRelsGeneratorInfo = pReader->m\_pRels->WriteImage(strImagePath, additionalFile, oleData, strOrigBase64);
 // ------------------- if (!strTempFile.empty()) { CDirectory::DeleteFile(strTempFile); } // -------------------
 if (!blip.is\_init()) blip = new PPTX::Logic::Blip();
 if (oRelsGeneratorInfo.nImageRId > 0) { blip->embed = new OOX::RId(oRelsGeneratorInfo.nImageRId); }  if(oRelsGeneratorInfo.nOleRId > 0) { blip->oleRid = OOX::RId(oRelsGeneratorInfo.nOleRId).get(); blip->oleFilepathBin = oRelsGeneratorInfo.sFilepathOle; blip->oleFilepathImage = oRelsGeneratorInfo.sFilepathImage; } if(oRelsGeneratorInfo.nMediaRId > 0) { blip->mediaRid = OOX::RId(oRelsGeneratorInfo.nMediaRId).get(); blip->mediaFilepath = oRelsGeneratorInfo.sFilepathMedia; } pReader->Skip(1); // end attribute break; } default: { pReader->SkipRecord(); break; } } }
 pReader->Seek(\_e2); break; } case 1: { srcRect = new PPTX::Logic::Rect(); srcRect->fromPPTY(pReader);  break; } case 2: { tile = new PPTX::Logic::Tile(); tile->fromPPTY(pReader); break; } case 3: { stretch = new PPTX::Logic::Stretch(); pReader->SkipRecord(); break; } default: { // пока никаких настроек градиента нет pReader->SkipRecord(); } } }
 pReader->Seek(\_e); }
 } // namespace Logic} // namespace PPTX

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


