=== Content from github.com_ce7dd633_20250114_225918.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver%2Fblob%2Fv5.6.0.21%2FDocService%2Fsources%2Fconverterservice.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver%2Fblob%2Fv5.6.0.21%2FDocService%2Fsources%2Fconverterservice.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ONLYOFFICE%2Fserver)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[server](/ONLYOFFICE/server)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fserver) You must be signed in to change notification settings
* [Fork
  242](/login?return_to=%2FONLYOFFICE%2Fserver)
* [Star
   197](/login?return_to=%2FONLYOFFICE%2Fserver)

* [Code](/ONLYOFFICE/server/tree/v5.6.0.21)
* [Pull requests
  1](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/server/tree/v5.6.0.21)
* [Pull requests](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_61a30c32_20250114_225915.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2FDocumentServer)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2FDocumentServer)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ONLYOFFICE%2FDocumentServer)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[DocumentServer](/ONLYOFFICE/DocumentServer)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2FDocumentServer) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FONLYOFFICE%2FDocumentServer)
* [Star
   5k](/login?return_to=%2FONLYOFFICE%2FDocumentServer)

ONLYOFFICE Docs is a free collaborative online office suite comprising viewers and editors for texts, spreadsheets and presentations, forms and PDF, fully compatible with Office Open XML formats: .docx, .xlsx, .pptx and enabling collaborative editing in real time.

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### License

[AGPL-3.0 license](/ONLYOFFICE/DocumentServer/blob/master/LICENSE.txt)

[5k
stars](/ONLYOFFICE/DocumentServer/stargazers) [1.1k
forks](/ONLYOFFICE/DocumentServer/forks) [Branches](/ONLYOFFICE/DocumentServer/branches) [Tags](/ONLYOFFICE/DocumentServer/tags) [Activity](/ONLYOFFICE/DocumentServer/activity)
 [Star](/login?return_to=%2FONLYOFFICE%2FDocumentServer)

 [Notifications](/login?return_to=%2FONLYOFFICE%2FDocumentServer) You must be signed in to change notification settings

* [Code](/ONLYOFFICE/DocumentServer)
* [Issues
  921](/ONLYOFFICE/DocumentServer/issues)
* [Pull requests
  1](/ONLYOFFICE/DocumentServer/pulls)
* [Discussions](/ONLYOFFICE/DocumentServer/discussions)
* [Actions](/ONLYOFFICE/DocumentServer/actions)
* [Wiki](/ONLYOFFICE/DocumentServer/wiki)
* [Security](/ONLYOFFICE/DocumentServer/security)
* [Insights](/ONLYOFFICE/DocumentServer/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/DocumentServer)
* [Issues](/ONLYOFFICE/DocumentServer/issues)
* [Pull requests](/ONLYOFFICE/DocumentServer/pulls)
* [Discussions](/ONLYOFFICE/DocumentServer/discussions)
* [Actions](/ONLYOFFICE/DocumentServer/actions)
* [Wiki](/ONLYOFFICE/DocumentServer/wiki)
* [Security](/ONLYOFFICE/DocumentServer/security)
* [Insights](/ONLYOFFICE/DocumentServer/pulse)

# ONLYOFFICE/DocumentServer

    master[Branches](/ONLYOFFICE/DocumentServer/branches)[Tags](/ONLYOFFICE/DocumentServer/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[492 Commits](/ONLYOFFICE/DocumentServer/commits/master/) | | |
| [.github](/ONLYOFFICE/DocumentServer/tree/master/.github ".github") | | [.github](/ONLYOFFICE/DocumentServer/tree/master/.github ".github") |  |  |
| [core @ 029e6c6](/ONLYOFFICE/core/tree/029e6c6df762cc84a0597033e47411c2563ab37f "core") | | [core @ 029e6c6](/ONLYOFFICE/core/tree/029e6c6df762cc84a0597033e47411c2563ab37f "core") |  |  |
| [core-fonts @ d5d80e6](/ONLYOFFICE/core-fonts/tree/d5d80e6ae15800ccf31e1c4dbb1ae3385992e0c2 "core-fonts") | | [core-fonts @ d5d80e6](/ONLYOFFICE/core-fonts/tree/d5d80e6ae15800ccf31e1c4dbb1ae3385992e0c2 "core-fonts") |  |  |
| [dictionaries @ 25e1e98](/ONLYOFFICE/dictionaries/tree/25e1e985e4cc71be39812a120a14b6f07095266d "dictionaries") | | [dictionaries @ 25e1e98](/ONLYOFFICE/dictionaries/tree/25e1e985e4cc71be39812a120a14b6f07095266d "dictionaries") |  |  |
| [sdkjs @ e37d97e](/ONLYOFFICE/sdkjs/tree/e37d97e2810d0e6b19f41a7f989f279fb566943d "sdkjs") | | [sdkjs @ e37d97e](/ONLYOFFICE/sdkjs/tree/e37d97e2810d0e6b19f41a7f989f279fb566943d "sdkjs") |  |  |
| [server @ 03f49f8](/ONLYOFFICE/server/tree/03f49f8e954a9b76736cb62ecf970d916d135ba5 "server") | | [server @ 03f49f8](/ONLYOFFICE/server/tree/03f49f8e954a9b76736cb62ecf970d916d135ba5 "server") |  |  |
| [web-apps @ e6e56e8](/ONLYOFFICE/web-apps/tree/e6e56e8a5ebafad8e730eaec67595d9b8a848f03 "web-apps") | | [web-apps @ e6e56e8](/ONLYOFFICE/web-apps/tree/e6e56e8a5ebafad8e730eaec67595d9b8a848f03 "web-apps") |  |  |
| [.aspell.en.pws](/ONLYOFFICE/DocumentServer/blob/master/.aspell.en.pws ".aspell.en.pws") | | [.aspell.en.pws](/ONLYOFFICE/DocumentServer/blob/master/.aspell.en.pws ".aspell.en.pws") |  |  |
| [.gitmodules](/ONLYOFFICE/DocumentServer/blob/master/.gitmodules ".gitmodules") | | [.gitmodules](/ONLYOFFICE/DocumentServer/blob/master/.gitmodules ".gitmodules") |  |  |
| [.markdownlint.json](/ONLYOFFICE/DocumentServer/blob/master/.markdownlint.json ".markdownlint.json") | | [.markdownlint.json](/ONLYOFFICE/DocumentServer/blob/master/.markdownlint.json ".markdownlint.json") |  |  |
| [.mrconfig](/ONLYOFFICE/DocumentServer/blob/master/.mrconfig ".mrconfig") | | [.mrconfig](/ONLYOFFICE/DocumentServer/blob/master/.mrconfig ".mrconfig") |  |  |
| [CHANGELOG.md](/ONLYOFFICE/DocumentServer/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/ONLYOFFICE/DocumentServer/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [LICENSE.txt](/ONLYOFFICE/DocumentServer/blob/master/LICENSE.txt "LICENSE.txt") | | [LICENSE.txt](/ONLYOFFICE/DocumentServer/blob/master/LICENSE.txt "LICENSE.txt") |  |  |
| [ROADMAP.md](/ONLYOFFICE/DocumentServer/blob/master/ROADMAP.md "ROADMAP.md") | | [ROADMAP.md](/ONLYOFFICE/DocumentServer/blob/master/ROADMAP.md "ROADMAP.md") |  |  |
| [Readme.md](/ONLYOFFICE/DocumentServer/blob/master/Readme.md "Readme.md") | | [Readme.md](/ONLYOFFICE/DocumentServer/blob/master/Readme.md "Readme.md") |  |  |
| [mr-update.sh](/ONLYOFFICE/DocumentServer/blob/master/mr-update.sh "mr-update.sh") | | [mr-update.sh](/ONLYOFFICE/DocumentServer/blob/master/mr-update.sh "mr-update.sh") |  |  |
| View all files | | |

## Repository files navigation

* README
* AGPL-3.0 license

[![License](https://camo.githubusercontent.com/1720e1c42dd5a9a5cfaed3a4abec210e929921fa9271e404263661daf3c7905b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d474e552532304147504c25323056332d677265656e2e7376673f7374796c653d666c6174)](https://www.gnu.org/licenses/agpl-3.0.en.html) [![Release](https://camo.githubusercontent.com/ddb8bd81a4d6fc7401d08bb36c122c29e3e0a2674f9db7b305bbc96123478f9d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f52656c656173652d76382e312e312d626c75652e7376673f7374796c653d666c6174)](https://camo.githubusercontent.com/ddb8bd81a4d6fc7401d08bb36c122c29e3e0a2674f9db7b305bbc96123478f9d/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f52656c656173652d76382e312e312d626c75652e7376673f7374796c653d666c6174)

## Overview

[ONLYOFFICE Docs](https://www.onlyoffice.com/office-suite.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS)\* is a free collaborative online office suite comprising viewers and editors for texts, spreadsheets and presentations, forms and PDF, fully compatible with Office Open XML formats: .docx, .xlsx, .pptx and enabling collaborative editing in real time.

ONLYOFFICE Docs can be used as a part of [ONLYOFFICE Workspace](https://www.onlyoffice.com/workspace.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubCS) or with [third-party sync&share solutions](https://www.onlyoffice.com/all-connectors.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS) (e.g. Nextcloud, ownCloud, Seafile) to enable collaborative editing within their interface.

It has three editions - [Community, Enterprise, and Developer](#onlyoffice-docs-editions).

\* Starting from version 6.0, Document Server is distributed under a new name - ONLYOFFICE Docs.

## Components

ONLYOFFICE Docs contains the following components:

* [server](https://github.com/ONLYOFFICE/server) - the backend server software layer which is the base for all other components of ONLYOFFICE Docs.
* [core](https://github.com/ONLYOFFICE/core) - server core components of ONLYOFFICE Docs which enable the conversion between the most popular office document formats (DOC, DOCX, ODT, RTF, TXT, PDF, HTML, EPUB, XPS, DjVu, XLS, XLSX, ODS, CSV, PPT, PPTX, ODP).
* [sdkjs](https://github.com/ONLYOFFICE/sdkjs) - JavaScript SDK for the ONLYOFFICE Docs which contains API for all the included components client-side interaction.
* [web-apps](https://github.com/ONLYOFFICE/web-apps) - the frontend for ONLYOFFICE Docs which builds the program interface and allows the user create, edit, save and export text, spreadsheet and presentation documents using the common interface of a document editor.
* [dictionaries](https://github.com/ONLYOFFICE/dictionaries) - the dictionaries of various languages used for spellchecking in ONLYOFFICE Docs.

## Plugins

ONLYOFFICE Docs offer support for plugins allowing developers to add specific features to the editors that are not directly related to the OOXML format. For more information see [our API](https://api.onlyoffice.com/plugin/basic) or visit github [plugins repo](https://github.com/ONLYOFFICE/onlyoffice.github.io).

## Functionality

ONLYOFFICE Docs includes the following editors:

* [ONLYOFFICE Document Editor](https://www.onlyoffice.com/document-editor.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE Spreadsheet Editor](https://www.onlyoffice.com/spreadsheet-editor.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE Presentation Editor](https://www.onlyoffice.com/presentation-editor.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE Form Creator](https://www.onlyoffice.com/form-creator.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)
* [ONLYOFFICE PDF editor, reader & converter](https://www.onlyoffice.com/pdf-reader.aspx?utm_source=GitHub&utm_medium=social&utm_campaign=GitHubDesktop)

The editors allow you to create, edit, save and export text, spreadsheet and presentation documents and additionally have the features:

* Collaborative editing
* Hieroglyph support
* Reviewing
* Spell-checking

## ONLYOFFICE Docs editions

ONLYOFFICE offers different versions of its online document editors that can be deployed on your own servers.

ONLYOFFICE Docs (packaged as Document Server):

* Community Edition (`onlyoffice-documentserver` package)
* Enterprise Edition (`onlyoffice-documentserver-ee` package)
* Developer Edition (`onlyoffice-documentserver-de` package)

The table below will help you to make the right choice.

| Pricing and licensing | Community Edition | Enterprise Edition | Developer Edition |
| --- | --- | --- | --- |
|  | [Get it now](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-community) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-enterprise) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-developer) |
| Cost | FREE | [Go to the pricing page](https://www.onlyoffice.com/docs-enterprise-prices.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS) | [Go to the pricing page](https://www.onlyoffice.com/developer-edition-prices.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS) |
| Simultaneous connections | up to 20 maximum | As in chosen pricing plan | As in chosen pricing plan |
| Number of users | up to 20 recommended | As in chosen pricing plan | As in chosen pricing plan |
| Clusterization | - | + | + |
| License | GNU AGPL v.3 | Proprietary | Proprietary |
| **Support** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Documentation | [Help Center](https://helpcenter.onlyoffice.com/installation/docs-community-index.aspx) | [Help Center](https://helpcenter.onlyoffice.com/installation/docs-enterprise-index.aspx) | [Help Center](https://helpcenter.onlyoffice.com/installation/docs-developer-index.aspx) |
| Standard support | [GitHub](https://github.com/ONLYOFFICE/DocumentServer/issues) or paid | One year support included | One year support included |
| Premium support | Contact Us | Contact Us | Contact Us |
| **Services** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Conversion Service | + | + | + |
| Document Builder Service | + | + | + |
| **Interface** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Tabbed interface | + | + | + |
| Dark theme | + | + | + |
| 125%, 150%, 175%, 200% scaling | + | + | + |
| White label | - | - | + |
| Integrated test example (node.js) | + | + | + |
| Mobile web editors | - | +\*\* | +\*\* |
| **Plugins & Macros** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Plugins | + | + | + |
| Macros | + | + | + |
| **Collaborative capabilities** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Two co-editing modes | + | + | + |
| Comments | + | + | + |
| Built-in chat | + | + | + |
| Review and tracking changes | + | + | + |
| Display modes of tracking changes | + | + | + |
| Version history | + | + | + |
| **Document Editor features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Font and paragraph formatting | + | + | + |
| Object insertion | + | + | + |
| Adding Content control | + | + | + |
| Editing Content control | + | + | + |
| Layout tools | + | + | + |
| Table of contents | + | + | + |
| Navigation panel | + | + | + |
| Mail Merge | + | + | + |
| Comparing Documents | + | + | + |
| **Spreadsheet Editor features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Font and paragraph formatting | + | + | + |
| Object insertion | + | + | + |
| Functions, formulas, equations | + | + | + |
| Table templates | + | + | + |
| Pivot tables | + | + | + |
| Data validation | + | + | + |
| Conditional formatting | + | + | + |
| Sparklines | + | + | + |
| Sheet Views | + | + | + |
| **Presentation Editor features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Font and paragraph formatting | + | + | + |
| Object insertion | + | + | + |
| Transitions | + | + | + |
| Animations | + | + | + |
| Presenter mode | + | + | + |
| Notes | + | + | + |
| **Form creator features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Adding form fields | + | + | + |
| Form preview | + | + | + |
| Saving as PDF | + | + | + |
| **Working with PDF** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| Text annotations (highlight, underline, cross out) | + | + | + |
| Comments | + | + | + |
| Freehand drawings | + | + | + |
| Form filling | + | + | + |
| **Security features** | **Community Edition** | **Enterprise Edition** | **Developer Edition** |
| End-to-end encryption via Private Rooms\*\*\* | + | + | - |
|  | [Get it now](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-community) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-enterprise) | [Start Free Trial](https://www.onlyoffice.com/download-docs.aspx?utm_source=github&utm_medium=cpc&utm_campaign=GitHubDS#docs-developer) |

\*\* If supported by DMS

\*\*\* End-to-end encryption via Private Rooms requires ONLYOFFICE Workspace

## How to Install on a local server

The easiest way to install ONLYOFFICE Docs is to use **the Docker image** ([the official source code](https://github.com/ONLYOFFICE/Docker-DocumentServer))

* [Installing ONLYOFFICE Docs Docker](https://helpcenter.onlyoffice.com/installation/docs-community-install-docker.aspx)
* [Installing ONLYOFFICE Docs for Linux](https://helpcenter.onlyoffice.com/installation/docs-community-install-ubuntu.aspx)
* [Installing ONLYOFFICE Docs for Windows](https://helpcenter.onlyoffice.com/installation/docs-community-install-windows.aspx)

## How to Build

Instructions for building ONLYOFFICE Docs for a local server from source code are in [our helpcenter](https://helpcenter.onlyoffice.com/installation/docs-community-compile.aspx).

## License

ONLYOFFICE Docs is licensed under the GNU Affero Public License, version 3.0. See [LICENSE](https://onlyo.co/38YZGJh) for more information.

## User Feedback and Support

If you have any problems with or questions about ONLYOFFICE Docs, please visit our official forum to find answers to your questions: [forum.onlyoffice.com](https://forum.onlyoffice.com) or you can ask and answer ONLYOFFICE development questions on [Stack Overflow](https://stackoverflow.com/questions/tagged/onlyoffice).

## About

ONLYOFFICE Docs is a free collaborative online office suite comprising viewers and editors for texts, spreadsheets and presentations, forms and PDF, fully compatible with Office Open XML formats: .docx, .xlsx, .pptx and enabling collaborative editing in real time.

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### Topics

[nodejs](/topics/nodejs "Topic: nodejs")
[node](/topics/node "Topic: node")
[presentation](/topics/presentation "Topic: presentation")
[excel](/topics/excel "Topic: excel")
[word](/topics/word "Topic: word")
[xlsx](/topics/xlsx "Topic: xlsx")
[xls](/topics/xls "Topic: xls")
[spreadsheet](/topics/spreadsheet "Topic: spreadsheet")
[collaboration](/topics/collaboration "Topic: collaboration")
[office](/topics/office "Topic: office")
[docx](/topics/docx "Topic: docx")
[node-js](/topics/node-js "Topic: node-js")
[pptx](/topics/pptx "Topic: pptx")
[collaborative](/topics/collaborative "Topic: collaborative")
[doc](/topics/doc "Topic: doc")
[ods](/topics/ods "Topic: ods")
[odp](/topics/odp "Topic: odp")
[odt](/topics/odt "Topic: odt")
[ppt](/topics/ppt "Topic: ppt")
[onlyoffice](/topics/onlyoffice "Topic: onlyoffice")

### Resources

[Readme](#readme-ov-file)
### License

[AGPL-3.0 license](#AGPL-3.0-1-ov-file)

[Activity](/ONLYOFFICE/DocumentServer/activity)
[Custom properties](/ONLYOFFICE/DocumentServer/custom-properties)
### Stars

[**5k**
stars](/ONLYOFFICE/DocumentServer/stargazers)
### Watchers

[**175**
watching](/ONLYOFFICE/DocumentServer/watchers)
### Forks

[**1.1k**
forks](/ONLYOFFICE/DocumentServer/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2FDocumentServer&report=ONLYOFFICE+%28user%29)

## [Releases 102](/ONLYOFFICE/DocumentServer/releases)

[ONLYOFFICE-DocumentServer-8.2.2
Latest

Nov 28, 2024](/ONLYOFFICE/DocumentServer/releases/tag/v8.2.2)
[+ 101 releases](/ONLYOFFICE/DocumentServer/releases)

## [Contributors 17](/ONLYOFFICE/DocumentServer/graphs/contributors)

[+ 3 contributors](/ONLYOFFICE/DocumentServer/graphs/contributors)

## Languages

* [Shell
  100.0%](/ONLYOFFICE/DocumentServer/search?l=shell)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_85dd1b99_20250114_225929.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver%2Fblob%2Fv5.6.0.21%2FFileConverter%2Fsources%2Fconverter.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver%2Fblob%2Fv5.6.0.21%2FFileConverter%2Fsources%2Fconverter.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ONLYOFFICE%2Fserver)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[server](/ONLYOFFICE/server)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fserver) You must be signed in to change notification settings
* [Fork
  242](/login?return_to=%2FONLYOFFICE%2Fserver)
* [Star
   197](/login?return_to=%2FONLYOFFICE%2Fserver)

* [Code](/ONLYOFFICE/server/tree/v5.6.0.21)
* [Pull requests
  1](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/server/tree/v5.6.0.21)
* [Pull requests](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

## Files

 v5.6.0.21
## Breadcrumbs

1. [server](/ONLYOFFICE/server/tree/v5.6.0.21)
2. /[FileConverter](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter)
3. /[sources](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter/sources)
/
# converter.js

Copy path Blame  Blame
## Latest commit

## History

[History](/ONLYOFFICE/server/commits/v5.6.0.21/FileConverter/sources/converter.js)766 lines (751 loc) · 30.6 KB v5.6.0.21
## Breadcrumbs

1. [server](/ONLYOFFICE/server/tree/v5.6.0.21)
2. /[FileConverter](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter)
3. /[sources](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter/sources)
/
# converter.js

Top
## File metadata and controls

* Code
* Blame

766 lines (751 loc) · 30.6 KB[Raw](https://github.com/ONLYOFFICE/server/raw/refs/tags/v5.6.0.21/FileConverter/sources/converter.js)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766/\* \* (c) Copyright Ascensio System SIA 2010-2019 \* \* This program is a free software product. You can redistribute it and/or \* modify it under the terms of the GNU Affero General Public License (AGPL) \* version 3 as published by the Free Software Foundation. In accordance with \* Section 7(a) of the GNU AGPL its Section 15 shall be amended to the effect \* that Ascensio System SIA expressly excludes the warranty of non-infringement \* of any third-party rights. \* \* This program is distributed WITHOUT ANY WARRANTY; without even the implied \* warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. For \* details, see the GNU AGPL at: http://www.gnu.org/licenses/agpl-3.0.html \* \* You can contact Ascensio System SIA at 20A-12 Ernesta Birznieka-Upisha \* street, Riga, Latvia, EU, LV-1050. \* \* The interactive user interfaces in modified source and object code versions \* of the Program must display Appropriate Legal Notices, as required under \* Section 5 of the GNU AGPL version 3. \* \* Pursuant to Section 7(b) of the License you must retain the original Product \* logo when distributing the program. Pursuant to Section 7(e) we decline to \* grant you any rights under trademark law for use of our trademarks. \* \* All the Product's GUI elements, including illustrations and icon sets, as \* well as technical writing content are licensed under the terms of the \* Creative Commons Attribution-ShareAlike 4.0 International. See the License \* terms at http://creativecommons.org/licenses/by-sa/4.0/legalcode \* \*/
'use strict';var os = require('os');var path = require('path');var fs = require('fs');var url = require('url');var childProcess = require('child\_process');var co = require('co');var config = require('config');var spawnAsync = require('@expo/spawn-async');const bytes = require('bytes');var configConverter = config.get('FileConverter.converter');
var commonDefines = require('./../../Common/sources/commondefines');var storage = require('./../../Common/sources/storage-base');var utils = require('./../../Common/sources/utils');var logger = require('./../../Common/sources/logger');var constants = require('./../../Common/sources/constants');var baseConnector = require('./../../DocService/sources/baseConnector');var statsDClient = require('./../../Common/sources/statsdclient');var queueService = require('./../../Common/sources/taskqueueRabbitMQ');
var cfgDownloadMaxBytes = configConverter.has('maxDownloadBytes') ? configConverter.get('maxDownloadBytes') : 100000000;var cfgDownloadTimeout = configConverter.has('downloadTimeout') ? configConverter.get('downloadTimeout') : 60;var cfgDownloadAttemptMaxCount = configConverter.has('downloadAttemptMaxCount') ? configConverter.get('downloadAttemptMaxCount') : 3;var cfgDownloadAttemptDelay = configConverter.has('downloadAttemptDelay') ? configConverter.get('downloadAttemptDelay') : 1000;var cfgFontDir = configConverter.get('fontDir');var cfgPresentationThemesDir = configConverter.get('presentationThemesDir');var cfgX2tPath = configConverter.get('x2tPath');var cfgDocbuilderPath = configConverter.get('docbuilderPath');var cfgDocbuilderAllFontsPath = configConverter.get('docbuilderAllFontsPath');var cfgArgs = configConverter.get('args');var cfgSpawnOptions = configConverter.get('spawnOptions');if (cfgSpawnOptions.env) { Object.assign(cfgSpawnOptions.env, process.env);}var cfgErrorFiles = configConverter.get('errorfiles');var cfgInputLimits = configConverter.get('inputLimits');const cfgStreamWriterBufferSize = configConverter.get('streamWriterBufferSize');//cfgMaxRequestChanges was obtained as a result of the test: 84408 changes - 5,16 MBconst cfgMaxRequestChanges = config.get('services.CoAuthoring.server.maxRequestChanges');var cfgTokenEnableRequestOutbox = config.get('services.CoAuthoring.token.enable.request.outbox');const cfgForgottenFilesName = config.get('services.CoAuthoring.server.forgottenfilesname');
//windows limit 512(2048) https://msdn.microsoft.com/en-us/library/6e3b887c.aspx//Ubuntu 14.04 limit 4096 http://underyx.me/2015/05/18/raising-the-maximum-number-of-file-descriptors.html//MacOs limit 2048 http://apple.stackexchange.com/questions/33715/too-many-open-filesvar MAX\_OPEN\_FILES = 200;var TEMP\_PREFIX = 'ASC\_CONVERT';var queue = null;var clientStatsD = statsDClient.getClient();var exitCodesReturn = [constants.CONVERT\_PARAMS, constants.CONVERT\_NEED\_PARAMS, constants.CONVERT\_CORRUPTED, constants.CONVERT\_DRM, constants.CONVERT\_PASSWORD, constants.CONVERT\_LIMITS];var exitCodesMinorError = [constants.CONVERT\_NEED\_PARAMS, constants.CONVERT\_DRM, constants.CONVERT\_PASSWORD];var exitCodesUpload = [constants.NO\_ERROR, constants.CONVERT\_CORRUPTED, constants.CONVERT\_NEED\_PARAMS, constants.CONVERT\_DRM];let inputLimitsXmlCache;
function TaskQueueDataConvert(task) { var cmd = task.getCmd(); this.key = cmd.savekey ? cmd.savekey : cmd.id; this.fileFrom = null; this.fileTo = null; if(constants.AVS\_OFFICESTUDIO\_FILE\_OTHER\_PDFA !== cmd.outputformat){ this.formatTo = cmd.outputformat; } else { this.formatTo = constants.AVS\_OFFICESTUDIO\_FILE\_CROSSPLATFORM\_PDF; this.isPDFA = true; } this.csvTxtEncoding = cmd.getCodepage(); this.csvDelimiter = cmd.getDelimiter(); this.csvDelimiterChar = cmd.getDelimiterChar(); this.paid = task.getPaid(); this.embeddedFonts = cmd.embeddedfonts; this.fromChanges = task.getFromChanges(); //todo if (cfgFontDir) { this.fontDir = path.resolve(cfgFontDir); } else { this.fontDir = cfgFontDir; } this.themeDir = path.resolve(cfgPresentationThemesDir); this.mailMergeSend = cmd.mailmergesend; this.thumbnail = cmd.thumbnail; this.jsonParams = cmd.getJsonParams(); this.lcid = cmd.getLCID(); this.password = cmd.getPassword(); this.noBase64 = cmd.getNoBase64(); this.timestamp = new Date();}TaskQueueDataConvert.prototype = { serialize: function(fsPath) { let xml = '\ufeff<?xml version="1.0" encoding="utf-8"?>'; xml += '<TaskQueueDataConvert xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'; xml += ' xmlns:xsd="http://www.w3.org/2001/XMLSchema">'; xml += this.serializeXmlProp('m\_sKey', this.key); xml += this.serializeXmlProp('m\_sFileFrom', this.fileFrom); xml += this.serializeXmlProp('m\_sFileTo', this.fileTo); xml += this.serializeXmlProp('m\_nFormatTo', this.formatTo); xml += this.serializeXmlProp('m\_bIsPDFA', this.isPDFA); xml += this.serializeXmlProp('m\_nCsvTxtEncoding', this.csvTxtEncoding); xml += this.serializeXmlProp('m\_nCsvDelimiter', this.csvDelimiter); xml += this.serializeXmlProp('m\_nCsvDelimiterChar', this.csvDelimiterChar); xml += this.serializeXmlProp('m\_bPaid', this.paid); xml += this.serializeXmlProp('m\_bEmbeddedFonts', this.embeddedFonts); xml += this.serializeXmlProp('m\_bFromChanges', this.fromChanges); xml += this.serializeXmlProp('m\_sFontDir', this.fontDir); xml += this.serializeXmlProp('m\_sThemeDir', this.themeDir); if (this.mailMergeSend) { xml += this.serializeMailMerge(this.mailMergeSend); } if (this.thumbnail) { xml += this.serializeThumbnail(this.thumbnail); } xml += this.serializeXmlProp('m\_sJsonParams', this.jsonParams); xml += this.serializeXmlProp('m\_nLcid', this.lcid); xml += this.serializeXmlProp('m\_oTimestamp', this.timestamp.toISOString()); xml += this.serializeXmlProp('m\_bIsNoBase64', this.noBase64); xml += this.serializeLimit(); xml += '</TaskQueueDataConvert>'; fs.writeFileSync(fsPath, xml, {encoding: 'utf8'}); let hiddenXml; if (undefined !== this.password) { hiddenXml = '<TaskQueueDataConvert>'; hiddenXml += this.serializeXmlProp('m\_sPassword', this.password); hiddenXml += '</TaskQueueDataConvert>'; } return hiddenXml; }, serializeMailMerge: function(data) { var xml = '<m\_oMailMergeSend>'; xml += this.serializeXmlProp('from', data.getFrom()); xml += this.serializeXmlProp('to', data.getTo()); xml += this.serializeXmlProp('subject', data.getSubject()); xml += this.serializeXmlProp('mailFormat', data.getMailFormat()); xml += this.serializeXmlProp('fileName', data.getFileName()); xml += this.serializeXmlProp('message', data.getMessage()); xml += this.serializeXmlProp('recordFrom', data.getRecordFrom()); xml += this.serializeXmlProp('recordTo', data.getRecordTo()); xml += this.serializeXmlProp('recordCount', data.getRecordCount()); xml += this.serializeXmlProp('userid', data.getUserId()); xml += this.serializeXmlProp('url', data.getUrl()); xml += '</m\_oMailMergeSend>'; return xml; }, serializeThumbnail: function(data) { var xml = '<m\_oThumbnail>'; xml += this.serializeXmlProp('format', data.getFormat()); xml += this.serializeXmlProp('aspect', data.getAspect()); xml += this.serializeXmlProp('first', data.getFirst()); xml += this.serializeXmlProp('width', data.getWidth()); xml += this.serializeXmlProp('height', data.getHeight()); xml += '</m\_oThumbnail>'; return xml; }, serializeLimit: function() { if (!inputLimitsXmlCache) { var xml = '<m\_oInputLimits>'; for (let i = 0; i < cfgInputLimits.length; ++i) { let limit = cfgInputLimits[i]; if (limit.type && limit.zip) { xml += '<m\_oInputLimit'; xml += this.serializeXmlAttr('type', limit.type); xml += '>'; xml += '<m\_oZip'; if (limit.zip.compressed) { xml += this.serializeXmlAttr('compressed', bytes.parse(limit.zip.compressed)); } if (limit.zip.uncompressed) { xml += this.serializeXmlAttr('uncompressed', bytes.parse(limit.zip.uncompressed)); } xml += this.serializeXmlAttr('template', limit.zip.template); xml += '/>'; xml += '</m\_oInputLimit>'; } } xml += '</m\_oInputLimits>'; inputLimitsXmlCache = xml; } return inputLimitsXmlCache; }, serializeXmlProp: function(name, value) { var xml = ''; if (null != value) { xml += '<' + name + '>'; xml += utils.encodeXml(value.toString()); xml += '</' + name + '>'; } else { xml += '<' + name + ' xsi:nil="true" />'; } return xml; }, serializeXmlAttr: function(name, value) { var xml = ''; if (null != value) { xml += ' ' + name + '=\"'; xml += utils.encodeXml(value.toString()); xml += '\"'; } return xml; }};
function getTempDir() { var tempDir = os.tmpdir(); var now = new Date(); var newTemp; while (!newTemp || fs.existsSync(newTemp)) { var newName = [TEMP\_PREFIX, now.getYear(), now.getMonth(), now.getDate(), '-', (Math.random() \* 0x100000000 + 1).toString(36) ].join(''); newTemp = path.join(tempDir, newName); } fs.mkdirSync(newTemp); var sourceDir = path.join(newTemp, 'source'); fs.mkdirSync(sourceDir); var resultDir = path.join(newTemp, 'result'); fs.mkdirSync(resultDir); return {temp: newTemp, source: sourceDir, result: resultDir};}function\* downloadFile(docId, uri, fileFrom, withAuthorization) { var res = constants.CONVERT\_DOWNLOAD; var data = null; var downloadAttemptCount = 0; var urlParsed = url.parse(uri); var filterStatus = yield\* utils.checkHostFilter(urlParsed.hostname); if (0 == filterStatus) { while (constants.NO\_ERROR !== res && downloadAttemptCount++ < cfgDownloadAttemptMaxCount) { try { let authorization; if (cfgTokenEnableRequestOutbox && withAuthorization) { authorization = utils.fillJwtForRequest({url: uri}); } data = yield utils.downloadUrlPromise(uri, cfgDownloadTimeout, cfgDownloadMaxBytes, authorization); res = constants.NO\_ERROR; } catch (err) { res = constants.CONVERT\_DOWNLOAD; logger.error('error downloadFile:url=%s;attempt=%d;code:%s;connect:%s;(id=%s)\r\n%s', uri, downloadAttemptCount, err.code, err.connect, docId, err.stack); //not continue attempts if timeout if (err.code === 'ETIMEDOUT' || err.code === 'ESOCKETTIMEDOUT') { break; } else if (err.code === 'EMSGSIZE') { res = constants.CONVERT\_LIMITS; break; } else { yield utils.sleep(cfgDownloadAttemptDelay); } } } if (constants.NO\_ERROR === res) { logger.debug('downloadFile complete filesize=%d (id=%s)', data.length, docId); fs.writeFileSync(fileFrom, data); } } else { logger.error('checkIpFilter error:url=%s;code:%s;(id=%s)', uri, filterStatus, docId); res = constants.CONVERT\_DOWNLOAD; } return res;}function\* downloadFileFromStorage(id, strPath, dir) { var list = yield storage.listObjects(strPath); logger.debug('downloadFileFromStorage list %s (id=%s)', list.toString(), id); //create dirs var dirsToCreate = []; var dirStruct = {}; list.forEach(function(file) { var curDirPath = dir; var curDirStruct = dirStruct; var parts = storage.getRelativePath(strPath, file).split('/'); for (var i = 0; i < parts.length - 1; ++i) { var part = parts[i]; curDirPath = path.join(curDirPath, part); if (!curDirStruct[part]) { curDirStruct[part] = {}; dirsToCreate.push(curDirPath); } } }); //make dirs for (var i = 0; i < dirsToCreate.length; ++i) { fs.mkdirSync(dirsToCreate[i]); } //download //todo Promise.all for (var i = 0; i < list.length; ++i) { var file = list[i]; var fileRel = storage.getRelativePath(strPath, file); var data = yield storage.getObject(file); fs.writeFileSync(path.join(dir, fileRel), data); }}function\* processDownloadFromStorage(dataConvert, cmd, task, tempDirs, authorProps) { let res = constants.NO\_ERROR; let needConcatFiles = false; if (task.getFromOrigin() || task.getFromSettings()) { dataConvert.fileFrom = path.join(tempDirs.source, 'origin.' + cmd.getFormat()); } else { //перезаписываем некоторые файлы из m\_sKey(например Editor.bin или changes) yield\* downloadFileFromStorage(cmd.getSaveKey(), cmd.getSaveKey(), tempDirs.source); dataConvert.fileFrom = path.join(tempDirs.source, 'Editor.bin'); needConcatFiles = true; } //mail merge let mailMergeSend = cmd.getMailMergeSend(); if (mailMergeSend) { yield\* downloadFileFromStorage(mailMergeSend.getJsonKey(), mailMergeSend.getJsonKey(), tempDirs.source); needConcatFiles = true; } if (needConcatFiles) { yield\* concatFiles(tempDirs.source); } if (task.getFromChanges()) { res = yield\* processChanges(tempDirs, cmd, authorProps); } return res;}
function\* concatFiles(source) { //concatenate EditorN.ext parts in Editor.ext let list = yield utils.listObjects(source, true); list.sort(utils.compareStringByLength); let writeStreams = {}; for (let i = 0; i < list.length; ++i) { let file = list[i]; if (file.match(/Editor\d+\./)) { let target = file.replace(/(Editor)\d+(\..\*)/, '$1$2'); let writeStream = writeStreams[target]; if (!writeStream) { writeStream = yield utils.promiseCreateWriteStream(target); writeStreams[target] = writeStream; } let readStream = yield utils.promiseCreateReadStream(file); yield utils.pipeStreams(readStream, writeStream, false); } } for (let i in writeStreams) { if (writeStreams.hasOwnProperty(i)) { writeStreams[i].end(); } }}
function\* processChanges(tempDirs, cmd, authorProps) { let res = constants.NO\_ERROR; let changesDir = path.join(tempDirs.source, constants.CHANGES\_NAME); fs.mkdirSync(changesDir); let indexFile = 0; let changesAuthor = null; let changesIndex = null; let changesHistory = { serverVersion: commonDefines.buildVersion, changes: [] }; let forceSave = cmd.getForceSave(); let forceSaveTime; let forceSaveIndex = Number.MAX\_VALUE; if (forceSave) { forceSaveTime = forceSave.getTime(); forceSaveIndex = forceSave.getIndex(); } let streamObj = yield\* streamCreate(cmd.getDocId(), changesDir, indexFile++, {highWaterMark: cfgStreamWriterBufferSize}); let curIndexStart = 0; let curIndexEnd = Math.min(curIndexStart + cfgMaxRequestChanges, forceSaveIndex); while (curIndexStart < curIndexEnd) { let changes = yield baseConnector.getChangesPromise(cmd.getDocId(), curIndexStart, curIndexEnd, forceSaveTime); for (let i = 0; i < changes.length; ++i) { let change = changes[i]; if (change.change\_data.startsWith('ENCRYPTED;')) { logger.warn('processChanges encrypted changes (id=%s)', cmd.getDocId()); //todo sql request instead? res = constants.EDITOR\_CHANGES; break; } if (null === changesAuthor || changesAuthor !== change.user\_id\_original) { if (null !== changesAuthor) { yield\* streamEnd(streamObj, ']'); streamObj = yield\* streamCreate(cmd.getDocId(), changesDir, indexFile++); } changesAuthor = change.user\_id\_original; changesIndex = utils.getIndexFromUserId(change.user\_id, change.user\_id\_original); authorProps.lastModifiedBy = change.user\_name; authorProps.modified = change.change\_date.toISOString().slice(0, 19) + 'Z'; let strDate = baseConnector.getDateTime(change.change\_date); changesHistory.changes.push({'created': strDate, 'user': {'id': changesAuthor, 'name': change.user\_name}}); yield\* streamWrite(streamObj, '['); } else { yield\* streamWrite(streamObj, ','); } yield\* streamWrite(streamObj, change.change\_data); streamObj.isNoChangesInFile = false; } if (changes.length === curIndexEnd - curIndexStart) { curIndexStart += cfgMaxRequestChanges; curIndexEnd = Math.min(curIndexStart + cfgMaxRequestChanges, forceSaveIndex); } else { break; } } yield\* streamEnd(streamObj, ']'); if (streamObj.isNoChangesInFile) { fs.unlinkSync(streamObj.filePath); } cmd.setUserId(changesAuthor); cmd.setUserIndex(changesIndex); fs.writeFileSync(path.join(tempDirs.result, 'changesHistory.json'), JSON.stringify(changesHistory), 'utf8'); return res;}
function\* streamCreate(docId, changesDir, indexFile, opt\_options) { let fileName = constants.CHANGES\_NAME + indexFile + '.json'; let filePath = path.join(changesDir, fileName); let writeStream = yield utils.promiseCreateWriteStream(filePath, opt\_options); writeStream.on('error', function(err) { //todo integrate error handle in main thread (probable: set flag here and check it in main thread) logger.error('WriteStreamError (id=%s)\r\n%s', docId, err.stack); }); return {writeStream: writeStream, filePath: filePath, isNoChangesInFile: true};}
function\* streamWrite(streamObj, text) { if (!streamObj.writeStream.write(text, 'utf8')) { yield utils.promiseWaitDrain(streamObj.writeStream); }}
function\* streamEnd(streamObj, text) { streamObj.writeStream.end(text, 'utf8'); yield utils.promiseWaitClose(streamObj.writeStream);}function\* processUploadToStorage(dir, storagePath) { var list = yield utils.listObjects(dir); if (list.length < MAX\_OPEN\_FILES) { yield\* processUploadToStorageChunk(list, dir, storagePath); } else { for (var i = 0, j = list.length; i < j; i += MAX\_OPEN\_FILES) { yield\* processUploadToStorageChunk(list.slice(i, i + MAX\_OPEN\_FILES), dir, storagePath); } }}function\* processUploadToStorageChunk(list, dir, storagePath) { yield Promise.all(list.map(function (curValue) { let localValue = storagePath + '/' + curValue.substring(dir.length + 1); return storage.uploadObject(localValue, curValue); }));}function writeProcessOutputToLog(docId, childRes, isDebug) { if (childRes) { if (undefined !== childRes.stdout) { if (isDebug) { logger.debug('stdout (id=%s):%s', docId, childRes.stdout); } else { logger.error('stdout (id=%s):%s', docId, childRes.stdout); } } if (undefined !== childRes.stderr) { if (isDebug) { logger.debug('stderr (id=%s):%s', docId, childRes.stderr); } else { logger.error('stderr (id=%s):%s', docId, childRes.stderr); } } }}function\* postProcess(cmd, dataConvert, tempDirs, childRes, error, isTimeout) { var exitCode = 0; var exitSignal = null; if(childRes) { exitCode = childRes.status; exitSignal = childRes.signal; } if (0 !== exitCode || null !== exitSignal) { if (-1 !== exitCodesReturn.indexOf(-exitCode)) { error = -exitCode; } else if(isTimeout) { error = constants.CONVERT\_TIMEOUT; } else { error = constants.CONVERT; } if (-1 !== exitCodesMinorError.indexOf(error)) { writeProcessOutputToLog(dataConvert.key, childRes, true); logger.debug('ExitCode (code=%d;signal=%s;error:%d;id=%s)', exitCode, exitSignal, error, dataConvert.key); } else { writeProcessOutputToLog(dataConvert.key, childRes, false); logger.error('ExitCode (code=%d;signal=%s;error:%d;id=%s)', exitCode, exitSignal, error, dataConvert.key); if (cfgErrorFiles) { yield\* processUploadToStorage(tempDirs.temp, cfgErrorFiles + '/' + dataConvert.key); logger.debug('processUploadToStorage error complete(id=%s)', dataConvert.key); } } } else { writeProcessOutputToLog(dataConvert.key, childRes, true); logger.debug('ExitCode (code=%d;signal=%s;error:%d;id=%s)', exitCode, exitSignal, error, dataConvert.key); } if (-1 !== exitCodesUpload.indexOf(error)) { yield\* processUploadToStorage(tempDirs.result, dataConvert.key); logger.debug('processUploadToStorage complete(id=%s)', dataConvert.key); } cmd.setStatusInfo(error); var existFile = false; try { existFile = fs.lstatSync(dataConvert.fileTo).isFile(); } catch (err) { existFile = false; } if (!existFile) { //todo пересмотреть. загрулка в случае AVS\_OFFICESTUDIO\_FILE\_OTHER\_TEAMLAB\_INNER x2t меняет расширение у файла. var fileToBasename = path.basename(dataConvert.fileTo); var fileToDir = path.dirname(dataConvert.fileTo); var files = fs.readdirSync(fileToDir); for (var i = 0; i < files.length; ++i) { var fileCur = files[i]; if (0 == fileCur.indexOf(fileToBasename)) { dataConvert.fileTo = path.join(fileToDir, fileCur); break; } } } cmd.setOutputPath(path.basename(dataConvert.fileTo)); if(!cmd.getTitle()){ cmd.setTitle(cmd.getOutputPath()); }
 var res = new commonDefines.TaskQueueData(); res.setCmd(cmd); logger.debug('output (data=%s;id=%s)', JSON.stringify(res), dataConvert.key); return res;}function deleteFolderRecursive(strPath) { if (fs.existsSync(strPath)) { var files = fs.readdirSync(strPath); files.forEach(function(file) { var curPath = path.join(strPath, file); if (fs.lstatSync(curPath).isDirectory()) { // recurse deleteFolderRecursive(curPath); } else { // delete file fs.unlinkSync(curPath); } }); fs.rmdirSync(strPath); }}
function\* ExecuteTask(task) { var startDate = null; var curDate = null; if(clientStatsD) { startDate = curDate = new Date(); } var resData; var tempDirs; var getTaskTime = new Date(); var cmd = task.getCmd(); var dataConvert = new TaskQueueDataConvert(task); logger.debug('Start Task(id=%s)', dataConvert.key); var error = constants.NO\_ERROR; tempDirs = getTempDir(); let fileTo = task.getToFile(); dataConvert.fileTo = fileTo ? path.join(tempDirs.result, fileTo) : ''; let isBuilder = cmd.getIsBuilder(); let authorProps = {lastModifiedBy: null, modified: null}; if (cmd.getUrl()) { dataConvert.fileFrom = path.join(tempDirs.source, dataConvert.key + '.' + cmd.getFormat()); error = yield\* downloadFile(dataConvert.key, cmd.getUrl(), dataConvert.fileFrom, cmd.getWithAuthorization()); if(clientStatsD) { clientStatsD.timing('conv.downloadFile', new Date() - curDate); curDate = new Date(); } } else if (cmd.getSaveKey()) { yield\* downloadFileFromStorage(cmd.getDocId(), cmd.getDocId(), tempDirs.source); logger.debug('downloadFileFromStorage complete(id=%s)', dataConvert.key); if(clientStatsD) { clientStatsD.timing('conv.downloadFileFromStorage', new Date() - curDate); curDate = new Date(); } error = yield\* processDownloadFromStorage(dataConvert, cmd, task, tempDirs, authorProps); } else if (cmd.getForgotten()) { yield\* downloadFileFromStorage(cmd.getDocId(), cmd.getForgotten(), tempDirs.source); logger.debug('downloadFileFromStorage complete(id=%s)', dataConvert.key); let list = yield utils.listObjects(tempDirs.source, false); if (list.length > 0) { dataConvert.fileFrom = list[0]; //store indicator file to determine if opening was from the forgotten file var forgottenMarkPath = tempDirs.result + '/' + cfgForgottenFilesName + '.txt'; fs.writeFileSync(forgottenMarkPath, cfgForgottenFilesName, {encoding: 'utf8'}); } else { error = constants.UNKNOWN; } } else if (isBuilder) { //in cause script in POST body yield\* downloadFileFromStorage(cmd.getDocId(), cmd.getDocId(), tempDirs.source); logger.debug('downloadFileFromStorage complete(id=%s)', dataConvert.key); let list = yield utils.listObjects(tempDirs.source, false); if (list.length > 0) { dataConvert.fileFrom = list[0]; } } else { error = constants.UNKNOWN; } var childRes = null; let isTimeout = false; if (constants.NO\_ERROR === error) { if(constants.AVS\_OFFICESTUDIO\_FILE\_OTHER\_HTMLZIP === dataConvert.formatTo && cmd.getSaveKey() && !dataConvert.mailMergeSend) { //todo заглушка.вся конвертация на клиенте, но нет простого механизма сохранения на клиенте yield utils.pipeFiles(dataConvert.fileFrom, dataConvert.fileTo); } else { var childArgs; if (cfgArgs.length > 0) { childArgs = cfgArgs.trim().replace(/ +/g, ' ').split(' '); } else { childArgs = []; } let processPath; if (!isBuilder) { processPath = cfgX2tPath; let paramsFile = path.join(tempDirs.temp, 'params.xml'); let hiddenXml = dataConvert.serialize(paramsFile); childArgs.push(paramsFile); if (hiddenXml) { childArgs.push(hiddenXml); } } else { fs.mkdirSync(path.join(tempDirs.result, 'output')); processPath = cfgDocbuilderPath; childArgs.push('--all-fonts-path=' + cfgDocbuilderAllFontsPath); childArgs.push('--save-use-only-names=' + tempDirs.result + '/output'); childArgs.push(dataConvert.fileFrom); } let timeoutId; try { let spawnOptions = cfgSpawnOptions; if (authorProps.lastModifiedBy && authorProps.modified) { //copy to avoid modification of global cfgSpawnOptions spawnOptions = Object.assign({}, cfgSpawnOptions); spawnOptions.env = Object.assign({}, spawnOptions.env || process.env);
 spawnOptions.env['LAST\_MODIFIED\_BY'] = authorProps.lastModifiedBy; spawnOptions.env['MODIFIED'] = authorProps.modified; } let spawnAsyncPromise = spawnAsync(processPath, childArgs, spawnOptions); childRes = spawnAsyncPromise.child; let waitMS = task.getVisibilityTimeout() \* 1000 - (new Date().getTime() - getTaskTime.getTime()); timeoutId = setTimeout(function() { isTimeout = true; timeoutId = undefined; //close stdio streams to enable emit 'close' event even if HtmlFileInternal is hung-up childRes.stdin.end(); childRes.stdout.destroy(); childRes.stderr.destroy(); childRes.kill(); }, waitMS); childRes = yield spawnAsyncPromise; } catch (err) { let fLog = null === err.status ? logger.error : logger.debug; fLog.call(logger, 'error spawnAsync(id=%s)\r\n%s', cmd.getDocId(), err.stack); childRes = err; } if (undefined !== timeoutId) { clearTimeout(timeoutId); } } if(clientStatsD) { clientStatsD.timing('conv.spawnSync', new Date() - curDate); curDate = new Date(); } } resData = yield\* postProcess(cmd, dataConvert, tempDirs, childRes, error, isTimeout); logger.debug('postProcess (id=%s)', dataConvert.key); if(clientStatsD) { clientStatsD.timing('conv.postProcess', new Date() - curDate); curDate = new Date(); } if (tempDirs) { deleteFolderRecursive(tempDirs.temp); logger.debug('deleteFolderRecursive (id=%s)', dataConvert.key); if(clientStatsD) { clientStatsD.timing('conv.deleteFolderRecursive', new Date() - curDate); curDate = new Date(); } } if(clientStatsD) { clientStatsD.timing('conv.allconvert', new Date() - startDate); } return resData;}
function receiveTask(data, ack) { return co(function\* () { var res = null; var task = null; try { task = new commonDefines.TaskQueueData(JSON.parse(data)); if (task) { res = yield\* ExecuteTask(task); } } catch (err) { logger.error(err); } finally { try { if (!res && task) { //если все упало так что даже нет res, все равно пытаемся отдать ошибку. var cmd = task.getCmd(); cmd.setStatusInfo(constants.CONVERT); res = new commonDefines.TaskQueueData(); res.setCmd(cmd); } if (res) { yield queue.addResponse(res); } } catch (err) { logger.error(err); } finally { ack(); } } });}function simulateErrorResponse(data){ let task = new commonDefines.TaskQueueData(JSON.parse(data)); //simulate error response let cmd = task.getCmd(); cmd.setStatusInfo(constants.CONVERT); let res = new commonDefines.TaskQueueData(); res.setCmd(cmd); return res;}function run() { queue = new queueService(simulateErrorResponse); queue.on('task', receiveTask); queue.init(true, true, true, false, false, false, function(err) { if (null != err) { logger.error('createTaskQueue error :\r\n%s', err.stack); } });}exports.run = run;

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_01e38bb7_20250114_225917.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=ONLYOFFICE%2Fserver)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[server](/ONLYOFFICE/server)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fserver) You must be signed in to change notification settings
* [Fork
  242](/login?return_to=%2FONLYOFFICE%2Fserver)
* [Star
   197](/login?return_to=%2FONLYOFFICE%2Fserver)

The backend server software layer which is the part of ONLYOFFICE Document Server and is the base for all other components

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### License

[AGPL-3.0 license](/ONLYOFFICE/server/blob/master/LICENSE.txt)

[197
stars](/ONLYOFFICE/server/stargazers) [242
forks](/ONLYOFFICE/server/forks) [Branches](/ONLYOFFICE/server/branches) [Tags](/ONLYOFFICE/server/tags) [Activity](/ONLYOFFICE/server/activity)
 [Star](/login?return_to=%2FONLYOFFICE%2Fserver)

 [Notifications](/login?return_to=%2FONLYOFFICE%2Fserver) You must be signed in to change notification settings

* [Code](/ONLYOFFICE/server)
* [Pull requests
  1](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/server)
* [Pull requests](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

# ONLYOFFICE/server

    master[Branches](/ONLYOFFICE/server/branches)[Tags](/ONLYOFFICE/server/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[2,475 Commits](/ONLYOFFICE/server/commits/master/) | | |
| [.github/workflows](/ONLYOFFICE/server/tree/master/.github/workflows "This path skips through empty directories") | | [.github/workflows](/ONLYOFFICE/server/tree/master/.github/workflows "This path skips through empty directories") |  |  |
| [3d-party-lic-report](/ONLYOFFICE/server/tree/master/3d-party-lic-report "3d-party-lic-report") | | [3d-party-lic-report](/ONLYOFFICE/server/tree/master/3d-party-lic-report "3d-party-lic-report") |  |  |
| [Common](/ONLYOFFICE/server/tree/master/Common "Common") | | [Common](/ONLYOFFICE/server/tree/master/Common "Common") |  |  |
| [DocService](/ONLYOFFICE/server/tree/master/DocService "DocService") | | [DocService](/ONLYOFFICE/server/tree/master/DocService "DocService") |  |  |
| [FileConverter](/ONLYOFFICE/server/tree/master/FileConverter "FileConverter") | | [FileConverter](/ONLYOFFICE/server/tree/master/FileConverter "FileConverter") |  |  |
| [Metrics](/ONLYOFFICE/server/tree/master/Metrics "Metrics") | | [Metrics](/ONLYOFFICE/server/tree/master/Metrics "Metrics") |  |  |
| [SpellChecker](/ONLYOFFICE/server/tree/master/SpellChecker "SpellChecker") | | [SpellChecker](/ONLYOFFICE/server/tree/master/SpellChecker "SpellChecker") |  |  |
| [branding](/ONLYOFFICE/server/tree/master/branding "branding") | | [branding](/ONLYOFFICE/server/tree/master/branding "branding") |  |  |
| [license](/ONLYOFFICE/server/tree/master/license "license") | | [license](/ONLYOFFICE/server/tree/master/license "license") |  |  |
| [schema](/ONLYOFFICE/server/tree/master/schema "schema") | | [schema](/ONLYOFFICE/server/tree/master/schema "schema") |  |  |
| [tests](/ONLYOFFICE/server/tree/master/tests "tests") | | [tests](/ONLYOFFICE/server/tree/master/tests "tests") |  |  |
| [.gitignore](/ONLYOFFICE/server/blob/master/.gitignore ".gitignore") | | [.gitignore](/ONLYOFFICE/server/blob/master/.gitignore ".gitignore") |  |  |
| [.travis.yml](/ONLYOFFICE/server/blob/master/.travis.yml ".travis.yml") | | [.travis.yml](/ONLYOFFICE/server/blob/master/.travis.yml ".travis.yml") |  |  |
| [3DPARTY.md](/ONLYOFFICE/server/blob/master/3DPARTY.md "3DPARTY.md") | | [3DPARTY.md](/ONLYOFFICE/server/blob/master/3DPARTY.md "3DPARTY.md") |  |  |
| [3rd-Party.txt](/ONLYOFFICE/server/blob/master/3rd-Party.txt "3rd-Party.txt") | | [3rd-Party.txt](/ONLYOFFICE/server/blob/master/3rd-Party.txt "3rd-Party.txt") |  |  |
| [CHANGELOG.md](/ONLYOFFICE/server/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/ONLYOFFICE/server/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [Gruntfile.js](/ONLYOFFICE/server/blob/master/Gruntfile.js "Gruntfile.js") | | [Gruntfile.js](/ONLYOFFICE/server/blob/master/Gruntfile.js "Gruntfile.js") |  |  |
| [LICENSE.txt](/ONLYOFFICE/server/blob/master/LICENSE.txt "LICENSE.txt") | | [LICENSE.txt](/ONLYOFFICE/server/blob/master/LICENSE.txt "LICENSE.txt") |  |  |
| [Makefile](/ONLYOFFICE/server/blob/master/Makefile "Makefile") | | [Makefile](/ONLYOFFICE/server/blob/master/Makefile "Makefile") |  |  |
| [Readme.md](/ONLYOFFICE/server/blob/master/Readme.md "Readme.md") | | [Readme.md](/ONLYOFFICE/server/blob/master/Readme.md "Readme.md") |  |  |
| [npm-shrinkwrap.json](/ONLYOFFICE/server/blob/master/npm-shrinkwrap.json "npm-shrinkwrap.json") | | [npm-shrinkwrap.json](/ONLYOFFICE/server/blob/master/npm-shrinkwrap.json "npm-shrinkwrap.json") |  |  |
| [package.json](/ONLYOFFICE/server/blob/master/package.json "package.json") | | [package.json](/ONLYOFFICE/server/blob/master/package.json "package.json") |  |  |
| View all files | | |

## Repository files navigation

* README
* AGPL-3.0 license
# Server

[![License](https://camo.githubusercontent.com/1720e1c42dd5a9a5cfaed3a4abec210e929921fa9271e404263661daf3c7905b/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f4c6963656e73652d474e552532304147504c25323056332d677265656e2e7376673f7374796c653d666c6174)](https://www.gnu.org/licenses/agpl-3.0.en.html)

The backend server software layer which is the part of [ONLYOFFICE Document Server](https://github.com/ONLYOFFICE/DocumentServer) and [ONLYOFFICE Desktop Editors](https://github.com/ONLYOFFICE/DesktopEditors) and is the base for all other components.

## Document service set up

This instruction describes document service deployment for Windows based platform.

### Installing necessary components

For the document service to work correctly it is necessary to install the following components for your Windows system (if not specified additionally, the latest version for 32 or 64 bit Windows can be installed with default settings):

1. [Node.js](https://nodejs.org/en/download/) version 8.0.0 or later
2. [Java](https://java.com/en/download/). Necessary for the sdk build.
3. Database (MySQL or PostgreSQL). When installing use the `onlyoffice` password for the `root` user.

   * [MySQL Server](http://dev.mysql.com/downloads/windows/installer/) version 5.5 or later
   * [PostgreSQL Server](https://www.postgresql.org/download/) version 9.1 or later
4. [Erlang](https://www.erlang.org/download.html)
5. [RabbitMQ](https://www.rabbitmq.com/releases/rabbitmq-server/v3.5.4/rabbitmq-server-3.5.4.exe)
6. [Redis](https://github.com/microsoftarchive/redis/releases/latest)
7. [Python 2.7](https://www.python.org/downloads/release/python-2716/)
8. Microsoft Visual C++ Express 2010 (necessary for the spellchecker modules build)

### Setting up the system

1. Database setup:

   * Database setup for MySQL

     Run the `schema/mysql/createdb.sql` script for MySQL
   * Database setup for PostgreSQL

     1. Enter in `psql` (PostgreSQL interactive terminal) with
        login and password introduced during installation, then enter commands:

        ```
        CREATE USER onlyoffice WITH PASSWORD 'onlyoffice';
        CREATE DATABASE onlyoffice OWNER onlyoffice;
        \c onlyoffice
        \i 'schema/postgresql/createdb.sql';
        ```
     2. Delete from `server\Common\config\development-windows.json` option `sql`.
2. Install the Web Monitor for RabbitMQ (see the details for the installation [here](https://www.rabbitmq.com/management.html))
3. Open the command line `cmd` executable.
4. Switch to the installation directory using the `cd /d Installation-directory/sbin` command.
5. Run the following command:

   ```
   rabbitmq-plugins.bat enable rabbitmq_management
   ```
6. The Web Monitor is located at the <http://localhost:15672/> address.
   Use the `guest:guest` for the login:password combination.
7. If Redis does not start or crashes after the start for some reason,
   try to change the `maxheap` parameter in the config settings.
   For 64 bit version of Windows 7 the config file can be found here:
   `C:\Program Files\Redis\redis.windows-service.conf`.
   Find the `# maxheap <bytes>` line and change it to, e.g.

   ```
   maxheap 128MB

   ```

   and restart the service

### Running the service

Run the `run.bat` script to start the service.

Notes

All config files for the server part can be found in the `Common\config` folder

* `default.json` - common config files similar for all production versions.
* `production-windows.json` - config files for the production version running on a Windows based platform.
* `production-linux.json` - config files for the production version running on a Linux based platform.
* `development-windows.json` - config files for the development version running on a Windows based platform (this configuration is used when running the 'run.bat' script).

In case it is necessary to temporarily edit the config files, create the local.json file and reassign the values there. It will allow to prevent from uploading local changes and losing config files when updating the repository. See [Configuration Files](https://github.com/lorenwest/node-config/wiki/Configuration-Files) for more information about the configuration files.

## User Feedback and Support

If you have any problems with or questions about [ONLYOFFICE Document Server](https://github.com/ONLYOFFICE/DocumentServer), please visit our official forum to find answers to your questions: [forum.onlyoffice.com](https://forum.onlyoffice.com) or you can ask and answer ONLYOFFICE development questions on [Stack Overflow](https://stackoverflow.com/questions/tagged/onlyoffice).

## License

Server is released under an GNU AGPL v3.0 license. See the LICENSE file for more information.

## About

The backend server software layer which is the part of ONLYOFFICE Document Server and is the base for all other components

[www.onlyoffice.com](https://www.onlyoffice.com "https://www.onlyoffice.com")

### Topics

[nodejs](/topics/nodejs "Topic: nodejs")
[redis](/topics/redis "Topic: redis")
[node](/topics/node "Topic: node")
[rabbitmq](/topics/rabbitmq "Topic: rabbitmq")
[backend-server](/topics/backend-server "Topic: backend-server")

### Resources

[Readme](#readme-ov-file)
### License

[AGPL-3.0 license](#AGPL-3.0-1-ov-file)

[Activity](/ONLYOFFICE/server/activity)
[Custom properties](/ONLYOFFICE/server/custom-properties)
### Stars

[**197**
stars](/ONLYOFFICE/server/stargazers)
### Watchers

[**33**
watching](/ONLYOFFICE/server/watchers)
### Forks

[**242**
forks](/ONLYOFFICE/server/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver&report=ONLYOFFICE+%28user%29)

## [Releases](/ONLYOFFICE/server/releases)

[7,743
tags](/ONLYOFFICE/server/tags)

## [Packages 0](/orgs/ONLYOFFICE/packages?repo_name=server)

No packages published

## [Contributors 26](/ONLYOFFICE/server/graphs/contributors)

* [![@konovalovsergey](https://avatars.githubusercontent.com/u/17902399?s=64&v=4)](https://github.com/konovalovsergey)
* [![@trofim24](https://avatars.githubusercontent.com/u/1764789?s=64&v=4)](https://github.com/trofim24)
* [![@agolybev](https://avatars.githubusercontent.com/u/8861642?s=64&v=4)](https://github.com/agolybev)
* [![@papacarlo](https://avatars.githubusercontent.com/u/22055467?s=64&v=4)](https://github.com/papacarlo)
* [![@KhromovNikita](https://avatars.githubusercontent.com/u/52740597?s=64&v=4)](https://github.com/KhromovNikita)
* [![@JuliaRadzhabova](https://avatars.githubusercontent.com/u/17922480?s=64&v=4)](https://github.com/JuliaRadzhabova)
* [![@K0R0L](https://avatars.githubusercontent.com/u/16754960?s=64&v=4)](https://github.com/K0R0L)
* [![@DrToldme](https://avatars.githubusercontent.com/u/16436298?s=64&v=4)](https://github.com/DrToldme)
* [![@ayuzhin](https://avatars.githubusercontent.com/u/17567024?s=64&v=4)](https://github.com/ayuzhin)
* [![@ShockwaveNN](https://avatars.githubusercontent.com/u/668524?s=64&v=4)](https://github.com/ShockwaveNN)
* [![@dependabot[bot]](https://avatars.githubusercontent.com/in/29110?s=64&v=4)](https://github.com/apps/dependabot)
* [![@L3o-pold](https://avatars.githubusercontent.com/u/4710495?s=64&v=4)](https://github.com/L3o-pold)
* [![@romandemidov](https://avatars.githubusercontent.com/u/58073444?s=64&v=4)](https://github.com/romandemidov)
* [![@danilapog](https://avatars.githubusercontent.com/u/77471369?s=64&v=4)](https://github.com/danilapog)

[+ 12 contributors](/ONLYOFFICE/server/graphs/contributors)

## Languages

* [JavaScript
  96.2%](/ONLYOFFICE/server/search?l=javascript)
* [HTML
  2.8%](/ONLYOFFICE/server/search?l=html)
* Other
  1.0%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0a1f4fb1_20250114_225924.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver%2Fblob%2Fv5.6.0.21%2FFileConverter%2Fsources%2Fconverter.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FONLYOFFICE%2Fserver%2Fblob%2Fv5.6.0.21%2FFileConverter%2Fsources%2Fconverter.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=ONLYOFFICE%2Fserver)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ONLYOFFICE](/ONLYOFFICE)
/
**[server](/ONLYOFFICE/server)**
Public

* [Notifications](/login?return_to=%2FONLYOFFICE%2Fserver) You must be signed in to change notification settings
* [Fork
  242](/login?return_to=%2FONLYOFFICE%2Fserver)
* [Star
   197](/login?return_to=%2FONLYOFFICE%2Fserver)

* [Code](/ONLYOFFICE/server/tree/v5.6.0.21)
* [Pull requests
  1](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

Additional navigation options

* [Code](/ONLYOFFICE/server/tree/v5.6.0.21)
* [Pull requests](/ONLYOFFICE/server/pulls)
* [Actions](/ONLYOFFICE/server/actions)
* [Security](/ONLYOFFICE/server/security)
* [Insights](/ONLYOFFICE/server/pulse)

## Files

 v5.6.0.21
## Breadcrumbs

1. [server](/ONLYOFFICE/server/tree/v5.6.0.21)
2. /[FileConverter](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter)
3. /[sources](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter/sources)
/
# converter.js

Copy path Blame  Blame
## Latest commit

## History

[History](/ONLYOFFICE/server/commits/v5.6.0.21/FileConverter/sources/converter.js)766 lines (751 loc) · 30.6 KB v5.6.0.21
## Breadcrumbs

1. [server](/ONLYOFFICE/server/tree/v5.6.0.21)
2. /[FileConverter](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter)
3. /[sources](/ONLYOFFICE/server/tree/v5.6.0.21/FileConverter/sources)
/
# converter.js

Top
## File metadata and controls

* Code
* Blame

766 lines (751 loc) · 30.6 KB[Raw](https://github.com/ONLYOFFICE/server/raw/refs/tags/v5.6.0.21/FileConverter/sources/converter.js)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766/\* \* (c) Copyright Ascensio System SIA 2010-2019 \* \* This program is a free software product. You can redistribute it and/or \* modify it under the terms of the GNU Affero General Public License (AGPL) \* version 3 as published by the Free Software Foundation. In accordance with \* Section 7(a) of the GNU AGPL its Section 15 shall be amended to the effect \* that Ascensio System SIA expressly excludes the warranty of non-infringement \* of any third-party rights. \* \* This program is distributed WITHOUT ANY WARRANTY; without even the implied \* warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. For \* details, see the GNU AGPL at: http://www.gnu.org/licenses/agpl-3.0.html \* \* You can contact Ascensio System SIA at 20A-12 Ernesta Birznieka-Upisha \* street, Riga, Latvia, EU, LV-1050. \* \* The interactive user interfaces in modified source and object code versions \* of the Program must display Appropriate Legal Notices, as required under \* Section 5 of the GNU AGPL version 3. \* \* Pursuant to Section 7(b) of the License you must retain the original Product \* logo when distributing the program. Pursuant to Section 7(e) we decline to \* grant you any rights under trademark law for use of our trademarks. \* \* All the Product's GUI elements, including illustrations and icon sets, as \* well as technical writing content are licensed under the terms of the \* Creative Commons Attribution-ShareAlike 4.0 International. See the License \* terms at http://creativecommons.org/licenses/by-sa/4.0/legalcode \* \*/
'use strict';var os = require('os');var path = require('path');var fs = require('fs');var url = require('url');var childProcess = require('child\_process');var co = require('co');var config = require('config');var spawnAsync = require('@expo/spawn-async');const bytes = require('bytes');var configConverter = config.get('FileConverter.converter');
var commonDefines = require('./../../Common/sources/commondefines');var storage = require('./../../Common/sources/storage-base');var utils = require('./../../Common/sources/utils');var logger = require('./../../Common/sources/logger');var constants = require('./../../Common/sources/constants');var baseConnector = require('./../../DocService/sources/baseConnector');var statsDClient = require('./../../Common/sources/statsdclient');var queueService = require('./../../Common/sources/taskqueueRabbitMQ');
var cfgDownloadMaxBytes = configConverter.has('maxDownloadBytes') ? configConverter.get('maxDownloadBytes') : 100000000;var cfgDownloadTimeout = configConverter.has('downloadTimeout') ? configConverter.get('downloadTimeout') : 60;var cfgDownloadAttemptMaxCount = configConverter.has('downloadAttemptMaxCount') ? configConverter.get('downloadAttemptMaxCount') : 3;var cfgDownloadAttemptDelay = configConverter.has('downloadAttemptDelay') ? configConverter.get('downloadAttemptDelay') : 1000;var cfgFontDir = configConverter.get('fontDir');var cfgPresentationThemesDir = configConverter.get('presentationThemesDir');var cfgX2tPath = configConverter.get('x2tPath');var cfgDocbuilderPath = configConverter.get('docbuilderPath');var cfgDocbuilderAllFontsPath = configConverter.get('docbuilderAllFontsPath');var cfgArgs = configConverter.get('args');var cfgSpawnOptions = configConverter.get('spawnOptions');if (cfgSpawnOptions.env) { Object.assign(cfgSpawnOptions.env, process.env);}var cfgErrorFiles = configConverter.get('errorfiles');var cfgInputLimits = configConverter.get('inputLimits');const cfgStreamWriterBufferSize = configConverter.get('streamWriterBufferSize');//cfgMaxRequestChanges was obtained as a result of the test: 84408 changes - 5,16 MBconst cfgMaxRequestChanges = config.get('services.CoAuthoring.server.maxRequestChanges');var cfgTokenEnableRequestOutbox = config.get('services.CoAuthoring.token.enable.request.outbox');const cfgForgottenFilesName = config.get('services.CoAuthoring.server.forgottenfilesname');
//windows limit 512(2048) https://msdn.microsoft.com/en-us/library/6e3b887c.aspx//Ubuntu 14.04 limit 4096 http://underyx.me/2015/05/18/raising-the-maximum-number-of-file-descriptors.html//MacOs limit 2048 http://apple.stackexchange.com/questions/33715/too-many-open-filesvar MAX\_OPEN\_FILES = 200;var TEMP\_PREFIX = 'ASC\_CONVERT';var queue = null;var clientStatsD = statsDClient.getClient();var exitCodesReturn = [constants.CONVERT\_PARAMS, constants.CONVERT\_NEED\_PARAMS, constants.CONVERT\_CORRUPTED, constants.CONVERT\_DRM, constants.CONVERT\_PASSWORD, constants.CONVERT\_LIMITS];var exitCodesMinorError = [constants.CONVERT\_NEED\_PARAMS, constants.CONVERT\_DRM, constants.CONVERT\_PASSWORD];var exitCodesUpload = [constants.NO\_ERROR, constants.CONVERT\_CORRUPTED, constants.CONVERT\_NEED\_PARAMS, constants.CONVERT\_DRM];let inputLimitsXmlCache;
function TaskQueueDataConvert(task) { var cmd = task.getCmd(); this.key = cmd.savekey ? cmd.savekey : cmd.id; this.fileFrom = null; this.fileTo = null; if(constants.AVS\_OFFICESTUDIO\_FILE\_OTHER\_PDFA !== cmd.outputformat){ this.formatTo = cmd.outputformat; } else { this.formatTo = constants.AVS\_OFFICESTUDIO\_FILE\_CROSSPLATFORM\_PDF; this.isPDFA = true; } this.csvTxtEncoding = cmd.getCodepage(); this.csvDelimiter = cmd.getDelimiter(); this.csvDelimiterChar = cmd.getDelimiterChar(); this.paid = task.getPaid(); this.embeddedFonts = cmd.embeddedfonts; this.fromChanges = task.getFromChanges(); //todo if (cfgFontDir) { this.fontDir = path.resolve(cfgFontDir); } else { this.fontDir = cfgFontDir; } this.themeDir = path.resolve(cfgPresentationThemesDir); this.mailMergeSend = cmd.mailmergesend; this.thumbnail = cmd.thumbnail; this.jsonParams = cmd.getJsonParams(); this.lcid = cmd.getLCID(); this.password = cmd.getPassword(); this.noBase64 = cmd.getNoBase64(); this.timestamp = new Date();}TaskQueueDataConvert.prototype = { serialize: function(fsPath) { let xml = '\ufeff<?xml version="1.0" encoding="utf-8"?>'; xml += '<TaskQueueDataConvert xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'; xml += ' xmlns:xsd="http://www.w3.org/2001/XMLSchema">'; xml += this.serializeXmlProp('m\_sKey', this.key); xml += this.serializeXmlProp('m\_sFileFrom', this.fileFrom); xml += this.serializeXmlProp('m\_sFileTo', this.fileTo); xml += this.serializeXmlProp('m\_nFormatTo', this.formatTo); xml += this.serializeXmlProp('m\_bIsPDFA', this.isPDFA); xml += this.serializeXmlProp('m\_nCsvTxtEncoding', this.csvTxtEncoding); xml += this.serializeXmlProp('m\_nCsvDelimiter', this.csvDelimiter); xml += this.serializeXmlProp('m\_nCsvDelimiterChar', this.csvDelimiterChar); xml += this.serializeXmlProp('m\_bPaid', this.paid); xml += this.serializeXmlProp('m\_bEmbeddedFonts', this.embeddedFonts); xml += this.serializeXmlProp('m\_bFromChanges', this.fromChanges); xml += this.serializeXmlProp('m\_sFontDir', this.fontDir); xml += this.serializeXmlProp('m\_sThemeDir', this.themeDir); if (this.mailMergeSend) { xml += this.serializeMailMerge(this.mailMergeSend); } if (this.thumbnail) { xml += this.serializeThumbnail(this.thumbnail); } xml += this.serializeXmlProp('m\_sJsonParams', this.jsonParams); xml += this.serializeXmlProp('m\_nLcid', this.lcid); xml += this.serializeXmlProp('m\_oTimestamp', this.timestamp.toISOString()); xml += this.serializeXmlProp('m\_bIsNoBase64', this.noBase64); xml += this.serializeLimit(); xml += '</TaskQueueDataConvert>'; fs.writeFileSync(fsPath, xml, {encoding: 'utf8'}); let hiddenXml; if (undefined !== this.password) { hiddenXml = '<TaskQueueDataConvert>'; hiddenXml += this.serializeXmlProp('m\_sPassword', this.password); hiddenXml += '</TaskQueueDataConvert>'; } return hiddenXml; }, serializeMailMerge: function(data) { var xml = '<m\_oMailMergeSend>'; xml += this.serializeXmlProp('from', data.getFrom()); xml += this.serializeXmlProp('to', data.getTo()); xml += this.serializeXmlProp('subject', data.getSubject()); xml += this.serializeXmlProp('mailFormat', data.getMailFormat()); xml += this.serializeXmlProp('fileName', data.getFileName()); xml += this.serializeXmlProp('message', data.getMessage()); xml += this.serializeXmlProp('recordFrom', data.getRecordFrom()); xml += this.serializeXmlProp('recordTo', data.getRecordTo()); xml += this.serializeXmlProp('recordCount', data.getRecordCount()); xml += this.serializeXmlProp('userid', data.getUserId()); xml += this.serializeXmlProp('url', data.getUrl()); xml += '</m\_oMailMergeSend>'; return xml; }, serializeThumbnail: function(data) { var xml = '<m\_oThumbnail>'; xml += this.serializeXmlProp('format', data.getFormat()); xml += this.serializeXmlProp('aspect', data.getAspect()); xml += this.serializeXmlProp('first', data.getFirst()); xml += this.serializeXmlProp('width', data.getWidth()); xml += this.serializeXmlProp('height', data.getHeight()); xml += '</m\_oThumbnail>'; return xml; }, serializeLimit: function() { if (!inputLimitsXmlCache) { var xml = '<m\_oInputLimits>'; for (let i = 0; i < cfgInputLimits.length; ++i) { let limit = cfgInputLimits[i]; if (limit.type && limit.zip) { xml += '<m\_oInputLimit'; xml += this.serializeXmlAttr('type', limit.type); xml += '>'; xml += '<m\_oZip'; if (limit.zip.compressed) { xml += this.serializeXmlAttr('compressed', bytes.parse(limit.zip.compressed)); } if (limit.zip.uncompressed) { xml += this.serializeXmlAttr('uncompressed', bytes.parse(limit.zip.uncompressed)); } xml += this.serializeXmlAttr('template', limit.zip.template); xml += '/>'; xml += '</m\_oInputLimit>'; } } xml += '</m\_oInputLimits>'; inputLimitsXmlCache = xml; } return inputLimitsXmlCache; }, serializeXmlProp: function(name, value) { var xml = ''; if (null != value) { xml += '<' + name + '>'; xml += utils.encodeXml(value.toString()); xml += '</' + name + '>'; } else { xml += '<' + name + ' xsi:nil="true" />'; } return xml; }, serializeXmlAttr: function(name, value) { var xml = ''; if (null != value) { xml += ' ' + name + '=\"'; xml += utils.encodeXml(value.toString()); xml += '\"'; } return xml; }};
function getTempDir() { var tempDir = os.tmpdir(); var now = new Date(); var newTemp; while (!newTemp || fs.existsSync(newTemp)) { var newName = [TEMP\_PREFIX, now.getYear(), now.getMonth(), now.getDate(), '-', (Math.random() \* 0x100000000 + 1).toString(36) ].join(''); newTemp = path.join(tempDir, newName); } fs.mkdirSync(newTemp); var sourceDir = path.join(newTemp, 'source'); fs.mkdirSync(sourceDir); var resultDir = path.join(newTemp, 'result'); fs.mkdirSync(resultDir); return {temp: newTemp, source: sourceDir, result: resultDir};}function\* downloadFile(docId, uri, fileFrom, withAuthorization) { var res = constants.CONVERT\_DOWNLOAD; var data = null; var downloadAttemptCount = 0; var urlParsed = url.parse(uri); var filterStatus = yield\* utils.checkHostFilter(urlParsed.hostname); if (0 == filterStatus) { while (constants.NO\_ERROR !== res && downloadAttemptCount++ < cfgDownloadAttemptMaxCount) { try { let authorization; if (cfgTokenEnableRequestOutbox && withAuthorization) { authorization = utils.fillJwtForRequest({url: uri}); } data = yield utils.downloadUrlPromise(uri, cfgDownloadTimeout, cfgDownloadMaxBytes, authorization); res = constants.NO\_ERROR; } catch (err) { res = constants.CONVERT\_DOWNLOAD; logger.error('error downloadFile:url=%s;attempt=%d;code:%s;connect:%s;(id=%s)\r\n%s', uri, downloadAttemptCount, err.code, err.connect, docId, err.stack); //not continue attempts if timeout if (err.code === 'ETIMEDOUT' || err.code === 'ESOCKETTIMEDOUT') { break; } else if (err.code === 'EMSGSIZE') { res = constants.CONVERT\_LIMITS; break; } else { yield utils.sleep(cfgDownloadAttemptDelay); } } } if (constants.NO\_ERROR === res) { logger.debug('downloadFile complete filesize=%d (id=%s)', data.length, docId); fs.writeFileSync(fileFrom, data); } } else { logger.error('checkIpFilter error:url=%s;code:%s;(id=%s)', uri, filterStatus, docId); res = constants.CONVERT\_DOWNLOAD; } return res;}function\* downloadFileFromStorage(id, strPath, dir) { var list = yield storage.listObjects(strPath); logger.debug('downloadFileFromStorage list %s (id=%s)', list.toString(), id); //create dirs var dirsToCreate = []; var dirStruct = {}; list.forEach(function(file) { var curDirPath = dir; var curDirStruct = dirStruct; var parts = storage.getRelativePath(strPath, file).split('/'); for (var i = 0; i < parts.length - 1; ++i) { var part = parts[i]; curDirPath = path.join(curDirPath, part); if (!curDirStruct[part]) { curDirStruct[part] = {}; dirsToCreate.push(curDirPath); } } }); //make dirs for (var i = 0; i < dirsToCreate.length; ++i) { fs.mkdirSync(dirsToCreate[i]); } //download //todo Promise.all for (var i = 0; i < list.length; ++i) { var file = list[i]; var fileRel = storage.getRelativePath(strPath, file); var data = yield storage.getObject(file); fs.writeFileSync(path.join(dir, fileRel), data); }}function\* processDownloadFromStorage(dataConvert, cmd, task, tempDirs, authorProps) { let res = constants.NO\_ERROR; let needConcatFiles = false; if (task.getFromOrigin() || task.getFromSettings()) { dataConvert.fileFrom = path.join(tempDirs.source, 'origin.' + cmd.getFormat()); } else { //перезаписываем некоторые файлы из m\_sKey(например Editor.bin или changes) yield\* downloadFileFromStorage(cmd.getSaveKey(), cmd.getSaveKey(), tempDirs.source); dataConvert.fileFrom = path.join(tempDirs.source, 'Editor.bin'); needConcatFiles = true; } //mail merge let mailMergeSend = cmd.getMailMergeSend(); if (mailMergeSend) { yield\* downloadFileFromStorage(mailMergeSend.getJsonKey(), mailMergeSend.getJsonKey(), tempDirs.source); needConcatFiles = true; } if (needConcatFiles) { yield\* concatFiles(tempDirs.source); } if (task.getFromChanges()) { res = yield\* processChanges(tempDirs, cmd, authorProps); } return res;}
function\* concatFiles(source) { //concatenate EditorN.ext parts in Editor.ext let list = yield utils.listObjects(source, true); list.sort(utils.compareStringByLength); let writeStreams = {}; for (let i = 0; i < list.length; ++i) { let file = list[i]; if (file.match(/Editor\d+\./)) { let target = file.replace(/(Editor)\d+(\..\*)/, '$1$2'); let writeStream = writeStreams[target]; if (!writeStream) { writeStream = yield utils.promiseCreateWriteStream(target); writeStreams[target] = writeStream; } let readStream = yield utils.promiseCreateReadStream(file); yield utils.pipeStreams(readStream, writeStream, false); } } for (let i in writeStreams) { if (writeStreams.hasOwnProperty(i)) { writeStreams[i].end(); } }}
function\* processChanges(tempDirs, cmd, authorProps) { let res = constants.NO\_ERROR; let changesDir = path.join(tempDirs.source, constants.CHANGES\_NAME); fs.mkdirSync(changesDir); let indexFile = 0; let changesAuthor = null; let changesIndex = null; let changesHistory = { serverVersion: commonDefines.buildVersion, changes: [] }; let forceSave = cmd.getForceSave(); let forceSaveTime; let forceSaveIndex = Number.MAX\_VALUE; if (forceSave) { forceSaveTime = forceSave.getTime(); forceSaveIndex = forceSave.getIndex(); } let streamObj = yield\* streamCreate(cmd.getDocId(), changesDir, indexFile++, {highWaterMark: cfgStreamWriterBufferSize}); let curIndexStart = 0; let curIndexEnd = Math.min(curIndexStart + cfgMaxRequestChanges, forceSaveIndex); while (curIndexStart < curIndexEnd) { let changes = yield baseConnector.getChangesPromise(cmd.getDocId(), curIndexStart, curIndexEnd, forceSaveTime); for (let i = 0; i < changes.length; ++i) { let change = changes[i]; if (change.change\_data.startsWith('ENCRYPTED;')) { logger.warn('processChanges encrypted changes (id=%s)', cmd.getDocId()); //todo sql request instead? res = constants.EDITOR\_CHANGES; break; } if (null === changesAuthor || changesAuthor !== change.user\_id\_original) { if (null !== changesAuthor) { yield\* streamEnd(streamObj, ']'); streamObj = yield\* streamCreate(cmd.getDocId(), changesDir, indexFile++); } changesAuthor = change.user\_id\_original; changesIndex = utils.getIndexFromUserId(change.user\_id, change.user\_id\_original); authorProps.lastModifiedBy = change.user\_name; authorProps.modified = change.change\_date.toISOString().slice(0, 19) + 'Z'; let strDate = baseConnector.getDateTime(change.change\_date); changesHistory.changes.push({'created': strDate, 'user': {'id': changesAuthor, 'name': change.user\_name}}); yield\* streamWrite(streamObj, '['); } else { yield\* streamWrite(streamObj, ','); } yield\* streamWrite(streamObj, change.change\_data); streamObj.isNoChangesInFile = false; } if (changes.length === curIndexEnd - curIndexStart) { curIndexStart += cfgMaxRequestChanges; curIndexEnd = Math.min(curIndexStart + cfgMaxRequestChanges, forceSaveIndex); } else { break; } } yield\* streamEnd(streamObj, ']'); if (streamObj.isNoChangesInFile) { fs.unlinkSync(streamObj.filePath); } cmd.setUserId(changesAuthor); cmd.setUserIndex(changesIndex); fs.writeFileSync(path.join(tempDirs.result, 'changesHistory.json'), JSON.stringify(changesHistory), 'utf8'); return res;}
function\* streamCreate(docId, changesDir, indexFile, opt\_options) { let fileName = constants.CHANGES\_NAME + indexFile + '.json'; let filePath = path.join(changesDir, fileName); let writeStream = yield utils.promiseCreateWriteStream(filePath, opt\_options); writeStream.on('error', function(err) { //todo integrate error handle in main thread (probable: set flag here and check it in main thread) logger.error('WriteStreamError (id=%s)\r\n%s', docId, err.stack); }); return {writeStream: writeStream, filePath: filePath, isNoChangesInFile: true};}
function\* streamWrite(streamObj, text) { if (!streamObj.writeStream.write(text, 'utf8')) { yield utils.promiseWaitDrain(streamObj.writeStream); }}
function\* streamEnd(streamObj, text) { streamObj.writeStream.end(text, 'utf8'); yield utils.promiseWaitClose(streamObj.writeStream);}function\* processUploadToStorage(dir, storagePath) { var list = yield utils.listObjects(dir); if (list.length < MAX\_OPEN\_FILES) { yield\* processUploadToStorageChunk(list, dir, storagePath); } else { for (var i = 0, j = list.length; i < j; i += MAX\_OPEN\_FILES) { yield\* processUploadToStorageChunk(list.slice(i, i + MAX\_OPEN\_FILES), dir, storagePath); } }}function\* processUploadToStorageChunk(list, dir, storagePath) { yield Promise.all(list.map(function (curValue) { let localValue = storagePath + '/' + curValue.substring(dir.length + 1); return storage.uploadObject(localValue, curValue); }));}function writeProcessOutputToLog(docId, childRes, isDebug) { if (childRes) { if (undefined !== childRes.stdout) { if (isDebug) { logger.debug('stdout (id=%s):%s', docId, childRes.stdout); } else { logger.error('stdout (id=%s):%s', docId, childRes.stdout); } } if (undefined !== childRes.stderr) { if (isDebug) { logger.debug('stderr (id=%s):%s', docId, childRes.stderr); } else { logger.error('stderr (id=%s):%s', docId, childRes.stderr); } } }}function\* postProcess(cmd, dataConvert, tempDirs, childRes, error, isTimeout) { var exitCode = 0; var exitSignal = null; if(childRes) { exitCode = childRes.status; exitSignal = childRes.signal; } if (0 !== exitCode || null !== exitSignal) { if (-1 !== exitCodesReturn.indexOf(-exitCode)) { error = -exitCode; } else if(isTimeout) { error = constants.CONVERT\_TIMEOUT; } else { error = constants.CONVERT; } if (-1 !== exitCodesMinorError.indexOf(error)) { writeProcessOutputToLog(dataConvert.key, childRes, true); logger.debug('ExitCode (code=%d;signal=%s;error:%d;id=%s)', exitCode, exitSignal, error, dataConvert.key); } else { writeProcessOutputToLog(dataConvert.key, childRes, false); logger.error('ExitCode (code=%d;signal=%s;error:%d;id=%s)', exitCode, exitSignal, error, dataConvert.key); if (cfgErrorFiles) { yield\* processUploadToStorage(tempDirs.temp, cfgErrorFiles + '/' + dataConvert.key); logger.debug('processUploadToStorage error complete(id=%s)', dataConvert.key); } } } else { writeProcessOutputToLog(dataConvert.key, childRes, true); logger.debug('ExitCode (code=%d;signal=%s;error:%d;id=%s)', exitCode, exitSignal, error, dataConvert.key); } if (-1 !== exitCodesUpload.indexOf(error)) { yield\* processUploadToStorage(tempDirs.result, dataConvert.key); logger.debug('processUploadToStorage complete(id=%s)', dataConvert.key); } cmd.setStatusInfo(error); var existFile = false; try { existFile = fs.lstatSync(dataConvert.fileTo).isFile(); } catch (err) { existFile = false; } if (!existFile) { //todo пересмотреть. загрулка в случае AVS\_OFFICESTUDIO\_FILE\_OTHER\_TEAMLAB\_INNER x2t меняет расширение у файла. var fileToBasename = path.basename(dataConvert.fileTo); var fileToDir = path.dirname(dataConvert.fileTo); var files = fs.readdirSync(fileToDir); for (var i = 0; i < files.length; ++i) { var fileCur = files[i]; if (0 == fileCur.indexOf(fileToBasename)) { dataConvert.fileTo = path.join(fileToDir, fileCur); break; } } } cmd.setOutputPath(path.basename(dataConvert.fileTo)); if(!cmd.getTitle()){ cmd.setTitle(cmd.getOutputPath()); }
 var res = new commonDefines.TaskQueueData(); res.setCmd(cmd); logger.debug('output (data=%s;id=%s)', JSON.stringify(res), dataConvert.key); return res;}function deleteFolderRecursive(strPath) { if (fs.existsSync(strPath)) { var files = fs.readdirSync(strPath); files.forEach(function(file) { var curPath = path.join(strPath, file); if (fs.lstatSync(curPath).isDirectory()) { // recurse deleteFolderRecursive(curPath); } else { // delete file fs.unlinkSync(curPath); } }); fs.rmdirSync(strPath); }}
function\* ExecuteTask(task) { var startDate = null; var curDate = null; if(clientStatsD) { startDate = curDate = new Date(); } var resData; var tempDirs; var getTaskTime = new Date(); var cmd = task.getCmd(); var dataConvert = new TaskQueueDataConvert(task); logger.debug('Start Task(id=%s)', dataConvert.key); var error = constants.NO\_ERROR; tempDirs = getTempDir(); let fileTo = task.getToFile(); dataConvert.fileTo = fileTo ? path.join(tempDirs.result, fileTo) : ''; let isBuilder = cmd.getIsBuilder(); let authorProps = {lastModifiedBy: null, modified: null}; if (cmd.getUrl()) { dataConvert.fileFrom = path.join(tempDirs.source, dataConvert.key + '.' + cmd.getFormat()); error = yield\* downloadFile(dataConvert.key, cmd.getUrl(), dataConvert.fileFrom, cmd.getWithAuthorization()); if(clientStatsD) { clientStatsD.timing('conv.downloadFile', new Date() - curDate); curDate = new Date(); } } else if (cmd.getSaveKey()) { yield\* downloadFileFromStorage(cmd.getDocId(), cmd.getDocId(), tempDirs.source); logger.debug('downloadFileFromStorage complete(id=%s)', dataConvert.key); if(clientStatsD) { clientStatsD.timing('conv.downloadFileFromStorage', new Date() - curDate); curDate = new Date(); } error = yield\* processDownloadFromStorage(dataConvert, cmd, task, tempDirs, authorProps); } else if (cmd.getForgotten()) { yield\* downloadFileFromStorage(cmd.getDocId(), cmd.getForgotten(), tempDirs.source); logger.debug('downloadFileFromStorage complete(id=%s)', dataConvert.key); let list = yield utils.listObjects(tempDirs.source, false); if (list.length > 0) { dataConvert.fileFrom = list[0]; //store indicator file to determine if opening was from the forgotten file var forgottenMarkPath = tempDirs.result + '/' + cfgForgottenFilesName + '.txt'; fs.writeFileSync(forgottenMarkPath, cfgForgottenFilesName, {encoding: 'utf8'}); } else { error = constants.UNKNOWN; } } else if (isBuilder) { //in cause script in POST body yield\* downloadFileFromStorage(cmd.getDocId(), cmd.getDocId(), tempDirs.source); logger.debug('downloadFileFromStorage complete(id=%s)', dataConvert.key); let list = yield utils.listObjects(tempDirs.source, false); if (list.length > 0) { dataConvert.fileFrom = list[0]; } } else { error = constants.UNKNOWN; } var childRes = null; let isTimeout = false; if (constants.NO\_ERROR === error) { if(constants.AVS\_OFFICESTUDIO\_FILE\_OTHER\_HTMLZIP === dataConvert.formatTo && cmd.getSaveKey() && !dataConvert.mailMergeSend) { //todo заглушка.вся конвертация на клиенте, но нет простого механизма сохранения на клиенте yield utils.pipeFiles(dataConvert.fileFrom, dataConvert.fileTo); } else { var childArgs; if (cfgArgs.length > 0) { childArgs = cfgArgs.trim().replace(/ +/g, ' ').split(' '); } else { childArgs = []; } let processPath; if (!isBuilder) { processPath = cfgX2tPath; let paramsFile = path.join(tempDirs.temp, 'params.xml'); let hiddenXml = dataConvert.serialize(paramsFile); childArgs.push(paramsFile); if (hiddenXml) { childArgs.push(hiddenXml); } } else { fs.mkdirSync(path.join(tempDirs.result, 'output')); processPath = cfgDocbuilderPath; childArgs.push('--all-fonts-path=' + cfgDocbuilderAllFontsPath); childArgs.push('--save-use-only-names=' + tempDirs.result + '/output'); childArgs.push(dataConvert.fileFrom); } let timeoutId; try { let spawnOptions = cfgSpawnOptions; if (authorProps.lastModifiedBy && authorProps.modified) { //copy to avoid modification of global cfgSpawnOptions spawnOptions = Object.assign({}, cfgSpawnOptions); spawnOptions.env = Object.assign({}, spawnOptions.env || process.env);
 spawnOptions.env['LAST\_MODIFIED\_BY'] = authorProps.lastModifiedBy; spawnOptions.env['MODIFIED'] = authorProps.modified; } let spawnAsyncPromise = spawnAsync(processPath, childArgs, spawnOptions); childRes = spawnAsyncPromise.child; let waitMS = task.getVisibilityTimeout() \* 1000 - (new Date().getTime() - getTaskTime.getTime()); timeoutId = setTimeout(function() { isTimeout = true; timeoutId = undefined; //close stdio streams to enable emit 'close' event even if HtmlFileInternal is hung-up childRes.stdin.end(); childRes.stdout.destroy(); childRes.stderr.destroy(); childRes.kill(); }, waitMS); childRes = yield spawnAsyncPromise; } catch (err) { let fLog = null === err.status ? logger.error : logger.debug; fLog.call(logger, 'error spawnAsync(id=%s)\r\n%s', cmd.getDocId(), err.stack); childRes = err; } if (undefined !== timeoutId) { clearTimeout(timeoutId); } } if(clientStatsD) { clientStatsD.timing('conv.spawnSync', new Date() - curDate); curDate = new Date(); } } resData = yield\* postProcess(cmd, dataConvert, tempDirs, childRes, error, isTimeout); logger.debug('postProcess (id=%s)', dataConvert.key); if(clientStatsD) { clientStatsD.timing('conv.postProcess', new Date() - curDate); curDate = new Date(); } if (tempDirs) { deleteFolderRecursive(tempDirs.temp); logger.debug('deleteFolderRecursive (id=%s)', dataConvert.key); if(clientStatsD) { clientStatsD.timing('conv.deleteFolderRecursive', new Date() - curDate); curDate = new Date(); } } if(clientStatsD) { clientStatsD.timing('conv.allconvert', new Date() - startDate); } return resData;}
function receiveTask(data, ack) { return co(function\* () { var res = null; var task = null; try { task = new commonDefines.TaskQueueData(JSON.parse(data)); if (task) { res = yield\* ExecuteTask(task); } } catch (err) { logger.error(err); } finally { try { if (!res && task) { //если все упало так что даже нет res, все равно пытаемся отдать ошибку. var cmd = task.getCmd(); cmd.setStatusInfo(constants.CONVERT); res = new commonDefines.TaskQueueData(); res.setCmd(cmd); } if (res) { yield queue.addResponse(res); } } catch (err) { logger.error(err); } finally { ack(); } } });}function simulateErrorResponse(data){ let task = new commonDefines.TaskQueueData(JSON.parse(data)); //simulate error response let cmd = task.getCmd(); cmd.setStatusInfo(constants.CONVERT); let res = new commonDefines.TaskQueueData(); res.setCmd(cmd); return res;}function run() { queue = new queueService(simulateErrorResponse); queue.on('task', receiveTask); queue.init(true, true, true, false, false, false, function(err) { if (null != err) { logger.error('createTaskQueue error :\r\n%s', err.stack); } });}exports.run = run;

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


