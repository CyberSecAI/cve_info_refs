=== Content from plugins.trac.wordpress.org_9c7eeaf0_20250115_090258.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2659751)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/2659750 "Changeset 2659750")
* [Next Changeset](/changeset/2659752 "Changeset 2659752") →

---

# Changeset 2659751

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
01/19/2022 03:28:37 AM
([3 years](/timeline?from=2022-01-19T03%3A28%3A37Z&precision=second "See timeline at 01/19/2022 03:28:37 AM") ago)

Author:
globalprogramming
Message:

Wp remote request testing + additional escaping

Location:
[whmcs-bridge/trunk](/browser/whmcs-bridge/trunk?rev=2659751)
Files:

3 edited

* [bridge\_cp.php](/browser/whmcs-bridge/trunk/bridge_cp.php?rev=2659751 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [includes/cpedit.inc.php](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751 "Show entry in browser")
  (modified)
  ([8 diffs](#file1 "Show differences"))
* [includes/request.class.php](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751 "Show entry in browser")
  (modified)
  ([20 diffs](#file2 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [whmcs-bridge/trunk/bridge\_cp.php](/changeset/2659751/whmcs-bridge/trunk/bridge_cp.php "Show the changeset 2659751 restricted to whmcs-bridge/trunk/bridge_cp.php")

  | [r2653041](/browser/whmcs-bridge/trunk/bridge_cp.php?rev=2653041#L155 "Show revision 2653041 of this file in browser") | [r2659751](/browser/whmcs-bridge/trunk/bridge_cp.php?rev=2659751#L155 "Show revision 2659751 of this file in browser") |  |
  | --- | --- | --- |
  | 155 | 155 |  |
  | 156 | 156 | if (isset($\_REQUEST['installed'])) |
  | 157 |  | echo ~~'<div id="message" class="updated fade"><p><strong>' . WHMCS\_BRIDGE . ' installed.</strong></p></div>'~~; |
  |  | 157 | echo wp\_kses\_post('<div id="message" class="updated fade"><p><strong>' . WHMCS\_BRIDGE . ' installed.</strong></p></div>'); |
  | 158 | 158 | if (isset($\_REQUEST['error'])) { |
  | 159 |  | echo '<div id="message" class="updated fade"><p>The following error occured: <strong>' . $\_REQUEST['error'] . '</strong></p></div>'; |
  |  | 159 | $error = $\_REQUEST['error']; |
  |  | 160 |  |
  |  | 161 | echo wp\_kses\_post('<div id="message" class="updated fade"><p>The following error occured: <strong>' . $error . '</strong></p></div>'); |
  | 160 | 162 | if (strstr($\_REQUEST['error'], 'parsing')) { |
  | 161 |  | echo '<div id="message" class="updated fade"><p>Parse errors occur when the bridge is unable to connect to your WHMCS API, for more information please <a href="http://i-plugins.com/whmcs/knowledgebase/1082/I-am-getting-intermittent-DOMDocument-or-loadXML-errors-showing-up-on-the-bridge.html" target="\_blank"><strong>click here</strong></a></p></div>'; |
  | 162 |  |  |
  |  | 163 | echo wp\_kses\_post('<div id="message" class="updated fade"><p>Parse errors occur when the bridge is unable to connect to your WHMCS API, for more information please <a href="http://i-plugins.com/whmcs/knowledgebase/1082/I-am-getting-intermittent-DOMDocument-or-loadXML-errors-showing-up-on-the-bridge.html" target="\_blank"><strong>click here</strong></a></p></div>'); |
  | 163 | 164 | } |
  | 164 | 165 | } |
* ## [whmcs-bridge/trunk/includes/cpedit.inc.php](/changeset/2659751/whmcs-bridge/trunk/includes/cpedit.inc.php "Show the changeset 2659751 restricted to whmcs-bridge/trunk/includes/cpedit.inc.php")

  | [r2653261](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L1 "Show revision 2653261 of this file in browser") | [r2659751](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L1 "Show revision 2659751 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | ~~<?php~~ |
  | 2 |  | ~~//v1.09.15~~ |
  | 3 |  | ~~?>~~ |
  | 4 | 1 | <table class="optiontable wbridge" cellpadding="2" cellspacing="2"> |
  | 5 |  |  |
  | 6 | 2 | <?php if ($controlpanelOptions) { |
  | 7 | 3 | foreach ($controlpanelOptions as $value) { |
  | 8 |  |  |
  | 9 | 4 | if ($value['type'] == "text" || $value['type'] == "password") { |
  | 10 | 5 | $text\_value = get\_option($value['id']) != '' ? get\_option($value['id']) : ((isset($value['std'])) ? $value['std'] : ''); |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L18) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L13) |  |
  | 18 | 13 | <td colspan="2"> |
  | 19 | 14 | <div class="alert info small"> |
  | 20 |  | <?php echo ($value['desc']); ?> |
  |  | 15 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 21 | 16 | </div> |
  | 22 | 17 | </td> |
  | 23 | 18 | </tr> |
  | 24 | 19 | <tr align="left"> |
  | 25 |  | <th scope="row" class="wb\_lbl"><?php echo ~~$value['name']~~; ?></th> |
  | 26 |  | <td><input name="<?php echo ~~$value['id']; ?>" id="<?php echo $value['id']~~; ?>" |
  | 27 |  | ~~type="<?php echo $value['type']~~; ?>" |
  | 28 |  | ~~value="<?php echo $text\_value~~ ?>" |
  | 29 |  | size="40" |
  | 30 |  | class="ipt" |
  | 31 |  | /></td> |
  |  | 20 | <th scope="row" class="wb\_lbl"><?php echo wp\_kses\_post($value['name']); ?></th> |
  |  | 21 | <td><input name="<?php echo esc\_attr($value['id']); ?>" id="<?php echo esc\_attr($value['id']); ?>" |
  |  | 22 | type="<?php echo esc\_attr($value['type']); ?>" |
  |  | 23 | value="<?php echo esc\_attr($text\_value); ?>" |
  |  | 24 | size="40" |
  |  | 25 | class="ipt" |
  |  | 26 | /></td> |
  | 32 | 27 | </tr> |
  | 33 | 28 |  |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L37) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L32) |  |
  | 37 | 32 | <td colspan="2"> |
  | 38 | 33 | <div class="alert info small"> |
  | 39 |  | <?php echo ($value['desc']); ?> |
  |  | 34 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 40 | 35 | </div> |
  | 41 | 36 | </td> |
  | 42 | 37 | </tr> |
  | 43 | 38 | <tr align="left"> |
  | 44 |  | <th scope="row" class="wb\_lbl"><?php echo ($value['name']); ?></th> |
  |  | 39 | <th scope="row" class="wb\_lbl"><?php echo wp\_kses\_post($value['name']); ?></th> |
  | 45 | 40 | </tr> |
  | 46 | 41 |  |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L50) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L45) |  |
  | 50 | 45 | <td colspan="2"> |
  | 51 | 46 | <div class="alert info small"> |
  | 52 |  | <?php echo ($value['desc']); ?> |
  |  | 47 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 53 | 48 | </div> |
  | 54 | 49 | </td> |
  | 55 | 50 | </tr> |
  | 56 | 51 | <tr align="left"> |
  | 57 |  | <th scope="row" class="wb\_lbl"><?php echo ($value['name']); ?></th> |
  | 58 |  | <td><input class="ipt" name="<?php echo esc\_~~html($value['id']); ?>" id="<?php echo esc\_html~~($value['id']); ?>" |
  |  | 52 | <th scope="row" class="wb\_lbl"><?php echo wp\_kses\_post($value['name']); ?></th> |
  |  | 53 | <td><input class="ipt" name="<?php echo esc\_attr($value['id']); ?>" id="<?php echo esc\_attr($value['id']); ?>" |
  | 59 | 54 | type="checkbox" |
  | 60 | 55 | value="checked" |
  | 61 | 56 | <?php if (get\_option($value['id']) != "") { |
  | 62 |  | echo ~~" checked"~~; |
  |  | 57 | echo esc\_attr(" checked"); |
  | 63 | 58 | } ?> |
  | 64 | 59 | /></td> |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L70) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L65) |  |
  | 70 | 65 | <td colspan="2"> |
  | 71 | 66 | <div class="alert info small"> |
  | 72 |  | <?php echo ($value['desc']); ?> |
  |  | 67 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 73 | 68 | </div> |
  | 74 | 69 | </td> |
  | 75 | 70 | </tr> |
  | 76 | 71 | <tr align="left"> |
  | 77 |  | <th scope="row" class="wb\_lbl" colspan="2"><?php echo ~~$value['name']~~; ?></th> |
  |  | 72 | <th scope="row" class="wb\_lbl" colspan="2"><?php echo wp\_kses\_post($value['name']); ?></th> |
  | 78 | 73 | </tr> |
  | 79 | 74 | <tr align="left"> |
  | 80 |  | <td colspan="2" align="center"><textarea class="ipt" name="<?php echo ~~$value['id']; ?>" id="<?php echo $value['id']~~; ?>" cols="50" |
  |  | 75 | <td colspan="2" align="center"><textarea class="ipt" name="<?php echo esc\_attr($value['id']); ?>" id="<?php echo esc\_attr($value['id']); ?>" cols="50" |
  | 81 | 76 | rows="8"/><?php if (get\_option($value['id']) != "") { |
  | 82 |  | echo ~~stripslashes(get\_option($value['id']~~)); |
  |  | 77 | echo esc\_textarea(stripslashes(get\_option($value['id']))); |
  | 83 | 78 | } else { |
  | 84 |  | echo isset($value['std']) ? ~~$value['std'] : ''~~; |
  |  | 79 | echo isset($value['std']) ? esc\_textarea($value['std']) : esc\_textarea(''); |
  | 85 | 80 | } ?></textarea></td> |
  | 86 | 81 |  |
  | 87 | 82 | </tr> |
  | 88 | 83 | <?php } elseif ($value['type'] == "select") { ?> |
  | 89 |  |  |
  | 90 | 84 | <tr> |
  | 91 | 85 | <td colspan="2"> |
  | 92 | 86 | <div class="alert info small"> |
  | 93 |  | <?php echo ($value['desc']); ?> |
  |  | 87 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 94 | 88 | </div> |
  | 95 | 89 | </td> |
  | 96 | 90 | </tr> |
  | 97 | 91 | <tr align="left"> |
  | 98 |  | <th scope="top" class="wb\_lbl"><?php echo ~~$value['name']~~; ?></th> |
  | 99 |  | <td><select class="ipt" name="<?php echo ~~$value['id']; ?>" id="<?php echo $value['id']~~; ?>"> |
  |  | 92 | <th scope="top" class="wb\_lbl"><?php echo wp\_kses\_post($value['name']); ?></th> |
  |  | 93 | <td><select class="ipt" name="<?php echo esc\_attr($value['id']) ?>" id="<?php echo esc\_attr($value['id']); ?>"> |
  | 100 | 94 | <?php foreach ($value['options'] as $option) { ?> |
  | 101 | 95 | <option <?php if (get\_option($value['id']) == $option) { |
  | 102 |  | echo ~~' selected="selected"'~~; |
  | 103 |  | } ?>><?php echo ~~$option~~; ?></option> |
  |  | 96 | echo esc\_attr(' selected="selected"'); |
  |  | 97 | } ?>><?php echo esc\_attr($option); ?></option> |
  | 104 | 98 | <?php } ?> |
  | 105 | 99 | </select></td> |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L111) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L105) |  |
  | 111 | 105 | <td colspan="2"> |
  | 112 | 106 | <div class="alert info small"> |
  | 113 |  | <?php echo ~~$value['desc']~~; ?> |
  |  | 107 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 114 | 108 | </div> |
  | 115 | 109 | </td> |
  | 116 | 110 | </tr> |
  | 117 | 111 | <tr align="left"> |
  | 118 |  | <th scope="top" class="wb\_lbl"><?php echo ~~$value['name']~~; ?></th> |
  | 119 |  | <td><select class="ipt" name="<?php echo ~~$value['id']; ?>" id="<?php echo $value['id']~~; ?>"> |
  |  | 112 | <th scope="top" class="wb\_lbl"><?php echo wp\_kses\_post($value['name']); ?></th> |
  |  | 113 | <td><select class="ipt" name="<?php echo esc\_attr($value['id']); ?>" id="<?php echo esc\_attr($value['id']); ?>"> |
  | 120 | 114 | <?php foreach ($value['options'] as $key => $option) { ?> |
  | 121 |  | <option value="<?php echo ~~$key~~; ?>" |
  |  | 115 | <option value="<?php echo esc\_attr($key); ?>" |
  | 122 | 116 | <?php |
  | 123 | 117 | if (get\_option($value['id']) == $key) { |
  | 124 |  | echo ~~' selected="selected"'~~; |
  |  | 118 | echo esc\_attr(' selected="selected"'); |
  | 125 | 119 | } elseif (!get\_option($value['id']) && isset($value['std']) && $value['std'] == $key) { |
  | 126 |  | echo ~~' selected="selected"'~~; |
  |  | 120 | echo esc\_attr(' selected="selected"'); |
  | 127 | 121 | } |
  | 128 | 122 | ?> |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L138) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L132) |  |
  | 138 | 132 | <td colspan="2"> |
  | 139 | 133 | <div class="alert info small"> |
  | 140 |  | <?php echo ~~$value['desc']~~; ?> |
  |  | 134 | <?php echo wp\_kses\_post($value['desc']); ?> |
  | 141 | 135 | </div> |
  | 142 | 136 | </td> |
  | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2653261#L144) | […](/browser/whmcs-bridge/trunk/includes/cpedit.inc.php?rev=2659751#L138) |  |
  | 144 | 138 | <tr valign="top"> |
  | 145 | 139 | <td colspan="2" style="text-align: left;"> |
  | 146 |  | <h2><?php echo ~~$value['name']~~; ?></h2> |
  |  | 140 | <h2><?php echo wp\_kses\_post($value['name']); ?></h2> |
  | 147 | 141 | </td> |
  | 148 | 142 | </tr> |
* ## [whmcs-bridge/trunk/includes/request.class.php](/changeset/2659751/whmcs-bridge/trunk/includes/request.class.php "Show the changeset 2659751 restricted to whmcs-bridge/trunk/includes/request.class.php")

  | [r2659243](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L1 "Show revision 2659243 of this file in browser") | [r2659751](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L1 "Show revision 2659751 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | class bridgeHttpRequest  { |
  | 3 |  | var $\_fp;        // HTTP socket |
  | 4 |  | var $\_url;        // full URL |
  | 5 |  | var $\_host;        // HTTP host |
  | 6 |  | var $\_protocol;    // protocol (HTTP/HTTPS) |
  | 7 |  | var $\_uri;        // request URI |
  | 8 |  | var $\_port;        // port |
  | 9 |  | var $\_path; |
  | 10 |  | var $error=false; |
  | 11 |  | var $errno=false; |
  | 12 |  | var $post=array();  //post variables, defaults to $\_POST |
  | 13 |  | var $redirect=false; |
  | 14 |  | var $forceWithRedirect=array(); |
  | 15 |  | var $errors=array(); |
  | 16 |  | var $countRedirects=0; |
  | 17 |  | var $sid; |
  | 18 |  | var $httpCode; |
  | 19 |  | var $repost=false; |
  | 20 |  | var $type; //content-type |
  | 21 |  | var $follow=true; //whether to follow redirect links or not |
  | 22 |  | var $noErrors=false; //whether to trigger an error in case of a curl error |
  | 23 |  | var $errorMessage; |
  | 24 |  | var $httpHeaders=array('Expect:','bridgeon: 1'); //avoid 417 errors |
  | 25 |  | var $debugFunction; |
  | 26 |  | var $time; |
  | 27 |  | var $cookieArray=array(); |
  | 28 |  | var $cookieCache=''; |
  |  | 3 | public $\_fp;        // HTTP socket |
  |  | 4 | public $\_url;        // full URL |
  |  | 5 | public $\_host;        // HTTP host |
  |  | 6 | public $\_protocol;    // protocol (HTTP/HTTPS) |
  |  | 7 | public $\_uri;        // request URI |
  |  | 8 | public $\_port;        // port |
  |  | 9 | public $\_path; |
  |  | 10 | public $error=false; |
  |  | 11 | public $errno=false; |
  |  | 12 | public $post=array();   //post variables, defaults to $\_POST |
  |  | 13 | public $redirect=false; |
  |  | 14 | public $forceWithRedirect=array(); |
  |  | 15 | public $errors=array(); |
  |  | 16 | public $countRedirects=0; |
  |  | 17 | public $sid; |
  |  | 18 | public $httpCode; |
  |  | 19 | public $repost=false; |
  |  | 20 | public $type; //content-type |
  |  | 21 | public $follow = true; //whether to follow redirect links or not |
  |  | 22 | public $noErrors = false; //whether to trigger an error in case of a curl error |
  |  | 23 | public $errorMessage; |
  |  | 24 | public $httpHeaders = array('Expect:','bridgeon: 1'); //avoid 417 errors |
  |  | 25 | public $debugFunction; |
  |  | 26 | public $time; |
  |  | 27 | public $cookieArray = array(); |
  |  | 28 | public $cookieCach=''; |
  |  | 29 | public $debugPrefix = ''; |
  | 29 | 30 |  |
  | 30 | 31 | // constructor |
  | 31 |  | function \_\_construct($url = "", $sid = "", $repost = false) { |
  |  | 32 | public function \_\_construct($url = "", $sid = "", $repost = false) { |
  | 32 | 33 | if (!$url) return; |
  | 33 | 34 | $this->sid=$sid; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L36) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L37) |  |
  | 36 | 37 | $this->post=$\_POST; |
  | 37 | 38 | $this->repost=$repost; |
  |  | 39 | $this->debugPrefix = "[connect ".uniqid()."] "; |
  | 38 | 40 | } |
  | 39 | 41 |  |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L57) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L59) |  |
  | 57 | 59 |  |
  | 58 | 60 | private function debug($type=0,$msg='',$filename="",$linenum=0) { |
  | 59 |  | if ($f=$this->debugFunction) $f($type,$msg,$filename,$linenum); |
  |  | 61 | if ($f=$this->debugFunction) $f($type,$this->debugPrefix.$msg,$filename,$linenum); |
  | 60 | 62 | } |
  | 61 | 63 |  |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L63) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L65) |  |
  | 63 | 65 | if (strtoupper(substr(PHP\_OS, 0, 3)) === 'WIN') return 'WINDOWS'; |
  | 64 | 66 | else return 'LINUX'; |
  | 65 |  | ~~}~~ |
  | 66 |  |  |
  | 67 |  | ~~private function processHeaders($headers) {~~ |
  | 68 |  | ~~$this->debug(0, 'Processing headers: '.json\_encode($headers));~~ |
  | 69 |  |  |
  | 70 |  | ~~// split headers, one per array element~~ |
  | 71 |  | ~~if ( is\_string($headers) ) {~~ |
  | 72 |  | ~~// tolerate line terminator: CRLF = LF (RFC 2616 19.3)~~ |
  | 73 |  | ~~$headers = str\_replace("\r\n", "\n", $headers);~~ |
  | 74 |  | ~~// unfold folded header fields. LWS = [CRLF] 1\*( SP | HT ) <US-ASCII SP, space (32)>, <US-ASCII HT, horizontal-tab (9)> (RFC 2616 2.2)~~ |
  | 75 |  | ~~$headers = preg\_replace('/\n[ \t]/', ' ', $headers);~~ |
  | 76 |  | ~~// create the headers array~~ |
  | 77 |  | ~~$headers = explode("\n", $headers);~~ |
  | 78 |  | ~~}~~ |
  | 79 |  |  |
  | 80 |  | ~~$response = array('code' => 0, 'message' => '');~~ |
  | 81 |  |  |
  | 82 |  | ~~// If a redirection has taken place, The headers for each page request may have been passed.~~ |
  | 83 |  | ~~// In this case, determine the final HTTP header and parse from there.~~ |
  | 84 |  | ~~for ( $i = count($headers)-1; $i >= 0; $i-- ) {~~ |
  | 85 |  | ~~if ( !empty($headers[$i]) && false === strpos($headers[$i], ':') ) {~~ |
  | 86 |  | ~~$headers = array\_splice($headers, $i);~~ |
  | 87 |  | ~~break;~~ |
  | 88 |  | ~~}~~ |
  | 89 |  | ~~}~~ |
  | 90 |  |  |
  | 91 |  | ~~$cookies = '';~~ |
  | 92 |  | ~~$newheaders = array();~~ |
  | 93 |  |  |
  | 94 |  | ~~foreach ( $headers as $tempheader ) {~~ |
  | 95 |  | ~~if ( empty($tempheader) )~~ |
  | 96 |  | ~~continue;~~ |
  | 97 |  |  |
  | 98 |  | ~~if ( false === strpos($tempheader, ':') ) {~~ |
  | 99 |  | ~~list( , $response['code'], $response['message']) = explode(' ', $tempheader, 3);~~ |
  | 100 |  | ~~continue;~~ |
  | 101 |  | ~~}~~ |
  | 102 |  |  |
  | 103 |  | ~~list($key, $value) = explode(':', $tempheader, 2);~~ |
  | 104 |  |  |
  | 105 |  | ~~if ( !empty( $value ) ) {~~ |
  | 106 |  | ~~$key = strtolower( $key );~~ |
  | 107 |  |  |
  | 108 |  | ~~if ( isset( $newheaders[$key] ) ) {~~ |
  | 109 |  | ~~if ( !is\_array($newheaders[$key]) )~~ |
  | 110 |  | ~~$newheaders[$key] = array($newheaders[$key]);~~ |
  | 111 |  | ~~$newheaders[$key][] = trim( $value );~~ |
  | 112 |  | ~~} else {~~ |
  | 113 |  | ~~$newheaders[$key] = trim( $value );~~ |
  | 114 |  | ~~}~~ |
  | 115 |  | ~~if ('set-cookie' == $key) {~~ |
  | 116 |  | ~~if ($cookies) $cookies.=' ;';~~ |
  | 117 |  | ~~$cookies .= $value;~~ |
  | 118 |  | ~~list($k,$rest)=explode('=',$value,2);~~ |
  | 119 |  | ~~$this->cookieArray[trim($k)]=$value;~~ |
  | 120 |  | ~~if (stristr($value,'=deleted'))~~ |
  | 121 |  | ~~unset($\_SESSION[$this->sid]['cookie-array'][trim($k)]);~~ |
  | 122 |  | ~~else~~ |
  | 123 |  | ~~$\_SESSION[$this->sid]['cookie-array'][trim($k)]=$value;~~ |
  | 124 |  | ~~}~~ |
  | 125 |  | ~~}~~ |
  | 126 |  | ~~}~~ |
  | 127 |  | ~~return array('response' => $response, 'headers' => $newheaders, 'cookies' => $cookies);~~ |
  | 128 | 67 | } |
  | 129 | 68 |  |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L158) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L97) |  |
  | 158 | 97 |  |
  | 159 | 98 | //check if server is live |
  | 160 |  | function live() { |
  |  | 99 | public function live() { |
  | 161 | 100 | //return true; |
  | 162 | 101 | if (ip2long($this->\_host)) return true; //in case using an IP instead of a host name |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L169) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L108) |  |
  | 169 | 108 |  |
  | 170 | 109 | //get mime type of uploaded file |
  | 171 |  | function mimeType($file) { |
  |  | 110 | public function mimeType($file) { |
  | 172 | 111 | $mime=''; |
  | 173 | 112 | if (function\_exists('finfo\_open')) { |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L182) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L121) |  |
  | 182 | 121 |  |
  | 183 | 122 | //check if wp HTTP API is available |
  | 184 |  | function curlInstalled() { |
  |  | 123 | public function curlInstalled() { |
  | 185 | 124 | if (!function\_exists('wp\_remote\_request')) return false; |
  | 186 | 125 | else return true; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L188) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L127) |  |
  | 188 | 127 |  |
  | 189 | 128 | //check destination is reachable |
  | 190 |  | function checkConnection() { |
  |  | 129 | public function checkConnection() { |
  | 191 | 130 | $this->post['checkconnection']=1; |
  | 192 | 131 | $output=$this->connect($this->\_protocol.'://'.$this->\_host.$this->\_uri); |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L196) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L135) |  |
  | 196 | 135 |  |
  | 197 | 136 | //error logging |
  | 198 |  | function error($msg) { |
  |  | 137 | public function error($msg) { |
  | 199 | 138 | $this->errorMsg=$msg; |
  | 200 | 139 | $this->error=true; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L204) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L143) |  |
  | 204 | 143 |  |
  | 205 | 144 | //notification logging |
  | 206 |  | function notify($msg) { |
  |  | 145 | public function notify($msg) { |
  | 207 | 146 | $this->errorMsg=$msg; |
  | 208 | 147 | $this->error=true; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L212) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L151) |  |
  | 212 | 151 |  |
  | 213 | 152 | // download URL to string |
  | 214 |  | function DownloadToString($withHeaders=true,$withCookies=false) { |
  |  | 153 | public function DownloadToString($withHeaders=true,$withCookies=false) { |
  | 215 | 154 | if ($this->\_port == 80 || $this->\_port == 443) |
  | 216 | 155 | $html = $this->connect($this->\_protocol.'://'.$this->\_host.$this->\_uri,$withHeaders,$withCookies); |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L221) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L160) |  |
  | 221 | 160 | } |
  | 222 | 161 |  |
  | 223 |  | function makeQueryString($params, $prefix = '', $removeFinalAmp = true) { |
  |  | 162 | public function makeQueryString($params, $prefix = '', $removeFinalAmp = true) { |
  | 224 | 163 | $queryString = ''; |
  | 225 | 164 | if (is\_array($params)) { |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L246) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L185) |  |
  | 246 | 185 | } |
  | 247 | 186 |  |
  | 248 |  | function connect($url, $withHeaders=true, $withCookies=false) { |
  |  | 187 | private function generatePostArray() { |
  |  | 188 | $apost = []; |
  |  | 189 | if (count($this->post) > 0) { |
  |  | 190 | $this->debug(0, "HTTP POST 2"); |
  |  | 191 | $post = ""; |
  |  | 192 | $apost = array(); |
  |  | 193 | $this->post = stripslashes\_deep($this->post); |
  |  | 194 | foreach ($this->post as $k => $v) { |
  |  | 195 | if (is\_array($v)) { |
  |  | 196 | foreach ($v as $k2 => $v2) { |
  |  | 197 | if (is\_array($v2)) { |
  |  | 198 | foreach ($v2 as $k3 => $v3) { |
  |  | 199 | if (is\_array($v3)) { |
  |  | 200 | foreach ($v3 as $k4 => $v4) { |
  |  | 201 | $apost[$k . '[' . $k2 . ']' . '[' . $k3 . '][' . $k4 . ']'] = ($v4); |
  |  | 202 | } |
  |  | 203 | } else { |
  |  | 204 | $apost[$k . '[' . $k2 . ']' . '[' . $k3 . ']'] = ($v3); |
  |  | 205 | } |
  |  | 206 | } |
  |  | 207 | } else { |
  |  | 208 | $apost[$k . '[' . $k2 . ']'] = ($v2); |
  |  | 209 | } |
  |  | 210 | } |
  |  | 211 |  |
  |  | 212 | } else { |
  |  | 213 | $apost[$k] = ($v); |
  |  | 214 | } |
  |  | 215 | } |
  |  | 216 | } |
  |  | 217 | return $apost; |
  |  | 218 | } |
  |  | 219 |  |
  |  | 220 | public function connect($url, $withHeaders=true, $withCookies=false) { |
  | 249 | 221 | $this->time('reset'); |
  | 250 | 222 | global $wordpressPageName; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L281) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L253) |  |
  | 281 | 253 | $http\_args = array(); |
  | 282 | 254 |  |
  | 283 |  | $this->debug(0, 'HTTP Call: ' . $url . (is\_array($this->post) ? ' with ' . ~~print\_r($this->post, true~~) : '')); |
  |  | 255 | $this->debug(0, 'HTTP Call: ' . $url . (is\_array($this->post) ? ' with ' . json\_encode($this->post) : '')); |
  | 284 | 256 |  |
  | 285 | 257 | if (get\_option("cc\_whmcs\_bridge\_affiliate\_id") && is\_numeric(get\_option("cc\_whmcs\_bridge\_affiliate\_id")) && get\_option("cc\_whmcs\_bridge\_affiliate\_id") > 0) { |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L293) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L265) |  |
  | 293 | 265 |  |
  | 294 | 266 | $http\_args['headers'] = $this->httpHeaders; |
  | 295 |  |  |
  | 296 |  | ~~//        curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); // return into a variable~~ |
  | 297 |  | ~~//        curl\_setopt($ch, CURLOPT\_USERAGENT, $\_SERVER['HTTP\_USER\_AGENT']);~~ |
  | 298 |  |  |
  | 299 |  | ~~//cloudflare debug~~ |
  | 300 |  | ~~//        curl\_setopt($ch, CURLOPT\_FORBID\_REUSE, 1);~~ |
  | 301 |  | ~~//        curl\_setopt($ch, CURLOPT\_FRESH\_CONNECT, 1);~~ |
  | 302 |  |  |
  | 303 |  | ~~//CURLOPT\_REFERER -  The contents of the "Referer: " header to be used in a HTTP request.~~ |
  | 304 |  | ~~//CURLOPT\_INTERFACE -  The name of the outgoing network interface to use. This can be an interface name, an IP address or a host name.~~ |
  | 305 |  |  |
  | 306 |  | ~~//        curl\_setopt($ch, CURLOPT\_TIMEOUT, 120); // times out after 120s~~ |
  | 307 | 267 | $http\_args['timeout'] = 60; |
  | 308 | 268 |  |
  | 309 | 269 | if ($this->\_protocol == "https") { |
  | 310 | 270 | $http\_args['sslverify'] = false; |
  | 311 |  | //            curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0); |
  | 312 |  | //            curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0); |
  | 313 |  | //            curl\_setopt($ch, CURLOPT\_CAINFO, NULL); |
  | 314 |  | //            curl\_setopt($ch, CURLOPT\_CAPATH, NULL); |
  | 315 |  | //curl\_setopt($ch, CURLOPT\_SSLVERSION, 3); |
  | 316 |  | } |
  | 317 |  | // gzip |
  | 318 |  | //        $this->debug(0, 'Server Software: '.$\_SERVER['SERVER\_SOFTWARE']); |
  | 319 |  | //        if (stristr($\_SERVER['SERVER\_SOFTWARE'], 'litespeed') !== false) { |
  | 320 |  | //            curl\_setopt($ch, CURLOPT\_ENCODING, ""); |
  | 321 |  | //        } |
  | 322 |  | // quicker lookup |
  | 323 |  | //curl\_setopt($ch, CURLOPT\_IPRESOLVE, CURL\_IPRESOLVE\_V4); |
  | 324 |  |  |
  | 325 |  | $cookies = ""; |
  | 326 |  | //        $cookies = apply\_filters('bridgeHttpRequest\_pre', $cookies); |
  | 327 |  |  |
  | 328 |  | if (isset($\_SESSION[$this->sid]['cookie-array']) && count($\_SESSION[$this->sid]['cookie-array']) > 0) { |
  | 329 |  | foreach ($\_SESSION[$this->sid]['cookie-array'] as $n => $v) { |
  | 330 |  | // CloudFlare |
  | 331 |  | if (stristr($n, '\_\_cfduid') !== false) continue; |
  | 332 |  | if (stristr($n, '\_cflb') !== false) continue; |
  | 333 |  | if (stristr($n, '\_cf\_bm') !== false) continue; |
  | 334 |  |  |
  | 335 |  | if ($cookies) $cookies .= ';'; |
  | 336 |  | $cookies .= $v; |
  | 337 |  | } |
  | 338 |  | } |
  | 339 |  |  |
  | 340 |  | if ($cookies) { |
  | 341 |  | $this->debug(0, 'Cookie before:' . json\_encode(explode("\r\n", $cookies))); |
  | 342 |  | if (stristr($cookies, '\_\_cfduid') !== false) { |
  | 343 |  | $cookies = 'WHMCS'.substr($cookies, strpos($cookies, "WHMCS") + 1); |
  | 344 |  | } |
  | 345 |  | //curl\_setopt($ch, CURLOPT\_COOKIE, $cookies); |
  | 346 |  | $http\_args['cookies'] = explode(";", $cookies); |
  | 347 |  | } |
  | 348 |  |  |
  | 349 |  | $\_SESSION['cookieCache'] = $cookies; |
  |  | 271 | } |
  |  | 272 |  |
  |  | 273 | $cookies = []; |
  |  | 274 |  |
  |  | 275 | if (isset($\_SESSION[$this->sid]['cookieArr']) && count($\_SESSION[$this->sid]['cookieArr']) > 0) { |
  |  | 276 | $cookies = $\_SESSION[$this->sid]['cookieArr']; |
  |  | 277 | } |
  |  | 278 |  |
  |  | 279 | if (!empty($cookies)) { |
  |  | 280 | $this->debug(0, 'Cookie before:' . json\_encode($cookies)); |
  |  | 281 | $http\_args['cookies'] = $cookies; |
  |  | 282 | } |
  |  | 283 |  |
  |  | 284 | $\_SESSION['cookieCach'] = $cookies; |
  | 350 | 285 |  |
  | 351 | 286 | /\*if (count($\_FILES) > 0) { |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L388) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L323) |  |
  | 388 | 323 |  |
  | 389 | 324 | $rawPost = file\_get\_contents('php://input'); |
  | 390 |  | cc\_whmcs\_log(0, "RAW data: ".$rawPost); |
  | 391 |  | $apost = array(); |
  | 392 |  |  |
  | 393 |  | if (count($this->post) > 0) { |
  | 394 |  | cc\_whmcs\_log(0, "HTTP Method POST 2"); |
  | 395 |  | //curl\_setopt($ch, CURLOPT\_POST, 1); // set POST method |
  | 396 |  | $post = ""; |
  | 397 |  | $apost = array(); |
  | 398 |  | $this->post = stripslashes\_deep($this->post); |
  | 399 |  | foreach ($this->post as $k => $v) { |
  | 400 |  | if (is\_array($v)) { |
  | 401 |  | foreach ($v as $k2 => $v2) { |
  | 402 |  | if (is\_array($v2)) { |
  | 403 |  | foreach ($v2 as $k3 => $v3) { |
  | 404 |  | if (is\_array($v3)) { |
  | 405 |  | foreach ($v3 as $k4 => $v4) { |
  | 406 |  | $apost[$k . '[' . $k2 . ']' . '[' . $k3 . '][' . $k4 . ']'] = ($v4); |
  | 407 |  | } |
  | 408 |  | } else { |
  | 409 |  | $apost[$k . '[' . $k2 . ']' . '[' . $k3 . ']'] = ($v3); |
  | 410 |  | } |
  | 411 |  | } |
  | 412 |  | } else { |
  | 413 |  | $apost[$k . '[' . $k2 . ']'] = ($v2); |
  | 414 |  | } |
  | 415 |  | } |
  | 416 |  |  |
  | 417 |  | } else { |
  | 418 |  | $apost[$k] = ($v); |
  | 419 |  | } |
  | 420 |  | } |
  | 421 |  | } else if (stristr($url, 'two-factor') !== false && stristr($url, 'totp') === false) { |
  | 422 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, "POST"); // set POST method |
  | 423 |  | cc\_whmcs\_log(0, "HTTP customrequest Method POST 1"); |
  | 424 |  | } |
  | 425 |  |  |
  | 426 |  | if (count($apost) > 0) { |
  |  | 325 | if (!empty($rawPost)) |
  |  | 326 | $this->debug(0, "RAW data: ".$rawPost); |
  |  | 327 |  |
  |  | 328 | $apost = $this->generatePostArray(); |
  |  | 329 |  |
  |  | 330 | if (!empty($apost)) { |
  | 427 | 331 | $http\_args['method'] = 'POST'; |
  | 428 | 332 |  |
  | 429 | 333 | if (stristr($url, 'clientarea.php?action=details') !== false && !isset($apost['save']) && isset($apost['firstname'], $apost['lastname'], $apost['companyname'], $apost['address1'])) { |
  | 430 | 334 | $apost['save'] = 'Save Changes'; |
  | 431 |  | ~~cc\_whmcs\_lo~~g(0, 'Safari patch for updating personal details'); |
  |  | 335 | $this->debug(0, 'Safari patch for updating personal details'); |
  | 432 | 336 | } |
  | 433 | 337 |  |
  | 434 | 338 | if (count($newfiles) > 0) { |
  | 435 |  | //                curl\_setopt($ch, CURLOPT\_POSTFIELDS, $apost); |
  | 436 |  | cc\_whmcs\_log(0, 'Posting as [0]:  ' . print\_r($apost, true)); |
  |  | 339 | $this->debug(0, 'Posting as [0]:  ' . json\_encode($apost)); |
  | 437 | 340 |  |
  | 438 | 341 | $http\_args['body'] = $apost; |
  | 439 | 342 | } else { |
  | 440 | 343 | $pfields = $this->makeQueryString($apost); |
  | 441 |  | //                curl\_setopt($ch, CURLOPT\_POSTFIELDS, $pfields); |
  | 442 |  | cc\_whmcs\_log(0, 'Posting as [1]:  ' . print\_r($pfields, true)); |
  |  | 344 | $this->debug(0, 'Posting as [1]:  ' . json\_encode($pfields)); |
  | 443 | 345 |  |
  | 444 | 346 | $http\_args['body'] = $pfields; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L448) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L350) |  |
  | 448 | 350 | $http\_args['method'] = 'POST'; |
  | 449 | 351 |  |
  | 450 |  | if (in\_array(substr($rawPost, 0, 1),  ['[', '{', '"'])) { |
  | 451 |  | //                curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, "POST"); // set POST method |
  | 452 |  | } else { |
  |  | 352 | if (!in\_array(substr($rawPost, 0, 1),  ['[', '{', '"'])) { |
  | 453 | 353 | parse\_str($rawPost, $rawPost); |
  | 454 | 354 | } |
  | 455 |  | ~~//            curl\_setopt($ch, CURLOPT\_POSTFIELDS, $rawPost);~~ |
  | 456 | 355 |  |
  | 457 | 356 | $http\_args['body'] = $rawPost; |
  | 458 | 357 |  |
  | 459 |  | cc\_whmcs\_log(0, "Posting RAW: ".$rawPost); |
  | 460 |  | //            cc\_whmcs\_log(0, "HTTP customrequest Method POST 2"); |
  |  | 358 | $this->debug(0, "Posting RAW: ".$rawPost); |
  | 461 | 359 | } else if (strtolower($\_SERVER['REQUEST\_METHOD']) == "post" && strstr($url, 'viewinvoice.php') === false) { |
  | 462 | 360 | $http\_args['method'] = 'POST'; |
  | 463 |  | //curl\_setopt($ch, CURLOPT\_POST, 1); // set POST method |
  | 464 |  | cc\_whmcs\_log(0, "HTTP Method POST 1"); |
  | 465 |  | } |
  | 466 |  |  |
  | 467 |  | //        $data = curl\_exec($ch); // run the whole process |
  | 468 |  |  |
  |  | 361 |  |
  |  | 362 | $this->debug(0, "HTTP Method POST 1"); |
  |  | 363 | } |
  | 469 | 364 |  |
  | 470 | 365 | // Fix legacy headers |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L482) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L377) |  |
  | 482 | 377 | } |
  | 483 | 378 |  |
  | 484 |  | ~~cc\_whmcs\_lo~~g(0, "Posting to {$url} with: ".json\_encode($http\_args)); |
  |  | 379 | $this->debug(0, "Posting to {$url} with: ".json\_encode($http\_args)); |
  | 485 | 380 |  |
  | 486 | 381 | $data = wp\_remote\_request($url, $http\_args); |
  | 487 | 382 |  |
  | 488 |  | //        if (curl\_errno($ch)) { |
  | 489 |  | //            $this->errno = curl\_errno($ch); |
  | 490 |  | //            $this->error = curl\_error($ch); |
  | 491 |  | //            $error\_msg = 'An error has occurred: ' . $this->error; |
  | 492 |  | //            $this->error($this->errno . '/' . $error\_msg.' ('.$url.')'); |
  | 493 |  | //            cc\_whmcs\_log(0, 'HTTP Error:  '.$this->errno . '/' . $error\_msg.' ('.$url.')'); |
  | 494 |  | //            return '<body>'.$error\_msg.'<br>Please try again later.</body>'; |
  | 495 |  | //        } |
  | 496 |  | // |
  | 497 |  | //        $info = curl\_getinfo($ch); |
  |  | 383 | if (is\_wp\_error($data)) { |
  |  | 384 | $this->errno = $data->get\_error\_code(); |
  |  | 385 | $this->error = $data->get\_error\_message($this->errno); |
  |  | 386 | $error\_msg = 'An error has occurred: ' . $this->error; |
  |  | 387 | $this->error($this->errno . '/' . $error\_msg.' ('.$url.')'); |
  |  | 388 | $this->debug(0, 'HTTP Error:  '.$this->errno . '/' . $error\_msg.' ('.$url.')'); |
  |  | 389 | return '<body>'.$error\_msg.'<br>Please try again later.</body>'; |
  |  | 390 | } |
  | 498 | 391 |  |
  | 499 | 392 | if (!empty($data)) { |
  | 500 |  | ~~//            $headerLength = curl\_getinfo($ch, CURLINFO\_HEADER\_SIZE);~~ |
  | 501 |  | ~~//            $head = trim(substr($data, 0, $headerLength));~~ |
  | 502 |  | ~~//            if (strlen($data) > $headerLength) $body = substr($data, $headerLength);~~ |
  | 503 |  | ~~//            else $body = '';~~ |
  | 504 |  | ~~//            if (false !== strpos($head, "\r\n\r\n")) {~~ |
  | 505 |  | ~~//                $headerParts = explode("\r\n\r\n", $head);~~ |
  | 506 |  | ~~//                $head = $headerParts[count($headerParts) - 1];~~ |
  | 507 |  | ~~//            }~~ |
  | 508 |  | ~~//~~ |
  | 509 |  | ~~//            cc\_whmcs\_log(0, "Head: ".json\_encode($head));~~ |
  | 510 |  | ~~//~~ |
  | 511 |  | ~~//            $head = $this->processHeaders($head);~~ |
  | 512 |  | ~~//            $headers = $head['headers'];~~ |
  | 513 |  | ~~//            $cookies = $head['cookies'];~~ |
  | 514 |  | ~~//~~ |
  | 515 |  | ~~//            if (empty($cookies))~~ |
  | 516 |  | ~~//                $cookies = $\_SESSION['cookieCache'];~~ |
  | 517 |  |  |
  | 518 | 393 | $headers = $data['headers']->getAll(); |
  | 519 | 394 |  |
  | 520 |  | cc\_whmcs\_log(0, 'Headers: '.print\_r($headers, true)); |
  | 521 |  |  |
  | 522 |  | $cookies = $headers['set-cookie']; |
  | 523 |  |  |
  | 524 |  | list($k, $rest) = explode('=', $cookies,2); |
  | 525 |  |  |
  | 526 |  | $this->cookieArray[trim($k)] = $cookies; |
  | 527 |  |  |
  | 528 |  | if (stristr($cookies,'=deleted')) |
  | 529 |  | unset($\_SESSION[$this->sid]['cookie-array'][trim($k)]); |
  | 530 |  | else |
  | 531 |  | $\_SESSION[$this->sid]['cookie-array'][trim($k)] = $cookies; |
  |  | 395 | $this->debug(0, 'Headers: '.json\_encode($headers)); |
  |  | 396 |  |
  |  | 397 | $cookies = wp\_remote\_retrieve\_cookies($data); |
  |  | 398 | if (!empty($cookies) && !is\_wp\_error($cookies)) { |
  |  | 399 | $\_SESSION[$this->sid]['cookieArr'] = $cookies; |
  |  | 400 | } else { |
  |  | 401 | $cookies = $\_SESSION['cookieCach']; |
  |  | 402 | } |
  | 532 | 403 |  |
  | 533 | 404 | $body = $data['body']; |
  | 534 | 405 | } else { |
  | 535 | 406 | $headers = array(); |
  | 536 |  | $cookies = ''; |
  | 537 |  | $body = ''; |
  | 538 |  | $this->error('An undefined error occured'); |
  | 539 |  | return '<body>An undefined error occured</body>'; |
  | 540 |  | } |
  | 541 |  |  |
  | 542 |  | if (isset($this->cookieArray['PHPSESSID']) && $this->cookieArray['PHPSESSID']) { |
  | 543 |  | $\_SESSION[$this->sid]['sessid'] = $this->cookieArray['PHPSESSID']; |
  | 544 |  | } |
  | 545 |  |  |
  | 546 |  | if ($cookies) { |
  |  | 407 | $cookies = []; |
  |  | 408 | $body = ""; |
  |  | 409 |  |
  |  | 410 | $this->error("An undefined error occurred"); |
  |  | 411 |  |
  |  | 412 | return '<body>An undefined error occurred</body>'; |
  |  | 413 | } |
  |  | 414 |  |
  |  | 415 |  |
  |  | 416 | $foundSessId = false; |
  |  | 417 | foreach ($cookies as $ck) { |
  |  | 418 | if ($ck->name == 'PHPSESSID') { |
  |  | 419 | $foundSessId = true; |
  |  | 420 | $\_SESSION[$this->sid]['sessid'] = $ck->value; |
  |  | 421 | } |
  |  | 422 | } |
  |  | 423 |  |
  |  | 424 | if (!empty($cookies)) { |
  | 547 | 425 | $this->debug(0, 'Cookie after:' . json\_encode($cookies)); |
  | 548 | 426 |  |
  | 549 |  | if (!isset($\_SESSION[$this->sid])) $\_SESSION[$this->sid] = array(); |
  |  | 427 | if (!isset($\_SESSION[$this->sid])) |
  |  | 428 | $\_SESSION[$this->sid] = array(); |
  |  | 429 |  |
  | 550 | 430 | if (isset($\_SESSION[$this->sid]['sessid'])) { |
  | 551 |  | if (!strstr($cookies, 'PHPSESSID') && $cookies) $cookies .= ';' . $\_SESSION[$this->sid]['sessid']; |
  | 552 |  | elseif (!strstr($cookies, 'PHPSESSID')) $cookies = $\_SESSION[$this->sid]['sessid']; |
  | 553 |  | } |
  |  | 431 | if (!$foundSessId) |
  |  | 432 | $cookies[] = new WP\_Http\_Cookie(['name' => 'PHPSESSID', 'value' => $\_SESSION[$this->sid]['sessid']]); |
  |  | 433 | } |
  |  | 434 |  |
  | 554 | 435 | $\_SESSION[$this->sid]['cookies'] = $cookies; |
  | 555 | 436 | } |
  | 556 |  | if (is\_array($cookies)) $this->debug(0, 'Cookie after:' . json\_encode($cookies)); |
  | 557 |  |  |
  | 558 |  | ~~//curl\_close($ch~~); |
  | 559 |  |  |
  | 560 |  | //remove temporary upload files |
  |  | 437 |  |
  |  | 438 | if (is\_array($cookies)) |
  |  | 439 | $this->debug(0, 'Cookie after:' . json\_encode($cookies)); |
  |  | 440 |  |
  |  | 441 | // remove temporary upload files |
  | 561 | 442 | if (count($newfiles) > 0) { |
  | 562 |  | foreach ($newfiles as $~~file~~) { |
  | 563 |  | @unlink($~~file~~); |
  |  | 443 | foreach ($newfiles as $nF) { |
  |  | 444 | @unlink($nF); |
  | 564 | 445 | } |
  | 565 | 446 | } |
  | 566 | 447 |  |
  | 567 | 448 | $this->headers = $headers; |
  | 568 |  | ~~//$this->data = $data;~~ |
  | 569 | 449 | $this->data = $data['raw']; |
  | 570 | 450 | $this->cookies = $cookies; |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L574) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L454) |  |
  | 574 | 454 | $this->type = $headers['content-type']; |
  | 575 | 455 | } |
  | 576 |  |  |
  | 577 |  | ~~//$this->cookies = apply\_filters('bridgeHttpRequest\_post', $this->cookies);~~ |
  | 578 | 456 |  |
  | 579 | 457 | $this->debug(0, 'Call process completed in ' . $this->time('delta') . ' microseconds'); |
  | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659243#L776) | […](/browser/whmcs-bridge/trunk/includes/request.class.php?rev=2659751#L654) |  |
  | 776 | 654 | $this->countRedirects++; |
  | 777 | 655 | if ($this->countRedirects < 10) { |
  | 778 |  | ~~//if ($redir != $url) {~~ |
  | 779 | 656 | return $this->connect($redir, $withHeaders, $withCookies); |
  | 780 |  | ~~//}~~ |
  | 781 | 657 | } else { |
  | 782 | 658 | $error\_msg = 'ERROR: Too many redirects ' . $url . ' > ' . $headers['location']; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2659751)
* [Zip Archive](?format=zip&new=2659751)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wpscan.com_52580506_20250115_090300.html ===


[Skip to content](#wp--skip-link--target)

* [Features](https://a8cteam5105.wordpress.com/features/)
* [Pricing](https://a8cteam5105.wordpress.com/pricing/)
* Solutions
  + [Status](https://status.wpscan.com/)
  + [API Details](/api)
  + [CLI Scanner](https://a8cteam5105.wordpress.com/wordpress-cli-scanner/)
* Vulnerabilities
  + [Themes](/themes)
  + [WordPress](/wordpresses)
  + [Plugins](/plugins)
  + [Stats](/statistics)
  + [Submit Vulnerabilities](/submit)
  + [Leaderboard](/leaderboard)
* Resources
  + [Blog](/blog)
  + [Enterprise Features](https://a8cteam5105.wordpress.com/enterprise-customers-features/)
  + [How to Install WPScan](https://a8cteam5105.wordpress.com/how-to-install-wpscan/)
  + [WPScan Glossary](/wpscan-glossary)
  + [2024 Website Threat Report](https://wpscan.com/2023-website-threat-report/)

Search

## WordPress Plugin Vulnerabilities

# WHMCS Bridge < 6.4b - Reflected Cross-Site Scripting (XSS)

### Description

The plugin does not sanitise and escape the error parameter before outputting it back in admin dashboard, leading to a Reflected Cross-Site Scripting

### Proof of Concept

http://example.com/wp-admin/options-general.php?page=cc-ce-bridge-cp&error=%3Cimg%20src%20onerror=alert(1)%3E

### Affects Plugins

[![Plugin icon](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/plugin-icon.svg)

whmcs-bridge](https://a8cteam5105.wordpress.com/plugin/whmcs-bridge/)

![](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/checkmark-green-alt.svg)
Fixed in 6.4b

### References

CVE
[CVE-2021-25112](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-25112)

URL
<https://plugins.trac.wordpress.org/changeset/2659751>

### Classification

Type
XSS

OWASP top 10
[A7: Cross-Site Scripting (XSS)](https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_%28XSS%29)

CWE
[CWE-79](https://cwe.mitre.org/data/definitions/79.html)

CVSS
[6.1 (medium)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

### Miscellaneous

Original Researcher
Krzysztof Zając

Submitter
Krzysztof Zając

Submitter website
<https://kazet.cc/>

Verified
Yes

WPVDB ID
[4aae2dd9-8d51-4633-91bc-ddb53ca3471c](https://a8cteam5105.wordpress.com/vulnerability/4aae2dd9-8d51-4633-91bc-ddb53ca3471c/)

### Timeline

Publicly Published
2022-01-27 (about 2 years ago)

Added
2022-01-27 (about 2 years ago)

Last Updated
2022-04-16 (about 2 years ago)

### Other

Published
Title

Published
2024-09-30
Title
[Loggedin – Limit Active Logins < 1.3.2 - Reflected Cross-Site Scripting](https://a8cteam5105.wordpress.com/vulnerability/5a9eeb56-3022-40ff-8034-df951c5b1fb4/)

Published
2023-02-22
Title
[GoToWP <= 5.1.1 - Contributor+ Stored XSS](https://a8cteam5105.wordpress.com/vulnerability/351f31e0-cd13-4079-8fd1-447f319133c9/)

Published
2024-10-09
Title
[Advanced Blocks Pro <= 1.0.0 - Authenticated (Author+) Stored Cross-Site Scripting via SVG File Upload](https://a8cteam5105.wordpress.com/vulnerability/d7dc1af2-a3fe-431d-bcfa-525f1f9233ba/)

Published
2021-10-20
Title
[BetterLinks < 1.2.6 - Admin+ Stored Cross-Site Scripting](https://a8cteam5105.wordpress.com/vulnerability/6bc8fff1-ff10-4175-8a46-563f0f26f96a/)

Published
2021-03-30
Title
[Cooked Pro < 1.7.5.6 - Unauthenticated Reflected Cross Site Scripting (XSS)](https://a8cteam5105.wordpress.com/vulnerability/ed620de5-1ad2-4480-b08b-719480472bc0/)

![](https://wpscan.com/wp-content/uploads/2023/10/wpscan-logo-dark.png?w=246)

### Vulnerabilities

* [WordPress](/wordpresses)
* [Plugins](/plugins)
* [Themes](/themes)
* [Our Stats](https://a8cteam5105.wordpress.com/statistics/)
* [Submit vulnerabilities](https://a8cteam5105.wordpress.com/submit/)

#### About

* [How it works](/features)
* [Pricing](/pricing)
* [WordPress plugin](https://wordpress.org/plugins/wpscan/)
* [Blog](/blog)
* [Contact](/contact)

#### For Developers

* [Status](https://status.wpscan.com/)
* [API details](/api)
* [CLI scanner](/wordpress-cli-scanner)

#### Other

* [Privacy](https://automattic.com/privacy/)
* [Terms of service](/terms)
* [Submission terms](/submission-terms/)
* [Disclosure policy](/vulnerability-disclosure-policy)
* [Privacy Notice for California Users](https://automattic.com/privacy/#california-consumer-privacy-act-ccpa)

---

![](https://wpscan.com/wp-content/uploads/2023/08/frame-1323.png?w=48)

In partnership with [Jetpack](https://jetpack.com/)

* [GitHub](https://github.com/wpscanteam/wpscan/)
* [Twitter](https://twitter.com/_wpscan_)
* [Facebook](https://www.facebook.com/WPScan)

---

An

![](https://wpscan.com/wp-content/uploads/2023/08/autpmattic-logo.png?w=298)

endeavor

[Work With Us](https://automattic.com/work-with-us/)

[Press](https://automattic.com/press/)

* Subscribe
  Subscribed

  + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)

  Join 30,404 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
* Privacy
* + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://wpscan.com)
  + [View site in Reader](https://wordpress.com/read/feeds/156197069)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

![](https://pixel.wp.com/b.gif?v=noscript)

