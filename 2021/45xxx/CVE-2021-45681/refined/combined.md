=== Content from rustsec.org_c6e7de85_20250114_203805.html ===


RUSTSEC-2021-0083: derive-com-impl: QueryInterface should call AddRef before returning pointer › RustSec Advisory Database

#

[About](/)
[Advisories](/advisories/)
[Report Vulnerabilities](/contributing.html)

[History](https://github.com/RustSec/advisory-db/commits/main/crates/derive-com-impl/RUSTSEC-2021-0083.md) ⋅
[Edit](https://github.com/RustSec/advisory-db/edit/main/crates/derive-com-impl/RUSTSEC-2021-0083.md) ⋅
[JSON (OSV)](https://api.osv.dev/v1/vulns/RUSTSEC-2021-0083)

# RUSTSEC-2021-0083

QueryInterface should call AddRef before returning pointer

Reported
January 20, 2021

Issued
August 21, 2021

(last modified: June 13, 2023)

Package
[derive-com-impl](/packages/derive-com-impl.html)
([crates.io](https://crates.io/crates/derive-com-impl))

Type
Vulnerability

Categories

* [memory-corruption](/categories/memory-corruption.html)

Keywords
[#com](/keywords/com.html)
[#queryinterface](/keywords/queryinterface.html)
[#addref](/keywords/addref.html)

Aliases

* [CVE-2021-45681](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45681)
* [GHSA-9rg7-3j4f-cf4x](https://github.com/advisories/GHSA-9rg7-3j4f-cf4x)
* [GHSA-w4cc-pc2h-whcj](https://github.com/advisories/GHSA-w4cc-pc2h-whcj)

References

* <https://github.com/Connicpu/com-impl/issues/1>

Patched

* `>=0.1.2`

Affected Functions
Version
`derive_com_impl::derive_com_impl`

* `<=0.1.1`

### Description

Affected version of this crate, which is a required dependency in com-impl,
provides a faulty implementation of the `IUnknown::QueryInterface` method.

`QueryInterface` implementation must call `IUnknown::AddRef` before returning the pointer,
as describe in this documentation:
[https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(refiid\_void)](https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface%28refiid_void%29)

As it is not incrementing the refcount as expected, the following calls to `IUnknown::Release` method
will cause WMI to drop reference to the interface, and can lead to invalid reference.

This is documented in <https://docs.microsoft.com/en-us/windows/win32/learnwin32/managing-the-lifetime-of-an-object#reference-counting>

There is no simple workaround, as you can't know how many time QueryInterface will be called.
The only way to quick fix this is to use the macro expanded version of the code and modify
the QueryInterface method to add the AddRef call yourself.

The issue was corrected in commit `9803f31fbd1717d482d848f041044d061fca6da7`.

Advisory available under [CC0-1.0](https://spdx.org/licenses/CC0-1.0.html)
license.



=== Content from raw.githubusercontent.com_72a242d0_20250114_203804.html ===
```toml
[advisory]
id = "RUSTSEC-2021-0083"
package = "derive-com-impl"
date = "2021-01-20"
url = "https://github.com/Connicpu/com-impl/issues/1"
categories = ["memory-corruption"]
keywords = ["com", "queryinterface", "addref"]
aliases = ["CVE-2021-45681", "GHSA-9rg7-3j4f-cf4x", "GHSA-w4cc-pc2h-whcj"]
[affected]
functions = { "derive\_com\_impl::derive\_com\_impl" = ["<= 0.1.1"] }
[versions]
patched = [">= 0.1.2"]
```
# QueryInterface should call AddRef before returning pointer
Affected version of this crate, which is a required dependency in com-impl,
provides a faulty implementation of the `IUnknown::QueryInterface` method.
`QueryInterface` implementation must call `IUnknown::AddRef` before returning the pointer,
as describe in this documentation:
As it is not incrementing the refcount as expected, the following calls to `IUnknown::Release` method
will cause WMI to drop reference to the interface, and can lead to invalid reference.
This is documented in
There is no simple workaround, as you can't know how many time QueryInterface will be called.
The only way to quick fix this is to use the macro expanded version of the code and modify
the QueryInterface method to add the AddRef call yourself.
The issue was corrected in commit `9803f31fbd1717d482d848f041044d061fca6da7`.

