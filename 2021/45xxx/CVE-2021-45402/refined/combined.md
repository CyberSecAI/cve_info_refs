=== Content from git.kernel.org_349617a7_20250114_223957.html ===


| [cgit logo](/) | [index](/) : [kernel/git/netdev/net.git](/pub/scm/linux/kernel/git/netdev/net.git/) | main |
| --- | --- | --- |
| Netdev Group's networking tree | Netdev Group |

| [about](/pub/scm/linux/kernel/git/netdev/net.git/about/)[summary](/pub/scm/linux/kernel/git/netdev/net.git/)[refs](/pub/scm/linux/kernel/git/netdev/net.git/refs/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)[log](/pub/scm/linux/kernel/git/netdev/net.git/log/)[tree](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)[commit](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)[diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)[stats](/pub/scm/linux/kernel/git/netdev/net.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2021-12-15 22:02:19 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2021-12-16 19:45:46 +0100 |
| commit | [3cf2b61eb06765e27fec6799292d9fb46d0b7e60](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60) ([patch](/pub/scm/linux/kernel/git/netdev/net.git/patch/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)) | |
| tree | [fd019252d9e2955dcb97d570b2225cc2b651ca28](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60) | |
| parent | [e523102cb719cbad1673b6aa2a4d5c1fa6f13799](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=e523102cb719cbad1673b6aa2a4d5c1fa6f13799) ([diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60&id2=e523102cb719cbad1673b6aa2a4d5c1fa6f13799)) | |
| download | [net-3cf2b61eb06765e27fec6799292d9fb46d0b7e60.tar.gz](/pub/scm/linux/kernel/git/netdev/net.git/snapshot/net-3cf2b61eb06765e27fec6799292d9fb46d0b7e60.tar.gz) | |

bpf: Fix signed bounds propagation after mov32For the case where both s32\_{min,max}\_value bounds are positive, the
\_\_reg\_assign\_32\_into\_64() directly propagates them to their 64 bit
counterparts, otherwise it pessimises them into [0,u32\_max] universe and
tries to refine them later on by learning through the tnum as per comment
in mentioned function. However, that does not always happen, for example,
in mov32 operation we call zext\_32\_to\_64(dst\_reg) which invokes the
\_\_reg\_assign\_32\_into\_64() as is without subsequent bounds update as
elsewhere thus no refinement based on tnum takes place.
Thus, not calling into the \_\_update\_reg\_bounds() / \_\_reg\_deduce\_bounds() /
\_\_reg\_bound\_offset() triplet as we do, for example, in case of ALU ops via
adjust\_scalar\_min\_max\_vals(), will lead to more pessimistic bounds when
dumping the full register state:
Before fix:
0: (b4) w0 = -1
1: R0\_w=invP4294967295
(id=0,imm=ffffffff,
smin\_value=4294967295,smax\_value=4294967295,
umin\_value=4294967295,umax\_value=4294967295,
var\_off=(0xffffffff; 0x0),
s32\_min\_value=-1,s32\_max\_value=-1,
u32\_min\_value=-1,u32\_max\_value=-1)
1: (bc) w0 = w0
2: R0\_w=invP4294967295
(id=0,imm=ffffffff,
smin\_value=0,smax\_value=4294967295,
umin\_value=4294967295,umax\_value=4294967295,
var\_off=(0xffffffff; 0x0),
s32\_min\_value=-1,s32\_max\_value=-1,
u32\_min\_value=-1,u32\_max\_value=-1)
Technically, the smin\_value=0 and smax\_value=4294967295 bounds are not
incorrect, but given the register is still a constant, they break assumptions
about const scalars that smin\_value == smax\_value and umin\_value == umax\_value.
After fix:
0: (b4) w0 = -1
1: R0\_w=invP4294967295
(id=0,imm=ffffffff,
smin\_value=4294967295,smax\_value=4294967295,
umin\_value=4294967295,umax\_value=4294967295,
var\_off=(0xffffffff; 0x0),
s32\_min\_value=-1,s32\_max\_value=-1,
u32\_min\_value=-1,u32\_max\_value=-1)
1: (bc) w0 = w0
2: R0\_w=invP4294967295
(id=0,imm=ffffffff,
smin\_value=4294967295,smax\_value=4294967295,
umin\_value=4294967295,umax\_value=4294967295,
var\_off=(0xffffffff; 0x0),
s32\_min\_value=-1,s32\_max\_value=-1,
u32\_min\_value=-1,u32\_max\_value=-1)
Without the smin\_value == smax\_value and umin\_value == umax\_value invariant
being intact for const scalars, it is possible to leak out kernel pointers
from unprivileged user space if the latter is enabled. For example, when such
registers are involved in pointer arithmtics, then adjust\_ptr\_min\_max\_vals()
will taint the destination register into an unknown scalar, and the latter
can be exported and stored e.g. into a BPF map value.
Fixes: 3f50f132d840 ("bpf: Verifier, do explicit ALU32 bounds tracking")
Reported-by: Kuee K1r0a <liulin063@gmail.com>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Acked-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/netdev/net.git/diff/kernel/bpf/verifier.c?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 2d48159b58bd37..0872b6c9fb33fc 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/kernel/bpf/verifier.c?id=e523102cb719cbad1673b6aa2a4d5c1fa6f13799)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/kernel/bpf/verifier.c?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)@@ -8317,6 +8317,10 @@ static int check\_alu\_op(struct bpf\_verifier\_env \*env, struct bpf\_insn \*insn) insn->dst\_reg); } zext\_32\_to\_64(dst\_reg);++ \_\_update\_reg\_bounds(dst\_reg);+ \_\_reg\_deduce\_bounds(dst\_reg);+ \_\_reg\_bound\_offset(dst\_reg); } } else { /\* case: R = imm |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:38:35 +0000



=== Content from git.kernel.org_4228e7d2_20250114_223958.html ===


| [cgit logo](/) | [index](/) : [kernel/git/netdev/net.git](/pub/scm/linux/kernel/git/netdev/net.git/) | main |
| --- | --- | --- |
| Netdev Group's networking tree | Netdev Group |

| [about](/pub/scm/linux/kernel/git/netdev/net.git/about/)[summary](/pub/scm/linux/kernel/git/netdev/net.git/)[refs](/pub/scm/linux/kernel/git/netdev/net.git/refs/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)[log](/pub/scm/linux/kernel/git/netdev/net.git/log/)[tree](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)[commit](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)[diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)[stats](/pub/scm/linux/kernel/git/netdev/net.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2021-12-15 22:28:48 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2021-12-16 19:45:56 +0100 |
| commit | [e572ff80f05c33cd0cb4860f864f5c9c044280b6](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6) ([patch](/pub/scm/linux/kernel/git/netdev/net.git/patch/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)) | |
| tree | [91fe11a7a0931e8b7c9d552ec61f351900cacd35](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6) | |
| parent | [3cf2b61eb06765e27fec6799292d9fb46d0b7e60](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60) ([diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6&id2=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)) | |
| download | [net-e572ff80f05c33cd0cb4860f864f5c9c044280b6.tar.gz](/pub/scm/linux/kernel/git/netdev/net.git/snapshot/net-e572ff80f05c33cd0cb4860f864f5c9c044280b6.tar.gz) | |

bpf: Make 32->64 bounds propagation slightly more robustMake the bounds propagation in \_\_reg\_assign\_32\_into\_64() slightly more
robust and readable by aligning it similarly as we did back in the
\_\_reg\_combine\_64\_into\_32() counterpart. Meaning, only propagate or
pessimize them as a smin/smax pair.
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Acked-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/netdev/net.git/diff/kernel/bpf/verifier.c?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 9 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 0872b6c9fb33fc..b532f1058d35f3 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/kernel/bpf/verifier.c?id=3cf2b61eb06765e27fec6799292d9fb46d0b7e60)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/kernel/bpf/verifier.c?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)@@ -1366,22 +1366,28 @@ static void \_\_reg\_bound\_offset(struct bpf\_reg\_state \*reg) reg->var\_off = tnum\_or(tnum\_clear\_subreg(var64\_off), var32\_off); } +static bool \_\_reg32\_bound\_s64(s32 a)+{+ return a >= 0 && a <= S32\_MAX;+}+ static void \_\_reg\_assign\_32\_into\_64(struct bpf\_reg\_state \*reg) { reg->umin\_value = reg->u32\_min\_value; reg->umax\_value = reg->u32\_max\_value;- /\* Attempt to pull 32-bit signed bounds into 64-bit bounds- \* but must be positive otherwise set to worse case bounds- \* and refine later from tnum.++ /\* Attempt to pull 32-bit signed bounds into 64-bit bounds but must+ \* be positive otherwise set to worse case bounds and refine later+ \* from tnum. \*/- if (reg->s32\_min\_value >= 0 && reg->s32\_max\_value >= 0)- reg->smax\_value = reg->s32\_max\_value;- else- reg->smax\_value = U32\_MAX;- if (reg->s32\_min\_value >= 0)+ if (\_\_reg32\_bound\_s64(reg->s32\_min\_value) &&+ \_\_reg32\_bound\_s64(reg->s32\_max\_value)) { reg->smin\_value = reg->s32\_min\_value;- else+ reg->smax\_value = reg->s32\_max\_value;+ } else { reg->smin\_value = 0;+ reg->smax\_value = U32\_MAX;+ } }  static void \_\_reg\_combine\_32\_into\_64(struct bpf\_reg\_state \*reg) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:38:35 +0000



=== Content from git.kernel.org_95a0ff68_20250114_223958.html ===


| [cgit logo](/) | [index](/) : [kernel/git/netdev/net.git](/pub/scm/linux/kernel/git/netdev/net.git/) | main |
| --- | --- | --- |
| Netdev Group's networking tree | Netdev Group |

| [about](/pub/scm/linux/kernel/git/netdev/net.git/about/)[summary](/pub/scm/linux/kernel/git/netdev/net.git/)[refs](/pub/scm/linux/kernel/git/netdev/net.git/refs/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)[log](/pub/scm/linux/kernel/git/netdev/net.git/log/)[tree](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)[commit](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)[diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)[stats](/pub/scm/linux/kernel/git/netdev/net.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2021-12-15 23:48:54 +0000 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2021-12-16 19:46:06 +0100 |
| commit | [b1a7288dedc6caf9023f2676b4f5ed34cf0d4029](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029) ([patch](/pub/scm/linux/kernel/git/netdev/net.git/patch/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)) | |
| tree | [f8813e16d20cfbef5eaa561986390472f11f0d3d](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029) | |
| parent | [e572ff80f05c33cd0cb4860f864f5c9c044280b6](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6) ([diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029&id2=e572ff80f05c33cd0cb4860f864f5c9c044280b6)) | |
| download | [net-b1a7288dedc6caf9023f2676b4f5ed34cf0d4029.tar.gz](/pub/scm/linux/kernel/git/netdev/net.git/snapshot/net-b1a7288dedc6caf9023f2676b4f5ed34cf0d4029.tar.gz) | |

bpf, selftests: Add test case trying to taint map value pointerAdd a test case which tries to taint map value pointer arithmetic into a
unknown scalar with subsequent export through the map.
Before fix:
# ./test\_verifier 1186
#1186/u map access: trying to leak tained dst reg FAIL
Unexpected success to load!
verification time 24 usec
stack depth 8
processed 15 insns (limit 1000000) max\_states\_per\_insn 0 total\_states 1 peak\_states 1 mark\_read 1
#1186/p map access: trying to leak tained dst reg FAIL
Unexpected success to load!
verification time 8 usec
stack depth 8
processed 15 insns (limit 1000000) max\_states\_per\_insn 0 total\_states 1 peak\_states 1 mark\_read 1
Summary: 0 PASSED, 0 SKIPPED, 2 FAILED
After fix:
# ./test\_verifier 1186
#1186/u map access: trying to leak tained dst reg OK
#1186/p map access: trying to leak tained dst reg OK
Summary: 2 PASSED, 0 SKIPPED, 0 FAILED
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Reviewed-by: John Fastabend <john.fastabend@gmail.com>
Acked-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)

| -rw-r--r-- | [tools/testing/selftests/bpf/verifier/value\_ptr\_arith.c](/pub/scm/linux/kernel/git/netdev/net.git/diff/tools/testing/selftests/bpf/verifier/value_ptr_arith.c?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 0 deletions

| diff --git a/tools/testing/selftests/bpf/verifier/value\_ptr\_arith.c b/tools/testing/selftests/bpf/verifier/value\_ptr\_arith.cindex 2debba4e8a3a8e..4d347bc53aa28e 100644--- a/[tools/testing/selftests/bpf/verifier/value\_ptr\_arith.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/tools/testing/selftests/bpf/verifier/value_ptr_arith.c?id=e572ff80f05c33cd0cb4860f864f5c9c044280b6)+++ b/[tools/testing/selftests/bpf/verifier/value\_ptr\_arith.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/tools/testing/selftests/bpf/verifier/value_ptr_arith.c?id=b1a7288dedc6caf9023f2676b4f5ed34cf0d4029)@@ -1078,6 +1078,29 @@ .errstr\_unpriv = "R0 pointer -= pointer prohibited", }, {+ "map access: trying to leak tained dst reg",+ .insns = {+ BPF\_MOV64\_IMM(BPF\_REG\_0, 0),+ BPF\_ST\_MEM(BPF\_DW, BPF\_REG\_10, -8, 0),+ BPF\_MOV64\_REG(BPF\_REG\_2, BPF\_REG\_10),+ BPF\_ALU64\_IMM(BPF\_ADD, BPF\_REG\_2, -8),+ BPF\_LD\_MAP\_FD(BPF\_REG\_1, 0),+ BPF\_RAW\_INSN(BPF\_JMP | BPF\_CALL, 0, 0, 0, BPF\_FUNC\_map\_lookup\_elem),+ BPF\_JMP\_IMM(BPF\_JNE, BPF\_REG\_0, 0, 1),+ BPF\_EXIT\_INSN(),+ BPF\_MOV64\_REG(BPF\_REG\_2, BPF\_REG\_0),+ BPF\_MOV32\_IMM(BPF\_REG\_1, 0xFFFFFFFF),+ BPF\_MOV32\_REG(BPF\_REG\_1, BPF\_REG\_1),+ BPF\_ALU64\_REG(BPF\_SUB, BPF\_REG\_2, BPF\_REG\_1),+ BPF\_STX\_MEM(BPF\_DW, BPF\_REG\_0, BPF\_REG\_2, 0),+ BPF\_MOV64\_IMM(BPF\_REG\_0, 0),+ BPF\_EXIT\_INSN(),+ },+ .fixup\_map\_array\_48b = { 4 },+ .result = REJECT,+ .errstr = "math between map\_value pointer and 4294967295 is not allowed",+},+{ "32bit pkt\_ptr -= scalar", .insns = { BPF\_LDX\_MEM(BPF\_W, BPF\_REG\_8, BPF\_REG\_1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:38:35 +0000


