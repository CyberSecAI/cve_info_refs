The provided content describes multiple vulnerabilities in Terramaster NAS devices, leading to remote code execution (RCE). Although the post is tagged with `cve-2021-45842`, it appears to describe a chain of multiple vulnerabilities, and the blog post itself seems to be more of a write-up for multiple CVEs (cve-2021-45842, cve-2021-45841, cve-2021-45840, cve-2021-45839, cve-2021-45837, cve-2021-45836).

Here's a breakdown of the vulnerabilities discussed:

**1. Encrypted PHP Files and Custom PHP Extension**

*   **Root Cause:** Terramaster uses a custom PHP extension (`php_terra_master.so`) to decrypt PHP files before execution. This extension uses a hardcoded key (`GH65Hws2jedf3fl3MeK`) for decryption, which is used in the `pm9screw_compile_file` function, a function originally part of php-screw.
*   **Vulnerability:** The use of a hardcoded key makes the encryption easily reversible. This allows attackers to decrypt the entire web interface.
*   **Impact:** Decrypting the PHP code exposes the application's logic and reveals further vulnerabilities.

**2. Remote Code Execution (RCE) via `shell_exec` and `system` calls**

*   **Root Cause:** Multiple PHP scripts use `shell_exec()` or `system()` with user-controlled input without proper sanitization. The code concatenates user provided input directly into shell commands.
*   **Vulnerability:** This allows for command injection.
*   **Impact:** Attackers can execute arbitrary commands on the system as root.
*   **Attack vectors:**
    *   `http://nas:8181/tos/index.php?app/app_start_stop&id=transmission&start=0&name=Transmission.*.oexe;ls%3E/tmp/xxx.txt;ls` (requires admin)
    *   `http://nas:8181/tos/index.php?app/del&id=0&name=;ls%3E/tmp/xyz.txt;ls%23`
    *   `http://nas:8181/tos/index.php?app/hand_app&name=;ls%3E/tmp/kjl.txt;ls.tpk`
*   **Required attacker capabilities/position:** For the first RCE, admin access is required. The other two RCEs can be triggered by any user.

**3. Authentication Bypass via Session Crafting**

*   **Root Cause:** The authentication logic relies on cookies named `kod_name` and `kod_token`. The `kod_token` is generated by the `tos_encrypt_str` function, which uses the last part of the device's MAC address and the user's password.
*   **Vulnerability:** The `tos_encrypt_str` function uses a weak hash (MD5), and the MAC address can be obtained without authentication. The guest user has a default empty password.
*   **Impact:** Attackers can craft valid session cookies for any user, including the admin account, bypassing the authentication.
*   **Attack vectors:** By setting the `kod_name` cookie to an existing user, and crafting a `kod_token` with `tos_encrypt_str()`
*   **Required attacker capabilities/position:** Any user can perform this.

**4. Information Disclosure of MAC address and admin password hash**

*   **Root Cause:** API endpoints `/module/api.php?mobile/wapNasIPS` and `/module/api.php?mobile/webNasIPS` disclose the device's MAC address and the administrator's password hash.
*  **Vulnerability:** Lack of authentication/authorization controls on API endpoints, weak password hashing algorithm.
*   **Impact:** Attackers can obtain sensitive information to craft authentication tokens and escalate privileges.
*   **Attack vectors:** Sending a request to `/module/api.php?mobile/wapNasIPS` or `/module/api.php?mobile/webNasIPS` with headers `User-Device:TNAS` and `User-Agent:TNAS`
*   **Required attacker capabilities/position:** Any user can perform this.

**5. Arbitrary File Download**

*   **Root Cause:** The API `/module/api.php?mobile/fileDownload` allows downloading arbitrary files from the server.
*   **Vulnerability:** Lack of proper authentication and path sanitization.
*   **Impact:** Attackers can download sensitive files from the server, such as `/etc/group` or `/etc/passwd`. This can be used to obtain usernames and password hashes.
*   **Attack vectors:** Sending a POST request to the API, setting the required `signature` and `timestamp` headers.
*   **Required attacker capabilities/position:** Any user can perform this.

**Chaining these vulnerabilities, the attacker can achieve remote root access:**

1.  Use the info disclosure to get the MAC address and admin hash.
2.  Use the arbitrary file download to get `/etc/group` and identify admin usernames.
3.  Craft a valid session for an admin user using `tos_encrypt_str` with the extracted MAC address, or use the default empty password for guest user.
4.  Use the RCE vulnerability to execute arbitrary commands as root.

This content provides significant detail about the vulnerabilities, including the root cause, the technical details of exploitation, and a full proof-of-concept exploit code.