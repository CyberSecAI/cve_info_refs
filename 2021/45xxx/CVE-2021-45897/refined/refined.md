```
{
  "cveId": "CVE-2021-45897",
  "related": true,
  "content": "The provided content details a Remote Code Execution (RCE) vulnerability in SuiteCRM, specifically in versions 8.0.1 and earlier, as well as versions 7.12.2 and earlier. This vulnerability is addressed in SuiteCRM versions 7.12.3 and 8.0.2. The root cause lies within the `EmailTemplates` module, where an authenticated user can exploit a flaw in the `repairEntryPointImages` function by injecting a malicious PHP file via a crafted image tag's `src` attribute. This allows a remote user to upload a file with a `.php` extension into a publicly accessible directory, leading to arbitrary code execution on the web server.\n\nHere's a breakdown of the extracted information:\n\n*   **Root Cause of Vulnerability:** The `repairEntryPointImages` function in `EmailTemplate.php` uses a regular expression to locate `img` tags with a specific format in the email template body. It copies the attachment from the upload directory to the `public` folder and uses the `filename` query parameter as file extension. However, it does not validate the `filename` parameter in a way that would prevent a non-image extension (e.g. php) and therefore allows uploading of arbitrary file types with the provided name and extension.\n\n*   **Weaknesses/Vulnerabilities Present:**\n    *   **Unvalidated file extension:** The `filename` query parameter in the image source (`src`) is not validated, allowing for arbitrary file extensions to be used, like `.php`.\n    *   **Insecure file upload:** Arbitrary files can be uploaded as attachments and later served publicly due to the flawed `repairEntryPointImages` function.\n\n*   **Impact of Exploitation:**\n    *   Remote Code Execution (RCE) on the web server where SuiteCRM is hosted. An attacker can execute arbitrary PHP code by accessing the uploaded PHP file.\n\n*   **Attack Vectors:**\n    *   An authenticated user with access to the `EmailTemplates` module crafts a malicious email template by:\n        1.  Uploading a PHP file as an email template attachment, which is then stored in the Notes module.\n        2.  Creating an email template that contains an HTML img tag with an internal download link for that attachment with a php extension in the filename parameter\n        3.  Upon accessing or saving of this template, `repairEntryPointImages` is triggered, causing the uploaded file to be copied to the public directory with the attacker controlled filename.\n\n*   **Required Attacker Capabilities/Position:**\n    *   The attacker needs to be an authenticated user with access to the `EmailTemplates` module.\n    *   The attacker must know the URL or directory where to place/access their webshell.\n\nAdditionally, the content also includes:\n*   A link to the [CVE description](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45897).\n*   Details about a Proof of Concept (PoC) exploit.\n*   Information on how the vendor patched this vulnerability.\n*   Mention of the SuiteCRM versions affected and fixed.\n*   Details of a fix that was implemented in SuiteCRM versions 7.12.3 and 8.0.2, which validate file extensions to avoid uploading malicious file types.",
  "vulnerabilityDetails": {
    "rootCause": "The `repairEntryPointImages` function in `EmailTemplate.php` does not validate the `filename` parameter of an image tag's `src` attribute, leading to arbitrary file extension usage during attachment copying.",
    "vulnerability": "Unvalidated file extension usage and insecure file upload. An authenticated user with access to the `EmailTemplates` module can inject a php file via the `filename` parameter.",
    "impact": "Remote Code Execution (RCE). The attacker can execute arbitrary PHP code on the webserver.",
    "attackVector": "An authenticated user creates a crafted email template containing an `img` tag with a specific `src` attribute. SuiteCRM parses this and uses the `filename` query param to save an uploaded attachment in the `/public/` directory.",
    "attackerCapabilities": "Requires an authenticated user with access to the `EmailTemplates` module to create a malicious email template."
  }
}
```