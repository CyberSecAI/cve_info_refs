=== Content from bishopfox.com_0144e99f_20250115_095849.html ===


Cosmos

[Services](https://bishopfox.com/services)

[Resources](https://bishopfox.com/resource-center)

[Customers](https://bishopfox.com/customers)

[Partners](https://bishopfox.com/partners)

[About Us](https://bishopfox.com/company)

[Get Started](https://bishopfox.com/get-started)

![](https://assets.bishopfox.com/prod-1437/Images/gigaom-badge-2024-ASM-leader.png)

Introducing Cosmos

### Named Leader of the GigaOm Radar for the third year in a row!

[Request A Demo](https://bishopfox.com/request-demo)

[Cosmos Overview](/cosmos)

Meet Cosmos: The continuous offensive security solution designed to provide proactive defense.

[Cosmos Attack Surface Management](/cosmos-attack-surface-management-casm)

Get Cosmos Attack Surface Management (CASM) for unmatched visibility into your changing external attack surface with continuous discovery and mapping.

[Cosmos Application Penetration Testing](/cosmos-application-penetration-testing-capt)

Cosmos Application Penetration Testing (CAPT) strengthens the security of business-critical applications with in-depth assessments.

[Cosmos External Penetration Testing](/cosmos-external-penetration-testing-cept)

Cosmos External Penetration Testing (CEPT) builds on Cosmos Attack Surface Management to provide the highest level of attack surface protection with post-exploitation activities.

![](https://assets.bishopfox.com/prod-1437/Images/global/main-menu/poly-fox-graphic.png)

The Best Defense is a Great Offense

### See Why We're the Leaders in Offensive Security

[Explore Services](https://bishopfox.com/services)

[Application Security](/services/application-security)

Ensure your applications are secure and improve your DevSecOps practices.

* [Application Pen Testing](/services/application-penetration-testing)
* [Hybrid App Assessment](/services/hybrid-application-assessment)
* [Mobile App Assessment](/services/mobile-application-assessment)
* [View More](/services/application-security)

[Red Team & Readiness](/services/red-teaming)

Get a holistic view of your ability to defend against a real-world attack.

* [Social Engineering](/services/social-engineering)
* [Incident Response Tabletop Exercise](/services/tabletop-exercise)
* [Ransomware Readiness](/services/ransomware-readiness)

[IoT & Product Security](/services/product-security-review)

Validate interconnected devices and products are secure against attackers.

[Cloud Security](/services/cloud-penetration-testing)

Assess cloud security posture with expert testing and analysis of your environment.

[Network Security](/services/network-security)

Get insight into how skilled adversaries could establish network access and put sensitive systems and data at risk.

* [External Pen Testing](/services/external-penetration-testing)
* [Internal Pen Testing](/services/internal-penetration-testing)

[AI/ML Security Assessment](/services/ai-ml-security-assessment)

Fortify the security of rapidly evolving AI/ML applications, models, and supporting infrastructures.

[Compliance & Regulations](/services/compliance-and-frameworks)

Satisfy governance, risk, and compliance programs with our testing services.

[Assessments for Our Partners](/services/vendor-assessments)

We're proud to work with Google, Facebook, and Amazon to increase security in their partner ecosystems.

* [Cloud App Security Assessments (CASA)](/services/casa)
* [Meta Workplace Assessments](/services/facebook-partner-assessment)
* [Amazon Alexa Assessments](/services/amazon-alexa-built-in-device-assessment)
* [Oracle Security Assessments](/services/oracle-security-assessment)
* [View More](/services/vendor-assessments)

![](https://assets.bishopfox.com/prod-1437/Images/pages/campaign-lander-images/2023-Ponemon-Report/Ponemon-Report-Tablet_Plus-Pages-copy.png)

A Ponemon Institute Report

### The State of Offensive Security

Get the blueprint. Insights into how mature security organizations invest in offensive strategies.

[Get the Report](https://bishopfox.com/ponemon-2023-report)

[Resource Center](/resource-center)

Discover new offensive security resources, ranging from reports and eBooks to slide decks from speaking gigs.

* [Webcasts](/resources/webcasts)
* [Reports](/resources/reports)
* [eBooks & Guides](/resources/guides)
* [Cybersecurity Style Guide](/cybersecurity-style-guide)
* [View All](/resources)

[Bulletins & Advisories](/blog/advisories)

Explore the latest security bulletins and advisories released by our team.

* [Exploit for Fortinet CVE-2022-42475](/blog/exploit-cve-2022-42475)
  Latest
* [View All](/blog/advisories)

[Blog](/blog)

Dive into our blog for insights and perspectives from our offensive security experts.

* [Industry](/blog/industry)
* [Technology](/blog/technology)
* [Product](/blog/product)

[Bishop Fox Labs](/labs)

Learn more about our research and some of the most popular open-source security tools. Check them out here!

* [Hacking Tools](/tools)
* [Training Sessions](/resources/livestream)

![](https://assets.bishopfox.com/prod-1437/Images/global/main-menu/Tag-Cyber-Independent-Assessment-Feature-Transparent.png)

Why Partner with Us?

### Join Forces with the Leaders in Offensive Security

Independent Assessment by TAG Cyber

[Get the Report](https://bishopfox.com/resources/tag-cybers-report-cast-platform)

[Partner Program Overview](/partners)

Learn about our partner programs and see how we can work together to provide best-in-class security offerings.

[Find a Partner](/partner-directory)

Check out our awesome ecosystem of trusted partners to find the right solution for your needs.

[Become a Partner](/partners/become-a-partner)

Explore partnership opportunities and apply to join forces with Bishop Fox.

[Assessments for Our Partners](/services/vendor-assessments)

We're proud to work with Google, Facebook, and Amazon to increase the security of their partner ecosystems.

* [Cloud Application Security Assessments](/services/casa)
* [Mobile Application Security Assessment](/services/masa)
* [Nest Assessments](/services/nest-partner-security-assessment)
* [Meta Workplace Assessments](/services/facebook-partner-assessment)
* [Amazon Alexa Assessments](/services/amazon-alexa-built-in-device-assessment)

![](https://assets.bishopfox.com/prod-1437/Images/global/main-menu/hero-fox.png)

We're Hiring!

### Want to Work with the Best Minds in Offensive Security?

Be part of an elite team and work on projects that have a real impact.

[Explore Openings](https://bishopfox.com/careers)

[Company Overview](/company)

Get to know us. Learn about our roots and see why we're on a mission to improve security for all.

[Events](/events)

Join us at an upcoming event or peruse our speaking engagements, past and present.

[Newsroom](/news)

Read the latest articles, announcements, and press releases from Bishop Fox.

[Contact Us](/contact)

Want to get in touch? We're ready to connect.

[Career Opportunities](/careers)

We're hiring! Explore our open positions and discover why the Fox Den is a great place to build your career.

[Intern & Educational Programs](/company/internships)

Starting your offensive security journey? Check out our internships and educational programs.

[Bishop Fox Mexico](/mexico)

¡Celebramos! Bishop Fox is now in Mexico. Learn more about our expansion.

![bishopfox-mexico-logo](/static/assets/images/main-menu/bishopfox-mexico-logo.png)

Search

Cosmos

* Overview
* [Cosmos Overview](/cosmos)
* [Cosmos Attack Surface Management](/cosmos-attack-surface-management-casm)
* [Cosmos Application Penetration Testing](/cosmos-application-penetration-testing-capt)
* [Cosmos External Penetration Testing](/cosmos-external-penetration-testing-cept)

[Services](https://bishopfox.com/services)

* [Overview](https://bishopfox.com/services)
* [Application Security](/services/application-security)
* [Red Team & Readiness](/services/red-teaming)
* [IoT & Product Security](/services/product-security-review)
* [Cloud Security](/services/cloud-penetration-testing)
* [Network Security](/services/network-security)
* [AI/ML Security Assessment](/services/ai-ml-security-assessment)
* [Compliance & Regulations](/services/compliance-and-frameworks)
* [Assessments for Our Partners](/services/vendor-assessments)

[Resources](https://bishopfox.com/resource-center)

* [Overview](https://bishopfox.com/resource-center)
* [Resource Center](/resource-center)
* [Bulletins & Advisories](/blog/advisories)
* [Blog](/blog)
* [Bishop Fox Labs](/labs)

[Customers](https://bishopfox.com/customers)

[Partners](https://bishopfox.com/partners)

* [Overview](https://bishopfox.com/partners)
* [Partner Program Overview](/partners)
* [Find a Partner](/partner-directory)
* [Become a Partner](/partners/become-a-partner)
* [Assessments for Our Partners](/services/vendor-assessments)

[About Us](https://bishopfox.com/company)

* [Overview](https://bishopfox.com/company)
* [Company Overview](/company)
* [Events](/events)
* [Newsroom](/news)
* [Contact Us](/contact)
* [Career Opportunities](/careers)
* [Intern & Educational Programs](/company/internships)
* [Bishop Fox Mexico](/mexico)

[Get Started](https://bishopfox.com/get-started)

Search

[Blog](https://bishopfox.com/blog)
// [Tech](https://bishopfox.com/blog/technology)
// [Jan 11, 2022](https://bishopfox.com/blog/imperva-eliminates-critical-exposure)

# Zero-Day Collaboration: Working With Imperva to Eliminate a Critical Exposure

By:
[Carl Livitt, Bishop Fox Alumnus](https://bishopfox.com/authors/carl-livitt)

![String of blue purple lights](https://assets.bishopfox.com/prod-1437/Images/channels/blog/tiles/BishopFox-Imperva-Collaboratio-zero-day-vulnerability.jpg)

Share

During a recent investigation, the Bishop Fox Cosmos Adversarial Operations experts identified a WAF rule bypass in the [Imperva Cloud Web Application Firewall](https://www.imperva.com/products/web-application-firewall-waf/). Through our coordinated [Responsible Disclosure Process](https://bishopfox.com/vulnerability-disclosure-policy), Bishop Fox notified Imperva, kicking off a great collaboration between teams to share information about the exploit. This cooperative effort enabled Imperva’s team to quickly develop a patch and deploy it in record time to the Imperva Global Network.

We believe that this type of collaborative work between organizations is a model for how Responsible Disclosure can and should work. It also illustrates how offensive and defensive security organizations can combine forces to ensure the best outcomes for organizations and continually improve security.

---

## Bishop Fox’s Approach to Responsible Disclosure

At Bishop Fox, we are focused on improving security for everyone. When we find vulnerabilities, our goal is to work with organizations to close potential attack windows as quickly and efficiently as possible. We don’t believe in leveraging vulnerabilities for our own benefit or stockpiling exposures to further our own siloed testing abilities or line our pockets.

**We believe in:**

* Working with organizations to help accelerate their response and remediation efforts
* Providing detailed information that enables organizations to protect themselves against potential exposures and understand impact

In this instance, the Imperva team was immediately responsive to our findings and quickly resolved the issue – which is always our desired outcome.

## Remediating a Zero-Day Vulnerability

In the course of testing a client environment, the Bishop Fox team discovered the Imperva Cloud WAF was vulnerable to a bypass that allowed attackers to evade WAF rules when sending malicious HTTP POST payloads, such as Log4j exploits, SQL injection, command execution, directory traversal, and XXE. This was of particular concern given the recent prevalence of the [Log4j vulnerability](https://bishopfox.com/blog/identify-and-exploit-log4shell).

Imperva activated their team as soon as Bishop Fox reported the vulnerability to them, and they turned around a global fix in just a few days. All customers of Cloud WAF were automatically patched as of December 23, 2021.

## Tune into Our Webcast as We Unpack the Process

We’ve teed up a webcast to talk about the collaboration between Imperva and Bishop Fox and unpack what we consider an ideal example of the Responsible Disclosure process. We invite you to go behind the scenes with executives from both companies as they discuss this recent real-world example and explore how offensive and defensive security organizations can and should be combining forces.

[Register for our webcast on February 2, 2022 at 2 p.m. ET / 11 a.m. PT](https://bishopfox.com/resources/imperva-eliminate-critical-exposure-webcast) for insights into:

* How responsible disclosure and CVE processes work
* How Imperva and Bishop Fox mobilized teams to accelerate information sharing and remediation efforts
* How offensive security strengthens defensive security products and why Imperva’s CTO prioritizes it
* How Log4j has and will change the security landscape in the coming weeks and months

## Exploring the Vulnerability

### Post Request Bypass

The Imperva WAF was affected by a post request vulnerability. This security vulnerability could lead to attackers evading WAF rules when sending malicious HTTP POST payloads, such as log4j exploits, SQL injection, command execution, directory traversal, XXE, etc.

### Vulnerability Details

* CVE ID: [CVE-2021-45468](https://nvd.nist.gov/vuln/detail/CVE-2021-45468)
* Vulnerability Type: Post Request Bypass
* Security Risk: Critical

### Replicating the Vulnerability

Add the header Content-Encoding: gzip to HTTP POST requests. Leave POST data as-is. Don't encode it. So long as the first four bytes of the Content-Encoding header are gzip, no WAF rules will be applied to POST requests. You can do this in Burp by using the proxy's Match & Replace feature:

![Using Burp Suite Professional proxy's match and replace feature example](https://assets.bishopfox.com/prod-1437/Images/channels/blog/Content/Imperva-post-request-bypass-vulnerability.png)

Add a new header like this:

![Example of adding a new header using Burp Suite Match and Replace rule](https://assets.bishopfox.com/prod-1437/Images/channels/blog/Content/Burp-Suite-Add-match-and-replace-rule-example-of-new-header.png)

That's it; you're good to go.

## Running the Test Script

Run `imperva_gzip.py` against a URL that supports POST requests like this:
Syntax: `./imperva_gzip.py [[-t] | [-r]] URL`

Guess the WAF type for a given URL:

```
$ ./imperva_gzip.py -t https://www.vulnerable.com/search
Imperva Incapsula
$ ./imperva_gzip.py -t https://www.wordpress-user.com/login
WordFence
$ ./imperva_gzip.py -t https://www.cloudflare-customer.com
Cloudflare
```

Check to see if the WAF is vulnerable to the gzip bypass:

```
$ ./imperva_gzip.py https://www.vulnerable.com/search
[+] Can we make POST requests to https://www.vulnerable.com/search?
[+] Checking for Imperva WAF...
[+] Attempting gzip bypass for UNIX trigger...
[+] Vulnerable! HTTP response code: 200
[+] Attempting gzip bypass for Windows trigger...
[+] Vulnerable! HTTP response code: 200
```

If you get this error:

```
$ ./imperva_gzip.py https://www.vulnerable.com/search
[+] Can we make POST requests to https://www.vulnerable.com/search?
[!] Can't POST to https://www.vulnerable.com/search. Try -r if 30x redirects are allowed. HTTP response code: 302
```

then try passing `-r` on the command line to enable relaxed mode. Relaxed mode is off by default, which means a POST request is expected to elicit an HTTP 200 response from the server. -r expands the acceptable responses to HTTP 2xx, 3xx.

## Scripting

The exit codes for `imperva_gzip.py` are as follows:
```
0: Returned after getting WAF type.
1: Command-line was invalid.
2: There was an error connecting. Could be DNS error, timeout, etc.
3: No WAF was detected; malicious UNIX/Windows payloads weren't blocked.
4: A WAF was detected, but it wasn't Imperva.
5: The server responded to a test POST request with something other than HTTP 200.
128: There is an Imperva WAF, but it is not vulnerable to the gzip bypass.
129: The bypass was effective for the UNIX payload, but not the Windows one.
130: The bypass was effective for the Windows payload, but not the UNIX one.
131: The bypass was effective against both Windows and UNIX payloads.
```

## Process to Manually Test for Vulnerability

Send three POST requests:

1. Establish a baseline POST request/response with a valid but harmless POST request
2. Trigger the Imperva WAF using the same POST request, but with extra “malicious” data such as ![Example of malicious code added to trigger the Imperva WAF](https://assets.bishopfox.com/prod-1437/Images/channels/blog/Content/code-sample-executing.jpg) in the body to verify that Imperva blocks it
3. Add the header `Content-Encoding: gzip` to the same malicious request and verify that Imperva doesn't block it

## Other Encoding

According to <https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding>, there are four valid values for the Content-Encoding header:

* compress
* deflate
* gzip
* br

In testing, only gzip worked as a bypass.

Subscribe to Bishop Fox's Security Blog

Be first to learn about latest tools, advisories, and findings.

Thank You! You have been subscribed.

---

### Recommended Posts

## You might be interested in these related posts.

[![](https://assets.bishopfox.com/prod-1437/Images/channels/blog/tiles/BishopFox-Blog-RAINK-F.jpg)

Jan 14, 2025

raink: Use LLMs for Document Ranking](https://bishopfox.com/blog/raink-llms-document-ranking)
[![](https://assets.bishopfox.com/prod-1437/Images/channels/blog/tiles/BishopFox-Blogs-Cyber-Mirage-Deepfake-Cloning-F.jpg)

Jan 08, 2025

Cyber Mirage: How AI is Shaping the Future of Social Engineering](https://bishopfox.com/blog/cyber-mirage-deepfake-ai-social-engineering)
[![](https://assets.bishopfox.com/prod-1437/Images/channels/blog/tiles/Featured_Tile_2024-12-12-205929_kppy.jpg)

Dec 13, 2024

Current State of SonicWall Exposure: Firmware Decryption Unlocks New Insights](https://bishopfox.com/blog/state-sonicwall-exposure-firmware-decryption-unlocks-insights)
[![](https://assets.bishopfox.com/prod-1437/Images/channels/blog/tiles/SonicWall-hadware-part1_Featured_Tile.jpg)

Dec 02, 2024

Sonicwall Firmware Deep Dive - Part 1](https://bishopfox.com/blog/sonicwall-firmware-deep-dive-part-1)

* [Cosmos Platform](/cosmos)
* [Cosmos Attack Surface Management](/cosmos-attack-surface-management-casm)
* [Cosmos Application Penetration Testing](/cosmos-application-penetration-testing-capt)
* [Cosmos External Penetration Testing](/cosmos-external-penetration-testing-cept)

* [Services](/services)
* [Application Security](/services/application-security)
* [Cloud Security](/services/cloud-penetration-testing)
* [IoT & Product Security](/services/product-security-review)
* [Network Security](/services/network-security)
* [Red Team & Readiness](/services/red-teaming)
* [Compliance, Regulations, & Frameworks](/services/compliance-and-frameworks)
* [Google, Facebook, & Amazon Partner Assessments](/services/vendor-assessments)

* [Resources](/resources)
* [Resource Center](/resource-center)
* [Blog](/blog)
* [Advisories](/blog/advisories)
* [Tools](/tools)

* [Our Customers](/customers)
* [Our Customer Stories](/resources/customer-stories)

* [Partners](/partners)
* [Partner Programs](/partners)
* [Partner Directory](/partner-directory)
* [Become a Partner](/partners/become-a-partner)

* [Company](/company)
* [About Us](/company)
* [Careers
  We're Hiring](/careers)
* [Events](/events)
* [Newsroom](/news)
* [Bishop Fox Mexico](/mexico)
* [Bishop Fox Labs](/labs)
* [Contact Us](/contact)

Copyright © 2025 Bishop Fox

[Privacy Statement](https://bishopfox.com/privacy-statement)
[Responsible Disclosure Policy](https://bishopfox.com/vulnerability-disclosure-policy)

This site uses cookies to provide you with a great user experience. By continuing to use our website, you consent to the use of cookies. To find out more about the cookies we use, please see our [Privacy Policy](https://bishopfox.com/privacy-statement).

Accept


