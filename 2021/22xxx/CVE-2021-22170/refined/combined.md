=== Content from gitlab.com_82f8f0d1_20250114_183348.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# AES-GCM issues in lib/gitlab/crypto\_helper.rb

The `Gitlab::CryptoHelper` module is being used to encrypt sensitive token values within the database.
The token values are encrypted utilizing AES-GCM. AES-GCM is an authenticated cipher, thus ensuring integrity of the stored ciphertexts. Within the `Gitlab::CryptoHelper` implementation however this cannot be guaranteed. The cipher is set up with a static key and a static nonce as follows:

```
    AES256_GCM_OPTIONS = {
      algorithm: 'aes-256-gcm',
      key: Settings.attr_encrypted_db_key_base_32,
      iv: Settings.attr_encrypted_db_key_base_12
    }.freeze
```

Both `Settings.attr_encrypted_db_key_base_32` and `Settings.attr_encrypted_db_key_base_12` are static values, namely the first 32 or the first 12 bytes of `Gitlab::Application.secrets.db_key_base`.

There are several issues with those settings:

* Key and IV (nonce) are related to each other (IV is a substring of the key)
  + This is not advisable, even tough this is not directly exploitable the IV and key should not relate to each other
* `Gitlab::Application.secrets.db_key_base` is a hexadecimal string e.g. `"7ce6778d9ef49559..."` this results in both IV and key are effectively half as long as intended
* The nonce reuse allows recovery of the authentication key used within AES-GCM.
  + Just by observing two different ciphertexts and their respective authentication tags we can forge authentication tags for arbitrary ciphertexts.
* When knowing a plain/ciphertext pair (e.g. from a project's runners token) we can deduce the keystream and thus encrypt arbitrary values up to the length of our known pair

I'd suggest to store a random IV along with the encrypted value. Additionally the key should be derived from `Gitlab::Application.secrets.db_key_base` with e.g. PBKDF2.

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_e4654d9e_20250114_183347.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2021](/gitlab-org/cves/-/tree/master/2021)
* [**CVE-2021-22170.json**](/gitlab-org/cves/-/blob/master/2021/CVE-2021-22170.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2021/CVE-2021-22170.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2021/CVE-2021-22170.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ GitLab Bot 's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 " GitLab Bot ")](/gitlab-bot)

  Dec 03, 2021

  [7066f071](/gitlab-org/cves/-/commit/7066f0718f95b323bb5cd3ed47d76e69759a32eb)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/7066f0718f95b323bb5cd3ed47d76e69759a32eb)
  繚
  7066f071

  [ GitLab Bot ](/gitlab-bot) authored Dec 03, 2021

  7066f071

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/7066f0718f95b323bb5cd3ed47d76e69759a32eb)
  [ GitLab Bot ](/gitlab-bot) authored Dec 03, 2021

Loading


