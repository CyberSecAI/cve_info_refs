Based on the provided content, here's a breakdown of the vulnerability:

**Root Cause:**

The vulnerability stems from a bypass of the intended restrictions on `kroki-plantuml-include` and `kroki-fetch-diagram` within GitLab's AsciiDoc processing. Although these features were disabled to prevent arbitrary file access, the attacker leveraged the `counter` attribute in Asciidoctor to inject malicious values into these attributes, effectively re-enabling them.

**Weaknesses/Vulnerabilities:**

*   **Insecure Attribute Handling:** The `counter` attribute in Asciidoctor allows for dynamic attribute injection, bypassing the intended static attribute restrictions set by GitLab.
*   **Lack of Input Sanitization:** The values injected through the `counter` are not properly sanitized or validated before being used in `kroki-plantuml-include` and `kroki-fetch-diagram`.
*   **Bypassed Restrictions:** The intended disabling of `kroki-plantuml-include` and `kroki-fetch-diagram` is circumvented, leading to arbitrary file access vulnerabilities.

**Impact of Exploitation:**

*   **Arbitrary File Read:** An attacker can read arbitrary files on the server by injecting a file path into the `kroki-plantuml-include` attribute. This allows access to sensitive data like `/etc/passwd`, and potentially other configuration or secret files.
*   **Arbitrary File Write:** An attacker can write to arbitrary files on the server by controlling the `kroki-server-url` attribute and the `format` of the generated diagram. By controlling the URL that kroki fetches diagrams from and using path traversal in the diagram name, they can force GitLab to download data from the controlled URL and save it to an arbitrary location on the server, as if it was a diagram.

**Attack Vectors:**

*   **Asciidoctor Markup Injection:** The attacker crafts malicious Asciidoctor markup within a GitLab wiki page.
*   **`counter` Attribute Abuse:** The attacker leverages the `counter` attribute to inject malicious file paths, server URLs, and diagram names.
*   **Kroki Integration Exploitation:** The attacker utilizes the Kroki integration to trigger file access/write operations.

**Required Attacker Capabilities/Position:**

*   **GitLab User:** The attacker needs to be a user with the ability to create or edit wiki pages in a GitLab project.
*   **Kroki Enabled:** The GitLab instance must have Kroki integration enabled.
*   **Network Access:** For arbitrary file write, the attacker needs to be able to host a server accessible by the GitLab instance.

**Additional Details:**

*   The vulnerability was discovered by `ledz1996` and reported via HackerOne.
*   The report provides detailed steps for reproducing both the arbitrary file read and arbitrary file write vulnerabilities, including example payloads and scripts.
*   The vulnerability affects GitLab version 13.7.4-ee and potentially other versions.
*   The arbitrary file write leverages a path traversal vulnerability in combination with the ability to control the server url that Kroki fetches from.