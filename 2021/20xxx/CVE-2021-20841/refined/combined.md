=== Content from www.ec-cube.net_7731637c_20250114_192304.html ===

# EC-CUBE 2系における複数の脆弱性 (JVN#75444925)

##### 更新履歴

2021/11/11 17:00
「脆弱性の概要」に、JVNからの公表内容情報へのリンクを追加
2021/11/11 11:00
初版公開

## EC-CUBE 2系における2件の脆弱性のお知らせ

EC-CUBE 2系に2件の脆弱性(緊急度 中：1件、緊急度 低：1件)があることが判明いたしました。

脆弱性そのものは、修正ファイルの反映によりすぐに解決するものです。以下のいずれかの方法により、ご対応をお願いいたします。

* 修正方法1: EC-CUBEのバージョンアップを行う場合
* 修正方法2: 修正差分を確認して適宜反映する場合

皆様にはお手数おかけし誠に申し訳ございません。

本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。

## 脆弱性の概要

### 1. 管理画面におけるCSRF

危険度:
中

不具合が存在するEC-CUBEのバージョン:
2.11.0 〜 2.17.1

詳細:

管理画面にログインした状態の管理者権限を持つユーザが、細工されたページに誘導され特定のURLにアクセスした場合、意図せず管理ユーザを削除される CSRF脆弱性。

---

### 2. 認可制御の不備

危険度:
低

不具合が存在するEC-CUBEのバージョン:
2.11.2 〜 2.17.1

詳細:

店舗オーナー権限を持つユーザによって、本来操作権限のないシステム設定の変更が可能となる認可制御の不備。

なお、管理画面の「システム設定」→「マスタデータ管理」より、mtb\_permission の ID を管理画面URLと同じディレクトリ名に変更することで回避可能です。

例:

管理画面URLが `example.com/example-admin/` の場合、マスタデータ管理の mtb\_permission の ID `/admin/system/index.php` を、`/example-admin/system/index.php` に変更する (その他のIDも同様に、ディレクトリ名部分を変更する)

---

### JVNからの公表内容 (2021/11/11公開)

[JVN#75444925: EC-CUBE 2系における複数の脆弱性](https://jvn.jp/jp/JVN75444925/)

## 修正方法1: EC-CUBEのバージョンアップを行う場合

EC-CUBE 2.17.2以降の最新版にバージョンアップしていただくことで、本件の脆弱性は修正されます。

公式サイトの[ダウンロードページ](https://www.ec-cube.net/download/other.php)から最新バージョンをダウンロードしてご利用ください。

## 修正方法2: 修正差分を確認して適宜反映する場合

EC-CUBE本体のソースコードをカスタマイズされている方向けです。

下記のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。

### サポート対象バージョン

* **EC-CUBE 2.17.1**
* **EC-CUBE 2.13.5**

(旧バージョンのEC-CUBEをお使いの方は、最新バージョンへのアップデートを推奨いたします)

### 修正対象ファイル

以下の3ファイルとなります。

* /data/class/SC\_Session.php
* /data/class/pages/admin/system/LC\_Page\_Admin\_System\_Delete.php
* /html/user\_data/packages/admin/js/eccube.admin.js

### 修正差分

EC-CUBE 2.17.1 / 2.13.5 とも、同一内容となります。

 data/class/SC\_Session.php
CHANGED

Viewed

|  | @@ -65,7 +65,7 @@ class SC\_Session |
| --- | --- |
| 65 65 | } |
| 66 66 | } |
| 67 67 | /\* 認証成功の判定 \*/ |
| 68 | -  public function IsSuccess() |
| 68 | +  public function IsSuccess($admin\_dir = ADMIN\_DIR) |
| 69 69 | { |
| 70 70 | if ($this->cert == CERT\_STRING) { |
| 71 71 | $script\_path = realpath($\_SERVER['SCRIPT\_FILENAME']); |
|  | @@ -75,7 +75,15 @@ class SC\_Session |
| 75 75 | $arrPERMISSION = $masterData->getMasterData('mtb\_permission'); |
| 76 76 |  |
| 77 77 | foreach ($arrPERMISSION as $path => $auth) { |
| 78 | -  $~~permission\_path~~ ~~=~~ ~~realpath(HTML\_REALDIR~~ ~~.~~ ~~$path);~~ |
| 78 | +  if (stripos($path, '/admin/') === 0) { |
| 79 | +  // path が /admin で始まる場合は /admin を削除 |
| 80 | +  $path = str\_replace('/admin', '', $path); |
| 81 | +  } elseif (stripos($path, '/'.$admin\_dir) === 0) { |
| 82 | +  // path が /ADMIN\_DIR で始まる場合は /ADMIN\_DIR を削除 |
| 83 | +  $path = str\_replace('/'.$admin\_dir, '', $path); |
| 84 | +  } |
| 85 | +  $permission\_path = realpath(HTML\_REALDIR.$admin\_dir.$path); |
| 86 | + |
| 79 87 | $arrPermissionPath = explode('/', str\_replace('\\', '/', $permission\_path)); |
| 80 88 | $arrDiff = array\_diff\_assoc($arrScriptPath, $arrPermissionPath); |
| 81 89 | // 一致した場合は、権限チェックを行う |

 data/class/pages/admin/system/LC\_Page\_Admin\_System\_Delete.php
CHANGED

Viewed

|  | @@ -60,6 +60,10 @@ class LC\_Page\_Admin\_System\_Delete extends LC\_Page\_Admin\_Ex |
| --- | --- |
| 60 60 | \*/ |
| 61 61 | public function action() |
| 62 62 | { |
| 63 | +  if ($this->getMode() !== 'delete') { |
| 64 | +  SC\_Utils\_Ex::sfDispError(INVALID\_MOVE\_ERRORR); |
| 65 | +  SC\_Response\_Ex::actionExit(); |
| 66 | +  } |
| 63 67 | $objFormParam = new SC\_FormParam\_Ex; |
| 64 68 |  |
| 65 69 | // パラメーターの初期化 |

 html/user\_data/packages/admin/js/eccube.admin.js
CHANGED

Viewed

|  | @@ -31,7 +31,8 @@ |
| --- | --- |
| 31 31 |  |
| 32 32 | //指定されたidの削除を行うページを実行する。 |
| 33 33 | eccube.deleteMember = function(id, pageno, lastAdminFlag) { |
| 34 | -  var ~~url~~ = ~~"./delete~~.~~php?id=" + id + "&pageno=" + pageno~~; |
| 34 | +  var transactionid = $('input[name=transactionid]').val(); |
| 35 | +  var url = "./delete.php?id=" + id + "&pageno=" + pageno + "&mode=delete&transactionid=" + transactionid; |
| 35 36 | var message = lastAdminFlag ? |
| 36 37 | '警告: 管理者がいなくなってしまいますと、システム設定などの操作が行えなくりますが宜しいでしょうか' |
| 37 38 | : '登録内容を削除しても宜しいでしょうか'; |

### 問い合わせ先

本脆弱性に関するお問合せ：

EC-CUBE 運営チーム

MAIL: [[email protected]](/cdn-cgi/l/email-protection)



=== Content from jvn.jp_dca84f6f_20250114_192301.html ===


![Japan Vulnerability Notes](/common/img/note_logo.gif)

Published:2021/11/11  Last Updated:2021/11/11
# JVN#75444925 Multiple vulnerabilities in EC-CUBE 2 series

## Overview

EC-CUBE 2 series provided by EC-CUBE CO.,LTD. contains multiple vulnerabilities.

## Products Affected

**CVE-2021-20841**

* EC-CUBE 2.11.2 to 2.17.1 (EC-CUBE 2 series)

**CVE-2021-20842**

* EC-CUBE 2.11.0 to 2.17.1 (EC-CUBE 2 series)

## Description

EC-CUBE 2 series provided by EC-CUBE CO.,LTD. contains multiple vulnerabilities listed below.

* **Improper access control in Management screen ([CWE-284](https://cwe.mitre.org/data/definitions/284.html))** - CVE-2021-20841

  | CVSS v3 | CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N | **Base Score: 4.3** |
  | --- | --- | --- |
  | CVSS v2 | AV:N/AC:L/Au:S/C:N/I:P/A:N | **Base Score: 4.0** |
* **Cross-site request forgery vulnerability in Management screen ([CWE-352](https://cwe.mitre.org/data/definitions/352.html))** - CVE-2021-20842

  | CVSS v3 | CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N | **Base Score: 6.5** |
  | --- | --- | --- |
  | CVSS v2 | AV:N/AC:H/Au:N/C:N/I:P/A:N | **Base Score: 2.6** |

## Impact

* A user who can log in to the product may alter System settings without the appropriate privilege - CVE-2021-20841
* If a user with an administrative privilege views a malicious page while logged in, Administrator may be deleted - CVE-2021-20842

## Solution

**Update the Softwere**

Update the software according to the information provided by the developer.

The developer has released EC-CUBE 2.17.2 that addresses these vulnerabilities.

**Apply the Patch**

Apply the hotfix patch according to the information provided by the developer.

**Apply the Workaround**

**CVE-2021-20841**

Applying the following workaround may mitigate the impact of this vulnerability.

* Change the value of `mtb_permission` to the directory name of Management screen URL

For more information, refer to the information provided by the developer.

## Vendor Status

| Vendor | Status | Last Update | Vendor Notes |
| --- | --- | --- | --- |
| EC-CUBE CO.,LTD. | [Vulnerable](491122/index.html) | 2021/11/11 | [EC-CUBE CO.,LTD. website](https://www.ec-cube.net/info/weakness/20211111/) |

## References

## JPCERT/CC Addendum

## Vulnerability Analysis by JPCERT/CC

## Credit

EC-CUBE CO.,LTD. reported these vulnerabilities to JPCERT/CC to notify users of the solution through JVN. JPCERT/CC and EC-CUBE CO.,LTD. coordinated under the Information Security Early Warning Partnership.

## Other Information

| JPCERT Alert |  |
| --- | --- |
| JPCERT Reports |  |
| CERT Advisory |  |
| CPNI Advisory |  |
| TRnotes |  |
| CVE | [CVE-2021-20841](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-20841) |
|  | [CVE-2021-20842](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-20842) |
| JVN iPedia | [JVNDB-2021-000100](https://jvndb.jvn.jp/jvndb/JVNDB-2021-000100) |

* JVN
* [HOME](/en/index.html)
* [What is JVN ?](/en/nav/jvn.html)
* [Instructions](/en/nav/jvnhelp.html)
* [List of Vulnerability Report](/en/report/index.html)
* [VN\_JP](/en/jp/index.html)
* [VN\_JP(Unreachable)](/en/adj/index.html)
* [VN\_VU](/en/vu/index.html)
* [TA](/en/ta/index.html)
* [TRnotes](/en/tr/index.html)
* [JVN iPedia](http://jvndb.jvn.jp/en/)
* [MyJVN](http://jvndb.jvn.jp/en/apis/myjvn/index.html)
* [JVNJS/RSS](/en/rss/index.html)
* [Vendor List](/en/nav/index.html)
* [List of unreachable developers](/en/reply/index.html)
* [Contact](/en/contact/index.html)

Copyright (c) 2000-2021 JPCERT/CC and IPA. All rights reserved.


