```
{
  "vulnerability": {
    "root_cause": "An optimization in Tremor's `patch` and `merge` operations on the `state` variable caused a memory safety issue. These operations were being optimized to update the target expression (`state`) in-place. When the `state` variable was targeted and the `merge` or `patch` operations referenced the `event` data, the optimization led to references to the `event`'s memory being held beyond the lifetime of the `event` data allocation. This would allow access to potentially freed or reallocated memory regions.",
    "weaknesses": [
      "CWE-416: Use After Free",
      "CWE-825: Expired Pointer Dereference"
    ],
    "impact": "The vulnerability could lead to memory corruption and access to potentially sensitive data if an attacker could trigger the vulnerable code paths and exfiltrate the state via TCP or HTTP, or by other means, as the data could now contain references to arbitrary memory.",
    "attack_vectors": "An attacker could trigger the vulnerability by crafting a tremor-script script that uses `patch` or `merge` operations with the `state` variable, where these operations also reference `event` data. The vulnerability would be triggered when this script is executed by a Tremor server or another program using the `tremor-script` crate.",
    "required_attacker_capabilities": "The attacker would need the ability to execute a crafted Tremor script on a vulnerable system. This could be accomplished if an attacker can control the logic of scripts that are deployed onto the tremor runtime or by another means that allows the attacker to execute their own tremor-script code.",
    "additional_details": "The vulnerability was caused by an optimization in the `patch` and `merge` operations, where, if the result was assigned back to the target variable (e.g., `let state = merge state of event end;`), the operation was performed in-place instead of cloning the target value. This in-place operation, combined with borrowed data structures (specifically `beef::Cow<'lifetime, str>`) that reference the raw data of an event, caused the vulnerability. The fix was to remove this in-place optimization and always clone the target expression before performing `patch` or `merge` operations. A temporary workaround was also provided that avoids direct reassignment to the state variable (`let tmp = merge state of event end; let state = tmp`)."
  }
}
```