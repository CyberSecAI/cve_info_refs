=== Content from gitlab.com_9af0a8dc_20250114_201640.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2021](/gitlab-org/cves/-/tree/master/2021)
* [**CVE-2021-39937.json**](/gitlab-org/cves/-/blob/master/2021/CVE-2021-39937.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2021/CVE-2021-39937.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2021/CVE-2021-39937.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Dec 13, 2021

  [9dfc79bc](/gitlab-org/cves/-/commit/9dfc79bcf5ed2fd8f0fd61202e94d4423fadb796)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/9dfc79bcf5ed2fd8f0fd61202e94d4423fadb796)
  ·
  9dfc79bc

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Dec 13, 2021

  9dfc79bc

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/9dfc79bcf5ed2fd8f0fd61202e94d4423fadb796)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Dec 13, 2021

Loading



=== Content from gitlab.com_75487d86_20250114_201641.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# BulkMemberAccessLoad concern does not differentiate memoization\_index across models

### Summary

[BulkMemberAccessLoad](https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/models/concerns/bulk_member_access_load.rb) is used to memoize max member access in projects and groups so we don't have to query the database each time we ask (Using `SafeRequestStore`).

[This line](https://gitlab.com/gitlab-org/gitlab/-/blob/64ada62a60172dff2c70a2c9636492651e8e7d1c/app/models/concerns/bulk_member_access_load.rb#L45) returns the key to store the max access in this format `"max_member_access_for_#{klass.name.underscore.pluralize}:#{memoization_index}"`. But, memoization\_index makes no diferentiation if the stored ID is from a project or a group. So, if you get the max access for a group with ID=6 and it is `MAINTAINER`, it will be stored in the SafeRequestStore as `max_member_access_for_users:6`. If you ask for the max member access for a project with ID=6 on the same request, you will get `MAINTAINER` without it getting to the DB.

### Steps to reproduce

Didn't get to test on the API or any other place than specs yet, so might not be possible to accomplish from any of our external APIs.

Probably easier to test in the GQL API by multiplexing. So, make a request that authorizes read\_group where you have access. In the same request try to read a project with the same ID as the group, and you will get access even if you don't.

This also happens in the opposite direction, if you get max access for the project with no access, the trying to read the group will fail because no access for that group ID is already memoized.

Sample queries described in [#336802 (comment 636855209)](https://gitlab.com/gitlab-org/gitlab/-/issues/336802#note_636855209 "BulkMemberAccessLoad concern does not differentiate memoization_index across models")

### What is the expected *correct* behavior?

Memoization on the request store should also store the model the ID belongs to.

### Possible fixes

Possibly changing [this line](https://gitlab.com/gitlab-org/gitlab/-/blob/64ada62a60172dff2c70a2c9636492651e8e7d1c/app/models/concerns/bulk_member_access_load.rb#L45) to use the model as part of the key is enough. Might affect several places where `BulkMemberAccessLoad`'s methods are called.

Edited Jul 28, 2021 by [Mario Celi](/mcelicalderonG)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


