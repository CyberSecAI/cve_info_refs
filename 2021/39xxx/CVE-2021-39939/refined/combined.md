=== Content from gitlab.com_a5a4caee_20250114_182616.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2021](/gitlab-org/cves/-/tree/master/2021)
* [**CVE-2021-39939.json**](/gitlab-org/cves/-/blob/master/2021/CVE-2021-39939.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2021/CVE-2021-39939.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2021/CVE-2021-39939.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Dec 13, 2021

  [09b5a058](/gitlab-org/cves/-/commit/09b5a058e05e9cdce751ccf5ecfc9ddbf8407d88)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/09b5a058e05e9cdce751ccf5ecfc9ddbf8407d88)
  ·
  09b5a058

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Dec 13, 2021

  09b5a058

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/09b5a058e05e9cdce751ccf5ecfc9ddbf8407d88)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Dec 13, 2021

Loading



=== Content from gitlab.com_4f4df75f_20250114_182617.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Specially crafted docker images can exhaust resources on managers

## Summary

For the Docker executor, when we run a job's main container, we copy the containers output directly to the trace log implementation. This implementation has a limit on how much data is stored.

[!2534 (merged)](https://gitlab.com/gitlab-org/gitlab-runner/-/merge_requests/2534 "Introduce docker internal user package") introduced a `user` package that executes `id` inside of the user's provided container. This is used to fetch the containers `uid` and `gid` and allows us to `chown` files created by our helper image, whose files will also be created with uid `0`.

Unfortunately, no such limit is placed on the output from `id`, so a specially crafted docker image that replaces how `id` works can have it return an excessive amount of data to fill and exhaust a limitless buffer on the Runner manager.

This problem only exists when `FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR` is enabled, however, it can be enabled at the job level. A simple protection is to ensure `FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR` cannot be enabled until the problem is resolved.

A similar problem exists for Docker's service output, which fails its 30s health check. However, whilst there's no limit here (and probably should be), this command reads the Docker's log file output via a different API endpoint. This appears to have an internal limit of 1MB, because we don't `follow` the output.

## Solution

* Disable `FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR` on the Runner fleet to protect GitLab hosted Runner Managers: <https://gitlab.com/gitlab-com/gl-infra/chef-repo/-/merge_requests/805/>
* Explicitly set sane limits on any command/data returned from containers that are not directly fed into the trace log.

Closes [#28630 (closed)](https://gitlab.com/gitlab-org/gitlab-runner/-/issues/28630 "Specially crafted docker images can exhaust resources on managers")

Edited Dec 02, 2021 by [Georgi N. Georgiev](/ggeorgiev_gitlab)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


