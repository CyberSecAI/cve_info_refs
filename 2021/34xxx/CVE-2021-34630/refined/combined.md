=== Content from plugins.svn.wordpress.org_2a5fa48d_20250114_215808.html ===
php
/\*
Plugin Name: GTranslate
Plugin URI: https://gtranslate.io/?xyz=998
Description: Makes your website <strongmultilingual and available to the world using Google Translate. For support visit [GTranslate Support](https://wordpress.org/support/plugin/gtranslate).
Version: 2.8.64
Author: Translate AI Multilingual Solutions
Author URI: https://gtranslate.io
Text Domain: gtranslate
\*/
/\* Copyright 2010 - 2020 Edvard Ananyan (email : edo888@gmail.com)
This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
\*/
add\_action('widgets\_init', array('GTranslate', 'register'));
register\_activation\_hook(\_\_FILE\_\_, array('GTranslate', 'activate'));
register\_deactivation\_hook(\_\_FILE\_\_, array('GTranslate', 'deactivate'));
add\_filter('plugin\_action\_links\_' . plugin\_basename(\_\_FILE\_\_), array('GTranslate', 'settings\_link'));
add\_action('admin\_menu', array('GTranslate', 'admin\_menu'));
add\_action('init', array('GTranslate', 'enqueue\_scripts'));
add\_action('plugins\_loaded', array('GTranslate', 'load\_textdomain'));
add\_shortcode('GTranslate', array('GTranslate', 'get\_widget\_code'));
add\_shortcode('gtranslate', array('GTranslate', 'get\_widget\_code'));
class GTranslate extends WP\_Widget {
public static function activate() {
$data = array(
'gtranslate\_title' => \_\_('Website Translator', 'gtranslate'),
);
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
add\_option('GTranslate', $data);
}
public static function deactivate() {
// delete\_option('GTranslate');
}
public static function settings\_link($links) {
$settings\_link = array('['.\_\_('Settings', 'gtranslate').'](%27%20.%20admin_url%28%27options-general.php?page=gtranslate_options') . ')');
return array\_merge($links, $settings\_link);
}
public static function control() {
$data = get\_option('GTranslate');
?>

php \_e('Title', 'gtranslate'); ?:

php \_e('Please go to <a href="' . admin\_url('options-general.php?page=gtranslate\_options') . '"'.\_\_('GTranslate Settings', 'gtranslate').' for configuration.', 'gtranslate'); ?>

php
if (isset($\_POST['gtranslate\_title'])){
$data['gtranslate\_title'] = esc\_attr($\_POST['gtranslate\_title']);
update\_option('GTranslate', $data);
}
}
public static function enqueue\_scripts() {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
wp\_enqueue\_style( 'gtranslate-style', plugins\_url('gtranslate-style'.$data['flag\_size'].'.css', \_\_FILE\_\_) );
wp\_enqueue\_script('jquery');
// make sure main\_lang is set correctly in config.php file
if($data['pro\_version'] or $data['enterprise\_version']) {
include dirname(\_\_FILE\_\_) . '/url\_addon/config.php';
if($main\_lang != $data['default\_language']) { // update main\_lang in config.php
$config\_file = dirname(\_\_FILE\_\_) . '/url\_addon/config.php';
if(is\_writable($config\_file)) {
$config = file\_get\_contents($config\_file);
$config = preg\_replace('/\$main\_lang = \'[a-z-]{2,5}\'/i', '$main\_lang = \''.$data['default\_language'].'\'', $config);
file\_put\_contents($config\_file, $config);
}
}
}
}
public static function load\_textdomain() {
load\_plugin\_textdomain('gtranslate');
// set correct language direction
global $text\_direction;
if(isset($\_SERVER['HTTP\_X\_GT\_LANG']) and in\_array($\_SERVER['HTTP\_X\_GT\_LANG'], array('ar', 'iw', 'fa')))
$text\_direction = 'rtl';
elseif(isset($\_SERVER['HTTP\_X\_GT\_LANG']))
$text\_direction = 'ltr';
}
public function widget($args, $instance) {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
echo $args['before\_widget'];
echo $args['before\_title'] . $data['gtranslate\_title'] . $args['after\_title'];
if(empty($data['widget\_code']))
\_e('<bNotice: Please configure GTranslate from WP-Admin -> Settings -> GTranslate to see it in action.', 'gtranslate');
else
echo $data['widget\_code'];
// avoid caching issues
if($data['widget\_look'] == 'dropdown\_with\_flags' and ($data['pro\_version'] or $data['enterprise\_version'])) {
echo '';
} elseif($data['widget\_look'] == 'popup' and ($data['pro\_version'] or $data['enterprise\_version'])) {
echo '';
}
// detect browser language
if(!($data['pro\_version'] or $data['enterprise\_version']) and $data['detect\_browser\_language']) {
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$allowed\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$allowed\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$allowed\_languages = $data['incl\_langs'];
$allowed\_languages = json\_encode($allowed\_languages);
echo "";
}
echo $args['after\_widget'];
}
public static function widget2($args) {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
echo $args['before\_widget'];
echo $args['before\_title'] . $data['gtranslate\_title'] . $args['after\_title'];
if(empty($data['widget\_code']))
\_e('**Notice:** Please configure GTranslate from WP-Admin -> Settings -> GTranslate to see it in action.', 'gtranslate');
else
echo $data['widget\_code'];
// avoid caching issues
if($data['widget\_look'] == 'dropdown\_with\_flags' and ($data['pro\_version'] or $data['enterprise\_version'])) {
echo '';
} elseif($data['widget\_look'] == 'popup' and ($data['pro\_version'] or $data['enterprise\_version'])) {
echo '';
}
// detect browser language
if(!($data['pro\_version'] or $data['enterprise\_version']) and $data['detect\_browser\_language']) {
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$allowed\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$allowed\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$allowed\_languages = $data['incl\_langs'];
$allowed\_languages = json\_encode($allowed\_languages);
echo "";
}
echo $args['after\_widget'];
}
public static function get\_widget\_code($atts) {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
if(empty($data['widget\_code']))
return \_\_('**Notice:** Please configure GTranslate from WP-Admin -> Settings -> GTranslate to see it in action.', 'gtranslate');
else {
// avoid caching issues
if($data['widget\_look'] == 'dropdown\_with\_flags' and ($data['pro\_version'] or $data['enterprise\_version'])) {
$data['widget\_code'] .= '';
} elseif($data['widget\_look'] == 'popup' and ($data['pro\_version'] or $data['enterprise\_version'])) {
$data['widget\_code'] .= '';
}
//$\_SERVER['HTTP\_ACCEPT\_LANGUAGE'] = 'ru-Ru'; // debug
// detect browser language
if(!($data['pro\_version'] or $data['enterprise\_version']) and $data['detect\_browser\_language']) {
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$allowed\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$allowed\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$allowed\_languages = $data['incl\_langs'];
$allowed\_languages = json\_encode($allowed\_languages);
$data['widget\_code'] .= "";
}
return $data['widget\_code'];
}
}
public static function register() {
register\_widget('GTranslateWidget');
}
public static function admin\_menu() {
add\_options\_page(\_\_('GTranslate Options', 'gtranslate'), 'GTranslate', 'administrator', 'gtranslate\_options', array('GTranslate', 'options'));
}
public static function options() {
?>

## G|translate

php
if(isset($\_POST['save']) and $\_POST['save'])
GTranslate::control\_options();
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
wp\_enqueue\_script('jquery-ui-sortable');
wp\_enqueue\_script('jquery-effects-core');
wp\_enqueue\_script('wp-color-picker');
wp\_enqueue\_style( 'wp-color-picker');
wp\_add\_inline\_script('wp-color-picker', 'jQuery(document).ready(function($) {$(".color-field").wpColorPicker({change:function(e,c){$("#"+e.target.getAttribute("id")+"\_hidden").val(c.color.toString());e.target.value = c.color.toString();RefreshDoWidgetCode();}});});');
/\* code editor for widget\_code textarea
if(function\_exists('wp\_enqueue\_code\_editor')) {
$editor\_settings = wp\_enqueue\_code\_editor(array('type' = 'text/html'));
if($editor\_settings !== false)
wp\_add\_inline\_script('code-editor', sprintf('jQuery(function() {wp.codeEditor.initialize("widget\_code", %s);});', wp\_json\_encode($editor\_settings)));
}
\*/
$site\_url = site\_url();
$wp\_plugin\_url = preg\_replace('/^https?:/i', '', plugins\_url() . '/gtranslate');
extract($data);
$gt\_lang\_array\_json = '{"af":"Afrikaans","sq":"Albanian","am":"Amharic","ar":"Arabic","hy":"Armenian","az":"Azerbaijani","eu":"Basque","be":"Belarusian","bn":"Bengali","bs":"Bosnian","bg":"Bulgarian","ca":"Catalan","ceb":"Cebuano","ny":"Chichewa","zh-CN":"Chinese (Simplified)","zh-TW":"Chinese (Traditional)","co":"Corsican","hr":"Croatian","cs":"Czech","da":"Danish","nl":"Dutch","en":"English","eo":"Esperanto","et":"Estonian","tl":"Filipino","fi":"Finnish","fr":"French","fy":"Frisian","gl":"Galician","ka":"Georgian","de":"German","el":"Greek","gu":"Gujarati","ht":"Haitian Creole","ha":"Hausa","haw":"Hawaiian","iw":"Hebrew","hi":"Hindi","hmn":"Hmong","hu":"Hungarian","is":"Icelandic","ig":"Igbo","id":"Indonesian","ga":"Irish","it":"Italian","ja":"Japanese","jw":"Javanese","kn":"Kannada","kk":"Kazakh","km":"Khmer","ko":"Korean","ku":"Kurdish (Kurmanji)","ky":"Kyrgyz","lo":"Lao","la":"Latin","lv":"Latvian","lt":"Lithuanian","lb":"Luxembourgish","mk":"Macedonian","mg":"Malagasy","ms":"Malay","ml":"Malayalam","mt":"Maltese","mi":"Maori","mr":"Marathi","mn":"Mongolian","my":"Myanmar (Burmese)","ne":"Nepali","no":"Norwegian","ps":"Pashto","fa":"Persian","pl":"Polish","pt":"Portuguese","pa":"Punjabi","ro":"Romanian","ru":"Russian","sm":"Samoan","gd":"Scottish Gaelic","sr":"Serbian","st":"Sesotho","sn":"Shona","sd":"Sindhi","si":"Sinhala","sk":"Slovak","sl":"Slovenian","so":"Somali","es":"Spanish","su":"Sudanese","sw":"Swahili","sv":"Swedish","tg":"Tajik","ta":"Tamil","te":"Telugu","th":"Thai","tr":"Turkish","uk":"Ukrainian","ur":"Urdu","uz":"Uzbek","vi":"Vietnamese","cy":"Welsh","xh":"Xhosa","yi":"Yiddish","yo":"Yoruba","zu":"Zulu"}';
$gt\_lang\_array = get\_object\_vars(json\_decode($gt\_lang\_array\_json));
include dirname(\_\_FILE\_\_) . '/native\_names\_map.php'; // defines $native\_names\_map array
//echo '
```
' . print_r($native_names_map, true) . '
```
';
$gt\_lang\_array\_native\_json = json\_encode($native\_names\_map);
if(!empty($language\_codes))
$gt\_lang\_codes\_json = json\_encode(explode(',', $language\_codes));
else
$gt\_lang\_codes\_json = '[]';
if(!empty($language\_codes2))
$gt\_lang\_codes2\_json = json\_encode(explode(',', $language\_codes2));
else
$gt\_lang\_codes2\_json = '[]';
$script = << 0 ? true : false;
var pro\_version = jQuery('#pro\_version:checked').length > 0 ? true : false;
var enterprise\_version = jQuery('#enterprise\_version:checked').length > 0 ? true : false;
var new\_window = jQuery('#new\_window:checked').length > 0 ? true : false;
var show\_in\_menu = jQuery('#show\_in\_menu').val();
var floating\_language\_selector = jQuery('#floating\_language\_selector').val();
var native\_language\_names = jQuery('#native\_language\_names:checked').length > 0 ? true : false;
var analytics = jQuery('#analytics:checked').length > 0 ? true : false;
var detect\_browser\_language = jQuery('#detect\_browser\_language:checked').length > 0 ? true : false;
var email\_translation = jQuery('#email\_translation:checked').length > 0 ? true : false;
var switcher\_text\_color = jQuery('#switcher\_text\_color').val();
var switcher\_arrow\_color = jQuery('#switcher\_arrow\_color').val();
var switcher\_border\_color = jQuery('#switcher\_border\_color').val();
var switcher\_background\_color = jQuery('#switcher\_background\_color').val();
var switcher\_background\_shadow\_color = jQuery('#switcher\_background\_shadow\_color').val();
var switcher\_background\_hover\_color = jQuery('#switcher\_background\_hover\_color').val();
var dropdown\_text\_color = jQuery('#dropdown\_text\_color').val();
var dropdown\_hover\_color = jQuery('#dropdown\_hover\_color').val();
var dropdown\_background\_color = jQuery('#dropdown\_background\_color').val();
// make sure default language is on
if(widget\_look == 'flags\_dropdown' || widget\_look == 'dropdown\_with\_flags' || widget\_look == 'flags' || widget\_look == 'flags\_name' || widget\_code == 'flags\_code' || widget\_look == 'popup')
jQuery('#fincl\_langs'+default\_language).prop('checked', true);
if(widget\_look == 'dropdown' || widget\_look == 'globe' || widget\_look == 'lang\_names' || widget\_look == 'lang\_codes')
jQuery('#incl\_langs'+default\_language).prop('checked', true);
if(pro\_version || enterprise\_version) {
translation\_method = 'redirect';
jQuery('#new\_window\_option').show();
jQuery('#url\_translation\_option').show();
jQuery('#hreflang\_tags\_option').show();
jQuery('#email\_translation\_option').show();
if(email\_translation)
jQuery('#email\_translation\_debug\_option').show();
//jQuery('#auto\_switch\_option').hide();
} else {
jQuery('#new\_window\_option').hide();
jQuery('#url\_translation\_option').hide();
jQuery('#hreflang\_tags\_option').hide();
jQuery('#email\_translation\_option').hide();
jQuery('#email\_translation\_debug\_option').hide();
//jQuery('#auto\_switch\_option').show();
}
if(widget\_look == 'dropdown' || widget\_look == 'flags\_dropdown' || widget\_look == 'globe' || widget\_look == 'lang\_names' || widget\_look == 'lang\_codes') {
jQuery('#dropdown\_languages\_option').show();
} else {
jQuery('#dropdown\_languages\_option').hide();
}
if(widget\_look == 'globe') {
jQuery('#alternative\_flags\_option').show();
} else {
jQuery('#alternative\_flags\_option').hide();
}
if(widget\_look == 'flags' || widget\_look == 'flags\_dropdown' || widget\_look == 'dropdown\_with\_flags' || widget\_look == 'flags\_name' || widget\_look == 'flags\_code' || widget\_look == 'popup') {
jQuery('#flag\_languages\_option').show();
jQuery('#alternative\_flags\_option').show();
} else {
jQuery('#flag\_languages\_option').hide();
if(widget\_look != 'globe')
jQuery('#alternative\_flags\_option').hide();
}
if(widget\_look == 'flags\_dropdown') {
jQuery('#line\_break\_option').show();
} else {
jQuery('#line\_break\_option').hide();
}
if(widget\_look == 'dropdown' || widget\_look == 'lang\_names' || widget\_look == 'lang\_codes' || widget\_look == 'globe') {
jQuery('#flag\_size\_option,#flag\_monochrome\_option').hide();
} else {
jQuery('#flag\_size\_option,#flag\_monochrome\_option').show();
}
if(widget\_look == 'dropdown\_with\_flags') {
jQuery('.switcher\_color\_options').show();
} else {
jQuery('.switcher\_color\_options').hide();
}
if(native\_language\_names) {
gt\_lang\_array = gt\_lang\_array\_native;
jQuery('.en\_names').hide();
jQuery('.native\_names').show();
} else {
gt\_lang\_array = gt\_lang\_array\_english;
jQuery('.native\_names').hide();
jQuery('.en\_names').show();
}
if(pro\_version && enterprise\_version)
pro\_version = false;
if(translation\_method == 'on\_fly' || translation\_method == 'redirect' || translation\_method == 'onfly') {
// Adding flags and names
if(widget\_look == 'flags' || widget\_look == 'flags\_dropdown' || widget\_look == 'flags\_name' || widget\_look == 'flags\_code' || widget\_look == 'lang\_names' || widget\_look == 'lang\_codes') {
jQuery.each(((widget\_look == 'flags' || widget\_look == 'flags\_dropdown' || widget\_look == 'flags\_name' || widget\_look == 'flags\_code') ? language\_codes : language\_codes2), function(i, val) {
lang = (widget\_look == 'flags' || widget\_look == 'flags\_dropdown' || widget\_look == 'flags\_name' || widget\_look == 'flags\_code') ? language\_codes[i] : language\_codes2[i];
if(widget\_look == 'lang\_names' || widget\_look == 'lang\_codes')
chklist = '#incl\_langs';
else
chklist = '#fincl\_langs';
if(jQuery(chklist+lang+':checked').length) {
lang\_name = gt\_lang\_array[lang];
var href = '#';
if(pro\_version) {
href = (lang == default\_language) ? '$site\_url' : '$site\_url'.replace('$site\_url'.split('/').slice(0, 3).join('/'), '$site\_url'.split('/').slice(0, 3).join('/')+'/'+lang);
if(lang != default\_language && href.endsWith('/'+lang)) href += '/';
} else if(enterprise\_version)
href = (lang == default\_language) ? '$site\_url' : '$site\_url'.replace('$site\_url'.split('/').slice(2, 3)[0].replace('www.', ''), lang + '.' + '$site\_url'.split('/').slice(2, 3)[0].replace('www.', '')).replace('://www.', '://');
widget\_preview += '[';
//adding language flag
if(widget\_look == 'flags' || widget\_look == 'flags\_dropdown' || widget\_look == 'flags\_name' || widget\_look == 'flags\_code') {
if(lang == 'en' && jQuery('#alt\_us:checked').length)
widget\_preview += '!['+lang_name+']({$wp_plugin_url}/flags/'+flag_size+'/en-us.png)](%27%2Bhref%2B%27 "'+lang_name+'") ';
else if(widget\_look == 'lang\_names')
widget\_preview += lang\_name+' ';
else if(widget\_look == 'flags\_code')
widget\_preview += ' '+lang.toUpperCase()+' ';
else if(widget\_look == 'lang\_codes')
widget\_preview += lang.toUpperCase()+' ';
else if(widget\_look == 'flags')
widget\_preview += '';
else if(widget\_look == 'flags\_dropdown')
widget\_preview += '';
}
});
}
// Adding dropdown
if(widget\_look == 'dropdown' || widget\_look == 'flags\_dropdown') {
if((widget\_look == 'flags' || widget\_look == 'flags\_dropdown') && jQuery('#add\_new\_line:checked').length)
widget\_preview += '
';
else
widget\_preview += ' ';
widget\_preview += '';
widget\_preview += 'Select Language';
jQuery.each(language\_codes2, function(i, val) {
lang = language\_codes2[i];
if(jQuery('#incl\_langs'+lang+':checked').length) {
lang\_name = gt\_lang\_array[lang];
widget\_preview += ''+lang\_name+'';
}
});
widget\_preview += '';
}
// Adding onfly html and css
if(translation\_method == 'onfly') {
widget\_code += ''+new\_line+new\_line;
widget\_code += ''+new\_line;
widget\_code += '

### php \_e('Widget preview', 'gtranslate'); ?

### php \_e('Color options', 'gtranslate'); ? ( light | dark )

| php \_e('Switcher text color', 'gtranslate'); ?: |  |
| --- | --- |
| php \_e('Switcher arrow color', 'gtranslate'); ?: |  |
| php \_e('Switcher border color', 'gtranslate'); ?: |  |
| php \_e('Switcher background color', 'gtranslate'); ?: |  |
| php \_e('Switcher background shadow color', 'gtranslate'); ?: |  |
| php \_e('Switcher background hover color', 'gtranslate'); ?: |  |
| php \_e('Dropdown text color', 'gtranslate'); ?: |  |
| php \_e('Dropdown hover color', 'gtranslate'); ?: |  |
| php \_e('Dropdown background color', 'gtranslate'); ?: |  |

### php \_e('Paid version advantages', 'gtranslate'); ?

* php \_e('Search engine indexing', 'gtranslate'); ?
* php \_e('Search engine friendly (SEF) URLs', 'gtranslate'); ?
* php \_e('Human level neural translations', 'gtranslate'); ?
* php \_e('Edit translations manually', 'gtranslate'); ?
* [php \_e('Automatic translation post-editing service and professional translations', 'gtranslate'); ?](https://gtranslate.io/website-translation-quote "Website Translation Price Calculator")
* php \_e('Meta data translation (keywords, page description, etc...)', 'gtranslate'); ?
* php \_e('URL/slug translation', 'gtranslate'); ?
* php \_e('Language hosting (custom domain like example.fr, example.es)', 'gtranslate'); ?
* php \_e('Seamless updates', 'gtranslate'); ?
* php \_e('Increased international traffic and AdSense revenue', 'gtranslate'); ?
* php \_e('Works in China', 'gtranslate'); ?
* php \_e('Priority Live Chat support', 'gtranslate'); ?

php \_e('Prices starting from <b$7.99/month!', 'gtranslate'); ?>

[php \_e('Try Now (15 days free)', 'gtranslate'); ?](https://gtranslate.io/?xyz=998#pricing) [php \_e('FAQ', 'gtranslate'); ?](https://gtranslate.io/?xyz=998#faq) [php \_e('Website Translation Quote', 'gtranslate'); ?](https://gtranslate.io/website-translation-quote) [php \_e('Live Chat', 'gtranslate'); ?](https://gtranslate.io/?xyz=998#contact)

### php \_e('Do you like GTranslate?', 'gtranslate'); ?

php \_e('Give us 5 stars on', 'gtranslate'); ? [WordPress.org](https://wordpress.org/support/plugin/gtranslate/reviews/?filter=5) :)

> [GTranslate](https://www.facebook.com/gtranslate)

### php \_e('Useful links', 'gtranslate'); ?

| * [php \_e('Videos', 'gtranslate'); ?](https://gtranslate.io/videos) * [php \_e('How-tos', 'gtranslate'); ?](https://docs.gtranslate.io/how-tos) * [php \_e('Blog', 'gtranslate'); ?](https://gtranslate.io/blog) * [php \_e('About GTranslate team', 'gtranslate'); ?](https://gtranslate.io/about-us) * [php \_e('FAQ', 'gtranslate'); ?](https://gtranslate.io/?xyz=998#faq) | * [php \_e('User dashboard', 'gtranslate'); ?](https://my.gtranslate.io/) * [php \_e('Compare plans', 'gtranslate'); ?](https://gtranslate.io/?xyz=998#pricing) * [php \_e('Website Translation Quote', 'gtranslate'); ?](https://gtranslate.io/website-translation-quote) * [php \_e('Reviews', 'gtranslate'); ?](https://wordpress.org/support/plugin/gtranslate/reviews/) |
| --- | --- |

### php \_e('GTranslate Tour Video', 'gtranslate'); ?

### php \_e('Live Chat', 'gtranslate'); ?

9am - 6pm (Mon - Fri) New York Time

php \_e('We are here to make your experience with GTranslate more convenient.'); ?

php
}
public static function control\_options() {
check\_admin\_referer('gtranslate-save');
$data = get\_option('GTranslate');
if(!is\_array($data))
GTranslate::load\_defaults($data);
$data['pro\_version'] = isset($\_POST['pro\_version']) ? intval($\_POST['pro\_version']) : '';
$data['enterprise\_version'] = isset($\_POST['enterprise\_version']) ? intval($\_POST['enterprise\_version']) : '';
$data['url\_translation'] = isset($\_POST['url\_translation']) ? intval($\_POST['url\_translation']) : '';
$data['add\_hreflang\_tags'] = isset($\_POST['add\_hreflang\_tags']) ? intval($\_POST['add\_hreflang\_tags']) : '';
$data['email\_translation'] = isset($\_POST['email\_translation']) ? intval($\_POST['email\_translation']) : '';
$data['email\_translation\_debug'] = isset($\_POST['email\_translation\_debug']) ? intval($\_POST['email\_translation\_debug']) : '';
$data['new\_window'] = isset($\_POST['new\_window']) ? intval($\_POST['new\_window']) : '';
$data['show\_in\_menu'] = isset($\_POST['show\_in\_menu']) ? sanitize\_text\_field($\_POST['show\_in\_menu']) : '';
$data['floating\_language\_selector'] = isset($\_POST['floating\_language\_selector']) ? sanitize\_text\_field($\_POST['floating\_language\_selector']) : 'no';
$data['native\_language\_names'] = isset($\_POST['native\_language\_names']) ? intval($\_POST['native\_language\_names']) : '';
$data['analytics'] = isset($\_POST['analytics']) ? intval($\_POST['analytics']) : '';
$data['detect\_browser\_language'] = isset($\_POST['detect\_browser\_language']) ? intval($\_POST['detect\_browser\_language']) : '';
$data['add\_new\_line'] = isset($\_POST['add\_new\_line']) ? intval($\_POST['add\_new\_line']) : '';
$data['default\_language'] = isset($\_POST['default\_language']) ? sanitize\_text\_field($\_POST['default\_language']) : 'en';
$data['translation\_method'] = 'onfly';
$data['widget\_look'] = isset($\_POST['widget\_look']) ? sanitize\_text\_field($\_POST['widget\_look']) : 'flags\_dropdown';
$data['flag\_size'] = isset($\_POST['flag\_size']) ? intval($\_POST['flag\_size']) : '16';
$data['monochrome\_flags'] = isset($\_POST['monochrome\_flags']) ? intval($\_POST['monochrome\_flags']) : '';
$data['incl\_langs'] = (isset($\_POST['incl\_langs']) and is\_array($\_POST['incl\_langs'])) ? $\_POST['incl\_langs'] : array($data['default\_language']);
$data['fincl\_langs'] = (isset($\_POST['fincl\_langs']) and is\_array($\_POST['fincl\_langs'])) ? $\_POST['fincl\_langs'] : array($data['default\_language']);
$data['alt\_flags'] = (isset($\_POST['alt\_flags']) and is\_array($\_POST['alt\_flags'])) ? $\_POST['alt\_flags'] : array();
$data['switcher\_text\_color'] = isset($\_POST['switcher\_text\_color']) ? $\_POST['switcher\_text\_color'] : '#666';
$data['switcher\_arrow\_color'] = isset($\_POST['switcher\_arrow\_color']) ? $\_POST['switcher\_arrow\_color'] : '#666';
$data['switcher\_border\_color'] = isset($\_POST['switcher\_border\_color']) ? $\_POST['switcher\_border\_color'] : '#ccc';
$data['switcher\_background\_color'] = isset($\_POST['switcher\_background\_color']) ? $\_POST['switcher\_background\_color'] : '#fff';
$data['switcher\_background\_shadow\_color'] = isset($\_POST['switcher\_background\_shadow\_color']) ? $\_POST['switcher\_background\_shadow\_color'] : '#efefef';
$data['switcher\_background\_hover\_color'] = isset($\_POST['switcher\_background\_color']) ? $\_POST['switcher\_background\_hover\_color'] : '#f0f0f0';
$data['dropdown\_text\_color'] = isset($\_POST['dropdown\_text\_color']) ? $\_POST['dropdown\_text\_color'] : '#000';
$data['dropdown\_hover\_color'] = isset($\_POST['dropdown\_hover\_color']) ? $\_POST['dropdown\_hover\_color'] : '#fff'; // #ffc
$data['dropdown\_background\_color'] = isset($\_POST['dropdown\_background\_color']) ? $\_POST['dropdown\_background\_color'] : '#eee';
$data['language\_codes'] = (isset($\_POST['language\_codes']) and !empty($\_POST['language\_codes'])) ? sanitize\_text\_field($\_POST['language\_codes']) : 'af,sq,ar,hy,az,eu,be,bg,ca,zh-CN,zh-TW,hr,cs,da,nl,en,et,tl,fi,fr,gl,ka,de,el,ht,iw,hi,hu,is,id,ga,it,ja,ko,lv,lt,mk,ms,mt,no,fa,pl,pt,ro,ru,sr,sk,sl,es,sw,sv,th,tr,uk,ur,vi,cy,yi';
$data['language\_codes2'] = (isset($\_POST['language\_codes2']) and !empty($\_POST['language\_codes2'])) ? sanitize\_text\_field($\_POST['language\_codes2']) : 'af,sq,am,ar,hy,az,eu,be,bn,bs,bg,ca,ceb,ny,zh-CN,zh-TW,co,hr,cs,da,nl,en,eo,et,tl,fi,fr,fy,gl,ka,de,el,gu,ht,ha,haw,iw,hi,hmn,hu,is,ig,id,ga,it,ja,jw,kn,kk,km,ko,ku,ky,lo,la,lv,lt,lb,mk,mg,ms,ml,mt,mi,mr,mn,my,ne,no,ps,fa,pl,pt,pa,ro,ru,sm,gd,sr,st,sn,sd,si,sk,sl,so,es,su,sw,sv,tg,ta,te,th,tr,uk,ur,uz,vi,cy,xh,yi,yo,zu';
if(isset($\_POST['use\_encoding']) and intval($\_POST['use\_encoding']) == 1)
$data['widget\_code'] = isset($\_POST['widget\_code']) ? rawurldecode(base64\_decode(stripslashes($\_POST['widget\_code']))) : '';
else
$data['widget\_code'] = isset($\_POST['widget\_code']) ? stripslashes($\_POST['widget\_code']) : '';
echo '<p style="color:red;"' . \_\_('Changes Saved', 'gtranslate') . '';
update\_option('GTranslate', $data);
if($data['pro\_version']) { // check if rewrite rules are in place
$htaccess\_file = get\_home\_path() . '.htaccess';
// todo: use insert\_with\_markers functions instead
if(is\_writeable($htaccess\_file)) {
$htaccess = file\_get\_contents($htaccess\_file);
if(strpos($htaccess, 'gtranslate.php') === false) { // no config rules
$rewrite\_rules = file\_get\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/rewrite.txt');
$rewrite\_rules = str\_replace('GTRANSLATE\_PLUGIN\_PATH', str\_replace(str\_replace(array('https:', 'http:'), array(':', ':'), home\_url()), '', str\_replace(array('https:', 'http:'), array(':', ':'), plugins\_url())) . '/gtranslate', $rewrite\_rules);
$htaccess = $rewrite\_rules . "\r\n\r\n" . $htaccess;
if(!empty($htaccess)) { // going to update .htaccess
file\_put\_contents($htaccess\_file, $htaccess);
echo '

' . \_\_('.htaccess file updated', 'gtranslate') . '

';
}
}
} else {
$rewrite\_rules = file\_get\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/rewrite.txt');
$rewrite\_rules = str\_replace('GTRANSLATE\_PLUGIN\_PATH', str\_replace(home\_url(), '', plugins\_url()) . '/gtranslate', $rewrite\_rules);
echo '

' . \_\_('Please add the following rules to the top of your .htaccess file', 'gtranslate') . '

';
echo '
```
' . $rewrite_rules . '
```
';
}
// update main\_lang in config.php
$config\_file = dirname(\_\_FILE\_\_) . '/url\_addon/config.php';
if(is\_writable($config\_file)) {
$config = file\_get\_contents($config\_file);
$config = preg\_replace('/\$main\_lang = \'[a-z-]{2,5}\'/i', '$main\_lang = \''.$data['default\_language'].'\'', $config);
file\_put\_contents($config\_file, $config);
} else {
echo '

' . \_\_('Cannot update gtranslate/url\_addon/config.php file. Make sure to update it manually and set correct $main\_lang.', 'gtranslate') . '

';
}
} else { // todo: remove rewrite rules
// do nothing
}
}
public static function load\_defaults(& $data) {
if(!is\_array($data))
$data = array();
$data['pro\_version'] = isset($data['pro\_version']) ? $data['pro\_version'] : '';
$data['enterprise\_version'] = isset($data['enterprise\_version']) ? $data['enterprise\_version'] : '';
$data['url\_translation'] = isset($data['url\_translation']) ? $data['url\_translation'] : '';
$data['add\_hreflang\_tags'] = isset($data['add\_hreflang\_tags']) ? $data['add\_hreflang\_tags'] : '';
$data['email\_translation'] = isset($data['email\_translation']) ? $data['email\_translation'] : '';
$data['email\_translation\_debug'] = isset($data['email\_translation\_debug']) ? $data['email\_translation\_debug'] : '';
$data['new\_window'] = isset($data['new\_window']) ? $data['new\_window'] : '';
$data['show\_in\_menu'] = isset($data['show\_in\_menu']) ? $data['show\_in\_menu'] : ((isset($data['show\_in\_primary\_menu']) and $data['show\_in\_primary\_menu'] == 1) ? 'primary' : '');
$data['floating\_language\_selector'] = isset($data['floating\_language\_selector']) ? $data['floating\_language\_selector'] : 'no';
$data['native\_language\_names'] = isset($data['native\_language\_names']) ? $data['native\_language\_names'] : '';
$data['analytics'] = isset($data['analytics']) ? $data['analytics'] : '';
$data['detect\_browser\_language'] = isset($data['detect\_browser\_language']) ? $data['detect\_browser\_language'] : '';
$data['add\_new\_line'] = isset($data['add\_new\_line']) ? $data['add\_new\_line'] : '1';
if(!isset($data['default\_language'])) {
$locale\_map = array('af'=>'af','am'=>'am','arq'=>'ar','ar'=>'ar','ary'=>'ar','az'=>'az','az\_TR'=>'az','azb'=>'az','bel'=>'be','bg\_BG'=>'bg','bn\_BD'=>'bn','bs\_BA'=>'bs','ca'=>'ca','bal'=>'ca','ceb'=>'ceb','co'=>'co','cs\_CZ'=>'cs','cy'=>'cy','da\_DK'=>'da','de\_DE'=>'de','de\_CH'=>'de','gsw'=>'de','el'=>'el','en\_AU'=>'en','en\_CA'=>'en','en\_NZ'=>'en','en\_ZA'=>'en','en\_GB'=>'en','eo'=>'eo','es\_AR'=>'es','es\_CL'=>'es','es\_CO'=>'es','es\_GT'=>'es','es\_MX'=>'es','es\_PE'=>'es','es\_PR'=>'es','es\_ES'=>'es','es\_VE'=>'es','et'=>'et','eu'=>'eu','fa\_IR'=>'fa','fa\_AF'=>'fa','fi'=>'fi','fr\_BE'=>'fr','fr\_CA'=>'fr','fr\_FR'=>'fr','fy'=>'fy','ga'=>'ga','gd'=>'gd','gl\_ES'=>'gl','gu'=>'gu','hau'=>'ha','haw\_US'=>'haw','hi\_IN'=>'hi','hr'=>'hr','hat'=>'ht','hu\_HU'=>'hu','hy'=>'hy','id\_ID'=>'id','is\_IS'=>'is','it\_IT'=>'it','he\_IL'=>'iw','ja'=>'ja','jv\_ID'=>'jw','ka\_GE'=>'ka','kk'=>'kk','km'=>'km','kn'=>'kn','ko\_KR'=>'ko','ckb'=>'ku','kir'=>'ky','lb\_LU'=>'lb','lo'=>'lo','lt\_LT'=>'lt','lv'=>'lv','mg\_MG'=>'mg','mri'=>'mi','mk\_MK'=>'mk','ml\_IN'=>'ml','mn'=>'mn','mr'=>'mr','ms\_MY'=>'ms','my\_MM'=>'my','ne\_NP'=>'ne','nl\_NL'=>'nl','nl\_BE'=>'nl','nb\_NO'=>'no','nn\_NO'=>'no','pa\_IN'=>'pa','pl\_PL'=>'pl','ps'=>'ps','pt\_BR'=>'pt','pt\_PT'=>'pt','ro\_RO'=>'ro','ru\_RU'=>'ru','snd'=>'sd','si\_LK'=>'si','sk\_SK'=>'sk','sl\_SI'=>'sl','so\_SO'=>'so','sq'=>'sq','sr\_RS'=>'sr','su\_ID'=>'su','sv\_SE'=>'sv','sw'=>'sw','ta\_IN'=>'ta','ta\_LK'=>'ta','te'=>'te','tg'=>'tg','th'=>'th','tr\_TR'=>'tr','uk'=>'uk','ur'=>'ur','uz\_UZ'=>'uz','vi'=>'vi','xho'=>'xh','yor'=>'yo','zh\_CN'=>'zh-CN','zh\_HK'=>'zh-CN','zh\_TW'=>'zh-TW');
$locale = get\_locale();
$data['default\_language'] = isset($locale\_map[$locale]) ? $locale\_map[$locale] : 'en';
}
$data['translation\_method'] = isset($data['translation\_method']) ? $data['translation\_method'] : 'onfly';
if($data['translation\_method'] == 'on\_fly') $data['translation\_method'] = 'redirect';
$data['widget\_look'] = isset($data['widget\_look']) ? $data['widget\_look'] : 'dropdown\_with\_flags';
$data['flag\_size'] = isset($data['flag\_size']) ? $data['flag\_size'] : '24';
$data['monochrome\_flags'] = isset($data['monochrome\_flags']) ? $data['monochrome\_flags'] : '';
$data['widget\_code'] = isset($data['widget\_code']) ? $data['widget\_code'] : '';
$data['incl\_langs'] = isset($data['incl\_langs']) ? $data['incl\_langs'] : array('en', 'es', 'it', 'pt', 'de', 'fr', 'ru', 'nl', 'ar', 'zh-CN');
$data['fincl\_langs'] = isset($data['fincl\_langs']) ? $data['fincl\_langs'] : array('en', 'es', 'it', 'pt', 'de', 'fr', 'ru', 'nl', 'ar', 'zh-CN');
$data['alt\_flags'] = isset($data['alt\_flags']) ? $data['alt\_flags'] : array();
$data['switcher\_text\_color'] = isset($data['switcher\_text\_color']) ? $data['switcher\_text\_color'] : '#666';
$data['switcher\_arrow\_color'] = isset($data['switcher\_arrow\_color']) ? $data['switcher\_arrow\_color'] : '#666';
$data['switcher\_border\_color'] = isset($data['switcher\_border\_color']) ? $data['switcher\_border\_color'] : '#ccc';
$data['switcher\_background\_color'] = isset($data['switcher\_background\_color']) ? $data['switcher\_background\_color'] : '#fff';
$data['switcher\_background\_shadow\_color'] = isset($data['switcher\_background\_shadow\_color']) ? $data['switcher\_background\_shadow\_color'] : '#efefef';
$data['switcher\_background\_hover\_color'] = isset($data['switcher\_background\_hover\_color']) ? $data['switcher\_background\_hover\_color'] : '#fff';
$data['dropdown\_text\_color'] = isset($data['dropdown\_text\_color']) ? $data['dropdown\_text\_color'] : '#000';
$data['dropdown\_hover\_color'] = isset($data['dropdown\_hover\_color']) ? $data['dropdown\_hover\_color'] : '#fff'; // #ffc
$data['dropdown\_background\_color'] = isset($data['dropdown\_background\_color']) ? $data['dropdown\_background\_color'] : '#eee';
$data['language\_codes'] = (isset($data['language\_codes']) and !empty($data['language\_codes'])) ? $data['language\_codes'] : 'af,sq,am,ar,hy,az,eu,be,bn,bs,bg,ca,ceb,ny,zh-CN,zh-TW,co,hr,cs,da,nl,en,eo,et,tl,fi,fr,fy,gl,ka,de,el,gu,ht,ha,haw,iw,hi,hmn,hu,is,ig,id,ga,it,ja,jw,kn,kk,km,ko,ku,ky,lo,la,lv,lt,lb,mk,mg,ms,ml,mt,mi,mr,mn,my,ne,no,ps,fa,pl,pt,pa,ro,ru,sm,gd,sr,st,sn,sd,si,sk,sl,so,es,su,sw,sv,tg,ta,te,th,tr,uk,ur,uz,vi,cy,xh,yi,yo,zu';
$data['language\_codes2'] = (isset($data['language\_codes2']) and !empty($data['language\_codes2'])) ? $data['language\_codes2'] : 'af,sq,am,ar,hy,az,eu,be,bn,bs,bg,ca,ceb,ny,zh-CN,zh-TW,co,hr,cs,da,nl,en,eo,et,tl,fi,fr,fy,gl,ka,de,el,gu,ht,ha,haw,iw,hi,hmn,hu,is,ig,id,ga,it,ja,jw,kn,kk,km,ko,ku,ky,lo,la,lv,lt,lb,mk,mg,ms,ml,mt,mi,mr,mn,my,ne,no,ps,fa,pl,pt,pa,ro,ru,sm,gd,sr,st,sn,sd,si,sk,sl,so,es,su,sw,sv,tg,ta,te,th,tr,uk,ur,uz,vi,cy,xh,yi,yo,zu';
// add missing languages once
if(strlen($data['language\_codes']) < strlen($data['language\_codes2']))
$data['language\_codes'] = $data['language\_codes2'];
}
}
class GTranslateWidget extends WP\_Widget {
function \_\_construct() {
parent::\_\_construct('gtranslate', esc\_html\_\_('GTranslate', 'gtranslate'), array('description' => esc\_html\_\_('GTranslate language switcher', 'gtranslate')));
}
public function widget($args, $instance) {
echo $args['before\_widget'];
if(!empty($instance['title'])) {
echo $args['before\_title'] . apply\_filters('widget\_title', $instance['title']) . $args['after\_title'];
}
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
if(empty($data['widget\_code']))
\_e('**Notice:** Please configure GTranslate from WP-Admin -> Settings -> GTranslate to see it in action.', 'gtranslate');
else
echo $data['widget\_code'];
// avoid caching issues
if($data['widget\_look'] == 'dropdown\_with\_flags' and ($data['pro\_version'] or $data['enterprise\_version'])) {
echo '';
} elseif($data['widget\_look'] == 'popup' and ($data['pro\_version'] or $data['enterprise\_version'])) {
echo '';
}
// detect browser language
if(!($data['pro\_version'] or $data['enterprise\_version']) and $data['detect\_browser\_language']) {
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$allowed\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$allowed\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$allowed\_languages = $data['incl\_langs'];
$allowed\_languages = json\_encode($allowed\_languages);
echo "";
}
echo $args['after\_widget'];
}
public function form($instance) {
$title = !empty($instance['title']) ? $instance['title'] : '';
?>

php esc\_attr\_e('Title:', 'gtranslate'); ?

php
}
public function update($new\_instance, $old\_instance) {
$instance = array();
$instance['title'] = (!empty($new\_instance['title'])) ? strip\_tags($new\_instance['title']) : '';
return $instance;
}
}
class GTranslate\_Notices {
protected $prefix = 'gtranslate';
public $notice\_spam = 0;
public $notice\_spam\_max = 3;
// Basic actions to run
public function \_\_construct() {
// Runs the admin notice ignore function incase a dismiss button has been clicked
add\_action('admin\_init', array($this, 'admin\_notice\_ignore'));
// Runs the admin notice temp ignore function incase a temp dismiss link has been clicked
add\_action('admin\_init', array($this, 'admin\_notice\_temp\_ignore'));
// Adding notices
add\_action('admin\_notices', array($this, 'gt\_admin\_notices'));
}
// Checks to ensure notices aren't disabled and the user has the correct permissions.
public function gt\_admin\_notice() {
$gt\_settings = get\_option($this-prefix . '\_admin\_notice');
if (!isset($gt\_settings['disable\_admin\_notices']) || (isset($gt\_settings['disable\_admin\_notices']) && $gt\_settings['disable\_admin\_notices'] == 0)) {
if (current\_user\_can('manage\_options')) {
return true;
}
}
return false;
}
// Primary notice function that can be called from an outside function sending necessary variables
public function admin\_notice($admin\_notices) {
// Check options
if (!$this->gt\_admin\_notice()) {
return false;
}
foreach ($admin\_notices as $slug => $admin\_notice) {
// Call for spam protection
if ($this->anti\_notice\_spam()) {
return false;
}
// Check for proper page to display on
if (isset( $admin\_notices[$slug]['pages']) and is\_array( $admin\_notices[$slug]['pages'])) {
if (!$this->admin\_notice\_pages($admin\_notices[$slug]['pages'])) {
return false;
}
}
// Check for required fields
if (!$this->required\_fields($admin\_notices[$slug])) {
// Get the current date then set start date to either passed value or current date value and add interval
$current\_date = current\_time("n/j/Y");
$start = (isset($admin\_notices[$slug]['start']) ? $admin\_notices[$slug]['start'] : $current\_date);
$start = date("n/j/Y", strtotime($start));
$end = ( isset( $admin\_notices[ $slug ]['end'] ) ? $admin\_notices[ $slug ]['end'] : $start );
$end = date( "n/j/Y", strtotime( $end ) );
$date\_array = explode('/', $start);
$interval = (isset($admin\_notices[$slug]['int']) ? $admin\_notices[$slug]['int'] : 0);
$date\_array[1] += $interval;
$start = date("n/j/Y", mktime(0, 0, 0, $date\_array[0], $date\_array[1], $date\_array[2]));
// This is the main notices storage option
$admin\_notices\_option = get\_option($this->prefix . '\_admin\_notice', array());
// Check if the message is already stored and if so just grab the key otherwise store the message and its associated date information
if (!array\_key\_exists( $slug, $admin\_notices\_option)) {
$admin\_notices\_option[$slug]['start'] = $start;
$admin\_notices\_option[$slug]['int'] = $interval;
update\_option($this->prefix . '\_admin\_notice', $admin\_notices\_option);
}
// Sanity check to ensure we have accurate information
// New date information will not overwrite old date information
$admin\_display\_check = (isset($admin\_notices\_option[$slug]['dismissed']) ? $admin\_notices\_option[$slug]['dismissed'] : 0);
$admin\_display\_start = (isset($admin\_notices\_option[$slug]['start']) ? $admin\_notices\_option[$slug]['start'] : $start);
$admin\_display\_interval = (isset($admin\_notices\_option[$slug]['int']) ? $admin\_notices\_option[$slug]['int'] : $interval);
$admin\_display\_msg = (isset($admin\_notices[$slug]['msg']) ? $admin\_notices[$slug]['msg'] : '');
$admin\_display\_title = (isset($admin\_notices[$slug]['title']) ? $admin\_notices[$slug]['title'] : '');
$admin\_display\_link = (isset($admin\_notices[$slug]['link']) ? $admin\_notices[$slug]['link'] : '');
$admin\_display\_dismissible= (isset($admin\_notices[$slug]['dismissible']) ? $admin\_notices[$slug]['dismissible'] : true);
$output\_css = false;
// Ensure the notice hasn't been hidden and that the current date is after the start date
if ($admin\_display\_check == 0 and strtotime($admin\_display\_start) <= strtotime($current\_date)) {
// Get remaining query string
$query\_str = esc\_url(add\_query\_arg($this->prefix . '\_admin\_notice\_ignore', $slug));
// Admin notice display output
echo '';
echo '';
echo '

';
echo $admin\_display\_title;
echo '

';
echo '

';
echo $admin\_display\_msg;
echo '

';
echo '

' . $admin\_display\_link . '
';
if($admin\_display\_dismissible)
echo '';
echo '';
$this->notice\_spam += 1;
$output\_css = true;
}
if ($output\_css) {
wp\_enqueue\_style($this->prefix . '-admin-notices', plugins\_url(plugin\_basename(dirname(\_\_FILE\_\_))) . '/gtranslate-notices.css', array());
}
}
}
}
// Spam protection check
public function anti\_notice\_spam() {
if ($this->notice\_spam >= $this->notice\_spam\_max) {
return true;
}
return false;
}
// Ignore function that gets ran at admin init to ensure any messages that were dismissed get marked
public function admin\_notice\_ignore() {
// If user clicks to ignore the notice, update the option to not show it again
if (isset($\_GET[$this->prefix . '\_admin\_notice\_ignore'])) {
$admin\_notices\_option = get\_option($this->prefix . '\_admin\_notice', array());
$key = $\_GET[$this->prefix . '\_admin\_notice\_ignore'];
if(!preg\_match('/^[a-z\_0-9]+$/i', $key))
return;
$admin\_notices\_option[$key]['dismissed'] = 1;
update\_option($this->prefix . '\_admin\_notice', $admin\_notices\_option);
$query\_str = remove\_query\_arg($this->prefix . '\_admin\_notice\_ignore');
wp\_redirect($query\_str);
exit;
}
}
// Temp Ignore function that gets ran at admin init to ensure any messages that were temp dismissed get their start date changed
public function admin\_notice\_temp\_ignore() {
// If user clicks to temp ignore the notice, update the option to change the start date - default interval of 14 days
if (isset($\_GET[$this->prefix . '\_admin\_notice\_temp\_ignore'])) {
$admin\_notices\_option = get\_option($this->prefix . '\_admin\_notice', array());
$current\_date = current\_time("n/j/Y");
$date\_array = explode('/', $current\_date);
$interval = (isset($\_GET['gt\_int']) ? intval($\_GET['gt\_int']) : 14);
$date\_array[1] += $interval;
$new\_start = date("n/j/Y", mktime(0, 0, 0, $date\_array[0], $date\_array[1], $date\_array[2]));
$key = $\_GET[$this->prefix . '\_admin\_notice\_temp\_ignore'];
if(!preg\_match('/^[a-z\_0-9]+$/i', $key))
return;
$admin\_notices\_option[$key]['start'] = $new\_start;
$admin\_notices\_option[$key]['dismissed'] = 0;
update\_option($this->prefix . '\_admin\_notice', $admin\_notices\_option);
$query\_str = remove\_query\_arg(array($this->prefix . '\_admin\_notice\_temp\_ignore', 'gt\_int'));
wp\_redirect( $query\_str );
exit;
}
}
public function admin\_notice\_pages($pages) {
foreach ($pages as $key => $page) {
if (is\_array($page)) {
if (isset($\_GET['page']) and $\_GET['page'] == $page[0] and isset($\_GET['tab']) and $\_GET['tab'] == $page[1]) {
return true;
}
} else {
if ($page == 'all') {
return true;
}
if (get\_current\_screen()->id === $page) {
return true;
}
if (isset($\_GET['page']) and $\_GET['page'] == $page) {
return true;
}
}
}
return false;
}
// Required fields check
public function required\_fields( $fields ) {
if (!isset( $fields['msg']) or (isset($fields['msg']) and empty($fields['msg']))) {
return true;
}
if (!isset( $fields['title']) or (isset($fields['title']) and empty($fields['title']))) {
return true;
}
return false;
}
// Special parameters function that is to be used in any extension of this class
public function special\_parameters($admin\_notices) {
// Intentionally left blank
}
public function gt\_admin\_notices() {
$deactivate\_plugins= array('WP Translator' => 'wptranslator/WPTranslator.php', 'TranslatePress' => 'translatepress-multilingual/index.php', 'Google Language Translator' => 'google-language-translator/google-language-translator.php', 'Google Website Translator' => 'google-website-translator/google-website-translator.php', 'Weglot' => 'weglot/weglot.php', 'TransPosh' => 'transposh-translation-filter-for-wordpress/transposh.php');
foreach($deactivate\_plugins as $name => $plugin\_file) {
if(is\_plugin\_active($plugin\_file)) {
$deactivate\_link = wp\_nonce\_url('plugins.php?action=deactivate&plugin='.urlencode($plugin\_file ).'&plugin\_status=all&paged=1&s=', 'deactivate-plugin\_' . $plugin\_file);
$notices['deactivate\_plugin\_'.strtolower(str\_replace(' ', '', $name))] = array(
'title' => sprintf(\_\_('Please deactivate %s plugin', 'gtranslate'), $name),
'msg' => sprintf(\_\_('%s plugin causes conflicts with GTranslate.', 'gtranslate'), $name),
'link' => '- [' . sprintf(\_\_('Deactivate %s plugin', 'gtranslate'), $name) . '](%27.%24deactivate_link.%27)
',
'dismissible' => false,
'int' => 0
);
}
}
/\*
$one\_week\_support = esc\_url(add\_query\_arg(array($this->prefix . '\_admin\_notice\_ignore' => 'one\_week\_support')));
$notices['one\_week\_support'] = array(
'title' => \_\_('Hey! How is it going?', 'gtranslate'),
'msg' => \_\_('Thank you for using GTranslate! We hope that you have found everything you need, but if you have any questions you can use our Live Chat or Forum:', 'gtranslate'),
'link' => '- [' . \_\_('Get help', 'gtranslate') . '](https://gtranslate.io/#contact)
' .
'- ['.\_\_('Check videos', 'gtranslate') . '](https://gtranslate.io/videos)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24one_week_support%20.%20%27)
',
'int' => 1
);
\*/
$two\_week\_review\_ignore = esc\_url(add\_query\_arg(array($this->prefix . '\_admin\_notice\_ignore' => 'two\_week\_review')));
$two\_week\_review\_temp = esc\_url(add\_query\_arg(array($this->prefix . '\_admin\_notice\_temp\_ignore' => 'two\_week\_review', 'gt\_int' => 6)));
$notices['two\_week\_review'] = array(
'title' => \_\_('Please Leave a Review', 'gtranslate'),
'msg' => \_\_("We hope you have enjoyed using GTranslate! Would you mind taking a few minutes to write a review on WordPress.org?
Just writing a simple **'thank you'** will make us happy!", 'gtranslate'),
'link' => '- [' . \_\_('Sure! I would love to!', 'gtranslate') . '](https://wordpress.org/support/plugin/gtranslate/reviews/?filter=5)
' .
'- [' . \_\_('I have already left a review', 'gtranslate') . '](%27%20.%20%24two_week_review_ignore%20.%20%27)
' .
'- [' . \_\_('Maybe later', 'gtranslate') . '](%27%20.%20%24two_week_review_temp%20.%20%27)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24two_week_review_ignore%20.%20%27)
',
'later\_link' => $two\_week\_review\_temp,
'int' => 5
);
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
$upgrade\_tips\_ignore = esc\_url(add\_query\_arg(array($this->prefix . '\_admin\_notice\_ignore' => 'upgrade\_tips')));
$upgrade\_tips\_temp = esc\_url(add\_query\_arg(array($this->prefix . '\_admin\_notice\_temp\_ignore' => 'upgrade\_tips', 'gt\_int' => 7)));
if($data['pro\_version'] != '1' and $data['enterprise\_version'] != '1') {
$notices['upgrade\_tips'][] = array(
'title' => \_\_('Did you know?', 'gtranslate'),
'msg' => \_\_('You can have **neural machine translations** which are human level by upgrading your GTranslate.', 'gtranslate'),
'link' => '- [' . \_\_('Learn more', 'gtranslate') . '](https://gtranslate.io/?xyz=998#pricing)
' .
'- [' . \_\_('Maybe later', 'gtranslate') . '](%27%20.%20%24upgrade_tips_temp%20.%20%27)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24upgrade_tips_ignore%20.%20%27)
',
'later\_link' => $upgrade\_tips\_temp,
'int' => 2
);
$notices['upgrade\_tips'][] = array(
'title' => \_\_('Did you know?', 'gtranslate'),
'msg' => \_\_('You can **increase** your international **traffic** by upgrading your GTranslate.', 'gtranslate'),
'link' => '- [' . \_\_('Learn more', 'gtranslate') . '](https://gtranslate.io/?xyz=998#pricing)
' .
'- [' . \_\_('Maybe later', 'gtranslate') . '](%27%20.%20%24upgrade_tips_temp%20.%20%27)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24upgrade_tips_ignore%20.%20%27)
',
'later\_link' => $upgrade\_tips\_temp,
'int' => 2
);
$notices['upgrade\_tips'][] = array(
'title' => \_\_('Did you know?', 'gtranslate'),
'msg' => \_\_('You can have your **translated pages indexed** in search engines by upgrading your GTranslate.', 'gtranslate'),
'link' => '- [' . \_\_('Learn more', 'gtranslate') . '](https://gtranslate.io/?xyz=998#pricing)
' .
'- [' . \_\_('Maybe later', 'gtranslate') . '](%27%20.%20%24upgrade_tips_temp%20.%20%27)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24upgrade_tips_ignore%20.%20%27)
',
'later\_link' => $upgrade\_tips\_temp,
'int' => 2
);
$notices['upgrade\_tips'][] = array(
'title' => \_\_('Did you know?', 'gtranslate'),
'msg' => \_\_('You can **increase** your **AdSense revenue** by upgrading your GTranslate.', 'gtranslate'),
'link' => '- [' . \_\_('Learn more', 'gtranslate') . '](https://gtranslate.io/?xyz=998#pricing)
' .
'- [' . \_\_('Maybe later', 'gtranslate') . '](%27%20.%20%24upgrade_tips_temp%20.%20%27)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24upgrade_tips_ignore%20.%20%27)
',
'later\_link' => $upgrade\_tips\_temp,
'int' => 2
);
$notices['upgrade\_tips'][] = array(
'title' => \_\_('Did you know?', 'gtranslate'),
'msg' => \_\_('You can **edit translations** by upgrading your GTranslate.', 'gtranslate'),
'link' => '- [' . \_\_('Learn more', 'gtranslate') . '](https://gtranslate.io/?xyz=998#pricing)
' .
'- [' . \_\_('Maybe later', 'gtranslate') . '](%27%20.%20%24upgrade_tips_temp%20.%20%27)
' .
'- [' . \_\_('Never show again', 'gtranslate') . '](%27%20.%20%24upgrade_tips_ignore%20.%20%27)
',
'later\_link' => $upgrade\_tips\_temp,
'int' => 2
);
shuffle($notices['upgrade\_tips']);
$notices['upgrade\_tips'] = $notices['upgrade\_tips'][0];
}
$this->admin\_notice($notices);
}
}
if(is\_admin()) {
global $pagenow;
if(!defined('DOING\_AJAX') or !DOING\_AJAX)
new GTranslate\_Notices();
}
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
if($data['pro\_version']) { // gtranslate redirect rules with PHP (for environments with no .htaccess support (pantheon, flywheel, etc.), usually .htaccess rules override this)
//@list($request\_uri, $query\_params) = explode('?', $\_SERVER['REQUEST\_URI']);
$url\_params = explode('?', $\_SERVER['REQUEST\_URI']);
$request\_uri = $url\_params[0];
if(isset($url\_params[1]))
$query\_params = $url\_params[1];
else
$query\_params = '';
if(preg\_match('/^\/(af|sq|am|ar|hy|az|eu|be|bn|bs|bg|ca|ceb|ny|zh-CN|zh-TW|co|hr|cs|da|nl|en|eo|et|tl|fi|fr|fy|gl|ka|de|el|gu|ht|ha|haw|iw|hi|hmn|hu|is|ig|id|ga|it|ja|jw|kn|kk|km|ko|ku|ky|lo|la|lv|lt|lb|mk|mg|ms|ml|mt|mi|mr|mn|my|ne|no|ps|fa|pl|pt|pa|ro|ru|sm|gd|sr|st|sn|sd|si|sk|sl|so|es|su|sw|sv|tg|ta|te|th|tr|uk|ur|uz|vi|cy|xh|yi|yo|zu)\/(af|sq|am|ar|hy|az|eu|be|bn|bs|bg|ca|ceb|ny|zh-CN|zh-TW|co|hr|cs|da|nl|en|eo|et|tl|fi|fr|fy|gl|ka|de|el|gu|ht|ha|haw|iw|hi|hmn|hu|is|ig|id|ga|it|ja|jw|kn|kk|km|ko|ku|ky|lo|la|lv|lt|lb|mk|mg|ms|ml|mt|mi|mr|mn|my|ne|no|ps|fa|pl|pt|pa|ro|ru|sm|gd|sr|st|sn|sd|si|sk|sl|so|es|su|sw|sv|tg|ta|te|th|tr|uk|ur|uz|vi|cy|xh|yi|yo|zu)\/(.\*)$/', $request\_uri, $matches)) {
header('Location: ' . '/' . $matches[1] . '/' . $matches[3] . (empty($query\_params) ? '' : '?'.$query\_params), true, 301);
exit;
} // #1 redirect double language codes /es/en/...
if(preg\_match('/^\/(af|sq|am|ar|hy|az|eu|be|bn|bs|bg|ca|ceb|ny|zh-CN|zh-TW|co|hr|cs|da|nl|en|eo|et|tl|fi|fr|fy|gl|ka|de|el|gu|ht|ha|haw|iw|hi|hmn|hu|is|ig|id|ga|it|ja|jw|kn|kk|km|ko|ku|ky|lo|la|lv|lt|lb|mk|mg|ms|ml|mt|mi|mr|mn|my|ne|no|ps|fa|pl|pt|pa|ro|ru|sm|gd|sr|st|sn|sd|si|sk|sl|so|es|su|sw|sv|tg|ta|te|th|tr|uk|ur|uz|vi|cy|xh|yi|yo|zu)$/', $request\_uri)) {
header('Location: ' . $request\_uri . '/' . (empty($query\_params) ? '' : '?'.$query\_params), true, 301);
exit;
} // #2 add trailing slash
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$allowed\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$allowed\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$allowed\_languages = $data['incl\_langs'];
$allowed\_languages = implode('|', $allowed\_languages); // ex: en|ru|it|de
if(preg\_match('/^\/('.$allowed\_languages.')\/(.\*)/', $request\_uri, $matches)) {
$\_GET['glang'] = $matches[1];
$\_GET['gurl'] = rawurldecode($matches[2]);
require\_once dirname(\_\_FILE\_\_) . '/url\_addon/gtranslate.php';
exit;
} // #3 proxy translation
}
if(!empty($data['show\_in\_menu'])) {
add\_filter('wp\_nav\_menu\_items', 'gtranslate\_menu\_item', 10, 2);
function gtranslate\_menu\_item($items, $args) {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
if($args->theme\_location == $data['show\_in\_menu']) {
if($data['widget\_look'] == 'dropdown\_with\_flags') {
$items .= '- ';
  $items .= '';
  $items .= GTranslate::get\_widget\_code(false);
  $items .= '';
  $items .= '
';
} else if($data['widget\_look'] == 'globe' or $data['widget\_look'] == 'dropdown' or $data['widget\_look'] == 'flags\_dropdown') {
$items .= '- ';
  $items .= GTranslate::get\_widget\_code(false);
  $items .= '
';
if($data['widget\_look'] == 'flags\_dropdown') {
$items .= '';
}
} else {
// optimize menu look
$html = GTranslate::get\_widget\_code(false);
$html = str\_replace('', '', $html);
$items = str\_replace('gtranslate-parent', 'gtranslate-parent menu-item-has-children', $items);
$parent\_item\_position = strpos($items, 'gtranslate-parent');
if($parent\_item\_position !== false) {
$parent\_link\_position = strpos($items, '', $parent\_item\_position);
$items = substr\_replace($items, '

'.$html.'
', $parent\_link\_position, 4);
} else {
$items .= $html;
}
}
}
return $items;
}
}
if($data['floating\_language\_selector'] != 'no' and !is\_admin()) {
add\_action('wp\_footer', 'gtranslate\_display\_floating');
function gtranslate\_display\_floating() {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
if($data['widget\_look'] == 'dropdown\_with\_flags')
$vertical\_location = 0;
else
$vertical\_location = 10;
if(is\_admin\_bar\_showing() and ($data['floating\_language\_selector'] == 'top\_left' or $data['floating\_language\_selector'] == 'top\_right' or $data['floating\_language\_selector'] == 'top\_left\_sticky' or $data['floating\_language\_selector'] == 'top\_right\_sticky'))
$vertical\_location += 32;
$vertical\_location = $vertical\_location . 'px';
switch($data['floating\_language\_selector']) {
case 'top\_left': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'top\_left\_sticky': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'top\_right': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'top\_right\_sticky': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'bottom\_left': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'bottom\_left\_sticky': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'bottom\_right': $html = ''.GTranslate::get\_widget\_code(false).''; break;
case 'bottom\_right\_sticky': $html = ''.GTranslate::get\_widget\_code(false).''; break;
default: $html = ''; break;
}
echo $html;
}
}
if($data['pro\_version'] or $data['enterprise\_version']) {
add\_action('wp\_head', 'gtranslate\_request\_uri\_var');
if(isset($\_GET['page']) and $\_GET['page'] == 'gtranslate\_options')
add\_action('admin\_head', 'gtranslate\_request\_uri\_var');
function gtranslate\_request\_uri\_var() {
echo "";
}
}
if($data['url\_translation'] and ($data['pro\_version'] or $data['enterprise\_version'])) {
add\_action('wp\_head', 'gtranslate\_url\_translation\_meta', 1);
function gtranslate\_url\_translation\_meta() {
echo '';
}
}
if($data['add\_hreflang\_tags'] and ($data['pro\_version'] or $data['enterprise\_version'])) {
add\_action('wp\_head', 'gtranslate\_add\_hreflang\_tags', 1);
function gtranslate\_add\_hreflang\_tags() {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
$enabled\_languages = array();
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$enabled\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$enabled\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$enabled\_languages = $data['incl\_langs'];
//$current\_url = wp\_get\_canonical\_url();
$current\_url = network\_home\_url(add\_query\_arg(null, null));
if($current\_url !== false) {
// adding default language
if($data['default\_language'] === 'iw')
echo ''."\n";
elseif($data['default\_language'] === 'jw')
echo ''."\n";
else
echo ''."\n";
// adding enabled languages
foreach($enabled\_languages as $lang) {
$href = '';
$domain = str\_replace('www.', '', $\_SERVER['HTTP\_HOST']);
if($data['enterprise\_version'])
$href = str\_ireplace('://' . $\_SERVER['HTTP\_HOST'], '://' . $lang . '.' . $domain, $current\_url);
elseif($data['pro\_version'])
$href = str\_ireplace('://' . $\_SERVER['HTTP\_HOST'], '://' . $\_SERVER['HTTP\_HOST'] . '/' . $lang, $current\_url);
if(!empty($href) and $lang != $data['default\_language']) {
if($lang === 'iw')
echo ''."\n";
elseif($lang === 'jw')
echo ''."\n";
else
echo ''."\n";
}
}
}
}
}
// translate WP REST API posts and categories data in JSON response
if($data['pro\_version'] or $data['enterprise\_version']) {
function gtranslate\_rest\_post($response, $post, $request) {
if(isset($response->data['content']) and is\_array($response->data['content']))
$response->data['content']['gt\_translate\_keys'] = array(array('key' => 'rendered', 'format' => 'html'));
if(isset($response->data['excerpt']) and is\_array($response->data['excerpt']))
$response->data['excerpt']['gt\_translate\_keys'] = array(array('key' => 'rendered', 'format' => 'html'));
if(isset($response->data['title']) and is\_array($response->data['title']))
$response->data['title']['gt\_translate\_keys'] = array(array('key' => 'rendered', 'format' => 'text'));
if(isset($response->data['link']))
$response->data['gt\_translate\_keys'] = array(array('key' => 'link', 'format' => 'url'));
// more fields can be added here
return $response;
}
function gtranslate\_rest\_category($response, $category, $request) {
if(isset($response->data['description']))
$response->data['gt\_translate\_keys'][] = array('key' => 'description', 'format' => 'html');
if(isset($response->data['name']))
$response->data['gt\_translate\_keys'][] = array('key' => 'name', 'format' => 'text');
if(isset($response->data['link']))
$response->data['gt\_translate\_keys'][] = array('key' => 'link', 'format' => 'url');
// more fields can be added here
return $response;
}
add\_filter('rest\_prepare\_post', 'gtranslate\_rest\_post', 10, 3);
add\_filter('rest\_prepare\_category', 'gtranslate\_rest\_category', 10, 3);
}
// auto redirect to browser language
if(($data['pro\_version'] or $data['enterprise\_version']) and $data['detect\_browser\_language'] and parse\_url($\_SERVER['REQUEST\_URI'], PHP\_URL\_PATH) == parse\_url(site\_url(), PHP\_URL\_PATH) . '/' and isset($\_SERVER['HTTP\_ACCEPT\_LANGUAGE']) and isset($\_SERVER['HTTP\_USER\_AGENT']) and !isset($\_SERVER['HTTP\_X\_GT\_LANG']) and preg\_match('/bot|spider|slurp|facebook/i', $\_SERVER['HTTP\_USER\_AGENT']) == 0) {
if($data['widget\_look'] == 'flags' or $data['widget\_look'] == 'dropdown\_with\_flags' or $data['widget\_look'] == 'flags\_name' or $data['widget\_look'] == 'flags\_code' or $data['widget\_look'] == 'popup')
$allowed\_languages = $data['fincl\_langs'];
elseif($data['widget\_look'] == 'flags\_dropdown')
$allowed\_languages = array\_values(array\_unique(array\_merge($data['fincl\_langs'], $data['incl\_langs'])));
else
$allowed\_languages = $data['incl\_langs'];
$accept\_language = strtolower(substr($\_SERVER['HTTP\_ACCEPT\_LANGUAGE'], 0, 2));
// for debug purposes only
if(isset($\_GET['gt\_auto\_switch\_to']))
$accept\_language = $\_GET['gt\_auto\_switch\_to'];
if($accept\_language == 'zh')
$accept\_language = 'zh-CN';
elseif($accept\_language == 'he')
$accept\_language = 'iw';
if($accept\_language != $data['default\_language'] and in\_array($accept\_language, $allowed\_languages) and !isset($\_COOKIE['gt\_auto\_switch'])) {
// set cookie for 30 days and redirect
setcookie('gt\_auto\_switch', 1, time() + 2592000);
if($data['pro\_version'])
header('Location: ' . home\_url() . '/' . $accept\_language . '/');
if($data['enterprise\_version'] and isset($\_SERVER['HTTP\_HOST']))
header('Location: ' . str\_replace('://'.$\_SERVER['HTTP\_HOST'], '://'.$accept\_language.'.'.preg\_replace('/^www\./', '', $\_SERVER['HTTP\_HOST']), site\_url()));
// todo: special redirect for language hosting
exit;
}
}
// convert wp\_localize\_script format into JSON + JS parser
if($data['pro\_version'] or $data['enterprise\_version']) {
function gtranslate\_filter\_l10n\_scripts() {
global $wp\_scripts;
$translate\_handles = array(
'agile-store-locator-script',
'wmc-wizard',
'wc-address-i18n',
'wc-checkout',
'wc-country-select',
'wc-add-to-cart',
'wc-password-strength-meter',
'googlecode\_regular',
'googlecode\_property',
'googlecode\_contact',
'mapfunctions',
'myhome-min',
);
//echo '';
//return;
foreach($wp\_scripts->registered as $handle => $script) {
if(isset($script->extra['data']) and in\_array($handle, $translate\_handles)) {
$l10n = $script->extra['data'];
preg\_match\_all('/var (.+) = ({(.\*)});/', $l10n, $matches);
//echo '';
if(isset($matches[1]) and isset($matches[2])) {
$vars = $matches[1];
$scripts = $matches[2];
} else
continue;
foreach($vars as $i => $var\_name) {
$attribute\_ids = $wp\_scripts->get\_data($handle, 'attribute-ids');
$attribute\_ids[] = $var\_name . '-gt-l10n-'.$i;
$jsons = $wp\_scripts->get\_data($handle, 'jsons');
$jsons[] = $scripts[$i];
$jss = $wp\_scripts->get\_data($handle, 'jss');
$jss[] = "var $var\_name = JSON.parse(document.getElementById('$var\_name-gt-l10n-$i').innerHTML);";
$wp\_scripts->add\_data($handle, 'attribute-ids', $attribute\_ids);
$wp\_scripts->add\_data($handle, 'jsons', $jsons);
$wp\_scripts->add\_data($handle, 'jss', $jss);
}
unset($wp\_scripts->registered[$handle]->extra['data']);
}
}
//echo '';
}
function gtranslate\_add\_script\_attributes($tag, $handle) {
global $wp\_scripts;
gtranslate\_filter\_l10n\_scripts();
if(isset($wp\_scripts->registered[$handle]->extra['attribute-ids'])) {
$attribute\_ids = $wp\_scripts->get\_data($handle, 'attribute-ids');
$jsons = $wp\_scripts->get\_data($handle, 'jsons');
$jss = $wp\_scripts->get\_data($handle, 'jss');
$return = '';
foreach($attribute\_ids as $i => $attribute\_id) {
$json = $jsons[$i];
$js = $jss[$i];
$return .= "\n\n";
}
return $return . $tag;
}
return $tag;
}
// filter for woocommerce script params
function gt\_filter\_woocommerce\_scripts\_data($data, $handle) {
switch($handle) {
case 'wc-address-i18n': {
$data['gt\_translate\_keys'] = array(
array('key' => 'locale', 'format' => 'json'),
'i18n\_required\_text',
'i18n\_optional\_text',
);
$locale = json\_decode($data['locale']);
if(isset($locale->default->address\_1))
$locale->default->address\_1->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->address\_2))
$locale->default->address\_2->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->city))
$locale->default->city->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->postcode))
$locale->default->postcode->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->state))
$locale->default->state->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->shipping->address\_1))
$locale->default->shipping->address\_1->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->shipping->address\_2))
$locale->default->shipping->address\_2->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->shipping->city))
$locale->default->shipping->city->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->shipping->postcode))
$locale->default->shipping->postcode->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->shipping->state))
$locale->default->shipping->state->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->billing->address\_1))
$locale->default->billing->address\_1->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->billing->address\_2))
$locale->default->billing->address\_2->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->billing->city))
$locale->default->billing->city->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->billing->postcode))
$locale->default->billing->postcode->gt\_translate\_keys = array('label', 'placeholder');
if(isset($locale->default->billing->state))
$locale->default->billing->state->gt\_translate\_keys = array('label', 'placeholder');
$data['locale'] = json\_encode($locale);
} break;
case 'wc-checkout': {
$data['gt\_translate\_keys'] = array('i18n\_checkout\_error');
} break;
case 'wc-country-select': {
$data['gt\_translate\_keys'] = array('i18n\_ajax\_error', 'i18n\_input\_too\_long\_1', 'i18n\_input\_too\_long\_n', 'i18n\_input\_too\_short\_1', 'i18n\_input\_too\_short\_n', 'i18n\_load\_more', 'i18n\_no\_matches', 'i18n\_searching', 'i18n\_select\_state\_text', 'i18n\_selection\_too\_long\_1', 'i18n\_selection\_too\_long\_n');
} break;
case 'wc-add-to-cart': {
$data['gt\_translate\_keys'] = array('i18n\_view\_cart', array('key' => 'cart\_url', 'format' => 'url'));
} break;
case 'wc-password-strength-meter': {
$data['gt\_translate\_keys'] = array('i18n\_password\_error', 'i18n\_password\_hint', '');
} break;
default: break;
}
return $data;
}
function gt\_woocommerce\_geolocate\_ip($false) {
if(isset($\_SERVER['HTTP\_X\_GT\_VIEWER\_IP']))
$\_SERVER['HTTP\_X\_REAL\_IP'] = $\_SERVER['HTTP\_X\_GT\_VIEWER\_IP'];
elseif(isset($\_SERVER['HTTP\_X\_GT\_CLIENTIP']))
$\_SERVER['HTTP\_X\_REAL\_IP'] = $\_SERVER['HTTP\_X\_GT\_CLIENTIP'];
return $false;
}
//add\_action('wp\_print\_scripts', 'gtranslate\_filter\_l10n\_scripts', 1);
//add\_action('wp\_print\_header\_scripts', 'gtranslate\_filter\_l10n\_scripts', 1);
//add\_action('wp\_print\_footer\_scripts', 'gtranslate\_filter\_l10n\_scripts', 1);
add\_filter('script\_loader\_tag', 'gtranslate\_add\_script\_attributes', 100, 2);
add\_filter('woocommerce\_get\_script\_data', 'gt\_filter\_woocommerce\_scripts\_data', 10, 2 );
add\_filter('woocommerce\_geolocate\_ip', 'gt\_woocommerce\_geolocate\_ip', 10, 4);
// translate emails
if($data['email\_translation']) {
function gt\_translate\_emails($args) {
$subject = $args['subject'];
$message = $args['message'];
if(function\_exists('curl\_init') and isset($\_SERVER['HTTP\_X\_GT\_LANG'])) {
//file\_put\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', date('Y-m-d H:i:s') . " - $subject$message\n", FILE\_APPEND);
// translate woocommerce
if(strpos($message, 'woocommerce') !== false) {
$data = get\_option('GTranslate');
GTranslate::load\_defaults($data);
include dirname(\_\_FILE\_\_) . '/url\_addon/config.php';
$server\_id = intval(substr(md5(preg\_replace('/^www\./', '', $\_SERVER['HTTP\_HOST'])), 0, 5), 16) % count($servers);
$server = $servers[$server\_id];
$host = $\_SERVER['HTTP\_X\_GT\_LANG'] . '.' . preg\_replace('/^www\./', '', $\_SERVER['HTTP\_HOST']);
$protocol = ((isset($\_SERVER['HTTPS']) and ($\_SERVER['HTTPS'] == 'on' or $\_SERVER['HTTPS'] == 1)) or (isset($\_SERVER['HTTP\_X\_FORWARDED\_PROTO']) and $\_SERVER['HTTP\_X\_FORWARDED\_PROTO'] == 'https')) ? 'https' : 'http';
$headers = array();
$headers[] = 'Host: ' . $host;
// add real visitor IP header
if(isset($\_SERVER['HTTP\_CLIENT\_IP']) and !empty($\_SERVER['HTTP\_CLIENT\_IP']))
$viewer\_ip\_address = $\_SERVER['HTTP\_CLIENT\_IP'];
if(isset($\_SERVER['HTTP\_CF\_CONNECTING\_IP']) and !empty($\_SERVER['HTTP\_CF\_CONNECTING\_IP']))
$viewer\_ip\_address = $\_SERVER['HTTP\_CF\_CONNECTING\_IP'];
if(isset($\_SERVER['HTTP\_X\_SUCURI\_CLIENTIP']) and !empty($\_SERVER['HTTP\_X\_SUCURI\_CLIENTIP']))
$viewer\_ip\_address = $\_SERVER['HTTP\_X\_SUCURI\_CLIENTIP'];
if(!isset($viewer\_ip\_address))
$viewer\_ip\_address = $\_SERVER['REMOTE\_ADDR'];
$headers[] = 'X-GT-Viewer-IP: ' . $viewer\_ip\_address;
$headers[] = 'User-Agent: GTranslate-Email-Translate';
// add X-Forwarded-For
if(isset($\_SERVER['HTTP\_X\_FORWARDED\_FOR']) and !empty($\_SERVER['HTTP\_X\_FORWARDED\_FOR']))
$headers[] = 'X-GT-Forwarded-For: ' . $\_SERVER['HTTP\_X\_FORWARDED\_FOR'];
$ch = curl\_init();
curl\_setopt($ch, CURLOPT\_URL, $protocol.'://'.$server.'.tdn.gtranslate.net'.wp\_make\_link\_relative(plugins\_url('gtranslate/url\_addon/gtranslate-email.php').'?glang='.$\_SERVER['HTTP\_X\_GT\_LANG']));
curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers);
curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true);
curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, true);
curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 2);
if(defined('CURL\_IPRESOLVE\_V4')) curl\_setopt($ch, CURLOPT\_IPRESOLVE, CURL\_IPRESOLVE\_V4);
curl\_setopt($ch, CURLOPT\_CAINFO, dirname(\_\_FILE\_\_) . '/url\_addon/cacert.pem');
curl\_setopt($ch, CURLOPT\_POST, 1);
curl\_setopt($ch, CURLOPT\_POSTFIELDS, array('body' => do\_shortcode("$subject$message"), 'access\_key' => md5(substr(NONCE\_SALT, 0, 10) . substr(NONCE\_KEY, 0, 5))));
if($data['email\_translation\_debug']) {
$fh = fopen(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', 'a');
curl\_setopt($ch, CURLOPT\_VERBOSE, true);
curl\_setopt($ch, CURLOPT\_STDERR, $fh);
}
$response = curl\_exec($ch);
$response\_info = curl\_getinfo($ch);
curl\_close($ch);
if($data['email\_translation\_debug']) {
file\_put\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', 'Response: ' . $response . "\n", FILE\_APPEND);
file\_put\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', 'Response\_info: ' . print\_r($response\_info, true) . "\n", FILE\_APPEND);
}
if(isset($response\_info['http\_code']) and $response\_info['http\_code'] == 200) {
if($data['pro\_version'])
$response = str\_ireplace($host, $\_SERVER['HTTP\_HOST'] . '/' . $\_SERVER['HTTP\_X\_GT\_LANG'], $response);
preg\_match\_all('/(.\*?)<\/subject>(.\*?)<\/message>/s', $response, $matches);
//file\_put\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', 'Matches: ' . print\_r($matches, true) . "\n", FILE\_APPEND);
if(isset($matches[1][0], $matches[2][0])) {
$subject = $matches[1][0];
$message = $matches[2][0];
if($data['email\_translation\_debug']) {
file\_put\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', 'Translated Subject: ' . $subject . "\n", FILE\_APPEND);
file\_put\_contents(dirname(\_\_FILE\_\_) . '/url\_addon/debug.txt', 'Translated Message: ' . $message . "\n", FILE\_APPEND);
}
$args['subject'] = $subject;
$args['message'] = $message;
}
}
}
}
return $args;
}
add\_filter('wp\_mail', 'gt\_translate\_emails', 10000, 1);
}
}
if($data['enterprise\_version']) {
// solve wp\_get\_referer issue
function gt\_allowed\_redirect\_hosts($hosts) {
$gt\_hosts = array();
if(isset($\_SERVER['HTTP\_X\_GT\_LANG']))
$gt\_hosts[] = $\_SERVER['HTTP\_X\_GT\_LANG'] . '.' . str\_replace('www.', '', $\_SERVER['HTTP\_HOST']);
return array\_merge($hosts, $gt\_hosts);
}
add\_filter('allowed\_redirect\_hosts', 'gt\_allowed\_redirect\_hosts');
}
