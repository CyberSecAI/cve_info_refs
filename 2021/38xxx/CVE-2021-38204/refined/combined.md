=== Content from lists.debian.org_75ba9c65_20250115_094839.html ===


---

[[Date Prev](msg00011.html)][[Date Next](msg00013.html)]
[[Thread Prev](msg00011.html)][[Thread Next](msg00013.html)]
[[Date Index](maillist.html#00012)]
[[Thread Index](threads.html#00012)]

# [SECURITY] [DLA 2843-1] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 2843-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Thu, 16 Dec 2021 22:27:40 +0100
* *Message-id*: <[[🔎]](/msgid-search/YbuvTLjOg3K0RE4J%40decadent.org.uk) [YbuvTLjOg3K0RE4J@decadent.org.uk](msg00012.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-2843-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
December 16, 2021                             <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux
Version        : 4.9.290-1
CVE ID         : CVE-2020-3702 CVE-2020-16119 CVE-2021-0920 CVE-2021-3612
                 CVE-2021-3653 CVE-2021-3655 CVE-2021-3679 CVE-2021-3732
                 CVE-2021-3753 CVE-2021-3760 CVE-2021-20317 CVE-2021-20321
                 CVE-2021-20322 CVE-2021-22543 CVE-2021-37159 CVE-2021-38160
                 CVE-2021-38198 CVE-2021-38199 CVE-2021-38204 CVE-2021-38205
                 CVE-2021-40490 CVE-2021-41864 CVE-2021-42008 CVE-2021-42739
                 CVE-2021-43389

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service, or information
leaks.

CVE-2020-3702

    A flaw was found in the driver for Atheros IEEE 802.11n family of
    chipsets (ath9k) allowing information disclosure.

CVE-2020-16119

    Hadar Manor reported a use-after-free in the DCCP protocol
    implementation in the Linux kernel. A local attacker can take
    advantage of this flaw to cause a denial of service or potentially
    to execute arbitrary code.

CVE-2021-0920

    A race condition was discovered in the local sockets (AF_UNIX)
    subsystem, which could lead to a use-after-free.  A local user
    could exploit this for denial of service (memory corruption or
    crash), or possibly for privilege escalation.

CVE-2021-3612

    Murray McAllister reported a flaw in the joystick input subsystem.
    A local user permitted to access a joystick device could exploit
    this to read and write out-of-bounds in the kernel, which could
    be used for privilege escalation.

CVE-2021-3653

   Maxim Levitsky discovered a vulnerability in the KVM hypervisor
   implementation for AMD processors in the Linux kernel: Missing
   validation of the `int_ctl` VMCB field could allow a malicious L1
   guest to enable AVIC support (Advanced Virtual Interrupt
   Controller) for the L2 guest. The L2 guest can take advantage of
   this flaw to write to a limited but still relatively large subset
   of the host physical memory.

CVE-2021-3655

    Ilja Van Sprundel and Marcelo Ricardo Leitner found multiple flaws
    in the SCTP implementation, where missing validation could lead to
    an out-of-bounds read.  On a system using SCTP, a networked
    attacker could exploit these to cause a denial of service (crash).

CVE-2021-3679

    A flaw in the Linux kernel tracing module functionality could
    allow a privileged local user (with CAP_SYS_ADMIN capability) to
    cause a denial of service (resource starvation).

CVE-2021-3732

    Alois Wohlschlager reported a flaw in the implementation of the
    overlayfs subsystem, allowing a local attacker with privileges to
    mount a filesystem to reveal files hidden in the original mount.

CVE-2021-3753

    Minh Yuan reported a race condition in the vt_k_ioctl in
    drivers/tty/vt/vt_ioctl.c, which may cause an out of bounds read
    in vt.

CVE-2021-3760

    Lin Horse reported a flaw in the NCI (NFC Controller Interface)
    driver, which could lead to a use-after-free.

    However, this driver is not included in the binary packages
    provided by Debian.

CVE-2021-20317

    It was discovered that the timer queue structure could become
    corrupt, leading to waiting tasks never being woken up.  A local
    user with certain privileges could exploit this to cause a denial
    of service (system hang).

CVE-2021-20321

    A race condition was discovered in the overlayfs filesystem
    driver.  A local user with access to an overlayfs mount and to its
    underlying upper directory could exploit this for privilege
    escalation.

CVE-2021-20322

    An information leak was discovered in the IPv4 implementation.  A
    remote attacker could exploit this to quickly discover which UDP
    ports a system is using, making it easier for them to carry out a
    DNS poisoning attack against that system.

CVE-2021-22543

    David Stevens discovered a flaw in how the KVM hypervisor maps
    host memory into a guest.  A local user permitted to access
    /dev/kvm could use this to cause certain pages to be freed when
    they should not, leading to a use-after-free.  This could be used
    to cause a denial of service (crash or memory corruption) or
    possibly for privilege escalation.

CVE-2021-37159

    A flaw was discovered in the hso driver for Option mobile
    broadband modems.  An error during initialisation could lead to a
    double-free or use-after-free.  An attacker able to plug in USB
    devices could use this to cause a denial of service (crash or
    memory corruption) or possibly to run arbitrary code.

CVE-2021-38160

    A flaw in the virtio_console was discovered allowing data
    corruption or data loss by an untrusted device.

CVE-2021-38198

    A flaw was discovered in the KVM implementation for x86
    processors, that could result in virtual memory protection within
    a guest not being applied correctly.  When shadow page tables are
    used - i.e. for nested virtualisation, or on CPUs lacking the EPT
    or NPT feature - a user of the guest OS might be able to exploit
    this for denial of service or privilege escalation within the
    guest.

CVE-2021-38199

    Michael Wakabayashi reported a flaw in the NFSv4 client
    implementation, where incorrect connection setup ordering allows
    operations of a remote NFSv4 server to cause a denial of service.

CVE-2021-38204

    A flaw was discovered in the max4321-hcd USB host controller
    driver, which could lead to a use-after-free.

    However, this driver is not included in the binary packages
    provided by Debian.

CVE-2021-38205

    An information leak was discovered in the xilinx_emaclite network
    driver.  On a custom kernel where this driver is enabled and used,
    this might make it easier to exploit other kernel bugs.

CVE-2021-40490

    A race condition was discovered in the ext4 subsystem when writing
    to an inline_data file while its xattrs are changing. This could
    result in denial of service.

CVE-2021-41864

    An integer overflow was discovered in the Extended BPF (eBPF)
    subsystem.  A local user could exploit this for denial of service
    (memory corruption or crash), or possibly for privilege
    escalation.

    This can be mitigated by setting sysctl
    kernel.unprivileged_bpf_disabled=1, which disables eBPF use by
    unprivileged users.

CVE-2021-42008

    A heap buffer overflow was discovered in the 6pack serial port
    network driver.  A local user with CAP_NET_ADMIN capability could
    exploit this for denial of service (memory corruption or crash), or
    possibly for privilege escalation.

CVE-2021-42739

    A heap buffer overflow was discovered in the firedtv driver for
    FireWire-connected DVB receivers.  A local user with access to a
    firedtv device could exploit this for denial of service (memory
    corruption or crash), or possibly for privilege escalation.

CVE-2021-43389

    The Active Defense Lab of Venustech discovered a flaw in the CMTP
    subsystem as used by Bluetooth, which could lead to an
    out-of-bounds read and object type confusion.  A local user with
    CAP_NET_ADMIN capability in the initial user namespace could
    exploit this for denial of service (memory corruption or crash),
    or possibly for privilege escalation.

For Debian 9 stretch, these problems have been fixed in version
4.9.290-1.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings
Humans are not rational beings; they are rationalising beings.

```

**Attachment:
[signature.asc](pgpYxpTbjLb4O.pgp)**

*Description:* PGP signature

---



=== Content from cdn.kernel.org_229c8584_20250115_094838.html ===
commit 6fdb13a7e573640853c481ddabf7a192fff42bba
Author: Greg Kroah-Hartman
Date: Wed Jul 28 14:37:42 2021 +0200
Linux 5.13.6
Link: https://lore.kernel.org/r/20210726153846.245305071@linuxfoundation.org
Tested-by: Justin M. Forbes
Tested-by: Florian Fainelli
Tested-by: Shuah Khan
Link: https://lore.kernel.org/r/20210726165238.919699741@linuxfoundation.org
Tested-by: Linux Kernel Functional Testing
Tested-by: Jon Hunter
Tested-by: Guenter Roeck
Tested-by: Florian Fainelli
Signed-off-by: Greg Kroah-Hartman
commit 2db604ff60dd8a4747c10a17fd56ec829b06c3a2
Author: Florian Fainelli
Date: Wed Jul 7 21:10:51 2021 -0700
skbuff: Fix build with SKB extensions disabled
commit 9615fe36b31d926f1c5107013b772dc226a6a7ca upstream.
We will fail to build with CONFIG\_SKB\_EXTENSIONS disabled after
8550ff8d8c75 ("skbuff: Release nfct refcount on napi stolen or re-used
skbs") since there is an unconditionally use of skb\_ext\_find() without
an appropriate stub. Simply build the code conditionally and properly
guard against both COFNIG\_SKB\_EXTENSIONS as well as
CONFIG\_NET\_TC\_SKB\_EXT being disabled.
Fixes: Fixes: 8550ff8d8c75 ("skbuff: Release nfct refcount on napi stolen or re-used skbs")
Signed-off-by: Florian Fainelli
Reviewed-by: Roi Dayan
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 429826249d801235140b0e779308c2c9e9705d5a
Author: Íñigo Huguet
Date: Tue Jul 13 16:21:28 2021 +0200
sfc: ensure correct number of XDP queues
[ Upstream commit 788bc000d4c2f25232db19ab3a0add0ba4e27671 ]
Commit 99ba0ea616aa ("sfc: adjust efx->xdp\_tx\_queue\_count with the real
number of initialized queues") intended to fix a problem caused by a
round up when calculating the number of XDP channels and queues.
However, this was not the real problem. The real problem was that the
number of XDP TX queues had been reduced to half in
commit e26ca4b53582 ("sfc: reduce the number of requested xdp ev queues"),
but the variable xdp\_tx\_queue\_count had remained the same.
Once the correct number of XDP TX queues is created again in the
previous patch of this series, this also can be reverted since the error
doesn't actually exist.
Only in the case that there is a bug in the code we can have different
values in xdp\_queue\_number and efx->xdp\_tx\_queue\_count. Because of this,
and per Edward Cree's suggestion, I add instead a WARN\_ON to catch if it
happens again in the future.
Note that the number of allocated queues can be higher than the number
of used ones due to the round up, as explained in the existing comment
in the code. That's why we also have to stop increasing xdp\_queue\_number
beyond efx->xdp\_tx\_queue\_count.
Signed-off-by: Íñigo Huguet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b1ea64337fde1a3ee2e98a20c9b83ac9b3fda17c
Author: Yoshitaka Ikeda
Date: Fri Jul 16 14:35:13 2021 +0000
spi: spi-cadence-quadspi: Fix division by zero warning - try2
commit 0e85ee897858b1c7a5de53f496d016899d9639c5 upstream.
Fix below division by zero warning:
- The reason for dividing by zero is because the dummy bus width is zero,
but if the dummy n bytes is zero, it indicates that there is no data transfer,
so we can just return zero without doing any calculations.
[ 0.795337] Division by zero in kernel.
:
[ 0.834051] [<807fd40c>] (\_\_div0) from [<804e1acc>] (Ldiv0+0x8/0x10)
[ 0.839097] [<805f0710>] (cqspi\_exec\_mem\_op) from [<805edb4c>] (spi\_mem\_exec\_op+0x3b0/0x3f8)
Fixes: 7512eaf54190 ("spi: cadence-quadspi: Fix dummy cycle calculation when buswidth > 1")
Signed-off-by: Yoshitaka Ikeda
Reviewed-by: Pratyush Yadav
Link: https://lore.kernel.org/r/92eea403-9b21-2488-9cc1-664bee760c5e@nskint.co.jp
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit c4443564f8f6e8a1570780c945f53b1aa1bb159d
Author: Colin Xu
Date: Wed Jul 7 08:45:31 2021 +0800
drm/i915/gvt: Clear d3\_entered on elsp cmd submission.
commit c90b4503ccf42d9d367e843c223df44aa550e82a upstream.
d3\_entered flag is used to mark for vgpu\_reset a previous power
transition from D3->D0, typically for VM resume from S3, so that gvt
could skip PPGTT invalidation in current vgpu\_reset during resuming.
In case S0ix exit, although there is D3->D0, guest driver continue to
use vgpu as normal, with d3\_entered set, until next shutdown/reboot or
power transition.
If a reboot follows a S0ix exit, device power state transite as:
D0->D3->D0->D0(reboot), while system power state transites as:
S0->S0 (reboot). There is no vgpu\_reset until D0(reboot), thus
d3\_entered won't be cleared, the vgpu\_reset will skip PPGTT invalidation
however those PPGTT entries are no longer valid. Err appears like:
gvt: vgpu 2: vfio\_pin\_pages failed for gfn 0xxxxx, ret -22
gvt: vgpu 2: fail: spt xxxx guest entry 0xxxxx type 2
gvt: vgpu 2: fail: shadow page xxxx guest entry 0xxxxx type 2.
Give gvt a chance to clear d3\_entered on elsp cmd submission so that the
states before & after S0ix enter/exit are consistent.
Fixes: ba25d977571e ("drm/i915/gvt: Do not destroy ppgtt\_mm during vGPU D3->D0.")
Reviewed-by: Zhenyu Wang
Signed-off-by: Colin Xu
Signed-off-by: Zhenyu Wang
Link: http://patchwork.freedesktop.org/patch/msgid/20210707004531.4873-1-colin.xu@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 9bad2eae08e227d7c3a7cbe5c73b1cc18ef25260
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:15 2021 +0200
perf inject: Close inject.output on exit
commit 02e6246f5364d5260a6ea6f92ab6f409058b162f upstream.
ASan reports a memory leak when running:
# perf test "83: Zstd perf.data compression/decompression"
which happens inside 'perf inject'.
The bug is caused by inject.output never being closed.
This patch adds the missing perf\_data\_\_close().
Signed-off-by: Riccardo Mancini
Fixes: 6ef81c55a2b6584c ("perf session: Return error code for perf\_session\_\_new() function on failure")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mamatha Inamdar
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/c06f682afa964687367cf6e92a64ceb49aec76a5.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 5cf3d397fcf63488866b019c84e5e193ae299f25
Author: Mark Rutland
Date: Thu Jul 15 13:30:49 2021 +0100
arm64: entry: fix KCOV suppression
commit e6f85cbeb23bd74b8966cf1f15bf7d01399ff625 upstream.
We suppress KCOV for entry.o rather than entry-common.o. As entry.o is
built from entry.S, this is pointless, and permits instrumentation of
entry-common.o, which is built from entry-common.c.
Fix the Makefile to suppress KCOV for entry-common.o, as we had intended
to begin with. I've verified with objdump that this is working as
expected.
Fixes: bf6fa2c0dda7 ("arm64: entry: don't instrument entry code with KCOV")
Signed-off-by: Mark Rutland
Cc: Catalin Marinas
Cc: James Morse
Cc: Marc Zyngier
Cc: Will Deacon
Link: https://lore.kernel.org/r/20210715123049.9990-1-mark.rutland@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 12b4399333021a6f4c8a9e6e61f552f47e20d1f8
Author: Robert Richter
Date: Thu Jul 15 11:26:02 2021 +0200
Documentation: Fix intiramfs script name
commit 5e60f363b38fd40e4d8838b5d6f4d4ecee92c777 upstream.
Documentation was not changed when renaming the script in commit
80e715a06c2d ("initramfs: rename gen\_initramfs\_list.sh to
gen\_initramfs.sh"). Fixing this.
Basically does:
$ sed -i -e s/gen\_initramfs\_list.sh/gen\_initramfs.sh/g $(git grep -l gen\_initramfs\_list.sh)
Fixes: 80e715a06c2d ("initramfs: rename gen\_initramfs\_list.sh to gen\_initramfs.sh")
Signed-off-by: Robert Richter
Signed-off-by: Masahiro Yamada
Signed-off-by: Greg Kroah-Hartman
commit 337deea6460da584d44725dd5b16b08a03e1c550
Author: Stefan Wahren
Date: Sat Jul 10 13:04:55 2021 +0200
ARM: multi\_v7\_defconfig: Make NOP\_USB\_XCEIV driver built-in
commit ab37a7a890c1176144a4c66ff3d51ef2c20ed486 upstream.
The usage of usb-nop-xceiv PHY on Raspberry Pi boards with BCM283x has
been a "regression source" a lot of times. The last case is breakage of
USB mass storage boot has been commit e590474768f1 ("driver core: Set
fw\_devlink=on by default") for multi\_v7\_defconfig. As long as
NOP\_USB\_XCEIV is configured as module, the dwc2 USB driver defer probing
endlessly and prevent booting from USB mass storage device. So make
the driver built-in as in bcm2835\_defconfig and arm64/defconfig.
Fixes: e590474768f1 ("driver core: Set fw\_devlink=on by default")
Reported-by: Ojaswin Mujoo
Signed-off-by: Stefan Wahren
Link: https://lore.kernel.org/r/1625915095-23077-1-git-send-email-stefan.wahren@i2se.com'
Signed-off-by: Arnd Bergmann
Signed-off-by: Greg Kroah-Hartman
commit a5fd9d3d35bc0d1b2c8db722c0bd7ce8d08d9d7a
Author: Paul Blakey
Date: Mon Jul 5 13:54:51 2021 +0300
skbuff: Release nfct refcount on napi stolen or re-used skbs
commit 8550ff8d8c75416e984d9c4b082845e57e560984 upstream.
When multiple SKBs are merged to a new skb under napi GRO,
or SKB is re-used by napi, if nfct was set for them in the
driver, it will not be released while freeing their stolen
head state or on re-use.
Release nfct on napi's stolen or re-used SKBs, and
in gro\_list\_prepare, check conntrack metadata diff.
Fixes: 5c6b94604744 ("net/mlx5e: CT: Handle misses after executing CT action")
Reviewed-by: Roi Dayan
Signed-off-by: Paul Blakey
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8f738d2d51cf50411609942ccffb8b69ba61f799
Author: Matthieu Baerts
Date: Fri Jun 25 14:25:22 2021 -0700
mptcp: fix 'masking a bool' warning
commit c4512c63b1193c73b3f09c598a6d0a7f88da1dd8 upstream.
Dan Carpenter reported an issue introduced in
commit fde56eea01f9 ("mptcp: refine mptcp\_cleanup\_rbuf") where a new
boolean (ack\_pending) is masked with 0x9.
This is not the intention to ignore values by using a boolean. This
variable should not have a 'bool' type: we should keep the 'u8' to allow
this comparison.
Fixes: fde56eea01f9 ("mptcp: refine mptcp\_cleanup\_rbuf")
Reported-by: Dan Carpenter
Signed-off-by: Matthieu Baerts
Signed-off-by: Mat Martineau
Acked-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ecc9318db5ffa96902cfccebff00d5ba080b3366
Author: Mahesh Bandewar
Date: Fri Jul 16 16:09:41 2021 -0700
bonding: fix build issue
commit 5b69874f74cc5707edd95fcdaa757c507ac8af0f upstream.
The commit 9a5605505d9c (" bonding: Add struct bond\_ipesc to manage SA") is causing
following build error when XFRM is not selected in kernel config.
lld: error: undefined symbol: xfrm\_dev\_state\_flush
>>> referenced by bond\_main.c:3453 (drivers/net/bonding/bond\_main.c:3453)
>>> net/bonding/bond\_main.o:(bond\_netdev\_event) in archive drivers/built-in.a
Fixes: 9a5605505d9c (" bonding: Add struct bond\_ipesc to manage SA")
Signed-off-by: Mahesh Bandewar
CC: Taehee Yoo
CC: Jay Vosburgh
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit da510a38cb609390e581cbc68994621021fd6797
Author: Yoshitaka Ikeda
Date: Fri Jul 16 14:33:12 2021 +0000
spi: spi-cadence-quadspi: Revert "Fix division by zero warning"
commit 0ccfd1ba84a4503b509250941af149e9ebd605ca upstream.
Revert to change to a better code.
This reverts commit 55cef88bbf12f3bfbe5c2379a8868a034707e755.
Signed-off-by: Yoshitaka Ikeda
Link: https://lore.kernel.org/r/bd30bdb4-07c4-f713-5648-01c898d51f1b@nskint.co.jp
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit bc93e9909cc8f8c23d5f2f09c52dc3bacec50d74
Author: Likun Gao
Date: Thu Jul 15 11:08:48 2021 +0800
drm/amdgpu: update golden setting for sienna\_cichlid
commit 3e94b5965e624f7e6d8dd18eb8f3bf2bb99ba30d upstream.
Update GFX golden setting for sienna\_cichlid.
Signed-off-by: Likun Gao
Reviewed-by: Hawking Zhang
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 52ee22ce8af269e8fab7bf3d29bc162ac99b52e0
Author: Xiaojian Du
Date: Wed Jul 14 15:07:22 2021 +0800
drm/amdgpu: update the golden setting for vangogh
commit 4fff6fbca12524358a32e56f125ae738141f62b4 upstream.
This patch is to update the golden setting for vangogh.
Signed-off-by: Xiaojian Du
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 72097f7beefdf3bcf0800d3e08bceb2dab31dd12
Author: Tao Zhou
Date: Thu Jul 15 14:49:08 2021 +0800
drm/amdgpu: update gc golden setting for dimgrey\_cavefish
commit cfe4e8f00f8f19ba305800f64962d1949ab5d4ca upstream.
Update gc\_10\_3\_4 golden setting.
Signed-off-by: Tao Zhou
Reviewed-by: Guchun Chen
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 75ab00b813e4b6372c8da582363d872c2b9c2a4b
Author: Charles Baylis
Date: Fri Jul 16 17:43:12 2021 +0100
drm: Return -ENOTTY for non-drm ioctls
commit 3abab27c322e0f2acf981595aa8040c9164dc9fb upstream.
drm: Return -ENOTTY for non-drm ioctls
Return -ENOTTY from drm\_ioctl() when userspace passes in a cmd number
which doesn't relate to the drm subsystem.
Glibc uses the TCGETS ioctl to implement isatty(), and without this
change isatty() returns it incorrectly returns true for drm devices.
To test run this command:
$ if [ -t 0 ]; then echo is a tty; fi < /dev/dri/card0
which shows "is a tty" without this patch.
This may also modify memory which the userspace application is not
expecting.
Signed-off-by: Charles Baylis
Cc: stable@vger.kernel.org
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/YPG3IBlzaMhfPqCr@stando.fishzet.co.uk
Signed-off-by: Greg Kroah-Hartman
commit c9d31f7d17e43eb02571f20bbc3959c388467eb8
Author: Adrian Hunter
Date: Fri Jul 16 14:44:07 2021 +0300
driver core: Prevent warning when removing a device link from unregistered consumer
commit e64daad660a0c9ace3acdc57099fffe5ed83f977 upstream.
sysfs\_remove\_link() causes a warning if the parent directory does not
exist. That can happen if the device link consumer has not been registered.
So do not attempt sysfs\_remove\_link() in that case.
Fixes: 287905e68dd29 ("driver core: Expose device link details in sysfs")
Signed-off-by: Adrian Hunter
Cc: stable@vger.kernel.org # 5.9+
Reviewed-by: Rafael J. Wysocki
Link: https://lore.kernel.org/r/20210716114408.17320-2-adrian.hunter@intel.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 9d06d3d2a16d009bfbf1025ca6732f900b79f468
Author: Greg Kroah-Hartman
Date: Tue Jun 29 12:40:24 2021 +0200
nds32: fix up stack guard gap
commit c453db6cd96418c79702eaf38259002755ab23ff upstream.
Commit 1be7107fbe18 ("mm: larger stack guard gap, between vmas") fixed
up all architectures to deal with the stack guard gap. But when nds32
was added to the tree, it forgot to do the same thing.
Resolve this by properly fixing up the nsd32's version of
arch\_get\_unmapped\_area()
Cc: Nick Hu
Cc: Greentime Hu
Cc: Vincent Chen
Cc: Michal Hocko
Cc: Hugh Dickins
Cc: Qiang Liu
Cc: stable
Reported-by: iLifetruth
Acked-by: Hugh Dickins
Link: https://lore.kernel.org/r/20210629104024.2293615-1-gregkh@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 7544d21b40147f34adbff5fba07527a9e3ac8d4e
Author: Jérôme Glisse
Date: Thu Jul 1 08:28:25 2021 -0700
misc: eeprom: at24: Always append device id even if label property is set.
commit c36748ac545421d94a5091c754414c0f3664bf10 upstream.
We need to append device id even if eeprom have a label property set as some
platform can have multiple eeproms with same label and we can not register
each of those with same label. Failing to register those eeproms trigger
cascade failures on such platform (system is no longer working).
This fix regression on such platform introduced with 4e302c3b568e
Reported-by: Alexander Fomichev
Fixes: 4e302c3b568e ("misc: eeprom: at24: fix NVMEM name with custom AT24 device name")
Cc: stable@vger.kernel.org
Signed-off-by: Jérôme Glisse
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 6ef92931cc5bf7fcc4d7702cb975fdd817c51eb9
Author: Ilya Dryomov
Date: Sat Jul 3 11:56:55 2021 +0200
rbd: always kick acquire on "acquired" and "released" notifications
commit 8798d070d416d18a75770fc19787e96705073f43 upstream.
Skipping the "lock has been released" notification if the lock owner
is not what we expect based on owner\_cid can lead to I/O hangs.
One example is our own notifications: because owner\_cid is cleared
in rbd\_unlock(), when we get our own notification it is processed as
unexpected/duplicate and maybe\_kick\_acquire() isn't called. If a peer
that requested the lock then doesn't go through with acquiring it,
I/O requests that came in while the lock was being quiesced would
be stalled until another I/O request is submitted and kicks acquire
from rbd\_img\_exclusive\_lock().
This makes the comment in rbd\_release\_lock() actually true: prior to
this change the canceled work was being requeued in response to the
"lock has been acquired" notification from rbd\_handle\_acquired\_lock().
Cc: stable@vger.kernel.org # 5.3+
Signed-off-by: Ilya Dryomov
Tested-by: Robin Geuze
Signed-off-by: Greg Kroah-Hartman
commit 8b334d74fbbd1c7dbdf18dffbf589169954a54a0
Author: Ilya Dryomov
Date: Sat Jul 3 11:31:26 2021 +0200
rbd: don't hold lock\_rwsem while running\_list is being drained
commit ed9eb71085ecb7ded9a5118cec2ab70667cc7350 upstream.
Currently rbd\_quiesce\_lock() holds lock\_rwsem for read while blocking
on releasing\_wait completion. On the I/O completion side, each image
request also needs to take lock\_rwsem for read. Because rw\_semaphore
implementation doesn't allow new readers after a writer has indicated
interest in the lock, this can result in a deadlock if something that
needs to take lock\_rwsem for write gets involved. For example:
1. watch error occurs
2. rbd\_watch\_errcb() takes lock\_rwsem for write, clears owner\_cid and
releases lock\_rwsem
3. after reestablishing the watch, rbd\_reregister\_watch() takes
lock\_rwsem for write and calls rbd\_reacquire\_lock()
4. rbd\_quiesce\_lock() downgrades lock\_rwsem to for read and blocks on
releasing\_wait until running\_list becomes empty
5. another watch error occurs
6. rbd\_watch\_errcb() blocks trying to take lock\_rwsem for write
7. no in-flight image request can complete and delete itself from
running\_list because lock\_rwsem won't be granted anymore
A similar scenario can occur with "lock has been acquired" and "lock
has been released" notification handers which also take lock\_rwsem for
write to update owner\_cid.
We don't actually get anything useful from sitting on lock\_rwsem in
rbd\_quiesce\_lock() -- owner\_cid updates certainly don't need to be
synchronized with. In fact the whole owner\_cid tracking logic could
probably be removed from the kernel client because we don't support
proxied maintenance operations.
Cc: stable@vger.kernel.org # 5.3+
URL: https://tracker.ceph.com/issues/42757
Signed-off-by: Ilya Dryomov
Tested-by: Robin Geuze
Signed-off-by: Greg Kroah-Hartman
commit 79da14fac0b5fbf0b2810c47b103f29ff9e16f97
Author: Mike Kravetz
Date: Fri Jul 23 15:50:44 2021 -0700
hugetlbfs: fix mount mode command line processing
commit e0f7e2b2f7e7864238a4eea05cc77ae1be2bf784 upstream.
In commit 32021982a324 ("hugetlbfs: Convert to fs\_context") processing
of the mount mode string was changed from match\_octal() to fsparam\_u32.
This changed existing behavior as match\_octal does not require octal
values to have a '0' prefix, but fsparam\_u32 does.
Use fsparam\_u32oct which provides the same behavior as match\_octal.
Link: https://lkml.kernel.org/r/20210721183326.102716-1-mike.kravetz@oracle.com
Fixes: 32021982a324 ("hugetlbfs: Convert to fs\_context")
Signed-off-by: Mike Kravetz
Reported-by: Dennis Camera
Reviewed-by: Matthew Wilcox (Oracle)
Cc: David Howells
Cc: Al Viro
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4861f6d3b90f81b4c5e3817c9092885962b369bc
Author: Qi Zheng
Date: Fri Jul 23 15:50:41 2021 -0700
mm: fix the deadlock in finish\_fault()
commit e4dc3489143f84f7ed30be58b886bb6772f229b9 upstream.
Commit 63f3655f9501 ("mm, memcg: fix reclaim deadlock with writeback")
fix the following ABBA deadlock by pre-allocating the pte page table
without holding the page lock.
lock\_page(A)
SetPageWriteback(A)
unlock\_page(A)
lock\_page(B)
lock\_page(B)
pte\_alloc\_one
shrink\_page\_list
wait\_on\_page\_writeback(A)
SetPageWriteback(B)
unlock\_page(B)
# flush A, B to clear the writeback
Commit f9ce0be71d1f ("mm: Cleanup faultaround and finish\_fault()
codepaths") reworked the relevant code but ignored this race. This will
cause the deadlock above to appear again, so fix it.
Link: https://lkml.kernel.org/r/20210721074849.57004-1-zhengqi.arch@bytedance.com
Fixes: f9ce0be71d1f ("mm: Cleanup faultaround and finish\_fault() codepaths")
Signed-off-by: Qi Zheng
Acked-by: Kirill A. Shutemov
Cc: Thomas Gleixner
Cc: Johannes Weiner
Cc: Michal Hocko
Cc: Vladimir Davydov
Cc: Muchun Song
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5d4b4d2e3c8d5bc3bf62f94a594cd02ca7e7b65c
Author: Mike Rapoport
Date: Fri Jul 23 15:50:26 2021 -0700
memblock: make for\_each\_mem\_range() traverse MEMBLOCK\_HOTPLUG regions
commit 79e482e9c3ae86e849c701c846592e72baddda5a upstream.
Commit b10d6bca8720 ("arch, drivers: replace for\_each\_membock() with
for\_each\_mem\_range()") didn't take into account that when there is
movable\_node parameter in the kernel command line, for\_each\_mem\_range()
would skip ranges marked with MEMBLOCK\_HOTPLUG.
The page table setup code in POWER uses for\_each\_mem\_range() to create
the linear mapping of the physical memory and since the regions marked
as MEMORY\_HOTPLUG are skipped, they never make it to the linear map.
A later access to the memory in those ranges will fail:
BUG: Unable to handle kernel data access on write at 0xc000000400000000
Faulting instruction address: 0xc00000000008a3c0
Oops: Kernel access of bad area, sig: 11 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in:
CPU: 0 PID: 53 Comm: kworker/u2:0 Not tainted 5.13.0 #7
NIP: c00000000008a3c0 LR: c0000000003c1ed8 CTR: 0000000000000040
REGS: c000000008a57770 TRAP: 0300 Not tainted (5.13.0)
MSR: 8000000002009033  CR: 84222202 XER: 20040000
CFAR: c0000000003c1ed4 DAR: c000000400000000 DSISR: 42000000 IRQMASK: 0
GPR00: c0000000003c1ed8 c000000008a57a10 c0000000019da700 c000000400000000
GPR04: 0000000000000280 0000000000000180 0000000000000400 0000000000000200
GPR08: 0000000000000100 0000000000000080 0000000000000040 0000000000000300
GPR12: 0000000000000380 c000000001bc0000 c0000000001660c8 c000000006337e00
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: 0000000040000000 0000000020000000 c000000001a81990 c000000008c30000
GPR24: c000000008c20000 c000000001a81998 000fffffffff0000 c000000001a819a0
GPR28: c000000001a81908 c00c000001000000 c000000008c40000 c000000008a64680
NIP clear\_user\_page+0x50/0x80
LR \_\_handle\_mm\_fault+0xc88/0x1910
Call Trace:
\_\_handle\_mm\_fault+0xc44/0x1910 (unreliable)
handle\_mm\_fault+0x130/0x2a0
\_\_get\_user\_pages+0x248/0x610
\_\_get\_user\_pages\_remote+0x12c/0x3e0
get\_arg\_page+0x54/0xf0
copy\_string\_kernel+0x11c/0x210
kernel\_execve+0x16c/0x220
call\_usermodehelper\_exec\_async+0x1b0/0x2f0
ret\_from\_kernel\_thread+0x5c/0x70
Instruction dump:
79280fa4 79271764 79261f24 794ae8e2 7ca94214 7d683a14 7c893a14 7d893050
7d4903a6 60000000 60000000 60000000 <7c001fec> 7c091fec 7c081fec 7c051fec
---[ end trace 490b8c67e6075e09 ]---
Making for\_each\_mem\_range() include MEMBLOCK\_HOTPLUG regions in the
traversal fixes this issue.
Link: https://bugzilla.redhat.com/show\_bug.cgi?id=1976100
Link: https://lkml.kernel.org/r/20210712071132.20902-1-rppt@kernel.org
Fixes: b10d6bca8720 ("arch, drivers: replace for\_each\_membock() with for\_each\_mem\_range()")
Signed-off-by: Mike Rapoport
Tested-by: Greg Kurz
Reviewed-by: David Hildenbrand
Cc:  [5.10+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0e88a5bee0f585889cc0d6e634930bf82a5db0dd
Author: Sergei Trofimovich
Date: Fri Jul 23 15:50:23 2021 -0700
mm: page\_alloc: fix page\_poison=1 / INIT\_ON\_ALLOC\_DEFAULT\_ON interaction
commit 69e5d322a2fb86173fde8bad26e8eb38cad1b1e9 upstream.
To reproduce the failure we need the following system:
- kernel command: page\_poison=1 init\_on\_free=0 init\_on\_alloc=0
- kernel config:
\* CONFIG\_INIT\_ON\_ALLOC\_DEFAULT\_ON=y
\* CONFIG\_INIT\_ON\_FREE\_DEFAULT\_ON=y
\* CONFIG\_PAGE\_POISONING=y
Resulting in:
0000000085629bdd: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
0000000022861832: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00000000c597f5b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
CPU: 11 PID: 15195 Comm: bash Kdump: loaded Tainted: G U O 5.13.1-gentoo-x86\_64 #1
Hardware name: System manufacturer System Product Name/PRIME Z370-A, BIOS 2801 01/13/2021
Call Trace:
dump\_stack+0x64/0x7c
\_\_kernel\_unpoison\_pages.cold+0x48/0x84
post\_alloc\_hook+0x60/0xa0
get\_page\_from\_freelist+0xdb8/0x1000
\_\_alloc\_pages+0x163/0x2b0
\_\_get\_free\_pages+0xc/0x30
pgd\_alloc+0x2e/0x1a0
mm\_init+0x185/0x270
dup\_mm+0x6b/0x4f0
copy\_process+0x190d/0x1b10
kernel\_clone+0xba/0x3b0
\_\_do\_sys\_clone+0x8f/0xb0
do\_syscall\_64+0x68/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Before commit 51cba1ebc60d ("init\_on\_alloc: Optimize static branches")
init\_on\_alloc never enabled static branch by default. It could only be
enabed explicitly by init\_mem\_debugging\_and\_hardening().
But after commit 51cba1ebc60d, a static branch could already be enabled
by default. There was no code to ever disable it. That caused
page\_poison=1 / init\_on\_free=1 conflict.
This change extends init\_mem\_debugging\_and\_hardening() to also disable
static branch disabling.
Link: https://lkml.kernel.org/r/20210714031935.4094114-1-keescook@chromium.org
Link: https://lore.kernel.org/r/20210712215816.1512739-1-slyfox@gentoo.org
Fixes: 51cba1ebc60d ("init\_on\_alloc: Optimize static branches")
Signed-off-by: Sergei Trofimovich
Signed-off-by: Kees Cook
Co-developed-by: Kees Cook
Reported-by: Mikhail Morfikov
Reported-by:
Tested-by:
Reviewed-by: David Hildenbrand
Cc: Alexander Potapenko
Cc: Thomas Gleixner
Cc: Vlastimil Babka
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ee791f0bba88799396463e38b6877e66bc160c52
Author: Christoph Hellwig
Date: Fri Jul 23 15:50:17 2021 -0700
mm: call flush\_dcache\_page() in memcpy\_to\_page() and memzero\_page()
commit 8dad53a11f8d94dceb540a5f8f153484f42be84b upstream.
memcpy\_to\_page and memzero\_page can write to arbitrary pages, which
could be in the page cache or in high memory, so call
flush\_kernel\_dcache\_pages to flush the dcache.
This is a problem when using these helpers on dcache challeneged
architectures. Right now there are just a few users, chances are no one
used the PC floppy driver, the aha1542 driver for an ISA SCSI HBA, and a
few advanced and optional btrfs and ext4 features on those platforms yet
since the conversion.
Link: https://lkml.kernel.org/r/20210713055231.137602-2-hch@lst.de
Fixes: bb90d4bc7b6a ("mm/highmem: Lift memcpy\_[to|from]\_page to core")
Fixes: 28961998f858 ("iov\_iter: lift memzero\_page() to highmem.h")
Signed-off-by: Christoph Hellwig
Reviewed-by: Ira Weiny
Cc: Chaitanya Kulkarni
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5040926bc22d8cee69a494aad60278a27042adc6
Author: Alexander Potapenko
Date: Fri Jul 23 15:50:14 2021 -0700
kfence: skip all GFP\_ZONEMASK allocations
commit 236e9f1538523d3d380dda1cc99571d587058f37 upstream.
Allocation requests outside ZONE\_NORMAL (MOVABLE, HIGHMEM or DMA) cannot
be fulfilled by KFENCE, because KFENCE memory pool is located in a zone
different from the requested one.
Because callers of kmem\_cache\_alloc() may actually rely on the
allocation to reside in the requested zone (e.g. memory allocations
done with \_\_GFP\_DMA must be DMAable), skip all allocations done with
GFP\_ZONEMASK and/or respective SLAB flags (SLAB\_CACHE\_DMA and
SLAB\_CACHE\_DMA32).
Link: https://lkml.kernel.org/r/20210714092222.1890268-2-glider@google.com
Fixes: 0ce20dd84089 ("mm: add Kernel Electric-Fence infrastructure")
Signed-off-by: Alexander Potapenko
Reviewed-by: Marco Elver
Acked-by: Souptick Joarder
Cc: Dmitry Vyukov
Cc: Greg Kroah-Hartman
Cc: Souptick Joarder
Cc:  [5.12+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit e9adaed2f12647998fa6eb694aa096c6f79fe507
Author: Alexander Potapenko
Date: Fri Jul 23 15:50:11 2021 -0700
kfence: move the size check to the beginning of \_\_kfence\_alloc()
commit 235a85cb32bb123854ad31de46fdbf04c1d57cda upstream.
Check the allocation size before toggling kfence\_allocation\_gate.
This way allocations that can't be served by KFENCE will not result in
waiting for another CONFIG\_KFENCE\_SAMPLE\_INTERVAL without allocating
anything.
Link: https://lkml.kernel.org/r/20210714092222.1890268-1-glider@google.com
Signed-off-by: Alexander Potapenko
Suggested-by: Marco Elver
Reviewed-by: Marco Elver
Cc: Dmitry Vyukov
Cc: Marco Elver
Cc: Greg Kroah-Hartman
Cc:  [5.12+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 60e7f63de337296f1da05da08e142021fd4cf6a4
Author: Peter Collingbourne
Date: Fri Jul 23 15:50:01 2021 -0700
userfaultfd: do not untag user pointers
commit e71e2ace5721a8b921dca18b045069e7bb411277 upstream.
Patch series "userfaultfd: do not untag user pointers", v5.
If a user program uses userfaultfd on ranges of heap memory, it may end
up passing a tagged pointer to the kernel in the range.start field of
the UFFDIO\_REGISTER ioctl. This can happen when using an MTE-capable
allocator, or on Android if using the Tagged Pointers feature for MTE
readiness [1].
When a fault subsequently occurs, the tag is stripped from the fault
address returned to the application in the fault.address field of struct
uffd\_msg. However, from the application's perspective, the tagged
address \*is\* the memory address, so if the application is unaware of
memory tags, it may get confused by receiving an address that is, from
its point of view, outside of the bounds of the allocation. We observed
this behavior in the kselftest for userfaultfd [2] but other
applications could have the same problem.
Address this by not untagging pointers passed to the userfaultfd ioctls.
Instead, let the system call fail. Also change the kselftest to use
mmap so that it doesn't encounter this problem.
[1] https://source.android.com/devices/tech/debug/tagged-pointers
[2] tools/testing/selftests/vm/userfaultfd.c
This patch (of 2):
Do not untag pointers passed to the userfaultfd ioctls. Instead, let
the system call fail. This will provide an early indication of problems
with tag-unaware userspace code instead of letting the code get confused
later, and is consistent with how we decided to handle brk/mmap/mremap
in commit dcde237319e6 ("mm: Avoid creating virtual address aliases in
brk()/mmap()/mremap()"), as well as being consistent with the existing
tagged address ABI documentation relating to how ioctl arguments are
handled.
The code change is a revert of commit 7d0325749a6c ("userfaultfd: untag
user pointers") plus some fixups to some additional calls to
validate\_range that have appeared since then.
[1] https://source.android.com/devices/tech/debug/tagged-pointers
[2] tools/testing/selftests/vm/userfaultfd.c
Link: https://lkml.kernel.org/r/20210714195437.118982-1-pcc@google.com
Link: https://lkml.kernel.org/r/20210714195437.118982-2-pcc@google.com
Link: https://linux-review.googlesource.com/id/I761aa9f0344454c482b83fcfcce547db0a25501b
Fixes: 63f0c6037965 ("arm64: Introduce prctl() options to control the tagged user addresses ABI")
Signed-off-by: Peter Collingbourne
Reviewed-by: Andrey Konovalov
Reviewed-by: Catalin Marinas
Cc: Alistair Delva
Cc: Andrea Arcangeli
Cc: Dave Martin
Cc: Evgenii Stepanov
Cc: Lokesh Gidra
Cc: Mitch Phillips
Cc: Vincenzo Frascino
Cc: Will Deacon
Cc: William McVicker
Cc:  [5.4]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit a6ead78130ad6b3eadaaa5811be1ddaf1f6ec405
Author: Jens Axboe
Date: Thu Jul 22 17:08:07 2021 -0600
io\_uring: fix early fdput() of file
commit 0cc936f74bcacb039b7533aeac0a887dfc896bf6 upstream.
A previous commit shuffled some code around, and inadvertently used
struct file after fdput() had been called on it. As we can't touch
the file post fdput() dropping our reference, move the fdput() to
after that has been done.
Cc: Pavel Begunkov
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/io-uring/YPnqM0fY3nM5RdRI@zeniv-ca.linux.org.uk/
Fixes: f2a48dd09b8e ("io\_uring: refactor io\_sq\_offload\_create()")
Reported-by: Al Viro
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 81cebadedc37c7b961382e90eca487d2c7bf75f7
Author: Pavel Begunkov
Date: Tue Jul 20 10:50:44 2021 +0100
io\_uring: remove double poll entry on arm failure
commit 46fee9ab02cb24979bbe07631fc3ae95ae08aa3e upstream.
\_\_io\_queue\_proc() can enqueue both poll entries and still fail
afterwards, so the callers trying to cancel it should also try to remove
the second poll entry (if any).
For example, it may leave the request alive referencing a io\_uring
context but not accessible for cancellation:
[ 282.599913][ T1620] task:iou-sqp-23145 state:D stack:28720 pid:23155 ppid: 8844 flags:0x00004004
[ 282.609927][ T1620] Call Trace:
[ 282.613711][ T1620] \_\_schedule+0x93a/0x26f0
[ 282.634647][ T1620] schedule+0xd3/0x270
[ 282.638874][ T1620] io\_uring\_cancel\_generic+0x54d/0x890
[ 282.660346][ T1620] io\_sq\_thread+0xaac/0x1250
[ 282.696394][ T1620] ret\_from\_fork+0x1f/0x30
Cc: stable@vger.kernel.org
Fixes: 18bceab101add ("io\_uring: allow POLL\_ADD with double poll\_wait() users")
Reported-and-tested-by: syzbot+ac957324022b7132accf@syzkaller.appspotmail.com
Signed-off-by: Pavel Begunkov
Link: https://lore.kernel.org/r/0ec1228fc5eda4cb524eeda857da8efdc43c331c.1626774457.git.asml.silence@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 0d80ae099a495e011a993666df017141d7d67cdc
Author: Pavel Begunkov
Date: Tue Jul 20 10:50:43 2021 +0100
io\_uring: explicitly count entries for poll reqs
commit 68b11e8b1562986c134764433af64e97d30c9fc0 upstream.
If \_\_io\_queue\_proc() fails to add a second poll entry, e.g. kmalloc()
failed, but it goes on with a third waitqueue, it may succeed and
overwrite the error status. Count the number of poll entries we added,
so we can set pt->error to zero at the beginning and find out when the
mentioned scenario happens.
Cc: stable@vger.kernel.org
Fixes: 18bceab101add ("io\_uring: allow POLL\_ADD with double poll\_wait() users")
Signed-off-by: Pavel Begunkov
Link: https://lore.kernel.org/r/9d6b9e561f88bcc0163623b74a76c39f712151c3.1626774457.git.asml.silence@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 2f13b6fece9a2d75f0dad816b3ae778e452034b8
Author: Peter Collingbourne
Date: Fri Jul 23 15:50:04 2021 -0700
selftest: use mmap instead of posix\_memalign to allocate memory
commit 0db282ba2c12c1515d490d14a1ff696643ab0f1b upstream.
This test passes pointers obtained from anon\_allocate\_area to the
userfaultfd and mremap APIs. This causes a problem if the system
allocator returns tagged pointers because with the tagged address ABI
the kernel rejects tagged addresses passed to these APIs, which would
end up causing the test to fail. To make this test compatible with such
system allocators, stop using the system allocator to allocate memory in
anon\_allocate\_area, and instead just use mmap.
Link: https://lkml.kernel.org/r/20210714195437.118982-3-pcc@google.com
Link: https://linux-review.googlesource.com/id/Icac91064fcd923f77a83e8e133f8631c5b8fc241
Fixes: c47174fc362a ("userfaultfd: selftest")
Co-developed-by: Lokesh Gidra
Signed-off-by: Lokesh Gidra
Signed-off-by: Peter Collingbourne
Reviewed-by: Catalin Marinas
Cc: Vincenzo Frascino
Cc: Dave Martin
Cc: Will Deacon
Cc: Andrea Arcangeli
Cc: Alistair Delva
Cc: William McVicker
Cc: Evgenii Stepanov
Cc: Mitch Phillips
Cc: Andrey Konovalov
Cc:  [5.4]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit fae0c4bb0366f618e2e241e2ce79f707d24f483a
Author: Frederic Weisbecker
Date: Thu Jun 3 01:15:59 2021 +0200
posix-cpu-timers: Fix rearm racing against process tick
commit 1a3402d93c73bf6bb4df6d7c2aac35abfc3c50e2 upstream.
Since the process wide cputime counter is started locklessly from
posix\_cpu\_timer\_rearm(), it can be concurrently stopped by operations
on other timers from the same thread group, such as in the following
unlucky scenario:
CPU 0 CPU 1
----- -----
timer\_settime(TIMER B)
posix\_cpu\_timer\_rearm(TIMER A)
cpu\_clock\_sample\_group()
(pct->timers\_active already true)
handle\_posix\_cpu\_timers()
check\_process\_timers()
stop\_process\_timers()
pct->timers\_active = false
arm\_timer(TIMER A)
tick -> run\_posix\_cpu\_timers()
// sees !pct->timers\_active, ignore
// our TIMER A
Fix this with simply locking process wide cputime counting start and
timer arm in the same block.
Acked-by: Peter Zijlstra (Intel)
Signed-off-by: Frederic Weisbecker
Fixes: 60f2ceaa8111 ("posix-cpu-timers: Remove unnecessary locking around cpu\_clock\_sample\_group")
Cc: stable@vger.kernel.org
Cc: Oleg Nesterov
Cc: Thomas Gleixner
Cc: Ingo Molnar
Cc: Eric W. Biederman
Signed-off-by: Greg Kroah-Hartman
commit 52db60a983d2da3a037f2000e22301d40e125bec
Author: Loic Poulain
Date: Fri Jul 16 13:21:06 2021 +0530
bus: mhi: pci\_generic: Fix inbound IPCR channel
commit b8a97f2a65388394f433bf0730293a94f7d49046 upstream.
The qrtr-mhi client driver assumes that inbound buffers are
automatically allocated and queued by the MHI core, but this
doesn't happen for mhi pci devices since IPCR inbound channel is
not flagged with auto\_queue, causing unusable IPCR (qrtr)
feature. Fix that.
Link: https://lore.kernel.org/r/1625736749-24947-1-git-send-email-loic.poulain@linaro.org
[mani: fixed a spelling mistake in commit description]
Fixes: 855a70c12021 ("bus: mhi: Add MHI PCI support for WWAN modems")
Cc: stable@vger.kernel.org #5.10
Reviewed-by: Hemant kumar
Reviewed-by: Manivannan Sadhasivam
Signed-off-by: Loic Poulain
Signed-off-by: Manivannan Sadhasivam
Link: https://lore.kernel.org/r/20210716075106.49938-4-manivannan.sadhasivam@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit aed4f5b51aba41e2afd7cfda20a0571a6a67dfe9
Author: Bhaumik Bhatt
Date: Fri Jul 16 13:21:05 2021 +0530
bus: mhi: core: Validate channel ID when processing command completions
commit 546362a9ef2ef40b57c6605f14e88ced507f8dd0 upstream.
MHI reads the channel ID from the event ring element sent by the
device which can be any value between 0 and 255. In order to
prevent any out of bound accesses, add a check against the maximum
number of channels supported by the controller and those channels
not configured yet so as to skip processing of that event ring
element.
Link: https://lore.kernel.org/r/1624558141-11045-1-git-send-email-bbhatt@codeaurora.org
Fixes: 1d3173a3bae7 ("bus: mhi: core: Add support for processing events from client device")
Cc: stable@vger.kernel.org #5.10
Reviewed-by: Hemant Kumar
Reviewed-by: Manivannan Sadhasivam
Reviewed-by: Jeffrey Hugo
Signed-off-by: Bhaumik Bhatt
Signed-off-by: Manivannan Sadhasivam
Link: https://lore.kernel.org/r/20210716075106.49938-3-manivannan.sadhasivam@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit a88270680663c6ca74c77d072fc52f264762ac42
Author: Bhaumik Bhatt
Date: Fri Jul 16 13:21:04 2021 +0530
bus: mhi: pci\_generic: Apply no-op for wake using sideband wake boolean
commit 56f6f4c4eb2a710ec8878dd9373d3d2b2eb75f5c upstream.
Devices such as SDX24 do not have the provision for inband wake
doorbell in the form of channel 127 and instead have a sideband
GPIO for it. Newer devices such as SDX55 or SDX65 support inband
wake method by default. Ensure the functionality is used based on
this such that device wake stays held when a client driver uses
mhi\_device\_get() API or the equivalent debugfs entry.
Link: https://lore.kernel.org/r/1624560809-30610-1-git-send-email-bbhatt@codeaurora.org
Fixes: e3e5e6508fc1 ("bus: mhi: pci\_generic: No-Op for device\_wake operations")
Cc: stable@vger.kernel.org #5.12
Reviewed-by: Manivannan Sadhasivam
Signed-off-by: Bhaumik Bhatt
Signed-off-by: Manivannan Sadhasivam
Link: https://lore.kernel.org/r/20210716075106.49938-2-manivannan.sadhasivam@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit ce5b3de58fc21303722df46551f7eb9a91afb409
Author: Peter Ujfalusi
Date: Tue Jul 13 12:34:38 2021 +0300
driver core: auxiliary bus: Fix memory leak when driver\_register() fail
commit 4afa0c22eed33cfe0c590742387f0d16f32412f3 upstream.
If driver\_register() returns with error we need to free the memory
allocated for auxdrv->driver.name before returning from
\_\_auxiliary\_driver\_register()
Fixes: 7de3697e9cbd4 ("Add auxiliary bus support")
Reviewed-by: Dan Williams
Cc: stable
Signed-off-by: Peter Ujfalusi
Link: https://lore.kernel.org/r/20210713093438.3173-1-peter.ujfalusi@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 423123e428a1773f81332307af9cdcad1b74cef7
Author: Markus Boehme
Date: Tue Jul 20 16:26:19 2021 -0700
ixgbe: Fix packet corruption due to missing DMA sync
commit 09cfae9f13d51700b0fecf591dcd658fc5375428 upstream.
When receiving a packet with multiple fragments, hardware may still
touch the first fragment until the entire packet has been received. The
driver therefore keeps the first fragment mapped for DMA until end of
packet has been asserted, and delays its dma\_sync call until then.
The driver tries to fit multiple receive buffers on one page. When using
3K receive buffers (e.g. using Jumbo frames and legacy-rx is turned
off/build\_skb is being used) on an architecture with 4K pages, the
driver allocates an order 1 compound page and uses one page per receive
buffer. To determine the correct offset for a delayed DMA sync of the
first fragment of a multi-fragment packet, the driver then cannot just
use PAGE\_MASK on the DMA address but has to construct a mask based on
the actual size of the backing page.
Using PAGE\_MASK in the 3K RX buffer/4K page architecture configuration
will always sync the first page of a compound page. With the SWIOTLB
enabled this can lead to corrupted packets (zeroed out first fragment,
re-used garbage from another packet) and various consequences, such as
slow/stalling data transfers and connection resets. For example, testing
on a link with MTU exceeding 3058 bytes on a host with SWIOTLB enabled
(e.g. "iommu=soft swiotlb=262144,force") TCP transfers quickly fizzle
out without this patch.
Cc: stable@vger.kernel.org
Fixes: 0c5661ecc5dd7 ("ixgbe: fix crash in build\_skb Rx code path")
Signed-off-by: Markus Boehme
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b9a178f189bb6d75293573e181928735f5e3e070
Author: Gustavo A. R. Silva
Date: Mon Apr 19 18:43:32 2021 -0500
media: ngene: Fix out-of-bounds bug in ngene\_command\_config\_free\_buf()
commit 8d4abca95ecc82fc8c41912fa0085281f19cc29f upstream.
Fix an 11-year old bug in ngene\_command\_config\_free\_buf() while
addressing the following warnings caught with -Warray-bounds:
arch/alpha/include/asm/string.h:22:16: warning: '\_\_builtin\_memcpy' offset [12, 16] from the object at 'com' is out of the bounds of referenced subobject 'config' with type 'unsigned char' at offset 10 [-Warray-bounds]
arch/x86/include/asm/string\_32.h:182:25: warning: '\_\_builtin\_memcpy' offset [12, 16] from the object at 'com' is out of the bounds of referenced subobject 'config' with type 'unsigned char' at offset 10 [-Warray-bounds]
The problem is that the original code is trying to copy 6 bytes of
data into a one-byte size member \_config\_ of the wrong structue
FW\_CONFIGURE\_BUFFERS, in a single call to memcpy(). This causes a
legitimate compiler warning because memcpy() overruns the length
of &com.cmd.ConfigureBuffers.config. It seems that the right
structure is FW\_CONFIGURE\_FREE\_BUFFERS, instead, because it contains
6 more members apart from the header \_hdr\_. Also, the name of
the function ngene\_command\_config\_free\_buf() suggests that the actual
intention is to ConfigureFreeBuffers, instead of ConfigureBuffers
(which takes place in the function ngene\_command\_config\_buf(), above).
Fix this by enclosing those 6 members of struct FW\_CONFIGURE\_FREE\_BUFFERS
into new struct config, and use &com.cmd.ConfigureFreeBuffers.config as
the destination address, instead of &com.cmd.ConfigureBuffers.config,
when calling memcpy().
This also helps with the ongoing efforts to globally enable
-Warray-bounds and get us closer to being able to tighten the
FORTIFY\_SOURCE routines on memcpy().
Link: https://github.com/KSPP/linux/issues/109
Fixes: dae52d009fc9 ("V4L/DVB: ngene: Initial check-in")
Cc: stable@vger.kernel.org
Reported-by: kernel test robot
Reviewed-by: Kees Cook
Signed-off-by: Gustavo A. R. Silva
Link: https://lore.kernel.org/linux-hardening/20210420001631.GA45456@embeddedor/
Signed-off-by: Greg Kroah-Hartman
commit f5ef2fe05d386995b951476ffc8d6a6023888d99
Author: Filipe Manana
Date: Wed Jul 21 17:31:48 2021 +0100
btrfs: fix lock inversion problem when doing qgroup extent tracing
commit 8949b9a114019b03fbd0d03d65b8647cba4feef3 upstream.
At btrfs\_qgroup\_trace\_extent\_post() we call btrfs\_find\_all\_roots() with a
NULL value as the transaction handle argument, which makes that function
take the commit\_root\_sem semaphore, which is necessary when we don't hold
a transaction handle or any other mechanism to prevent a transaction
commit from wiping out commit roots.
However btrfs\_qgroup\_trace\_extent\_post() can be called in a context where
we are holding a write lock on an extent buffer from a subvolume tree,
namely from btrfs\_truncate\_inode\_items(), called either during truncate
or unlink operations. In this case we end up with a lock inversion problem
because the commit\_root\_sem is a higher level lock, always supposed to be
acquired before locking any extent buffer.
Lockdep detects this lock inversion problem since we switched the extent
buffer locks from custom locks to semaphores, and when running btrfs/158
from fstests, it reported the following trace:
[ 9057.626435] ======================================================
[ 9057.627541] WARNING: possible circular locking dependency detected
[ 9057.628334] 5.14.0-rc2-btrfs-next-93 #1 Not tainted
[ 9057.628961] ------------------------------------------------------
[ 9057.629867] kworker/u16:4/30781 is trying to acquire lock:
[ 9057.630824] ffff8e2590f58760 (btrfs-tree-00){++++}-{3:3}, at: \_\_btrfs\_tree\_read\_lock+0x24/0x110 [btrfs]
[ 9057.632542]
but task is already holding lock:
[ 9057.633551] ffff8e25582d4b70 (&fs\_info->commit\_root\_sem){++++}-{3:3}, at: iterate\_extent\_inodes+0x10b/0x280 [btrfs]
[ 9057.635255]
which lock already depends on the new lock.
[ 9057.636292]
the existing dependency chain (in reverse order) is:
[ 9057.637240]
-> #1 (&fs\_info->commit\_root\_sem){++++}-{3:3}:
[ 9057.638138] down\_read+0x46/0x140
[ 9057.638648] btrfs\_find\_all\_roots+0x41/0x80 [btrfs]
[ 9057.639398] btrfs\_qgroup\_trace\_extent\_post+0x37/0x70 [btrfs]
[ 9057.640283] btrfs\_add\_delayed\_data\_ref+0x418/0x490 [btrfs]
[ 9057.641114] btrfs\_free\_extent+0x35/0xb0 [btrfs]
[ 9057.641819] btrfs\_truncate\_inode\_items+0x424/0xf70 [btrfs]
[ 9057.642643] btrfs\_evict\_inode+0x454/0x4f0 [btrfs]
[ 9057.643418] evict+0xcf/0x1d0
[ 9057.643895] do\_unlinkat+0x1e9/0x300
[ 9057.644525] do\_syscall\_64+0x3b/0xc0
[ 9057.645110] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 9057.645835]
-> #0 (btrfs-tree-00){++++}-{3:3}:
[ 9057.646600] \_\_lock\_acquire+0x130e/0x2210
[ 9057.647248] lock\_acquire+0xd7/0x310
[ 9057.647773] down\_read\_nested+0x4b/0x140
[ 9057.648350] \_\_btrfs\_tree\_read\_lock+0x24/0x110 [btrfs]
[ 9057.649175] btrfs\_read\_lock\_root\_node+0x31/0x40 [btrfs]
[ 9057.650010] btrfs\_search\_slot+0x537/0xc00 [btrfs]
[ 9057.650849] scrub\_print\_warning\_inode+0x89/0x370 [btrfs]
[ 9057.651733] iterate\_extent\_inodes+0x1e3/0x280 [btrfs]
[ 9057.652501] scrub\_print\_warning+0x15d/0x2f0 [btrfs]
[ 9057.653264] scrub\_handle\_errored\_block.isra.0+0x135f/0x1640 [btrfs]
[ 9057.654295] scrub\_bio\_end\_io\_worker+0x101/0x2e0 [btrfs]
[ 9057.655111] btrfs\_work\_helper+0xf8/0x400 [btrfs]
[ 9057.655831] process\_one\_work+0x247/0x5a0
[ 9057.656425] worker\_thread+0x55/0x3c0
[ 9057.656993] kthread+0x155/0x180
[ 9057.657494] ret\_from\_fork+0x22/0x30
[ 9057.658030]
other info that might help us debug this:
[ 9057.659064] Possible unsafe locking scenario:
[ 9057.659824] CPU0 CPU1
[ 9057.660402] ---- ----
[ 9057.660988] lock(&fs\_info->commit\_root\_sem);
[ 9057.661581] lock(btrfs-tree-00);
[ 9057.662348] lock(&fs\_info->commit\_root\_sem);
[ 9057.663254] lock(btrfs-tree-00);
[ 9057.663690]
\*\*\* DEADLOCK \*\*\*
[ 9057.664437] 4 locks held by kworker/u16:4/30781:
[ 9057.665023] #0: ffff8e25922a1148 ((wq\_completion)btrfs-scrub){+.+.}-{0:0}, at: process\_one\_work+0x1c7/0x5a0
[ 9057.666260] #1: ffffabb3451ffe70 ((work\_completion)(&work->normal\_work)){+.+.}-{0:0}, at: process\_one\_work+0x1c7/0x5a0
[ 9057.667639] #2: ffff8e25922da198 (&ret->mutex){+.+.}-{3:3}, at: scrub\_handle\_errored\_block.isra.0+0x5d2/0x1640 [btrfs]
[ 9057.669017] #3: ffff8e25582d4b70 (&fs\_info->commit\_root\_sem){++++}-{3:3}, at: iterate\_extent\_inodes+0x10b/0x280 [btrfs]
[ 9057.670408]
stack backtrace:
[ 9057.670976] CPU: 7 PID: 30781 Comm: kworker/u16:4 Not tainted 5.14.0-rc2-btrfs-next-93 #1
[ 9057.672030] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
[ 9057.673492] Workqueue: btrfs-scrub btrfs\_work\_helper [btrfs]
[ 9057.674258] Call Trace:
[ 9057.674588] dump\_stack\_lvl+0x57/0x72
[ 9057.675083] check\_noncircular+0xf3/0x110
[ 9057.675611] \_\_lock\_acquire+0x130e/0x2210
[ 9057.676132] lock\_acquire+0xd7/0x310
[ 9057.676605] ? \_\_btrfs\_tree\_read\_lock+0x24/0x110 [btrfs]
[ 9057.677313] ? lock\_is\_held\_type+0xe8/0x140
[ 9057.677849] down\_read\_nested+0x4b/0x140
[ 9057.678349] ? \_\_btrfs\_tree\_read\_lock+0x24/0x110 [btrfs]
[ 9057.679068] \_\_btrfs\_tree\_read\_lock+0x24/0x110 [btrfs]
[ 9057.679760] btrfs\_read\_lock\_root\_node+0x31/0x40 [btrfs]
[ 9057.680458] btrfs\_search\_slot+0x537/0xc00 [btrfs]
[ 9057.681083] ? \_raw\_spin\_unlock+0x29/0x40
[ 9057.681594] ? btrfs\_find\_all\_roots\_safe+0x11f/0x140 [btrfs]
[ 9057.682336] scrub\_print\_warning\_inode+0x89/0x370 [btrfs]
[ 9057.683058] ? btrfs\_find\_all\_roots\_safe+0x11f/0x140 [btrfs]
[ 9057.683834] ? scrub\_write\_block\_to\_dev\_replace+0xb0/0xb0 [btrfs]
[ 9057.684632] iterate\_extent\_inodes+0x1e3/0x280 [btrfs]
[ 9057.685316] scrub\_print\_warning+0x15d/0x2f0 [btrfs]
[ 9057.685977] ? \_\_\_ratelimit+0xa4/0x110
[ 9057.686460] scrub\_handle\_errored\_block.isra.0+0x135f/0x1640 [btrfs]
[ 9057.687316] scrub\_bio\_end\_io\_worker+0x101/0x2e0 [btrfs]
[ 9057.688021] btrfs\_work\_helper+0xf8/0x400 [btrfs]
[ 9057.688649] ? lock\_is\_held\_type+0xe8/0x140
[ 9057.689180] process\_one\_work+0x247/0x5a0
[ 9057.689696] worker\_thread+0x55/0x3c0
[ 9057.690175] ? process\_one\_work+0x5a0/0x5a0
[ 9057.690731] kthread+0x155/0x180
[ 9057.691158] ? set\_kthread\_struct+0x40/0x40
[ 9057.691697] ret\_from\_fork+0x22/0x30
Fix this by making btrfs\_find\_all\_roots() never attempt to lock the
commit\_root\_sem when it is called from btrfs\_qgroup\_trace\_extent\_post().
We can't just pass a non-NULL transaction handle to btrfs\_find\_all\_roots()
from btrfs\_qgroup\_trace\_extent\_post(), because that would make backref
lookup not use commit roots and acquire read locks on extent buffers, and
therefore could deadlock when btrfs\_qgroup\_trace\_extent\_post() is called
from the btrfs\_truncate\_inode\_items() code path which has acquired a write
lock on an extent buffer of the subvolume btree.
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Qu Wenruo
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 6f919907e92e8bed7cd0472b26106ba7c16b9d3f
Author: Filipe Manana
Date: Tue Jul 6 15:41:15 2021 +0100
btrfs: fix unpersisted i\_size on fsync after expanding truncate
commit 9acc8103ab594f72250788cb45a43427f36d685d upstream.
If we have an inode that does not have the full sync flag set, was changed
in the current transaction, then it is logged while logging some other
inode (like its parent directory for example), its i\_size is increased by
a truncate operation, the log is synced through an fsync of some other
inode and then finally we explicitly call fsync on our inode, the new
i\_size is not persisted.
The following example shows how to trigger it, with comments explaining
how and why the issue happens:
$ mkfs.btrfs -f /dev/sdc
$ mount /dev/sdc /mnt
$ touch /mnt/foo
$ xfs\_io -f -c "pwrite -S 0xab 0 1M" /mnt/bar
$ sync
# Fsync bar, this will be a noop since the file has not yet been
# modified in the current transaction. The goal here is to clear
# BTRFS\_INODE\_NEEDS\_FULL\_SYNC from the inode's runtime flags.
$ xfs\_io -c "fsync" /mnt/bar
# Now rename both files, without changing their parent directory.
$ mv /mnt/bar /mnt/bar2
$ mv /mnt/foo /mnt/foo2
# Increase the size of bar2 with a truncate operation.
$ xfs\_io -c "truncate 2M" /mnt/bar2
# Now fsync foo2, this results in logging its parent inode (the root
# directory), and logging the parent results in logging the inode of
# file bar2 (its inode item and the new name). The inode of file bar2
# is logged with an i\_size of 0 bytes since it's logged in
# LOG\_INODE\_EXISTS mode, meaning we are only logging its names (and
# xattrs if it had any) and the i\_size of the inode will not be changed
# when the log is replayed.
$ xfs\_io -c "fsync" /mnt/foo2
# Now explicitly fsync bar2. This resulted in doing nothing, not
# logging the inode with the new i\_size of 2M and the hole from file
# offset 1M to 2M. Because the inode did not have the flag
# BTRFS\_INODE\_NEEDS\_FULL\_SYNC set, when it was logged through the
# fsync of file foo2, its last\_log\_commit field was updated,
# resulting in this explicit of file bar2 not doing anything.
$ xfs\_io -c "fsync" /mnt/bar2
# File bar2 content and size before a power failure.
$ od -A d -t x1 /mnt/bar2
0000000 ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab
\*
1048576 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
\*
2097152
# Mount the filesystem to replay the log.
$ mount /dev/sdc /mnt
# Read the file again, should have the same content and size as before
# the power failure happened, but it doesn't, i\_size is still at 1M.
$ od -A d -t x1 /mnt/bar2
0000000 ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab
\*
1048576
This started to happen after commit 209ecbb8585bf6 ("btrfs: remove stale
comment and logic from btrfs\_inode\_in\_log()"), since btrfs\_inode\_in\_log()
no longer checks if the inode's list of modified extents is not empty.
However, checking that list is not the right way to address this case
and the check was added long time ago in commit 125c4cf9f37c98
("Btrfs: set inode's logged\_trans/last\_log\_commit after ranged fsync")
for a different purpose, to address consecutive ranged fsyncs.
The reason that checking for the list emptiness makes this test pass is
because during an expanding truncate we create an extent map to represent
a hole from the old i\_size to the new i\_size, and add that extent map to
the list of modified extents in the inode. However if we are low on
available memory and we can not allocate a new extent map, then we don't
treat it as an error and just set the full sync flag on the inode, so that
the next fsync does not rely on the list of modified extents - so checking
for the emptiness of the list to decide if the inode needs to be logged is
not reliable, and results in not logging the inode if it was not possible
to allocate the extent map for the hole.
Fix this by ensuring that if we are only logging that an inode exists
(inode item, names/references and xattrs), we don't update the inode's
last\_log\_commit even if it does not have the full sync runtime flag set.
A test case for fstests follows soon.
CC: stable@vger.kernel.org # 5.13+
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit a02b54480573dc45976f55f1b9c50b19dc94e70d
Author: Anand Jain
Date: Sun Jul 4 19:14:39 2021 +0800
btrfs: check for missing device in btrfs\_trim\_fs
commit 16a200f66ede3f9afa2e51d90ade017aaa18d213 upstream.
A fstrim on a degraded raid1 can trigger the following null pointer
dereference:
BTRFS info (device loop0): allowing degraded mounts
BTRFS info (device loop0): disk space caching is enabled
BTRFS info (device loop0): has skinny extents
BTRFS warning (device loop0): devid 2 uuid 97ac16f7-e14d-4db1-95bc-3d489b424adb is missing
BTRFS warning (device loop0): devid 2 uuid 97ac16f7-e14d-4db1-95bc-3d489b424adb is missing
BTRFS info (device loop0): enabling ssd optimizations
BUG: kernel NULL pointer dereference, address: 0000000000000620
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
CPU: 0 PID: 4574 Comm: fstrim Not tainted 5.13.0-rc7+ #31
Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
RIP: 0010:btrfs\_trim\_fs+0x199/0x4a0 [btrfs]
RSP: 0018:ffff959541797d28 EFLAGS: 00010293
RAX: 0000000000000000 RBX: ffff946f84eca508 RCX: a7a67937adff8608
RDX: ffff946e8122d000 RSI: 0000000000000000 RDI: ffffffffc02fdbf0
RBP: ffff946ea4615000 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: ffff946e8122d960 R12: 0000000000000000
R13: ffff959541797db8 R14: ffff946e8122d000 R15: ffff959541797db8
FS: 00007f55917a5080(0000) GS:ffff946f9bc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000620 CR3: 000000002d2c8001 CR4: 00000000000706f0
Call Trace:
btrfs\_ioctl\_fitrim+0x167/0x260 [btrfs]
btrfs\_ioctl+0x1c00/0x2fe0 [btrfs]
? selinux\_file\_ioctl+0x140/0x240
? syscall\_trace\_enter.constprop.0+0x188/0x240
? \_\_x64\_sys\_ioctl+0x83/0xb0
\_\_x64\_sys\_ioctl+0x83/0xb0
Reproducer:
$ mkfs.btrfs -fq -d raid1 -m raid1 /dev/loop0 /dev/loop1
$ mount /dev/loop0 /btrfs
$ umount /btrfs
$ btrfs dev scan --forget
$ mount -o degraded /dev/loop0 /btrfs
$ fstrim /btrfs
The reason is we call btrfs\_trim\_free\_extents() for the missing device,
which uses device->bdev (NULL for missing device) to find if the device
supports discard.
Fix is to check if the device is missing before calling
btrfs\_trim\_free\_extents().
CC: stable@vger.kernel.org # 5.4+
Reviewed-by: Filipe Manana
Signed-off-by: Anand Jain
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 020d8ceab3412776ff4b921bfe5e630019bbbf18
Author: Steven Rostedt (VMware)
Date: Wed Jul 21 19:10:08 2021 -0400
tracing: Synthetic event field\_pos is an index not a boolean
commit 3b13911a2fd0dd0146c9777a254840c5466cf120 upstream.
Performing the following:
># echo 'wakeup\_lat s32 pid; u64 delta; char wake\_comm[]' > synthetic\_events
># echo 'hist:keys=pid:\_\_arg\_\_1=common\_timestamp.usecs' > events/sched/sched\_waking/trigger
># echo 'hist:keys=next\_pid:pid=next\_pid,delta=common\_timestamp.usecs-$\_\_arg\_\_1:onmatch(sched.sched\_waking).trace(wakeup\_lat,$pid,$delta,prev\_comm)'\
> events/sched/sched\_switch/trigger
># echo 1 > events/synthetic/enable
Crashed the kernel:
BUG: kernel NULL pointer dereference, address: 000000000000001b
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP
CPU: 7 PID: 0 Comm: swapper/7 Not tainted 5.13.0-rc5-test+ #104
Hardware name: Hewlett-Packard HP Compaq Pro 6300 SFF/339A, BIOS K01 v03.03 07/14/2016
RIP: 0010:strlen+0x0/0x20
Code: f6 82 80 2b 0b bc 20 74 11 0f b6 50 01 48 83 c0 01 f6 82 80 2b 0b bc
20 75 ef c3 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 <80> 3f 00 74 10
48 89 f8 48 83 c0 01 80 38 9 f8 c3 31
RSP: 0018:ffffaa75000d79d0 EFLAGS: 00010046
RAX: 0000000000000002 RBX: ffff9cdb55575270 RCX: 0000000000000000
RDX: ffff9cdb58c7a320 RSI: ffffaa75000d7b40 RDI: 000000000000001b
RBP: ffffaa75000d7b40 R08: ffff9cdb40a4f010 R09: ffffaa75000d7ab8
R10: ffff9cdb4398c700 R11: 0000000000000008 R12: ffff9cdb58c7a320
R13: ffff9cdb55575270 R14: ffff9cdb58c7a000 R15: 0000000000000018
FS: 0000000000000000(0000) GS:ffff9cdb5aa00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000001b CR3: 00000000c0612006 CR4: 00000000001706e0
Call Trace:
trace\_event\_raw\_event\_synth+0x90/0x1d0
action\_trace+0x5b/0x70
event\_hist\_trigger+0x4bd/0x4e0
? cpumask\_next\_and+0x20/0x30
? update\_sd\_lb\_stats.constprop.0+0xf6/0x840
? \_\_lock\_acquire.constprop.0+0x125/0x550
? find\_held\_lock+0x32/0x90
? sched\_clock\_cpu+0xe/0xd0
? lock\_release+0x155/0x440
? update\_load\_avg+0x8c/0x6f0
? enqueue\_entity+0x18a/0x920
? \_\_rb\_reserve\_next+0xe5/0x460
? ring\_buffer\_lock\_reserve+0x12a/0x3f0
event\_triggers\_call+0x52/0xe0
trace\_event\_buffer\_commit+0x1ae/0x240
trace\_event\_raw\_event\_sched\_switch+0x114/0x170
\_\_traceiter\_sched\_switch+0x39/0x50
\_\_schedule+0x431/0xb00
schedule\_idle+0x28/0x40
do\_idle+0x198/0x2e0
cpu\_startup\_entry+0x19/0x20
secondary\_startup\_64\_no\_verify+0xc2/0xcb
The reason is that the dynamic events array keeps track of the field
position of the fields array, via the field\_pos variable in the
synth\_field structure. Unfortunately, that field is a boolean for some
reason, which means any field\_pos greater than 1 will be a bug (in this
case it was 2).
Link: https://lkml.kernel.org/r/20210721191008.638bce34@oasis.local.home
Cc: Masami Hiramatsu
Cc: Namhyung Kim
Cc: Ingo Molnar
Cc: Andrew Morton
Cc: stable@vger.kernel.org
Fixes: bd82631d7ccdc ("tracing: Add support for dynamic strings to synthetic events")
Reviewed-by: Tom Zanussi
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 917a5bdd114a27c159796928cb3c09723a51d1c7
Author: Haoran Luo
Date: Wed Jul 21 14:12:07 2021 +0000
tracing: Fix bug in rb\_per\_cpu\_empty() that might cause deadloop.
commit 67f0d6d9883c13174669f88adac4f0ee656cc16a upstream.
The "rb\_per\_cpu\_empty()" misinterpret the condition (as not-empty) when
"head\_page" and "commit\_page" of "struct ring\_buffer\_per\_cpu" points to
the same buffer page, whose "buffer\_data\_page" is empty and "read" field
is non-zero.
An error scenario could be constructed as followed (kernel perspective):
1. All pages in the buffer has been accessed by reader(s) so that all of
them will have non-zero "read" field.
2. Read and clear all buffer pages so that "rb\_num\_of\_entries()" will
return 0 rendering there's no more data to read. It is also required
that the "read\_page", "commit\_page" and "tail\_page" points to the same
page, while "head\_page" is the next page of them.
3. Invoke "ring\_buffer\_lock\_reserve()" with large enough "length"
so that it shot pass the end of current tail buffer page. Now the
"head\_page", "commit\_page" and "tail\_page" points to the same page.
4. Discard current event with "ring\_buffer\_discard\_commit()", so that
"head\_page", "commit\_page" and "tail\_page" points to a page whose buffer
data page is now empty.
When the error scenario has been constructed, "tracing\_read\_pipe" will
be trapped inside a deadloop: "trace\_empty()" returns 0 since
"rb\_per\_cpu\_empty()" returns 0 when it hits the CPU containing such
constructed ring buffer. Then "trace\_find\_next\_entry\_inc()" always
return NULL since "rb\_num\_of\_entries()" reports there's no more entry
to read. Finally "trace\_seq\_to\_user()" returns "-EBUSY" spanking
"tracing\_read\_pipe" back to the start of the "waitagain" loop.
I've also written a proof-of-concept script to construct the scenario
and trigger the bug automatically, you can use it to trace and validate
my reasoning above:
https://github.com/aegistudio/RingBufferDetonator.git
Tests has been carried out on linux kernel 5.14-rc2
(2734d6c1b1a089fb593ef6a23d4b70903526fe0c), my fixed version
of kernel (for testing whether my update fixes the bug) and
some older kernels (for range of affected kernels). Test result is
also attached to the proof-of-concept repository.
Link: https://lore.kernel.org/linux-trace-devel/YPaNxsIlb2yjSi5Y@aegistudio/
Link: https://lore.kernel.org/linux-trace-devel/YPgrN85WL9VyrZ55@aegistudio
Cc: stable@vger.kernel.org
Fixes: bf41a158cacba ("ring-buffer: make reentrant")
Suggested-by: Linus Torvalds
Signed-off-by: Haoran Luo
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 29ecaddb8655537d298aef5d88b4380c80c72058
Author: Steven Rostedt (VMware)
Date: Wed Jul 21 11:00:53 2021 -0400
tracing/histogram: Rename "cpu" to "common\_cpu"
commit 1e3bac71c5053c99d438771fc9fa5082ae5d90aa upstream.
Currently the histogram logic allows the user to write "cpu" in as an
event field, and it will record the CPU that the event happened on.
The problem with this is that there's a lot of events that have "cpu"
as a real field, and using "cpu" as the CPU it ran on, makes it
impossible to run histograms on the "cpu" field of events.
For example, if I want to have a histogram on the count of the
workqueue\_queue\_work event on its cpu field, running:
># echo 'hist:keys=cpu' > events/workqueue/workqueue\_queue\_work/trigger
Gives a misleading and wrong result.
Change the command to "common\_cpu" as no event should have "common\_\*"
fields as that's a reserved name for fields used by all events. And
this makes sense here as common\_cpu would be a field used by all events.
Now we can even do:
># echo 'hist:keys=common\_cpu,cpu if cpu < 100' > events/workqueue/workqueue\_queue\_work/trigger
># cat events/workqueue/workqueue\_queue\_work/hist
# event histogram
#
# trigger info: hist:keys=common\_cpu,cpu:vals=hitcount:sort=hitcount:size=2048 if cpu < 100 [active]
#
{ common\_cpu: 0, cpu: 2 } hitcount: 1
{ common\_cpu: 0, cpu: 4 } hitcount: 1
{ common\_cpu: 7, cpu: 7 } hitcount: 1
{ common\_cpu: 0, cpu: 7 } hitcount: 1
{ common\_cpu: 0, cpu: 1 } hitcount: 1
{ common\_cpu: 0, cpu: 6 } hitcount: 2
{ common\_cpu: 0, cpu: 5 } hitcount: 2
{ common\_cpu: 1, cpu: 1 } hitcount: 4
{ common\_cpu: 6, cpu: 6 } hitcount: 4
{ common\_cpu: 5, cpu: 5 } hitcount: 14
{ common\_cpu: 4, cpu: 4 } hitcount: 26
{ common\_cpu: 0, cpu: 0 } hitcount: 39
{ common\_cpu: 2, cpu: 2 } hitcount: 184
Now for backward compatibility, I added a trick. If "cpu" is used, and
the field is not found, it will fall back to "common\_cpu" and work as
it did before. This way, it will still work for old programs that use
"cpu" to get the actual CPU, but if the event has a "cpu" as a field, it
will get that event's "cpu" field, which is probably what it wants
anyway.
I updated the tracefs/README to include documentation about both the
common\_timestamp and the common\_cpu. This way, if that text is present in
the README, then an application can know that common\_cpu is supported over
just plain "cpu".
Link: https://lkml.kernel.org/r/20210721110053.26b4f641@oasis.local.home
Cc: Namhyung Kim
Cc: Ingo Molnar
Cc: Andrew Morton
Cc: stable@vger.kernel.org
Fixes: 8b7622bf94a44 ("tracing: Add cpu field for hist triggers")
Reviewed-by: Tom Zanussi
Reviewed-by: Masami Hiramatsu
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 58f47cfe5210daf71b3e6cb34570f80fee667611
Author: Steven Rostedt (VMware)
Date: Thu Jul 22 21:52:18 2021 -0400
tracepoints: Update static\_call before tp\_funcs when adding a tracepoint
commit 352384d5c84ebe40fa77098cc234fe173247d8ef upstream.
Because of the significant overhead that retpolines pose on indirect
calls, the tracepoint code was updated to use the new "static\_calls" that
can modify the running code to directly call a function instead of using
an indirect caller, and this function can be changed at runtime.
In the tracepoint code that calls all the registered callbacks that are
attached to a tracepoint, the following is done:
it\_func\_ptr = rcu\_dereference\_raw((&\_\_tracepoint\_##name)->funcs);
if (it\_func\_ptr) {
\_\_data = (it\_func\_ptr)->data;
static\_call(tp\_func\_##name)(\_\_data, args);
}
If there's just a single callback, the static\_call is updated to just call
that callback directly. Once another handler is added, then the static
caller is updated to call the iterator, that simply loops over all the
funcs in the array and calls each of the callbacks like the old method
using indirect calling.
The issue was discovered with a race between updating the funcs array and
updating the static\_call. The funcs array was updated first and then the
static\_call was updated. This is not an issue as long as the first element
in the old array is the same as the first element in the new array. But
that assumption is incorrect, because callbacks also have a priority
field, and if there's a callback added that has a higher priority than the
callback on the old array, then it will become the first callback in the
new array. This means that it is possible to call the old callback with
the new callback data element, which can cause a kernel panic.
static\_call = callback1()
funcs[] = {callback1,data1};
callback2 has higher priority than callback1
CPU 1 CPU 2
----- -----
new\_funcs = {callback2,data2},
{callback1,data1}
rcu\_assign\_pointer(tp->funcs, new\_funcs);
/\*
\* Now tp->funcs has the new array
\* but the static\_call still calls callback1
\*/
it\_func\_ptr = tp->funcs [ new\_funcs ]
data = it\_func\_ptr->data [ data2 ]
static\_call(callback1, data);
/\* Now callback1 is called with
\* callback2's data \*/
[ KERNEL PANIC ]
update\_static\_call(iterator);
To prevent this from happening, always switch the static\_call to the
iterator before assigning the tp->funcs to the new array. The iterator will
always properly match the callback with its data.
To trigger this bug:
In one terminal:
while :; do hackbench 50; done
In another terminal
echo 1 > /sys/kernel/tracing/events/sched/sched\_waking/enable
while :; do
echo 1 > /sys/kernel/tracing/set\_event\_pid;
sleep 0.5
echo 0 > /sys/kernel/tracing/set\_event\_pid;
sleep 0.5
done
And it doesn't take long to crash. This is because the set\_event\_pid adds
a callback to the sched\_waking tracepoint with a high priority, which will
be called before the sched\_waking trace event callback is called.
Note, the removal to a single callback updates the array first, before
changing the static\_call to single callback, which is the proper order as
the first element in the array is the same as what the static\_call is
being changed to.
Link: https://lore.kernel.org/io-uring/4ebea8f0-58c9-e571-fd30-0ce4f6f09c70@samba.org/
Cc: stable@vger.kernel.org
Fixes: d25e37d89dd2f ("tracepoint: Optimize using static\_call()")
Reported-by: Stefan Metzmacher
tested-by: Stefan Metzmacher
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 0ea2fd39f1192941bd49e9c0d93ce61cbba5f6f3
Author: Marc Zyngier
Date: Tue Jul 13 19:43:26 2021 +0100
firmware/efi: Tell memblock about EFI iomem reservations
commit 2bab693a608bdf614b9fcd44083c5100f34b9f77 upstream.
kexec\_load\_file() relies on the memblock infrastructure to avoid
stamping over regions of memory that are essential to the survival
of the system.
However, nobody seems to agree how to flag these regions as reserved,
and (for example) EFI only publishes its reservations in /proc/iomem
for the benefit of the traditional, userspace based kexec tool.
On arm64 platforms with GICv3, this can result in the payload being
placed at the location of the LPI tables. Shock, horror!
Let's augment the EFI reservation code with a memblock\_reserve() call,
protecting our dear tables from the secondary kernel invasion.
Reported-by: Moritz Fischer
Tested-by: Moritz Fischer
Signed-off-by: Marc Zyngier
Cc: stable@vger.kernel.org
Cc: Ard Biesheuvel
Cc: James Morse
Cc: Catalin Marinas
Cc: Will Deacon
Signed-off-by: Ard Biesheuvel
Signed-off-by: Greg Kroah-Hartman
commit 68a4037d5dd0e75f9b74e65c838fc1dbfddb03f1
Author: Amelie Delaunay
Date: Fri Jul 16 14:07:18 2021 +0200
usb: typec: stusb160x: Don't block probing of consumer of "connector" nodes
commit 6b63376722d9e1b915a2948e9b30f4ba2712e3f5 upstream.
Similar as with tcpm this patch lets fw\_devlink know not to wait on the
fwnode to be populated as a struct device.
Without this patch, USB functionality can be broken on some previously
supported boards.
Fixes: 28ec344bb891 ("usb: typec: tcpm: Don't block probing of consumers of "connector" nodes")
Cc: stable
Signed-off-by: Amelie Delaunay
Link: https://lore.kernel.org/r/20210716120718.20398-3-amelie.delaunay@foss.st.com
Signed-off-by: Greg Kroah-Hartman
commit eeb18490e8f492e85bdd6134e61c4a918c72454c
Author: Amelie Delaunay
Date: Fri Jul 16 14:07:17 2021 +0200
usb: typec: stusb160x: register role switch before interrupt registration
commit 86762ad4abcc549deb7a155c8e5e961b9755bcf0 upstream.
During interrupt registration, attach state is checked. If attached,
then the Type-C state is updated with typec\_set\_xxx functions and role
switch is set with usb\_role\_switch\_set\_role().
If the usb\_role\_switch parameter is error or null, the function simply
returns 0.
So, to update usb\_role\_switch role if a device is attached before the
irq is registered, usb\_role\_switch must be registered before irq
registration.
Fixes: da0cb6310094 ("usb: typec: add support for STUSB160x Type-C controller family")
Cc: stable
Signed-off-by: Amelie Delaunay
Link: https://lore.kernel.org/r/20210716120718.20398-2-amelie.delaunay@foss.st.com
Signed-off-by: Greg Kroah-Hartman
commit 703527bf83917c567c2f3022ccf7564d410c97ca
Author: Martin Kepplinger
Date: Wed Jul 14 08:18:07 2021 +0200
usb: typec: tipd: Don't block probing of consumer of "connector" nodes
commit 57560ee95cb7f91cf0bc31d4ae8276e0dcfe17aa upstream.
Similar as with tcpm this patch lets fw\_devlink know not to wait on the
fwnode to be populated as a struct device.
Without this patch, USB functionality can be broken on some previously
supported boards.
Fixes: 28ec344bb891 ("usb: typec: tcpm: Don't block probing of consumers of "connector" nodes")
Cc: stable
Acked-by: Heikki Krogerus
Signed-off-by: Martin Kepplinger
Link: https://lore.kernel.org/r/20210714061807.5737-1-martin.kepplinger@puri.sm
Signed-off-by: Greg Kroah-Hartman
commit 61c129211a3d95599a619a9fb5cb90399c7abbc9
Author: Minas Harutyunyan
Date: Tue Jul 20 05:41:24 2021 -0700
usb: dwc2: gadget: Fix sending zero length packet in DDMA mode.
commit d53dc38857f6dbefabd9eecfcbf67b6eac9a1ef4 upstream.
Sending zero length packet in DDMA mode perform by DMA descriptor
by setting SP (short packet) flag.
For DDMA in function dwc2\_hsotg\_complete\_in() does not need to send
zlp.
Tested by USBCV MSC tests.
Fixes: f71b5e2533de ("usb: dwc2: gadget: fix zero length packet transfers")
Cc: stable
Signed-off-by: Minas Harutyunyan
Link: https://lore.kernel.org/r/967bad78c55dd2db1c19714eee3d0a17cf99d74a.1626777738.git.Minas.Harutyunyan@synopsys.com
Signed-off-by: Greg Kroah-Hartman
commit bd062872040bae54878ed2207c548925ab64f097
Author: Minas Harutyunyan
Date: Tue Jul 13 09:32:55 2021 +0400
usb: dwc2: gadget: Fix GOUTNAK flow for Slave mode.
commit fecb3a171db425e5068b27231f8efe154bf72637 upstream.
Because of dwc2\_hsotg\_ep\_stop\_xfr() function uses poll
mode, first need to mask GINTSTS\_GOUTNAKEFF interrupt.
In Slave mode GINTSTS\_GOUTNAKEFF interrupt will be
aserted only after pop OUT NAK status packet from RxFIFO.
In dwc2\_hsotg\_ep\_sethalt() function before setting
DCTL\_SGOUTNAK need to unmask GOUTNAKEFF interrupt.
Tested by USBCV CH9 and MSC tests set in Slave, BDMA and DDMA.
All tests are passed.
Fixes: a4f827714539a ("usb: dwc2: gadget: Disable enabled HW endpoint in dwc2\_hsotg\_ep\_disable")
Fixes: 6070636c4918c ("usb: dwc2: Fix Stalling a Non-Isochronous OUT EP")
Cc: stable
Signed-off-by: Minas Harutyunyan
Link: https://lore.kernel.org/r/e17fad802bbcaf879e1ed6745030993abb93baf8.1626152924.git.Minas.Harutyunyan@synopsys.com
Signed-off-by: Greg Kroah-Hartman
commit 36b53430c97f9e5e7298896fb017bc4f141eca47
Author: Marek Szyprowski
Date: Fri Jul 16 07:01:27 2021 +0200
usb: dwc2: Skip clock gating on Samsung SoCs
commit c4a0f7a6ab5417eb6105b0e1d7e6e67f6ef7d4e5 upstream.
Commit 0112b7ce68ea ("usb: dwc2: Update dwc2\_handle\_usb\_suspend\_intr
function.") changed the way the driver handles power down modes in a such
way that it uses clock gating when no other power down mode is available.
This however doesn't work well on the DWC2 implementation used on the
Samsung SoCs. When a clock gating is enabled, system hangs. It looks that
the proper clock gating requires some additional glue code in the shared
USB2 PHY and/or Samsung glue code for the DWC2. To restore driver
operation on the Samsung SoCs simply skip enabling clock gating mode
until one finds what is really needed to make it working reliably.
Fixes: 0112b7ce68ea ("usb: dwc2: Update dwc2\_handle\_usb\_suspend\_intr function.")
Cc: stable
Acked-by: Krzysztof Kozlowski
Signed-off-by: Marek Szyprowski
Link: https://lore.kernel.org/r/20210716050127.4406-1-m.szyprowski@samsung.com
Signed-off-by: Greg Kroah-Hartman
commit b85e8638ba15b43dc7ed7d5242249ad520e00b45
Author: Zhang Qilong
Date: Fri Jun 18 22:14:41 2021 +0800
usb: gadget: Fix Unbalanced pm\_runtime\_enable in tegra\_xudc\_probe
commit 5b01248156bd75303e66985c351dee648c149979 upstream.
Add missing pm\_runtime\_disable() when probe error out. It could
avoid pm\_runtime implementation complains when removing and probing
again the driver.
Fixes: 49db427232fe ("usb: gadget: Add UDC driver for tegra XUSB device mode controller")
Cc: stable
Signed-off-by: Zhang Qilong
Link: https://lore.kernel.org/r/20210618141441.107817-1-zhangqilong3@huawei.com
Signed-off-by: Greg Kroah-Hartman
commit 7138b108ecdbbe7e96a5157db2874af69013f159
Author: John Keeping
Date: Wed Jul 21 17:17:45 2021 +0100
USB: serial: cp210x: add ID for CEL EM3588 USB ZigBee stick
commit d6a206e60124a9759dd7f6dfb86b0e1d3b1df82e upstream.
Add the USB serial device ID for the CEL ZigBee EM3588 radio stick.
Signed-off-by: John Keeping
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit f1a01c2b462835f7b8ef7654d5902d477e2c304d
Author: Ian Ray
Date: Mon Jul 19 18:43:49 2021 +0200
USB: serial: cp210x: fix comments for GE CS1000
commit e9db418d4b828dd049caaf5ed65dc86f93bb1a0c upstream.
Fix comments for GE CS1000 CP210x USB ID assignments.
Fixes: 42213a0190b5 ("USB: serial: cp210x: add some more GE USB IDs")
Signed-off-by: Ian Ray
Signed-off-by: Sebastian Reichel
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 8a55cb17e401851a0f49cc9792c05a5af82b1bab
Author: Marco De Marco
Date: Mon Jul 5 19:44:21 2021 +0000
USB: serial: option: add support for u-blox LARA-R6 family
commit 94b619a07655805a1622484967754f5848640456 upstream.
The patch is meant to support LARA-R6 Cat 1 module family.
Module USB ID:
Vendor ID: 0x05c6
Product ID: 0x90fA
Interface layout:
If 0: Diagnostic
If 1: AT parser
If 2: AT parser
If 3: QMI wwan (not available in all versions)
Signed-off-by: Marco De Marco
Link: https://lore.kernel.org/r/49260184.kfMIbaSn9k@mars
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit c9d143a3d8aa7faecacd34d1c5ca903311b92996
Author: Yoshihiro Shimoda
Date: Thu Jun 24 21:20:39 2021 +0900
usb: renesas\_usbhs: Fix superfluous irqs happen after usb\_pkt\_pop()
commit 5719df243e118fb343725e8b2afb1637e1af1373 upstream.
This driver has a potential issue which this driver is possible to
cause superfluous irqs after usb\_pkt\_pop() is called. So, after
the commit 3af32605289e ("usb: renesas\_usbhs: fix error return
code of usbhsf\_pkt\_handler()") had been applied, we could observe
the following error happened when we used g\_audio.
renesas\_usbhs e6590000.usb: irq\_ready run\_error 1 : -22
To fix the issue, disable the tx or rx interrupt in usb\_pkt\_pop().
Fixes: 2743e7f90dc0 ("usb: renesas\_usbhs: fix the usb\_pkt\_pop()")
Cc:  # v4.4+
Signed-off-by: Yoshihiro Shimoda
Link: https://lore.kernel.org/r/20210624122039.596528-1-yoshihiro.shimoda.uh@renesas.com
Signed-off-by: Greg Kroah-Hartman
commit d4179cdb769a651f2ae89c325612a69bf6fbdf70
Author: Mark Tomlinson
Date: Fri Jun 25 15:14:56 2021 +1200
usb: max-3421: Prevent corruption of freed memory
commit b5fdf5c6e6bee35837e160c00ac89327bdad031b upstream.
The MAX-3421 USB driver remembers the state of the USB toggles for a
device/endpoint. To save SPI writes, this was only done when a new
device/endpoint was being used. Unfortunately, if the old device was
removed, this would cause writes to freed memory.
To fix this, a simpler scheme is used. The toggles are read from
hardware when a URB is completed, and the toggles are always written to
hardware when any URB transaction is started. This will cause a few more
SPI transactions, but no causes kernel panics.
Fixes: 2d53139f3162 ("Add support for using a MAX3421E chip as a host driver.")
Cc: stable
Signed-off-by: Mark Tomlinson
Link: https://lore.kernel.org/r/20210625031456.8632-1-mark.tomlinson@alliedtelesis.co.nz
Signed-off-by: Greg Kroah-Hartman
commit 3b5d8c72ffd5f5d347a90013d7b508a12b9d0b9c
Author: Julian Sikorski
Date: Tue Jul 20 19:19:10 2021 +0200
USB: usb-storage: Add LaCie Rugged USB3-FW to IGNORE\_UAS
commit 6abf2fe6b4bf6e5256b80c5817908151d2d33e9f upstream.
LaCie Rugged USB3-FW appears to be incompatible with UAS. It generates
errors like:
[ 1151.582598] sd 14:0:0:0: tag#16 uas\_eh\_abort\_handler 0 uas-tag 1 inflight: IN
[ 1151.582602] sd 14:0:0:0: tag#16 CDB: Report supported operation codes a3 0c 01 12 00 00 00 00 02 00 00 00
[ 1151.588594] scsi host14: uas\_eh\_device\_reset\_handler start
[ 1151.710482] usb 2-4: reset SuperSpeed Gen 1 USB device number 2 using xhci\_hcd
[ 1151.741398] scsi host14: uas\_eh\_device\_reset\_handler success
[ 1181.785534] scsi host14: uas\_eh\_device\_reset\_handler start
Signed-off-by: Julian Sikorski
Cc: stable
Link: https://lore.kernel.org/r/20210720171910.36497-1-belegdol+github@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 9499b2d2cc601745eb9b57ecd983931a17f66eae
Author: Mathias Nyman
Date: Thu Jul 15 18:01:21 2021 +0300
usb: hub: Fix link power management max exit latency (MEL) calculations
commit 1bf2761c837571a66ec290fb66c90413821ffda2 upstream.
Maximum Exit Latency (MEL) value is used by host to know how much in
advance it needs to start waking up a U1/U2 suspended link in order to
service a periodic transfer in time.
Current MEL calculation only includes the time to wake up the path from
U1/U2 to U0. This is called tMEL1 in USB 3.1 section C 1.5.2
Total MEL = tMEL1 + tMEL2 +tMEL3 + tMEL4 which should additinally include:
- tMEL2 which is the time it takes for PING message to reach device
- tMEL3 time for device to process the PING and submit a PING\_RESPONSE
- tMEL4 time for PING\_RESPONSE to traverse back upstream to host.
Add the missing tMEL2, tMEL3 and tMEL4 to MEL calculation.
Cc:  # v3.5
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20210715150122.1995966-1-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit c7affd5b02265fc8cdb06453f701cd78f531171e
Author: Mathias Nyman
Date: Thu Jul 15 18:01:22 2021 +0300
usb: hub: Disable USB 3 device initiated lpm if exit latency is too high
commit 1b7f56fbc7a1b66967b6114d1b5f5a257c3abae6 upstream.
The device initiated link power management U1/U2 states should not be
enabled in case the system exit latency plus one bus interval (125us) is
greater than the shortest service interval of any periodic endpoint.
This is the case for both U1 and U2 sytstem exit latencies and link states.
See USB 3.2 section 9.4.9 "Set Feature" for more details
Note, before this patch the host and device initiated U1/U2 lpm states
were both enabled with lpm. After this patch it's possible to end up with
only host inititated U1/U2 lpm in case the exit latencies won't allow
device initiated lpm.
If this case we still want to set the udev->usb3\_lpm\_ux\_enabled flag so
that sysfs users can see the link may go to U1/U2.
Signed-off-by: Mathias Nyman
Cc: stable
Link: https://lore.kernel.org/r/20210715150122.1995966-2-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 1408e47ab233d78b43af735a6bbf64f503260f51
Author: Nicholas Piggin
Date: Thu Jul 8 21:26:22 2021 +1000
KVM: PPC: Book3S HV Nested: Sanitise H\_ENTER\_NESTED TM state
commit d9c57d3ed52a92536f5fa59dc5ccdd58b4875076 upstream.
The H\_ENTER\_NESTED hypercall is handled by the L0, and it is a request
by the L1 to switch the context of the vCPU over to that of its L2
guest, and return with an interrupt indication. The L1 is responsible
for switching some registers to guest context, and the L0 switches
others (including all the hypervisor privileged state).
If the L2 MSR has TM active, then the L1 is responsible for
recheckpointing the L2 TM state. Then the L1 exits to L0 via the
H\_ENTER\_NESTED hcall, and the L0 saves the TM state as part of the exit,
and then it recheckpoints the TM state as part of the nested entry and
finally HRFIDs into the L2 with TM active MSR. Not efficient, but about
the simplest approach for something that's horrendously complicated.
Problems arise if the L1 exits to the L0 with a TM state which does not
match the L2 TM state being requested. For example if the L1 is
transactional but the L2 MSR is non-transactional, or vice versa. The
L0's HRFID can take a TM Bad Thing interrupt and crash.
Fix this by disallowing H\_ENTER\_NESTED in TM[T] state entirely, and then
ensuring that if the L1 is suspended then the L2 must have TM active,
and if the L1 is not suspended then the L2 must not have TM active.
Fixes: 360cae313702 ("KVM: PPC: Book3S HV: Nested guest entry via hypercall")
Cc: stable@vger.kernel.org # v4.20+
Reported-by: Alexey Kardashevskiy
Acked-by: Michael Neuling
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 35e114e6f84ab559eb35a5ac73590d23a43f22ba
Author: Nicholas Piggin
Date: Tue Jul 20 20:43:09 2021 +1000
KVM: PPC: Book3S: Fix H\_RTAS rets buffer overflow
commit f62f3c20647ebd5fb6ecb8f0b477b9281c44c10a upstream.
The kvmppc\_rtas\_hcall() sets the host rtas\_args.rets pointer based on
the rtas\_args.nargs that was provided by the guest. That guest nargs
value is not range checked, so the guest can cause the host rets pointer
to be pointed outside the args array. The individual rtas function
handlers check the nargs and nrets values to ensure they are correct,
but if they are not, the handlers store a -3 (0xfffffffd) failure
indication in rets[0] which corrupts host memory.
Fix this by testing up front whether the guest supplied nargs and nret
would exceed the array size, and fail the hcall directly without storing
a failure indication to rets[0].
Also expand on a comment about why we kill the guest and try not to
return errors directly if we have a valid rets[0] pointer.
Fixes: 8e591cb72047 ("KVM: PPC: Book3S: Add infrastructure to implement kernel-side RTAS calls")
Cc: stable@vger.kernel.org # v3.10+
Reported-by: Alexey Kardashevskiy
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 3d98808e2414bdb06a7e392260ea17fa7929a5ee
Author: David Jeffery
Date: Thu Jul 15 17:37:44 2021 -0400
usb: ehci: Prevent missed ehci interrupts with edge-triggered MSI
commit 0b60557230adfdeb8164e0b342ac9cd469a75759 upstream.
When MSI is used by the ehci-hcd driver, it can cause lost interrupts which
results in EHCI only continuing to work due to a polling fallback. But the
reliance of polling drastically reduces performance of any I/O through EHCI.
Interrupts are lost as the EHCI interrupt handler does not safely handle
edge-triggered interrupts. It fails to ensure all interrupt status bits are
cleared, which works with level-triggered interrupts but not the
edge-triggered interrupts typical from using MSI.
To fix this problem, check if the driver may have raced with the hardware
setting additional interrupt status bits and clear status until it is in a
stable state.
Fixes: 306c54d0edb6 ("usb: hcd: Try MSI interrupts on PCI devices")
Tested-by: Laurence Oberman
Reviewed-by: Andy Shevchenko
Acked-by: Alan Stern
Signed-off-by: David Jeffery
Link: https://lore.kernel.org/r/20210715213744.GA44506@redhat
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 2c476bab281843c1f2eb8bc37622f27580b506ef
Author: Mathias Nyman
Date: Thu Jul 15 18:06:51 2021 +0300
xhci: Fix lost USB 2 remote wake
commit 72f68bf5c756f5ce1139b31daae2684501383ad5 upstream.
There's a small window where a USB 2 remote wake may be left unhandled
due to a race between hub thread and xhci port event interrupt handler.
When the resume event is detected in the xhci interrupt handler it kicks
the hub timer, which should move the port from resume to U0 once resume
has been signalled for long enough.
To keep the hub "thread" running we set a bus\_state->resuming\_ports flag.
This flag makes sure hub timer function kicks itself.
checking this flag was not properly protected by the spinlock. Flag was
copied to a local variable before lock was taken. The local variable was
then checked later with spinlock held.
If interrupt is handled right after copying the flag to the local variable
we end up stopping the hub thread before it can handle the USB 2 resume.
CPU0 CPU1
(hub thread) (xhci event handler)
xhci\_hub\_status\_data()
status = bus\_state->resuming\_ports;
handle\_port\_status()
spin\_lock()
bus\_state->resuming\_ports = 1
set\_flag(HCD\_FLAG\_POLL\_RH)
spin\_unlock()
spin\_lock()
if (!status)
clear\_flag(HCD\_FLAG\_POLL\_RH)
spin\_unlock()
Fix this by taking the lock a bit earlier so that it covers
the resuming\_ports flag copy in the hub thread
Cc:
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20210715150651.1996099-2-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 6c15cef90a456b265e1a39d7c42339ee2204f824
Author: Greg Thelen
Date: Fri Jul 2 00:12:24 2021 -0700
usb: xhci: avoid renesas\_usb\_fw.mem when it's unusable
commit 0665e387318607d8269bfdea60723c627c8bae43 upstream.
Commit a66d21d7dba8 ("usb: xhci: Add support for Renesas controller with
memory") added renesas\_usb\_fw.mem firmware reference to xhci-pci. Thus
modinfo indicates xhci-pci.ko has "firmware: renesas\_usb\_fw.mem". But
the firmware is only actually used with CONFIG\_USB\_XHCI\_PCI\_RENESAS. An
unusable firmware reference can trigger safety checkers which look for
drivers with unmet firmware dependencies.
Avoid referring to renesas\_usb\_fw.mem in circumstances when it cannot be
loaded (when CONFIG\_USB\_XHCI\_PCI\_RENESAS isn't set).
Fixes: a66d21d7dba8 ("usb: xhci: Add support for Renesas controller with memory")
Cc: stable
Signed-off-by: Greg Thelen
Link: https://lore.kernel.org/r/20210702071224.3673568-1-gthelen@google.com
Signed-off-by: Greg Kroah-Hartman
commit 62b022edb1874e5527223623312c18db5d268d4e
Author: Moritz Fischer
Date: Mon Jul 19 00:05:19 2021 -0700
Revert "usb: renesas-xhci: Fix handling of unknown ROM state"
commit 44cf53602f5a0db80d53c8fff6cdbcae59650a42 upstream.
This reverts commit d143825baf15f204dac60acdf95e428182aa3374.
Justin reports some of his systems now fail as result of this commit:
xhci\_hcd 0000:04:00.0: Direct firmware load for renesas\_usb\_fw.mem failed with error -2
xhci\_hcd 0000:04:00.0: request\_firmware failed: -2
xhci\_hcd: probe of 0000:04:00.0 failed with error -2
The revert brings back the original issue the commit tried to solve but
at least unbreaks existing systems relying on previous behavior.
Cc: stable@vger.kernel.org
Cc: Mathias Nyman
Cc: Vinod Koul
Cc: Justin Forbes
Reported-by: Justin Forbes
Signed-off-by: Moritz Fischer
Fixes: d143825baf15 ("usb: renesas-xhci: Fix handling of unknown ROM state")
Link: https://lore.kernel.org/r/20210719070519.41114-1-mdf@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 0def8cf06098d630b904be51045088345403c986
Author: Takashi Iwai
Date: Tue Jul 20 11:26:40 2021 +0200
ALSA: pcm: Fix mmap capability check
commit c4824ae7db418aee6f50f308a20b832e58e997fd upstream.
The hw\_support\_mmap() doesn't cover all memory allocation types and
might use a wrong device pointer for checking the capability.
Check the all memory allocation types more completely.
Cc:
Link: https://lore.kernel.org/r/20210720092640.12338-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 7ca1bb5bace3a750d14ed7bb1dfc59df94339fe2
Author: Alan Young
Date: Fri Jul 9 09:48:54 2021 +0100
ALSA: pcm: Call substream ack() method upon compat mmap commit
commit 2e2832562c877e6530b8480982d99a4ff90c6777 upstream.
If a 32-bit application is being used with a 64-bit kernel and is using
the mmap mechanism to write data, then the SNDRV\_PCM\_IOCTL\_SYNC\_PTR
ioctl results in calling snd\_pcm\_ioctl\_sync\_ptr\_compat(). Make this use
pcm\_lib\_apply\_appl\_ptr() so that the substream's ack() method, if
defined, is called.
The snd\_pcm\_sync\_ptr() function, used in the 64-bit ioctl case, already
uses snd\_pcm\_ioctl\_sync\_ptr\_compat().
Fixes: 9027c4639ef1 ("ALSA: pcm: Call ack() whenever appl\_ptr is updated")
Signed-off-by: Alan Young
Cc:
Link: https://lore.kernel.org/r/c441f18c-eb2a-3bdd-299a-696ccca2de9c@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 7810cd82b1ad3c9422242933ad6dd435e1ebc3a9
Author: Takashi Iwai
Date: Fri Jul 16 15:56:00 2021 +0200
ALSA: hdmi: Expose all pins on MSI MS-7C94 board
commit 33f735f137c6539e3ceceb515cd1e2a644005b49 upstream.
The BIOS on MSI Mortar B550m WiFi (MS-7C94) board with AMDGPU seems
disabling the other pins than HDMI although it has more outputs
including DP.
This patch adds the board to the allow list for enabling all pins.
Reported-by: Damjan Georgievski
Cc:
Link: https://lore.kernel.org/r/CAEk1YH4Jd0a8vfZxORVu7qg+Zsc-K+pR187ezNq8QhJBPW4gpw@mail.gmail.com
Link: https://lore.kernel.org/r/20210716135600.24176-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 7b75c0f0a668d8bb037427a1bfa2d5944ae2c7a5
Author: Hui Wang
Date: Mon Jul 19 11:02:31 2021 +0800
ALSA: hda/realtek: Fix pop noise and 2 Front Mic issues on a machine
commit e4efa82660e6d80338c554e45e903714e1b2c27b upstream.
This is a Lenovo ThinkStation machine which uses the codec alc623.
There are 2 issues on this machine, the 1st one is the pop noise in
the lineout, the 2nd one is there are 2 Front Mics and pulseaudio
can't handle them, After applying the fixup of
ALC623\_FIXUP\_LENOVO\_THINKSTATION\_P340 to this machine, the 2 issues
are fixed.
Cc:
Signed-off-by: Hui Wang
Link: https://lore.kernel.org/r/20210719030231.6870-1-hui.wang@canonical.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ac8ea355df6de4d5bb30f52eba38bb6a74d526b9
Author: Takashi Iwai
Date: Fri Jul 16 15:27:23 2021 +0200
ALSA: sb: Fix potential ABBA deadlock in CSP driver
commit 1c2b9519159b470ef24b2638f4794e86e2952ab7 upstream.
SB16 CSP driver may hit potentially a typical ABBA deadlock in two
code paths:
In snd\_sb\_csp\_stop():
spin\_lock\_irqsave(&p->chip->mixer\_lock, flags);
spin\_lock(&p->chip->reg\_lock);
In snd\_sb\_csp\_load():
spin\_lock\_irqsave(&p->chip->reg\_lock, flags);
spin\_lock(&p->chip->mixer\_lock);
Also the similar pattern is seen in snd\_sb\_csp\_start().
Although the practical impact is very small (those states aren't
triggered in the same running state and this happens only on a real
hardware, decades old ISA sound boards -- which must be very difficult
to find nowadays), it's a real scenario and has to be fixed.
This patch addresses those deadlocks by splitting the locks in
snd\_sb\_csp\_start() and snd\_sb\_csp\_stop() for avoiding the nested
locks.
Reported-by: Jia-Ju Bai
Cc:
Link: https://lore.kernel.org/r/7b0fcdaf-cd4f-4728-2eae-48c151a92e10@gmail.com
Link: https://lore.kernel.org/r/20210716132723.13216-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ecdaa97166666e825c1c8128d0598d577d437174
Author: Alexander Tsoy
Date: Thu Jul 22 02:56:05 2021 +0300
ALSA: usb-audio: Add registration quirk for JBL Quantum headsets
commit b0084afde27fe8a504377dee65f55bc6aa776937 upstream.
These devices has two interfaces, but only the second interface
contains the capture endpoint, thus quirk is required to delay the
registration until the second interface appears.
Tested-by: Jakub Fišer
Signed-off-by: Alexander Tsoy
Cc:
Link: https://lore.kernel.org/r/20210721235605.53741-1-alexander@tsoy.me
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 498129dedee00af52408e4ad0f9ef91b4ba9e821
Author: Takashi Iwai
Date: Wed Jul 14 10:48:36 2021 +0200
ALSA: usb-audio: Add missing proc text entry for BESPOKEN type
commit 64752a95b702817602d72f109ceaf5ec0780e283 upstream.
Recently we've added a new usb\_mixer element type, USB\_MIXER\_BESPOKEN,
but it wasn't added in the table in snd\_usb\_mixer\_dump\_cval(). This
is no big problem since each bespoken type should have its own dump
method, but it still isn't disallowed to use the standard one, so we
should cover it as well. Along with it, define the table with the
explicit array initializer for avoiding other pitfalls.
Fixes: 785b6f29a795 ("ALSA: usb-audio: scarlett2: Fix wrong resume call")
Reported-by: Pavel Machek
Cc:
Link: https://lore.kernel.org/r/20210714084836.1977-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ca4c5e5c7bebe30de6048c1f65fb22a659393cce
Author: Alexander Egorenkov
Date: Fri Jul 16 22:00:22 2021 +0200
s390/boot: fix use of expolines in the DMA code
commit 463f36c76fa4ec015c640ff63ccf52e7527abee0 upstream.
The DMA code section of the decompressor must be compiled with expolines
if Spectre V2 mitigation has been enabled for the decompressed kernel.
This is required because although the decompressor's image contains
the DMA code section, it is handed over to the decompressed kernel for use.
Because the DMA code is already slow w/o expolines, use expolines always
regardless whether the decompressed kernel is using them or not. This
simplifies the DMA code by dropping the conditional compilation of
expolines.
Fixes: bf72630130c2 ("s390: use proper expoline sections for .dma code")
Cc:  # 5.2
Signed-off-by: Alexander Egorenkov
Reviewed-by: Heiko Carstens
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit fde6627ce6dc6864f2b17b6408dc36d012524fb5
Author: Vasily Gorbik
Date: Fri Jun 25 23:50:07 2021 +0200
s390/ftrace: fix ftrace\_update\_ftrace\_func implementation
commit f8c2602733c953ed7a16e060640b8e96f9d94b9b upstream.
s390 enforces DYNAMIC\_FTRACE if FUNCTION\_TRACER is selected.
At the same time implementation of ftrace\_caller is not compliant with
HAVE\_DYNAMIC\_FTRACE since it doesn't provide implementation of
ftrace\_update\_ftrace\_func() and calls ftrace\_trace\_function() directly.
The subtle difference is that during ftrace code patching ftrace
replaces function tracer via ftrace\_update\_ftrace\_func() and activates
it back afterwards. Unexpected direct calls to ftrace\_trace\_function()
during ftrace code patching leads to nullptr-dereferences when tracing
is activated for one of functions which are used during code patching.
Those function currently are:
copy\_from\_kernel\_nofault()
copy\_from\_kernel\_nofault\_allowed()
preempt\_count\_sub() [with debug\_defconfig]
preempt\_count\_add() [with debug\_defconfig]
Corresponding KASAN report:
BUG: KASAN: nullptr-dereference in function\_trace\_call+0x316/0x3b0
Read of size 4 at addr 0000000000001e08 by task migration/0/15
CPU: 0 PID: 15 Comm: migration/0 Tainted: G B 5.13.0-41423-g08316af3644d
Hardware name: IBM 3906 M04 704 (LPAR)
Stopper: multi\_cpu\_stop+0x0/0x3e0 <- stop\_machine\_cpuslocked+0x1e4/0x218
Call Trace:
[<0000000001f77caa>] show\_stack+0x16a/0x1d0
[<0000000001f8de42>] dump\_stack+0x15a/0x1b0
[<0000000001f81d56>] print\_address\_description.constprop.0+0x66/0x2e0
[<000000000082b0ca>] kasan\_report+0x152/0x1c0
[<00000000004cfd8e>] function\_trace\_call+0x316/0x3b0
[<0000000001fb7082>] ftrace\_caller+0x7a/0x7e
[<00000000006bb3e6>] copy\_from\_kernel\_nofault\_allowed+0x6/0x10
[<00000000006bb42e>] copy\_from\_kernel\_nofault+0x3e/0xd0
[<000000000014605c>] ftrace\_make\_call+0xb4/0x1f8
[<000000000047a1b4>] ftrace\_replace\_code+0x134/0x1d8
[<000000000047a6e0>] ftrace\_modify\_all\_code+0x120/0x1d0
[<000000000047a7ec>] \_\_ftrace\_modify\_code+0x5c/0x78
[<000000000042395c>] multi\_cpu\_stop+0x224/0x3e0
[<0000000000423212>] cpu\_stopper\_thread+0x33a/0x5a0
[<0000000000243ff2>] smpboot\_thread\_fn+0x302/0x708
[<00000000002329ea>] kthread+0x342/0x408
[<00000000001066b2>] \_\_ret\_from\_fork+0x92/0xf0
[<0000000001fb57fa>] ret\_from\_fork+0xa/0x30
The buggy address belongs to the page:
page:(\_\_\_\_ptrval\_\_\_\_) refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1
flags: 0x1ffff00000001000(reserved|node=0|zone=0|lastcpupid=0x1ffff)
raw: 1ffff00000001000 0000040000000048 0000040000000048 0000000000000000
raw: 0000000000000000 0000000000000000 ffffffff00000001 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
0000000000001d00: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
0000000000001d80: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
>0000000000001e00: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
^
0000000000001e80: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
0000000000001f00: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7
==================================================================
To fix that introduce ftrace\_func callback to be called from
ftrace\_caller and update it in ftrace\_update\_ftrace\_func().
Fixes: 4cc9bed034d1 ("[S390] cleanup ftrace backend functions")
Cc: stable@vger.kernel.org
Reviewed-by: Heiko Carstens
Signed-off-by: Vasily Gorbik
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 93af4d65538c3e36802f3b45720a5ae6f8076f0a
Author: Stephen Boyd
Date: Wed Jun 23 00:50:02 2021 -0700
mmc: core: Don't allocate IDA for OF aliases
commit 10252bae863d09b9648bed2e035572d207200ca1 upstream.
There's a chance that the IDA allocated in mmc\_alloc\_host() is not freed
for some time because it's freed as part of a class' release function
(see mmc\_host\_classdev\_release() where the IDA is freed). If another
thread is holding a reference to the class, then only once all balancing
device\_put() calls (in turn calling kobject\_put()) have been made will
the IDA be released and usable again.
Normally this isn't a problem because the kobject is released before
anything else that may want to use the same number tries to again, but
with CONFIG\_DEBUG\_KOBJECT\_RELEASE=y and OF aliases it becomes pretty
easy to try to allocate an alias from the IDA twice while the first time
it was allocated is still pending a call to ida\_simple\_remove(). It's
also possible to trigger it by using CONFIG\_DEBUG\_KOBJECT\_RELEASE and
probe defering a driver at boot that calls mmc\_alloc\_host() before
trying to get resources that may defer likes clks or regulators.
Instead of allocating from the IDA in this scenario, let's just skip it
if we know this is an OF alias. The number is already "claimed" and
devices that aren't using OF aliases won't try to use the claimed
numbers anyway (see mmc\_first\_nonreserved\_index()). This should avoid
any issues with mmc\_alloc\_host() returning failures from the
ida\_simple\_get() in the case that we're using an OF alias.
Cc: Matthias Schiffer
Cc: Sujit Kautkar
Reported-by: Zubin Mithra
Fixes: fa2d0aa96941 ("mmc: core: Allow setting slot index via device tree alias")
Signed-off-by: Stephen Boyd
Link: https://lore.kernel.org/r/20210623075002.1746924-3-swboyd@chromium.org
Cc: stable@vger.kernel.org
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 025b6262dc963796992ca32c812f2794e02b6a4f
Author: Olivier Langlois
Date: Wed Jun 23 11:50:11 2021 -0700
io\_uring: Fix race condition when sqp thread goes to sleep
commit 997135017716c33f3405e86cca5da9567b40a08e upstream.
If an asynchronous completion happens before the task is preparing
itself to wait and set its state to TASK\_INTERRUPTIBLE, the completion
will not wake up the sqp thread.
Cc: stable@vger.kernel.org
Signed-off-by: Olivier Langlois
Reviewed-by: Pavel Begunkov
Link: https://lore.kernel.org/r/d1419dc32ec6a97b453bee34dc03fa6a02797142.1624473200.git.olivier@trillion01.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit ccf23a0888077a25a0793a746c3941db2a7562e4
Author: Linus Torvalds
Date: Sat Jul 24 15:25:54 2021 -0700
ACPI: fix NULL pointer dereference
commit fc68f42aa737dc15e7665a4101d4168aadb8e4c4 upstream.
Commit 71f642833284 ("ACPI: utils: Fix reference counting in
for\_each\_acpi\_dev\_match()") started doing "acpi\_dev\_put()" on a pointer
that was possibly NULL. That fails miserably, because that helper
inline function is not set up to handle that case.
Just make acpi\_dev\_put() silently accept a NULL pointer, rather than
calling down to put\_device() with an invalid offset off that NULL
pointer.
Link: https://lore.kernel.org/lkml/a607c149-6bf6-0fd0-0e31-100378504da2@kernel.dk/
Reported-and-tested-by: Jens Axboe
Tested-by: Daniel Scally
Cc: Andy Shevchenko
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 343b467acb55ccafdbb5ad7a3df397040758bff7
Author: Marcelo Henrique Cerri
Date: Wed Jun 30 18:54:38 2021 -0700
proc: Avoid mixing integer types in mem\_rw()
[ Upstream commit d238692b4b9f2c36e35af4c6e6f6da36184aeb3e ]
Use size\_t when capping the count argument received by mem\_rw(). Since
count is size\_t, using min\_t(int, ...) can lead to a negative value
that will later be passed to access\_remote\_vm(), which can cause
unexpected behavior.
Since we are capping the value to at maximum PAGE\_SIZE, the conversion
from size\_t to int when passing it to access\_remote\_vm() as "len"
shouldn't be a problem.
Link: https://lkml.kernel.org/r/20210512125215.3348316-1-marcelo.cerri@canonical.com
Reviewed-by: David Disseldorp
Signed-off-by: Thadeu Lima de Souza Cascardo
Signed-off-by: Marcelo Henrique Cerri
Cc: Alexey Dobriyan
Cc: Souza Cascardo
Cc: Christian Brauner
Cc: Michel Lespinasse
Cc: Helge Deller
Cc: Oleg Nesterov
Cc: Lorenzo Stoakes
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 11b40c8a67fe12d9ce449c130be9567a9663ad72
Author: Ronnie Sahlberg
Date: Fri Jul 23 11:21:24 2021 +1000
cifs: fix fallocate when trying to allocate a hole.
[ Upstream commit 488968a8945c119859d91bb6a8dc13bf50002f15 ]
Remove the conditional checking for out\_data\_len and skipping the fallocate
if it is 0. This is wrong will actually change any legitimate the fallocate
where the entire region is unallocated into a no-op.
Additionally, before allocating the range, if FALLOC\_FL\_KEEP\_SIZE is set then
we need to clamp the length of the fallocate region as to not extend the size of the file.
Fixes: 966a3cb7c7db ("cifs: improve fallocate emulation")
Signed-off-by: Ronnie Sahlberg
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit a803678bd60e7a767138fda0b9f3ec05ec8b9534
Author: Ronnie Sahlberg
Date: Thu Jul 22 14:53:32 2021 +1000
cifs: only write 64kb at a time when fallocating a small region of a file
[ Upstream commit 2485bd7557a7edb4520b4072af464f0a08c8efe0 ]
We only allow sending single credit writes through the SMB2\_write() synchronous
api so split this into smaller chunks.
Fixes: 966a3cb7c7db ("cifs: improve fallocate emulation")
Signed-off-by: Ronnie Sahlberg
Reported-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit ea826bd778f53507ab810b0380d0823761bdbce8
Author: Ioana Ciornei
Date: Thu Jul 22 15:15:51 2021 +0300
dpaa2-switch: seed the buffer pool after allocating the swp
[ Upstream commit 7aaa0f311e2df2704fa8ddb8ed681a3b5841d0bf ]
Any interraction with the buffer pool (seeding a buffer, acquire one) is
made through a software portal (SWP, a DPIO object).
There are circumstances where the dpaa2-switch driver probes on a DPSW
before any DPIO devices have been probed. In this case, seeding of the
buffer pool will lead to a panic since no SWPs are initialized.
To fix this, seed the buffer pool after making sure that the software
portals have been probed and are ready to be used.
Fixes: 0b1b71370458 ("staging: dpaa2-switch: handle Rx path on control interface")
Signed-off-by: Ioana Ciornei
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a0f2f2bf424dec6f2d299d4e1a8035883434e17a
Author: Maxime Ripard
Date: Tue Jul 20 15:45:23 2021 +0200
drm/panel: raspberrypi-touchscreen: Prevent double-free
[ Upstream commit 7bbcb919e32d776ca8ddce08abb391ab92eef6a9 ]
The mipi\_dsi\_device allocated by mipi\_dsi\_device\_register\_full() is
already free'd on release.
Fixes: 2f733d6194bd ("drm/panel: Add support for the Raspberry Pi 7" Touchscreen.")
Signed-off-by: Maxime Ripard
Reviewed-by: Sam Ravnborg
Link: https://patchwork.freedesktop.org/patch/msgid/20210720134525.563936-9-maxime@cerno.tech
Signed-off-by: Sasha Levin
commit 6cd7bb123703048bef66aebfc63e8c8152cc8fdf
Author: Yajun Deng
Date: Thu Jul 22 11:23:43 2021 +0800
net: sched: cls\_api: Fix the the wrong parameter
[ Upstream commit 9d85a6f44bd5585761947f40f7821c9cd78a1bbe ]
The 4th parameter in tc\_chain\_notify() should be flags rather than seq.
Let's change it back correctly.
Fixes: 32a4f5ecd738 ("net: sched: introduce chain object to uapi")
Signed-off-by: Yajun Deng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c95f925b0c7ef9383591c0ed233cb1e06831b07b
Author: Heinrich Schuchardt
Date: Tue Jun 29 15:40:18 2021 +0200
RISC-V: load initrd wherever it fits into memory
[ Upstream commit c79e89ecaa246c880292ba68cbe08c9c30db77e3 ]
Requiring that initrd is loaded below RAM start + 256 MiB led to failure
to boot SUSE Linux with GRUB on QEMU, cf.
https://lists.gnu.org/archive/html/grub-devel/2021-06/msg00037.html
Remove the constraint.
Reported-by: Andreas Schwab
Signed-off-by: Heinrich Schuchardt
Reviewed-by: Atish Patra
Acked-by: Ard Biesheuvel
Fixes: d7071743db31 ("RISC-V: Add EFI stub support.")
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit 0bc325702d70d1e9dfcd4dced086ebf3f6420a7c
Author: Vladimir Oltean
Date: Wed Jul 21 15:37:59 2021 +0300
net: dsa: sja1105: make VID 4095 a bridge VLAN too
[ Upstream commit e40cba9490bab1414d45c2d62defc0ad4f6e4136 ]
This simple series of commands:
ip link add br0 type bridge vlan\_filtering 1
ip link set swp0 master br0
fails on sja1105 with the following error:
[ 33.439103] sja1105 spi0.1: vlan-lookup-table needs to have at least the default untagged VLAN
[ 33.447710] sja1105 spi0.1: Invalid config, cannot upload
Warning: sja1105: Failed to change VLAN Ethertype.
For context, sja1105 has 3 operating modes:
- SJA1105\_VLAN\_UNAWARE: the dsa\_8021q\_vlans are committed to hardware
- SJA1105\_VLAN\_FILTERING\_FULL: the bridge\_vlans are committed to hardware
- SJA1105\_VLAN\_FILTERING\_BEST\_EFFORT: both the dsa\_8021q\_vlans and the
bridge\_vlans are committed to hardware
Swapping out a VLAN list and another in happens in
sja1105\_build\_vlan\_table(), which performs a delta update procedure.
That function is called from a few places, notably from
sja1105\_vlan\_filtering() which is called from the
SWITCHDEV\_ATTR\_ID\_BRIDGE\_VLAN\_FILTERING handler.
The above set of 2 commands fails when run on a kernel pre-commit
8841f6e63f2c ("net: dsa: sja1105: make devlink property
best\_effort\_vlan\_filtering true by default"). So the priv->vlan\_state
transition that takes place is between VLAN-unaware and full VLAN
filtering. So the dsa\_8021q\_vlans are swapped out and the bridge\_vlans
are swapped in.
So why does it fail?
Well, the bridge driver, through nbp\_vlan\_init(), first sets up the
SWITCHDEV\_ATTR\_ID\_BRIDGE\_VLAN\_FILTERING attribute, and only then
proceeds to call nbp\_vlan\_add for the default\_pvid.
So when we swap out the dsa\_8021q\_vlans and swap in the bridge\_vlans in
the SWITCHDEV\_ATTR\_ID\_BRIDGE\_VLAN\_FILTERING handler, there are no bridge
VLANs (yet). So we have wiped the VLAN table clean, and the low-level
static config checker complains of an invalid configuration. We \_will\_
add the bridge VLANs using the dynamic config interface, albeit later,
when nbp\_vlan\_add() calls us. So it is natural that it fails.
So why did it ever work?
Surprisingly, it looks like I only tested this configuration with 2
things set up in a particular way:
- a network manager that brings all ports up
- a kernel with CONFIG\_VLAN\_8021Q=y
It is widely known that commit ad1afb003939 ("vlan\_dev: VLAN 0 should be
treated as "no vlan tag" (802.1p packet)") installs VID 0 to every net
device that comes up. DSA treats these VLANs as bridge VLANs, and
therefore, in my testing, the list of bridge\_vlans was never empty.
However, if CONFIG\_VLAN\_8021Q is not enabled, or the port is not up when
it joins a VLAN-aware bridge, the bridge\_vlans list will be temporarily
empty, and the sja1105\_static\_config\_reload() call from
sja1105\_vlan\_filtering() will fail.
To fix this, the simplest thing is to keep VID 4095, the one used for
CPU-injected control packets since commit ed040abca4c1 ("net: dsa:
sja1105: use 4095 as the private VLAN for untagged traffic"), in the
list of bridge VLANs too, not just the list of tag\_8021q VLANs. This
ensures that the list of bridge VLANs will never be empty.
Fixes: ec5ae61076d0 ("net: dsa: sja1105: save/restore VLANs using a delta commit method")
Reported-by: Radu Pirea (NXP OSS)
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ec7be4fdd8e14c1033a602a273f4ba255f4ee6fd
Author: Wei Wang
Date: Wed Jul 21 10:27:38 2021 -0700
tcp: disable TFO blackhole logic by default
[ Upstream commit 213ad73d06073b197a02476db3a4998e219ddb06 ]
Multiple complaints have been raised from the TFO users on the internet
stating that the TFO blackhole logic is too aggressive and gets falsely
triggered too often.
(e.g. https://blog.apnic.net/2021/07/05/tcp-fast-open-not-so-fast/)
Considering that most middleboxes no longer drop TFO packets, we decide
to disable the blackhole logic by setting
/proc/sys/net/ipv4/tcp\_fastopen\_blackhole\_timeout\_set to 0 by default.
Fixes: cf1ef3f0719b4 ("net/tcp\_fastopen: Disable active side TFO in certain scenarios")
Signed-off-by: Wei Wang
Signed-off-by: Eric Dumazet
Acked-by: Neal Cardwell
Acked-by: Soheil Hassas Yeganeh
Acked-by: Yuchung Cheng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ad9bfbe97bdef94dc27b5407929eb7356c1a5284
Author: Bin Meng
Date: Sun Jun 27 21:51:17 2021 +0800
riscv: Fix 32-bit RISC-V boot failure
[ Upstream commit d0e4dae74470fb709fc0ab61862c317938f4cc4d ]
Commit dd2d082b5760 ("riscv: Cleanup setup\_bootmem()") adjusted
the calling sequence in setup\_bootmem(), which invalidates the fix
commit de043da0b9e7 ("RISC-V: Fix usage of memblock\_enforce\_memory\_limit")
did for 32-bit RISC-V unfortunately.
So now 32-bit RISC-V does not boot again when testing booting kernel
on QEMU 'virt' with '-m 2G', which was exactly what the original
commit de043da0b9e7 ("RISC-V: Fix usage of memblock\_enforce\_memory\_limit")
tried to fix.
Fixes: dd2d082b5760 ("riscv: Cleanup setup\_bootmem()")
Signed-off-by: Bin Meng
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit fecd81c2e62f2de91273117b07362308b398e0d0
Author: Sukadev Bhattiprolu
Date: Tue Jul 20 19:34:39 2021 -0700
ibmvnic: Remove the proper scrq flush
[ Upstream commit bb55362bd6976631b662ca712779b6532d8de0a6 ]
Commit 65d6470d139a ("ibmvnic: clean pending indirect buffs during reset")
intended to remove the call to ibmvnic\_tx\_scrq\_flush() when the
->resetting flag is true and was tested that way. But during the final
rebase to net-next, the hunk got applied to a block few lines below
(which happened to have the same diff context) and the wrong call to
ibmvnic\_tx\_scrq\_flush() got removed.
Fix that by removing the correct ibmvnic\_tx\_scrq\_flush() and restoring
the one that was incorrectly removed.
Fixes: 65d6470d139a ("ibmvnic: clean pending indirect buffs during reset")
Reported-by: Dany Madden
Signed-off-by: Sukadev Bhattiprolu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fee8c811ab344cb996ce98978ca1fdbd2a7e463e
Author: Vadim Fedorenko
Date: Tue Jul 20 23:35:28 2021 +0300
udp: check encap socket in \_\_udp\_lib\_err
[ Upstream commit 9bfce73c8921c92a9565562e6e7d458d37b7ce80 ]
Commit d26796ae5894 ("udp: check udp sock encap\_type in \_\_udp\_lib\_err")
added checks for encapsulated sockets but it broke cases when there is
no implementation of encap\_err\_lookup for encapsulation, i.e. ESP in
UDP encapsulation. Fix it by calling encap\_err\_lookup only if socket
implements this method otherwise treat it as legal socket.
Fixes: d26796ae5894 ("udp: check udp sock encap\_type in \_\_udp\_lib\_err")
Signed-off-by: Vadim Fedorenko
Reviewed-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c1de376423a7759bf4fa25d6a038a4c1e035c9e1
Author: Xin Long
Date: Tue Jul 20 16:07:01 2021 -0400
sctp: update active\_key for asoc when old key is being replaced
[ Upstream commit 58acd10092268831e49de279446c314727101292 ]
syzbot reported a call trace:
BUG: KASAN: use-after-free in sctp\_auth\_shkey\_hold+0x22/0xa0 net/sctp/auth.c:112
Call Trace:
sctp\_auth\_shkey\_hold+0x22/0xa0 net/sctp/auth.c:112
sctp\_set\_owner\_w net/sctp/socket.c:131 [inline]
sctp\_sendmsg\_to\_asoc+0x152e/0x2180 net/sctp/socket.c:1865
sctp\_sendmsg+0x103b/0x1d30 net/sctp/socket.c:2027
inet\_sendmsg+0x99/0xe0 net/ipv4/af\_inet.c:821
sock\_sendmsg\_nosec net/socket.c:703 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:723
This is an use-after-free issue caused by not updating asoc->shkey after
it was replaced in the key list asoc->endpoint\_shared\_keys, and the old
key was freed.
This patch is to fix by also updating active\_key for asoc when old key is
being replaced with a new one. Note that this issue doesn't exist in
sctp\_auth\_del\_key\_id(), as it's not allowed to delete the active\_key
from the asoc.
Fixes: 1b1e0bc99474 ("sctp: add refcnt support for sh\_key")
Reported-by: syzbot+b774577370208727d12b@syzkaller.appspotmail.com
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 65bd5af10d020589d22010c26d800dc8fdafae9c
Author: Christoph Hellwig
Date: Wed Jul 21 10:00:11 2021 +0200
nvme: set the PRACT bit when using Write Zeroes with T10 PI
[ Upstream commit aaeb7bb061be545251606f4d9c82d710ca2a7c8e ]
When using Write Zeroes on a namespace that has protection
information enabled they behavior without the PRACT bit
counter-intuitive and will generally lead to validation failures
when reading the written blocks. Fix this by always setting the
PRACT bit that generates matching PI data on the fly.
Fixes: 6e02318eaea5 ("nvme: add support for the Write Zeroes command")
Signed-off-by: Christoph Hellwig
Reviewed-by: Keith Busch
Reviewed-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit bc08be0ed085f832f882cb60f89a3b7f467b7fde
Author: Sayanta Pattanayak
Date: Tue Jul 20 17:17:40 2021 +0100
r8169: Avoid duplicate sysfs entry creation error
[ Upstream commit e9a72f874d5b95cef0765bafc56005a50f72c5fe ]
When registering the MDIO bus for a r8169 device, we use the PCI
bus/device specifier as a (seemingly) unique device identifier.
However the very same BDF number can be used on another PCI segment,
which makes the driver fail probing:
[ 27.544136] r8169 0002:07:00.0: enabling device (0000 -> 0003)
[ 27.559734] sysfs: cannot create duplicate filename '/class/mdio\_bus/r8169-700'
....
[ 27.684858] libphy: mii\_bus r8169-700 failed to register
[ 27.695602] r8169: probe of 0002:07:00.0 failed with error -22
Add the segment number to the device name to make it more unique.
This fixes operation on ARM N1SDP boards, with two boards connected
together to form an SMP system, and all on-board devices showing up
twice, just on different PCI segments. A similar issue would occur on
large systems with many PCI slots and multiple RTL8169 NICs.
Fixes: f1e911d5d0dfd ("r8169: add basic phylib support")
Signed-off-by: Sayanta Pattanayak
[Andre: expand commit message, use pci\_domain\_nr()]
Signed-off-by: Andre Przywara
Acked-by: Heiner Kallweit
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 2131ea6126924e733c7bd718034927078d037d39
Author: David Howells
Date: Mon Jul 12 17:04:47 2021 +0100
afs: Fix setting of writeback\_index
[ Upstream commit 5a972474cf685bf99ca430979657095bda3a15c8 ]
Fix afs\_writepages() to always set mapping->writeback\_index to a page index
and not a byte position[1].
Fixes: 31143d5d515e ("AFS: implement basic file write support")
Reported-by: Marc Dionne
Signed-off-by: David Howells
Reviewed-by: Marc Dionne
cc: linux-afs@lists.infradead.org
Link: https://lore.kernel.org/r/CAB9dFdvHsLsw7CMnB+4cgciWDSqVjuij4mH3TaXnHQB8sz5rHw@mail.gmail.com/ [1]
Link: https://lore.kernel.org/r/162610728339.3408253.4604750166391496546.stgit@warthog.procyon.org.uk/ # v2 (no v1)
Signed-off-by: Sasha Levin
commit 8dda575c891255cff73d8fbdb0f18e0469b61f49
Author: Tom Rix
Date: Fri Apr 30 08:50:31 2021 -0700
afs: check function return
[ Upstream commit afe6949862f77bcc14fa16ad7938a04e84586d6a ]
Static analysis reports this problem
write.c:773:29: warning: Assigned value is garbage or undefined
mapping->writeback\_index = next;
^ ~~~~
The call to afs\_writepages\_region() can return without setting
next. So check the function return before using next.
Changes:
ver #2:
- Need to fix the range\_cyclic case also[1].
Fixes: e87b03f5830e ("afs: Prepare for use of THPs")
Signed-off-by: Tom Rix
Signed-off-by: David Howells
Reviewed-by: Marc Dionne
cc: linux-afs@lists.infradead.org
Link: https://lore.kernel.org/r/20210430155031.3287870-1-trix@redhat.com
Link: https://lore.kernel.org/r/CAB9dFdvHsLsw7CMnB+4cgciWDSqVjuij4mH3TaXnHQB8sz5rHw@mail.gmail.com/ [1]
Link: https://lore.kernel.org/r/162609464716.3133237.10354897554363093252.stgit@warthog.procyon.org.uk/ # v1
Link: https://lore.kernel.org/r/162610727640.3408253.8687445613469681311.stgit@warthog.procyon.org.uk/ # v2
Signed-off-by: Sasha Levin
commit 3d888afffcf389c3f6a109056a3621229266d327
Author: David Howells
Date: Tue Jun 15 11:57:26 2021 +0100
afs: Fix tracepoint string placement with built-in AFS
[ Upstream commit 6c881ca0b3040f3e724eae513117ba4ddef86057 ]
To quote Alexey[1]:
I was adding custom tracepoint to the kernel, grabbed full F34 kernel
.config, disabled modules and booted whole shebang as VM kernel.
Then did
perf record -a -e ...
It crashed:
general protection fault, probably for non-canonical address 0x435f5346592e4243: 0000 [#1] SMP PTI
CPU: 1 PID: 842 Comm: cat Not tainted 5.12.6+ #26
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-1.fc33 04/01/2014
RIP: 0010:t\_show+0x22/0xd0
Then reproducer was narrowed to
# cat /sys/kernel/tracing/printk\_formats
Original F34 kernel with modules didn't crash.
So I started to disable options and after disabling AFS everything
started working again.
The root cause is that AFS was placing char arrays content into a
section full of \_pointers\_ to strings with predictable consequences.
Non canonical address 435f5346592e4243 is "CB.YFS\_" which came from
CM\_NAME macro.
Steps to reproduce:
CONFIG\_AFS=y
CONFIG\_TRACING=y
# cat /sys/kernel/tracing/printk\_formats
Fix this by the following means:
(1) Add enum->string translation tables in the event header with the AFS
and YFS cache/callback manager operations listed by RPC operation ID.
(2) Modify the afs\_cb\_call tracepoint to print the string from the
translation table rather than using the string at the afs\_call name
pointer.
(3) Switch translation table depending on the service we're being accessed
as (AFS or YFS) in the tracepoint print clause. Will this cause
problems to userspace utilities?
Note that the symbolic representation of the YFS service ID isn't
available to this header, so I've put it in as a number. I'm not sure
if this is the best way to do this.
(4) Remove the name wrangling (CM\_NAME) macro and put the names directly
into the afs\_call\_type structs in cmservice.c.
Fixes: 8e8d7f13b6d5a9 ("afs: Add some tracepoints")
Reported-by: Alexey Dobriyan (SK hynix)
Signed-off-by: David Howells
Reviewed-by: Steven Rostedt (VMware)
Reviewed-by: Marc Dionne
cc: Andrew Morton
cc: linux-afs@lists.infradead.org
Link: https://lore.kernel.org/r/YLAXfvZ+rObEOdc%2F@localhost.localdomain/ [1]
Link: https://lore.kernel.org/r/643721.1623754699@warthog.procyon.org.uk/
Link: https://lore.kernel.org/r/162430903582.2896199.6098150063997983353.stgit@warthog.procyon.org.uk/ # v1
Link: https://lore.kernel.org/r/162609463957.3133237.15916579353149746363.stgit@warthog.procyon.org.uk/ # v1 (repost)
Link: https://lore.kernel.org/r/162610726860.3408253.445207609466288531.stgit@warthog.procyon.org.uk/ # v2
Signed-off-by: Sasha Levin
commit 6bd6db23b44d9e13a0688c0fd167a9344dae6865
Author: Vincent Palatin
Date: Wed Jul 21 11:25:16 2021 +0200
Revert "USB: quirks: ignore remote wake-up on Fibocom L850-GL LTE modem"
[ Upstream commit f3a1a937f7b240be623d989c8553a6d01465d04f ]
This reverts commit 0bd860493f81eb2a46173f6f5e44cc38331c8dbd.
While the patch was working as stated,ie preventing the L850-GL LTE modem
from crashing on some U3 wake-ups due to a race condition between the
host wake-up and the modem-side wake-up, when using the MBIM interface,
this would force disabling the USB runtime PM on the device.
The increased power consumption is significant for LTE laptops,
and given that with decently recent modem firmwares, when the modem hits
the bug, it automatically recovers (ie it drops from the bus, but
automatically re-enumerates after less than half a second, rather than being
stuck until a power cycle as it was doing with ancient firmware), for
most people, the trade-off now seems in favor of re-enabling it by
default.
For people with access to the platform code, the bug can also be worked-around
successfully by changing the USB3 LFPM polling off-time for the XHCI
controller in the BIOS code.
Signed-off-by: Vincent Palatin
Link: https://lore.kernel.org/r/20210721092516.2775971-1-vpalatin@chromium.org
Fixes: 0bd860493f81 ("USB: quirks: ignore remote wake-up on Fibocom L850-GL LTE modem")
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit de3a841649ae4b463088d4aaaf3c32399f134e67
Author: Zhihao Cheng
Date: Mon Jul 5 21:38:29 2021 +0800
nvme-pci: don't WARN\_ON in nvme\_reset\_work if ctrl.state is not RESETTING
[ Upstream commit 7764656b108cd308c39e9a8554353b8f9ca232a3 ]
Followling process:
nvme\_probe
nvme\_reset\_ctrl
nvme\_change\_ctrl\_state(ctrl, NVME\_CTRL\_RESETTING)
queue\_work(nvme\_reset\_wq, &ctrl->reset\_work)
--------------> nvme\_remove
nvme\_change\_ctrl\_state(&dev->ctrl, NVME\_CTRL\_DELETING)
worker\_thread
process\_one\_work
nvme\_reset\_work
WARN\_ON(dev->ctrl.state != NVME\_CTRL\_RESETTING)
, which will trigger WARN\_ON in nvme\_reset\_work():
[ 127.534298] WARNING: CPU: 0 PID: 139 at drivers/nvme/host/pci.c:2594
[ 127.536161] CPU: 0 PID: 139 Comm: kworker/u8:7 Not tainted 5.13.0
[ 127.552518] Call Trace:
[ 127.552840] ? kvm\_sched\_clock\_read+0x25/0x40
[ 127.553936] ? native\_send\_call\_func\_single\_ipi+0x1c/0x30
[ 127.555117] ? send\_call\_function\_single\_ipi+0x9b/0x130
[ 127.556263] ? \_\_smp\_call\_single\_queue+0x48/0x60
[ 127.557278] ? ttwu\_queue\_wakelist+0xfa/0x1c0
[ 127.558231] ? try\_to\_wake\_up+0x265/0x9d0
[ 127.559120] ? ext4\_end\_io\_rsv\_work+0x160/0x290
[ 127.560118] process\_one\_work+0x28c/0x640
[ 127.561002] worker\_thread+0x39a/0x700
[ 127.561833] ? rescuer\_thread+0x580/0x580
[ 127.562714] kthread+0x18c/0x1e0
[ 127.563444] ? set\_kthread\_struct+0x70/0x70
[ 127.564347] ret\_from\_fork+0x1f/0x30
The preceding problem can be easily reproduced by executing following
script (based on blktests suite):
test() {
pdev="$(\_get\_pci\_dev\_from\_blkdev)"
sysfs="/sys/bus/pci/devices/${pdev}"
for ((i = 0; i < 10; i++)); do
echo 1 > "$sysfs/remove"
echo 1 > /sys/bus/pci/rescan
done
}
Since the device ctrl could be updated as an non-RESETTING state by
repeating probe/remove in userspace (which is a normal situation), we
can replace stack dumping WARN\_ON with a warnning message.
Fixes: 82b057caefaff ("nvme-pci: fix multiple ctrl removal schedulin")
Signed-off-by: Zhihao Cheng
Signed-off-by: Sasha Levin
commit a521c15683c1d604a85c3829d1a8428040807f35
Author: Jason Ekstrand
Date: Tue Jul 20 13:13:55 2021 -0500
drm/ttm: Force re-init if ttm\_global\_init() fails
[ Upstream commit 235c3610d5f02ee91244239b43cd9ae8b4859dff ]
If we have a failure, decrement the reference count so that the next
call to ttm\_global\_init() will actually do something instead of assume
everything is all set up.
Signed-off-by: Jason Ekstrand
Fixes: 62b53b37e4b1 ("drm/ttm: use a static ttm\_bo\_global instance")
Reviewed-by: Christian König
Link: https://patchwork.freedesktop.org/patch/msgid/20210720181357.2760720-5-jason@jlekstrand.net
Signed-off-by: Christian König
Signed-off-by: Sasha Levin
commit e7732c5a19a15a62b0b23fd683a639b0483e1f40
Author: David Disseldorp
Date: Wed Jul 21 00:55:22 2021 +0200
scsi: target: Fix NULL dereference on XCOPY completion
[ Upstream commit a47fa41381a09e5997afd762664db4f5f6657e03 ]
CPU affinity control added with commit 39ae3edda325 ("scsi: target: core:
Make completion affinity configurable") makes target\_complete\_cmd() queue
work on a CPU based on se\_tpg->se\_tpg\_wwn->cmd\_compl\_affinity state.
LIO's EXTENDED COPY worker is a special case in that read/write cmds are
dispatched using the global xcopy\_pt\_tpg, which carries a NULL se\_tpg\_wwn
pointer following initialization in target\_xcopy\_setup\_pt().
The NULL xcopy\_pt\_tpg->se\_tpg\_wwn pointer is dereferenced on completion of
any EXTENDED COPY initiated read/write cmds. E.g using the libiscsi
SCSI.ExtendedCopy.Simple test:
BUG: kernel NULL pointer dereference, address: 00000000000001a8
RIP: 0010:target\_complete\_cmd+0x9d/0x130 [target\_core\_mod]
Call Trace:
fd\_execute\_rw+0x148/0x42a [target\_core\_file]
? \_\_dynamic\_pr\_debug+0xa7/0xe0
? target\_check\_reservation+0x5b/0x940 [target\_core\_mod]
\_\_target\_execute\_cmd+0x1e/0x90 [target\_core\_mod]
transport\_generic\_new\_cmd+0x17c/0x330 [target\_core\_mod]
target\_xcopy\_issue\_pt\_cmd+0x9/0x60 [target\_core\_mod]
target\_xcopy\_read\_source.isra.7+0x10b/0x1b0 [target\_core\_mod]
? target\_check\_fua+0x40/0x40 [target\_core\_mod]
? transport\_complete\_task\_attr+0x130/0x130 [target\_core\_mod]
target\_xcopy\_do\_work+0x61f/0xc00 [target\_core\_mod]
This fix makes target\_complete\_cmd() queue work on se\_cmd->cpuid if
se\_tpg\_wwn is NULL.
Link: https://lore.kernel.org/r/20210720225522.26291-1-ddiss@suse.de
Fixes: 39ae3edda325 ("scsi: target: core: Make completion affinity configurable")
Cc: Lee Duncan
Cc: Mike Christie
Reviewed-by: Mike Christie
Signed-off-by: David Disseldorp
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 2ed13e8f7829dc9011a3d02f25c63b9ce14e9c94
Author: Chris Packham
Date: Fri Jul 16 08:58:32 2021 +1200
i2c: mpc: Poll for MCF
[ Upstream commit 4a8ac5e45cdaa88884b4ce05303e304cbabeb367 ]
During some transfers the bus can still be busy when an interrupt is
received. Commit 763778cd7926 ("i2c: mpc: Restore reread of I2C status
register") attempted to address this by re-reading MPC\_I2C\_SR once but
that just made it less likely to happen without actually preventing it.
Instead of a single re-read, poll with a timeout so that the bus is given
enough time to settle but a genuine stuck SCL is still noticed.
Fixes: 1538d82f4647 ("i2c: mpc: Interrupt driven transfer")
Signed-off-by: Chris Packham
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit a706c12da916ef6fd7b31664d1caffe0b1d4a1d3
Author: Luis Henriques
Date: Thu Jul 15 14:40:39 2021 +0100
ceph: don't WARN if we're still opening a session to an MDS
[ Upstream commit cdb330f4b41ab55feb35487729e883c9e08b8a54 ]
If MDSs aren't available while mounting a filesystem, the session state
will transition from SESSION\_OPENING to SESSION\_CLOSING. And in that
scenario check\_session\_state() will be called from delayed\_work() and
trigger this WARN.
Avoid this by only WARNing after a session has already been established
(i.e., the s\_ttl will be different from 0).
Fixes: 62575e270f66 ("ceph: check session state after bumping session->s\_seq")
Signed-off-by: Luis Henriques
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Sasha Levin
commit 115784bcccf135c3a3548098153413d76f16aae0
Author: Paolo Abeni
Date: Tue Jul 20 15:08:40 2021 +0200
ipv6: fix another slab-out-of-bounds in fib6\_nh\_flush\_exceptions
[ Upstream commit 8fb4792f091e608a0a1d353dfdf07ef55a719db5 ]
While running the self-tests on a KASAN enabled kernel, I observed a
slab-out-of-bounds splat very similar to the one reported in
commit 821bbf79fe46 ("ipv6: Fix KASAN: slab-out-of-bounds Read in
fib6\_nh\_flush\_exceptions").
We additionally need to take care of fib6\_metrics initialization
failure when the caller provides an nh.
The fix is similar, explicitly free the route instead of calling
fib6\_info\_release on a half-initialized object.
Fixes: f88d8ea67fbdb ("ipv6: Plumb support for nexthop object in a fib6\_info")
Signed-off-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 34f1e1f657fae2891b485a3b2b95fe4d2aef9f0d
Author: Peilin Ye
Date: Mon Jul 19 16:41:24 2021 -0700
net/sched: act\_skbmod: Skip non-Ethernet packets
[ Upstream commit 727d6a8b7ef3d25080fad228b2c4a1d4da5999c6 ]
Currently tcf\_skbmod\_act() assumes that packets use Ethernet as their L2
protocol, which is not always the case. As an example, for CAN devices:
$ ip link add dev vcan0 type vcan
$ ip link set up vcan0
$ tc qdisc add dev vcan0 root handle 1: htb
$ tc filter add dev vcan0 parent 1: protocol ip prio 10 \
matchall action skbmod swap mac
Doing the above silently corrupts all the packets. Do not perform skbmod
actions for non-Ethernet packets.
Fixes: 86da71b57383 ("net\_sched: Introduce skbmod action")
Reviewed-by: Cong Wang
Signed-off-by: Peilin Ye
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 502731a03f27cba1513fbbff77e508185ffce5bb
Author: Yang Yingliang
Date: Tue Jul 20 16:38:05 2021 +0800
io\_uring: fix memleak in io\_init\_wq\_offload()
[ Upstream commit 362a9e65289284f36403058eea2462d0330c1f24 ]
I got memory leak report when doing fuzz test:
BUG: memory leak
unreferenced object 0xffff888107310a80 (size 96):
comm "syz-executor.6", pid 4610, jiffies 4295140240 (age 20.135s)
hex dump (first 32 bytes):
01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 00 00 ad 4e ad de ff ff ff ff 00 00 00 00 .....N..........
backtrace:
[<000000001974933b>] kmalloc include/linux/slab.h:591 [inline]
[<000000001974933b>] kzalloc include/linux/slab.h:721 [inline]
[<000000001974933b>] io\_init\_wq\_offload fs/io\_uring.c:7920 [inline]
[<000000001974933b>] io\_uring\_alloc\_task\_context+0x466/0x640 fs/io\_uring.c:7955
[<0000000039d0800d>] \_\_io\_uring\_add\_tctx\_node+0x256/0x360 fs/io\_uring.c:9016
[<000000008482e78c>] io\_uring\_add\_tctx\_node fs/io\_uring.c:9052 [inline]
[<000000008482e78c>] \_\_do\_sys\_io\_uring\_enter fs/io\_uring.c:9354 [inline]
[<000000008482e78c>] \_\_se\_sys\_io\_uring\_enter fs/io\_uring.c:9301 [inline]
[<000000008482e78c>] \_\_x64\_sys\_io\_uring\_enter+0xabc/0xc20 fs/io\_uring.c:9301
[<00000000b875f18f>] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[<00000000b875f18f>] do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
[<000000006b0a8484>] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
CPU0 CPU1
io\_uring\_enter io\_uring\_enter
io\_uring\_add\_tctx\_node io\_uring\_add\_tctx\_node
\_\_io\_uring\_add\_tctx\_node \_\_io\_uring\_add\_tctx\_node
io\_uring\_alloc\_task\_context io\_uring\_alloc\_task\_context
io\_init\_wq\_offload io\_init\_wq\_offload
hash = kzalloc hash = kzalloc
ctx->hash\_map = hash ctx->hash\_map = hash <- one of the hash is leaked
When calling io\_uring\_enter() in parallel, the 'hash\_map' will be leaked,
add uring\_lock to protect 'hash\_map'.
Fixes: e941894eae31 ("io-wq: make buffered file write hashed work map per-ctx")
Reported-by: Hulk Robot
Signed-off-by: Yang Yingliang
Reviewed-by: Pavel Begunkov
Link: https://lore.kernel.org/r/20210720083805.3030730-1-yangyingliang@huawei.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 23c492a5041896ba62e5e9c4aad1ca5d4853d92d
Author: Alexandru Tachici
Date: Sat Jul 17 00:02:45 2021 +0300
spi: spi-bcm2835: Fix deadlock
[ Upstream commit c45c1e82bba130db4f19d9dbc1deefcf4ea994ed ]
The bcm2835\_spi\_transfer\_one function can create a deadlock
if it is called while another thread already has the
CCF lock.
Signed-off-by: Alexandru Tachici
Fixes: f8043872e796 ("spi: add driver for BCM2835")
Reviewed-by: Florian Fainelli
Link: https://lore.kernel.org/r/20210716210245.13240-2-alexandru.tachici@analog.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 140e0dbad4cf04da50d8acc09e33de760c3c554b
Author: Jian Shen
Date: Mon Jul 19 17:13:08 2021 +0800
net: hns3: fix rx VLAN offload state inconsistent issue
[ Upstream commit bbfd4506f962e7e6fff8f37f017154a3c3791264 ]
Currently, VF doesn't enable rx VLAN offload when initializating,
and PF does it for VFs. If user disable the rx VLAN offload for
VF with ethtool -K, and reload the VF driver, it may cause the
rx VLAN offload state being inconsistent between hardware and
software.
Fixes it by enabling rx VLAN offload when VF initializing.
Fixes: e2cb1dec9779 ("net: hns3: Add HNS3 VF HCL(Hardware Compatibility Layer) Support")
Signed-off-by: Jian Shen
Signed-off-by: Guangbin Huang
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 1e3b38761394c699e898674fd3237f2cf3c0d990
Author: Chengwen Feng
Date: Mon Jul 19 17:13:05 2021 +0800
net: hns3: fix possible mismatches resp of mailbox
[ Upstream commit 1b713d14dc3c077ec45e65dab4ea01a8bc41b8c1 ]
Currently, the mailbox synchronous communication between VF and PF use
the following fields to maintain communication:
1. Origin\_mbx\_msg which was combined by message code and subcode, used
to match request and response.
2. Received\_resp which means whether received response.
There may possible mismatches of the following situation:
1. VF sends message A with code=1 subcode=1.
2. PF was blocked about 500ms when processing the message A.
3. VF will detect message A timeout because it can't get the response
within 500ms.
4. VF sends message B with code=1 subcode=1 which equal message A.
5. PF processes the first message A and send the response message to
VF.
6. VF will identify the response matched the message B because the
code/subcode is the same. This will lead to mismatch of request and
response.
To fix the above bug, we use the following scheme:
1. The message sent from VF was labelled with match\_id which was a
unique 16-bit non-zero value.
2. The response sent from PF will label with match\_id which got from
the request.
3. The VF uses the match\_id to match request and response message.
As for PF driver, it only needs to copy the match\_id from request to
response.
Fixes: dde1a86e93ca ("net: hns3: Add mailbox support to PF driver")
Signed-off-by: Chengwen Feng
Signed-off-by: Guangbin Huang
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit e52445629c2e4306f3169397f8c06d3798592217
Author: Pierre-Louis Bossart
Date: Mon Jul 19 18:17:46 2021 -0500
ALSA: hda: intel-dsp-cfg: add missing ElkhartLake PCI ID
[ Upstream commit 114613f62f42e7cbc1242c4e82076a0153043761 ]
We missed the fact that ElkhartLake platforms have two different PCI
IDs. We only added one so the SOF driver is never selected by the
autodetection logic for the missing configuration.
BugLink: https://github.com/thesofproject/linux/issues/2990
Fixes: cc8f81c7e625 ('ALSA: hda: fix intel DSP config')
Signed-off-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20210719231746.557325-1-pierre-louis.bossart@linux.intel.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit ce9f267d9e8a612e34d581bd29b04ec45f9c8ea5
Author: Eric Dumazet
Date: Mon Jul 19 02:12:18 2021 -0700
net/tcp\_fastopen: fix data races around tfo\_active\_disable\_stamp
[ Upstream commit 6f20c8adb1813467ea52c1296d52c4e95978cb2f ]
tfo\_active\_disable\_stamp is read and written locklessly.
We need to annotate these accesses appropriately.
Then, we need to perform the atomic\_inc(tfo\_active\_disable\_times)
after the timestamp has been updated, and thus add barriers
to make sure tcp\_fastopen\_active\_should\_disable() wont read
a stale timestamp.
Fixes: cf1ef3f0719b ("net/tcp\_fastopen: Disable active side TFO in certain scenarios")
Signed-off-by: Eric Dumazet
Cc: Wei Wang
Cc: Yuchung Cheng
Cc: Neal Cardwell
Acked-by: Wei Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b9d21b9b46bda14fe74a97a593c5bee258d064d3
Author: Randy Dunlap
Date: Sun Jul 18 13:38:34 2021 -0700
net: hisilicon: rename CACHE\_LINE\_MASK to avoid redefinition
[ Upstream commit b16f3299ae1aa3c327e1fb742d0379ae4d6e86f2 ]
Building on ARCH=arc causes a "redefined" warning, so rename this
driver's CACHE\_LINE\_MASK to avoid the warning.
../drivers/net/ethernet/hisilicon/hip04\_eth.c:134: warning: "CACHE\_LINE\_MASK" redefined
134 | #define CACHE\_LINE\_MASK 0x3F
In file included from ../include/linux/cache.h:6,
from ../include/linux/printk.h:9,
from ../include/linux/kernel.h:19,
from ../include/linux/list.h:9,
from ../include/linux/module.h:12,
from ../drivers/net/ethernet/hisilicon/hip04\_eth.c:7:
../arch/arc/include/asm/cache.h:17: note: this is the location of the previous definition
17 | #define CACHE\_LINE\_MASK (~(L1\_CACHE\_BYTES - 1))
Fixes: d413779cdd93 ("net: hisilicon: Add an tx\_desc to adapt HI13X1\_GMAC")
Signed-off-by: Randy Dunlap
Cc: Vineet Gupta
Cc: Jiangfeng Xiao
Cc: "David S. Miller"
Cc: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a24886feddbae495a7ea3ee266c59b0fd5820e6a
Author: Somnath Kotur
Date: Sun Jul 18 15:36:31 2021 -0400
bnxt\_en: Check abort error state in bnxt\_half\_open\_nic()
[ Upstream commit 11a39259ff79b74bc99f8b7c44075a2d6d5e7ab1 ]
bnxt\_half\_open\_nic() is called during during ethtool self test and is
protected by rtnl\_lock. Firmware reset can be happening at the same
time. Only critical portions of the entire firmware reset sequence
are protected by the rtnl\_lock. It is possible that bnxt\_half\_open\_nic()
can be called when the firmware reset sequence is aborting. In that
case, bnxt\_half\_open\_nic() needs to check if the ABORT\_ERR flag is set
and abort if it is. The ethtool self test will fail but the NIC will be
brought to a consistent IF\_DOWN state.
Without this patch, if bnxt\_half\_open\_nic() were to continue in this
error state, it may crash like this:
bnxt\_en 0000:82:00.1 enp130s0f1np1: FW reset in progress during close, FW reset will be aborted
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
...
Process ethtool (pid: 333327, stack limit = 0x0000000046476577)
Call trace:
bnxt\_alloc\_mem+0x444/0xef0 [bnxt\_en]
bnxt\_half\_open\_nic+0x24/0xb8 [bnxt\_en]
bnxt\_self\_test+0x2dc/0x390 [bnxt\_en]
ethtool\_self\_test+0xe0/0x1f8
dev\_ethtool+0x1744/0x22d0
dev\_ioctl+0x190/0x3e0
sock\_ioctl+0x238/0x480
do\_vfs\_ioctl+0xc4/0x758
ksys\_ioctl+0x84/0xb8
\_\_arm64\_sys\_ioctl+0x28/0x38
el0\_svc\_handler+0xb0/0x180
el0\_svc+0x8/0xc
Fixes: a1301f08c5ac ("bnxt\_en: Check abort error state in bnxt\_open\_nic().")
Signed-off-by: Somnath Kotur
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c2ed50ff29f829d246679a067b17d6e9969186e5
Author: Michael Chan
Date: Sun Jul 18 15:36:30 2021 -0400
bnxt\_en: Validate vlan protocol ID on RX packets
[ Upstream commit 96bdd4b9ea7ef9a12db8fdd0ce90e37dffbd3703 ]
Only pass supported VLAN protocol IDs for stripped VLAN tags to the
stack. The stack will hit WARN() if the protocol ID is unsupported.
Existing firmware sets up the chip to strip 0x8100, 0x88a8, 0x9100.
Only the 1st two protocols are supported by the kernel.
Fixes: a196e96bb68f ("bnxt\_en: clean up VLAN feature bit handling")
Reviewed-by: Somnath Kotur
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a1a54e07e63c8537ee511de7788e3274accd0340
Author: Somnath Kotur
Date: Sun Jul 18 15:36:29 2021 -0400
bnxt\_en: fix error path of FW reset
[ Upstream commit 3958b1da725a477b4a222183d16a14d85445d4b6 ]
When bnxt\_open() fails in the firmware reset path, the driver needs to
gracefully abort, but it is executing code that should be invoked only
in the success path. Define a function to abort FW reset and
consolidate all error paths to call this new function.
Fixes: dab62e7c2de7 ("bnxt\_en: Implement faster recovery for firmware fatal error.")
Signed-off-by: Somnath Kotur
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c8c2eed44e41518003d95af987f6dbe9cb530e77
Author: Michael Chan
Date: Sun Jul 18 15:36:28 2021 -0400
bnxt\_en: Add missing check for BNXT\_STATE\_ABORT\_ERR in bnxt\_fw\_rset\_task()
[ Upstream commit 6cd657cb3ee6f4de57e635b126ffbe0e51d00f1a ]
In the BNXT\_FW\_RESET\_STATE\_POLL\_VF state in bnxt\_fw\_reset\_task() after all
VFs have unregistered, we need to check for BNXT\_STATE\_ABORT\_ERR after
we acquire the rtnl\_lock. If the flag is set, we need to abort.
Fixes: 230d1f0de754 ("bnxt\_en: Handle firmware reset.")
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4564b85633b2df1f737565c164a0477c798b156b
Author: Michael Chan
Date: Sun Jul 18 15:36:27 2021 -0400
bnxt\_en: Refresh RoCE capabilities in bnxt\_ulp\_probe()
[ Upstream commit 2c9f046bc377efd1f5e26e74817d5f96e9506c86 ]
The capabilities can change after firmware upgrade/downgrade, so we
should get the up-to-date RoCE capabilities everytime bnxt\_ulp\_probe()
is called.
Fixes: 2151fe0830fd ("bnxt\_en: Handle RESET\_NOTIFY async event from firmware.")
Reviewed-by: Somnath Kotur
Reviewed-by: Edwin Peer
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 52b6ad30a026c675f0a9be8c51b0bb9116339b14
Author: Kalesh AP
Date: Sun Jul 18 15:36:25 2021 -0400
bnxt\_en: don't disable an already disabled PCI device
[ Upstream commit c81cfb6256d90ea5ba4a6fb280ea3b171be4e05c ]
If device is already disabled in reset path and PCI io error is
detected before the device could be enabled, driver could
call pci\_disable\_device() for already disabled device. Fix this
problem by calling pci\_disable\_device() only if the device is already
enabled.
Fixes: 6316ea6db93d ("bnxt\_en: Enable AER support.")
Signed-off-by: Kalesh AP
Signed-off-by: Michael Chan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8ac2e2d69b353ba013e2cd4c2355ede98b542bbe
Author: Andy Shevchenko
Date: Mon Jul 12 21:21:21 2021 +0300
ACPI: utils: Fix reference counting in for\_each\_acpi\_dev\_match()
[ Upstream commit 71f6428332844f38c7cb10461d9f29e9c9b983a0 ]
Currently it's possible to iterate over the dangling pointer in case the device
suddenly disappears. This may happen becase callers put it at the end of a loop.
Instead, let's move that call inside acpi\_dev\_get\_next\_match\_dev().
Fixes: 803abec64ef9 ("media: ipu3-cio2: Add cio2-bridge to ipu3-cio2 driver")
Fixes: bf263f64e804 ("media: ACPI / bus: Add acpi\_dev\_get\_next\_match\_dev() and helper macro")
Fixes: edbd1bc4951e ("efi/dev-path-parser: Switch to use for\_each\_acpi\_dev\_match()")
Signed-off-by: Andy Shevchenko
Reviewed-by: Daniel Scally
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit 587c2751068a8a78197f6b2d80357d42c828205a
Author: Andy Shevchenko
Date: Sun Apr 4 21:12:16 2021 +0300
efi/dev-path-parser: Switch to use for\_each\_acpi\_dev\_match()
[ Upstream commit edbd1bc4951eff8da65732dbe0d381e555054428 ]
Switch to use for\_each\_acpi\_dev\_match() instead of home grown analogue.
No functional change intended.
Signed-off-by: Andy Shevchenko
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
commit 4657af6770c0bfc0b60751cf5fbb8e562d72150a
Author: Robert Richter
Date: Thu Jul 15 11:26:01 2021 +0200
ACPI: Kconfig: Fix table override from built-in initrd
[ Upstream commit d2cbbf1fe503c07e466c62f83aa1926d74d15821 ]
During a rework of initramfs code the INITRAMFS\_COMPRESSION config
option was removed in commit 65e00e04e5ae. A leftover as a dependency
broke the config option ACPI\_TABLE\_OVERRIDE\_VIA\_ BUILTIN\_INITRD that
is used to enable the overriding of ACPI tables from built-in initrd.
Fixing the dependency.
Fixes: 65e00e04e5ae ("initramfs: refactor the initramfs build rules")
Signed-off-by: Robert Richter
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Sasha Levin
commit 24376facf2fd3d4df77a5f61a711615ed037ca04
Author: Marek Vasut
Date: Fri Jul 16 20:21:33 2021 +0200
spi: cadence: Correct initialisation of runtime PM again
[ Upstream commit 56912da7a68c8356df6a6740476237441b0b792a ]
The original implementation of RPM handling in probe() was mostly
correct, except it failed to call pm\_runtime\_get\_\*() to activate the
hardware. The subsequent fix, 734882a8bf98 ("spi: cadence: Correct
initialisation of runtime PM"), breaks the implementation further,
to the point where the system using this hard IP on ZynqMP hangs on
boot, because it accesses hardware which is gated off.
Undo 734882a8bf98 ("spi: cadence: Correct initialisation of runtime
PM") and instead add missing pm\_runtime\_get\_noresume() and move the
RPM disabling all the way to the end of probe(). That makes ZynqMP
not hang on boot yet again.
Fixes: 734882a8bf98 ("spi: cadence: Correct initialisation of runtime PM")
Signed-off-by: Marek Vasut
Cc: Charles Keepax
Cc: Mark Brown
Link: https://lore.kernel.org/r/20210716182133.218640-1-marex@denx.de
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 6128d746d705d3cd74f84f81119fc8850cc96c92
Author: Dmitry Bogdanov
Date: Fri Jul 2 12:16:55 2021 +0300
scsi: target: Fix protect handling in WRITE SAME(32)
[ Upstream commit 6d8e7e7c932162bccd06872362751b0e1d76f5af ]
WRITE SAME(32) command handling reads WRPROTECT at the wrong offset in 1st
byte instead of 10th byte.
Link: https://lore.kernel.org/r/20210702091655.22818-1-d.bogdanov@yadro.com
Fixes: afd73f1b60fc ("target: Perform PROTECT sanity checks for WRITE\_SAME")
Signed-off-by: Dmitry Bogdanov
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 868ffb5f290f4582238854e1ff96b1506102e9e9
Author: Mike Christie
Date: Wed Jun 30 19:25:59 2021 -0500
scsi: iscsi: Fix iface sysfs attr detection
[ Upstream commit e746f3451ec7f91dcc9fd67a631239c715850a34 ]
A ISCSI\_IFACE\_PARAM can have the same value as a ISCSI\_NET\_PARAM so when
iscsi\_iface\_attr\_is\_visible tries to figure out the type by just checking
the value, we can collide and return the wrong type. When we call into the
driver we might not match and return that we don't want attr visible in
sysfs. The patch fixes this by setting the type when we figure out what the
param is.
Link: https://lore.kernel.org/r/20210701002559.89533-1-michael.christie@oracle.com
Fixes: 3e0f65b34cc9 ("[SCSI] iscsi\_transport: Additional parameters for network settings")
Signed-off-by: Mike Christie
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit bc1660206c3723c37ed4d622ad81781f1e987250
Author: Nguyen Dinh Phi
Date: Sun Jul 18 22:40:13 2021 +0800
netrom: Decrease sock refcount when sock timers expire
[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c9437655302c503caa2a7ecf7a3167ee6a02cbef
Author: Xin Long
Date: Sat Jul 17 17:19:19 2021 -0400
sctp: trim optlen when it's a huge value in sctp\_setsockopt
[ Upstream commit 2f3fdd8d4805015fa964807e1c7f3d88f31bd389 ]
After commit ca84bd058dae ("sctp: copy the optval from user space in
sctp\_setsockopt"), it does memory allocation in sctp\_setsockopt with
the optlen, and it would fail the allocation and return error if the
optlen from user space is a huge value.
This breaks some sockopts, like SCTP\_HMAC\_IDENT, SCTP\_RESET\_STREAMS and
SCTP\_AUTH\_KEY, as when processing these sockopts before, optlen would
be trimmed to a biggest value it needs when optlen is a huge value,
instead of failing the allocation and returning error.
This patch is to fix the allocation failure when it's a huge optlen from
user space by trimming it to the biggest size sctp sockopt may need when
necessary, and this biggest size is from sctp\_setsockopt\_reset\_streams()
for SCTP\_RESET\_STREAMS, which is bigger than those for SCTP\_HMAC\_IDENT
and SCTP\_AUTH\_KEY.
Fixes: ca84bd058dae ("sctp: copy the optval from user space in sctp\_setsockopt")
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cac71d27745f92ee13f0ecc668ffe151a4a9c9b1
Author: Pavel Skripkin
Date: Sat Jul 17 14:29:33 2021 +0300
net: sched: fix memory leak in tcindex\_partial\_destroy\_work
[ Upstream commit f5051bcece50140abd1a11a2d36dc3ec5484fc32 ]
Syzbot reported memory leak in tcindex\_set\_parms(). The problem was in
non-freed perfect hash in tcindex\_partial\_destroy\_work().
In tcindex\_set\_parms() new tcindex\_data is allocated and some fields from
old one are copied to new one, but not the perfect hash. Since
tcindex\_partial\_destroy\_work() is the destroy function for old
tcindex\_data, we need to free perfect hash to avoid memory leak.
Reported-and-tested-by: syzbot+f0bbb2287b8993d4fa74@syzkaller.appspotmail.com
Fixes: 331b72922c5f ("net: sched: RCU cls\_tcindex")
Signed-off-by: Pavel Skripkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a4a488915feaad38345cc01b80d52e8200ff5209
Author: Nicholas Piggin
Date: Fri Jul 16 12:43:10 2021 +1000
KVM: PPC: Fix kvm\_arch\_vcpu\_ioctl vcpu\_load leak
[ Upstream commit bc4188a2f56e821ea057aca6bf444e138d06c252 ]
vcpu\_put is not called if the user copy fails. This can result in preempt
notifier corruption and crashes, among other issues.
Fixes: b3cebfe8c1ca ("KVM: PPC: Move vcpu\_load/vcpu\_put down to each ioctl case in kvm\_arch\_vcpu\_ioctl")
Reported-by: Alexey Kardashevskiy
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210716024310.164448-2-npiggin@gmail.com
Signed-off-by: Sasha Levin
commit cdf4a0589eafbf9bc94af61b9ecf72220f00523f
Author: Nicholas Piggin
Date: Fri Jul 16 12:43:09 2021 +1000
KVM: PPC: Book3S: Fix CONFIG\_TRANSACTIONAL\_MEM=n crash
[ Upstream commit bd31ecf44b8e18ccb1e5f6b50f85de6922a60de3 ]
When running CPU\_FTR\_P9\_TM\_HV\_ASSIST, HFSCR[TM] is set for the guest
even if the host has CONFIG\_TRANSACTIONAL\_MEM=n, which causes it to be
unprepared to handle guest exits while transactional.
Normal guests don't have a problem because the HTM capability will not
be advertised, but a rogue or buggy one could crash the host.
Fixes: 4bb3c7a0208f ("KVM: PPC: Book3S HV: Work around transactional memory bugs in POWER9")
Reported-by: Alexey Kardashevskiy
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210716024310.164448-1-npiggin@gmail.com
Signed-off-by: Sasha Levin
commit 69f253c44401b7bd2ca42a943b43c0f784f4bafb
Author: Yajun Deng
Date: Wed Jul 14 17:13:20 2021 +0800
net: decnet: Fix sleeping inside in af\_decnet
[ Upstream commit 5f119ba1d5771bbf46d57cff7417dcd84d3084ba ]
The release\_sock() is blocking function, it would change the state
after sleeping. use wait\_woken() instead.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Yajun Deng
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 626cb6d84ba227e9b1b2f578522bf59361611656
Author: Michal Suchanek
Date: Thu Jul 8 11:46:54 2021 +0200
efi/tpm: Differentiate missing and invalid final event log table.
[ Upstream commit 674a9f1f6815849bfb5bf385e7da8fc198aaaba9 ]
Missing TPM final event log table is not a firmware bug.
Clearly if providing event log in the old format makes the final event
log invalid it should not be provided at least in that case.
Fixes: b4f1874c6216 ("tpm: check event log version before reading final events")
Signed-off-by: Michal Suchanek
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
commit f6eeb0829e1a29050d52b60f3f99650c248b3986
Author: Vijendar Mukunda
Date: Fri Jul 16 18:00:12 2021 +0530
ASoC: soc-pcm: add a flag to reverse the stop sequence
[ Upstream commit 59dd33f82dc0975c55d3d46801e7ca45532d7673 ]
On stream stop, currently CPU DAI stop sequence invoked first
followed by DMA. For Few platforms, it is required to stop the
DMA first before stopping CPU DAI.
Introduced new flag in dai\_link structure for reordering stop sequence.
Based on flag check, ASoC core will re-order the stop sequence.
Fixes: 4378f1fbe92405 ("ASoC: soc-pcm: Use different sequence for start/stop trigger")
Signed-off-by: Vijendar Mukunda
Link: https://lore.kernel.org/r/20210716123015.15697-1-vijendar.mukunda@amd.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 57df79dd0b47e89f149027af77b6727440d38443
Author: Roman Skakun
Date: Fri Jul 16 11:39:34 2021 +0300
dma-mapping: handle vmalloc addresses in dma\_common\_{mmap,get\_sgtable}
[ Upstream commit 40ac971eab89330d6153e7721e88acd2d98833f9 ]
xen-swiotlb can use vmalloc backed addresses for dma coherent allocations
and uses the common helpers. Properly handle them to unbreak Xen on
ARM platforms.
Fixes: 1b65c4e5a9af ("swiotlb-xen: use xen\_alloc/free\_coherent\_pages")
Signed-off-by: Roman Skakun
Reviewed-by: Andrii Anisov
[hch: split the patch, renamed the helpers]
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit eeaa4b8d1e2e6f10362673d283a97dccc7275afa
Author: Dongliang Mu
Date: Wed Jul 14 17:13:22 2021 +0800
usb: hso: fix error handling code of hso\_create\_net\_device
[ Upstream commit a6ecfb39ba9d7316057cea823b196b734f6b18ca ]
The current error handling code of hso\_create\_net\_device is
hso\_free\_net\_device, no matter which errors lead to. For example,
WARNING in hso\_free\_net\_device [1].
Fix this by refactoring the error handling code of
hso\_create\_net\_device by handling different errors by different code.
[1] https://syzkaller.appspot.com/bug?id=66eff8d49af1b28370ad342787413e35bbe76efe
Reported-by: syzbot+44d53c7255bb1aea22d2@syzkaller.appspotmail.com
Fixes: 5fcfb6d0bfcd ("hso: fix bailout in error case of probe")
Signed-off-by: Dongliang Mu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d20ce763c6904fc66405b177c1d0153282a43237
Author: Yoshitaka Ikeda
Date: Thu Jul 15 16:21:32 2021 +0000
spi: spi-cadence-quadspi: Fix division by zero warning
[ Upstream commit 55cef88bbf12f3bfbe5c2379a8868a034707e755 ]
Fix below division by zero warning:
- Added an if statement because buswidth can be zero, resulting in division by zero.
- The modified code was based on another driver (atmel-quadspi).
[ 0.795337] Division by zero in kernel.
:
[ 0.834051] [<807fd40c>] (\_\_div0) from [<804e1acc>] (Ldiv0+0x8/0x10)
[ 0.839097] [<805f0710>] (cqspi\_exec\_mem\_op) from [<805edb4c>] (spi\_mem\_exec\_op+0x3b0/0x3f8)
Fixes: 7512eaf54190 ("spi: cadence-quadspi: Fix dummy cycle calculation when buswidth > 1")
Signed-off-by: Yoshitaka Ikeda
Link: https://lore.kernel.org/r/ed989af6-da88-4e0b-9ed8-126db6cad2e4@nskint.co.jp
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit d4c7797ab1517515f0d08b3bc1c6b48883889c54
Author: Ziyang Xuan
Date: Thu Jul 15 20:22:04 2021 +0800
net: fix uninit-value in caif\_seqpkt\_sendmsg
[ Upstream commit 991e634360f2622a683b48dfe44fe6d9cb765a09 ]
When nr\_segs equal to zero in iovec\_from\_user, the object
msg->msg\_iter.iov is uninit stack memory in caif\_seqpkt\_sendmsg
which is defined in \_\_\_sys\_sendmsg. So we cann't just judge
msg->msg\_iter.iov->base directlly. We can use nr\_segs to judge
msg in caif\_seqpkt\_sendmsg whether has data buffers.
=====================================================
BUG: KMSAN: uninit-value in caif\_seqpkt\_sendmsg+0x693/0xf60 net/caif/caif\_socket.c:542
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x1c9/0x220 lib/dump\_stack.c:118
kmsan\_report+0xf7/0x1e0 mm/kmsan/kmsan\_report.c:118
\_\_msan\_warning+0x58/0xa0 mm/kmsan/kmsan\_instr.c:215
caif\_seqpkt\_sendmsg+0x693/0xf60 net/caif/caif\_socket.c:542
sock\_sendmsg\_nosec net/socket.c:652 [inline]
sock\_sendmsg net/socket.c:672 [inline]
\_\_\_\_sys\_sendmsg+0x12b6/0x1350 net/socket.c:2343
\_\_\_sys\_sendmsg net/socket.c:2397 [inline]
\_\_sys\_sendmmsg+0x808/0xc90 net/socket.c:2480
\_\_compat\_sys\_sendmmsg net/compat.c:656 [inline]
Reported-by: syzbot+09a5d591c1f98cf5efcb@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=1ace85e8fc9b0d5a45c08c2656c3e91762daa9b8
Fixes: bece7b2398d0 ("caif: Rewritten socket implementation")
Signed-off-by: Ziyang Xuan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3d6f06fb19fb1763c7dd77f6b13e077f3e639f16
Author: Tobias Klauser
Date: Thu Jul 15 13:06:09 2021 +0200
bpftool: Check malloc return value in mount\_bpffs\_for\_pin
[ Upstream commit d444b06e40855219ef38b5e9286db16d435f06dc ]
Fix and add a missing NULL check for the prior malloc() call.
Fixes: 49a086c201a9 ("bpftool: implement prog load command")
Signed-off-by: Tobias Klauser
Signed-off-by: Daniel Borkmann
Reviewed-by: Quentin Monnet
Acked-by: Roman Gushchin
Link: https://lore.kernel.org/bpf/20210715110609.29364-1-tklauser@distanz.ch
Signed-off-by: Sasha Levin
commit 464c306367cb649360a9143e469682a8dcc0a38d
Author: Jakub Sitnicki
Date: Wed Jul 14 17:47:50 2021 +0200
bpf, sockmap, udp: sk\_prot needs inuse\_idx set for proc stats
[ Upstream commit 54ea2f49fd9400dd698c25450be3352b5613b3b4 ]
The proc socket stats use sk\_prot->inuse\_idx value to record inuse sock
stats. We currently do not set this correctly from sockmap side. The
result is reading sock stats '/proc/net/sockstat' gives incorrect values.
The socket counter is incremented correctly, but because we don't set the
counter correctly when we replace sk\_prot we may omit the decrement.
To get the correct inuse\_idx value move the core\_initcall that initializes
the UDP proto handlers to late\_initcall. This way it is initialized after
UDP has the chance to assign the inuse\_idx value from the register protocol
handler.
Fixes: edc6741cc660 ("bpf: Add sockmap hooks for UDP sockets")
Signed-off-by: Jakub Sitnicki
Signed-off-by: Daniel Borkmann
Reviewed-by: Cong Wang
Acked-by: John Fastabend
Link: https://lore.kernel.org/bpf/20210714154750.528206-1-jakub@cloudflare.com
Signed-off-by: Sasha Levin
commit 600b122a690b613bb15eb98a6758d3926e06714e
Author: John Fastabend
Date: Mon Jul 12 12:55:46 2021 -0700
bpf, sockmap, tcp: sk\_prot needs inuse\_idx set for proc stats
[ Upstream commit 228a4a7ba8e99bb9ef980b62f71e3be33f4aae69 ]
The proc socket stats use sk\_prot->inuse\_idx value to record inuse sock
stats. We currently do not set this correctly from sockmap side. The
result is reading sock stats '/proc/net/sockstat' gives incorrect values.
The socket counter is incremented correctly, but because we don't set the
counter correctly when we replace sk\_prot we may omit the decrement.
To get the correct inuse\_idx value move the core\_initcall that initializes
the TCP proto handlers to late\_initcall. This way it is initialized after
TCP has the chance to assign the inuse\_idx value from the register protocol
handler.
Fixes: 604326b41a6fb ("bpf, sockmap: convert to generic sk\_msg interface")
Suggested-by: Jakub Sitnicki
Signed-off-by: John Fastabend
Signed-off-by: Daniel Borkmann
Reviewed-by: Cong Wang
Link: https://lore.kernel.org/bpf/20210712195546.423990-3-john.fastabend@gmail.com
Signed-off-by: Sasha Levin
commit 6c508a1c6c62793dc6e6872cad4b200097bab7c9
Author: John Fastabend
Date: Mon Jul 12 12:55:45 2021 -0700
bpf, sockmap: Fix potential memory leak on unlikely error case
[ Upstream commit 7e6b27a69167f97c56b5437871d29e9722c3e470 ]
If skb\_linearize is needed and fails we could leak a msg on the error
handling. To fix ensure we kfree the msg block before returning error.
Found during code review.
Fixes: 4363023d2668e ("bpf, sockmap: Avoid failures from skb\_to\_sgvec when skb has frag\_list")
Signed-off-by: John Fastabend
Signed-off-by: Daniel Borkmann
Reviewed-by: Cong Wang
Link: https://lore.kernel.org/bpf/20210712195546.423990-2-john.fastabend@gmail.com
Signed-off-by: Sasha Levin
commit 6be4502a80e3e17d96ac0033887dfbfec4480043
Author: Colin Ian King
Date: Thu Jul 15 13:57:12 2021 +0100
s390/bpf: Perform r1 range checking before accessing jit->seen\_reg[r1]
[ Upstream commit 91091656252f5d6d8c476e0c92776ce9fae7b445 ]
Currently array jit->seen\_reg[r1] is being accessed before the range
checking of index r1. The range changing on r1 should be performed
first since it will avoid any potential out-of-range accesses on the
array seen\_reg[] and also it is more optimal to perform checks on r1
before fetching data from the array. Fix this by swapping the order
of the checks before the array access.
Fixes: 054623105728 ("s390/bpf: Add s390x eBPF JIT compiler backend")
Signed-off-by: Colin Ian King
Signed-off-by: Daniel Borkmann
Tested-by: Ilya Leoshkevich
Acked-by: Ilya Leoshkevich
Link: https://lore.kernel.org/bpf/20210715125712.24690-1-colin.king@canonical.com
Signed-off-by: Sasha Levin
commit 7006eabb4044ef46fe0ba15eefeb8f8aea172bf0
Author: Colin Ian King
Date: Wed Jul 14 16:23:43 2021 +0100
liquidio: Fix unintentional sign extension issue on left shift of u16
[ Upstream commit e7efc2ce3d0789cd7c21b70ff00cd7838d382639 ]
Shifting the u16 integer oct->pcie\_port by CN23XX\_PKT\_INPUT\_CTL\_MAC\_NUM\_POS
(29) bits will be promoted to a 32 bit signed int and then sign-extended
to a u64. In the cases where oct->pcie\_port where bit 2 is set (e.g. 3..7)
the shifted value will be sign extended and the top 32 bits of the result
will be set.
Fix this by casting the u16 values to a u64 before the 29 bit left shift.
Addresses-Coverity: ("Unintended sign extension")
Fixes: 3451b97cce2d ("liquidio: CN23XX register setup")
Signed-off-by: Colin Ian King
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1dd68ece22bab3f715c2cbfbeebf614c5441ba02
Author: Geert Uytterhoeven
Date: Wed Jul 14 11:58:12 2021 +0200
net: dsa: mv88e6xxx: NET\_DSA\_MV88E6XXX\_PTP should depend on NET\_DSA\_MV88E6XXX
[ Upstream commit 99bb2ebab953435852340cdb198c5abbf0bb5dd3 ]
Making global2 support mandatory removed the Kconfig symbol
NET\_DSA\_MV88E6XXX\_GLOBAL2. This symbol also served as an intermediate
symbol to make NET\_DSA\_MV88E6XXX\_PTP depend on NET\_DSA\_MV88E6XXX. With
the symbol removed, the user is always asked about PTP support for
Marvell 88E6xxx switches, even if the latter support is not enabled.
Fix this by reinstating the dependency.
Fixes: 63368a7416df144b ("net: dsa: mv88e6xxx: Make global2 support mandatory")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Andrew Lunn
Reviewed-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5bd05b57e901066299fc675d120e0676255c2e9f
Author: Maxime Ripard
Date: Wed Jul 7 11:51:10 2021 +0200
drm/vc4: hdmi: Drop devm interrupt handler for CEC interrupts
[ Upstream commit 32a19de21ae40f0601f48575b610dde4f518ccc6 ]
The CEC interrupt handlers are registered through the
devm\_request\_threaded\_irq function. However, while free\_irq is indeed
called properly when the device is unbound or bind fails, it's called
after unbind or bind is done.
In our particular case, it means that on failure it creates a window
where our interrupt handler can be called, but we're freeing every
resource (CEC adapter, DRM objects, etc.) it might need.
In order to address this, let's switch to the non-devm variant to
control better when the handler will be unregistered and allow us to
make it safe.
Fixes: 15b4511a4af6 ("drm/vc4: add HDMI CEC support")
Signed-off-by: Maxime Ripard
Reviewed-by: Dave Stevenson
Link: https://patchwork.freedesktop.org/patch/msgid/20210707095112.1469670-2-maxime@cerno.tech
Signed-off-by: Sasha Levin
commit 3ba73cb983023c833043c5f70325a77fabff6361
Author: Nicolas Saenz Julienne
Date: Fri Jul 9 16:13:25 2021 +0200
timers: Fix get\_next\_timer\_interrupt() with no timers pending
[ Upstream commit aebacb7f6ca1926918734faae14d1f0b6fae5cb7 ]
31cd0e119d50 ("timers: Recalculate next timer interrupt only when
necessary") subtly altered get\_next\_timer\_interrupt()'s behaviour. The
function no longer consistently returns KTIME\_MAX with no timers
pending.
In order to decide if there are any timers pending we check whether the
next expiry will happen NEXT\_TIMER\_MAX\_DELTA jiffies from now.
Unfortunately, the next expiry time and the timer base clock are no
longer updated in unison. The former changes upon certain timer
operations (enqueue, expire, detach), whereas the latter keeps track of
jiffies as they move forward. Ultimately breaking the logic above.
A simplified example:
- Upon entering get\_next\_timer\_interrupt() with:
jiffies = 1
base->clk = 0;
base->next\_expiry = NEXT\_TIMER\_MAX\_DELTA;
'base->next\_expiry == base->clk + NEXT\_TIMER\_MAX\_DELTA', the function
returns KTIME\_MAX.
- 'base->clk' is updated to the jiffies value.
- The next time we enter get\_next\_timer\_interrupt(), taking into account
no timer operations happened:
base->clk = 1;
base->next\_expiry = NEXT\_TIMER\_MAX\_DELTA;
'base->next\_expiry != base->clk + NEXT\_TIMER\_MAX\_DELTA', the function
returns a valid expire time, which is incorrect.
This ultimately might unnecessarily rearm sched's timer on nohz\_full
setups, and add latency to the system[1].
So, introduce 'base->timers\_pending'[2], update it every time
'base->next\_expiry' changes, and use it in get\_next\_timer\_interrupt().
[1] See tick\_nohz\_stop\_tick().
[2] A quick pahole check on x86\_64 and arm64 shows it doesn't make
'struct timer\_base' any bigger.
Fixes: 31cd0e119d50 ("timers: Recalculate next timer interrupt only when necessary")
Signed-off-by: Nicolas Saenz Julienne
Signed-off-by: Frederic Weisbecker
Signed-off-by: Sasha Levin
commit 364ec7249d01013e331b597089a1e04a8761d9d8
Author: Sathya Prakash M R
Date: Mon Jul 12 15:16:20 2021 -0500
ASoC: SOF: Intel: Update ADL descriptor to use ACPI power states
[ Upstream commit aa21548e34c19c12e924c736f3fd9e6a4d0f5419 ]
The ADL descriptor was missing an ACPI power setting, causing the DSP
to enter D3 even with a D0i1-compatible wake-on-voice/hotwording
capture stream.
Fixes: 4ad03f894b3c ('ASoC: SOF: Intel: Update ADL P to use its own descriptor')
Reviewed-by: Ranjani Sridharan
Signed-off-by: Sathya Prakash M R
Signed-off-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20210712201620.44311-1-pierre-louis.bossart@linux.intel.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit a7537dc73e69ad9c0b67ad24ad3ebee954ed0af6
Author: Xuan Zhuo
Date: Sat Jul 10 11:16:35 2021 +0800
xdp, net: Fix use-after-free in bpf\_xdp\_link\_release
[ Upstream commit 5acc7d3e8d342858405fbbc671221f676b547ce7 ]
The problem occurs between dev\_get\_by\_index() and dev\_xdp\_attach\_link().
At this point, dev\_xdp\_uninstall() is called. Then xdp link will not be
detached automatically when dev is released. But link->dev already
points to dev, when xdp link is released, dev will still be accessed,
but dev has been released.
dev\_get\_by\_index() |
link->dev = dev |
| rtnl\_lock()
| unregister\_netdevice\_many()
| dev\_xdp\_uninstall()
| rtnl\_unlock()
rtnl\_lock(); |
dev\_xdp\_attach\_link() |
rtnl\_unlock(); |
| netdev\_run\_todo() // dev released
bpf\_xdp\_link\_release() |
/\* access dev. |
use-after-free \*/ |
[ 45.966867] BUG: KASAN: use-after-free in bpf\_xdp\_link\_release+0x3b8/0x3d0
[ 45.967619] Read of size 8 at addr ffff00000f9980c8 by task a.out/732
[ 45.968297]
[ 45.968502] CPU: 1 PID: 732 Comm: a.out Not tainted 5.13.0+ #22
[ 45.969222] Hardware name: linux,dummy-virt (DT)
[ 45.969795] Call trace:
[ 45.970106] dump\_backtrace+0x0/0x4c8
[ 45.970564] show\_stack+0x30/0x40
[ 45.970981] dump\_stack\_lvl+0x120/0x18c
[ 45.971470] print\_address\_description.constprop.0+0x74/0x30c
[ 45.972182] kasan\_report+0x1e8/0x200
[ 45.972659] \_\_asan\_report\_load8\_noabort+0x2c/0x50
[ 45.973273] bpf\_xdp\_link\_release+0x3b8/0x3d0
[ 45.973834] bpf\_link\_free+0xd0/0x188
[ 45.974315] bpf\_link\_put+0x1d0/0x218
[ 45.974790] bpf\_link\_release+0x3c/0x58
[ 45.975291] \_\_fput+0x20c/0x7e8
[ 45.975706] \_\_\_\_fput+0x24/0x30
[ 45.976117] task\_work\_run+0x104/0x258
[ 45.976609] do\_notify\_resume+0x894/0xaf8
[ 45.977121] work\_pending+0xc/0x328
[ 45.977575]
[ 45.977775] The buggy address belongs to the page:
[ 45.978369] page:fffffc00003e6600 refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x4f998
[ 45.979522] flags: 0x7fffe0000000000(node=0|zone=0|lastcpupid=0x3ffff)
[ 45.980349] raw: 07fffe0000000000 fffffc00003e6708 ffff0000dac3c010 0000000000000000
[ 45.981309] raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
[ 45.982259] page dumped because: kasan: bad access detected
[ 45.982948]
[ 45.983153] Memory state around the buggy address:
[ 45.983753] ffff00000f997f80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 45.984645] ffff00000f998000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 45.985533] >ffff00000f998080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 45.986419] ^
[ 45.987112] ffff00000f998100: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 45.988006] ffff00000f998180: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 45.988895] ==================================================================
[ 45.989773] Disabling lock debugging due to kernel taint
[ 45.990552] Kernel panic - not syncing: panic\_on\_warn set ...
[ 45.991166] CPU: 1 PID: 732 Comm: a.out Tainted: G B 5.13.0+ #22
[ 45.991929] Hardware name: linux,dummy-virt (DT)
[ 45.992448] Call trace:
[ 45.992753] dump\_backtrace+0x0/0x4c8
[ 45.993208] show\_stack+0x30/0x40
[ 45.993627] dump\_stack\_lvl+0x120/0x18c
[ 45.994113] dump\_stack+0x1c/0x34
[ 45.994530] panic+0x3a4/0x7d8
[ 45.994930] end\_report+0x194/0x198
[ 45.995380] kasan\_report+0x134/0x200
[ 45.995850] \_\_asan\_report\_load8\_noabort+0x2c/0x50
[ 45.996453] bpf\_xdp\_link\_release+0x3b8/0x3d0
[ 45.997007] bpf\_link\_free+0xd0/0x188
[ 45.997474] bpf\_link\_put+0x1d0/0x218
[ 45.997942] bpf\_link\_release+0x3c/0x58
[ 45.998429] \_\_fput+0x20c/0x7e8
[ 45.998833] \_\_\_\_fput+0x24/0x30
[ 45.999247] task\_work\_run+0x104/0x258
[ 45.999731] do\_notify\_resume+0x894/0xaf8
[ 46.000236] work\_pending+0xc/0x328
[ 46.000697] SMP: stopping secondary CPUs
[ 46.001226] Dumping ftrace buffer:
[ 46.001663] (ftrace buffer empty)
[ 46.002110] Kernel Offset: disabled
[ 46.002545] CPU features: 0x00000001,23202c00
[ 46.003080] Memory Limit: none
Fixes: aa8d3a716b59db6c ("bpf, xdp: Add bpf\_link-based XDP attachment API")
Reported-by: Abaci
Signed-off-by: Xuan Zhuo
Signed-off-by: Alexei Starovoitov
Reviewed-by: Dust Li
Acked-by: Andrii Nakryiko
Link: https://lore.kernel.org/bpf/20210710031635.41649-1-xuanzhuo@linux.alibaba.com
Signed-off-by: Sasha Levin
commit cbb086074dab631ac43f8645cbac1d7b148e05c4
Author: Daniel Borkmann
Date: Mon Jul 12 22:57:35 2021 +0200
bpf: Fix tail\_call\_reachable rejection for interpreter when jit failed
[ Upstream commit 5dd0a6b8582ffbfa88351949d50eccd5b6694ade ]
During testing of f263a81451c1 ("bpf: Track subprog poke descriptors correctly
and fix use-after-free") under various failure conditions, for example, when
jit\_subprogs() fails and tries to clean up the program to be run under the
interpreter, we ran into the following freeze:
[...]
#127/8 tailcall\_bpf2bpf\_3:FAIL
[...]
[ 92.041251] BUG: KASAN: slab-out-of-bounds in \_\_\_bpf\_prog\_run+0x1b9d/0x2e20
[ 92.042408] Read of size 8 at addr ffff88800da67f68 by task test\_progs/682
[ 92.043707]
[ 92.044030] CPU: 1 PID: 682 Comm: test\_progs Tainted: G O 5.13.0-53301-ge6c08cb33a30-dirty #87
[ 92.045542] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1 04/01/2014
[ 92.046785] Call Trace:
[ 92.047171] ? \_\_bpf\_prog\_run\_args64+0xc0/0xc0
[ 92.047773] ? \_\_bpf\_prog\_run\_args32+0x8b/0xb0
[ 92.048389] ? \_\_bpf\_prog\_run\_args64+0xc0/0xc0
[ 92.049019] ? ktime\_get+0x117/0x130
[...] // few hundred [similar] lines more
[ 92.659025] ? ktime\_get+0x117/0x130
[ 92.659845] ? \_\_bpf\_prog\_run\_args64+0xc0/0xc0
[ 92.660738] ? \_\_bpf\_prog\_run\_args32+0x8b/0xb0
[ 92.661528] ? \_\_bpf\_prog\_run\_args64+0xc0/0xc0
[ 92.662378] ? print\_usage\_bug+0x50/0x50
[ 92.663221] ? print\_usage\_bug+0x50/0x50
[ 92.664077] ? bpf\_ksym\_find+0x9c/0xe0
[ 92.664887] ? ktime\_get+0x117/0x130
[ 92.665624] ? kernel\_text\_address+0xf5/0x100
[ 92.666529] ? \_\_kernel\_text\_address+0xe/0x30
[ 92.667725] ? unwind\_get\_return\_address+0x2f/0x50
[ 92.668854] ? \_\_\_bpf\_prog\_run+0x15d4/0x2e20
[ 92.670185] ? ktime\_get+0x117/0x130
[ 92.671130] ? \_\_bpf\_prog\_run\_args64+0xc0/0xc0
[ 92.672020] ? \_\_bpf\_prog\_run\_args32+0x8b/0xb0
[ 92.672860] ? \_\_bpf\_prog\_run\_args64+0xc0/0xc0
[ 92.675159] ? ktime\_get+0x117/0x130
[ 92.677074] ? lock\_is\_held\_type+0xd5/0x130
[ 92.678662] ? \_\_\_bpf\_prog\_run+0x15d4/0x2e20
[ 92.680046] ? ktime\_get+0x117/0x130
[ 92.681285] ? \_\_bpf\_prog\_run32+0x6b/0x90
[ 92.682601] ? \_\_bpf\_prog\_run64+0x90/0x90
[ 92.683636] ? lock\_downgrade+0x370/0x370
[ 92.684647] ? mark\_held\_locks+0x44/0x90
[ 92.685652] ? ktime\_get+0x117/0x130
[ 92.686752] ? lockdep\_hardirqs\_on+0x79/0x100
[ 92.688004] ? ktime\_get+0x117/0x130
[ 92.688573] ? \_\_cant\_migrate+0x2b/0x80
[ 92.689192] ? bpf\_test\_run+0x2f4/0x510
[ 92.689869] ? bpf\_test\_timer\_continue+0x1c0/0x1c0
[ 92.690856] ? rcu\_read\_lock\_bh\_held+0x90/0x90
[ 92.691506] ? \_\_kasan\_slab\_alloc+0x61/0x80
[ 92.692128] ? eth\_type\_trans+0x128/0x240
[ 92.692737] ? \_\_build\_skb+0x46/0x50
[ 92.693252] ? bpf\_prog\_test\_run\_skb+0x65e/0xc50
[ 92.693954] ? bpf\_prog\_test\_run\_raw\_tp+0x2d0/0x2d0
[ 92.694639] ? \_\_fget\_light+0xa1/0x100
[ 92.695162] ? bpf\_prog\_inc+0x23/0x30
[ 92.695685] ? \_\_sys\_bpf+0xb40/0x2c80
[ 92.696324] ? bpf\_link\_get\_from\_fd+0x90/0x90
[ 92.697150] ? mark\_held\_locks+0x24/0x90
[ 92.698007] ? lockdep\_hardirqs\_on\_prepare+0x124/0x220
[ 92.699045] ? finish\_task\_switch+0xe6/0x370
[ 92.700072] ? lockdep\_hardirqs\_on+0x79/0x100
[ 92.701233] ? finish\_task\_switch+0x11d/0x370
[ 92.702264] ? \_\_switch\_to+0x2c0/0x740
[ 92.703148] ? mark\_held\_locks+0x24/0x90
[ 92.704155] ? \_\_x64\_sys\_bpf+0x45/0x50
[ 92.705146] ? do\_syscall\_64+0x35/0x80
[ 92.706953] ? entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[...]
Turns out that the program rejection from e411901c0b77 ("bpf: allow for tailcalls
in BPF subprograms for x64 JIT") is buggy since env->prog->aux->tail\_call\_reachable
is never true. Commit ebf7d1f508a7 ("bpf, x64: rework pro/epilogue and tailcall
handling in JIT") added a tracker into check\_max\_stack\_depth() which propagates
the tail\_call\_reachable condition throughout the subprograms. This info is then
assigned to the subprogram's func[i]->aux->tail\_call\_reachable. However, in the
case of the rejection check upon JIT failure, env->prog->aux->tail\_call\_reachable
is used. func[0]->aux->tail\_call\_reachable which represents the main program's
information did not propagate this to the outer env->prog->aux, though. Add this
propagation into check\_max\_stack\_depth() where it needs to belong so that the
check can be done reliably.
Fixes: ebf7d1f508a7 ("bpf, x64: rework pro/epilogue and tailcall handling in JIT")
Fixes: e411901c0b77 ("bpf: allow for tailcalls in BPF subprograms for x64 JIT")
Co-developed-by: John Fastabend
Signed-off-by: Daniel Borkmann
Signed-off-by: John Fastabend
Signed-off-by: Alexei Starovoitov
Acked-by: Maciej Fijalkowski
Link: https://lore.kernel.org/bpf/618c34e3163ad1a36b1e82377576a6081e182f25.1626123173.git.daniel@iogearbox.net
Signed-off-by: Sasha Levin
commit cd12f874ae1003cf391a8b08dab5ef6c46e08d21
Author: Xuan Zhuo
Date: Thu Jul 8 16:04:09 2021 +0800
bpf, test: fix NULL pointer dereference on invalid expected\_attach\_type
[ Upstream commit 5e21bb4e812566aef86fbb77c96a4ec0782286e4 ]
These two types of XDP progs (BPF\_XDP\_DEVMAP, BPF\_XDP\_CPUMAP) will not be
executed directly in the driver, therefore we should also not directly
run them from here. To run in these two situations, there must be further
preparations done, otherwise these may cause a kernel panic.
For more details, see also dev\_xdp\_attach().
[ 46.982479] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 46.984295] #PF: supervisor read access in kernel mode
[ 46.985777] #PF: error\_code(0x0000) - not-present page
[ 46.987227] PGD 800000010dca4067 P4D 800000010dca4067 PUD 10dca6067 PMD 0
[ 46.989201] Oops: 0000 [#1] SMP PTI
[ 46.990304] CPU: 7 PID: 562 Comm: a.out Not tainted 5.13.0+ #44
[ 46.992001] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/24
[ 46.995113] RIP: 0010:\_\_\_bpf\_prog\_run+0x17b/0x1710
[ 46.996586] Code: 49 03 14 cc e8 76 f6 fe ff e9 ad fe ff ff 0f b6 43 01 48 0f bf 4b 02 48 83 c3 08 89 c2 83 e0 0f c0 ea 04 02
[ 47.001562] RSP: 0018:ffffc900005afc58 EFLAGS: 00010246
[ 47.003115] RAX: 0000000000000000 RBX: ffffc9000023f068 RCX: 0000000000000000
[ 47.005163] RDX: 0000000000000000 RSI: 0000000000000079 RDI: ffffc900005afc98
[ 47.007135] RBP: 0000000000000000 R08: ffffc9000023f048 R09: c0000000ffffdfff
[ 47.009171] R10: 0000000000000001 R11: ffffc900005afb40 R12: ffffc900005afc98
[ 47.011172] R13: 0000000000000001 R14: 0000000000000001 R15: ffffffff825258a8
[ 47.013244] FS: 00007f04a5207580(0000) GS:ffff88842fdc0000(0000) knlGS:0000000000000000
[ 47.015705] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 47.017475] CR2: 0000000000000000 CR3: 0000000100182005 CR4: 0000000000770ee0
[ 47.019558] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 47.021595] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 47.023574] PKRU: 55555554
[ 47.024571] Call Trace:
[ 47.025424] \_\_bpf\_prog\_run32+0x32/0x50
[ 47.026296] ? printk+0x53/0x6a
[ 47.027066] ? ktime\_get+0x39/0x90
[ 47.027895] bpf\_test\_run.cold.28+0x23/0x123
[ 47.028866] ? printk+0x53/0x6a
[ 47.029630] bpf\_prog\_test\_run\_xdp+0x149/0x1d0
[ 47.030649] \_\_sys\_bpf+0x1305/0x23d0
[ 47.031482] \_\_x64\_sys\_bpf+0x17/0x20
[ 47.032316] do\_syscall\_64+0x3a/0x80
[ 47.033165] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 47.034254] RIP: 0033:0x7f04a51364dd
[ 47.035133] Code: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 48
[ 47.038768] RSP: 002b:00007fff8f9fc518 EFLAGS: 00000213 ORIG\_RAX: 0000000000000141
[ 47.040344] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f04a51364dd
[ 47.041749] RDX: 0000000000000048 RSI: 0000000020002a80 RDI: 000000000000000a
[ 47.043171] RBP: 00007fff8f9fc530 R08: 0000000002049300 R09: 0000000020000100
[ 47.044626] R10: 0000000000000004 R11: 0000000000000213 R12: 0000000000401070
[ 47.046088] R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
[ 47.047579] Modules linked in:
[ 47.048318] CR2: 0000000000000000
[ 47.049120] ---[ end trace 7ad34443d5be719a ]---
[ 47.050273] RIP: 0010:\_\_\_bpf\_prog\_run+0x17b/0x1710
[ 47.051343] Code: 49 03 14 cc e8 76 f6 fe ff e9 ad fe ff ff 0f b6 43 01 48 0f bf 4b 02 48 83 c3 08 89 c2 83 e0 0f c0 ea 04 02
[ 47.054943] RSP: 0018:ffffc900005afc58 EFLAGS: 00010246
[ 47.056068] RAX: 0000000000000000 RBX: ffffc9000023f068 RCX: 0000000000000000
[ 47.057522] RDX: 0000000000000000 RSI: 0000000000000079 RDI: ffffc900005afc98
[ 47.058961] RBP: 0000000000000000 R08: ffffc9000023f048 R09: c0000000ffffdfff
[ 47.060390] R10: 0000000000000001 R11: ffffc900005afb40 R12: ffffc900005afc98
[ 47.061803] R13: 0000000000000001 R14: 0000000000000001 R15: ffffffff825258a8
[ 47.063249] FS: 00007f04a5207580(0000) GS:ffff88842fdc0000(0000) knlGS:0000000000000000
[ 47.065070] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 47.066307] CR2: 0000000000000000 CR3: 0000000100182005 CR4: 0000000000770ee0
[ 47.067747] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 47.069217] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 47.070652] PKRU: 55555554
[ 47.071318] Kernel panic - not syncing: Fatal exception
[ 47.072854] Kernel Offset: disabled
[ 47.073683] ---[ end Kernel panic - not syncing: Fatal exception ]---
Fixes: 9216477449f3 ("bpf: cpumap: Add the possibility to attach an eBPF program to cpumap")
Fixes: fbee97feed9b ("bpf: Add support to attach bpf program to a devmap entry")
Reported-by: Abaci
Signed-off-by: Xuan Zhuo
Signed-off-by: Daniel Borkmann
Reviewed-by: Dust Li
Acked-by: Jesper Dangaard Brouer
Acked-by: David Ahern
Acked-by: Song Liu
Link: https://lore.kernel.org/bpf/20210708080409.73525-1-xuanzhuo@linux.alibaba.com
Signed-off-by: Sasha Levin
commit bc813a1ae95c0a260d2213ba5656ed119cc559a1
Author: Maxim Schwalm
Date: Mon Jul 12 03:50:11 2021 +0300
ASoC: rt5631: Fix regcache sync errors on resume
[ Upstream commit c71f78a662611fe2c67f3155da19b0eff0f29762 ]
The ALC5631 does not like multi-write accesses, avoid them. This fixes:
rt5631 4-001a: Unable to sync registers 0x3a-0x3c. -121
errors on resume from suspend (and all registers after the registers in
the error not being synced).
Inspired by commit 2d30e9494f1e ("ASoC: rt5651: Fix regcache sync errors
on resume") from Hans de Geode, which fixed the same errors on ALC5651.
Signed-off-by: Maxim Schwalm
Link: https://lore.kernel.org/r/20210712005011.28536-1-digetx@gmail.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 09b8cc7810587257e5f82080884001301e1a1ba9
Author: Peter Hess
Date: Tue Jul 6 14:16:09 2021 +0200
spi: mediatek: fix fifo rx mode
[ Upstream commit 3a70dd2d050331ee4cf5ad9d5c0a32d83ead9a43 ]
In FIFO mode were two problems:
- RX mode was never handled and
- in this case the tx\_buf pointer was NULL and caused an exception
fix this by handling RX mode in mtk\_spi\_fifo\_transfer
Fixes: a568231f4632 ("spi: mediatek: Add spi bus for Mediatek MT8173")
Signed-off-by: Peter Hess
Signed-off-by: Frank Wunderlich
Link: https://lore.kernel.org/r/20210706121609.680534-1-linux@fw-web.de
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit edd1b2b19214d90df76af88cebbe619222c344e2
Author: Axel Lin
Date: Wed Jun 30 17:59:59 2021 +0800
regulator: hi6421: Fix getting wrong drvdata
[ Upstream commit 1c73daee4bf30ccdff5e86dc400daa6f74735da5 ]
Since config.dev = pdev->dev.parent in current code, so
dev\_get\_drvdata(rdev->dev.parent) call in hi6421\_regulator\_enable
returns the drvdata of the mfd device rather than the regulator. Fix it.
This was broken while converting to use simplified DT parsing because the
config.dev changed from pdev->dev to pdev->dev.parent for parsing the
parent's of\_node.
Fixes: 29dc269a85ef ("regulator: hi6421: Convert to use simplified DT parsing")
Signed-off-by: Axel Lin
Link: https://lore.kernel.org/r/20210630095959.2411543-1-axel.lin@ingics.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit ae58c13a6b24b02dcadcd1380b49782808f43cee
Author: Axel Lin
Date: Sat Jun 19 20:41:33 2021 +0800
regulator: hi6421: Use correct variable type for regmap api val argument
[ Upstream commit ae60e6a9d24e89a74e2512204ad04de94921bdd2 ]
Use unsigned int instead of u32 for regmap\_read/regmap\_update\_bits val
argument.
Signed-off-by: Axel Lin
Link: https://lore.kernel.org/r/20210619124133.4096683-1-axel.lin@ingics.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit ffb6e766e200f33b9a3df70e1e3f5eb3c26881f1
Author: Alain Volmat
Date: Wed Jul 7 10:27:00 2021 +0200
spi: stm32: fixes pm\_runtime calls in probe/remove
[ Upstream commit 7999d2555c9f879d006ea8469d74db9cdb038af0 ]
Add pm\_runtime calls in probe/probe error path and remove
in order to be consistent in all places in ordering and
ensure that pm\_runtime is disabled prior to resources used
by the SPI controller.
This patch also fixes the 2 following warnings on driver remove:
WARNING: CPU: 0 PID: 743 at drivers/clk/clk.c:594 clk\_core\_disable\_lock+0x18/0x24
WARNING: CPU: 0 PID: 743 at drivers/clk/clk.c:476 clk\_unprepare+0x24/0x2c
Fixes: 038ac869c9d2 ("spi: stm32: add runtime PM support")
Signed-off-by: Amelie Delaunay
Signed-off-by: Alain Volmat
Link: https://lore.kernel.org/r/1625646426-5826-2-git-send-email-alain.volmat@foss.st.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 5b64a59c2c6e52fb17b6a9692ad9062749e9e5ec
Author: Charles Keepax
Date: Sat Jun 26 16:59:39 2021 +0100
ASoC: wm\_adsp: Correct wm\_coeff\_tlv\_get handling
[ Upstream commit dd6fb8ff2210f74b056bf9234d0605e8c26a8ac0 ]
When wm\_coeff\_tlv\_get was updated it was accidentally switch to the \_raw
version of the helper causing it to ignore the current DSP state it
should be checking. Switch the code back to the correct helper so that
users can't read the controls when they arn't available.
Fixes: 73ecf1a673d3 ("ASoC: wm\_adsp: Correct cache handling of new kernel control API")
Signed-off-by: Charles Keepax
Link: https://lore.kernel.org/r/20210626155941.12251-1-ckeepax@opensource.cirrus.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 14e7330ad1064fe453c3c144b42a3aab931ff80a
Author: Lecopzer Chen
Date: Thu Jul 15 15:37:16 2021 +0800
Kbuild: lto: fix module versionings mismatch in GNU make 3.X
[ Upstream commit 1d11053dc63094075bf9e4809fffd3bb5e72f9a6 ]
When building modules(CONFIG\_...=m), I found some of module versions
are incorrect and set to 0.
This can be found in build log for first clean build which shows
WARNING: EXPORT symbol "XXXX" [drivers/XXX/XXX.ko] version generation failed,
symbol will not be versioned.
But in second build(incremental build), the WARNING disappeared and the
module version becomes valid CRC and make someone who want to change
modules without updating kernel image can't insert their modules.
The problematic code is
+ $(foreach n, $(filter-out FORCE,$^), \
+ $(if $(wildcard $(n).symversions), \
+ ; cat $(n).symversions >> $@.symversions))
For example:
rm -f fs/notify/built-in.a.symversions ; rm -f fs/notify/built-in.a; \
llvm-ar cDPrST fs/notify/built-in.a fs/notify/fsnotify.o \
fs/notify/notification.o fs/notify/group.o ...
`foreach n` shows nothing to `cat` into $(n).symversions because
`if $(wildcard $(n).symversions)` return nothing, but actually
they do exist during this line was executed.
-rw-r--r-- 1 root root 168580 Jun 13 19:10 fs/notify/fsnotify.o
-rw-r--r-- 1 root root 111 Jun 13 19:10 fs/notify/fsnotify.o.symversions
The reason is the $(n).symversions are generated at runtime, but
Makefile wildcard function expends and checks the file exist or not
during parsing the Makefile.
Thus fix this by use `test` shell command to check the file
existence in runtime.
Rebase from both:
1. [https://lore.kernel.org/lkml/20210616080252.32046-1-lecopzer.chen@mediatek.com/]
2. [https://lore.kernel.org/lkml/20210702032943.7865-1-lecopzer.chen@mediatek.com/]
Fixes: 38e891849003 ("kbuild: lto: fix module versioning")
Co-developed-by: Sami Tolvanen
Signed-off-by: Lecopzer Chen
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit 4fc85eb660864c4b7a3d1d46c13157fcefeed7e2
Author: Yang Jihong
Date: Tue Jul 13 19:23:58 2021 +0800
perf sched: Fix record failure when CONFIG\_SCHEDSTATS is not set
[ Upstream commit b0f008551f0bf4d5f6db9b5f0e071b02790d6a2e ]
The tracepoints trace\_sched\_stat\_{wait, sleep, iowait} are not exposed to user
if CONFIG\_SCHEDSTATS is not set, "perf sched record" records the three events.
As a result, the command fails.
Before:
#perf sched record sleep 1
event syntax error: 'sched:sched\_stat\_wait'
\\_\_\_ unknown tracepoint
Error: File /sys/kernel/tracing/events/sched/sched\_stat\_wait not found.
Hint: Perhaps this kernel misses some CONFIG\_ setting to enable this feature?.
Run 'perf list' for a list of valid events
Usage: perf record [] []
or: perf record [] --  []
-e, --event  event selector. use 'perf list' to list available events
Solution:
Check whether schedstat tracepoints are exposed. If no, these events are not recorded.
After:
# perf sched record sleep 1
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.163 MB perf.data (1091 samples) ]
# perf sched report
run measurement overhead: 4736 nsecs
sleep measurement overhead: 9059979 nsecs
the run test took 999854 nsecs
the sleep test took 8945271 nsecs
nr\_run\_events: 716
nr\_sleep\_events: 785
nr\_wakeup\_events: 0
...
------------------------------------------------------------
Fixes: 2a09b5de235a6 ("sched/fair: do not expose some tracepoints to user if CONFIG\_SCHEDSTATS is not set")
Signed-off-by: Yang Jihong
Cc: Alexander Shishkin
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Steven Rostedt (VMware)
Cc: Yafang Shao
Link: http://lore.kernel.org/lkml/20210713112358.194693-1-yangjihong1@huawei.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit a83d04c140e37dcbcc5a25f19aad0973c12b64fb
Author: Riccardo Mancini
Date: Fri Jul 16 16:11:20 2021 +0200
perf data: Close all files in close\_dir()
[ Upstream commit d4b3eedce151e63932ce4a00f1d0baa340a8b907 ]
When using 'perf report' in directory mode, the first file is not closed
on exit, causing a memory leak.
The problem is caused by the iterating variable never reaching 0.
Fixes: 145520631130bd64 ("perf data: Add perf\_data\_\_(create\_dir|close\_dir) functions")
Signed-off-by: Riccardo Mancini
Acked-by: Namhyung Kim
Cc: Alexander Shishkin
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Peter Zijlstra
Cc: Zhen Lei
Link: http://lore.kernel.org/lkml/20210716141122.858082-1-rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit ed0bdfef4ba5e294815769ef2ca50bc99e0a820f
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:25 2021 +0200
perf probe-file: Delete namelist in del\_events() on the error path
[ Upstream commit e0fa7ab42232e742dcb3de9f3c1f6127b5adc019 ]
ASan reports some memory leaks when running:
# perf test "42: BPF filter"
This second leak is caused by a strlist not being dellocated on error
inside probe\_file\_\_del\_events.
This patch adds a goto label before the deallocation and makes the error
path jump to it.
Signed-off-by: Riccardo Mancini
Fixes: e7895e422e4da63d ("perf probe: Split del\_perf\_probe\_events()")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/174963c587ae77fa108af794669998e4ae558338.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 871c7043aa52382d62f1c0bff8691a052030843a
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:19 2021 +0200
perf lzma: Close lzma stream on exit
[ Upstream commit f8cbb0f926ae1e1fb5f9e51614e5437560ed4039 ]
ASan reports memory leaks when running:
# perf test "88: Check open filename arg using perf trace + vfs\_getname"
One of these is caused by the lzma stream never being closed inside
lzma\_decompress\_to\_file().
This patch adds the missing lzma\_end().
Signed-off-by: Riccardo Mancini
Fixes: 80a32e5b498a7547 ("perf tools: Add lzma decompression support for kernel module")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/aaf50bdce7afe996cfc06e1bbb36e4a2a9b9db93.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit e4518a4141f260ed0fec6bcca24906250ff441c6
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:18 2021 +0200
perf script: Fix memory 'threads' and 'cpus' leaks on exit
[ Upstream commit faf3ac305d61341c74e5cdd9e41daecce7f67bfe ]
ASan reports several memory leaks while running:
# perf test "82: Use vfs\_getname probe to get syscall args filenames"
Two of these are caused by some refcounts not being decreased on
perf-script exit, namely script.threads and script.cpus.
This patch adds the missing \_\_put calls in a new perf\_script\_\_exit
function, which is called at the end of cmd\_script.
This patch concludes the fixes of all remaining memory leaks in perf
test "82: Use vfs\_getname probe to get syscall args filenames".
Signed-off-by: Riccardo Mancini
Fixes: cfc8874a48599249 ("perf script: Process cpu/threads maps")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/5ee73b19791c6fa9d24c4d57f4ac1a23609400d7.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit a412ae547ed514efefd4d980e8511ec32021777c
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:17 2021 +0200
perf script: Release zstd data
[ Upstream commit 1b1f57cf9e4c8eb16c8f6b2ce12cc5dd3517fc61 ]
ASan reports several memory leak while running:
# perf test "82: Use vfs\_getname probe to get syscall args filenames"
One of the leaks is caused by zstd data not being released on exit in
perf-script.
This patch adds the missing zstd\_fini().
Signed-off-by: Riccardo Mancini
Fixes: b13b04d9382113f7 ("perf script: Initialize zstd\_data")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Milian Wolff
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/39388e8cc2f85ca219ea18697a17b7bd8f74b693.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit f50f139670f942a7885225f3b930261eff249a79
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:14 2021 +0200
perf report: Free generated help strings for sort option
[ Upstream commit a37338aad8c4d8676173ead14e881d2ec308155c ]
ASan reports the memory leak of the strings allocated by sort\_help() when
running perf report.
This patch changes the returned pointer to char\* (instead of const
char\*), saves it in a temporary variable, and finally deallocates it at
function exit.
Signed-off-by: Riccardo Mancini
Fixes: 702fb9b415e7c99b ("perf report: Show all sort keys in help output")
Cc: Andi Kleen
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/a38b13f02812a8a6759200b9063c6191337f44d4.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 97bb58171315dbe7b5295fd68cfc65348d4c071c
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:13 2021 +0200
perf env: Fix memory leak of cpu\_pmu\_caps
[ Upstream commit da6b7c6c0626901428245f65712385805e42eba6 ]
ASan reports memory leaks while running:
# perf test "83: Zstd perf.data compression/decompression"
The first of the leaks is caused by env->cpu\_pmu\_caps not being freed.
This patch adds the missing (z)free inside perf\_env\_\_exit.
Signed-off-by: Riccardo Mancini
Fixes: 6f91ea283a1ed23e ("perf header: Support CPU PMU capabilities")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/6ba036a8220156ec1f3d6be3e5d25920f6145028.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 9f29d864b4adf41015965dec115532692654373f
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:12 2021 +0200
perf test maps\_\_merge\_in: Fix memory leak of maps
[ Upstream commit 244d1797c8c8e850b8de7992af713aa5c70d5650 ]
ASan reports a memory leak when running:
# perf test "65: maps\_\_merge\_in"
This is the second and final patch addressing these memory leaks.
This time, the problem is simply that the maps object is never
destructed.
This patch adds the missing maps\_\_exit call.
Signed-off-by: Riccardo Mancini
Fixes: 79b6bb73f888933c ("perf maps: Merge 'struct maps' with 'struct map\_groups'")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/a1a29b97a58738987d150e94d4ebfad0282fb038.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 976804a726c7cb90a940668ddd70f1e781fabb39
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:11 2021 +0200
perf dso: Fix memory leak in dso\_\_new\_map()
[ Upstream commit 581e295a0f6b5c2931d280259fbbfff56959faa9 ]
ASan reports a memory leak when running:
# perf test "65: maps\_\_merge\_in".
The causes of the leaks are two, this patch addresses only the first
one, which is related to dso\_\_new\_map().
The bug is that dso\_\_new\_map() creates a new dso but never decreases the
refcount it gets from creating it.
This patch adds the missing dso\_\_put().
Signed-off-by: Riccardo Mancini
Fixes: d3a7c489c7fd2463 ("perf tools: Reference count struct dso")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/60bfe0cd06e89e2ca33646eb8468d7f5de2ee597.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit e39103cfa102b390a5aa1c1f5b372115bc6b31dd
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:10 2021 +0200
perf test event\_update: Fix memory leak of unit
[ Upstream commit dccfca926c351ba0893af4c8b481477bdb2881a4 ]
ASan reports a memory leak while running:
# perf test "49: Synthesize attr update"
Caused by a string being duplicated but never freed.
This patch adds the missing free().
Note that evsel->unit is not deallocated together with evsel since it is
supposed to be a constant string.
Signed-off-by: Riccardo Mancini
Fixes: a6e5281780d1da65 ("perf tools: Add event\_update event unit type")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/1fbc8158663fb0d4d5392e36bae564f6ad60be3c.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 4db1e70516a4cc10ab8c861e903b5f3d7afa50c8
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:09 2021 +0200
perf test event\_update: Fix memory leak of evlist
[ Upstream commit fc56f54f6fcd5337634f4545af6459613129b432 ]
ASan reports a memory leak when running:
# perf test "49: Synthesize attr update"
Caused by evlist not being deleted.
This patch adds the missing evlist\_\_delete and removes the
perf\_cpu\_map\_\_put since it's already being deleted by evlist\_\_delete.
Signed-off-by: Riccardo Mancini
Fixes: a6e5281780d1da65 ("perf tools: Add event\_update event unit type")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/f7994ad63d248f7645f901132d208fadf9f2b7e4.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 19239ff4c98da41d223daa3806b8cef0f43ed13a
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:08 2021 +0200
perf test session\_topology: Delete session->evlist
[ Upstream commit 233f2dc1c284337286f9a64c0152236779a42f6c ]
ASan reports a memory leak related to session->evlist while running:
# perf test "41: Session topology".
When perf\_data is in write mode, session->evlist is owned by the caller,
which should also take care of deleting it.
This patch adds the missing evlist\_\_delete().
Signed-off-by: Riccardo Mancini
Fixes: c84974ed9fb67293 ("perf test: Add entry to test cpu topology")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/822f741f06eb25250fb60686cf30a35f447e9e91.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 76b70b7987e76f420a5039b17d7498f9e8b3feae
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:07 2021 +0200
perf env: Fix sibling\_dies memory leak
[ Upstream commit 42db3d9ded555f7148b5695109a7dc8d66f0dde4 ]
ASan reports a memory leak in perf\_env while running:
# perf test "41: Session topology"
Caused by sibling\_dies not being freed.
This patch adds the required free.
Fixes: acae8b36cded0ee6 ("perf header: Add die information in CPU topology")
Signed-off-by: Riccardo Mancini
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/2140d0b57656e4eb9021ca9772250c24c032924b.1626343282.git.rickyman7@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 1e338fb1f779dcec3eb508a99a580f0e6334ae07
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:06 2021 +0200
perf probe: Fix dso->nsinfo refcounting
[ Upstream commit dedeb4be203b382ba7245d13079bc3b0f6d40c65 ]
ASan reports a memory leak of nsinfo during the execution of:
# perf test "31: Lookup mmap thread".
The leak is caused by a refcounted variable being replaced without
dropping the refcount.
This patch makes sure that the refcnt of nsinfo is decreased whenever
a refcounted variable is replaced with a new value.
Signed-off-by: Riccardo Mancini
Fixes: 544abd44c7064c8a ("perf probe: Allow placing uprobes in alternate namespaces.")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Krister Johansen
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/55223bc8821b34ccb01f92ef1401c02b6a32e61f.1626343282.git.rickyman7@gmail.com
[ Split from a larger patch ]
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 7ec2746ef5c6dbb6f1df9d4c18e81e13b85ddcaa
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:06 2021 +0200
perf map: Fix dso->nsinfo refcounting
[ Upstream commit 2d6b74baa7147251c30a46c4996e8cc224aa2dc5 ]
ASan reports a memory leak of nsinfo during the execution of
# perf test "31: Lookup mmap thread"
The leak is caused by a refcounted variable being replaced without
dropping the refcount.
This patch makes sure that the refcnt of nsinfo is decreased whenever a
refcounted variable is replaced with a new value.
Signed-off-by: Riccardo Mancini
Fixes: bf2e710b3cb8445c ("perf maps: Lookup maps in both intitial mountns and inner mountns.")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Krister Johansen
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/55223bc8821b34ccb01f92ef1401c02b6a32e61f.1626343282.git.rickyman7@gmail.com
[ Split from a larger patch ]
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 54dc8a81b785fee27cfc032f0683b2aba9d7479a
Author: Riccardo Mancini
Date: Thu Jul 15 18:07:06 2021 +0200
perf inject: Fix dso->nsinfo refcounting
[ Upstream commit 0967ebffe098157180a0bbd180ac90348c6e07d7 ]
ASan reports a memory leak of nsinfo during the execution of:
# perf test "31: Lookup mmap thread"
The leak is caused by a refcounted variable being replaced without
dropping the refcount.
This patch makes sure that the refcnt of nsinfo is decreased when a
refcounted variable is replaced with a new value.
Signed-off-by: Riccardo Mancini
Fixes: 27c9c3424fc217da ("perf inject: Add --buildid-all option")
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/55223bc8821b34ccb01f92ef1401c02b6a32e61f.1626343282.git.rickyman7@gmail.com
[ Split from a larger patch ]
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit ebeae33405576af47cfae09b2d5720cdc4fb06d0
Author: Sudeep Holla
Date: Thu Jun 24 10:50:59 2021 +0100
firmware: arm\_scmi: Ensure drivers provide a probe function
[ Upstream commit 5e469dac326555d2038d199a6329458cc82a34e5 ]
The bus probe callback calls the driver callback without further
checking. Better be safe than sorry and refuse registration of a driver
without a probe function to prevent a NULL pointer exception.
Link: https://lore.kernel.org/r/20210624095059.4010157-2-sudeep.holla@arm.com
Fixes: 933c504424a2 ("firmware: arm\_scmi: add scmi protocol bus to enumerate protocol devices")
Reported-by: Uwe Kleine-König
Tested-by: Cristian Marussi
Reviewed-by: Cristian Marussi
Acked-by: Uwe Kleine-König
Signed-off-by: Sudeep Holla
Signed-off-by: Sasha Levin
commit 1824f2a7d4a7cf9bc7ab19172ccf8f33de21d37c
Author: Zev Weiss
Date: Fri Apr 16 02:51:13 2021 -0500
ARM: dts: aspeed: Update e3c246d4i vuart properties
[ Upstream commit 812bae32e5d50914f75a6e036d3bde39ca86b0c3 ]
This device-tree was merged with a provisional vuart IRQ-polarity
property that was still under review and ended up taking a somewhat
different form. This patch updates it to match the final form of the
new vuart properties, which additionally allow specifying the SIRQ
number and LPC address.
Signed-off-by: Zev Weiss
Reviewed-by: Andrew Jeffery
Fixes: ca03042f0f12 ("serial: 8250\_aspeed\_vuart: add aspeed, lpc-io-reg and aspeed, lpc-interrupts DT properties")
Reviewed-by: Joel Stanley
Link: https://lore.kernel.org/r/20210416075113.18047-1-zev@bewilderbeest.net
Signed-off-by: Joel Stanley
Signed-off-by: Sasha Levin
commit 9fe5024f5738fe1bcf5cf39a5654b4fdd07e7ff2
Author: Mark Rutland
Date: Wed Jul 14 15:38:41 2021 +0100
arm64: mte: fix restoration of GCR\_EL1 from suspend
[ Upstream commit 59f44069e0527523f27948da7b77599a73dab157 ]
Since commit:
bad1e1c663e0a72f ("arm64: mte: switch GCR\_EL1 in kernel entry and exit")
we saved/restored the user GCR\_EL1 value at exception boundaries, and
update\_gcr\_el1\_excl() is no longer used for this. However it is used to
restore the kernel's GCR\_EL1 value when returning from a suspend state.
Thus, the comment is misleading (and an ISB is necessary).
When restoring the kernel's GCR value, we need an ISB to ensure this is
used by subsequent instructions. We don't necessarily get an ISB by
other means (e.g. if the kernel is built without support for pointer
authentication). As \_\_cpu\_setup() initialised GCR\_EL1.Exclude to 0xffff,
until a context synchronization event, allocation tag 0 may be used
rather than the desired set of tags.
This patch drops the misleading comment, adds the missing ISB, and for
clarity folds update\_gcr\_el1\_excl() into its only user.
Fixes: bad1e1c663e0 ("arm64: mte: switch GCR\_EL1 in kernel entry and exit")
Signed-off-by: Mark Rutland
Cc: Andrey Konovalov
Cc: Catalin Marinas
Cc: Vincenzo Frascino
Cc: Will Deacon
Link: https://lore.kernel.org/r/20210714143843.56537-2-mark.rutland@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 3a2c492e752814ad0567dd1a4ec37398ae003842
Author: Sean Christopherson
Date: Thu May 6 10:58:26 2021 -0700
KVM: SVM: Fix sev\_pin\_memory() error checks in SEV migration utilities
[ Upstream commit c7a1b2b678c54ac19320daf525038d0e2e43ca7c ]
Use IS\_ERR() instead of checking for a NULL pointer when querying for
sev\_pin\_memory() failures. sev\_pin\_memory() always returns an error code
cast to a pointer, or a valid pointer; it never returns NULL.
Reported-by: Dan Carpenter
Cc: Steve Rutherford
Cc: Brijesh Singh
Cc: Ashish Kalra
Fixes: d3d1af85e2c7 ("KVM: SVM: Add KVM\_SEND\_UPDATE\_DATA command")
Fixes: 15fb7de1a7f5 ("KVM: SVM: Add KVM\_SEV\_RECEIVE\_UPDATE\_DATA command")
Signed-off-by: Sean Christopherson
Message-Id: <20210506175826.2166383-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 9d85689380b6a5ebf0c4fe2047d84043b3c70a46
Author: Sean Christopherson
Date: Thu May 6 10:58:25 2021 -0700
KVM: SVM: Return -EFAULT if copy\_to\_user() for SEV mig packet header fails
[ Upstream commit b4a693924aab93f3747465b2261add46c82c3220 ]
Return -EFAULT if copy\_to\_user() fails; if accessing user memory faults,
copy\_to\_user() returns the number of bytes remaining, not an error code.
Reported-by: Dan Carpenter
Cc: Steve Rutherford
Cc: Brijesh Singh
Cc: Ashish Kalra
Fixes: d3d1af85e2c7 ("KVM: SVM: Add KVM\_SEND\_UPDATE\_DATA command")
Signed-off-by: Sean Christopherson
Message-Id: <20210506175826.2166383-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 319b79706f63dcee469dc4cc01c52a533b62622d
Author: Like Xu
Date: Mon Jun 28 15:43:54 2021 +0800
KVM: x86/pmu: Clear anythread deprecated bit when 0xa leaf is unsupported on the SVM
[ Upstream commit 7234c362ccb3c2228f06f19f93b132de9cfa7ae4 ]
The AMD platform does not support the functions Ah CPUID leaf. The returned
results for this entry should all remain zero just like the native does:
AMD host:
0x0000000a 0x00: eax=0x00000000 ebx=0x00000000 ecx=0x00000000 edx=0x00000000
(uncanny) AMD guest:
0x0000000a 0x00: eax=0x00000000 ebx=0x00000000 ecx=0x00000000 edx=0x00008000
Fixes: cadbaa039b99 ("perf/x86/intel: Make anythread filter support conditional")
Signed-off-by: Like Xu
Message-Id: <20210628074354.33848-1-likexu@tencent.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 916450b2101ba9a1245efd8b1f9139d24dcb8ab1
Author: Íñigo Huguet
Date: Tue Jul 13 16:21:27 2021 +0200
sfc: fix lack of XDP TX queues - error XDP TX failed (-22)
[ Upstream commit f28100cb9c9645c07cbd22431278ac9492f6a01c ]
Fixes: e26ca4b53582 sfc: reduce the number of requested xdp ev queues
The buggy commit intended to allocate less channels for XDP in order to
be more unlikely to reach the limit of 32 channels of the driver.
The idea was to use each IRQ/eventqeue for more XDP TX queues than
before, calculating which is the maximum number of TX queues that one
event queue can handle. For example, in EF10 each event queue could
handle up to 8 queues, better than the 4 they were handling before the
change. This way, it would have to allocate half of channels than before
for XDP TX.
The problem is that the TX queues are also contained inside the channel
structs, and there are only 4 queues per channel. Reducing the number of
channels means also reducing the number of queues, resulting in not
having the desired number of 1 queue per CPU.
This leads to getting errors on XDP\_TX and XDP\_REDIRECT if they're
executed from a high numbered CPU, because there only exist queues for
the low half of CPUs, actually. If XDP\_TX/REDIRECT is executed in a low
numbered CPU, the error doesn't happen. This is the error in the logs
(repeated many times, even rate limited):
sfc 0000:5e:00.0 ens3f0np0: XDP TX failed (-22)
This errors happens in function efx\_xdp\_tx\_buffers, where it expects to
have a dedicated XDP TX queue per CPU.
Reverting the change makes again more likely to reach the limit of 32
channels in machines with many CPUs. If this happen, no XDP\_TX/REDIRECT
will be possible at all, and we will have this log error messages:
At interface probe:
sfc 0000:5e:00.0: Insufficient resources for 12 XDP event queues (24 other channels, max 32)
At every subsequent XDP\_TX/REDIRECT failure, rate limited:
sfc 0000:5e:00.0 ens3f0np0: XDP TX failed (-22)
However, without reverting the change, it makes the user to think that
everything is OK at probe time, but later it fails in an unpredictable
way, depending on the CPU that handles the packet.
It is better to restore the predictable behaviour. If the user sees the
error message at probe time, he/she can try to configure the best way it
fits his/her needs. At least, he/she will have 2 options:
- Accept that XDP\_TX/REDIRECT is not available (he/she may not need it)
- Load sfc module with modparam 'rss\_cpus' with a lower number, thus
creating less normal RX queues/channels, letting more free resources
for XDP, with some performance penalty.
Anyway, let the calculation of maximum TX queues that can be handled by
a single event queue, and use it only if it's less than the number of TX
queues per channel. This doesn't happen in practice, but could happen if
some constant values are tweaked in the future, such us
EFX\_MAX\_TXQ\_PER\_CHANNEL, EFX\_MAX\_EVQ\_SIZE or EFX\_MAX\_DMAQ\_SIZE.
Related mailing list thread:
https://lore.kernel.org/bpf/20201215104327.2be76156@carbon/
Signed-off-by: Íñigo Huguet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 14a3ed8ef86850bbacaf316e962f4ae38b212cd7
Author: Vladimir Oltean
Date: Tue Jul 13 12:33:50 2021 +0300
net: ocelot: fix switchdev objects synced for wrong netdev with LAG offload
[ Upstream commit e56c6bbd98dc1cefb6f9c5d795fd29016e4f2fe7 ]
The point with a \*dev and a \*brport\_dev is that when we have a LAG net
device that is a bridge port, \*dev is an ocelot net device and
\*brport\_dev is the bonding/team net device. The ocelot net device
beneath the LAG does not exist from the bridge's perspective, so we need
to sync the switchdev objects belonging to the brport\_dev and not to the
dev.
Fixes: e4bd44e89dcf ("net: ocelot: replay switchdev events when joining bridge")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d1f7e509dc3a6cc74beb72f2f4a46b41861a5a5e
Author: Casey Chen
Date: Wed Jul 7 14:14:32 2021 -0700
nvme-pci: do not call nvme\_dev\_remove\_admin from nvme\_remove
[ Upstream commit 251ef6f71be2adfd09546a26643426fe62585173 ]
nvme\_dev\_remove\_admin could free dev->admin\_q and the admin\_tagset
while they are being accessed by nvme\_dev\_disable(), which can be called
by nvme\_reset\_work via nvme\_remove\_dead\_ctrl.
Commit cb4bfda62afa ("nvme-pci: fix hot removal during error handling")
intended to avoid requests being stuck on a removed controller by killing
the admin queue. But the later fix c8e9e9b7646e ("nvme-pci: unquiesce
admin queue on shutdown"), together with nvme\_dev\_disable(dev, true)
right before nvme\_dev\_remove\_admin() could help dispatch requests and
fail them early, so we don't need nvme\_dev\_remove\_admin() any more.
Fixes: cb4bfda62afa ("nvme-pci: fix hot removal during error handling")
Signed-off-by: Casey Chen
Reviewed-by: Keith Busch
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit b093e56f137c739b9e99ddf6c1e05fff70097800
Author: Marek Behún
Date: Sun Jul 11 18:38:15 2021 +0200
net: phy: marvell10g: fix differentiation of 88X3310 from 88X3340
[ Upstream commit a5de4be0aaaa66a2fa98e8a33bdbed3bd0682804 ]
It seems that we cannot differentiate 88X3310 from 88X3340 by simply
looking at bit 3 of revision ID. This only works on revisions A0 and A1.
On revision B0, this bit is always 1.
Instead use the 3.d00d register for differentiation, since this register
contains information about number of ports on the device.
Fixes: 9885d016ffa9 ("net: phy: marvell10g: add separate structure for 88X3340")
Signed-off-by: Marek Behún
Reported-by: Matteo Croce
Tested-by: Matteo Croce
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b2fe6fc671eaef878fbe00712d5ab32ac2dd9bec
Author: Paolo Abeni
Date: Fri Jul 9 17:20:51 2021 -0700
mptcp: properly account bulk freed memory
[ Upstream commit ce599c516386f09ca30848a1a4eb93d3fffbe187 ]
After commit 879526030c8b ("mptcp: protect the rx path with
the msk socket spinlock") the rmem currently used by a given
msk is really sk\_rmem\_alloc - rmem\_released.
The safety check in mptcp\_data\_ready() does not take the above
in due account, as a result legit incoming data is kept in
subflow receive queue with no reason, delaying or blocking
MPTCP-level ack generation.
This change addresses the issue introducing a new helper to fetch
the rmem memory and using it as needed. Additionally add a MIB
counter for the exceptional event described above - the peer is
misbehaving.
Finally, introduce the required annotation when rmem\_released is
updated.
Fixes: 879526030c8b ("mptcp: protect the rx path with the msk socket spinlock")
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/211
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cd7f1414f17072e9c267ee37013ba38446ee0ab7
Author: Paolo Abeni
Date: Tue Jun 22 12:25:23 2021 -0700
mptcp: refine mptcp\_cleanup\_rbuf
[ Upstream commit fde56eea01f96b664eb63033990be0fd2a945da5 ]
The current cleanup rbuf tries a bit too hard to avoid acquiring
the subflow socket lock. We may end-up delaying the needed ack,
or skip acking a blocked subflow.
Address the above extending the conditions used to trigger the cleanup
to reflect more closely what TCP does and invoking tcp\_cleanup\_rbuf()
on all the active subflows.
Note that we can't replicate the exact tests implemented in
tcp\_cleanup\_rbuf(), as MPTCP lacks some of the required info - e.g.
ping-pong mode.
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b24550868ff63d859b47a04dc218a397b56cf9ea
Author: Paolo Abeni
Date: Mon Jun 21 15:54:34 2021 -0700
mptcp: use fast lock for subflows when possible
[ Upstream commit 75e908c33615999abe1f3a8429d25dea30d28e4e ]
There are a bunch of callsite where the ssk socket
lock is acquired using the full-blown version eligible for
the fast variant. Let's move to the latter.
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c888aa8632185b5e03f09921c4c79ea0225d7cda
Author: Jianguo Wu
Date: Fri Jul 9 17:20:50 2021 -0700
selftests: mptcp: fix case multiple subflows limited by server
[ Upstream commit a7da441621c7945fbfd43ed239c93b8073cda502 ]
After patch "mptcp: fix syncookie process if mptcp can not\_accept new
subflow", if subflow is limited, MP\_JOIN SYN is dropped, and no SYN/ACK
will be replied.
So in case "multiple subflows limited by server", the expected SYN/ACK
number should be 1.
Fixes: 00587187ad30 ("selftests: mptcp: add test cases for mptcp join tests with syn cookies")
Reported-by: kernel test robot
Signed-off-by: Jianguo Wu
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fe2350115a5f406ec900ed6fbb07b9f27c4e8add
Author: Jianguo Wu
Date: Fri Jul 9 17:20:49 2021 -0700
mptcp: avoid processing packet if a subflow reset
[ Upstream commit 6787b7e350d3552651a3422d3d8980fbc8d65368 ]
If check\_fully\_established() causes a subflow reset, it should not
continue to process the packet in tcp\_data\_queue().
Add a return value to mptcp\_incoming\_options(), and return false if a
subflow has been reset, else return true. Then drop the packet in
tcp\_data\_queue()/tcp\_rcv\_state\_process() if mptcp\_incoming\_options()
return false.
Fixes: d582484726c4 ("mptcp: fix fallback for MP\_JOIN subflows")
Signed-off-by: Jianguo Wu
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1dabd873933f4ae3c4d33dd9434450e2fa1d04dd
Author: Geliang Tang
Date: Thu Jun 17 16:46:12 2021 -0700
mptcp: add sk parameter for mptcp\_get\_options
[ Upstream commit c863225b79426459feca2ef5b0cc2f07e8e68771 ]
This patch added a new parameter name sk in mptcp\_get\_options().
Acked-by: Paolo Abeni
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 89aa6912f2cfe50639420099874e60b325cc4f5f
Author: Jianguo Wu
Date: Fri Jul 9 17:20:48 2021 -0700
mptcp: fix syncookie process if mptcp can not\_accept new subflow
[ Upstream commit 8547ea5f52dd8ef19b69c25c41b1415481b3503b ]
Lots of "TCP: tcp\_fin: Impossible, sk->sk\_state=7" in client side
when doing stress testing using wrk and webfsd.
There are at least two cases may trigger this warning:
1.mptcp is in syncookie, and server recv MP\_JOIN SYN request,
in subflow\_check\_req(), the mptcp\_can\_accept\_new\_subflow()
return false, so subflow\_init\_req\_cookie\_join\_save() isn't
called, i.e. not store the data present in the MP\_JOIN syn
request and the random nonce in hash table - join\_entries[],
but still send synack. When recv 3rd-ack,
mptcp\_token\_join\_cookie\_init\_state() will return false, and
3rd-ack is dropped, then if mptcp conn is closed by client,
client will send a DATA\_FIN and a MPTCP FIN, the DATA\_FIN
doesn't have MP\_CAPABLE or MP\_JOIN,
so mptcp\_subflow\_init\_cookie\_req() will return 0, and pass
the cookie check, MP\_JOIN request is fallback to normal TCP.
Server will send a TCP FIN if closed, in client side,
when process TCP FIN, it will do reset, the code path is:
tcp\_data\_queue()->mptcp\_incoming\_options()
->check\_fully\_established()->mptcp\_subflow\_reset().
mptcp\_subflow\_reset() will set sock state to TCP\_CLOSE,
so tcp\_fin will hit TCP\_CLOSE, and print the warning.
2.mptcp is in syncookie, and server recv 3rd-ack, in
mptcp\_subflow\_init\_cookie\_req(), mptcp\_can\_accept\_new\_subflow()
return false, and subflow\_req->mp\_join is not set to 1,
so in subflow\_syn\_recv\_sock() will not reset the MP\_JOIN
subflow, but fallback to normal TCP, and then the same thing
happens when server will send a TCP FIN if closed.
For case1, subflow\_check\_req() return -EPERM,
then tcp\_conn\_request() will drop MP\_JOIN SYN.
For case2, let subflow\_syn\_recv\_sock() call
mptcp\_can\_accept\_new\_subflow(), and do fatal fallback, send reset.
Fixes: 9466a1ccebbe ("mptcp: enable JOIN requests even if cookies are in use")
Signed-off-by: Jianguo Wu
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1aa3ffb95fdc2090395a5733fc950859777a037f
Author: Jianguo Wu
Date: Fri Jul 9 17:20:47 2021 -0700
mptcp: remove redundant req destruct in subflow\_check\_req()
[ Upstream commit 030d37bd1cd2443a1f21db47eb301899bfa45a2a ]
In subflow\_check\_req(), if subflow sport is mismatch, will put msk,
destroy token, and destruct req, then return -EPERM, which can be
done by subflow\_req\_destructor() via:
tcp\_conn\_request()
|--\_\_reqsk\_free()
|--subflow\_req\_destructor()
So we should remove these redundant code, otherwise will call
tcp\_v4\_reqsk\_destructor() twice, and may double free
inet\_rsk(req)->ireq\_opt.
Fixes: 5bc56388c74f ("mptcp: add port number check for MP\_JOIN")
Signed-off-by: Jianguo Wu
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 688984fc1af16c094f52516de0f0155d2043d5cc
Author: Jianguo Wu
Date: Fri Jul 9 17:20:46 2021 -0700
mptcp: fix warning in \_\_skb\_flow\_dissect() when do syn cookie for subflow join
[ Upstream commit 0c71929b5893e410e0efbe1bbeca6f19a5f19956 ]
I did stress test with wrk[1] and webfsd[2] with the assistance of
mptcp-tools[3]:
Server side:
./use\_mptcp.sh webfsd -4 -R /tmp/ -p 8099
Client side:
./use\_mptcp.sh wrk -c 200 -d 30 -t 4 http://192.168.174.129:8099/
and got the following warning message:
[ 55.552626] TCP: request\_sock\_subflow: Possible SYN flooding on port 8099. Sending cookies. Check SNMP counters.
[ 55.553024] ------------[ cut here ]------------
[ 55.553027] WARNING: CPU: 0 PID: 10 at net/core/flow\_dissector.c:984 \_\_skb\_flow\_dissect+0x280/0x1650
...
[ 55.553117] CPU: 0 PID: 10 Comm: ksoftirqd/0 Not tainted 5.12.0+ #18
[ 55.553121] Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 02/27/2020
[ 55.553124] RIP: 0010:\_\_skb\_flow\_dissect+0x280/0x1650
...
[ 55.553133] RSP: 0018:ffffb79580087770 EFLAGS: 00010246
[ 55.553137] RAX: 0000000000000000 RBX: ffffffff8ddb58e0 RCX: ffffb79580087888
[ 55.553139] RDX: ffffffff8ddb58e0 RSI: ffff8f7e4652b600 RDI: 0000000000000000
[ 55.553141] RBP: ffffb79580087858 R08: 0000000000000000 R09: 0000000000000008
[ 55.553143] R10: 000000008c622965 R11: 00000000d3313a5b R12: ffff8f7e4652b600
[ 55.553146] R13: ffff8f7e465c9062 R14: 0000000000000000 R15: ffffb79580087888
[ 55.553149] FS: 0000000000000000(0000) GS:ffff8f7f75e00000(0000) knlGS:0000000000000000
[ 55.553152] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 55.553154] CR2: 00007f73d1d19000 CR3: 0000000135e10004 CR4: 00000000003706f0
[ 55.553160] Call Trace:
[ 55.553166] ? \_\_sha256\_final+0x67/0xd0
[ 55.553173] ? sha256+0x7e/0xa0
[ 55.553177] \_\_skb\_get\_hash+0x57/0x210
[ 55.553182] subflow\_init\_req\_cookie\_join\_save+0xac/0xc0
[ 55.553189] subflow\_check\_req+0x474/0x550
[ 55.553195] ? ip\_route\_output\_key\_hash+0x67/0x90
[ 55.553200] ? xfrm\_lookup\_route+0x1d/0xa0
[ 55.553207] subflow\_v4\_route\_req+0x8e/0xd0
[ 55.553212] tcp\_conn\_request+0x31e/0xab0
[ 55.553218] ? selinux\_socket\_sock\_rcv\_skb+0x116/0x210
[ 55.553224] ? tcp\_rcv\_state\_process+0x179/0x6d0
[ 55.553229] tcp\_rcv\_state\_process+0x179/0x6d0
[ 55.553235] tcp\_v4\_do\_rcv+0xaf/0x220
[ 55.553239] tcp\_v4\_rcv+0xce4/0xd80
[ 55.553243] ? ip\_route\_input\_rcu+0x246/0x260
[ 55.553248] ip\_protocol\_deliver\_rcu+0x35/0x1b0
[ 55.553253] ip\_local\_deliver\_finish+0x44/0x50
[ 55.553258] ip\_local\_deliver+0x6c/0x110
[ 55.553262] ? ip\_rcv\_finish\_core.isra.19+0x5a/0x400
[ 55.553267] ip\_rcv+0xd1/0xe0
...
After debugging, I found in \_\_skb\_flow\_dissect(), skb->dev and skb->sk
are both NULL, then net is NULL, and trigger WARN\_ON\_ONCE(!net),
actually net is always NULL in this code path, as skb->dev is set to
NULL in tcp\_v4\_rcv(), and skb->sk is never set.
Code snippet in \_\_skb\_flow\_dissect() that trigger warning:
975 if (skb) {
976 if (!net) {
977 if (skb->dev)
978 net = dev\_net(skb->dev);
979 else if (skb->sk)
980 net = sock\_net(skb->sk);
981 }
982 }
983
984 WARN\_ON\_ONCE(!net);
So, using seq and transport header derived hash.
[1] https://github.com/wg/wrk
[2] https://github.com/ourway/webfsd
[3] https://github.com/pabeni/mptcp-tools
Fixes: 9466a1ccebbe ("mptcp: enable JOIN requests even if cookies are in use")
Suggested-by: Paolo Abeni
Suggested-by: Florian Westphal
Signed-off-by: Jianguo Wu
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5a870ea6e8b7beb767f2158aea59736e9326e073
Author: Zack Rusin
Date: Tue Jun 15 14:23:35 2021 -0400
drm/vmwgfx: Fix a bad merge in otable batch takedown
[ Upstream commit 34bd46bcf3de72cbffcdc42d3fa67e543d1c869b ]
Change
2ef4fb92363c ("drm/vmwgfx: Make sure bo's are unpinned before putting them back")
caused a conflict in one of the drm trees and the merge commit
68a32ba14177 ("Merge tag 'drm-next-2021-04-28' of git://anongit.freedesktop.org/drm/drm")
accidently re-added code that the original change was removing.
Fixed by removing the incorrect buffer unpin - it has already been unpinned
two lines above.
Fixes: 68a32ba14177 ("Merge tag 'drm-next-2021-04-28' of git://anongit.freedesktop.org/drm/drm")
Signed-off-by: Zack Rusin
Reviewed-by: Martin Krastev
Link: https://patchwork.freedesktop.org/patch/msgid/20210615182336.995192-4-zackr@vmware.com
Signed-off-by: Sasha Levin
commit 441b2f191e9f3a28baf5f5142838dd844cbfa11d
Author: Shahjada Abul Husain
Date: Thu Jul 8 21:51:56 2021 +0530
cxgb4: fix IRQ free race during driver unload
[ Upstream commit 015fe6fd29c4b9ac0f61b8c4455ef88e6018b9cc ]
IRQs are requested during driver's ndo\_open() and then later
freed up in disable\_interrupts() during driver unload.
A race exists where driver can set the CXGB4\_FULL\_INIT\_DONE
flag in ndo\_open() after the disable\_interrupts() in driver
unload path checks it, and hence misses calling free\_irq().
Fix by unregistering netdevice first and sync with driver's
ndo\_open(). This ensures disable\_interrupts() checks the flag
correctly and frees up the IRQs properly.
Fixes: b37987e8db5f ("cxgb4: Disable interrupts and napi before unregistering netdev")
Signed-off-by: Shahjada Abul Husain
Signed-off-by: Raju Rangoju
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit efdf9d46bc15786b35a07284dbfb8573cb1addd4
Author: Uwe Kleine-König
Date: Thu Jul 1 10:27:51 2021 +0200
pwm: sprd: Ensure configuring period and duty\_cycle isn't wrongly skipped
[ Upstream commit 65e2e6c1c20104ed19060a38f4edbf14e9f9a9a5 ]
As the last call to sprd\_pwm\_apply() might have exited early if
state->enabled was false, the values for period and duty\_cycle stored in
pwm->state might not have been written to hardware and it must be
ensured that they are configured before enabling the PWM.
Fixes: 8aae4b02e8a6 ("pwm: sprd: Add Spreadtrum PWM support")
Signed-off-by: Uwe Kleine-König
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
commit 6c75b21b2aab0eb604c827d3fc846f2ddb3890fb
Author: Hangbin Liu
Date: Wed Jul 7 16:15:30 2021 +0800
selftests: icmp\_redirect: IPv6 PMTU info should be cleared after redirect
[ Upstream commit 0e02bf5de46ae30074a2e1a8194a422a84482a1a ]
After redirecting, it's already a new path. So the old PMTU info should
be cleared. The IPv6 test "mtu exception plus redirect" should only
has redirect info without old PMTU.
The IPv4 test can not be changed because of legacy.
Fixes: ec8105352869 ("selftests: Add redirect tests")
Signed-off-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 84d37878814b0a4ab4faf7fc1f3394cf37e2a5ba
Author: Hangbin Liu
Date: Wed Jul 7 16:15:29 2021 +0800
selftests: icmp\_redirect: remove from checking for IPv6 route get
[ Upstream commit 24b671aad4eae423e1abf5b7f08d9a5235458b8d ]
If the kernel doesn't enable option CONFIG\_IPV6\_SUBTREES, the RTA\_SRC
info will not be exported to userspace in rt6\_fill\_node(). And ip cmd will
not print "from ::" to the route output. So remove this check.
Fixes: ec8105352869 ("selftests: Add redirect tests")
Signed-off-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b11b6ecda552cc0bf59fd7cdd0d59b0c2a1491ee
Author: YueHaibing
Date: Wed Jul 7 15:53:35 2021 +0800
stmmac: platform: Fix signedness bug in stmmac\_probe\_config\_dt()
[ Upstream commit eca81f09145d765c21dd8fb1ba5d874ca255c32c ]
The "plat->phy\_interface" variable is an enum and in this context GCC
will treat it as an unsigned int so the error handling is never
triggered.
Fixes: b9f0b2f634c0 ("net: stmmac: platform: fix probe for ACPI devices")
Signed-off-by: YueHaibing
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 350e10d217337480158b604bbf6601c50ed161c6
Author: Nicolas Dichtel
Date: Tue Jul 6 11:13:35 2021 +0200
ipv6: fix 'disable\_policy' for fwd packets
[ Upstream commit ccd27f05ae7b8ebc40af5b004e94517a919aa862 ]
The goal of commit df789fe75206 ("ipv6: Provide ipv6 version of
"disable\_policy" sysctl") was to have the disable\_policy from ipv4
available on ipv6.
However, it's not exactly the same mechanism. On IPv4, all packets coming
from an interface, which has disable\_policy set, bypass the policy check.
For ipv6, this is done only for local packets, ie for packets destinated to
an address configured on the incoming interface.
Let's align ipv6 with ipv4 so that the 'disable\_policy' sysctl has the same
effect for both protocols.
My first approach was to create a new kind of route cache entries, to be
able to set DST\_NOPOLICY without modifying routes. This would have added a
lot of code. Because the local delivery path is already handled, I choose
to focus on the forwarding path to minimize code churn.
Fixes: df789fe75206 ("ipv6: Provide ipv6 version of "disable\_policy" sysctl")
Signed-off-by: Nicolas Dichtel
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8994e395fc39a15351ea39ca89d746abd55da017
Author: Taehee Yoo
Date: Mon Jul 5 15:38:14 2021 +0000
bonding: fix incorrect return value of bond\_ipsec\_offload\_ok()
[ Upstream commit 168e696a36792a4a3b2525a06249e7472ef90186 ]
bond\_ipsec\_offload\_ok() is called to check whether the interface supports
ipsec offload or not.
bonding interface support ipsec offload only in active-backup mode.
So, if a bond interface is not in active-backup mode, it should return
false but it returns true.
Fixes: a3b658cfb664 ("bonding: allow xfrm offload setup post-module-load")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4ac748c4b2240cd3b4086166c3fdd8e01621728e
Author: Taehee Yoo
Date: Mon Jul 5 15:38:13 2021 +0000
bonding: fix suspicious RCU usage in bond\_ipsec\_offload\_ok()
[ Upstream commit 955b785ec6b3b2f9b91914d6eeac8ee66ee29239 ]
To dereference bond->curr\_active\_slave, it uses rcu\_dereference().
But it and the caller doesn't acquire RCU so a warning occurs.
So add rcu\_read\_lock().
Splat looks like:
WARNING: suspicious RCU usage
5.13.0-rc6+ #1179 Not tainted
drivers/net/bonding/bond\_main.c:571 suspicious
rcu\_dereference\_check() usage!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ping/974:
#0: ffff888109e7db70 (sk\_lock-AF\_INET){+.+.}-{0:0},
at: raw\_sendmsg+0x1303/0x2cb0
stack backtrace:
CPU: 2 PID: 974 Comm: ping Not tainted 5.13.0-rc6+ #1179
Call Trace:
dump\_stack+0xa4/0xe5
bond\_ipsec\_offload\_ok+0x1f4/0x260 [bonding]
xfrm\_output+0x179/0x890
xfrm4\_output+0xfa/0x410
? \_\_xfrm4\_output+0x4b0/0x4b0
? \_\_ip\_make\_skb+0xecc/0x2030
? xfrm4\_udp\_encap\_rcv+0x800/0x800
? ip\_local\_out+0x21/0x3a0
ip\_send\_skb+0x37/0xa0
raw\_sendmsg+0x1bfd/0x2cb0
Fixes: 18cb261afd7b ("bonding: support hardware encryption offload to slaves")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 42ec69b9cd7d1f9a8b7420807f3a5d899ca99d28
Author: Taehee Yoo
Date: Mon Jul 5 15:38:12 2021 +0000
bonding: Add struct bond\_ipesc to manage SA
[ Upstream commit 9a5605505d9c7dbfdb89cc29a8f5fc5cf9fd2334 ]
bonding has been supporting ipsec offload.
When SA is added, bonding just passes SA to its own active real interface.
But it doesn't manage SA.
So, when events(add/del real interface, active real interface change, etc)
occur, bonding can't handle that well because It doesn't manage SA.
So some problems(panic, UAF, refcnt leak)occur.
In order to make it stable, it should manage SA.
That's the reason why struct bond\_ipsec is added.
When a new SA is added to bonding interface, it is stored in the
bond\_ipsec list. And the SA is passed to a current active real interface.
If events occur, it uses bond\_ipsec data to handle these events.
bond->ipsec\_list is protected by bond->ipsec\_lock.
If a current active real interface is changed, the following logic works.
1. delete all SAs from old active real interface
2. Add all SAs to the new active real interface.
3. If a new active real interface doesn't support ipsec offload or SA's
option, it sets real\_dev to NULL.
Fixes: 18cb261afd7b ("bonding: support hardware encryption offload to slaves")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d5e9ed0855a4aef14a4506a0caee9464308c4069
Author: Taehee Yoo
Date: Mon Jul 5 15:38:11 2021 +0000
bonding: disallow setting nested bonding + ipsec offload
[ Upstream commit b121693381b112b78c076dea171ee113e237c0e4 ]
bonding interface can be nested and it supports ipsec offload.
So, it allows setting the nested bonding + ipsec scenario.
But code does not support this scenario.
So, it should be disallowed.
interface graph:
bond2
|
bond1
|
eth0
The nested bonding + ipsec offload may not a real usecase.
So, disallowing this scenario is fine.
Fixes: 18cb261afd7b ("bonding: support hardware encryption offload to slaves")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c24d04866549619d6d6fdee6fe9d3eadd6c7f578
Author: Taehee Yoo
Date: Mon Jul 5 15:38:10 2021 +0000
bonding: fix suspicious RCU usage in bond\_ipsec\_del\_sa()
[ Upstream commit a22c39b831a081da9b2c488bd970a4412d926f30 ]
To dereference bond->curr\_active\_slave, it uses rcu\_dereference().
But it and the caller doesn't acquire RCU so a warning occurs.
So add rcu\_read\_lock().
Test commands:
ip netns add A
ip netns exec A bash
modprobe netdevsim
echo "1 1" > /sys/bus/netdevsim/new\_device
ip link add bond0 type bond
ip link set eth0 master bond0
ip link set eth0 up
ip link set bond0 up
ip x s add proto esp dst 14.1.1.1 src 15.1.1.1 spi 0x07 mode \
transport reqid 0x07 replay-window 32 aead 'rfc4106(gcm(aes))' \
0x44434241343332312423222114131211f4f3f2f1 128 sel src 14.0.0.52/24 \
dst 14.0.0.70/24 proto tcp offload dev bond0 dir in
ip x s f
Splat looks like:
=============================
WARNING: suspicious RCU usage
5.13.0-rc3+ #1168 Not tainted
-----------------------------
drivers/net/bonding/bond\_main.c:448 suspicious rcu\_dereference\_check()
usage!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
2 locks held by ip/705:
#0: ffff888106701780 (&net->xfrm.xfrm\_cfg\_mutex){+.+.}-{3:3},
at: xfrm\_netlink\_rcv+0x59/0x80 [xfrm\_user]
#1: ffff8880075b0098 (&x->lock){+.-.}-{2:2},
at: xfrm\_state\_delete+0x16/0x30
stack backtrace:
CPU: 6 PID: 705 Comm: ip Not tainted 5.13.0-rc3+ #1168
Call Trace:
dump\_stack+0xa4/0xe5
bond\_ipsec\_del\_sa+0x16a/0x1c0 [bonding]
\_\_xfrm\_state\_delete+0x51f/0x730
xfrm\_state\_delete+0x1e/0x30
xfrm\_state\_flush+0x22f/0x390
xfrm\_flush\_sa+0xd8/0x260 [xfrm\_user]
? xfrm\_flush\_policy+0x290/0x290 [xfrm\_user]
xfrm\_user\_rcv\_msg+0x331/0x660 [xfrm\_user]
? rcu\_read\_lock\_sched\_held+0x91/0xc0
? xfrm\_user\_state\_lookup.constprop.39+0x320/0x320 [xfrm\_user]
? find\_held\_lock+0x3a/0x1c0
? mutex\_lock\_io\_nested+0x1210/0x1210
? sched\_clock\_cpu+0x18/0x170
netlink\_rcv\_skb+0x121/0x350
[ ... ]
Fixes: 18cb261afd7b ("bonding: support hardware encryption offload to slaves")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a1f01d2ddb55f62bd70d3c1391f5c652d5dbc139
Author: Taehee Yoo
Date: Mon Jul 5 15:38:09 2021 +0000
ixgbevf: use xso.real\_dev instead of xso.dev in callback functions of struct xfrmdev\_ops
[ Upstream commit 2de7e4f67599affc97132bd07e30e3bd59d0b777 ]
There are two pointers in struct xfrm\_state\_offload, \*dev, \*real\_dev.
These are used in callback functions of struct xfrmdev\_ops.
The \*dev points whether bonding interface or real interface.
If bonding ipsec offload is used, it points bonding interface If not,
it points real interface.
And real\_dev always points real interface.
So, ixgbevf should always use real\_dev instead of dev.
Of course, real\_dev always not be null.
Test commands:
ip link add bond0 type bond
#eth0 is ixgbevf interface
ip link set eth0 master bond0
ip link set bond0 up
ip x s add proto esp dst 14.1.1.1 src 15.1.1.1 spi 0x07 mode \
transport reqid 0x07 replay-window 32 aead 'rfc4106(gcm(aes))' \
0x44434241343332312423222114131211f4f3f2f1 128 sel src 14.0.0.52/24 \
dst 14.0.0.70/24 proto tcp offload dev bond0 dir in
Splat looks like:
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
CPU: 6 PID: 688 Comm: ip Not tainted 5.13.0-rc3+ #1168
RIP: 0010:ixgbevf\_ipsec\_find\_empty\_idx+0x28/0x1b0 [ixgbevf]
Code: 00 00 0f 1f 44 00 00 55 53 48 89 fb 48 83 ec 08 40 84 f6 0f 84 9c
00 00 00 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 <0f> b6 04 02
84 c0 74 08 3c 01 0f 8e 4c 01 00 00 66 81 3b 00 04 0f
RSP: 0018:ffff8880089af390 EFLAGS: 00010246
RAX: dffffc0000000000 RBX: 0000000000000000 RCX: 0000000000000001
RDX: 0000000000000000 RSI: 0000000000000001 RDI: 0000000000000000
RBP: ffff8880089af4f8 R08: 0000000000000003 R09: fffffbfff4287e11
R10: 0000000000000001 R11: ffff888005de8908 R12: 0000000000000000
R13: ffff88810936a000 R14: ffff88810936a000 R15: ffff888004d78040
FS: 00007fdf9883a680(0000) GS:ffff88811a400000(0000)
knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000055bc14adbf40 CR3: 000000000b87c005 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
ixgbevf\_ipsec\_add\_sa+0x1bf/0x9c0 [ixgbevf]
? rcu\_read\_lock\_sched\_held+0x91/0xc0
? ixgbevf\_ipsec\_parse\_proto\_keys.isra.9+0x280/0x280 [ixgbevf]
? lock\_acquire+0x191/0x720
? bond\_ipsec\_add\_sa+0x48/0x350 [bonding]
? lockdep\_hardirqs\_on\_prepare+0x3e0/0x3e0
? rcu\_read\_lock\_held+0x91/0xa0
? rcu\_read\_lock\_sched\_held+0xc0/0xc0
bond\_ipsec\_add\_sa+0x193/0x350 [bonding]
xfrm\_dev\_state\_add+0x2a9/0x770
? memcpy+0x38/0x60
xfrm\_add\_sa+0x2278/0x3b10 [xfrm\_user]
? xfrm\_get\_policy+0xaa0/0xaa0 [xfrm\_user]
? register\_lock\_class+0x1750/0x1750
xfrm\_user\_rcv\_msg+0x331/0x660 [xfrm\_user]
? rcu\_read\_lock\_sched\_held+0x91/0xc0
? xfrm\_user\_state\_lookup.constprop.39+0x320/0x320 [xfrm\_user]
? find\_held\_lock+0x3a/0x1c0
? mutex\_lock\_io\_nested+0x1210/0x1210
? sched\_clock\_cpu+0x18/0x170
netlink\_rcv\_skb+0x121/0x350
[ ... ]
Fixes: 272c2330adc9 ("xfrm: bail early on slave pass over skb")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9863701fa0ecd2abfadb27b0e7a9b0fe1c9d02b6
Author: Taehee Yoo
Date: Mon Jul 5 15:38:07 2021 +0000
bonding: fix null dereference in bond\_ipsec\_add\_sa()
[ Upstream commit 105cd17a866017b45f3c45901b394c711c97bf40 ]
If bond doesn't have real device, bond->curr\_active\_slave is null.
But bond\_ipsec\_add\_sa() dereferences bond->curr\_active\_slave without
null checking.
So, null-ptr-deref would occur.
Test commands:
ip link add bond0 type bond
ip link set bond0 up
ip x s add proto esp dst 14.1.1.1 src 15.1.1.1 spi \
0x07 mode transport reqid 0x07 replay-window 32 aead 'rfc4106(gcm(aes))' \
0x44434241343332312423222114131211f4f3f2f1 128 sel src 14.0.0.52/24 \
dst 14.0.0.70/24 proto tcp offload dev bond0 dir in
Splat looks like:
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
CPU: 4 PID: 680 Comm: ip Not tainted 5.13.0-rc3+ #1168
RIP: 0010:bond\_ipsec\_add\_sa+0xc4/0x2e0 [bonding]
Code: 85 21 02 00 00 4d 8b a6 48 0c 00 00 e8 75 58 44 ce 85 c0 0f 85 14
01 00 00 48 b8 00 00 00 00 00 fc ff df 4c 89 e2 48 c1 ea 03 <80> 3c 02
00 0f 85 fc 01 00 00 48 8d bb e0 02 00 00 4d 8b 2c 24 48
RSP: 0018:ffff88810946f508 EFLAGS: 00010246
RAX: dffffc0000000000 RBX: ffff88810b4e8040 RCX: 0000000000000001
RDX: 0000000000000000 RSI: ffffffff8fe34280 RDI: ffff888115abe100
RBP: ffff88810946f528 R08: 0000000000000003 R09: fffffbfff2287e11
R10: 0000000000000001 R11: ffff888115abe0c8 R12: 0000000000000000
R13: ffffffffc0aea9a0 R14: ffff88800d7d2000 R15: ffff88810b4e8330
FS: 00007efc5552e680(0000) GS:ffff888119c00000(0000)
knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000055c2530dbf40 CR3: 0000000103056004 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
xfrm\_dev\_state\_add+0x2a9/0x770
? memcpy+0x38/0x60
xfrm\_add\_sa+0x2278/0x3b10 [xfrm\_user]
? xfrm\_get\_policy+0xaa0/0xaa0 [xfrm\_user]
? register\_lock\_class+0x1750/0x1750
xfrm\_user\_rcv\_msg+0x331/0x660 [xfrm\_user]
? rcu\_read\_lock\_sched\_held+0x91/0xc0
? xfrm\_user\_state\_lookup.constprop.39+0x320/0x320 [xfrm\_user]
? find\_held\_lock+0x3a/0x1c0
? mutex\_lock\_io\_nested+0x1210/0x1210
? sched\_clock\_cpu+0x18/0x170
netlink\_rcv\_skb+0x121/0x350
? xfrm\_user\_state\_lookup.constprop.39+0x320/0x320 [xfrm\_user]
? netlink\_ack+0x9d0/0x9d0
? netlink\_deliver\_tap+0x17c/0xa50
xfrm\_netlink\_rcv+0x68/0x80 [xfrm\_user]
netlink\_unicast+0x41c/0x610
? netlink\_attachskb+0x710/0x710
netlink\_sendmsg+0x6b9/0xb70
[ ...]
Fixes: 18cb261afd7b ("bonding: support hardware encryption offload to slaves")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9ae2584fdd67b0c793935fa0d2fcedeb3d9a438b
Author: Taehee Yoo
Date: Mon Jul 5 15:38:06 2021 +0000
bonding: fix suspicious RCU usage in bond\_ipsec\_add\_sa()
[ Upstream commit b648eba4c69e5819880b4907e7fcb2bb576069ab ]
To dereference bond->curr\_active\_slave, it uses rcu\_dereference().
But it and the caller doesn't acquire RCU so a warning occurs.
So add rcu\_read\_lock().
Test commands:
ip link add dummy0 type dummy
ip link add bond0 type bond
ip link set dummy0 master bond0
ip link set dummy0 up
ip link set bond0 up
ip x s add proto esp dst 14.1.1.1 src 15.1.1.1 spi 0x07 \
mode transport \
reqid 0x07 replay-window 32 aead 'rfc4106(gcm(aes))' \
0x44434241343332312423222114131211f4f3f2f1 128 sel \
src 14.0.0.52/24 dst 14.0.0.70/24 proto tcp offload \
dev bond0 dir in
Splat looks like:
=============================
WARNING: suspicious RCU usage
5.13.0-rc3+ #1168 Not tainted
-----------------------------
drivers/net/bonding/bond\_main.c:411 suspicious rcu\_dereference\_check() usage!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by ip/684:
#0: ffffffff9a2757c0 (&net->xfrm.xfrm\_cfg\_mutex){+.+.}-{3:3},
at: xfrm\_netlink\_rcv+0x59/0x80 [xfrm\_user]
55.191733][ T684] stack backtrace:
CPU: 0 PID: 684 Comm: ip Not tainted 5.13.0-rc3+ #1168
Call Trace:
dump\_stack+0xa4/0xe5
bond\_ipsec\_add\_sa+0x18c/0x1f0 [bonding]
xfrm\_dev\_state\_add+0x2a9/0x770
? memcpy+0x38/0x60
xfrm\_add\_sa+0x2278/0x3b10 [xfrm\_user]
? xfrm\_get\_policy+0xaa0/0xaa0 [xfrm\_user]
? register\_lock\_class+0x1750/0x1750
xfrm\_user\_rcv\_msg+0x331/0x660 [xfrm\_user]
? rcu\_read\_lock\_sched\_held+0x91/0xc0
? xfrm\_user\_state\_lookup.constprop.39+0x320/0x320 [xfrm\_user]
? find\_held\_lock+0x3a/0x1c0
? mutex\_lock\_io\_nested+0x1210/0x1210
? sched\_clock\_cpu+0x18/0x170
netlink\_rcv\_skb+0x121/0x350
? xfrm\_user\_state\_lookup.constprop.39+0x320/0x320 [xfrm\_user]
? netlink\_ack+0x9d0/0x9d0
? netlink\_deliver\_tap+0x17c/0xa50
xfrm\_netlink\_rcv+0x68/0x80 [xfrm\_user]
netlink\_unicast+0x41c/0x610
? netlink\_attachskb+0x710/0x710
netlink\_sendmsg+0x6b9/0xb70
[ ... ]
Fixes: 18cb261afd7b ("bonding: support hardware encryption offload to slaves")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 08d21fa872ec8ceb0054f224e1bf8cd764622928
Author: Wang Hai
Date: Mon Jun 28 17:18:15 2021 +0800
bpf, samples: Fix xdpsock with '-M' parameter missing unload process
[ Upstream commit 2620e92ae6ed83260eb46d214554cd308ee35d92 ]
Execute the following command and exit, then execute it again, the following
error will be reported:
$ sudo ./samples/bpf/xdpsock -i ens4f2 -M
^C
$ sudo ./samples/bpf/xdpsock -i ens4f2 -M
libbpf: elf: skipping unrecognized data section(16) .eh\_frame
libbpf: elf: skipping relo section(17) .rel.eh\_frame for section(16) .eh\_frame
libbpf: Kernel error message: XDP program already attached
ERROR: link set xdp fd failed
Commit c9d27c9e8dc7 ("samples: bpf: Do not unload prog within xdpsock") removed
the unloading prog code because of the presence of bpf\_link. This is fine if
XDP\_SHARED\_UMEM is disabled, but if it is enabled, unloading the prog is still
needed.
Fixes: c9d27c9e8dc7 ("samples: bpf: Do not unload prog within xdpsock")
Signed-off-by: Wang Hai
Signed-off-by: Daniel Borkmann
Acked-by: Magnus Karlsson
Cc: Maciej Fijalkowski
Link: https://lore.kernel.org/bpf/20210628091815.2373487-1-wanghai38@huawei.com
Signed-off-by: Sasha Levin
commit b2a6c45d44e9e72259f52d9db92e060e655158df
Author: Christophe JAILLET
Date: Thu Jul 1 22:18:24 2021 +0200
gve: Fix an error handling path in 'gve\_probe()'
[ Upstream commit 2342ae10d1272d411a468a85a67647dd115b344f ]
If the 'register\_netdev() call fails, we must release the resources
allocated by the previous 'gve\_init\_priv()' call, as already done in the
remove function.
Add a new label and the missing 'gve\_teardown\_priv\_resources()' in the
error handling path.
Fixes: 893ce44df565 ("gve: Add basic driver framework for Compute Engine Virtual NIC")
Signed-off-by: Christophe JAILLET
Reviewed-by: Catherine Sullivan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 2f2b3b953b43d7653310fd0d4e51607d920ef9f3
Author: Mohammad Athari Bin Ismail
Date: Wed Jun 30 17:59:35 2021 +0800
net: stmmac: Terminate FPE workqueue in suspend
[ Upstream commit 6b28a86d6c0bb02119f386ec2f56efde909e9bcb ]
Add stmmac\_fpe\_stop\_wq() in stmmac\_suspend() to terminate FPE workqueue
during suspend. So, in suspend mode, there will be no FPE workqueue
available. Without this fix, new additional FPE workqueue will be created
in every suspend->resume cycle.
Fixes: 5a5586112b92 ("net: stmmac: support FPE link partner hand-shaking procedure")
Signed-off-by: Mohammad Athari Bin Ismail
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 317de567c11203b18cc28c0fb75c3ad2d6d1ff8c
Author: Jedrzej Jagielski
Date: Fri Jun 11 22:42:17 2021 +0000
igb: Fix position of assignment to \*ring
[ Upstream commit 382a7c20d9253bcd5715789b8179528d0f3de72c ]
Assignment to \*ring should be done after correctness check of the
argument queue.
Fixes: 91db364236c8 ("igb: Refactor igb\_configure\_cbs()")
Signed-off-by: Jedrzej Jagielski
Acked-by: Vinicius Costa Gomes
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 6c82171aa35b3a3ccc2f46aa41a946b63e6b9169
Author: Aleksandr Loktionov
Date: Thu Apr 22 10:19:23 2021 +0000
igb: Check if num of q\_vectors is smaller than max before array access
[ Upstream commit 6c19d772618fea40d9681f259368f284a330fd90 ]
Ensure that the adapter->q\_vector[MAX\_Q\_VECTORS] array isn't accessed
beyond its size. It was fixed by using a local variable num\_q\_vectors
as a limit for loop index, and ensure that num\_q\_vectors is not bigger
than MAX\_Q\_VECTORS.
Fixes: 047e0030f1e6 ("igb: add new data structure for handling interrupts and NAPI")
Signed-off-by: Aleksandr Loktionov
Reviewed-by: Grzegorz Siwik
Reviewed-by: Arkadiusz Kubalewski
Reviewed-by: Slawomir Laba
Reviewed-by: Sylwester Dziedziuch
Reviewed-by: Mateusz Palczewski
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit e2b71652a5e396486445c6bc2149af2d03a5eeaa
Author: Christophe JAILLET
Date: Wed Jun 16 07:53:02 2021 +0200
iavf: Fix an error handling path in 'iavf\_probe()'
[ Upstream commit af30cbd2f4d6d66a9b6094e0aa32420bc8b20e08 ]
If an error occurs after a 'pci\_enable\_pcie\_error\_reporting()' call, it
must be undone by a corresponding 'pci\_disable\_pcie\_error\_reporting()'
call, as already done in the remove function.
Fixes: 5eae00c57f5e ("i40evf: main driver core")
Signed-off-by: Christophe JAILLET
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 2f5343365d179e9d8d872f1006697d206d63a72e
Author: Christophe JAILLET
Date: Wed Jun 16 07:05:53 2021 +0200
e1000e: Fix an error handling path in 'e1000\_probe()'
[ Upstream commit 4589075608420bc49fcef6e98279324bf2bb91ae ]
If an error occurs after a 'pci\_enable\_pcie\_error\_reporting()' call, it
must be undone by a corresponding 'pci\_disable\_pcie\_error\_reporting()'
call, as already done in the remove function.
Fixes: 111b9dc5c981 ("e1000e: add aer support")
Signed-off-by: Christophe JAILLET
Acked-by: Sasha Neftin
Tested-by: Dvora Fuxbrumer
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit b928fdcafad9927db7a994f2f299eb9150c3ebbf
Author: Christophe JAILLET
Date: Wed Jun 16 07:00:36 2021 +0200
fm10k: Fix an error handling path in 'fm10k\_probe()'
[ Upstream commit e85e14d68f517ef12a5fb8123fff65526b35b6cd ]
If an error occurs after a 'pci\_enable\_pcie\_error\_reporting()' call, it
must be undone by a corresponding 'pci\_disable\_pcie\_error\_reporting()'
call, as already done in the remove function.
Fixes: 19ae1b3fb99c ("fm10k: Add support for PCI power management and error handling")
Signed-off-by: Christophe JAILLET
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit a0169ebdb140bff6c43a7389adf2e4ea3da675fa
Author: Christophe JAILLET
Date: Sat Jun 12 22:08:33 2021 +0200
igb: Fix an error handling path in 'igb\_probe()'
[ Upstream commit fea03b1cebd653cd095f2e9a58cfe1c85661c363 ]
If an error occurs after a 'pci\_enable\_pcie\_error\_reporting()' call, it
must be undone by a corresponding 'pci\_disable\_pcie\_error\_reporting()'
call, as already done in the remove function.
Fixes: 40a914fa72ab ("igb: Add support for pci-e Advanced Error Reporting")
Signed-off-by: Christophe JAILLET
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 67ad974445802c2f4d083c60902296d35070f9c2
Author: Christophe JAILLET
Date: Sat Jun 12 22:00:05 2021 +0200
igc: Fix an error handling path in 'igc\_probe()'
[ Upstream commit c6bc9e5ce5d37cb3e6b552f41b92a193db1806ab ]
If an error occurs after a 'pci\_enable\_pcie\_error\_reporting()' call, it
must be undone by a corresponding 'pci\_disable\_pcie\_error\_reporting()'
call, as already done in the remove function.
Fixes: c9a11c23ceb6 ("igc: Add netdev")
Signed-off-by: Christophe JAILLET
Tested-by: Dvora Fuxbrumer
Acked-by: Sasha Neftin
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 67a846441f8ef62347533255df72e743298f9d94
Author: Christophe JAILLET
Date: Sat Jun 12 15:46:09 2021 +0200
ixgbe: Fix an error handling path in 'ixgbe\_probe()'
[ Upstream commit dd2aefcd5e37989ae5f90afdae44bbbf3a2990da ]
If an error occurs after a 'pci\_enable\_pcie\_error\_reporting()' call, it
must be undone by a corresponding 'pci\_disable\_pcie\_error\_reporting()'
call, as already done in the remove function.
Fixes: 6fabd715e6d8 ("ixgbe: Implement PCIe AER support")
Signed-off-by: Christophe JAILLET
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 9d81d1be9f31afff9447a480473274192d6ef947
Author: Tom Rix
Date: Fri May 21 12:50:19 2021 -0700
igc: change default return of igc\_read\_phy\_reg()
[ Upstream commit 05682a0a61b6cbecd97a0f37f743b2cbfd516977 ]
Static analysis reports this problem
igc\_main.c:4944:20: warning: The left operand of '&'
is a garbage value
if (!(phy\_data & SR\_1000T\_REMOTE\_RX\_STATUS) &&
~~~~~~~~ ^
phy\_data is set by the call to igc\_read\_phy\_reg() only if
there is a read\_reg() op, else it is unset and a 0 is
returned. Change the return to -EOPNOTSUPP.
Fixes: 208983f099d9 ("igc: Add watchdog")
Signed-off-by: Tom Rix
Tested-by: Dvora Fuxbrumer
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 8e24c12f2ff6d32fd9f057382f08e748ec97194c
Author: Vinicius Costa Gomes
Date: Thu May 13 17:31:04 2021 -0700
igb: Fix use-after-free error during reset
[ Upstream commit 7b292608db23ccbbfbfa50cdb155d01725d7a52e ]
Cleans the next descriptor to watch (next\_to\_watch) when cleaning the
TX ring.
Failure to do so can cause invalid memory accesses. If igb\_poll() runs
while the controller is reset this can lead to the driver try to free
a skb that was already freed.
(The crash is harder to reproduce with the igb driver, but the same
potential problem exists as the code is identical to igc)
Fixes: 7cc6fd4c60f2 ("igb: Don't bother clearing Tx buffer\_info in igb\_clean\_tx\_ring")
Signed-off-by: Vinicius Costa Gomes
Reported-by: Erez Geva
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit ea5e36b7367ea0a36ef73a163768f16d2977bd83
Author: Vinicius Costa Gomes
Date: Thu May 13 17:31:03 2021 -0700
igc: Fix use-after-free error during reset
[ Upstream commit 56ea7ed103b46970e171eb1c95916f393d64eeff ]
Cleans the next descriptor to watch (next\_to\_watch) when cleaning the
TX ring.
Failure to do so can cause invalid memory accesses. If igc\_poll() runs
while the controller is being reset this can lead to the driver try to
free a skb that was already freed.
Log message:
[ 101.525242] refcount\_t: underflow; use-after-free.
[ 101.525251] WARNING: CPU: 1 PID: 646 at lib/refcount.c:28 refcount\_warn\_saturate+0xab/0xf0
[ 101.525259] Modules linked in: sch\_etf(E) sch\_mqprio(E) rfkill(E) intel\_rapl\_msr(E) intel\_rapl\_common(E)
x86\_pkg\_temp\_thermal(E) intel\_powerclamp(E) coretemp(E) binfmt\_misc(E) kvm\_intel(E) kvm(E) irqbypass(E) crc32\_pclmul(E)
ghash\_clmulni\_intel(E) aesni\_intel(E) mei\_wdt(E) libaes(E) crypto\_simd(E) cryptd(E) glue\_helper(E) snd\_hda\_codec\_hdmi(E)
rapl(E) intel\_cstate(E) snd\_hda\_intel(E) snd\_intel\_dspcfg(E) sg(E) soundwire\_intel(E) intel\_uncore(E) at24(E)
soundwire\_generic\_allocation(E) iTCO\_wdt(E) soundwire\_cadence(E) intel\_pmc\_bxt(E) serio\_raw(E) snd\_hda\_codec(E)
iTCO\_vendor\_support(E) watchdog(E) snd\_hda\_core(E) snd\_hwdep(E) snd\_soc\_core(E) snd\_compress(E) snd\_pcsp(E)
soundwire\_bus(E) snd\_pcm(E) evdev(E) snd\_timer(E) mei\_me(E) snd(E) soundcore(E) mei(E) configfs(E) ip\_tables(E) x\_tables(E)
autofs4(E) ext4(E) crc32c\_generic(E) crc16(E) mbcache(E) jbd2(E) sd\_mod(E) t10\_pi(E) crc\_t10dif(E) crct10dif\_generic(E)
i915(E) ahci(E) libahci(E) ehci\_pci(E) igb(E) xhci\_pci(E) ehci\_hcd(E)
[ 101.525303] drm\_kms\_helper(E) dca(E) xhci\_hcd(E) libata(E) crct10dif\_pclmul(E) cec(E) crct10dif\_common(E) tsn(E) igc(E)
e1000e(E) ptp(E) i2c\_i801(E) crc32c\_intel(E) psmouse(E) i2c\_algo\_bit(E) i2c\_smbus(E) scsi\_mod(E) lpc\_ich(E) pps\_core(E)
usbcore(E) drm(E) button(E) video(E)
[ 101.525318] CPU: 1 PID: 646 Comm: irq/37-enp7s0-T Tainted: G E 5.10.30-rt37-tsn1-rt-ipipe #ipipe
[ 101.525320] Hardware name: SIEMENS AG SIMATIC IPC427D/A5E31233588, BIOS V17.02.09 03/31/2017
[ 101.525322] RIP: 0010:refcount\_warn\_saturate+0xab/0xf0
[ 101.525325] Code: 05 31 48 44 01 01 e8 f0 c6 42 00 0f 0b c3 80 3d 1f 48 44 01 00 75 90 48 c7 c7 78 a8 f3 a6 c6 05 0f 48
44 01 01 e8 d1 c6 42 00 <0f> 0b c3 80 3d fe 47 44 01 00 0f 85 6d ff ff ff 48 c7 c7 d0 a8 f3
[ 101.525327] RSP: 0018:ffffbdedc0917cb8 EFLAGS: 00010286
[ 101.525329] RAX: 0000000000000000 RBX: ffff98fd6becbf40 RCX: 0000000000000001
[ 101.525330] RDX: 0000000000000001 RSI: ffffffffa6f2700c RDI: 00000000ffffffff
[ 101.525332] RBP: ffff98fd6becc14c R08: ffffffffa7463d00 R09: ffffbdedc0917c50
[ 101.525333] R10: ffffffffa74c3578 R11: 0000000000000034 R12: 00000000ffffff00
[ 101.525335] R13: ffff98fd6b0b1000 R14: 0000000000000039 R15: ffff98fd6be35c40
[ 101.525337] FS: 0000000000000000(0000) GS:ffff98fd6e240000(0000) knlGS:0000000000000000
[ 101.525339] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 101.525341] CR2: 00007f34135a3a70 CR3: 0000000150210003 CR4: 00000000001706e0
[ 101.525343] Call Trace:
[ 101.525346] sock\_wfree+0x9c/0xa0
[ 101.525353] unix\_destruct\_scm+0x7b/0xa0
[ 101.525358] skb\_release\_head\_state+0x40/0x90
[ 101.525362] skb\_release\_all+0xe/0x30
[ 101.525364] napi\_consume\_skb+0x57/0x160
[ 101.525367] igc\_poll+0xb7/0xc80 [igc]
[ 101.525376] ? sched\_clock+0x5/0x10
[ 101.525381] ? sched\_clock\_cpu+0xe/0x100
[ 101.525385] net\_rx\_action+0x14c/0x410
[ 101.525388] \_\_do\_softirq+0xe9/0x2f4
[ 101.525391] \_\_local\_bh\_enable\_ip+0xe3/0x110
[ 101.525395] ? irq\_finalize\_oneshot.part.47+0xe0/0xe0
[ 101.525398] irq\_forced\_thread\_fn+0x6a/0x80
[ 101.525401] irq\_thread+0xe8/0x180
[ 101.525403] ? wake\_threads\_waitq+0x30/0x30
[ 101.525406] ? irq\_thread\_check\_affinity+0xd0/0xd0
[ 101.525408] kthread+0x183/0x1a0
[ 101.525412] ? kthread\_park+0x80/0x80
[ 101.525415] ret\_from\_fork+0x22/0x30
Fixes: 13b5b7fd6a4a ("igc: Add support for Tx/Rx rings")
Reported-by: Erez Geva
Signed-off-by: Vinicius Costa Gomes
Tested-by: Dvora Fuxbrumer
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin


=== Content from github.com_e85b6678_20250115_094839.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fb5fdf5c6e6bee35837e160c00ac89327bdad031b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fb5fdf5c6e6bee35837e160c00ac89327bdad031b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/b5fdf5c6e6bee35837e160c00ac89327bdad031b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

usb: max-3421: Prevent corruption of freed memory

[Browse files](/torvalds/linux/tree/b5fdf5c6e6bee35837e160c00ac89327bdad031b)
Browse the repository at this point in the history

```
The MAX-3421 USB driver remembers the state of the USB toggles for a
device/endpoint. To save SPI writes, this was only done when a new
device/endpoint was being used. Unfortunately, if the old device was
removed, this would cause writes to freed memory.

To fix this, a simpler scheme is used. The toggles are read from
hardware when a URB is completed, and the toggles are always written to
hardware when any URB transaction is started. This will cause a few more
SPI transactions, but no causes kernel panics.

Fixes: [2d53139](https://github.com/torvalds/linux/commit/2d53139f31626bad6f8983d8e519ddde2cbba921) ("Add support for using a MAX3421E chip as a host driver.")
Cc: stable <stable@vger.kernel.org>
Signed-off-by: Mark Tomlinson <mark.tomlinson@alliedtelesis.co.nz>
Link: [https://lore.kernel.org/r/20210625031456.8632-1-mark.tomlinson@alliedtelesis.co.nz](https://lore.kernel.org/r/20210625031456.8632-1-mark.tomlinson%40alliedtelesis.co.nz)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
```

* Loading branch information

[![@gregkh](https://avatars.githubusercontent.com/u/14953?s=40&v=4)](/gregkh)

Mark Tomlinson
authored and
[gregkh](/torvalds/linux/commits?author=gregkh "View all commits by gregkh")
committed
Jul 21, 2021

1 parent
[5b01248](/torvalds/linux/commit/5b01248156bd75303e66985c351dee648c149979)

commit b5fdf5c

Showing
**1 changed file**
with
**14 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

44 changes: 14 additions & 30 deletions

44
[drivers/usb/host/max3421-hcd.c](#diff-4f49a09c256e5e47e0837295049ea9fe1a1e868098713b4f7161f76145e3cc04 "drivers/usb/host/max3421-hcd.c")

Show comments

[View file](/torvalds/linux/blob/b5fdf5c6e6bee35837e160c00ac89327bdad031b/drivers/usb/host/max3421-hcd.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -153,8 +153,6 @@ struct max3421\_hcd { |
|  |  | \*/ |
|  |  | struct urb \*curr\_urb; |
|  |  | enum scheduling\_pass sched\_pass; |
|  |  | struct usb\_device \*loaded\_dev; /\* dev that's loaded into the chip \*/ |
|  |  | int loaded\_epnum; /\* epnum whose toggles are loaded \*/ |
|  |  | int urb\_done; /\* > 0 -> no errors, < 0: errno \*/ |
|  |  | size\_t curr\_len; |
|  |  | u8 hien; |
| Expand Down  Expand Up | | @@ -492,47 +490,24 @@ max3421\_set\_speed(struct usb\_hcd \*hcd, struct usb\_device \*dev) |
|  |  | \* Caller must NOT hold HCD spinlock. |
|  |  | \*/ |
|  |  | static void |
|  |  | max3421\_set\_address(struct usb\_hcd \*hcd, struct usb\_device \*dev, int epnum, |
|  |  | int force\_toggles) |
|  |  | max3421\_set\_address(struct usb\_hcd \*hcd, struct usb\_device \*dev, int epnum) |
|  |  | { |
|  |  | struct max3421\_hcd \*max3421\_hcd = hcd\_to\_max3421(hcd); |
|  |  | int old\_epnum, same\_ep, rcvtog, sndtog; |
|  |  | struct usb\_device \*old\_dev; |
|  |  | int rcvtog, sndtog; |
|  |  | u8 hctl; |
|  |  |  |
|  |  | old\_dev = max3421\_hcd->loaded\_dev; |
|  |  | old\_epnum = max3421\_hcd->loaded\_epnum; |
|  |  |  |
|  |  | same\_ep = (dev == old\_dev && epnum == old\_epnum); |
|  |  | if (same\_ep && !force\_toggles) |
|  |  | return; |
|  |  |  |
|  |  | if (old\_dev && !same\_ep) { |
|  |  | /\* save the old end-points toggles: \*/ |
|  |  | u8 hrsl = spi\_rd8(hcd, MAX3421\_REG\_HRSL); |
|  |  |  |
|  |  | rcvtog = (hrsl >> MAX3421\_HRSL\_RCVTOGRD\_BIT) & 1; |
|  |  | sndtog = (hrsl >> MAX3421\_HRSL\_SNDTOGRD\_BIT) & 1; |
|  |  |  |
|  |  | /\* no locking: HCD (i.e., we) own toggles, don't we? \*/ |
|  |  | usb\_settoggle(old\_dev, old\_epnum, 0, rcvtog); |
|  |  | usb\_settoggle(old\_dev, old\_epnum, 1, sndtog); |
|  |  | } |
|  |  | /\* setup new endpoint's toggle bits: \*/ |
|  |  | rcvtog = usb\_gettoggle(dev, epnum, 0); |
|  |  | sndtog = usb\_gettoggle(dev, epnum, 1); |
|  |  | hctl = (BIT(rcvtog + MAX3421\_HCTL\_RCVTOG0\_BIT) | |
|  |  | BIT(sndtog + MAX3421\_HCTL\_SNDTOG0\_BIT)); |
|  |  |  |
|  |  | max3421\_hcd->loaded\_epnum = epnum; |
|  |  | spi\_wr8(hcd, MAX3421\_REG\_HCTL, hctl); |
|  |  |  |
|  |  | /\* |
|  |  | \* Note: devnum for one and the same device can change during |
|  |  | \* address-assignment so it's best to just always load the |
|  |  | \* address whenever the end-point changed/was forced. |
|  |  | \*/ |
|  |  | max3421\_hcd->loaded\_dev = dev; |
|  |  | spi\_wr8(hcd, MAX3421\_REG\_PERADDR, dev->devnum); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -667,7 +642,7 @@ max3421\_select\_and\_start\_urb(struct usb\_hcd \*hcd) |
|  |  | struct max3421\_hcd \*max3421\_hcd = hcd\_to\_max3421(hcd); |
|  |  | struct urb \*urb, \*curr\_urb = NULL; |
|  |  | struct max3421\_ep \*max3421\_ep; |
|  |  | int epnum, force\_toggles = 0; |
|  |  | int epnum; |
|  |  | struct usb\_host\_endpoint \*ep; |
|  |  | struct list\_head \*pos; |
|  |  | unsigned long flags; |
| Expand Down  Expand Up | | @@ -777,15 +752,14 @@ max3421\_select\_and\_start\_urb(struct usb\_hcd \*hcd) |
|  |  | usb\_settoggle(urb->dev, epnum, 0, 1); |
|  |  | usb\_settoggle(urb->dev, epnum, 1, 1); |
|  |  | max3421\_ep->pkt\_state = PKT\_STATE\_SETUP; |
|  |  | force\_toggles = 1; |
|  |  | } else |
|  |  | max3421\_ep->pkt\_state = PKT\_STATE\_TRANSFER; |
|  |  | } |
|  |  |  |
|  |  | spin\_unlock\_irqrestore(&max3421\_hcd->lock, flags); |
|  |  |  |
|  |  | max3421\_ep->last\_active = max3421\_hcd->frame\_number; |
|  |  | max3421\_set\_address(hcd, urb->dev, epnum, force\_toggles); |
|  |  | max3421\_set\_address(hcd, urb->dev, epnum); |
|  |  | max3421\_set\_speed(hcd, urb->dev); |
|  |  | max3421\_next\_transfer(hcd, 0); |
|  |  | return 1; |
| Expand Down  Expand Up | | @@ -1379,6 +1353,16 @@ max3421\_urb\_done(struct usb\_hcd \*hcd) |
|  |  | status = 0; |
|  |  | urb = max3421\_hcd->curr\_urb; |
|  |  | if (urb) { |
|  |  | /\* save the old end-points toggles: \*/ |
|  |  | u8 hrsl = spi\_rd8(hcd, MAX3421\_REG\_HRSL); |
|  |  | int rcvtog = (hrsl >> MAX3421\_HRSL\_RCVTOGRD\_BIT) & 1; |
|  |  | int sndtog = (hrsl >> MAX3421\_HRSL\_SNDTOGRD\_BIT) & 1; |
|  |  | int epnum = usb\_endpoint\_num(&urb->ep->desc); |
|  |  |  |
|  |  | /\* no locking: HCD (i.e., we) own toggles, don't we? \*/ |
|  |  | usb\_settoggle(urb->dev, epnum, 0, rcvtog); |
|  |  | usb\_settoggle(urb->dev, epnum, 1, sndtog); |
|  |  |  |
|  |  | max3421\_hcd->curr\_urb = NULL; |
|  |  | spin\_lock\_irqsave(&max3421\_hcd->lock, flags); |
|  |  | usb\_hcd\_unlink\_urb\_from\_ep(hcd, urb); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b5fdf5c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fb5fdf5c6e6bee35837e160c00ac89327bdad031b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


