=== Content from github.com_884520fa_20250114_221122.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-browser%2Fissues%2F13527)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-browser%2Fissues%2F13527)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=brave%2Fbrave-browser)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[brave](/brave)
/
**[brave-browser](/brave/brave-browser)**
Public

* [Notifications](/login?return_to=%2Fbrave%2Fbrave-browser) You must be signed in to change notification settings
* [Fork
  2.4k](/login?return_to=%2Fbrave%2Fbrave-browser)
* [Star
   18.3k](/login?return_to=%2Fbrave%2Fbrave-browser)

* [Code](/brave/brave-browser)
* [Issues
  5k+](/brave/brave-browser/issues)
* [Pull requests
  1](/brave/brave-browser/pulls)
* [Actions](/brave/brave-browser/actions)
* [Projects
  13](/brave/brave-browser/projects)
* [Wiki](/brave/brave-browser/wiki)
* [Security](/brave/brave-browser/security)
* [Insights](/brave/brave-browser/pulse)

Additional navigation options

* [Code](/brave/brave-browser)
* [Issues](/brave/brave-browser/issues)
* [Pull requests](/brave/brave-browser/pulls)
* [Actions](/brave/brave-browser/actions)
* [Projects](/brave/brave-browser/projects)
* [Wiki](/brave/brave-browser/wiki)
* [Security](/brave/brave-browser/security)
* [Insights](/brave/brave-browser/pulse)

# [hackerone] Tor DNS issue¬†#13527

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosed[brave/brave-core#7769](https://github.com/brave/brave-core/pull/7769)brave/brave-core#7769Closed[[hackerone] Tor DNS issue](#top)#13527[brave/brave-core#7769](https://github.com/brave/brave-core/pull/7769)Copy linkAssignees [![diracdeltas](https://avatars.githubusercontent.com/u/549654?s=64&u=04bd895abbafff00171f2d25819df51d6e7fe621&v=4)](/diracdeltas)[![darkdh](https://avatars.githubusercontent.com/u/11330831?s=64&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)Labels[OS/Desktop](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22OS%2FDesktop%22)[QA Pass-Win64](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%20Pass-Win64%22)[QA Pass-macOS](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%20Pass-macOS%22)[QA/Test-Plan-Specified](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%2FTest-Plan-Specified%22)[QA/Yes](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%2FYes%22)[release-notes/include](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22release-notes%2Finclude%22)[security](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22security%22)Milestone[1.20.x - Release #2](https://github.com/brave/brave-browser/milestone/173)![@diracdeltas](https://avatars.githubusercontent.com/u/549654?u=04bd895abbafff00171f2d25819df51d6e7fe621&v=4&size=80)
## Description

![@diracdeltas](https://avatars.githubusercontent.com/u/549654?u=04bd895abbafff00171f2d25819df51d6e7fe621&v=4&size=48)[diracdeltas](https://github.com/diracdeltas)opened [on Jan 12, 2021](https://github.com/brave/brave-browser/issues/13527#issue-784678328)

<https://hackerone.com/reports/1077022>

~~related: [#4257](https://github.com/brave/brave-browser/issues/4257). it appears this was a known issue at least in the muon days. unclear if it was ever fixed in brave-core.~~

UPDATE: cause was cname adblocking, so this is a regression, not an earlier issue.

## Metadata

### Assignees

* [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=64&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)darkdh](/darkdh)
* [![@diracdeltas](https://avatars.githubusercontent.com/u/549654?s=64&u=04bd895abbafff00171f2d25819df51d6e7fe621&v=4)diracdeltas](/diracdeltas)
### Labels

[OS/Desktop](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22OS%2FDesktop%22)[QA Pass-Win64](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%20Pass-Win64%22)[QA Pass-macOS](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%20Pass-macOS%22)[QA/Test-Plan-Specified](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%2FTest-Plan-Specified%22)[QA/Yes](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22QA%2FYes%22)[release-notes/include](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22release-notes%2Finclude%22)[security](https://github.com/brave/brave-browser/issues?q=state%3Aopen%20label%3A%22security%22)
### Type

No type
### Projects

No projects
### Milestone

* [1.20.x - Release #2](https://github.com/brave/brave-browser/milestone/173)
### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_863f52de_20250114_221127.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-core%2Fpull%2F7769)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-core%2Fpull%2F7769)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=brave%2Fbrave-core)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[brave](/brave)
/
**[brave-core](/brave/brave-core)**
Public

* [Notifications](/login?return_to=%2Fbrave%2Fbrave-core) You must be signed in to change notification settings
* [Fork
  895](/login?return_to=%2Fbrave%2Fbrave-core)
* [Star
   2.5k](/login?return_to=%2Fbrave%2Fbrave-core)

* [Code](/brave/brave-core)
* [Pull requests
  231](/brave/brave-core/pulls)
* [Actions](/brave/brave-core/actions)
* [Security](/brave/brave-core/security)
* [Insights](/brave/brave-core/pulse)

Additional navigation options

* [Code](/brave/brave-core)
* [Pull requests](/brave/brave-core/pulls)
* [Actions](/brave/brave-core/actions)
* [Security](/brave/brave-core/security)
* [Insights](/brave/brave-core/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fbrave%2Fbrave-core%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fbrave%2Fbrave-core%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fix Tor dns leak #7769

 Merged

[darkdh](/darkdh)
merged 4 commits into
[master](/brave/brave-core/tree/master "brave/brave-core:master")
from
[tor-dns-leak](/brave/brave-core/tree/tor-dns-leak "brave/brave-core:tor-dns-leak")

Feb 4, 2021

 Merged

# [Fix Tor dns leak](#top) #7769

[darkdh](/darkdh)
merged 4 commits into
[master](/brave/brave-core/tree/master "brave/brave-core:master")
from
[tor-dns-leak](/brave/brave-core/tree/tor-dns-leak "brave/brave-core:tor-dns-leak")

Feb 4, 2021

[Conversation
20](/brave/brave-core/pull/7769)
[Commits
4](/brave/brave-core/pull/7769/commits)
[Checks
0](/brave/brave-core/pull/7769/checks)
[Files changed](/brave/brave-core/pull/7769/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![darkdh](https://avatars.githubusercontent.com/u/11330831?s=60&v=4)](/darkdh)

Copy link

Member

### @darkdh **[darkdh](/darkdh)** commented [Feb 2, 2021](#issue-798831617) ‚Ä¢ edited Loading

Resolves [brave/brave-browser#13527](https://github.com/brave/brave-browser/issues/13527)

This PR

Disable CNAME adblock for Tor to prevent it from sending DoH or standard DNS query which will not be routed through Tor

~~1. Fixes DoH requests should respect proxy config, matching the behavior as Firefox, so that DoH requests will route through Tor

2. Enforce DoH for DNS queries sent by CNAME adblock because users can turn DoH off and we currently don't have a way to route insecure DNS lookup through Tor(proxy config). We can consider implementing `Proxy DNS when using SOCKS v5`(network.proxy.socks\_remote\_dns) that Firefox has so we don't have to enforce DoH for this

3. Skip CNAME adblock DNS lookup if DoH mode is not secure or DoH server list is empty~~

## Submitter Checklist:

* There is a [ticket](https://github.com/brave/brave-browser/issues) for my issue.
* Used Github [auto-closing keywords](https://help.github.com/articles/closing-issues-via-commit-messages/) in the commit message.
* Wrote a good [PR/commit description](https://google.github.io/eng-practices/review/developer/cl-descriptions.html)
* Added appropriate labels (`QA/Yes` or `QA/No`; `release-notes/include` or `release-notes/exclude`; `OS/...`) to the associated issue
* Checked the PR locally: `npm run test -- brave_browser_tests`, `npm run test -- brave_unit_tests`, `npm run lint`, `npm run gn_check`, `npm run tslint`
* Ran `git rebase master` (if needed).
* Requested a security/privacy review as needed.

## Reviewer Checklist:

* New files have MPL-2.0 license header.
* Adequate test coverage exists to prevent regressions
* Major classes, functions and non-trivial code blocks are well-commented
* Changes in component dependencies are properly reflected in `gn`
* Code follows the [style guide](https://chromium.googlesource.com/chromium/src/%2B/HEAD/styleguide/c%2B%2B/c%2B%2B.md)
* Test plan is specified in PR before merging

## After-merge Checklist:

* The associated issue milestone is set to the smallest version that the

  changes has landed on.
* All relevant documentation has been updated, for instance:
  + [https://github.com/brave/brave-browser/wiki/Deviations-from-Chromium-(features-we-disable-or-remove)](https://github.com/brave/brave-browser/wiki/Deviations-from-Chromium-%28features-we-disable-or-remove%29)
  + <https://github.com/brave/brave-browser/wiki/Proxy-redirected-URLs>
  + <https://github.com/brave/brave-browser/wiki/Fingerprinting-Protections>
  + <https://github.com/brave/brave-browser/wiki/Brave%E2%80%99s-Use-of-Referral-Codes>
  + <https://github.com/brave/brave-browser/wiki/Custom-Headers>
  + <https://github.com/brave/brave-browser/wiki/Web-Compatibility-Exceptions-in-Brave>
  + <https://github.com/brave/brave-browser/wiki/QA-Guide>
  + <https://github.com/brave/brave-browser/wiki/P3A>

## Test Plan:

### DoH off

1. Follow the section `Using the (Pre)-Master-Secret` to setup `SSLKEYLOGFILE`

   <https://wiki.wireshark.org/TLS>
2. After Wireshark is capturing traffic, use the `dns` filter
3. Launch Brave
4. Go to brave://settings/security and turn off `Use secure DNS`
5. Open Tor window
6. Navigate to <https://tools.ietf.org/>
7. After site loaded, stop Wireshark capturing
8. There shouldn't be any DNS query or DoH query for `tools.ietf.org`

### DoH enabled

1. Follow the section `Using the (Pre)-Master-Secret` to setup `SSLKEYLOGFILE`

   <https://wiki.wireshark.org/TLS>
2. After Wireshark is capturing traffic, use the `dns` filter
3. Launch Brave
4. Go to brave://settings/security and make sure `Use secure DNS` is on and use custom Cloudflare resolver
5. Open Tor window
6. Navigate to <https://tools.ietf.org/>
7. After site loaded, stop Wireshark capturing
8. There shouldn't be any DNS query or DoH query for `tools.ietf.org`

Sorry, something went wrong.

 üëç
1
 ariebrainware reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
requested review from
[fmarier](/fmarier),
[diracdeltas](/diracdeltas),
[bbondy](/bbondy),
[iefremov](/iefremov) and
[antonok-edm](/antonok-edm)
[February 2, 2021 00:57](#event-4276658695)

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
requested a review
from a team
as a [code owner](/brave/brave-core/blob/0118ba5cb1a5f4fb937d3c1b1e305343e3282d4a/.github/CODEOWNERS#L1)
[February 2, 2021 00:57](#event-4276658723)

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
self-assigned this
[Feb 2, 2021](#event-4276658727)

[![darkdh](https://avatars.githubusercontent.com/u/11330831?s=60&v=4)](/darkdh)

**[darkdh](/darkdh)**
commented
[Feb 2, 2021](#pullrequestreview-580901154)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper.cc](/brave/brave-core/pull/7769/files#diff-0986ef9872f15c706dc15f78ee8ef549348a10918b13d126e4483261d7171853)
Outdated

|  |  | @@ -148,13 +161,35 @@ class AdblockCnameResolveHostClient : public network::mojom::ResolveHostClient { | |
| --- | --- | --- | --- |
|  |  | // See https://crbug.com/872665 |
|  |  | optional\_parameters->source = net::HostResolverSource::DNS; |

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 2, 2021](#discussion_r568249163)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

`ResolveHostParameters::secure_dns_mode_override` for `SECURE` mode is useless without specifying doh\_server.

So we have to do it through `DnsConfigOverrides`

Sorry, something went wrong.

All reactions

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
[force-pushed](/brave/brave-core/compare/143b511a0f1801952a25f5af512c303bc7d59098..16a7c2427139d502149b8b281e692b0d30e46daf)
the
tor-dns-leak

branch
from
[`143b511`](/brave/brave-core/commit/143b511a0f1801952a25f5af512c303bc7d59098) to
[`16a7c24`](/brave/brave-core/commit/16a7c2427139d502149b8b281e692b0d30e46daf)  [Compare](/brave/brave-core/compare/143b511a0f1801952a25f5af512c303bc7d59098..16a7c2427139d502149b8b281e692b0d30e46daf)
[February 2, 2021 01:08](#event-4276682319)

[![antonok-edm](https://avatars.githubusercontent.com/u/22821309?s=60&v=4)](/antonok-edm)

**[antonok-edm](/antonok-edm)**
approved these changes
[Feb 2, 2021](#pullrequestreview-580957048)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper.cc](/brave/brave-core/pull/7769/files#diff-0986ef9872f15c706dc15f78ee8ef549348a10918b13d126e4483261d7171853)
Outdated

Comment on lines
166
 to
169

|  |  | // Enforce DoH for Tor |
| --- | --- | --- |
|  |  | // TODO(darkdh): we can consider implementing |
|  |  | // "Proxy DNS when using SOCKS v5" (network.proxy.socks\_remote\_dns) |
|  |  | // like Firefox has so that we don't have to enforce DoH |

Copy link

Collaborator

### @antonok-edm **[antonok-edm](/antonok-edm)** [Feb 2, 2021](#discussion_r568297728)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Just a heads up about [brave/brave-browser#13414](https://github.com/brave/brave-browser/issues/13414) - we should be able to remove most of this machinery once we rebase onto CR89, so I'd recommend keeping the fixes here as minimal as possible!

Sorry, something went wrong.

All reactions

Copy link

Collaborator

### @bridiver **[bridiver](/bridiver)** [Feb 3, 2021](#discussion_r569025751)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It seems like we should be setting this stuff when the Tor connection is created because presumably we need to always use it? Not just for this?

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 3, 2021](#discussion_r569041877)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Normally, when we are in Tor window, we don't need to send ANY dns queries. We route all the HTTP/HTTPS traffic to tor proxy without knowing the IP, that means we just send hostname to proxy and the Tor exit node will do the resolving.

Sorry, something went wrong.

All reactions

[![diracdeltas](https://avatars.githubusercontent.com/u/549654?s=60&v=4)](/diracdeltas)

**[diracdeltas](/diracdeltas)**
requested changes
[Feb 2, 2021](#pullrequestreview-581805906)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

Copy link

Member

### @diracdeltas **[diracdeltas](/diracdeltas)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

this is great but i don't think we should enable DoH for users who haven't picked a DoH provider, because IIUC they need to consent to the provider's terms of service. for users who haven't picked a DoH provider, can we just disable cname adblocking for them in Tor mode?

Sorry, something went wrong.

All reactions

[![bridiver](https://avatars.githubusercontent.com/u/34129?s=60&v=4)](/bridiver)

**[bridiver](/bridiver)**
reviewed
[Feb 3, 2021](#pullrequestreview-581888386)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[patches/net-dns-dns\_transaction.cc.patch](/brave/brave-core/pull/7769/files#diff-d65a819d8a2d366303a61d3447c5ddd5610cde62bce2c09019fc45e84cd8b7cf)
Outdated

|  |  | request\_->SetExtraRequestHeaders(extra\_request\_headers); |
| --- | --- | --- |
|  |  | // Disable secure DNS for any DoH server hostname lookups to avoid deadlock. |
|  |  | request\_->SetDisableSecureDns(true); |
|  |  | - request\_->SetLoadFlags(request\_->load\_flags() | LOAD\_DISABLE\_CACHE | |

Copy link

Collaborator

### @bridiver **[bridiver](/bridiver)** [Feb 3, 2021](#discussion_r569024813)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I think you can avoid this patch by defining `LOAD_BYPASS_PROXY` as `LOAD_DISABLE_CACHE`. If that doesn't work for some reason you should use a define/chromium\_src override after the original call instead of changing it to minimize the patch

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 3, 2021](#discussion_r569063186)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

fixed

Sorry, something went wrong.

All reactions

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
[force-pushed](/brave/brave-core/compare/1f1759b9fffe451ded95fa815906df45e64a5c24..b5bf0de5a609310dbaaabcf935a69c03275b98af)
the
tor-dns-leak

branch
from
[`1f1759b`](/brave/brave-core/commit/1f1759b9fffe451ded95fa815906df45e64a5c24) to
[`b5bf0de`](/brave/brave-core/commit/b5bf0de5a609310dbaaabcf935a69c03275b98af)  [Compare](/brave/brave-core/compare/1f1759b9fffe451ded95fa815906df45e64a5c24..b5bf0de5a609310dbaaabcf935a69c03275b98af)
[February 3, 2021 01:42](#event-4282639018)

[![iefremov](https://avatars.githubusercontent.com/u/3109556?s=60&v=4)](/iefremov)

**[iefremov](/iefremov)**
reviewed
[Feb 3, 2021](#pullrequestreview-582332836)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper\_unittest.cc](/brave/brave-core/pull/7769/files#diff-0d36a577389555a2192eb92ed7407242283269f3483197bffdaef05d1b9ddde6)
Outdated

|  |  | auto request\_info = std::make\_shared<brave::BraveRequestInfo>(GURL()); |
| --- | --- | --- |
|  |  | int rc = |
|  |  | OnBeforeURLRequest\_AdBlockTPPreWork(ResponseCallback(), request\_info); |
|  |  | EXPECT\_TRUE(request\_info->new\_url\_spec.empty()); |
|  |  | EXPECT\_EQ(rc, net::OK); |
|  |  | } |
|  |  |  |
|  |  | TEST\_F(BraveAdBlockTPNetworkDelegateHelperTest, ByassTor) { |

Copy link

Contributor

### @iefremov **[iefremov](/iefremov)** [Feb 3, 2021](#discussion_r569391026)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

ByPassTor

Sorry, something went wrong.

All reactions

Copy link

Collaborator

### @bridiver **[bridiver](/bridiver)** [Feb 3, 2021](#discussion_r569654043)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

actually I think this is a bad name because it makes it sound like it should be bypassing Tor and that's exactly the opposite of what we are doing. Maybe something like DisableInsecureRequestsOverTor

Sorry, something went wrong.

 üòÑ
1
 BitesizedLion reacted with laugh emoji

All reactions

* üòÑ
  1 reaction

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 3, 2021](#discussion_r569706502)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

fixed

Sorry, something went wrong.

All reactions

[![iefremov](https://avatars.githubusercontent.com/u/3109556?s=60&v=4)](/iefremov)

**[iefremov](/iefremov)**
reviewed
[Feb 3, 2021](#pullrequestreview-582334514)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper\_unittest.cc](/brave/brave-core/pull/7769/files#diff-0d36a577389555a2192eb92ed7407242283269f3483197bffdaef05d1b9ddde6)
Outdated

|  |  | }; |
| --- | --- | --- |
|  |  | } // namespace |
|  |  |  |
|  |  | class BraveAdBlockTPNetworkDelegateHelperTest : public testing::Test { |

Copy link

Contributor

### @iefremov **[iefremov](/iefremov)** [Feb 3, 2021](#discussion_r569392344)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

this fixture is not related to existing tests, so you could leave them as is and give the test class more relevant name

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 3, 2021](#discussion_r569706547)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

fixed

Sorry, something went wrong.

All reactions

[![iefremov](https://avatars.githubusercontent.com/u/3109556?s=60&v=4)](/iefremov)

**[iefremov](/iefremov)**
reviewed
[Feb 3, 2021](#pullrequestreview-582351301)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[chromium\_src/net/dns/dns\_transaction.cc](/brave/brave-core/pull/7769/files#diff-3ce0a287b7804c3416893f38bed22d098d3c8756b659ca5915ca088bb674434e)
Outdated

|  |  |  |
| --- | --- | --- |
|  |  | #include "net/base/load\_flags.h" |
|  |  |  |
|  |  | #define LOAD\_BYPASS\_PROXY LOAD\_DISABLE\_CACHE |

Copy link

Contributor

### @iefremov **[iefremov](/iefremov)** [Feb 3, 2021](#discussion_r569404954)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I really don't think we should do this for all requests. I checked git history around this code ([https://chromium-review.googlesource.com/c/chromium/src/+/1843334/10/net/dns/dns\_transaction.cc](https://chromium-review.googlesource.com/c/chromium/src/%2B/1843334/10/net/dns/dns_transaction.cc)), and the authors say LOAD\_BYPASS\_PROXY is here to prevent deadlocks.

So we should either try upstreaming this or limit to tor-related requests

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 3, 2021](#discussion_r569588975) ‚Ä¢ edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

That is for `SetDisableSecureDns` ([https://chromium-review.googlesource.com/c/chromium/src/+/1843332/5/net/dns/dns\_transaction.cc](https://chromium-review.googlesource.com/c/chromium/src/%2B/1843332/5/net/dns/dns_transaction.cc))

It's been there since the first DoH commit

[https://chromium-review.googlesource.com/c/chromium/src/+/710554/40/net/dns/dns\_transaction.cc#431](https://chromium-review.googlesource.com/c/chromium/src/%2B/710554/40/net/dns/dns_transaction.cc#431)

Sorry, something went wrong.

All reactions

Copy link

Collaborator

### @bridiver **[bridiver](/bridiver)** [Feb 3, 2021](#discussion_r569656213)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

yea, I actually can't really imagine why we'd ever want to bypass the proxy for DoH requests. That seems like it would actually prevent requests from working at all if the proxy was required for access and non-proxy requests are blocked by firewall

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 3, 2021](#discussion_r569786887)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

There is a discussion with upstream net dev

<https://groups.google.com/u/1/a/chromium.org/g/net-dev/c/GI4E9ERwPgw>

Sorry, something went wrong.

All reactions

 [![@diracdeltas](https://avatars.githubusercontent.com/u/549654?s=40&u=04bd895abbafff00171f2d25819df51d6e7fe621&v=4)](/diracdeltas)
[diracdeltas](/diracdeltas)
self-requested a review
[February 3, 2021 18:55](#event-4286982477)

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
[force-pushed](/brave/brave-core/compare/dbb13b2044af84712f52ea6330f4d61a2249c624..689261a55a1cf026206ae797ccfddca1da22bfd1)
the
tor-dns-leak

branch
2 times, most recently
from
[`dbb13b2`](/brave/brave-core/commit/dbb13b2044af84712f52ea6330f4d61a2249c624) to
[`689261a`](/brave/brave-core/commit/689261a55a1cf026206ae797ccfddca1da22bfd1)  [Compare](/brave/brave-core/compare/dbb13b2044af84712f52ea6330f4d61a2249c624..689261a55a1cf026206ae797ccfddca1da22bfd1)
[February 3, 2021 22:16](#event-4287820680)

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=80&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)

Copy link

Member

Author

### **[darkdh](/darkdh)** commented [Feb 3, 2021](#issuecomment-772868729)

| per discussion on slack with [@bridiver](https://github.com/bridiver) and [@iefremov](https://github.com/iefremov), we came to a conclusion that disabling CNAME adblock for Tor would be best option now. Considering in order to make DoH route through Tor, we need to remove `LOAD_BYPASS_PROXY` for dns transaction but it might introduce dns and proxy code looping when we need to resolve proxy name. see (<https://groups.google.com/u/1/a/chromium.org/g/net-dev/c/GI4E9ERwPgw>) So if we want to route DoH through Tor, we need fine grained solution for it and also need a bigger discussion about this with privacy and security |
| --- |

 üëç
2
 diracdeltas and antonok-edm reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

Sorry, something went wrong.

[![@fmarier](https://avatars.githubusercontent.com/u/167821?s=80&u=836283846d232d3d0be00ac58f9e0025d7a35335&v=4)](/fmarier)

Copy link

Member

### **[fmarier](/fmarier)** commented [Feb 3, 2021](#issuecomment-772884875)

| we came to a conclusion that disabling CNAME adblock for Tor would be best option now. Considering in order to make DoH route through Tor, we need to remove LOAD\_BYPASS\_PROXY for dns transaction but it might introduce dns and proxy code looping when we need to resolve proxy name.  Sounds like a good compromise to me. |
| --- |

All reactions

Sorry, something went wrong.

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
requested review from
[iefremov](/iefremov) and
[bridiver](/bridiver)
[February 4, 2021 02:53](#event-4288586236)

[![iefremov](https://avatars.githubusercontent.com/u/3109556?s=60&v=4)](/iefremov)

**[iefremov](/iefremov)**
reviewed
[Feb 4, 2021](#pullrequestreview-583192106)

 [View reviewed changes](/brave/brave-core/pull/7769/files)

[browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper.cc](/brave/brave-core/pull/7769/files#diff-0986ef9872f15c706dc15f78ee8ef549348a10918b13d126e4483261d7171853)
Outdated

|  |  | // DoH or standard DNS quries won't be routed through Tor, so we need to skip |
| --- | --- | --- |
|  |  | // it. |
|  |  | if (ctx->browser\_context->IsTor()) { |
|  |  | return net::OK; |

Copy link

Contributor

### @iefremov **[iefremov](/iefremov)** [Feb 4, 2021](#discussion_r570071589)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This is going to disable adblocker in tor windows. What we need to do here is an adblocking pass without CNAME resolving, e.g. we can directly call `ShouldBlockAdWithOptionalCname` with empty CNAME

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @darkdh **[darkdh](/darkdh)** [Feb 4, 2021](#discussion_r570452017)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

fixed

Sorry, something went wrong.

All reactions

 [darkdh](/darkdh)
added 4 commits
[February 4, 2021 10:29](#commits-pushed-5e099e8)

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&v=4)](/darkdh)

`[DoH requests should respect proxy config](/brave/brave-core/pull/7769/commits/5e099e88e02907d4553adf4eb04590113f703233 "DoH requests should respect proxy config
Tested on Firefox: When DoH is enabled, the requests will route through
proxy")`
 ‚Ä¶

`[5e099e8](/brave/brave-core/pull/7769/commits/5e099e88e02907d4553adf4eb04590113f703233)`

```
Tested on Firefox: When DoH is enabled, the requests will route through
proxy
```

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&v=4)](/darkdh)

`[Enforce DoH for the CNAME adblock DNS query for Tor context](/brave/brave-core/pull/7769/commits/745570427b6e49e9764eb34156300abbc24efb31 "Enforce DoH for the CNAME adblock DNS query for Tor context
because we currently have no better way to route insecure DNS query
through proxy like \"Proxy DNS when using SOCKS v5\"
(network.proxy.socks_remote_dns) that Firefox has")`
 ‚Ä¶

`[7455704](/brave/brave-core/pull/7769/commits/745570427b6e49e9764eb34156300abbc24efb31)`

```
because we currently have no better way to route insecure DNS query
through proxy like "Proxy DNS when using SOCKS v5"
(network.proxy.socks_remote_dns) that Firefox has
```

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&v=4)](/darkdh)

`[Bypass CNAME adblocking for Tor when DoH is not enabled by users](/brave/brave-core/pull/7769/commits/47118d97c8561bd455da9ff72f4cb42cdac6be03 "Bypass CNAME adblocking for Tor when DoH is not enabled by users")`

`[47118d9](/brave/brave-core/pull/7769/commits/47118d97c8561bd455da9ff72f4cb42cdac6be03)`

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&v=4)](/darkdh)

`[Disable CNAME adblock for Tor](/brave/brave-core/pull/7769/commits/a148c43124434ca5440c9fef1a99b9b712c966a0 "Disable CNAME adblock for Tor")`

`[a148c43](/brave/brave-core/pull/7769/commits/a148c43124434ca5440c9fef1a99b9b712c966a0)`

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
[force-pushed](/brave/brave-core/compare/689261a55a1cf026206ae797ccfddca1da22bfd1..a148c43124434ca5440c9fef1a99b9b712c966a0)
the
tor-dns-leak

branch
from
[`689261a`](/brave/brave-core/commit/689261a55a1cf026206ae797ccfddca1da22bfd1) to
[`a148c43`](/brave/brave-core/commit/a148c43124434ca5440c9fef1a99b9b712c966a0)  [Compare](/brave/brave-core/compare/689261a55a1cf026206ae797ccfddca1da22bfd1..a148c43124434ca5440c9fef1a99b9b712c966a0)
[February 4, 2021 18:30](#event-4292407709)

[![iefremov](https://avatars.githubusercontent.com/u/3109556?s=60&v=4)](/iefremov)

**[iefremov](/iefremov)**
approved these changes
[Feb 4, 2021](#pullrequestreview-583697261)

 [View reviewed changes](/brave/brave-core/pull/7769/files/a148c43124434ca5440c9fef1a99b9b712c966a0)

[![diracdeltas](https://avatars.githubusercontent.com/u/549654?s=60&v=4)](/diracdeltas)

**[diracdeltas](/diracdeltas)**
approved these changes
[Feb 4, 2021](#pullrequestreview-583700786)

 [View reviewed changes](/brave/brave-core/pull/7769/files/a148c43124434ca5440c9fef1a99b9b712c966a0)

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
merged commit [`12fe321`](/brave/brave-core/commit/12fe321eaad8acc1cbd1d70b4128f687777bcf15)
into
master

[Feb 4, 2021](https://github.com/brave/brave-core/pull/7769#event-4293146344)

 [![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
deleted the
tor-dns-leak

branch
[February 4, 2021 21:32](#event-4293146442)

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&u=ccee39a2bf1b616b9adf193892570e73214e37f8&v=4)](/darkdh)
[darkdh](/darkdh)
added this to the [1.22.x - Nightly](/brave/brave-core/milestone/120) milestone
[Feb 4, 2021](#event-4293146809)

[brave-builds](/brave-builds)
pushed a commit
that referenced
this pull request
[Feb 10, 2021](#ref-commit-91e9db5)
[![@brave-browser-releases](https://avatars.githubusercontent.com/u/39539223?s=40&u=f213f82c027815991ef5ad42ae0fdb49e80e22c3&v=4)](/brave-browser-releases)

`[Uplift of](/brave/brave-core/commit/91e9db544d33b95a60fcdeb8691d9989d0b49295 "Uplift of #7769 (squashed) to beta") [#7769](https://github.com/brave/brave-core/pull/7769) [(squashed) to beta](/brave/brave-core/commit/91e9db544d33b95a60fcdeb8691d9989d0b49295 "Uplift of #7769 (squashed) to beta")`

`[91e9db5](/brave/brave-core/commit/91e9db544d33b95a60fcdeb8691d9989d0b49295)`

[![@brave-builds](https://avatars.githubusercontent.com/u/45370463?s=40&u=3be836715d815c35a07da7aa894253ba5ea126bf&v=4)](/brave-builds)
[brave-builds](/brave-builds)
mentioned this pull request
[Feb 10, 2021](#ref-pullrequest-805162710)

[Fix Tor dns leak (uplift to 1.21.x)
#7909](/brave/brave-core/pull/7909)
 Merged

7 tasks

[![@bbondy](https://avatars.githubusercontent.com/u/831718?s=40&v=4)](/bbondy)
[bbondy](/bbondy)
mentioned this pull request
[Feb 19, 2021](#ref-pullrequest-812143847)

[Specify resolver source to avoid using system resolver for CNAME adblocking (uplift to 1.20.x)
#8010](/brave/brave-core/pull/8010)
 Merged

7 tasks

[![@stephendonner](https://avatars.githubusercontent.com/u/387249?s=40&v=4)](/stephendonner)
[stephendonner](/stephendonner)
mentioned this pull request
[Feb 19, 2021](#ref-issue-784678328)

[[hackerone] Tor DNS issue
brave/brave-browser#13527](/brave/brave-browser/issues/13527)

Closed

[![@antonok-edm](https://avatars.githubusercontent.com/u/22821309?s=40&v=4)](/antonok-edm)
[antonok-edm](/antonok-edm)
mentioned this pull request
[May 4, 2021](#ref-pullrequest-875746321)

[Only check CNAME for unblocked requests
#8704](/brave/brave-core/pull/8704)
 Merged

24 tasks

[![@antonok-edm](https://avatars.githubusercontent.com/u/22821309?s=40&v=4)](/antonok-edm)
[antonok-edm](/antonok-edm)
mentioned this pull request
[Jul 28, 2022](#ref-pullrequest-1321476760)

[Expand CNAME uncloaking protection
#14392](/brave/brave-core/pull/14392)
 Closed

25 tasks

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-core%2Fpull%2F7769)

Reviewers

[![@antonok-edm](https://avatars.githubusercontent.com/u/22821309?s=40&v=4)](/antonok-edm) [antonok-edm](/antonok-edm)

antonok-edm approved these changes

[![@iefremov](https://avatars.githubusercontent.com/u/3109556?s=40&v=4)](/iefremov) [iefremov](/iefremov)

iefremov approved these changes

[![@diracdeltas](https://avatars.githubusercontent.com/u/549654?s=40&v=4)](/diracdeltas) [diracdeltas](/diracdeltas)

diracdeltas approved these changes

[![@fmarier](https://avatars.githubusercontent.com/u/167821?s=40&v=4)](/fmarier) [fmarier](/fmarier)

 Awaiting requested review from fmarier

[![@bbondy](https://avatars.githubusercontent.com/u/831718?s=40&v=4)](/bbondy) [bbondy](/bbondy)

 Awaiting requested review from bbondy

[![@bridiver](https://avatars.githubusercontent.com/u/34129?s=40&v=4)](/bridiver) [bridiver](/bridiver)

 Awaiting requested review from bridiver

Assignees

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&v=4)](/darkdh) [darkdh](/darkdh)

Labels

None yet

Projects

None yet

Milestone

 [**1.22.x - Release**](/brave/brave-core/milestone/120 "1.22.x - Release")

Development

Successfully merging this pull request may close these issues.

 [[hackerone] Tor DNS issue](https://github.com/brave/brave-browser/issues/13527)

6 participants

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=52&v=4)](/darkdh) [![@fmarier](https://avatars.githubusercontent.com/u/167821?s=52&v=4)](/fmarier) [![@bridiver](https://avatars.githubusercontent.com/u/34129?s=52&v=4)](/bridiver) [![@diracdeltas](https://avatars.githubusercontent.com/u/549654?s=52&v=4)](/diracdeltas) [![@iefremov](https://avatars.githubusercontent.com/u/3109556?s=52&v=4)](/iefremov) [![@antonok-edm](https://avatars.githubusercontent.com/u/22821309?s=52&v=4)](/antonok-edm)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_268b17d1_20250114_221123.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-browser%2Fsecurity%2Fadvisories%2FGHSA-mqjf-9x5g-2rv6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-browser%2Fsecurity%2Fadvisories%2FGHSA-mqjf-9x5g-2rv6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=brave%2Fbrave-browser)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[brave](/brave)
/
**[brave-browser](/brave/brave-browser)**
Public

* [Notifications](/login?return_to=%2Fbrave%2Fbrave-browser) You must be signed in to change notification settings
* [Fork
  2.4k](/login?return_to=%2Fbrave%2Fbrave-browser)
* [Star
   18.3k](/login?return_to=%2Fbrave%2Fbrave-browser)

* [Code](/brave/brave-browser)
* [Issues
  5k+](/brave/brave-browser/issues)
* [Pull requests
  1](/brave/brave-browser/pulls)
* [Actions](/brave/brave-browser/actions)
* [Projects
  13](/brave/brave-browser/projects)
* [Wiki](/brave/brave-browser/wiki)
* [Security](/brave/brave-browser/security)
* [Insights](/brave/brave-browser/pulse)

Additional navigation options

* [Code](/brave/brave-browser)
* [Issues](/brave/brave-browser/issues)
* [Pull requests](/brave/brave-browser/pulls)
* [Actions](/brave/brave-browser/actions)
* [Projects](/brave/brave-browser/projects)
* [Wiki](/brave/brave-browser/wiki)
* [Security](/brave/brave-browser/security)
* [Insights](/brave/brave-browser/pulse)

# Regression in DNS leakage from Tor windows

High

[diracdeltas](/diracdeltas)
published
GHSA-mqjf-9x5g-2rv6
Feb 20, 2021

## Package

Brave Browser Desktop

## Affected versions

1.17.73-1.20.103

## Patched versions

1.20.108

## Description

### Impact

The CNAME adblocking feature added in Brave 1.17.73 accidentally initiated DNS requests that bypassed the Brave Tor proxy. Users with adblocking enabled would leak DNS requests from Tor windows to their DNS provider. (DNS requests that were not initiated by CNAME adblocking would go through Tor as expected.)

### Patches

1.20.108

### References

[#13527](https://github.com/brave/brave-browser/issues/13527)

### For more information

If you have any questions or comments about this advisory, email us at security@brave.com. If you would like to report a security issue, please open one at <https://hackerone.com/brave>.

### Severity

High

### CVE ID

CVE-2021-21323

### Weaknesses

No CWEs

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_79ae4883_20250114_221124.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-core%2Fcommit%2F12fe321eaad8acc1cbd1d70b4128f687777bcf15)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-core%2Fcommit%2F12fe321eaad8acc1cbd1d70b4128f687777bcf15)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=brave%2Fbrave-core)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[brave](/brave)
/
**[brave-core](/brave/brave-core)**
Public

* [Notifications](/login?return_to=%2Fbrave%2Fbrave-core) You must be signed in to change notification settings
* [Fork
  895](/login?return_to=%2Fbrave%2Fbrave-core)
* [Star
   2.5k](/login?return_to=%2Fbrave%2Fbrave-core)

* [Code](/brave/brave-core)
* [Pull requests
  231](/brave/brave-core/pulls)
* [Actions](/brave/brave-core/actions)
* [Security](/brave/brave-core/security)
* [Insights](/brave/brave-core/pulse)

Additional navigation options

* [Code](/brave/brave-core)
* [Pull requests](/brave/brave-core/pulls)
* [Actions](/brave/brave-core/actions)
* [Security](/brave/brave-core/security)
* [Insights](/brave/brave-core/pulse)

## Commit

[Permalink](/brave/brave-core/commit/12fe321eaad8acc1cbd1d70b4128f687777bcf15)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#7769](https://github.com/brave/brave-core/pull/7769) from brave/tor-dns-leak

[Browse files](/brave/brave-core/tree/12fe321eaad8acc1cbd1d70b4128f687777bcf15)
Browse the repository at this point in the history

```
Fix Tor dns leak
```

* Loading branch information

[![@darkdh](https://avatars.githubusercontent.com/u/11330831?s=40&v=4)](/darkdh)

[darkdh](/brave/brave-core/commits?author=darkdh "View all commits by darkdh")
authored
Feb 4, 2021

2 parents
[57f96ea](/brave/brave-core/commit/57f96ea6b7759dcf2506071321c7c0c5b4e6f28c)
+
[a148c43](/brave/brave-core/commit/a148c43124434ca5440c9fef1a99b9b712c966a0)

commit 12fe321

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**18 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* browser/net

  + browser/net/BUILD.gn
    [BUILD.gn](#diff-5b6a0f291a5557f044f56850144d1143d0a8e5c883954ec1a92b8a2a0c1d905c)
  + browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper.cc
    [brave\_ad\_block\_tp\_network\_delegate\_helper.cc](#diff-0986ef9872f15c706dc15f78ee8ef549348a10918b13d126e4483261d7171853)

## There are no files selected for viewing

6 changes: 2 additions & 4 deletions

6
[browser/net/BUILD.gn](#diff-5b6a0f291a5557f044f56850144d1143d0a8e5c883954ec1a92b8a2a0c1d905c "browser/net/BUILD.gn")

Show comments

[View file](/brave/brave-core/blob/12fe321eaad8acc1cbd1d70b4128f687777bcf15/browser/net/BUILD.gn)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -54,11 +54,11 @@ source\_set("net") { |
|  |  | "//brave/components/brave\_webtorrent/browser/buildflags", |
|  |  | "//brave/components/ipfs/buildflags", |
|  |  | "//brave/extensions:common", |
|  |  | "//components/content\_settings/core/browser", |
|  |  | "//components/prefs", |
|  |  | "//components/user\_prefs", |
|  |  | "//content/public/browser", |
|  |  | "//content/public/common", |
|  |  | "//components/content\_settings/core/browser", |
|  |  | "//extensions/common:common\_constants", |
|  |  | "//mojo/public/cpp/bindings", |
|  |  | "//mojo/public/cpp/system", |
| Expand Down  Expand Up | | @@ -88,9 +88,7 @@ source\_set("net") { |
|  |  | "brave\_referrals\_network\_delegate\_helper.h", |
|  |  | ] |
|  |  |  |
|  |  | deps += [ |
|  |  | "//brave/components/brave\_referrals/browser", |
|  |  | ] |
|  |  | deps += [ "//brave/components/brave\_referrals/browser" ] |
|  |  | } |
|  |  |  |
|  |  | if (enable\_brave\_webtorrent) { |
| Expand Down | |  |

25 changes: 16 additions & 9 deletions

25
[browser/net/brave\_ad\_block\_tp\_network\_delegate\_helper.cc](#diff-0986ef9872f15c706dc15f78ee8ef549348a10918b13d126e4483261d7171853 "browser/net/brave_ad_block_tp_network_delegate_helper.cc")

Show comments

[View file](/brave/brave-core/blob/12fe321eaad8acc1cbd1d70b4128f687777bcf15/browser/net/brave_ad_block_tp_network_delegate_helper.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -65,26 +65,24 @@ void ShouldBlockAdOnTaskRunner(std::shared\_ptr<BraveRequestInfo> ctx, |
|  |  | std::string source\_host = ctx->initiator\_url.host(); |
|  |  |  |
|  |  | g\_brave\_browser\_process->ad\_block\_service()->ShouldStartRequest( |
|  |  | ctx->request\_url, ctx->resource\_type, source\_host, |
|  |  | &did\_match\_rule, &did\_match\_exception, &did\_match\_important, |
|  |  | &ctx->mock\_data\_url); |
|  |  | ctx->request\_url, ctx->resource\_type, source\_host, &did\_match\_rule, |
|  |  | &did\_match\_exception, &did\_match\_important, &ctx->mock\_data\_url); |
|  |  | if (did\_match\_important) { |
|  |  | ctx->blocked\_by = kAdBlocked; |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | if (canonical\_name.has\_value() && ctx->request\_url.host() != \*canonical\_name |
|  |  | && \*canonical\_name != "") { |
|  |  | if (canonical\_name.has\_value() && |
|  |  | ctx->request\_url.host() != \*canonical\_name && \*canonical\_name != "") { |
|  |  | GURL::Replacements replacements = GURL::Replacements(); |
|  |  | replacements.SetHost( |
|  |  | canonical\_name->c\_str(), |
|  |  | url::Component(0, static\_cast<int>(canonical\_name->length()))); |
|  |  | const GURL canonical\_url = ctx->request\_url.ReplaceComponents(replacements); |
|  |  |  |
|  |  | g\_brave\_browser\_process->ad\_block\_service()->ShouldStartRequest( |
|  |  | ctx->request\_url, ctx->resource\_type, source\_host, |
|  |  | &did\_match\_rule, &did\_match\_exception, &did\_match\_important, |
|  |  | &ctx->mock\_data\_url); |
|  |  | ctx->request\_url, ctx->resource\_type, source\_host, &did\_match\_rule, |
|  |  | &did\_match\_exception, &did\_match\_important, &ctx->mock\_data\_url); |
|  |  | } |
|  |  |  |
|  |  | if (did\_match\_important || (did\_match\_rule && !did\_match\_exception)) { |
| Expand Down  Expand Up | | @@ -206,7 +204,16 @@ void OnBeforeURLRequestAdBlockTP(const ResponseCallback& next\_callback, |
|  |  | scoped\_refptr<base::SequencedTaskRunner> task\_runner = |
|  |  | g\_brave\_browser\_process->ad\_block\_service()->GetTaskRunner(); |
|  |  |  |
|  |  | new AdblockCnameResolveHostClient(std::move(next\_callback), task\_runner, ctx); |
|  |  | DCHECK(ctx->browser\_context); |
|  |  | // DoH or standard DNS quries won't be routed through Tor, so we need to skip |
|  |  | // it. |
|  |  | if (ctx->browser\_context->IsTor()) { |
|  |  | ShouldBlockAdWithOptionalCname(task\_runner, std::move(next\_callback), ctx, |
|  |  | base::nullopt); |
|  |  | } else { |
|  |  | new AdblockCnameResolveHostClient(std::move(next\_callback), task\_runner, |
|  |  | ctx); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | int OnBeforeURLRequest\_AdBlockTPPreWork(const ResponseCallback& next\_callback, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `12fe321`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrave%2Fbrave-core%2Fcommit%2F12fe321eaad8acc1cbd1d70b4128f687777bcf15) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


