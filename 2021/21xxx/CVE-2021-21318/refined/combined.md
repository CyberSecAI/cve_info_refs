=== Content from github.com_57928136_20250115_102442.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fsecurity%2Fadvisories%2FGHSA-vpc2-3wcv-qj4w)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fsecurity%2Fadvisories%2FGHSA-vpc2-3wcv-qj4w)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=opencast%2Fopencast)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[opencast](/opencast)
/
**[opencast](/opencast/opencast)**
Public

* [Notifications](/login?return_to=%2Fopencast%2Fopencast) You must be signed in to change notification settings
* [Fork
  238](/login?return_to=%2Fopencast%2Fopencast)
* [Star
   410](/login?return_to=%2Fopencast%2Fopencast)

* [Code](/opencast/opencast)
* [Issues
  228](/opencast/opencast/issues)
* [Pull requests
  65](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

Additional navigation options

* [Code](/opencast/opencast)
* [Issues](/opencast/opencast/issues)
* [Pull requests](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

# Removing access may not effect published series

Low

[lkiesow](/lkiesow)
published
GHSA-vpc2-3wcv-qj4w
Feb 17, 2021

## Package

maven

search-service-impl
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

< 9.2

## Patched versions

9.2

## Description

Access to series and series metadata on the search service (shown in media module and player) depends on the events published which are part of the series. Publishing an event will automatically publish a series and update access to it. Removing an event or republishing the event should do the same.

Opencast before version 9.2 may not update the series access or remove a published series if an event is being removed. On removal of an episode, this may lead to:

* An access control list for series metadata with broader access rules than the merged access rules of all remaining events.
* The series metadata still being available although all episodes of that series have been removed.

### Patches

This problem is fixed in Opencast 9.2.

### Workarounds

Without the patch, publishing an episode with strict access rules will overwrite the currently set series access. This allows for an easy denial of access for all users without superuser privileges, effectively hiding the series.

### References

For technical details, take a look at the patch fixing the issue: [b18c6a7](https://github.com/opencast/opencast/commit/b18c6a7f81f08ed14884592a6c14c9ab611ad450)

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [our issue tracker](https://github.com/opencast/opencast/issues)
* Email us at security@opencast.org

### Severity

Low

### CVE ID

CVE-2021-21318

### Weaknesses

No CWEs

### Credits

* [![@lkiesow](https://avatars.githubusercontent.com/u/1008395?s=40&v=4)](/lkiesow)
  [lkiesow](/lkiesow)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0749a7d6_20250115_102441.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fcommit%2Fb18c6a7f81f08ed14884592a6c14c9ab611ad450)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fcommit%2Fb18c6a7f81f08ed14884592a6c14c9ab611ad450)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=opencast%2Fopencast)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[opencast](/opencast)
/
**[opencast](/opencast/opencast)**
Public

* [Notifications](/login?return_to=%2Fopencast%2Fopencast) You must be signed in to change notification settings
* [Fork
  238](/login?return_to=%2Fopencast%2Fopencast)
* [Star
   410](/login?return_to=%2Fopencast%2Fopencast)

* [Code](/opencast/opencast)
* [Issues
  228](/opencast/opencast/issues)
* [Pull requests
  65](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

Additional navigation options

* [Code](/opencast/opencast)
* [Issues](/opencast/opencast/issues)
* [Pull requests](/opencast/opencast/pulls)
* [Discussions](/opencast/opencast/discussions)
* [Actions](/opencast/opencast/actions)
* [Security](/opencast/opencast/security)
* [Insights](/opencast/opencast/pulse)

## Commit

[Permalink](/opencast/opencast/commit/b18c6a7f81f08ed14884592a6c14c9ab611ad450)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix Engage Series Publication and Access

[Browse files](/opencast/opencast/tree/b18c6a7f81f08ed14884592a6c14c9ab611ad450)
Browse the repository at this point in the history

```
Access to series and series metadata on the search service (shown in
media module and player) depends on the events published which are part
of the series. Publishing an event will automatically publish a series
and update access to it. Removing an event or republishing the event
should do the same.

Incorrectly Hiding Public Series
--------------------------------

This patch fixes the access control update to the series when a new
episode is being published. Until now, a new episode publication would
always update the series access with the episode access.

While this is no security issue since it can only cause the access to be
stricter, it may cause public series to become private. This would
happen, for example, if a users sets one episode of a series to private
and republishes the episode.

Now, the search service will merge the access control lists of all
episodes to grant access based on their combined access rules.

Update Series on Removal
------------------------

This patch fixes Opencast not updating the series access or remove a
published series if an event is being removed.

This means that access to a series is re-calculated when an episode is
being deleted based on the remaining published episodes in the series.
For example, removing the last episode with public access will now make
the series private which it would have stayed public before.

It also means that if the last episode of a series is being removed, the
series itself will be unpublished as well, so no empty series will
continue to show up any longer.
```

* Loading branch information

[![@lkiesow](https://avatars.githubusercontent.com/u/1008395?s=40&v=4)](/lkiesow)

[lkiesow](/opencast/opencast/commits?author=lkiesow "View all commits by lkiesow")
committed
Jan 17, 2021

1 parent
[29b08ce](/opencast/opencast/commit/29b08ceec87c926bfbb2961fee8288ec44cba7e8)

commit b18c6a7

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**153 additions**
and
**36 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* modules/search-service-impl/src/main/java/org/opencastproject/search/impl

  + modules/search-service-impl/src/main/java/org/opencastproject/search/impl/SearchServiceImpl.java
    [SearchServiceImpl.java](#diff-28c74ab6f058f6f5a4e6a0d81750f9916ba38f1c06882289722bfb12c9c15284)
  + persistence

    - modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchEntity.java
      [SearchEntity.java](#diff-69eb33b628f54198dac6232e21fb1c5b6fab48c2381e06317cab19321959b174)
    - modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabase.java
      [SearchServiceDatabase.java](#diff-2d3e554c1a247de20ecc6b2c62c7604421801956bd021608dd1aa637e787ea4e)
    - modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabaseImpl.java
      [SearchServiceDatabaseImpl.java](#diff-ca73f6f6fbf7c925d80503f14dc6d8d4ee9ab130677cbedb7ff3bf0d9187299c)
  + solr

    - modules/search-service-impl/src/main/java/org/opencastproject/search/impl/solr/SolrIndexManager.java
      [SolrIndexManager.java](#diff-2680f916493288cde8ec3afa9457f4893231e9f4d63dec5b48a11811d6ec3c8a)

## There are no files selected for viewing

54 changes: 35 additions & 19 deletions

54
[.../search-service-impl/src/main/java/org/opencastproject/search/impl/SearchServiceImpl.java](#diff-28c74ab6f058f6f5a4e6a0d81750f9916ba38f1c06882289722bfb12c9c15284 "modules/search-service-impl/src/main/java/org/opencastproject/search/impl/SearchServiceImpl.java")

Show comments

[View file](/opencast/opencast/blob/b18c6a7f81f08ed14884592a6c14c9ab611ad450/modules/search-service-impl/src/main/java/org/opencastproject/search/impl/SearchServiceImpl.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -373,28 +373,32 @@ public Job add(MediaPackage mediaPackage) throws SearchException, MediaPackageEx |
|  |  | \* the media package |
|  |  | \* @throws SearchException |
|  |  | \* if the media package cannot be added to the search index |
|  |  | \* @throws MediaPackageException |
|  |  | \* if the mediapckage is invalid |
|  |  | \* @throws IllegalArgumentException |
|  |  | \* if the mediapackage is <code>null</code> |
|  |  | \* @throws UnauthorizedException |
|  |  | \* if the user does not have the rights to add the mediapackage |
|  |  | \*/ |
|  |  | public void addSynchronously(MediaPackage mediaPackage) throws SearchException, MediaPackageException, |
|  |  | IllegalArgumentException, UnauthorizedException { |
|  |  | public void addSynchronously(MediaPackage mediaPackage) |
|  |  | throws SearchException, IllegalArgumentException, UnauthorizedException, NotFoundException, |
|  |  | SearchServiceDatabaseException { |
|  |  | if (mediaPackage == null) { |
|  |  | throw new IllegalArgumentException("Unable to add a null mediapackage"); |
|  |  | } |
|  |  | logger.debug("Attempting to add mediapackage {} to search index", mediaPackage.getIdentifier()); |
|  |  | final String mediaPackageId = mediaPackage.getIdentifier().toString(); |
|  |  | logger.debug("Attempting to add media package {} to search index", mediaPackageId); |
|  |  | AccessControlList acl = authorizationService.getActiveAcl(mediaPackage).getA(); |
|  |  |  |
|  |  | AccessControlList seriesAcl = persistence.getAccessControlLists(mediaPackage.getSeries(), mediaPackageId).stream() |
|  |  | .reduce(new AccessControlList(acl.getEntries()), AccessControlList::mergeActions); |
|  |  | logger.debug("Updating series with merged access control list: {}", seriesAcl); |
|  |  |  |
|  |  | Date now = new Date(); |
|  |  |  |
|  |  | try { |
|  |  | if (indexManager.add(mediaPackage, acl, now)) { |
|  |  | logger.info("Added mediapackage `{}` to the search index, using ACL `{}`", mediaPackage, acl); |
|  |  | if (indexManager.add(mediaPackage, acl, seriesAcl, now)) { |
|  |  | logger.info("Added media package `{}` to the search index, using ACL `{}`", mediaPackageId, acl); |
|  |  | } else { |
|  |  | logger.warn("Failed to add mediapackage {} to the search index", mediaPackage.getIdentifier()); |
|  |  | logger.warn("Failed to add media package {} to the search index", mediaPackageId); |
|  |  | } |
|  |  | } catch (SolrServerException e) { |
|  |  | throw new SearchException(e); |
| Expand All | | @@ -403,8 +407,8 @@ public void addSynchronously(MediaPackage mediaPackage) throws SearchException, |
|  |  | try { |
|  |  | persistence.storeMediaPackage(mediaPackage, acl, now); |
|  |  | } catch (SearchServiceDatabaseException e) { |
|  |  | logger.error("Could not store media package to search database {}: {}", mediaPackage.getIdentifier(), e); |
|  |  | throw new SearchException(e); |
|  |  | throw new SearchException( |
|  |  | String.format("Could not store media package to search database %s", mediaPackageId), e); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand All | | @@ -429,13 +433,8 @@ public Job delete(String mediaPackageId) throws SearchException, UnauthorizedExc |
|  |  | \* @return <code>true</code> if the mediapackage was deleted |
|  |  | \* @throws SearchException |
|  |  | \* if deletion failed |
|  |  | \* @throws UnauthorizedException |
|  |  | \* if the user did not have access to the media package |
|  |  | \* @throws NotFoundException |
|  |  | \* if the mediapackage did not exist |
|  |  | \*/ |
|  |  | public boolean deleteSynchronously(String mediaPackageId) throws SearchException, UnauthorizedException, |
|  |  | NotFoundException { |
|  |  | public boolean deleteSynchronously(final String mediaPackageId) throws SearchException { |
|  |  | SearchResult result; |
|  |  | try { |
|  |  | result = solrRequester.getForWrite(new SearchQuery().withId(mediaPackageId)); |
| Expand All | | @@ -445,7 +444,8 @@ public boolean deleteSynchronously(String mediaPackageId) throws SearchException |
|  |  | mediaPackageId); |
|  |  | return false; |
|  |  | } |
|  |  | logger.info("Removing mediapackage {} from search index", mediaPackageId); |
|  |  | final String seriesId = result.getItems()[0].getDcIsPartOf(); |
|  |  | logger.info("Removing media package {} from search index", mediaPackageId); |
|  |  |  |
|  |  | Date now = new Date(); |
|  |  | try { |
| Expand All | | @@ -460,8 +460,24 @@ public boolean deleteSynchronously(String mediaPackageId) throws SearchException |
|  |  | throw new SearchException(e); |
|  |  | } |
|  |  |  |
|  |  | return indexManager.delete(mediaPackageId, now); |
|  |  | } catch (SolrServerException e) { |
|  |  | final boolean success = indexManager.delete(mediaPackageId, now); |
|  |  |  |
|  |  | // Update series |
|  |  | if (seriesId != null) { |
|  |  | if (persistence.getMediaPackages(seriesId).size() > 0) { |
|  |  | // Update series acl if there are still episodes in the series |
|  |  | final AccessControlList seriesAcl = persistence.getAccessControlLists(seriesId).stream() |
|  |  | .reduce(new AccessControlList(), AccessControlList::mergeActions); |
|  |  | indexManager.addSeries(seriesId, seriesAcl); |
|  |  |  |
|  |  | } else { |
|  |  | // Remove series if there are no episodes in the series any longer |
|  |  | indexManager.delete(seriesId, now); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return success; |
|  |  | } catch (SolrServerException | SearchServiceDatabaseException e) { |
|  |  | logger.info("Could not delete media package with id {} from search index", mediaPackageId); |
|  |  | throw new SearchException(e); |
|  |  | } |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[...-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchEntity.java](#diff-69eb33b628f54198dac6232e21fb1c5b6fab48c2381e06317cab19321959b174 "modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchEntity.java")

Show comments

[View file](/opencast/opencast/blob/b18c6a7f81f08ed14884592a6c14c9ab611ad450/modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchEntity.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -50,7 +50,8 @@ |
|  |  | @NamedQuery(name = "Search.findAll", query = "SELECT s FROM SearchEntity s"), |
|  |  | @NamedQuery(name = "Search.getCount", query = "SELECT COUNT(s) FROM SearchEntity s"), |
|  |  | @NamedQuery(name = "Search.findById", query = "SELECT s FROM SearchEntity s WHERE s.mediaPackageId=:mediaPackageId"), |
|  |  | @NamedQuery(name = "Search.findBySeriesId", query = "SELECT s FROM SearchEntity s WHERE s.seriesId=:seriesId"), |
|  |  | @NamedQuery(name = "Search.findBySeriesId", query = "SELECT s FROM SearchEntity s WHERE s.seriesId=:seriesId and " |
|  |  | + "s.deletionDate is null"), |
|  |  | @NamedQuery(name = "Search.getNoSeries", query = "SELECT s FROM SearchEntity s WHERE s.seriesId IS NULL")}) |
|  |  | public class SearchEntity { |
|  |  |  |
| Expand Down | |  |

30 changes: 28 additions & 2 deletions

30
[...impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabase.java](#diff-2d3e554c1a247de20ecc6b2c62c7604421801956bd021608dd1aa637e787ea4e "modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabase.java")

Show comments

[View file](/opencast/opencast/blob/b18c6a7f81f08ed14884592a6c14c9ab611ad450/modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabase.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,6 +27,7 @@ |
|  |  | import org.opencastproject.util.NotFoundException; |
|  |  | import org.opencastproject.util.data.Tuple; |
|  |  |  |
|  |  | import java.util.Collection; |
|  |  | import java.util.Date; |
|  |  | import java.util.Iterator; |
|  |  |  |
| Expand Down  Expand Up | | @@ -81,7 +82,18 @@ public interface SearchServiceDatabase { |
|  |  | MediaPackage getMediaPackage(String mediaPackageId) throws NotFoundException, SearchServiceDatabaseException; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Retrieves ACL for series with given ID. |
|  |  | \* Gets media packages from a specific series |
|  |  | \* |
|  |  | \* @param seriesId |
|  |  | \* the series identifier |
|  |  | \* @return collection of media packages |
|  |  | \* @throws SearchServiceDatabaseException |
|  |  | \* if there is a problem communicating with the underlying data store |
|  |  | \*/ |
|  |  | Collection<MediaPackage> getMediaPackages(String seriesId) throws SearchServiceDatabaseException; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Retrieves ACL for episode with given ID. |
|  |  | \* |
|  |  | \* @param mediaPackageId |
|  |  | \* media package for which ACL will be retrieved |
| Expand All | | @@ -92,7 +104,21 @@ public interface SearchServiceDatabase { |
|  |  | \* if exception occurred |
|  |  | \*/ |
|  |  | AccessControlList getAccessControlList(String mediaPackageId) throws NotFoundException, |
|  |  | SearchServiceDatabaseException; |
|  |  | SearchServiceDatabaseException; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Retrieves ACLs for series with given ID. |
|  |  | \* |
|  |  | \* @param seriesId |
|  |  | \* series identifier for which ACL will be retrieved |
|  |  | \* @param excludeIds |
|  |  | \* list of media package identifier to exclude from the list |
|  |  | \* @return Collection of {@link AccessControlList} of media packages from the series |
|  |  | \* @throws SearchServiceDatabaseException |
|  |  | \* if exception occurred |
|  |  | \*/ |
|  |  | Collection<AccessControlList> getAccessControlLists(String seriesId, String ... excludeIds) |
|  |  | throws SearchServiceDatabaseException; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns the modification date from the selected media package. |
| Expand Down | |  |

61 changes: 60 additions & 1 deletion

61
[.../src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabaseImpl.java](#diff-ca73f6f6fbf7c925d80503f14dc6d8d4ee9ab130677cbedb7ff3bf0d9187299c "modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabaseImpl.java")

Show comments

[View file](/opencast/opencast/blob/b18c6a7f81f08ed14884592a6c14c9ab611ad450/modules/search-service-impl/src/main/java/org/opencastproject/search/impl/persistence/SearchServiceDatabaseImpl.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,9 +26,11 @@ |
|  |  | import static org.opencastproject.security.api.Permissions.Action.WRITE; |
|  |  |  |
|  |  | import org.opencastproject.mediapackage.MediaPackage; |
|  |  | import org.opencastproject.mediapackage.MediaPackageException; |
|  |  | import org.opencastproject.mediapackage.MediaPackageParser; |
|  |  | import org.opencastproject.security.api.AccessControlList; |
|  |  | import org.opencastproject.security.api.AccessControlParser; |
|  |  | import org.opencastproject.security.api.AccessControlParsingException; |
|  |  | import org.opencastproject.security.api.AccessControlUtil; |
|  |  | import org.opencastproject.security.api.Organization; |
|  |  | import org.opencastproject.security.api.SecurityService; |
| Expand All | | @@ -42,6 +44,10 @@ |
|  |  | import org.slf4j.Logger; |
|  |  | import org.slf4j.LoggerFactory; |
|  |  |  |
|  |  | import java.io.IOException; |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.Arrays; |
|  |  | import java.util.Collection; |
|  |  | import java.util.Date; |
|  |  | import java.util.Iterator; |
|  |  | import java.util.LinkedList; |
| Expand Down  Expand Up | | @@ -250,13 +256,66 @@ public AccessControlList getAccessControlList(String mediaPackageId) throws NotF |
|  |  | } catch (NotFoundException e) { |
|  |  | throw e; |
|  |  | } catch (Exception e) { |
|  |  | logger.error("Could not retrieve ACL {}: {}", mediaPackageId, e.getMessage()); |
|  |  | logger.error("Could not retrieve ACL {}", mediaPackageId, e); |
|  |  | throw new SearchServiceDatabaseException(e); |
|  |  | } finally { |
|  |  | em.close(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* {@inheritDoc} |
|  |  | \* |
|  |  | \* @see org.opencastproject.search.impl.persistence.SearchServiceDatabase#getAccessControlLists(String, String...) |
|  |  | \*/ |
|  |  | @Override |
|  |  | public Collection<AccessControlList> getAccessControlLists(final String seriesId, String ... excludeIds) |
|  |  | throws SearchServiceDatabaseException { |
|  |  | List<String> excludes = Arrays.asList(excludeIds); |
|  |  | List<AccessControlList> accessControlLists = new ArrayList<>(); |
|  |  | EntityManager em = emf.createEntityManager(); |
|  |  | TypedQuery<SearchEntity> q = em.createNamedQuery("Search.findBySeriesId", SearchEntity.class) |
|  |  | .setParameter("seriesId", seriesId); |
|  |  | try { |
|  |  | for (SearchEntity entity: q.getResultList()) { |
|  |  | if (entity.getAccessControl() != null && !excludes.contains(entity.getMediaPackageId())) { |
|  |  | accessControlLists.add(AccessControlParser.parseAcl(entity.getAccessControl())); |
|  |  | } |
|  |  | } |
|  |  | } catch (IOException | AccessControlParsingException e) { |
|  |  | throw new SearchServiceDatabaseException(e); |
|  |  | } finally { |
|  |  | em.close(); |
|  |  | } |
|  |  | return accessControlLists; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* {@inheritDoc} |
|  |  | \* |
|  |  | \* @see org.opencastproject.search.impl.persistence.SearchServiceDatabase#getMediaPackages(String) |
|  |  | \*/ |
|  |  | @Override |
|  |  | public Collection<MediaPackage> getMediaPackages(final String seriesId) |
|  |  | throws SearchServiceDatabaseException { |
|  |  | List<MediaPackage> episodes = new ArrayList<>(); |
|  |  | EntityManager em = emf.createEntityManager(); |
|  |  | TypedQuery<SearchEntity> q = em.createNamedQuery("Search.findBySeriesId", SearchEntity.class) |
|  |  | .setParameter("seriesId", seriesId); |
|  |  | try { |
|  |  | for (SearchEntity entity: q.getResultList()) { |
|  |  | if (entity.getMediaPackageXML() != null) { |
|  |  | episodes.add(MediaPackageParser.getFromXml(entity.getMediaPackageXML())); |
|  |  | } |
|  |  | } |
|  |  | } catch (MediaPackageException e) { |
|  |  | throw new SearchServiceDatabaseException(e); |
|  |  | } finally { |
|  |  | em.close(); |
|  |  | } |
|  |  | return episodes; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* {@inheritDoc} |
|  |  | \* |
| Expand Down | |  |

41 changes: 28 additions & 13 deletions

41
[...rch-service-impl/src/main/java/org/opencastproject/search/impl/solr/SolrIndexManager.java](#diff-2680f916493288cde8ec3afa9457f4893231e9f4d63dec5b48a11811d6ec3c8a "modules/search-service-impl/src/main/java/org/opencastproject/search/impl/solr/SolrIndexManager.java")

Show comments

[View file](/opencast/opencast/blob/b18c6a7f81f08ed14884592a6c14c9ab611ad450/modules/search-service-impl/src/main/java/org/opencastproject/search/impl/solr/SolrIndexManager.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -273,32 +273,47 @@ public boolean delete(String id, Date deletionDate) throws SolrServerException { |
|  |  | \* @throws SolrServerException |
|  |  | \* if an errors occurs while talking to solr |
|  |  | \*/ |
|  |  | public boolean add(MediaPackage sourceMediaPackage, AccessControlList acl, Date now) throws SolrServerException, |
|  |  | UnauthorizedException { |
|  |  | public boolean add(MediaPackage sourceMediaPackage, AccessControlList acl, AccessControlList seriesAcl, Date now) |
|  |  | throws SolrServerException, UnauthorizedException { |
|  |  | try { |
|  |  | SolrInputDocument episodeDocument = createEpisodeInputDocument(sourceMediaPackage, acl); |
|  |  | Schema.setOcModified(episodeDocument, now); |
|  |  |  |
|  |  | SolrInputDocument seriesDocument = createSeriesInputDocument(sourceMediaPackage.getSeries(), acl); |
|  |  | SolrInputDocument seriesDocument = createSeriesInputDocument(sourceMediaPackage.getSeries(), seriesAcl); |
|  |  | if (seriesDocument != null) |
|  |  | Schema.enrich(episodeDocument, seriesDocument); |
|  |  |  |
|  |  | // If neither an episode nor a series was contained, there is no point in trying to update |
|  |  | if (episodeDocument == null && seriesDocument == null) { |
|  |  | logger.warn("Neither episode nor series metadata found"); |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // Post everything to the search index |
|  |  | if (episodeDocument != null) |
|  |  | solrServer.add(episodeDocument); |
|  |  | solrServer.add(episodeDocument); |
|  |  | if (seriesDocument != null) |
|  |  | solrServer.add(seriesDocument); |
|  |  | solrServer.commit(); |
|  |  | return true; |
|  |  | } catch (Exception e) { |
|  |  | logger.error("Unable to add mediapackage {} to index", sourceMediaPackage.getIdentifier()); |
|  |  | throw new SolrServerException(e); |
|  |  | throw new SolrServerException( |
|  |  | String.format("Unable to add media package %s to index", sourceMediaPackage.getIdentifier()), e); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Posts a series to Solr. If the entry already exists, this will update the series. |
|  |  | \* |
|  |  | \* @param seriesId |
|  |  | \* the series to post |
|  |  | \* @param acl |
|  |  | \* the access control list for this series |
|  |  | \* @throws SolrServerException |
|  |  | \* if an errors occurs while talking to solr |
|  |  | \*/ |
|  |  | public void addSeries(final String seriesId, final AccessControlList acl) throws SolrServerException { |
|  |  | try { |
|  |  | SolrInputDocument seriesDocument = createSeriesInputDocument(seriesId, acl); |
|  |  | if (seriesDocument != null) { |
|  |  | solrServer.add(seriesDocument); |
|  |  | solrServer.commit(); |
|  |  | } |
|  |  | } catch (Exception e) { |
|  |  | throw new SolrServerException(String.format("Unable to add series %s to index", seriesId), e); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b18c6a7`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencast%2Fopencast%2Fcommit%2Fb18c6a7f81f08ed14884592a6c14c9ab611ad450) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


