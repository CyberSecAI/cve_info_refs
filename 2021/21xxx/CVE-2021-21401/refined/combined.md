=== Content from github.com_9b8bc791_20250115_085849.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fblob%2Fc9124132a604047d0ef97a09c0e99cd9bed2c818%2FCHANGELOG.txt)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fblob%2Fc9124132a604047d0ef97a09c0e99cd9bed2c818%2FCHANGELOG.txt)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=nanopb%2Fnanopb)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nanopb](/nanopb)
/
**[nanopb](/nanopb/nanopb)**
Public

* [Notifications](/login?return_to=%2Fnanopb%2Fnanopb) You must be signed in to change notification settings
* [Fork
  873](/login?return_to=%2Fnanopb%2Fnanopb)
* [Star
   4.4k](/login?return_to=%2Fnanopb%2Fnanopb)

* [Code](/nanopb/nanopb)
* [Issues
  54](/nanopb/nanopb/issues)
* [Pull requests
  9](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects
  0](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

Additional navigation options

* [Code](/nanopb/nanopb)
* [Issues](/nanopb/nanopb/issues)
* [Pull requests](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

## Files

 c912413
## Breadcrumbs

1. [nanopb](/nanopb/nanopb/tree/c9124132a604047d0ef97a09c0e99cd9bed2c818)
/
# CHANGELOG.txt

Copy path Blame  Blame
## Latest commit

## History

[History](/nanopb/nanopb/commits/c9124132a604047d0ef97a09c0e99cd9bed2c818/CHANGELOG.txt)522 lines (463 loc) · 23.3 KB c912413
## Breadcrumbs

1. [nanopb](/nanopb/nanopb/tree/c9124132a604047d0ef97a09c0e99cd9bed2c818)
/
# CHANGELOG.txt

Top
## File metadata and controls

* Code
* Blame

522 lines (463 loc) · 23.3 KB[Raw](https://github.com/nanopb/nanopb/raw/c9124132a604047d0ef97a09c0e99cd9bed2c818/CHANGELOG.txt)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522nanopb-0.4.5 (2021-03-22) Fix invalid free() with oneof (#647, GHSA-7mv5-5mxh-qg88) Fix unordered field numbers inside oneof causing fields to be ignored (#617) Fix pb\_decode() not initializing fields inside oneof (#635 Fix compiler errors with complex oneof hierarchy and sizeof() (#610) Fix descriptor width calculation for 64-bit types (#644) Fix compiler error in generated initializer for submessage callback (#631) Fix duplicate union definition in generated file (#637) Fix test case build error on SCons 4.1.0 Pip package: include nanopb\_pb2.py (#629) Make generator consider dependencies recursively (#610) Bazel build system updates (#633) Add support for including comments from .proto file (#85, #645)
nanopb-0.4.4 (2020-11-25) Fix memory leak with oneofs and PB\_ENABLE\_MALLOC (#615, GHSA-85rr-4rh9-hhwh) Fix generator error when oneof contains a single unresolved field size (#610) Fix unsigned enums not working correctly inside OneOf (#611) Fix recursion depth exceeded error in generator (#493) Add '--version' option to nanopb\_generator.py (#607) Add support for proto3 optional fields introduced in protoc 3.12 (#591) Add better error message when enum type is not found (#592) Allow specifying descriptorsize on field level also (#546) Allow multiple targets to be created by calling NANOPB\_GENERATE\_CPP() (#596) Conanfile: Add protobuf-nanopb library to cpp\_info.libs (#605) Include version number in generator verbose output Convert documentation to markdown format (#587) Remove outdated transitional generator/nanopb/options.proto. Test case improvements Documentation improvements
nanopb-0.4.3 (2020-09-21) Fix generator error when output is in current directory (#553) Fix issue with unknown message sizes being referred inside oneof encoded size calculation (#569) Fix problem with [default=xxxx, (nanopb).proto3=true] field option combination (#558) Fix cross compilation with Conan build system (#568) Better support C++ types in generated structs (#577) CMake rule improvements (#554, #555, #556, #561, #564) Generator: fix compatibility bug with Python 3.1 and earlier Make Linux and Mac packages use grpcio protoc Make pb\_decode\_varint32() reject overlong varint encodings. Performance optimizations Test case improvements Documentation improvements
NOTE: version 0.4.3 changes layout of pb\_msgdesc\_t. It requires recompiling .pb.c files andthus breaks ABI compatibility. In general, ABI compatibility is not currently maintainedbetween any nanopb versions.
NOTE: There was an apparent false positive virus identification by Windows Defender of thePyInstaller 3.6 based Windows package nanopb-0.4.3-windows-x86.zip. The package was replacedby nanopb-0.4.3-p1-windows-x86.zip with rebuilt PyInstaller 4.0, which seems to avoid the problem.Actual nanopb code is unchanged between the packages.
nanopb-0.4.2 (2020-06-23) Fix buffer overflow when encoding bytes with size set to 65535 (#547, GHSA-3p39-mfxg-hrq4) Fix segfault with pointer fields and proto3\_singular\_msgs = true. (#504,#505) Fix Windows 10 temp file handling (#486) Fix macro name conflicts (ATMEGA32U4 UENUM and more) (#522) Fix generator error with nested messages and default values (#487) Fix nanopb\_generator exception on enums with aliases (#535) Fix compile error when struct members are called X or a (#492) Fix sizeof(union ...) fallback not compiling with C++ (#415, #494) Fix "missing required field" error with submessage callback (#544) Fix field descriptor sizing with submsg\_callback option (#545) Fix protoc calling on Python 2 (#503) Fix handling of varying NaN representations in PB\_CONVERT\_DOUBLE\_FLOAT (#543) Fix clang undefined behavior sanitizer errors. Change generator to use Python 3 by default (#441, #509) Binary packages updated to use Python 3 and grpcio-tools Add support for infinity and nan floating-point defaults (#530, #538) Add generator option sort\_by\_tag (#542) Add type\_override option to override type defined in .proto (#497) Set proto2 enum fields to first value when no default is given, even if nonzero (#532,#539) Include protoc-gen-nanopb in path in protoc wrapper script Properly pass error status from protoc wrapper when calling binary protoc Generator: pass --include\_imports when calling protoc (#494) Create intermediate directories when writing files to relative path (#512) Add current directory to include path for protoc (#499) Update readme to use nanopb\_generator.py directly Regression test for proto3 incorrectly considered empty (#504) CMake: change package name to Nanopb for cmake 3.17 compatibility (#506) CMake: remove find\_package(PythonInterp) (#508) CMake: use split --nanopb\_opt only on protoc >= 3.6 (#515) CMake: Relax python version spec, allowing Python3. (#534) Swift package manager (#549) Rename BUILD as BUILD.bazel (#537)
Note: Windows binary packages in 0.4.2 and later require Windows 7 or newer.
nanopb-0.4.1 (2020-02-02) Fix invalid free() after failed realloc() (GHSA-gcx3-7m76-287p) Avoid overflows in allocation for packed fields. Verify stream size before allocating string / bytes. Add workaround for avr-libc realloc() bug (#475) Fix bug with field numbers >255 (#407) Fix compilation error on platforms without uint8\_t (#485) Fix warnings on Python3.8 (#399, #467) Make fixed\_count option work when combined with FT\_POINTER. Add missing #define for submsg callbacks, add regression test (#472) Fix ImportError when using generator/protoc with Python 3 Remove accidental debug code in generator Reduce stack usage (#484) Remove PB\_FIELDINFO\_WIDTH option (#473) Add nanopb-specific package name option (#422) Add testcase for Any type (#163) Add exclude option also from .proto/.options Set default include path in the grpc\_tools protoc wrapper. Add workaround for python-protobuf 3.6.1 bug (#478) Detect invalid wire type when decoding fields. Improved fuzz testing
nanopb-0.4.0 (2019-12-20) New field descriptor format. Make nanopb\_generator automatically compile .proto files (#462) Allow installing as Python package from pip (#460) Use protoc from grpcio-tools Python package if available (#463) Change proto3 message types to be optional (#308, #452) Add pb\_decode\_ex(), pb\_encode\_ex() functions. Automatically rebuild nanopb\_pb2.py Use plugin.proto that comes with python-protobuf (#234)
 Allow specifying a per-message callback. (#175) Improve callback handling inside oneofs. (#175)
 Introduce new compile time flag: PB\_VALIDATE\_UTF8 (#437) Add TypenameMangling.M\_PACKAGE\_INITIALS (#394) Introduce new compile time flag: PB\_ENCODE\_ARRAYS\_UNPACKED (#427) Add default\_has option (#423) Add option for including extra files from .pb.h Add generator option to error out on unmatched options (#458) Generator: Allow comma separated options in plugin mode (#343) Allow comma-separated option parsing to handle `#include` (#450) Remove timestamp from generated files by default, add -t to keep it. Make --no-strip-path default (#326) Fix .options file case sensitivity on Windows. Fix generator error with mangle\_names option (#380) Take int\_size setting into account in calculating message sizes (#373) .gitignore: don't ignore generator-bin files (#419) Cleanup .pb.h header format
 Make tests run on AVR and STM32 Add PB\_CONVERT\_DOUBLE\_FLOAT setting to convert doubles on AVR. Store field descriptor constants in flash on AVR (#464) Added "f" suffix to const float declarations. (#453) Fix clang-tidy warnings about using signed integers in binary bitwise operations (#451) Add C++ message descriptors helper (#384) Implement conan recipe (#378) CMake: Split nanopb\_out command (#454) CMake: install created shared library(dll) in windows to the binary folder (#447)
nanopb-0.3.9.8 (2021-03-22) Fix invalid free() with oneof (#647, GHSA-7mv5-5mxh-qg88) Don't generate lines with trailing spaces (#622) Verify stream size before allocating string / bytes (#620)
nanopb-0.3.9.7 (2020-11-25) Fix memory leak with oneofs and PB\_ENABLE\_MALLOC (#615, GHSA-85rr-4rh9-hhwh) Fix unsigned enums not working correctly inside OneOf (#611) Add '--version' option to nanopb\_generator.py (#607) SwiftPM rule updates (#567, #585)
nanopb-0.3.9.6 (2020-06-23) Fix buffer overflow when encoding bytes with size set to 65535 (#547, GHSA-3p39-mfxg-hrq4) Fix proto3 submessage improperly considered empty (#504) Fix ImportError when using generator/protoc with Python 3 Add build rules for Swift package manager (#549)
nanopb-0.3.9.5 (2020-02-02) Fix invalid free() after failed realloc() (GHSA-gcx3-7m76-287p) Add workaround for avr-libc realloc() bug (#475) Fix empty submessages getting encoded in proto3 mode (#395) Avoid overflows in allocation for packed fields.
nanopb-0.3.9.4 (2019-10-13) Fix undefined behavior with bool fields (#434) Fix enum min/max defines when values are not in order (#405) Fix network\_server socket example with zero-length strings (#421) Don't call stream read callback with count=0 (#421) Add compile time flag PB\_ENCODE\_ARRAYS\_UNPACKED (#427)
nanopb-0.3.9.3 (2019-03-08) NOTE: nanopb-0.3.9.3.tar.gz before 2019-03-21 was accidentally from 0.4 branch (#388) Fix fixed size and callback repeated fields inside proto3 submessages (#376, #382, #386) Fix incorrect PB\_STATIC\_ASSERT for bytes inside oneof (#363) Fix generator error with mangle\_names option (#380) Generator: Allow comma separated options in plugin mode (#343)
nanopb-0.3.9.2 (2018-11-10) Erroneous free() when using callbacks combined with PB\_ENABLE\_MALLOC (#346) Fix possible null-pointer dereference in decode\_callback\_field (#342) Fix FindNanopb.cmake on Windows (#335) Fix large generator memory usage with oneof fields (#338) Fix error in splint test (#359) Allow cmake to build as a shared library (#352, #353) Add --no-strip-path command line option (#326) Option for flattening nested protobuf names (#333) Documentation fixes (#329, #350, #358) Better error messages (#351)
nanopb-0.3.9.1 (2018-04-14) Fix handling of special characters in string/bytes default values (issue #322) Fix encoding of negative numbers with PB\_WITHOUT\_64BIT (#285) Fix \_zero initializer for enums that don't begin at 0. (#295) Multiple CMake fixes (#296, #299, #304, #312, #320) Fix compiler warnings (#305) Fix scons rules for Python 3 Add check for large extension field number (issue #306) Updated included descriptor.proto version (#314) Resolve oneof sizes symbolically when needed (#311) Add fixed\_count option (#260) Add some verbose prints in generator (issue #238) Add test/example of using 'map' type. (#289)
nanopb-0.3.9 (2017-09-23) Fix bugs in proto3 encoding of submessages (#256) Fix message size calculation for arrays of size 1 (#253) Fix segfault with FT\_CALLBACK inside FT\_POINTER (#259) Properly detect truncated tags in corrupted messages (#277) Make pb\_decode\_varint32 overflow checks exact (#258) Add option to build without 64-bit support (#86) Add options to define source and header file extensions (#264) Add pb\_en/decode\_nullterminated() (part of #278) Add pb\_decode\_delimited\_noinit (#284) CMake: add dependency for .options file (#265) CMake: change use of relative paths (#250,#271,#273) Better error message for missing max\_size option (#281) Travis-CI build fixes (#283) Add Bazel build system file (#266)
nanopb-0.3.8 (2017-03-05) Fix problems with multiple oneofs in same message (#229) Zero-valued extension fields were mistakenly ignored by encoder (#242) Multiple fixes related to proto3 mode (#242, #245, #247, #249) Fix potential unaligned access (#226, #227) Fix documentation for protoc --plugin argument (#239) Extend inline / fixed length bytes array support (#244) Add new option max\_length for strings (#107) Make string substream API more robust (#230) Make pb\_decode\_varint32 public API (#231) Allow overriding proto3 mode (#228) Add optional enum->string mapping function (#223) Add transitional options.proto file (#241) Add better error message on Python library version imcompatibility (#240) Include version number in PlatformIO library.json (#222) CMake build script changes (#236, #237) Change download links to https Improvements to test cases.
nanopb-0.3.7 (2016-10-30) Add support for proto3-style singular fields (#182, #206, #216) Updated binary package protoc to version 3.1.0 Add FT\_INLINE allocation of bytes fields (#211) Include package name in include guard (#207) Fix missing warning with large bytes fields (issue #220) Added CMake project (#208) Add bazel BUILD file for nanopb (#209) Added an AUTHORS file (#211) Documentation updates Improvements to test cases.
nanopb-0.3.6 (2016-06-19) Protect against corrupted \_count fields in pb\_release (#205) Fix error in STATIC\_ASSERT with multiple files (#203) Add -D option to specify output directory (#193) Generate MIN/MAX/ARRAYSIZE defines for enums (#194) Generate comments about uncalculable message sizes (#195) Documentation updates (#196, #201) Improvements to test cases.
nanopb-0.3.5 (2016-02-13) NOTE: If you are using pb\_syshdr.h, you will need to add uint\_least8\_t definition. See docs/migration.rst for details.
 Fix generator crash with Enum inside Oneof (#188) Fix some generator regressions related to .options file path (#172) Add support for platforms without uint8\_t (#191) Allow const parameter to pb\_istream\_from\_buffer (#152) Ignore null pointers in pb\_release() (#183) Add support for anonymous unions (#184) Add Python3 support to the generator (#169) Add code generator insertion points to generated files (#178) Improvements to CMake script (#181) Improvements to test cases.
nanopb-0.3.4 (2015-09-26) Fix handling of unsigned 8- and 16-bit enums (issue 164) Fix generator on systems where python = python3. (issue 155) Fix compiler warning on GCC 5.x (issue 171) Make the generator better handle imported .protos (issue 165) Add packed\_enum option to generator. Add syntax= line to .proto files (issue 167) Add PlatformIO registry manifest file. (pr 156)
nanopb-0.3.3 (2015-04-10) Fix missing files in Linux binary package (issue 146) Fix generator bug when oneof is first field in a message. (issue 142) Fix generator error when long\_names:false is combined with Oneofs. (issue 147) Fix oneof submessage initialization bug. (issue 149) Fix problem with plugin options on Python 2.7.2 and older. (issue 153) Fix crash when callback is inside oneof field. (issue 148) Switch to .tar.gz format for Mac OS X packages. (issue 154) Always define enum long names so that cross-file references work. (issue 118) Add msgid generator option. (issue 151) Improve comment support in .options files. (issue 145) Updates for the CMake rule file, add cmake example. Better error messages for syntax errors in .options file
nanopb-0.3.2 (2015-01-24) Fix memory leaks with PB\_ENABLE\_MALLOC with some submessage hierarchies (issue 138) Implement support for oneofs (C unions). (issues 131, 141) Add int\_size option for generator (issue 139) Add compilation option to disable struct packing. (issue 136) Change PB\_RETURN\_ERROR() macro to avoid compiler warnings (issue 140) Fix build problems with protoc 3.0.0 Add support for POINTER type in extensions Initialize also extension fields to defaults in pb\_decode(). Detect too large varint values when decoding.
nanopb-0.3.1 (2014-09-11) Fix security issue due to size\_t overflows. (issue 132) Fix memory leak with duplicated fields and PB\_ENABLE\_MALLOC Fix crash if pb\_release() is called twice. Fix cyclic message support (issue 130) Fix error in generated initializers for repeated pointer fields. Improve tests (issues 113, 126)
nanopb-0.3.0 (2014-08-26) NOTE: See docs/migration.html or online at http://koti.kapsi.fi/~jpa/nanopb/docs/migration.html for changes in this version. Most importantly, you need to add pb\_common.c to the list of files to compile.
 Separated field iterator logic to pb\_common.c (issue 128) Change the \_count fields to use pb\_size\_t datatype (issue 82) Added PB\_ prefix to macro names (issue 106) Added #if version guard to generated files (issue 129) Added migration document
nanopb-0.2.9.5 (2020-06-23) Fix buffer overflow when encoding bytes with size set to 65535 (#547, GHSA-3p39-mfxg-hrq4) Backport Python 3 and protoc 3.x fixes to test cases
nanopb-0.2.9.4 (2020-02-02) Fix invalid free() after failed realloc() (GHSA-gcx3-7m76-287p) Add workaround for avr-libc realloc() bug (#475)
nanopb-0.2.9.3 (2016-06-19) Protect against corrupted \_count fields in pb\_release (#205)
nanopb-0.2.9.2 (2015-01-24) Fix memory leaks with PB\_ENABLE\_MALLOC with some submessage hierarchies (issue 138) Fix compilation error with generated initializers for repeated pointer fields
nanopb-0.2.9.1 (2014-09-11) Fix security issue due to size\_t overflows. (issue 132) Fix memory leak with duplicated fields and PB\_ENABLE\_MALLOC Fix crash if pb\_release() is called twice.
nanopb-0.2.9 (2014-08-09) NOTE: If you are using the -e option with the generator, you have to prepend . to the argument to get the same behaviour as before.
 Do not automatically add a dot with generator -e option. (issue 122) Fix problem with .options file and extension fields. (issue 125) Don't use SIZE\_MAX macro, as it is not in C89. (issue 120) Generate #defines for initializing message structures. (issue 79) Add skip\_message option to generator. (issue 121) Add PB\_PACKED\_STRUCT support for Keil MDK-ARM toolchain (issue 119) Give better messages about the .options file path. (issue 124) Improved tests
nanopb-0.2.8 (2014-05-20) Fix security issue with PB\_ENABLE\_MALLOC. (issue 117) Add option to not add timestamps to .pb.h and .pb.c preambles. (issue 115) Documentation updates Improved tests
nanopb-0.2.7 (2014-04-07) Fix bug with default values for extension fields (issue 111) Fix some MISRA-C warnings (issue 91) Implemented optional malloc() support (issue 80) Changed pointer-type bytes field datatype Add a "found" field to pb\_extension\_t (issue 112) Add convenience function pb\_get\_encoded\_size() (issue 16)
nanopb-0.2.6 (2014-02-15) Fix generator error with bytes callback fields (issue 99) Fix warnings about large integer constants (issue 102) Add comments to where STATIC\_ASSERT is used (issue 96) Add warning about unknown field names on .options (issue 105) Move descriptor.proto to google/protobuf subdirectory (issue 104) Improved tests
nanopb-0.2.5 (2014-01-01) Fix a bug with encoding negative values in int32 fields (issue 97) Create binary packages of the generator + dependencies (issue 47) Add support for pointer-type fields to the encoder (part of issue 80) Fixed path in FindNanopb.cmake (issue 94) Improved tests
nanopb-0.2.4 (2013-11-07) Remove the deprecated NANOPB\_INTERNALS functions from public API. Document the security model. Check array and bytes max sizes when encoding (issue 90) Add #defines for maximum encoded message size (issue 89) Add #define tags for extension fields (issue 93) Fix MISRA C violations (issue 91) Clean up pb\_field\_t definition with typedefs.
nanopb-0.2.3 (2013-09-18) Improve compatibility by removing ternary operator from initializations (issue 88) Fix build error on Visual C++ (issue 84, patch by Markus Schwarzenberg) Don't stop on unsupported extension fields (issue 83) Add an example pb\_syshdr.h file for non-C99 compilers Reorganize tests and examples into subfolders (issue 63) Switch from Makefiles to scons for building the tests Make the tests buildable on Windows
nanopb-0.2.2 (2013-08-18) Add support for extension fields (issue 17) Fix unknown fields in empty message (issue 78) Include the field tags in the generated .pb.h file. Add pb\_decode\_delimited and pb\_encode\_delimited wrapper functions (issue 74) Add a section in top of pb.h for changing compilation settings (issue 76) Documentation improvements (issues 12, 77 and others) Improved tests
nanopb-0.2.1 (2013-04-14) NOTE: The default callback function signature has changed. If you don't want to update your code, define PB\_OLD\_CALLBACK\_STYLE.  Change the callback function to use void\*\* (issue 69) Add support for defining the nanopb options in a separate file (issue 12) Add support for packed structs in IAR and MSVC (in addition to GCC) (issue 66) Implement error message support for the encoder side (issue 7) Handle unterminated strings when encoding (issue 68) Fix bug with empty strings in repeated string callbacks (issue 73) Fix regression in 0.2.0 with optional callback fields (issue 70) Fix bugs with empty message types (issues 64, 65) Fix some compiler warnings on clang (issue 67) Some portability improvements (issues 60, 62) Various new generator options Improved tests
nanopb-0.2.0 (2013-03-02) NOTE: This release requires you to regenerate all .pb.c files. Files generated by older versions will not compile anymore.
 Reformat generated .pb.c files using macros (issue 58) Rename PB\_HTYPE\_ARRAY -> PB\_HTYPE\_REPEATED Separate PB\_HTYPE to PB\_ATYPE and PB\_HTYPE Move STATIC\_ASSERTs to .pb.c file Added CMake file (by Pavel Ilin) Add option to give file extension to generator (by Michael Haberler) Documentation updates
nanopb-0.1.9 (2013-02-13) Fixed error message bugs (issues 52, 56) Sanitize #ifndef filename (issue 50) Performance improvements Add compile-time option PB\_BUFFER\_ONLY Add Java package name to nanopb.proto Check for sizeof(double) == 8 (issue 54) Added generator option to ignore some fields. (issue 51) Added generator option to make message structs packed. (issue 49) Add more test cases.
nanopb-0.1.8 (2012-12-13) Fix bugs in the enum short names introduced in 0.1.7 (issues 42, 43) Fix STATIC\_ASSERT macro when using multiple .proto files. (issue 41) Fix missing initialization of istream.errmsg Make tests/Makefile work for non-gcc compilers (issue 40)
nanopb-0.1.7 (2012-11-11) Remove "skip" mode from pb\_istream\_t callbacks. Example implementation had a bug. (issue 37) Add option to use shorter names for enum values (issue 38) Improve options support in generator (issues 12, 30) Add nanopb version number to generated files (issue 36) Add extern "C" to generated headers (issue 35) Add names for structs to allow forward declaration (issue 39) Add buffer size check in example (issue 34) Fix build warnings on MS compilers (issue 33)
nanopb-0.1.6 (2012-09-02) Reorganize the field decoder interface (issue 2) Improve performance in submessage decoding (issue 28) Implement error messages in the decoder side (issue 7) Extended testcases (alltypes test is now complete). Fix some compiler warnings (issues 25, 26, 27, 32).
nanopb-0.1.5 (2012-08-04) Fix bug in decoder with packed arrays (issue 23). Extended testcases. Fix some compiler warnings.
nanopb-0.1.4 (2012-07-05) Add compile-time options for easy-to-use >255 field support. Improve the detection of missing required fields. Added example on how to handle union messages. Fix generator error with .proto without messages. Fix problems that stopped the code from compiling with some compilers. Fix some compiler warnings.
nanopb-0.1.3 (2012-06-12) Refactor the field encoder interface. Improve generator error messages (issue 5) Add descriptor.proto into the #include exclusion list Fix some compiler warnings.
nanopb-0.1.2 (2012-02-15) Make the generator to generate include for other .proto files (issue 4). Fixed generator not working on Windows (issue 3)
nanopb-0.1.1 (2012-01-14) Fixed bug in encoder with 'bytes' fields (issue 1). Fixed a bug in the generator that caused a compiler error on sfixed32 and sfixed64 fields. Extended testcases.
nanopb-0.1.0 (2012-01-06) First stable release.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_1939fbac_20250115_085853.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fsecurity%2Fadvisories%2FGHSA-7mv5-5mxh-qg88)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fsecurity%2Fadvisories%2FGHSA-7mv5-5mxh-qg88)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=nanopb%2Fnanopb)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nanopb](/nanopb)
/
**[nanopb](/nanopb/nanopb)**
Public

* [Notifications](/login?return_to=%2Fnanopb%2Fnanopb) You must be signed in to change notification settings
* [Fork
  873](/login?return_to=%2Fnanopb%2Fnanopb)
* [Star
   4.4k](/login?return_to=%2Fnanopb%2Fnanopb)

* [Code](/nanopb/nanopb)
* [Issues
  54](/nanopb/nanopb/issues)
* [Pull requests
  9](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects
  0](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

Additional navigation options

* [Code](/nanopb/nanopb)
* [Issues](/nanopb/nanopb/issues)
* [Pull requests](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

# Invalid free() call with oneofs and PB\_ENABLE\_MALLOC

Moderate

[PetteriAimonen](/PetteriAimonen)
published
GHSA-7mv5-5mxh-qg88
Mar 20, 2021

## Package

nanopb

## Affected versions

0.3.2 to 0.3.9.7, 0.4.0 to 0.4.4

## Patched versions

0.3.9.8, 0.4.5

## Description

### Impact

Decoding a specifically formed message can cause invalid `free()` or `realloc()` calls if the message type contains an `oneof` field, and the `oneof` directly contains both a pointer field and a non-pointer field. If the message data first contains the non-pointer field and then the pointer field, the data of the non-pointer field is incorrectly treated as if it was a pointer value. Such message data rarely occurs in normal messages, but it is a concern when untrusted data is parsed.

### Patches

Preliminary patch is available on git for [0.4.x](https://github.com/nanopb/nanopb/commit/e2f0ccf939d9f82931d085acb6df8e9a182a4261) and [0.3.x](https://github.com/nanopb/nanopb/commit/4a375a560651a86726e5283be85a9231fd0efe9c) branches. The fix will be released in versions 0.3.9.8 and 0.4.5 once testing has been completed.

### Workarounds

Following workarounds are available:

* Set the option `no_unions` for the oneof field. This will generate fields as separate instead of C union, and avoids triggering the problematic code.
* Set the type of all fields inside the oneof to `FT_POINTER`. This ensures that the data contained inside the `union` is always a valid pointer.
* Heap implementations that guard against invalid `free()` provide a partial mitigation. Depending on the message type, the pointer value may be attacker controlled and can be used to bypass heap protections.

### References

Bug report: [#647](https://github.com/nanopb/nanopb/issues/647)

### For more information

If you have any questions or comments about this advisory, comment on the bug report linked above.

### Severity

Moderate

### CVE ID

CVE-2021-21401

### Weaknesses

[CWE-763](/advisories?query=cwe%3A763)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d9ff46dd_20250115_085850.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fcommit%2Fe2f0ccf939d9f82931d085acb6df8e9a182a4261)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fcommit%2Fe2f0ccf939d9f82931d085acb6df8e9a182a4261)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=nanopb%2Fnanopb)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nanopb](/nanopb)
/
**[nanopb](/nanopb/nanopb)**
Public

* [Notifications](/login?return_to=%2Fnanopb%2Fnanopb) You must be signed in to change notification settings
* [Fork
  873](/login?return_to=%2Fnanopb%2Fnanopb)
* [Star
   4.4k](/login?return_to=%2Fnanopb%2Fnanopb)

* [Code](/nanopb/nanopb)
* [Issues
  54](/nanopb/nanopb/issues)
* [Pull requests
  9](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects
  0](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

Additional navigation options

* [Code](/nanopb/nanopb)
* [Issues](/nanopb/nanopb/issues)
* [Pull requests](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

## Commit

[Permalink](/nanopb/nanopb/commit/e2f0ccf939d9f82931d085acb6df8e9a182a4261)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix invalid free() with oneof ([#647](https://github.com/nanopb/nanopb/issues/647))

[Browse files](/nanopb/nanopb/tree/e2f0ccf939d9f82931d085acb6df8e9a182a4261)
Browse the repository at this point in the history

```
Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.
```

* Loading branch information

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&v=4)](/PetteriAimonen)

[PetteriAimonen](/nanopb/nanopb/commits?author=PetteriAimonen "View all commits by PetteriAimonen")
committed
Mar 20, 2021

1 parent
[9cbe4ae](/nanopb/nanopb/commit/9cbe4ae6b03ae4ac2a678861101a9d771a6522ce)

commit e2f0ccf

Showing
**1 changed file**
with
**8 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

8 changes: 8 additions & 0 deletions

8
[pb\_decode.c](#diff-a1a4995b5c41bb4c50673943cc47020d0797eab70616c7c922ba37354c9e8de4 "pb_decode.c")

Show comments

[View file](/nanopb/nanopb/blob/e2f0ccf939d9f82931d085acb6df8e9a182a4261/pb_decode.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1203,6 +1203,14 @@ static bool pb\_release\_union\_field(pb\_istream\_t \*stream, pb\_field\_iter\_t \*field) |
|  |  |  |
|  |  | pb\_release\_single\_field(&old\_field); |
|  |  |  |
|  |  | if (PB\_ATYPE(field->type) == PB\_ATYPE\_POINTER) |
|  |  | { |
|  |  | /\* Initialize the pointer to NULL to make sure it is valid |
|  |  | \* even in case of error return. \*/ |
|  |  | \*(void\*\*)field->pField = NULL; |
|  |  | field->pData = NULL; |
|  |  | } |
|  |  |  |
|  |  | return true; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e2f0ccf`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fcommit%2Fe2f0ccf939d9f82931d085acb6df8e9a182a4261) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_40f611cb_20250115_085852.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fissues%2F647)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fissues%2F647)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=nanopb%2Fnanopb)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nanopb](/nanopb)
/
**[nanopb](/nanopb/nanopb)**
Public

* [Notifications](/login?return_to=%2Fnanopb%2Fnanopb) You must be signed in to change notification settings
* [Fork
  873](/login?return_to=%2Fnanopb%2Fnanopb)
* [Star
   4.4k](/login?return_to=%2Fnanopb%2Fnanopb)

* [Code](/nanopb/nanopb)
* [Issues
  54](/nanopb/nanopb/issues)
* [Pull requests
  9](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects
  0](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

Additional navigation options

* [Code](/nanopb/nanopb)
* [Issues](/nanopb/nanopb/issues)
* [Pull requests](/nanopb/nanopb/pulls)
* [Actions](/nanopb/nanopb/actions)
* [Projects](/nanopb/nanopb/projects)
* [Security](/nanopb/nanopb/security)
* [Insights](/nanopb/nanopb/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnanopb%2Fnanopb%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnanopb%2Fnanopb%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Ill-formed oneof message leads to calling free on an arbitrary pointer #647

Closed

[var-const](/var-const) opened this issue
Mar 20, 2021
· 3 comments

Closed

# [Ill-formed oneof message leads to calling free on an arbitrary pointer](#top) #647

[var-const](/var-const) opened this issue
Mar 20, 2021
· 3 comments

Labels
[Component-Decoder](/nanopb/nanopb/labels/Component-Decoder)
[FixedInGit](/nanopb/nanopb/labels/FixedInGit)
[Priority-High](/nanopb/nanopb/labels/Priority-High)
[Type-Defect](/nanopb/nanopb/labels/Type-Defect)

## Comments

[![@var-const](https://avatars.githubusercontent.com/u/8216808?s=80&u=e2ca7ecd1d3a68f9bb360b4b233549cf237e60fc&v=4)](/var-const)

Copy link

### **[var-const](/var-const)** commented [Mar 20, 2021](#issue-836515067) • edited Loading

| This affects `0.3.9.7` (and probably lower versions, though I haven't checked) with `PB_ENABLE_MALLOC` enabled.  Specially crafted bytes can make `pb_decode` eventually call `pb_free` on an arbitrary pointer. Here's the smallest repro case I could make:  ``` /* // Equivalent to:  syntax = "proto3"; message Repro {   oneof value_type {     bool boolean_value = 1;     string bytes_value = 5;   } } */  typedef struct _Repro {     pb_size_t which_value_type;     union {         bool boolean_value;         pb_bytes_array_t *bytes_value;     }; } Repro;  const pb_field_t Repro_fields[] = {     PB_ANONYMOUS_ONEOF_FIELD(value_type,   1, BOOL    , ONEOF, STATIC  , FIRST, Repro, boolean_value, boolean_value, 0),     PB_ANONYMOUS_ONEOF_FIELD(value_type,   5, BYTES   , ONEOF, POINTER , UNION, Repro, bytes_value, bytes_value, 0),     PB_LAST_FIELD };  int main() {   const uint8_t bytes[] = {0x08, 0x08, 0x2d};   size_t size = 3;    pb_istream_t stream = pb_istream_from_buffer(bytes, size);   Repro repro{};   pb_decode(&stream, Repro_fields, &repro); } ```  Running this leads to:  ``` malloc: *** error for object 0x1: pointer being freed was not allocated  ```  I can repro this on both Linux and Mac.  What I believe happens is:   * the first two bytes are interpreted as `boolean_value` and result in [`iter.pData`](https://github.com/nanopb/nanopb/blob/c2d43e59d8ec880ed261366818f0cacc5c8cc2e6/pb_decode.c#L478) being [set to `1`](https://github.com/nanopb/nanopb/blob/c2d43e59d8ec880ed261366818f0cacc5c8cc2e6/pb_decode.c#L1328); * the third byte is interpreted as a field tag referring to `bytes_value`. Because there are no more bytes in the input, decoding the field fails (with `end-of-stream`). However, the current field is reset to `5` from `1` while `iter.pData` is not cleared and is still set to `1`; * seeing that decoding failed, `pb_decode` tries to release the message. `pb_release_single_field`, thinking that the current field is `5`, considers the contents of `iter.pData` to refer to a dynamically-allocated array and [calls `pb_free` on it](https://github.com/nanopb/nanopb/blob/c2d43e59d8ec880ed261366818f0cacc5c8cc2e6/pb_decode.c#L1243).   I'm not sure what the right fix would be -- perhaps `iter.pData` should be set to null when oneof fields are switched, or perhaps the current field should not be changed until it is successfully parsed?  Note that this is a potential security issue. I presume that if the first field was an integer, an arbitrary value could be written to it which would then be interpreted as an address and passed to `free`.  Note: this was found by OSS-Fuzz on Firestore (note that I have trimmed down the repro case from the original). |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=80&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

Copy link

Member

### **[PetteriAimonen](/PetteriAimonen)** commented [Mar 20, 2021](#issuecomment-803264106)

| Setting pData to NULL when starting to decode a pointer type oneof field sounds reasonable. This could be done in `pb_release_union_field()`. |
| --- |

All reactions

Sorry, something went wrong.

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)
[PetteriAimonen](/PetteriAimonen)
added
[Component-Decoder](/nanopb/nanopb/labels/Component-Decoder)
[Priority-High](/nanopb/nanopb/labels/Priority-High)
[Type-Defect](/nanopb/nanopb/labels/Type-Defect)
labels
[Mar 20, 2021](#event-4485325453)

[PetteriAimonen](/PetteriAimonen)
added a commit
that referenced
this issue
[Mar 20, 2021](#ref-commit-0aa1dab)
[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

`[Add testcase for](/nanopb/nanopb/commit/0aa1dab94a4deff4940a39eafeefdc5d8f3a107e "Add testcase for #647: invalid free with oneof") [#647](https://github.com/nanopb/nanopb/issues/647)[: invalid free with oneof](/nanopb/nanopb/commit/0aa1dab94a4deff4940a39eafeefdc5d8f3a107e "Add testcase for #647: invalid free with oneof")`

`[0aa1dab](/nanopb/nanopb/commit/0aa1dab94a4deff4940a39eafeefdc5d8f3a107e)`

[PetteriAimonen](/PetteriAimonen)
added a commit
that referenced
this issue
[Mar 20, 2021](#ref-commit-4a375a5)
[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

`[Fix invalid free() with oneof (](/nanopb/nanopb/commit/4a375a560651a86726e5283be85a9231fd0efe9c "Fix invalid free() with oneof (#647)

Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.")[#647](https://github.com/nanopb/nanopb/issues/647)[)](/nanopb/nanopb/commit/4a375a560651a86726e5283be85a9231fd0efe9c "Fix invalid free() with oneof (#647)

Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.")`
…

`[4a375a5](/nanopb/nanopb/commit/4a375a560651a86726e5283be85a9231fd0efe9c)`

```
Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.
```

[PetteriAimonen](/PetteriAimonen)
added a commit
that referenced
this issue
[Mar 20, 2021](#ref-commit-9cbe4ae)
[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

`[Add testcase for](/nanopb/nanopb/commit/9cbe4ae6b03ae4ac2a678861101a9d771a6522ce "Add testcase for #647: invalid free with oneof") [#647](https://github.com/nanopb/nanopb/issues/647)[: invalid free with oneof](/nanopb/nanopb/commit/9cbe4ae6b03ae4ac2a678861101a9d771a6522ce "Add testcase for #647: invalid free with oneof")`

`[9cbe4ae](/nanopb/nanopb/commit/9cbe4ae6b03ae4ac2a678861101a9d771a6522ce)`

[PetteriAimonen](/PetteriAimonen)
added a commit
that referenced
this issue
[Mar 20, 2021](#ref-commit-e2f0ccf)
[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

`[Fix invalid free() with oneof (](/nanopb/nanopb/commit/e2f0ccf939d9f82931d085acb6df8e9a182a4261 "Fix invalid free() with oneof (#647)

Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.")[#647](https://github.com/nanopb/nanopb/issues/647)[)](/nanopb/nanopb/commit/e2f0ccf939d9f82931d085acb6df8e9a182a4261 "Fix invalid free() with oneof (#647)

Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.")`
…

`[e2f0ccf](/nanopb/nanopb/commit/e2f0ccf939d9f82931d085acb6df8e9a182a4261)`

```
Nanopb would call free() or realloc() on an invalid
(attacker controlled) pointer value when all the following
conditions are true:

- PB_ENABLE_MALLOC is defined at the compile time
- Message definition contains an oneof field, and the oneof
  contains at least one pointer type field and at least one
  non-pointer type field.
- Data being decoded first contains a non-pointer value for
  the oneof field, and later contains an overwriting pointer
  value.

Depending on message layout, the bug may not be exploitable in all
cases, but it is known to be exploitable at least with string and
bytes fields. Actual security impact will also depend on the heap
implementation used.
```

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=80&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

Copy link

Member

### **[PetteriAimonen](/PetteriAimonen)** commented [Mar 20, 2021](#issuecomment-803270964)

| Security advisory: [GHSA-7mv5-5mxh-qg88](https://github.com/nanopb/nanopb/security/advisories/GHSA-7mv5-5mxh-qg88 "GHSA-7mv5-5mxh-qg88")  I'm still a bit surprised why this hasn't been caught by the existing fuzztest. It seems the same issue should occur even with submessages, as used in `alltypes_pointer` test case, causing invalid value to be passed to `realloc()` instead of `free()`. But in any case, I should still expand the fuzz test to have string, bytes and integer fields inside the oneof.  Yet another bug that could potentially have been found with [#143](https://github.com/nanopb/nanopb/issues/143). |
| --- |

All reactions

Sorry, something went wrong.

[PetteriAimonen](/PetteriAimonen)
added a commit
that referenced
this issue
[Mar 22, 2021](#ref-commit-0a03bdf)
[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

`[fuzztest: Better coverage of static data in oneof (](/nanopb/nanopb/commit/0a03bdfbb543fc62adbe150993f221646edb61f1 "fuzztest: Better coverage of static data in oneof (#647)

Previously added static_message member of the oneof
had the shortcoming that the first member of the submessage
was also a pointer. So when it aliased with a pointer to a message,
it was still a valid NULL pointer.")[#647](https://github.com/nanopb/nanopb/issues/647)[)](/nanopb/nanopb/commit/0a03bdfbb543fc62adbe150993f221646edb61f1 "fuzztest: Better coverage of static data in oneof (#647)

Previously added static_message member of the oneof
had the shortcoming that the first member of the submessage
was also a pointer. So when it aliased with a pointer to a message,
it was still a valid NULL pointer.")`
…

`[0a03bdf](/nanopb/nanopb/commit/0a03bdfbb543fc62adbe150993f221646edb61f1)`

```
Previously added static_message member of the oneof
had the shortcoming that the first member of the submessage
was also a pointer. So when it aliased with a pointer to a message,
it was still a valid NULL pointer.
```

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)
[PetteriAimonen](/PetteriAimonen)
added
the
[FixedInGit](/nanopb/nanopb/labels/FixedInGit)
label
[Mar 22, 2021](#event-4489419755)

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=80&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)

Copy link

Member

### **[PetteriAimonen](/PetteriAimonen)** commented [Mar 22, 2021](#issuecomment-804141161)

| Fix released in 0.3.9.8 and 0.4.5. |
| --- |

All reactions

Sorry, something went wrong.

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=40&u=14ce5a89695c2e2e9f4a45948345741e7c9ea90a&v=4)](/PetteriAimonen)
[PetteriAimonen](/PetteriAimonen)
closed this as [completed](/nanopb/nanopb/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Mar 22, 2021](#event-4490764380)

This was referenced Dec 15, 2023

[CVE-apply：In Nanopb before versions 0.3.9.8 and 0.4.5, decoding a specifically formed message can cause invalid `free()` or `realloc()` calls if the message type contains an `oneof` field, and the `oneof` directly contains both a pointer field and a non-pointer field.
cxong/cdogs-sdl#829](/cxong/cdogs-sdl/issues/829)

Closed

[CVE apply: nanopb/maply\_pb\_decode.c has invalid free() with oneof
mousebird-consulting-inc/WhirlyGlobe#1601](/mousebird-consulting-inc/WhirlyGlobe/issues/1601)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fnanopb%2Fnanopb%2Fissues%2F647)

Assignees

No one assigned

Labels

[Component-Decoder](/nanopb/nanopb/labels/Component-Decoder)
[FixedInGit](/nanopb/nanopb/labels/FixedInGit)
[Priority-High](/nanopb/nanopb/labels/Priority-High)
[Type-Defect](/nanopb/nanopb/labels/Type-Defect)

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@PetteriAimonen](https://avatars.githubusercontent.com/u/922265?s=52&v=4)](/PetteriAimonen) [![@var-const](https://avatars.githubusercontent.com/u/8216808?s=52&v=4)](/var-const)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


