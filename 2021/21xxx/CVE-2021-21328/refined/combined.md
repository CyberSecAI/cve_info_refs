=== Content from vapor.codes_f78aaa49_20250114_203746.html ===
[Vapor](/)Toggle Navigation

* [Home](/)
* [Showcase](/showcase)
* Documentation
  + [Framework DocsLearn how to use Vapor](https://docs.vapor.codes)
  + [API DocsReference documentation for Vapor](https://api.vapor.codes)
* [Team](/team)
* [Blog](https://blog.vapor.codes)
* [GitHub](https://github.com/vapor)
Vapor
# Swift, but on a server

### Vapor provides a safe, performant and easy to use foundation to build HTTP servers, backends and APIs in Swift

[Get Started](https://docs.vapor.codes/)[... stars on GitHub](https://github.com/vapor/vapor)
```
import Vapor

let app = try await Application.make(.detect())

app.get("hello") { req in
    "Hello, world!"
}

try await app.execute()

```
##### Powering companies like:

[John Lewis](https://johnlewis.com)[Swift Package Index](https://swiftpackageindex.com)[Allegro](https://allegro.pl)
## Build server side with the tooling you already understand

No need to learn a language from scratch (or assemble a different team) just for your backend. Vapor is built on Appleâs SwiftNIO so youâll get to use the language you already know and love.

### Vapor

Build efficient APIs in a language you love. Create routes, send and receive JSON and build HTTP servers.

[Learn More](https://docs.vapor.codes/)
### Fluent

Create models and interact with your database in native, safe Swift code without needing to write any SQL

[Learn More](https://docs.vapor.codes/fluent/overview/)
### JWT

Create, sign and verify JSON Web Tokens in Swift. Built on top of SwiftNIO

[Learn More](https://docs.vapor.codes/security/jwt/)
### Leaf

A templating engine written in Swift. Generate HTML for both web apps and emails with a simple syntax anyone can use

[Learn More](https://docs.vapor.codes/leaf/overview/)
## High-performant APIs and servers

Built with a non-blocking, event-driven architecture, Vapor allows you to build high-performant, scalable APIs and HTTP servers. Using Swift's Concurrency model, you can write clear, maintainable code that's efficient and easy to read.

[Get Started](https://docs.vapor.codes/)
```
app.get("todos", ":id") { req async throws -> Todo in
  let id: UUID = try req.parameters.require("id")

  guard
    let todo = try await Todo.find(id, on: req.db)
  else {
    throw Abort(.notFound)
  }

  return todo
}
```
## Ship with confidence, even on Fridays

With Vapor's expressive, protocol oriented design, you'll have peace of mind when shipping your code. With our strong type-safety focus, many errors and problems are caught early on by the compiler.

[Get Started](https://docs.vapor.codes/)
```
func search(req: Request) async throws -> [Todo] {
  let name: String = try req.query.get(at: "name")

  let results = try await Todo.query(on: req.db)
    .filter(\.$number == name)
    .all()

  return results
}
```
Binary operator '==' cannot be applied to operands of type 'KeyPath<Todo,
FieldProperty<Todo, Int>>' and 'String'Integrations
## Full integration with your entire stack

Vapor's mature ecosystem includes over a hundred official and community maintained server-first Swift packages to make building your applications easy and efficient.

[Get Started](https://docs.vapor.codes/)![Vapor Integrations](https://design.vapor.codes/images/integrations.png)
### Used by the teams behind these amazing apps

[See full list](/showcase)![SwiftFiddle Card](https://design.vapor.codes/images/swiftfiddle-card.png)
##### SwiftFiddle

SwiftFiddle is an online playground for creating, sharing and embedding Swift fiddles

[See it in action](https://swiftfiddle.com)![SwiftPackageIndex Card](/static/images/showcase/swift-package-index.png)
##### SwiftPackageIndex

The Swift Package Index is a searchable index of Swift packages and their compatibility with various platforms.

[See it in action](https://swiftpackageindex.com)![Underway NYC Card](https://design.vapor.codes/images/underway-nyc-card.png)
##### Underway NYC

Quickly locate yourself on the official MTA map of NYC and get real-time train arrivals at that subway stop

[See it in action](https://www.underway.nyc)![Litmaps Card](/static/images/showcase/litmaps.png)
##### Litmaps

Litmaps is a browser-based research platform designed for clarity, comprehensiveness, and collaboration.

[See it in action](https://litmaps.com)Previous ShowcaseNext Showcase![Vapor Discord server](https://design.vapor.codes/images/discord-chat.png)
## Join the largest community of Swift backend developers

Vapor's 13k+ Discord community will be at your side to support you along the way. Ask questions, contribute and be a part of a thriving, wholesome corner of the internet.

[Join our Discord](https://vapor.team/)[Contribute](https://github.com/vapor/vapor)
## Get all the tools you need to build with Swift

[Get Started](https://docs.vapor.codes/)[Go to API Docs](https://api.vapor.codes/)
## Get all the tools you need to build with Swift

* Easily create new projects with the Vapor Toolbox
* Expansive documentation and API reference
* Everything you need to build backends and APIs
* Full support for Swift's concurrency model
### Supported by our incredible sponsors and backers

[Become a supporter](https://github.com/sponsors/vapor)![Broken Hands](/static/images/sponsors/brokenhands.png)
##### Broken Hands

Providing Vapor training and consulting for clients around the world.

[Learn More](https://www.brokenhands.io/)![omrd](/static/images/sponsors/omrd.png)
##### omrd

omrd provides consultation services for dental elated scans.

[Learn More](https://omrd.com)![Emerge Tools](/static/images/sponsors/emerge-tools.png)
##### Emerge Tools

Emerge Tools is a suite of revolutionary products designed to supercharge mobile apps and the teams that build them.

[Learn More](https://www.emergetools.com)Previous SponsorsNext SponsorsVapor provides a safe, performant and easy to use foundation to build HTTP servers, backends and APIs in Swift
###### Community

* [Team](/team)
* [Join our Discord](https://vapor.team)
* [Evangelists](/evangelists)
* [Showcase](/showcase)
* [Supporters](/supporters)
###### Resources

* [Blog](https://blog.vapor.codes)
* [Framework Docs](https://docs.vapor.codes)
* [API Docs](https://api.vapor.codes)
* [Press Kit](https://design.vapor.codes/VaporPressKit.zip)
* [Help](https://vapor.team)

---

© QuTheory, LLC 2024

* [Twitter](https://twitter.com/codevapor)
* [Mastodon](https://hachyderm.io/%40codevapor)
* [GitHub](https://github.com/vapor)


=== Content from github.com_e77c60fa_20250114_203745.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Freleases%2Ftag%2F4.40.1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Freleases%2Ftag%2F4.40.1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=vapor%2Fvapor)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vapor](/vapor)
/
**[vapor](/vapor/vapor)**
Public

* [Notifications](/login?return_to=%2Fvapor%2Fvapor) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fvapor%2Fvapor)
* [Star
   24.7k](/login?return_to=%2Fvapor%2Fvapor)

* [Code](/vapor/vapor/tree/4.40.1)
* [Issues
  84](/vapor/vapor/issues)
* [Pull requests
  11](/vapor/vapor/pulls)
* [Actions](/vapor/vapor/actions)
* [Security](/vapor/vapor/security)
* [Insights](/vapor/vapor/pulse)

Additional navigation options

* [Code](/vapor/vapor/tree/4.40.1)
* [Issues](/vapor/vapor/issues)
* [Pull requests](/vapor/vapor/pulls)
* [Actions](/vapor/vapor/actions)
* [Security](/vapor/vapor/security)
* [Insights](/vapor/vapor/pulse)

1. [Releases](/vapor/vapor/releases)
2. [4.40.1](/vapor/vapor/releases/tag/4.40.1)

# Rewrite metrics path and method to undefined for unknown routes

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/vapor/vapor/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...4.40.1)

 Loading

[View all tags](/vapor/vapor/tags)

![@0xTim](https://avatars.githubusercontent.com/u/9938337?s=40&v=4)
[0xTim](/0xTim)
released this
22 Feb 16:21

[4.40.1](/vapor/vapor/tree/4.40.1)

[`e3aa712`](/vapor/vapor/commit/e3aa712508db2854ac0ab905696c65fd88fa7e23)

This commit was created on GitHub.com and signed with GitHub’s **verified signature**.
The key has expired.

GPG key ID: 4AEE18F83AFDEB23
Expired

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

Fixes an issue where an attacker could perform a denial of service attack against a Vapor application using Metrics. By sending requests to either dynamic paths with values that return a 404 or unknown paths, unlimited counters and timers could be created. This could potentially drain the system and cause knock-on effect on downstream systems.

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3dae160f_20250114_203743.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Fcommit%2Fe3aa712508db2854ac0ab905696c65fd88fa7e23)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Fcommit%2Fe3aa712508db2854ac0ab905696c65fd88fa7e23)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=vapor%2Fvapor)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vapor](/vapor)
/
**[vapor](/vapor/vapor)**
Public

* [Notifications](/login?return_to=%2Fvapor%2Fvapor) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fvapor%2Fvapor)
* [Star
   24.7k](/login?return_to=%2Fvapor%2Fvapor)

* [Code](/vapor/vapor)
* [Issues
  84](/vapor/vapor/issues)
* [Pull requests
  11](/vapor/vapor/pulls)
* [Actions](/vapor/vapor/actions)
* [Security](/vapor/vapor/security)
* [Insights](/vapor/vapor/pulse)

Additional navigation options

* [Code](/vapor/vapor)
* [Issues](/vapor/vapor/issues)
* [Pull requests](/vapor/vapor/pulls)
* [Actions](/vapor/vapor/actions)
* [Security](/vapor/vapor/security)
* [Insights](/vapor/vapor/pulse)

## Commit

[Permalink](/vapor/vapor/commit/e3aa712508db2854ac0ab905696c65fd88fa7e23)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-gcj9-jj38-hwmc](https://github.com/advisories/GHSA-gcj9-jj38-hwmc "GHSA-gcj9-jj38-hwmc")

[Browse files](/vapor/vapor/tree/e3aa712508db2854ac0ab905696c65fd88fa7e23)
Browse the repository at this point in the history

```
* Start backfilling some tests for metrics

* Add failing test for not found route

* Rewrite 404 path to avoid DOS attack

* Failing test to distinguish between undefined routes and routes that return a 404

* Finalise path expressions

* Don't crash the tests by bootstrapping multiple times

* Tests passing

* Make tests non-throwing

* Check request.route instead of adding new bool

* Update Tests/VaporTests/Utilities/CapturingMetricsSystem.swift

Co-authored-by: Gwynne Raskind <gwynne@darkrainfall.org>

* Add attribution for CapturingMetricsSystem

* Update Tests/VaporTests/Utilities/CapturingMetricsSystem.swift

Co-authored-by: Gwynne Raskind <gwynne@darkrainfall.org>

* Remove last uses of NSUUID

* Revert change to stop the tests crashing

* Backfill more tests

* Migrate CapturingMetricsSystem to NIOConcurrencyHelpers

* Ensure undefined route methods get mapped to undefined

* Add tests for the timers as well

* Reuse dimensions for the timer as well

* Rewrite undefined routes' method to undefined as well as the path

* Avoid duplicating the method in the path

* Add comment for rewriting path in metrics

* Add test to ensure we don't pass through the ID for a dynamic path

* Fix typo in comment

Co-authored-by: Gwynne Raskind <gwynne@darkrainfall.org>
```

* Loading branch information

[![@0xTim](https://avatars.githubusercontent.com/u/9938337?s=40&v=4)](/0xTim) [![@gwynne](https://avatars.githubusercontent.com/u/1130717?s=40&v=4)](/gwynne)

[0xTim](/vapor/vapor/commits?author=0xTim "View all commits by 0xTim")
and
[gwynne](/vapor/vapor/commits?author=gwynne "View all commits by gwynne")
authored
Feb 22, 2021

1 parent
[b23d83a](/vapor/vapor/commit/b23d83affa779fefe575f170e6abab63b428c2fa)

commit e3aa712

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**349 additions**
and
**14 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* NOTICES.txt
  [NOTICES.txt](#diff-1ea19b22a3e7c2d04320ee3b08ec8a77f89db8e2f392c018a44a89951d96aba1)
* Sources/Vapor/Responder

  + Sources/Vapor/Responder/DefaultResponder.swift
    [DefaultResponder.swift](#diff-f8b55d7f3df6aa3724f57ce51781cb948cd101018091ec6e5c85b25986ed96e3)
* Tests/VaporTests

  + Tests/VaporTests/MetricsTests.swift
    [MetricsTests.swift](#diff-77e1503952c38cd38bdaf7342cf87e7d104eb47dcdd76ee296fd496e7e538d20)
  + Utilities

    - Tests/VaporTests/Utilities/CapturingMetricsSystem.swift
      [CapturingMetricsSystem.swift](#diff-b5fc4db37ce170f45c60a8a52c982364951547a13ce5c6d333d297cf0ae66dba)

## There are no files selected for viewing

21 changes: 21 additions & 0 deletions

21
[NOTICES.txt](#diff-1ea19b22a3e7c2d04320ee3b08ec8a77f89db8e2f392c018a44a89951d96aba1 "NOTICES.txt")

Show comments

[View file](/vapor/vapor/blob/e3aa712508db2854ac0ab905696c65fd88fa7e23/NOTICES.txt)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,21 @@ |
|  |  |  |
|  |  | //===----------------------------------------------------------------------===// |
|  |  | // |
|  |  | // This source file is part of the Vapor open source project |
|  |  | // |
|  |  | // Copyright (c) 2017-2021 Vapor project authors |
|  |  | // Licensed under MIT |
|  |  | // |
|  |  | // See LICENSE for license information |
|  |  | // |
|  |  | // SPDX-License-Identifier: MIT |
|  |  | // |
|  |  | //===----------------------------------------------------------------------===// |
|  |  |  |
|  |  | This product contains a derivation of the TestMetrics test implementation |
|  |  | from Swift Metrics. |
|  |  |  |
|  |  | \* LICENSE (Apache License 2.0): |
|  |  | \* https://www.apache.org/licenses/LICENSE-2.0 |
|  |  | \* HOMEPAGE: |
|  |  | \* https://github.com/apple/swift-metrics |

38 changes: 24 additions & 14 deletions

38
[Sources/Vapor/Responder/DefaultResponder.swift](#diff-f8b55d7f3df6aa3724f57ce51781cb948cd101018091ec6e5c85b25986ed96e3 "Sources/Vapor/Responder/DefaultResponder.swift")

Show comments

[View file](/vapor/vapor/blob/e3aa712508db2854ac0ab905696c65fd88fa7e23/Sources/Vapor/Responder/DefaultResponder.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -41,13 +41,10 @@ internal struct DefaultResponder: Responder { |
|  |  | public func respond(to request: Request) -> EventLoopFuture<Response> { |
|  |  | let startTime = DispatchTime.now().uptimeNanoseconds |
|  |  | let response: EventLoopFuture<Response> |
|  |  | let path: String |
|  |  | if let cachedRoute = self.getRoute(for: request) { |
|  |  | path = cachedRoute.route.description |
|  |  | request.route = cachedRoute.route |
|  |  | response = cachedRoute.responder.respond(to: request) |
|  |  | } else { |
|  |  | path = request.url.path |
|  |  | response = self.notFoundResponder.respond(to: request) |
|  |  | } |
|  |  | return response.always { result in |
| Expand All | | @@ -60,7 +57,6 @@ internal struct DefaultResponder: Responder { |
|  |  | } |
|  |  | self.updateMetrics( |
|  |  | for: request, |
|  |  | path: path, |
|  |  | startTime: startTime, |
|  |  | statusCode: status.code |
|  |  | ) |
| Expand All | | @@ -83,25 +79,39 @@ internal struct DefaultResponder: Responder { |
|  |  | /// Records the requests metrics. |
|  |  | private func updateMetrics( |
|  |  | for request: Request, |
|  |  | path: String, |
|  |  | startTime: UInt64, |
|  |  | statusCode: UInt |
|  |  | ) { |
|  |  | let counterDimensions = [ |
|  |  | ("method", request.method.string), |
|  |  | ("path", path), |
|  |  | let pathForMetrics: String |
|  |  | if let route = request.route { |
|  |  | // We don't use route.description here to avoid duplicating the method in the path |
|  |  | pathForMetrics = "/\(route.path.map { "\($0)" }.joined(separator: "/"))" |
|  |  | } else { |
|  |  | // If the route is undefined (i.e. a 404 and not something like /users/:userID |
|  |  | // We rewrite the path and the method to undefined to avoid DOSing the |
|  |  | // application and any downstream metrics systems. Otherwise an attacker |
|  |  | // could spam the service with unlimited requests and exhaust the system |
|  |  | // with unlimited timers/counters |
|  |  | pathForMetrics = "vapor\_route\_undefined" |
|  |  | } |
|  |  | let methodForMetrics: String |
|  |  | if request.route == nil { |
|  |  | methodForMetrics = "undefined" |
|  |  | } else { |
|  |  | methodForMetrics = request.method.string |
|  |  | } |
|  |  | let dimensions = [ |
|  |  | ("method", methodForMetrics), |
|  |  | ("path", pathForMetrics), |
|  |  | ("status", statusCode.description), |
|  |  | ] |
|  |  | Counter(label: "http\_requests\_total", dimensions: counterDimensions).increment() |
|  |  | Counter(label: "http\_requests\_total", dimensions: dimensions).increment() |
|  |  | if statusCode >= 500 { |
|  |  | Counter(label: "http\_request\_errors\_total", dimensions: counterDimensions).increment() |
|  |  | Counter(label: "http\_request\_errors\_total", dimensions: dimensions).increment() |
|  |  | } |
|  |  | Timer( |
|  |  | label: "http\_request\_duration\_seconds", |
|  |  | dimensions: [ |
|  |  | ("method", request.method.string), |
|  |  | ("path", path) |
|  |  | ], |
|  |  | dimensions: dimensions, |
|  |  | preferredDisplayUnit: .seconds |
|  |  | ).recordNanoseconds(DispatchTime.now().uptimeNanoseconds - startTime) |
|  |  | } |
| Expand Down | |  |

126 changes: 126 additions & 0 deletions

126
[Tests/VaporTests/MetricsTests.swift](#diff-77e1503952c38cd38bdaf7342cf87e7d104eb47dcdd76ee296fd496e7e538d20 "Tests/VaporTests/MetricsTests.swift")

Show comments

[View file](/vapor/vapor/blob/e3aa712508db2854ac0ab905696c65fd88fa7e23/Tests/VaporTests/MetricsTests.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,126 @@ |
|  |  | import XCTVapor |
|  |  | import Vapor |
|  |  | import Metrics |
|  |  | @testable import CoreMetrics |
|  |  |  |
|  |  | class MetricsTests: XCTestCase { |
|  |  | func testMetricsIncreasesCounter() { |
|  |  | let metrics = CapturingMetricsSystem() |
|  |  | MetricsSystem.bootstrapInternal(metrics) |
|  |  |  |
|  |  | let app = Application(.testing) |
|  |  | defer { app.shutdown() } |
|  |  |  |
|  |  | struct User: Content { |
|  |  | let id: Int |
|  |  | let name: String |
|  |  | } |
|  |  |  |
|  |  | app.routes.get("users", ":userID") { req -> User in |
|  |  | let userID = try req.parameters.require("userID", as: Int.self) |
|  |  | if userID == 1 { |
|  |  | return User(id: 1, name: "Tim") |
|  |  | } else { |
|  |  | throw Abort(.notFound) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | XCTAssertNoThrow(try app.testable().test(.GET, "/users/1") { res in |
|  |  | XCTAssertEqual(res.status, .ok) |
|  |  | let resData = try res.content.decode(User.self) |
|  |  | XCTAssertEqual(resData.id, 1) |
|  |  | XCTAssertEqual(metrics.counters.count, 1) |
|  |  | let counter = metrics.counters["http\_requests\_total"] as! TestCounter |
|  |  | print(counter.dimensions) |
|  |  | let pathDimension = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "path"})) |
|  |  | XCTAssertEqual(pathDimension.1, "/users/:userID") |
|  |  | XCTAssertNil(counter.dimensions.first(where: { $0.0 == "path" && $0.1 == "/users/1" })) |
|  |  | let methodDimension = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "method"})) |
|  |  | XCTAssertEqual(methodDimension.1, "GET") |
|  |  | let status = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "status"})) |
|  |  | XCTAssertEqual(status.1, "200") |
|  |  |  |
|  |  | let timer = metrics.timers["http\_request\_duration\_seconds"] as! TestTimer |
|  |  | let timerPathDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "path"})) |
|  |  | XCTAssertEqual(timerPathDimension.1, "/users/:userID") |
|  |  | let timerMethodDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "method"})) |
|  |  | XCTAssertEqual(timerMethodDimension.1, "GET") |
|  |  | let timerStatusDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "status"})) |
|  |  | XCTAssertEqual(timerStatusDimension.1, "200") |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | func testID404DoesntSpamMetrics() { |
|  |  | let metrics = CapturingMetricsSystem() |
|  |  | MetricsSystem.bootstrapInternal(metrics) |
|  |  |  |
|  |  | let app = Application(.testing) |
|  |  | defer { app.shutdown() } |
|  |  |  |
|  |  | struct User: Content { |
|  |  | let id: Int |
|  |  | let name: String |
|  |  | } |
|  |  |  |
|  |  | app.routes.get("users", ":userID") { req -> User in |
|  |  | let userID = try req.parameters.require("userID", as: Int.self) |
|  |  | if userID == 1 { |
|  |  | return User(id: 1, name: "Tim") |
|  |  | } else { |
|  |  | throw Abort(.notFound) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | XCTAssertNoThrow(try app.testable().test(.GET, "/users/2") { res in |
|  |  | XCTAssertEqual(res.status, .notFound) |
|  |  | let counter = metrics.counters["http\_requests\_total"] as! TestCounter |
|  |  | let pathDimension = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "path"})) |
|  |  | XCTAssertEqual(pathDimension.1, "/users/:userID") |
|  |  | let methodDimension = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "method"})) |
|  |  | XCTAssertEqual(methodDimension.1, "GET") |
|  |  | let status = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "status"})) |
|  |  | XCTAssertEqual(status.1, "404") |
|  |  | XCTAssertNil(counter.dimensions.first(where: { $0.1 == "200" })) |
|  |  | XCTAssertNil(counter.dimensions.first(where: { $0.0 == "path" && $0.1 == "/users/1" })) |
|  |  |  |
|  |  | let timer = metrics.timers["http\_request\_duration\_seconds"] as! TestTimer |
|  |  | let timerPathDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "path"})) |
|  |  | XCTAssertEqual(timerPathDimension.1, "/users/:userID") |
|  |  | let timerMethodDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "method"})) |
|  |  | XCTAssertEqual(timerMethodDimension.1, "GET") |
|  |  | let timerStatusDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "status"})) |
|  |  | XCTAssertEqual(timerStatusDimension.1, "404") |
|  |  | XCTAssertNil(timer.dimensions.first(where: { $0.1 == "200" })) |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | func test404RewritesPathForMetricsToAvoidDOSAttack() { |
|  |  | let metrics = CapturingMetricsSystem() |
|  |  | MetricsSystem.bootstrapInternal(metrics) |
|  |  |  |
|  |  | let app = Application(.testing) |
|  |  | defer { app.shutdown() } |
|  |  |  |
|  |  | XCTAssertNoThrow(try app.testable().test(.GET, "/not/found") { res in |
|  |  | XCTAssertEqual(res.status, .notFound) |
|  |  | XCTAssertEqual(metrics.counters.count, 1) |
|  |  | let counter = metrics.counters["http\_requests\_total"] as! TestCounter |
|  |  | let pathDimension = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "path"})) |
|  |  | XCTAssertEqual(pathDimension.1, "vapor\_route\_undefined") |
|  |  | let methodDimension = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "method"})) |
|  |  | XCTAssertEqual(methodDimension.1, "undefined") |
|  |  | let status = try XCTUnwrap(counter.dimensions.first(where: { $0.0 == "status"})) |
|  |  | XCTAssertEqual(status.1, "404") |
|  |  |  |
|  |  | let timer = metrics.timers["http\_request\_duration\_seconds"] as! TestTimer |
|  |  | let timerPathDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "path"})) |
|  |  | XCTAssertEqual(timerPathDimension.1, "vapor\_route\_undefined") |
|  |  | let timerMethodDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "method"})) |
|  |  | XCTAssertEqual(timerMethodDimension.1, "undefined") |
|  |  | let timerStatusDimension = try XCTUnwrap(timer.dimensions.first(where: { $0.0 == "status"})) |
|  |  | XCTAssertEqual(timerStatusDimension.1, "404") |
|  |  | XCTAssertNil(timer.dimensions.first(where: { $0.1 == "200" })) |
|  |  | }) |
|  |  | } |
|  |  | } |
|  |  |  |

178 changes: 178 additions & 0 deletions

178
[Tests/VaporTests/Utilities/CapturingMetricsSystem.swift](#diff-b5fc4db37ce170f45c60a8a52c982364951547a13ce5c6d333d297cf0ae66dba "Tests/VaporTests/Utilities/CapturingMetricsSystem.swift")

Show comments

[View file](/vapor/vapor/blob/e3aa712508db2854ac0ab905696c65fd88fa7e23/Tests/VaporTests/Utilities/CapturingMetricsSystem.swift)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,178 @@ |
|  |  | // ===----------------------------------------------------------------------===## |
|  |  | // |
|  |  | // This source file is part of the Vapor open source project |
|  |  | // |
|  |  | // Copyright (c) 2017-2021 Vapor project authors |
|  |  | // Licensed under MIT |
|  |  | // |
|  |  | // See LICENSE for license information |
|  |  | // |
|  |  | // SPDX-License-Identifier: MIT |
|  |  | // |
|  |  | // ===----------------------------------------------------------------------===## |
|  |  | // This was adapted from Swift Metrics's TestMetrics.swift code. |
|  |  | // The license for the original work is reproduced below. See NOTICES.txt for |
|  |  | // more. |
|  |  |  |
|  |  | import Metrics |
|  |  | import Foundation |
|  |  | import NIOConcurrencyHelpers |
|  |  |  |
|  |  | /// Metrics factory which allows inspecting recorded metrics programmatically. |
|  |  | /// Only intended for tests of the Metrics API itself. |
|  |  | internal final class CapturingMetricsSystem: MetricsFactory { |
|  |  | private let lock = Lock() |
|  |  | var counters = [String: CounterHandler]() |
|  |  | var recorders = [String: RecorderHandler]() |
|  |  | var timers = [String: TimerHandler]() |
|  |  |  |
|  |  | public func makeCounter(label: String, dimensions: [(String, String)]) -> CounterHandler { |
|  |  | return self.make(label: label, dimensions: dimensions, registry: &self.counters, maker: TestCounter.init) |
|  |  | } |
|  |  |  |
|  |  | public func makeRecorder(label: String, dimensions: [(String, String)], aggregate: Bool) -> RecorderHandler { |
|  |  | let maker = { (label: String, dimensions: [(String, String)]) -> RecorderHandler in |
|  |  | TestRecorder(label: label, dimensions: dimensions, aggregate: aggregate) |
|  |  | } |
|  |  | return self.make(label: label, dimensions: dimensions, registry: &self.recorders, maker: maker) |
|  |  | } |
|  |  |  |
|  |  | public func makeTimer(label: String, dimensions: [(String, String)]) -> TimerHandler { |
|  |  | return self.make(label: label, dimensions: dimensions, registry: &self.timers, maker: TestTimer.init) |
|  |  | } |
|  |  |  |
|  |  | private func make<Item>(label: String, dimensions: [(String, String)], registry: inout [String: Item], maker: (String, [(String, String)]) -> Item) -> Item { |
|  |  | return self.lock.withLock { |
|  |  | let item = maker(label, dimensions) |
|  |  | registry[label] = item |
|  |  | return item |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func destroyCounter(\_ handler: CounterHandler) { |
|  |  | if let testCounter = handler as? TestCounter { |
|  |  | self.counters.removeValue(forKey: testCounter.label) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func destroyRecorder(\_ handler: RecorderHandler) { |
|  |  | if let testRecorder = handler as? TestRecorder { |
|  |  | self.recorders.removeValue(forKey: testRecorder.label) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func destroyTimer(\_ handler: TimerHandler) { |
|  |  | if let testTimer = handler as? TestTimer { |
|  |  | self.timers.removeValue(forKey: testTimer.label) |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal class TestCounter: CounterHandler, Equatable { |
|  |  | let id: String |
|  |  | let label: String |
|  |  | let dimensions: [(String, String)] |
|  |  |  |
|  |  | let lock = Lock() |
|  |  | var values = [(Date, Int64)]() |
|  |  |  |
|  |  | init(label: String, dimensions: [(String, String)]) { |
|  |  | self.id = UUID().uuidString |
|  |  | self.label = label |
|  |  | self.dimensions = dimensions |
|  |  | } |
|  |  |  |
|  |  | func increment(by amount: Int64) { |
|  |  | self.lock.withLock { |
|  |  | self.values.append((Date(), amount)) |
|  |  | } |
|  |  | print("adding \(amount) to \(self.label)") |
|  |  | } |
|  |  |  |
|  |  | func reset() { |
|  |  | self.lock.withLock { |
|  |  | self.values = [] |
|  |  | } |
|  |  | print("resetting \(self.label)") |
|  |  | } |
|  |  |  |
|  |  | public static func == (lhs: TestCounter, rhs: TestCounter) -> Bool { |
|  |  | return lhs.id == rhs.id |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal class TestRecorder: RecorderHandler, Equatable { |
|  |  | let id: String |
|  |  | let label: String |
|  |  | let dimensions: [(String, String)] |
|  |  | let aggregate: Bool |
|  |  |  |
|  |  | let lock = Lock() |
|  |  | var values = [(Date, Double)]() |
|  |  |  |
|  |  | init(label: String, dimensions: [(String, String)], aggregate: Bool) { |
|  |  | self.id = UUID().uuidString |
|  |  | self.label = label |
|  |  | self.dimensions = dimensions |
|  |  | self.aggregate = aggregate |
|  |  | } |
|  |  |  |
|  |  | func record(\_ value: Int64) { |
|  |  | self.record(Double(value)) |
|  |  | } |
|  |  |  |
|  |  | func record(\_ value: Double) { |
|  |  | self.lock.withLock { |
|  |  | values.append((Date(), value)) |
|  |  | } |
|  |  | print("recording \(value) in \(self.label)") |
|  |  | } |
|  |  |  |
|  |  | public static func == (lhs: TestRecorder, rhs: TestRecorder) -> Bool { |
|  |  | return lhs.id == rhs.id |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal class TestTimer: TimerHandler, Equatable { |
|  |  | let id: String |
|  |  | let label: String |
|  |  | var displayUnit: TimeUnit? |
|  |  | let dimensions: [(String, String)] |
|  |  |  |
|  |  | let lock = Lock() |
|  |  | var values = [(Date, Int64)]() |
|  |  |  |
|  |  | init(label: String, dimensions: [(String, String)]) { |
|  |  | self.id = UUID().uuidString |
|  |  | self.label = label |
|  |  | self.displayUnit = nil |
|  |  | self.dimensions = dimensions |
|  |  | } |
|  |  |  |
|  |  | func preferDisplayUnit(\_ unit: TimeUnit) { |
|  |  | self.lock.withLock { |
|  |  | self.displayUnit = unit |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func retriveValueInPreferredUnit(atIndex i: Int) -> Double { |
|  |  | return self.lock.withLock { |
|  |  | let value = values[i].1 |
|  |  | guard let displayUnit = self.displayUnit else { |
|  |  | return Double(value) |
|  |  | } |
|  |  | return Double(value) / Double(displayUnit.scaleFromNanoseconds) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func recordNanoseconds(\_ duration: Int64) { |
|  |  | self.lock.withLock { |
|  |  | values.append((Date(), duration)) |
|  |  | } |
|  |  | print("recording \(duration) \(self.label)") |
|  |  | } |
|  |  |  |
|  |  | public static func == (lhs: TestTimer, rhs: TestTimer) -> Bool { |
|  |  | return lhs.id == rhs.id |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e3aa712`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Fcommit%2Fe3aa712508db2854ac0ab905696c65fd88fa7e23) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c4a2344e_20250114_203746.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Fsecurity%2Fadvisories%2FGHSA-gcj9-jj38-hwmc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvapor%2Fvapor%2Fsecurity%2Fadvisories%2FGHSA-gcj9-jj38-hwmc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=vapor%2Fvapor)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vapor](/vapor)
/
**[vapor](/vapor/vapor)**
Public

* [Notifications](/login?return_to=%2Fvapor%2Fvapor) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fvapor%2Fvapor)
* [Star
   24.7k](/login?return_to=%2Fvapor%2Fvapor)

* [Code](/vapor/vapor)
* [Issues
  84](/vapor/vapor/issues)
* [Pull requests
  11](/vapor/vapor/pulls)
* [Actions](/vapor/vapor/actions)
* [Security](/vapor/vapor/security)
* [Insights](/vapor/vapor/pulse)

Additional navigation options

* [Code](/vapor/vapor)
* [Issues](/vapor/vapor/issues)
* [Pull requests](/vapor/vapor/pulls)
* [Actions](/vapor/vapor/actions)
* [Security](/vapor/vapor/security)
* [Insights](/vapor/vapor/pulse)

# Vapor's Metrics integration could cause a system drain

Low

[0xTim](/0xTim)
published
GHSA-gcj9-jj38-hwmc
Feb 22, 2021

## Package

Vapor
(SwiftPM)

## Affected versions

<= 4.40.0

## Patched versions

4.40.1

## Description

### Impact

This is a DoS attack against anyone who Bootstraps a metrics backend for their Vapor app with the following attack vector:

1. send unlimited requests against a vapor instance with different paths. this will create “unlimited” counters and timers, which will eventually drain the system.
2. downstream services might suffer from this attack as well by being spammed with error paths

### Patches

This has been patched in 4.40.1. The `DefaultResponder` will rewrite any undefined route paths for to `vapor_route_undefined` to avoid unlimited counters.

### Workarounds

Don't bootstrap a metrics system or upgrade to 4.40.1

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [Vapor](https://github.com/vapor/vapor)
* Ask in [Discord](http://vapor.team)

### Severity

Low

### CVE ID

CVE-2021-21328

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


