=== Content from github.com_36622b16_20250114_202844.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F8950)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F8950)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

# Add a maximum size for well-known lookups. #8950

 Merged

[clokep](/clokep)
merged 5 commits into
[develop](/matrix-org/synapse/tree/develop "matrix-org/synapse:develop")
from
[clokep/well-known-max-size](/matrix-org/synapse/tree/clokep/well-known-max-size "matrix-org/synapse:clokep/well-known-max-size")

Dec 16, 2020

 Merged

# [Add a maximum size for well-known lookups.](#top) #8950

[clokep](/clokep)
merged 5 commits into
[develop](/matrix-org/synapse/tree/develop "matrix-org/synapse:develop")
from
[clokep/well-known-max-size](/matrix-org/synapse/tree/clokep/well-known-max-size "matrix-org/synapse:clokep/well-known-max-size")

Dec 16, 2020

[Conversation
10](/matrix-org/synapse/pull/8950)
[Commits
5](/matrix-org/synapse/pull/8950/commits)
[Checks
0](/matrix-org/synapse/pull/8950/checks)
[Files changed](/matrix-org/synapse/pull/8950/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![clokep](https://avatars.githubusercontent.com/u/517124?s=60&v=4)](/clokep)

Copy link

Member

### @clokep **[clokep](/clokep)** commented [Dec 15, 2020](#issue-768124695) • edited Loading

I noticed we already had a way to enforce a maximum size when reading a response from Twisted. There's no reason for a .well-known lookup to be large so we should bail after a short amount of data. I chose 50kb in here, but that's somewhat arbitrary, the maximum reasonable size for a well-known response is:

```
len("""{
    "m.server": "<maximum domain length>:65535"
}
""")
```

Note that the maximum domain length is 253 characters. So this leads to roughly 28 + 253 < 300 bytes. We can bikeshed the maximum size if you'd like.

Note that I don't *think* there's anything else useful to put in there.

Sorry, something went wrong.

All reactions

 [clokep](/clokep)
added 2 commits
[December 15, 2020 15:09](#commits-pushed-32adcde)

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep)

`[Add a maximum size for well-known lookups.](/matrix-org/synapse/pull/8950/commits/32adcdeefe27844a1c331848df09640aeba270ef "Add a maximum size for well-known lookups.")`

`[32adcde](/matrix-org/synapse/pull/8950/commits/32adcdeefe27844a1c331848df09640aeba270ef)`

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep)

`[Raise a custom exception.](/matrix-org/synapse/pull/8950/commits/9389a88816ddb1eeb70f927da804b921aba0facb "Raise a custom exception.")`

`[9389a88](/matrix-org/synapse/pull/8950/commits/9389a88816ddb1eeb70f927da804b921aba0facb)`

 [![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
[force-pushed](/matrix-org/synapse/compare/70681cc7e40d264829be6b4df0b3cc38f0ffd059..9389a88816ddb1eeb70f927da804b921aba0facb)
the
clokep/well-known-max-size

branch
from
[`70681cc`](/matrix-org/synapse/commit/70681cc7e40d264829be6b4df0b3cc38f0ffd059) to
[`9389a88`](/matrix-org/synapse/commit/9389a88816ddb1eeb70f927da804b921aba0facb)  [Compare](/matrix-org/synapse/compare/70681cc7e40d264829be6b4df0b3cc38f0ffd059..9389a88816ddb1eeb70f927da804b921aba0facb)
[December 15, 2020 20:09](#event-4116441294)

[![@tulir](https://avatars.githubusercontent.com/u/4224639?s=80&v=4)](/tulir)

Copy link

Member

### **[tulir](/tulir)** commented [Dec 15, 2020](#issuecomment-745563273)

| Note that I don't think there's anything else useful to put in there.  Some people might handle all `/.well-known/matrix/*` paths as one and return the same JSON object regardless of the file name. 50kb limit should still be fine though |
| --- |

 👍
1
 clokep reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

 [![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
requested a review
from a team
[December 16, 2020 12:01](#event-4119339418)

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
self-assigned this
[Dec 16, 2020](#event-4120111339)

[![richvdh](https://avatars.githubusercontent.com/u/1389908?s=60&v=4)](/richvdh)

**[richvdh](/richvdh)**
suggested changes
[Dec 16, 2020](#pullrequestreview-554020143)

 [View reviewed changes](/matrix-org/synapse/pull/8950/files/9389a88816ddb1eeb70f927da804b921aba0facb)

[synapse/http/client.py](/matrix-org/synapse/pull/8950/files/9389a88816ddb1eeb70f927da804b921aba0facb#diff-66444b92f547d9edb90914be0717bbe92d7b02ce10b65b4546b6c629af563ae9)

Show resolved

Hide resolved

[synapse/http/client.py](/matrix-org/synapse/pull/8950/files/9389a88816ddb1eeb70f927da804b921aba0facb#diff-66444b92f547d9edb90914be0717bbe92d7b02ce10b65b4546b6c629af563ae9)
Outdated

Show resolved

Hide resolved

[synapse/http/client.py](/matrix-org/synapse/pull/8950/files/9389a88816ddb1eeb70f927da804b921aba0facb#diff-66444b92f547d9edb90914be0717bbe92d7b02ce10b65b4546b6c629af563ae9)
Outdated

Show resolved

Hide resolved

[synapse/http/federation/well\_known\_resolver.py](/matrix-org/synapse/pull/8950/files/9389a88816ddb1eeb70f927da804b921aba0facb#diff-46f71022105249f09ee6eb1cfcf3db83aeb37c73d908e58972989156792641f3)
Outdated

Show resolved

Hide resolved

 [clokep](/clokep)
added 3 commits
[December 16, 2020 14:44](#commits-pushed-b8aeebd)

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep)

`[Actually raise the proper exception.](/matrix-org/synapse/pull/8950/commits/b8aeebd6e5546fc09847a69e33726b453f8b4e6f "Actually raise the proper exception.")`

`[b8aeebd](/matrix-org/synapse/pull/8950/commits/b8aeebd6e5546fc09847a69e33726b453f8b4e6f)`

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep)

`[Use a more Pythonic name and update the docstring.](/matrix-org/synapse/pull/8950/commits/bcec5f30148181dd99d01fdb9d38f082909712cc "Use a more Pythonic name and update the docstring.")`

`[bcec5f3](/matrix-org/synapse/pull/8950/commits/bcec5f30148181dd99d01fdb9d38f082909712cc)`

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep)

`[Add back log config.](/matrix-org/synapse/pull/8950/commits/57391a486145310168325e4194075248ff3bb659 "Add back log config.")`

`[57391a4](/matrix-org/synapse/pull/8950/commits/57391a486145310168325e4194075248ff3bb659)`

[![clokep](https://avatars.githubusercontent.com/u/517124?s=60&v=4)](/clokep)

**[clokep](/clokep)**
commented
[Dec 16, 2020](#pullrequestreview-554033464)

 [View reviewed changes](/matrix-org/synapse/pull/8950/files/57391a486145310168325e4194075248ff3bb659)

[synapse/http/client.py](/matrix-org/synapse/pull/8950/files/57391a486145310168325e4194075248ff3bb659#diff-66444b92f547d9edb90914be0717bbe92d7b02ce10b65b4546b6c629af563ae9)

|  |  | @@ -782,12 +783,15 @@ def connectionLost(self, reason: Failure) -> None: | |
| --- | --- | --- | --- |
|  |  | self.deferred.errback(reason) |
|  |  |  |
|  |  |  |
|  |  | def readBodyToFile( |
|  |  | def read\_body\_with\_max\_size( |

Copy link

Member

Author

### @clokep **[clokep](/clokep)** [Dec 16, 2020](#discussion_r544580469)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I wanted to make this async and handle the `Deferred` logic internally, but the call from the `MatrixFederationHttpClient` adds a timeout, which involves having both a timeout and a reactor. The timeout could be made optional easily, but needed both or neither is kind of meh.

Sorry, something went wrong.

All reactions

 [![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
requested a review
from [richvdh](/richvdh)
[December 16, 2020 19:54](#event-4121489559)

[![richvdh](https://avatars.githubusercontent.com/u/1389908?s=60&v=4)](/richvdh)

**[richvdh](/richvdh)**
approved these changes
[Dec 16, 2020](#pullrequestreview-554111562)

 [View reviewed changes](/matrix-org/synapse/pull/8950/files/57391a486145310168325e4194075248ff3bb659)

Copy link

Member

### @richvdh **[richvdh](/richvdh)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

lgtm

Sorry, something went wrong.

All reactions

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
merged commit [`ff5c4da`](/matrix-org/synapse/commit/ff5c4da1289cb5e097902b3e55b771be342c29d6)
into
develop

[Dec 16, 2020](https://github.com/matrix-org/synapse/pull/8950#event-4122091867)

 [![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
deleted the
clokep/well-known-max-size

branch
[December 16, 2020 22:25](#event-4122091945)

[clokep](/clokep)
added a commit
that referenced
this pull request
[Jan 6, 2021](#ref-commit-0312266)
[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)

`[Merge tag 'v1.25.0rc1' into develop](/matrix-org/synapse/commit/0312266ee3b5fd527006f8ce5228fa8f227acbe4 "Merge tag 'v1.25.0rc1' into develop

Synapse 1.25.0rc1 (2021-01-06)
==============================

Removal warning
---------------

The old [Purge Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/purge_room.md)
and [Shutdown Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/shutdown_room.md)
are deprecated and will be removed in a future release. They will be replaced by the
[Delete Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/rooms.md#delete-room-api).

`POST /_synapse/admin/v1/rooms/<room_id>/delete` replaces `POST /_synapse/admin/v1/purge_room` and
`POST /_synapse/admin/v1/shutdown_room/<room_id>`.

Features
--------

- Add an admin API that lets server admins get power in rooms in which local users have power. ([\#8756](https://github.com/matrix-org/synapse/issues/8756))
- Add optional HTTP authentication to replication endpoints. ([\#8853](https://github.com/matrix-org/synapse/issues/8853))
- Improve the error messages printed as a result of configuration problems for extension modules. ([\#8874](https://github.com/matrix-org/synapse/issues/8874))
- Add the number of local devices to Room Details Admin API. Contributed by @dklimpel. ([\#8886](https://github.com/matrix-org/synapse/issues/8886))
- Add `X-Robots-Tag` header to stop web crawlers from indexing media. Contributed by Aaron Raimist. ([\#8887](https://github.com/matrix-org/synapse/issues/8887))
- Spam-checkers may now define their methods as `async`. ([\#8890](https://github.com/matrix-org/synapse/issues/8890))
- Add support for allowing users to pick their own user ID during a single-sign-on login. ([\#8897](https://github.com/matrix-org/synapse/issues/8897), [\#8900](https://github.com/matrix-org/synapse/issues/8900), [\#8911](https://github.com/matrix-org/synapse/issues/8911), [\#8938](https://github.com/matrix-org/synapse/issues/8938), [\#8941](https://github.com/matrix-org/synapse/issues/8941), [\#8942](https://github.com/matrix-org/synapse/issues/8942), [\#8951](https://github.com/matrix-org/synapse/issues/8951))
- Add an `email.invite_client_location` configuration option to send a web client location to the invite endpoint on the identity server which allows customisation of the email template. ([\#8930](https://github.com/matrix-org/synapse/issues/8930))
- The search term in the list room and list user Admin APIs is now treated as case-insensitive. ([\#8931](https://github.com/matrix-org/synapse/issues/8931))
- Apply an IP range blacklist to push and key revocation requests. ([\#8821](https://github.com/matrix-org/synapse/issues/8821), [\#8870](https://github.com/matrix-org/synapse/issues/8870), [\#8954](https://github.com/matrix-org/synapse/issues/8954))
- Add an option to allow re-use of user-interactive authentication sessions for a period of time. ([\#8970](https://github.com/matrix-org/synapse/issues/8970))
- Allow running the redact endpoint on workers. ([\#8994](https://github.com/matrix-org/synapse/issues/8994))

Bugfixes
--------

- Fix bug where we might not correctly calculate the current state for rooms with multiple extremities. ([\#8827](https://github.com/matrix-org/synapse/issues/8827))
- Fix a long-standing bug in the register admin endpoint (`/_synapse/admin/v1/register`) when the `mac` field was not provided. The endpoint now properly returns a 400 error. Contributed by @edwargix. ([\#8837](https://github.com/matrix-org/synapse/issues/8837))
- Fix a long-standing bug on Synapse instances supporting Single-Sign-On, where users would be prompted to enter their password to confirm certain actions, even though they have not set a password. ([\#8858](https://github.com/matrix-org/synapse/issues/8858))
- Fix a longstanding bug where a 500 error would be returned if the `Content-Length` header was not provided to the upload media resource. ([\#8862](https://github.com/matrix-org/synapse/issues/8862))
- Add additional validation to pusher URLs to be compliant with the specification. ([\#8865](https://github.com/matrix-org/synapse/issues/8865))
- Fix the error code that is returned when a user tries to register on a homeserver on which new-user registration has been disabled. ([\#8867](https://github.com/matrix-org/synapse/issues/8867))
- Fix a bug where `PUT /_synapse/admin/v2/users/<user_id>` failed to create a new user when `avatar_url` is specified. Bug introduced in Synapse v1.9.0. ([\#8872](https://github.com/matrix-org/synapse/issues/8872))
- Fix a 500 error when attempting to preview an empty HTML file. ([\#8883](https://github.com/matrix-org/synapse/issues/8883))
- Fix occasional deadlock when handling SIGHUP. ([\#8918](https://github.com/matrix-org/synapse/issues/8918))
- Fix login API to not ratelimit application services that have ratelimiting disabled. ([\#8920](https://github.com/matrix-org/synapse/issues/8920))
- Fix bug where we ratelimited auto joining of rooms on registration (using `auto_join_rooms` config). ([\#8921](https://github.com/matrix-org/synapse/issues/8921))
- Fix a bug where deactivated users appeared in the user directory when their profile information was updated. ([\#8933](https://github.com/matrix-org/synapse/issues/8933), [\#8964](https://github.com/matrix-org/synapse/issues/8964))
- Fix bug introduced in Synapse v1.24.0 which would cause an exception on startup if both `enabled` and `localdb_enabled` were set to `False` in the `password_config` setting of the configuration file. ([\#8937](https://github.com/matrix-org/synapse/issues/8937))
- Fix a bug where 500 errors would be returned if the `m.room_history_visibility` event had invalid content. ([\#8945](https://github.com/matrix-org/synapse/issues/8945))
- Fix a bug causing common English words to not be considered for a user directory search. ([\#8959](https://github.com/matrix-org/synapse/issues/8959))
- Fix bug where application services couldn't register new ghost users if the server had reached its MAU limit. ([\#8962](https://github.com/matrix-org/synapse/issues/8962))
- Fix a long-standing bug where a `m.image` event without a `url` would cause errors on push. ([\#8965](https://github.com/matrix-org/synapse/issues/8965))
- Fix a small bug in v2 state resolution algorithm, which could also cause performance issues for rooms with large numbers of power levels. ([\#8971](https://github.com/matrix-org/synapse/issues/8971))
- Add validation to the `sendToDevice` API to raise a missing parameters error instead of a 500 error. ([\#8975](https://github.com/matrix-org/synapse/issues/8975))
- Add validation of group IDs to raise a 400 error instead of a 500 eror. ([\#8977](https://github.com/matrix-org/synapse/issues/8977))

Improved Documentation
----------------------

- Fix the \"Event persist rate\" section of the included grafana dashboard by adding missing prometheus rules. ([\#8802](https://github.com/matrix-org/synapse/issues/8802))
- Combine related media admin API docs. ([\#8839](https://github.com/matrix-org/synapse/issues/8839))
- Fix an error in the documentation for the SAML username mapping provider. ([\#8873](https://github.com/matrix-org/synapse/issues/8873))
- Clarify comments around template directories in `sample_config.yaml`. ([\#8891](https://github.com/matrix-org/synapse/issues/8891))
- Moved instructions for database setup, adjusted heading levels and improved syntax highlighting in [INSTALL.md](../INSTALL.md). Contributed by fossterer. ([\#8987](https://github.com/matrix-org/synapse/issues/8987))
- Update the example value of `group_creation_prefix` in the sample configuration. ([\#8992](https://github.com/matrix-org/synapse/issues/8992))
- Link the Synapse developer room to the development section in the docs. ([\#9002](https://github.com/matrix-org/synapse/issues/9002))

Deprecations and Removals
-------------------------

- Deprecate Shutdown Room and Purge Room Admin APIs. ([\#8829](https://github.com/matrix-org/synapse/issues/8829))

Internal Changes
----------------

- Properly store the mapping of external ID to Matrix ID for CAS users. ([\#8856](https://github.com/matrix-org/synapse/issues/8856), [\#8958](https://github.com/matrix-org/synapse/issues/8958))
- Remove some unnecessary stubbing from unit tests. ([\#8861](https://github.com/matrix-org/synapse/issues/8861))
- Remove unused `FakeResponse` class from unit tests. ([\#8864](https://github.com/matrix-org/synapse/issues/8864))
- Pass `room_id` to `get_auth_chain_difference`. ([\#8879](https://github.com/matrix-org/synapse/issues/8879))
- Add type hints to push module. ([\#8880](https://github.com/matrix-org/synapse/issues/8880), [\#8882](https://github.com/matrix-org/synapse/issues/8882), [\#8901](https://github.com/matrix-org/synapse/issues/8901), [\#8940](https://github.com/matrix-org/synapse/issues/8940), [\#8943](https://github.com/matrix-org/synapse/issues/8943), [\#9020](https://github.com/matrix-org/synapse/issues/9020))
- Simplify logic for handling user-interactive-auth via single-sign-on servers. ([\#8881](https://github.com/matrix-org/synapse/issues/8881))
- Skip the SAML tests if the requirements (`pysaml2` and `xmlsec1`) aren't available. ([\#8905](https://github.com/matrix-org/synapse/issues/8905))
- Fix multiarch docker image builds. ([\#8906](https://github.com/matrix-org/synapse/issues/8906))
- Don't publish `latest` docker image until all archs are built. ([\#8909](https://github.com/matrix-org/synapse/issues/8909))
- Various clean-ups to the structured logging and logging context code. ([\#8916](https://github.com/matrix-org/synapse/issues/8916), [\#8935](https://github.com/matrix-org/synapse/issues/8935))
- Automatically drop stale forward-extremities under some specific conditions. ([\#8929](https://github.com/matrix-org/synapse/issues/8929))
- Refactor test utilities for injecting HTTP requests. ([\#8946](https://github.com/matrix-org/synapse/issues/8946))
- Add a maximum size of 50 kilobytes to .well-known lookups. ([\#8950](https://github.com/matrix-org/synapse/issues/8950))
- Fix bug in `generate_log_config` script which made it write empty files. ([\#8952](https://github.com/matrix-org/synapse/issues/8952))
- Clean up tox.ini file; disable coverage checking for non-test runs. ([\#8963](https://github.com/matrix-org/synapse/issues/8963))
- Add type hints to the admin and room list handlers. ([\#8973](https://github.com/matrix-org/synapse/issues/8973))
- Add type hints to the receipts and user directory handlers. ([\#8976](https://github.com/matrix-org/synapse/issues/8976))
- Drop the unused `local_invites` table. ([\#8979](https://github.com/matrix-org/synapse/issues/8979))
- Add type hints to the base storage code. ([\#8980](https://github.com/matrix-org/synapse/issues/8980))
- Support using PyJWT v2.0.0 in the test suite. ([\#8986](https://github.com/matrix-org/synapse/issues/8986))
- Fix `tests.federation.transport.RoomDirectoryFederationTests` and ensure it runs in CI. ([\#8998](https://github.com/matrix-org/synapse/issues/8998))
- Add type hints to the crypto module. ([\#8999](https://github.com/matrix-org/synapse/issues/8999))")`
…

`[0312266](/matrix-org/synapse/commit/0312266ee3b5fd527006f8ce5228fa8f227acbe4)`

```
Synapse 1.25.0rc1 (2021-01-06)
==============================

Removal warning
---------------

The old [Purge Room API](<https://github.com/matrix-org/synapse/tree/master/docs/admin_api/purge_room.md>)
and [Shutdown Room API](<https://github.com/matrix-org/synapse/tree/master/docs/admin_api/shutdown_room.md>)
are deprecated and will be removed in a future release. They will be replaced by the
[Delete Room API](<https://github.com/matrix-org/synapse/tree/master/docs/admin_api/rooms.md#delete-room-api>).

`POST /_synapse/admin/v1/rooms/<room_id>/delete` replaces `POST /_synapse/admin/v1/purge_room` and
`POST /_synapse/admin/v1/shutdown_room/<room_id>`.

Features
--------

- Add an admin API that lets server admins get power in rooms in which local users have power. ([\[#8756](https://github.com/matrix-org/synapse/pull/8756)]([#8756](https://github.com/matrix-org/synapse/pull/8756)))
- Add optional HTTP authentication to replication endpoints. ([\[#8853](https://github.com/matrix-org/synapse/pull/8853)]([#8853](https://github.com/matrix-org/synapse/pull/8853)))
- Improve the error messages printed as a result of configuration problems for extension modules. ([\[#8874](https://github.com/matrix-org/synapse/pull/8874)]([#8874](https://github.com/matrix-org/synapse/pull/8874)))
- Add the number of local devices to Room Details Admin API. Contributed by [@dklimpel](https://github.com/dklimpel). ([\[#8886](https://github.com/matrix-org/synapse/pull/8886)]([#8886](https://github.com/matrix-org/synapse/pull/8886)))
- Add `X-Robots-Tag` header to stop web crawlers from indexing media. Contributed by Aaron Raimist. ([\[#8887](https://github.com/matrix-org/synapse/pull/8887)]([#8887](https://github.com/matrix-org/synapse/pull/8887)))
- Spam-checkers may now define their methods as `async`. ([\[#8890](https://github.com/matrix-org/synapse/pull/8890)]([#8890](https://github.com/matrix-org/synapse/pull/8890)))
- Add support for allowing users to pick their own user ID during a single-sign-on login. ([\[#8897](https://github.com/matrix-org/synapse/pull/8897)]([#8897](https://github.com/matrix-org/synapse/pull/8897)), [\[#8900](https://github.com/matrix-org/synapse/pull/8900)]([#8900](https://github.com/matrix-org/synapse/pull/8900)), [\[#8911](https://github.com/matrix-org/synapse/pull/8911)]([#8911](https://github.com/matrix-org/synapse/pull/8911)), [\[#8938](https://github.com/matrix-org/synapse/pull/8938)]([#8938](https://github.com/matrix-org/synapse/pull/8938)), [\[#8941](https://github.com/matrix-org/synapse/pull/8941)]([#8941](https://github.com/matrix-org/synapse/pull/8941)), [\[#8942](https://github.com/matrix-org/synapse/pull/8942)]([#8942](https://github.com/matrix-org/synapse/pull/8942)), [\[#8951](https://github.com/matrix-org/synapse/pull/8951)]([#8951](https://github.com/matrix-org/synapse/pull/8951)))
- Add an `email.invite_client_location` configuration option to send a web client location to the invite endpoint on the identity server which allows customisation of the email template. ([\[#8930](https://github.com/matrix-org/synapse/pull/8930)]([#8930](https://github.com/matrix-org/synapse/pull/8930)))
- The search term in the list room and list user Admin APIs is now treated as case-insensitive. ([\[#8931](https://github.com/matrix-org/synapse/pull/8931)]([#8931](https://github.com/matrix-org/synapse/pull/8931)))
- Apply an IP range blacklist to push and key revocation requests. ([\[#8821](https://github.com/matrix-org/synapse/pull/8821)]([#8821](https://github.com/matrix-org/synapse/pull/8821)), [\[#8870](https://github.com/matrix-org/synapse/pull/8870)]([#8870](https://github.com/matrix-org/synapse/pull/8870)), [\[#8954](https://github.com/matrix-org/synapse/pull/8954)]([#8954](https://github.com/matrix-org/synapse/pull/8954)))
- Add an option to allow re-use of user-interactive authentication sessions for a period of time. ([\[#8970](https://github.com/matrix-org/synapse/pull/8970)]([#8970](https://github.com/matrix-org/synapse/pull/8970)))
- Allow running the redact endpoint on workers. ([\[#8994](https://github.com/matrix-org/synapse/pull/8994)]([#8994](https://github.com/matrix-org/synapse/pull/8994)))

Bugfixes
--------

- Fix bug where we might not correctly calculate the current state for rooms with multiple extremities. ([\[#8827](https://github.com/matrix-org/synapse/pull/8827)]([#8827](https://github.com/matrix-org/synapse/pull/8827)))
- Fix a long-standing bug in the register admin endpoint (`/_synapse/admin/v1/register`) when the `mac` field was not provided. The endpoint now properly returns a 400 error. Contributed by [@edwargix](https://github.com/edwargix). ([\[#8837](https://github.com/matrix-org/synapse/pull/8837)]([#8837](https://github.com/matrix-org/synapse/pull/8837)))
- Fix a long-standing bug on Synapse instances supporting Single-Sign-On, where users would be prompted to enter their password to confirm certain actions, even though they have not set a password. ([\[#8858](https://github.com/matrix-org/synapse/pull/8858)]([#8858](https://github.com/matrix-org/synapse/pull/8858)))
- Fix a longstanding bug where a 500 error would be returned if the `Content-Length` header was not provided to the upload media resource. ([\[#8862](https://github.com/matrix-org/synapse/pull/8862)]([#8862](https://github.com/matrix-org/synapse/pull/8862)))
- Add additional validation to pusher URLs to be compliant with the specification. ([\[#8865](https://github.com/matrix-org/synapse/pull/8865)]([#8865](https://github.com/matrix-org/synapse/pull/8865)))
- Fix the error code that is returned when a user tries to register on a homeserver on which new-user registration has been disabled. ([\[#8867](https://github.com/matrix-org/synapse/pull/8867)]([#8867](https://github.com/matrix-org/synapse/pull/8867)))
- Fix a bug where `PUT /_synapse/admin/v2/users/<user_id>` failed to create a new user when `avatar_url` is specified. Bug introduced in Synapse v1.9.0. ([\[#8872](https://github.com/matrix-org/synapse/pull/8872)]([#8872](https://github.com/matrix-org/synapse/pull/8872)))
- Fix a 500 error when attempting to preview an empty HTML file. ([\[#8883](https://github.com/matrix-org/synapse/pull/8883)]([#8883](https://github.com/matrix-org/synapse/pull/8883)))
- Fix occasional deadlock when handling SIGHUP. ([\[#8918](https://github.com/matrix-org/synapse/pull/8918)]([#8918](https://github.com/matrix-org/synapse/pull/8918)))
- Fix login API to not ratelimit application services that have ratelimiting disabled. ([\[#8920](https://github.com/matrix-org/synapse/pull/8920)]([#8920](https://github.com/matrix-org/synapse/pull/8920)))
- Fix bug where we ratelimited auto joining of rooms on registration (using `auto_join_rooms` config). ([\[#8921](https://github.com/matrix-org/synapse/pull/8921)]([#8921](https://github.com/matrix-org/synapse/pull/8921)))
- Fix a bug where deactivated users appeared in the user directory when their profile information was updated. ([\[#8933](https://github.com/matrix-org/synapse/pull/8933)]([#8933](https://github.com/matrix-org/synapse/pull/8933)), [\[#8964](https://github.com/matrix-org/synapse/pull/8964)]([#8964](https://github.com/matrix-org/synapse/pull/8964)))
- Fix bug introduced in Synapse v1.24.0 which would cause an exception on startup if both `enabled` and `localdb_enabled` were set to `False` in the `password_config` setting of the configuration file. ([\[#8937](https://github.com/matrix-org/synapse/pull/8937)]([#8937](https://github.com/matrix-org/synapse/pull/8937)))
- Fix a bug where 500 errors would be returned if the `m.room_history_visibility` event had invalid content. ([\[#8945](https://github.com/matrix-org/synapse/pull/8945)]([#8945](https://github.com/matrix-org/synapse/pull/8945)))
- Fix a bug causing common English words to not be considered for a user directory search. ([\[#8959](https://github.com/matrix-org/synapse/pull/8959)]([#8959](https://github.com/matrix-org/synapse/pull/8959)))
- Fix bug where application services couldn't register new ghost users if the server had reached its MAU limit. ([\[#8962](https://github.com/matrix-org/synapse/pull/8962)]([#8962](https://github.com/matrix-org/synapse/pull/8962)))
- Fix a long-standing bug where a `m.image` event without a `url` would cause errors on push. ([\[#8965](https://github.com/matrix-org/synapse/pull/8965)]([#8965](https://github.com/matrix-org/synapse/pull/8965)))
- Fix a small bug in v2 state resolution algorithm, which could also cause performance issues for rooms with large numbers of power levels. ([\[#8971](https://github.com/matrix-org/synapse/pull/8971)]([#8971](https://github.com/matrix-org/synapse/pull/8971)))
- Add validation to the `sendToDevice` API to raise a missing parameters error instead of a 500 error. ([\[#8975](https://github.com/matrix-org/synapse/pull/8975)]([#8975](https://github.com/matrix-org/synapse/pull/8975)))
- Add validation of group IDs to raise a 400 error instead of a 500 eror. ([\[#8977](https://github.com/matrix-org/synapse/pull/8977)]([#8977](https://github.com/matrix-org/synapse/pull/8977)))

Improved Documentation
----------------------

- Fix the "Event persist rate" section of the included grafana dashboard by adding missing prometheus rules. ([\[#8802](https://github.com/matrix-org/synapse/pull/8802)]([#8802](https://github.com/matrix-org/synapse/pull/8802)))
- Combine related media admin API docs. ([\[#8839](https://github.com/matrix-org/synapse/pull/8839)]([#8839](https://github.com/matrix-org/synapse/pull/8839)))
- Fix an error in the documentation for the SAML username mapping provider. ([\[#8873](https://github.com/matrix-org/synapse/pull/8873)]([#8873](https://github.com/matrix-org/synapse/pull/8873)))
- Clarify comments around template directories in `sample_config.yaml`. ([\[#8891](https://github.com/matrix-org/synapse/pull/8891)]([#8891](https://github.com/matrix-org/synapse/pull/8891)))
- Moved instructions for database setup, adjusted heading levels and improved syntax highlighting in [INSTALL.md](../INSTALL.md). Contributed by fossterer. ([\[#8987](https://github.com/matrix-org/synapse/pull/8987)]([#8987](https://github.com/matrix-org/synapse/pull/8987)))
- Update the example value of `group_creation_prefix` in the sample configuration. ([\[#8992](https://github.com/matrix-org/synapse/pull/8992)]([#8992](https://github.com/matrix-org/synapse/pull/8992)))
- Link the Synapse developer room to the development section in the docs. ([\[#9002](https://github.com/matrix-org/synapse/pull/9002)]([#9002](https://github.com/matrix-org/synapse/pull/9002)))

Deprecations and Removals
-------------------------

- Deprecate Shutdown Room and Purge Room Admin APIs. ([\[#8829](https://github.com/matrix-org/synapse/pull/8829)]([#8829](https://github.com/matrix-org/synapse/pull/8829)))

Internal Changes
----------------

- Properly store the mapping of external ID to Matrix ID for CAS users. ([\[#8856](https://github.com/matrix-org/synapse/pull/8856)]([#8856](https://github.com/matrix-org/synapse/pull/8856)), [\[#8958](https://github.com/matrix-org/synapse/pull/8958)]([#8958](https://github.com/matrix-org/synapse/pull/8958)))
- Remove some unnecessary stubbing from unit tests. ([\[#8861](https://github.com/matrix-org/synapse/pull/8861)]([#8861](https://github.com/matrix-org/synapse/pull/8861)))
- Remove unused `FakeResponse` class from unit tests. ([\[#8864](https://github.com/matrix-org/synapse/pull/8864)]([#8864](https://github.com/matrix-org/synapse/pull/8864)))
- Pass `room_id` to `get_auth_chain_difference`. ([\[#8879](https://github.com/matrix-org/synapse/pull/8879)]([#8879](https://github.com/matrix-org/synapse/pull/8879)))
- Add type hints to push module. ([\[#8880](https://github.com/matrix-org/synapse/pull/8880)]([#8880](https://github.com/matrix-org/synapse/pull/8880)), [\[#8882](https://github.com/matrix-org/synapse/pull/8882)]([#8882](https://github.com/matrix-org/synapse/pull/8882)), [\[#8901](https://github.com/matrix-org/synapse/pull/8901)]([#8901](https://github.com/matrix-org/synapse/pull/8901)), [\[#8940](https://github.com/matrix-org/synapse/pull/8940)]([#8940](https://github.com/matrix-org/synapse/pull/8940)), [\[#8943](https://github.com/matrix-org/synapse/pull/8943)]([#8943](https://github.com/matrix-org/synapse/pull/8943)), [\[#9020](https://github.com/matrix-org/synapse/pull/9020)]([#9020](https://github.com/matrix-org/synapse/pull/9020)))
- Simplify logic for handling user-interactive-auth via single-sign-on servers. ([\[#8881](https://github.com/matrix-org/synapse/pull/8881)]([#8881](https://github.com/matrix-org/synapse/pull/8881)))
- Skip the SAML tests if the requirements (`pysaml2` and `xmlsec1`) aren't available. ([\[#8905](https://github.com/matrix-org/synapse/pull/8905)]([#8905](https://github.com/matrix-org/synapse/pull/8905)))
- Fix multiarch docker image builds. ([\[#8906](https://github.com/matrix-org/synapse/pull/8906)]([#8906](https://github.com/matrix-org/synapse/pull/8906)))
- Don't publish `latest` docker image until all archs are built. ([\[#8909](https://github.com/matrix-org/synapse/pull/8909)]([#8909](https://github.com/matrix-org/synapse/pull/8909)))
- Various clean-ups to the structured logging and logging context code. ([\[#8916](https://github.com/matrix-org/synapse/pull/8916)]([#8916](https://github.com/matrix-org/synapse/pull/8916)), [\[#8935](https://github.com/matrix-org/synapse/pull/8935)]([#8935](https://github.com/matrix-org/synapse/pull/8935)))
- Automatically drop stale forward-extremities under some specific conditions. ([\[#8929](https://github.com/matrix-org/synapse/pull/8929)]([#8929](https://github.com/matrix-org/synapse/pull/8929)))
- Refactor test utilities for injecting HTTP requests. ([\[#8946](https://github.com/matrix-org/synapse/pull/8946)]([#8946](https://github.com/matrix-org/synapse/pull/8946)))
- Add a maximum size of 50 kilobytes to .well-known lookups. ([\[#8950](https://github.com/matrix-org/synapse/pull/8950)]([#8950](https://github.com/matrix-org/synapse/pull/8950)))
- Fix bug in `generate_log_config` script which made it write empty files. ([\[#8952](https://github.com/matrix-org/synapse/pull/8952)]([#8952](https://github.com/matrix-org/synapse/pull/8952)))
- Clean up tox.ini file; disable coverage checking for non-test runs. ([\[#8963](https://github.com/matrix-org/synapse/pull/8963)]([#8963](https://github.com/matrix-org/synapse/pull/8963)))
- Add type hints to the admin and room list handlers. ([\[#8973](https://github.com/matrix-org/synapse/pull/8973)]([#8973](https://github.com/matrix-org/synapse/pull/8973)))
- Add type hints to the receipts and user directory handlers. ([\[#8976](https://github.com/matrix-org/synapse/pull/8976)]([#8976](https://github.com/matrix-org/synapse/pull/8976)))
- Drop the unused `local_invites` table. ([\[#8979](https://github.com/matrix-org/synapse/pull/8979)]([#8979](https://github.com/matrix-org/synapse/pull/8979)))
- Add type hints to the base storage code. ([\[#8980](https://github.com/matrix-org/synapse/pull/8980)]([#8980](https://github.com/matrix-org/synapse/pull/8980)))
- Support using PyJWT v2.0.0 in the test suite. ([\[#8986](https://github.com/matrix-org/synapse/pull/8986)]([#8986](https://github.com/matrix-org/synapse/pull/8986)))
- Fix `tests.federation.transport.RoomDirectoryFederationTests` and ensure it runs in CI. ([\[#8998](https://github.com/matrix-org/synapse/pull/8998)]([#8998](https://github.com/matrix-org/synapse/pull/8998)))
- Add type hints to the crypto module. ([\[#8999](https://github.com/matrix-org/synapse/pull/8999)]([#8999](https://github.com/matrix-org/synapse/pull/8999)))
```

[netbsd-srcmastr](/netbsd-srcmastr)
pushed a commit
to NetBSD/pkgsrc
that referenced
this pull request
[Jan 13, 2021](#ref-commit-77c50e6)
[![@Midar](https://avatars.githubusercontent.com/u/752237?s=40&u=81dfb9be718247c7664693c556bf3fdfb6715545&v=4)](/Midar)

`[Update chat/matrix-synapse to 1.25](/NetBSD/pkgsrc/commit/77c50e6d6eba834d4ef70412227be0506fc9a3e3 "Update chat/matrix-synapse to 1.25

Synapse 1.25.0 (2021-01-13)
===========================

Ending Support for Python 3.5 and Postgres 9.5
----------------------------------------------

With this release, the Synapse team is announcing a formal deprecation policy for our platform dependencies, like Python and PostgreSQL:

All future releases of Synapse will follow the upstream end-of-life schedules.

Which means:

* This is the last release which guarantees support for Python 3.5.
* We will end support for PostgreSQL 9.5 early next month.
* We will end support for Python 3.6 and PostgreSQL 9.6 near the end of the year.

Crucially, this means __we will not produce .deb packages for Debian 9 (Stretch) or Ubuntu 16.04 (Xenial)__ beyond the transition period described below.

The website https://endoflife.date/ has convenient summaries of the support schedules for projects like [Python](https://endoflife.date/python) and [PostgreSQL](https://endoflife.date/postgresql).

If you are unable to upgrade your environment to a supported version of Python or Postgres, we encourage you to consider using the [Synapse Docker images](./INSTALL.md#docker-images-and-ansible-playbooks) instead.

### Transition Period

We will make a good faith attempt to avoid breaking compatibility in all releases through the end of March 2021. However, critical security vulnerabilities in dependencies or other unanticipated circumstances may arise which necessitate breaking compatibility earlier.

We intend to continue producing .deb packages for Debian 9 (Stretch) and Ubuntu 16.04 (Xenial) through the transition period.

Removal warning
---------------

The old [Purge Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/purge_room.md)
and [Shutdown Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/shutdown_room.md)
are deprecated and will be removed in a future release. They will be replaced by the
[Delete Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/rooms.md#delete-room-api).

`POST /_synapse/admin/v1/rooms/<room_id>/delete` replaces `POST /_synapse/admin/v1/purge_room` and
`POST /_synapse/admin/v1/shutdown_room/<room_id>`.

Bugfixes
--------

- Fix HTTP proxy support when using a proxy that is on a blacklisted IP. Introduced in v1.25.0rc1. Contributed by @Bubu. ([\#9084](https://github.com/matrix-org/synapse/issues/9084))

Synapse 1.25.0rc1 (2021-01-06)
==============================

Features
--------

- Add an admin API that lets server admins get power in rooms in which local users have power. ([\#8756](https://github.com/matrix-org/synapse/issues/8756))
- Add optional HTTP authentication to replication endpoints. ([\#8853](https://github.com/matrix-org/synapse/issues/8853))
- Improve the error messages printed as a result of configuration problems for extension modules. ([\#8874](https://github.com/matrix-org/synapse/issues/8874))
- Add the number of local devices to Room Details Admin API. Contributed by @dklimpel. ([\#8886](https://github.com/matrix-org/synapse/issues/8886))
- Add `X-Robots-Tag` header to stop web crawlers from indexing media. Contributed by Aaron Raimist. ([\#8887](https://github.com/matrix-org/synapse/issues/8887))
- Spam-checkers may now define their methods as `async`. ([\#8890](https://github.com/matrix-org/synapse/issues/8890))
- Add support for allowing users to pick their own user ID during a single-sign-on login. ([\#8897](https://github.com/matrix-org/synapse/issues/8897), [\#8900](https://github.com/matrix-org/synapse/issues/8900), [\#8911](https://github.com/matrix-org/synapse/issues/8911), [\#8938](https://github.com/matrix-org/synapse/issues/8938), [\#8941](https://github.com/matrix-org/synapse/issues/8941), [\#8942](https://github.com/matrix-org/synapse/issues/8942), [\#8951](https://github.com/matrix-org/synapse/issues/8951))
- Add an `email.invite_client_location` configuration option to send a web client location to the invite endpoint on the identity server which allows customisation of the email template. ([\#8930](https://github.com/matrix-org/synapse/issues/8930))
- The search term in the list room and list user Admin APIs is now treated as case-insensitive. ([\#8931](https://github.com/matrix-org/synapse/issues/8931))
- Apply an IP range blacklist to push and key revocation requests. ([\#8821](https://github.com/matrix-org/synapse/issues/8821), [\#8870](https://github.com/matrix-org/synapse/issues/8870), [\#8954](https://github.com/matrix-org/synapse/issues/8954))
- Add an option to allow re-use of user-interactive authentication sessions for a period of time. ([\#8970](https://github.com/matrix-org/synapse/issues/8970))
- Allow running the redact endpoint on workers. ([\#8994](https://github.com/matrix-org/synapse/issues/8994))

Bugfixes
--------

- Fix bug where we might not correctly calculate the current state for rooms with multiple extremities. ([\#8827](https://github.com/matrix-org/synapse/issues/8827))
- Fix a long-standing bug in the register admin endpoint (`/_synapse/admin/v1/register`) when the `mac` field was not provided. The endpoint now properly returns a 400 error. Contributed by @edwargix. ([\#8837](https://github.com/matrix-org/synapse/issues/8837))
- Fix a long-standing bug on Synapse instances supporting Single-Sign-On, where users would be prompted to enter their password to confirm certain actions, even though they have not set a password. ([\#8858](https://github.com/matrix-org/synapse/issues/8858))
- Fix a longstanding bug where a 500 error would be returned if the `Content-Length` header was not provided to the upload media resource. ([\#8862](https://github.com/matrix-org/synapse/issues/8862))
- Add additional validation to pusher URLs to be compliant with the specification. ([\#8865](https://github.com/matrix-org/synapse/issues/8865))
- Fix the error code that is returned when a user tries to register on a homeserver on which new-user registration has been disabled. ([\#8867](https://github.com/matrix-org/synapse/issues/8867))
- Fix a bug where `PUT /_synapse/admin/v2/users/<user_id>` failed to create a new user when `avatar_url` is specified. Bug introduced in Synapse v1.9.0. ([\#8872](https://github.com/matrix-org/synapse/issues/8872))
- Fix a 500 error when attempting to preview an empty HTML file. ([\#8883](https://github.com/matrix-org/synapse/issues/8883))
- Fix occasional deadlock when handling SIGHUP. ([\#8918](https://github.com/matrix-org/synapse/issues/8918))
- Fix login API to not ratelimit application services that have ratelimiting disabled. ([\#8920](https://github.com/matrix-org/synapse/issues/8920))
- Fix bug where we ratelimited auto joining of rooms on registration (using `auto_join_rooms` config). ([\#8921](https://github.com/matrix-org/synapse/issues/8921))
- Fix a bug where deactivated users appeared in the user directory when their profile information was updated. ([\#8933](https://github.com/matrix-org/synapse/issues/8933), [\#8964](https://github.com/matrix-org/synapse/issues/8964))
- Fix bug introduced in Synapse v1.24.0 which would cause an exception on startup if both `enabled` and `localdb_enabled` were set to `False` in the `password_config` setting of the configuration file. ([\#8937](https://github.com/matrix-org/synapse/issues/8937))
- Fix a bug where 500 errors would be returned if the `m.room_history_visibility` event had invalid content. ([\#8945](https://github.com/matrix-org/synapse/issues/8945))
- Fix a bug causing common English words to not be considered for a user directory search. ([\#8959](https://github.com/matrix-org/synapse/issues/8959))
- Fix bug where application services couldn't register new ghost users if the server had reached its MAU limit. ([\#8962](https://github.com/matrix-org/synapse/issues/8962))
- Fix a long-standing bug where a `m.image` event without a `url` would cause errors on push. ([\#8965](https://github.com/matrix-org/synapse/issues/8965))
- Fix a small bug in v2 state resolution algorithm, which could also cause performance issues for rooms with large numbers of power levels. ([\#8971](https://github.com/matrix-org/synapse/issues/8971))
- Add validation to the `sendToDevice` API to raise a missing parameters error instead of a 500 error. ([\#8975](https://github.com/matrix-org/synapse/issues/8975))
- Add validation of group IDs to raise a 400 error instead of a 500 eror. ([\#8977](https://github.com/matrix-org/synapse/issues/8977))

Improved Documentation
----------------------

- Fix the \"Event persist rate\" section of the included grafana dashboard by adding missing prometheus rules. ([\#8802](https://github.com/matrix-org/synapse/issues/8802))
- Combine related media admin API docs. ([\#8839](https://github.com/matrix-org/synapse/issues/8839))
- Fix an error in the documentation for the SAML username mapping provider. ([\#8873](https://github.com/matrix-org/synapse/issues/8873))
- Clarify comments around template directories in `sample_config.yaml`. ([\#8891](https://github.com/matrix-org/synapse/issues/8891))
- Move instructions for database setup, adjusted heading levels and improved syntax highlighting in [INSTALL.md](../INSTALL.md). Contributed by @fossterer. ([\#8987](https://github.com/matrix-org/synapse/issues/8987))
- Update the example value of `group_creation_prefix` in the sample configuration. ([\#8992](https://github.com/matrix-org/synapse/issues/8992))
- Link the Synapse developer room to the development section in the docs. ([\#9002](https://github.com/matrix-org/synapse/issues/9002))

Deprecations and Removals
-------------------------

- Deprecate Shutdown Room and Purge Room Admin APIs. ([\#8829](https://github.com/matrix-org/synapse/issues/8829))

Internal Changes
----------------

- Properly store the mapping of external ID to Matrix ID for CAS users. ([\#8856](https://github.com/matrix-org/synapse/issues/8856), [\#8958](https://github.com/matrix-org/synapse/issues/8958))
- Remove some unnecessary stubbing from unit tests. ([\#8861](https://github.com/matrix-org/synapse/issues/8861))
- Remove unused `FakeResponse` class from unit tests. ([\#8864](https://github.com/matrix-org/synapse/issues/8864))
- Pass `room_id` to `get_auth_chain_difference`. ([\#8879](https://github.com/matrix-org/synapse/issues/8879))
- Add type hints to push module. ([\#8880](https://github.com/matrix-org/synapse/issues/8880), [\#8882](https://github.com/matrix-org/synapse/issues/8882), [\#8901](https://github.com/matrix-org/synapse/issues/8901), [\#8940](https://github.com/matrix-org/synapse/issues/8940), [\#8943](https://github.com/matrix-org/synapse/issues/8943), [\#9020](https://github.com/matrix-org/synapse/issues/9020))
- Simplify logic for handling user-interactive-auth via single-sign-on servers. ([\#8881](https://github.com/matrix-org/synapse/issues/8881))
- Skip the SAML tests if the requirements (`pysaml2` and `xmlsec1`) aren't available. ([\#8905](https://github.com/matrix-org/synapse/issues/8905))
- Fix multiarch docker image builds. ([\#8906](https://github.com/matrix-org/synapse/issues/8906))
- Don't publish `latest` docker image until all archs are built. ([\#8909](https://github.com/matrix-org/synapse/issues/8909))
- Various clean-ups to the structured logging and logging context code. ([\#8916](https://github.com/matrix-org/synapse/issues/8916), [\#8935](https://github.com/matrix-org/synapse/issues/8935))
- Automatically drop stale forward-extremities under some specific conditions. ([\#8929](https://github.com/matrix-org/synapse/issues/8929))
- Refactor test utilities for injecting HTTP requests. ([\#8946](https://github.com/matrix-org/synapse/issues/8946))
- Add a maximum size of 50 kilobytes to .well-known lookups. ([\#8950](https://github.com/matrix-org/synapse/issues/8950))
- Fix bug in `generate_log_config` script which made it write empty files. ([\#8952](https://github.com/matrix-org/synapse/issues/8952))
- Clean up tox.ini file; disable coverage checking for non-test runs. ([\#8963](https://github.com/matrix-org/synapse/issues/8963))
- Add type hints to the admin and room list handlers. ([\#8973](https://github.com/matrix-org/synapse/issues/8973))
- Add type hints to the receipts and user directory handlers. ([\#8976](https://github.com/matrix-org/synapse/issues/8976))
- Drop the unused `local_invites` table. ([\#8979](https://github.com/matrix-org/synapse/issues/8979))
- Add type hints to the base storage code. ([\#8980](https://github.com/matrix-org/synapse/issues/8980))
- Support using PyJWT v2.0.0 in the test suite. ([\#8986](https://github.com/matrix-org/synapse/issues/8986))
- Fix `tests.federation.transport.RoomDirectoryFederationTests` and ensure it runs in CI. ([\#8998](https://github.com/matrix-org/synapse/issues/8998))
- Add type hints to the crypto module. ([\#8999](https://github.com/matrix-org/synapse/issues/8999))")`
…

`[77c50e6](/NetBSD/pkgsrc/commit/77c50e6d6eba834d4ef70412227be0506fc9a3e3)`

```
Synapse 1.25.0 (2021-01-13)
===========================

Ending Support for Python 3.5 and Postgres 9.5
----------------------------------------------

With this release, the Synapse team is announcing a formal deprecation policy for our platform dependencies, like Python and PostgreSQL:

All future releases of Synapse will follow the upstream end-of-life schedules.

Which means:

* This is the last release which guarantees support for Python 3.5.
* We will end support for PostgreSQL 9.5 early next month.
* We will end support for Python 3.6 and PostgreSQL 9.6 near the end of the year.

Crucially, this means __we will not produce .deb packages for Debian 9 (Stretch) or Ubuntu 16.04 (Xenial)__ beyond the transition period described below.

The website <https://endoflife.date/> has convenient summaries of the support schedules for projects like [Python](<https://endoflife.date/python>) and [PostgreSQL](<https://endoflife.date/postgresql>).

If you are unable to upgrade your environment to a supported version of Python or Postgres, we encourage you to consider using the [Synapse Docker images](./INSTALL.md#docker-images-and-ansible-playbooks) instead.

### Transition Period

We will make a good faith attempt to avoid breaking compatibility in all releases through the end of March 2021. However, critical security vulnerabilities in dependencies or other unanticipated circumstances may arise which necessitate breaking compatibility earlier.

We intend to continue producing .deb packages for Debian 9 (Stretch) and Ubuntu 16.04 (Xenial) through the transition period.

Removal warning
---------------

The old [Purge Room API](<https://github.com/matrix-org/synapse/tree/master/docs/admin_api/purge_room.md>)
and [Shutdown Room API](<https://github.com/matrix-org/synapse/tree/master/docs/admin_api/shutdown_room.md>)
are deprecated and will be removed in a future release. They will be replaced by the
[Delete Room API](<https://github.com/matrix-org/synapse/tree/master/docs/admin_api/rooms.md#delete-room-api>).

`POST /_synapse/admin/v1/rooms/<room_id>/delete` replaces `POST /_synapse/admin/v1/purge_room` and
`POST /_synapse/admin/v1/shutdown_room/<room_id>`.

Bugfixes
--------

- Fix HTTP proxy support when using a proxy that is on a blacklisted IP. Introduced in v1.25.0rc1. Contributed by [@Bubu](https://github.com/Bubu). ([\#9084]([matrix-org/synapse#9084](https://github.com/matrix-org/synapse/pull/9084)))

Synapse 1.25.0rc1 (2021-01-06)
==============================

Features
--------

- Add an admin API that lets server admins get power in rooms in which local users have power. ([\#8756]([matrix-org/synapse#8756](https://github.com/matrix-org/synapse/pull/8756)))
- Add optional HTTP authentication to replication endpoints. ([\#8853]([matrix-org/synapse#8853](https://github.com/matrix-org/synapse/pull/8853)))
- Improve the error messages printed as a result of configuration problems for extension modules. ([\#8874]([matrix-org/synapse#8874](https://github.com/matrix-org/synapse/pull/8874)))
- Add the number of local devices to Room Details Admin API. Contributed by [@dklimpel](https://github.com/dklimpel). ([\#8886]([matrix-org/synapse#8886](https://github.com/matrix-org/synapse/pull/8886)))
- Add `X-Robots-Tag` header to stop web crawlers from indexing media. Contributed by Aaron Raimist. ([\#8887]([matrix-org/synapse#8887](https://github.com/matrix-org/synapse/pull/8887)))
- Spam-checkers may now define their methods as `async`. ([\#8890]([matrix-org/synapse#8890](https://github.com/matrix-org/synapse/pull/8890)))
- Add support for allowing users to pick their own user ID during a single-sign-on login. ([\#8897]([matrix-org/synapse#8897](https://github.com/matrix-org/synapse/pull/8897)), [\#8900]([matrix-org/synapse#8900](https://github.com/matrix-org/synapse/pull/8900)), [\#8911]([matrix-org/synapse#8911](https://github.com/matrix-org/synapse/pull/8911)), [\#8938]([matrix-org/synapse#8938](https://github.com/matrix-org/synapse/pull/8938)), [\#8941]([matrix-org/synapse#8941](https://github.com/matrix-org/synapse/pull/8941)), [\#8942]([matrix-org/synapse#8942](https://github.com/matrix-org/synapse/pull/8942)), [\#8951]([matrix-org/synapse#8951](https://github.com/matrix-org/synapse/pull/8951)))
- Add an `email.invite_client_location` configuration option to send a web client location to the invite endpoint on the identity server which allows customisation of the email template. ([\#8930]([matrix-org/synapse#8930](https://github.com/matrix-org/synapse/pull/8930)))
- The search term in the list room and list user Admin APIs is now treated as case-insensitive. ([\#8931]([matrix-org/synapse#8931](https://github.com/matrix-org/synapse/pull/8931)))
- Apply an IP range blacklist to push and key revocation requests. ([\#8821]([matrix-org/synapse#8821](https://github.com/matrix-org/synapse/pull/8821)), [\#8870]([matrix-org/synapse#8870](https://github.com/matrix-org/synapse/pull/8870)), [\#8954]([matrix-org/synapse#8954](https://github.com/matrix-org/synapse/pull/8954)))
- Add an option to allow re-use of user-interactive authentication sessions for a period of time. ([\#8970]([matrix-org/synapse#8970](https://github.com/matrix-org/synapse/pull/8970)))
- Allow running the redact endpoint on workers. ([\#8994]([matrix-org/synapse#8994](https://github.com/matrix-org/synapse/pull/8994)))

Bugfixes
--------

- Fix bug where we might not correctly calculate the current state for rooms with multiple extremities. ([\#8827]([matrix-org/synapse#8827](https://github.com/matrix-org/synapse/pull/8827)))
- Fix a long-standing bug in the register admin endpoint (`/_synapse/admin/v1/register`) when the `mac` field was not provided. The endpoint now properly returns a 400 error. Contributed by [@edwargix](https://github.com/edwargix). ([\#8837]([matrix-org/synapse#8837](https://github.com/matrix-org/synapse/pull/8837)))
- Fix a long-standing bug on Synapse instances supporting Single-Sign-On, where users would be prompted to enter their password to confirm certain actions, even though they have not set a password. ([\#8858]([matrix-org/synapse#8858](https://github.com/matrix-org/synapse/pull/8858)))
- Fix a longstanding bug where a 500 error would be returned if the `Content-Length` header was not provided to the upload media resource. ([\#8862]([matrix-org/synapse#8862](https://github.com/matrix-org/synapse/pull/8862)))
- Add additional validation to pusher URLs to be compliant with the specification. ([\#8865]([matrix-org/synapse#8865](https://github.com/matrix-org/synapse/pull/8865)))
- Fix the error code that is returned when a user tries to register on a homeserver on which new-user registration has been disabled. ([\#8867]([matrix-org/synapse#8867](https://github.com/matrix-org/synapse/pull/8867)))
- Fix a bug where `PUT /_synapse/admin/v2/users/<user_id>` failed to create a new user when `avatar_url` is specified. Bug introduced in Synapse v1.9.0. ([\#8872]([matrix-org/synapse#8872](https://github.com/matrix-org/synapse/pull/8872)))
- Fix a 500 error when attempting to preview an empty HTML file. ([\#8883]([matrix-org/synapse#8883](https://github.com/matrix-org/synapse/pull/8883)))
- Fix occasional deadlock when handling SIGHUP. ([\#8918]([matrix-org/synapse#8918](https://github.com/matrix-org/synapse/pull/8918)))
- Fix login API to not ratelimit application services that have ratelimiting disabled. ([\#8920]([matrix-org/synapse#8920](https://github.com/matrix-org/synapse/pull/8920)))
- Fix bug where we ratelimited auto joining of rooms on registration (using `auto_join_rooms` config). ([\#8921]([matrix-org/synapse#8921](https://github.com/matrix-org/synapse/pull/8921)))
- Fix a bug where deactivated users appeared in the user directory when their profile information was updated. ([\#8933]([matrix-org/synapse#8933](https://github.com/matrix-org/synapse/pull/8933)), [\#8964]([matrix-org/synapse#8964](https://github.com/matrix-org/synapse/pull/8964)))
- Fix bug introduced in Synapse v1.24.0 which would cause an exception on startup if both `enabled` and `localdb_enabled` were set to `False` in the `password_config` setting of the configuration file. ([\#8937]([matrix-org/synapse#8937](https://github.com/matrix-org/synapse/pull/8937)))
- Fix a bug where 500 errors would be returned if the `m.room_history_visibility` event had invalid content. ([\#8945]([matrix-org/synapse#8945](https://github.com/matrix-org/synapse/pull/8945)))
- Fix a bug causing common English words to not be considered for a user directory search. ([\#8959]([matrix-org/synapse#8959](https://github.com/matrix-org/synapse/pull/8959)))
- Fix bug where application services couldn't register new ghost users if the server had reached its MAU limit. ([\#8962]([matrix-org/synapse#8962](https://github.com/matrix-org/synapse/pull/8962)))
- Fix a long-standing bug where a `m.image` event without a `url` would cause errors on push. ([\#8965]([matrix-org/synapse#8965](https://github.com/matrix-org/synapse/pull/8965)))
- Fix a small bug in v2 state resolution algorithm, which could also cause performance issues for rooms with large numbers of power levels. ([\#8971]([matrix-org/synapse#8971](https://github.com/matrix-org/synapse/pull/8971)))
- Add validation to the `sendToDevice` API to raise a missing parameters error instead of a 500 error. ([\#8975]([matrix-org/synapse#8975](https://github.com/matrix-org/synapse/pull/8975)))
- Add validation of group IDs to raise a 400 error instead of a 500 eror. ([\#8977]([matrix-org/synapse#8977](https://github.com/matrix-org/synapse/pull/8977)))

Improved Documentation
----------------------

- Fix the "Event persist rate" section of the included grafana dashboard by adding missing prometheus rules. ([\#8802]([matrix-org/synapse#8802](https://github.com/matrix-org/synapse/pull/8802)))
- Combine related media admin API docs. ([\#8839]([matrix-org/synapse#8839](https://github.com/matrix-org/synapse/pull/8839)))
- Fix an error in the documentation for the SAML username mapping provider. ([\#8873]([matrix-org/synapse#8873](https://github.com/matrix-org/synapse/pull/8873)))
- Clarify comments around template directories in `sample_config.yaml`. ([\#8891]([matrix-org/synapse#8891](https://github.com/matrix-org/synapse/pull/8891)))
- Move instructions for database setup, adjusted heading levels and improved syntax highlighting in [INSTALL.md](../INSTALL.md). Contributed by [@fossterer](https://github.com/fossterer). ([\#8987]([matrix-org/synapse#8987](https://github.com/matrix-org/synapse/pull/8987)))
- Update the example value of `group_creation_prefix` in the sample configuration. ([\#8992]([matrix-org/synapse#8992](https://github.com/matrix-org/synapse/pull/8992)))
- Link the Synapse developer room to the development section in the docs. ([\#9002]([matrix-org/synapse#9002](https://github.com/matrix-org/synapse/pull/9002)))

Deprecations and Removals
-------------------------

- Deprecate Shutdown Room and Purge Room Admin APIs. ([\#8829]([matrix-org/synapse#8829](https://github.com/matrix-org/synapse/pull/8829)))

Internal Changes
----------------

- Properly store the mapping of external ID to Matrix ID for CAS users. ([\#8856]([matrix-org/synapse#8856](https://github.com/matrix-org/synapse/pull/8856)), [\#8958]([matrix-org/synapse#8958](https://github.com/matrix-org/synapse/pull/8958)))
- Remove some unnecessary stubbing from unit tests. ([\#8861]([matrix-org/synapse#8861](https://github.com/matrix-org/synapse/pull/8861)))
- Remove unused `FakeResponse` class from unit tests. ([\#8864]([matrix-org/synapse#8864](https://github.com/matrix-org/synapse/pull/8864)))
- Pass `room_id` to `get_auth_chain_difference`. ([\#8879]([matrix-org/synapse#8879](https://github.com/matrix-org/synapse/pull/8879)))
- Add type hints to push module. ([\#8880]([matrix-org/synapse#8880](https://github.com/matrix-org/synapse/pull/8880)), [\#8882]([matrix-org/synapse#8882](https://github.com/matrix-org/synapse/pull/8882)), [\#8901]([matrix-org/synapse#8901](https://github.com/matrix-org/synapse/pull/8901)), [\#8940]([matrix-org/synapse#8940](https://github.com/matrix-org/synapse/pull/8940)), [\#8943]([matrix-org/synapse#8943](https://github.com/matrix-org/synapse/pull/8943)), [\#9020]([matrix-org/synapse#9020](https://github.com/matrix-org/synapse/pull/9020)))
- Simplify logic for handling user-interactive-auth via single-sign-on servers. ([\#8881]([matrix-org/synapse#8881](https://github.com/matrix-org/synapse/pull/8881)))
- Skip the SAML tests if the requirements (`pysaml2` and `xmlsec1`) aren't available. ([\#8905]([matrix-org/synapse#8905](https://github.com/matrix-org/synapse/pull/8905)))
- Fix multiarch docker image builds. ([\#8906]([matrix-org/synapse#8906](https://github.com/matrix-org/synapse/pull/8906)))
- Don't publish `latest` docker image until all archs are built. ([\#8909]([matrix-org/synapse#8909](https://github.com/matrix-org/synapse/pull/8909)))
- Various clean-ups to the structured logging and logging context code. ([\#8916]([matrix-org/synapse#8916](https://github.com/matrix-org/synapse/pull/8916)), [\#8935]([matrix-org/synapse#8935](https://github.com/matrix-org/synapse/pull/8935)))
- Automatically drop stale forward-extremities under some specific conditions. ([\#8929]([matrix-org/synapse#8929](https://github.com/matrix-org/synapse/pull/8929)))
- Refactor test utilities for injecting HTTP requests. ([\#8946]([matrix-org/synapse#8946](https://github.com/matrix-org/synapse/pull/8946)))
- Add a maximum size of 50 kilobytes to .well-known lookups. ([\#8950]([matrix-org/synapse#8950](https://github.com/matrix-org/synapse/pull/8950)))
- Fix bug in `generate_log_config` script which made it write empty files. ([\#8952]([matrix-org/synapse#8952](https://github.com/matrix-org/synapse/pull/8952)))
- Clean up tox.ini file; disable coverage checking for non-test runs. ([\#8963]([matrix-org/synapse#8963](https://github.com/matrix-org/synapse/pull/8963)))
- Add type hints to the admin and room list handlers. ([\#8973]([matrix-org/synapse#8973](https://github.com/matrix-org/synapse/pull/8973)))
- Add type hints to the receipts and user directory handlers. ([\#8976]([matrix-org/synapse#8976](https://github.com/matrix-org/synapse/pull/8976)))
- Drop the unused `local_invites` table. ([\#8979]([matrix-org/synapse#8979](https://github.com/matrix-org/synapse/pull/8979)))
- Add type hints to the base storage code. ([\#8980]([matrix-org/synapse#8980](https://github.com/matrix-org/synapse/pull/8980)))
- Support using PyJWT v2.0.0 in the test suite. ([\#8986]([matrix-org/synapse#8986](https://github.com/matrix-org/synapse/pull/8986)))
- Fix `tests.federation.transport.RoomDirectoryFederationTests` and ensure it runs in CI. ([\#8998]([matrix-org/synapse#8998](https://github.com/matrix-org/synapse/pull/8998)))
- Add type hints to the crypto module. ([\#8999]([matrix-org/synapse#8999](https://github.com/matrix-org/synapse/pull/8999)))
```

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&u=794f0e1fb2bba9a17208cd1b64823f86d55bb7e0&v=4)](/clokep)
[clokep](/clokep)
mentioned this pull request
[Jan 18, 2021](#ref-issue-787224717)

[UnboundLocalError raised when response body exceeds max size
#9132](/matrix-org/synapse/issues/9132)

Closed

[![@aaronraimist](https://avatars.githubusercontent.com/u/5855073?s=40&v=4)](/aaronraimist)
[aaronraimist](/aaronraimist)
mentioned this pull request
[Apr 10, 2021](#ref-pullrequest-599203500)

[MSC2499: Fixes for Well-known URIs
matrix-org/matrix-spec-proposals#2499](/matrix-org/matrix-spec-proposals/pull/2499)
 Open

[![ghost](https://avatars.githubusercontent.com/u/10137?s=60&v=4)](/ghost)

**[ghost](/ghost)**
reviewed
[May 15, 2021](#pullrequestreview-660388793)

 [View reviewed changes](/matrix-org/synapse/pull/8950/files/57391a486145310168325e4194075248ff3bb659)

Copy link

### @ghost **[ghost](/ghost)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Reviewed changes

Sorry, something went wrong.

All reactions

[Sign up for free](/join?source=comment-repo)
**to subscribe to this conversation on GitHub**.
Already have an account?
[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F8950).

Reviewers

[![@richvdh](https://avatars.githubusercontent.com/u/1389908?s=40&v=4)](/richvdh) [richvdh](/richvdh)

richvdh approved these changes

Assignees

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep) [clokep](/clokep)

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=52&v=4)](/clokep) [![@tulir](https://avatars.githubusercontent.com/u/4224639?s=52&v=4)](/tulir) [![@richvdh](https://avatars.githubusercontent.com/u/1389908?s=52&v=4)](/richvdh)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_42ce0734_20250114_202846.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Freleases%2Ftag%2Fv1.25.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Freleases%2Ftag%2Fv1.25.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse/tree/v1.25.0)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse/tree/v1.25.0)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

1. [Releases](/matrix-org/synapse/releases)
2. [v1.25.0](/matrix-org/synapse/releases/tag/v1.25.0)

# v1.25.0

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/matrix-org/synapse/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v1.25.0)

 Loading

[View all tags](/matrix-org/synapse/tags)

![@erikjohnston](https://avatars.githubusercontent.com/u/8428120?s=40&v=4)
[erikjohnston](/erikjohnston)
released this
13 Jan 10:35

·
[5343 commits](/matrix-org/synapse/compare/v1.25.0...develop)
to develop
since this release

[v1.25.0](/matrix-org/synapse/tree/v1.25.0)

This tag was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/8428120?s=64&v=4)](/erikjohnston)
[erikjohnston](/erikjohnston)
Erik Johnston

GPG key ID: A542E4ED1B0FAC09

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

[`ebd534b`](/matrix-org/synapse/commit/ebd534b58d9d53dc5086a9dd9cb176868c7b93ef)

# Synapse 1.25.0 (2021-01-13)

## Ending Support for Python 3.5 and Postgres 9.5

With this release, the Synapse team is announcing a formal deprecation policy for our platform dependencies, like Python and PostgreSQL:

All future releases of Synapse will follow the upstream end-of-life schedules.

Which means:

* This is the last release which guarantees support for Python 3.5.
* We will end support for PostgreSQL 9.5 early next month.
* We will end support for Python 3.6 and PostgreSQL 9.6 near the end of the year.

Crucially, this means **we will not produce .deb packages for Debian 9 (Stretch) or Ubuntu 16.04 (Xenial)** beyond the transition period described below.

The website <https://endoflife.date/> has convenient summaries of the support schedules for projects like [Python](https://endoflife.date/python) and [PostgreSQL](https://endoflife.date/postgresql).

If you are unable to upgrade your environment to a supported version of Python or Postgres, we encourage you to consider using the [Synapse Docker images](/matrix-org/synapse/blob/v1.25.0/INSTALL.md#docker-images-and-ansible-playbooks) instead.

### Transition Period

We will make a good faith attempt to avoid breaking compatibility in all releases through the end of March 2021. However, critical security vulnerabilities in dependencies or other unanticipated circumstances may arise which necessitate breaking compatibility earlier.

We intend to continue producing .deb packages for Debian 9 (Stretch) and Ubuntu 16.04 (Xenial) through the transition period.

## Removal warning

The old [Purge Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/purge_room.md)

and [Shutdown Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/shutdown_room.md)

are deprecated and will be removed in a future release. They will be replaced by the

[Delete Room API](https://github.com/matrix-org/synapse/tree/master/docs/admin_api/rooms.md#delete-room-api).

`POST /_synapse/admin/v1/rooms/<room_id>/delete` replaces `POST /_synapse/admin/v1/purge_room` and

`POST /_synapse/admin/v1/shutdown_room/<room_id>`.

## Bugfixes

* Fix HTTP proxy support when using a proxy that is on a blacklisted IP. Introduced in v1.25.0rc1. Contributed by [@Bubu](https://github.com/Bubu). ([#9084](https://github.com/matrix-org/synapse/issues/9084))

# Synapse 1.25.0rc1 (2021-01-06)

## Features

* Add an admin API that lets server admins get power in rooms in which local users have power. ([#8756](https://github.com/matrix-org/synapse/issues/8756))
* Add optional HTTP authentication to replication endpoints. ([#8853](https://github.com/matrix-org/synapse/issues/8853))
* Improve the error messages printed as a result of configuration problems for extension modules. ([#8874](https://github.com/matrix-org/synapse/issues/8874))
* Add the number of local devices to Room Details Admin API. Contributed by [@dklimpel](https://github.com/dklimpel). ([#8886](https://github.com/matrix-org/synapse/issues/8886))
* Add `X-Robots-Tag` header to stop web crawlers from indexing media. Contributed by Aaron Raimist. ([#8887](https://github.com/matrix-org/synapse/issues/8887))
* Spam-checkers may now define their methods as `async`. ([#8890](https://github.com/matrix-org/synapse/issues/8890))
* Add support for allowing users to pick their own user ID during a single-sign-on login. ([#8897](https://github.com/matrix-org/synapse/issues/8897), [#8900](https://github.com/matrix-org/synapse/issues/8900), [#8911](https://github.com/matrix-org/synapse/issues/8911), [#8938](https://github.com/matrix-org/synapse/issues/8938), [#8941](https://github.com/matrix-org/synapse/issues/8941), [#8942](https://github.com/matrix-org/synapse/issues/8942), [#8951](https://github.com/matrix-org/synapse/issues/8951))
* Add an `email.invite_client_location` configuration option to send a web client location to the invite endpoint on the identity server which allows customisation of the email template. ([#8930](https://github.com/matrix-org/synapse/issues/8930))
* The search term in the list room and list user Admin APIs is now treated as case-insensitive. ([#8931](https://github.com/matrix-org/synapse/issues/8931))
* Apply an IP range blacklist to push and key revocation requests. ([#8821](https://github.com/matrix-org/synapse/issues/8821), [#8870](https://github.com/matrix-org/synapse/issues/8870), [#8954](https://github.com/matrix-org/synapse/issues/8954))
* Add an option to allow re-use of user-interactive authentication sessions for a period of time. ([#8970](https://github.com/matrix-org/synapse/issues/8970))
* Allow running the redact endpoint on workers. ([#8994](https://github.com/matrix-org/synapse/issues/8994))

## Bugfixes

* Fix bug where we might not correctly calculate the current state for rooms with multiple extremities. ([#8827](https://github.com/matrix-org/synapse/issues/8827))
* Fix a long-standing bug in the register admin endpoint (`/_synapse/admin/v1/register`) when the `mac` field was not provided. The endpoint now properly returns a 400 error. Contributed by [@edwargix](https://github.com/edwargix). ([#8837](https://github.com/matrix-org/synapse/issues/8837))
* Fix a long-standing bug on Synapse instances supporting Single-Sign-On, where users would be prompted to enter their password to confirm certain actions, even though they have not set a password. ([#8858](https://github.com/matrix-org/synapse/issues/8858))
* Fix a longstanding bug where a 500 error would be returned if the `Content-Length` header was not provided to the upload media resource. ([#8862](https://github.com/matrix-org/synapse/issues/8862))
* Add additional validation to pusher URLs to be compliant with the specification. ([#8865](https://github.com/matrix-org/synapse/issues/8865))
* Fix the error code that is returned when a user tries to register on a homeserver on which new-user registration has been disabled. ([#8867](https://github.com/matrix-org/synapse/issues/8867))
* Fix a bug where `PUT /_synapse/admin/v2/users/<user_id>` failed to create a new user when `avatar_url` is specified. Bug introduced in Synapse v1.9.0. ([#8872](https://github.com/matrix-org/synapse/issues/8872))
* Fix a 500 error when attempting to preview an empty HTML file. ([#8883](https://github.com/matrix-org/synapse/issues/8883))
* Fix occasional deadlock when handling SIGHUP. ([#8918](https://github.com/matrix-org/synapse/issues/8918))
* Fix login API to not ratelimit application services that have ratelimiting disabled. ([#8920](https://github.com/matrix-org/synapse/issues/8920))
* Fix bug where we ratelimited auto joining of rooms on registration (using `auto_join_rooms` config). ([#8921](https://github.com/matrix-org/synapse/issues/8921))
* Fix a bug where deactivated users appeared in the user directory when their profile information was updated. ([#8933](https://github.com/matrix-org/synapse/issues/8933), [#8964](https://github.com/matrix-org/synapse/issues/8964))
* Fix bug introduced in Synapse v1.24.0 which would cause an exception on startup if both `enabled` and `localdb_enabled` were set to `False` in the `password_config` setting of the configuration file. ([#8937](https://github.com/matrix-org/synapse/issues/8937))
* Fix a bug where 500 errors would be returned if the `m.room_history_visibility` event had invalid content. ([#8945](https://github.com/matrix-org/synapse/issues/8945))
* Fix a bug causing common English words to not be considered for a user directory search. ([#8959](https://github.com/matrix-org/synapse/issues/8959))
* Fix bug where application services couldn't register new ghost users if the server had reached its MAU limit. ([#8962](https://github.com/matrix-org/synapse/issues/8962))
* Fix a long-standing bug where a `m.image` event without a `url` would cause errors on push. ([#8965](https://github.com/matrix-org/synapse/issues/8965))
* Fix a small bug in v2 state resolution algorithm, which could also cause performance issues for rooms with large numbers of power levels. ([#8971](https://github.com/matrix-org/synapse/issues/8971))
* Add validation to the `sendToDevice` API to raise a missing parameters error instead of a 500 error. ([#8975](https://github.com/matrix-org/synapse/issues/8975))
* Add validation of group IDs to raise a 400 error instead of a 500 eror. ([#8977](https://github.com/matrix-org/synapse/issues/8977))

## Improved Documentation

* Fix the "Event persist rate" section of the included grafana dashboard by adding missing prometheus rules. ([#8802](https://github.com/matrix-org/synapse/issues/8802))
* Combine related media admin API docs. ([#8839](https://github.com/matrix-org/synapse/issues/8839))
* Fix an error in the documentation for the SAML username mapping provider. ([#8873](https://github.com/matrix-org/synapse/issues/8873))
* Clarify comments around template directories in `sample_config.yaml`. ([#8891](https://github.com/matrix-org/synapse/issues/8891))
* Move instructions for database setup, adjusted heading levels and improved syntax highlighting in [INSTALL.md](/matrix-org/synapse/blob/INSTALL.md). Contributed by [@fossterer](https://github.com/fossterer). ([#8987](https://github.com/matrix-org/synapse/issues/8987))
* Update the example value of `group_creation_prefix` in the sample configuration. ([#8992](https://github.com/matrix-org/synapse/issues/8992))
* Link the Synapse developer room to the development section in the docs. ([#9002](https://github.com/matrix-org/synapse/issues/9002))

## Deprecations and Removals

* Deprecate Shutdown Room and Purge Room Admin APIs. ([#8829](https://github.com/matrix-org/synapse/issues/8829))

## Internal Changes

* Properly store the mapping of external ID to Matrix ID for CAS users. ([#8856](https://github.com/matrix-org/synapse/issues/8856), [#8958](https://github.com/matrix-org/synapse/issues/8958))
* Remove some unnecessary stubbing from unit tests. ([#8861](https://github.com/matrix-org/synapse/issues/8861))
* Remove unused `FakeResponse` class from unit tests. ([#8864](https://github.com/matrix-org/synapse/issues/8864))
* Pass `room_id` to `get_auth_chain_difference`. ([#8879](https://github.com/matrix-org/synapse/issues/8879))
* Add type hints to push module. ([#8880](https://github.com/matrix-org/synapse/issues/8880), [#8882](https://github.com/matrix-org/synapse/issues/8882), [#8901](https://github.com/matrix-org/synapse/issues/8901), [#8940](https://github.com/matrix-org/synapse/issues/8940), [#8943](https://github.com/matrix-org/synapse/issues/8943), [#9020](https://github.com/matrix-org/synapse/issues/9020))
* Simplify logic for handling user-interactive-auth via single-sign-on servers. ([#8881](https://github.com/matrix-org/synapse/issues/8881))
* Skip the SAML tests if the requirements (`pysaml2` and `xmlsec1`) aren't available. ([#8905](https://github.com/matrix-org/synapse/issues/8905))
* Fix multiarch docker image builds. ([#8906](https://github.com/matrix-org/synapse/issues/8906))
* Don't publish `latest` docker image until all archs are built. ([#8909](https://github.com/matrix-org/synapse/issues/8909))
* Various clean-ups to the structured logging and logging context code. ([#8916](https://github.com/matrix-org/synapse/issues/8916), [#8935](https://github.com/matrix-org/synapse/issues/8935))
* Automatically drop stale forward-extremities under some specific conditions. ([#8929](https://github.com/matrix-org/synapse/issues/8929))
* Refactor test utilities for injecting HTTP requests. ([#8946](https://github.com/matrix-org/synapse/issues/8946))
* Add a maximum size of 50 kilobytes to .well-known lookups. ([#8950](https://github.com/matrix-org/synapse/issues/8950))
* Fix bug in `generate_log_config` script which made it write empty files. ([#8952](https://github.com/matrix-org/synapse/issues/8952))
* Clean up tox.ini file; disable coverage checking for non-test runs. ([#8963](https://github.com/matrix-org/synapse/issues/8963))
* Add type hints to the admin and room list handlers. ([#8973](https://github.com/matrix-org/synapse/issues/8973))
* Add type hints to the receipts and user directory handlers. ([#8976](https://github.com/matrix-org/synapse/issues/8976))
* Drop the unused `local_invites` table. ([#8979](https://github.com/matrix-org/synapse/issues/8979))
* Add type hints to the base storage code. ([#8980](https://github.com/matrix-org/synapse/issues/8980))
* Support using PyJWT v2.0.0 in the test suite. ([#8986](https://github.com/matrix-org/synapse/issues/8986))
* Fix `tests.federation.transport.RoomDirectoryFederationTests` and ensure it runs in CI. ([#8998](https://github.com/matrix-org/synapse/issues/8998))
* Add type hints to the crypto module. ([#8999](https://github.com/matrix-org/synapse/issues/8999))

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c45ca5aa_20250114_202849.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fsecurity%2Fadvisories%2FGHSA-2hwx-mjrm-v3g8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fsecurity%2Fadvisories%2FGHSA-2hwx-mjrm-v3g8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

# Denial of service attack via .well-known lookups

Low

[clokep](/clokep)
published
GHSA-2hwx-mjrm-v3g8
Feb 25, 2021

## Package

pip

matrix-synapse
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

> 0.99.0

## Patched versions

>= 1.25.0

## Description

### Impact

A malicious homeserver could redirect requests to their .well-known file to a large file. This can lead to a denial of service attack where homeservers will consume significantly more resources when requesting the .well-known file of a malicious homeserver.

This affects any server which accepts federation requests from untrusted servers.

### Patches

Issue is resolved by [#8950](https://github.com/matrix-org/synapse/pull/8950). A bug not affecting the security aspects of this was fixed in [#9108](https://github.com/matrix-org/synapse/pull/9108).

### Workarounds

The `federation_domain_whitelist` setting can be used to restrict the homeservers communicated with over federation.

### Severity

Low

### CVE ID

CVE-2021-21274

### Weaknesses

No CWEs

### Credits

* [![@mscherer](https://avatars.githubusercontent.com/u/230335?s=40&v=4)](/mscherer)
  [mscherer](/mscherer)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.fedoraproject.org_ad82ac63_20250114_202849.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY.mbox.gz?message=TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY/#TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY)

# [SECURITY] Fedora 34 Update: matrix-synapse-1.38.1-1.fc34

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

1 Aug
2021

1 Aug
'21

9:05 p.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2021-a627cfd31e
2021-08-02 01:02:57.308573
--------------------------------------------------------------------------------

Name : matrix-synapse
Product : Fedora 34
Version : 1.38.1
Release : 1.fc34
URL : <https://github.com/matrix-org/synapse>
Summary : A Matrix reference homeserver written in Python using Twisted
Description :
Matrix is an ambitious new ecosystem for open federated Instant Messaging and
VoIP. Synapse is a reference "homeserver" implementation of Matrix from the
core development team at matrix.org, written in Python/Twisted. It is intended
to showcase the concept of Matrix and let folks see the spec in the context of
a coded base and let you run your own homeserver and generally help bootstrap
the ecosystem.

--------------------------------------------------------------------------------
Update Information:

Update to v1.38.1 ---- New upstream release 1.38.0, incorporating a number of
important security fixes. Upstream changelog: <https://github.com/matrix->
org/synapse/blob/v1.38.0/CHANGES.md Upstream upgrade notes: <https://matrix->
org.github.io/synapse/develop/upgrade#upgrading-to-v1380
--------------------------------------------------------------------------------
ChangeLog:

\* Fri Jul 23 2021 Kai A. Hiller V02460@gmail.com - 1.38.1-1
- Update to v1.38.1
\* Thu Jul 22 2021 Fedora Release Engineering releng@fedoraproject.org - 1.38.0-3
- Rebuilt for <https://fedoraproject.org/wiki/Fedora_35_Mass_Rebuild>
\* Sun Jul 18 2021 Dan Callaghan djc@djc.id.au - 1.38.0-2
- fix startup ordering of synapse.service (RHBZ#1910740)
- relax version requirement for python3-cryptography
\* Wed Jul 14 2021 Kai A. Hiller V02460@gmail.com - 1.38.0-1
- Update to v1.38.0
\* Fri Jun 4 2021 Python Maint python-maint@redhat.com - 1.26.0-3
- Rebuilt for Python 3.10
\* Tue Mar 2 2021 Zbigniew J��drzejewski-Szmek zbyszek@in.waw.pl - 1.26.0-2
- Rebuilt for updated systemd-rpm-macros
See <https://pagure.io/fesco/issue/2583>.
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #1910740 - synapse.service can fail if it starts before postgresql is ready
<https://bugzilla.redhat.com/show_bug.cgi?id=1910740>
[ 2 ] Bug #1918426 - matrix-synapse-1.38.0 is available
<https://bugzilla.redhat.com/show_bug.cgi?id=1918426>
[ 3 ] Bug #1934603 - CVE-2021-21274 matrix-synapse: DoS via .well-known lookups [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1934603>
[ 4 ] Bug #1934606 - CVE-2021-21273 matrix-synapse: open redirects on some federation and push requests [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1934606>
[ 5 ] Bug #1944136 - CVE-2021-21332 matrix-synapse: password reset endpoint is vulnerable to XSS [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1944136>
[ 6 ] Bug #1944139 - CVE-2021-21333 matrix-synapse: HTML injection in email and account expiry notifications [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1944139>
[ 7 ] Bug #1949110 - CVE-2021-21393 matrix-synapse: Denial of service (via resource exhaustion) due to improper input validation on groups/communities endpoints [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1949110>
[ 8 ] Bug #1949112 - CVE-2021-21392 matrix-synapse: IP blacklist bypass via transitional IPv6 addresses on dual-stack networks [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1949112>
[ 9 ] Bug #1958801 - CVE-2021-21394 matrix-synapse: missing input validation may cause excessive use of disk space and memory [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1958801>
[ 10 ] Bug #1959542 - CVE-2021-29471 matrix-synapse: Denial-of-service when processing moderate length events [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=1959542>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2021-a627cfd31e' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY/#TNNAJOZNMVMXM6AS7RFFKB4QLUJ4IFEY)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from github.com_4b121c02_20250114_202840.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fcommit%2Fff5c4da1289cb5e097902b3e55b771be342c29d6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fcommit%2Fff5c4da1289cb5e097902b3e55b771be342c29d6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

## Commit

[Permalink](/matrix-org/synapse/commit/ff5c4da1289cb5e097902b3e55b771be342c29d6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add a maximum size for well-known lookups. ([#8950](https://github.com/matrix-org/synapse/pull/8950))

[Browse files](/matrix-org/synapse/tree/ff5c4da1289cb5e097902b3e55b771be342c29d6)
Browse the repository at this point in the history

* Loading branch information

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep)

[clokep](/matrix-org/synapse/commits?author=clokep "View all commits by clokep")
authored
Dec 16, 2020

1 parent
[e1b8e37](/matrix-org/synapse/commit/e1b8e37f936b115e2164d272333c9b15342e6f88)

commit ff5c4da

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**80 additions**
and
**18 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* changelog.d

  + changelog.d/8950.misc
    [8950.misc](#diff-a133b32f50a527f6026f4a4e223575e817815560530cb56219d5d5b14d782a42)
* synapse/http

  + synapse/http/client.py
    [client.py](#diff-66444b92f547d9edb90914be0717bbe92d7b02ce10b65b4546b6c629af563ae9)
  + federation

    - synapse/http/federation/well\_known\_resolver.py
      [well\_known\_resolver.py](#diff-46f71022105249f09ee6eb1cfcf3db83aeb37c73d908e58972989156792641f3)
  + synapse/http/matrixfederationclient.py
    [matrixfederationclient.py](#diff-a53ea02bf6a0cbb98e925b47e71f4ffb149075536543c1eca15366fc65c90aef)
* tests/http/federation

  + tests/http/federation/test\_matrix\_federation\_agent.py
    [test\_matrix\_federation\_agent.py](#diff-433005b0b4c240474be987e6288c5f7c4494e8e5eadb180640962c8b8c321cfc)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[changelog.d/8950.misc](#diff-a133b32f50a527f6026f4a4e223575e817815560530cb56219d5d5b14d782a42 "changelog.d/8950.misc")

Show comments

[View file](/matrix-org/synapse/blob/ff5c4da1289cb5e097902b3e55b771be342c29d6/changelog.d/8950.misc)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1 @@ |
|  |  | Add a maximum size of 50 kilobytes to .well-known lookups. |

32 changes: 18 additions & 14 deletions

32
[synapse/http/client.py](#diff-66444b92f547d9edb90914be0717bbe92d7b02ce10b65b4546b6c629af563ae9 "synapse/http/client.py")

Show comments

[View file](/matrix-org/synapse/blob/ff5c4da1289cb5e097902b3e55b771be342c29d6/synapse/http/client.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -720,11 +720,14 @@ async def get\_file( |
|  |  |  |
|  |  | try: |
|  |  | length = await make\_deferred\_yieldable( |
|  |  | readBodyToFile(response, output\_stream, max\_size) |
|  |  | read\_body\_with\_max\_size(response, output\_stream, max\_size) |
|  |  | ) |
|  |  | except BodyExceededMaxSize: |
|  |  | SynapseError( |
|  |  | 502, |
|  |  | "Requested file is too large > %r bytes" % (max\_size,), |
|  |  | Codes.TOO\_LARGE, |
|  |  | ) |
|  |  | except SynapseError: |
|  |  | # This can happen e.g. because the body is too large. |
|  |  | raise |
|  |  | except Exception as e: |
|  |  | raise SynapseError(502, ("Failed to download remote body: %s" % e)) from e |
|  |  |  |
| Expand All | | @@ -748,7 +751,11 @@ def \_timeout\_to\_request\_timed\_out\_error(f: Failure): |
|  |  | return f |
|  |  |  |
|  |  |  |
|  |  | class \_ReadBodyToFileProtocol(protocol.Protocol): |
|  |  | class BodyExceededMaxSize(Exception): |
|  |  | """The maximum allowed size of the HTTP body was exceeded.""" |
|  |  |  |
|  |  |  |
|  |  | class \_ReadBodyWithMaxSizeProtocol(protocol.Protocol): |
|  |  | def \_\_init\_\_( |
|  |  | self, stream: BinaryIO, deferred: defer.Deferred, max\_size: Optional[int] |
|  |  | ): |
| Expand All | | @@ -761,13 +768,7 @@ def dataReceived(self, data: bytes) -> None: |
|  |  | self.stream.write(data) |
|  |  | self.length += len(data) |
|  |  | if self.max\_size is not None and self.length >= self.max\_size: |
|  |  | self.deferred.errback( |
|  |  | SynapseError( |
|  |  | 502, |
|  |  | "Requested file is too large > %r bytes" % (self.max\_size,), |
|  |  | Codes.TOO\_LARGE, |
|  |  | ) |
|  |  | ) |
|  |  | self.deferred.errback(BodyExceededMaxSize()) |
|  |  | self.deferred = defer.Deferred() |
|  |  | self.transport.loseConnection() |
|  |  |  |
| Expand All | | @@ -782,12 +783,15 @@ def connectionLost(self, reason: Failure) -> None: |
|  |  | self.deferred.errback(reason) |
|  |  |  |
|  |  |  |
|  |  | def readBodyToFile( |
|  |  | def read\_body\_with\_max\_size( |
|  |  | response: IResponse, stream: BinaryIO, max\_size: Optional[int] |
|  |  | ) -> defer.Deferred: |
|  |  | """ |
|  |  | Read a HTTP response body to a file-object. Optionally enforcing a maximum file size. |
|  |  |  |
|  |  | If the maximum file size is reached, the returned Deferred will resolve to a |
|  |  | Failure with a BodyExceededMaxSize exception. |
|  |  |  |
|  |  | Args: |
|  |  | response: The HTTP response to read from. |
|  |  | stream: The file-object to write to. |
| Expand All | | @@ -798,7 +802,7 @@ def readBodyToFile( |
|  |  | """ |
|  |  |  |
|  |  | d = defer.Deferred() |
|  |  | response.deliverBody(\_ReadBodyToFileProtocol(stream, d, max\_size)) |
|  |  | response.deliverBody(\_ReadBodyWithMaxSizeProtocol(stream, d, max\_size)) |
|  |  | return d |
|  |  |  |
|  |  |  |
| Expand Down | |  |

25 changes: 23 additions & 2 deletions

25
[synapse/http/federation/well\_known\_resolver.py](#diff-46f71022105249f09ee6eb1cfcf3db83aeb37c73d908e58972989156792641f3 "synapse/http/federation/well_known_resolver.py")

Show comments

[View file](/matrix-org/synapse/blob/ff5c4da1289cb5e097902b3e55b771be342c29d6/synapse/http/federation/well_known_resolver.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,17 +15,19 @@ |
|  |  | import logging |
|  |  | import random |
|  |  | import time |
|  |  | from io import BytesIO |
|  |  | from typing import Callable, Dict, Optional, Tuple |
|  |  |  |
|  |  | import attr |
|  |  |  |
|  |  | from twisted.internet import defer |
|  |  | from twisted.internet.interfaces import IReactorTime |
|  |  | from twisted.web.client import RedirectAgent, readBody |
|  |  | from twisted.web.client import RedirectAgent |
|  |  | from twisted.web.http import stringToDatetime |
|  |  | from twisted.web.http\_headers import Headers |
|  |  | from twisted.web.iweb import IAgent, IResponse |
|  |  |  |
|  |  | from synapse.http.client import BodyExceededMaxSize, read\_body\_with\_max\_size |
|  |  | from synapse.logging.context import make\_deferred\_yieldable |
|  |  | from synapse.util import Clock, json\_decoder |
|  |  | from synapse.util.caches.ttlcache import TTLCache |
| Expand Down  Expand Up | | @@ -53,6 +55,9 @@ |
|  |  | # lower bound for .well-known cache period |
|  |  | WELL\_KNOWN\_MIN\_CACHE\_PERIOD = 5 \* 60 |
|  |  |  |
|  |  | # The maximum size (in bytes) to allow a well-known file to be. |
|  |  | WELL\_KNOWN\_MAX\_SIZE = 50 \* 1024 # 50 KiB |
|  |  |  |
|  |  | # Attempt to refetch a cached well-known N% of the TTL before it expires. |
|  |  | # e.g. if set to 0.2 and we have a cached entry with a TTL of 5mins, then |
|  |  | # we'll start trying to refetch 1 minute before it expires. |
| Expand Down  Expand Up | | @@ -229,6 +234,9 @@ async def \_make\_well\_known\_request( |
|  |  | server\_name: name of the server, from the requested url |
|  |  | retry: Whether to retry the request if it fails. |
|  |  |  |
|  |  | Raises: |
|  |  | \_FetchWellKnownFailure if we fail to lookup a result |
|  |  |  |
|  |  | Returns: |
|  |  | Returns the response object and body. Response may be a non-200 response. |
|  |  | """ |
| Expand All | | @@ -250,7 +258,11 @@ async def \_make\_well\_known\_request( |
|  |  | b"GET", uri, headers=Headers(headers) |
|  |  | ) |
|  |  | ) |
|  |  | body = await make\_deferred\_yieldable(readBody(response)) |
|  |  | body\_stream = BytesIO() |
|  |  | await make\_deferred\_yieldable( |
|  |  | read\_body\_with\_max\_size(response, body\_stream, WELL\_KNOWN\_MAX\_SIZE) |
|  |  | ) |
|  |  | body = body\_stream.getvalue() |
|  |  |  |
|  |  | if 500 <= response.code < 600: |
|  |  | raise Exception("Non-200 response %s" % (response.code,)) |
| Expand All | | @@ -259,6 +271,15 @@ async def \_make\_well\_known\_request( |
|  |  | except defer.CancelledError: |
|  |  | # Bail if we've been cancelled |
|  |  | raise |
|  |  | except BodyExceededMaxSize: |
|  |  | # If the well-known file was too large, do not keep attempting |
|  |  | # to download it, but consider it a temporary error. |
|  |  | logger.warning( |
|  |  | "Requested .well-known file for %s is too large > %r bytes", |
|  |  | server\_name.decode("ascii"), |
|  |  | WELL\_KNOWN\_MAX\_SIZE, |
|  |  | ) |
|  |  | raise \_FetchWellKnownFailure(temporary=True) |
|  |  | except Exception as e: |
|  |  | if not retry or i >= WELL\_KNOWN\_RETRY\_ATTEMPTS: |
|  |  | logger.info("Error fetching %s: %s", uri\_str, e) |
| Expand Down | |  |

13 changes: 11 additions & 2 deletions

13
[synapse/http/matrixfederationclient.py](#diff-a53ea02bf6a0cbb98e925b47e71f4ffb149075536543c1eca15366fc65c90aef "synapse/http/matrixfederationclient.py")

Show comments

[View file](/matrix-org/synapse/blob/ff5c4da1289cb5e097902b3e55b771be342c29d6/synapse/http/matrixfederationclient.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,16 +37,19 @@ |
|  |  | import synapse.metrics |
|  |  | import synapse.util.retryutils |
|  |  | from synapse.api.errors import ( |
|  |  | Codes, |
|  |  | FederationDeniedError, |
|  |  | HttpResponseException, |
|  |  | RequestSendFailed, |
|  |  | SynapseError, |
|  |  | ) |
|  |  | from synapse.http import QuieterFileBodyProducer |
|  |  | from synapse.http.client import ( |
|  |  | BlacklistingAgentWrapper, |
|  |  | BlacklistingReactorWrapper, |
|  |  | BodyExceededMaxSize, |
|  |  | encode\_query\_args, |
|  |  | readBodyToFile, |
|  |  | read\_body\_with\_max\_size, |
|  |  | ) |
|  |  | from synapse.http.federation.matrix\_federation\_agent import MatrixFederationAgent |
|  |  | from synapse.logging.context import make\_deferred\_yieldable |
| Expand Down  Expand Up | | @@ -975,9 +978,15 @@ async def get\_file( |
|  |  | headers = dict(response.headers.getAllRawHeaders()) |
|  |  |  |
|  |  | try: |
|  |  | d = readBodyToFile(response, output\_stream, max\_size) |
|  |  | d = read\_body\_with\_max\_size(response, output\_stream, max\_size) |
|  |  | d.addTimeout(self.default\_timeout, self.reactor) |
|  |  | length = await make\_deferred\_yieldable(d) |
|  |  | except BodyExceededMaxSize: |
|  |  | msg = "Requested file is too large > %r bytes" % (max\_size,) |
|  |  | logger.warning( |
|  |  | "{%s} [%s] %s", request.txn\_id, request.destination, msg, |
|  |  | ) |
|  |  | SynapseError(502, msg, Codes.TOO\_LARGE) |
|  |  | except Exception as e: |
|  |  | logger.warning( |
|  |  | "{%s} [%s] Error reading response: %s", |
| Expand Down | |  |

27 changes: 27 additions & 0 deletions

27
[tests/http/federation/test\_matrix\_federation\_agent.py](#diff-433005b0b4c240474be987e6288c5f7c4494e8e5eadb180640962c8b8c321cfc "tests/http/federation/test_matrix_federation_agent.py")

Show comments

[View file](/matrix-org/synapse/blob/ff5c4da1289cb5e097902b3e55b771be342c29d6/tests/http/federation/test_matrix_federation_agent.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -36,6 +36,7 @@ |
|  |  | from synapse.http.federation.matrix\_federation\_agent import MatrixFederationAgent |
|  |  | from synapse.http.federation.srv\_resolver import Server |
|  |  | from synapse.http.federation.well\_known\_resolver import ( |
|  |  | WELL\_KNOWN\_MAX\_SIZE, |
|  |  | WellKnownResolver, |
|  |  | \_cache\_period\_from\_headers, |
|  |  | ) |
| Expand Down  Expand Up | | @@ -1107,6 +1108,32 @@ def test\_well\_known\_cache\_with\_temp\_failure(self): |
|  |  | r = self.successResultOf(fetch\_d) |
|  |  | self.assertEqual(r.delegated\_server, None) |
|  |  |  |
|  |  | def test\_well\_known\_too\_large(self): |
|  |  | """A well-known query that returns a result which is too large should be rejected.""" |
|  |  | self.reactor.lookups["testserv"] = "1.2.3.4" |
|  |  |  |
|  |  | fetch\_d = defer.ensureDeferred( |
|  |  | self.well\_known\_resolver.get\_well\_known(b"testserv") |
|  |  | ) |
|  |  |  |
|  |  | # there should be an attempt to connect on port 443 for the .well-known |
|  |  | clients = self.reactor.tcpClients |
|  |  | self.assertEqual(len(clients), 1) |
|  |  | (host, port, client\_factory, \_timeout, \_bindAddress) = clients.pop(0) |
|  |  | self.assertEqual(host, "1.2.3.4") |
|  |  | self.assertEqual(port, 443) |
|  |  |  |
|  |  | self.\_handle\_well\_known\_connection( |
|  |  | client\_factory, |
|  |  | expected\_sni=b"testserv", |
|  |  | response\_headers={b"Cache-Control": b"max-age=1000"}, |
|  |  | content=b'{ "m.server": "' + (b"a" \* WELL\_KNOWN\_MAX\_SIZE) + b'" }', |
|  |  | ) |
|  |  |  |
|  |  | # The result is sucessful, but disabled delegation. |
|  |  | r = self.successResultOf(fetch\_d) |
|  |  | self.assertIsNone(r.delegated\_server) |
|  |  |  |
|  |  | def test\_srv\_fallbacks(self): |
|  |  | """Test that other SRV results are tried if the first one fails. |
|  |  | """ |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ff5c4da`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fcommit%2Fff5c4da1289cb5e097902b3e55b771be342c29d6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


