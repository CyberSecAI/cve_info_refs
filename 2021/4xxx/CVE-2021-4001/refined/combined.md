=== Content from access.redhat.com_82ac14ff_20250115_113126.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from git.kernel.org_417cbaf3_20250115_113126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/bpf/bpf.git](/pub/scm/linux/kernel/git/bpf/bpf.git/) | master |
| --- | --- | --- |
| BPF kernel tree | BPF Group |

| [about](/pub/scm/linux/kernel/git/bpf/bpf.git/about/)[summary](/pub/scm/linux/kernel/git/bpf/bpf.git/)[refs](/pub/scm/linux/kernel/git/bpf/bpf.git/refs/?id=353050be4c19e102178ccc05988101887c25ae53)[log](/pub/scm/linux/kernel/git/bpf/bpf.git/log/)[tree](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/?id=353050be4c19e102178ccc05988101887c25ae53)[commit](/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=353050be4c19e102178ccc05988101887c25ae53)[diff](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/?id=353050be4c19e102178ccc05988101887c25ae53)[stats](/pub/scm/linux/kernel/git/bpf/bpf.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2021-11-09 18:48:08 +0000 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2021-11-15 20:47:07 -0800 |
| commit | [353050be4c19e102178ccc05988101887c25ae53](/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=353050be4c19e102178ccc05988101887c25ae53) ([patch](/pub/scm/linux/kernel/git/bpf/bpf.git/patch/?id=353050be4c19e102178ccc05988101887c25ae53)) | |
| tree | [41c94d543e6bf439a4934b95e228b20f01fc785c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/?id=353050be4c19e102178ccc05988101887c25ae53) | |
| parent | [6060a6cb05e3223146a3c30a1977f136da6c85e7](/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=6060a6cb05e3223146a3c30a1977f136da6c85e7) ([diff](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/?id=353050be4c19e102178ccc05988101887c25ae53&id2=6060a6cb05e3223146a3c30a1977f136da6c85e7)) | |
| download | [bpf-353050be4c19e102178ccc05988101887c25ae53.tar.gz](/pub/scm/linux/kernel/git/bpf/bpf.git/snapshot/bpf-353050be4c19e102178ccc05988101887c25ae53.tar.gz) | |

bpf: Fix toctou on read-only map's constant scalar trackingCommit a23740ec43ba ("bpf: Track contents of read-only maps as scalars") is
checking whether maps are read-only both from BPF program side and user space
side, and then, given their content is constant, reading out their data via
map->ops->map\_direct\_value\_addr() which is then subsequently used as known
scalar value for the register, that is, it is marked as \_\_mark\_reg\_known()
with the read value at verification time. Before a23740ec43ba, the register
content was marked as an unknown scalar so the verifier could not make any
assumptions about the map content.
The current implementation however is prone to a TOCTOU race, meaning, the
value read as known scalar for the register is not guaranteed to be exactly
the same at a later point when the program is executed, and as such, the
prior made assumptions of the verifier with regards to the program will be
invalid which can cause issues such as OOB access, etc.
While the BPF\_F\_RDONLY\_PROG map flag is always fixed and required to be
specified at map creation time, the map->frozen property is initially set to
false for the map given the map value needs to be populated, e.g. for global
data sections. Once complete, the loader "freezes" the map from user space
such that no subsequent updates/deletes are possible anymore. For the rest
of the lifetime of the map, this freeze one-time trigger cannot be undone
anymore after a successful BPF\_MAP\_FREEZE cmd return. Meaning, any new BPF\_\*
cmd calls which would update/delete map entries will be rejected with -EPERM
since map\_get\_sys\_perms() removes the FMODE\_CAN\_WRITE permission. This also
means that pending update/delete map entries must still complete before this
guarantee is given. This corner case is not an issue for loaders since they
create and prepare such program private map in successive steps.
However, a malicious user is able to trigger this TOCTOU race in two different
ways: i) via userfaultfd, and ii) via batched updates. For i) userfaultfd is
used to expand the competition interval, so that map\_update\_elem() can modify
the contents of the map after map\_freeze() and bpf\_prog\_load() were executed.
This works, because userfaultfd halts the parallel thread which triggered a
map\_update\_elem() at the time where we copy key/value from the user buffer and
this already passed the FMODE\_CAN\_WRITE capability test given at that time the
map was not "frozen". Then, the main thread performs the map\_freeze() and
bpf\_prog\_load(), and once that had completed successfully, the other thread
is woken up to complete the pending map\_update\_elem() which then changes the
map content. For ii) the idea of the batched update is similar, meaning, when
there are a large number of updates to be processed, it can increase the
competition interval between the two. It is therefore possible in practice to
modify the contents of the map after executing map\_freeze() and bpf\_prog\_load().
One way to fix both i) and ii) at the same time is to expand the use of the
map's map->writecnt. The latter was introduced in fc9702273e2e ("bpf: Add mmap()
support for BPF\_MAP\_TYPE\_ARRAY") and further refined in 1f6cb19be2e2 ("bpf:
Prevent re-mmap()'ing BPF map as writable for initially r/o mapping") with
the rationale to make a writable mmap()'ing of a map mutually exclusive with
read-only freezing. The counter indicates writable mmap() mappings and then
prevents/fails the freeze operation. Its semantics can be expanded beyond
just mmap() by generally indicating ongoing write phases. This would essentially
span any parallel regular and batched flavor of update/delete operation and
then also have map\_freeze() fail with -EBUSY. For the check\_mem\_access() in
the verifier we expand upon the bpf\_map\_is\_rdonly() check ensuring that all
last pending writes have completed via bpf\_map\_write\_active() test. Once the
map->frozen is set and bpf\_map\_write\_active() indicates a map->writecnt of 0
only then we are really guaranteed to use the map's data as known constants.
For map->frozen being set and pending writes in process of still being completed
we fall back to marking that register as unknown scalar so we don't end up
making assumptions about it. With this, both TOCTOU reproducers from i) and
ii) are fixed.
Note that the map->writecnt has been converted into a atomic64 in the fix in
order to avoid a double freeze\_mutex mutex\_{un,}lock() pair when updating
map->writecnt in the various map update/delete BPF\_\* cmd flavors. Spanning
the freeze\_mutex over entire map update/delete operations in syscall side
would not be possible due to then causing everything to be serialized.
Similarly, something like synchronize\_rcu() after setting map->frozen to wait
for update/deletes to complete is not possible either since it would also
have to span the user copy which can sleep. On the libbpf side, this won't
break d66562fba1ce ("libbpf: Add BPF object skeleton support") as the
anonymous mmap()-ed "map initialization image" is remapped as a BPF map-backed
mmap()-ed memory where for .rodata it's non-writable.
Fixes: a23740ec43ba ("bpf: Track contents of read-only maps as scalars")
Reported-by: w1tcher.bupt@gmail.com
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/?id=353050be4c19e102178ccc05988101887c25ae53)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/include/linux/bpf.h?id=353050be4c19e102178ccc05988101887c25ae53) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/kernel/bpf/syscall.c?id=353050be4c19e102178ccc05988101887c25ae53) | 57 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/bpf/bpf.git/diff/kernel/bpf/verifier.c?id=353050be4c19e102178ccc05988101887c25ae53) | 17 | |  |  |  | | --- | --- | --- | |

3 files changed, 54 insertions, 23 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex f715e8863f4de9..e7a163a3146b62 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/include/linux/bpf.h?id=6060a6cb05e3223146a3c30a1977f136da6c85e7)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/include/linux/bpf.h?id=353050be4c19e102178ccc05988101887c25ae53)@@ -193,7 +193,7 @@ struct bpf\_map { atomic64\_t usercnt; struct work\_struct work; struct mutex freeze\_mutex;- u64 writecnt; /\* writable mmap cnt; protected by freeze\_mutex \*/+ atomic64\_t writecnt; };  static inline bool map\_value\_has\_spin\_lock(const struct bpf\_map \*map)@@ -1419,6 +1419,7 @@ void bpf\_map\_put(struct bpf\_map \*map); void \*bpf\_map\_area\_alloc(u64 size, int numa\_node); void \*bpf\_map\_area\_mmapable\_alloc(u64 size, int numa\_node); void bpf\_map\_area\_free(void \*base);+bool bpf\_map\_write\_active(const struct bpf\_map \*map); void bpf\_map\_init\_from\_attr(struct bpf\_map \*map, union bpf\_attr \*attr); int generic\_map\_lookup\_batch(struct bpf\_map \*map, const union bpf\_attr \*attr,diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 50f96ea4452a2e..1033ee8c0caf01 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/kernel/bpf/syscall.c?id=6060a6cb05e3223146a3c30a1977f136da6c85e7)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/kernel/bpf/syscall.c?id=353050be4c19e102178ccc05988101887c25ae53)@@ -132,6 +132,21 @@ static struct bpf\_map \*find\_and\_alloc\_map(union bpf\_attr \*attr) return map; } +static void bpf\_map\_write\_active\_inc(struct bpf\_map \*map)+{+ atomic64\_inc(&map->writecnt);+}++static void bpf\_map\_write\_active\_dec(struct bpf\_map \*map)+{+ atomic64\_dec(&map->writecnt);+}++bool bpf\_map\_write\_active(const struct bpf\_map \*map)+{+ return atomic64\_read(&map->writecnt) != 0;+}+ static u32 bpf\_map\_value\_size(const struct bpf\_map \*map) { if (map->map\_type == BPF\_MAP\_TYPE\_PERCPU\_HASH ||@@ -601,11 +616,8 @@ static void bpf\_map\_mmap\_open(struct vm\_area\_struct \*vma) { struct bpf\_map \*map = vma->vm\_file->private\_data; - if (vma->vm\_flags & VM\_MAYWRITE) {- mutex\_lock(&map->freeze\_mutex);- map->writecnt++;- mutex\_unlock(&map->freeze\_mutex);- }+ if (vma->vm\_flags & VM\_MAYWRITE)+ bpf\_map\_write\_active\_inc(map); }  /\* called for all unmapped memory region (including initial) \*/@@ -613,11 +625,8 @@ static void bpf\_map\_mmap\_close(struct vm\_area\_struct \*vma) { struct bpf\_map \*map = vma->vm\_file->private\_data; - if (vma->vm\_flags & VM\_MAYWRITE) {- mutex\_lock(&map->freeze\_mutex);- map->writecnt--;- mutex\_unlock(&map->freeze\_mutex);- }+ if (vma->vm\_flags & VM\_MAYWRITE)+ bpf\_map\_write\_active\_dec(map); }  static const struct vm\_operations\_struct bpf\_map\_default\_vmops = {@@ -668,7 +677,7 @@ static int bpf\_map\_mmap(struct file \*filp, struct vm\_area\_struct \*vma) goto out;  if (vma->vm\_flags & VM\_MAYWRITE)- map->writecnt++;+ bpf\_map\_write\_active\_inc(map); out: mutex\_unlock(&map->freeze\_mutex); return err;@@ -1139,6 +1148,7 @@ static int map\_update\_elem(union bpf\_attr \*attr, bpfptr\_t uattr) map = \_\_bpf\_map\_get(f); if (IS\_ERR(map)) return PTR\_ERR(map);+ bpf\_map\_write\_active\_inc(map); if (!(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_WRITE)) { err = -EPERM; goto err\_put;@@ -1174,6 +1184,7 @@ free\_value: free\_key: kvfree(key); err\_put:+ bpf\_map\_write\_active\_dec(map); fdput(f); return err; }@@ -1196,6 +1207,7 @@ static int map\_delete\_elem(union bpf\_attr \*attr) map = \_\_bpf\_map\_get(f); if (IS\_ERR(map)) return PTR\_ERR(map);+ bpf\_map\_write\_active\_inc(map); if (!(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_WRITE)) { err = -EPERM; goto err\_put;@@ -1226,6 +1238,7 @@ static int map\_delete\_elem(union bpf\_attr \*attr) out: kvfree(key); err\_put:+ bpf\_map\_write\_active\_dec(map); fdput(f); return err; }@@ -1533,6 +1546,7 @@ static int map\_lookup\_and\_delete\_elem(union bpf\_attr \*attr) map = \_\_bpf\_map\_get(f); if (IS\_ERR(map)) return PTR\_ERR(map);+ bpf\_map\_write\_active\_inc(map); if (!(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_READ) || !(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_WRITE)) { err = -EPERM;@@ -1597,6 +1611,7 @@ free\_value: free\_key: kvfree(key); err\_put:+ bpf\_map\_write\_active\_dec(map); fdput(f); return err; }@@ -1624,8 +1639,7 @@ static int map\_freeze(const union bpf\_attr \*attr) }  mutex\_lock(&map->freeze\_mutex);-- if (map->writecnt) {+ if (bpf\_map\_write\_active(map)) { err = -EBUSY; goto err\_put; }@@ -4171,6 +4185,9 @@ static int bpf\_map\_do\_batch(const union bpf\_attr \*attr, union bpf\_attr \_\_user \*uattr, int cmd) {+ bool has\_read = cmd == BPF\_MAP\_LOOKUP\_BATCH ||+ cmd == BPF\_MAP\_LOOKUP\_AND\_DELETE\_BATCH;+ bool has\_write = cmd != BPF\_MAP\_LOOKUP\_BATCH; struct bpf\_map \*map; int err, ufd; struct fd f;@@ -4183,16 +4200,13 @@ static int bpf\_map\_do\_batch(const union bpf\_attr \*attr, map = \_\_bpf\_map\_get(f); if (IS\_ERR(map)) return PTR\_ERR(map);-- if ((cmd == BPF\_MAP\_LOOKUP\_BATCH ||- cmd == BPF\_MAP\_LOOKUP\_AND\_DELETE\_BATCH) &&- !(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_READ)) {+ if (has\_write)+ bpf\_map\_write\_active\_inc(map);+ if (has\_read && !(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_READ)) { err = -EPERM; goto err\_put; }-- if (cmd != BPF\_MAP\_LOOKUP\_BATCH &&- !(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_WRITE)) {+ if (has\_write && !(map\_get\_sys\_perms(map, f) & FMODE\_CAN\_WRITE)) { err = -EPERM; goto err\_put; }@@ -4205,8 +4219,9 @@ static int bpf\_map\_do\_batch(const union bpf\_attr \*attr, BPF\_DO\_BATCH(map->ops->map\_update\_batch); else BPF\_DO\_BATCH(map->ops->map\_delete\_batch);- err\_put:+ if (has\_write)+ bpf\_map\_write\_active\_dec(map); fdput(f); return err; }diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 65d2f93b703079..50efda51515b50 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/kernel/bpf/verifier.c?id=6060a6cb05e3223146a3c30a1977f136da6c85e7)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/bpf/bpf.git/tree/kernel/bpf/verifier.c?id=353050be4c19e102178ccc05988101887c25ae53)@@ -4056,7 +4056,22 @@ static void coerce\_reg\_to\_size(struct bpf\_reg\_state \*reg, int size)  static bool bpf\_map\_is\_rdonly(const struct bpf\_map \*map) {- return (map->map\_flags & BPF\_F\_RDONLY\_PROG) && map->frozen;+ /\* A map is considered read-only if the following condition are true:+ \*+ \* 1) BPF program side cannot change any of the map content. The+ \* BPF\_F\_RDONLY\_PROG flag is throughout the lifetime of a map+ \* and was set at map creation time.+ \* 2) The map value(s) have been initialized from user space by a+ \* loader and then "frozen", such that no new map update/delete+ \* operations from syscall side are possible for the rest of+ \* the map's lifetime from that point onwards.+ \* 3) Any parallel/pending map update/delete operations from syscall+ \* side have been completed. Only after that point, it's safe to+ \* assume that map value(s) are immutable.+ \*/+ return (map->map\_flags & BPF\_F\_RDONLY\_PROG) &&+ READ\_ONCE(map->frozen) &&+ !bpf\_map\_write\_active(map); }  static int bpf\_map\_direct\_read(struct bpf\_map \*map, int off, int size, u64 \*val) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 11:30:03 +0000



=== Content from bugzilla.redhat.com_37232e91_20250114_184655.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D2025645)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D2025645)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D2025645)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 2025645

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 2025645**](show_bug.cgi?id=2025645)
(CVE-2021-4001)
- [CVE-2021-4001](https://access.redhat.com/security/cve/CVE-2021-4001) kernel: race condition when the EBPF map is frozen

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2021-4001 kernel: race condition when the EBPF map is frozen

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | NEW | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2021-4001 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Nobody | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [2025646](show_bug.cgi?id=2025646 "CLOSED ERRATA - CVE-2021-4001 kernel: race condition when the EBPF map is frozen [fedora-all]") [2027593](show_bug.cgi?id=2027593) [2029194](show_bug.cgi?id=2029194) [2029195](show_bug.cgi?id=2029195) [2029196](show_bug.cgi?id=2029196) [2029197](show_bug.cgi?id=2029197) [2029198](show_bug.cgi?id=2029198) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [2024668](show_bug.cgi?id=2024668) [2025647](show_bug.cgi?id=2025647) | | TreeView+ | [depends on](buglist.cgi?bug_id=2025645&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=2025645&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2021-11-22 16:34 UTC by Guilherme de Almeida Suckevicz | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-09-19 14:13 UTC ([History](show_activity.cgi?id=2025645)) | | [CC List:](page.cgi?id=fields.html#cclist) | 39 users (show)  acaringi adscvr airlied alciregi bdettelb bhu chwhite crwood dvlasenk hdegoede hkrzesin jarod jarodwilson jburrell jeremy jforbes jglisse jlelli jonathan josef jshortt jstancek jwboyer kcarcia kernel-maint kernel-mgr lgoncalv linville masami256 mchehab nmurray ptalbert qzhao rkeshri rvrbovsk steved vkumar walters williams | | Fixed In Version: | kernel 5.16 rc2 | | | Doc Type: | If docs needed, set a value | | | Doc Text: | A race condition was found in the Linux kernel's ebpf verifier between bpf\_map\_update\_elem and bpf\_map\_freeze due to a missing lock in kernel/bpf/syscall.c. In this flaw, a local user with a special privilege (cap\_sys\_admin or cap\_bpf) can modify the frozen mapped address space. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: |  | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2025645#c0)  Guilherme de Almeida Suckevicz    2021-11-22 16:34:57 UTC  ``` A race problem is found in the ebpf verifier between bpf_map_update_elem and bpf_map_freeze due to a missing lock in kernel/bpf/syscall.c. In this flaw, a local user with a special privilege (cap_sys_admin or cap_bpf) can modify the frozen mapped address space.  Reference and upstream patch: <https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=353050be4c19e102178ccc05988101887c25ae53>   ```  [Comment 1](show_bug.cgi?id=2025645#c1)  Guilherme de Almeida Suckevicz    2021-11-22 16:35:58 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 2025646](show_bug.cgi?id=2025646 "CLOSED ERRATA - CVE-2021-4001 kernel: race condition when the EBPF map is frozen [fedora-all]")]   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=2025645&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)


