```
{
  "cve": "CVE-2021-4345",
  "source_information": {
    "blog_nintechnet_com": {
      "content": "The WordPress [uListing](https://wordpress.org/plugins/ulisting/) plugin (3,000+ active installations) fixed multiple critical vulnerabilities affecting version 1.6.6 and below that could lead to unauthenticated arbitrary account creation, WordPress options change, information disclosure and SQL injection among several other issues.\n\n### Broken Access Control\n\nUsers can interact with the plugin via two API: the WordPress built-in AJAX API and WP\\_Route, a third-party API (e.g., `https://example.com/1/api/{some_route}`). Most actions and endpoints are accessible to unauthenticated users, lack security nonces and data is seldom validated.\n\nDue to the large number of issues, I’ll review below the most critical ones only.\n\n### Unauthenticated Arbitrary Account Creation\n\nThe plugin registers the `stm_listing_register` AJAX action to load the eponymous function in the “ulisting/includes/classes/StmListingAuth.php” script line 53:\n\n```\npublic static function stm_listing_register()\n{\n   $result = array(\n      'errors' => [],\n      'message' => null,\n      'status'  => 'error'\n   );\n\n   $request_body = file_get_contents('php://input');\n   $data = json_decode($request_body, true);\n\n   $data_for_validate = $data;\n   $validator = new Validation();\n   $data_for_validate = $validator->sanitize($data_for_validate);\n   $validator->validation_rules(array(\n      'email' => 'required|valid_email',\n      'first_name' => 'required|max_len,50|min_len,3',\n      'last_name' => 'required|max_len,50|min_len,3',\n      'login' => 'required|max_len,50|min_len,3',\n      'password' => 'required|max_len,50|min_len,8',\n      'password_repeat' => 'required|equalsfield,password',\n      'role' => 'required',\n   ));\n\n   $validated_data = $validator->run($data_for_validate);\n\n   if($validated_data === false) {\n      $result['errors'] = $validator->get_errors_array();\n      wp_send_json($result);\n      die;\n   }\n\n   extract($data);\n   /**\n    * @var $email ;\n    * @var $first_name ;\n    * @var $last_name ;\n    * @var $login ;\n    * @var $password ;\n    * @var $password_repeat ;\n    * @var $role ;\n    * @var $agency_id ;\n    */\n\n   $user = wp_create_user($login, $password, $email);\n\n   if (is_wp_error($user)) {\n      $result['message'] = $user->get_error_message();\n   } else {\n      if($user = new StmUser($user)) {\n               do_action(\"ulisting_profile_edit\", ['user' => $user, 'data' => $validated_data]);\n         wp_update_user(array(\n            'ID'              => $user->ID,\n            'first_name'      => $first_name,\n            'last_name'       => $last_name,\n            'role'            => $role\n         ));\n      }\n      ...\n      ...\n\n```\n\nIt allows users to register an account on the blog. Because users can submit a role, which is not checked by the plugin, an unauthenticated user can create an administrator account on the blog (or any other role).\n\n### Unauthenticated Arbitrary Account Change\n\nThe plugin registers the `stm_listing_profile_edit` AJAX action to load the eponymous function in the “ulisting/includes/classes/StmListingAuth.php” script line 138:\n\n```\npublic static function stm_listing_profile_edit() {\n\n   $result = array(\n      'errors' => [],\n      'message' => null,\n      'status'  => 'error'\n   );\n   $validator = new Validation();\n   $data_for_validate = $validator->sanitize(array_merge($_POST,$_FILES));\n\n   $validator->validation_rules(array(\n      'user_id' => 'required',\n      'email' => 'required|valid_email',\n      'first_name' => 'required|max_len,50|min_len,3',\n      'last_name' => 'required|max_len,50|min_len,3',\n      'avatar' => 'extension,png;jpg'\n   ));\n\n   $validated_data = $validator->run($data_for_validate);\n\n   if($validated_data === false) {\n      $result['errors'] = $validator->get_errors_array();\n      wp_send_json($result);\n      die;\n   }\n\n   extract($validated_data);\n   /**\n    * @var $user_id ;\n    * @var $email ;\n    * @var $first_name ;\n    * @var $last_name ;\n    */\n\n   if($user = new StmUser($user_id) AND $user->ID) {\n\n      do_action(\"ulisting_profile_edit\", ['user' => $user, 'data' => $validated_data]);\n\n      $result['status'] = 'success';\n      $result['message'] = esc_html__('Profile update completed successfully.', \"ulisting\");\n\n      if(isset($_FILES['avatar'])) {\n         $avatar = $user->updateAvatar( $_FILES['avatar'] );\n         if(isset($avatar['error'])) {\n            $result['status'] = 'error';\n            $result['errors']['avatar'] = $avatar['message'];\n         }else\n            $result['url_avatar'] = $avatar['url'];\n      }\n\n      wp_update_user(array(\n         'ID'              => $user->ID,\n         'first_name'      => $first_name,\n         'last_name'       => $last_name,\n         'user_email'      => $email,\n      ));\n\n      foreach ( $validated_data['user_meta'] as $k => $val )\n         update_user_meta($user->ID, $k, $val);\n\n   } else {\n      $result['message'] = esc_html__('User not found', \"ulisting\");\n      wp_send_json($result);\n      die;\n   }\n\n   wp_send_json($result);\n   die;\n\n}\n\n```\n\nThe function allows users to edit their account. Because it doesn’t verify that users are logged-in and editing their own account, an unauthenticated user can edit any account on the blog such as modifying the admin account and changing its email address, and can also edit values in the `usermeta` table in the database and change the user profile picture.\n\n### Unauthenticated WordPress Options Change (via AJAX)\n\nThe plugin registers the `stm_update_email_data` AJAX action to load the eponymous function in the “ulisting/includes/classes/StmListingSettings.php” script line 200:\n\n```\n/**\n* Update Email Template Images by key\n*/\npublic static function stm_update_email_data() {\n   $result = [\n      'status'  => 'success',\n      'success' => true\n   ];\n\n   $request_body = file_get_contents('php://input');\n   $request_data = json_decode($request_body, true);\n\n   if (isset($request_data['socials'])) {\n      update_option('ulisting_email_socials', $request_data['socials']);\n   }\n\n   if (isset($request_data['images']) && !empty($request_data['images'])) {\n      foreach ($request_data['images'] as $image)\n         update_option($image['option_name'], $image['id']);\n   }\n   wp_send_json($result);\n}\n\n```\n\nThe function doesn’t check for user capabilities, lacks a security nonce and doesn’t verify or validate user input. An unauthenticated user can change any WordPress option in the database in order, for instance, to enable registration (`users_can_register`) and to set the user default role to administrator, or modify the value of `siteurl` in order to redirect all traffic to an external malicious website. It is also possible to modify the plugin `ulisting_email_socials` option.\n\n### Unauthenticated WordPress Options Change (via WP\\_Route)\n\nIn the “ulisting/includes/route.php” script line 200, the plugin registers the `/1/api/ulisting-builder/listing-single-layout/new-layout` route that loads the `StmListingSingleLayout::import_new_layout` method from the “ulisting/includes/classes/StmListingSingleLayout.php” script line 1222:\n\n```\npublic static function import_new_layout(){\n   $result = [\n      'success' => false,\n   ];\n\n   $files = $_FILES;\n\n   if(!empty($files['file']) && !empty($_POST['id']) && file_exists($files['file']['tmp_name'])){\n      $content = file_get_contents($files['file']['tmp_name']);\n\n      if(is_array($content))\n         $content = ulisting__sanitize_array($content);\n      else\n         $content = sanitize_text_field($content);\n\n      if(isset($_POST['listing_type_id']) && $_POST['type'] === 'single')\n         update_post_meta($_POST['listing_type_id'], $_POST['id'], $content);\n      elseif ($_POST['type'] === 'inventory')\n         update_option($_POST['id'], $content);\n\n      $result['success'] = true;\n   }\n\n   return $result;\n}\n\n```\n\nHere too, the method doesn’t check for user capabilities and there’s no security nonce either, allowing an unauthenticated user to change any WordPress option in the database. It is also possible to edit values in the `postmeta` table in the database.\n\n### Unauthenticated Information Disclosure\n\nIn the “ulisting/includes/route.php” script line 60, the plugin registers the `/1/api/ulisting-user/search` route that loads the `StmUser::search` method from the “ulisting/includes/classes/StmUser.php” script line 303:\n\n```\n/**\n * @param $search string\n *\n * @return mixed list array\n */\npublic static function search($search) {\n   if(!$search)\n      return [];\n      $data = [];\n      $users = new WP_User_Query( array(\n         'search' => '*'.esc_attr( $search ).'*',\n         'number' => 50,\n         'search_columns' => array(\n         'user_login',\n         'user_nicename',\n         'user_email',\n         'user_url',\n      ),\n   ) );\n   foreach ($users->get_results() as $user) {\n      $data[] = array(\n         'id' => $user->data->ID,\n         'name' => $user->data->display_name,\n         'email' => $user->data->user_email\n      );\n   }\n   return $data;\n}\n\n```\n\nThe method doesn’t check if the user has the `list_users` capability.\n\nAn unauthenticated user can retrieve the list of all users and their email address in the database.\n\n### Unauthenticated Arbitrary Roles and Capabilities Creation/Deletion\n\nIn the “ulisting/includes/route.php” script line 36, the plugin registers the `/1/api/ulisting-user/role/save` route that loads the `UlistingUserRole::save_role_api` method from the “ulisting/includes/classes/UlistingUserRole.php” script line 83:\n\n```\npublic static function save_role_api(){\n   $result = [\n      'success' => false,\n      'message' => false\n   ];\n   $request_body = file_get_contents('php://input');\n   $request_data = json_decode($request_body, true);\n   if(isset($request_data['roles'])) {\n      self::save_roles($request_data['roles']);\n      $result['success'] = true;\n   }\n   return $result;\n}\n\n/**\n * @param $roles\n */\npublic static function save_roles($roles) {\n   global $wp_roles;\n   $model = new UlistingUserRole();\n   $i = empty(get_role(\"agency\")) ? 1 : 0;\n   foreach ($roles as $role) {\n\n      if(!uListing_user_role_active() AND $i == 2)\n         continue;\n\n      if($role['is_delete'] == 1){\n         remove_role($role['slug']);\n         continue;\n      }\n      if(!isset($model->roles[$role['slug']])){\n         add_role($role['slug'],$role['name'], $role['capabilities']);\n         $wp_role = get_role( $role['slug'] );\n      }else{\n         $wp_role = get_role( $role['slug'] );\n         if (isset($wp_roles->roles[$role['slug']]) && !empty($role['name'])) $wp_roles->roles[$role['slug']]['name'] = $role['name'];\n         foreach ($role['capabilities'] as $key => $val) {\n            $wp_role->add_cap($key, $val);\n         }\n      }\n      do_action('ulisting_user_role_save_custom_fields',['wp_role' => $wp_role, 'custom_fields' => $role['custom_fields']]);\n      $i++;\n   }\n}\n\n```\n\nThe function doesn’t check for user capabilities and lacks a security nonce.\n\nAn unauthenticated user can remove or add roles, and add capabilities to the blog.\n\n### Unauthenticated SQL Injection #1\n\nIn the “ulisting/includes/route.php” script line 348, the plugin registers the `/1/api/ulisting-page-statistics/listing` route:\n\n```\n/**\n * Page statistics\n */\n$wp_router->get( array(\n   'uri'  => ULISTING_BASE_URL.'/ulisting-page-statistics/listing',\n   'uses' => function(){\n      if(isset($_GET[\"type\"]) AND isset($_GET[\"listing_id\"]))\n         wp_send_json( \\uListing\\Classes\\UlistingPageStatistics::get_listing_page_statistics($_GET) );\n      die;\n   }\n   )\n);\n\n```\n\nIf the `$_GET[\"type\"]` and `$_GET[\"listing_id\"]` variables are set, it loads the “UlistingPageStatistics::get\\_listing\\_page\\_statistics” method found in the “ulisting/includes/classes/UlistingPageStatistics.php” script:\n\n```\n$statistics = UlistingPageStatistics::query()\n   ->select(\" page_statistics.id, page_statistics.type, page_statistics.`created_date`  , count(page_statistics.id) as count \")\n   ->asTable(\"page_statistics\")\n   ->where_raw(\"page_statistics.`object_id` = \" . $params[\"listing_id\"] . \" OR page_statistics.`object_id` = \" . $params[\"user_id\"])\n   ->where_raw(\" page_statistics.`created_date` between '".$start_date."' and '".$end_date."' \")\n   ->group_by(\" HOUR(page_statistics.`created_date`), page_statistics.`id`, page_statistics.`type`\")\n   ->find();\n\n```\n\nThe `listing_id` and `user_id` GET variables are inserted into the SQL query without being checked or sanitized.\n\nAn unauthenticated user can perform a SQL injection attack with either variable.\n\n### Unauthenticated SQL Injection #2\n\nIn the “ulisting/includes/classes/UlistingPageStatistics.php” script line 66, the plugin retrieves the IP from untrusted sources, `HTTP_CLIENT_IP` and `HTTP_X_FORWARDED_FOR`:\n\n```\npublic static function getRealIpAddr() {\n   if (!empty($_SERVER['HTTP_CLIENT_IP'])) { //check ip from share internet\n      $ip=$_SERVER['HTTP_CLIENT_IP'];\n   } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']))  { //to check ip is pass from proxy\n      $ip=$_SERVER['HTTP_X_FORWARDED_FOR'];\n   } else {\n      $ip=$_SERVER['REMOTE_ADDR'];\n   }\n   return $ip;\n}\n\n```\n\nIt doesn’t validate it and insert it, unsanitized, into the SQL query line 117:\n\n```\npublic static function page_statistics_for_listing($listing_id){\n   global $wpdb;\n   $page_statistics = UlistingPageStatistics::query()\n      ->asTable(\"page_statistics\")\n      ->join(\" left join `\".$wpdb->prefix.\"ulisting_page_statistics_meta` as meta on meta.`page_statistics_id` = page_statistics.id \")\n      ->where(\"page_statistics.`object_id`\", $listing_id)\n      ->where_raw(\"DATE(page_statistics.`created_date`) = DATE('\" . date(\"Y-m-d\") . \"') \");\n   if(is_user_logged_in())\n      $page_statistics->where(\"meta.`meta_key`\", \"user_id\")\n         ->where(\"meta.`meta_value`\", get_current_user_id());\n   else\n      $page_statistics->where(\"meta.`meta_key`\", \"ip\")\n         ->where(\"meta.`meta_value`\", self::getRealIpAddr());\n\n```\n\nAn unauthenticated user can perform a SQL injection attack by forging a bogus IP address.\n\n### Unauthenticated Arbitrary Post/Page Deletion\n\nIn the “ulisting/includes/route.php” script line 89, the plugin registers the `/1/api/ulisting-user/deletelisting` route that loads the `StmUser::delete_listing` method from the “ulisting/includes/classes/StmUser.php” script line 511:\n\n```\npublic static function delete_listing() {\n   $result = [\n      'success' => false,\n      'data'    => []\n   ];\n\n   $request_body = file_get_contents('php://input');\n   $request_data = json_decode($request_body, true);\n\n   $validation = new Validation();\n   $request_data = $validation->sanitize($request_data);\n   $validation->validation_rules(array(\n      'user_id' => 'required',\n      'listing_id' => 'required'\n   ));\n\n   if ( ($validated_data = $validation->run($request_data)) === false) {\n      $result['errors'] = $validation->get_errors_array();\n      return $result;\n   }\n\n   if( !($user = new StmUser($request_data['user_id'])) ) {\n      return $result;\n   }\n\n   $listing_id = ( isset($request_data['listing_id']) ) ? $request_data['listing_id'] : null;\n   $listingUserRelation = StmListingUserRelations::query()->where('listing_id', $listing_id)->findOne();\n\n   $back_slots = get_option('ulisting_back_slots');\n   $back_slots = strval($back_slots) === 'true';\n\n   if ($listingUserRelation) {\n      if ($listingUserRelation->user_id != $request_data['user_id']) return $result;\n   }\n\n   if ($listing_id) {\n      $listing    = StmListing::find_one($listing_id);\n      $user_plans = $listing->get_user_plan();\n      if ( !empty($listing) && $back_slots && !empty($user_plans) ) {\n         foreach ($user_plans as $user_plan) {\n            if ( isset($user_plan->payment_type) && $user_plan->payment_type === StmPricingPlans::PRICING_PLANS_PAYMENT_TYPE_ONE_TIME) {\n               $user_plan_meta = $user_plan->get_user_plan_meta();\n               $limit          = intval($user_plan_meta->meta_value) + 1;\n               $user_plan_meta->meta_value = $limit;\n               $user_plan_meta->save();\n            }\n         }\n      }\n\n      wp_delete_post( $listing_id, 'false' );\n      $result['success'] = true;\n   }\n   return $result;\n}\n\n```\n\nThe plugin doesn’t check if the user is logged-in and allowed to delete the corresponding page or post, and there’s no security nonce either.\n\nAn unauthenticated user can delete any page or post on the blog.\n\n### Additional Issues\n\nAdditional issues include:\n\n*   Unauthenticated WordPress options deletion.\n*   Unauthenticated plugin settings change.\n*   Unauthenticated arbitrary post/page status change.\n*   Unauthenticated arbitrary post meta deletion and change.\n*   etc\n\n### Bypassing Firewalls & Security Plugins\n\nWhile looking at the WP\\_Route API code I noticed that unlike the WordPress REST API, which requires a strict syntax, it allowed character encoding. For instance, if `http://example.com/1/api/ulisting-user/search?search=*` will return the list of all users on the blog, so will `http://example.com/%31%2f%61%70%69%2f%75%6c%69%73%74%69%6e%67%2d%75%73%65%72%2f%73%65%61%72%63%68?search=*`. This kind of light obfuscation is interesting because on websites that have a poorly implemented security, hackers could use it to bypass security rules and exploit the vulnerabilities. Users of our NinjaFirewall WAF for WordPress don’t have to worry about such evasion tricks, the firewall will handle them without any problem.\n\n### Recommendations\n\nUpdate immediately if you have version 1.6.6 or below installed. If you are using our web application firewall for WordPress, [NinjaFirewall WP Edition](https://wordpress.org/plugins/ninjafirewall/) (free) and [NinjaFirewall WP+ Edition](https://nintechnet.com/ninjafirewall/wp-edition/) (premium), you are protected against those vulnerabilities.\n\n### Timeline\n\nDue to unsuccessful attempts to contact the authors on January 11, 2021, the issue was escalated to the WordPress Plugins Team on January 16 and a new version 1.7 was released on January 19.\n\n### Stay informed about the latest vulnerabilities\n\n*   Running WordPress? You can get [email notifications](https://blog.nintechnet.com/how-to-get-informed-about-the-latest-security-updates-in-your-wordpress-plugins-and-themes/) about vulnerabilities in the plugins or themes installed on your blog.\n*   On Twitter: [@nintechnet](https://twitter.com/nintechnet)",
      "date": "January 28, 2021"
    },
     "www_wordfence_com": {
      "content": "The uListing plugin for WordPress is vulnerable to authorization bypass due to missing capability and nonce checks on the UlistingUserRole::save\\_role\\_api method in versions up to, and including, 1.6.6. This makes it possible for unauthenticated attackers to remove or add roles, and add capabilities.",
       "date": "January 28, 2021"
    },
     "plugins_trac_wordpress_org": {
      "content": "update 1.7",
        "date": "January 15, 2021"
     }
  },
  "vulnerability_details": {
    "root_cause": "The plugin suffers from multiple vulnerabilities due to missing capability and nonce checks, insufficient input sanitization, and broken access control. This is present in both the WordPress AJAX API and a custom API (WP_Route) implemented by the plugin.",
    "weaknesses": [
      "Missing authorization checks",
      "Missing nonce checks",
        "Insufficient input sanitization",
      "Broken Access Control",
       "SQL Injection",
         "Information Disclosure"
      ],
    "impact": "An unauthenticated attacker can perform various malicious actions such as creating an admin account, modifying any user account, modifying arbitrary WordPress options, deleting arbitrary posts/pages, creating/deleting roles/capabilities, and performing SQL injection.",
    "attack_vectors": [
      "Sending malicious HTTP requests to the plugin's AJAX API endpoints.",
        "Sending malicious HTTP requests to the plugin's WP_Route API endpoints."
    ],
    "required_attacker_capabilities": "An unauthenticated attacker with the ability to send HTTP requests to the affected server."
  },
    "affected_versions": "<= 1.6.6",
  "fixed_version": "1.7"
}
```