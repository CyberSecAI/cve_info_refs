The provided content relates to a commit in the FreePBX voicemail module that addresses a stored XSS vulnerability.

**Root cause of vulnerability:**
The vulnerability is caused by the lack of proper sanitization of user-supplied input when displaying voicemail settings. Specifically, the `value` attribute in the HTML input fields for 'number' and 'text' types was not being properly sanitized, which allowed an attacker to inject malicious script.

**Weaknesses/vulnerabilities present:**
- Stored Cross-Site Scripting (XSS) vulnerability

**Impact of exploitation:**
- An attacker could inject malicious scripts into the voicemail settings page.
- This could potentially allow the attacker to execute arbitrary code in the context of a user's browser who views the vulnerable page, potentially leading to:
    - Session hijacking
    - Data theft
    - Redirecting users to malicious sites
    - Other malicious actions

**Attack vectors:**
- An attacker could insert malicious JavaScript code into the settings fields (text or number) in the voicemail module.
- The malicious code would then be stored in the system.
- When an administrator or another user views the voicemail settings page, the malicious code would be executed in their browser.

**Required attacker capabilities/position:**
- The attacker needs to have the ability to modify voicemail settings, which typically requires administrative or privileged access within the FreePBX system.
- An attacker with lower-level access may not be able to directly modify these settings.

**Mitigation:**
The fix implemented in the commit involves using `htmlentities()` to sanitize the user supplied values before being displayed in the `value` attributes, which helps to prevent XSS.

**Code changes:**

In `views/ssettings.php`:
- The following line was changed for 'number' type inputs:
    ```diff
    - <input type="number" class="form-control" id="<?php echo $id_prefix?>__<?php echo $key?>" name="<?php echo $id_prefix?>__<?php echo $key?>" value="<?php echo !empty($settings[$key]) ? $settings[$key] : $items['default'] ?>" <?php if(!empty($items['options'])) {?>min="<?php echo $items['options'][0]?>" max="<?php echo $items['options'][1]?>"<?php } ?>>
    + <input type="number" class="form-control" id="<?php echo $id_prefix?>__<?php echo $key?>" name="<?php echo $id_prefix?>__<?php echo $key?>" value="<?php echo !empty($settings[$key]) ? htmlentities($settings[$key], ENT_COMPAT, 'UTF-8') : $items['default'] ?>" <?php if(!empty($items['options'])) {?>min="<?php echo $items['options'][0]?>" max="<?php echo $items['options'][1]?>"<?php } ?>>
    ```
- Similarly for 'text' type inputs:
  ```diff
    - <input type="text" class="form-control" id="<?php echo $id_prefix?>__<?php echo $key?>" name="<?php echo $id_prefix?>__<?php echo $key?>" value="<?php echo !empty($settings[$key]) ? $settings[$key] : $items['default'] ?>">
    + <input type="text" class="form-control" id="<?php echo $id_prefix?>__<?php echo $key?>" name="<?php echo $id_prefix?>__<?php echo $key?>" value="<?php echo !empty($settings[$key]) ? htmlentities($settings[$key], ENT_COMPAT, 'UTF-8') : $items['default'] ?>">
  ```
In `page.voicemail.php`:
- The code was changed to use `freepbxGetSanitizedRequest(FILTER_UNSAFE_RAW)` to ensure that the request is sanitized before being passed on to `voicemail_update_settings` and `voicemail_update_usage` functions.
   ```diff
   -  if (voicemail_update_settings($action, $context, $extension, $_REQUEST)) {
   +  $request = freepbxGetSanitizedRequest(FILTER_UNSAFE_RAW);
   +  if (voicemail_update_settings($action, $context, $extension, $request)) {
   ```
   ```diff
   - voicemail_update_usage($vmail_info, $context, $extension, $_REQUEST);
   + $request = freepbxGetSanitizedRequest(FILTER_UNSAFE_RAW);
   + voicemail_update_usage($vmail_info, $context, $extension, $request);
   ```