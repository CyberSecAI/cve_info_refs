=== Content from github.com_a7014a46_20250115_093203.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbookstackapp%2Fbookstack%2Fcommit%2Fcb0d674a71449de883713db2fcdccb6e108992ad)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbookstackapp%2Fbookstack%2Fcommit%2Fcb0d674a71449de883713db2fcdccb6e108992ad)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=BookStackApp%2FBookStack)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[BookStackApp](/BookStackApp)
/
**[BookStack](/BookStackApp/BookStack)**
Public

* [Notifications](/login?return_to=%2FBookStackApp%2FBookStack) You must be signed in to change notification settings
* [Fork
  2k](/login?return_to=%2FBookStackApp%2FBookStack)
* [Star
   15.8k](/login?return_to=%2FBookStackApp%2FBookStack)

* [Code](/BookStackApp/BookStack)
* [Issues
  598](/BookStackApp/BookStack/issues)
* [Pull requests
  2](/BookStackApp/BookStack/pulls)
* [Actions](/BookStackApp/BookStack/actions)
* [Security](/BookStackApp/BookStack/security)
* [Insights](/BookStackApp/BookStack/pulse)

Additional navigation options

* [Code](/BookStackApp/BookStack)
* [Issues](/BookStackApp/BookStack/issues)
* [Pull requests](/BookStackApp/BookStack/pulls)
* [Actions](/BookStackApp/BookStack/actions)
* [Security](/BookStackApp/BookStack/security)
* [Insights](/BookStackApp/BookStack/pulse)

## Commit

[Permalink](/BookStackApp/BookStack/commit/cb0d674a71449de883713db2fcdccb6e108992ad)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge branch 'sort\_changes'

[Browse files](/BookStackApp/BookStack/tree/cb0d674a71449de883713db2fcdccb6e108992ad)
Browse the repository at this point in the history

```
Related to [#3134](https://github.com/BookStackApp/BookStack/issues/3134)
```

* Loading branch information

[![@ssddanbrown](https://avatars.githubusercontent.com/u/8343178?s=40&v=4)](/ssddanbrown)

[ssddanbrown](/BookStackApp/BookStack/commits?author=ssddanbrown "View all commits by ssddanbrown")
committed
Jan 6, 2022

2 parents
[4d09433](/BookStackApp/BookStack/commit/4d094331cfd1fbd2fede80232d9b1a0a94b4d482)
+
[2312d07](/BookStackApp/BookStack/commit/2312d07bb59b55a4efe0739d2176988a9bebb68c)

commit cb0d674

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**451 additions**
and
**162 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + Entities

    - Repos

      * app/Entities/Repos/ChapterRepo.php
        [ChapterRepo.php](#diff-86929a404ff4a6ab64ecb7b4e9dc1e27d414fc95ff47f251a4ed862e2451dc39)
      * app/Entities/Repos/PageRepo.php
        [PageRepo.php](#diff-f46a0a5a8f91b4215cbac6c1869249a598c4581a148b56c8499a73e2dcc8ca21)
    - Tools

      * app/Entities/Tools/BookContents.php
        [BookContents.php](#diff-d869ebf931dae4246585090d95657fb1d7959e466cd32af35af0a81a83159d97)
      * app/Entities/Tools/BookSortMap.php
        [BookSortMap.php](#diff-3e32bd705e23c0faab1ebf2d6ab51dea12d5c084f04e49f9faeb5a34626e8d33)
      * app/Entities/Tools/BookSortMapItem.php
        [BookSortMapItem.php](#diff-fc15923238db0d7d6c41128bbc991ae440f4bb718a63f45ea240885d640b48d2)
  + Exceptions

    - app/Exceptions/SortOperationException.php
      [SortOperationException.php](#diff-f962208ec12d8d30de2d5f0426b316a137ce5a534a7f3e12a013439c7c59b440)
  + Http/Controllers

    - app/Http/Controllers/BookSortController.php
      [BookSortController.php](#diff-481d7c055abe370253155aa3866c660d8c9298368ae9bdf84047f8e4cf505921)
    - app/Http/Controllers/ChapterController.php
      [ChapterController.php](#diff-27655a91cf12a1d0b05ff21b228c4a112b276597107ba9c6470bbc74f0c176c8)
    - app/Http/Controllers/PageController.php
      [PageController.php](#diff-c46f3feac860e7c017e64257048f6fd290ad1a3da02f9afd6cbcb2ead7358e65)
* tests

  + Entity

    - tests/Entity/SortTest.php
      [SortTest.php](#diff-a52d363cb25aa5fd86e2c03cf118266cc51c93f718452dcf8cc7406cf03811fd)
  + Permissions

    - tests/Permissions/EntityPermissionsTest.php
      [EntityPermissionsTest.php](#diff-f491f3f885693b5b1b808a681cc91fdc4727db866bb46377e263bd25e105f56a)

## There are no files selected for viewing

7 changes: 6 additions & 1 deletion

7
[app/Entities/Repos/ChapterRepo.php](#diff-86929a404ff4a6ab64ecb7b4e9dc1e27d414fc95ff47f251a4ed862e2451dc39 "app/Entities/Repos/ChapterRepo.php")

Show comments

[View file](/BookStackApp/BookStack/blob/cb0d674a71449de883713db2fcdccb6e108992ad/app/Entities/Repos/ChapterRepo.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,6 +10,7 @@ |
|  |  | use BookStack\Entities\Tools\TrashCan; |
|  |  | use BookStack\Exceptions\MoveOperationException; |
|  |  | use BookStack\Exceptions\NotFoundException; |
|  |  | use BookStack\Exceptions\PermissionsException; |
|  |  | use BookStack\Facades\Activity; |
|  |  | use Exception; |
|  |  |  |
| Expand Down  Expand Up | | @@ -85,15 +86,19 @@ public function destroy(Chapter $chapter) |
|  |  | \* 'book:<id>' (book:5). |
|  |  | \* |
|  |  | \* @throws MoveOperationException |
|  |  | \* @throws PermissionsException |
|  |  | \*/ |
|  |  | public function move(Chapter $chapter, string $parentIdentifier): Book |
|  |  | { |
|  |  | /\*\* @var Book $parent \*/ |
|  |  | $parent = $this->findParentByIdentifier($parentIdentifier); |
|  |  | if (is\_null($parent)) { |
|  |  | throw new MoveOperationException('Book to move chapter into not found'); |
|  |  | } |
|  |  |  |
|  |  | if (!userCan('chapter-create', $parent)) { |
|  |  | throw new PermissionsException('User does not have permission to create a chapter within the chosen book'); |
|  |  | } |
|  |  |  |
|  |  | $chapter->changeBook($parent->id); |
|  |  | $chapter->rebuildPermissions(); |
|  |  | Activity::add(ActivityType::CHAPTER\_MOVE, $chapter); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/Entities/Repos/PageRepo.php](#diff-f46a0a5a8f91b4215cbac6c1869249a598c4581a148b56c8499a73e2dcc8ca21 "app/Entities/Repos/PageRepo.php")

Show comments

[View file](/BookStackApp/BookStack/blob/cb0d674a71449de883713db2fcdccb6e108992ad/app/Entities/Repos/PageRepo.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -328,7 +328,7 @@ public function restoreRevision(Page $page, int $revisionId): Page |
|  |  | public function move(Page $page, string $parentIdentifier): Entity |
|  |  | { |
|  |  | $parent = $this->findParentByIdentifier($parentIdentifier); |
|  |  | if ($parent === null) { |
|  |  | if (is\_null($parent)) { |
|  |  | throw new MoveOperationException('Book or chapter to move page into not found'); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

213 changes: 154 additions & 59 deletions

213
[app/Entities/Tools/BookContents.php](#diff-d869ebf931dae4246585090d95657fb1d7959e466cd32af35af0a81a83159d97 "app/Entities/Tools/BookContents.php")

Show comments

[View file](/BookStackApp/BookStack/blob/cb0d674a71449de883713db2fcdccb6e108992ad/app/Entities/Tools/BookContents.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,7 +7,6 @@ |
|  |  | use BookStack\Entities\Models\Chapter; |
|  |  | use BookStack\Entities\Models\Entity; |
|  |  | use BookStack\Entities\Models\Page; |
|  |  | use BookStack\Exceptions\SortOperationException; |
|  |  | use Illuminate\Support\Collection; |
|  |  |  |
|  |  | class BookContents |
| Expand Down  Expand Up | | @@ -107,111 +106,207 @@ protected function getPages(bool $showDrafts = false, bool $getPageContent = fal |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Sort the books content using the given map. |
|  |  | \* The map is a single-dimension collection of objects in the following format: |
|  |  | \* { |
|  |  | \* +"id": "294" (ID of item) |
|  |  | \* +"sort": 1 (Sort order index) |
|  |  | \* +"parentChapter": false (ID of parent chapter, as string, or false) |
|  |  | \* +"type": "page" (Entity type of item) |
|  |  | \* +"book": "1" (Id of book to place item in) |
|  |  | \* }. |
|  |  | \* |
|  |  | \* Sort the books content using the given sort map. |
|  |  | \* Returns a list of books that were involved in the operation. |
|  |  | \* |
|  |  | \* @throws SortOperationException |
|  |  | \* @returns Book[] |
|  |  | \*/ |
|  |  | public function sortUsingMap(Collection $sortMap): Collection |
|  |  | public function sortUsingMap(BookSortMap $sortMap): array |
|  |  | { |
|  |  | // Load models into map |
|  |  | $this->loadModelsIntoSortMap($sortMap); |
|  |  | $booksInvolved = $this->getBooksInvolvedInSort($sortMap); |
|  |  | $modelMap = $this->loadModelsFromSortMap($sortMap); |
|  |  |  |
|  |  | // Sort our changes from our map to be chapters first |
|  |  | // Since they need to be process to ensure book alignment for child page changes. |
|  |  | $sortMapItems = $sortMap->all(); |
|  |  | usort($sortMapItems, function(BookSortMapItem $itemA, BookSortMapItem $itemB) { |
|  |  | $aScore = $itemA->type === 'page' ? 2 : 1; |
|  |  | $bScore = $itemB->type === 'page' ? 2 : 1; |
|  |  | return $aScore - $bScore; |
|  |  | }); |
|  |  |  |
|  |  | // Perform the sort |
|  |  | $sortMap->each(function ($mapItem) { |
|  |  | $this->applySortUpdates($mapItem); |
|  |  | }); |
|  |  | foreach ($sortMapItems as $item) { |
|  |  | $this->applySortUpdates($item, $modelMap); |
|  |  | } |
|  |  |  |
|  |  | /\*\* @var Book[] $booksInvolved \*/ |
|  |  | $booksInvolved = array\_values(array\_filter($modelMap, function (string $key) { |
|  |  | return strpos($key, 'book:') === 0; |
|  |  | }, ARRAY\_FILTER\_USE\_KEY)); |
|  |  |  |
|  |  | // Update permissions and activity. |
|  |  | $booksInvolved->each(function (Book $book) { |
|  |  | // Update permissions of books involved |
|  |  | foreach ($booksInvolved as $book) { |
|  |  | $book->rebuildPermissions(); |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | return $booksInvolved; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Using the given sort map item, detect changes for the related model |
|  |  | \* and update it if required. |
|  |  | \* and update it if required. Changes where permissions are lacking will |
|  |  | \* be skipped and not throw an error. |
|  |  | \* |
|  |  | \* @param array<string, Entity> $modelMap |
|  |  | \*/ |
|  |  | protected function applySortUpdates(\stdClass $sortMapItem) |
|  |  | protected function applySortUpdates(BookSortMapItem $sortMapItem, array $modelMap): void |
|  |  | { |
|  |  | /\*\* @var BookChild $model \*/ |
|  |  | $model = $sortMapItem->model; |
|  |  | $model = $modelMap[$sortMapItem->type . ':' . $sortMapItem->id] ?? null; |
|  |  | if (!$model) { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | $priorityChanged = $model->priority !== $sortMapItem->sort; |
|  |  | $bookChanged = $model->book\_id !== $sortMapItem->parentBookId; |
|  |  | $chapterChanged = ($model instanceof Page) && $model->chapter\_id !== $sortMapItem->parentChapterId; |
|  |  |  |
|  |  | // Stop if there's no change |
|  |  | if (!$priorityChanged && !$bookChanged && !$chapterChanged) { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | $currentParentKey = 'book:' . $model->book\_id; |
|  |  | if ($model instanceof Page && $model->chapter\_id) { |
|  |  | $currentParentKey = 'chapter:' . $model->chapter\_id; |
|  |  | } |
|  |  |  |
|  |  | $priorityChanged = intval($model->priority) !== intval($sortMapItem->sort); |
|  |  | $bookChanged = intval($model->book\_id) !== intval($sortMapItem->book); |
|  |  | $chapterChanged = ($model instanceof Page) && intval($model->chapter\_id) !== $sortMapItem->parentChapter; |
|  |  | $currentParent = $modelMap[$currentParentKey] ?? null; |
|  |  | /\*\* @var Book $newBook \*/ |
|  |  | $newBook = $modelMap['book:' . $sortMapItem->parentBookId] ?? null; |
|  |  | /\*\* @var ?Chapter $newChapter \*/ |
|  |  | $newChapter = $sortMapItem->parentChapterId ? ($modelMap['chapter:' . $sortMapItem->parentChapterId] ?? null) : null; |
|  |  |  |
|  |  | if (!$this->isSortChangePermissible($sortMapItem, $model, $currentParent, $newBook, $newChapter)) { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | // Action the required changes |
|  |  | if ($bookChanged) { |
|  |  | $model->changeBook($sortMapItem->book); |
|  |  | $model->changeBook($newBook->id); |
|  |  | } |
|  |  |  |
|  |  | if ($chapterChanged) { |
|  |  | $model->chapter\_id = intval($sortMapItem->parentChapter); |
|  |  | $model->save(); |
|  |  | $model->chapter\_id = $newChapter->id ?? 0; |
|  |  | } |
|  |  |  |
|  |  | if ($priorityChanged) { |
|  |  | $model->priority = intval($sortMapItem->sort); |
|  |  | $model->priority = $sortMapItem->sort; |
|  |  | } |
|  |  |  |
|  |  | if ($chapterChanged || $priorityChanged) { |
|  |  | $model->save(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Load models from the database into the given sort map. |
|  |  | \* Check if the current user has permissions to apply the given sorting change. |
|  |  | \* Is quite complex since items can gain a different parent change. Acts as a: |
|  |  | \* - Update of old parent element (Change of content/order). |
|  |  | \* - Update of sorted/moved element. |
|  |  | \* - Deletion of element (Relative to parent upon move). |
|  |  | \* - Creation of element within parent (Upon move to new parent). |
|  |  | \*/ |
|  |  | protected function loadModelsIntoSortMap(Collection $sortMap): void |
|  |  | protected function isSortChangePermissible(BookSortMapItem $sortMapItem, BookChild $model, ?Entity $currentParent, ?Entity $newBook, ?Entity $newChapter): bool |
|  |  | { |
|  |  | $keyMap = $sortMap->keyBy(function (\stdClass $sortMapItem) { |
|  |  | return $sortMapItem->type . ':' . $sortMapItem->id; |
|  |  | }); |
|  |  | $pageIds = $sortMap->where('type', '=', 'page')->pluck('id'); |
|  |  | $chapterIds = $sortMap->where('type', '=', 'chapter')->pluck('id'); |
|  |  | // Stop if we can't see the current parent or new book. |
|  |  | if (!$currentParent || !$newBook) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | $pages = Page::visible()->whereIn('id', $pageIds)->get(); |
|  |  | $chapters = Chapter::visible()->whereIn('id', $chapterIds)->get(); |
|  |  | $hasNewParent = $newBook->id !== $model->book\_id || ($model instanceof Page && $model->chapter\_id !== ($sortMapItem->parentChapterId ?? 0)); |
|  |  | if ($model instanceof Chapter) { |
|  |  | $hasPermission = userCan('book-update', $currentParent) |
|  |  | && userCan('book-update', $newBook) |
|  |  | && userCan('chapter-update', $model) |
|  |  | && (!$hasNewParent || userCan('chapter-create', $newBook)) |
|  |  | && (!$hasNewParent || userCan('chapter-delete', $model)); |
|  |  |  |
|  |  | foreach ($pages as $page) { |
|  |  | $sortItem = $keyMap->get('page:' . $page->id); |
|  |  | $sortItem->model = $page; |
|  |  | if (!$hasPermission) { |
|  |  | return false; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | foreach ($chapters as $chapter) { |
|  |  | $sortItem = $keyMap->get('chapter:' . $chapter->id); |
|  |  | $sortItem->model = $chapter; |
|  |  | if ($model instanceof Page) { |
|  |  | $parentPermission = ($currentParent instanceof Chapter) ? 'chapter-update' : 'book-update'; |
|  |  | $hasCurrentParentPermission = userCan($parentPermission, $currentParent); |
|  |  |  |
|  |  | // This needs to check if there was an intended chapter location in the original sort map |
|  |  | // rather than inferring from the $newChapter since that variable may be null |
|  |  | // due to other reasons (Visibility). |
|  |  | $newParent = $sortMapItem->parentChapterId ? $newChapter : $newBook; |
|  |  | if (!$newParent) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | $hasPageEditPermission = userCan('page-update', $model); |
|  |  | $newParentInRightLocation = ($newParent instanceof Book || $newParent->book\_id === $newBook->id); |
|  |  | $newParentPermission = ($newParent instanceof Chapter) ? 'chapter-update' : 'book-update'; |
|  |  | $hasNewParentPermission = userCan($newParentPermission, $newParent); |
|  |  |  |
|  |  | $hasDeletePermissionIfMoving = (!$hasNewParent || userCan('page-delete', $model)); |
|  |  | $hasCreatePermissionIfMoving = (!$hasNewParent || userCan('page-create', $newParent)); |
|  |  |  |
|  |  | $hasPermission = $hasCurrentParentPermission |
|  |  | && $newParentInRightLocation |
|  |  | && $hasNewParentPermission |
|  |  | && $hasPageEditPermission |
|  |  | && $hasDeletePermissionIfMoving |
|  |  | && $hasCreatePermissionIfMoving; |
|  |  |  |
|  |  | if (!$hasPermission) { |
|  |  | return false; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get the books involved in a sort. |
|  |  | \* The given sort map should have its models loaded first. |
|  |  | \* |
|  |  | \* @throws SortOperationException |
|  |  | \* Load models from the database into the given sort map. |
|  |  | \* @return array<string, Entity> |
|  |  | \*/ |
|  |  | protected function getBooksInvolvedInSort(Collection $sortMap): Collection |
|  |  | protected function loadModelsFromSortMap(BookSortMap $sortMap): array |
|  |  | { |
|  |  | $bookIdsInvolved = collect([$this->book->id]); |
|  |  | $bookIdsInvolved = $bookIdsInvolved->concat($sortMap->pluck('book')); |
|  |  | $bookIdsInvolved = $bookIdsInvolved->concat($sortMap->pluck('model.book\_id')); |
|  |  | $bookIdsInvolved = $bookIdsInvolved->unique()->toArray(); |
|  |  | $modelMap = []; |
|  |  | $ids = [ |
|  |  | 'chapter' => [], |
|  |  | 'page' => [], |
|  |  | 'book' => [], |
|  |  | ]; |
|  |  |  |
|  |  | foreach ($sortMap->all() as $sortMapItem) { |
|  |  | $ids[$sortMapItem->type][] = $sortMapItem->id; |
|  |  | $ids['book'][] = $sortMapItem->parentBookId; |
|  |  | if ($sortMapItem->parentChapterId) { |
|  |  | $ids['chapter'][] = $sortMapItem->parentChapterId; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | $pages = Page::visible()->whereIn('id', array\_unique($ids['page']))->get(Page::$listAttributes); |
|  |  | /\*\* @var Page $page \*/ |
|  |  | foreach ($pages as $page) { |
|  |  | $modelMap['page:' . $page->id] = $page; |
|  |  | $ids['book'][] = $page->book\_id; |
|  |  | if ($page->chapter\_id) { |
|  |  | $ids['chapter'][] = $page->chapter\_id; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | $books = Book::hasPermission('update')->whereIn('id', $bookIdsInvolved)->get(); |
|  |  | $chapters = Chapter::visible()->whereIn('id', array\_unique($ids['chapter']))->get(); |
|  |  | /\*\* @var Chapter $chapter \*/ |
|  |  | foreach ($chapters as $chapter) { |
|  |  | $modelMap['chapter:' . $chapter->id] = $chapter; |
|  |  | $ids['book'][] = $chapter->book\_id; |
|  |  | } |
|  |  |  |
|  |  | if (count($books) !== count($bookIdsInvolved)) { |
|  |  | throw new SortOperationException('Could not find all books requested in sort operation'); |
|  |  | $books = Book::visible()->whereIn('id', array\_unique($ids['book']))->get(); |
|  |  | /\*\* @var Book $book \*/ |
|  |  | foreach ($books as $book) { |
|  |  | $modelMap['book:' . $book->id] = $book; |
|  |  | } |
|  |  |  |
|  |  | return $books; |
|  |  | return $modelMap; |
|  |  | } |
|  |  | } |

45 changes: 45 additions & 0 deletions

45
[app/Entities/Tools/BookSortMap.php](#diff-3e32bd705e23c0faab1ebf2d6ab51dea12d5c084f04e49f9faeb5a34626e8d33 "app/Entities/Tools/BookSortMap.php")

Show comments

[View file](/BookStackApp/BookStack/blob/cb0d674a71449de883713db2fcdccb6e108992ad/app/Entities/Tools/BookSortMap.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,45 @@ |
|  |  | <?php |
|  |  |  |
|  |  | namespace BookStack\Entities\Tools; |
|  |  |  |
|  |  | class BookSortMap |
|  |  | { |
|  |  | /\*\* |
|  |  | \* @var BookSortMapItem[] |
|  |  | \*/ |
|  |  | protected $mapData = []; |
|  |  |  |
|  |  | public function addItem(BookSortMapItem $mapItem): void |
|  |  | { |
|  |  | $this->mapData[] = $mapItem; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return BookSortMapItem[] |
|  |  | \*/ |
|  |  | public function all(): array |
|  |  | { |
|  |  | return $this->mapData; |
|  |  | } |
|  |  |  |
|  |  | public static function fromJson(string $json): self |
|  |  | { |
|  |  | $map = new static(); |
|  |  | $mapData = json\_decode($json); |
|  |  |  |
|  |  | foreach ($mapData as $mapDataItem) { |
|  |  | $item = new BookSortMapItem( |
|  |  | intval($mapDataItem->id), |
|  |  | intval($mapDataItem->sort), |
|  |  | $mapDataItem->parentChapter ? intval($mapDataItem->parentChapter) : null, |
|  |  | $mapDataItem->type, |
|  |  | intval($mapDataItem->book) |
|  |  | ); |
|  |  |  |
|  |  | $map->addItem($item); |
|  |  | } |
|  |  |  |
|  |  | return $map; |
|  |  | } |
|  |  |  |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `cb0d674`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbookstackapp%2Fbookstack%2Fcommit%2Fcb0d674a71449de883713db2fcdccb6e108992ad) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from huntr.dev_c0f01538_20250115_093204.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)
