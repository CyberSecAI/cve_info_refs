=== Content from github.com_6808e260_20250114_205842.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RaspAP%2Fraspap-webgui)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RaspAP](/RaspAP)
/
**[raspap-webgui](/RaspAP/raspap-webgui)**
Public

* [Notifications](/login?return_to=%2FRaspAP%2Fraspap-webgui) You must be signed in to change notification settings
* [Fork
  797](/login?return_to=%2FRaspAP%2Fraspap-webgui)
* [Star
   4.5k](/login?return_to=%2FRaspAP%2Fraspap-webgui)

* [Code](/RaspAP/raspap-webgui)
* [Issues
  22](/RaspAP/raspap-webgui/issues)
* [Pull requests
  9](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects
  1](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

Additional navigation options

* [Code](/RaspAP/raspap-webgui)
* [Issues](/RaspAP/raspap-webgui/issues)
* [Pull requests](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

## Files

 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/RaspAP/raspap-webgui/commits/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)executable file·682 lines (604 loc) · 28.8 KB 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Top
## File metadata and controls

* Code
* Blame

executable file·682 lines (604 loc) · 28.8 KB[Raw](https://github.com/RaspAP/raspap-webgui/raw/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681#!/bin/bash## RaspAP installation functions# Author: @billz <billzimmerman@gmail.com># Author URI: https://github.com/billz/# License: GNU General Public License v3.0# License URI: https://github.com/raspap/raspap-webgui/blob/master/LICENSE
# You are not obligated to bundle the LICENSE file with your RaspAP projects as long# as you leave these references intact in the header comments of your source files.
# Exit on errorset -o errexit# Exit on error inside functionsset -o errtrace# Turn on traces, disabled by default# set -o xtrace
# Set defaultsreadonly raspap\_dir="/etc/raspap"readonly raspap\_user="www-data"readonly raspap\_sudoers="/etc/sudoers.d/090\_raspap"readonly raspap\_default="/etc/dnsmasq.d/090\_raspap.conf"readonly raspap\_wlan0="/etc/dnsmasq.d/090\_wlan0.conf"readonly raspap\_adblock="/etc/dnsmasq.d/090\_adblock.conf"readonly raspap\_sysctl="/etc/sysctl.d/90\_raspap.conf"readonly raspap\_network="$raspap\_dir/networking/"readonly raspap\_router="/etc/lighttpd/conf-available/50-raspap-router.conf"readonly rulesv4="/etc/iptables/rules.v4"readonly notracking\_url="https://raw.githubusercontent.com/notracking/hosts-blocklists/master/"webroot\_dir="/var/www/html"
if [ "$insiders" == 1 ]; then repo="RaspAP/raspap-insiders" branch=${RASPAP\_INSIDERS\_LATEST}figit\_source\_url="https://github.com/$repo"
# NOTE: all the below functions are overloadable for system-specific installsfunction \_install\_raspap() { \_display\_welcome \_config\_installation \_update\_system\_packages \_install\_dependencies \_enable\_php\_lighttpd \_create\_raspap\_directories \_optimize\_php \_check\_for\_old\_configs \_download\_latest\_files \_change\_file\_ownership \_create\_hostapd\_scripts \_create\_lighttpd\_scripts \_install\_lighttpd\_configs \_move\_config\_file \_default\_configuration \_configure\_networking \_prompt\_install\_adblock \_prompt\_install\_openvpn \_install\_mobile\_clients \_prompt\_install\_wireguard \_patch\_system\_files \_install\_complete}
# search for optional installation files names install\_feature\_\*.shfunction \_install\_mobile\_clients() { if [ "$insiders" == 1 ]; then \_install\_log "Installing support for mobile data clients" for feature in $(ls $webroot\_dir/installers/install\_feature\_\*.sh) ; do source $feature f=$(basename $feature) func="\_${f%.\*}" if declare -f -F $func > /dev/null; then echo "Installing $func" $func || \_install\_status 1 "Unable to install feature ($func)" else \_install\_status 1 "Install file $f is missing install function $func" fi done fi}
# Prompts user to set installation optionsfunction \_config\_installation() { if [ "$upgrade" == 1 ]; then opt=(Upgrade Upgrading upgrade) else opt=(Install Installing installation) fi \_install\_log "Configure ${opt[2]}" \_get\_linux\_distro echo "Detected OS: ${DESC}" echo "Using GitHub repository: ${repo} ${branch} branch" echo "Configuration directory: ${raspap\_dir}" echo -n "lighttpd root: ${webroot\_dir}? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then read -e -p < /dev/tty "Enter alternate lighttpd directory: " -i "/var/www/html" webroot\_dir fi else echo -e fi echo "${opt[1]} lighttpd directory: ${webroot\_dir}" if [ "$upgrade" == 1 ]; then echo "This will upgrade your existing install to version ${RASPAP\_RELEASE}" echo "Your configuration will NOT be changed" fi echo -n "Complete ${opt[2]} with these values? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation aborted." exit 0 fi else echo -e fi}
# Determines host Linux distribution detailsfunction \_get\_linux\_distro() { if type lsb\_release >/dev/null 2>&1; then # linuxbase.org OS=$(lsb\_release -si) RELEASE=$(lsb\_release -sr) CODENAME=$(lsb\_release -sc) DESC=$(lsb\_release -sd) elif [ -f /etc/os-release ]; then # freedesktop.org . /etc/os-release OS=$ID RELEASE=$VERSION\_ID CODENAME=$VERSION\_CODENAME DESC=$PRETTY\_NAME else \_install\_status 1 "Unsupported Linux distribution" fi}
# Sets php package option based on Linux version, abort if unsupported distrofunction \_set\_php\_package() { case $RELEASE in 18.04|19.10) # Ubuntu Server php\_package="php7.4-cgi" phpcgiconf="/etc/php/7.4/cgi/php.ini" ;; 10\*) php\_package="php7.3-cgi" phpcgiconf="/etc/php/7.3/cgi/php.ini" ;; 9\*) php\_package="php7.0-cgi" phpcgiconf="/etc/php/7.0/cgi/php.ini" ;; 8) \_install\_status 1 "${DESC} and php5 are not supported. Please upgrade." ;; \*) \_install\_status 1 "${DESC} is unsupported. Please install on a supported distro." ;; esac}
# Runs a system software update to make sure we're using all fresh packagesfunction \_install\_dependencies() { \_install\_log "Installing required packages" \_set\_php\_package if [ "$php\_package" = "php7.4-cgi" ]; then echo "Adding apt-repository ppa:ondrej/php" sudo apt-get install $apt\_option software-properties-common || \_install\_status 1 "Unable to install dependency" sudo add-apt-repository $apt\_option ppa:ondrej/php || \_install\_status 1 "Unable to add-apt-repository ppa:ondrej/php" fi if [ ${OS,,} = "debian" ] || [ ${OS,,} = "ubuntu" ]; then dhcpcd\_package="dhcpcd5" fi # Set dconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v4 boolean true | sudo debconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v6 boolean true | sudo debconf-set-selections sudo apt-get install $apt\_option lighttpd git hostapd dnsmasq iptables-persistent $php\_package $dhcpcd\_package vnstat qrencode || \_install\_status 1 "Unable to install dependencies" \_install\_status 0}
# Enables PHP for lighttpd and restarts service for settings to take effectfunction \_enable\_php\_lighttpd() { \_install\_log "Enabling PHP for lighttpd" sudo lighttpd-enable-mod fastcgi-php  sudo service lighttpd force-reload sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd"}
# Verifies existence and permissions of RaspAP directoryfunction \_create\_raspap\_directories() { \_install\_log "Creating RaspAP directories" if [ -d "$raspap\_dir" ]; then sudo mv $raspap\_dir "$raspap\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to move old '$raspap\_dir' out of the way" fi sudo mkdir -p "$raspap\_dir" || \_install\_status 1 "Unable to create directory '$raspap\_dir'"
 # Create a directory for existing file backups. sudo mkdir -p "$raspap\_dir/backups"
 # Create a directory to store networking configs echo "Creating $raspap\_dir/networking" sudo mkdir -p "$raspap\_dir/networking" # Copy existing dhcpcd.conf to use as base config echo "Adding /etc/dhcpcd.conf as base configuration" cat /etc/dhcpcd.conf | sudo tee -a /etc/raspap/networking/defaults > /dev/null echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Generate hostapd logging and service control scriptsfunction \_create\_hostapd\_scripts() { \_install\_log "Creating hostapd logging & control scripts" sudo mkdir $raspap\_dir/hostapd || \_install\_status 1 "Unable to create directory '$raspap\_dir/hostapd'"
 # Move logging shell scripts  sudo cp "$webroot\_dir/installers/"\*log.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move logging scripts" # Move service control shell scripts sudo cp "$webroot\_dir/installers/"service\*.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move service control scripts" # Make enablelog.sh and disablelog.sh not writable by www-data group. sudo chown -c root:"$raspap\_user" "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Generate lighttpd service control scriptsfunction \_create\_lighttpd\_scripts() { \_install\_log "Creating lighttpd control scripts" sudo mkdir $raspap\_dir/lighttpd || \_install\_status 1 "Unable to create directory '$raspap\_dir/lighttpd"
 # Move service control shell scripts echo "Copying configport.sh to $raspap\_dir/lighttpd" sudo cp "$webroot\_dir/installers/"configport.sh "$raspap\_dir/lighttpd" || \_install\_status 1 "Unable to move service control scripts" # Make configport.sh writable by www-data group echo "Changing file ownership" sudo chown -c root:"$raspap\_user" "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Copy extra config files required to configure lighttpdfunction \_install\_lighttpd\_configs() { \_install\_log "Copying lighttpd extra config files"
 # Copy config files echo "Copying 50-raspap-router.conf to /etc/lighttpd/conf-available"
 CONFSRC="$webroot\_dir/config/50-raspap-router.conf" LTROOT=$(grep "server.document-root" /etc/lighttpd/lighttpd.conf | awk -F '=' '{print $2}' | tr -d " \"")
 # Compare values and get difference HTROOT=${webroot\_dir/$LTROOT}
 # Remove trailing slash if present HTROOT=$(echo "$HTROOT" | sed -e 's/\/$//')
 # Substitute values awk "{gsub(\"/REPLACE\_ME\",\"$HTROOT\")}1" $CONFSRC > /tmp/50-raspap-router.conf
 # Copy into place sudo cp /tmp/50-raspap-router.conf /etc/lighttpd/conf-available/ || \_install\_status 1 "Unable to copy lighttpd config file into place."
 # Link into conf-enabled echo "Creating link to /etc/lighttpd/conf-enabled" if ! [ -L $raspap\_router ]; then echo "Existing 50-raspap-router.conf found. Unlinking." sudo unlink "/etc/lighttpd/conf-enabled/50-raspap-router.conf" fi echo "Linking 50-raspap-router.conf to /etc/lighttpd/conf-enabled/" sudo ln -s "/etc/lighttpd/conf-available/50-raspap-router.conf" "/etc/lighttpd/conf-enabled/50-raspap-router.conf" || \_install\_status 1 "Unable to symlink lighttpd config file (this is normal if the link already exists)." sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd" \_install\_status 0}
# Prompt to install ad blockingfunction \_prompt\_install\_adblock() { \_install\_log "Configure ad blocking (Beta)" echo -n "Install ad blocking and enable list management? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_adblock fi elif [ "$adblock\_option" == 1 ]; then \_install\_adblock else echo "(Skipped)" fi}
# Download notracking adblock lists and enable optionfunction \_install\_adblock() { \_install\_log "Creating ad blocking base configuration (Beta)" if [ ! -d "$raspap\_dir/adblock" ]; then echo "Creating $raspap\_dir/adblock" sudo mkdir -p "$raspap\_dir/adblock" fi if [ ! -f /tmp/hostnames.txt ]; then echo "Fetching latest hostnames list" wget ${notracking\_url}hostnames.txt -q --show-progress --progress=bar:force -O /tmp/hostnames.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking hostnames" fi if [ ! -f /tmp/domains.txt ]; then echo "Fetching latest domains list" wget ${notracking\_url}domains.txt -q --show-progress --progress=bar:force -O /tmp/domains.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking domains" fi echo "Adding blocklists to $raspap\_dir/adblock" sudo cp /tmp/hostnames.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking hostnames" sudo cp /tmp/domains.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking domains"
 echo "Moving and setting permissions for blocklist update script" sudo cp "$webroot\_dir/installers/"update\_blocklist.sh "$raspap\_dir/adblock" || \_install\_status 1 "Unable to move blocklist update script"
 # Make blocklists and update script writable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/adblock/"\*.\* || \_install\_status 1 "Unable to change owner/group" sudo chmod 750 "$raspap\_dir/adblock/"\*.sh || install\_error "Unable to change file permissions"
 # Create 090\_adblock.conf and write values to /etc/dnsmasq.d if [ ! -f "$raspap\_adblock" ]; then echo "Adding 090\_addblock.conf to /etc/dnsmasq.d" sudo touch "$raspap\_adblock" echo "conf-file=$raspap\_dir/adblock/domains.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" echo "addn-hosts=$raspap\_dir/adblock/hostnames.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" fi
 # Remove dhcp-option=6 in dnsmasq.d/090\_wlan0.conf to force local DNS resolution for DHCP clients echo "Enabling local DNS name resolution for DHCP clients" sudo sed -i '/dhcp-option=6/d' $raspap\_wlan0 || \_install\_status 1 "Unable to modify $raspap\_dnsmasq"
 echo "Enabling ad blocking management option" sudo sed -i "s/\('RASPI\_ADBLOCK\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Prompt to install openvpnfunction \_prompt\_install\_openvpn() { \_install\_log "Configure OpenVPN support" echo -n "Install OpenVPN and enable client configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_openvpn fi elif [ "$ovpn\_option" == 1 ]; then \_install\_openvpn else echo "(Skipped)" fi}
# Prompt to install WireGuardfunction \_prompt\_install\_wireguard() { if [ "$insiders" == 1 ]; then \_install\_log "Configure WireGuard support" echo -n "Install WireGuard and enable VPN tunnel configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_wireguard fi elif [ "$wg\_option" == 1 ]; then \_install\_wireguard else echo "(Skipped)" fi fi}
# Install Wireguard from the Debian unstable distrofunction \_install\_wireguard() { \_install\_log "Configure WireGuard support" if [ "$OS" == "Debian" ]; then echo 'deb http://ftp.debian.org/debian buster-backports main' | sudo tee /etc/apt/sources.list.d/buster-backports.list || \_install\_status 1 "Unable to add Debian backports repo" fi echo "Installing wireguard from apt" sudo apt-get update && sudo apt-get install $apt\_option wireguard || \_install\_status 1 "Unable to install wireguard" echo "Enabling wg-quick@wg0" sudo systemctl enable wg-quick@wg0 || \_install\_status 1 "Failed to enable wg-quick service" echo "Enabling WireGuard management option" sudo sed -i "s/\('RASPI\_WIREGUARD\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Install openvpn and enable client configuration optionfunction \_install\_openvpn() { \_install\_log "Installing OpenVPN and enabling client configuration" echo "Adding packages via apt-get" sudo apt-get install -y openvpn || \_install\_status 1 "Unable to install openvpn" sudo sed -i "s/\('RASPI\_OPENVPN\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" echo "Enabling openvpn-client service on boot" sudo systemctl enable openvpn-client@client || \_install\_status 1 "Unable to enable openvpn-client daemon" \_create\_openvpn\_scripts || \_install\_status 1 "Unable to create openvpn control scripts"}
# Generate openvpn logging and auth control scriptsfunction \_create\_openvpn\_scripts() { \_install\_log "Creating OpenVPN control scripts" sudo mkdir $raspap\_dir/openvpn || \_install\_status 1 "Unable to create directory '$raspap\_dir/openvpn'"
 # Move service auth control & logging shell scripts sudo cp "$webroot\_dir/installers/"configauth.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move auth control script" sudo cp "$webroot\_dir/installers/"openvpnlog.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move logging script" # Make scripts executable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Fetches latest files from github to webrootfunction \_download\_latest\_files() { if [ ! -d "$webroot\_dir" ]; then sudo mkdir -p $webroot\_dir || \_install\_status 1 "Unable to create new webroot directory" fi
 if [ -d "$webroot\_dir" ]; then sudo mv $webroot\_dir "$webroot\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to remove old webroot directory" fi
 \_install\_log "Cloning latest files from github" git clone --branch $branch --depth 1 -c advice.detachedHead=false $git\_source\_url /tmp/raspap-webgui || \_install\_status 1 "Unable to download files from github"
 sudo mv /tmp/raspap-webgui $webroot\_dir || \_install\_status 1 "Unable to move raspap-webgui to web root" if [ "$upgrade" == 1 ]; then \_install\_log "Applying existing configuration to ${webroot\_dir}/includes" sudo mv /tmp/config.php $webroot\_dir/includes || \_install\_status 1 "Unable to move config.php to ${webroot\_dir}/includes" fi
 \_install\_status 0}
# Sets files ownership in web root directoryfunction \_change\_file\_ownership() { if [ ! -d "$webroot\_dir" ]; then \_install\_status 1 "Web root directory doesn't exist" fi
 \_install\_log "Changing file ownership in web root directory" sudo chown -R $raspap\_user:$raspap\_user "$webroot\_dir" || \_install\_status 1 "Unable to change file ownership for '$webroot\_dir'"}
# Check for existing configuration filesfunction \_check\_for\_old\_configs() { if [ "$upgrade" == 1 ]; then \_install\_log "Moving existing configuration to /tmp" sudo mv $webroot\_dir/includes/config.php /tmp || \_install\_status 1 "Unable to move config.php to /tmp" else \_install\_log "Backing up existing configs to ${raspap\_dir}/backups" if [ -f /etc/network/interfaces ]; then sudo cp /etc/network/interfaces "$raspap\_dir/backups/interfaces.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/interfaces.`date +%F-%R`" "$raspap\_dir/backups/interfaces" fi
 if [ -f /etc/hostapd/hostapd.conf ]; then sudo cp /etc/hostapd/hostapd.conf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" "$raspap\_dir/backups/hostapd.conf" fi
 if [ -f $raspap\_default ]; then sudo cp $raspap\_default "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_raspap.conf" fi
 if [ -f $raspap\_wlan0 ]; then sudo cp $raspap\_wlan0 "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_wlan0.conf" fi
 if [ -f /etc/dhcpcd.conf ]; then sudo cp /etc/dhcpcd.conf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" "$raspap\_dir/backups/dhcpcd.conf" fi
 for file in /etc/systemd/network/raspap-\*.net\*; do if [ -f "${file}" ]; then filename=$(basename $file) sudo cp "$file" "${raspap\_dir}/backups/${filename}.`date +%F-%R`" sudo ln -sf "${raspap\_dir}/backups/${filename}.`date +%F-%R`" "${raspap\_dir}/backups/${filename}" fi done fi \_install\_status 0}
# Move configuration file to the correct locationfunction \_move\_config\_file() { if [ ! -d "$raspap\_dir" ]; then \_install\_status 1 "'$raspap\_dir' directory doesn't exist" fi
 \_install\_log "Moving configuration file to $raspap\_dir" sudo cp "$webroot\_dir"/raspap.php "$raspap\_dir" || \_install\_status 1 "Unable to move files to '$raspap\_dir'" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Set up default configurationfunction \_default\_configuration() { if [ "$upgrade" == 0 ]; then \_install\_log "Applying default configuration to installed services"
 sudo cp $webroot\_dir/config/hostapd.conf /etc/hostapd/hostapd.conf || \_install\_status 1 "Unable to move hostapd configuration file" sudo cp $webroot\_dir/config/090\_raspap.conf $raspap\_default || \_install\_status 1 "Unable to move dnsmasq default configuration file" sudo cp $webroot\_dir/config/090\_wlan0.conf $raspap\_wlan0 || \_install\_status 1 "Unable to move dnsmasq wlan0 configuration file" sudo cp $webroot\_dir/config/dhcpcd.conf /etc/dhcpcd.conf || \_install\_status 1 "Unable to move dhcpcd configuration file" sudo cp $webroot\_dir/config/defaults.json $raspap\_network || \_install\_status 1 "Unable to move defaults.json settings"
 echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"
 echo "Checking for existence of /etc/dnsmasq.d" [ -d /etc/dnsmasq.d ] || sudo mkdir /etc/dnsmasq.d
 echo "Copying bridged AP config to /etc/systemd/network" sudo systemctl stop systemd-networkd sudo systemctl disable systemd-networkd sudo cp $webroot\_dir/config/raspap-bridge-br0.netdev /etc/systemd/network/raspap-bridge-br0.netdev || \_install\_status 1 "Unable to move br0 netdev file" sudo cp $webroot\_dir/config/raspap-br0-member-eth0.network /etc/systemd/network/raspap-br0-member-eth0.network || \_install\_status 1 "Unable to move br0 member file"
 echo "Copying primary RaspAP config to includes/config.php" if [ ! -f "$webroot\_dir/includes/config.php" ]; then sudo cp "$webroot\_dir/config/config.php" "$webroot\_dir/includes/config.php" fi \_install\_status 0 fi}
# Install and enable RaspAP daemonfunction \_enable\_raspap\_daemon() { \_install\_log "Enabling RaspAP daemon" echo "Disable with: sudo systemctl disable raspapd.service" sudo cp $webroot\_dir/installers/raspapd.service /lib/systemd/system/ || \_install\_status 1 "Unable to move raspap.service file" sudo systemctl daemon-reload sudo systemctl enable raspapd.service || \_install\_status 1 "Failed to enable raspap.service"}
# Configure IP forwarding, set IP tables rules, prompt to install RaspAP daemonfunction \_configure\_networking() { \_install\_log "Configuring networking" echo "Enabling IP forwarding" echo "net.ipv4.ip\_forward=1" | sudo tee $raspap\_sysctl > /dev/null || \_install\_status 1 "Unable to set IP forwarding" sudo sysctl -p $raspap\_sysctl || \_install\_status 1 "Unable to execute sysctl" sudo /etc/init.d/procps restart || \_install\_status 1 "Unable to execute procps"
 echo "Checking iptables rules" rules=( "-A POSTROUTING -j MASQUERADE" "-A POSTROUTING -s 192.168.50.0/24 ! -d 192.168.50.0/24 -j MASQUERADE" ) for rule in "${rules[@]}"; do if grep -- "$rule" $rulesv4 > /dev/null; then echo "Rule already exits: ${rule}" else rule=$(sed -e 's/^\(-A POSTROUTING\)/-t nat \1/' <<< $rule) echo "Adding rule: ${rule}" sudo iptables $rule || \_install\_status 1 "Unable to execute iptables" added=true fi done # Persist rules if added if [ "$added" = true ]; then echo "Persisting IP tables rules" sudo iptables-save | sudo tee $rulesv4 > /dev/null || \_install\_status 1 "Unable to execute iptables-save" fi
 # Prompt to install RaspAP daemon echo -n "Enable RaspAP control service (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_enable\_raspap\_daemon fi else echo -e \_enable\_raspap\_daemon fi \_install\_status 0 }
# Add sudoers file to /etc/sudoers.d/ and set file permissionsfunction \_patch\_system\_files() {
 # Create sudoers if not present if [ ! -f $raspap\_sudoers ]; then \_install\_log "Adding raspap.sudoers to ${raspap\_sudoers}" sudo cp "$webroot\_dir/installers/raspap.sudoers" $raspap\_sudoers || \_install\_status 1 "Unable to apply raspap.sudoers to $raspap\_sudoers" sudo chmod 0440 $raspap\_sudoers || \_install\_status 1 "Unable to change file permissions for $raspap\_sudoers" fi
 # Add symlink to prevent wpa\_cli cmds from breaking with multiple wlan interfaces \_install\_log "Symlinked wpa\_supplicant hooks for multiple wlan interfaces" if [ ! -f /usr/share/dhcpcd/hooks/10-wpa\_supplicant ]; then sudo ln -s /usr/share/dhcpcd/hooks/10-wpa\_supplicant /etc/dhcp/dhclient-enter-hooks.d/ fi
 # Unmask and enable hostapd.service \_install\_log "Unmasking and enabling hostapd service" sudo systemctl unmask hostapd.service sudo systemctl enable hostapd.service \_install\_status 0}
# Optimize configuration of php-cgi.function \_optimize\_php() { if [ "$upgrade" == 0 ]; then \_install\_log "Optimize PHP configuration" if [ ! -f "$phpcgiconf" ]; then \_install\_warning "PHP configuration could not be found." return fi
 # Backup php.ini and create symlink for restoring. datetimephpconf=$(date +%F-%R) sudo cp "$phpcgiconf" "$raspap\_dir/backups/php.ini.$datetimephpconf" sudo ln -sf "$raspap\_dir/backups/php.ini.$datetimephpconf" "$raspap\_dir/backups/php.ini"
 echo -n "Enable HttpOnly for session cookies (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_session\_cookie=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$php\_session\_cookie" == 1 ]; then echo "Php-cgi enabling session.cookie\_httponly." sudo sed -i -E 's/^session\.cookie\_httponly\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/session.cookie\_httponly = 1/' "$phpcgiconf" fi
 if [ "$php\_package" = "php7.1-cgi" ]; then echo -n "Enable PHP OPCache (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_opcache=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$phpopcache" == 1 ]; then echo -e "Php-cgi enabling opcache.enable." sudo sed -i -E 's/^;?opcache\.enable\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/opcache.enable = 1/' "$phpcgiconf" # Make sure opcache extension is turned on. if [ -f "/usr/sbin/phpenmod" ]; then sudo phpenmod opcache else \_install\_status 2 "phpenmod not found." fi fi fi fi}
function \_install\_complete() { \_install\_log "Installation completed" echo "Join RaspAP Insiders for early access to exclusive features!" echo -e "${ANSI\_RASPBERRY}" echo "> https://docs.raspap.com/insiders/" echo "> https://github.com/sponsors/RaspAP/" echo -e "${ANSI\_RESET}" if [ "$assume\_yes" == 0 ]; then # Prompt to reboot if wired ethernet (eth0) is connected. # With default\_configuration this will create an active AP on restart. if ip a | grep -q ': eth0:.\*state UP'; then echo -n "The system needs to be rebooted as a final step. Reboot now? [y/N]: " read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation reboot aborted." exit 0 fi sudo shutdown -r now || \_install\_status 1 "Unable to execute shutdown" fi fi}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_8164f5a6_20250114_205824.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@omriinbar](https://avatars.githubusercontent.com/u/80689106?s=64&v=4)](/omriinbar)

# [omriinbar](/omriinbar)/**[RaspAP-Vulnerabilities.txt](/omriinbar/52c000c02a6992c6ce68d531195f69cf)**

Created
May 28, 2021 19:14

Show Gist options

* [Download ZIP](/omriinbar/52c000c02a6992c6ce68d531195f69cf/archive/a2c3740c220a54bd428389fda99793f63d117639.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/omriinbar/52c000c02a6992c6ce68d531195f69cf.js&quot;&gt;&lt;/script&gt;
* Save omriinbar/52c000c02a6992c6ce68d531195f69cf to your computer and use it in GitHub Desktop.

[Code](/omriinbar/52c000c02a6992c6ce68d531195f69cf)
[Revisions
2](/omriinbar/52c000c02a6992c6ce68d531195f69cf/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/omriinbar/52c000c02a6992c6ce68d531195f69cf.js&quot;&gt;&lt;/script&gt;

Save omriinbar/52c000c02a6992c6ce68d531195f69cf to your computer and use it in GitHub Desktop.

[Download ZIP](/omriinbar/52c000c02a6992c6ce68d531195f69cf/archive/a2c3740c220a54bd428389fda99793f63d117639.zip)

RaspAP Vulnerabilities

 [Raw](/omriinbar/52c000c02a6992c6ce68d531195f69cf/raw/a2c3740c220a54bd428389fda99793f63d117639/RaspAP-Vulnerabilities.txt)

[**RaspAP-Vulnerabilities.txt**](#file-raspap-vulnerabilities-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | CVE-2021-33356 |
| --- | --- |
|  | Vulnerable Product Version: RaspAP 1.5 to (and including) 2.6.5 |
|  | Vulnerability Type: Privilege Escalation due to Execution with Unnecessary Privileges (CWE-250) |
|  | Description: Multiple privilege escalation vulnerabilities in RaspAP 1.5 to 2.6.5 could allow an authenticated remote attacker to inject arbitrary commands to /installers/common.sh component that can result in remote command execution with root privileges. |
|  |  |
|  |  |
|  | CVE-2021-33357 |
|  | Vulnerable Product Version: RaspAP 2.6 to (and including) 2.6.5 |
|  | Vulnerability Type: OS Command Injection (CWE-78) |
|  | Description: A vulnerability exists in RaspAP 2.6 to 2.6.5 in the "iface" GET parameter in /ajax/networking/get\_netcfg.php, when the "iface" parameter value contains special characters such as ";" which enables an unauthenticated attacker to execute arbitrary OS commands. |
|  |  |
|  |  |
|  |  |
|  | CVE-2021-33358 |
|  | Vulnerable Product Version: RaspAP 2.3 to (and including) 2.6.5 |
|  | Vulnerability Type: OS Command Injection (CWE-78) |
|  | Description: Multiple vulnerabilities exist in RaspAP 2.3 to 2.6.5 in the "interface", "ssid" and "wpa\_passphrase" POST parameter in /hostapd, when the parameters values contain special characters such as ";" or "$()" which enables an authenticated attacker to execute arbitrary OS commands. |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fomriinbar%2F52c000c02a6992c6ce68d531195f69cf)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4cac4cdf_20250114_205833.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RaspAP%2Fraspap-webgui)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RaspAP](/RaspAP)
/
**[raspap-webgui](/RaspAP/raspap-webgui)**
Public

* [Notifications](/login?return_to=%2FRaspAP%2Fraspap-webgui) You must be signed in to change notification settings
* [Fork
  797](/login?return_to=%2FRaspAP%2Fraspap-webgui)
* [Star
   4.5k](/login?return_to=%2FRaspAP%2Fraspap-webgui)

* [Code](/RaspAP/raspap-webgui)
* [Issues
  22](/RaspAP/raspap-webgui/issues)
* [Pull requests
  9](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects
  1](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

Additional navigation options

* [Code](/RaspAP/raspap-webgui)
* [Issues](/RaspAP/raspap-webgui/issues)
* [Pull requests](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

## Files

 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/RaspAP/raspap-webgui/commits/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)executable file·682 lines (604 loc) · 28.8 KB 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Top
## File metadata and controls

* Code
* Blame

executable file·682 lines (604 loc) · 28.8 KB[Raw](https://github.com/RaspAP/raspap-webgui/raw/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681#!/bin/bash## RaspAP installation functions# Author: @billz <billzimmerman@gmail.com># Author URI: https://github.com/billz/# License: GNU General Public License v3.0# License URI: https://github.com/raspap/raspap-webgui/blob/master/LICENSE
# You are not obligated to bundle the LICENSE file with your RaspAP projects as long# as you leave these references intact in the header comments of your source files.
# Exit on errorset -o errexit# Exit on error inside functionsset -o errtrace# Turn on traces, disabled by default# set -o xtrace
# Set defaultsreadonly raspap\_dir="/etc/raspap"readonly raspap\_user="www-data"readonly raspap\_sudoers="/etc/sudoers.d/090\_raspap"readonly raspap\_default="/etc/dnsmasq.d/090\_raspap.conf"readonly raspap\_wlan0="/etc/dnsmasq.d/090\_wlan0.conf"readonly raspap\_adblock="/etc/dnsmasq.d/090\_adblock.conf"readonly raspap\_sysctl="/etc/sysctl.d/90\_raspap.conf"readonly raspap\_network="$raspap\_dir/networking/"readonly raspap\_router="/etc/lighttpd/conf-available/50-raspap-router.conf"readonly rulesv4="/etc/iptables/rules.v4"readonly notracking\_url="https://raw.githubusercontent.com/notracking/hosts-blocklists/master/"webroot\_dir="/var/www/html"
if [ "$insiders" == 1 ]; then repo="RaspAP/raspap-insiders" branch=${RASPAP\_INSIDERS\_LATEST}figit\_source\_url="https://github.com/$repo"
# NOTE: all the below functions are overloadable for system-specific installsfunction \_install\_raspap() { \_display\_welcome \_config\_installation \_update\_system\_packages \_install\_dependencies \_enable\_php\_lighttpd \_create\_raspap\_directories \_optimize\_php \_check\_for\_old\_configs \_download\_latest\_files \_change\_file\_ownership \_create\_hostapd\_scripts \_create\_lighttpd\_scripts \_install\_lighttpd\_configs \_move\_config\_file \_default\_configuration \_configure\_networking \_prompt\_install\_adblock \_prompt\_install\_openvpn \_install\_mobile\_clients \_prompt\_install\_wireguard \_patch\_system\_files \_install\_complete}
# search for optional installation files names install\_feature\_\*.shfunction \_install\_mobile\_clients() { if [ "$insiders" == 1 ]; then \_install\_log "Installing support for mobile data clients" for feature in $(ls $webroot\_dir/installers/install\_feature\_\*.sh) ; do source $feature f=$(basename $feature) func="\_${f%.\*}" if declare -f -F $func > /dev/null; then echo "Installing $func" $func || \_install\_status 1 "Unable to install feature ($func)" else \_install\_status 1 "Install file $f is missing install function $func" fi done fi}
# Prompts user to set installation optionsfunction \_config\_installation() { if [ "$upgrade" == 1 ]; then opt=(Upgrade Upgrading upgrade) else opt=(Install Installing installation) fi \_install\_log "Configure ${opt[2]}" \_get\_linux\_distro echo "Detected OS: ${DESC}" echo "Using GitHub repository: ${repo} ${branch} branch" echo "Configuration directory: ${raspap\_dir}" echo -n "lighttpd root: ${webroot\_dir}? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then read -e -p < /dev/tty "Enter alternate lighttpd directory: " -i "/var/www/html" webroot\_dir fi else echo -e fi echo "${opt[1]} lighttpd directory: ${webroot\_dir}" if [ "$upgrade" == 1 ]; then echo "This will upgrade your existing install to version ${RASPAP\_RELEASE}" echo "Your configuration will NOT be changed" fi echo -n "Complete ${opt[2]} with these values? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation aborted." exit 0 fi else echo -e fi}
# Determines host Linux distribution detailsfunction \_get\_linux\_distro() { if type lsb\_release >/dev/null 2>&1; then # linuxbase.org OS=$(lsb\_release -si) RELEASE=$(lsb\_release -sr) CODENAME=$(lsb\_release -sc) DESC=$(lsb\_release -sd) elif [ -f /etc/os-release ]; then # freedesktop.org . /etc/os-release OS=$ID RELEASE=$VERSION\_ID CODENAME=$VERSION\_CODENAME DESC=$PRETTY\_NAME else \_install\_status 1 "Unsupported Linux distribution" fi}
# Sets php package option based on Linux version, abort if unsupported distrofunction \_set\_php\_package() { case $RELEASE in 18.04|19.10) # Ubuntu Server php\_package="php7.4-cgi" phpcgiconf="/etc/php/7.4/cgi/php.ini" ;; 10\*) php\_package="php7.3-cgi" phpcgiconf="/etc/php/7.3/cgi/php.ini" ;; 9\*) php\_package="php7.0-cgi" phpcgiconf="/etc/php/7.0/cgi/php.ini" ;; 8) \_install\_status 1 "${DESC} and php5 are not supported. Please upgrade." ;; \*) \_install\_status 1 "${DESC} is unsupported. Please install on a supported distro." ;; esac}
# Runs a system software update to make sure we're using all fresh packagesfunction \_install\_dependencies() { \_install\_log "Installing required packages" \_set\_php\_package if [ "$php\_package" = "php7.4-cgi" ]; then echo "Adding apt-repository ppa:ondrej/php" sudo apt-get install $apt\_option software-properties-common || \_install\_status 1 "Unable to install dependency" sudo add-apt-repository $apt\_option ppa:ondrej/php || \_install\_status 1 "Unable to add-apt-repository ppa:ondrej/php" fi if [ ${OS,,} = "debian" ] || [ ${OS,,} = "ubuntu" ]; then dhcpcd\_package="dhcpcd5" fi # Set dconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v4 boolean true | sudo debconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v6 boolean true | sudo debconf-set-selections sudo apt-get install $apt\_option lighttpd git hostapd dnsmasq iptables-persistent $php\_package $dhcpcd\_package vnstat qrencode || \_install\_status 1 "Unable to install dependencies" \_install\_status 0}
# Enables PHP for lighttpd and restarts service for settings to take effectfunction \_enable\_php\_lighttpd() { \_install\_log "Enabling PHP for lighttpd" sudo lighttpd-enable-mod fastcgi-php  sudo service lighttpd force-reload sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd"}
# Verifies existence and permissions of RaspAP directoryfunction \_create\_raspap\_directories() { \_install\_log "Creating RaspAP directories" if [ -d "$raspap\_dir" ]; then sudo mv $raspap\_dir "$raspap\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to move old '$raspap\_dir' out of the way" fi sudo mkdir -p "$raspap\_dir" || \_install\_status 1 "Unable to create directory '$raspap\_dir'"
 # Create a directory for existing file backups. sudo mkdir -p "$raspap\_dir/backups"
 # Create a directory to store networking configs echo "Creating $raspap\_dir/networking" sudo mkdir -p "$raspap\_dir/networking" # Copy existing dhcpcd.conf to use as base config echo "Adding /etc/dhcpcd.conf as base configuration" cat /etc/dhcpcd.conf | sudo tee -a /etc/raspap/networking/defaults > /dev/null echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Generate hostapd logging and service control scriptsfunction \_create\_hostapd\_scripts() { \_install\_log "Creating hostapd logging & control scripts" sudo mkdir $raspap\_dir/hostapd || \_install\_status 1 "Unable to create directory '$raspap\_dir/hostapd'"
 # Move logging shell scripts  sudo cp "$webroot\_dir/installers/"\*log.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move logging scripts" # Move service control shell scripts sudo cp "$webroot\_dir/installers/"service\*.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move service control scripts" # Make enablelog.sh and disablelog.sh not writable by www-data group. sudo chown -c root:"$raspap\_user" "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Generate lighttpd service control scriptsfunction \_create\_lighttpd\_scripts() { \_install\_log "Creating lighttpd control scripts" sudo mkdir $raspap\_dir/lighttpd || \_install\_status 1 "Unable to create directory '$raspap\_dir/lighttpd"
 # Move service control shell scripts echo "Copying configport.sh to $raspap\_dir/lighttpd" sudo cp "$webroot\_dir/installers/"configport.sh "$raspap\_dir/lighttpd" || \_install\_status 1 "Unable to move service control scripts" # Make configport.sh writable by www-data group echo "Changing file ownership" sudo chown -c root:"$raspap\_user" "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Copy extra config files required to configure lighttpdfunction \_install\_lighttpd\_configs() { \_install\_log "Copying lighttpd extra config files"
 # Copy config files echo "Copying 50-raspap-router.conf to /etc/lighttpd/conf-available"
 CONFSRC="$webroot\_dir/config/50-raspap-router.conf" LTROOT=$(grep "server.document-root" /etc/lighttpd/lighttpd.conf | awk -F '=' '{print $2}' | tr -d " \"")
 # Compare values and get difference HTROOT=${webroot\_dir/$LTROOT}
 # Remove trailing slash if present HTROOT=$(echo "$HTROOT" | sed -e 's/\/$//')
 # Substitute values awk "{gsub(\"/REPLACE\_ME\",\"$HTROOT\")}1" $CONFSRC > /tmp/50-raspap-router.conf
 # Copy into place sudo cp /tmp/50-raspap-router.conf /etc/lighttpd/conf-available/ || \_install\_status 1 "Unable to copy lighttpd config file into place."
 # Link into conf-enabled echo "Creating link to /etc/lighttpd/conf-enabled" if ! [ -L $raspap\_router ]; then echo "Existing 50-raspap-router.conf found. Unlinking." sudo unlink "/etc/lighttpd/conf-enabled/50-raspap-router.conf" fi echo "Linking 50-raspap-router.conf to /etc/lighttpd/conf-enabled/" sudo ln -s "/etc/lighttpd/conf-available/50-raspap-router.conf" "/etc/lighttpd/conf-enabled/50-raspap-router.conf" || \_install\_status 1 "Unable to symlink lighttpd config file (this is normal if the link already exists)." sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd" \_install\_status 0}
# Prompt to install ad blockingfunction \_prompt\_install\_adblock() { \_install\_log "Configure ad blocking (Beta)" echo -n "Install ad blocking and enable list management? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_adblock fi elif [ "$adblock\_option" == 1 ]; then \_install\_adblock else echo "(Skipped)" fi}
# Download notracking adblock lists and enable optionfunction \_install\_adblock() { \_install\_log "Creating ad blocking base configuration (Beta)" if [ ! -d "$raspap\_dir/adblock" ]; then echo "Creating $raspap\_dir/adblock" sudo mkdir -p "$raspap\_dir/adblock" fi if [ ! -f /tmp/hostnames.txt ]; then echo "Fetching latest hostnames list" wget ${notracking\_url}hostnames.txt -q --show-progress --progress=bar:force -O /tmp/hostnames.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking hostnames" fi if [ ! -f /tmp/domains.txt ]; then echo "Fetching latest domains list" wget ${notracking\_url}domains.txt -q --show-progress --progress=bar:force -O /tmp/domains.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking domains" fi echo "Adding blocklists to $raspap\_dir/adblock" sudo cp /tmp/hostnames.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking hostnames" sudo cp /tmp/domains.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking domains"
 echo "Moving and setting permissions for blocklist update script" sudo cp "$webroot\_dir/installers/"update\_blocklist.sh "$raspap\_dir/adblock" || \_install\_status 1 "Unable to move blocklist update script"
 # Make blocklists and update script writable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/adblock/"\*.\* || \_install\_status 1 "Unable to change owner/group" sudo chmod 750 "$raspap\_dir/adblock/"\*.sh || install\_error "Unable to change file permissions"
 # Create 090\_adblock.conf and write values to /etc/dnsmasq.d if [ ! -f "$raspap\_adblock" ]; then echo "Adding 090\_addblock.conf to /etc/dnsmasq.d" sudo touch "$raspap\_adblock" echo "conf-file=$raspap\_dir/adblock/domains.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" echo "addn-hosts=$raspap\_dir/adblock/hostnames.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" fi
 # Remove dhcp-option=6 in dnsmasq.d/090\_wlan0.conf to force local DNS resolution for DHCP clients echo "Enabling local DNS name resolution for DHCP clients" sudo sed -i '/dhcp-option=6/d' $raspap\_wlan0 || \_install\_status 1 "Unable to modify $raspap\_dnsmasq"
 echo "Enabling ad blocking management option" sudo sed -i "s/\('RASPI\_ADBLOCK\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Prompt to install openvpnfunction \_prompt\_install\_openvpn() { \_install\_log "Configure OpenVPN support" echo -n "Install OpenVPN and enable client configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_openvpn fi elif [ "$ovpn\_option" == 1 ]; then \_install\_openvpn else echo "(Skipped)" fi}
# Prompt to install WireGuardfunction \_prompt\_install\_wireguard() { if [ "$insiders" == 1 ]; then \_install\_log "Configure WireGuard support" echo -n "Install WireGuard and enable VPN tunnel configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_wireguard fi elif [ "$wg\_option" == 1 ]; then \_install\_wireguard else echo "(Skipped)" fi fi}
# Install Wireguard from the Debian unstable distrofunction \_install\_wireguard() { \_install\_log "Configure WireGuard support" if [ "$OS" == "Debian" ]; then echo 'deb http://ftp.debian.org/debian buster-backports main' | sudo tee /etc/apt/sources.list.d/buster-backports.list || \_install\_status 1 "Unable to add Debian backports repo" fi echo "Installing wireguard from apt" sudo apt-get update && sudo apt-get install $apt\_option wireguard || \_install\_status 1 "Unable to install wireguard" echo "Enabling wg-quick@wg0" sudo systemctl enable wg-quick@wg0 || \_install\_status 1 "Failed to enable wg-quick service" echo "Enabling WireGuard management option" sudo sed -i "s/\('RASPI\_WIREGUARD\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Install openvpn and enable client configuration optionfunction \_install\_openvpn() { \_install\_log "Installing OpenVPN and enabling client configuration" echo "Adding packages via apt-get" sudo apt-get install -y openvpn || \_install\_status 1 "Unable to install openvpn" sudo sed -i "s/\('RASPI\_OPENVPN\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" echo "Enabling openvpn-client service on boot" sudo systemctl enable openvpn-client@client || \_install\_status 1 "Unable to enable openvpn-client daemon" \_create\_openvpn\_scripts || \_install\_status 1 "Unable to create openvpn control scripts"}
# Generate openvpn logging and auth control scriptsfunction \_create\_openvpn\_scripts() { \_install\_log "Creating OpenVPN control scripts" sudo mkdir $raspap\_dir/openvpn || \_install\_status 1 "Unable to create directory '$raspap\_dir/openvpn'"
 # Move service auth control & logging shell scripts sudo cp "$webroot\_dir/installers/"configauth.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move auth control script" sudo cp "$webroot\_dir/installers/"openvpnlog.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move logging script" # Make scripts executable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Fetches latest files from github to webrootfunction \_download\_latest\_files() { if [ ! -d "$webroot\_dir" ]; then sudo mkdir -p $webroot\_dir || \_install\_status 1 "Unable to create new webroot directory" fi
 if [ -d "$webroot\_dir" ]; then sudo mv $webroot\_dir "$webroot\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to remove old webroot directory" fi
 \_install\_log "Cloning latest files from github" git clone --branch $branch --depth 1 -c advice.detachedHead=false $git\_source\_url /tmp/raspap-webgui || \_install\_status 1 "Unable to download files from github"
 sudo mv /tmp/raspap-webgui $webroot\_dir || \_install\_status 1 "Unable to move raspap-webgui to web root" if [ "$upgrade" == 1 ]; then \_install\_log "Applying existing configuration to ${webroot\_dir}/includes" sudo mv /tmp/config.php $webroot\_dir/includes || \_install\_status 1 "Unable to move config.php to ${webroot\_dir}/includes" fi
 \_install\_status 0}
# Sets files ownership in web root directoryfunction \_change\_file\_ownership() { if [ ! -d "$webroot\_dir" ]; then \_install\_status 1 "Web root directory doesn't exist" fi
 \_install\_log "Changing file ownership in web root directory" sudo chown -R $raspap\_user:$raspap\_user "$webroot\_dir" || \_install\_status 1 "Unable to change file ownership for '$webroot\_dir'"}
# Check for existing configuration filesfunction \_check\_for\_old\_configs() { if [ "$upgrade" == 1 ]; then \_install\_log "Moving existing configuration to /tmp" sudo mv $webroot\_dir/includes/config.php /tmp || \_install\_status 1 "Unable to move config.php to /tmp" else \_install\_log "Backing up existing configs to ${raspap\_dir}/backups" if [ -f /etc/network/interfaces ]; then sudo cp /etc/network/interfaces "$raspap\_dir/backups/interfaces.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/interfaces.`date +%F-%R`" "$raspap\_dir/backups/interfaces" fi
 if [ -f /etc/hostapd/hostapd.conf ]; then sudo cp /etc/hostapd/hostapd.conf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" "$raspap\_dir/backups/hostapd.conf" fi
 if [ -f $raspap\_default ]; then sudo cp $raspap\_default "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_raspap.conf" fi
 if [ -f $raspap\_wlan0 ]; then sudo cp $raspap\_wlan0 "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_wlan0.conf" fi
 if [ -f /etc/dhcpcd.conf ]; then sudo cp /etc/dhcpcd.conf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" "$raspap\_dir/backups/dhcpcd.conf" fi
 for file in /etc/systemd/network/raspap-\*.net\*; do if [ -f "${file}" ]; then filename=$(basename $file) sudo cp "$file" "${raspap\_dir}/backups/${filename}.`date +%F-%R`" sudo ln -sf "${raspap\_dir}/backups/${filename}.`date +%F-%R`" "${raspap\_dir}/backups/${filename}" fi done fi \_install\_status 0}
# Move configuration file to the correct locationfunction \_move\_config\_file() { if [ ! -d "$raspap\_dir" ]; then \_install\_status 1 "'$raspap\_dir' directory doesn't exist" fi
 \_install\_log "Moving configuration file to $raspap\_dir" sudo cp "$webroot\_dir"/raspap.php "$raspap\_dir" || \_install\_status 1 "Unable to move files to '$raspap\_dir'" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Set up default configurationfunction \_default\_configuration() { if [ "$upgrade" == 0 ]; then \_install\_log "Applying default configuration to installed services"
 sudo cp $webroot\_dir/config/hostapd.conf /etc/hostapd/hostapd.conf || \_install\_status 1 "Unable to move hostapd configuration file" sudo cp $webroot\_dir/config/090\_raspap.conf $raspap\_default || \_install\_status 1 "Unable to move dnsmasq default configuration file" sudo cp $webroot\_dir/config/090\_wlan0.conf $raspap\_wlan0 || \_install\_status 1 "Unable to move dnsmasq wlan0 configuration file" sudo cp $webroot\_dir/config/dhcpcd.conf /etc/dhcpcd.conf || \_install\_status 1 "Unable to move dhcpcd configuration file" sudo cp $webroot\_dir/config/defaults.json $raspap\_network || \_install\_status 1 "Unable to move defaults.json settings"
 echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"
 echo "Checking for existence of /etc/dnsmasq.d" [ -d /etc/dnsmasq.d ] || sudo mkdir /etc/dnsmasq.d
 echo "Copying bridged AP config to /etc/systemd/network" sudo systemctl stop systemd-networkd sudo systemctl disable systemd-networkd sudo cp $webroot\_dir/config/raspap-bridge-br0.netdev /etc/systemd/network/raspap-bridge-br0.netdev || \_install\_status 1 "Unable to move br0 netdev file" sudo cp $webroot\_dir/config/raspap-br0-member-eth0.network /etc/systemd/network/raspap-br0-member-eth0.network || \_install\_status 1 "Unable to move br0 member file"
 echo "Copying primary RaspAP config to includes/config.php" if [ ! -f "$webroot\_dir/includes/config.php" ]; then sudo cp "$webroot\_dir/config/config.php" "$webroot\_dir/includes/config.php" fi \_install\_status 0 fi}
# Install and enable RaspAP daemonfunction \_enable\_raspap\_daemon() { \_install\_log "Enabling RaspAP daemon" echo "Disable with: sudo systemctl disable raspapd.service" sudo cp $webroot\_dir/installers/raspapd.service /lib/systemd/system/ || \_install\_status 1 "Unable to move raspap.service file" sudo systemctl daemon-reload sudo systemctl enable raspapd.service || \_install\_status 1 "Failed to enable raspap.service"}
# Configure IP forwarding, set IP tables rules, prompt to install RaspAP daemonfunction \_configure\_networking() { \_install\_log "Configuring networking" echo "Enabling IP forwarding" echo "net.ipv4.ip\_forward=1" | sudo tee $raspap\_sysctl > /dev/null || \_install\_status 1 "Unable to set IP forwarding" sudo sysctl -p $raspap\_sysctl || \_install\_status 1 "Unable to execute sysctl" sudo /etc/init.d/procps restart || \_install\_status 1 "Unable to execute procps"
 echo "Checking iptables rules" rules=( "-A POSTROUTING -j MASQUERADE" "-A POSTROUTING -s 192.168.50.0/24 ! -d 192.168.50.0/24 -j MASQUERADE" ) for rule in "${rules[@]}"; do if grep -- "$rule" $rulesv4 > /dev/null; then echo "Rule already exits: ${rule}" else rule=$(sed -e 's/^\(-A POSTROUTING\)/-t nat \1/' <<< $rule) echo "Adding rule: ${rule}" sudo iptables $rule || \_install\_status 1 "Unable to execute iptables" added=true fi done # Persist rules if added if [ "$added" = true ]; then echo "Persisting IP tables rules" sudo iptables-save | sudo tee $rulesv4 > /dev/null || \_install\_status 1 "Unable to execute iptables-save" fi
 # Prompt to install RaspAP daemon echo -n "Enable RaspAP control service (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_enable\_raspap\_daemon fi else echo -e \_enable\_raspap\_daemon fi \_install\_status 0 }
# Add sudoers file to /etc/sudoers.d/ and set file permissionsfunction \_patch\_system\_files() {
 # Create sudoers if not present if [ ! -f $raspap\_sudoers ]; then \_install\_log "Adding raspap.sudoers to ${raspap\_sudoers}" sudo cp "$webroot\_dir/installers/raspap.sudoers" $raspap\_sudoers || \_install\_status 1 "Unable to apply raspap.sudoers to $raspap\_sudoers" sudo chmod 0440 $raspap\_sudoers || \_install\_status 1 "Unable to change file permissions for $raspap\_sudoers" fi
 # Add symlink to prevent wpa\_cli cmds from breaking with multiple wlan interfaces \_install\_log "Symlinked wpa\_supplicant hooks for multiple wlan interfaces" if [ ! -f /usr/share/dhcpcd/hooks/10-wpa\_supplicant ]; then sudo ln -s /usr/share/dhcpcd/hooks/10-wpa\_supplicant /etc/dhcp/dhclient-enter-hooks.d/ fi
 # Unmask and enable hostapd.service \_install\_log "Unmasking and enabling hostapd service" sudo systemctl unmask hostapd.service sudo systemctl enable hostapd.service \_install\_status 0}
# Optimize configuration of php-cgi.function \_optimize\_php() { if [ "$upgrade" == 0 ]; then \_install\_log "Optimize PHP configuration" if [ ! -f "$phpcgiconf" ]; then \_install\_warning "PHP configuration could not be found." return fi
 # Backup php.ini and create symlink for restoring. datetimephpconf=$(date +%F-%R) sudo cp "$phpcgiconf" "$raspap\_dir/backups/php.ini.$datetimephpconf" sudo ln -sf "$raspap\_dir/backups/php.ini.$datetimephpconf" "$raspap\_dir/backups/php.ini"
 echo -n "Enable HttpOnly for session cookies (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_session\_cookie=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$php\_session\_cookie" == 1 ]; then echo "Php-cgi enabling session.cookie\_httponly." sudo sed -i -E 's/^session\.cookie\_httponly\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/session.cookie\_httponly = 1/' "$phpcgiconf" fi
 if [ "$php\_package" = "php7.1-cgi" ]; then echo -n "Enable PHP OPCache (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_opcache=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$phpopcache" == 1 ]; then echo -e "Php-cgi enabling opcache.enable." sudo sed -i -E 's/^;?opcache\.enable\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/opcache.enable = 1/' "$phpcgiconf" # Make sure opcache extension is turned on. if [ -f "/usr/sbin/phpenmod" ]; then sudo phpenmod opcache else \_install\_status 2 "phpenmod not found." fi fi fi fi}
function \_install\_complete() { \_install\_log "Installation completed" echo "Join RaspAP Insiders for early access to exclusive features!" echo -e "${ANSI\_RASPBERRY}" echo "> https://docs.raspap.com/insiders/" echo "> https://github.com/sponsors/RaspAP/" echo -e "${ANSI\_RESET}" if [ "$assume\_yes" == 0 ]; then # Prompt to reboot if wired ethernet (eth0) is connected. # With default\_configuration this will create an active AP on restart. if ip a | grep -q ': eth0:.\*state UP'; then echo -n "The system needs to be rebooted as a final step. Reboot now? [y/N]: " read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation reboot aborted." exit 0 fi sudo shutdown -r now || \_install\_status 1 "Unable to execute shutdown" fi fi}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3ca1e688_20250114_205829.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RaspAP%2Fraspap-webgui)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RaspAP](/RaspAP)
/
**[raspap-webgui](/RaspAP/raspap-webgui)**
Public

* [Notifications](/login?return_to=%2FRaspAP%2Fraspap-webgui) You must be signed in to change notification settings
* [Fork
  797](/login?return_to=%2FRaspAP%2Fraspap-webgui)
* [Star
   4.5k](/login?return_to=%2FRaspAP%2Fraspap-webgui)

* [Code](/RaspAP/raspap-webgui)
* [Issues
  22](/RaspAP/raspap-webgui/issues)
* [Pull requests
  9](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects
  1](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

Additional navigation options

* [Code](/RaspAP/raspap-webgui)
* [Issues](/RaspAP/raspap-webgui/issues)
* [Pull requests](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

## Files

 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/RaspAP/raspap-webgui/commits/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)executable file·682 lines (604 loc) · 28.8 KB 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Top
## File metadata and controls

* Code
* Blame

executable file·682 lines (604 loc) · 28.8 KB[Raw](https://github.com/RaspAP/raspap-webgui/raw/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681#!/bin/bash## RaspAP installation functions# Author: @billz <billzimmerman@gmail.com># Author URI: https://github.com/billz/# License: GNU General Public License v3.0# License URI: https://github.com/raspap/raspap-webgui/blob/master/LICENSE
# You are not obligated to bundle the LICENSE file with your RaspAP projects as long# as you leave these references intact in the header comments of your source files.
# Exit on errorset -o errexit# Exit on error inside functionsset -o errtrace# Turn on traces, disabled by default# set -o xtrace
# Set defaultsreadonly raspap\_dir="/etc/raspap"readonly raspap\_user="www-data"readonly raspap\_sudoers="/etc/sudoers.d/090\_raspap"readonly raspap\_default="/etc/dnsmasq.d/090\_raspap.conf"readonly raspap\_wlan0="/etc/dnsmasq.d/090\_wlan0.conf"readonly raspap\_adblock="/etc/dnsmasq.d/090\_adblock.conf"readonly raspap\_sysctl="/etc/sysctl.d/90\_raspap.conf"readonly raspap\_network="$raspap\_dir/networking/"readonly raspap\_router="/etc/lighttpd/conf-available/50-raspap-router.conf"readonly rulesv4="/etc/iptables/rules.v4"readonly notracking\_url="https://raw.githubusercontent.com/notracking/hosts-blocklists/master/"webroot\_dir="/var/www/html"
if [ "$insiders" == 1 ]; then repo="RaspAP/raspap-insiders" branch=${RASPAP\_INSIDERS\_LATEST}figit\_source\_url="https://github.com/$repo"
# NOTE: all the below functions are overloadable for system-specific installsfunction \_install\_raspap() { \_display\_welcome \_config\_installation \_update\_system\_packages \_install\_dependencies \_enable\_php\_lighttpd \_create\_raspap\_directories \_optimize\_php \_check\_for\_old\_configs \_download\_latest\_files \_change\_file\_ownership \_create\_hostapd\_scripts \_create\_lighttpd\_scripts \_install\_lighttpd\_configs \_move\_config\_file \_default\_configuration \_configure\_networking \_prompt\_install\_adblock \_prompt\_install\_openvpn \_install\_mobile\_clients \_prompt\_install\_wireguard \_patch\_system\_files \_install\_complete}
# search for optional installation files names install\_feature\_\*.shfunction \_install\_mobile\_clients() { if [ "$insiders" == 1 ]; then \_install\_log "Installing support for mobile data clients" for feature in $(ls $webroot\_dir/installers/install\_feature\_\*.sh) ; do source $feature f=$(basename $feature) func="\_${f%.\*}" if declare -f -F $func > /dev/null; then echo "Installing $func" $func || \_install\_status 1 "Unable to install feature ($func)" else \_install\_status 1 "Install file $f is missing install function $func" fi done fi}
# Prompts user to set installation optionsfunction \_config\_installation() { if [ "$upgrade" == 1 ]; then opt=(Upgrade Upgrading upgrade) else opt=(Install Installing installation) fi \_install\_log "Configure ${opt[2]}" \_get\_linux\_distro echo "Detected OS: ${DESC}" echo "Using GitHub repository: ${repo} ${branch} branch" echo "Configuration directory: ${raspap\_dir}" echo -n "lighttpd root: ${webroot\_dir}? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then read -e -p < /dev/tty "Enter alternate lighttpd directory: " -i "/var/www/html" webroot\_dir fi else echo -e fi echo "${opt[1]} lighttpd directory: ${webroot\_dir}" if [ "$upgrade" == 1 ]; then echo "This will upgrade your existing install to version ${RASPAP\_RELEASE}" echo "Your configuration will NOT be changed" fi echo -n "Complete ${opt[2]} with these values? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation aborted." exit 0 fi else echo -e fi}
# Determines host Linux distribution detailsfunction \_get\_linux\_distro() { if type lsb\_release >/dev/null 2>&1; then # linuxbase.org OS=$(lsb\_release -si) RELEASE=$(lsb\_release -sr) CODENAME=$(lsb\_release -sc) DESC=$(lsb\_release -sd) elif [ -f /etc/os-release ]; then # freedesktop.org . /etc/os-release OS=$ID RELEASE=$VERSION\_ID CODENAME=$VERSION\_CODENAME DESC=$PRETTY\_NAME else \_install\_status 1 "Unsupported Linux distribution" fi}
# Sets php package option based on Linux version, abort if unsupported distrofunction \_set\_php\_package() { case $RELEASE in 18.04|19.10) # Ubuntu Server php\_package="php7.4-cgi" phpcgiconf="/etc/php/7.4/cgi/php.ini" ;; 10\*) php\_package="php7.3-cgi" phpcgiconf="/etc/php/7.3/cgi/php.ini" ;; 9\*) php\_package="php7.0-cgi" phpcgiconf="/etc/php/7.0/cgi/php.ini" ;; 8) \_install\_status 1 "${DESC} and php5 are not supported. Please upgrade." ;; \*) \_install\_status 1 "${DESC} is unsupported. Please install on a supported distro." ;; esac}
# Runs a system software update to make sure we're using all fresh packagesfunction \_install\_dependencies() { \_install\_log "Installing required packages" \_set\_php\_package if [ "$php\_package" = "php7.4-cgi" ]; then echo "Adding apt-repository ppa:ondrej/php" sudo apt-get install $apt\_option software-properties-common || \_install\_status 1 "Unable to install dependency" sudo add-apt-repository $apt\_option ppa:ondrej/php || \_install\_status 1 "Unable to add-apt-repository ppa:ondrej/php" fi if [ ${OS,,} = "debian" ] || [ ${OS,,} = "ubuntu" ]; then dhcpcd\_package="dhcpcd5" fi # Set dconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v4 boolean true | sudo debconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v6 boolean true | sudo debconf-set-selections sudo apt-get install $apt\_option lighttpd git hostapd dnsmasq iptables-persistent $php\_package $dhcpcd\_package vnstat qrencode || \_install\_status 1 "Unable to install dependencies" \_install\_status 0}
# Enables PHP for lighttpd and restarts service for settings to take effectfunction \_enable\_php\_lighttpd() { \_install\_log "Enabling PHP for lighttpd" sudo lighttpd-enable-mod fastcgi-php  sudo service lighttpd force-reload sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd"}
# Verifies existence and permissions of RaspAP directoryfunction \_create\_raspap\_directories() { \_install\_log "Creating RaspAP directories" if [ -d "$raspap\_dir" ]; then sudo mv $raspap\_dir "$raspap\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to move old '$raspap\_dir' out of the way" fi sudo mkdir -p "$raspap\_dir" || \_install\_status 1 "Unable to create directory '$raspap\_dir'"
 # Create a directory for existing file backups. sudo mkdir -p "$raspap\_dir/backups"
 # Create a directory to store networking configs echo "Creating $raspap\_dir/networking" sudo mkdir -p "$raspap\_dir/networking" # Copy existing dhcpcd.conf to use as base config echo "Adding /etc/dhcpcd.conf as base configuration" cat /etc/dhcpcd.conf | sudo tee -a /etc/raspap/networking/defaults > /dev/null echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Generate hostapd logging and service control scriptsfunction \_create\_hostapd\_scripts() { \_install\_log "Creating hostapd logging & control scripts" sudo mkdir $raspap\_dir/hostapd || \_install\_status 1 "Unable to create directory '$raspap\_dir/hostapd'"
 # Move logging shell scripts  sudo cp "$webroot\_dir/installers/"\*log.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move logging scripts" # Move service control shell scripts sudo cp "$webroot\_dir/installers/"service\*.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move service control scripts" # Make enablelog.sh and disablelog.sh not writable by www-data group. sudo chown -c root:"$raspap\_user" "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Generate lighttpd service control scriptsfunction \_create\_lighttpd\_scripts() { \_install\_log "Creating lighttpd control scripts" sudo mkdir $raspap\_dir/lighttpd || \_install\_status 1 "Unable to create directory '$raspap\_dir/lighttpd"
 # Move service control shell scripts echo "Copying configport.sh to $raspap\_dir/lighttpd" sudo cp "$webroot\_dir/installers/"configport.sh "$raspap\_dir/lighttpd" || \_install\_status 1 "Unable to move service control scripts" # Make configport.sh writable by www-data group echo "Changing file ownership" sudo chown -c root:"$raspap\_user" "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Copy extra config files required to configure lighttpdfunction \_install\_lighttpd\_configs() { \_install\_log "Copying lighttpd extra config files"
 # Copy config files echo "Copying 50-raspap-router.conf to /etc/lighttpd/conf-available"
 CONFSRC="$webroot\_dir/config/50-raspap-router.conf" LTROOT=$(grep "server.document-root" /etc/lighttpd/lighttpd.conf | awk -F '=' '{print $2}' | tr -d " \"")
 # Compare values and get difference HTROOT=${webroot\_dir/$LTROOT}
 # Remove trailing slash if present HTROOT=$(echo "$HTROOT" | sed -e 's/\/$//')
 # Substitute values awk "{gsub(\"/REPLACE\_ME\",\"$HTROOT\")}1" $CONFSRC > /tmp/50-raspap-router.conf
 # Copy into place sudo cp /tmp/50-raspap-router.conf /etc/lighttpd/conf-available/ || \_install\_status 1 "Unable to copy lighttpd config file into place."
 # Link into conf-enabled echo "Creating link to /etc/lighttpd/conf-enabled" if ! [ -L $raspap\_router ]; then echo "Existing 50-raspap-router.conf found. Unlinking." sudo unlink "/etc/lighttpd/conf-enabled/50-raspap-router.conf" fi echo "Linking 50-raspap-router.conf to /etc/lighttpd/conf-enabled/" sudo ln -s "/etc/lighttpd/conf-available/50-raspap-router.conf" "/etc/lighttpd/conf-enabled/50-raspap-router.conf" || \_install\_status 1 "Unable to symlink lighttpd config file (this is normal if the link already exists)." sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd" \_install\_status 0}
# Prompt to install ad blockingfunction \_prompt\_install\_adblock() { \_install\_log "Configure ad blocking (Beta)" echo -n "Install ad blocking and enable list management? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_adblock fi elif [ "$adblock\_option" == 1 ]; then \_install\_adblock else echo "(Skipped)" fi}
# Download notracking adblock lists and enable optionfunction \_install\_adblock() { \_install\_log "Creating ad blocking base configuration (Beta)" if [ ! -d "$raspap\_dir/adblock" ]; then echo "Creating $raspap\_dir/adblock" sudo mkdir -p "$raspap\_dir/adblock" fi if [ ! -f /tmp/hostnames.txt ]; then echo "Fetching latest hostnames list" wget ${notracking\_url}hostnames.txt -q --show-progress --progress=bar:force -O /tmp/hostnames.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking hostnames" fi if [ ! -f /tmp/domains.txt ]; then echo "Fetching latest domains list" wget ${notracking\_url}domains.txt -q --show-progress --progress=bar:force -O /tmp/domains.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking domains" fi echo "Adding blocklists to $raspap\_dir/adblock" sudo cp /tmp/hostnames.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking hostnames" sudo cp /tmp/domains.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking domains"
 echo "Moving and setting permissions for blocklist update script" sudo cp "$webroot\_dir/installers/"update\_blocklist.sh "$raspap\_dir/adblock" || \_install\_status 1 "Unable to move blocklist update script"
 # Make blocklists and update script writable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/adblock/"\*.\* || \_install\_status 1 "Unable to change owner/group" sudo chmod 750 "$raspap\_dir/adblock/"\*.sh || install\_error "Unable to change file permissions"
 # Create 090\_adblock.conf and write values to /etc/dnsmasq.d if [ ! -f "$raspap\_adblock" ]; then echo "Adding 090\_addblock.conf to /etc/dnsmasq.d" sudo touch "$raspap\_adblock" echo "conf-file=$raspap\_dir/adblock/domains.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" echo "addn-hosts=$raspap\_dir/adblock/hostnames.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" fi
 # Remove dhcp-option=6 in dnsmasq.d/090\_wlan0.conf to force local DNS resolution for DHCP clients echo "Enabling local DNS name resolution for DHCP clients" sudo sed -i '/dhcp-option=6/d' $raspap\_wlan0 || \_install\_status 1 "Unable to modify $raspap\_dnsmasq"
 echo "Enabling ad blocking management option" sudo sed -i "s/\('RASPI\_ADBLOCK\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Prompt to install openvpnfunction \_prompt\_install\_openvpn() { \_install\_log "Configure OpenVPN support" echo -n "Install OpenVPN and enable client configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_openvpn fi elif [ "$ovpn\_option" == 1 ]; then \_install\_openvpn else echo "(Skipped)" fi}
# Prompt to install WireGuardfunction \_prompt\_install\_wireguard() { if [ "$insiders" == 1 ]; then \_install\_log "Configure WireGuard support" echo -n "Install WireGuard and enable VPN tunnel configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_wireguard fi elif [ "$wg\_option" == 1 ]; then \_install\_wireguard else echo "(Skipped)" fi fi}
# Install Wireguard from the Debian unstable distrofunction \_install\_wireguard() { \_install\_log "Configure WireGuard support" if [ "$OS" == "Debian" ]; then echo 'deb http://ftp.debian.org/debian buster-backports main' | sudo tee /etc/apt/sources.list.d/buster-backports.list || \_install\_status 1 "Unable to add Debian backports repo" fi echo "Installing wireguard from apt" sudo apt-get update && sudo apt-get install $apt\_option wireguard || \_install\_status 1 "Unable to install wireguard" echo "Enabling wg-quick@wg0" sudo systemctl enable wg-quick@wg0 || \_install\_status 1 "Failed to enable wg-quick service" echo "Enabling WireGuard management option" sudo sed -i "s/\('RASPI\_WIREGUARD\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Install openvpn and enable client configuration optionfunction \_install\_openvpn() { \_install\_log "Installing OpenVPN and enabling client configuration" echo "Adding packages via apt-get" sudo apt-get install -y openvpn || \_install\_status 1 "Unable to install openvpn" sudo sed -i "s/\('RASPI\_OPENVPN\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" echo "Enabling openvpn-client service on boot" sudo systemctl enable openvpn-client@client || \_install\_status 1 "Unable to enable openvpn-client daemon" \_create\_openvpn\_scripts || \_install\_status 1 "Unable to create openvpn control scripts"}
# Generate openvpn logging and auth control scriptsfunction \_create\_openvpn\_scripts() { \_install\_log "Creating OpenVPN control scripts" sudo mkdir $raspap\_dir/openvpn || \_install\_status 1 "Unable to create directory '$raspap\_dir/openvpn'"
 # Move service auth control & logging shell scripts sudo cp "$webroot\_dir/installers/"configauth.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move auth control script" sudo cp "$webroot\_dir/installers/"openvpnlog.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move logging script" # Make scripts executable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Fetches latest files from github to webrootfunction \_download\_latest\_files() { if [ ! -d "$webroot\_dir" ]; then sudo mkdir -p $webroot\_dir || \_install\_status 1 "Unable to create new webroot directory" fi
 if [ -d "$webroot\_dir" ]; then sudo mv $webroot\_dir "$webroot\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to remove old webroot directory" fi
 \_install\_log "Cloning latest files from github" git clone --branch $branch --depth 1 -c advice.detachedHead=false $git\_source\_url /tmp/raspap-webgui || \_install\_status 1 "Unable to download files from github"
 sudo mv /tmp/raspap-webgui $webroot\_dir || \_install\_status 1 "Unable to move raspap-webgui to web root" if [ "$upgrade" == 1 ]; then \_install\_log "Applying existing configuration to ${webroot\_dir}/includes" sudo mv /tmp/config.php $webroot\_dir/includes || \_install\_status 1 "Unable to move config.php to ${webroot\_dir}/includes" fi
 \_install\_status 0}
# Sets files ownership in web root directoryfunction \_change\_file\_ownership() { if [ ! -d "$webroot\_dir" ]; then \_install\_status 1 "Web root directory doesn't exist" fi
 \_install\_log "Changing file ownership in web root directory" sudo chown -R $raspap\_user:$raspap\_user "$webroot\_dir" || \_install\_status 1 "Unable to change file ownership for '$webroot\_dir'"}
# Check for existing configuration filesfunction \_check\_for\_old\_configs() { if [ "$upgrade" == 1 ]; then \_install\_log "Moving existing configuration to /tmp" sudo mv $webroot\_dir/includes/config.php /tmp || \_install\_status 1 "Unable to move config.php to /tmp" else \_install\_log "Backing up existing configs to ${raspap\_dir}/backups" if [ -f /etc/network/interfaces ]; then sudo cp /etc/network/interfaces "$raspap\_dir/backups/interfaces.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/interfaces.`date +%F-%R`" "$raspap\_dir/backups/interfaces" fi
 if [ -f /etc/hostapd/hostapd.conf ]; then sudo cp /etc/hostapd/hostapd.conf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" "$raspap\_dir/backups/hostapd.conf" fi
 if [ -f $raspap\_default ]; then sudo cp $raspap\_default "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_raspap.conf" fi
 if [ -f $raspap\_wlan0 ]; then sudo cp $raspap\_wlan0 "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_wlan0.conf" fi
 if [ -f /etc/dhcpcd.conf ]; then sudo cp /etc/dhcpcd.conf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" "$raspap\_dir/backups/dhcpcd.conf" fi
 for file in /etc/systemd/network/raspap-\*.net\*; do if [ -f "${file}" ]; then filename=$(basename $file) sudo cp "$file" "${raspap\_dir}/backups/${filename}.`date +%F-%R`" sudo ln -sf "${raspap\_dir}/backups/${filename}.`date +%F-%R`" "${raspap\_dir}/backups/${filename}" fi done fi \_install\_status 0}
# Move configuration file to the correct locationfunction \_move\_config\_file() { if [ ! -d "$raspap\_dir" ]; then \_install\_status 1 "'$raspap\_dir' directory doesn't exist" fi
 \_install\_log "Moving configuration file to $raspap\_dir" sudo cp "$webroot\_dir"/raspap.php "$raspap\_dir" || \_install\_status 1 "Unable to move files to '$raspap\_dir'" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Set up default configurationfunction \_default\_configuration() { if [ "$upgrade" == 0 ]; then \_install\_log "Applying default configuration to installed services"
 sudo cp $webroot\_dir/config/hostapd.conf /etc/hostapd/hostapd.conf || \_install\_status 1 "Unable to move hostapd configuration file" sudo cp $webroot\_dir/config/090\_raspap.conf $raspap\_default || \_install\_status 1 "Unable to move dnsmasq default configuration file" sudo cp $webroot\_dir/config/090\_wlan0.conf $raspap\_wlan0 || \_install\_status 1 "Unable to move dnsmasq wlan0 configuration file" sudo cp $webroot\_dir/config/dhcpcd.conf /etc/dhcpcd.conf || \_install\_status 1 "Unable to move dhcpcd configuration file" sudo cp $webroot\_dir/config/defaults.json $raspap\_network || \_install\_status 1 "Unable to move defaults.json settings"
 echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"
 echo "Checking for existence of /etc/dnsmasq.d" [ -d /etc/dnsmasq.d ] || sudo mkdir /etc/dnsmasq.d
 echo "Copying bridged AP config to /etc/systemd/network" sudo systemctl stop systemd-networkd sudo systemctl disable systemd-networkd sudo cp $webroot\_dir/config/raspap-bridge-br0.netdev /etc/systemd/network/raspap-bridge-br0.netdev || \_install\_status 1 "Unable to move br0 netdev file" sudo cp $webroot\_dir/config/raspap-br0-member-eth0.network /etc/systemd/network/raspap-br0-member-eth0.network || \_install\_status 1 "Unable to move br0 member file"
 echo "Copying primary RaspAP config to includes/config.php" if [ ! -f "$webroot\_dir/includes/config.php" ]; then sudo cp "$webroot\_dir/config/config.php" "$webroot\_dir/includes/config.php" fi \_install\_status 0 fi}
# Install and enable RaspAP daemonfunction \_enable\_raspap\_daemon() { \_install\_log "Enabling RaspAP daemon" echo "Disable with: sudo systemctl disable raspapd.service" sudo cp $webroot\_dir/installers/raspapd.service /lib/systemd/system/ || \_install\_status 1 "Unable to move raspap.service file" sudo systemctl daemon-reload sudo systemctl enable raspapd.service || \_install\_status 1 "Failed to enable raspap.service"}
# Configure IP forwarding, set IP tables rules, prompt to install RaspAP daemonfunction \_configure\_networking() { \_install\_log "Configuring networking" echo "Enabling IP forwarding" echo "net.ipv4.ip\_forward=1" | sudo tee $raspap\_sysctl > /dev/null || \_install\_status 1 "Unable to set IP forwarding" sudo sysctl -p $raspap\_sysctl || \_install\_status 1 "Unable to execute sysctl" sudo /etc/init.d/procps restart || \_install\_status 1 "Unable to execute procps"
 echo "Checking iptables rules" rules=( "-A POSTROUTING -j MASQUERADE" "-A POSTROUTING -s 192.168.50.0/24 ! -d 192.168.50.0/24 -j MASQUERADE" ) for rule in "${rules[@]}"; do if grep -- "$rule" $rulesv4 > /dev/null; then echo "Rule already exits: ${rule}" else rule=$(sed -e 's/^\(-A POSTROUTING\)/-t nat \1/' <<< $rule) echo "Adding rule: ${rule}" sudo iptables $rule || \_install\_status 1 "Unable to execute iptables" added=true fi done # Persist rules if added if [ "$added" = true ]; then echo "Persisting IP tables rules" sudo iptables-save | sudo tee $rulesv4 > /dev/null || \_install\_status 1 "Unable to execute iptables-save" fi
 # Prompt to install RaspAP daemon echo -n "Enable RaspAP control service (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_enable\_raspap\_daemon fi else echo -e \_enable\_raspap\_daemon fi \_install\_status 0 }
# Add sudoers file to /etc/sudoers.d/ and set file permissionsfunction \_patch\_system\_files() {
 # Create sudoers if not present if [ ! -f $raspap\_sudoers ]; then \_install\_log "Adding raspap.sudoers to ${raspap\_sudoers}" sudo cp "$webroot\_dir/installers/raspap.sudoers" $raspap\_sudoers || \_install\_status 1 "Unable to apply raspap.sudoers to $raspap\_sudoers" sudo chmod 0440 $raspap\_sudoers || \_install\_status 1 "Unable to change file permissions for $raspap\_sudoers" fi
 # Add symlink to prevent wpa\_cli cmds from breaking with multiple wlan interfaces \_install\_log "Symlinked wpa\_supplicant hooks for multiple wlan interfaces" if [ ! -f /usr/share/dhcpcd/hooks/10-wpa\_supplicant ]; then sudo ln -s /usr/share/dhcpcd/hooks/10-wpa\_supplicant /etc/dhcp/dhclient-enter-hooks.d/ fi
 # Unmask and enable hostapd.service \_install\_log "Unmasking and enabling hostapd service" sudo systemctl unmask hostapd.service sudo systemctl enable hostapd.service \_install\_status 0}
# Optimize configuration of php-cgi.function \_optimize\_php() { if [ "$upgrade" == 0 ]; then \_install\_log "Optimize PHP configuration" if [ ! -f "$phpcgiconf" ]; then \_install\_warning "PHP configuration could not be found." return fi
 # Backup php.ini and create symlink for restoring. datetimephpconf=$(date +%F-%R) sudo cp "$phpcgiconf" "$raspap\_dir/backups/php.ini.$datetimephpconf" sudo ln -sf "$raspap\_dir/backups/php.ini.$datetimephpconf" "$raspap\_dir/backups/php.ini"
 echo -n "Enable HttpOnly for session cookies (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_session\_cookie=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$php\_session\_cookie" == 1 ]; then echo "Php-cgi enabling session.cookie\_httponly." sudo sed -i -E 's/^session\.cookie\_httponly\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/session.cookie\_httponly = 1/' "$phpcgiconf" fi
 if [ "$php\_package" = "php7.1-cgi" ]; then echo -n "Enable PHP OPCache (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_opcache=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$phpopcache" == 1 ]; then echo -e "Php-cgi enabling opcache.enable." sudo sed -i -E 's/^;?opcache\.enable\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/opcache.enable = 1/' "$phpcgiconf" # Make sure opcache extension is turned on. if [ -f "/usr/sbin/phpenmod" ]; then sudo phpenmod opcache else \_install\_status 2 "phpenmod not found." fi fi fi fi}
function \_install\_complete() { \_install\_log "Installation completed" echo "Join RaspAP Insiders for early access to exclusive features!" echo -e "${ANSI\_RASPBERRY}" echo "> https://docs.raspap.com/insiders/" echo "> https://github.com/sponsors/RaspAP/" echo -e "${ANSI\_RESET}" if [ "$assume\_yes" == 0 ]; then # Prompt to reboot if wired ethernet (eth0) is connected. # With default\_configuration this will create an active AP on restart. if ip a | grep -q ': eth0:.\*state UP'; then echo -n "The system needs to be rebooted as a final step. Reboot now? [y/N]: " read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation reboot aborted." exit 0 fi sudo shutdown -r now || \_install\_status 1 "Unable to execute shutdown" fi fi}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_01ce8aaf_20250114_205846.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RaspAP%2Fraspap-webgui)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RaspAP](/RaspAP)
/
**[raspap-webgui](/RaspAP/raspap-webgui)**
Public

* [Notifications](/login?return_to=%2FRaspAP%2Fraspap-webgui) You must be signed in to change notification settings
* [Fork
  797](/login?return_to=%2FRaspAP%2Fraspap-webgui)
* [Star
   4.5k](/login?return_to=%2FRaspAP%2Fraspap-webgui)

* [Code](/RaspAP/raspap-webgui)
* [Issues
  22](/RaspAP/raspap-webgui/issues)
* [Pull requests
  9](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects
  1](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

Additional navigation options

* [Code](/RaspAP/raspap-webgui)
* [Issues](/RaspAP/raspap-webgui/issues)
* [Pull requests](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

## Files

 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/RaspAP/raspap-webgui/commits/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)executable file·682 lines (604 loc) · 28.8 KB 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Top
## File metadata and controls

* Code
* Blame

executable file·682 lines (604 loc) · 28.8 KB[Raw](https://github.com/RaspAP/raspap-webgui/raw/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681#!/bin/bash## RaspAP installation functions# Author: @billz <billzimmerman@gmail.com># Author URI: https://github.com/billz/# License: GNU General Public License v3.0# License URI: https://github.com/raspap/raspap-webgui/blob/master/LICENSE
# You are not obligated to bundle the LICENSE file with your RaspAP projects as long# as you leave these references intact in the header comments of your source files.
# Exit on errorset -o errexit# Exit on error inside functionsset -o errtrace# Turn on traces, disabled by default# set -o xtrace
# Set defaultsreadonly raspap\_dir="/etc/raspap"readonly raspap\_user="www-data"readonly raspap\_sudoers="/etc/sudoers.d/090\_raspap"readonly raspap\_default="/etc/dnsmasq.d/090\_raspap.conf"readonly raspap\_wlan0="/etc/dnsmasq.d/090\_wlan0.conf"readonly raspap\_adblock="/etc/dnsmasq.d/090\_adblock.conf"readonly raspap\_sysctl="/etc/sysctl.d/90\_raspap.conf"readonly raspap\_network="$raspap\_dir/networking/"readonly raspap\_router="/etc/lighttpd/conf-available/50-raspap-router.conf"readonly rulesv4="/etc/iptables/rules.v4"readonly notracking\_url="https://raw.githubusercontent.com/notracking/hosts-blocklists/master/"webroot\_dir="/var/www/html"
if [ "$insiders" == 1 ]; then repo="RaspAP/raspap-insiders" branch=${RASPAP\_INSIDERS\_LATEST}figit\_source\_url="https://github.com/$repo"
# NOTE: all the below functions are overloadable for system-specific installsfunction \_install\_raspap() { \_display\_welcome \_config\_installation \_update\_system\_packages \_install\_dependencies \_enable\_php\_lighttpd \_create\_raspap\_directories \_optimize\_php \_check\_for\_old\_configs \_download\_latest\_files \_change\_file\_ownership \_create\_hostapd\_scripts \_create\_lighttpd\_scripts \_install\_lighttpd\_configs \_move\_config\_file \_default\_configuration \_configure\_networking \_prompt\_install\_adblock \_prompt\_install\_openvpn \_install\_mobile\_clients \_prompt\_install\_wireguard \_patch\_system\_files \_install\_complete}
# search for optional installation files names install\_feature\_\*.shfunction \_install\_mobile\_clients() { if [ "$insiders" == 1 ]; then \_install\_log "Installing support for mobile data clients" for feature in $(ls $webroot\_dir/installers/install\_feature\_\*.sh) ; do source $feature f=$(basename $feature) func="\_${f%.\*}" if declare -f -F $func > /dev/null; then echo "Installing $func" $func || \_install\_status 1 "Unable to install feature ($func)" else \_install\_status 1 "Install file $f is missing install function $func" fi done fi}
# Prompts user to set installation optionsfunction \_config\_installation() { if [ "$upgrade" == 1 ]; then opt=(Upgrade Upgrading upgrade) else opt=(Install Installing installation) fi \_install\_log "Configure ${opt[2]}" \_get\_linux\_distro echo "Detected OS: ${DESC}" echo "Using GitHub repository: ${repo} ${branch} branch" echo "Configuration directory: ${raspap\_dir}" echo -n "lighttpd root: ${webroot\_dir}? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then read -e -p < /dev/tty "Enter alternate lighttpd directory: " -i "/var/www/html" webroot\_dir fi else echo -e fi echo "${opt[1]} lighttpd directory: ${webroot\_dir}" if [ "$upgrade" == 1 ]; then echo "This will upgrade your existing install to version ${RASPAP\_RELEASE}" echo "Your configuration will NOT be changed" fi echo -n "Complete ${opt[2]} with these values? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation aborted." exit 0 fi else echo -e fi}
# Determines host Linux distribution detailsfunction \_get\_linux\_distro() { if type lsb\_release >/dev/null 2>&1; then # linuxbase.org OS=$(lsb\_release -si) RELEASE=$(lsb\_release -sr) CODENAME=$(lsb\_release -sc) DESC=$(lsb\_release -sd) elif [ -f /etc/os-release ]; then # freedesktop.org . /etc/os-release OS=$ID RELEASE=$VERSION\_ID CODENAME=$VERSION\_CODENAME DESC=$PRETTY\_NAME else \_install\_status 1 "Unsupported Linux distribution" fi}
# Sets php package option based on Linux version, abort if unsupported distrofunction \_set\_php\_package() { case $RELEASE in 18.04|19.10) # Ubuntu Server php\_package="php7.4-cgi" phpcgiconf="/etc/php/7.4/cgi/php.ini" ;; 10\*) php\_package="php7.3-cgi" phpcgiconf="/etc/php/7.3/cgi/php.ini" ;; 9\*) php\_package="php7.0-cgi" phpcgiconf="/etc/php/7.0/cgi/php.ini" ;; 8) \_install\_status 1 "${DESC} and php5 are not supported. Please upgrade." ;; \*) \_install\_status 1 "${DESC} is unsupported. Please install on a supported distro." ;; esac}
# Runs a system software update to make sure we're using all fresh packagesfunction \_install\_dependencies() { \_install\_log "Installing required packages" \_set\_php\_package if [ "$php\_package" = "php7.4-cgi" ]; then echo "Adding apt-repository ppa:ondrej/php" sudo apt-get install $apt\_option software-properties-common || \_install\_status 1 "Unable to install dependency" sudo add-apt-repository $apt\_option ppa:ondrej/php || \_install\_status 1 "Unable to add-apt-repository ppa:ondrej/php" fi if [ ${OS,,} = "debian" ] || [ ${OS,,} = "ubuntu" ]; then dhcpcd\_package="dhcpcd5" fi # Set dconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v4 boolean true | sudo debconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v6 boolean true | sudo debconf-set-selections sudo apt-get install $apt\_option lighttpd git hostapd dnsmasq iptables-persistent $php\_package $dhcpcd\_package vnstat qrencode || \_install\_status 1 "Unable to install dependencies" \_install\_status 0}
# Enables PHP for lighttpd and restarts service for settings to take effectfunction \_enable\_php\_lighttpd() { \_install\_log "Enabling PHP for lighttpd" sudo lighttpd-enable-mod fastcgi-php  sudo service lighttpd force-reload sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd"}
# Verifies existence and permissions of RaspAP directoryfunction \_create\_raspap\_directories() { \_install\_log "Creating RaspAP directories" if [ -d "$raspap\_dir" ]; then sudo mv $raspap\_dir "$raspap\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to move old '$raspap\_dir' out of the way" fi sudo mkdir -p "$raspap\_dir" || \_install\_status 1 "Unable to create directory '$raspap\_dir'"
 # Create a directory for existing file backups. sudo mkdir -p "$raspap\_dir/backups"
 # Create a directory to store networking configs echo "Creating $raspap\_dir/networking" sudo mkdir -p "$raspap\_dir/networking" # Copy existing dhcpcd.conf to use as base config echo "Adding /etc/dhcpcd.conf as base configuration" cat /etc/dhcpcd.conf | sudo tee -a /etc/raspap/networking/defaults > /dev/null echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Generate hostapd logging and service control scriptsfunction \_create\_hostapd\_scripts() { \_install\_log "Creating hostapd logging & control scripts" sudo mkdir $raspap\_dir/hostapd || \_install\_status 1 "Unable to create directory '$raspap\_dir/hostapd'"
 # Move logging shell scripts  sudo cp "$webroot\_dir/installers/"\*log.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move logging scripts" # Move service control shell scripts sudo cp "$webroot\_dir/installers/"service\*.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move service control scripts" # Make enablelog.sh and disablelog.sh not writable by www-data group. sudo chown -c root:"$raspap\_user" "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Generate lighttpd service control scriptsfunction \_create\_lighttpd\_scripts() { \_install\_log "Creating lighttpd control scripts" sudo mkdir $raspap\_dir/lighttpd || \_install\_status 1 "Unable to create directory '$raspap\_dir/lighttpd"
 # Move service control shell scripts echo "Copying configport.sh to $raspap\_dir/lighttpd" sudo cp "$webroot\_dir/installers/"configport.sh "$raspap\_dir/lighttpd" || \_install\_status 1 "Unable to move service control scripts" # Make configport.sh writable by www-data group echo "Changing file ownership" sudo chown -c root:"$raspap\_user" "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Copy extra config files required to configure lighttpdfunction \_install\_lighttpd\_configs() { \_install\_log "Copying lighttpd extra config files"
 # Copy config files echo "Copying 50-raspap-router.conf to /etc/lighttpd/conf-available"
 CONFSRC="$webroot\_dir/config/50-raspap-router.conf" LTROOT=$(grep "server.document-root" /etc/lighttpd/lighttpd.conf | awk -F '=' '{print $2}' | tr -d " \"")
 # Compare values and get difference HTROOT=${webroot\_dir/$LTROOT}
 # Remove trailing slash if present HTROOT=$(echo "$HTROOT" | sed -e 's/\/$//')
 # Substitute values awk "{gsub(\"/REPLACE\_ME\",\"$HTROOT\")}1" $CONFSRC > /tmp/50-raspap-router.conf
 # Copy into place sudo cp /tmp/50-raspap-router.conf /etc/lighttpd/conf-available/ || \_install\_status 1 "Unable to copy lighttpd config file into place."
 # Link into conf-enabled echo "Creating link to /etc/lighttpd/conf-enabled" if ! [ -L $raspap\_router ]; then echo "Existing 50-raspap-router.conf found. Unlinking." sudo unlink "/etc/lighttpd/conf-enabled/50-raspap-router.conf" fi echo "Linking 50-raspap-router.conf to /etc/lighttpd/conf-enabled/" sudo ln -s "/etc/lighttpd/conf-available/50-raspap-router.conf" "/etc/lighttpd/conf-enabled/50-raspap-router.conf" || \_install\_status 1 "Unable to symlink lighttpd config file (this is normal if the link already exists)." sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd" \_install\_status 0}
# Prompt to install ad blockingfunction \_prompt\_install\_adblock() { \_install\_log "Configure ad blocking (Beta)" echo -n "Install ad blocking and enable list management? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_adblock fi elif [ "$adblock\_option" == 1 ]; then \_install\_adblock else echo "(Skipped)" fi}
# Download notracking adblock lists and enable optionfunction \_install\_adblock() { \_install\_log "Creating ad blocking base configuration (Beta)" if [ ! -d "$raspap\_dir/adblock" ]; then echo "Creating $raspap\_dir/adblock" sudo mkdir -p "$raspap\_dir/adblock" fi if [ ! -f /tmp/hostnames.txt ]; then echo "Fetching latest hostnames list" wget ${notracking\_url}hostnames.txt -q --show-progress --progress=bar:force -O /tmp/hostnames.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking hostnames" fi if [ ! -f /tmp/domains.txt ]; then echo "Fetching latest domains list" wget ${notracking\_url}domains.txt -q --show-progress --progress=bar:force -O /tmp/domains.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking domains" fi echo "Adding blocklists to $raspap\_dir/adblock" sudo cp /tmp/hostnames.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking hostnames" sudo cp /tmp/domains.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking domains"
 echo "Moving and setting permissions for blocklist update script" sudo cp "$webroot\_dir/installers/"update\_blocklist.sh "$raspap\_dir/adblock" || \_install\_status 1 "Unable to move blocklist update script"
 # Make blocklists and update script writable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/adblock/"\*.\* || \_install\_status 1 "Unable to change owner/group" sudo chmod 750 "$raspap\_dir/adblock/"\*.sh || install\_error "Unable to change file permissions"
 # Create 090\_adblock.conf and write values to /etc/dnsmasq.d if [ ! -f "$raspap\_adblock" ]; then echo "Adding 090\_addblock.conf to /etc/dnsmasq.d" sudo touch "$raspap\_adblock" echo "conf-file=$raspap\_dir/adblock/domains.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" echo "addn-hosts=$raspap\_dir/adblock/hostnames.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" fi
 # Remove dhcp-option=6 in dnsmasq.d/090\_wlan0.conf to force local DNS resolution for DHCP clients echo "Enabling local DNS name resolution for DHCP clients" sudo sed -i '/dhcp-option=6/d' $raspap\_wlan0 || \_install\_status 1 "Unable to modify $raspap\_dnsmasq"
 echo "Enabling ad blocking management option" sudo sed -i "s/\('RASPI\_ADBLOCK\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Prompt to install openvpnfunction \_prompt\_install\_openvpn() { \_install\_log "Configure OpenVPN support" echo -n "Install OpenVPN and enable client configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_openvpn fi elif [ "$ovpn\_option" == 1 ]; then \_install\_openvpn else echo "(Skipped)" fi}
# Prompt to install WireGuardfunction \_prompt\_install\_wireguard() { if [ "$insiders" == 1 ]; then \_install\_log "Configure WireGuard support" echo -n "Install WireGuard and enable VPN tunnel configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_wireguard fi elif [ "$wg\_option" == 1 ]; then \_install\_wireguard else echo "(Skipped)" fi fi}
# Install Wireguard from the Debian unstable distrofunction \_install\_wireguard() { \_install\_log "Configure WireGuard support" if [ "$OS" == "Debian" ]; then echo 'deb http://ftp.debian.org/debian buster-backports main' | sudo tee /etc/apt/sources.list.d/buster-backports.list || \_install\_status 1 "Unable to add Debian backports repo" fi echo "Installing wireguard from apt" sudo apt-get update && sudo apt-get install $apt\_option wireguard || \_install\_status 1 "Unable to install wireguard" echo "Enabling wg-quick@wg0" sudo systemctl enable wg-quick@wg0 || \_install\_status 1 "Failed to enable wg-quick service" echo "Enabling WireGuard management option" sudo sed -i "s/\('RASPI\_WIREGUARD\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Install openvpn and enable client configuration optionfunction \_install\_openvpn() { \_install\_log "Installing OpenVPN and enabling client configuration" echo "Adding packages via apt-get" sudo apt-get install -y openvpn || \_install\_status 1 "Unable to install openvpn" sudo sed -i "s/\('RASPI\_OPENVPN\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" echo "Enabling openvpn-client service on boot" sudo systemctl enable openvpn-client@client || \_install\_status 1 "Unable to enable openvpn-client daemon" \_create\_openvpn\_scripts || \_install\_status 1 "Unable to create openvpn control scripts"}
# Generate openvpn logging and auth control scriptsfunction \_create\_openvpn\_scripts() { \_install\_log "Creating OpenVPN control scripts" sudo mkdir $raspap\_dir/openvpn || \_install\_status 1 "Unable to create directory '$raspap\_dir/openvpn'"
 # Move service auth control & logging shell scripts sudo cp "$webroot\_dir/installers/"configauth.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move auth control script" sudo cp "$webroot\_dir/installers/"openvpnlog.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move logging script" # Make scripts executable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Fetches latest files from github to webrootfunction \_download\_latest\_files() { if [ ! -d "$webroot\_dir" ]; then sudo mkdir -p $webroot\_dir || \_install\_status 1 "Unable to create new webroot directory" fi
 if [ -d "$webroot\_dir" ]; then sudo mv $webroot\_dir "$webroot\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to remove old webroot directory" fi
 \_install\_log "Cloning latest files from github" git clone --branch $branch --depth 1 -c advice.detachedHead=false $git\_source\_url /tmp/raspap-webgui || \_install\_status 1 "Unable to download files from github"
 sudo mv /tmp/raspap-webgui $webroot\_dir || \_install\_status 1 "Unable to move raspap-webgui to web root" if [ "$upgrade" == 1 ]; then \_install\_log "Applying existing configuration to ${webroot\_dir}/includes" sudo mv /tmp/config.php $webroot\_dir/includes || \_install\_status 1 "Unable to move config.php to ${webroot\_dir}/includes" fi
 \_install\_status 0}
# Sets files ownership in web root directoryfunction \_change\_file\_ownership() { if [ ! -d "$webroot\_dir" ]; then \_install\_status 1 "Web root directory doesn't exist" fi
 \_install\_log "Changing file ownership in web root directory" sudo chown -R $raspap\_user:$raspap\_user "$webroot\_dir" || \_install\_status 1 "Unable to change file ownership for '$webroot\_dir'"}
# Check for existing configuration filesfunction \_check\_for\_old\_configs() { if [ "$upgrade" == 1 ]; then \_install\_log "Moving existing configuration to /tmp" sudo mv $webroot\_dir/includes/config.php /tmp || \_install\_status 1 "Unable to move config.php to /tmp" else \_install\_log "Backing up existing configs to ${raspap\_dir}/backups" if [ -f /etc/network/interfaces ]; then sudo cp /etc/network/interfaces "$raspap\_dir/backups/interfaces.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/interfaces.`date +%F-%R`" "$raspap\_dir/backups/interfaces" fi
 if [ -f /etc/hostapd/hostapd.conf ]; then sudo cp /etc/hostapd/hostapd.conf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" "$raspap\_dir/backups/hostapd.conf" fi
 if [ -f $raspap\_default ]; then sudo cp $raspap\_default "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_raspap.conf" fi
 if [ -f $raspap\_wlan0 ]; then sudo cp $raspap\_wlan0 "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_wlan0.conf" fi
 if [ -f /etc/dhcpcd.conf ]; then sudo cp /etc/dhcpcd.conf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" "$raspap\_dir/backups/dhcpcd.conf" fi
 for file in /etc/systemd/network/raspap-\*.net\*; do if [ -f "${file}" ]; then filename=$(basename $file) sudo cp "$file" "${raspap\_dir}/backups/${filename}.`date +%F-%R`" sudo ln -sf "${raspap\_dir}/backups/${filename}.`date +%F-%R`" "${raspap\_dir}/backups/${filename}" fi done fi \_install\_status 0}
# Move configuration file to the correct locationfunction \_move\_config\_file() { if [ ! -d "$raspap\_dir" ]; then \_install\_status 1 "'$raspap\_dir' directory doesn't exist" fi
 \_install\_log "Moving configuration file to $raspap\_dir" sudo cp "$webroot\_dir"/raspap.php "$raspap\_dir" || \_install\_status 1 "Unable to move files to '$raspap\_dir'" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Set up default configurationfunction \_default\_configuration() { if [ "$upgrade" == 0 ]; then \_install\_log "Applying default configuration to installed services"
 sudo cp $webroot\_dir/config/hostapd.conf /etc/hostapd/hostapd.conf || \_install\_status 1 "Unable to move hostapd configuration file" sudo cp $webroot\_dir/config/090\_raspap.conf $raspap\_default || \_install\_status 1 "Unable to move dnsmasq default configuration file" sudo cp $webroot\_dir/config/090\_wlan0.conf $raspap\_wlan0 || \_install\_status 1 "Unable to move dnsmasq wlan0 configuration file" sudo cp $webroot\_dir/config/dhcpcd.conf /etc/dhcpcd.conf || \_install\_status 1 "Unable to move dhcpcd configuration file" sudo cp $webroot\_dir/config/defaults.json $raspap\_network || \_install\_status 1 "Unable to move defaults.json settings"
 echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"
 echo "Checking for existence of /etc/dnsmasq.d" [ -d /etc/dnsmasq.d ] || sudo mkdir /etc/dnsmasq.d
 echo "Copying bridged AP config to /etc/systemd/network" sudo systemctl stop systemd-networkd sudo systemctl disable systemd-networkd sudo cp $webroot\_dir/config/raspap-bridge-br0.netdev /etc/systemd/network/raspap-bridge-br0.netdev || \_install\_status 1 "Unable to move br0 netdev file" sudo cp $webroot\_dir/config/raspap-br0-member-eth0.network /etc/systemd/network/raspap-br0-member-eth0.network || \_install\_status 1 "Unable to move br0 member file"
 echo "Copying primary RaspAP config to includes/config.php" if [ ! -f "$webroot\_dir/includes/config.php" ]; then sudo cp "$webroot\_dir/config/config.php" "$webroot\_dir/includes/config.php" fi \_install\_status 0 fi}
# Install and enable RaspAP daemonfunction \_enable\_raspap\_daemon() { \_install\_log "Enabling RaspAP daemon" echo "Disable with: sudo systemctl disable raspapd.service" sudo cp $webroot\_dir/installers/raspapd.service /lib/systemd/system/ || \_install\_status 1 "Unable to move raspap.service file" sudo systemctl daemon-reload sudo systemctl enable raspapd.service || \_install\_status 1 "Failed to enable raspap.service"}
# Configure IP forwarding, set IP tables rules, prompt to install RaspAP daemonfunction \_configure\_networking() { \_install\_log "Configuring networking" echo "Enabling IP forwarding" echo "net.ipv4.ip\_forward=1" | sudo tee $raspap\_sysctl > /dev/null || \_install\_status 1 "Unable to set IP forwarding" sudo sysctl -p $raspap\_sysctl || \_install\_status 1 "Unable to execute sysctl" sudo /etc/init.d/procps restart || \_install\_status 1 "Unable to execute procps"
 echo "Checking iptables rules" rules=( "-A POSTROUTING -j MASQUERADE" "-A POSTROUTING -s 192.168.50.0/24 ! -d 192.168.50.0/24 -j MASQUERADE" ) for rule in "${rules[@]}"; do if grep -- "$rule" $rulesv4 > /dev/null; then echo "Rule already exits: ${rule}" else rule=$(sed -e 's/^\(-A POSTROUTING\)/-t nat \1/' <<< $rule) echo "Adding rule: ${rule}" sudo iptables $rule || \_install\_status 1 "Unable to execute iptables" added=true fi done # Persist rules if added if [ "$added" = true ]; then echo "Persisting IP tables rules" sudo iptables-save | sudo tee $rulesv4 > /dev/null || \_install\_status 1 "Unable to execute iptables-save" fi
 # Prompt to install RaspAP daemon echo -n "Enable RaspAP control service (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_enable\_raspap\_daemon fi else echo -e \_enable\_raspap\_daemon fi \_install\_status 0 }
# Add sudoers file to /etc/sudoers.d/ and set file permissionsfunction \_patch\_system\_files() {
 # Create sudoers if not present if [ ! -f $raspap\_sudoers ]; then \_install\_log "Adding raspap.sudoers to ${raspap\_sudoers}" sudo cp "$webroot\_dir/installers/raspap.sudoers" $raspap\_sudoers || \_install\_status 1 "Unable to apply raspap.sudoers to $raspap\_sudoers" sudo chmod 0440 $raspap\_sudoers || \_install\_status 1 "Unable to change file permissions for $raspap\_sudoers" fi
 # Add symlink to prevent wpa\_cli cmds from breaking with multiple wlan interfaces \_install\_log "Symlinked wpa\_supplicant hooks for multiple wlan interfaces" if [ ! -f /usr/share/dhcpcd/hooks/10-wpa\_supplicant ]; then sudo ln -s /usr/share/dhcpcd/hooks/10-wpa\_supplicant /etc/dhcp/dhclient-enter-hooks.d/ fi
 # Unmask and enable hostapd.service \_install\_log "Unmasking and enabling hostapd service" sudo systemctl unmask hostapd.service sudo systemctl enable hostapd.service \_install\_status 0}
# Optimize configuration of php-cgi.function \_optimize\_php() { if [ "$upgrade" == 0 ]; then \_install\_log "Optimize PHP configuration" if [ ! -f "$phpcgiconf" ]; then \_install\_warning "PHP configuration could not be found." return fi
 # Backup php.ini and create symlink for restoring. datetimephpconf=$(date +%F-%R) sudo cp "$phpcgiconf" "$raspap\_dir/backups/php.ini.$datetimephpconf" sudo ln -sf "$raspap\_dir/backups/php.ini.$datetimephpconf" "$raspap\_dir/backups/php.ini"
 echo -n "Enable HttpOnly for session cookies (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_session\_cookie=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$php\_session\_cookie" == 1 ]; then echo "Php-cgi enabling session.cookie\_httponly." sudo sed -i -E 's/^session\.cookie\_httponly\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/session.cookie\_httponly = 1/' "$phpcgiconf" fi
 if [ "$php\_package" = "php7.1-cgi" ]; then echo -n "Enable PHP OPCache (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_opcache=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$phpopcache" == 1 ]; then echo -e "Php-cgi enabling opcache.enable." sudo sed -i -E 's/^;?opcache\.enable\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/opcache.enable = 1/' "$phpcgiconf" # Make sure opcache extension is turned on. if [ -f "/usr/sbin/phpenmod" ]; then sudo phpenmod opcache else \_install\_status 2 "phpenmod not found." fi fi fi fi}
function \_install\_complete() { \_install\_log "Installation completed" echo "Join RaspAP Insiders for early access to exclusive features!" echo -e "${ANSI\_RASPBERRY}" echo "> https://docs.raspap.com/insiders/" echo "> https://github.com/sponsors/RaspAP/" echo -e "${ANSI\_RESET}" if [ "$assume\_yes" == 0 ]; then # Prompt to reboot if wired ethernet (eth0) is connected. # With default\_configuration this will create an active AP on restart. if ip a | grep -q ': eth0:.\*state UP'; then echo -n "The system needs to be rebooted as a final step. Reboot now? [y/N]: " read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation reboot aborted." exit 0 fi sudo shutdown -r now || \_install\_status 1 "Unable to execute shutdown" fi fi}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_e62cdc1c_20250114_205837.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRaspAP%2Fraspap-webgui%2Fblob%2F5a7b77459839c9420fac0d10ec28cee1af9bb782%2Finstallers%2Fcommon.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RaspAP%2Fraspap-webgui)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RaspAP](/RaspAP)
/
**[raspap-webgui](/RaspAP/raspap-webgui)**
Public

* [Notifications](/login?return_to=%2FRaspAP%2Fraspap-webgui) You must be signed in to change notification settings
* [Fork
  797](/login?return_to=%2FRaspAP%2Fraspap-webgui)
* [Star
   4.5k](/login?return_to=%2FRaspAP%2Fraspap-webgui)

* [Code](/RaspAP/raspap-webgui)
* [Issues
  22](/RaspAP/raspap-webgui/issues)
* [Pull requests
  9](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects
  1](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

Additional navigation options

* [Code](/RaspAP/raspap-webgui)
* [Issues](/RaspAP/raspap-webgui/issues)
* [Pull requests](/RaspAP/raspap-webgui/pulls)
* [Discussions](/RaspAP/raspap-webgui/discussions)
* [Actions](/RaspAP/raspap-webgui/actions)
* [Projects](/RaspAP/raspap-webgui/projects)
* [Wiki](/RaspAP/raspap-webgui/wiki)
* [Security](/RaspAP/raspap-webgui/security)
* [Insights](/RaspAP/raspap-webgui/pulse)

## Files

 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/RaspAP/raspap-webgui/commits/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)executable file·682 lines (604 loc) · 28.8 KB 5a7b774
## Breadcrumbs

1. [raspap-webgui](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782)
2. /[installers](/RaspAP/raspap-webgui/tree/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers)
/
# common.sh

Top
## File metadata and controls

* Code
* Blame

executable file·682 lines (604 loc) · 28.8 KB[Raw](https://github.com/RaspAP/raspap-webgui/raw/5a7b77459839c9420fac0d10ec28cee1af9bb782/installers/common.sh)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681#!/bin/bash## RaspAP installation functions# Author: @billz <billzimmerman@gmail.com># Author URI: https://github.com/billz/# License: GNU General Public License v3.0# License URI: https://github.com/raspap/raspap-webgui/blob/master/LICENSE
# You are not obligated to bundle the LICENSE file with your RaspAP projects as long# as you leave these references intact in the header comments of your source files.
# Exit on errorset -o errexit# Exit on error inside functionsset -o errtrace# Turn on traces, disabled by default# set -o xtrace
# Set defaultsreadonly raspap\_dir="/etc/raspap"readonly raspap\_user="www-data"readonly raspap\_sudoers="/etc/sudoers.d/090\_raspap"readonly raspap\_default="/etc/dnsmasq.d/090\_raspap.conf"readonly raspap\_wlan0="/etc/dnsmasq.d/090\_wlan0.conf"readonly raspap\_adblock="/etc/dnsmasq.d/090\_adblock.conf"readonly raspap\_sysctl="/etc/sysctl.d/90\_raspap.conf"readonly raspap\_network="$raspap\_dir/networking/"readonly raspap\_router="/etc/lighttpd/conf-available/50-raspap-router.conf"readonly rulesv4="/etc/iptables/rules.v4"readonly notracking\_url="https://raw.githubusercontent.com/notracking/hosts-blocklists/master/"webroot\_dir="/var/www/html"
if [ "$insiders" == 1 ]; then repo="RaspAP/raspap-insiders" branch=${RASPAP\_INSIDERS\_LATEST}figit\_source\_url="https://github.com/$repo"
# NOTE: all the below functions are overloadable for system-specific installsfunction \_install\_raspap() { \_display\_welcome \_config\_installation \_update\_system\_packages \_install\_dependencies \_enable\_php\_lighttpd \_create\_raspap\_directories \_optimize\_php \_check\_for\_old\_configs \_download\_latest\_files \_change\_file\_ownership \_create\_hostapd\_scripts \_create\_lighttpd\_scripts \_install\_lighttpd\_configs \_move\_config\_file \_default\_configuration \_configure\_networking \_prompt\_install\_adblock \_prompt\_install\_openvpn \_install\_mobile\_clients \_prompt\_install\_wireguard \_patch\_system\_files \_install\_complete}
# search for optional installation files names install\_feature\_\*.shfunction \_install\_mobile\_clients() { if [ "$insiders" == 1 ]; then \_install\_log "Installing support for mobile data clients" for feature in $(ls $webroot\_dir/installers/install\_feature\_\*.sh) ; do source $feature f=$(basename $feature) func="\_${f%.\*}" if declare -f -F $func > /dev/null; then echo "Installing $func" $func || \_install\_status 1 "Unable to install feature ($func)" else \_install\_status 1 "Install file $f is missing install function $func" fi done fi}
# Prompts user to set installation optionsfunction \_config\_installation() { if [ "$upgrade" == 1 ]; then opt=(Upgrade Upgrading upgrade) else opt=(Install Installing installation) fi \_install\_log "Configure ${opt[2]}" \_get\_linux\_distro echo "Detected OS: ${DESC}" echo "Using GitHub repository: ${repo} ${branch} branch" echo "Configuration directory: ${raspap\_dir}" echo -n "lighttpd root: ${webroot\_dir}? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then read -e -p < /dev/tty "Enter alternate lighttpd directory: " -i "/var/www/html" webroot\_dir fi else echo -e fi echo "${opt[1]} lighttpd directory: ${webroot\_dir}" if [ "$upgrade" == 1 ]; then echo "This will upgrade your existing install to version ${RASPAP\_RELEASE}" echo "Your configuration will NOT be changed" fi echo -n "Complete ${opt[2]} with these values? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation aborted." exit 0 fi else echo -e fi}
# Determines host Linux distribution detailsfunction \_get\_linux\_distro() { if type lsb\_release >/dev/null 2>&1; then # linuxbase.org OS=$(lsb\_release -si) RELEASE=$(lsb\_release -sr) CODENAME=$(lsb\_release -sc) DESC=$(lsb\_release -sd) elif [ -f /etc/os-release ]; then # freedesktop.org . /etc/os-release OS=$ID RELEASE=$VERSION\_ID CODENAME=$VERSION\_CODENAME DESC=$PRETTY\_NAME else \_install\_status 1 "Unsupported Linux distribution" fi}
# Sets php package option based on Linux version, abort if unsupported distrofunction \_set\_php\_package() { case $RELEASE in 18.04|19.10) # Ubuntu Server php\_package="php7.4-cgi" phpcgiconf="/etc/php/7.4/cgi/php.ini" ;; 10\*) php\_package="php7.3-cgi" phpcgiconf="/etc/php/7.3/cgi/php.ini" ;; 9\*) php\_package="php7.0-cgi" phpcgiconf="/etc/php/7.0/cgi/php.ini" ;; 8) \_install\_status 1 "${DESC} and php5 are not supported. Please upgrade." ;; \*) \_install\_status 1 "${DESC} is unsupported. Please install on a supported distro." ;; esac}
# Runs a system software update to make sure we're using all fresh packagesfunction \_install\_dependencies() { \_install\_log "Installing required packages" \_set\_php\_package if [ "$php\_package" = "php7.4-cgi" ]; then echo "Adding apt-repository ppa:ondrej/php" sudo apt-get install $apt\_option software-properties-common || \_install\_status 1 "Unable to install dependency" sudo add-apt-repository $apt\_option ppa:ondrej/php || \_install\_status 1 "Unable to add-apt-repository ppa:ondrej/php" fi if [ ${OS,,} = "debian" ] || [ ${OS,,} = "ubuntu" ]; then dhcpcd\_package="dhcpcd5" fi # Set dconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v4 boolean true | sudo debconf-set-selections echo iptables-persistent iptables-persistent/autosave\_v6 boolean true | sudo debconf-set-selections sudo apt-get install $apt\_option lighttpd git hostapd dnsmasq iptables-persistent $php\_package $dhcpcd\_package vnstat qrencode || \_install\_status 1 "Unable to install dependencies" \_install\_status 0}
# Enables PHP for lighttpd and restarts service for settings to take effectfunction \_enable\_php\_lighttpd() { \_install\_log "Enabling PHP for lighttpd" sudo lighttpd-enable-mod fastcgi-php  sudo service lighttpd force-reload sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd"}
# Verifies existence and permissions of RaspAP directoryfunction \_create\_raspap\_directories() { \_install\_log "Creating RaspAP directories" if [ -d "$raspap\_dir" ]; then sudo mv $raspap\_dir "$raspap\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to move old '$raspap\_dir' out of the way" fi sudo mkdir -p "$raspap\_dir" || \_install\_status 1 "Unable to create directory '$raspap\_dir'"
 # Create a directory for existing file backups. sudo mkdir -p "$raspap\_dir/backups"
 # Create a directory to store networking configs echo "Creating $raspap\_dir/networking" sudo mkdir -p "$raspap\_dir/networking" # Copy existing dhcpcd.conf to use as base config echo "Adding /etc/dhcpcd.conf as base configuration" cat /etc/dhcpcd.conf | sudo tee -a /etc/raspap/networking/defaults > /dev/null echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Generate hostapd logging and service control scriptsfunction \_create\_hostapd\_scripts() { \_install\_log "Creating hostapd logging & control scripts" sudo mkdir $raspap\_dir/hostapd || \_install\_status 1 "Unable to create directory '$raspap\_dir/hostapd'"
 # Move logging shell scripts  sudo cp "$webroot\_dir/installers/"\*log.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move logging scripts" # Move service control shell scripts sudo cp "$webroot\_dir/installers/"service\*.sh "$raspap\_dir/hostapd" || \_install\_status 1 "Unable to move service control scripts" # Make enablelog.sh and disablelog.sh not writable by www-data group. sudo chown -c root:"$raspap\_user" "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/hostapd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Generate lighttpd service control scriptsfunction \_create\_lighttpd\_scripts() { \_install\_log "Creating lighttpd control scripts" sudo mkdir $raspap\_dir/lighttpd || \_install\_status 1 "Unable to create directory '$raspap\_dir/lighttpd"
 # Move service control shell scripts echo "Copying configport.sh to $raspap\_dir/lighttpd" sudo cp "$webroot\_dir/installers/"configport.sh "$raspap\_dir/lighttpd" || \_install\_status 1 "Unable to move service control scripts" # Make configport.sh writable by www-data group echo "Changing file ownership" sudo chown -c root:"$raspap\_user" "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/lighttpd/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Copy extra config files required to configure lighttpdfunction \_install\_lighttpd\_configs() { \_install\_log "Copying lighttpd extra config files"
 # Copy config files echo "Copying 50-raspap-router.conf to /etc/lighttpd/conf-available"
 CONFSRC="$webroot\_dir/config/50-raspap-router.conf" LTROOT=$(grep "server.document-root" /etc/lighttpd/lighttpd.conf | awk -F '=' '{print $2}' | tr -d " \"")
 # Compare values and get difference HTROOT=${webroot\_dir/$LTROOT}
 # Remove trailing slash if present HTROOT=$(echo "$HTROOT" | sed -e 's/\/$//')
 # Substitute values awk "{gsub(\"/REPLACE\_ME\",\"$HTROOT\")}1" $CONFSRC > /tmp/50-raspap-router.conf
 # Copy into place sudo cp /tmp/50-raspap-router.conf /etc/lighttpd/conf-available/ || \_install\_status 1 "Unable to copy lighttpd config file into place."
 # Link into conf-enabled echo "Creating link to /etc/lighttpd/conf-enabled" if ! [ -L $raspap\_router ]; then echo "Existing 50-raspap-router.conf found. Unlinking." sudo unlink "/etc/lighttpd/conf-enabled/50-raspap-router.conf" fi echo "Linking 50-raspap-router.conf to /etc/lighttpd/conf-enabled/" sudo ln -s "/etc/lighttpd/conf-available/50-raspap-router.conf" "/etc/lighttpd/conf-enabled/50-raspap-router.conf" || \_install\_status 1 "Unable to symlink lighttpd config file (this is normal if the link already exists)." sudo systemctl restart lighttpd.service || \_install\_status 1 "Unable to restart lighttpd" \_install\_status 0}
# Prompt to install ad blockingfunction \_prompt\_install\_adblock() { \_install\_log "Configure ad blocking (Beta)" echo -n "Install ad blocking and enable list management? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_adblock fi elif [ "$adblock\_option" == 1 ]; then \_install\_adblock else echo "(Skipped)" fi}
# Download notracking adblock lists and enable optionfunction \_install\_adblock() { \_install\_log "Creating ad blocking base configuration (Beta)" if [ ! -d "$raspap\_dir/adblock" ]; then echo "Creating $raspap\_dir/adblock" sudo mkdir -p "$raspap\_dir/adblock" fi if [ ! -f /tmp/hostnames.txt ]; then echo "Fetching latest hostnames list" wget ${notracking\_url}hostnames.txt -q --show-progress --progress=bar:force -O /tmp/hostnames.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking hostnames" fi if [ ! -f /tmp/domains.txt ]; then echo "Fetching latest domains list" wget ${notracking\_url}domains.txt -q --show-progress --progress=bar:force -O /tmp/domains.txt 2>&1 \ || \_install\_status 1 "Unable to download notracking domains" fi echo "Adding blocklists to $raspap\_dir/adblock" sudo cp /tmp/hostnames.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking hostnames" sudo cp /tmp/domains.txt $raspap\_dir/adblock || \_install\_status 1 "Unable to move notracking domains"
 echo "Moving and setting permissions for blocklist update script" sudo cp "$webroot\_dir/installers/"update\_blocklist.sh "$raspap\_dir/adblock" || \_install\_status 1 "Unable to move blocklist update script"
 # Make blocklists and update script writable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/adblock/"\*.\* || \_install\_status 1 "Unable to change owner/group" sudo chmod 750 "$raspap\_dir/adblock/"\*.sh || install\_error "Unable to change file permissions"
 # Create 090\_adblock.conf and write values to /etc/dnsmasq.d if [ ! -f "$raspap\_adblock" ]; then echo "Adding 090\_addblock.conf to /etc/dnsmasq.d" sudo touch "$raspap\_adblock" echo "conf-file=$raspap\_dir/adblock/domains.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" echo "addn-hosts=$raspap\_dir/adblock/hostnames.txt" | sudo tee -a "$raspap\_adblock" > /dev/null || \_install\_status 1 "Unable to write to $raspap\_adblock" fi
 # Remove dhcp-option=6 in dnsmasq.d/090\_wlan0.conf to force local DNS resolution for DHCP clients echo "Enabling local DNS name resolution for DHCP clients" sudo sed -i '/dhcp-option=6/d' $raspap\_wlan0 || \_install\_status 1 "Unable to modify $raspap\_dnsmasq"
 echo "Enabling ad blocking management option" sudo sed -i "s/\('RASPI\_ADBLOCK\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Prompt to install openvpnfunction \_prompt\_install\_openvpn() { \_install\_log "Configure OpenVPN support" echo -n "Install OpenVPN and enable client configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_openvpn fi elif [ "$ovpn\_option" == 1 ]; then \_install\_openvpn else echo "(Skipped)" fi}
# Prompt to install WireGuardfunction \_prompt\_install\_wireguard() { if [ "$insiders" == 1 ]; then \_install\_log "Configure WireGuard support" echo -n "Install WireGuard and enable VPN tunnel configuration? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_install\_wireguard fi elif [ "$wg\_option" == 1 ]; then \_install\_wireguard else echo "(Skipped)" fi fi}
# Install Wireguard from the Debian unstable distrofunction \_install\_wireguard() { \_install\_log "Configure WireGuard support" if [ "$OS" == "Debian" ]; then echo 'deb http://ftp.debian.org/debian buster-backports main' | sudo tee /etc/apt/sources.list.d/buster-backports.list || \_install\_status 1 "Unable to add Debian backports repo" fi echo "Installing wireguard from apt" sudo apt-get update && sudo apt-get install $apt\_option wireguard || \_install\_status 1 "Unable to install wireguard" echo "Enabling wg-quick@wg0" sudo systemctl enable wg-quick@wg0 || \_install\_status 1 "Failed to enable wg-quick service" echo "Enabling WireGuard management option" sudo sed -i "s/\('RASPI\_WIREGUARD\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" \_install\_status 0}
# Install openvpn and enable client configuration optionfunction \_install\_openvpn() { \_install\_log "Installing OpenVPN and enabling client configuration" echo "Adding packages via apt-get" sudo apt-get install -y openvpn || \_install\_status 1 "Unable to install openvpn" sudo sed -i "s/\('RASPI\_OPENVPN\_ENABLED', \)false/\1true/g" "$webroot\_dir/includes/config.php" || \_install\_status 1 "Unable to modify config.php" echo "Enabling openvpn-client service on boot" sudo systemctl enable openvpn-client@client || \_install\_status 1 "Unable to enable openvpn-client daemon" \_create\_openvpn\_scripts || \_install\_status 1 "Unable to create openvpn control scripts"}
# Generate openvpn logging and auth control scriptsfunction \_create\_openvpn\_scripts() { \_install\_log "Creating OpenVPN control scripts" sudo mkdir $raspap\_dir/openvpn || \_install\_status 1 "Unable to create directory '$raspap\_dir/openvpn'"
 # Move service auth control & logging shell scripts sudo cp "$webroot\_dir/installers/"configauth.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move auth control script" sudo cp "$webroot\_dir/installers/"openvpnlog.sh "$raspap\_dir/openvpn" || \_install\_status 1 "Unable to move logging script" # Make scripts executable by www-data group sudo chown -c root:"$raspap\_user" "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable change owner and/or group" sudo chmod 750 "$raspap\_dir/openvpn/"\*.sh || \_install\_status 1 "Unable to change file permissions" \_install\_status 0}
# Fetches latest files from github to webrootfunction \_download\_latest\_files() { if [ ! -d "$webroot\_dir" ]; then sudo mkdir -p $webroot\_dir || \_install\_status 1 "Unable to create new webroot directory" fi
 if [ -d "$webroot\_dir" ]; then sudo mv $webroot\_dir "$webroot\_dir.`date +%F-%R`" || \_install\_status 1 "Unable to remove old webroot directory" fi
 \_install\_log "Cloning latest files from github" git clone --branch $branch --depth 1 -c advice.detachedHead=false $git\_source\_url /tmp/raspap-webgui || \_install\_status 1 "Unable to download files from github"
 sudo mv /tmp/raspap-webgui $webroot\_dir || \_install\_status 1 "Unable to move raspap-webgui to web root" if [ "$upgrade" == 1 ]; then \_install\_log "Applying existing configuration to ${webroot\_dir}/includes" sudo mv /tmp/config.php $webroot\_dir/includes || \_install\_status 1 "Unable to move config.php to ${webroot\_dir}/includes" fi
 \_install\_status 0}
# Sets files ownership in web root directoryfunction \_change\_file\_ownership() { if [ ! -d "$webroot\_dir" ]; then \_install\_status 1 "Web root directory doesn't exist" fi
 \_install\_log "Changing file ownership in web root directory" sudo chown -R $raspap\_user:$raspap\_user "$webroot\_dir" || \_install\_status 1 "Unable to change file ownership for '$webroot\_dir'"}
# Check for existing configuration filesfunction \_check\_for\_old\_configs() { if [ "$upgrade" == 1 ]; then \_install\_log "Moving existing configuration to /tmp" sudo mv $webroot\_dir/includes/config.php /tmp || \_install\_status 1 "Unable to move config.php to /tmp" else \_install\_log "Backing up existing configs to ${raspap\_dir}/backups" if [ -f /etc/network/interfaces ]; then sudo cp /etc/network/interfaces "$raspap\_dir/backups/interfaces.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/interfaces.`date +%F-%R`" "$raspap\_dir/backups/interfaces" fi
 if [ -f /etc/hostapd/hostapd.conf ]; then sudo cp /etc/hostapd/hostapd.conf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/hostapd.conf.`date +%F-%R`" "$raspap\_dir/backups/hostapd.conf" fi
 if [ -f $raspap\_default ]; then sudo cp $raspap\_default "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_raspap.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_raspap.conf" fi
 if [ -f $raspap\_wlan0 ]; then sudo cp $raspap\_wlan0 "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/090\_wlan0.conf.`date +%F-%R`" "$raspap\_dir/backups/090\_wlan0.conf" fi
 if [ -f /etc/dhcpcd.conf ]; then sudo cp /etc/dhcpcd.conf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" sudo ln -sf "$raspap\_dir/backups/dhcpcd.conf.`date +%F-%R`" "$raspap\_dir/backups/dhcpcd.conf" fi
 for file in /etc/systemd/network/raspap-\*.net\*; do if [ -f "${file}" ]; then filename=$(basename $file) sudo cp "$file" "${raspap\_dir}/backups/${filename}.`date +%F-%R`" sudo ln -sf "${raspap\_dir}/backups/${filename}.`date +%F-%R`" "${raspap\_dir}/backups/${filename}" fi done fi \_install\_status 0}
# Move configuration file to the correct locationfunction \_move\_config\_file() { if [ ! -d "$raspap\_dir" ]; then \_install\_status 1 "'$raspap\_dir' directory doesn't exist" fi
 \_install\_log "Moving configuration file to $raspap\_dir" sudo cp "$webroot\_dir"/raspap.php "$raspap\_dir" || \_install\_status 1 "Unable to move files to '$raspap\_dir'" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"}
# Set up default configurationfunction \_default\_configuration() { if [ "$upgrade" == 0 ]; then \_install\_log "Applying default configuration to installed services"
 sudo cp $webroot\_dir/config/hostapd.conf /etc/hostapd/hostapd.conf || \_install\_status 1 "Unable to move hostapd configuration file" sudo cp $webroot\_dir/config/090\_raspap.conf $raspap\_default || \_install\_status 1 "Unable to move dnsmasq default configuration file" sudo cp $webroot\_dir/config/090\_wlan0.conf $raspap\_wlan0 || \_install\_status 1 "Unable to move dnsmasq wlan0 configuration file" sudo cp $webroot\_dir/config/dhcpcd.conf /etc/dhcpcd.conf || \_install\_status 1 "Unable to move dhcpcd configuration file" sudo cp $webroot\_dir/config/defaults.json $raspap\_network || \_install\_status 1 "Unable to move defaults.json settings"
 echo "Changing file ownership of $raspap\_dir" sudo chown -R $raspap\_user:$raspap\_user "$raspap\_dir" || \_install\_status 1 "Unable to change file ownership for '$raspap\_dir'"
 echo "Checking for existence of /etc/dnsmasq.d" [ -d /etc/dnsmasq.d ] || sudo mkdir /etc/dnsmasq.d
 echo "Copying bridged AP config to /etc/systemd/network" sudo systemctl stop systemd-networkd sudo systemctl disable systemd-networkd sudo cp $webroot\_dir/config/raspap-bridge-br0.netdev /etc/systemd/network/raspap-bridge-br0.netdev || \_install\_status 1 "Unable to move br0 netdev file" sudo cp $webroot\_dir/config/raspap-br0-member-eth0.network /etc/systemd/network/raspap-br0-member-eth0.network || \_install\_status 1 "Unable to move br0 member file"
 echo "Copying primary RaspAP config to includes/config.php" if [ ! -f "$webroot\_dir/includes/config.php" ]; then sudo cp "$webroot\_dir/config/config.php" "$webroot\_dir/includes/config.php" fi \_install\_status 0 fi}
# Install and enable RaspAP daemonfunction \_enable\_raspap\_daemon() { \_install\_log "Enabling RaspAP daemon" echo "Disable with: sudo systemctl disable raspapd.service" sudo cp $webroot\_dir/installers/raspapd.service /lib/systemd/system/ || \_install\_status 1 "Unable to move raspap.service file" sudo systemctl daemon-reload sudo systemctl enable raspapd.service || \_install\_status 1 "Failed to enable raspap.service"}
# Configure IP forwarding, set IP tables rules, prompt to install RaspAP daemonfunction \_configure\_networking() { \_install\_log "Configuring networking" echo "Enabling IP forwarding" echo "net.ipv4.ip\_forward=1" | sudo tee $raspap\_sysctl > /dev/null || \_install\_status 1 "Unable to set IP forwarding" sudo sysctl -p $raspap\_sysctl || \_install\_status 1 "Unable to execute sysctl" sudo /etc/init.d/procps restart || \_install\_status 1 "Unable to execute procps"
 echo "Checking iptables rules" rules=( "-A POSTROUTING -j MASQUERADE" "-A POSTROUTING -s 192.168.50.0/24 ! -d 192.168.50.0/24 -j MASQUERADE" ) for rule in "${rules[@]}"; do if grep -- "$rule" $rulesv4 > /dev/null; then echo "Rule already exits: ${rule}" else rule=$(sed -e 's/^\(-A POSTROUTING\)/-t nat \1/' <<< $rule) echo "Adding rule: ${rule}" sudo iptables $rule || \_install\_status 1 "Unable to execute iptables" added=true fi done # Persist rules if added if [ "$added" = true ]; then echo "Persisting IP tables rules" sudo iptables-save | sudo tee $rulesv4 > /dev/null || \_install\_status 1 "Unable to execute iptables-save" fi
 # Prompt to install RaspAP daemon echo -n "Enable RaspAP control service (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else \_enable\_raspap\_daemon fi else echo -e \_enable\_raspap\_daemon fi \_install\_status 0 }
# Add sudoers file to /etc/sudoers.d/ and set file permissionsfunction \_patch\_system\_files() {
 # Create sudoers if not present if [ ! -f $raspap\_sudoers ]; then \_install\_log "Adding raspap.sudoers to ${raspap\_sudoers}" sudo cp "$webroot\_dir/installers/raspap.sudoers" $raspap\_sudoers || \_install\_status 1 "Unable to apply raspap.sudoers to $raspap\_sudoers" sudo chmod 0440 $raspap\_sudoers || \_install\_status 1 "Unable to change file permissions for $raspap\_sudoers" fi
 # Add symlink to prevent wpa\_cli cmds from breaking with multiple wlan interfaces \_install\_log "Symlinked wpa\_supplicant hooks for multiple wlan interfaces" if [ ! -f /usr/share/dhcpcd/hooks/10-wpa\_supplicant ]; then sudo ln -s /usr/share/dhcpcd/hooks/10-wpa\_supplicant /etc/dhcp/dhclient-enter-hooks.d/ fi
 # Unmask and enable hostapd.service \_install\_log "Unmasking and enabling hostapd service" sudo systemctl unmask hostapd.service sudo systemctl enable hostapd.service \_install\_status 0}
# Optimize configuration of php-cgi.function \_optimize\_php() { if [ "$upgrade" == 0 ]; then \_install\_log "Optimize PHP configuration" if [ ! -f "$phpcgiconf" ]; then \_install\_warning "PHP configuration could not be found." return fi
 # Backup php.ini and create symlink for restoring. datetimephpconf=$(date +%F-%R) sudo cp "$phpcgiconf" "$raspap\_dir/backups/php.ini.$datetimephpconf" sudo ln -sf "$raspap\_dir/backups/php.ini.$datetimephpconf" "$raspap\_dir/backups/php.ini"
 echo -n "Enable HttpOnly for session cookies (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_session\_cookie=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$php\_session\_cookie" == 1 ]; then echo "Php-cgi enabling session.cookie\_httponly." sudo sed -i -E 's/^session\.cookie\_httponly\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/session.cookie\_httponly = 1/' "$phpcgiconf" fi
 if [ "$php\_package" = "php7.1-cgi" ]; then echo -n "Enable PHP OPCache (Recommended)? [Y/n]: " if [ "$assume\_yes" == 0 ]; then read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo -e else php\_opcache=1; fi fi
 if [ "$assume\_yes" == 1 ] || [ "$phpopcache" == 1 ]; then echo -e "Php-cgi enabling opcache.enable." sudo sed -i -E 's/^;?opcache\.enable\s\*=\s\*(0|([O|o]ff)|([F|f]alse)|([N|n]o))\s\*$/opcache.enable = 1/' "$phpcgiconf" # Make sure opcache extension is turned on. if [ -f "/usr/sbin/phpenmod" ]; then sudo phpenmod opcache else \_install\_status 2 "phpenmod not found." fi fi fi fi}
function \_install\_complete() { \_install\_log "Installation completed" echo "Join RaspAP Insiders for early access to exclusive features!" echo -e "${ANSI\_RASPBERRY}" echo "> https://docs.raspap.com/insiders/" echo "> https://github.com/sponsors/RaspAP/" echo -e "${ANSI\_RESET}" if [ "$assume\_yes" == 0 ]; then # Prompt to reboot if wired ethernet (eth0) is connected. # With default\_configuration this will create an active AP on restart. if ip a | grep -q ': eth0:.\*state UP'; then echo -n "The system needs to be rebooted as a final step. Reboot now? [y/N]: " read answer < /dev/tty if [ "$answer" != "${answer#[Nn]}" ]; then echo "Installation reboot aborted." exit 0 fi sudo shutdown -r now || \_install\_status 1 "Unable to execute shutdown" fi fi}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


