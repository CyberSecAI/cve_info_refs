=== Content from sites.google.com_c4428b32_20250115_095540.html ===
Search this siteEmbedded FilesSkip to main contentSkip to navigation[![](https://lh4.googleusercontent.com/GcyZPFmLcupvmM-jq5Zia9_nSAVXkgt-I0da5hkFJJ2jnTl3ao6gJbWVEuHER0td-342ZCxmSJEY6zROooVhWw=w16383)](/view/syzscope/home)[SyzScope](/view/syzscope/home)

* [Home](/view/syzscope/home)
* [About SyzScope](/view/syzscope/about-syzscope)
[![](https://lh4.googleusercontent.com/GcyZPFmLcupvmM-jq5Zia9_nSAVXkgt-I0da5hkFJJ2jnTl3ao6gJbWVEuHER0td-342ZCxmSJEY6zROooVhWw=w16383)SyzScope](/view/syzscope/home)
# KASAN: use-after-free Read in cipso\_v4\_genopt

Original report of the bug: <https://syzkaller.appspot.com/bug?id=96e7d345748d8814901c91cd92084ed04b46701e>

From our analysis, we find that it can lead to 1 constrained address write.

Fuzzer tested kernel version: [7a7fd0de](https://www.google.com/url?q=https%3A%2F%2Fgit.kernel.org%2Fpub%2Fscm%2Flinux%2Fkernel%2Fgit%2Ftorvalds%2Flinux.git%2Flog%2F%3Fid%3D7a7fd0de4a9804299793e564a555a49c1fc924cb&sa=D&sntz=1&usg=AOvVaw3WJDCryqJa0m0VZ39PKrqq)

Upstream patch: [cipso,calipso: resolve a number of problems with the DOI refcounts](https://www.google.com/url?q=https%3A%2F%2Fgit.kernel.org%2Fpub%2Fscm%2Flinux%2Fkernel%2Fgit%2Ftorvalds%2Flinux.git%2Fcommit%2F%3Fid%3Dad5d07f4a9cd671233ae20983848874731102c08&sa=D&sntz=1&usg=AOvVaw174jkH6G1n45heI81Ocxtd) and [net: mac802154: Fix general protection fault](https://www.google.com/url?q=https%3A%2F%2Fgit.kernel.org%2Fpub%2Fscm%2Flinux%2Fkernel%2Fgit%2Ftorvalds%2Flinux.git%2Fcommit%2F%3Fid%3D1165affd484889d4986cf3b724318935a0b120d8&sa=D&sntz=1&usg=AOvVaw0Oyc7j8d1Z-ifWPODWPKTl)

## Primitive 1: Constrained address write in netlbl\_bitmap\_setbit

### Bug impact analysis:

doi\_def was freed but still used in cipso\_v4\_genopt

switch (doi\_def->tags[**iter**]) { // doi\_def was freed, thus it triggered the UAF read which was initially caught by syzbot/syzkaller

 case **CIPSO\_V4\_TAG\_RBITMAP**:

 ret\_val = **cipso\_v4\_gentag\_rbm**(doi\_def, // doi\_def was freed, and got passed to cipso\_v4\_gentag\_rbm

 secattr,

 &buf[**CIPSO\_V4\_HDR\_LEN**],

 buf\_len - **CIPSO\_V4\_HDR\_LEN**);

 break;

*cipso\_v4\_gentag\_rbm* passed *doi\_def* to *cipso\_v4\_map\_cat\_rbm\_hton*

static int **cipso\_v4\_gentag\_rbm**(const struct **cipso\_v4\_doi** \*doi\_def,

 const struct **netlbl\_lsm\_secattr** \*secattr,

 unsigned char \*buffer,

 **u32** buffer\_len)

{

...

 if (secattr->flags & **NETLBL\_SECATTR\_MLS\_CAT**) {

 ret\_val = **cipso\_v4\_map\_cat\_rbm\_hton**(doi\_def, // doi\_def was freed, and got passed to cipso\_v4\_map\_lvl\_hton

 secattr,

 &buffer[4],

 buffer\_len - 4);

...

}

Note that *doi\_def* was freed, *host\_cat\_array* can point to any address. Furthermore, elements in *host\_cat\_array* can also take potentially any arbitrary value

static int **cipso\_v4\_map\_cat\_rbm\_hton**(const struct **cipso\_v4\_doi** \*doi\_def,

 const struct **netlbl\_lsm\_secattr** \*secattr,

 unsigned char \*net\_cat,

 **u32** net\_cat\_len)

{

 ...

 **u32** \*host\_cat\_array = **NULL**;

 if (doi\_def->type == **CIPSO\_V4\_MAP\_TRANS**) {

 **host\_cat\_size** = doi\_def->map.std->cat.local\_size;

 host\_cat\_array = doi\_def->map.std->cat.local; // An arbitrary value write happened here

 }

 for (;;) {

 ...

 switch (doi\_def->type) {

 case **CIPSO\_V4\_MAP\_TRANS**:

 ...

 **net\_spot** = host\_cat\_array[host\_spot]; // net\_spot can also be an arbitrary value

 ...

 break;

 }

 ...

 **netlbl\_bitmap\_setbit**(net\_cat, **net\_spot**, 1); // net\_spot passed to netlbl\_bitmap\_setbit

 ...

 }

 ...

}

By controlling *bit*, we can control the index of *bitmap*, which means we can determine how far the write can be (causing OOB memory access)

void **netlbl\_bitmap\_setbit**(unsigned char \*bitmap, **u32** bit, u8 state)

{

 **u32** **byte\_spot**;

 u8 bitmask;

 **byte\_spot** = bit / 8; // bit is an arbitrary value, therefore we can control byte\_spot

 bitmask = 0x80 >> (bit % 8);

 if (state)

 bitmap[**byte\_spot**] |= bitmask; // The write can be out-of-bounds as byte\_spot is controlled, the address range where the write can happen is [bitmap, bitmap+536870912]

 else

 bitmap[**byte\_spot**] &= ~bitmask; // The write can be out-of-bounds by byte\_spot is controlled, the address range where the write can happen is [bitmap, bitmap+536870912]

}

### Trace in high level:

|cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1784 (Triggered the UAF read bug)

|netlbl\_bitmap\_setbit net/ipv4/cipso\_ipv4.c:829

|netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:930 (Triggered a new impact: Constrained address write)

### Trace in detail:

0xffffffff85327b63

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1784 (Triggered the UAF read bug)

--------------------------------------

0xffffffff85327b75

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1784

--------------------------------------

0xffffffff85327b7e

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1784

--------------------------------------

0xffffffff85327b84

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1784

--------------------------------------

0xffffffff85327e81

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1786

--------------------------------------

0xffffffff85327e86

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1786

--------------------------------------

0xffffffff85327e8e

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1786

--------------------------------------

0xffffffff85327ea3

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1786

--------------------------------------

0xffffffff85327eac

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1194

--------------------------------------

0xffffffff85327eb1

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1194

--------------------------------------

0xffffffff85327ebd

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1194

--------------------------------------

0xffffffff85327ed3

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:681

--------------------------------------

0xffffffff85327eec

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:681

--------------------------------------

0xffffffff853281ef

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1814

--------------------------------------

0xffffffff853281f4

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1814

--------------------------------------

0xffffffff85328204

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1814

--------------------------------------

0xffffffff85328212

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff85328225

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff8532822e

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff85328233

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff8532823d

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff85328254

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff85328269

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:686

--------------------------------------

0xffffffff85328272

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1200

--------------------------------------

0xffffffff85328277

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1200

--------------------------------------

0xffffffff85328283

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1200

--------------------------------------

0xffffffff8532828b

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1201

--------------------------------------

0xffffffff85328290

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:1201

--------------------------------------

0xffffffff853282a7

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:805

--------------------------------------

0xffffffff853282b1

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:805

--------------------------------------

0xffffffff853282c6

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:806

--------------------------------------

0xffffffff853280a9

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:804

--------------------------------------

0xffffffff85328118

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:810

--------------------------------------

0xffffffff8532811d

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:810

--------------------------------------

0xffffffff8532812d

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:810

--------------------------------------

0xffffffff85c25c80

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:615

--------------------------------------

0xffffffff85c25c98

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:562

--------------------------------------

0xffffffff85c25c9d

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25ca2

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25caa

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25cb9

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25cbe

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25cc3

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25cd9

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25cde

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25cf3

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:564

--------------------------------------

0xffffffff85c25d2a

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:618

--------------------------------------

0xffffffff85c25d2f

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:618

--------------------------------------

0xffffffff85c25d3a

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:618

--------------------------------------

0xffffffff85c25d43

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:618

--------------------------------------

0xffffffff85c25d4d

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:626

--------------------------------------

0xffffffff85c25d59

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:626

--------------------------------------

0xffffffff85c25d63

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:626

--------------------------------------

0xffffffff85c25d78

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:629

--------------------------------------

0xffffffff85c25df8

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25dfd

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25e0b

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25e1c

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25dff

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:631

--------------------------------------

0xffffffff85c25e04

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:631

--------------------------------------

0xffffffff85c25e1c

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25dff

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:631

--------------------------------------

0xffffffff85c25e04

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:631

--------------------------------------

0xffffffff85c25e1c

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25dff

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:631

--------------------------------------

0xffffffff85c25e04

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:631

--------------------------------------

0xffffffff85c25e1c

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:630

--------------------------------------

0xffffffff85c25e21

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:634

--------------------------------------

0xffffffff85c25e26

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:634

--------------------------------------

0xffffffff85c25d17

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:566

--------------------------------------

0xffffffff85c25d1c

netlbl\_catmap\_walk net/netlabel/netlabel\_kapi.c:566

--------------------------------------

0xffffffff85328139

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:810

--------------------------------------

0xffffffff85328144

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:812

--------------------------------------

0xffffffff8532814c

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:815

--------------------------------------

0xffffffff85328151

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:815

--------------------------------------

0xffffffff8532815d

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:815

--------------------------------------

0xffffffff85328176

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:815

--------------------------------------

0xffffffff85328180

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:820

--------------------------------------

0xffffffff85328185

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:820

--------------------------------------

0xffffffff85328196

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:820

--------------------------------------

0xffffffff8532819b

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:822

--------------------------------------

0xffffffff853281a0

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:822

--------------------------------------

0xffffffff853281b6

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:822

--------------------------------------

0xffffffff853281c4

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:823

--------------------------------------

0xffffffff853280d9

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:827

--------------------------------------

0xffffffff853280de

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:827

--------------------------------------

0xffffffff853280eb

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:827

--------------------------------------

0xffffffff853280f8

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:829

--------------------------------------

0xffffffff853280fd

cipso\_v4\_genopt net/ipv4/cipso\_ipv4.c:829

--------------------------------------

0xffffffff85c258b0

netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:927

--------------------------------------

0xffffffff85c258ce

netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:928

--------------------------------------

0xffffffff85c258e4

netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:929

--------------------------------------

0xffffffff85c258f2

netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:929

--------------------------------------

0xffffffff85c258f7

netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:930

--------------------------------------

0xffffffff85c258fc

netlbl\_bitmap\_setbit net/netlabel/netlabel\_kapi.c:930 (Triggered a new impact: Constrained address write)

--------------------------------------

Total 159 basic block

[Email] | [Address] | [Phone number]

Google SitesReport abusePage detailsPage updated Google SitesReport abuseThis site uses cookies from Google to deliver its services and to analyze traffic. Information about your use of this site is shared with Google. By clicking "accept", you agree to its use of cookies. [Cookie Policy](https://www.google.com/policies/technologies/cookies/)RejectAccept

=== Content from git.kernel.org_64ed5b01_20250115_095539.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=1165affd484889d4986cf3b724318935a0b120d8)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=1165affd484889d4986cf3b724318935a0b120d8)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1165affd484889d4986cf3b724318935a0b120d8)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1165affd484889d4986cf3b724318935a0b120d8)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-03-04 18:21:25 +0300 |
| --- | --- | --- |
| committer | Stefan Schmidt <stefan@datenfreihafen.org> | 2021-04-06 22:42:16 +0200 |
| commit | [1165affd484889d4986cf3b724318935a0b120d8](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1165affd484889d4986cf3b724318935a0b120d8) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=1165affd484889d4986cf3b724318935a0b120d8)) | |
| tree | [e0ed291da12a632c5b04ed6afb43aa13de8966d6](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=1165affd484889d4986cf3b724318935a0b120d8) | |
| parent | [1534efc7bbc1121e92c86c2dabebaf2c9dcece19](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1534efc7bbc1121e92c86c2dabebaf2c9dcece19) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1165affd484889d4986cf3b724318935a0b120d8&id2=1534efc7bbc1121e92c86c2dabebaf2c9dcece19)) | |
| download | [linux-1165affd484889d4986cf3b724318935a0b120d8.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-1165affd484889d4986cf3b724318935a0b120d8.tar.gz) | |

net: mac802154: Fix general protection faultsyzbot found general protection fault in crypto\_destroy\_tfm()[1].
It was caused by wrong clean up loop in llsec\_key\_alloc().
If one of the tfm array members is in IS\_ERR() range it will
cause general protection fault in clean up function [1].
Call Trace:
crypto\_free\_aead include/crypto/aead.h:191 [inline] [1]
llsec\_key\_alloc net/mac802154/llsec.c:156 [inline]
mac802154\_llsec\_key\_add+0x9e0/0xcc0 net/mac802154/llsec.c:249
ieee802154\_add\_llsec\_key+0x56/0x80 net/mac802154/cfg.c:338
rdev\_add\_llsec\_key net/ieee802154/rdev-ops.h:260 [inline]
nl802154\_add\_llsec\_key+0x3d3/0x560 net/ieee802154/nl802154.c:1584
genl\_family\_rcv\_msg\_doit+0x228/0x320 net/netlink/genetlink.c:739
genl\_family\_rcv\_msg net/netlink/genetlink.c:783 [inline]
genl\_rcv\_msg+0x328/0x580 net/netlink/genetlink.c:800
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2502
genl\_rcv+0x24/0x40 net/netlink/genetlink.c:811
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Reported-by: syzbot+9ec037722d2603a9f52e@syzkaller.appspotmail.com
Acked-by: Alexander Aring <aahringo@redhat.com>
Link: [https://lore.kernel.org/r/20210304152125.1052825-1-paskripkin@gmail.com](https://lore.kernel.org/r/20210304152125.1052825-1-paskripkin%40gmail.com)
Signed-off-by: Stefan Schmidt <stefan@datenfreihafen.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1165affd484889d4986cf3b724318935a0b120d8)

| -rw-r--r-- | [net/mac802154/llsec.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/mac802154/llsec.c?id=1165affd484889d4986cf3b724318935a0b120d8) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/mac802154/llsec.c b/net/mac802154/llsec.cindex 585d33144c33f8..55550ead2ced8c 100644--- a/[net/mac802154/llsec.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/mac802154/llsec.c?id=1534efc7bbc1121e92c86c2dabebaf2c9dcece19)+++ b/[net/mac802154/llsec.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/mac802154/llsec.c?id=1165affd484889d4986cf3b724318935a0b120d8)@@ -152,7 +152,7 @@ err\_tfm0: crypto\_free\_sync\_skcipher(key->tfm0); err\_tfm: for (i = 0; i < ARRAY\_SIZE(key->tfm); i++)- if (key->tfm[i])+ if (!IS\_ERR\_OR\_NULL(key->tfm[i])) crypto\_free\_aead(key->tfm[i]);  kfree\_sensitive(key); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:54:16 +0000



=== Content from cdn.kernel.org_fc67a234_20250115_095523.html ===
commit dfe7059bf16bca04a2d68a6381fe959cda58b8a5
Author: Greg Kroah-Hartman
Date: Wed Apr 14 08:47:26 2021 +0200
Linux 5.11.14
Tested-by: Jon Hunter
Tested-by: Jason Self
Tested-by: Shuah Khan
Tested-by: Guenter Roeck
Tested-by: Linux Kernel Functional Testing
Link: https://lore.kernel.org/r/20210412084016.009884719@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit dfbf7440e38c39592fcf5e2147a6685abe4e38cb
Author: Vlad Buslov
Date: Wed Apr 7 18:36:02 2021 +0300
Revert "net: sched: bump refcount for new action in ACT replace mode"
commit 4ba86128ba077fbb7d86516ae24ed642e6c3adef upstream.
This reverts commit 6855e8213e06efcaf7c02a15e12b1ae64b9a7149.
Following commit in series fixes the issue without introducing regression
in error rollback of tcf\_action\_destroy().
Signed-off-by: Vlad Buslov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ea8895e370e8facd4420d99f5f3ad48c87aa35a9
Author: Alexander Aring
Date: Sun Apr 4 20:30:54 2021 -0400
net: ieee802154: stop dump llsec params for monitors
commit 1534efc7bbc1121e92c86c2dabebaf2c9dcece19 upstream.
This patch stops dumping llsec params for monitors which we don't support
yet. Otherwise we will access llsec mib which isn't initialized for
monitors.
Reported-by: syzbot+cde43a581a8e5f317bc2@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210405003054.256017-16-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 8e22301b6f0e70befe25dac612fe19c3ea7efb70
Author: Alexander Aring
Date: Sun Apr 4 20:30:53 2021 -0400
net: ieee802154: forbid monitor for del llsec seclevel
commit 9dde130937e95b72adfae64ab21d6e7e707e2dac upstream.
This patch forbids to del llsec seclevel for monitor interfaces which we
don't support yet. Otherwise we will access llsec mib which isn't
initialized for monitors.
Reported-by: syzbot+fbf4fc11a819824e027b@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210405003054.256017-15-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 77c15dde1ccb34a4dad9c344362d9372ea902666
Author: Alexander Aring
Date: Sun Apr 4 20:30:41 2021 -0400
net: ieee802154: forbid monitor for set llsec params
commit 88c17855ac4291fb462e13a86b7516773b6c932e upstream.
This patch forbids to set llsec params for monitor interfaces which we
don't support yet.
Reported-by: syzbot+8b6719da8a04beeafcc3@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210405003054.256017-3-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 7c1f54ad35fde94e6fabfcce3d931deb6fcc7e25
Author: Alexander Aring
Date: Sun Feb 21 12:43:21 2021 -0500
net: ieee802154: fix nl802154 del llsec devkey
commit 27c746869e1a135dffc2f2a80715bb7aa00445b4 upstream.
This patch fixes a nullpointer dereference if NL802154\_ATTR\_SEC\_DEVKEY is
not set by the user. If this is the case nl802154 will return -EINVAL.
Reported-by: syzbot+368672e0da240db53b5f@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210221174321.14210-4-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit bdf8a7c207feb4e5af7cabcbf3c5dceab43b2ff5
Author: Alexander Aring
Date: Sun Feb 21 12:43:20 2021 -0500
net: ieee802154: fix nl802154 add llsec key
commit 20d5fe2d7103f5c43ad11a3d6d259e9d61165c35 upstream.
This patch fixes a nullpointer dereference if NL802154\_ATTR\_SEC\_KEY is
not set by the user. If this is the case nl802154 will return -EINVAL.
Reported-by: syzbot+ce4e062c2d51977ddc50@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210221174321.14210-3-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 0a965b0b6352f18face21d6c564a6b489b94c8cc
Author: Alexander Aring
Date: Sun Feb 21 12:43:19 2021 -0500
net: ieee802154: fix nl802154 del llsec dev
commit 3d1eac2f45585690d942cf47fd7fbd04093ebd1b upstream.
This patch fixes a nullpointer dereference if NL802154\_ATTR\_SEC\_DEVICE is
not set by the user. If this is the case nl802154 will return -EINVAL.
Reported-by: syzbot+d946223c2e751d136c94@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210221174321.14210-2-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 2bfa1f18d83c88f5d4297873c9b9f3f474dae561
Author: Alexander Aring
Date: Sun Feb 21 12:43:18 2021 -0500
net: ieee802154: fix nl802154 del llsec key
commit 37feaaf5ceb2245e474369312bb7b922ce7bce69 upstream.
This patch fixes a nullpointer dereference if NL802154\_ATTR\_SEC\_KEY is
not set by the user. If this is the case nl802154 will return -EINVAL.
Reported-by: syzbot+ac5c11d2959a8b3c4806@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210221174321.14210-1-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit baf5e98edb8bfb07b8d9fa8fd45f6813e77f58c9
Author: Alexander Aring
Date: Sun Feb 28 10:18:03 2021 -0500
net: ieee802154: nl-mac: fix check on panid
commit 6f7f657f24405f426212c09260bf7fe8a52cef33 upstream.
This patch fixes a null pointer derefence for panid handle by move the
check for the netlink variable directly before accessing them.
Reported-by: syzbot+d4c07de0144f6f63be3a@syzkaller.appspotmail.com
Signed-off-by: Alexander Aring
Link: https://lore.kernel.org/r/20210228151817.95700-4-aahringo@redhat.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 743c9072afafd1919b41ae319044513ed014a58f
Author: Pavel Skripkin
Date: Thu Mar 4 18:21:25 2021 +0300
net: mac802154: Fix general protection fault
commit 1165affd484889d4986cf3b724318935a0b120d8 upstream.
syzbot found general protection fault in crypto\_destroy\_tfm()[1].
It was caused by wrong clean up loop in llsec\_key\_alloc().
If one of the tfm array members is in IS\_ERR() range it will
cause general protection fault in clean up function [1].
Call Trace:
crypto\_free\_aead include/crypto/aead.h:191 [inline] [1]
llsec\_key\_alloc net/mac802154/llsec.c:156 [inline]
mac802154\_llsec\_key\_add+0x9e0/0xcc0 net/mac802154/llsec.c:249
ieee802154\_add\_llsec\_key+0x56/0x80 net/mac802154/cfg.c:338
rdev\_add\_llsec\_key net/ieee802154/rdev-ops.h:260 [inline]
nl802154\_add\_llsec\_key+0x3d3/0x560 net/ieee802154/nl802154.c:1584
genl\_family\_rcv\_msg\_doit+0x228/0x320 net/netlink/genetlink.c:739
genl\_family\_rcv\_msg net/netlink/genetlink.c:783 [inline]
genl\_rcv\_msg+0x328/0x580 net/netlink/genetlink.c:800
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2502
genl\_rcv+0x24/0x40 net/netlink/genetlink.c:811
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Signed-off-by: Pavel Skripkin
Reported-by: syzbot+9ec037722d2603a9f52e@syzkaller.appspotmail.com
Acked-by: Alexander Aring
Link: https://lore.kernel.org/r/20210304152125.1052825-1-paskripkin@gmail.com
Signed-off-by: Stefan Schmidt
Signed-off-by: Greg Kroah-Hartman
commit 37b26be74c5f3e58baadeb1fccba4ff0328a2a1c
Author: Pavel Skripkin
Date: Thu Apr 1 16:27:52 2021 +0300
drivers: net: fix memory leak in peak\_usb\_create\_dev
commit a0b96b4a62745397aee662670cfc2157bac03f55 upstream.
syzbot reported memory leak in peak\_usb.
The problem was in case of failure after calling
->dev\_init()[2] in peak\_usb\_create\_dev()[1]. The data
allocated int dev\_init() wasn't freed, so simple
->dev\_free() call fix this problem.
backtrace:
[<0000000079d6542a>] kmalloc include/linux/slab.h:552 [inline]
[<0000000079d6542a>] kzalloc include/linux/slab.h:682 [inline]
[<0000000079d6542a>] pcan\_usb\_fd\_init+0x156/0x210 drivers/net/can/usb/peak\_usb/pcan\_usb\_fd.c:868 [2]
[<00000000c09f9057>] peak\_usb\_create\_dev drivers/net/can/usb/peak\_usb/pcan\_usb\_core.c:851 [inline] [1]
[<00000000c09f9057>] peak\_usb\_probe+0x389/0x490 drivers/net/can/usb/peak\_usb/pcan\_usb\_core.c:949
Reported-by: syzbot+91adee8d9ebb9193d22d@syzkaller.appspotmail.com
Signed-off-by: Pavel Skripkin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a495430c96b52827b4c718efc383ff58d628559f
Author: Pavel Skripkin
Date: Thu Apr 1 07:46:24 2021 +0300
drivers: net: fix memory leak in atusb\_probe
commit 6b9fbe16955152626557ec6f439f3407b7769941 upstream.
syzbot reported memory leak in atusb\_probe()[1].
The problem was in atusb\_alloc\_urbs().
Since urb is anchored, we need to release the reference
to correctly free the urb
backtrace:
[] kmalloc include/linux/slab.h:559 [inline]
[] usb\_alloc\_urb+0x66/0xe0 drivers/usb/core/urb.c:74
[] atusb\_alloc\_urbs drivers/net/ieee802154/atusb.c:362 [inline][2]
[] atusb\_probe+0x158/0x820 drivers/net/ieee802154/atusb.c:1038 [1]
Reported-by: syzbot+28a246747e0a465127f3@syzkaller.appspotmail.com
Signed-off-by: Pavel Skripkin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a6c699baecd82917cda40b7bb82ffe93aae758d0
Author: Phillip Potter
Date: Tue Apr 6 18:45:54 2021 +0100
net: tun: set tun->dev->addr\_len during TUNSETLINK processing
commit cca8ea3b05c972ffb5295367e6c544369b45fbdd upstream.
When changing type with TUNSETLINK ioctl command, set tun->dev->addr\_len
to match the appropriate type, using new tun\_get\_addr\_len utility function
which returns appropriate address length for given type. Fixes a
KMSAN-found uninit-value bug reported by syzbot at:
https://syzkaller.appspot.com/bug?id=0766d38c656abeace60621896d705743aeefed51
Reported-by: syzbot+001516d86dbe88862cec@syzkaller.appspotmail.com
Diagnosed-by: Eric Dumazet
Signed-off-by: Phillip Potter
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 54436d4df9b0351a7042861312dc66b15ada03f9
Author: Du Cheng
Date: Thu Apr 8 00:27:56 2021 +0800
cfg80211: remove WARN\_ON() in cfg80211\_sme\_connect
commit 1b5ab825d9acc0f27d2f25c6252f3526832a9626 upstream.
A WARN\_ON(wdev->conn) would trigger in cfg80211\_sme\_connect(), if multiple
send\_msg(NL80211\_CMD\_CONNECT) system calls are made from the userland, which
should be anticipated and handled by the wireless driver. Remove this WARN\_ON()
to prevent kernel panic if kernel is configured to "panic\_on\_warn".
Bug reported by syzbot.
Reported-by: syzbot+5f9392825de654244975@syzkaller.appspotmail.com
Signed-off-by: Du Cheng
Link: https://lore.kernel.org/r/20210407162756.6101-1-ducheng2@gmail.com
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit ffa1a3ce6d401d25f1907ee752a3fa58ca4eab20
Author: Andy Shevchenko
Date: Fri Mar 5 14:02:40 2021 +0200
gpiolib: Read "gpio-line-names" from a firmware node
commit b41ba2ec54a70908067034f139aa23d0dd2985ce upstream.
On STM32MP1, the GPIO banks are subnodes of pin-controller@50002000,
see arch/arm/boot/dts/stm32mp151.dtsi. The driver for
pin-controller@50002000 is in drivers/pinctrl/stm32/pinctrl-stm32.c
and iterates over all of its DT subnodes when registering each GPIO
bank gpiochip. Each gpiochip has:
- gpio\_chip.parent = dev,
where dev is the device node of the pin controller
- gpio\_chip.of\_node = np,
which is the OF node of the GPIO bank
Therefore, dev\_fwnode(chip->parent) != of\_fwnode\_handle(chip.of\_node),
i.e. pin-controller@50002000 != pin-controller@50002000/gpio@5000\*000.
The original code behaved correctly, as it extracted the "gpio-line-names"
from of\_fwnode\_handle(chip.of\_node) = pin-controller@50002000/gpio@5000\*000.
To achieve the same behaviour, read property from the firmware node.
Fixes: 7cba1a4d5e162 ("gpiolib: generalize devprop\_gpiochip\_set\_names() for device properties")
Reported-by: Marek Vasut
Reported-by: Roman Guskov
Signed-off-by: Andy Shevchenko
Tested-by: Marek Vasut
Reviewed-by: Marek Vasut
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 73da7931fdde78c4c301b1ab3a91630ac9aa2f6d
Author: Thomas Tai
Date: Thu Apr 8 13:28:33 2021 -0400
x86/traps: Correct exc\_general\_protection() and math\_error() return paths
commit 632a1c209b8773cb0119fe3aada9f1db14fa357c upstream.
Commit
334872a09198 ("x86/traps: Attempt to fixup exceptions in vDSO before signaling")
added return statements which bypass calling cond\_local\_irq\_disable().
According to
ca4c6a9858c2 ("x86/traps: Make interrupt enable/disable symmetric in C code"),
cond\_local\_irq\_disable() is needed because the asm return code no longer
disables interrupts. Follow the existing code as an example to use "goto
exit" instead of "return" statement.
[ bp: Massage commit message. ]
Fixes: 334872a09198 ("x86/traps: Attempt to fixup exceptions in vDSO before signaling")
Signed-off-by: Thomas Tai
Signed-off-by: Borislav Petkov
Reviewed-by: Alexandre Chartre
Link: https://lkml.kernel.org/r/1617902914-83245-1-git-send-email-thomas.tai@oracle.com
Signed-off-by: Greg Kroah-Hartman
commit 8c6563a4b5c864fd2c27dc7dd2876fc6a6a55952
Author: Kumar Kartikeya Dwivedi
Date: Tue Mar 30 04:23:23 2021 +0530
net: sched: bump refcount for new action in ACT replace mode
commit 6855e8213e06efcaf7c02a15e12b1ae64b9a7149 upstream.
Currently, action creation using ACT API in replace mode is buggy.
When invoking for non-existent action index 42,
tc action replace action bpf obj foo.o sec  index 42
kernel creates the action, fills up the netlink response, and then just
deletes the action after notifying userspace.
tc action show action bpf
doesn't list the action.
This happens due to the following sequence when ovr = 1 (replace mode)
is enabled:
tcf\_idr\_check\_alloc is used to atomically check and either obtain
reference for existing action at index, or reserve the index slot using
a dummy entry (ERR\_PTR(-EBUSY)).
This is necessary as pointers to these actions will be held after
dropping the idrinfo lock, so bumping the reference count is necessary
as we need to insert the actions, and notify userspace by dumping their
attributes. Finally, we drop the reference we took using the
tcf\_action\_put\_many call in tcf\_action\_add. However, for the case where
a new action is created due to free index, its refcount remains one.
This when paired with the put\_many call leads to the kernel setting up
the action, notifying userspace of its creation, and then tearing it
down. For existing actions, the refcount is still held so they remain
unaffected.
Fortunately due to rtnl\_lock serialization requirement, such an action
with refcount == 1 will not be concurrently deleted by anything else, at
best CLS API can move its refcount up and down by binding to it after it
has been published from tcf\_idr\_insert\_many. Since refcount is atleast
one until put\_many call, CLS API cannot delete it. Also \_\_tcf\_action\_put
release path already ensures deterministic outcome (either new action
will be created or existing action will be reused in case CLS API tries
to bind to action concurrently) due to idr lock serialization.
We fix this by making refcount of newly created actions as 2 in ACT API
replace mode. A relaxed store will suffice as visibility is ensured only
after the tcf\_idr\_insert\_many call.
Note that in case of creation or overwriting using CLS API only (i.e.
bind = 1), overwriting existing action object is not allowed, and any
such request is silently ignored (without error).
The refcount bump that occurs in tcf\_idr\_check\_alloc call there for
existing action will pair with tcf\_exts\_destroy call made from the
owner module for the same action. In case of action creation, there
is no existing action, so no tcf\_exts\_destroy callback happens.
This means no code changes for CLS API.
Fixes: cae422f379f3 ("net: sched: use reference counting action init")
Signed-off-by: Kumar Kartikeya Dwivedi
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b8045fd3141088d684403ce43dde52f7b9ea9878
Author: Rafał Miłecki
Date: Mon Mar 29 16:03:17 2021 +0200
dt-bindings: net: ethernet-controller: fix typo in NVMEM
commit af9d316f3dd6d1385fbd1631b5103e620fc4298a upstream.
The correct property name is "nvmem-cell-names". This is what:
1. Was originally documented in the ethernet.txt
2. Is used in DTS files
3. Matches standard syntax for phandles
4. Linux net subsystem checks for
Fixes: 9d3de3c58347 ("dt-bindings: net: Add YAML schemas for the generic Ethernet options")
Signed-off-by: Rafał Miłecki
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fc1b68fad2030275fa6f4c49b0a79bc4c80328d7
Author: Arnd Bergmann
Date: Mon Mar 22 12:55:25 2021 +0100
lockdep: Address clang -Wformat warning printing for %hd
commit 6d48b7912cc72275dc7c59ff961c8bac7ef66a92 upstream.
Clang doesn't like format strings that truncate a 32-bit
value to something shorter:
kernel/locking/lockdep.c:709:4: error: format specifies type 'short' but the argument has type 'int' [-Werror,-Wformat]
In this case, the warning is a slightly questionable, as it could realize
that both class->wait\_type\_outer and class->wait\_type\_inner are in fact
8-bit struct members, even though the result of the ?: operator becomes an
'int'.
However, there is really no point in printing the number as a 16-bit
'short' rather than either an 8-bit or 32-bit number, so just change
it to a normal %d.
Fixes: de8f5e4f2dc1 ("lockdep: Introduce wait-type checks")
Signed-off-by: Arnd Bergmann
Signed-off-by: Ingo Molnar
Link: https://lore.kernel.org/r/20210322115531.3987555-1-arnd@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 460505d684e594f68786581786e2818e70a5b175
Author: Krzysztof Kozlowski
Date: Sun Mar 14 12:07:09 2021 +0100
clk: socfpga: fix iomem pointer cast on 64-bit
commit 2867b9746cef78745c594894aece6f8ef826e0b4 upstream.
Pointers should be cast with uintptr\_t instead of integer. This fixes
warning when compile testing on ARM64:
drivers/clk/socfpga/clk-gate.c: In function ‘socfpga\_clk\_recalc\_rate’:
drivers/clk/socfpga/clk-gate.c:102:7: warning: cast from pointer to integer of different size [-Wpointer-to-int-cast]
Fixes: b7cec13f082f ("clk: socfpga: Look for the GPIO\_DB\_CLK by its offset")
Signed-off-by: Krzysztof Kozlowski
Acked-by: Dinh Nguyen
Link: https://lore.kernel.org/r/20210314110709.32599-1-krzysztof.kozlowski@canonical.com
Signed-off-by: Stephen Boyd
Signed-off-by: Greg Kroah-Hartman
commit 8fd28ec36a802146866031b8da787fd143ddc3c0
Author: William Roche
Date: Tue Apr 6 11:28:59 2021 -0400
RAS/CEC: Correct ce\_add\_elem()'s returned values
commit 3a62583c2853b0ab37a57dde79decea210b5fb89 upstream.
ce\_add\_elem() uses different return values to signal a result from
adding an element to the collector. Commit in Fixes: broke the case
where the element being added is not found in the array. Correct that.
[ bp: Rewrite commit message, add kernel-doc comments. ]
Fixes: de0e0624d86f ("RAS/CEC: Check count\_threshold unconditionally")
Signed-off-by: William Roche
Signed-off-by: Borislav Petkov
Cc:
Link: https://lkml.kernel.org/r/1617722939-29670-1-git-send-email-william.roche@oracle.com
Signed-off-by: Greg Kroah-Hartman
commit 494727f56bf13c6a5dd5da6fc7da57be4b33268c
Author: Eli Cohen
Date: Thu Apr 8 12:10:46 2021 +0300
vdpa/mlx5: Fix wrong use of bit numbers
[ Upstream commit 4b454a82418dd76d8c0590bb3f7a99a63ea57dc5 ]
VIRTIO\_F\_VERSION\_1 is a bit number. Use BIT\_ULL() with mask
conditionals.
Also, in mlx5\_vdpa\_is\_little\_endian() use BIT\_ULL for consistency with
the rest of the code.
Fixes: 1a86b377aa21 ("vdpa/mlx5: Add VDPA driver for supported mlx5 devices")
Signed-off-by: Eli Cohen
Link: https://lore.kernel.org/r/20210408091047.4269-5-elic@nvidia.com
Signed-off-by: Michael S. Tsirkin
Acked-by: Jason Wang
Signed-off-by: Sasha Levin
commit d3d06fd40d0b4860c6091ad70f8f1b640fe9d3b1
Author: Si-Wei Liu
Date: Thu Apr 8 12:10:43 2021 +0300
vdpa/mlx5: should exclude header length and fcs from mtu
[ Upstream commit d084d996aaf53c0cc583dc75a4fc2a67fe485846 ]
When feature VIRTIO\_NET\_F\_MTU is negotiated on mlx5\_vdpa,
22 extra bytes worth of MTU length is shown in guest.
This is because the mlx5\_query\_port\_max\_mtu API returns
the "hardware" MTU value, which does not just contain the
Ethernet payload, but includes extra lengths starting
from the Ethernet header up to the FCS altogether.
Fix the MTU so packets won't get dropped silently.
Fixes: 1a86b377aa21 ("vdpa/mlx5: Add VDPA driver for supported mlx5 devices")
Signed-off-by: Si-Wei Liu
Acked-by: Jason Wang
Acked-by: Eli Cohen
Link: https://lore.kernel.org/r/20210408091047.4269-2-elic@nvidia.com
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Sasha Levin
commit defb759f8886aceab2d6f5cf6e0a6d5020350ec2
Author: Leon Romanovsky
Date: Mon Apr 5 10:44:34 2021 +0300
RDMA/addr: Be strict with gid size
[ Upstream commit d1c803a9ccd7bd3aff5e989ccfb39ed3b799b975 ]
The nla\_len() is less than or equal to 16. If it's less than 16 then end
of the "gid" buffer is uninitialized.
Fixes: ae43f8286730 ("IB/core: Add IP to GID netlink offload")
Link: https://lore.kernel.org/r/20210405074434.264221-1-leon@kernel.org
Reported-by: Dan Carpenter
Signed-off-by: Mark Bloch
Signed-off-by: Leon Romanovsky
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit 4dc4f3d72eafba68429f632d3e01bec9fcaf7f9f
Author: Grzegorz Siwik
Date: Wed Mar 24 09:58:27 2021 +0100
i40e: Fix parameters in aq\_get\_phy\_register()
[ Upstream commit b2d0efc4be7ed320e33eaa9b6dd6f3f6011ffb8e ]
Change parameters order in aq\_get\_phy\_register() due to wrong
statistics in PHY reported by ethtool. Previously all PHY statistics were
exactly the same for all interfaces
Now statistics are reported correctly - different for different interfaces
Fixes: 0514db37dd78 ("i40e: Extend PHY access with page change flag")
Signed-off-by: Grzegorz Siwik
Tested-by: Dave Switzer
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit d09c457d014f4c30e5f10c35ab75a35642a238d8
Author: Dom Cobley
Date: Thu Mar 18 17:13:28 2021 +0100
drm/vc4: crtc: Reduce PV fifo threshold on hvs4
[ Upstream commit eb9dfdd1ed40357b99a4201c8534c58c562e48c9 ]
Experimentally have found PV on hvs4 reports fifo full
error with expected settings and does not with one less
This appears as:
[drm:drm\_atomic\_helper\_wait\_for\_flip\_done] \*ERROR\* [CRTC:82:crtc-3] flip\_done timed out
with bit 10 of PV\_STAT set "HVS driving pixels when the PV FIFO is full"
Fixes: c8b75bca92cb ("drm/vc4: Add KMS support for Raspberry Pi.")
Signed-off-by: Dom Cobley
Signed-off-by: Maxime Ripard
Link: https://patchwork.freedesktop.org/patch/msgid/20210318161328.1471556-3-maxime@cerno.tech
Signed-off-by: Sasha Levin
commit 70fae2455c0e71f0f7d9b9331e46909502b075fa
Author: Kamal Heib
Date: Sun Apr 4 15:55:01 2021 +0300
RDMA/qedr: Fix kernel panic when trying to access recv\_cq
[ Upstream commit e1ad897b9c738d5550be6762bf3a6ef1672259a4 ]
As INI QP does not require a recv\_cq, avoid the following null pointer
dereference by checking if the qp\_type is not INI before trying to extract
the recv\_cq.
BUG: kernel NULL pointer dereference, address: 00000000000000e0
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] SMP PTI
CPU: 0 PID: 54250 Comm: mpitests-IMB-MP Not tainted 5.12.0-rc5 #1
Hardware name: Dell Inc. PowerEdge R320/0KM5PX, BIOS 2.7.0 08/19/2019
RIP: 0010:qedr\_create\_qp+0x378/0x820 [qedr]
Code: 02 00 00 50 e8 29 d4 a9 d1 48 83 c4 18 e9 65 fe ff ff 48 8b 53 10 48 8b 43 18 44 8b 82 e0 00 00 00 45 85 c0 0f 84 10 74 00 00 <8b> b8 e0 00 00 00 85 ff 0f 85 50 fd ff ff e9 fd 73 00 00 48 8d bd
RSP: 0018:ffff9c8f056f7a70 EFLAGS: 00010202
RAX: 0000000000000000 RBX: ffff9c8f056f7b58 RCX: 0000000000000009
RDX: ffff8c41a9744c00 RSI: ffff9c8f056f7b58 RDI: ffff8c41c0dfa280
RBP: ffff8c41c0dfa280 R08: 0000000000000002 R09: 0000000000000001
R10: 0000000000000000 R11: ffff8c41e06fc608 R12: ffff8c4194052000
R13: 0000000000000000 R14: ffff8c4191546070 R15: ffff8c41c0dfa280
FS: 00007f78b2787b80(0000) GS:ffff8c43a3200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000000000e0 CR3: 00000001011d6002 CR4: 00000000001706f0
Call Trace:
ib\_uverbs\_handler\_UVERBS\_METHOD\_QP\_CREATE+0x4e4/0xb90 [ib\_uverbs]
? ib\_uverbs\_cq\_event\_handler+0x30/0x30 [ib\_uverbs]
ib\_uverbs\_run\_method+0x6f6/0x7a0 [ib\_uverbs]
? ib\_uverbs\_handler\_UVERBS\_METHOD\_QP\_DESTROY+0x70/0x70 [ib\_uverbs]
? \_\_cond\_resched+0x15/0x30
? \_\_kmalloc+0x5a/0x440
ib\_uverbs\_cmd\_verbs+0x195/0x360 [ib\_uverbs]
? xa\_load+0x6e/0x90
? cred\_has\_capability+0x7c/0x130
? avc\_has\_extended\_perms+0x17f/0x440
? vma\_link+0xae/0xb0
? vma\_set\_page\_prot+0x2a/0x60
? mmap\_region+0x298/0x6c0
? do\_mmap+0x373/0x520
? selinux\_file\_ioctl+0x17f/0x220
ib\_uverbs\_ioctl+0xa7/0x110 [ib\_uverbs]
\_\_x64\_sys\_ioctl+0x84/0xc0
do\_syscall\_64+0x33/0x40
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f78b120262b
Fixes: 06e8d1df46ed ("RDMA/qedr: Add support for user mode XRC-SRQ's")
Link: https://lore.kernel.org/r/20210404125501.154789-1-kamalheib1@gmail.com
Signed-off-by: Kamal Heib
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit a9eede95b4ea53c02aa42c8011a9fa44a02d267a
Author: Jin Yao
Date: Wed Apr 7 10:44:52 2021 +0800
perf report: Fix wrong LBR block sorting
[ Upstream commit f2013278ae40b89cc27916366c407ce5261815ef ]
When '--total-cycles' is specified, it supports sorting for all blocks
by 'Sampled Cycles%'. This is useful to concentrate on the globally
hottest blocks.
'Sampled Cycles%' - block sampled cycles aggregation / total sampled cycles
But in current code, it doesn't use the cycles aggregation. Part of
'cycles' counting is possibly dropped for some overlap jumps. But for
identifying the hot block, we always need the full cycles.
# perf record -b ./triad\_loop
# perf report --total-cycles --stdio
Before:
#
# Sampled Cycles% Sampled Cycles Avg Cycles% Avg Cycles [Program Block Range] Shared Object
# ............... .............. ........... .......... ............................................................. .................
#
0.81% 793 4.32% 793 [setup-vdso.h:34 -> setup-vdso.h:40] ld-2.27.so
0.49% 480 0.87% 160 [native\_write\_msr+0 -> native\_write\_msr+16] [kernel.kallsyms]
0.48% 476 0.52% 95 [native\_read\_msr+0 -> native\_read\_msr+29] [kernel.kallsyms]
0.31% 303 1.65% 303 [nmi\_restore+0 -> nmi\_restore+37] [kernel.kallsyms]
0.26% 255 1.39% 255 [nohz\_balance\_exit\_idle+75 -> nohz\_balance\_exit\_idle+162] [kernel.kallsyms]
0.24% 234 1.28% 234 [end\_repeat\_nmi+67 -> end\_repeat\_nmi+83] [kernel.kallsyms]
0.23% 227 1.24% 227 [\_\_irqentry\_text\_end+96 -> \_\_irqentry\_text\_end+126] [kernel.kallsyms]
0.20% 194 1.06% 194 [native\_set\_debugreg+52 -> native\_set\_debugreg+56] [kernel.kallsyms]
0.11% 106 0.14% 26 [native\_sched\_clock+0 -> native\_sched\_clock+98] [kernel.kallsyms]
0.10% 97 0.53% 97 [trigger\_load\_balance+0 -> trigger\_load\_balance+67] [kernel.kallsyms]
0.09% 85 0.46% 85 [get-dynamic-info.h:102 -> get-dynamic-info.h:111] ld-2.27.so
...
0.00% 92.7K 0.02% 4 [triad\_loop.c:64 -> triad\_loop.c:65] triad\_loop
The hottest block '[triad\_loop.c:64 -> triad\_loop.c:65]' is not at
the top of output.
After:
# Sampled Cycles% Sampled Cycles Avg Cycles% Avg Cycles [Program Block Range] Shared Object
# ............... .............. ........... .......... .............................................................. .................
#
94.35% 92.7K 0.02% 4 [triad\_loop.c:64 -> triad\_loop.c:65] triad\_loop
0.81% 793 4.32% 793 [setup-vdso.h:34 -> setup-vdso.h:40] ld-2.27.so
0.49% 480 0.87% 160 [native\_write\_msr+0 -> native\_write\_msr+16] [kernel.kallsyms]
0.48% 476 0.52% 95 [native\_read\_msr+0 -> native\_read\_msr+29] [kernel.kallsyms]
0.31% 303 1.65% 303 [nmi\_restore+0 -> nmi\_restore+37] [kernel.kallsyms]
0.26% 255 1.39% 255 [nohz\_balance\_exit\_idle+75 -> nohz\_balance\_exit\_idle+162] [kernel.kallsyms]
0.24% 234 1.28% 234 [end\_repeat\_nmi+67 -> end\_repeat\_nmi+83] [kernel.kallsyms]
0.23% 227 1.24% 227 [\_\_irqentry\_text\_end+96 -> \_\_irqentry\_text\_end+126] [kernel.kallsyms]
0.20% 194 1.06% 194 [native\_set\_debugreg+52 -> native\_set\_debugreg+56] [kernel.kallsyms]
0.11% 106 0.14% 26 [native\_sched\_clock+0 -> native\_sched\_clock+98] [kernel.kallsyms]
0.10% 97 0.53% 97 [trigger\_load\_balance+0 -> trigger\_load\_balance+67] [kernel.kallsyms]
0.09% 85 0.46% 85 [get-dynamic-info.h:102 -> get-dynamic-info.h:111] ld-2.27.so
0.08% 82 0.06% 11 [intel\_pmu\_drain\_pebs\_nhm+580 -> intel\_pmu\_drain\_pebs\_nhm+627] [kernel.kallsyms]
0.08% 77 0.42% 77 [lru\_add\_drain\_cpu+0 -> lru\_add\_drain\_cpu+133] [kernel.kallsyms]
0.08% 74 0.10% 18 [handle\_pmi\_common+271 -> handle\_pmi\_common+310] [kernel.kallsyms]
0.08% 74 0.40% 74 [get-dynamic-info.h:131 -> get-dynamic-info.h:157] ld-2.27.so
0.07% 69 0.09% 17 [intel\_pmu\_drain\_pebs\_nhm+432 -> intel\_pmu\_drain\_pebs\_nhm+468] [kernel.kallsyms]
Now the hottest block is reported at the top of output.
Fixes: b65a7d372b1a55db ("perf hist: Support block formats with compare/sort/display")
Signed-off-by: Jin Yao
Reviewed-by: Andi Kleen
Cc: Alexander Shishkin
Cc: Jin Yao
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Peter Zijlstra
Link: http://lore.kernel.org/lkml/20210407024452.29988-1-yao.jin@linux.intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit bb8af68d05826644ef1293f4f2ae8a1e92211f84
Author: Potnuri Bharat Teja
Date: Wed Mar 31 19:27:15 2021 +0530
RDMA/cxgb4: check for ipv6 address properly while destroying listener
[ Upstream commit 603c4690b01aaffe3a6c3605a429f6dac39852ae ]
ipv6 bit is wrongly set by the below which causes fatal adapter lookup
engine errors for ipv4 connections while destroying a listener. Fix it to
properly check the local address for ipv6.
Fixes: 3408be145a5d ("RDMA/cxgb4: Fix adapter LE hash errors while destroying ipv6 listening server")
Link: https://lore.kernel.org/r/20210331135715.30072-1-bharat@chelsio.com
Signed-off-by: Potnuri Bharat Teja
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit 16821ab710b08a72b6f2777a451d0680f1eaf39b
Author: Aya Levin
Date: Sun Apr 4 12:55:00 2021 +0300
net/mlx5: Fix PBMC register mapping
[ Upstream commit 534b1204ca4694db1093b15cf3e79a99fcb6a6da ]
Add reserved mapping to cover all the register in order to avoid setting
arbitrary values to newer FW which implements the reserved fields.
Fixes: 50b4a3c23646 ("net/mlx5: PPTB and PBMC register firmware command support")
Signed-off-by: Aya Levin
Reviewed-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 5bc62430494d797bedd933aeff8afdadcd7b5ee4
Author: Aya Levin
Date: Sun Apr 4 10:50:50 2021 +0300
net/mlx5: Fix PPLM register mapping
[ Upstream commit ce28f0fd670ddffcd564ce7119bdefbaf08f02d3 ]
Add reserved mapping to cover all the register in order to avoid
setting arbitrary values to newer FW which implements the reserved
fields.
Fixes: a58837f52d43 ("net/mlx5e: Expose FEC feilds and related capability bit")
Signed-off-by: Aya Levin
Reviewed-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 90240cbac0bbeaeb5f2f73303ca1260140eb23f1
Author: Raed Salem
Date: Thu Jan 21 16:01:37 2021 +0200
net/mlx5: Fix placement of log\_max\_flow\_counter
[ Upstream commit a14587dfc5ad2312dabdd42a610d80ecd0dc8bea ]
The cited commit wrongly placed log\_max\_flow\_counter field of
mlx5\_ifc\_flow\_table\_prop\_layout\_bits, align it to the HW spec intended
placement.
Fixes: 16f1c5bb3ed7 ("net/mlx5: Check device capability for maximum flow counters")
Signed-off-by: Raed Salem
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit d2a6cda95cb037191963ca5481547bda46943625
Author: Eli Cohen
Date: Wed Mar 24 09:46:09 2021 +0200
net/mlx5: Fix HW spec violation configuring uplink
[ Upstream commit 1a73704c82ed4ee95532ac04645d02075bd1ce3d ]
Make sure to modify uplink port to follow only if the uplink\_follow
capability is set as required by the HW spec. Failure to do so causes
traffic to the uplink representor net device to cease after switching to
switchdev mode.
Fixes: 7d0314b11cdd ("net/mlx5e: Modify uplink state on interface up/down")
Signed-off-by: Eli Cohen
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 8679f4a647c480ea33e2c767deced16e845069a8
Author: Guangbin Huang
Date: Tue Apr 6 21:10:43 2021 +0800
net: hns3: clear VF down state bit before request link status
[ Upstream commit ed7bedd2c3ca040f1e8ea02c6590a93116b1ec78 ]
Currently, the VF down state bit is cleared after VF sending
link status request command. There is problem that when VF gets
link status replied from PF, the down state bit may still set
as 1. In this case, the link status replied from PF will be
ignored and always set VF link status to down.
To fix this problem, clear VF down state bit before VF requests
link status.
Fixes: e2cb1dec9779 ("net: hns3: Add HNS3 VF HCL(Hardware Compatibility Layer) Support")
Signed-off-by: Guangbin Huang
Signed-off-by: Huazhong Tan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 67f7aba24445293c05e8879f77c1326b2be89587
Author: Xin Long
Date: Tue Apr 6 10:45:23 2021 +0800
tipc: increment the tmp aead refcnt before attaching it
[ Upstream commit 2a2403ca3add03f542f6b34bef9f74649969b06d ]
Li Shuang found a NULL pointer dereference crash in her testing:
[] BUG: unable to handle kernel NULL pointer dereference at 0000000000000020
[] RIP: 0010:tipc\_crypto\_rcv\_complete+0xc8/0x7e0 [tipc]
[] Call Trace:
[]
[] tipc\_crypto\_rcv+0x2d9/0x8f0 [tipc]
[] tipc\_rcv+0x2fc/0x1120 [tipc]
[] tipc\_udp\_recv+0xc6/0x1e0 [tipc]
[] udpv6\_queue\_rcv\_one\_skb+0x16a/0x460
[] udp6\_unicast\_rcv\_skb.isra.35+0x41/0xa0
[] ip6\_protocol\_deliver\_rcu+0x23b/0x4c0
[] ip6\_input+0x3d/0xb0
[] ipv6\_rcv+0x395/0x510
[] \_\_netif\_receive\_skb\_core+0x5fc/0xc40
This is caused by NULL returned by tipc\_aead\_get(), and then crashed when
dereferencing it later in tipc\_crypto\_rcv\_complete(). This might happen
when tipc\_crypto\_rcv\_complete() is called by two threads at the same time:
the tmp attached by tipc\_crypto\_key\_attach() in one thread may be released
by the one attached by that in the other thread.
This patch is to fix it by incrementing the tmp's refcnt before attaching
it instead of calling tipc\_aead\_get() after attaching it.
Fixes: fc1b6d6de220 ("tipc: introduce TIPC encryption & authentication")
Reported-by: Li Shuang
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 42a4b202f851e089e1c6ec9fc3f35bcc21444811
Author: Hans de Goede
Date: Sun Apr 4 16:38:31 2021 +0200
platform/x86: intel-hid: Fix spurious wakeups caused by tablet-mode events during suspend
[ Upstream commit a3790a8a94fc0234c5d38013b48e74ef221ec84c ]
Some devices send (duplicate) tablet-mode events when moved around even
though the mode has not changed; and they do this even when suspended.
Change the tablet-mode event handling when priv->wakeup\_mode is set to
update the switch state in case it changed and then return immediately
(without calling pm\_wakeup\_hard\_event()) to avoid spurious wakeups.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=212537
Fixes: 537b0dd4729e ("platform/x86: intel-hid: Add support for SW\_TABLET\_MODE")
Signed-off-by: Hans de Goede
Reviewed-by: Elia Devito
Link: https://lore.kernel.org/r/20210404143831.25173-1-hdegoede@redhat.com
Signed-off-by: Sasha Levin
commit 452302ba607ea0b036a560bea6a8347e639ecc18
Author: Marc Kleine-Budde
Date: Tue Mar 30 11:46:07 2021 +0200
can: mcp251x: fix support for half duplex SPI host controllers
[ Upstream commit 617085fca6375e2c1667d1fbfc6adc4034c85f04 ]
Some SPI host controllers do not support full-duplex SPI transfers.
The function mcp251x\_spi\_trans() does a full duplex transfer. It is
used in several places in the driver, where a TX half duplex transfer
is sufficient.
To fix support for half duplex SPI host controllers, this patch
introduces a new function mcp251x\_spi\_write() and changes all callers
that do a TX half duplex transfer to use mcp251x\_spi\_write().
Fixes: e0e25001d088 ("can: mcp251x: add support for half duplex controllers")
Link: https://lore.kernel.org/r/20210330100246.1074375-1-mkl@pengutronix.de
Cc: Tim Harvey
Tested-By: Tim Harvey
Reported-by: Gerhard Bertelsmann
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 868d3fdda06f70faeeb5d12baede60c865f43a15
Author: Luca Coelho
Date: Fri Mar 26 12:57:17 2021 +0200
iwlwifi: fix 11ax disabled bit in the regulatory capability flags
[ Upstream commit 07cc40fec9a85e669ea12e161a438d2cbd76f1ed ]
When version 2 of the regulatory capability flags API was implemented,
the flag to disable 11ax was defined as bit 13, but this was later
changed and the bit remained as bit 10, like in version 1. This was
never changed in the driver, so we were checking for the wrong bit in
newer devices. Fix it.
Signed-off-by: Luca Coelho
Fixes: e27c506a985c ("iwlwifi: regulatory: regulatory capabilities api change")
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20210326125611.6d28516b59cd.Id0248d5e4662695254f49ce37b0268834ed52918@changeid
Signed-off-by: Sasha Levin
commit d66df19e5125fb095ad7fda6a017ec897f5b3607
Author: Andy Shevchenko
Date: Wed Mar 31 14:05:10 2021 +0300
i2c: designware: Adjust bus\_freq\_hz when refuse high speed mode set
[ Upstream commit 5e729bc54bda705f64941008b018b4e41a4322bf ]
When hardware doesn't support High Speed Mode, we forget bus\_freq\_hz
timing adjustment. This makes the timings and real registers being
unsynchronized. Adjust bus\_freq\_hz when refuse high speed mode set.
Fixes: b6e67145f149 ("i2c: designware: Enable high speed mode")
Reported-by: "Song Bao Hua (Barry Song)"
Signed-off-by: Andy Shevchenko
Reviewed-by: Barry Song
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit e93c80d4bdc8f4b80317b88b13f6945788b2ff67
Author: Ilya Maximets
Date: Sun Apr 4 19:50:31 2021 +0200
openvswitch: fix send of uninitialized stack memory in ct limit reply
[ Upstream commit 4d51419d49930be2701c2633ae271b350397c3ca ]
'struct ovs\_zone\_limit' has more members than initialized in
ovs\_ct\_limit\_get\_default\_limit(). The rest of the memory is a random
kernel stack content that ends up being sent to userspace.
Fix that by using designated initializer that will clear all
non-specified fields.
Fixes: 11efd5cb04a1 ("openvswitch: Support conntrack zone limit")
Signed-off-by: Ilya Maximets
Acked-by: Tonghao Zhang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ba0e8db170c301b73aa71eb4585218f3105cea0a
Author: Adrian Hunter
Date: Thu Apr 1 13:36:05 2021 +0300
perf inject: Fix repipe usage
[ Upstream commit 026334a3bb6a3919b42aba9fc11843db2b77fd41 ]
Since commit 14d3d54052539a1e ("perf session: Try to read pipe data from
file") 'perf inject' has started printing "PERFILE2h" when not processing
pipes.
The commit exposed perf to the possiblity that the input is not a pipe
but the 'repipe' parameter gets used. That causes the printing because
perf inject sets 'repipe' to true always.
The 'repipe' parameter of perf\_session\_\_new() is used by 2 functions:
- perf\_file\_header\_\_read\_pipe()
- trace\_report()
In both cases, the functions copy data to STDOUT\_FILENO when 'repipe' is
true.
Fix by setting 'repipe' to true only if the output is a pipe.
Fixes: e558a5bd8b74aff4 ("perf inject: Work with files")
Signed-off-by: Adrian Hunter
Acked-by: Jiri Olsa
Cc: Andrew Vagin
Link: http://lore.kernel.org/lkml/20210401103605.9000-1-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 721a5fc944cddc59167a739e31f8b5b2aaaca861
Author: Alexander Gordeev
Date: Mon Mar 29 18:35:07 2021 +0200
s390/cpcmd: fix inline assembly register clobbering
[ Upstream commit 7a2f91441b2c1d81b77c1cd816a4659f4abc9cbe ]
Register variables initialized using arithmetic. That leads to
kasan instrumentaton code corrupting the registers contents.
Follow GCC guidlines and use temporary variables for assigning
init values to register variables.
Fixes: 94c12cc7d196 ("[S390] Inline assembly cleanup.")
Signed-off-by: Alexander Gordeev
Acked-by: Ilya Leoshkevich
Link: https://gcc.gnu.org/onlinedocs/gcc-10.2.0/gcc/Local-Register-Variables.html
Signed-off-by: Heiko Carstens
Signed-off-by: Sasha Levin
commit 2f09eec28aabbfdaea61eed8b2ed5b63db88b47d
Author: Zqiang
Date: Thu Feb 18 11:16:49 2021 +0800
workqueue: Move the position of debug\_work\_activate() in \_\_queue\_work()
[ Upstream commit 0687c66b5f666b5ad433f4e94251590d9bc9d10e ]
The debug\_work\_activate() is called on the premise that
the work can be inserted, because if wq be in WQ\_DRAINING
status, insert work may be failed.
Fixes: e41e704bc4f4 ("workqueue: improve destroy\_workqueue() debuggability")
Signed-off-by: Zqiang
Reviewed-by: Lai Jiangshan
Signed-off-by: Tejun Heo
Signed-off-by: Sasha Levin
commit e3561eea3e6cd99cad3ab18431cfe0347f6eeeac
Author: Lukasz Bartosik
Date: Fri Apr 2 00:51:49 2021 +0200
clk: fix invalid usage of list cursor in unregister
[ Upstream commit 7045465500e465b09f09d6e5bdc260a9f1aab97b ]
Fix invalid usage of a list\_for\_each\_entry cursor in
clk\_notifier\_unregister(). When list is empty or if the list
is completely traversed (without breaking from the loop on one
of the entries) then the list cursor does not point to a valid
entry and therefore should not be used. The patch fixes a logical
bug that hasn't been seen in pratice however it is analogus
to the bug fixed in clk\_notifier\_register().
The issue was dicovered when running 5.12-rc1 kernel on x86\_64
with KASAN enabled:
BUG: KASAN: global-out-of-bounds in clk\_notifier\_register+0xab/0x230
Read of size 8 at addr ffffffffa0d10588 by task swapper/0/1
CPU: 1 PID: 1 Comm: swapper/0 Not tainted 5.12.0-rc1 #1
Hardware name: Google Caroline/Caroline,
BIOS Google\_Caroline.7820.430.0 07/20/2018
Call Trace:
dump\_stack+0xee/0x15c
print\_address\_description+0x1e/0x2dc
kasan\_report+0x188/0x1ce
? clk\_notifier\_register+0xab/0x230
? clk\_prepare\_lock+0x15/0x7b
? clk\_notifier\_register+0xab/0x230
clk\_notifier\_register+0xab/0x230
dw8250\_probe+0xc01/0x10d4
...
Memory state around the buggy address:
ffffffffa0d10480: 00 00 00 00 00 03 f9 f9 f9 f9 f9 f9 00 00 00 00
ffffffffa0d10500: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 f9 f9
>ffffffffa0d10580: f9 f9 f9 f9 00 00 00 00 00 00 00 00 00 00 00 00
^
ffffffffa0d10600: 00 00 00 00 00 00 f9 f9 f9 f9 f9 f9 00 00 00 00
ffffffffa0d10680: 00 00 00 00 00 00 00 00 f9 f9 f9 f9 00 00 00 00
==================================================================
Fixes: b2476490ef11 ("clk: introduce the common clock framework")
Reported-by: Lukasz Majczak
Signed-off-by: Lukasz Bartosik
Link: https://lore.kernel.org/r/20210401225149.18826-2-lb@semihalf.com
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit 0b4a64f2a0cce810928193f57735b374f6234fce
Author: Lukasz Bartosik
Date: Fri Apr 2 00:51:48 2021 +0200
clk: fix invalid usage of list cursor in register
[ Upstream commit 8d3c0c01cb2e36b2bf3c06a82b18b228d0c8f5d0 ]
Fix invalid usage of a list\_for\_each\_entry cursor in
clk\_notifier\_register(). When list is empty or if the list
is completely traversed (without breaking from the loop on one
of the entries) then the list cursor does not point to a valid
entry and therefore should not be used.
The issue was dicovered when running 5.12-rc1 kernel on x86\_64
with KASAN enabled:
BUG: KASAN: global-out-of-bounds in clk\_notifier\_register+0xab/0x230
Read of size 8 at addr ffffffffa0d10588 by task swapper/0/1
CPU: 1 PID: 1 Comm: swapper/0 Not tainted 5.12.0-rc1 #1
Hardware name: Google Caroline/Caroline,
BIOS Google\_Caroline.7820.430.0 07/20/2018
Call Trace:
dump\_stack+0xee/0x15c
print\_address\_description+0x1e/0x2dc
kasan\_report+0x188/0x1ce
? clk\_notifier\_register+0xab/0x230
? clk\_prepare\_lock+0x15/0x7b
? clk\_notifier\_register+0xab/0x230
clk\_notifier\_register+0xab/0x230
dw8250\_probe+0xc01/0x10d4
...
Memory state around the buggy address:
ffffffffa0d10480: 00 00 00 00 00 03 f9 f9 f9 f9 f9 f9 00 00 00 00
ffffffffa0d10500: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 f9 f9
>ffffffffa0d10580: f9 f9 f9 f9 00 00 00 00 00 00 00 00 00 00 00 00
^
ffffffffa0d10600: 00 00 00 00 00 00 f9 f9 f9 f9 f9 f9 00 00 00 00
ffffffffa0d10680: 00 00 00 00 00 00 00 00 f9 f9 f9 f9 00 00 00 00
==================================================================
Fixes: b2476490ef11 ("clk: introduce the common clock framework")
Reported-by: Lukasz Majczak
Signed-off-by: Lukasz Bartosik
Link: https://lore.kernel.org/r/20210401225149.18826-1-lb@semihalf.com
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit 63479ae4fb6d441824971f584b41be5a8e29ad79
Author: Claudiu Beznea
Date: Fri Apr 2 15:42:53 2021 +0300
net: macb: restore cmp registers on resume path
[ Upstream commit a14d273ba15968495896a38b7b3399dba66d0270 ]
Restore CMP screener registers on resume path.
Fixes: c1e85c6ce57ef ("net: macb: save/restore the remaining registers and features")
Signed-off-by: Claudiu Beznea
Acked-by: Nicolas Ferre
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a8c23ab799e87b6d38af9ef3c998f460f4013583
Author: Yunjian Wang
Date: Thu Apr 1 12:52:48 2021 +0800
net: cls\_api: Fix uninitialised struct field bo->unlocked\_driver\_cb
[ Upstream commit 990b03b05b2fba79de2a1ee9dc359fc552d95ba6 ]
The 'unlocked\_driver\_cb' struct field in 'bo' is not being initialized
in tcf\_block\_offload\_init(). The uninitialized 'unlocked\_driver\_cb'
will be used when calling unlocked\_driver\_cb(). So initialize 'bo' to
zero to avoid the issue.
Addresses-Coverity: ("Uninitialized scalar variable")
Fixes: 0fdcf78d5973 ("net: use flow\_indr\_dev\_setup\_offload()")
Signed-off-by: Yunjian Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d52f64fc54b88ceb8867be7b7cf7137f7e28b8c9
Author: Rui Salvaterra
Date: Wed Feb 17 15:30:38 2021 +0000
ARM: dts: turris-omnia: fix hardware buffer management
[ Upstream commit 5b2c7e0ae762fff2b172caf16b2766cc3e1ad859 ]
Hardware buffer management has never worked on the Turris Omnia, as the
required MBus window hadn't been reserved. Fix thusly.
Fixes: 018b88eee1a2 ("ARM: dts: turris-omnia: enable HW buffer management")
Signed-off-by: Rui Salvaterra
Reviewed-by: Marek Behún
Tested-by: Klaus Kudielka
Signed-off-by: Gregory CLEMENT
Signed-off-by: Sasha Levin
commit 4e2446fbdd006da3c88e4e5a36666b2d63a1c08e
Author: Gregory CLEMENT
Date: Fri Apr 2 21:58:26 2021 +0200
Revert "arm64: dts: marvell: armada-cp110: Switch to per-port SATA interrupts"
[ Upstream commit 967ff33eb0efcd48e4df11ab9aee51c41e0f44d0 ]
The driver part of this support was not merged which leads to break
AHCI on all Marvell Armada 7k8k / CN913x platforms as it was reported
by Marcin Wojtas.
So for now let's remove it in order to fix the issue waiting for the
driver part really be merged.
This reverts commit 53e950d597e3578da84238b86424bfcc9e101d87.
Fixes: 53e950d597e3 ("arm64: dts: marvell: armada-cp110: Switch to per-port SATA interrupts")
Signed-off-by: Gregory CLEMENT
Signed-off-by: Sasha Levin
commit bd1702fdff3c9809b48544f5751795d4ce256e1d
Author: Kalyan Thota
Date: Fri Apr 2 04:54:53 2021 -0700
drm/msm/disp/dpu1: program 3d\_merge only if block is attached
[ Upstream commit 12aca1ce9ee33af3751aec5e55a5900747cbdd4b ]
Update the 3d merge as active in the data path only if
the hw block is selected in the configuration.
Reported-by: Stephen Boyd
Fixes: 73bfb790ac78 ("msm:disp:dpu1: setup display datapath for SC7180 target")
Signed-off-by: Kalyan Thota
Message-Id: <1617364493-13518-1-git-send-email-kalyan\_t@codeaurora.org>
Signed-off-by: Rob Clark
Signed-off-by: Sasha Levin
commit dbb59f2d3d3391d96b0f70309925c694bd73aeaa
Author: Dmitry Baryshkov
Date: Wed Mar 31 17:02:23 2021 +0300
drm/msm: a6xx: fix version check for the A650 SQE microcode
[ Upstream commit 6ddbfa1f5adbd5dea14ff66778ca58257f09f17d ]
I suppose the microcode version check for a650 is incorrect. It checks
for the version 1.95, while the firmware released have major version of 0:
0.91 (vulnerable), 0.99 (fixing the issue).
Lower version requirements to accept firmware 0.99.
Fixes: 8490f02a3ca4 ("drm/msm: a6xx: Make sure the SQE microcode is safe")
Cc: Akhil P Oommen
Cc: Jordan Crouse
Signed-off-by: Dmitry Baryshkov
Acked-by: Jordan Crouse
Message-Id: <20210331140223.3771449-1-dmitry.baryshkov@linaro.org>
Signed-off-by: Rob Clark
Signed-off-by: Sasha Levin
commit 3b365c0d2c05ac535607f60eb08383c701201dc3
Author: Can Guo
Date: Thu Apr 1 00:39:09 2021 -0700
scsi: ufs: core: Fix wrong Task Tag used in task management request UPIUs
[ Upstream commit 4b42d557a8add52b9a9924fb31e40a218aab7801 ]
In \_\_ufshcd\_issue\_tm\_cmd(), it is not correct to use hba->nutrs + req->tag
as the Task Tag in a TMR UPIU. Directly use req->tag as the Task Tag.
Fixes: e293313262d3 ("scsi: ufs: Fix broken task management command implementation")
Link: https://lore.kernel.org/r/1617262750-4864-3-git-send-email-cang@codeaurora.org
Reviewed-by: Bart Van Assche
Signed-off-by: Can Guo
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 4c00f57e62b9a0c339c85dbae84cfaa47648ef39
Author: Can Guo
Date: Thu Apr 1 00:39:08 2021 -0700
scsi: ufs: core: Fix task management request completion timeout
[ Upstream commit 1235fc569e0bf541ddda0a1224d4c6fa6d914890 ]
ufshcd\_tmc\_handler() calls blk\_mq\_tagset\_busy\_iter(fn = ufshcd\_compl\_tm()),
but since blk\_mq\_tagset\_busy\_iter() only iterates over all reserved tags
and requests which are not in IDLE state, ufshcd\_compl\_tm() never gets a
chance to run. Thus, TMR always ends up with completion timeout. Fix it by
calling blk\_mq\_start\_request() in \_\_ufshcd\_issue\_tm\_cmd().
Link: https://lore.kernel.org/r/1617262750-4864-2-git-send-email-cang@codeaurora.org
Fixes: 69a6c269c097 ("scsi: ufs: Use blk\_{get,put}\_request() to allocate and free TMFs")
Reviewed-by: Bart Van Assche
Signed-off-by: Can Guo
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit db63372d24fd7b4795eb325d59481fe789819d1b
Author: Paolo Abeni
Date: Thu Apr 1 18:57:45 2021 +0200
mptcp: revert "mptcp: provide subflow aware release function"
[ Upstream commit 0a3cc57978d1d1448312f8973bd84dca4a71433a ]
This change reverts commit ad98dd37051e ("mptcp: provide subflow aware
release function"). The latter introduced a deadlock spotted by
syzkaller and is not needed anymore after the previous commit.
Fixes: ad98dd37051e ("mptcp: provide subflow aware release function")
Signed-off-by: Paolo Abeni
Reviewed-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 70ba3614edd98ac4dab18f45b0138aa33d610942
Author: Paolo Abeni
Date: Thu Apr 1 18:57:44 2021 +0200
mptcp: forbit mcast-related sockopt on MPTCP sockets
[ Upstream commit 86581852d7710990d8af9dadfe9a661f0abf2114 ]
Unrolling mcast state at msk dismantel time is bug prone, as
syzkaller reported:
======================================================
WARNING: possible circular locking dependency detected
5.11.0-syzkaller #0 Not tainted
------------------------------------------------------
syz-executor905/8822 is trying to acquire lock:
ffffffff8d678fe8 (rtnl\_mutex){+.+.}-{3:3}, at: ipv6\_sock\_mc\_close+0xd7/0x110 net/ipv6/mcast.c:323
but task is already holding lock:
ffff888024390120 (sk\_lock-AF\_INET6){+.+.}-{0:0}, at: lock\_sock include/net/sock.h:1600 [inline]
ffff888024390120 (sk\_lock-AF\_INET6){+.+.}-{0:0}, at: mptcp6\_release+0x57/0x130 net/mptcp/protocol.c:3507
which lock already depends on the new lock.
Instead we can simply forbit any mcast-related setsockopt
Fixes: 717e79c867ca5 ("mptcp: Add setsockopt()/getsockopt() socket operations")
Signed-off-by: Paolo Abeni
Reviewed-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e55cd1733145e1b4e296eba37cef3f66da4a1fc9
Author: Norman Maurer
Date: Thu Apr 1 08:59:17 2021 +0200
net: udp: Add support for getsockopt(..., ..., UDP\_GRO, ..., ...);
[ Upstream commit 98184612aca0a9ee42b8eb0262a49900ee9eef0d ]
Support for UDP\_GRO was added in the past but the implementation for
getsockopt was missed which did lead to an error when we tried to
retrieve the setting for UDP\_GRO. This patch adds the missing switch
case for UDP\_GRO
Fixes: e20cf8d3f1f7 ("udp: implement GRO for plain UDP sockets.")
Signed-off-by: Norman Maurer
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f369daf200bfae3f503f2418033d6e5a9436cc66
Author: Stephen Boyd
Date: Thu Mar 25 14:28:22 2021 -0700
drm/msm: Set drvdata to NULL when msm\_drm\_init() fails
[ Upstream commit 5620b135aea49a8f41c86aaecfcb1598a7774121 ]
We should set the platform device's driver data to NULL here so that
code doesn't assume the struct drm\_device pointer is valid when it could
have been destroyed. The lifetime of this pointer is managed by a kref
but when msm\_drm\_init() fails we call drm\_dev\_put() on the pointer which
will free the pointer's memory. This driver uses the component model, so
there's sort of two "probes" in this file, one for the platform device
i.e. msm\_pdev\_probe() and one for the component i.e. msm\_drm\_bind(). The
msm\_drm\_bind() code is using the platform device's driver data to store
struct drm\_device so the two functions are intertwined.
This relationship becomes a problem for msm\_pdev\_shutdown() when it
tests the NULL-ness of the pointer to see if it should call
drm\_atomic\_helper\_shutdown(). The NULL test is a proxy check for if the
pointer has been freed by kref\_put(). If the drm\_device has been
destroyed, then we shouldn't call the shutdown helper, and we know that
is the case if msm\_drm\_init() failed, therefore set the driver data to
NULL so that this pointer liveness is tracked properly.
Fixes: 9d5cbf5fe46e ("drm/msm: add shutdown support for display platform\_driver")
Cc: Dmitry Baryshkov
Cc: Fabio Estevam
Cc: Krishna Manikandan
Signed-off-by: Stephen Boyd
Message-Id: <20210325212822.3663144-1-swboyd@chromium.org>
Signed-off-by: Rob Clark
Signed-off-by: Sasha Levin
commit 1740e07334abdf176c819712a7cc03a458f36828
Author: Md Haris Iqbal
Date: Thu Mar 25 16:32:57 2021 +0100
RDMA/rtrs-clt: Close rtrs client conn before destroying rtrs clt session files
[ Upstream commit 7582207b1059129e59eb92026fca2cfc088a74fc ]
KASAN detected the following BUG:
BUG: KASAN: use-after-free in rtrs\_clt\_update\_wc\_stats+0x41/0x100 [rtrs\_client]
Read of size 8 at addr ffff88bf2fb4adc0 by task swapper/0/0
CPU: 0 PID: 0 Comm: swapper/0 Tainted: G O 5.4.84-pserver #5.4.84-1+feature+linux+5.4.y+dbg+20201216.1319+b6b887b~deb10
Hardware name: Supermicro H8QG6/H8QG6, BIOS 3.00 09/04/2012
Call Trace:
dump\_stack+0x96/0xe0
print\_address\_description.constprop.4+0x1f/0x300
? irq\_work\_claim+0x2e/0x50
\_\_kasan\_report.cold.8+0x78/0x92
? rtrs\_clt\_update\_wc\_stats+0x41/0x100 [rtrs\_client]
kasan\_report+0x10/0x20
rtrs\_clt\_update\_wc\_stats+0x41/0x100 [rtrs\_client]
rtrs\_clt\_rdma\_done+0xb1/0x760 [rtrs\_client]
? lockdep\_hardirqs\_on+0x1a8/0x290
? process\_io\_rsp+0xb0/0xb0 [rtrs\_client]
? mlx4\_ib\_destroy\_cq+0x100/0x100 [mlx4\_ib]
? add\_interrupt\_randomness+0x1a2/0x340
\_\_ib\_process\_cq+0x97/0x100 [ib\_core]
ib\_poll\_handler+0x41/0xb0 [ib\_core]
irq\_poll\_softirq+0xe0/0x260
\_\_do\_softirq+0x127/0x672
irq\_exit+0xd1/0xe0
do\_IRQ+0xa3/0x1d0
common\_interrupt+0xf/0xf

RIP: 0010:cpuidle\_enter\_state+0xea/0x780
Code: 31 ff e8 99 48 47 ff 80 7c 24 08 00 74 12 9c 58 f6 c4 02 0f 85 53 05 00 00 31 ff e8 b0 6f 53 ff e8 ab 4f 5e ff fb 8b 44 24 04 <85> c0 0f 89 f3 01 00 00 48 8d 7b 14 e8 65 1e 77 ff c7 43 14 00 00
RSP: 0018:ffffffffab007d58 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffffca
RAX: 0000000000000002 RBX: ffff88b803d69800 RCX: ffffffffa91a8298
RDX: 0000000000000007 RSI: dffffc0000000000 RDI: ffffffffab021414
RBP: ffffffffab6329e0 R08: 0000000000000002 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000002
R13: 000000bf39d82466 R14: ffffffffab632aa0 R15: ffffffffab632ae0
? lockdep\_hardirqs\_on+0x1a8/0x290
? cpuidle\_enter\_state+0xe5/0x780
cpuidle\_enter+0x3c/0x60
do\_idle+0x2fb/0x390
? arch\_cpu\_idle\_exit+0x40/0x40
? schedule+0x94/0x120
cpu\_startup\_entry+0x19/0x1b
start\_kernel+0x5da/0x61b
? thread\_stack\_cache\_init+0x6/0x6
? load\_ucode\_amd\_bsp+0x6f/0xc4
? init\_amd\_microcode+0xa6/0xa6
? x86\_family+0x5/0x20
? load\_ucode\_bsp+0x182/0x1fd
secondary\_startup\_64+0xa4/0xb0
Allocated by task 5730:
save\_stack+0x19/0x80
\_\_kasan\_kmalloc.constprop.9+0xc1/0xd0
kmem\_cache\_alloc\_trace+0x15b/0x350
alloc\_sess+0xf4/0x570 [rtrs\_client]
rtrs\_clt\_open+0x3b4/0x780 [rtrs\_client]
find\_and\_get\_or\_create\_sess+0x649/0x9d0 [rnbd\_client]
rnbd\_clt\_map\_device+0xd7/0xf50 [rnbd\_client]
rnbd\_clt\_map\_device\_store+0x4ee/0x970 [rnbd\_client]
kernfs\_fop\_write+0x141/0x240
vfs\_write+0xf3/0x280
ksys\_write+0xba/0x150
do\_syscall\_64+0x68/0x270
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
Freed by task 5822:
save\_stack+0x19/0x80
\_\_kasan\_slab\_free+0x125/0x170
kfree+0xe7/0x3f0
kobject\_put+0xd3/0x240
rtrs\_clt\_destroy\_sess\_files+0x3f/0x60 [rtrs\_client]
rtrs\_clt\_close+0x3c/0x80 [rtrs\_client]
close\_rtrs+0x45/0x80 [rnbd\_client]
rnbd\_client\_exit+0x10f/0x2bd [rnbd\_client]
\_\_x64\_sys\_delete\_module+0x27b/0x340
do\_syscall\_64+0x68/0x270
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
When rtrs\_clt\_close is triggered, it iterates over all the present
rtrs\_clt\_sess and triggers close on them. However, the call to
rtrs\_clt\_destroy\_sess\_files is done before the rtrs\_clt\_close\_conns. This
is incorrect since during the initialization phase we allocate
rtrs\_clt\_sess first, and then we go ahead and create rtrs\_clt\_con for it.
If we free the rtrs\_clt\_sess structure before closing the rtrs\_clt\_con, it
may so happen that an inflight IO completion would trigger the function
rtrs\_clt\_rdma\_done, which would lead to the above UAF case.
Hence close the rtrs\_clt\_con connections first, and then trigger the
destruction of session files.
Fixes: 6a98d71daea1 ("RDMA/rtrs: client: main functionality")
Link: https://lore.kernel.org/r/20210325153308.1214057-12-gi-oh.kim@ionos.com
Signed-off-by: Md Haris Iqbal
Signed-off-by: Jack Wang
Signed-off-by: Gioh Kim
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit 3244d3db66363191103188537b56269b5d03f102
Author: Eryk Rybak
Date: Tue Mar 2 08:46:27 2021 +0100
i40e: Fix display statistics for veb\_tc
[ Upstream commit c3214de929dbf1b7374add8bbed30ce82b197bbb ]
If veb-stats was enabled, the ethtool stats triggered a warning
due to invalid size: 'unexpected stat size for veb.tc\_%u\_tx\_packets'.
This was due to an incorrect structure definition for the statistics.
Structures and functions have been improved in line with requirements
for the presentation of statistics, in particular for the functions:
'i40e\_add\_ethtool\_stats' and 'i40e\_add\_stat\_strings'.
Fixes: 1510ae0be2a4 ("i40e: convert VEB TC stats to use an i40e\_stats array")
Signed-off-by: Eryk Rybak
Signed-off-by: Grzegorz Szczurek
Reviewed-by: Aleksandr Loktionov
Tested-by: Dave Switzer
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 517d0e9b6a8c8e863251dcb4c4ed0b948e5a1149
Author: Magnus Karlsson
Date: Fri Mar 19 10:44:10 2021 +0100
i40e: fix receiving of single packets in xsk zero-copy mode
[ Upstream commit 528060ef3e1105c5c3eba66ffbfc80e0825e2cce ]
Fix so that single packets are received immediately instead of in
batches of 8. If you sent 1 pps to a system, you received 8 packets
every 8 seconds instead of 1 packet every second. The problem behind
this was that the work\_done reporting from the Tx part of the driver
was broken. The work\_done reporting in i40e controls not only the
reporting back to the napi logic but also the setting of the interrupt
throttling logic. When Tx or Rx reports that it has more to do,
interrupts are throttled or coalesced and when they both report that
they are done, interrupts are armed right away. If the wrong work\_done
value is returned, the logic will start to throttle interrupts in a
situation where it should have just enabled them. This leads to the
undesired batching behavior seen in user-space.
Fix this by returning the correct boolean value from the Tx xsk
zero-copy path. Return true if there is nothing to do or if we got
fewer packets to process than we asked for. Return false if we got as
many packets as the budget since there might be more packets we can
process.
Fixes: 3106c580fb7c ("i40e: Use batched xsk Tx interfaces to increase performance")
Reported-by: Sreedevi Joshi
Signed-off-by: Magnus Karlsson
Acked-by: Maciej Fijalkowski
Tested-by: Kiran Bhandare
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 7f0fc4682e49d039e11f4d0237bce8209b410f0c
Author: Arnd Bergmann
Date: Tue Mar 23 14:15:23 2021 +0100
soc/fsl: qbman: fix conflicting alignment attributes
[ Upstream commit 040f31196e8b2609613f399793b9225271b79471 ]
When building with W=1, gcc points out that the \_\_packed attribute
on struct qm\_eqcr\_entry conflicts with the 8-byte alignment
attribute on struct qm\_fd inside it:
drivers/soc/fsl/qbman/qman.c:189:1: error: alignment 1 of 'struct qm\_eqcr\_entry' is less than 8 [-Werror=packed-not-aligned]
I assume that the alignment attribute is the correct one, and
that qm\_eqcr\_entry cannot actually be unaligned in memory,
so add the same alignment on the outer struct.
Fixes: c535e923bb97 ("soc/fsl: Introduce DPAA 1.x QMan device driver")
Signed-off-by: Arnd Bergmann
Link: https://lore.kernel.org/r/20210323131530.2619900-1-arnd@kernel.org'
Signed-off-by: Arnd Bergmann
Signed-off-by: Sasha Levin
commit 95bafdf79ed391da5106f23bffa5de1a639121df
Author: Ong Boon Leong
Date: Wed Mar 31 21:25:03 2021 +0800
xdp: fix xdp\_return\_frame() kernel BUG throw for page\_pool memory model
[ Upstream commit 622d13694b5f048c01caa7ba548498d9880d4cb0 ]
xdp\_return\_frame() may be called outside of NAPI context to return
xdpf back to page\_pool. xdp\_return\_frame() calls \_\_xdp\_return() with
napi\_direct = false. For page\_pool memory model, \_\_xdp\_return() calls
xdp\_return\_frame\_no\_direct() unconditionally and below false negative
kernel BUG throw happened under preempt-rt build:
[ 430.450355] BUG: using smp\_processor\_id() in preemptible [00000000] code: modprobe/3884
[ 430.451678] caller is \_\_xdp\_return+0x1ff/0x2e0
[ 430.452111] CPU: 0 PID: 3884 Comm: modprobe Tainted: G U E 5.12.0-rc2+ #45
Changes in v2:
- This patch fixes the issue by making xdp\_return\_frame\_no\_direct() is
only called if napi\_direct = true, as recommended for better by
Jesper Dangaard Brouer. Thanks!
Fixes: 2539650fadbf ("xdp: Helpers for disabling napi\_direct of xdp\_return\_frame")
Signed-off-by: Ong Boon Leong
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4253a6bfbcab217c85629575e9976c2121924e9e
Author: Lv Yunlong
Date: Tue Mar 30 18:59:59 2021 -0700
net/rds: Fix a use after free in rds\_message\_map\_pages
[ Upstream commit bdc2ab5c61a5c07388f4820ff21e787b4dfd1ced ]
In rds\_message\_map\_pages, the rm is freed by rds\_message\_put(rm).
But rm is still used by rm->data.op\_sg in return value.
My patch assigns ERR\_CAST(rm->data.op\_sg) to err before the rm is
freed to avoid the uaf.
Fixes: 7dba92037baf3 ("net/rds: Use ERR\_PTR for rds\_message\_alloc\_sgs()")
Signed-off-by: Lv Yunlong
Reviewed-by: Håkon Bugge
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3afc6743f639ec118c612c218c4f3b57a84ae02a
Author: Tariq Toukan
Date: Wed Feb 10 14:58:01 2021 +0200
net/mlx5e: Guarantee room for XSK wakeup NOP on async ICOSQ
[ Upstream commit 3ff3874fa0b261ef74f2bfb008a82ab1601c11eb ]
XSK wakeup flow triggers an IRQ by posting a NOP WQE and hitting
the doorbell on the async ICOSQ.
It maintains its state so that it doesn't issue another NOP WQE
if it has an outstanding one already.
For this flow to work properly, the NOP post must not fail.
Make sure to reserve room for the NOP WQE in all WQE posts to the
async ICOSQ.
Fixes: 8d94b590f1e4 ("net/mlx5e: Turn XSK ICOSQ into a general asynchronous one")
Fixes: 1182f3659357 ("net/mlx5e: kTLS, Add kTLS RX HW offload support")
Fixes: 0419d8c9d8f8 ("net/mlx5e: kTLS, Add kTLS RX resync support")
Signed-off-by: Tariq Toukan
Reviewed-by: Maxim Mikityanskiy
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit c896de640df7a4809d8c3d9861bad7f007ff8e10
Author: Daniel Jurgens
Date: Thu Dec 5 16:58:10 2019 -0600
net/mlx5: Don't request more than supported EQs
[ Upstream commit a7b76002ae78cd230ee652ccdfedf21aa94fcecc ]
Calculating the number of compeltion EQs based on the number of
available IRQ vectors doesn't work now that all async EQs share one IRQ.
Thus the max number of EQs can be exceeded on systems with more than
approximately 256 CPUs. Take this into account when calculating the
number of available completion EQs.
Fixes: 81bfa206032a ("net/mlx5: Use a single IRQ for all async EQs")
Signed-off-by: Daniel Jurgens
Reviewed-by: Parav Pandit
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit acea114d3c46148358f36ce1a7eecc0e83e4e1c1
Author: Aya Levin
Date: Wed Mar 24 12:25:06 2021 +0200
net/mlx5e: Fix ethtool indication of connector type
[ Upstream commit 3211434dfe7a66fcf55e43961ea524b78336c04c ]
Use connector\_type read from PTYS register when it's valid, based on
corresponding capability bit.
Fixes: 5b4793f81745 ("net/mlx5e: Add support for reading connector type from PTYS")
Signed-off-by: Aya Levin
Reviewed-by: Eran Ben Elisha
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit ab0b84d31f48d539b7c66a984c626848c8dea5f8
Author: Maor Dickman
Date: Mon Mar 22 17:22:03 2021 +0200
net/mlx5: Delete auxiliary bus driver eth-rep first
[ Upstream commit 1f90aedfb496ccccf862c7b7c0889af20c2fc61a ]
Delete auxiliary bus drivers flow deletes the eth driver
first and then the eth-reps driver but eth-reps devices resources
are depend on eth device.
Fixed by changing the delete order of auxiliary bus drivers to delete
the eth-rep driver first and after it the eth driver.
Fixes: 601c10c89cbb ("net/mlx5: Delete custom device management logic")
Signed-off-by: Maor Dickman
Reviewed-by: Leon Romanovsky
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 5b8399ab502c96610f1c36819a1a8f28bb0a0e45
Author: Ariel Levkovich
Date: Tue Mar 9 01:29:01 2021 +0200
net/mlx5e: Fix mapping of ct\_label zero
[ Upstream commit d24f847e54214049814b9515771622eaab3f42ab ]
ct\_label 0 is a default label each flow has and therefore
there can be rules that match on ct\_label=0 without a prior
rule that set the ct\_label to this value.
The ct\_label value is not used directly in the HW rules and
instead it is mapped to some id within a defined range and this
id is used to set and match the metadata register which carries
the ct\_label.
If we have a rule that matches on ct\_label=0, the hw rule will
perform matching on a value that is != 0 because of the mapping
from label to id. Since the metadata register default value is
0 and it was never set before to anything else by an action that
sets the ct\_label, there will always be a mismatch between that
register and the value in the rule.
To support such rule, a forced mapping of ct\_label 0 to id=0
is done so that it will match the metadata register default
value of 0.
Fixes: 54b154ecfb8c ("net/mlx5e: CT: Map 128 bits labels to 32 bit map ID")
Signed-off-by: Ariel Levkovich
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 16896b4482896982b1a7b756088e47d4d71af314
Author: Bastian Germann
Date: Wed Mar 31 17:18:43 2021 +0200
ASoC: sunxi: sun4i-codec: fill ASoC card owner
[ Upstream commit 7c0d6e482062eb5c06ecccfab340abc523bdca00 ]
card->owner is a required property and since commit 81033c6b584b ("ALSA:
core: Warn on empty module") a warning is issued if it is empty. Add it.
This fixes following warning observed on Lamobo R1:
WARNING: CPU: 1 PID: 190 at sound/core/init.c:207 snd\_card\_new+0x430/0x480 [snd]
Modules linked in: sun4i\_codec(E+) sun4i\_backend(E+) snd\_soc\_core(E) ...
CPU: 1 PID: 190 Comm: systemd-udevd Tainted: G C E 5.10.0-1-armmp #1 Debian 5.10.4-1
Hardware name: Allwinner sun7i (A20) Family
Call trace:
(snd\_card\_new [snd])
(snd\_soc\_bind\_card [snd\_soc\_core])
(snd\_soc\_register\_card [snd\_soc\_core])
(sun4i\_codec\_probe [sun4i\_codec])
Fixes: 45fb6b6f2aa3 ("ASoC: sunxi: add support for the on-chip codec on early Allwinner SoCs")
Related: commit 3c27ea23ffb4 ("ASoC: qcom: Set card->owner to avoid warnings")
Related: commit ec653df2a0cb ("drm/vc4/vc4\_hdmi: fill ASoC card owner")
Cc: linux-arm-kernel@lists.infradead.org
Cc: alsa-devel@alsa-project.org
Signed-off-by: Bastian Germann
Link: https://lore.kernel.org/r/20210331151843.30583-1-bage@linutronix.de
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 5c802d8b58a63d2bc452c13bc67b7946611d4cd1
Author: 周琰杰 (Zhou Yanjie)
Date: Fri Mar 19 18:12:13 2021 +0800
I2C: JZ4780: Fix bug for Ingenic X1000.
[ Upstream commit 942bfbecc0281c75db84f744b9b77b0f2396f484 ]
Only send "X1000\_I2C\_DC\_STOP" when last byte, or it will cause
error when I2C write operation which should look like this:
device\_addr + w, reg\_addr, data;
But without this patch, it looks like this:
device\_addr + w, reg\_addr, device\_addr + w, data;
Fixes: 21575a7a8d4c ("I2C: JZ4780: Add support for the X1000.")
Reported-by: 杨文龙 (Yang Wenlong)
Tested-by: 杨文龙 (Yang Wenlong)
Signed-off-by: 周琰杰 (Zhou Yanjie)
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 7fcd99a9395d6fabaed78df252bf11c327870cf5
Author: Florian Fainelli
Date: Tue Mar 30 15:00:24 2021 -0700
net: phy: broadcom: Only advertise EEE for supported modes
[ Upstream commit c056d480b40a68f2520ccc156c7fae672d69d57d ]
We should not be advertising EEE for modes that we do not support,
correct that oversight by looking at the PHY device supported linkmodes.
Fixes: 99cec8a4dda2 ("net: phy: broadcom: Allow enabling or disabling of EEE")
Signed-off-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b84de22448b5dccbaedf375148bf41c117b5c45f
Author: Yinjun Zhang
Date: Tue Mar 30 10:30:23 2021 +0200
nfp: flower: ignore duplicate merge hints from FW
[ Upstream commit 2ea538dbee1c79f6f6c24a6f2f82986e4b7ccb78 ]
A merge hint message needs some time to process before the merged
flow actually reaches the firmware, during which we may get duplicate
merge hints if there're more than one packet that hit the pre-merged
flow. And processing duplicate merge hints will cost extra host\_ctx's
which are a limited resource.
Avoid the duplicate merge by using hash table to store the sub\_flows
to be merged.
Fixes: 8af56f40e53b ("nfp: flower: offload merge flows")
Signed-off-by: Yinjun Zhang
Signed-off-by: Louis Peens
Signed-off-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cd090f3e5d56c283b43f3bb9d8c9ad896816e332
Author: Loic Poulain
Date: Tue Mar 30 16:11:08 2021 +0200
net: qrtr: Fix memory leak on qrtr\_tx\_wait failure
[ Upstream commit 8a03dd925786bdc3834d56ccc980bb70668efa35 ]
qrtr\_tx\_wait does not check for radix\_tree\_insert failure, causing
the 'flow' object to be unreferenced after qrtr\_tx\_wait return. Fix
that by releasing flow on radix\_tree\_insert failure.
Fixes: 5fdeb0d372ab ("net: qrtr: Implement outgoing flow control")
Reported-by: syzbot+739016799a89c530b32a@syzkaller.appspotmail.com
Signed-off-by: Loic Poulain
Reviewed-by: Bjorn Andersson
Reviewed-by: Manivannan Sadhasivam
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f61307f7b2bb7c6676c9e80212a0dd3462ba7439
Author: Milton Miller
Date: Mon Mar 29 10:20:39 2021 -0500
net/ncsi: Avoid channel\_monitor hrtimer deadlock
[ Upstream commit 03cb4d05b4ea9a3491674ca40952adb708d549fa ]
Calling ncsi\_stop\_channel\_monitor from channel\_monitor is a guaranteed
deadlock on SMP because stop calls del\_timer\_sync on the timer that
invoked channel\_monitor as its timer function.
Recognise the inherent race of marking the monitor disabled before
deleting the timer by just returning if enable was cleared. After
a timeout (the default case -- reset to START when response received)
just mark the monitor.enabled false.
If the channel has an entry on the channel\_queue list, or if the
state is not ACTIVE or INACTIVE, then warn and mark the timer stopped
and don't restart, as the locking is broken somehow.
Fixes: 0795fb2021f0 ("net/ncsi: Stop monitor if channel times out or is inactive")
Signed-off-by: Milton Miller
Signed-off-by: Eddie James
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9029e8bf54b300a9dba31113fa932ffa8ab3a496
Author: Stefan Riedmueller
Date: Mon Mar 29 15:01:03 2021 +0200
ARM: dts: imx6: pbab01: Set vmmc supply for both SD interfaces
[ Upstream commit f57011e72f5fe0421ec7a812beb1b57bdf4bb47f ]
Setting the vmmc supplies is crucial since otherwise the supplying
regulators get disabled and the SD interfaces are no longer powered
which leads to system failures if the system is booted from that SD
interface.
Fixes: 1e44d3f880d5 ("ARM i.MX6Q: dts: Enable I2C1 with EEPROM and PMIC on Phytec phyFLEX-i.MX6 Ouad module")
Signed-off-by: Stefan Riedmueller
Reviewed-by: Fabio Estevam
Signed-off-by: Shawn Guo
Signed-off-by: Sasha Levin
commit be1aab34608957c2fbec39ce28a68566e7e6fdb3
Author: Lv Yunlong
Date: Sun Mar 28 00:30:29 2021 -0700
net:tipc: Fix a double free in tipc\_sk\_mcast\_rcv
[ Upstream commit 6bf24dc0cc0cc43b29ba344b66d78590e687e046 ]
In the if(skb\_peek(arrvq) == skb) branch, it calls \_\_skb\_dequeue(arrvq) to get
the skb by skb = skb\_peek(arrvq). Then \_\_skb\_dequeue() unlinks the skb from arrvq
and returns the skb which equals to skb\_peek(arrvq). After \_\_skb\_dequeue(arrvq)
finished, the skb is freed by kfree\_skb(\_\_skb\_dequeue(arrvq)) in the first time.
Unfortunately, the same skb is freed in the second time by kfree\_skb(skb) after
the branch completed.
My patch removes kfree\_skb() in the if(skb\_peek(arrvq) == skb) branch, because
this skb will be freed by kfree\_skb(skb) finally.
Fixes: cb1b728096f54 ("tipc: eliminate race condition at multicast reception")
Signed-off-by: Lv Yunlong
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9b46ee6192876ae23d61614b0657182ef66eddb7
Author: Rahul Lakkireddy
Date: Sat Mar 27 23:49:08 2021 +0530
cxgb4: avoid collecting SGE\_QBASE regs during traffic
[ Upstream commit 1bfb3dea965ff9f6226fd1709338f227363b6061 ]
Accessing SGE\_QBASE\_MAP[0-3] and SGE\_QBASE\_INDEX registers can lead
to SGE missing doorbells under heavy traffic. So, only collect them
when adapter is idle. Also update the regdump range to skip collecting
these registers.
Fixes: 80a95a80d358 ("cxgb4: collect SGE PF/VF queue map")
Signed-off-by: Rahul Lakkireddy
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 698e56363274627242412585fcb464d2af9bc758
Author: Taniya Das
Date: Sat Mar 27 07:11:05 2021 +0530
clk: qcom: camcc: Update the clock ops for the SC7180
[ Upstream commit e5c359f70e4b5e7b6c2bf4b0ca2d2686d543a37b ]
Some of the RCGs could be always ON from the XO source and could be used
as the clock on signal for the GDSC to be operational. In the cases where
the GDSCs are parked at different source with the source clock disabled,
it could lead to the GDSC to be stuck at ON/OFF during gdsc disable/enable.
Thus park the RCGs at XO during clock disable and update the rcg\_ops to
use the shared\_ops.
Fixes: 15d09e830bbc ("clk: qcom: camcc: Add camera clock controller driver for SC7180")
Signed-off-by: Taniya Das
Link: https://lore.kernel.org/r/1616809265-11912-1-git-send-email-tdas@codeaurora.org
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit 4fbe8b216bee88b0dd6bd42973874581fb9c6066
Author: Maxim Kochetkov
Date: Mon Mar 29 18:30:16 2021 +0300
net: dsa: Fix type was not set for devlink port
[ Upstream commit fb6ec87f7229b92baa81b35cbc76f2626d5bfadb ]
If PHY is not available on DSA port (described at devicetree but absent or
failed to detect) then kernel prints warning after 3700 secs:
[ 3707.948771] ------------[ cut here ]------------
[ 3707.948784] Type was not set for devlink port.
[ 3707.948894] WARNING: CPU: 1 PID: 17 at net/core/devlink.c:8097 0xc083f9d8
We should unregister the devlink port as a user port and
re-register it as an unused port before executing "continue" in case of
dsa\_port\_setup error.
Fixes: 86f8b1c01a0a ("net: dsa: Do not make user port errors fatal")
Signed-off-by: Maxim Kochetkov
Reviewed-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3d7807ec85225749b751636793d314d12bd3331f
Author: Claudiu Manoil
Date: Mon Mar 29 17:08:47 2021 +0300
gianfar: Handle error code at MAC address change
[ Upstream commit bff5b62585123823842833ab20b1c0a7fa437f8c ]
Handle return error code of eth\_mac\_addr();
Fixes: 3d23a05c75c7 ("gianfar: Enable changing mac addr when if up")
Signed-off-by: Claudiu Manoil
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit aa9d1e5e3c332546ca32a425a6996d89bcca8f12
Author: Lv Yunlong
Date: Mon Mar 29 05:36:48 2021 -0700
ethernet: myri10ge: Fix a use after free in myri10ge\_sw\_tso
[ Upstream commit 63415767a2446136372e777cde5bb351f21ec21d ]
In myri10ge\_sw\_tso, the skb\_list\_walk\_safe macro will set
(curr) = (segs) and (next) = (curr)->next. If status!=0 is true,
the memory pointed by curr and segs will be free by dev\_kfree\_skb\_any(curr).
But later, the segs is used by segs = segs->next and causes a uaf.
As (next) = (curr)->next, my patch replaces seg->next to next.
Fixes: 536577f36ff7a ("net: myri10ge: use skb\_list\_walk\_safe helper for gso segments")
Signed-off-by: Lv Yunlong
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 976b779142e991e70f57fd0680aebe2a342a1489
Author: Ido Schimmel
Date: Mon Mar 29 11:29:23 2021 +0300
mlxsw: spectrum: Fix ECN marking in tunnel decapsulation
[ Upstream commit 66167c310deb4ac1725f81004fb4b504676ad0bf ]
Cited commit changed the behavior of the software data path with regards
to the ECN marking of decapsulated packets. However, the commit did not
change other callers of \_\_INET\_ECN\_decapsulate(), namely mlxsw. The
driver is using the function in order to ensure that the hardware and
software data paths act the same with regards to the ECN marking of
decapsulated packets.
The discrepancy was uncovered by commit 5aa3c334a449 ("selftests:
forwarding: vxlan\_bridge\_1d: Fix vxlan ecn decapsulate value") that
aligned the selftest to the new behavior. Without this patch the
selftest passes when used with veth pairs, but fails when used with
mlxsw netdevs.
Fix this by instructing the device to propagate the ECT(1) mark from the
outer header to the inner header when the inner header is ECT(0), for
both NVE and IP-in-IP tunnels.
A helper is added in order not to duplicate the code between both tunnel
types.
Fixes: b723748750ec ("tunnel: Propagate ECT(1) when decapsulating as recommended by RFC6040")
Signed-off-by: Ido Schimmel
Reviewed-by: Petr Machata
Acked-by: Toke Høiland-Jørgensen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5325e847b749c50de5bfa99105ca40c322b7f4d4
Author: Marc Kleine-Budde
Date: Mon Mar 22 10:44:54 2021 +0100
can: uapi: can.h: mark union inside struct can\_frame packed
[ Upstream commit f5076c6ba02e8e24c61c40bbf48078929bc0fc79 ]
In commit ea7800565a12 ("can: add optional DLC element to Classical
CAN frame structure") the struct can\_frame::can\_dlc was put into an
anonymous union with another u8 variable.
For various reasons some members in struct can\_frame and canfd\_frame
including the first 8 byes of data are expected to have the same
memory layout. This is enforced by a BUILD\_BUG\_ON check in af\_can.c.
Since the above mentioned commit this check fails on ARM kernels
compiled with the ARM OABI (which means CONFIG\_AEABI not set). In this
case -mabi=apcs-gnu is passed to the compiler, which leads to a
structure size boundary of 32, instead of 8 compared to CONFIG\_AEABI
enabled. This means the the union in struct can\_frame takes 4 bytes
instead of the expected 1.
Rong Chen illustrates the problem with pahole in the ARM OABI case:
| struct can\_frame {
| canid\_t can\_id; /\* 0 4 \*/
| union {
| \_\_u8 len; /\* 4 1 \*/
| \_\_u8 can\_dlc; /\* 4 1 \*/
| }; /\* 4 4 \*/
| \_\_u8 \_\_pad; /\* 8 1 \*/
| \_\_u8 \_\_res0; /\* 9 1 \*/
| \_\_u8 len8\_dlc; /\* 10 1 \*/
|
| /\* XXX 5 bytes hole, try to pack \*/
|
| \_\_u8 data[8]
| \_\_attribute\_\_((\_\_aligned\_\_(8))); /\* 16 8 \*/
|
| /\* size: 24, cachelines: 1, members: 6 \*/
| /\* sum members: 19, holes: 1, sum holes: 5 \*/
| /\* forced alignments: 1, forced holes: 1, sum forced holes: 5 \*/
| /\* last cacheline: 24 bytes \*/
| } \_\_attribute\_\_((\_\_aligned\_\_(8)));
Marking the anonymous union as \_\_attribute\_\_((packed)) fixes the
BUILD\_BUG\_ON problem on these compilers.
Fixes: ea7800565a12 ("can: add optional DLC element to Classical CAN frame structure")
Reported-by: kernel test robot
Suggested-by: Rong Chen
Link: https://lore.kernel.org/linux-can/2c82ec23-3551-61b5-1bd8-178c3407ee83@hartkopp.net/
Link: https://lore.kernel.org/r/20210325125850.1620-3-socketcan@hartkopp.net
Signed-off-by: Oliver Hartkopp
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 84e55cd73e981b89cb4ce956f16d4a4507ed01a3
Author: Oliver Hartkopp
Date: Thu Mar 25 13:58:49 2021 +0100
can: isotp: fix msg\_namelen values depending on CAN\_REQUIRED\_SIZE
[ Upstream commit f522d9559b07854c231cf8f0b8cb5a3578f8b44e ]
Since commit f5223e9eee65 ("can: extend sockaddr\_can to include j1939
members") the sockaddr\_can has been extended in size and a new
CAN\_REQUIRED\_SIZE macro has been introduced to calculate the protocol
specific needed size.
The ABI for the msg\_name and msg\_namelen has not been adapted to the
new CAN\_REQUIRED\_SIZE macro for the other CAN protocols which leads to
a problem when an existing binary reads the (increased) struct
sockaddr\_can in msg\_name.
Fixes: e057dd3fc20f ("can: add ISO 15765-2:2016 transport protocol")
Reported-by: Richard Weinberger
Acked-by: Kurt Van Dijck
Link: https://lore.kernel.org/linux-can/1135648123.112255.1616613706554.JavaMail.zimbra@nod.at/T/#t
Link: https://lore.kernel.org/r/20210325125850.1620-2-socketcan@hartkopp.net
Signed-off-by: Oliver Hartkopp
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit cf9a8a13c8ba356698c1999a9a18ef6eb2245e81
Author: Oliver Hartkopp
Date: Thu Mar 25 13:58:48 2021 +0100
can: bcm/raw: fix msg\_namelen values depending on CAN\_REQUIRED\_SIZE
[ Upstream commit 9e9714742fb70467464359693a73b911a630226f ]
Since commit f5223e9eee65 ("can: extend sockaddr\_can to include j1939
members") the sockaddr\_can has been extended in size and a new
CAN\_REQUIRED\_SIZE macro has been introduced to calculate the protocol
specific needed size.
The ABI for the msg\_name and msg\_namelen has not been adapted to the
new CAN\_REQUIRED\_SIZE macro for the other CAN protocols which leads to
a problem when an existing binary reads the (increased) struct
sockaddr\_can in msg\_name.
Fixes: f5223e9eee65 ("can: extend sockaddr\_can to include j1939 members")
Reported-by: Richard Weinberger
Tested-by: Richard Weinberger
Acked-by: Kurt Van Dijck
Link: https://lore.kernel.org/linux-can/1135648123.112255.1616613706554.JavaMail.zimbra@nod.at/T/#t
Link: https://lore.kernel.org/r/20210325125850.1620-1-socketcan@hartkopp.net
Signed-off-by: Oliver Hartkopp
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 5ed41733bd87e3733e42a5d0417087a59d26d4aa
Author: Steffen Klassert
Date: Fri Mar 26 09:44:48 2021 +0100
xfrm: Provide private skb extensions for segmented and hw offloaded ESP packets
[ Upstream commit c7dbf4c08868d9db89b8bfe8f8245ca61b01ed2f ]
Commit 94579ac3f6d0 ("xfrm: Fix double ESP trailer insertion in IPsec
crypto offload.") added a XFRM\_XMIT flag to avoid duplicate ESP trailer
insertion on HW offload. This flag is set on the secpath that is shared
amongst segments. This lead to a situation where some segments are
not transformed correctly when segmentation happens at layer 3.
Fix this by using private skb extensions for segmented and hw offloaded
ESP packets.
Fixes: 94579ac3f6d0 ("xfrm: Fix double ESP trailer insertion in IPsec crypto offload.")
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 2c9d1023f6ac89e1051e4e73796d2dc98e603f4e
Author: Oliver Stäbler
Date: Wed Mar 24 14:28:41 2021 +0100
arm64: dts: imx8mm/q: Fix pad control of SD1\_DATA0
[ Upstream commit 5cfad4f45806f6f898b63b8c77cea7452c704cb3 ]
Fix address of the pad control register
(IOMUXC\_SW\_PAD\_CTL\_PAD\_SD1\_DATA0) for SD1\_DATA0\_GPIO2\_IO2. This seems
to be a typo but it leads to an exception when pinctrl is applied due to
wrong memory address access.
Signed-off-by: Oliver Stäbler
Reviewed-by: Fabio Estevam
Acked-by: Rob Herring
Fixes: c1c9d41319c3 ("dt-bindings: imx: Add pinctrl binding doc for imx8mm")
Fixes: 748f908cc882 ("arm64: add basic DTS for i.MX8MQ")
Signed-off-by: Shawn Guo
Signed-off-by: Sasha Levin
commit 917a67603e55906639dfd7f6312859043f95abda
Author: Lv Yunlong
Date: Sun Mar 28 00:50:08 2021 -0700
drivers/net/wan/hdlc\_fr: Fix a double free in pvc\_xmit
[ Upstream commit 1b479fb801602b22512f53c19b1f93a4fc5d5d9d ]
In pvc\_xmit, if \_\_skb\_pad(skb, pad, false) failed, it will free
the skb in the first time and goto drop. But the same skb is freed
by kfree\_skb(skb) in the second time in drop.
Maintaining the original function unchanged, my patch adds a new
label out to avoid the double free if \_\_skb\_pad() failed.
Fixes: f5083d0cee08a ("drivers/net/wan/hdlc\_fr: Improvements to the code of pvc\_xmit")
Signed-off-by: Lv Yunlong
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c6fec9c6c3ede9925ea41b3a18e772cdb1085037
Author: Eric Dumazet
Date: Thu Mar 25 11:14:53 2021 -0700
sch\_red: fix off-by-one checks in red\_check\_params()
[ Upstream commit 3a87571f0ffc51ba3bf3ecdb6032861d0154b164 ]
This fixes following syzbot report:
UBSAN: shift-out-of-bounds in ./include/net/red.h:237:23
shift exponent 32 is too large for 32-bit type 'unsigned int'
CPU: 1 PID: 8418 Comm: syz-executor170 Not tainted 5.12.0-rc4-next-20210324-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
ubsan\_epilogue+0xb/0x5a lib/ubsan.c:148
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x181 lib/ubsan.c:327
red\_set\_parms include/net/red.h:237 [inline]
choke\_change.cold+0x3c/0xc8 net/sched/sch\_choke.c:414
qdisc\_create+0x475/0x12f0 net/sched/sch\_api.c:1247
tc\_modify\_qdisc+0x4c8/0x1a50 net/sched/sch\_api.c:1663
rtnetlink\_rcv\_msg+0x44e/0xad0 net/core/rtnetlink.c:5553
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2502
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1312 [inline]
netlink\_unicast+0x533/0x7d0 net/netlink/af\_netlink.c:1338
netlink\_sendmsg+0x856/0xd90 net/netlink/af\_netlink.c:1927
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
\_\_\_\_sys\_sendmsg+0x6e8/0x810 net/socket.c:2350
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2404
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2433
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x43f039
Code: 28 c3 e8 2a 14 00 00 66 2e 0f 1f 84 00 00 00 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 c0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffdfa725168 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 0000000000400488 RCX: 000000000043f039
RDX: 0000000000000000 RSI: 0000000020000040 RDI: 0000000000000004
RBP: 0000000000403020 R08: 0000000000400488 R09: 0000000000400488
R10: 0000000000400488 R11: 0000000000000246 R12: 00000000004030b0
R13: 0000000000000000 R14: 00000000004ac018 R15: 0000000000400488
Fixes: 8afa10cbe281 ("net\_sched: red: Avoid illegal values")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6807582024d00dab87564a46fcb7d09721d8ebf3
Author: Antoine Tenart
Date: Thu Mar 25 16:35:33 2021 +0100
geneve: do not modify the shared tunnel info when PMTU triggers an ICMP reply
[ Upstream commit 68c1a943ef37bafde5ea2383e8ca224c7169ee31 ]
When the interface is part of a bridge or an Open vSwitch port and a
packet exceed a PMTU estimate, an ICMP reply is sent to the sender. When
using the external mode (collect metadata) the source and destination
addresses are reversed, so that Open vSwitch can match the packet
against an existing (reverse) flow.
But inverting the source and destination addresses in the shared
ip\_tunnel\_info will make following packets of the flow to use a wrong
destination address (packets will be tunnelled to itself), if the flow
isn't updated. Which happens with Open vSwitch, until the flow times
out.
Fixes this by uncloning the skb's ip\_tunnel\_info before inverting its
source and destination addresses, so that the modification will only be
made for the PTMU packet, not the following ones.
Fixes: c1a800e88dbf ("geneve: Support for PMTU discovery on directly bridged links")
Tested-by: Eelco Chaudron
Reviewed-by: Eelco Chaudron
Signed-off-by: Antoine Tenart
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 29a6eaf081bb810e51553d74bf4911fa9326545e
Author: Antoine Tenart
Date: Thu Mar 25 16:35:32 2021 +0100
vxlan: do not modify the shared tunnel info when PMTU triggers an ICMP reply
[ Upstream commit 30a93d2b7d5a7cbb53ac19c9364a256d1aa6c08a ]
When the interface is part of a bridge or an Open vSwitch port and a
packet exceed a PMTU estimate, an ICMP reply is sent to the sender. When
using the external mode (collect metadata) the source and destination
addresses are reversed, so that Open vSwitch can match the packet
against an existing (reverse) flow.
But inverting the source and destination addresses in the shared
ip\_tunnel\_info will make following packets of the flow to use a wrong
destination address (packets will be tunnelled to itself), if the flow
isn't updated. Which happens with Open vSwitch, until the flow times
out.
Fixes this by uncloning the skb's ip\_tunnel\_info before inverting its
source and destination addresses, so that the modification will only be
made for the PTMU packet, not the following ones.
Fixes: fc68c99577cc ("vxlan: Support for PMTU discovery on directly bridged links")
Tested-by: Eelco Chaudron
Reviewed-by: Eelco Chaudron
Signed-off-by: Antoine Tenart
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a2a18462885c4ba42d2ba404c38e13e19d67b73b
Author: Shyam Sundar S K
Date: Thu Mar 25 08:39:12 2021 +0530
amd-xgbe: Update DMA coherency values
[ Upstream commit d75135082698140a26a56defe1bbc1b06f26a41f ]
Based on the IOMMU configuration, the current cache control settings can
result in possible coherency issues. The hardware team has recommended
new settings for the PCI device path to eliminate the issue.
Fixes: 6f595959c095 ("amd-xgbe: Adjust register settings to improve performance")
Signed-off-by: Shyam Sundar S K
Acked-by: Tom Lendacky
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 496cc293bcb404d759f4ea2e517052b2f780197a
Author: Al Viro
Date: Thu Mar 25 14:12:34 2021 -0400
hostfs: fix memory handling in follow\_link()
[ Upstream commit 7f6c411c9b50cfab41cc798e003eff27608c7016 ]
1) argument should not be freed in any case - the caller already has
it as ->s\_fs\_info (and uses it a lot afterwards)
2) allocate readlink buffer with kmalloc() - the caller has no way
to tell if it's got that (on absolute symlink) or a result of
kasprintf(). Sure, for SLAB and SLUB kfree() works on results of
kmem\_cache\_alloc(), but that's not documented anywhere, might change
in the future \*and\* is already not true for SLOB.
Fixes: 52b209f7b848 ("get rid of hostfs\_read\_inode()")
Signed-off-by: Al Viro
Signed-off-by: Sasha Levin
commit d18ea652212729aa6aaf6d650c48b583d3a010fd
Author: Eryk Rybak
Date: Thu Feb 18 11:15:26 2021 +0000
i40e: Fix kernel oops when i40e driver removes VF's
[ Upstream commit 347b5650cd158d1d953487cc2bec567af5c5bf96 ]
Fix the reason of kernel oops when i40e driver removed VFs.
Added new \_\_I40E\_VFS\_RELEASING state to signalize releasing
process by PF, that it makes possible to exit of reset VF procedure.
Without this patch, it is possible to suspend the VFs reset by
releasing VFs resources procedure. Retrying the reset after the
timeout works on the freed VF memory causing a kernel oops.
Fixes: d43d60e5eb95 ("i40e: ensure reset occurs when disabling VF")
Signed-off-by: Eryk Rybak
Signed-off-by: Grzegorz Szczurek
Reviewed-by: Aleksandr Loktionov
Tested-by: Konrad Jankowski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit abd9ccfd238e92520360425dab456a0aad847ce9
Author: Mateusz Palczewski
Date: Mon Jan 4 15:00:02 2021 +0000
i40e: Added Asym\_Pause to supported link modes
[ Upstream commit 90449e98c265296329446c7abcd2aae3b20c0bc9 ]
Add Asym\_Pause to supported link modes (it is supported by HW).
Lack of Asym\_Pause in supported modes can cause several problems,
i.e. it won't be possible to turn the autonegotiation on
with asymmetric pause settings (i.e. Tx on, Rx off).
Fixes: 4e91bcd5d47a ("i40e: Finish implementation of ethtool get settings")
Signed-off-by: Dawid Lukwinski
Signed-off-by: Mateusz Palczewski
Reviewed-by: Aleksandr Loktionov
Reviewed-by: Przemyslaw Patynowski
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit eab112754f531e76a1cb9466f7f58314ae794c13
Author: Norbert Ciosek
Date: Thu Jan 28 10:17:02 2021 -0800
virtchnl: Fix layout of RSS structures
[ Upstream commit 22f8b5df881e9f1302514bbbbbb8649c2051de55 ]
Remove padding from RSS structures. Previous layout
could lead to unwanted compiler optimizations
in loops when iterating over key and lut arrays.
Fixes: 65ece6de0114 ("virtchnl: Add missing explicit padding to structures")
Signed-off-by: Norbert Ciosek
Tested-by: Konrad Jankowski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit ffbb80ef6d082f8f857fecbc45d1ac3d7447ee96
Author: Steffen Klassert
Date: Tue Mar 23 09:26:44 2021 +0100
xfrm: Fix NULL pointer dereference on policy lookup
[ Upstream commit b1e3a5607034aa0a481c6f69a6893049406665fb ]
When xfrm interfaces are used in combination with namespaces
and ESP offload, we get a dst\_entry NULL pointer dereference.
This is because we don't have a dst\_entry attached in the ESP
offloading case and we need to do a policy lookup before the
namespace transition.
Fix this by expicit checking of skb\_dst(skb) before accessing it.
Fixes: f203b76d78092 ("xfrm: Add virtual xfrm interfaces")
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit f769063baf06d962c9d2406ba41ab1e7fac9acc1
Author: Shengjiu Wang
Date: Fri Mar 19 18:48:46 2021 +0800
ASoC: wm8960: Fix wrong bclk and lrclk with pll enabled for some chips
[ Upstream commit 16b82e75c15a7dbd564ea3654f3feb61df9e1e6f ]
The input MCLK is 12.288MHz, the desired output sysclk is 11.2896MHz
and sample rate is 44100Hz, with the configuration pllprescale=2,
postscale=sysclkdiv=1, some chip may have wrong bclk
and lrclk output with pll enabled in master mode, but with the
configuration pllprescale=1, postscale=2, the output clock is correct.
>From Datasheet, the PLL performs best when f2 is between
90MHz and 100MHz when the desired sysclk output is 11.2896MHz
or 12.288MHz, so sysclkdiv = 2 (f2/8) is the best choice.
So search available sysclk\_divs from 2 to 1 other than from 1 to 2.
Fixes: 84fdc00d519f ("ASoC: codec: wm9860: Refactor PLL out freq search")
Signed-off-by: Shengjiu Wang
Acked-by: Charles Keepax
Link: https://lore.kernel.org/r/1616150926-22892-1-git-send-email-shengjiu.wang@nxp.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 0a622b3151968fe924b87666870deb615cd42808
Author: Guennadi Liakhovetski
Date: Mon Mar 22 11:37:21 2021 -0500
ASoC: SOF: Intel: HDA: fix core status verification
[ Upstream commit 927280909fa7d8e61596800d82f18047c6cfbbe4 ]
When checking for enabled cores it isn't enough to check that
some of the requested cores are running, we have to check that
all of them are.
Fixes: 747503b1813a ("ASoC: SOF: Intel: Add Intel specific HDA DSP HW operations")
Reviewed-by: Kai Vehmanen
Reviewed-by: Ranjani Sridharan
Signed-off-by: Guennadi Liakhovetski
Signed-off-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20210322163728.16616-2-pierre-louis.bossart@linux.intel.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 7ccd73a4446b941a7fc09101b898f58d5e2b1186
Author: Xin Long
Date: Fri Mar 19 15:35:07 2021 +0800
esp: delete NETIF\_F\_SCTP\_CRC bit from features for esp offload
[ Upstream commit 154deab6a3ba47792936edf77f2f13a1cbc4351d ]
Now in esp4/6\_gso\_segment(), before calling inner proto .gso\_segment,
NETIF\_F\_CSUM\_MASK bits are deleted, as HW won't be able to do the
csum for inner proto due to the packet encrypted already.
So the UDP/TCP packet has to do the checksum on its own .gso\_segment.
But SCTP is using CRC checksum, and for that NETIF\_F\_SCTP\_CRC should
be deleted to make SCTP do the csum in own .gso\_segment as well.
In Xiumei's testing with SCTP over IPsec/veth, the packets are kept
dropping due to the wrong CRC checksum.
Reported-by: Xiumei Mu
Fixes: 7862b4058b9f ("esp: Add gso handlers for esp4 and esp6")
Signed-off-by: Xin Long
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit fbc15e47cab7abb125d7a8298e03e094bc4d4240
Author: Ahmed S. Darwish
Date: Tue Mar 16 11:56:29 2021 +0100
net: xfrm: Localize sequence counter per network namespace
[ Upstream commit e88add19f68191448427a6e4eb059664650a837f ]
A sequence counter write section must be serialized or its internal
state can get corrupted. The "xfrm\_state\_hash\_generation" seqcount is
global, but its write serialization lock (net->xfrm.xfrm\_state\_lock) is
instantiated per network namespace. The write protection is thus
insufficient.
To provide full protection, localize the sequence counter per network
namespace instead. This should be safe as both the seqcount read and
write sections access data exclusively within the network namespace. It
also lays the foundation for transforming "xfrm\_state\_hash\_generation"
data type from seqcount\_t to seqcount\_LOCKNAME\_t in further commits.
Fixes: b65e3d7be06f ("xfrm: state: add sequence count to detect hash resizes")
Signed-off-by: Ahmed S. Darwish
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 8ac165db522d30098b79b4732c54d5776bf99f5e
Author: Suman Anna
Date: Mon Mar 15 15:58:59 2021 -0500
remoteproc: pru: Fix firmware loading crashes on K3 SoCs
[ Upstream commit 9afeefcf06fc7b4bdab06a6e2cb06745bded34dd ]
The K3 PRUs are 32-bit processors and in general have some limitations
in using the standard ARMv8 memcpy function for loading firmware segments,
so the driver already uses a custom memcpy implementation. This added
logic however is limited to only IRAMs at the moment, but the loading
into Data RAMs is not completely ok either and does generate a kernel
crash for unaligned accesses.
Fix these crashes by removing the existing IRAM logic limitation and
extending the custom memcpy usage to Data RAMs as well for all K3 SoCs.
Fixes: 1d39f4d19921 ("remoteproc: pru: Add support for various PRU cores on K3 AM65x SoCs")
Signed-off-by: Suman Anna
Link: https://lore.kernel.org/r/20210315205859.19590-1-s-anna@ti.com
Signed-off-by: Bjorn Andersson
Signed-off-by: Sasha Levin
commit e602597291746dc6c517809fda86446be01ff8db
Author: Carlos Leija
Date: Sun Mar 14 18:35:44 2021 +0200
ARM: OMAP4: PM: update ROM return address for OSWR and OFF
[ Upstream commit b3d09a06d89f474cb52664e016849315a97e09d9 ]
We need to add a dummy smc call to the cpuidle wakeup path to force the
ROM code to save the return address after MMU is enabled again. This is
needed to prevent random hangs on secure devices like droid4.
Otherwise the system will eventually hang when entering deeper SoC idle
states with the core and mpu domains in open-switch retention (OSWR).
The hang happens as the ROM code tries to use the earlier physical return
address set by omap-headsmp.S with MMU off while waking up CPU1 again.
The hangs started happening in theory already with commit caf8c87d7ff2
("ARM: OMAP2+: Allow core oswr for omap4"), but in practise the issue went
unnoticed as various drivers were often blocking any deeper idle states
with hardware autoidle features.
This patch is based on an earlier TI Linux kernel tree commit 92f0b3028d9e
("OMAP4: PM: update ROM return address for OSWR and OFF") written by
Carlos Leija , Praneeth Bajjuri , and
Bryan Buckley . A later version of the patch was
updated to use CPU\_PM notifiers by Tero Kristo .
Signed-off-by: Carlos Leija
Signed-off-by: Praneeth Bajjuri
Signed-off-by: Bryan Buckley
Signed-off-by: Tero Kristo
Fixes: caf8c87d7ff2 ("ARM: OMAP2+: Allow core oswr for omap4")
Reported-by: Carl Philipp Klemm
Reported-by: Merlijn Wajer
Cc: Ivan Jelincic
Cc: Pavel Machek
Cc: Sebastian Reichel
Cc: Tero Kristo
[tony@atomide.com: updated to apply, updated description]
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit 6b19552277270d423d0bd6361b5d180c0938b52f
Author: Tony Lindgren
Date: Sun Mar 14 18:41:01 2021 +0200
ARM: OMAP4: Fix PMIC voltage domains for bionic
[ Upstream commit 30916faa1a6009122e10d0c42338b8db44a36fde ]
We are now registering the mpu domain three times instead of registering
mpu, core and iva domains like we should.
Fixes: d44fa156dcb2 ("ARM: OMAP2+: Configure voltage controller for cpcap")
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit 2ab8c8f6464ea188a2c68a551601521985479993
Author: Geert Uytterhoeven
Date: Fri Mar 12 14:02:40 2021 +0100
regulator: bd9571mwv: Fix AVS and DVFS voltage range
[ Upstream commit 3b6e7088afc919f5b52e4d2de8501ad34d35b09b ]
According to Table 30 ("DVFS\_MoniVDAC [6:0] Setting Table") in the
BD9571MWV-M Datasheet Rev. 002, the valid voltage range is 600..1100 mV
(settings 0x3c..0x6e). While the lower limit is taken into account (by
setting regulator\_desc.linear\_min\_sel to 0x3c), the upper limit is not.
Fix this by reducing regulator\_desc.n\_voltages from 0x80 to 0x6f.
Fixes: e85c5a153fe237f2 ("regulator: Add ROHM BD9571MWV-M PMIC regulator driver")
Signed-off-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/20210312130242.3390038-2-geert+renesas@glider.be
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 5a3611f5d25fa8fc7fdc334b79c3cdc1b1142397
Author: Arnd Bergmann
Date: Sun Jan 3 14:56:12 2021 +0100
remoteproc: qcom: pil\_info: avoid 64-bit division
[ Upstream commit 7029e783027706b427bbfbdf8558252c1dac6fa0 ]
On 32-bit machines with 64-bit resource\_size\_t, the driver causes
a link failure because of the 64-bit division:
arm-linux-gnueabi-ld: drivers/remoteproc/qcom\_pil\_info.o: in function `qcom\_pil\_info\_store':
qcom\_pil\_info.c:(.text+0x1ec): undefined reference to `\_\_aeabi\_uldivmod'
Add a cast to an u32 to avoid this. If the resource exceeds 4GB,
there are bigger problems.
Fixes: 549b67da660d ("remoteproc: qcom: Introduce helper to store pil info in IMEM")
Signed-off-by: Arnd Bergmann
Link: https://lore.kernel.org/r/20210103135628.3702427-1-arnd@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Sasha Levin
commit 1d0d9d6fa9e812a794283f68ed87e69689ca1cf7
Author: Evan Nimmo
Date: Tue Mar 2 08:00:04 2021 +1300
xfrm: Use actual socket sk instead of skb socket for xfrm\_output\_resume
[ Upstream commit 9ab1265d52314fce1b51e8665ea6dbc9ac1a027c ]
A situation can occur where the interface bound to the sk is different
to the interface bound to the sk attached to the skb. The interface
bound to the sk is the correct one however this information is lost inside
xfrm\_output2 and instead the sk on the skb is used in xfrm\_output\_resume
instead. This assumes that the sk bound interface and the bound interface
attached to the sk within the skb are the same which can lead to lookup
failures inside ip\_route\_me\_harder resulting in the packet being dropped.
We have an l2tp v3 tunnel with ipsec protection. The tunnel is in the
global VRF however we have an encapsulated dot1q tunnel interface that
is within a different VRF. We also have a mangle rule that marks the
packets causing them to be processed inside ip\_route\_me\_harder.
Prior to commit 31c70d5956fc ("l2tp: keep original skb ownership") this
worked fine as the sk attached to the skb was changed from the dot1q
encapsulated interface to the sk for the tunnel which meant the interface
bound to the sk and the interface bound to the skb were identical.
Commit 46d6c5ae953c ("netfilter: use actual socket sk rather than skb sk
when routing harder") fixed some of these issues however a similar
problem existed in the xfrm code.
Fixes: 31c70d5956fc ("l2tp: keep original skb ownership")
Signed-off-by: Evan Nimmo
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 88da40f671bc5273f13388b1b76c02040c815b9a
Author: Eyal Birger
Date: Sat Feb 20 15:01:15 2021 +0200
xfrm: interface: fix ipv4 pmtu check to honor ip header df
[ Upstream commit 8fc0e3b6a8666d656923d214e4dc791e9a17164a ]
Frag needed should only be sent if the header enables DF.
This fix allows packets larger than MTU to pass the xfrm interface
and be fragmented after encapsulation, aligning behavior with
non-interface xfrm.
Fixes: f203b76d7809 ("xfrm: Add virtual xfrm interfaces")
Signed-off-by: Eyal Birger
Reviewed-by: Sabrina Dubroca
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 6c49d847de8249d4235ac71365409230c766b0bb
Author: Chinh T Cao
Date: Fri Feb 26 13:19:25 2021 -0800
ice: Recognize 860 as iSCSI port in CEE mode
[ Upstream commit aeac8ce864d9c0836e12ed5b5cc80f62f3cccb7c ]
iSCSI can use both TCP ports 860 and 3260. However, in our current
implementation, the ice\_aqc\_opc\_get\_cee\_dcb\_cfg (0x0A07) AQ command
doesn't provide a way to communicate the protocol port number to the
AQ's caller. Thus, we assume that 3260 is the iSCSI port number at the
AQ's caller layer.
Rely on the dcbx-willing mode, desired QoS and remote QoS configuration to
determine which port number that iSCSI will use.
Fixes: 0ebd3ff13cca ("ice: Add code for DCB initialization part 2/4")
Signed-off-by: Chinh T Cao
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 870bac104e16343fbdb71423dfc062de06650cc1
Author: Chinh T Cao
Date: Fri Nov 20 16:39:35 2020 -0800
ice: Refactor DCB related variables out of the ice\_port\_info struct
[ Upstream commit fc2d1165d4a424dd325ae1f45806565350a58013 ]
Refactor the DCB related variables out of the ice\_port\_info\_struct. The
goal is to make the ice\_port\_info struct cleaner.
Signed-off-by: Chinh T Cao
Co-developed-by: Dave Ertman
Signed-off-by: Dave Ertman
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 50b4b6e7aba9cc4dd1e63fcbc04292dc71c05059
Author: Vlad Buslov
Date: Wed Apr 7 18:36:04 2021 +0300
net: sched: fix err handler in tcf\_action\_init()
[ Upstream commit b3650bf76a32380d4d80a3e21b5583e7303f216c ]
With recent changes that separated action module load from action
initialization tcf\_action\_init() function error handling code was modified
to manually release the loaded modules if loading/initialization of any
further action in same batch failed. For the case when all modules
successfully loaded and some of the actions were initialized before one of
them failed in init handler. In this case for all previous actions the
module will be released twice by the error handler: First time by the loop
that manually calls module\_put() for all ops, and second time by the action
destroy code that puts the module after destroying the action.
Reproduction:
$ sudo tc actions add action simple sdata \"2\" index 2
$ sudo tc actions add action simple sdata \"1\" index 1 \
action simple sdata \"2\" index 2
RTNETLINK answers: File exists
We have an error talking to the kernel
$ sudo tc actions ls action simple
total acts 1
action order 0: Simple <"2">
index 2 ref 1 bind 0
$ sudo tc actions flush action simple
$ sudo tc actions ls action simple
$ sudo tc actions add action simple sdata \"2\" index 2
Error: Failed to load TC action module.
We have an error talking to the kernel
$ lsmod | grep simple
act\_simple 20480 -1
Fix the issue by modifying module reference counting handling in action
initialization code:
- Get module reference in tcf\_idr\_create() and put it in tcf\_idr\_release()
instead of taking over the reference held by the caller.
- Modify users of tcf\_action\_init\_1() to always release the module
reference which they obtain before calling init function instead of
assuming that created action takes over the reference.
- Finally, modify tcf\_action\_init\_1() to not release the module reference
when overwriting existing action as this is no longer necessary since both
upper and lower layers obtain and manage their own module references
independently.
Fixes: d349f9976868 ("net\_sched: fix RTNL deadlock again caused by request\_module()")
Suggested-by: Cong Wang
Signed-off-by: Vlad Buslov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3d5a5733046b2590ee5b2cd51bb14daf010b722e
Author: Paolo Bonzini
Date: Sat Apr 10 11:12:29 2021 -0400
KVM: x86/mmu: preserve pending TLB flush across calls to kvm\_tdp\_mmu\_zap\_sp
[ Upstream commit 315f02c60d9425b38eb8ad7f21b8a35e40db23f9 ]
Right now, if a call to kvm\_tdp\_mmu\_zap\_sp returns false, the caller
will skip the TLB flush, which is wrong. There are two ways to fix
it:
- since kvm\_tdp\_mmu\_zap\_sp will not yield and therefore will not flush
the TLB itself, we could change the call to kvm\_tdp\_mmu\_zap\_sp to
use "flush |= ..."
- or we can chain the flush argument through kvm\_tdp\_mmu\_zap\_sp down
to \_\_kvm\_tdp\_mmu\_zap\_gfn\_range. Note that kvm\_tdp\_mmu\_zap\_sp will
neither yield nor flush, so flush would never go from true to
false.
This patch does the former to simplify application to stable kernels,
and to make it further clearer that kvm\_tdp\_mmu\_zap\_sp will not flush.
Cc: seanjc@google.com
Fixes: 048f49809c526 ("KVM: x86/mmu: Ensure TLBs are flushed for TDP MMU during NX zapping")
Cc:  # 5.10.x: 048f49809c: KVM: x86/mmu: Ensure TLBs are flushed for TDP MMU during NX zapping
Cc:  # 5.10.x: 33a3164161: KVM: x86/mmu: Don't allow TDP MMU to yield when recovering NX pages
Cc:
Reviewed-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 75cf4240ce73a3e761dc9390487978c8f0bd5ffb
Author: Sean Christopherson
Date: Sat Apr 10 11:12:28 2021 -0400
KVM: x86/mmu: Don't allow TDP MMU to yield when recovering NX pages
[ Upstream commit 33a3164161fc86b9cc238f7f2aa2ccb1d5559b1c ]
Prevent the TDP MMU from yielding when zapping a gfn range during NX
page recovery. If a flush is pending from a previous invocation of the
zapping helper, either in the TDP MMU or the legacy MMU, but the TDP MMU
has not accumulated a flush for the current invocation, then yielding
will release mmu\_lock with stale TLB entries.
That being said, this isn't technically a bug fix in the current code, as
the TDP MMU will never yield in this case. tdp\_mmu\_iter\_cond\_resched()
will yield if and only if it has made forward progress, as defined by the
current gfn vs. the last yielded (or starting) gfn. Because zapping a
single shadow page is guaranteed to (a) find that page and (b) step
sideways at the level of the shadow page, the TDP iter will break its loop
before getting a chance to yield.
But that is all very, very subtle, and will break at the slightest sneeze,
e.g. zapping while holding mmu\_lock for read would break as the TDP MMU
wouldn't be guaranteed to see the present shadow page, and thus could step
sideways at a lower level.
Cc: Ben Gardon
Signed-off-by: Sean Christopherson
Message-Id: <20210325200119.1359384-4-seanjc@google.com>
[Add lockdep assertion. - Paolo]
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit e92475259667743590bf2f8e37c72076b8ae74a1
Author: Sean Christopherson
Date: Sat Apr 10 11:12:27 2021 -0400
KVM: x86/mmu: Ensure TLBs are flushed for TDP MMU during NX zapping
[ Upstream commit 048f49809c526348775425420fb5b8e84fd9a133 ]
Honor the "flush needed" return from kvm\_tdp\_mmu\_zap\_gfn\_range(), which
does the flush itself if and only if it yields (which it will never do in
this particular scenario), and otherwise expects the caller to do the
flush. If pages are zapped from the TDP MMU but not the legacy MMU, then
no flush will occur.
Fixes: 29cf0f5007a2 ("kvm: x86/mmu: NX largepage recovery for TDP MMU")
Cc: stable@vger.kernel.org
Cc: Ben Gardon
Signed-off-by: Sean Christopherson
Message-Id: <20210325200119.1359384-3-seanjc@google.com>
Reviewed-by: Ben Gardon
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit a71471ee61aa3f5d50d68af644beafc6142ffe87
Author: Sean Christopherson
Date: Sat Apr 10 11:12:26 2021 -0400
KVM: x86/mmu: Ensure TLBs are flushed when yielding during GFN range zap
[ Upstream commit a835429cda91621fca915d80672a157b47738afb ]
When flushing a range of GFNs across multiple roots, ensure any pending
flush from a previous root is honored before yielding while walking the
tables of the current root.
Note, kvm\_tdp\_mmu\_zap\_gfn\_range() now intentionally overwrites its local
"flush" with the result to avoid redundant flushes. zap\_gfn\_range()
preserves and return the incoming "flush", unless of course the flush was
performed prior to yielding and no new flush was triggered.
Fixes: 1af4a96025b3 ("KVM: x86/mmu: Yield in TDU MMU iter even if no SPTES changed")
Cc: stable@vger.kernel.org
Reviewed-by: Ben Gardon
Signed-off-by: Sean Christopherson
Message-Id: <20210325200119.1359384-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 9fa3f2f8794ead35d37a8d1350463646a0ffa4fb
Author: Ben Gardon
Date: Sat Apr 10 11:12:25 2021 -0400
KVM: x86/mmu: Yield in TDU MMU iter even if no SPTES changed
[ Upstream commit 1af4a96025b33587ca953c7ef12a1b20c6e70412 ]
Given certain conditions, some TDP MMU functions may not yield
reliably / frequently enough. For example, if a paging structure was
very large but had few, if any writable entries, wrprot\_gfn\_range
could traverse many entries before finding a writable entry and yielding
because the check for yielding only happens after an SPTE is modified.
Fix this issue by moving the yield to the beginning of the loop.
Fixes: a6a0b05da9f3 ("kvm: x86/mmu: Support dirty logging for the TDP MMU")
Reviewed-by: Peter Feiner
Signed-off-by: Ben Gardon
Message-Id: <20210202185734.1680553-15-bgardon@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 2d08b4ae1eb3156e80cb9c77d3ee268d4733e7f6
Author: Ben Gardon
Date: Sat Apr 10 11:12:24 2021 -0400
KVM: x86/mmu: Ensure forward progress when yielding in TDP MMU iter
[ Upstream commit ed5e484b79e8a9b8be714bd85b6fc70bd6dc99a7 ]
In some functions the TDP iter risks not making forward progress if two
threads livelock yielding to one another. This is possible if two threads
are trying to execute wrprot\_gfn\_range. Each could write protect an entry
and then yield. This would reset the tdp\_iter's walk over the paging
structure and the loop would end up repeating the same entry over and
over, preventing either thread from making forward progress.
Fix this issue by only yielding if the loop has made forward progress
since the last yield.
Fixes: a6a0b05da9f3 ("kvm: x86/mmu: Support dirty logging for the TDP MMU")
Reviewed-by: Peter Feiner
Signed-off-by: Ben Gardon
Message-Id: <20210202185734.1680553-14-bgardon@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit a4b9d17cb96728c89ab3cd6ff6c0fb78bcaa945e
Author: Ben Gardon
Date: Sat Apr 10 11:12:23 2021 -0400
KVM: x86/mmu: Rename goal\_gfn to next\_last\_level\_gfn
[ Upstream commit 74953d3530280dc53256054e1906f58d07bfba44 ]
The goal\_gfn field in tdp\_iter can be misleading as it implies that it
is the iterator's final goal. It is really a target for the lowest gfn
mapped by the leaf level SPTE the iterator will traverse towards. Change
the field's name to be more precise.
Signed-off-by: Ben Gardon
Message-Id: <20210202185734.1680553-13-bgardon@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 263d7f6a8a97b1ed290fa2b9bdbd411af3004d67
Author: Ben Gardon
Date: Sat Apr 10 11:12:22 2021 -0400
KVM: x86/mmu: Merge flush and non-flush tdp\_mmu\_iter\_cond\_resched
[ Upstream commit e139a34ef9d5627a41e1c02210229082140d1f92 ]
The flushing and non-flushing variants of tdp\_mmu\_iter\_cond\_resched have
almost identical implementations. Merge the two functions and add a
flush parameter.
Signed-off-by: Ben Gardon
Message-Id: <20210202185734.1680553-12-bgardon@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 15e48657332753dfed71e26c7f1fda703fdda4cc
Author: Ben Gardon
Date: Sat Apr 10 11:12:21 2021 -0400
KVM: x86/mmu: change TDP MMU yield function returns to match cond\_resched
[ Upstream commit e28a436ca4f65384cceaf3f4da0e00aa74244e6a ]
Currently the TDP MMU yield / cond\_resched functions either return
nothing or return true if the TLBs were not flushed. These are confusing
semantics, especially when making control flow decisions in calling
functions.
To clean things up, change both functions to have the same
return value semantics as cond\_resched: true if the thread yielded,
false if it did not. If the function yielded in the \_flush\_ version,
then the TLBs will have been flushed.
Reviewed-by: Peter Feiner
Acked-by: Paolo Bonzini
Signed-off-by: Ben Gardon
Message-Id: <20210202185734.1680553-2-bgardon@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit c4b292e00319908c8fe4e56743f50d019ff3e482
Author: Christophe Leroy
Date: Wed Mar 31 14:14:58 2021 +0000
powerpc/ptrace: Don't return error when getting/setting FP regs without CONFIG\_PPC\_FPU\_REGS
commit 3618250c8399cb36f4a0fbc48610a178307e1c64 upstream.
An #ifdef CONFIG\_PPC\_FPU\_REGS is missing in arch\_ptrace() leading
to the following Oops because [REGSET\_FPR] entry is not initialised in
native\_regsets[].
[ 41.917608] BUG: Unable to handle kernel instruction fetch
[ 41.922849] Faulting instruction address: 0xff8fd228
[ 41.927760] Oops: Kernel access of bad area, sig: 11 [#1]
[ 41.933089] BE PAGE\_SIZE=4K PREEMPT CMPC885
[ 41.940753] Modules linked in:
[ 41.943768] CPU: 0 PID: 366 Comm: gdb Not tainted 5.12.0-rc5-s3k-dev-01666-g7aac86a0f057-dirty #4835
[ 41.952800] NIP: ff8fd228 LR: c004d9e0 CTR: ff8fd228
[ 41.957790] REGS: caae9df0 TRAP: 0400 Not tainted (5.12.0-rc5-s3k-dev-01666-g7aac86a0f057-dirty)
[ 41.966741] MSR: 40009032  CR: 82004248 XER: 20000000
[ 41.973540]
[ 41.973540] GPR00: c004d9b4 caae9eb0 c1b64f60 c1b64520 c0713cd4 caae9eb8 c1bacdfc 00000004
[ 41.973540] GPR08: 00000200 ff8fd228 c1bac700 00001032 28004242 1061aaf4 00000001 106d64a0
[ 41.973540] GPR16: 00000000 00000000 7fa0a774 10610000 7fa0aef9 00000000 10610000 7fa0a538
[ 41.973540] GPR24: 7fa0a580 7fa0a570 c1bacc00 c1b64520 c1bacc00 caae9ee8 00000108 c0713cd4
[ 42.009685] NIP [ff8fd228] 0xff8fd228
[ 42.013300] LR [c004d9e0] \_\_regset\_get+0x100/0x124
[ 42.018036] Call Trace:
[ 42.020443] [caae9eb0] [c004d9b4] \_\_regset\_get+0xd4/0x124 (unreliable)
[ 42.026899] [caae9ee0] [c004da94] copy\_regset\_to\_user+0x5c/0xb0
[ 42.032751] [caae9f10] [c002f640] sys\_ptrace+0xe4/0x588
[ 42.037915] [caae9f30] [c0011010] ret\_from\_syscall+0x0/0x28
[ 42.043422] --- interrupt: c00 at 0xfd1f8e4
[ 42.047553] NIP: 0fd1f8e4 LR: 1004a688 CTR: 00000000
[ 42.052544] REGS: caae9f40 TRAP: 0c00 Not tainted (5.12.0-rc5-s3k-dev-01666-g7aac86a0f057-dirty)
[ 42.061494] MSR: 0000d032  CR: 48004442 XER: 00000000
[ 42.068551]
[ 42.068551] GPR00: 0000001a 7fa0a040 77dad7e0 0000000e 00000170 00000000 7fa0a078 00000004
[ 42.068551] GPR08: 00000000 108deb88 108dda40 106d6010 44004442 1061aaf4 00000001 106d64a0
[ 42.068551] GPR16: 00000000 00000000 7fa0a774 10610000 7fa0aef9 00000000 10610000 7fa0a538
[ 42.068551] GPR24: 7fa0a580 7fa0a570 1078fe00 1078fd70 1078fd70 00000170 0fdd3244 0000000d
[ 42.104696] NIP [0fd1f8e4] 0xfd1f8e4
[ 42.108225] LR [1004a688] 0x1004a688
[ 42.111753] --- interrupt: c00
[ 42.114768] Instruction dump:
[ 42.117698] XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
[ 42.125443] XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX XXXXXXXX
[ 42.133195] ---[ end trace d35616f22ab2100c ]---
Adding the missing #ifdef is not good because gdb doesn't like getting
an error when getting registers.
Instead, make ptrace return 0s when CONFIG\_PPC\_FPU\_REGS is not set.
Fixes: b6254ced4da6 ("powerpc/signal: Don't manage floating point regs when no FPU")
Cc: stable@vger.kernel.org
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/9121a44a2d50ba1af18d8aa5ada06c9a3bea8afd.1617200085.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 8f7d66db9bb157058ca688b08c37fcda7dffef3e
Author: Christophe Leroy
Date: Wed Mar 31 09:12:19 2021 +0000
powerpc/vdso: Make sure vdso\_wrapper.o is rebuilt everytime vdso.so is rebuilt
commit 791f9e36599d94af5a76d3f74d04e16326761aae upstream.
Commit bce74491c300 ("powerpc/vdso: fix unnecessary rebuilds of
vgettimeofday.o") moved vdso32\_wrapper.o and vdso64\_wrapper.o out
of arch/powerpc/kernel/vdso[32/64]/ and removed the dependencies in
the Makefile. This leads to the wrappers not being re-build hence the
kernel embedding the old vdso library.
Add back missing dependencies to ensure vdso32\_wrapper.o and vdso64\_wrapper.o
are rebuilt when vdso32.so.dbg and vdso64.so.dbg are changed.
Fixes: bce74491c300 ("powerpc/vdso: fix unnecessary rebuilds of vgettimeofday.o")
Cc: stable@vger.kernel.org
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/8bb015bc98c51d8ced581415b7e3d157e18da7c9.1617181918.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 9056443b5fc5d3a38d8ebd7137ba048dd838e5c7
Author: Wolfram Sang
Date: Mon Mar 15 12:50:08 2021 +0100
i2c: turn recovery error on init to debug
commit e409a6a3e0690efdef9b8a96197bc61ff117cfaf upstream.
In some configurations, recovery is optional. So, don't throw an error
when it is not used because e.g. pinctrl settings for recovery are not
provided. Reword the message and make it debug output.
Reported-by: Klaus Kudielka
Tested-by: Klaus Kudielka
Signed-off-by: Wolfram Sang
Signed-off-by: Wolfram Sang
Cc: stable@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit bf230ab930547308eacf8650c0ca4f14663469a9
Author: Roman Gushchin
Date: Wed Apr 7 20:57:33 2021 -0700
percpu: make pcpu\_nr\_empty\_pop\_pages per chunk type
commit 0760fa3d8f7fceeea508b98899f1c826e10ffe78 upstream.
nr\_empty\_pop\_pages is used to guarantee that there are some free
populated pages to satisfy atomic allocations. Accounted and
non-accounted allocations are using separate sets of chunks,
so both need to have a surplus of empty pages.
This commit makes pcpu\_nr\_empty\_pop\_pages and the corresponding logic
per chunk type.
[Dennis]
This issue came up as I was reviewing [1] and realized I missed this.
Simultaneously, it was reported btrfs was seeing failed atomic
allocations in fsstress tests [2] and [3].
[1] https://lore.kernel.org/linux-mm/20210324190626.564297-1-guro@fb.com/
[2] https://lore.kernel.org/linux-mm/20210401185158.3275.409509F4@e16-tech.com/
[3] https://lore.kernel.org/linux-mm/CAL3q7H5RNBjCi708GH7jnczAOe0BLnacT9C+OBgA-Dx9jhB6SQ@mail.gmail.com/
Fixes: 3c7be18ac9a0 ("mm: memcg/percpu: account percpu memory to memory cgroups")
Cc: stable@vger.kernel.org # 5.9+
Signed-off-by: Roman Gushchin
Tested-by: Filipe Manana
Signed-off-by: Dennis Zhou
Signed-off-by: Greg Kroah-Hartman
commit 31c068e73da16f85924e0927ae163539a67785ae
Author: Roman Bolshakov
Date: Sun Apr 4 00:54:15 2021 +0300
scsi: target: iscsi: Fix zero tag inside a trace event
commit 0352c3d3959a6cf543075b88c7e662fd3546f12e upstream.
target\_sequencer\_start event is triggered inside target\_cmd\_init\_cdb().
se\_cmd.tag is not initialized with ITT at the moment so the event always
prints zero tag.
Link: https://lore.kernel.org/r/20210403215415.95077-1-r.bolshakov@yadro.com
Cc: stable@vger.kernel.org # 5.10+
Reviewed-by: Mike Christie
Signed-off-by: Roman Bolshakov
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit da79a5b1f0141ec5ec7438643bebaa221c4ad073
Author: Viswas G
Date: Fri Apr 2 11:12:12 2021 +0530
scsi: pm80xx: Fix chip initialization failure
commit 65df7d1986a1909a0869419919e7d9c78d70407e upstream.
Inbound and outbound queues were not properly configured and that lead to
MPI configuration failure.
Fixes: 05c6c029a44d ("scsi: pm80xx: Increase number of supported queues")
Cc: stable@vger.kernel.org # 5.10+
Link: https://lore.kernel.org/r/20210402054212.17834-1-Viswas.G@microchip.com.com
Reported-and-tested-by: Ash Izat
Signed-off-by: Viswas G
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 6a94d0febc4f96b4bfa4e7e2711ff2eff549b353
Author: Saravana Kannan
Date: Thu Apr 1 21:03:40 2021 -0700
driver core: Fix locking bug in deferred\_probe\_timeout\_work\_func()
commit eed6e41813deb9ee622cd9242341f21430d7789f upstream.
list\_for\_each\_entry\_safe() is only useful if we are deleting nodes in a
linked list within the loop. It doesn't protect against other threads
adding/deleting nodes to the list in parallel. We need to grab
deferred\_probe\_mutex when traversing the deferred\_probe\_pending\_list.
Cc: stable@vger.kernel.org
Fixes: 25b4e70dcce9 ("driver core: allow stopping deferred probe after init")
Signed-off-by: Saravana Kannan
Link: https://lore.kernel.org/r/20210402040342.2944858-2-saravanak@google.com
Signed-off-by: Greg Kroah-Hartman
commit 72a598314b5a30c9adee1e0d563031c1fd0f79e2
Author: Shuah Khan
Date: Mon Mar 29 19:36:51 2021 -0600
usbip: synchronize event handler with sysfs code paths
commit 363eaa3a450abb4e63bd6e3ad79d1f7a0f717814 upstream.
Fuzzing uncovered race condition between sysfs code paths in usbip
drivers. Device connect/disconnect code paths initiated through
sysfs interface are prone to races if disconnect happens during
connect and vice versa.
Use sysfs\_lock to synchronize event handler with sysfs paths
in usbip drivers.
Cc: stable@vger.kernel.org
Reported-and-tested-by: syzbot+a93fba6d384346a761e3@syzkaller.appspotmail.com
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/c5c8723d3f29dfe3d759cfaafa7dd16b0dfe2918.1616807117.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit e8e4a8282b1a2ebb71cd633446aa572c462863a9
Author: Shuah Khan
Date: Mon Mar 29 19:36:50 2021 -0600
usbip: vudc synchronize sysfs code paths
commit bd8b82042269a95db48074b8bb400678dbac1815 upstream.
Fuzzing uncovered race condition between sysfs code paths in usbip
drivers. Device connect/disconnect code paths initiated through
sysfs interface are prone to races if disconnect happens during
connect and vice versa.
Use sysfs\_lock to protect sysfs paths in vudc.
Cc: stable@vger.kernel.org
Reported-and-tested-by: syzbot+a93fba6d384346a761e3@syzkaller.appspotmail.com
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/caabcf3fc87bdae970509b5ff32d05bb7ce2fb15.1616807117.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 4f72d804791d3744f51eb8c7b6abdee34f6e2404
Author: Shuah Khan
Date: Mon Mar 29 19:36:49 2021 -0600
usbip: stub-dev synchronize sysfs code paths
commit 9dbf34a834563dada91366c2ac266f32ff34641a upstream.
Fuzzing uncovered race condition between sysfs code paths in usbip
drivers. Device connect/disconnect code paths initiated through
sysfs interface are prone to races if disconnect happens during
connect and vice versa.
Use sysfs\_lock to protect sysfs paths in stub-dev.
Cc: stable@vger.kernel.org
Reported-and-tested-by: syzbot+a93fba6d384346a761e3@syzkaller.appspotmail.com
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/2b182f3561b4a065bf3bf6dce3b0e9944ba17b3f.1616807117.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 32fa3479cd3a034d8d1c431398807f41c2d42bf5
Author: Shuah Khan
Date: Mon Mar 29 19:36:48 2021 -0600
usbip: add sysfs\_lock to synchronize sysfs code paths
commit 4e9c93af7279b059faf5bb1897ee90512b258a12 upstream.
Fuzzing uncovered race condition between sysfs code paths in usbip
drivers. Device connect/disconnect code paths initiated through
sysfs interface are prone to races if disconnect happens during
connect and vice versa.
This problem is common to all drivers while it can be reproduced easily
in vhci\_hcd. Add a sysfs\_lock to usbip\_device struct to protect the paths.
Use this in vhci\_hcd to protect sysfs paths. For a complete fix, usip\_host
and usip-vudc drivers and the event handler will have to use this lock to
protect the paths. These changes will be done in subsequent patches.
Cc: stable@vger.kernel.org
Reported-and-tested-by: syzbot+a93fba6d384346a761e3@syzkaller.appspotmail.com
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/b6568f7beae702bbc236a545d3c020106ca75eac.1616807117.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 6547627a1262ee63859c092c4317a5a6f9b84c04
Author: Dan Carpenter
Date: Mon Mar 29 09:08:01 2021 +0300
thunderbolt: Fix off by one in tb\_port\_find\_retimer()
commit 08fe7ae1857080f5075df5ac7fef2ecd4e289117 upstream.
This array uses 1-based indexing so it corrupts memory one element
beyond of the array. Fix it by making the array one element larger.
Fixes: dacb12877d92 ("thunderbolt: Add support for on-board retimers")
Cc: stable@vger.kernel.org
Signed-off-by: Dan Carpenter
Signed-off-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
commit 7fb9c6165a6f1ecb4dd1c9b042cbc61cc31f4ebd
Author: Dan Carpenter
Date: Mon Mar 29 09:07:18 2021 +0300
thunderbolt: Fix a leak in tb\_retimer\_add()
commit bec4d7c93afc07dd0454ae41c559513f858cfb83 upstream.
After the device\_register() succeeds, then the correct way to clean up
is to call device\_unregister(). The unregister calls both device\_del()
and device\_put(). Since this code was only device\_del() it results in
a memory leak.
Fixes: dacb12877d92 ("thunderbolt: Add support for on-board retimers")
Cc: stable@vger.kernel.org
Signed-off-by: Dan Carpenter
Reviewed-by: Jason Gunthorpe
Signed-off-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
commit 1c453cfc613e02dab9df2866e9548883b338b1fd
Author: Paolo Abeni
Date: Tue Mar 30 18:43:54 2021 +0200
net: let skb\_orphan\_partial wake-up waiters.
commit 9adc89af724f12a03b47099cd943ed54e877cd59 upstream.
Currently the mentioned helper can end-up freeing the socket wmem
without waking-up any processes waiting for more write memory.
If the partially orphaned skb is attached to an UDP (or raw) socket,
the lack of wake-up can hang the user-space.
Even for TCP sockets not calling the sk destructor could have bad
effects on TSQ.
Address the issue using skb\_orphan to release the sk wmem before
setting the new sock\_efree destructor. Additionally bundle the
whole ownership update in a new helper, so that later other
potential users could avoid duplicate code.
v1 -> v2:
- use skb\_orphan() instead of sort of open coding it (Eric)
- provide an helper for the ownership change (Eric)
Fixes: f6ba8d33cfbb ("netem: fix skb\_orphan\_partial()")
Suggested-by: Eric Dumazet
Signed-off-by: Paolo Abeni
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9b4c8b7a3acfab3273bd4640a2a5299e282f3382
Author: Maciej Żenczykowski
Date: Mon Apr 5 00:06:52 2021 -0700
net-ipv6: bugfix - raw & sctp - switch to ipv6\_can\_nonlocal\_bind()
commit 630e4576f83accf90366686f39808d665d8dbecc upstream.
Found by virtue of ipv6 raw sockets not honouring the per-socket
IP{,V6}\_FREEBIND setting.
Based on hits found via:
git grep '[.]ip\_nonlocal\_bind'
We fix both raw ipv6 sockets to honour IP{,V6}\_FREEBIND and IP{,V6}\_TRANSPARENT,
and we fix sctp sockets to honour IP{,V6}\_TRANSPARENT (they already honoured
FREEBIND), and not just the ipv6 'ip\_nonlocal\_bind' sysctl.
The helper is defined as:
static inline bool ipv6\_can\_nonlocal\_bind(struct net \*net, struct inet\_sock \*inet) {
return net->ipv6.sysctl.ip\_nonlocal\_bind || inet->freebind || inet->transparent;
}
so this change only widens the accepted opt-outs and is thus a clean bugfix.
I'm not entirely sure what 'fixes' tag to add, since this is AFAICT an ancient bug,
but IMHO this should be applied to stable kernels as far back as possible.
As such I'm adding a 'fixes' tag with the commit that originally added the helper,
which happened in 4.19. Backporting to older LTS kernels (at least 4.9 and 4.14)
would presumably require open-coding it or backporting the helper as well.
Other possibly relevant commits:
v4.18-rc6-1502-g83ba4645152d net: add helpers checking if socket can be bound to nonlocal address
v4.18-rc6-1431-gd0c1f01138c4 net/ipv6: allow any source address for sendmsg pktinfo with ip\_nonlocal\_bind
v4.14-rc5-271-gb71d21c274ef sctp: full support for ipv6 ip\_nonlocal\_bind & IP\_FREEBIND
v4.7-rc7-1883-g9b9742022888 sctp: support ipv6 nonlocal bind
v4.1-12247-g35a256fee52c ipv6: Nonlocal bind
Cc: Lorenzo Colitti
Fixes: 83ba4645152d ("net: add helpers checking if socket can be bound to nonlocal address")
Signed-off-by: Maciej Żenczykowski
Reviewed-By: Lorenzo Colitti
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5dab4cf331baccff7253996635f4216b167195c0
Author: Kurt Kanzenbach
Date: Tue Apr 6 09:35:09 2021 +0200
net: hsr: Reset MAC header for Tx path
commit 9d6803921a16f4d768dc41a75375629828f4d91e upstream.
Reset MAC header in HSR Tx path. This is needed, because direct packet
transmission, e.g. by specifying PACKET\_QDISC\_BYPASS does not reset the MAC
header.
This has been observed using the following setup:
|$ ip link add name hsr0 type hsr slave1 lan0 slave2 lan1 supervision 45 version 1
|$ ifconfig hsr0 up
|$ ./test hsr0
The test binary is using mmap'ed sockets and is specifying the
PACKET\_QDISC\_BYPASS socket option.
This patch resolves the following warning on a non-patched kernel:
|[ 112.725394] ------------[ cut here ]------------
|[ 112.731418] WARNING: CPU: 1 PID: 257 at net/hsr/hsr\_forward.c:560 hsr\_forward\_skb+0x484/0x568
|[ 112.739962] net/hsr/hsr\_forward.c:560: Malformed frame (port\_src hsr0)
The warning can be safely removed, because the other call sites of
hsr\_forward\_skb() make sure that the skb is prepared correctly.
Fixes: d346a3fae3ff ("packet: introduce PACKET\_QDISC\_BYPASS socket option")
Signed-off-by: Kurt Kanzenbach
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e04756ed464aeb8f1a6289f0f7bf9a4a660b9fb9
Author: Johannes Berg
Date: Tue Mar 23 21:05:01 2021 +0100
mac80211: fix TXQ AC confusion
commit 1153a74768a9212daadbb50767aa400bc6a0c9b0 upstream.
Normally, TXQs have
txq->tid = tid;
txq->ac = ieee80211\_ac\_from\_tid(tid);
However, the special management TXQ actually has
txq->tid = IEEE80211\_NUM\_TIDS; // 16
txq->ac = IEEE80211\_AC\_VO;
This makes sense, but ieee80211\_ac\_from\_tid(16) is the same
as ieee80211\_ac\_from\_tid(0) which is just IEEE80211\_AC\_BE.
Now, normally this is fine. However, if the netdev queues
were stopped, then the code in ieee80211\_tx\_dequeue() will
propagate the stop from the interface (vif->txqs\_stopped[])
if the AC 2 (ieee80211\_ac\_from\_tid(txq->tid)) is marked as
stopped. On wake, however, \_\_ieee80211\_wake\_txqs() will wake
the TXQ if AC 0 (txq->ac) is woken up.
If a driver stops all queues with ieee80211\_stop\_tx\_queues()
and then wakes them again with ieee80211\_wake\_tx\_queues(),
the ieee80211\_wake\_txqs() tasklet will run to resync queue
and TXQ state. If all queues were woken, then what'll happen
is that \_ieee80211\_wake\_txqs() will run in order of HW queues
0-3, typically (and certainly for iwlwifi) corresponding to
ACs 0-3, so it'll call \_\_ieee80211\_wake\_txqs() for each AC in
order 0-3.
When \_\_ieee80211\_wake\_txqs() is called for AC 0 (VO) that'll
wake up the management TXQ (remember its tid is 16), and the
driver's wake\_tx\_queue() will be called. That tries to get a
frame, which will immediately \*stop\* the TXQ again, because
now we check against AC 2, and AC 2 hasn't yet been marked as
woken up again in sdata->vif.txqs\_stopped[] since we're only
in the \_\_ieee80211\_wake\_txqs() call for AC 0.
Thus, the management TXQ will never be started again.
Fix this by checking txq->ac directly instead of calculating
the AC as ieee80211\_ac\_from\_tid(txq->tid).
Fixes: adf8ed01e4fd ("mac80211: add an optional TXQ for other PS-buffered frames")
Acked-by: Toke Høiland-Jørgensen
Link: https://lore.kernel.org/r/20210323210500.bf4d50afea4a.I136ffde910486301f8818f5442e3c9bf8670a9c4@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 482295dfa848d0acf0d539193f26296ecf9796a1
Author: Ben Greear
Date: Tue Mar 30 16:07:49 2021 -0700
mac80211: fix time-is-after bug in mlme
commit 7d73cd946d4bc7d44cdc5121b1c61d5d71425dea upstream.
The incorrect timeout check caused probing to happen when it did
not need to happen. This in turn caused tx performance drop
for around 5 seconds in ath10k-ct driver. Possibly that tx drop
is due to a secondary issue, but fixing the probe to not happen
when traffic is running fixes the symptom.
Signed-off-by: Ben Greear
Fixes: 9abf4e49830d ("mac80211: optimize station connection monitor")
Acked-by: Felix Fietkau
Link: https://lore.kernel.org/r/20210330230749.14097-1-greearb@candelatech.com
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 302bcd6b7099721a807a31b1f6a6f4e577eebf69
Author: Johannes Berg
Date: Thu Apr 8 14:28:27 2021 +0200
cfg80211: check S1G beacon compat element length
commit b5ac0146492fc5c199de767e492be8a66471011a upstream.
We need to check the length of this element so that we don't
access data beyond its end. Fix that.
Fixes: 9eaffe5078ca ("cfg80211: convert S1G beacon to scan results")
Link: https://lore.kernel.org/r/20210408142826.f6f4525012de.I9fdeff0afdc683a6024e5ea49d2daa3cd2459d11@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 68bd15828044ec2241e9e60db9a2a350b4175288
Author: Johannes Berg
Date: Thu Apr 8 14:28:34 2021 +0200
nl80211: fix potential leak of ACL params
commit abaf94ecc9c356d0b885a84edef4905cdd89cfdd upstream.
In case nl80211\_parse\_unsol\_bcast\_probe\_resp() results in an
error, need to "goto out" instead of just returning to free
possibly allocated data.
Fixes: 7443dcd1f171 ("nl80211: Unsolicited broadcast probe response support")
Link: https://lore.kernel.org/r/20210408142833.d8bc2e2e454a.If290b1ba85789726a671ff0b237726d4851b5b0f@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 106ae6e854ac2ab01007ff10cef273f086eabf4c
Author: Johannes Berg
Date: Thu Apr 8 15:45:20 2021 +0200
nl80211: fix beacon head validation
commit 9a6847ba1747858ccac53c5aba3e25c54fbdf846 upstream.
If the beacon head attribute (NL80211\_ATTR\_BEACON\_HEAD)
is too short to even contain the frame control field,
we access uninitialized data beyond the buffer. Fix this
by checking the minimal required size first. We used to
do this until S1G support was added, where the fixed
data portion has a different size.
Reported-and-tested-by: syzbot+72b99dcf4607e8c770f3@syzkaller.appspotmail.com
Suggested-by: Eric Dumazet
Fixes: 1d47f1198d58 ("nl80211: correctly validate S1G beacon head")
Signed-off-by: Johannes Berg
Link: https://lore.kernel.org/r/20210408154518.d9b06d39b4ee.Iff908997b2a4067e8d456b3cb96cab9771d252b8@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 4ff14b582bd4db186bbc4ee5b6ad191ddd2736af
Author: Vlad Buslov
Date: Wed Apr 7 18:36:03 2021 +0300
net: sched: fix action overwrite reference counting
commit 87c750e8c38bce706eb32e4d8f1e3402f2cebbd4 upstream.
Action init code increments reference counter when it changes an action.
This is the desired behavior for cls API which needs to obtain action
reference for every classifier that points to action. However, act API just
needs to change the action and releases the reference before returning.
This sequence breaks when the requested action doesn't exist, which causes
act API init code to create new action with specified index, but action is
still released before returning and is deleted (unless it was referenced
concurrently by cls API).
Reproduction:
$ sudo tc actions ls action gact
$ sudo tc actions change action gact drop index 1
$ sudo tc actions ls action gact
Extend tcf\_action\_init() to accept 'init\_res' array and initialize it with
action->ops->init() result. In tcf\_action\_add() remove pointers to created
actions from actions array before passing it to tcf\_action\_put\_many().
Fixes: cae422f379f3 ("net: sched: use reference counting action init")
Reported-by: Kumar Kartikeya Dwivedi
Signed-off-by: Vlad Buslov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 69187263a358a1fcdeeb70aa9273e36b55ebce52
Author: Pavel Tikhomirov
Date: Thu Apr 8 18:14:31 2021 +0300
net: sched: sch\_teql: fix null-pointer dereference
commit 1ffbc7ea91606e4abd10eb60de5367f1c86daf5e upstream.
Reproduce:
modprobe sch\_teql
tc qdisc add dev teql0 root teql0
This leads to (for instance in Centos 7 VM) OOPS:
[ 532.366633] BUG: unable to handle kernel NULL pointer dereference at 00000000000000a8
[ 532.366733] IP: [] teql\_destroy+0x18/0x100 [sch\_teql]
[ 532.366825] PGD 80000001376d5067 PUD 137e37067 PMD 0
[ 532.366906] Oops: 0000 [#1] SMP
[ 532.366987] Modules linked in: sch\_teql ...
[ 532.367945] CPU: 1 PID: 3026 Comm: tc Kdump: loaded Tainted: G ------------ T 3.10.0-1062.7.1.el7.x86\_64 #1
[ 532.368041] Hardware name: Virtuozzo KVM, BIOS 1.11.0-2.vz7.2 04/01/2014
[ 532.368125] task: ffff8b7d37d31070 ti: ffff8b7c9fdbc000 task.ti: ffff8b7c9fdbc000
[ 532.368224] RIP: 0010:[] [] teql\_destroy+0x18/0x100 [sch\_teql]
[ 532.368320] RSP: 0018:ffff8b7c9fdbf8e0 EFLAGS: 00010286
[ 532.368394] RAX: ffffffffc0612490 RBX: ffff8b7cb1565e00 RCX: ffff8b7d35ba2000
[ 532.368476] RDX: ffff8b7d35ba2000 RSI: 0000000000000000 RDI: ffff8b7cb1565e00
[ 532.368557] RBP: ffff8b7c9fdbf8f8 R08: ffff8b7d3fd1f140 R09: ffff8b7d3b001600
[ 532.368638] R10: ffff8b7d3b001600 R11: ffffffff84c7d65b R12: 00000000ffffffd8
[ 532.368719] R13: 0000000000008000 R14: ffff8b7d35ba2000 R15: ffff8b7c9fdbf9a8
[ 532.368800] FS: 00007f6a4e872740(0000) GS:ffff8b7d3fd00000(0000) knlGS:0000000000000000
[ 532.368885] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 532.368961] CR2: 00000000000000a8 CR3: 00000001396ee000 CR4: 00000000000206e0
[ 532.369046] Call Trace:
[ 532.369159] [] qdisc\_create+0x36e/0x450
[ 532.369268] [] ? ns\_capable+0x29/0x50
[ 532.369366] [] ? nla\_parse+0x32/0x120
[ 532.369442] [] tc\_modify\_qdisc+0x13c/0x610
[ 532.371508] [] rtnetlink\_rcv\_msg+0xa7/0x260
[ 532.372668] [] ? sock\_has\_perm+0x75/0x90
[ 532.373790] [] ? rtnl\_newlink+0x890/0x890
[ 532.374914] [] netlink\_rcv\_skb+0xab/0xc0
[ 532.376055] [] rtnetlink\_rcv+0x28/0x30
[ 532.377204] [] netlink\_unicast+0x170/0x210
[ 532.378333] [] netlink\_sendmsg+0x308/0x420
[ 532.379465] [] sock\_sendmsg+0xb6/0xf0
[ 532.380710] [] ? \_\_xfs\_filemap\_fault+0x8e/0x1d0 [xfs]
[ 532.381868] [] ? xfs\_filemap\_fault+0x2c/0x30 [xfs]
[ 532.383037] [] ? \_\_do\_fault.isra.61+0x8a/0x100
[ 532.384144] [] \_\_\_sys\_sendmsg+0x3e9/0x400
[ 532.385268] [] ? handle\_mm\_fault+0x39d/0x9b0
[ 532.386387] [] ? \_\_do\_page\_fault+0x238/0x500
[ 532.387472] [] \_\_sys\_sendmsg+0x51/0x90
[ 532.388560] [] SyS\_sendmsg+0x12/0x20
[ 532.389636] [] system\_call\_fastpath+0x25/0x2a
[ 532.390704] [] ? system\_call\_after\_swapgs+0xae/0x146
[ 532.391753] Code: 00 00 00 00 00 00 5b 5d c3 66 2e 0f 1f 84 00 00 00 00 00 66 66 66 66 90 55 48 89 e5 41 55 41 54 53 48 8b b7 48 01 00 00 48 89 fb <48> 8b 8e a8 00 00 00 48 85 c9 74 43 48 89 ca eb 0f 0f 1f 80 00
[ 532.394036] RIP [] teql\_destroy+0x18/0x100 [sch\_teql]
[ 532.395127] RSP
[ 532.396179] CR2: 00000000000000a8
Null pointer dereference happens on master->slaves dereference in
teql\_destroy() as master is null-pointer.
When qdisc\_create() calls teql\_qdisc\_init() it imediately fails after
check "if (m->dev == dev)" because both devices are teql0, and it does
not set qdisc\_priv(sch)->m leaving it zero on error path, then
qdisc\_create() imediately calls teql\_destroy() which does not expect
zero master pointer and we get OOPS.
Fixes: 87b60cfacf9f ("net\_sched: fix error recovery at qdisc creation")
Signed-off-by: Pavel Tikhomirov
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5fc89b0942a5180be530171ceb4e8ca7d1785be4
Author: Eli Cohen
Date: Thu Apr 8 12:10:47 2021 +0300
vdpa/mlx5: Fix suspend/resume index restoration
commit bc04d93ea30a0a8eb2a2648b848cef35d1f6f798 upstream.
When we suspend the VM, the VDPA interface will be reset. When the VM is
resumed again, clear\_virtqueues() will clear the available and used
indices resulting in hardware virqtqueue objects becoming out of sync.
We can avoid this function alltogether since qemu will clear them if
required, e.g. when the VM went through a reboot.
Moreover, since the hw available and used indices should always be
identical on query and should be restored to the same value same value
for virtqueues that complete in order, we set the single value provided
by set\_vq\_state(). In get\_vq\_state() we return the value of hardware
used index.
Fixes: b35ccebe3ef7 ("vdpa/mlx5: Restore the hardware used index after change map")
Fixes: 1a86b377aa21 ("vdpa/mlx5: Add VDPA driver for supported mlx5 devices")
Signed-off-by: Eli Cohen
Link: https://lore.kernel.org/r/20210408091047.4269-6-elic@nvidia.com
Signed-off-by: Michael S. Tsirkin
Acked-by: Jason Wang
Signed-off-by: Greg Kroah-Hartman
commit 09c0736883832d2e3f7e92adff7594be94dd847b
Author: Arkadiusz Kubalewski
Date: Fri Mar 26 19:43:40 2021 +0100
i40e: Fix sparse errors in i40e\_txrx.c
commit 12738ac4754ec92a6a45bf3677d8da780a1412b3 upstream.
Remove error handling through pointers. Instead use plain int
to return value from i40e\_run\_xdp(...).
Previously:
- sparse errors were produced during compilation:
i40e\_txrx.c:2338 i40e\_run\_xdp() error: (-2147483647) too low for ERR\_PTR
i40e\_txrx.c:2558 i40e\_clean\_rx\_irq() error: 'skb' dereferencing possible ERR\_PTR()
- sk\_buff\* was used to return value, but it has never had valid
pointer to sk\_buff. Returned value was always int handled as
a pointer.
Fixes: 0c8493d90b6b ("i40e: add XDP support for pass and drop actions")
Fixes: 2e6893123830 ("i40e: split XDP\_TX tail and XDP\_REDIRECT map flushing")
Signed-off-by: Aleksandr Loktionov
Signed-off-by: Arkadiusz Kubalewski
Tested-by: Dave Switzer
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 0b8496ce20693eeccc179227ff38f743aa5de2f5
Author: Arkadiusz Kubalewski
Date: Fri Mar 26 19:43:41 2021 +0100
i40e: Fix sparse error: uninitialized symbol 'ring'
commit d6d04ee6d2c9bb5084c8f6074195d6aa0024e825 upstream.
Init pointer with NULL in default switch case statement.
Previously the error was produced when compiling against sparse.
i40e\_debugfs.c:582 i40e\_dbg\_dump\_desc() error: uninitialized symbol 'ring'.
Fixes: 44ea803e2fa7 ("i40e: introduce new dump desc XDP command")
Signed-off-by: Aleksandr Loktionov
Signed-off-by: Arkadiusz Kubalewski
Tested-by: Dave Switzer
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit f17f77fb3855006be3fdcdb3c472f16b853eee75
Author: Arkadiusz Kubalewski
Date: Fri Mar 26 19:43:42 2021 +0100
i40e: Fix sparse error: 'vsi->netdev' could be null
commit 6b5674fe6b9bf05394886ebcec62b2d7dae88c42 upstream.
Remove vsi->netdev->name from the trace.
This is redundant information. With the devinfo trace, the adapter
is already identifiable.
Previously following error was produced when compiling against sparse.
i40e\_main.c:2571 i40e\_sync\_vsi\_filters() error:
we previously assumed 'vsi->netdev' could be null (see line 2323)
Fixes: b603f9dc20af ("i40e: Log info when PF is entering and leaving Allmulti mode.")
Signed-off-by: Aleksandr Loktionov
Signed-off-by: Arkadiusz Kubalewski
Tested-by: Dave Switzer
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 3a1cc64a2b8effb2f79c1b91c31c2918fd3dd58e
Author: Arkadiusz Kubalewski
Date: Fri Mar 26 19:43:43 2021 +0100
i40e: Fix sparse warning: missing error code 'err'
commit 8a1e918d833ca5c391c4ded5dc006e2d1ce6d37c upstream.
Set proper return values inside error checking if-statements.
Previously following warning was produced when compiling against sparse.
i40e\_main.c:15162 i40e\_init\_recovery\_mode() warn: missing error code 'err'
Fixes: 4ff0ee1af0169 ("i40e: Introduce recovery mode support")
Signed-off-by: Aleksandr Loktionov
Signed-off-by: Arkadiusz Kubalewski
Tested-by: Dave Switzer
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 30261f0f6848eba74168afbc01fe6ab333ad10a4
Author: Eric Dumazet
Date: Tue Mar 30 16:43:43 2021 -0700
net: ensure mac header is set in virtio\_net\_hdr\_to\_skb()
commit 61431a5907fc36d0738e9a547c7e1556349a03e9 upstream.
Commit 924a9bc362a5 ("net: check if protocol extracted by virtio\_net\_hdr\_set\_proto is correct")
added a call to dev\_parse\_header\_protocol() but mac\_header is not yet set.
This means that eth\_hdr() reads complete garbage, and syzbot complained about it [1]
This patch resets mac\_header earlier, to get more coverage about this change.
Audit of virtio\_net\_hdr\_to\_skb() callers shows that this change should be safe.
[1]
BUG: KASAN: use-after-free in eth\_header\_parse\_protocol+0xdc/0xe0 net/ethernet/eth.c:282
Read of size 2 at addr ffff888017a6200b by task syz-executor313/8409
CPU: 1 PID: 8409 Comm: syz-executor313 Not tainted 5.12.0-rc2-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:79 [inline]
dump\_stack+0x141/0x1d7 lib/dump\_stack.c:120
print\_address\_description.constprop.0.cold+0x5b/0x2f8 mm/kasan/report.c:232
\_\_kasan\_report mm/kasan/report.c:399 [inline]
kasan\_report.cold+0x7c/0xd8 mm/kasan/report.c:416
eth\_header\_parse\_protocol+0xdc/0xe0 net/ethernet/eth.c:282
dev\_parse\_header\_protocol include/linux/netdevice.h:3177 [inline]
virtio\_net\_hdr\_to\_skb.constprop.0+0x99d/0xcd0 include/linux/virtio\_net.h:83
packet\_snd net/packet/af\_packet.c:2994 [inline]
packet\_sendmsg+0x2325/0x52b0 net/packet/af\_packet.c:3031
sock\_sendmsg\_nosec net/socket.c:654 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:674
sock\_no\_sendpage+0xf3/0x130 net/core/sock.c:2860
kernel\_sendpage.part.0+0x1ab/0x350 net/socket.c:3631
kernel\_sendpage net/socket.c:3628 [inline]
sock\_sendpage+0xe5/0x140 net/socket.c:947
pipe\_to\_sendpage+0x2ad/0x380 fs/splice.c:364
splice\_from\_pipe\_feed fs/splice.c:418 [inline]
\_\_splice\_from\_pipe+0x43e/0x8a0 fs/splice.c:562
splice\_from\_pipe fs/splice.c:597 [inline]
generic\_splice\_sendpage+0xd4/0x140 fs/splice.c:746
do\_splice\_from fs/splice.c:767 [inline]
do\_splice+0xb7e/0x1940 fs/splice.c:1079
\_\_do\_splice+0x134/0x250 fs/splice.c:1144
\_\_do\_sys\_splice fs/splice.c:1350 [inline]
\_\_se\_sys\_splice fs/splice.c:1332 [inline]
\_\_x64\_sys\_splice+0x198/0x250 fs/splice.c:1332
do\_syscall\_64+0x2d/0x70 arch/x86/entry/common.c:46
Fixes: 924a9bc362a5 ("net: check if protocol extracted by virtio\_net\_hdr\_set\_proto is correct")
Signed-off-by: Eric Dumazet
Cc: Balazs Nemeth
Cc: Willem de Bruijn
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a2b85e0b0b80574a825560374fd2a99ab376e739
Author: John Fastabend
Date: Thu Apr 1 15:00:40 2021 -0700
bpf, sockmap: Fix incorrect fwd\_alloc accounting
commit 144748eb0c445091466c9b741ebd0bfcc5914f3d upstream.
Incorrect accounting fwd\_alloc can result in a warning when the socket
is torn down,
[18455.319240] WARNING: CPU: 0 PID: 24075 at net/core/stream.c:208 sk\_stream\_kill\_queues+0x21f/0x230
[...]
[18455.319543] Call Trace:
[18455.319556] inet\_csk\_destroy\_sock+0xba/0x1f0
[18455.319577] tcp\_rcv\_state\_process+0x1b4e/0x2380
[18455.319593] ? lock\_downgrade+0x3a0/0x3a0
[18455.319617] ? tcp\_finish\_connect+0x1e0/0x1e0
[18455.319631] ? sk\_reset\_timer+0x15/0x70
[18455.319646] ? tcp\_schedule\_loss\_probe+0x1b2/0x240
[18455.319663] ? lock\_release+0xb2/0x3f0
[18455.319676] ? \_\_release\_sock+0x8a/0x1b0
[18455.319690] ? lock\_downgrade+0x3a0/0x3a0
[18455.319704] ? lock\_release+0x3f0/0x3f0
[18455.319717] ? \_\_tcp\_close+0x2c6/0x790
[18455.319736] ? tcp\_v4\_do\_rcv+0x168/0x370
[18455.319750] tcp\_v4\_do\_rcv+0x168/0x370
[18455.319767] \_\_release\_sock+0xbc/0x1b0
[18455.319785] \_\_tcp\_close+0x2ee/0x790
[18455.319805] tcp\_close+0x20/0x80
This currently happens because on redirect case we do skb\_set\_owner\_r()
with the original sock. This increments the fwd\_alloc memory accounting
on the original sock. Then on redirect we may push this into the queue
of the psock we are redirecting to. When the skb is flushed from the
queue we give the memory back to the original sock. The problem is if
the original sock is destroyed/closed with skbs on another psocks queue
then the original sock will not have a way to reclaim the memory before
being destroyed. Then above warning will be thrown
sockA sockB
sk\_psock\_strp\_read()
sk\_psock\_verdict\_apply()
-- SK\_REDIRECT --
sk\_psock\_skb\_redirect()
skb\_queue\_tail(psock\_other->ingress\_skb..)
sk\_close()
sock\_map\_unref()
sk\_psock\_put()
sk\_psock\_drop()
sk\_psock\_zap\_ingress()
At this point we have torn down our own psock, but have the outstanding
skb in psock\_other. Note that SK\_PASS doesn't have this problem because
the sk\_psock\_drop() logic releases the skb, its still associated with
our psock.
To resolve lets only account for sockets on the ingress queue that are
still associated with the current socket. On the redirect case we will
check memory limits per 6fa9201a89898, but will omit fwd\_alloc accounting
until skb is actually enqueued. When the skb is sent via skb\_send\_sock\_locked
or received with sk\_psock\_skb\_ingress memory will be claimed on psock\_other.
Fixes: 6fa9201a89898 ("bpf, sockmap: Avoid returning unneeded EAGAIN when redirecting to self")
Reported-by: Andrii Nakryiko
Signed-off-by: John Fastabend
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/161731444013.68884.4021114312848535993.stgit@john-XPS-13-9370
Signed-off-by: Greg Kroah-Hartman
commit f415b3c981dee376dd3745208c7c93d1201039cc
Author: John Fastabend
Date: Thu Apr 1 15:00:19 2021 -0700
bpf, sockmap: Fix sk->prot unhash op reset
commit 1c84b33101c82683dee8b06761ca1f69e78c8ee7 upstream.
In '4da6a196f93b1' we fixed a potential unhash loop caused when
a TLS socket in a sockmap was removed from the sockmap. This
happened because the unhash operation on the TLS ctx continued
to point at the sockmap implementation of unhash even though the
psock has already been removed. The sockmap unhash handler when a
psock is removed does the following,
void sock\_map\_unhash(struct sock \*sk)
{
void (\*saved\_unhash)(struct sock \*sk);
struct sk\_psock \*psock;
rcu\_read\_lock();
psock = sk\_psock(sk);
if (unlikely(!psock)) {
rcu\_read\_unlock();
if (sk->sk\_prot->unhash)
sk->sk\_prot->unhash(sk);
return;
}
[...]
}
The unlikely() case is there to handle the case where psock is detached
but the proto ops have not been updated yet. But, in the above case
with TLS and removed psock we never fixed sk\_prot->unhash() and unhash()
points back to sock\_map\_unhash resulting in a loop. To fix this we added
this bit of code,
static inline void sk\_psock\_restore\_proto(struct sock \*sk,
struct sk\_psock \*psock)
{
sk->sk\_prot->unhash = psock->saved\_unhash;
This will set the sk\_prot->unhash back to its saved value. This is the
correct callback for a TLS socket that has been removed from the sock\_map.
Unfortunately, this also overwrites the unhash pointer for all psocks.
We effectively break sockmap unhash handling for any future socks.
Omitting the unhash operation will leave stale entries in the map if
a socket transition through unhash, but does not do close() op.
To fix set unhash correctly before calling into tls\_update. This way the
TLS enabled socket will point to the saved unhash() handler.
Fixes: 4da6a196f93b1 ("bpf: Sockmap/tls, during free we may call tcp\_bpf\_unhash() in loop")
Reported-by: Cong Wang
Reported-by: Lorenz Bauer
Suggested-by: Cong Wang
Signed-off-by: John Fastabend
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/161731441904.68884.15593917809745631972.stgit@john-XPS-13-9370
Signed-off-by: Greg Kroah-Hartman
commit 9c020a533eaae1c2d41a7e3835c4c818a9b4b656
Author: Dave Marchevsky
Date: Wed Mar 31 17:07:47 2021 -0700
bpf: Refcount task stack in bpf\_get\_task\_stack
commit 06ab134ce8ecfa5a69e850f88f81c8a4c3fa91df upstream.
On x86 the struct pt\_regs \* grabbed by task\_pt\_regs() points to an
offset of task->stack. The pt\_regs are later dereferenced in
\_\_bpf\_get\_stack (e.g. by user\_mode() check). This can cause a fault if
the task in question exits while bpf\_get\_task\_stack is executing, as
warned by task\_stack\_page's comment:
\* When accessing the stack of a non-current task that might exit, use
\* try\_get\_task\_stack() instead. task\_stack\_page will return a pointer
\* that could get freed out from under you.
Taking the comment's advice and using try\_get\_task\_stack() and
put\_task\_stack() to hold task->stack refcount, or bail early if it's
already 0. Incrementing stack\_refcount will ensure the task's stack
sticks around while we're using its data.
I noticed this bug while testing a bpf task iter similar to
bpf\_iter\_task\_stack in selftests, except mine grabbed user stack, and
getting intermittent crashes, which resulted in dumps like:
BUG: unable to handle page fault for address: 0000000000003fe0
\#PF: supervisor read access in kernel mode
\#PF: error\_code(0x0000) - not-present page
RIP: 0010:\_\_bpf\_get\_stack+0xd0/0x230
Call Trace:
bpf\_prog\_0a2be35c092cb190\_get\_task\_stacks+0x5d/0x3ec
bpf\_iter\_run\_prog+0x24/0x81
\_\_task\_seq\_show+0x58/0x80
bpf\_seq\_read+0xf7/0x3d0
vfs\_read+0x91/0x140
ksys\_read+0x59/0xd0
do\_syscall\_64+0x48/0x120
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
Fixes: fa28dcb82a38 ("bpf: Introduce helper bpf\_get\_task\_stack()")
Signed-off-by: Dave Marchevsky
Signed-off-by: Alexei Starovoitov
Acked-by: Song Liu
Link: https://lore.kernel.org/bpf/20210401000747.3648767-1-davemarchevsky@fb.com
Signed-off-by: Greg Kroah-Hartman
commit 68629be80fc6e0f9d44e779972e0ab8595933fda
Author: Ciara Loftus
Date: Wed Mar 31 06:12:18 2021 +0000
libbpf: Only create rx and tx XDP rings when necessary
commit ca7a83e2487ad0bc9a3e0e7a8645354aa1782f13 upstream.
Prior to this commit xsk\_socket\_\_create(\_shared) always attempted to create
the rx and tx rings for the socket. However this causes an issue when the
socket being setup is that which shares the fd with the UMEM. If a
previous call to this function failed with this socket after the rings were
set up, a subsequent call would always fail because the rings are not torn
down after the first call and when we try to set them up again we encounter
an error because they already exist. Solve this by remembering whether the
rings were set up by introducing new bools to struct xsk\_umem which
represent the ring setup status and using them to determine whether or
not to set up the rings.
Fixes: 1cad07884239 ("libbpf: add support for using AF\_XDP sockets")
Signed-off-by: Ciara Loftus
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20210331061218.1647-4-ciara.loftus@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 00b6712eae9f046cb6f820a9ff9fd6b966f01f9c
Author: Ciara Loftus
Date: Wed Mar 31 06:12:17 2021 +0000
libbpf: Restore umem state after socket create failure
commit 43f1bc1efff16f553dd573d02eb7a15750925568 upstream.
If the call to xsk\_socket\_\_create fails, the user may want to retry the
socket creation using the same umem. Ensure that the umem is in the
same state on exit if the call fails by:
1. ensuring the umem \_save pointers are unmodified.
2. not unmapping the set of umem rings that were set up with the umem
during xsk\_umem\_\_create, since those maps existed before the call to
xsk\_socket\_\_create and should remain in tact even in the event of
failure.
Fixes: 2f6324a3937f ("libbpf: Support shared umems between queues and devices")
Signed-off-by: Ciara Loftus
Signed-off-by: Alexei Starovoitov
Link: https://lore.kernel.org/bpf/20210331061218.1647-3-ciara.loftus@intel.com
Signed-off-by: Greg Kroah-Hartman
commit b34f81c3d1a62bb2482c49f7b3affcbe8330447f
Author: Ciara Loftus
Date: Wed Mar 31 06:12:16 2021 +0000
libbpf: Ensure umem pointer is non-NULL before dereferencing
commit df662016310aa4475d7986fd726af45c8fe4f362 upstream.
Calls to xsk\_socket\_\_create dereference the umem to access the
fill\_save and comp\_save pointers. Make sure the umem is non-NULL
before doing this.
Fixes: 2f6324a3937f ("libbpf: Support shared umems between queues and devices")
Signed-off-by: Ciara Loftus
Signed-off-by: Alexei Starovoitov
Acked-by: Magnus Karlsson
Link: https://lore.kernel.org/bpf/20210331061218.1647-2-ciara.loftus@intel.com
Signed-off-by: Greg Kroah-Hartman
commit a2dfc5f4b3bd44f96326454ccd5a9e415f9f87c5
Author: Lv Yunlong
Date: Mon Mar 29 04:50:02 2021 -0700
ethernet/netronome/nfp: Fix a use after free in nfp\_bpf\_ctrl\_msg\_rx
commit 6e5a03bcba44e080a6bf300194a68ce9bb1e5184 upstream.
In nfp\_bpf\_ctrl\_msg\_rx, if
nfp\_ccm\_get\_type(skb) == NFP\_CCM\_TYPE\_BPF\_BPF\_EVENT is true, the skb
will be freed. But the skb is still used by nfp\_ccm\_rx(&bpf->ccm, skb).
My patch adds a return when the skb was freed.
Fixes: bcf0cafab44fd ("nfp: split out common control message handling code")
Signed-off-by: Lv Yunlong
Reviewed-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 430c0278903a7c5af3ed70ea4a8af915de51273d
Author: Lorenz Bauer
Date: Fri Mar 26 16:05:00 2021 +0000
bpf: link: Refuse non-O\_RDWR flags in BPF\_OBJ\_GET
commit 25fc94b2f02d832fa8e29419699dcc20b0b05c6a upstream.
Invoking BPF\_OBJ\_GET on a pinned bpf\_link checks the path access
permissions based on file\_flags, but the returned fd ignores flags.
This means that any user can acquire a "read-write" fd for a pinned
link with mode 0664 by invoking BPF\_OBJ\_GET with BPF\_F\_RDONLY in
file\_flags. The fd can be used to invoke BPF\_LINK\_DETACH, etc.
Fix this by refusing non-O\_RDWR flags in BPF\_OBJ\_GET. This works
because OBJ\_GET by default returns a read write mapping and libbpf
doesn't expose a way to override this behaviour for programs
and links.
Fixes: 70ed506c3bbc ("bpf: Introduce pinnable bpf\_link abstraction")
Signed-off-by: Lorenz Bauer
Signed-off-by: Alexei Starovoitov
Acked-by: Andrii Nakryiko
Acked-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20210326160501.46234-1-lmb@cloudflare.com
Signed-off-by: Greg Kroah-Hartman
commit f1d57bf095a8e202ba5a518933d672d37d58f676
Author: Toke Høiland-Jørgensen
Date: Fri Mar 26 11:03:13 2021 +0100
bpf: Enforce that struct\_ops programs be GPL-only
commit 12aa8a9467b354ef893ce0fc5719a4de4949a9fb upstream.
With the introduction of the struct\_ops program type, it became possible to
implement kernel functionality in BPF, making it viable to use BPF in place
of a regular kernel module for these particular operations.
Thus far, the only user of this mechanism is for implementing TCP
congestion control algorithms. These are clearly marked as GPL-only when
implemented as modules (as seen by the use of EXPORT\_SYMBOL\_GPL for
tcp\_register\_congestion\_control()), so it seems like an oversight that this
was not carried over to BPF implementations. Since this is the only user
of the struct\_ops mechanism, just enforcing GPL-only for the struct\_ops
program type seems like the simplest way to fix this.
Fixes: 0baf26b0fcd7 ("bpf: tcp: Support tcp\_congestion\_ops in bpf")
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Daniel Borkmann
Acked-by: Martin KaFai Lau
Link: https://lore.kernel.org/bpf/20210326100314.121853-1-toke@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit a6a96bddfb42119fe515b58903e71a706350dd3b
Author: Pedro Tammela
Date: Thu Mar 25 12:01:15 2021 -0300
libbpf: Fix bail out from 'ringbuf\_process\_ring()' on error
commit 6032ebb54c60cae24329f6aba3ce0c1ca8ad6abe upstream.
The current code bails out with negative and positive returns.
If the callback returns a positive return code, 'ring\_buffer\_\_consume()'
and 'ring\_buffer\_\_poll()' will return a spurious number of records
consumed, but mostly important will continue the processing loop.
This patch makes positive returns from the callback a no-op.
Fixes: bf99c936f947 ("libbpf: Add BPF ring buffer support")
Signed-off-by: Pedro Tammela
Signed-off-by: Andrii Nakryiko
Link: https://lore.kernel.org/bpf/20210325150115.138750-1-pctammela@mojatatu.com
Signed-off-by: Greg Kroah-Hartman
commit 388d05f70f1ee0cac4a2068fd295072f1a44152a
Author: Anirudh Rayabharam
Date: Wed Apr 7 22:57:22 2021 +0530
net: hso: fix null-ptr-deref during tty device unregistration
commit 8a12f8836145ffe37e9c8733dce18c22fb668b66 upstream.
Multiple ttys try to claim the same the minor number causing a double
unregistration of the same device. The first unregistration succeeds
but the next one results in a null-ptr-deref.
The get\_free\_serial\_index() function returns an available minor number
but doesn't assign it immediately. The assignment is done by the caller
later. But before this assignment, calls to get\_free\_serial\_index()
would return the same minor number.
Fix this by modifying get\_free\_serial\_index to assign the minor number
immediately after one is found to be and rename it to obtain\_minor()
to better reflect what it does. Similary, rename set\_serial\_by\_index()
to release\_minor() and modify it to free up the minor number of the
given hso\_serial. Every obtain\_minor() should have corresponding
release\_minor() call.
Fixes: 72dc1c096c705 ("HSO: add option hso driver")
Reported-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Tested-by: syzbot+c49fe6089f295a05e6f8@syzkaller.appspotmail.com
Reviewed-by: Greg Kroah-Hartman
Signed-off-by: Anirudh Rayabharam
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6adf0c0412f8d5590f68aaeb07722087eabf40d1
Author: Yongxin Liu
Date: Thu Apr 1 11:59:15 2021 -0700
ice: fix memory leak of aRFS after resuming from suspend
commit 1831da7ea5bdf5531d78bcf81f526faa4c4375fa upstream.
In ice\_suspend(), ice\_clear\_interrupt\_scheme() is called, and then
irq\_free\_descs() will be eventually called to free irq and its descriptor.
In ice\_resume(), ice\_init\_interrupt\_scheme() is called to allocate new
irqs. However, in ice\_rebuild\_arfs(), struct irq\_glue and struct cpu\_rmap
maybe cannot be freed, if the irqs that released in ice\_suspend() were
reassigned to other devices, which makes irq descriptor's affinity\_notify
lost.
So call ice\_free\_cpu\_rx\_rmap() before ice\_clear\_interrupt\_scheme(), which
can make sure all irq\_glue and cpu\_rmap can be correctly released before
corresponding irq and descriptor are released.
Fix the following memory leak.
unreferenced object 0xffff95bd951afc00 (size 512):
comm "kworker/0:1", pid 134, jiffies 4294684283 (age 13051.958s)
hex dump (first 32 bytes):
18 00 00 00 18 00 18 00 70 fc 1a 95 bd 95 ff ff ........p.......
00 00 ff ff 01 00 ff ff 02 00 ff ff 03 00 ff ff ................
backtrace:
[<0000000072e4b914>] \_\_kmalloc+0x336/0x540
[<0000000054642a87>] alloc\_cpu\_rmap+0x3b/0xb0
[<00000000f220deec>] ice\_set\_cpu\_rx\_rmap+0x6a/0x110 [ice]
[<000000002370a632>] ice\_probe+0x941/0x1180 [ice]
[<00000000d692edba>] local\_pci\_probe+0x47/0xa0
[<00000000503934f0>] work\_for\_cpu\_fn+0x1a/0x30
[<00000000555a9e4a>] process\_one\_work+0x1dd/0x410
[<000000002c4b414a>] worker\_thread+0x221/0x3f0
[<00000000bb2b556b>] kthread+0x14c/0x170
[<00000000ad2cf1cd>] ret\_from\_fork+0x1f/0x30
unreferenced object 0xffff95bd81b0a2a0 (size 96):
comm "kworker/0:1", pid 134, jiffies 4294684283 (age 13051.958s)
hex dump (first 32 bytes):
38 00 00 00 01 00 00 00 e0 ff ff ff 0f 00 00 00 8...............
b0 a2 b0 81 bd 95 ff ff b0 a2 b0 81 bd 95 ff ff ................
backtrace:
[<00000000582dd5c5>] kmem\_cache\_alloc\_trace+0x31f/0x4c0
[<000000002659850d>] irq\_cpu\_rmap\_add+0x25/0xe0
[<00000000495a3055>] ice\_set\_cpu\_rx\_rmap+0xb4/0x110 [ice]
[<000000002370a632>] ice\_probe+0x941/0x1180 [ice]
[<00000000d692edba>] local\_pci\_probe+0x47/0xa0
[<00000000503934f0>] work\_for\_cpu\_fn+0x1a/0x30
[<00000000555a9e4a>] process\_one\_work+0x1dd/0x410
[<000000002c4b414a>] worker\_thread+0x221/0x3f0
[<00000000bb2b556b>] kthread+0x14c/0x170
[<00000000ad2cf1cd>] ret\_from\_fork+0x1f/0x30
Fixes: 769c500dcc1e ("ice: Add advanced power mgmt for WoL")
Signed-off-by: Yongxin Liu
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 9f271557c8193c1b928a0d9b58172e16e4e2727d
Author: Johannes Berg
Date: Fri Mar 26 12:57:18 2021 +0200
iwlwifi: pcie: properly set LTR workarounds on 22000 devices
commit 25628bc08d4526d3673ca7d039eb636aa9006076 upstream.
As the context info gen3 code is only called for >=AX210 devices
(from iwl\_trans\_pcie\_gen2\_start\_fw()) the code there to set LTR
on 22000 devices cannot actually do anything (22000 < AX210).
Fix this by moving the LTR code to iwl\_trans\_pcie\_gen2\_start\_fw()
where it can handle both devices. This then requires that we kick
the firmware only after that rather than doing it from the context
info code.
Note that this again had a dead branch in gen3 code, which I've
removed here.
Signed-off-by: Johannes Berg
Fixes: ed0022da8bd9 ("iwlwifi: pcie: set LTR on more devices")
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/iwlwifi.20210326125611.675486178ed1.Ib61463aba6920645059e366dcdca4c4c77f0ff58@changeid
Signed-off-by: Greg Kroah-Hartman
commit 4ba18db419963c5692f52289145f7b9854c9f20e
Author: Robert Malz
Date: Fri Feb 26 13:19:32 2021 -0800
ice: Cleanup fltr list in case of allocation issues
commit b7eeb52721fe417730fc5adc5cbeeb5fe349ab26 upstream.
When ice\_remove\_vsi\_lkup\_fltr is called, by calling
ice\_add\_to\_vsi\_fltr\_list local copy of vsi filter list
is created. If any issues during creation of vsi filter
list occurs it up for the caller to free already
allocated memory. This patch ensures proper memory
deallocation in these cases.
Fixes: 80d144c9ac82 ("ice: Refactor switch rule management structures and functions")
Signed-off-by: Robert Malz
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit d01af2c5123b6008356266f1ef7794b7acae107f
Author: Anirudh Venkataramanan
Date: Fri Feb 26 13:19:30 2021 -0800
ice: Use port number instead of PF ID for WoL
commit 3176551979b92b02756979c0f1e2d03d1fc82b1e upstream.
As per the spec, the WoL control word read from the NVM should be
interpreted as port numbers, and not PF numbers. So when checking
if WoL supported, use the port number instead of the PF ID.
Also, ice\_is\_wol\_supported doesn't really need a pointer to the pf
struct, but just needs a pointer to the hw instance.
Fixes: 769c500dcc1e ("ice: Add advanced power mgmt for WoL")
Signed-off-by: Anirudh Venkataramanan
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit ccef0e5f56e4cc5e721c25ac9b8b78b7e21c1a1e
Author: Jacek Bułatek
Date: Fri Feb 26 13:19:29 2021 -0800
ice: Fix for dereference of NULL pointer
commit 7a91d3f02b04b2fb18c2dfa8b6c4e5a40a2753f5 upstream.
Add handling of allocation fault for ice\_vsi\_list\_map\_info.
Also \*fi should not be NULL pointer, it is a reference to raw
data field, so remove this variable and use the reference
directly.
Fixes: 9daf8208dd4d ("ice: Add support for switch filter programming")
Signed-off-by: Jacek Bułatek
Co-developed-by: Haiyue Wang
Signed-off-by: Haiyue Wang
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit e7b34fbb36f9d114c460926fc67806ee0dfaffff
Author: Dave Ertman
Date: Fri Feb 26 13:19:28 2021 -0800
ice: remove DCBNL\_DEVRESET bit from PF state
commit 741b7b743bbcb5a3848e4e55982064214f900d2f upstream.
The original purpose of the ICE\_DCBNL\_DEVRESET was to protect
the driver during DCBNL device resets. But, the flow for
DCBNL device resets now consists of only calls up the stack
such as dev\_close() and dev\_open() that will result in NDO calls
to the driver. These will be handled with state changes from the
stack. Also, there is a problem of the dev\_close and dev\_open
being blocked by checks for reset in progress also using the
ICE\_DCBNL\_DEVRESET bit.
Since the ICE\_DCBNL\_DEVRESET bit is not necessary for protecting
the driver from DCBNL device resets and it is actually blocking
changes coming from the DCBNL interface, remove the bit from the
PF state and don't block driver function based on DCBNL reset in
progress.
Fixes: b94b013eb626 ("ice: Implement DCBNL support")
Signed-off-by: Dave Ertman
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 51c26a04f36b2714872b4f68975c2eb850504575
Author: Bruce Allan
Date: Fri Feb 26 13:19:27 2021 -0800
ice: fix memory allocation call
commit 59df14f9cc2326bd6432d60eca0df8201d9d3d4b upstream.
Fix the order of number of array members and member size parameters in a
\*calloc() call.
Fixes: b3c3890489f6 ("ice: avoid unnecessary single-member variable-length structs")
Signed-off-by: Bruce Allan
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 95067fea090579871346b66eee9a50b8c49c4a5a
Author: Krzysztof Goreczny
Date: Fri Feb 26 13:19:26 2021 -0800
ice: prevent ice\_open and ice\_stop during reset
commit e95fc8573e07c5e4825df4650fd8b8c93fad27a7 upstream.
There is a possibility of race between ice\_open or ice\_stop calls
performed by OS and reset handling routine both trying to modify VSI
resources. Observed scenarios:
- reset handler deallocates memory in ice\_vsi\_free\_arrays and ice\_open
tries to access it in ice\_vsi\_cfg\_txq leading to driver crash
- reset handler deallocates memory in ice\_vsi\_free\_arrays and ice\_close
tries to access it in ice\_down leading to driver crash
- reset handler clears port scheduler topology and sets port state to
ICE\_SCHED\_PORT\_STATE\_INIT leading to ice\_ena\_vsi\_txq fail in ice\_open
To prevent this additional checks in ice\_open and ice\_stop are
introduced to make sure that OS is not allowed to alter VSI config while
reset is in progress.
Fixes: cdedef59deb0 ("ice: Configure VSIs for Tx/Rx")
Signed-off-by: Krzysztof Goreczny
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 8f0ed12955c3f3724e9010727909c939b05b8afa
Author: Fabio Pricoco
Date: Fri Feb 26 13:19:24 2021 -0800
ice: Increase control queue timeout
commit f88c529ac77b3c21819d2cf1dfcfae1937849743 upstream.
250 msec timeout is insufficient for some AQ commands. Advice from FW
team was to increase the timeout. Increase to 1 second.
Fixes: 7ec59eeac804 ("ice: Add support for control queues")
Signed-off-by: Fabio Pricoco
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit ad8d37ca2eccb497a50ddcc80e1851d8cbf9cb08
Author: Anirudh Venkataramanan
Date: Fri Feb 26 13:19:22 2021 -0800
ice: Continue probe on link/PHY errors
commit 08771bce330036d473be6ce851cd00bcd351ebf6 upstream.
An incorrect NVM update procedure can result in the driver failing probe.
In this case, the recommended resolution method is to update the NVM
using the right procedure. However, if the driver fails probe, the user
will not be able to update the NVM. So do not fail probe on link/PHY
errors.
Fixes: 1a3571b5938c ("ice: restore PHY settings on media insertion")
Signed-off-by: Anirudh Venkataramanan
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit ac95dc7c04e371d5a22b87d803ac7d90ab150265
Author: Tetsuo Handa
Date: Mon Apr 5 19:16:50 2021 +0900
batman-adv: initialize "struct batadv\_tvlv\_tt\_vlan\_data"->reserved field
commit 08c27f3322fec11950b8f1384aa0f3b11d028528 upstream.
KMSAN found uninitialized value at batadv\_tt\_prepare\_tvlv\_local\_data()
[1], for commit ced72933a5e8ab52 ("batman-adv: use CRC32C instead of CRC16
in TT code") inserted 'reserved' field into "struct batadv\_tvlv\_tt\_data"
and commit 7ea7b4a142758dea ("batman-adv: make the TT CRC logic VLAN
specific") moved that field to "struct batadv\_tvlv\_tt\_vlan\_data" but left
that field uninitialized.
[1] https://syzkaller.appspot.com/bug?id=07f3e6dba96f0eb3cabab986adcd8a58b9bdbe9d
Reported-by: syzbot
Tested-by: syzbot
Signed-off-by: Tetsuo Handa
Fixes: ced72933a5e8ab52 ("batman-adv: use CRC32C instead of CRC16 in TT code")
Fixes: 7ea7b4a142758dea ("batman-adv: make the TT CRC logic VLAN specific")
Acked-by: Sven Eckelmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fdd9358a43f730217de9e5b735ec43c774a16070
Author: Marek Behún
Date: Sun Feb 21 00:11:44 2021 +0100
ARM: dts: turris-omnia: configure LED[2]/INTn pin as interrupt pin
commit a26c56ae67fa9fbb45a8a232dcd7ebaa7af16086 upstream.
Use the `marvell,reg-init` DT property to configure the LED[2]/INTn pin
of the Marvell 88E1514 ethernet PHY on Turris Omnia into interrupt mode.
Without this the pin is by default in LED[2] mode, and the Marvell PHY
driver configures LED[2] into "On - Link, Blink - Activity" mode.
This fixes the issue where the pca9538 GPIO/interrupt controller (which
can't mask interrupts in HW) received too many interrupts and after a
time started ignoring the interrupt with error message:
IRQ 71: nobody cared
There is a work in progress to have the Marvell PHY driver support
parsing PHY LED nodes from OF and registering the LEDs as Linux LED
class devices. Once this is done the PHY driver can also automatically
set the pin into INTn mode if it does not find LED[2] in OF.
Until then, though, we fix this via `marvell,reg-init` DT property.
Signed-off-by: Marek Behún
Reported-by: Rui Salvaterra
Fixes: 26ca8b52d6e1 ("ARM: dts: add support for Turris Omnia")
Cc: Uwe Kleine-König
Cc: linux-arm-kernel@lists.infradead.org
Cc: Andrew Lunn
Cc: Gregory CLEMENT
Cc:
Tested-by: Rui Salvaterra
Reviewed-by: Andrew Lunn
Signed-off-by: Gregory CLEMENT
Signed-off-by: Greg Kroah-Hartman
commit 89dcd7587f1aa085875e229f1f07e9465f342db4
Author: Gao Xiang
Date: Tue Apr 6 12:59:29 2021 +0800
parisc: avoid a warning on u8 cast for cmpxchg on u8 pointers
commit 4d752e5af63753ab5140fc282929b98eaa4bd12e upstream.
commit b344d6a83d01 ("parisc: add support for cmpxchg on u8 pointers")
can generate a sparse warning ("cast truncates bits from constant
value"), which has been reported several times [1] [2] [3].
The original code worked as expected, but anyway, let silence such
sparse warning as what others did [4].
[1] https://lore.kernel.org/r/202104061220.nRMBwCXw-lkp@intel.com
[2] https://lore.kernel.org/r/202012291914.T5Agcn99-lkp@intel.com
[3] https://lore.kernel.org/r/202008210829.KVwn7Xeh%25lkp@intel.com
[4] https://lore.kernel.org/r/20210315131512.133720-2-jacopo+renesas@jmondi.org
Cc: Liam Beguin
Cc: Helge Deller
Cc: stable@vger.kernel.org # v5.8+
Signed-off-by: Gao Xiang
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 1cdbc74c5fb683c6ab7f68b8143c0cc31e4564b2
Author: Helge Deller
Date: Tue Apr 6 11:32:52 2021 +0200
parisc: parisc-agp requires SBA IOMMU driver
commit 9054284e8846b0105aad43a4e7174ca29fffbc44 upstream.
Add a dependency to the SBA IOMMU driver to avoid:
ERROR: modpost: "sba\_list" [drivers/char/agp/parisc-agp.ko] undefined!
Reported-by: kernel test robot
Cc: stable@vger.kernel.org
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit b028d1c717f5db26d73fb6147012867ce750ea3f
Author: Ilya Lipnitskiy
Date: Mon Apr 5 15:25:40 2021 -0700
of: property: fw\_devlink: do not link ".\*,nr-gpios"
commit d473d32c2fbac2d1d7082c61899cfebd34eb267a upstream.
[,]nr-gpios property is used by some GPIO drivers[0] to indicate
the number of GPIOs present on a system, not define a GPIO. nr-gpios is
not configured by #gpio-cells and can't be parsed along with other
"\*-gpios" properties.
nr-gpios without the "," prefix is not allowed by the DT
spec[1], so only add exception for the ",nr-gpios" suffix and let the
error message continue being printed for non-compliant implementations.
[0] nr-gpios is referenced in Documentation/devicetree/bindings/gpio:
- gpio-adnp.txt
- gpio-xgene-sb.txt
- gpio-xlp.txt
- snps,dw-apb-gpio.yaml
[1] Link: https://github.com/devicetree-org/dt-schema/blob/cb53a16a1eb3e2169ce170c071e47940845ec26e/schemas/gpio/gpio-consumer.yaml#L20
Fixes errors such as:
OF: /palmbus@300000/gpio@600: could not find phandle
Fixes: 7f00be96f125 ("of: property: Add device link support for interrupt-parent, dmas and -gpio(s)")
Signed-off-by: Ilya Lipnitskiy
Cc: Saravana Kannan
Cc: stable@vger.kernel.org # v5.5+
Link: https://lore.kernel.org/r/20210405222540.18145-1-ilya.lipnitskiy@gmail.com
Signed-off-by: Rob Herring
Signed-off-by: Greg Kroah-Hartman
commit 800b5c1d024b3a912172a3afddb51af28c9e3765
Author: Wong Vee Khee
Date: Tue Apr 6 21:17:30 2021 +0800
ethtool: fix incorrect datatype in set\_eee ops
commit 63cf32389925e234d166fb1a336b46de7f846003 upstream.
The member 'tx\_lpi\_timer' is defined with \_\_u32 datatype in the ethtool
header file. Hence, we should use ethnl\_update\_u32() in set\_eee ops.
Fixes: fd77be7bd43c ("ethtool: set EEE settings with EEE\_SET request")
Cc:  # 5.10.x
Cc: Michal Kubecek
Signed-off-by: Wong Vee Khee
Reviewed-by: Jakub Kicinski
Reviewed-by: Michal Kubecek
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e7d0f591c708350834916a28bd4b18f607d267ee
Author: Jack Qiu
Date: Fri Apr 9 13:27:35 2021 -0700
fs: direct-io: fix missing sdio->boundary
commit df41872b68601059dd4a84858952dcae58acd331 upstream.
I encountered a hung task issue, but not a performance one. I run DIO
on a device (need lba continuous, for example open channel ssd), maybe
hungtask in below case:
DIO: Checkpoint:
get addr A(at boundary), merge into BIO,
no submit because boundary missing
flush dirty data(get addr A+1), wait IO(A+1)
writeback timeout, because DIO(A) didn't submit
get addr A+2 fail, because checkpoint is doing
dio\_send\_cur\_page() may clear sdio->boundary, so prevent it from missing
a boundary.
Link: https://lkml.kernel.org/r/20210322042253.38312-1-jack.qiu@huawei.com
Fixes: b1058b981272 ("direct-io: submit bio after boundary buffer is added to it")
Signed-off-by: Jack Qiu
Reviewed-by: Jan Kara
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 1e43aace56f113a2bff52cd48f1245e68d7b0e7a
Author: Wengang Wang
Date: Fri Apr 9 13:27:29 2021 -0700
ocfs2: fix deadlock between setattr and dio\_end\_io\_write
commit 90bd070aae6c4fb5d302f9c4b9c88be60c8197ec upstream.
The following deadlock is detected:
truncate -> setattr path is waiting for pending direct IO to be done (inode->i\_dio\_count become zero) with inode->i\_rwsem held (down\_write).
PID: 14827 TASK: ffff881686a9af80 CPU: 20 COMMAND: "ora\_p005\_hrltd9"
#0 \_\_schedule at ffffffff818667cc
#1 schedule at ffffffff81866de6
#2 inode\_dio\_wait at ffffffff812a2d04
#3 ocfs2\_setattr at ffffffffc05f322e [ocfs2]
#4 notify\_change at ffffffff812a5a09
#5 do\_truncate at ffffffff812808f5
#6 do\_sys\_ftruncate.constprop.18 at ffffffff81280cf2
#7 sys\_ftruncate at ffffffff81280d8e
#8 do\_syscall\_64 at ffffffff81003949
#9 entry\_SYSCALL\_64\_after\_hwframe at ffffffff81a001ad
dio completion path is going to complete one direct IO (decrement
inode->i\_dio\_count), but before that it hung at locking inode->i\_rwsem:
#0 \_\_schedule+700 at ffffffff818667cc
#1 schedule+54 at ffffffff81866de6
#2 rwsem\_down\_write\_failed+536 at ffffffff8186aa28
#3 call\_rwsem\_down\_write\_failed+23 at ffffffff8185a1b7
#4 down\_write+45 at ffffffff81869c9d
#5 ocfs2\_dio\_end\_io\_write+180 at ffffffffc05d5444 [ocfs2]
#6 ocfs2\_dio\_end\_io+85 at ffffffffc05d5a85 [ocfs2]
#7 dio\_complete+140 at ffffffff812c873c
#8 dio\_aio\_complete\_work+25 at ffffffff812c89f9
#9 process\_one\_work+361 at ffffffff810b1889
#10 worker\_thread+77 at ffffffff810b233d
#11 kthread+261 at ffffffff810b7fd5
#12 ret\_from\_fork+62 at ffffffff81a0035e
Thus above forms ABBA deadlock. The same deadlock was mentioned in
upstream commit 28f5a8a7c033 ("ocfs2: should wait dio before inode lock
in ocfs2\_setattr()"). It seems that that commit only removed the
cluster lock (the victim of above dead lock) from the ABBA deadlock
party.
End-user visible effects: Process hang in truncate -> ocfs2\_setattr path
and other processes hang at ocfs2\_dio\_end\_io\_write path.
This is to fix the deadlock itself. It removes inode\_lock() call from
dio completion path to remove the deadlock and add ip\_alloc\_sem lock in
setattr path to synchronize the inode modifications.
[wen.gang.wang@oracle.com: remove the "had\_alloc\_lock" as suggested]
Link: https://lkml.kernel.org/r/20210402171344.1605-1-wen.gang.wang@oracle.com
Link: https://lkml.kernel.org/r/20210331203654.3911-1-wen.gang.wang@oracle.com
Signed-off-by: Wengang Wang
Reviewed-by: Joseph Qi
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Junxiao Bi
Cc: Changwei Ge
Cc: Gang He
Cc: Jun Piao
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 18027fae871c9b6910a32deb024c8b2d05bb97e1
Author: Mike Rapoport
Date: Fri Apr 9 13:27:23 2021 -0700
nds32: flush\_dcache\_page: use page\_mapping\_file to avoid races with swapoff
commit a3a8833dffb7e7329c2586b8bfc531adb503f123 upstream.
Commit cb9f753a3731 ("mm: fix races between swapoff and flush dcache")
updated flush\_dcache\_page implementations on several architectures to
use page\_mapping\_file() in order to avoid races between page\_mapping()
and swapoff().
This update missed arch/nds32 and there is a possibility of a race
there.
Replace page\_mapping() with page\_mapping\_file() in nds32 implementation
of flush\_dcache\_page().
Link: https://lkml.kernel.org/r/20210330175126.26500-1-rppt@kernel.org
Fixes: cb9f753a3731 ("mm: fix races between swapoff and flush dcache")
Signed-off-by: Mike Rapoport
Reviewed-by: Matthew Wilcox (Oracle)
Acked-by: Greentime Hu
Cc: Huang Ying
Cc: Nick Hu
Cc: Vincent Chen
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit eafe7f9cea56155c9c237ddae684f747089fbf6f
Author: Sergei Trofimovich
Date: Fri Apr 9 13:27:32 2021 -0700
ia64: fix user\_stack\_pointer() for ptrace()
commit 7ad1e366167837daeb93d0bacb57dee820b0b898 upstream.
ia64 has two stacks:
- memory stack (or stack), pointed at by by r12
- register backing store (register stack), pointed at by
ar.bsp/ar.bspstore with complications around dirty
register frame on CPU.
In [1] Dmitry noticed that PTRACE\_GET\_SYSCALL\_INFO returns the register
stack instead memory stack.
The bug comes from the fact that user\_stack\_pointer() and
current\_user\_stack\_pointer() don't return the same register:
ulong user\_stack\_pointer(struct pt\_regs \*regs) { return regs->ar\_bspstore; }
#define current\_user\_stack\_pointer() (current\_pt\_regs()->r12)
The change gets both back in sync.
I think ptrace(PTRACE\_GET\_SYSCALL\_INFO) is the only affected user by
this bug on ia64.
The change fixes 'rt\_sigreturn.gen.test' strace test where it was
observed initially.
Link: https://bugs.gentoo.org/769614 [1]
Link: https://lkml.kernel.org/r/20210331084447.2561532-1-slyfox@gentoo.org
Signed-off-by: Sergei Trofimovich
Reported-by: Dmitry V. Levin
Cc: Oleg Nesterov
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 7885eed5b30de22ae37d649d22f090de277ea21a
Author: Nick Desaulniers
Date: Fri Apr 9 13:27:26 2021 -0700
gcov: re-fix clang-11+ support
commit 9562fd132985ea9185388a112e50f2a51557827d upstream.
LLVM changed the expected function signature for llvm\_gcda\_emit\_function()
in the clang-11 release. Users of clang-11 or newer may have noticed
their kernels producing invalid coverage information:
$ llvm-cov gcov -a -c -u -f -b .gcda -- gcno=.gcno
1 : checksum mismatch, \
(, ) != (, )
2 Invalid .gcda File!
...
Fix up the function signatures so calling this function interprets its
parameters correctly and computes the correct cfg checksum. In
particular, in clang-11, the additional checksum is no longer optional.
Link: https://reviews.llvm.org/rG25544ce2df0daa4304c07e64b9c8b0f7df60c11d
Link: https://lkml.kernel.org/r/20210408184631.1156669-1-ndesaulniers@google.com
Reported-by: Prasad Sodagudi
Tested-by: Prasad Sodagudi
Signed-off-by: Nick Desaulniers
Reviewed-by: Nathan Chancellor
Cc:  [5.4+]
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
commit badf34851669a5e8bf87f44635fac4d1fce1dc96
Author: Al Viro
Date: Tue Apr 6 19:46:51 2021 -0400
LOOKUP\_MOUNTPOINT: we are cleaning "jumped" flag too late
commit 4f0ed93fb92d3528c73c80317509df3f800a222b upstream.
That (and traversals in case of umount .) should be done before
complete\_walk(). Either a braino or mismerge damage on queue
reorders - either way, I should've spotted that much earlier.
Fucked-up-by: Al Viro
X-Paperbag: Brown
Fixes: 161aff1d93ab "LOOKUP\_MOUNTPOINT: fold path\_mountpointat() into path\_lookupat()"
Cc: stable@vger.kernel.org # v5.7+
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 7e4bf73fe38f374607c2b207074af4db2a71aee1
Author: Mike Marciniszyn
Date: Mon Mar 29 09:48:19 2021 -0400
IB/hfi1: Fix probe time panic when AIP is enabled with a buggy BIOS
commit 5de61a47eb9064cbbc5f3360d639e8e34a690a54 upstream.
A panic can result when AIP is enabled:
BUG: unable to handle kernel NULL pointer dereference at 000000000000000
PGD 0 P4D 0
Oops: 0000 1 SMP PTI
CPU: 70 PID: 981 Comm: systemd-udevd Tainted: G OE --------- - - 4.18.0-240.el8.x86\_64 #1
Hardware name: Intel Corporation S2600KP/S2600KP, BIOS SE5C610.86B.01.01.0005.101720141054 10/17/2014
RIP: 0010:\_\_bitmap\_and+0x1b/0x70
RSP: 0018:ffff99aa0845f9f0 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff8d5a6fc18000 RCX: 0000000000000048
RDX: 0000000000000000 RSI: ffffffffc06336f0 RDI: ffff8d5a8fa67750
RBP: 0000000000000079 R08: 0000000fffffffff R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: ffffffffc06336f0
R13: 00000000000000a0 R14: ffff8d5a6fc18000 R15: 0000000000000003
FS: 00007fec137a5980(0000) GS:ffff8d5a9fa80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000a04b48002 CR4: 00000000001606e0
Call Trace:
hfi1\_num\_netdev\_contexts+0x7c/0x110 [hfi1]
hfi1\_init\_dd+0xd7f/0x1a90 [hfi1]
? pci\_bus\_read\_config\_dword+0x49/0x70
? pci\_mmcfg\_read+0x3e/0xe0
do\_init\_one.isra.18+0x336/0x640 [hfi1]
local\_pci\_probe+0x41/0x90
pci\_device\_probe+0x105/0x1c0
really\_probe+0x212/0x440
driver\_probe\_device+0x49/0xc0
device\_driver\_attach+0x50/0x60
\_\_driver\_attach+0x61/0x130
? device\_driver\_attach+0x60/0x60
bus\_for\_each\_dev+0x77/0xc0
? klist\_add\_tail+0x3b/0x70
bus\_add\_driver+0x14d/0x1e0
? dev\_init+0x10b/0x10b [hfi1]
driver\_register+0x6b/0xb0
? dev\_init+0x10b/0x10b [hfi1]
hfi1\_mod\_init+0x1e6/0x20a [hfi1]
do\_one\_initcall+0x46/0x1c3
? free\_unref\_page\_commit+0x91/0x100
? \_cond\_resched+0x15/0x30
? kmem\_cache\_alloc\_trace+0x140/0x1c0
do\_init\_module+0x5a/0x220
load\_module+0x14b4/0x17e0
? \_\_do\_sys\_finit\_module+0xa8/0x110
\_\_do\_sys\_finit\_module+0xa8/0x110
do\_syscall\_64+0x5b/0x1a0
The issue happens when pcibus\_to\_node() returns NO\_NUMA\_NODE.
Fix this issue by moving the initialization of dd->node to hfi1\_devdata
allocation and remove the other pcibus\_to\_node() calls in the probe path
and use dd->node instead.
Affinity logic is adjusted to use a new field dd->affinity\_entry as a
guard instead of dd->node.
Fixes: 4730f4a6c6b2 ("IB/hfi1: Activate the dummy netdev")
Link: https://lore.kernel.org/r/1617025700-31865-4-git-send-email-dennis.dalessandro@cornelisnetworks.com
Cc: stable@vger.kernel.org
Signed-off-by: Mike Marciniszyn
Signed-off-by: Dennis Dalessandro
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit 9e3516e2ea663e45f590570af2d62bf703560d6d
Author: Shyam Prasad N
Date: Wed Mar 31 14:35:24 2021 +0000
cifs: On cifs\_reconnect, resolve the hostname again.
commit 4e456b30f78c429b183db420e23b26cde7e03a78 upstream.
On cifs\_reconnect, make sure that DNS resolution happens again.
It could be the cause of connection to go dead in the first place.
This also contains the fix for a build issue identified by Intel bot.
Reported-by: kernel test robot
Signed-off-by: Shyam Prasad N
Reviewed-by: Paulo Alcantara (SUSE)
Reviewed-by: Pavel Shilovsky
CC:  # 5.11+
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit dc3b0323e723f890b3e910bf50d826a00e8d2a4a
Author: Maciek Borzecki
Date: Tue Apr 6 17:02:29 2021 +0200
cifs: escape spaces in share names
commit 0fc9322ab5e1fe6910c9673e1a7ff29f7dd72611 upstream.
Commit 653a5efb849a ("cifs: update super\_operations to show\_devname")
introduced the display of devname for cifs mounts. However, when mounting
a share which has a whitespace in the name, that exact share name is also
displayed in mountinfo. Make sure that all whitespace is escaped.
Signed-off-by: Maciek Borzecki
CC:  # 5.11+
Reviewed-by: Shyam Prasad N
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 2b11196aa5bc823217ffecc371dfdb9409685ae8
Author: Johannes Berg
Date: Fri Mar 19 23:25:11 2021 +0100
rfkill: revert back to old userspace API by default
commit 71826654ce40112f0651b6f4e94c422354f4adb6 upstream.
Recompiling with the new extended version of struct rfkill\_event
broke systemd in \*two\* ways:
- It used "sizeof(struct rfkill\_event)" to read the event, but
then complained if it actually got something != 8, this broke
it on new kernels (that include the updated API);
- It used sizeof(struct rfkill\_event) to write a command, but
didn't implement the intended expansion protocol where the
kernel returns only how many bytes it accepted, and errored
out due to the unexpected smaller size on kernels that didn't
include the updated API.
Even though systemd has now been fixed, that fix may not be always
deployed, and other applications could potentially have similar
issues.
As such, in the interest of avoiding regressions, revert the
default API "struct rfkill\_event" back to the original size.
Instead, add a new "struct rfkill\_event\_ext" that extends it by
the new field, and even more clearly document that applications
should be prepared for extensions in two ways:
\* write might only accept fewer bytes on older kernels, and
will return how many to let userspace know which data may
have been ignored;
\* read might return anything between 8 (the original size) and
whatever size the application sized its buffer at, indicating
how much event data was supported by the kernel.
Perhaps that will help avoid such issues in the future and we
won't have to come up with another version of the struct if we
ever need to extend it again.
Applications that want to take advantage of the new field will
have to be modified to use struct rfkill\_event\_ext instead now,
which comes with the danger of them having already been updated
to use it from 'struct rfkill\_event', but I found no evidence
of that, and it's still relatively new.
Cc: stable@vger.kernel.org # 5.11
Reported-by: Takashi Iwai
Tested-by: Sedat Dilek  # LLVM/Clang v12.0.0-r4 (x86-64)
Link: https://lore.kernel.org/r/20210319232510.f1a139cfdd9c.Ic5c7c9d1d28972059e132ea653a21a427c326678@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 359f3309001491820f701e081eb531adf4b806ef
Author: Alex Deucher
Date: Wed Apr 7 09:28:23 2021 -0400
drm/amdgpu/smu7: fix CAC setting on TOPAZ
commit cdcc108a2aced5f9cbc45920e29bf49819e5477f upstream.
We need to enable MC CAC for mclk switching to work.
Fixes: d765129a719f ("drm/amd/pm: correct sclk/mclk dpm enablement")
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1561
Tested-by: Konstantin Kharlamov
Reviewed-by: Evan Quan
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 96312b1dcdfc96654fbca71bd0560df53398eb99
Author: xinhui pan
Date: Wed Apr 7 19:29:39 2021 +0800
drm/amdgpu: Fix size overflow
commit 1b0b6e939f112949089e32ec89fd27796677263a upstream.
ttm->num\_pages is uint32. Hit overflow when << PAGE\_SHIFT directly
Fixes: 230c079fdcf4 ("drm/ttm: make num\_pages uint32\_t")
Signed-off-by: xinhui pan
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit c3c1c6652f17bb4edbc8a9336d51315301a25e74
Author: xinhui pan
Date: Wed Apr 7 20:57:50 2021 +0800
drm/radeon: Fix size overflow
commit 2efc021060c2aa55e1e8f7b98249d3ea63232fc7 upstream.
ttm->num\_pages is uint32. Hit overflow when << PAGE\_SHIFT directly
Fixes: 230c079fdcf4 ("drm/ttm: make num\_pages uint32\_t")
Signed-off-by: xinhui pan
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 579f19a881e708314de4472eefea00c9a575248a
Author: Vitaly Kuznetsov
Date: Tue Apr 6 17:56:40 2021 +0200
ACPI: processor: Fix build when CONFIG\_ACPI\_PROCESSOR=m
commit fa26d0c778b432d3d9814ea82552e813b33eeb5c upstream.
Commit 8cdddd182bd7 ("ACPI: processor: Fix CPU0 wakeup in
acpi\_idle\_play\_dead()") tried to fix CPU0 hotplug breakage by copying
wakeup\_cpu0() + start\_cpu0() logic from hlt\_play\_dead()//mwait\_play\_dead()
into acpi\_idle\_play\_dead(). The problem is that these functions are not
exported to modules so when CONFIG\_ACPI\_PROCESSOR=m build fails.
The issue could've been fixed by exporting both wakeup\_cpu0()/start\_cpu0()
(the later from assembly) but it seems putting the whole pattern into a
new function and exporting it instead is better.
Reported-by: kernel test robot
Fixes: 8cdddd182bd7 ("CPI: processor: Fix CPU0 wakeup in acpi\_idle\_play\_dead()")
Cc:  # 5.10+
Signed-off-by: Vitaly Kuznetsov
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 82c655d301bc5a5ba4ccfd783a010ee0e3be1b12
Author: Takashi Iwai
Date: Fri Apr 2 10:23:17 2021 +0200
drm/i915: Fix invalid access to ACPI \_DSM objects
commit b6a37a93c9ac3900987c79b726d0bb3699d8db4e upstream.
intel\_dsm\_platform\_mux\_info() tries to parse the ACPI package data
from \_DSM for the debug information, but it assumes the fixed format
without checking what values are stored in the elements actually.
When an unexpected value is returned from BIOS, it may lead to GPF or
NULL dereference, as reported recently.
Add the checks of the contents in the returned values and skip the
values for invalid cases.
v1->v2: Check the info contents before dereferencing, too
BugLink: http://bugzilla.opensuse.org/show\_bug.cgi?id=1184074
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20210402082317.871-1-tiwai@suse.de
(cherry picked from commit 337d7a1621c7f02af867229990ac67c97da1b53a)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Greg Kroah-Hartman
commit d10f8a1f800cfeb5413e83bb7fabb1364e32510b
Author: Martin Blumenstingl
Date: Thu Apr 8 20:38:28 2021 +0200
net: dsa: lantiq\_gswip: Configure all remaining GSWIP\_MII\_CFG bits
commit 4b5923249b8fa427943b50b8f35265176472be38 upstream.
There are a few more bits in the GSWIP\_MII\_CFG register for which we
did rely on the boot-loader (or the hardware defaults) to set them up
properly.
For some external RMII PHYs we need to select the GSWIP\_MII\_CFG\_RMII\_CLK
bit and also we should un-set it for non-RMII PHYs. The
GSWIP\_MII\_CFG\_RMII\_CLK bit is ignored for other PHY connection modes.
The GSWIP IP also supports in-band auto-negotiation for RGMII PHYs when
the GSWIP\_MII\_CFG\_RGMII\_IBS bit is set. Clear this bit always as there's
no known hardware which uses this (so it is not tested yet).
Clear the xMII isolation bit when set at initialization time if it was
previously set by the bootloader. Not doing so could lead to no traffic
(neither RX nor TX) on a port with this bit set.
While here, also add the GSWIP\_MII\_CFG\_RESET bit. We don't need to
manage it because this bit is self-clearning when set. We still add it
here to get a better overview of the GSWIP\_MII\_CFG register.
Fixes: 14fceff4771e51 ("net: dsa: Add Lantiq / Intel DSA driver for vrx200")
Cc: stable@vger.kernel.org
Suggested-by: Hauke Mehrtens
Acked-by: Hauke Mehrtens
Signed-off-by: Martin Blumenstingl
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 622322cc3802cdddec19d62e1ad0ba784b535d24
Author: Martin Blumenstingl
Date: Thu Apr 8 20:38:27 2021 +0200
net: dsa: lantiq\_gswip: Don't use PHY auto polling
commit 3e9005be87777afc902b9f5497495898202d335d upstream.
PHY auto polling on the GSWIP hardware can be used so link changes
(speed, link up/down, etc.) can be detected automatically. Internally
GSWIP reads the PHY's registers for this functionality. Based on this
automatic detection GSWIP can also automatically re-configure it's port
settings. Unfortunately this auto polling (and configuration) mechanism
seems to cause various issues observed by different people on different
devices:
- FritzBox 7360v2: the two Gbit/s ports (connected to the two internal
PHY11G instances) are working fine but the two Fast Ethernet ports
(using an AR8030 RMII PHY) are completely dead (neither RX nor TX are
received). It turns out that the AR8030 PHY sets the BMSR\_ESTATEN bit
as well as the ESTATUS\_1000\_TFULL and ESTATUS\_1000\_XFULL bits. This
makes the PHY auto polling state machine (rightfully?) think that the
established link speed (when the other side is Gbit/s capable) is
1Gbit/s.
- None of the Ethernet ports on the Zyxel P-2812HNU-F1 (two are
connected to the internal PHY11G GPHYs while the other three are
external RGMII PHYs) are working. Neither RX nor TX traffic was
observed. It is not clear which part of the PHY auto polling state-
machine caused this.
- FritzBox 7412 (only one LAN port which is connected to one of the
internal GPHYs running in PHY22F / Fast Ethernet mode) was seeing
random disconnects (link down events could be seen). Sometimes all
traffic would stop after such disconnect. It is not clear which part
of the PHY auto polling state-machine cauased this.
- TP-Link TD-W9980 (two ports are connected to the internal GPHYs
running in PHY11G / Gbit/s mode, the other two are external RGMII
PHYs) was affected by similar issues as the FritzBox 7412 just without
the "link down" events
Switch to software based configuration instead of PHY auto polling (and
letting the GSWIP hardware configure the ports automatically) for the
following link parameters:
- link up/down
- link speed
- full/half duplex
- flow control (RX / TX pause)
After a big round of manual testing by various people (who helped test
this on OpenWrt) it turns out that this fixes all reported issues.
Additionally it can be considered more future proof because any
"quirk" which is implemented for a PHY on the driver side can now be
used with the GSWIP hardware as well because Linux is in control of the
link parameters.
As a nice side-effect this also solves a problem where fixed-links were
not supported previously because we were relying on the PHY auto polling
mechanism, which cannot work for fixed-links as there's no PHY from
where it can read the registers. Configuring the link settings on the
GSWIP ports means that we now use the settings from device-tree also for
ports with fixed-links.
Fixes: 14fceff4771e51 ("net: dsa: Add Lantiq / Intel DSA driver for vrx200")
Fixes: 3e6fdeb28f4c33 ("net: dsa: lantiq\_gswip: Let GSWIP automatically set the xMII clock")
Cc: stable@vger.kernel.org
Acked-by: Hauke Mehrtens
Reviewed-by: Andrew Lunn
Signed-off-by: Martin Blumenstingl
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c3ccbe3821cea60c4dda07d3eae32490664d08e4
Author: Martin Blumenstingl
Date: Wed Mar 24 20:36:04 2021 +0100
net: dsa: lantiq\_gswip: Let GSWIP automatically set the xMII clock
commit 3e6fdeb28f4c331acbd27bdb0effc4befd4ef8e8 upstream.
The xMII interface clock depends on the PHY interface (MII, RMII, RGMII)
as well as the current link speed. Explicitly configure the GSWIP to
automatically select the appropriate xMII interface clock.
This fixes an issue seen by some users where ports using an external
RMII or RGMII PHY were deaf (no RX or TX traffic could be seen). Most
likely this is due to an "invalid" xMII clock being selected either by
the bootloader or hardware-defaults.
Fixes: 14fceff4771e51 ("net: dsa: Add Lantiq / Intel DSA driver for vrx200")
Signed-off-by: Martin Blumenstingl
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 952f5e5bccedb2a1ce82a872aec26aa7beacd115
Author: Muhammad Usama Anjum
Date: Fri Apr 9 03:01:29 2021 +0500
net: ipv6: check for validity before dereferencing cfg->fc\_nlinfo.nlh
commit 864db232dc7036aa2de19749c3d5be0143b24f8f upstream.
nlh is being checked for validtity two times when it is dereferenced in
this function. Check for validity again when updating the flags through
nlh pointer to make the dereferencing safe.
CC:
Addresses-Coverity: ("NULL pointer dereference")
Signed-off-by: Muhammad Usama Anjum
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 108b525bc87a6c337cd6582dad04fe11716d28a0
Author: Luca Fancellu
Date: Tue Apr 6 11:51:04 2021 +0100
xen/evtchn: Change irq\_info lock to raw\_spinlock\_t
commit d120198bd5ff1d41808b6914e1eb89aff937415c upstream.
Unmask operation must be called with interrupt disabled,
on preempt\_rt spin\_lock\_irqsave/spin\_unlock\_irqrestore
don't disable/enable interrupts, so use raw\_\* implementation
and change lock variable in struct irq\_info from spinlock\_t
to raw\_spinlock\_t
Cc: stable@vger.kernel.org
Fixes: 25da4618af24 ("xen/events: don't unmask an event channel when an eoi is pending")
Signed-off-by: Luca Fancellu
Reviewed-by: Julien Grall
Reviewed-by: Wei Liu
Link: https://lore.kernel.org/r/20210406105105.10141-1-luca.fancellu@arm.com
Signed-off-by: Boris Ostrovsky
Signed-off-by: Greg Kroah-Hartman
commit 762b867e134a247b02fab0bd84fe7d331a5e335d
Author: Ondrej Mosnacek
Date: Wed Apr 7 09:24:43 2021 +0200
selinux: fix race between old and new sidtab
commit 9ad6e9cb39c66366bf7b9aece114aca277981a1f upstream.
Since commit 1b8b31a2e612 ("selinux: convert policy read-write lock to
RCU"), there is a small window during policy load where the new policy
pointer has already been installed, but some threads may still be
holding the old policy pointer in their read-side RCU critical sections.
This means that there may be conflicting attempts to add a new SID entry
to both tables via sidtab\_context\_to\_sid().
See also (and the rest of the thread):
https://lore.kernel.org/selinux/CAFqZXNvfux46\_f8gnvVvRYMKoes24nwm2n3sPbMjrB8vKTW00g@mail.gmail.com/
Fix this by installing the new policy pointer under the old sidtab's
spinlock along with marking the old sidtab as "frozen". Then, if an
attempt to add new entry to a "frozen" sidtab is detected, make
sidtab\_context\_to\_sid() return -ESTALE to indicate that a new policy
has been installed and that the caller will have to abort the policy
transaction and try again after re-taking the policy pointer (which is
guaranteed to be a newer policy). This requires adding a retry-on-ESTALE
logic to all callers of sidtab\_context\_to\_sid(), but fortunately these
are easy to determine and aren't that many.
This seems to be the simplest solution for this problem, even if it
looks somewhat ugly. Note that other places in the kernel (e.g.
do\_mknodat() in fs/namei.c) use similar stale-retry patterns, so I think
it's reasonable.
Cc: stable@vger.kernel.org
Fixes: 1b8b31a2e612 ("selinux: convert policy read-write lock to RCU")
Signed-off-by: Ondrej Mosnacek
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 5a1f495e91df071b17fc295c786ff6085e168e35
Author: Ondrej Mosnacek
Date: Fri Apr 2 10:56:19 2021 +0200
selinux: fix cond\_list corruption when changing booleans
commit d8f5f0ea5b86300390b026b6c6e7836b7150814a upstream.
Currently, duplicate\_policydb\_cond\_list() first copies the whole
conditional avtab and then tries to link to the correct entries in
cond\_dup\_av\_list() using avtab\_search(). However, since the conditional
avtab may contain multiple entries with the same key, this approach
often fails to find the right entry, potentially leading to wrong rules
being activated/deactivated when booleans are changed.
To fix this, instead start with an empty conditional avtab and add the
individual entries one-by-one while building the new av\_lists. This
approach leads to the correct result, since each entry is present in the
av\_lists exactly once.
The issue can be reproduced with Fedora policy as follows:
# sesearch -s ftpd\_t -t public\_content\_rw\_t -c dir -p create -A
allow ftpd\_t non\_security\_file\_type:dir { add\_name create getattr ioctl link lock open read remove\_name rename reparent rmdir search setattr unlink watch watch\_reads write }; [ ftpd\_full\_access ]:True
allow ftpd\_t public\_content\_rw\_t:dir { add\_name create link remove\_name rename reparent rmdir setattr unlink watch watch\_reads write }; [ ftpd\_anon\_write ]:True
# setsebool ftpd\_anon\_write=off ftpd\_connect\_all\_unreserved=off ftpd\_connect\_db=off ftpd\_full\_access=off
On fixed kernels, the sesearch output is the same after the setsebool
command:
# sesearch -s ftpd\_t -t public\_content\_rw\_t -c dir -p create -A
allow ftpd\_t non\_security\_file\_type:dir { add\_name create getattr ioctl link lock open read remove\_name rename reparent rmdir search setattr unlink watch watch\_reads write }; [ ftpd\_full\_access ]:True
allow ftpd\_t public\_content\_rw\_t:dir { add\_name create link remove\_name rename reparent rmdir setattr unlink watch watch\_reads write }; [ ftpd\_anon\_write ]:True
While on the broken kernels, it will be different:
# sesearch -s ftpd\_t -t public\_content\_rw\_t -c dir -p create -A
allow ftpd\_t non\_security\_file\_type:dir { add\_name create getattr ioctl link lock open read remove\_name rename reparent rmdir search setattr unlink watch watch\_reads write }; [ ftpd\_full\_access ]:True
allow ftpd\_t non\_security\_file\_type:dir { add\_name create getattr ioctl link lock open read remove\_name rename reparent rmdir search setattr unlink watch watch\_reads write }; [ ftpd\_full\_access ]:True
allow ftpd\_t non\_security\_file\_type:dir { add\_name create getattr ioctl link lock open read remove\_name rename reparent rmdir search setattr unlink watch watch\_reads write }; [ ftpd\_full\_access ]:True
While there, also simplify the computation of nslots. This changes the
nslots values for nrules 2 or 3 to just two slots instead of 4, which
makes the sequence more consistent.
Cc: stable@vger.kernel.org
Fixes: c7c556f1e81b ("selinux: refactor changing booleans")
Signed-off-by: Ondrej Mosnacek
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 5f3255aff4ff8ddb12298470b620aa2dd4418525
Author: Ondrej Mosnacek
Date: Fri Apr 2 10:56:18 2021 +0200
selinux: make nslot handling in avtab more robust
commit 442dc00f82a9727dc0c48c44f792c168f593c6df upstream.
1. Make sure all fileds are initialized in avtab\_init().
2. Slightly refactor avtab\_alloc() to use the above fact.
3. Use h->nslot == 0 as a sentinel in the access functions to prevent
dereferencing h->htable when it's not allocated.
Cc: stable@vger.kernel.org
Signed-off-by: Ondrej Mosnacek
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 820d46654348863bf6b359ab1cc978eb1126bcac
Author: Xiaoming Ni
Date: Thu Mar 25 11:51:13 2021 +0800
nfc: Avoid endless loops caused by repeated llcp\_sock\_connect()
commit 4b5db93e7f2afbdfe3b78e37879a85290187e6f1 upstream.
When sock\_wait\_state() returns -EINPROGRESS, "sk->sk\_state" is
LLCP\_CONNECTING. In this case, llcp\_sock\_connect() is repeatedly invoked,
nfc\_llcp\_sock\_link() will add sk to local->connecting\_sockets twice.
sk->sk\_node->next will point to itself, that will make an endless loop
and hang-up the system.
To fix it, check whether sk->sk\_state is LLCP\_CONNECTING in
llcp\_sock\_connect() to avoid repeated invoking.
Fixes: b4011239a08e ("NFC: llcp: Fix non blocking sockets connections")
Reported-by: "kiyin(尹亮)"
Link: https://www.openwall.com/lists/oss-security/2020/11/01/1
Cc:  #v3.11
Signed-off-by: Xiaoming Ni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 596ad6296f07c63bed3cbd573de42f99b7984599
Author: Xiaoming Ni
Date: Thu Mar 25 11:51:12 2021 +0800
nfc: fix memory leak in llcp\_sock\_connect()
commit 7574fcdbdcb335763b6b322f6928dc0fd5730451 upstream.
In llcp\_sock\_connect(), use kmemdup to allocate memory for
"llcp\_sock->service\_name". The memory is not released in the sock\_unlink
label of the subsequent failure branch.
As a result, memory leakage occurs.
fix CVE-2020-25672
Fixes: d646960f7986 ("NFC: Initial LLCP support")
Reported-by: "kiyin(尹亮)"
Link: https://www.openwall.com/lists/oss-security/2020/11/01/1
Cc:  #v3.3
Signed-off-by: Xiaoming Ni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b42800750b07893f2993214c3f777892eb06ad16
Author: Xiaoming Ni
Date: Thu Mar 25 11:51:11 2021 +0800
nfc: fix refcount leak in llcp\_sock\_connect()
commit 8a4cd82d62b5ec7e5482333a72b58a4eea4979f0 upstream.
nfc\_llcp\_local\_get() is invoked in llcp\_sock\_connect(),
but nfc\_llcp\_local\_put() is not invoked in subsequent failure branches.
As a result, refcount leakage occurs.
To fix it, add calling nfc\_llcp\_local\_put().
fix CVE-2020-25671
Fixes: c7aa12252f51 ("NFC: Take a reference on the LLCP local pointer when creating a socket")
Reported-by: "kiyin(尹亮)"
Link: https://www.openwall.com/lists/oss-security/2020/11/01/1
Cc:  #v3.6
Signed-off-by: Xiaoming Ni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8c9e4971e142e2899606a2490b77a1208c1f4638
Author: Xiaoming Ni
Date: Thu Mar 25 11:51:10 2021 +0800
nfc: fix refcount leak in llcp\_sock\_bind()
commit c33b1cc62ac05c1dbb1cdafe2eb66da01c76ca8d upstream.
nfc\_llcp\_local\_get() is invoked in llcp\_sock\_bind(),
but nfc\_llcp\_local\_put() is not invoked in subsequent failure branches.
As a result, refcount leakage occurs.
To fix it, add calling nfc\_llcp\_local\_put().
fix CVE-2020-25670
Fixes: c7aa12252f51 ("NFC: Take a reference on the LLCP local pointer when creating a socket")
Reported-by: "kiyin(尹亮)"
Link: https://www.openwall.com/lists/oss-security/2020/11/01/1
Cc:  #v3.6
Signed-off-by: Xiaoming Ni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c6508aee5629ee9f37abbe799668e5b53d28837b
Author: Hans de Goede
Date: Wed Mar 24 14:27:10 2021 +0100
ASoC: intel: atom: Stop advertising non working S24LE support
commit aa65bacdb70e549a81de03ec72338e1047842883 upstream.
The SST firmware's media and deep-buffer inputs are hardcoded to
S16LE, the corresponding DAIs don't have a hw\_params callback and
their prepare callback also does not take the format into account.
So far the advertising of non working S24LE support has not caused
issues because pulseaudio defaults to S16LE, but changing pulse-audio's
config to use S24LE will result in broken sound.
Pipewire is replacing pulse now and pipewire prefers S24LE over S16LE
when available, causing the problem of the broken S24LE support to
come to the surface now.
Cc: stable@vger.kernel.org
BugLink: https://gitlab.freedesktop.org/pipewire/pipewire/-/issues/866
Fixes: 098c2cd281409 ("ASoC: Intel: Atom: add 24-bit support for media playback and capture")
Acked-by: Pierre-Louis Bossart
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20210324132711.216152-2-hdegoede@redhat.com
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit b1cdcf65b164065714af4e05e2e0e368267eaffc
Author: Christian Brauner
Date: Fri Apr 2 10:29:36 2021 +0200
file: fix close\_range() for unshare+cloexec
commit 9b5b872215fe6d1ca6a1ef411f130bd58e269012 upstream.
syzbot reported a bug when putting the last reference to a tasks file
descriptor table. Debugging this showed we didn't recalculate the
current maximum fd number for CLOSE\_RANGE\_UNSHARE | CLOSE\_RANGE\_CLOEXEC
after we unshared the file descriptors table. So max\_fd could exceed the
current fdtable maximum causing us to set excessive bits. As a concrete
example, let's say the user requested everything from fd 4 to ~0UL to be
closed and their current fdtable size is 256 with their highest open fd
being 4. With CLOSE\_RANGE\_UNSHARE the caller will end up with a new
fdtable which has room for 64 file descriptors since that is the lowest
fdtable size we accept. But now max\_fd will still point to 255 and needs
to be adjusted. Fix this by retrieving the correct maximum fd value in
\_\_range\_cloexec().
Reported-by: syzbot+283ce5a46486d6acdbaf@syzkaller.appspotmail.com
Fixes: 582f1fb6b721 ("fs, close\_range: add flag CLOSE\_RANGE\_CLOEXEC")
Fixes: fec8a6a69103 ("close\_range: unshare all fds for CLOSE\_RANGE\_UNSHARE | CLOSE\_RANGE\_CLOEXEC")
Cc: Christoph Hellwig
Cc: Giuseppe Scrivano
Cc: Al Viro
Cc: linux-fsdevel@vger.kernel.org
Cc: stable@vger.kernel.org
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit b9cf3b06052a41321b1ddabe5cec37e671ef4760
Author: Takashi Iwai
Date: Thu Apr 1 19:13:14 2021 +0200
ALSA: hda/conexant: Apply quirk for another HP ZBook G5 model
commit c6423ed2da6214a68527446b5f8e09cf7162b2ce upstream.
There is another HP ZBook G5 model with the PCI SSID 103c:844f that
requires the same quirk for controlling the mute LED. Add the
corresponding entry to the quirk table.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=212407
Cc:
Link: https://lore.kernel.org/r/20210401171314.667-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 739cee70131c654ab8156c4b80b5b41e47dd9988
Author: Takashi Iwai
Date: Wed Apr 7 11:57:30 2021 +0200
ALSA: hda/realtek: Fix speaker amp setup on Acer Aspire E1
commit c8426b2700b57d2760ff335840a02f66a64b6044 upstream.
We've got a report about Acer Aspire E1 (PCI SSID 1025:0840) that
loses the speaker output after resume. With the comparison of COEF
dumps, it was identified that the COEF 0x0d bits 0x6000 corresponds to
the speaker amp.
This patch adds the specific quirk for the device to restore the COEF
bits at the codec (re-)initialization.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1183869
Cc:
Link: https://lore.kernel.org/r/20210407095730.12560-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 1aaef5565d618343cd50621a58a9bf2e9c3fb141
Author: Jonas Holmberg
Date: Wed Apr 7 09:54:28 2021 +0200
ALSA: aloop: Fix initialization of controls
commit 168632a495f49f33a18c2d502fc249d7610375e9 upstream.
Add a control to the card before copying the id so that the numid field
is initialized in the copy. Otherwise the numid field of active\_id,
format\_id, rate\_id and channels\_id will be the same (0) and
snd\_ctl\_notify() will not queue the events properly.
Signed-off-by: Jonas Holmberg
Reviewed-by: Jaroslav Kysela
Cc:
Link: https://lore.kernel.org/r/20210407075428.2666787-1-jonashg@axis.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit be52c39a141076be17263a2c6b5ef7c7ead236c5
Author: Dmitry Safonov <0x7f454c46@gmail.com>
Date: Tue Mar 30 00:25:06 2021 +0100
xfrm/compat: Cleanup WARN()s that can be user-triggered
commit ef19e111337f6c3dca7019a8bad5fbc6fb18d635 upstream.
Replace WARN\_ONCE() that can be triggered from userspace with
pr\_warn\_once(). Those still give user a hint what's the issue.
I've left WARN()s that are not possible to trigger with current
code-base and that would mean that the code has issues:
- relying on current compat\_msg\_min[type] <= xfrm\_msg\_min[type]
- expected 4-byte padding size difference between
compat\_msg\_min[type] and xfrm\_msg\_min[type]
- compat\_policy[type].len <= xfrma\_policy[type].len
(for every type)
Reported-by: syzbot+834ffd1afc7212eb8147@syzkaller.appspotmail.com
Fixes: 5f3eea6b7e8f ("xfrm/compat: Attach xfrm dumps to 64=>32 bit translator")
Cc: "David S. Miller"
Cc: Eric Dumazet
Cc: Herbert Xu
Cc: Jakub Kicinski
Cc: Steffen Klassert
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Safonov
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman


=== Content from cdn.kernel.org_e0af95cd_20250115_095539.html ===
commit dd5ae3523018ed0d6e58591910cd61bc596fc89c
Author: Greg Kroah-Hartman
Date: Wed Mar 17 17:11:47 2021 +0100
Linux 5.11.7
Tested-by: Jon Hunter
Tested-by: Jason Self
Tested-by: Linux Kernel Functional Testing
Tested-by: Guenter Roeck
Tested-by: Ross Schmidt
Link: https://lore.kernel.org/r/20210315135507.611436477@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 198b86551885f58f9d8396d152db2b6ba96836db
Author: Andrew Scull
Date: Mon Mar 15 12:21:36 2021 +0000
KVM: arm64: Fix nVHE hyp panic host context restore
Commit c4b000c3928d4f20acef79dccf3a65ae3795e0b0 upstream.
When panicking from the nVHE hyp and restoring the host context, x29 is
expected to hold a pointer to the host context. This wasn't being done
so fix it to make sure there's a valid pointer the host context being
used.
Rather than passing a boolean indicating whether or not the host context
should be restored, instead pass the pointer to the host context. NULL
is passed to indicate that no context should be restored.
Fixes: a2e102e20fd6 ("KVM: arm64: nVHE: Handle hyp panics")
Cc: stable@vger.kernel.org # 5.11.y only
Signed-off-by: Andrew Scull
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20210219122406.1337626-1-ascull@google.com
Signed-off-by: Greg Kroah-Hartman
commit 4699bb8dd14c3ad7377b036c85742360c603f117
Author: Mike Rapoport
Date: Fri Mar 12 21:07:12 2021 -0800
mm/page\_alloc.c: refactor initialization of struct page for holes in memory layout
commit 0740a50b9baa4472cfb12442df4b39e2712a64a4 upstream.
There could be struct pages that are not backed by actual physical memory.
This can happen when the actual memory bank is not a multiple of
SECTION\_SIZE or when an architecture does not register memory holes
reserved by the firmware as memblock.memory.
Such pages are currently initialized using init\_unavailable\_mem() function
that iterates through PFNs in holes in memblock.memory and if there is a
struct page corresponding to a PFN, the fields of this page are set to
default values and it is marked as Reserved.
init\_unavailable\_mem() does not take into account zone and node the page
belongs to and sets both zone and node links in struct page to zero.
Before commit 73a6e474cb37 ("mm: memmap\_init: iterate over memblock
regions rather that check each PFN") the holes inside a zone were
re-initialized during memmap\_init() and got their zone/node links right.
However, after that commit nothing updates the struct pages representing
such holes.
On a system that has firmware reserved holes in a zone above ZONE\_DMA, for
instance in a configuration below:
# grep -A1 E820 /proc/iomem
7a17b000-7a216fff : Unknown E820 type
7a217000-7bffffff : System RAM
unset zone link in struct page will trigger
VM\_BUG\_ON\_PAGE(!zone\_spans\_pfn(page\_zone(page), pfn), page);
in set\_pfnblock\_flags\_mask() when called with a struct page from a range
other than E820\_TYPE\_RAM because there are pages in the range of
ZONE\_DMA32 but the unset zone link in struct page makes them appear as a
part of ZONE\_DMA.
Interleave initialization of the unavailable pages with the normal
initialization of memory map, so that zone and node information will be
properly set on struct pages that are not backed by the actual memory.
With this change the pages for holes inside a zone will get proper
zone/node links and the pages that are not spanned by any node will get
links to the adjacent zone/node. The holes between nodes will be
prepended to the zone/node above the hole and the trailing pages in the
last section that will be appended to the zone/node below.
[akpm@linux-foundation.org: don't initialize static to zero, use %llu for u64]
Link: https://lkml.kernel.org/r/20210225224351.7356-2-rppt@kernel.org
Fixes: 73a6e474cb37 ("mm: memmap\_init: iterate over memblock regions rather that check each PFN")
Signed-off-by: Mike Rapoport
Reported-by: Qian Cai
Reported-by: Andrea Arcangeli
Reviewed-by: Baoquan He
Acked-by: Vlastimil Babka
Reviewed-by: David Hildenbrand
Cc: Borislav Petkov
Cc: Chris Wilson
Cc: "H. Peter Anvin"
Cc: Łukasz Majczak
Cc: Ingo Molnar
Cc: Mel Gorman
Cc: Michal Hocko
Cc: "Sarvela, Tomi P"
Cc: Thomas Gleixner
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Mike Rapoport
Signed-off-by: Greg Kroah-Hartman
commit b72b83c6a0e70e266d1b276f0ded1fcbf41eb0dc
Author: Zhou Guanghui
Date: Fri Mar 12 21:08:30 2021 -0800
mm/memcg: rename mem\_cgroup\_split\_huge\_fixup to split\_page\_memcg and add nr\_pages argument
commit be6c8982e4ab9a41907555f601b711a7e2a17d4c upstream.
Rename mem\_cgroup\_split\_huge\_fixup to split\_page\_memcg and explicitly pass
in page number argument.
In this way, the interface name is more common and can be used by
potential users. In addition, the complete info(memcg and flag) of the
memcg needs to be set to the tail pages.
Link: https://lkml.kernel.org/r/20210304074053.65527-2-zhouguanghui1@huawei.com
Signed-off-by: Zhou Guanghui
Acked-by: Johannes Weiner
Reviewed-by: Zi Yan
Reviewed-by: Shakeel Butt
Acked-by: Michal Hocko
Cc: Hugh Dickins
Cc: "Kirill A. Shutemov"
Cc: Nicholas Piggin
Cc: Kefeng Wang
Cc: Hanjun Guo
Cc: Tianhong Ding
Cc: Weilong Chen
Cc: Rui Xiang
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5a162c56353de6d07eab79a02904c31fbb7aa577
Author: Zhou Guanghui
Date: Fri Mar 12 21:08:33 2021 -0800
mm/memcg: set memcg when splitting page
commit e1baddf8475b06cc56f4bafecf9a32a124343d9f upstream.
As described in the split\_page() comment, for the non-compound high order
page, the sub-pages must be freed individually. If the memcg of the first
page is valid, the tail pages cannot be uncharged when be freed.
For example, when alloc\_pages\_exact is used to allocate 1MB continuous
physical memory, 2MB is charged(kmemcg is enabled and \_\_GFP\_ACCOUNT is
set). When make\_alloc\_exact free the unused 1MB and free\_pages\_exact free
the applied 1MB, actually, only 4KB(one page) is uncharged.
Therefore, the memcg of the tail page needs to be set when splitting a
page.
Michel:
There are at least two explicit users of \_\_GFP\_ACCOUNT with
alloc\_exact\_pages added recently. See 7efe8ef274024 ("KVM: arm64:
Allocate stage-2 pgd pages with GFP\_KERNEL\_ACCOUNT") and c419621873713
("KVM: s390: Add memcg accounting to KVM allocations"), so this is not
just a theoretical issue.
Link: https://lkml.kernel.org/r/20210304074053.65527-3-zhouguanghui1@huawei.com
Signed-off-by: Zhou Guanghui
Acked-by: Johannes Weiner
Reviewed-by: Zi Yan
Reviewed-by: Shakeel Butt
Acked-by: Michal Hocko
Cc: Hanjun Guo
Cc: Hugh Dickins
Cc: Kefeng Wang
Cc: "Kirill A. Shutemov"
Cc: Nicholas Piggin
Cc: Rui Xiang
Cc: Tianhong Ding
Cc: Weilong Chen
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 27980e6bd3a21a5bf13a47090d7e934aaf339227
Author: Suren Baghdasaryan
Date: Fri Mar 12 21:08:06 2021 -0800
mm/madvise: replace ptrace attach requirement for process\_madvise
commit 96cfe2c0fd23ea7c2368d14f769d287e7ae1082e upstream.
process\_madvise currently requires ptrace attach capability.
PTRACE\_MODE\_ATTACH gives one process complete control over another
process. It effectively removes the security boundary between the two
processes (in one direction). Granting ptrace attach capability even to a
system process is considered dangerous since it creates an attack surface.
This severely limits the usage of this API.
The operations process\_madvise can perform do not affect the correctness
of the operation of the target process; they only affect where the data is
physically located (and therefore, how fast it can be accessed). What we
want is the ability for one process to influence another process in order
to optimize performance across the entire system while leaving the
security boundary intact.
Replace PTRACE\_MODE\_ATTACH with a combination of PTRACE\_MODE\_READ and
CAP\_SYS\_NICE. PTRACE\_MODE\_READ to prevent leaking ASLR metadata and
CAP\_SYS\_NICE for influencing process performance.
Link: https://lkml.kernel.org/r/20210303185807.2160264-1-surenb@google.com
Signed-off-by: Suren Baghdasaryan
Reviewed-by: Kees Cook
Acked-by: Minchan Kim
Acked-by: David Rientjes
Cc: Jann Horn
Cc: Jeff Vander Stoep
Cc: Michal Hocko
Cc: Shakeel Butt
Cc: Tim Murray
Cc: Florian Weimer
Cc: Oleg Nesterov
Cc: James Morris
Cc:  [5.10+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit eb2a88359a82b1d0c150849ad0873f5d2403fa85
Author: Nadav Amit
Date: Fri Mar 12 21:08:17 2021 -0800
mm/userfaultfd: fix memory corruption due to writeprotect
commit 6ce64428d62026a10cb5d80138ff2f90cc21d367 upstream.
Userfaultfd self-test fails occasionally, indicating a memory corruption.
Analyzing this problem indicates that there is a real bug since mmap\_lock
is only taken for read in mwriteprotect\_range() and defers flushes, and
since there is insufficient consideration of concurrent deferred TLB
flushes in wp\_page\_copy(). Although the PTE is flushed from the TLBs in
wp\_page\_copy(), this flush takes place after the copy has already been
performed, and therefore changes of the page are possible between the time
of the copy and the time in which the PTE is flushed.
To make matters worse, memory-unprotection using userfaultfd also poses a
problem. Although memory unprotection is logically a promotion of PTE
permissions, and therefore should not require a TLB flush, the current
userrfaultfd code might actually cause a demotion of the architectural PTE
permission: when userfaultfd\_writeprotect() unprotects memory region, it
unintentionally \*clears\* the RW-bit if it was already set. Note that this
unprotecting a PTE that is not write-protected is a valid use-case: the
userfaultfd monitor might ask to unprotect a region that holds both
write-protected and write-unprotected PTEs.
The scenario that happens in selftests/vm/userfaultfd is as follows:
cpu0 cpu1 cpu2
---- ---- ----
[ Writable PTE
cached in TLB ]
userfaultfd\_writeprotect()
[ write-\*unprotect\* ]
mwriteprotect\_range()
mmap\_read\_lock()
change\_protection()
change\_protection\_range()
...
change\_pte\_range()
[ \*clear\* “write”-bit ]
[ defer TLB flushes ]
[ page-fault ]
...
wp\_page\_copy()
cow\_user\_page()
[ copy page ]
[ write to old
page ]
...
set\_pte\_at\_notify()
A similar scenario can happen:
cpu0 cpu1 cpu2 cpu3
---- ---- ---- ----
[ Writable PTE
cached in TLB ]
userfaultfd\_writeprotect()
[ write-protect ]
[ deferred TLB flush ]
userfaultfd\_writeprotect()
[ write-unprotect ]
[ deferred TLB flush]
[ page-fault ]
wp\_page\_copy()
cow\_user\_page()
[ copy page ]
... [ write to page ]
set\_pte\_at\_notify()
This race exists since commit 292924b26024 ("userfaultfd: wp: apply
\_PAGE\_UFFD\_WP bit"). Yet, as Yu Zhao pointed, these races became apparent
since commit 09854ba94c6a ("mm: do\_wp\_page() simplification") which made
wp\_page\_copy() more likely to take place, specifically if page\_count(page)
> 1.
To resolve the aforementioned races, check whether there are pending
flushes on uffd-write-protected VMAs, and if there are, perform a flush
before doing the COW.
Further optimizations will follow to avoid during uffd-write-unprotect
unnecassary PTE write-protection and TLB flushes.
Link: https://lkml.kernel.org/r/20210304095423.3825684-1-namit@vmware.com
Fixes: 09854ba94c6a ("mm: do\_wp\_page() simplification")
Signed-off-by: Nadav Amit
Suggested-by: Yu Zhao
Reviewed-by: Peter Xu
Tested-by: Peter Xu
Cc: Andrea Arcangeli
Cc: Andy Lutomirski
Cc: Pavel Emelyanov
Cc: Mike Kravetz
Cc: Mike Rapoport
Cc: Minchan Kim
Cc: Will Deacon
Cc: Peter Zijlstra
Cc:  [5.9+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 1ae5cef2362a2018ccf95c3943c05640082674ff
Author: OGAWA Hirofumi
Date: Fri Mar 12 21:07:37 2021 -0800
mm/highmem.c: fix zero\_user\_segments() with start > end
commit 184cee516f3e24019a08ac8eb5c7cf04c00933cb upstream.
zero\_user\_segments() is used from \_\_block\_write\_begin\_int(), for example
like the following
zero\_user\_segments(page, 4096, 1024, 512, 918)
But new the zero\_user\_segments() implementation for for HIGHMEM +
TRANSPARENT\_HUGEPAGE doesn't handle "start > end" case correctly, and hits
BUG\_ON(). (we can fix \_\_block\_write\_begin\_int() instead though, it is the
old and multiple usage)
Also it calls kmap\_atomic() unnecessarily while start == end == 0.
Link: https://lkml.kernel.org/r/87v9ab60r4.fsf@mail.parknet.co.jp
Fixes: 0060ef3b4e6d ("mm: support THPs in zero\_user\_segments")
Signed-off-by: OGAWA Hirofumi
Cc: Matthew Wilcox
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4e11dc5f0e9cd67651911bfad605fadd08030a33
Author: Marc Zyngier
Date: Thu Mar 11 10:00:16 2021 +0000
KVM: arm64: Fix exclusive limit for IPA size
commit 262b003d059c6671601a19057e9fe1a5e7f23722 upstream.
When registering a memslot, we check the size and location of that
memslot against the IPA size to ensure that we can provide guest
access to the whole of the memory.
Unfortunately, this check rejects memslot that end-up at the exact
limit of the addressing capability for a given IPA size. For example,
it refuses the creation of a 2GB memslot at 0x8000000 with a 32bit
IPA space.
Fix it by relaxing the check to accept a memslot reaching the
limit of the IPA space.
Fixes: c3058d5da222 ("arm/arm64: KVM: Ensure memslots are within KVM\_PHYS\_SIZE")
Reviewed-by: Eric Auger
Signed-off-by: Marc Zyngier
Cc: stable@vger.kernel.org
Reviewed-by: Andrew Jones
Link: https://lore.kernel.org/r/20210311100016.3830038-3-maz@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 9c501b2204800b472bfbc53226e02a2dc7b12c48
Author: Marc Zyngier
Date: Thu Mar 11 10:00:15 2021 +0000
KVM: arm64: Reject VM creation when the default IPA size is unsupported
commit 7d717558dd5ef10d28866750d5c24ff892ea3778 upstream.
KVM/arm64 has forever used a 40bit default IPA space, partially
due to its 32bit heritage (where the only choice is 40bit).
However, there are implementations in the wild that have a \*cough\*
much smaller \*cough\* IPA space, which leads to a misprogramming of
VTCR\_EL2, and a guest that is stuck on its first memory access
if userspace dares to ask for the default IPA setting (which most
VMMs do).
Instead, blundly reject the creation of such VM, as we can't
satisfy the requirements from userspace (with a one-off warning).
Also clarify the boot warning, and document that the VM creation
will fail when an unsupported IPA size is provided.
Although this is an ABI change, it doesn't really change much
for userspace:
- the guest couldn't run before this change, but no error was
returned. At least userspace knows what is happening.
- a memory slot that was accepted because it did fit the default
IPA space now doesn't even get a chance to be registered.
The other thing that is left doing is to convince userspace to
actually use the IPA space setting instead of relying on the
antiquated default.
Fixes: 233a7cb23531 ("kvm: arm64: Allow tuning the physical address size for VM")
Signed-off-by: Marc Zyngier
Cc: stable@vger.kernel.org
Reviewed-by: Andrew Jones
Reviewed-by: Eric Auger
Link: https://lore.kernel.org/r/20210311100016.3830038-2-maz@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 6d448bab893bb870d558454428ebf4558b79c424
Author: Suzuki K Poulose
Date: Fri Mar 5 18:52:47 2021 +0000
KVM: arm64: nvhe: Save the SPE context early
commit b96b0c5de685df82019e16826a282d53d86d112c upstream.
The nVHE KVM hyp drains and disables the SPE buffer, before
entering the guest, as the EL1&0 translation regime
is going to be loaded with that of the guest.
But this operation is performed way too late, because :
- The owning translation regime of the SPE buffer
is transferred to EL2. (MDCR\_EL2\_E2PB == 0)
- The guest Stage1 is loaded.
Thus the flush could use the host EL1 virtual address,
but use the EL2 translations instead of host EL1, for writing
out any cached data.
Fix this by moving the SPE buffer handling early enough.
The restore path is doing the right thing.
Fixes: 014c4c77aad7 ("KVM: arm64: Improve debug register save/restore flow")
Cc: stable@vger.kernel.org
Cc: Christoffer Dall
Cc: Marc Zyngier
Cc: Will Deacon
Cc: Catalin Marinas
Cc: Mark Rutland
Cc: Alexandru Elisei
Reviewed-by: Alexandru Elisei
Signed-off-by: Suzuki K Poulose
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20210302120345.3102874-1-suzuki.poulose@arm.com
Message-Id: <20210305185254.3730990-2-maz@kernel.org>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 308d9960c1461337d1d101fd9712dafa143e07fd
Author: Will Deacon
Date: Fri Mar 5 18:52:48 2021 +0000
KVM: arm64: Avoid corrupting vCPU context register in guest exit
commit 31948332d5fa392ad933f4a6a10026850649ed76 upstream.
Commit 7db21530479f ("KVM: arm64: Restore hyp when panicking in guest
context") tracks the currently running vCPU, clearing the pointer to
NULL on exit from a guest.
Unfortunately, the use of 'set\_loaded\_vcpu' clobbers x1 to point at the
kvm\_hyp\_ctxt instead of the vCPU context, causing the subsequent RAS
code to go off into the weeds when it saves the DISR assuming that the
CPU context is embedded in a struct vCPU.
Leave x1 alone and use x3 as a temporary register instead when clearing
the vCPU on the guest exit path.
Cc: Marc Zyngier
Cc: Andrew Scull
Cc:
Fixes: 7db21530479f ("KVM: arm64: Restore hyp when panicking in guest context")
Suggested-by: Quentin Perret
Signed-off-by: Will Deacon
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20210226181211.14542-1-will@kernel.org
Message-Id: <20210305185254.3730990-3-maz@kernel.org>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 92d908dc52912e4f89b69779069e54c65ed2d86b
Author: Jia He
Date: Fri Mar 5 18:52:54 2021 +0000
KVM: arm64: Fix range alignment when walking page tables
commit 357ad203d45c0f9d76a8feadbd5a1c5d460c638b upstream.
When walking the page tables at a given level, and if the start
address for the range isn't aligned for that level, we propagate
the misalignment on each iteration at that level.
This results in the walker ignoring a number of entries (depending
on the original misalignment) on each subsequent iteration.
Properly aligning the address before the next iteration addresses
this issue.
Cc: stable@vger.kernel.org
Reported-by: Howard Zhang
Acked-by: Will Deacon
Signed-off-by: Jia He
Fixes: b1e57de62cfb ("KVM: arm64: Add stand-alone page-table walker infrastructure")
[maz: rewrite commit message]
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20210303024225.2591-1-justin.he@arm.com
Message-Id: <20210305185254.3730990-9-maz@kernel.org>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit f2f50032b65d30a2122f693ba4850335bbd4f699
Author: Marc Zyngier
Date: Wed Mar 3 16:45:05 2021 +0000
KVM: arm64: Ensure I-cache isolation between vcpus of a same VM
commit 01dc9262ff5797b675c32c0c6bc682777d23de05 upstream.
It recently became apparent that the ARMv8 architecture has interesting
rules regarding attributes being used when fetching instructions
if the MMU is off at Stage-1.
In this situation, the CPU is allowed to fetch from the PoC and
allocate into the I-cache (unless the memory is mapped with
the XN attribute at Stage-2).
If we transpose this to vcpus sharing a single physical CPU,
it is possible for a vcpu running with its MMU off to influence
another vcpu running with its MMU on, as the latter is expected to
fetch from the PoU (and self-patching code doesn't flush below that
level).
In order to solve this, reuse the vcpu-private TLB invalidation
code to apply the same policy to the I-cache, nuking it every time
the vcpu runs on a physical CPU that ran another vcpu of the same
VM in the past.
This involve renaming \_\_kvm\_tlb\_flush\_local\_vmid() to
\_\_kvm\_flush\_cpu\_context(), and inserting a local i-cache invalidation
there.
Cc: stable@vger.kernel.org
Signed-off-by: Marc Zyngier
Acked-by: Will Deacon
Acked-by: Catalin Marinas
Link: https://lore.kernel.org/r/20210303164505.68492-1-maz@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit fd398928b1b06df777c0c5076b97d48f013f9575
Author: Wanpeng Li
Date: Wed Feb 24 09:37:29 2021 +0800
KVM: kvmclock: Fix vCPUs > 64 can't be online/hotpluged
commit d7eb79c6290c7ae4561418544072e0a3266e7384 upstream.
# lscpu
Architecture: x86\_64
CPU op-mode(s): 32-bit, 64-bit
Byte Order: Little Endian
CPU(s): 88
On-line CPU(s) list: 0-63
Off-line CPU(s) list: 64-87
# cat /proc/cmdline
BOOT\_IMAGE=/vmlinuz-5.10.0-rc3-tlinux2-0050+ root=/dev/mapper/cl-root ro
rd.lvm.lv=cl/root rhgb quiet console=ttyS0 LANG=en\_US .UTF-8 no-kvmclock-vsyscall
# echo 1 > /sys/devices/system/cpu/cpu76/online
-bash: echo: write error: Cannot allocate memory
The per-cpu vsyscall pvclock data pointer assigns either an element of the
static array hv\_clock\_boot (#vCPU <= 64) or dynamically allocated memory
hvclock\_mem (vCPU > 64), the dynamically memory will not be allocated if
kvmclock vsyscall is disabled, this can result in cpu hotpluged fails in
kvmclock\_setup\_percpu() which returns -ENOMEM. It's broken for no-vsyscall
and sometimes you end up with vsyscall disabled if the host does something
strange. This patch fixes it by allocating this dynamically memory
unconditionally even if vsyscall is disabled.
Fixes: 6a1cac56f4 ("x86/kvm: Use \_\_bss\_decrypted attribute in shared variables")
Reported-by: Zelin Deng
Cc: Brijesh Singh
Cc: stable@vger.kernel.org#v4.19-rc5+
Signed-off-by: Wanpeng Li
Message-Id: <1614130683-24137-1-git-send-email-wanpengli@tencent.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 8da4090a0f4688e6cb3d2b55f985f297c882022c
Author: Sean Christopherson
Date: Thu Mar 4 18:18:08 2021 -0800
KVM: x86: Ensure deadline timer has truly expired before posting its IRQ
commit beda430177f56656e7980dcce93456ffaa35676b upstream.
When posting a deadline timer interrupt, open code the checks guarding
\_\_kvm\_wait\_lapic\_expire() in order to skip the lapic\_timer\_int\_injected()
check in kvm\_wait\_lapic\_expire(). The injection check will always fail
since the interrupt has not yet be injected. Moving the call after
injection would also be wrong as that wouldn't actually delay delivery
of the IRQ if it is indeed sent via posted interrupt.
Fixes: 010fd37fddf6 ("KVM: LAPIC: Reduce world switch latency caused by timer\_advance\_ns")
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Message-Id: <20210305021808.3769732-1-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 9bd012cb9b431424ce411da291c51ae80c830201
Author: Andy Lutomirski
Date: Thu Mar 4 11:05:54 2021 -0800
x86/entry: Fix entry/exit mismatch on failed fast 32-bit syscalls
commit 5d5675df792ff67e74a500c4c94db0f99e6a10ef upstream.
On a 32-bit fast syscall that fails to read its arguments from user
memory, the kernel currently does syscall exit work but not
syscall entry work. This confuses audit and ptrace. For example:
$ ./tools/testing/selftests/x86/syscall\_arg\_fault\_32
...
strace: pid 264258: entering, ptrace\_syscall\_info.op == 2
...
This is a minimal fix intended for ease of backporting. A more
complete cleanup is coming.
Fixes: 0b085e68f407 ("x86/entry: Consolidate 32/64 bit syscall entry")
Signed-off-by: Andy Lutomirski
Signed-off-by: Thomas Gleixner
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/8c82296ddf803b91f8d1e5eac89e5803ba54ab0e.1614884673.git.luto@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit eb4d509d3da6dcd89ec0e43e99bdefb5ddda9970
Author: Joerg Roedel
Date: Wed Mar 3 15:17:16 2021 +0100
x86/sev-es: Use \_\_copy\_from\_user\_inatomic()
commit bffe30dd9f1f3b2608a87ac909a224d6be472485 upstream.
The #VC handler must run in atomic context and cannot sleep. This is a
problem when it tries to fetch instruction bytes from user-space via
copy\_from\_user().
Introduce a insn\_fetch\_from\_user\_inatomic() helper which uses
\_\_copy\_from\_user\_inatomic() to safely copy the instruction bytes to
kernel memory in the #VC handler.
Fixes: 5e3427a7bc432 ("x86/sev-es: Handle instruction fetches from user-space")
Signed-off-by: Joerg Roedel
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org # v5.10+
Link: https://lkml.kernel.org/r/20210303141716.29223-6-joro@8bytes.org
Signed-off-by: Greg Kroah-Hartman
commit 178615c6bceef1104c865b9d1e4133a859de5095
Author: Joerg Roedel
Date: Wed Mar 3 15:17:15 2021 +0100
x86/sev-es: Correctly track IRQ states in runtime #VC handler
commit 62441a1fb53263bda349b6e5997c3cc5c120d89e upstream.
Call irqentry\_nmi\_enter()/irqentry\_nmi\_exit() in the #VC handler to
correctly track the IRQ state during its execution.
Fixes: 0786138c78e79 ("x86/sev-es: Add a Runtime #VC Exception Handler")
Reported-by: Andy Lutomirski
Signed-off-by: Joerg Roedel
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org # v5.10+
Link: https://lkml.kernel.org/r/20210303141716.29223-5-joro@8bytes.org
Signed-off-by: Greg Kroah-Hartman
commit d023a773a0e81d3843f12547226b99d8486d5d3e
Author: Joerg Roedel
Date: Wed Mar 3 15:17:13 2021 +0100
x86/sev-es: Check regs->sp is trusted before adjusting #VC IST stack
commit 545ac14c16b5dbd909d5a90ddf5b5a629a40fa94 upstream.
The code in the NMI handler to adjust the #VC handler IST stack is
needed in case an NMI hits when the #VC handler is still using its IST
stack.
But the check for this condition also needs to look if the regs->sp
value is trusted, meaning it was not set by user-space. Extend the check
to not use regs->sp when the NMI interrupted user-space code or the
SYSCALL gap.
Fixes: 315562c9af3d5 ("x86/sev-es: Adjust #VC IST Stack on entering NMI handler")
Reported-by: Andy Lutomirski
Signed-off-by: Joerg Roedel
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org # 5.10+
Link: https://lkml.kernel.org/r/20210303141716.29223-3-joro@8bytes.org
Signed-off-by: Greg Kroah-Hartman
commit 8d5720ce452f008bbc47cb010597da4035af9fdc
Author: Joerg Roedel
Date: Wed Mar 3 15:17:12 2021 +0100
x86/sev-es: Introduce ip\_within\_syscall\_gap() helper
commit 78a81d88f60ba773cbe890205e1ee67f00502948 upstream.
Introduce a helper to check whether an exception came from the syscall
gap and use it in the SEV-ES code. Extend the check to also cover the
compatibility SYSCALL entry path.
Fixes: 315562c9af3d5 ("x86/sev-es: Adjust #VC IST Stack on entering NMI handler")
Signed-off-by: Joerg Roedel
Signed-off-by: Borislav Petkov
Cc: stable@vger.kernel.org # 5.10+
Link: https://lkml.kernel.org/r/20210303141716.29223-2-joro@8bytes.org
Signed-off-by: Greg Kroah-Hartman
commit 1794ef8142ddeda54e74280e1798e08dbcef0882
Author: Josh Poimboeuf
Date: Fri Feb 5 08:24:02 2021 -0600
x86/unwind/orc: Disable KASAN checking in the ORC unwinder, part 2
commit e504e74cc3a2c092b05577ce3e8e013fae7d94e6 upstream.
KASAN reserves "redzone" areas between stack frames in order to detect
stack overruns. A read or write to such an area triggers a KASAN
"stack-out-of-bounds" BUG.
Normally, the ORC unwinder stays in-bounds and doesn't access the
redzone. But sometimes it can't find ORC metadata for a given
instruction. This can happen for code which is missing ORC metadata, or
for generated code. In such cases, the unwinder attempts to fall back
to frame pointers, as a best-effort type thing.
This fallback often works, but when it doesn't, the unwinder can get
confused and go off into the weeds into the KASAN redzone, triggering
the aforementioned KASAN BUG.
But in this case, the unwinder's confusion is actually harmless and
working as designed. It already has checks in place to prevent
off-stack accesses, but those checks get short-circuited by the KASAN
BUG. And a BUG is a lot more disruptive than a harmless unwinder
warning.
Disable the KASAN checks by using READ\_ONCE\_NOCHECK() for all stack
accesses. This finishes the job started by commit 881125bfe65b
("x86/unwind: Disable KASAN checking in the ORC unwinder"), which only
partially fixed the issue.
Fixes: ee9f8fce9964 ("x86/unwind: Add the ORC unwinder")
Reported-by: Ivan Babrou
Signed-off-by: Josh Poimboeuf
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Borislav Petkov
Reviewed-by: Steven Rostedt (VMware)
Tested-by: Ivan Babrou
Cc: stable@kernel.org
Link: https://lkml.kernel.org/r/9583327904ebbbeda399eca9c56d6c7085ac20fe.1612534649.git.jpoimboe@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit 8f105cac6c48f62147a7a15db51ebbe7b4c27377
Author: Andrey Konovalov
Date: Fri Mar 12 21:08:13 2021 -0800
kasan: fix KASAN\_STACK dependency for HW\_TAGS
commit d9b571c885a8974fbb7d4ee639dbc643fd000f9e upstream.
There's a runtime failure when running HW\_TAGS-enabled kernel built with
GCC on hardware that doesn't support MTE. GCC-built kernels always have
CONFIG\_KASAN\_STACK enabled, even though stack instrumentation isn't
supported by HW\_TAGS. Having that config enabled causes KASAN to issue
MTE-only instructions to unpoison kernel stacks, which causes the failure.
Fix the issue by disallowing CONFIG\_KASAN\_STACK when HW\_TAGS is used.
(The commit that introduced CONFIG\_KASAN\_HW\_TAGS specified proper
dependency for CONFIG\_KASAN\_STACK\_ENABLE but not for CONFIG\_KASAN\_STACK.)
Link: https://lkml.kernel.org/r/59e75426241dbb5611277758c8d4d6f5f9298dac.1615215441.git.andreyknvl@google.com
Fixes: 6a63a63ff1ac ("kasan: introduce CONFIG\_KASAN\_HW\_TAGS")
Signed-off-by: Andrey Konovalov
Reported-by: Catalin Marinas
Cc:
Cc: Will Deacon
Cc: Vincenzo Frascino
Cc: Dmitry Vyukov
Cc: Andrey Ryabinin
Cc: Alexander Potapenko
Cc: Marco Elver
Cc: Peter Collingbourne
Cc: Evgenii Stepanov
Cc: Branislav Rankov
Cc: Kevin Brodsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit f32ff9f5ceb2fe1e10be2264029b0aad198cc2da
Author: Andrey Konovalov
Date: Fri Mar 12 21:08:10 2021 -0800
kasan, mm: fix crash with HW\_TAGS and DEBUG\_PAGEALLOC
commit f9d79e8dce4077d3c6ab739c808169dfa99af9ef upstream.
Currently, kasan\_free\_nondeferred\_pages()->kasan\_free\_pages() is called
after debug\_pagealloc\_unmap\_pages(). This causes a crash when
debug\_pagealloc is enabled, as HW\_TAGS KASAN can't set tags on an
unmapped page.
This patch puts kasan\_free\_nondeferred\_pages() before
debug\_pagealloc\_unmap\_pages() and arch\_free\_page(), which can also make
the page unavailable.
Link: https://lkml.kernel.org/r/24cd7db274090f0e5bc3adcdc7399243668e3171.1614987311.git.andreyknvl@google.com
Fixes: 94ab5b61ee16 ("kasan, arm64: enable CONFIG\_KASAN\_HW\_TAGS")
Signed-off-by: Andrey Konovalov
Cc: Catalin Marinas
Cc: Will Deacon
Cc: Vincenzo Frascino
Cc: Dmitry Vyukov
Cc: Andrey Ryabinin
Cc: Alexander Potapenko
Cc: Marco Elver
Cc: Peter Collingbourne
Cc: Evgenii Stepanov
Cc: Branislav Rankov
Cc: Kevin Brodsky
Cc: Christoph Hellwig
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d28492be82e19fc69cc69975fc2052b37ef0c821
Author: Lior Ribak
Date: Fri Mar 12 21:07:41 2021 -0800
binfmt\_misc: fix possible deadlock in bm\_register\_write
commit e7850f4d844e0acfac7e570af611d89deade3146 upstream.
There is a deadlock in bm\_register\_write:
First, in the begining of the function, a lock is taken on the binfmt\_misc
root inode with inode\_lock(d\_inode(root)).
Then, if the user used the MISC\_FMT\_OPEN\_FILE flag, the function will call
open\_exec on the user-provided interpreter.
open\_exec will call a path lookup, and if the path lookup process includes
the root of binfmt\_misc, it will try to take a shared lock on its inode
again, but it is already locked, and the code will get stuck in a deadlock
To reproduce the bug:
$ echo ":iiiii:E::ii::/proc/sys/fs/binfmt\_misc/bla:F" > /proc/sys/fs/binfmt\_misc/register
backtrace of where the lock occurs (#5):
0 schedule () at ./arch/x86/include/asm/current.h:15
1 0xffffffff81b51237 in rwsem\_down\_read\_slowpath (sem=0xffff888003b202e0, count=, state=state@entry=2) at kernel/locking/rwsem.c:992
2 0xffffffff81b5150a in \_\_down\_read\_common (state=2, sem=) at kernel/locking/rwsem.c:1213
3 \_\_down\_read (sem=) at kernel/locking/rwsem.c:1222
4 down\_read (sem=) at kernel/locking/rwsem.c:1355
5 0xffffffff811ee22a in inode\_lock\_shared (inode=) at ./include/linux/fs.h:783
6 open\_last\_lookups (op=0xffffc9000022fe34, file=0xffff888004098600, nd=0xffffc9000022fd10) at fs/namei.c:3177
7 path\_openat (nd=nd@entry=0xffffc9000022fd10, op=op@entry=0xffffc9000022fe34, flags=flags@entry=65) at fs/namei.c:3366
8 0xffffffff811efe1c in do\_filp\_open (dfd=, pathname=pathname@entry=0xffff8880031b9000, op=op@entry=0xffffc9000022fe34) at fs/namei.c:3396
9 0xffffffff811e493f in do\_open\_execat (fd=fd@entry=-100, name=name@entry=0xffff8880031b9000, flags=, flags@entry=0) at fs/exec.c:913
10 0xffffffff811e4a92 in open\_exec (name=) at fs/exec.c:948
11 0xffffffff8124aa84 in bm\_register\_write (file=, buffer=, count=19, ppos=) at fs/binfmt\_misc.c:682
12 0xffffffff811decd2 in vfs\_write (file=file@entry=0xffff888004098500, buf=buf@entry=0xa758d0 ":iiiii:E::ii::i:CF
", count=count@entry=19, pos=pos@entry=0xffffc9000022ff10) at fs/read\_write.c:603
13 0xffffffff811defda in ksys\_write (fd=, buf=0xa758d0 ":iiiii:E::ii::i:CF
", count=19) at fs/read\_write.c:658
14 0xffffffff81b49813 in do\_syscall\_64 (nr=, regs=0xffffc9000022ff58) at arch/x86/entry/common.c:46
15 0xffffffff81c0007c in entry\_SYSCALL\_64 () at arch/x86/entry/entry\_64.S:120
To solve the issue, the open\_exec call is moved to before the write
lock is taken by bm\_register\_write
Link: https://lkml.kernel.org/r/20210228224414.95962-1-liorribak@gmail.com
Fixes: 948b701a607f1 ("binfmt\_misc: add persistent opened binary handler for containers")
Signed-off-by: Lior Ribak
Acked-by: Helge Deller
Cc: Al Viro
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit fabe9bbf52c7bda6cefafbc2e75ab1a41951d94d
Author: Christophe Leroy
Date: Tue Mar 9 08:39:39 2021 +0000
powerpc: Fix missing declaration of [en/dis]able\_kernel\_vsx()
commit bd73758803c2eedc037c2268b65a19542a832594 upstream.
Add stub instances of enable\_kernel\_vsx() and disable\_kernel\_vsx()
when CONFIG\_VSX is not set, to avoid following build failure.
CC [M] drivers/gpu/drm/amd/amdgpu/../display/dc/calcs/dcn\_calcs.o
In file included from ./drivers/gpu/drm/amd/amdgpu/../display/dc/dm\_services\_types.h:29,
from ./drivers/gpu/drm/amd/amdgpu/../display/dc/dm\_services.h:37,
from drivers/gpu/drm/amd/amdgpu/../display/dc/calcs/dcn\_calcs.c:27:
drivers/gpu/drm/amd/amdgpu/../display/dc/calcs/dcn\_calcs.c: In function 'dcn\_bw\_apply\_registry\_override':
./drivers/gpu/drm/amd/amdgpu/../display/dc/os\_types.h:64:3: error: implicit declaration of function 'enable\_kernel\_vsx'; did you mean 'enable\_kernel\_fp'? [-Werror=implicit-function-declaration]
64 | enable\_kernel\_vsx(); \
| ^~~~~~~~~~~~~~~~~
drivers/gpu/drm/amd/amdgpu/../display/dc/calcs/dcn\_calcs.c:640:2: note: in expansion of macro 'DC\_FP\_START'
640 | DC\_FP\_START();
| ^~~~~~~~~~~
./drivers/gpu/drm/amd/amdgpu/../display/dc/os\_types.h:75:3: error: implicit declaration of function 'disable\_kernel\_vsx'; did you mean 'disable\_kernel\_fp'? [-Werror=implicit-function-declaration]
75 | disable\_kernel\_vsx(); \
| ^~~~~~~~~~~~~~~~~~
drivers/gpu/drm/amd/amdgpu/../display/dc/calcs/dcn\_calcs.c:676:2: note: in expansion of macro 'DC\_FP\_END'
676 | DC\_FP\_END();
| ^~~~~~~~~
cc1: some warnings being treated as errors
make[5]: \*\*\* [drivers/gpu/drm/amd/amdgpu/../display/dc/calcs/dcn\_calcs.o] Error 1
This works because the caller is checking if VSX is available using
cpu\_has\_feature():
#define DC\_FP\_START() { \
if (cpu\_has\_feature(CPU\_FTR\_VSX\_COMP)) { \
preempt\_disable(); \
enable\_kernel\_vsx(); \
} else if (cpu\_has\_feature(CPU\_FTR\_ALTIVEC\_COMP)) { \
preempt\_disable(); \
enable\_kernel\_altivec(); \
} else if (!cpu\_has\_feature(CPU\_FTR\_FPU\_UNAVAILABLE)) { \
preempt\_disable(); \
enable\_kernel\_fp(); \
} \
When CONFIG\_VSX is not selected, cpu\_has\_feature(CPU\_FTR\_VSX\_COMP)
constant folds to 'false' so the call to enable\_kernel\_vsx() is
discarded and the build succeeds.
Fixes: 16a9dea110a6 ("amdgpu: Enable initial DCN support on POWER")
Cc: stable@vger.kernel.org # v5.6+
Reported-by: Geert Uytterhoeven
Reported-by: kernel test robot
Signed-off-by: Christophe Leroy
[mpe: Incorporate some discussion comments into the change log]
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/8d7d285a027e9d21f5ff7f850fa71a2655b0c4af.1615279170.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 2f12b9febb38de5d7c0bbf0dd7f4a2fdb9ab1e0b
Author: Nicholas Piggin
Date: Mon Mar 8 18:55:30 2021 +1000
powerpc: Fix inverted SET\_FULL\_REGS bitop
commit 73ac79881804eed2e9d76ecdd1018037f8510cb1 upstream.
This bit operation was inverted and set the low bit rather than
cleared it, breaking the ability to ptrace non-volatile GPRs after
exec. Fix.
Only affects 64e and 32-bit.
Fixes: feb9df3462e6 ("powerpc/64s: Always has full regs, so remove remnant checks")
Cc: stable@vger.kernel.org # v5.8+
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210308085530.3191843-1-npiggin@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 9e46a01793b1c1292c83e6028ff4d679b27cbd98
Author: Naveen N. Rao
Date: Thu Mar 4 07:34:11 2021 +0530
powerpc/64s: Fix instruction encoding for lis in ppc\_function\_entry()
commit cea15316ceee2d4a51dfdecd79e08a438135416c upstream.
'lis r2,N' is 'addis r2,0,N' and the instruction encoding in the macro
LIS\_R2 is incorrect (it currently maps to 'addis r0,r2,N'). Fix the
same.
Fixes: c71b7eff426f ("powerpc: Add ABIv2 support to ppc\_function\_entry")
Cc: stable@vger.kernel.org # v3.16+
Reported-by: Jiri Olsa
Signed-off-by: Naveen N. Rao
Acked-by: Segher Boessenkool
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210304020411.16796-1-naveen.n.rao@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 15dcba8a7fdbb096252c7cc3e17dee384c1c52b8
Author: Ard Biesheuvel
Date: Fri Mar 5 10:21:05 2021 +0100
efi: stub: omit SetVirtualAddressMap() if marked unsupported in RT\_PROP table
commit 9e9888a0fe97b9501a40f717225d2bef7100a2c1 upstream.
The EFI\_RT\_PROPERTIES\_TABLE contains a mask of runtime services that are
available after ExitBootServices(). This mostly does not concern the EFI
stub at all, given that it runs before that. However, there is one call
that is made at runtime, which is the call to SetVirtualAddressMap()
(which is not even callable at boot time to begin with)
So add the missing handling of the RT\_PROP table to ensure that we only
call SetVirtualAddressMap() if it is not being advertised as unsupported
by the firmware.
Cc:  # v5.10+
Tested-by: Shawn Guo
Signed-off-by: Ard Biesheuvel
Signed-off-by: Greg Kroah-Hartman
commit ab4728011789c84a6bca3c3a88ea8ace7acec837
Author: Peter Zijlstra
Date: Wed Feb 24 11:42:08 2021 +0100
sched: Simplify set\_affinity\_pending refcounts
commit 50caf9c14b1498c90cf808dbba2ca29bd32ccba4 upstream.
Now that we have set\_affinity\_pending::stop\_pending to indicate if a
stopper is in progress, and we have the guarantee that if that stopper
exists, it will (eventually) complete our @pending we can simplify the
refcount scheme by no longer counting the stopper thread.
Fixes: 6d337eab041d ("sched: Fix migrate\_disable() vs set\_cpus\_allowed\_ptr()")
Cc: stable@kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Reviewed-by: Valentin Schneider
Link: https://lkml.kernel.org/r/20210224131355.724130207@infradead.org
Signed-off-by: Greg Kroah-Hartman
commit 6ebb2dbadb442e8efb4b7a5daa4a50031b2a8491
Author: Peter Zijlstra
Date: Wed Feb 24 11:31:09 2021 +0100
sched: Fix affine\_move\_task() self-concurrency
commit 9e81889c7648d48dd5fe13f41cbc99f3c362484a upstream.
Consider:
sched\_setaffinity(p, X); sched\_setaffinity(p, Y);
Then the first will install p->migration\_pending = &my\_pending; and
issue stop\_one\_cpu\_nowait(pending); and the second one will read
p->migration\_pending and \_also\_ issue: stop\_one\_cpu\_nowait(pending),
the \_SAME\_ @pending.
This causes stopper list corruption.
Add set\_affinity\_pending::stop\_pending, to indicate if a stopper is in
progress.
Fixes: 6d337eab041d ("sched: Fix migrate\_disable() vs set\_cpus\_allowed\_ptr()")
Cc: stable@kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Reviewed-by: Valentin Schneider
Link: https://lkml.kernel.org/r/20210224131355.649146419@infradead.org
Signed-off-by: Greg Kroah-Hartman
commit a8957bc5a1a086fc806a6441c9157f12e6ef7129
Author: Peter Zijlstra
Date: Wed Feb 24 11:21:35 2021 +0100
sched: Optimize migration\_cpu\_stop()
commit 3f1bc119cd7fc987c8ed25ffb717f99403bb308c upstream.
When the purpose of migration\_cpu\_stop() is to migrate the task to
'any' valid CPU, don't migrate the task when it's already running on a
valid CPU.
Fixes: 6d337eab041d ("sched: Fix migrate\_disable() vs set\_cpus\_allowed\_ptr()")
Cc: stable@kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Reviewed-by: Valentin Schneider
Link: https://lkml.kernel.org/r/20210224131355.569238629@infradead.org
Signed-off-by: Greg Kroah-Hartman
commit dd8b56e25964452c63eb01ce49b9e4cfd97c4dc0
Author: Peter Zijlstra
Date: Wed Feb 24 11:50:39 2021 +0100
sched: Simplify migration\_cpu\_stop()
commit c20cf065d4a619d394d23290093b1002e27dff86 upstream.
When affine\_move\_task() issues a migration\_cpu\_stop(), the purpose of
that function is to complete that @pending, not any random other
p->migration\_pending that might have gotten installed since.
This realization much simplifies migration\_cpu\_stop() and allows
further necessary steps to fix all this as it provides the guarantee
that @pending's stopper will complete @pending (and not some random
other @pending).
Fixes: 6d337eab041d ("sched: Fix migrate\_disable() vs set\_cpus\_allowed\_ptr()")
Cc: stable@kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Reviewed-by: Valentin Schneider
Link: https://lkml.kernel.org/r/20210224131355.430014682@infradead.org
Signed-off-by: Greg Kroah-Hartman
commit 3d0fef8ad71809778aeb4e43599ae5ec1d5428c9
Author: Peter Zijlstra
Date: Wed Feb 24 11:15:23 2021 +0100
sched: Collate affine\_move\_task() stoppers
commit 58b1a45086b5f80f2b2842aa7ed0da51a64a302b upstream.
The SCA\_MIGRATE\_ENABLE and task\_running() cases are almost identical,
collapse them to avoid further duplication.
Fixes: 6d337eab041d ("sched: Fix migrate\_disable() vs set\_cpus\_allowed\_ptr()")
Cc: stable@kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Reviewed-by: Valentin Schneider
Link: https://lkml.kernel.org/r/20210224131355.500108964@infradead.org
Signed-off-by: Greg Kroah-Hartman
commit 1cd4fb3a325474a44b4451c2b19fc9f1f1ed630d
Author: Mathieu Desnoyers
Date: Wed Feb 17 11:56:51 2021 -0500
sched/membarrier: fix missing local execution of ipi\_sync\_rq\_state()
commit ce29ddc47b91f97e7f69a0fb7cbb5845f52a9825 upstream.
The function sync\_runqueues\_membarrier\_state() should copy the
membarrier state from the @mm received as parameter to each runqueue
currently running tasks using that mm.
However, the use of smp\_call\_function\_many() skips the current runqueue,
which is unintended. Replace by a call to on\_each\_cpu\_mask().
Fixes: 227a4aadc75b ("sched/membarrier: Fix p->mm->membarrier\_state racy load")
Reported-by: Nadav Amit
Signed-off-by: Mathieu Desnoyers
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Cc: stable@vger.kernel.org # 5.4.x+
Link: https://lore.kernel.org/r/74F1E842-4A84-47BF-B6C2-5407DFDD4A4A@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 5b4f39edf62bad6e59fd9083e92667edd74fb964
Author: Peter Zijlstra
Date: Sat Feb 13 13:10:35 2021 +0100
sched: Fix migration\_cpu\_stop() requeueing
commit 8a6edb5257e2a84720fe78cb179eca58ba76126f upstream.
When affine\_move\_task(p) is called on a running task @p, which is not
otherwise already changing affinity, we'll first set
p->migration\_pending and then do:
stop\_one\_cpu(cpu\_of\_rq(rq), migration\_cpu\_stop, &arg);
This then gets us to migration\_cpu\_stop() running on the CPU that was
previously running our victim task @p.
If we find that our task is no longer on that runqueue (this can
happen because of a concurrent migration due to load-balance etc.),
then we'll end up at the:
} else if (dest\_cpu < 1 || pending) {
branch. Which we'll take because we set pending earlier. Here we first
check if the task @p has already satisfied the affinity constraints,
if so we bail early [A]. Otherwise we'll reissue migration\_cpu\_stop()
onto the CPU that is now hosting our task @p:
stop\_one\_cpu\_nowait(cpu\_of(rq), migration\_cpu\_stop,
&pending->arg, &pending->stop\_work);
Except, we've never initialized pending->arg, which will be all 0s.
This then results in running migration\_cpu\_stop() on the next CPU with
arg->p == NULL, which gives the by now obvious result of fireworks.
The cure is to change affine\_move\_task() to always use pending->arg,
furthermore we can use the exact same pattern as the
SCA\_MIGRATE\_ENABLE case, since we'll block on the pending->done
completion anyway, no point in adding yet another completion in
stop\_one\_cpu().
This then gives a clear distinction between the two
migration\_cpu\_stop() use cases:
- sched\_exec() / migrate\_task\_to() : arg->pending == NULL
- affine\_move\_task() : arg->pending != NULL;
And we can have it ignore p->migration\_pending when !arg->pending. Any
stop work from sched\_exec() / migrate\_task\_to() is in addition to stop
works from affine\_move\_task(), which will be sufficient to issue the
completion.
Fixes: 6d337eab041d ("sched: Fix migrate\_disable() vs set\_cpus\_allowed\_ptr()")
Cc: stable@kernel.org
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Reviewed-by: Valentin Schneider
Link: https://lkml.kernel.org/r/20210224131355.357743989@infradead.org
Signed-off-by: Greg Kroah-Hartman
commit 10466d88b6b889bd868b276dc4af4ea935601781
Author: Arnd Bergmann
Date: Fri Mar 12 21:07:47 2021 -0800
linux/compiler-clang.h: define HAVE\_BUILTIN\_BSWAP\*
commit 97e4910232fa1f81e806aa60c25a0450276d99a2 upstream.
Separating compiler-clang.h from compiler-gcc.h inadventently dropped the
definitions of the three HAVE\_BUILTIN\_BSWAP macros, which requires falling
back to the open-coded version and hoping that the compiler detects it.
Since all versions of clang support the \_\_builtin\_bswap interfaces, add
back the flags and have the headers pick these up automatically.
This results in a 4% improvement of compilation speed for arm defconfig.
Note: it might also be worth revisiting which architectures set
CONFIG\_ARCH\_USE\_BUILTIN\_BSWAP for one compiler or the other, today this is
set on six architectures (arm32, csky, mips, powerpc, s390, x86), while
another ten architectures define custom helpers (alpha, arc, ia64, m68k,
mips, nios2, parisc, sh, sparc, xtensa), and the rest (arm64, h8300,
hexagon, microblaze, nds32, openrisc, riscv) just get the unoptimized
version and rely on the compiler to detect it.
A long time ago, the compiler builtins were architecture specific, but
nowadays, all compilers that are able to build the kernel have correct
implementations of them, though some may not be as optimized as the inline
asm versions.
The patch that dropped the optimization landed in v4.19, so as discussed
it would be fairly safe to backport this revert to stable kernels to the
4.19/5.4/5.10 stable kernels, but there is a remaining risk for
regressions, and it has no known side-effects besides compile speed.
Link: https://lkml.kernel.org/r/20210226161151.2629097-1-arnd@kernel.org
Link: https://lore.kernel.org/lkml/20210225164513.3667778-1-arnd@kernel.org/
Fixes: 815f0ddb346c ("include/linux/compiler\*.h: make compiler-\*.h mutually exclusive")
Signed-off-by: Arnd Bergmann
Reviewed-by: Nathan Chancellor
Reviewed-by: Kees Cook
Acked-by: Miguel Ojeda
Acked-by: Nick Desaulniers
Acked-by: Luc Van Oostenryck
Cc: Masahiro Yamada
Cc: Nick Hu
Cc: Greentime Hu
Cc: Vincent Chen
Cc: Paul Walmsley
Cc: Palmer Dabbelt
Cc: Albert Ou
Cc: Guo Ren
Cc: Randy Dunlap
Cc: Sami Tolvanen
Cc: Marco Elver
Cc: Arvind Sankar
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit db2d807997f3f80c5b4f3f9536e903f005aeaa17
Author: Minchan Kim
Date: Fri Mar 12 21:08:41 2021 -0800
zram: fix broken page writeback
commit 2766f1821600cc7562bae2128ad0b163f744c5d9 upstream.
commit 0d8359620d9b ("zram: support page writeback") introduced two
problems. It overwrites writeback\_store's return value as kstrtol's
return value, which makes return value zero so user could see zero as
return value of write syscall even though it wrote data successfully.
It also breaks index value in the loop in that it doesn't increase the
index any longer. It means it can write only first starting block index
so user couldn't write all idle pages in the zram so lose memory saving
chance.
This patch fixes those issues.
Link: https://lkml.kernel.org/r/20210312173949.2197662-2-minchan@kernel.org
Fixes: 0d8359620d9b("zram: support page writeback")
Signed-off-by: Minchan Kim
Reported-by: Amos Bianchi
Cc: Sergey Senozhatsky
Cc: John Dias
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 2eeb6948049a3164b5434d26d4f1116fdd9eb475
Author: Minchan Kim
Date: Fri Mar 12 21:08:38 2021 -0800
zram: fix return value on writeback\_store
commit 57e0076e6575a7b7cef620a0bd2ee2549ef77818 upstream.
writeback\_store's return value is overwritten by submit\_bio\_wait's return
value. Thus, writeback\_store will return zero since there was no IO
error. In the end, write syscall from userspace will see the zero as
return value, which could make the process stall to keep trying the write
until it will succeed.
Link: https://lkml.kernel.org/r/20210312173949.2197662-1-minchan@kernel.org
Fixes: 3b82a051c101("drivers/block/zram/zram\_drv.c: fix error return codes not being returned in writeback\_store")
Signed-off-by: Minchan Kim
Cc: Sergey Senozhatsky
Cc: Colin Ian King
Cc: John Dias
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 86a41a3b2ed7fda7e8641108c03bfc52cd07258b
Author: Matthew Wilcox (Oracle)
Date: Fri Mar 12 21:08:03 2021 -0800
include/linux/sched/mm.h: use rcu\_dereference in in\_vfork()
[ Upstream commit 149fc787353f65b7e72e05e7b75d34863266c3e2 ]
Fix a sparse warning by using rcu\_dereference(). Technically this is a
bug and a sufficiently aggressive compiler could reload the `real\_parent'
pointer outside the protection of the rcu lock (and access freed memory),
but I think it's pretty unlikely to happen.
Link: https://lkml.kernel.org/r/20210221194207.1351703-1-willy@infradead.org
Fixes: b18dc5f291c0 ("mm, oom: skip vforked tasks from being selected")
Signed-off-by: Matthew Wilcox (Oracle)
Reviewed-by: Miaohe Lin
Acked-by: Michal Hocko
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 17e14c8a01ca681d5afbd245081ff5b1c5fa26b4
Author: Arnd Bergmann
Date: Fri Mar 12 21:07:04 2021 -0800
stop\_machine: mark helpers \_\_always\_inline
[ Upstream commit cbf78d85079cee662c45749ef4f744d41be85d48 ]
With clang-13, some functions only get partially inlined, with a
specialized version referring to a global variable. This triggers a
harmless build-time check for the intel-rng driver:
WARNING: modpost: drivers/char/hw\_random/intel-rng.o(.text+0xe): Section mismatch in reference from the function stop\_machine() to the function .init.text:intel\_rng\_hw\_init()
The function stop\_machine() references
the function \_\_init intel\_rng\_hw\_init().
This is often because stop\_machine lacks a \_\_init
annotation or the annotation of intel\_rng\_hw\_init is wrong.
In this instance, an easy workaround is to force the stop\_machine()
function to be inline, along with related interfaces that did not show the
same behavior at the moment, but theoretically could.
The combination of the two patches listed below triggers the behavior in
clang-13, but individually these commits are correct.
Link: https://lkml.kernel.org/r/20210225130153.1956990-1-arnd@kernel.org
Fixes: fe5595c07400 ("stop\_machine: Provide stop\_machine\_cpuslocked()")
Fixes: ee527cd3a20c ("Use stop\_machine\_run in the Intel RNG driver")
Signed-off-by: Arnd Bergmann
Cc: Nathan Chancellor
Cc: Nick Desaulniers
Cc: Thomas Gleixner
Cc: Sebastian Andrzej Siewior
Cc: "Paul E. McKenney"
Cc: Ingo Molnar
Cc: Prarit Bhargava
Cc: Daniel Bristot de Oliveira
Cc: Peter Zijlstra
Cc: Valentin Schneider
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 2dacea74389c377152292abea55419c055d0c4e8
Author: Arnd Bergmann
Date: Fri Mar 12 21:07:01 2021 -0800
memblock: fix section mismatch warning
[ Upstream commit 34dc2efb39a231280fd6696a59bbe712bf3c5c4a ]
The inlining logic in clang-13 is rewritten to often not inline some
functions that were inlined by all earlier compilers.
In case of the memblock interfaces, this exposed a harmless bug of a
missing \_\_init annotation:
WARNING: modpost: vmlinux.o(.text+0x507c0a): Section mismatch in reference from the function memblock\_bottom\_up() to the variable .meminit.data:memblock
The function memblock\_bottom\_up() references
the variable \_\_meminitdata memblock.
This is often because memblock\_bottom\_up lacks a \_\_meminitdata
annotation or the annotation of memblock is wrong.
Interestingly, these annotations were present originally, but got removed
with the explanation that the \_\_init annotation prevents the function from
getting inlined. I checked this again and found that while this is the
case with clang, gcc (version 7 through 10, did not test others) does
inline the functions regardless.
As the previous change was apparently intended to help the clang builds,
reverting it to help the newer clang versions seems appropriate as well.
gcc builds don't seem to care either way.
Link: https://lkml.kernel.org/r/20210225133808.2188581-1-arnd@kernel.org
Fixes: 5bdba520c1b3 ("mm: memblock: drop \_\_init from memblock functions to make it inline")
Reference: 2cfb3665e864 ("include/linux/memblock.h: add \_\_init to memblock\_set\_bottom\_up()")
Signed-off-by: Arnd Bergmann
Reviewed-by: David Hildenbrand
Reviewed-by: Mike Rapoport
Cc: Nathan Chancellor
Cc: Nick Desaulniers
Cc: Faiyaz Mohammed
Cc: Baoquan He
Cc: Thomas Bogendoerfer
Cc: Aslan Bakirov
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit aee07c5595b53e2c196d5f352fb2dff3fba64431
Author: Peter Zijlstra
Date: Tue Mar 9 15:21:18 2021 +0100
seqlock,lockdep: Fix seqcount\_latch\_init()
[ Upstream commit 4817a52b306136c8b2b2271d8770401441e4cf79 ]
seqcount\_init() must be a macro in order to preserve the static
variable that is used for the lockdep key. Don't then wrap it in an
inline function, which destroys that.
Luckily there aren't many users of this function, but fix it before it
becomes a problem.
Fixes: 80793c3471d9 ("seqlock: Introduce seqcount\_latch\_t")
Reported-by: Eric Dumazet
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/YEeFEbNUVkZaXDp4@hirez.programming.kicks-ass.net
Signed-off-by: Sasha Levin
commit 87a2ad9d9bf82b2e493c690f6680b961a81c033a
Author: Daniel Axtens
Date: Thu Feb 25 14:09:59 2021 +1100
powerpc/64s/exception: Clean up a missed SRR specifier
[ Upstream commit c080a173301ffc62cb6c76308c803c7fee05517a ]
Nick's patch cleaning up the SRR specifiers in exception-64s.S missed
a single instance of EXC\_HV\_OR\_STD. Clean that up.
Caught by clang's integrated assembler.
Fixes: 3f7fbd97d07d ("powerpc/64s/exception: Clean up SRR specifiers")
Signed-off-by: Daniel Axtens
Acked-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210225031006.1204774-2-dja@axtens.net
Signed-off-by: Sasha Levin
commit 5e38bd7c7a1f158cb753dd5eee20520ed2069a4f
Author: Anna-Maria Behnsen
Date: Tue Feb 23 17:02:40 2021 +0100
hrtimer: Update softirq\_expires\_next correctly after \_\_hrtimer\_get\_next\_event()
[ Upstream commit 46eb1701c046cc18c032fa68f3c8ccbf24483ee4 ]
hrtimer\_force\_reprogram() and hrtimer\_interrupt() invokes
\_\_hrtimer\_get\_next\_event() to find the earliest expiry time of hrtimer
bases. \_\_hrtimer\_get\_next\_event() does not update
cpu\_base::[softirq\_]\_expires\_next to preserve reprogramming logic. That
needs to be done at the callsites.
hrtimer\_force\_reprogram() updates cpu\_base::softirq\_expires\_next only when
the first expiring timer is a softirq timer and the soft interrupt is not
activated. That's wrong because cpu\_base::softirq\_expires\_next is left
stale when the first expiring timer of all bases is a timer which expires
in hard interrupt context. hrtimer\_interrupt() does never update
cpu\_base::softirq\_expires\_next which is wrong too.
That becomes a problem when clock\_settime() sets CLOCK\_REALTIME forward and
the first soft expiring timer is in the CLOCK\_REALTIME\_SOFT base. Setting
CLOCK\_REALTIME forward moves the clock MONOTONIC based expiry time of that
timer before the stale cpu\_base::softirq\_expires\_next.
cpu\_base::softirq\_expires\_next is cached to make the check for raising the
soft interrupt fast. In the above case the soft interrupt won't be raised
until clock monotonic reaches the stale cpu\_base::softirq\_expires\_next
value. That's incorrect, but what's worse it that if the softirq timer
becomes the first expiring timer of all clock bases after the hard expiry
timer has been handled the reprogramming of the clockevent from
hrtimer\_interrupt() will result in an interrupt storm. That happens because
the reprogramming does not use cpu\_base::softirq\_expires\_next, it uses
\_\_hrtimer\_get\_next\_event() which returns the actual expiry time. Once clock
MONOTONIC reaches cpu\_base::softirq\_expires\_next the soft interrupt is
raised and the storm subsides.
Change the logic in hrtimer\_force\_reprogram() to evaluate the soft and hard
bases seperately, update softirq\_expires\_next and handle the case when a
soft expiring timer is the first of all bases by comparing the expiry times
and updating the required cpu base fields. Split this functionality into a
separate function to be able to use it in hrtimer\_interrupt() as well
without copy paste.
Fixes: 5da70160462e ("hrtimer: Implement support for softirq based hrtimers")
Reported-by: Mikael Beckius
Suggested-by: Thomas Gleixner
Tested-by: Mikael Beckius
Signed-off-by: Anna-Maria Behnsen
Signed-off-by: Thomas Gleixner
Signed-off-by: Ingo Molnar
Link: https://lore.kernel.org/r/20210223160240.27518-1-anna-maria@linutronix.de
Signed-off-by: Sasha Levin
commit 186d77e23a558070c144208b19974b0b4bad254b
Author: Kan Liang
Date: Mon Nov 30 11:38:41 2020 -0800
perf/x86/intel: Set PERF\_ATTACH\_SCHED\_CB for large PEBS and LBR
[ Upstream commit afbef30149587ad46f4780b1e0cc5e219745ce90 ]
To supply a PID/TID for large PEBS, it requires flushing the PEBS buffer
in a context switch.
For normal LBRs, a context switch can flip the address space and LBR
entries are not tagged with an identifier, we need to wipe the LBR, even
for per-cpu events.
For LBR callstack, save/restore the stack is required during a context
switch.
Set PERF\_ATTACH\_SCHED\_CB for the event with large PEBS & LBR.
Fixes: 9c964efa4330 ("perf/x86/intel: Drain the PEBS buffer during context switches")
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Link: https://lkml.kernel.org/r/20201130193842.10569-2-kan.liang@linux.intel.com
Signed-off-by: Sasha Levin
commit 1f89cb3cba5b423358f83cf3d2ef002be4193f7b
Author: Kan Liang
Date: Mon Nov 30 11:38:40 2020 -0800
perf/core: Flush PMU internal buffers for per-CPU events
[ Upstream commit a5398bffc01fe044848c5024e5e867e407f239b8 ]
Sometimes the PMU internal buffers have to be flushed for per-CPU events
during a context switch, e.g., large PEBS. Otherwise, the perf tool may
report samples in locations that do not belong to the process where the
samples are processed in, because PEBS does not tag samples with PID/TID.
The current code only flush the buffers for a per-task event. It doesn't
check a per-CPU event.
Add a new event state flag, PERF\_ATTACH\_SCHED\_CB, to indicate that the
PMU internal buffers have to be flushed for this event during a context
switch.
Add sched\_cb\_entry and perf\_sched\_cb\_usages back to track the PMU/cpuctx
which is required to be flushed.
Only need to invoke the sched\_task() for per-CPU events in this patch.
The per-task events have been handled in perf\_event\_context\_sched\_in/out
already.
Fixes: 9c964efa4330 ("perf/x86/intel: Drain the PEBS buffer during context switches")
Reported-by: Gabriel Marin
Originally-by: Namhyung Kim
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Ingo Molnar
Link: https://lkml.kernel.org/r/20201130193842.10569-1-kan.liang@linux.intel.com
Signed-off-by: Sasha Levin
commit a6757e81ba1b3702b89e7edc14059ea86a57bfc9
Author: Paolo Abeni
Date: Thu Mar 4 13:32:10 2021 -0800
mptcp: fix memory accounting on allocation error
[ Upstream commit eaeef1ce55ec9161e0c44ff27017777b1644b421 ]
In case of memory pressure the MPTCP xmit path keeps
at most a single skb in the tx cache, eventually freeing
additional ones.
The associated counter for forward memory is not update
accordingly, and that causes the following splat:
WARNING: CPU: 0 PID: 12 at net/core/stream.c:208 sk\_stream\_kill\_queues+0x3ca/0x530 net/core/stream.c:208
Modules linked in:
CPU: 0 PID: 12 Comm: kworker/0:1 Not tainted 5.11.0-rc2 #59
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: events mptcp\_worker
RIP: 0010:sk\_stream\_kill\_queues+0x3ca/0x530 net/core/stream.c:208
Code: 03 0f b6 04 02 84 c0 74 08 3c 03 0f 8e 63 01 00 00 8b ab 00 01 00 00 e9 60 ff ff ff e8 2f 24 d3 fe 0f 0b eb 97 e8 26 24 d3 fe <0f> 0b eb a0 e8 1d 24 d3 fe 0f 0b e9 a5 fe ff ff 4c 89 e7 e8 0e d0
RSP: 0018:ffffc900000c7bc8 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
RDX: ffff88810030ac40 RSI: ffffffff8262ca4a RDI: 0000000000000003
RBP: 0000000000000d00 R08: 0000000000000000 R09: ffffffff85095aa7
R10: ffffffff8262c9ea R11: 0000000000000001 R12: ffff888108908100
R13: ffffffff85095aa0 R14: ffffc900000c7c48 R15: 1ffff92000018f85
FS: 0000000000000000(0000) GS:ffff88811b200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fa7444baef8 CR3: 0000000035ee9005 CR4: 0000000000170ef0
Call Trace:
\_\_mptcp\_destroy\_sock+0x4a7/0x6c0 net/mptcp/protocol.c:2547
mptcp\_worker+0x7dd/0x1610 net/mptcp/protocol.c:2272
process\_one\_work+0x896/0x1170 kernel/workqueue.c:2275
worker\_thread+0x605/0x1350 kernel/workqueue.c:2421
kthread+0x344/0x410 kernel/kthread.c:292
ret\_from\_fork+0x22/0x30 arch/x86/entry/entry\_64.S:296
At close time, as reported by syzkaller/Christoph.
This change address the issue properly updating the fwd
allocated memory counter in the error path.
Reported-by: Christoph Paasch
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/136
Fixes: 724cfd2ee8aa ("mptcp: allocate TX skbs in msk context")
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cba9e678aafcdc879c5fc6222957f364acfe0010
Author: Florian Westphal
Date: Thu Mar 4 13:32:09 2021 -0800
mptcp: put subflow sock on connect error
[ Upstream commit f07157792c633b528de5fc1dbe2e4ea54f8e09d4 ]
mptcp\_add\_pending\_subflow() performs a sock\_hold() on the subflow,
then adds the subflow to the join list.
Without a sock\_put the subflow sk won't be freed in case connect() fails.
unreferenced object 0xffff88810c03b100 (size 3000):
[..]
sk\_prot\_alloc.isra.0+0x2f/0x110
sk\_alloc+0x5d/0xc20
inet6\_create+0x2b7/0xd30
\_\_sock\_create+0x17f/0x410
mptcp\_subflow\_create\_socket+0xff/0x9c0
\_\_mptcp\_subflow\_connect+0x1da/0xaf0
mptcp\_pm\_nl\_work+0x6e0/0x1120
mptcp\_worker+0x508/0x9a0
Fixes: 5b950ff4331ddda ("mptcp: link MPC subflow into msk only after accept")
Signed-off-by: Florian Westphal
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b9fc94c4f38405e5eefdad19da699af04bff63e9
Author: Willem de Bruijn
Date: Mon Mar 1 15:09:44 2021 +0000
net: expand textsearch ts\_state to fit skb\_seq\_state
[ Upstream commit b228c9b058760500fda5edb3134527f629fc2dc3 ]
The referenced commit expands the skb\_seq\_state used by
skb\_find\_text with a 4B frag\_off field, growing it to 48B.
This exceeds container ts\_state->cb, causing a stack corruption:
[ 73.238353] Kernel panic - not syncing: stack-protector: Kernel stack
is corrupted in: skb\_find\_text+0xc5/0xd0
[ 73.247384] CPU: 1 PID: 376 Comm: nping Not tainted 5.11.0+ #4
[ 73.252613] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),
BIOS 1.14.0-2 04/01/2014
[ 73.260078] Call Trace:
[ 73.264677] dump\_stack+0x57/0x6a
[ 73.267866] panic+0xf6/0x2b7
[ 73.270578] ? skb\_find\_text+0xc5/0xd0
[ 73.273964] \_\_stack\_chk\_fail+0x10/0x10
[ 73.277491] skb\_find\_text+0xc5/0xd0
[ 73.280727] string\_mt+0x1f/0x30
[ 73.283639] ipt\_do\_table+0x214/0x410
The struct is passed between skb\_find\_text and its callbacks
skb\_prepare\_seq\_read, skb\_seq\_read and skb\_abort\_seq read through
the textsearch interface using TS\_SKB\_CB.
I assumed that this mapped to skb->cb like other ..\_SKB\_CB wrappers.
skb->cb is 48B. But it maps to ts\_state->cb, which is only 40B.
skb->cb was increased from 40B to 48B after ts\_state was introduced,
in commit 3e3850e989c5 ("[NETFILTER]: Fix xfrm lookup in
ip\_route\_me\_harder/ip6\_route\_me\_harder").
Increase ts\_state.cb[] to 48 to fit the struct.
Also add a BUILD\_BUG\_ON to avoid a repeat.
The alternative is to directly add a dependency from textsearch onto
linux/skbuff.h, but I think the intent is textsearch to have no such
dependencies on its callers.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=211911
Fixes: 97550f6fa592 ("net: compound page support in skb\_seq\_read")
Reported-by: Kris Karas
Signed-off-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 828a2cf4bdfb01d4f37623561359cb697dfa0646
Author: Wei Yongjun
Date: Fri Mar 12 08:04:21 2021 +0000
perf/arm\_dmc620\_pmu: Fix error return code in dmc620\_pmu\_device\_probe()
[ Upstream commit c8e3866836528a4ba3b0535834f03768d74f7d8e ]
Fix to return negative error code -ENOMEM from the error handling
case instead of 0, as done elsewhere in this function.
Fixes: 53c218da220c ("driver/perf: Add PMU driver for the ARM DMC-620 memory controller")
Reported-by: Hulk Robot
Signed-off-by: Wei Yongjun
Link: https://lore.kernel.org/r/20210312080421.277562-1-weiyongjun1@huawei.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit aba4bdddaaca8df12876b78639c67f65f7cab870
Author: Dave Airlie
Date: Thu Mar 11 14:35:27 2021 +1000
drm/nouveau: fix dma syncing for loops (v2)
[ Upstream commit 4042160c2e5433e0759782c402292a90b5bf458d ]
The index variable should only be increased in one place.
Noticed this while trying to track down another oops.
v2: use while loop.
Fixes: f295c8cfec83 ("drm/nouveau: fix dma syncing warning with debugging on.")
Signed-off-by: Dave Airlie
Reviewed-by: Michael J. Ruhl
Signed-off-by: Dave Airlie
Link: https://patchwork.freedesktop.org/patch/msgid/20210311043527.5376-1-airlied@gmail.com
Signed-off-by: Sasha Levin
commit 33448e4e24d3ffe0d377ee24e78771e57047f904
Author: Jens Axboe
Date: Thu Mar 11 10:49:20 2021 -0700
io\_uring: perform IOPOLL reaping if canceler is thread itself
[ Upstream commit d052d1d685f5125249ab4ff887562c88ba959638 ]
We bypass IOPOLL completion polling (and reaping) for the SQPOLL thread,
but if it's the thread itself invoking cancelations, then we still need
to perform it or no one will.
Fixes: 9936c7c2bc76 ("io\_uring: deduplicate core cancellations sequence")
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit add3e42e5365ef6a177a7f091ad81657f807221e
Author: Ard Biesheuvel
Date: Wed Mar 10 18:15:11 2021 +0100
arm64: mm: use a 48-bit ID map when possible on 52-bit VA builds
[ Upstream commit 7ba8f2b2d652cd8d8a2ab61f4be66973e70f9f88 ]
52-bit VA kernels can run on hardware that is only 48-bit capable, but
configure the ID map as 52-bit by default. This was not a problem until
recently, because the special T0SZ value for a 52-bit VA space was never
programmed into the TCR register anwyay, and because a 52-bit ID map
happens to use the same number of translation levels as a 48-bit one.
This behavior was changed by commit 1401bef703a4 ("arm64: mm: Always update
TCR\_EL1 from \_\_cpu\_set\_tcr\_t0sz()"), which causes the unsupported T0SZ
value for a 52-bit VA to be programmed into TCR\_EL1. While some hardware
simply ignores this, Mark reports that Amberwing systems choke on this,
resulting in a broken boot. But even before that commit, the unsupported
idmap\_t0sz value was exposed to KVM and used to program TCR\_EL2 incorrectly
as well.
Given that we already have to deal with address spaces being either 48-bit
or 52-bit in size, the cleanest approach seems to be to simply default to
a 48-bit VA ID map, and only switch to a 52-bit one if the placement of the
kernel in DRAM requires it. This is guaranteed not to happen unless the
system is actually 52-bit VA capable.
Fixes: 90ec95cda91a ("arm64: mm: Introduce VA\_BITS\_MIN")
Reported-by: Mark Salter
Link: http://lore.kernel.org/r/20210310003216.410037-1-msalter@redhat.com
Signed-off-by: Ard Biesheuvel
Link: https://lore.kernel.org/r/20210310171515.416643-2-ardb@kernel.org
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 92204ad2df5460d8b43fb15b0c3111079e938455
Author: Daiyue Zhang
Date: Mon Mar 1 14:10:53 2021 +0800
configfs: fix a use-after-free in \_\_configfs\_open\_file
[ Upstream commit 14fbbc8297728e880070f7b077b3301a8c698ef9 ]
Commit b0841eefd969 ("configfs: provide exclusion between IO and removals")
uses ->frag\_dead to mark the fragment state, thus no bothering with extra
refcount on config\_item when opening a file. The configfs\_get\_config\_item
was removed in \_\_configfs\_open\_file, but not with config\_item\_put. So the
refcount on config\_item will lost its balance, causing use-after-free
issues in some occasions like this:
Test:
1. Mount configfs on /config with read-only items:
drwxrwx--- 289 root root 0 2021-04-01 11:55 /config
drwxr-xr-x 2 root root 0 2021-04-01 11:54 /config/a
--w--w--w- 1 root root 4096 2021-04-01 11:53 /config/a/1.txt
......
2. Then run:
for file in /config
do
echo $file
grep -R 'key' $file
done
3. \_\_configfs\_open\_file will be called in parallel, the first one
got called will do:
if (file->f\_mode & FMODE\_READ) {
if (!(inode->i\_mode & S\_IRUGO))
goto out\_put\_module;
config\_item\_put(buffer->item);
kref\_put()
package\_details\_release()
kfree()
the other one will run into use-after-free issues like this:
BUG: KASAN: use-after-free in \_\_configfs\_open\_file+0x1bc/0x3b0
Read of size 8 at addr fffffff155f02480 by task grep/13096
CPU: 0 PID: 13096 Comm: grep VIP: 00 Tainted: G W 4.14.116-kasan #1
TGID: 13096 Comm: grep
Call trace:
dump\_stack+0x118/0x160
kasan\_report+0x22c/0x294
\_\_asan\_load8+0x80/0x88
\_\_configfs\_open\_file+0x1bc/0x3b0
configfs\_open\_file+0x28/0x34
do\_dentry\_open+0x2cc/0x5c0
vfs\_open+0x80/0xe0
path\_openat+0xd8c/0x2988
do\_filp\_open+0x1c4/0x2fc
do\_sys\_open+0x23c/0x404
SyS\_openat+0x38/0x48
Allocated by task 2138:
kasan\_kmalloc+0xe0/0x1ac
kmem\_cache\_alloc\_trace+0x334/0x394
packages\_make\_item+0x4c/0x180
configfs\_mkdir+0x358/0x740
vfs\_mkdir2+0x1bc/0x2e8
SyS\_mkdirat+0x154/0x23c
el0\_svc\_naked+0x34/0x38
Freed by task 13096:
kasan\_slab\_free+0xb8/0x194
kfree+0x13c/0x910
package\_details\_release+0x524/0x56c
kref\_put+0xc4/0x104
config\_item\_put+0x24/0x34
\_\_configfs\_open\_file+0x35c/0x3b0
configfs\_open\_file+0x28/0x34
do\_dentry\_open+0x2cc/0x5c0
vfs\_open+0x80/0xe0
path\_openat+0xd8c/0x2988
do\_filp\_open+0x1c4/0x2fc
do\_sys\_open+0x23c/0x404
SyS\_openat+0x38/0x48
el0\_svc\_naked+0x34/0x38
To fix this issue, remove the config\_item\_put in
\_\_configfs\_open\_file to balance the refcount of config\_item.
Fixes: b0841eefd969 ("configfs: provide exclusion between IO and removals")
Signed-off-by: Daiyue Zhang
Signed-off-by: Yi Chen
Signed-off-by: Ge Qiu
Reviewed-by: Chao Yu
Acked-by: Al Viro
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 9460288cfc6912bde5bfa7138ebd68b84108881e
Author: James Smart
Date: Mon Mar 8 16:51:26 2021 -0800
nvme-fc: fix racing controller reset and create association
[ Upstream commit f20ef34d71abc1fc56b322aaa251f90f94320140 ]
Recent patch to prevent calling \_\_nvme\_fc\_abort\_outstanding\_ios in
interrupt context results in a possible race condition. A controller
reset results in errored io completions, which schedules error
work. The change of error work to a work element allows it to fire
after the ctrl state transition to NVME\_CTRL\_CONNECTING, causing
any outstanding io (used to initialize the controller) to fail and
cause problems for connect\_work.
Add a state check to only schedule error work if not in the RESETTING
state.
Fixes: 19fce0470f05 ("nvme-fc: avoid calling \_nvme\_fc\_abort\_outstanding\_ios from interrupt context")
Signed-off-by: Nigel Kirkland
Signed-off-by: James Smart
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 2652a763abf21c7932962de5f4545c0f33021dbc
Author: Anthony DeRossi
Date: Tue Mar 2 17:17:25 2021 -0800
drm/ttm: Fix TTM page pool accounting
[ Upstream commit ca63d76fd2319db984f2875992643f900caf2c72 ]
Freed pages are not subtracted from the allocated\_pages counter in
ttm\_pool\_type\_fini(), causing a leak in the count on device removal.
The next shrinker invocation loops forever trying to free pages that are
no longer in the pool:
rcu: INFO: rcu\_sched self-detected stall on CPU
rcu: 3-....: (9998 ticks this GP) idle=54e/1/0x4000000000000000 softirq=434857/434857 fqs=2237
(t=10001 jiffies g=2194533 q=49211)
NMI backtrace for cpu 3
CPU: 3 PID: 1034 Comm: kswapd0 Tainted: P O 5.11.0-com #1
Hardware name: System manufacturer System Product Name/PRIME X570-PRO, BIOS 1405 11/19/2019
Call Trace:
...

sysvec\_apic\_timer\_interrupt+0x77/0x80
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20
RIP: 0010:mutex\_unlock+0x16/0x20
Code: e7 48 8b 70 10 e8 7a 53 77 ff eb aa e8 43 6c ff ff 0f 1f 00 65 48 8b 14 25 00 6d 01 00 31 c9 48 89 d0 f0 48 0f b1 0f 48 39 c2 <74> 05 e9 e3 fe ff ff c3 66 90 48 8b 47 20 48 85 c0 74 0f 8b 50 10
RSP: 0018:ffffbdb840797be8 EFLAGS: 00000246
RAX: ffff9ff445a41c00 RBX: ffffffffc02a9ef8 RCX: 0000000000000000
RDX: ffff9ff445a41c00 RSI: ffffbdb840797c78 RDI: ffffffffc02a9ac0
RBP: 0000000000000080 R08: 0000000000000000 R09: ffffbdb840797c80
R10: 0000000000000000 R11: fffffffffffffff5 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000084 R15: ffffffffc02a9a60
ttm\_pool\_shrink+0x7d/0x90 [ttm]
ttm\_pool\_shrinker\_scan+0x5/0x20 [ttm]
do\_shrink\_slab+0x13a/0x1a0
...
debugfs shows the incorrect total:
$ cat /sys/kernel/debug/dri/0/ttm\_page\_pool
--- 0--- --- 1--- --- 2--- --- 3--- --- 4--- --- 5--- --- 6--- --- 7--- --- 8--- --- 9--- ---10---
wc : 0 0 0 0 0 0 0 0 0 0 0
uc : 0 0 0 0 0 0 0 0 0 0 0
wc 32 : 0 0 0 0 0 0 0 0 0 0 0
uc 32 : 0 0 0 0 0 0 0 0 0 0 0
DMA uc : 0 0 0 0 0 0 0 0 0 0 0
DMA wc : 0 0 0 0 0 0 0 0 0 0 0
DMA : 0 0 0 0 0 0 0 0 0 0 0
total : 3029 of 8244261
Using ttm\_pool\_type\_take() to remove pages from the pool before freeing
them correctly accounts for the freed pages.
Fixes: d099fc8f540a ("drm/ttm: new TT backend allocation pool v3")
Signed-off-by: Anthony DeRossi
Link: https://patchwork.freedesktop.org/patch/msgid/20210303011723.22512-1-ajderossi@gmail.com
Reviewed-by: Christian König
Signed-off-by: Christian König
Signed-off-by: Maarten Lankhorst
Signed-off-by: Sasha Levin
commit bfd2566889f3ea37584d39cb5903bba3475ba40e
Author: Jia-Ju Bai
Date: Tue Mar 9 19:30:17 2021 -0800
block: rsxx: fix error return code of rsxx\_pci\_probe()
[ Upstream commit df66617bfe87487190a60783d26175b65d2502ce ]
When create\_singlethread\_workqueue returns NULL to card->event\_wq, no
error return code of rsxx\_pci\_probe() is assigned.
To fix this bug, st is assigned with -ENOMEM in this case.
Fixes: 8722ff8cdbfa ("block: IBM RamSan 70/80 device driver")
Reported-by: TOTE Robot
Signed-off-by: Jia-Ju Bai
Link: https://lore.kernel.org/r/20210310033017.4023-1-baijiaju1990@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 07744d5bf4a6ef2287232c85755dd2f775cea042
Author: Ondrej Mosnacek
Date: Fri Jan 15 18:43:56 2021 +0100
NFSv4.2: fix return value of \_nfs4\_get\_security\_label()
[ Upstream commit 53cb245454df5b13d7063162afd7a785aed6ebf2 ]
An xattr 'get' handler is expected to return the length of the value on
success, yet \_nfs4\_get\_security\_label() (and consequently also
nfs4\_xattr\_get\_nfs4\_label(), which is used as an xattr handler) returns
just 0 on success.
Fix this by returning label.len instead, which contains the length of
the result.
Fixes: aa9c2669626c ("NFS: Client implementation of Labeled-NFS")
Signed-off-by: Ondrej Mosnacek
Reviewed-by: James Morris
Reviewed-by: Paul Moore
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 55b0c3d184ed597cafe977cac6548acef9ecfe73
Author: Trond Myklebust
Date: Mon Mar 8 14:42:52 2021 -0500
NFS: Don't gratuitously clear the inode cache when lookup failed
[ Upstream commit 47397915ede0192235474b145ebcd81b37b03624 ]
The fact that the lookup revalidation failed, does not mean that the
inode contents have changed.
Fixes: 5ceb9d7fdaaf ("NFS: Refactor nfs\_lookup\_revalidate()")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 594c1e4f69e97f97d6c5415f5adc5fd3667f95ad
Author: Trond Myklebust
Date: Mon Mar 8 14:42:51 2021 -0500
NFS: Don't revalidate the directory permissions on a lookup failure
[ Upstream commit 82e7ca1334ab16e2e04fafded1cab9dfcdc11b40 ]
There should be no reason to expect the directory permissions to change
just because the directory contents changed or a negative lookup timed
out. So let's avoid doing a full call to nfs\_mark\_for\_revalidate() in
that case.
Furthermore, if this is a negative dentry, and we haven't actually done
a new lookup, then we have no reason yet to believe the directory has
changed at all. So let's remove the gratuitous directory inode
invalidation altogether when called from
nfs\_lookup\_revalidate\_negative().
Reported-by: Geert Jansen
Fixes: 5ceb9d7fdaaf ("NFS: Refactor nfs\_lookup\_revalidate()")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit e1e4c4bb81d2b5205aff9ca3c308e32d545ea693
Author: Benjamin Coddington
Date: Wed Mar 3 08:47:16 2021 -0500
SUNRPC: Set memalloc\_nofs\_save() for sync tasks
[ Upstream commit f0940f4b3284a00f38a5d42e6067c2aaa20e1f2e ]
We could recurse into NFS doing memory reclaim while sending a sync task,
which might result in a deadlock. Set memalloc\_nofs\_save for sync task
execution.
Fixes: a1231fda7e94 ("SUNRPC: Set memalloc\_nofs\_save() on all rpciod/xprtiod jobs")
Signed-off-by: Benjamin Coddington
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 5f13849cf5eda8d84469580661be993ac4209aac
Author: Anshuman Khandual
Date: Fri Mar 5 10:54:57 2021 +0530
arm64/mm: Fix pfn\_valid() for ZONE\_DEVICE based memory
[ Upstream commit eeb0753ba27b26f609e61f9950b14f1b934fe429 ]
pfn\_valid() validates a pfn but basically it checks for a valid struct page
backing for that pfn. It should always return positive for memory ranges
backed with struct page mapping. But currently pfn\_valid() fails for all
ZONE\_DEVICE based memory types even though they have struct page mapping.
pfn\_valid() asserts that there is a memblock entry for a given pfn without
MEMBLOCK\_NOMAP flag being set. The problem with ZONE\_DEVICE based memory is
that they do not have memblock entries. Hence memblock\_is\_map\_memory() will
invariably fail via memblock\_search() for a ZONE\_DEVICE based address. This
eventually fails pfn\_valid() which is wrong. memblock\_is\_map\_memory() needs
to be skipped for such memory ranges. As ZONE\_DEVICE memory gets hotplugged
into the system via memremap\_pages() called from a driver, their respective
memory sections will not have SECTION\_IS\_EARLY set.
Normal hotplug memory will never have MEMBLOCK\_NOMAP set in their memblock
regions. Because the flag MEMBLOCK\_NOMAP was specifically designed and set
for firmware reserved memory regions. memblock\_is\_map\_memory() can just be
skipped as its always going to be positive and that will be an optimization
for the normal hotplug memory. Like ZONE\_DEVICE based memory, all normal
hotplugged memory too will not have SECTION\_IS\_EARLY set for their sections
Skipping memblock\_is\_map\_memory() for all non early memory sections would
fix pfn\_valid() problem for ZONE\_DEVICE based memory and also improve its
performance for normal hotplug memory as well.
Cc: Catalin Marinas
Cc: Will Deacon
Cc: Ard Biesheuvel
Cc: Robin Murphy
Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-kernel@vger.kernel.org
Acked-by: David Hildenbrand
Fixes: 73b20c84d42d ("arm64: mm: implement pte\_devmap support")
Signed-off-by: Anshuman Khandual
Acked-by: Catalin Marinas
Link: https://lore.kernel.org/r/1614921898-4099-2-git-send-email-anshuman.khandual@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 49e95245f113371a12a1a5fe81ada9a36426d91c
Author: Wei Yongjun
Date: Thu Mar 4 10:04:23 2021 +0000
cpufreq: qcom-hw: Fix return value check in qcom\_cpufreq\_hw\_cpu\_init()
[ Upstream commit 536eb97abeba857126ad055de5923fa592acef25 ]
In case of error, the function ioremap() returns NULL pointer
not ERR\_PTR(). The IS\_ERR() test in the return value check
should be replaced with NULL test.
Fixes: 67fc209b527d ("cpufreq: qcom-hw: drop devm\_xxx() calls from init/exit hooks")
Reported-by: Hulk Robot
Signed-off-by: Wei Yongjun
Acked-by: Shawn Guo
Signed-off-by: Viresh Kumar
Signed-off-by: Sasha Levin
commit e00dc812e45c3d9ea61ccbb83e739cd56d57bc7e
Author: Shawn Guo
Date: Sun Feb 28 09:33:19 2021 +0800
cpufreq: qcom-hw: fix dereferencing freed memory 'data'
[ Upstream commit 02fc409540303801994d076fcdb7064bd634dbf3 ]
Commit 67fc209b527d ("cpufreq: qcom-hw: drop devm\_xxx() calls from
init/exit hooks") introduces an issue of dereferencing freed memory
'data'. Fix it.
Fixes: 67fc209b527d ("cpufreq: qcom-hw: drop devm\_xxx() calls from init/exit hooks")
Reported-by: kernel test robot
Reported-by: Dan Carpenter
Signed-off-by: Shawn Guo
Signed-off-by: Viresh Kumar
Signed-off-by: Sasha Levin
commit a902066ac48ef381f14e49875c7797e4f43ac1eb
Author: Atish Patra
Date: Wed Mar 3 11:55:49 2021 -0800
net: macb: Add default usrio config to default gem config
[ Upstream commit b12422362ce947098ac420ac3c975fc006af4c02 ]
There is no usrio config defined for default gem config leading to
a kernel panic devices that don't define a data. This issue can be
reprdouced with microchip polar fire soc where compatible string
is defined as "cdns,macb".
Fixes: edac63861db7 ("add userio bits as platform configuration")
Signed-off-by: Atish Patra
Acked-by: Nicolas Ferre
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 98bac6bd42a7ab90576ad87dd80dfd37bf5945a5
Author: Jordan Niethe
Date: Thu Feb 25 14:19:46 2021 +1100
powerpc/sstep: Fix VSX instruction emulation
[ Upstream commit 5c88a17e15795226b56d83f579cbb9b7a4864f79 ]
Commit af99da74333b ("powerpc/sstep: Support VSX vector paired storage
access instructions") added loading and storing 32 word long data into
adjacent VSRs. However the calculation used to determine if two VSRs
needed to be loaded/stored inadvertently prevented the load/storing
taking place for instructions with a data length less than 16 words.
This causes the emulation to not function correctly, which can be seen
by the alignment\_handler selftest:
$ ./alignment\_handler
[snip]
test: test\_alignment\_handler\_vsx\_207
tags: git\_version:powerpc-5.12-1-0-g82d2c16b350f
VSX: 2.07B
Doing lxsspx: PASSED
Doing lxsiwax: FAILED: Wrong Data
Doing lxsiwzx: PASSED
Doing stxsspx: PASSED
Doing stxsiwx: PASSED
failure: test\_alignment\_handler\_vsx\_207
test: test\_alignment\_handler\_vsx\_300
tags: git\_version:powerpc-5.12-1-0-g82d2c16b350f
VSX: 3.00B
Doing lxsd: PASSED
Doing lxsibzx: PASSED
Doing lxsihzx: PASSED
Doing lxssp: FAILED: Wrong Data
Doing lxv: PASSED
Doing lxvb16x: PASSED
Doing lxvh8x: PASSED
Doing lxvx: PASSED
Doing lxvwsx: FAILED: Wrong Data
Doing lxvl: PASSED
Doing lxvll: PASSED
Doing stxsd: PASSED
Doing stxsibx: PASSED
Doing stxsihx: PASSED
Doing stxssp: PASSED
Doing stxv: PASSED
Doing stxvb16x: PASSED
Doing stxvh8x: PASSED
Doing stxvx: PASSED
Doing stxvl: PASSED
Doing stxvll: PASSED
failure: test\_alignment\_handler\_vsx\_300
[snip]
Fix this by making sure all VSX instruction emulation correctly
load/store from the VSRs.
Fixes: af99da74333b ("powerpc/sstep: Support VSX vector paired storage access instructions")
Signed-off-by: Jordan Niethe
Reviewed-by: Ravi Bangoria
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210225031946.1458206-1-jniethe5@gmail.com
Signed-off-by: Sasha Levin
commit c9dc6f49afb55e3b00458173ebce34f4799f1606
Author: Sergey Shtylyov
Date: Sun Feb 28 23:26:34 2021 +0300
sh\_eth: fix TRSCER mask for R7S72100
[ Upstream commit 75be7fb7f978202c4c3a1a713af4485afb2ff5f6 ]
According to the RZ/A1H Group, RZ/A1M Group User's Manual: Hardware,
Rev. 4.00, the TRSCER register has bit 9 reserved, hence we can't use
the driver's default TRSCER mask. Add the explicit initializer for
sh\_eth\_cpu\_data::trscer\_err\_mask for R7S72100.
Fixes: db893473d313 ("sh\_eth: Add support for r7s72100")
Signed-off-by: Sergey Shtylyov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7af661b1b62d5199500714cae16bd393c1bdd88a
Author: Ioana Ciornei
Date: Fri Feb 26 17:30:20 2021 +0200
net: phy: ti: take into account all possible interrupt sources
[ Upstream commit 73f476aa1975bae6a792b340f5b26ffcfba869a6 ]
The previous implementation of .handle\_interrupt() did not take into
account the fact that all the interrupt status registers should be
acknowledged since multiple interrupt sources could be asserted.
Fix this by reading all the status registers before exiting with
IRQ\_NONE or triggering the PHY state machine.
Fixes: 1d1ae3c6ca3f ("net: phy: ti: implement generic .handle\_interrupt() callback")
Reported-by: Sven Schuchmann
Signed-off-by: Ioana Ciornei
Link: https://lore.kernel.org/r/20210226153020.867852-1-ciorneiioana@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 48d541ef9b7d6d1256b2d0a1e86cfe641fedf4a2
Author: Ido Schimmel
Date: Thu Feb 25 18:57:21 2021 +0200
mlxsw: spectrum\_router: Ignore routes using a deleted nexthop object
[ Upstream commit dc860b88ce0a7ed9a048d5042cbb175daf60b657 ]
Routes are currently processed from a workqueue whereas nexthop objects
are processed in system call context. This can result in the driver not
finding a suitable nexthop group for a route and issuing a warning [1].
Fix this by ignoring such routes earlier in the process. The subsequent
deletion notification will be ignored as well.
[1]
WARNING: CPU: 2 PID: 7754 at drivers/net/ethernet/mellanox/mlxsw/spectrum\_router.c:4853 mlxsw\_sp\_router\_fib\_event\_work+0x1112/0x1e00 [mlxsw\_spectrum]
[...]
CPU: 2 PID: 7754 Comm: kworker/u8:0 Not tainted 5.11.0-rc6-cq-20210207-1 #16
Hardware name: Mellanox Technologies Ltd. MSN2100/SA001390, BIOS 5.6.5 05/24/2018
Workqueue: mlxsw\_core\_ordered mlxsw\_sp\_router\_fib\_event\_work [mlxsw\_spectrum]
RIP: 0010:mlxsw\_sp\_router\_fib\_event\_work+0x1112/0x1e00 [mlxsw\_spectrum]
Fixes: cdd6cfc54c64 ("mlxsw: spectrum\_router: Allow programming routes with nexthop objects")
Signed-off-by: Ido Schimmel
Reported-by: Alex Veber
Tested-by: Alex Veber
Reviewed-by: Petr Machata
Reviewed-by: Jiri Pirko
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 69eba6dfb351f9cb7df573d0b2a6a775a0a25903
Author: Ian Abbott
Date: Tue Feb 23 14:30:50 2021 +0000
staging: comedi: pcl818: Fix endian problem for AI command data
commit 148e34fd33d53740642db523724226de14ee5281 upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the call to
`comedi\_buf\_write\_samples()` is passing the address of a 32-bit integer
parameter. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the parameter
holding the sample value to `unsigned short`.
[Note: the bug was introduced in commit edf4537bcbf5 ("staging: comedi:
pcl818: use comedi\_buf\_write\_samples()") but the patch applies better to
commit d615416de615 ("staging: comedi: pcl818: introduce
pcl818\_ai\_write\_sample()").]
Fixes: d615416de615 ("staging: comedi: pcl818: introduce pcl818\_ai\_write\_sample()")
Cc:  # 4.0+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-10-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit bc446306e2bf4fc899a89265a9d72aa8fbddc771
Author: Ian Abbott
Date: Tue Feb 23 14:30:49 2021 +0000
staging: comedi: pcl711: Fix endian problem for AI command data
commit a084303a645896e834883f2c5170d044410dfdb3 upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the call to
`comedi\_buf\_write\_samples()` is passing the address of a 32-bit integer
variable. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the variable
holding the sample value to `unsigned short`.
Fixes: 1f44c034de2e ("staging: comedi: pcl711: use comedi\_buf\_write\_samples()")
Cc:  # 3.19+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-9-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit 61fd133419de153ce554a516ba7984315c4bdef7
Author: Ian Abbott
Date: Tue Feb 23 14:30:48 2021 +0000
staging: comedi: me4000: Fix endian problem for AI command data
commit b39dfcced399d31e7c4b7341693b18e01c8f655e upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the calls to
`comedi\_buf\_write\_samples()` are passing the address of a 32-bit integer
variable. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the variable
holding the sample value to `unsigned short`.
Fixes: de88924f67d1 ("staging: comedi: me4000: use comedi\_buf\_write\_samples()")
Cc:  # 3.19+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-8-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit ee81c14d867406fcb232aeb5490bfb997895a159
Author: Ian Abbott
Date: Tue Feb 23 14:30:47 2021 +0000
staging: comedi: dmm32at: Fix endian problem for AI command data
commit 54999c0d94b3c26625f896f8e3460bc029821578 upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the call to
`comedi\_buf\_write\_samples()` is passing the address of a 32-bit integer
variable. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the variable
holding the sample value to `unsigned short`.
[Note: the bug was introduced in commit 1700529b24cc ("staging: comedi:
dmm32at: use comedi\_buf\_write\_samples()") but the patch applies better
to the later (but in the same kernel release) commit 0c0eadadcbe6e
("staging: comedi: dmm32at: introduce dmm32\_ai\_get\_sample()").]
Fixes: 0c0eadadcbe6e ("staging: comedi: dmm32at: introduce dmm32\_ai\_get\_sample()")
Cc:  # 3.19+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-7-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit b4a6dc4a7611dd137c1f8f6752419777847c91f6
Author: Ian Abbott
Date: Tue Feb 23 14:30:46 2021 +0000
staging: comedi: das800: Fix endian problem for AI command data
commit 459b1e8c8fe97fcba0bd1b623471713dce2c5eaf upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the call to
`comedi\_buf\_write\_samples()` is passing the address of a 32-bit integer
variable. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the variable
holding the sample value to `unsigned short`.
Fixes: ad9eb43c93d8 ("staging: comedi: das800: use comedi\_buf\_write\_samples()")
Cc:  # 3.19+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-6-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit 82ecb3c446f74bedc23a43dec1850bd2f1276a03
Author: Ian Abbott
Date: Tue Feb 23 14:30:45 2021 +0000
staging: comedi: das6402: Fix endian problem for AI command data
commit 1c0f20b78781b9ca50dc3ecfd396d0db5b141890 upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the call to
`comedi\_buf\_write\_samples()` is passing the address of a 32-bit integer
variable. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the variable
holding the sample value to `unsigned short`.
Fixes: d1d24cb65ee3 ("staging: comedi: das6402: read analog input samples in interrupt handler")
Cc:  # 3.19+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-5-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit 62201ee024e35e17f08072966a2317e48a92fa4f
Author: Ian Abbott
Date: Tue Feb 23 14:30:44 2021 +0000
staging: comedi: adv\_pci1710: Fix endian problem for AI command data
commit b2e78630f733a76508b53ba680528ca39c890e82 upstream.
The analog input subdevice supports Comedi asynchronous commands that
use Comedi's 16-bit sample format. However, the calls to
`comedi\_buf\_write\_samples()` are passing the address of a 32-bit integer
variable. On bigendian machines, this will copy 2 bytes from the wrong
end of the 32-bit value. Fix it by changing the type of the variables
holding the sample value to `unsigned short`. The type of the `val`
parameter of `pci1710\_ai\_read\_sample()` is changed to `unsigned short \*`
accordingly. The type of the `val` variable in `pci1710\_ai\_insn\_read()`
is also changed to `unsigned short` since its address is passed to
`pci1710\_ai\_read\_sample()`.
Fixes: a9c3a015c12f ("staging: comedi: adv\_pci1710: use comedi\_buf\_write\_samples()")
Cc:  # 4.0+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-4-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit 26334ba6dd7f3fbe72c8a2f0f9eae425e320e383
Author: Ian Abbott
Date: Tue Feb 23 14:30:43 2021 +0000
staging: comedi: addi\_apci\_1500: Fix endian problem for command sample
commit ac0bbf55ed3be75fde1f8907e91ecd2fd589bde3 upstream.
The digital input subdevice supports Comedi asynchronous commands that
read interrupt status information. This uses 16-bit Comedi samples (of
which only the bottom 8 bits contain status information). However, the
interrupt handler is calling `comedi\_buf\_write\_samples()` with the
address of a 32-bit variable `unsigned int status`. On a bigendian
machine, this will copy 2 bytes from the wrong end of the variable. Fix
it by changing the type of the variable to `unsigned short`.
Fixes: a8c66b684efa ("staging: comedi: addi\_apci\_1500: rewrite the subdevice support functions")
Cc:  #4.0+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-3-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit cdca970941ce1c6d5ff8a65ccd818e7d2bbe0f04
Author: Ian Abbott
Date: Tue Feb 23 14:30:42 2021 +0000
staging: comedi: addi\_apci\_1032: Fix endian problem for COS sample
commit 25317f428a78fde71b2bf3f24d05850f08a73a52 upstream.
The Change-Of-State (COS) subdevice supports Comedi asynchronous
commands to read 16-bit change-of-state values. However, the interrupt
handler is calling `comedi\_buf\_write\_samples()` with the address of a
32-bit integer `&s->state`. On bigendian architectures, it will copy 2
bytes from the wrong end of the 32-bit integer. Fix it by transferring
the value via a 16-bit integer.
Fixes: 6bb45f2b0c86 ("staging: comedi: addi\_apci\_1032: use comedi\_buf\_write\_samples()")
Cc:  # 3.19+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20210223143055.257402-2-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
commit 3ff08f7339b7ca8d639fbc9d750a70a09684d62b
Author: Lee Gibson
Date: Fri Feb 26 14:51:57 2021 +0000
staging: rtl8192e: Fix possible buffer overflow in \_rtl92e\_wx\_set\_scan
commit 8687bf9ef9551bcf93897e33364d121667b1aadf upstream.
Function \_rtl92e\_wx\_set\_scan calls memcpy without checking the length.
A user could control that length and trigger a buffer overflow.
Fix by checking the length is within the maximum allowed size.
Reviewed-by: Dan Carpenter
Signed-off-by: Lee Gibson
Cc: stable
Link: https://lore.kernel.org/r/20210226145157.424065-1-leegib@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 1a1642a610394d27fb29255ab7e803b5b77b740c
Author: Lee Gibson
Date: Mon Mar 1 13:26:48 2021 +0000
staging: rtl8712: Fix possible buffer overflow in r8712\_sitesurvey\_cmd
commit b93c1e3981af19527beee1c10a2bef67a228c48c upstream.
Function r8712\_sitesurvey\_cmd calls memcpy without checking the length.
A user could control that length and trigger a buffer overflow.
Fix by checking the length is within the maximum allowed size.
Signed-off-by: Lee Gibson
Link: https://lore.kernel.org/r/20210301132648.420296-1-leegib@gmail.com
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 85bd010b4c03b3b920491e05ed7f4973f83c997a
Author: Dan Carpenter
Date: Tue Mar 2 14:19:39 2021 +0300
staging: ks7010: prevent buffer overflow in ks\_wlan\_set\_scan()
commit e163b9823a0b08c3bb8dc4f5b4b5c221c24ec3e5 upstream.
The user can specify a "req->essid\_len" of up to 255 but if it's
over IW\_ESSID\_MAX\_SIZE (32) that can lead to memory corruption.
Fixes: 13a9930d15b4 ("staging: ks7010: add driver from Nanonote extra-repository")
Signed-off-by: Dan Carpenter
Cc: stable
Link: https://lore.kernel.org/r/YD4fS8+HmM/Qmrw6@mwanda
Signed-off-by: Greg Kroah-Hartman
commit c21fccda627d18882237af01e3d73d8aea7db49b
Author: Dan Carpenter
Date: Fri Mar 5 11:56:32 2021 +0300
staging: rtl8188eu: fix potential memory corruption in rtw\_check\_beacon\_data()
commit d4ac640322b06095128a5c45ba4a1e80929fe7f3 upstream.
The "ie\_len" is a value in the 1-255 range that comes from the user. We
have to cap it to ensure that it's not too large or it could lead to
memory corruption.
Fixes: 9a7fe54ddc3a ("staging: r8188eu: Add source files for new driver - part 1")
Signed-off-by: Dan Carpenter
Cc: stable
Link: https://lore.kernel.org/r/YEHyQCrFZKTXyT7J@mwanda
Signed-off-by: Greg Kroah-Hartman
commit 6e90e2392f26d2eb6c0ee2a5b3621a2debd641a1
Author: Dan Carpenter
Date: Wed Feb 24 11:45:59 2021 +0300
staging: rtl8712: unterminated string leads to read overflow
commit d660f4f42ccea50262c6ee90c8e7ad19a69fb225 upstream.
The memdup\_user() function does not necessarily return a NUL terminated
string so this can lead to a read overflow. Switch from memdup\_user()
to strndup\_user() to fix this bug.
Fixes: c6dc001f2add ("staging: r8712u: Merging Realtek's latest (v2.6.6). Various fixes.")
Cc: stable
Signed-off-by: Dan Carpenter
Link: https://lore.kernel.org/r/YDYSR+1rj26NRhvb@mwanda
Signed-off-by: Greg Kroah-Hartman
commit 1cdd069f7080acf6370250853c1211890f4ff38f
Author: Dan Carpenter
Date: Fri Mar 5 11:58:03 2021 +0300
staging: rtl8188eu: prevent ->ssid overflow in rtw\_wx\_set\_scan()
commit 74b6b20df8cfe90ada777d621b54c32e69e27cd7 upstream.
This code has a check to prevent read overflow but it needs another
check to prevent writing beyond the end of the ->ssid[] array.
Fixes: a2c60d42d97c ("staging: r8188eu: Add files for new driver - part 16")
Signed-off-by: Dan Carpenter
Cc: stable
Link: https://lore.kernel.org/r/YEHymwsnHewzoam7@mwanda
Signed-off-by: Greg Kroah-Hartman
commit 952cf8b4b05b5343765e74ed38ed5950e1af1087
Author: Dan Carpenter
Date: Fri Mar 5 11:12:49 2021 +0300
staging: rtl8192u: fix ->ssid overflow in r8192\_wx\_set\_scan()
commit 87107518d7a93fec6cdb2559588862afeee800fb upstream.
We need to cap len at IW\_ESSID\_MAX\_SIZE (32) to avoid memory corruption.
This can be controlled by the user via the ioctl.
Fixes: 5f53d8ca3d5d ("Staging: add rtl8192SU wireless usb driver")
Signed-off-by: Dan Carpenter
Cc: stable
Link: https://lore.kernel.org/r/YEHoAWMOSZBUw91F@mwanda
Signed-off-by: Greg Kroah-Hartman
commit 2754ab0efc08a9ab6f50d4ad592967db37dd38cc
Author: Dmitry Baryshkov
Date: Fri Feb 12 22:26:58 2021 +0300
misc: fastrpc: restrict user apps from sending kernel RPC messages
commit 20c40794eb85ea29852d7bc37c55713802a543d6 upstream.
Verify that user applications are not using the kernel RPC message
handle to restrict them from directly attaching to guest OS on the
remote subsystem. This is a port of CVE-2019-2308 fix.
Fixes: c68cfb718c8f ("misc: fastrpc: Add support for context Invoke method")
Cc: Srinivas Kandagatla
Cc: Jonathan Marek
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20210212192658.3476137-1-dmitry.baryshkov@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 5d6496a8d31f2e5f9ff2ac02bd99e50ee97923e5
Author: Shile Zhang
Date: Thu Feb 18 20:31:16 2021 +0800
misc/pvpanic: Export module FDT device table
commit 65527a51c66f4edfa28602643d7dd4fa366eb826 upstream.
Export the module FDT device table to ensure the FDT compatible strings
are listed in the module alias. This help the pvpanic driver can be
loaded on boot automatically not only the ACPI device, but also the FDT
device.
Fixes: 46f934c9a12fc ("misc/pvpanic: add support to get pvpanic device info FDT")
Signed-off-by: Shile Zhang
Link: https://lore.kernel.org/r/20210218123116.207751-1-shile.zhang@linux.alibaba.com
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit ca67a57d517fedbcae2697935299676e643759a7
Author: Alexander Shiyan
Date: Wed Feb 17 11:06:08 2021 +0300
Revert "serial: max310x: rework RX interrupt handling"
commit 2334de198fed3da72e9785ecdd691d101aa96e77 upstream.
This reverts commit fce3c5c1a2d9cd888f2987662ce17c0c651916b2.
FIFO is triggered 4 intervals after receiving a byte, it's good
when we don't care about the time of reception, but are only
interested in the presence of any activity on the line.
Unfortunately, this method is not suitable for all tasks,
for example, the RS-485 protocol will not work properly,
since the state machine must track the request-response time
and after the timeout expires, a decision is made that the device
on the line is not responding.
Signed-off-by: Alexander Shiyan
Link: https://lore.kernel.org/r/20210217080608.31192-1-shc\_work@mail.ru
Fixes: fce3c5c1a2d9 ("serial: max310x: rework RX interrupt handling")
Cc: Thomas Petazzoni
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 15ab5e45f6c47e0a17ba69c9a1f666b54610fb24
Author: Shuah Khan
Date: Sun Mar 7 20:53:31 2021 -0700
usbip: fix vudc usbip\_sockfd\_store races leading to gpf
commit 46613c9dfa964c0c60b5385dbdf5aaa18be52a9c upstream.
usbip\_sockfd\_store() is invoked when user requests attach (import)
detach (unimport) usb gadget device from usbip host. vhci\_hcd sends
import request and usbip\_sockfd\_store() exports the device if it is
free for export.
Export and unexport are governed by local state and shared state
- Shared state (usbip device status, sockfd) - sockfd and Device
status are used to determine if stub should be brought up or shut
down. Device status is shared between host and client.
- Local state (tcp\_socket, rx and tx thread task\_struct ptrs)
A valid tcp\_socket controls rx and tx thread operations while the
device is in exported state.
- While the device is exported, device status is marked used and socket,
sockfd, and thread pointers are valid.
Export sequence (stub-up) includes validating the socket and creating
receive (rx) and transmit (tx) threads to talk to the client to provide
access to the exported device. rx and tx threads depends on local and
shared state to be correct and in sync.
Unexport (stub-down) sequence shuts the socket down and stops the rx and
tx threads. Stub-down sequence relies on local and shared states to be
in sync.
There are races in updating the local and shared status in the current
stub-up sequence resulting in crashes. These stem from starting rx and
tx threads before local and global state is updated correctly to be in
sync.
1. Doesn't handle kthread\_create() error and saves invalid ptr in local
state that drives rx and tx threads.
2. Updates tcp\_socket and sockfd, starts stub\_rx and stub\_tx threads
before updating usbip\_device status to SDEV\_ST\_USED. This opens up a
race condition between the threads and usbip\_sockfd\_store() stub up
and down handling.
Fix the above problems:
- Stop using kthread\_get\_run() macro to create/start threads.
- Create threads and get task struct reference.
- Add kthread\_create() failure handling and bail out.
- Hold usbip\_device lock to update local and shared states after
creating rx and tx threads.
- Update usbip\_device status to SDEV\_ST\_USED.
- Update usbip\_device tcp\_socket, sockfd, tcp\_rx, and tcp\_tx
- Start threads after usbip\_device (tcp\_socket, sockfd, tcp\_rx, tcp\_tx,
and status) is complete.
Credit goes to syzbot and Tetsuo Handa for finding and root-causing the
kthread\_get\_run() improper error handling problem and others. This is a
hard problem to find and debug since the races aren't seen in a normal
case. Fuzzing forces the race window to be small enough for the
kthread\_get\_run() error path bug and starting threads before updating the
local and shared state bug in the stub-up sequence.
Fixes: 9720b4bc76a83807 ("staging/usbip: convert to kthread")
Cc: stable@vger.kernel.org
Reported-by: syzbot
Reported-by: syzbot
Reported-by: syzbot
Reported-by: Tetsuo Handa
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/b1c08b983ffa185449c9f0f7d1021dc8c8454b60.1615171203.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit ff5d8d20368fc612f0c0dd44f5a94728877c2bd4
Author: Shuah Khan
Date: Sun Mar 7 20:53:30 2021 -0700
usbip: fix vhci\_hcd attach\_store() races leading to gpf
commit 718ad9693e3656120064b715fe931f43a6201e67 upstream.
attach\_store() is invoked when user requests import (attach) a device
from usbip host.
Attach and detach are governed by local state and shared state
- Shared state (usbip device status) - Device status is used to manage
the attach and detach operations on import-able devices.
- Local state (tcp\_socket, rx and tx thread task\_struct ptrs)
A valid tcp\_socket controls rx and tx thread operations while the
device is in exported state.
- Device has to be in the right state to be attached and detached.
Attach sequence includes validating the socket and creating receive (rx)
and transmit (tx) threads to talk to the host to get access to the
imported device. rx and tx threads depends on local and shared state to
be correct and in sync.
Detach sequence shuts the socket down and stops the rx and tx threads.
Detach sequence relies on local and shared states to be in sync.
There are races in updating the local and shared status in the current
attach sequence resulting in crashes. These stem from starting rx and
tx threads before local and global state is updated correctly to be in
sync.
1. Doesn't handle kthread\_create() error and saves invalid ptr in local
state that drives rx and tx threads.
2. Updates tcp\_socket and sockfd, starts stub\_rx and stub\_tx threads
before updating usbip\_device status to VDEV\_ST\_NOTASSIGNED. This opens
up a race condition between the threads, port connect, and detach
handling.
Fix the above problems:
- Stop using kthread\_get\_run() macro to create/start threads.
- Create threads and get task struct reference.
- Add kthread\_create() failure handling and bail out.
- Hold vhci and usbip\_device locks to update local and shared states after
creating rx and tx threads.
- Update usbip\_device status to VDEV\_ST\_NOTASSIGNED.
- Update usbip\_device tcp\_socket, sockfd, tcp\_rx, and tcp\_tx
- Start threads after usbip\_device (tcp\_socket, sockfd, tcp\_rx, tcp\_tx,
and status) is complete.
Credit goes to syzbot and Tetsuo Handa for finding and root-causing the
kthread\_get\_run() improper error handling problem and others. This is
hard problem to find and debug since the races aren't seen in a normal
case. Fuzzing forces the race window to be small enough for the
kthread\_get\_run() error path bug and starting threads before updating the
local and shared state bug in the attach sequence.
- Update usbip\_device tcp\_rx and tcp\_tx pointers holding vhci and
usbip\_device locks.
Tested with syzbot reproducer:
- https://syzkaller.appspot.com/text?tag=ReproC&x=14801034d00000
Fixes: 9720b4bc76a83807 ("staging/usbip: convert to kthread")
Cc: stable@vger.kernel.org
Reported-by: syzbot
Reported-by: syzbot
Reported-by: syzbot
Reported-by: Tetsuo Handa
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/bb434bd5d7a64fbec38b5ecfb838a6baef6eb12b.1615171203.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit f11d195b505d47d0442c59981efa41c47d0a8c9c
Author: Shuah Khan
Date: Sun Mar 7 20:53:29 2021 -0700
usbip: fix stub\_dev usbip\_sockfd\_store() races leading to gpf
commit 9380afd6df70e24eacbdbde33afc6a3950965d22 upstream.
usbip\_sockfd\_store() is invoked when user requests attach (import)
detach (unimport) usb device from usbip host. vhci\_hcd sends import
request and usbip\_sockfd\_store() exports the device if it is free
for export.
Export and unexport are governed by local state and shared state
- Shared state (usbip device status, sockfd) - sockfd and Device
status are used to determine if stub should be brought up or shut
down.
- Local state (tcp\_socket, rx and tx thread task\_struct ptrs)
A valid tcp\_socket controls rx and tx thread operations while the
device is in exported state.
- While the device is exported, device status is marked used and socket,
sockfd, and thread pointers are valid.
Export sequence (stub-up) includes validating the socket and creating
receive (rx) and transmit (tx) threads to talk to the client to provide
access to the exported device. rx and tx threads depends on local and
shared state to be correct and in sync.
Unexport (stub-down) sequence shuts the socket down and stops the rx and
tx threads. Stub-down sequence relies on local and shared states to be
in sync.
There are races in updating the local and shared status in the current
stub-up sequence resulting in crashes. These stem from starting rx and
tx threads before local and global state is updated correctly to be in
sync.
1. Doesn't handle kthread\_create() error and saves invalid ptr in local
state that drives rx and tx threads.
2. Updates tcp\_socket and sockfd, starts stub\_rx and stub\_tx threads
before updating usbip\_device status to SDEV\_ST\_USED. This opens up a
race condition between the threads and usbip\_sockfd\_store() stub up
and down handling.
Fix the above problems:
- Stop using kthread\_get\_run() macro to create/start threads.
- Create threads and get task struct reference.
- Add kthread\_create() failure handling and bail out.
- Hold usbip\_device lock to update local and shared states after
creating rx and tx threads.
- Update usbip\_device status to SDEV\_ST\_USED.
- Update usbip\_device tcp\_socket, sockfd, tcp\_rx, and tcp\_tx
- Start threads after usbip\_device (tcp\_socket, sockfd, tcp\_rx, tcp\_tx,
and status) is complete.
Credit goes to syzbot and Tetsuo Handa for finding and root-causing the
kthread\_get\_run() improper error handling problem and others. This is a
hard problem to find and debug since the races aren't seen in a normal
case. Fuzzing forces the race window to be small enough for the
kthread\_get\_run() error path bug and starting threads before updating the
local and shared state bug in the stub-up sequence.
Tested with syzbot reproducer:
- https://syzkaller.appspot.com/text?tag=ReproC&x=14801034d00000
Fixes: 9720b4bc76a83807 ("staging/usbip: convert to kthread")
Cc: stable@vger.kernel.org
Reported-by: syzbot
Reported-by: syzbot
Reported-by: syzbot
Reported-by: Tetsuo Handa
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/268a0668144d5ff36ec7d87fdfa90faf583b7ccc.1615171203.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit e0a3d7e8a8ffb16c0966ca9b9e4ae86c94d7b46c
Author: Shuah Khan
Date: Sun Mar 7 20:53:28 2021 -0700
usbip: fix vudc to check for stream socket
commit 6801854be94fe8819b3894979875ea31482f5658 upstream.
Fix usbip\_sockfd\_store() to validate the passed in file descriptor is
a stream socket. If the file descriptor passed was a SOCK\_DGRAM socket,
sock\_recvmsg() can't detect end of stream.
Cc: stable@vger.kernel.org
Suggested-by: Tetsuo Handa
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/387a670316002324113ac7ea1e8b53f4085d0c95.1615171203.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit d28f4c2c777315ad8700a9cc9b01a85e9befc0c1
Author: Shuah Khan
Date: Sun Mar 7 20:53:27 2021 -0700
usbip: fix vhci\_hcd to check for stream socket
commit f55a0571690c4aae03180e001522538c0927432f upstream.
Fix attach\_store() to validate the passed in file descriptor is a
stream socket. If the file descriptor passed was a SOCK\_DGRAM socket,
sock\_recvmsg() can't detect end of stream.
Cc: stable@vger.kernel.org
Suggested-by: Tetsuo Handa
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/52712aa308915bda02cece1589e04ee8b401d1f3.1615171203.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit 1652c100ca7279d084935b63ad105de11be4e77b
Author: Shuah Khan
Date: Sun Mar 7 20:53:26 2021 -0700
usbip: fix stub\_dev to check for stream socket
commit 47ccc8fc2c9c94558b27b6f9e2582df32d29e6e8 upstream.
Fix usbip\_sockfd\_store() to validate the passed in file descriptor is
a stream socket. If the file descriptor passed was a SOCK\_DGRAM socket,
sock\_recvmsg() can't detect end of stream.
Cc: stable@vger.kernel.org
Suggested-by: Tetsuo Handa
Signed-off-by: Shuah Khan
Link: https://lore.kernel.org/r/e942d2bd03afb8e8552bd2a5d84e18d17670d521.1615171203.git.skhan@linuxfoundation.org
Signed-off-by: Greg Kroah-Hartman
commit c5a43bffa0c7984f4155de26d64b58dfc13048c2
Author: Sebastian Reichel
Date: Tue Feb 23 17:44:18 2021 +0100
USB: serial: cp210x: add some more GE USB IDs
commit 42213a0190b535093a604945db05a4225bf43885 upstream.
GE CS1000 has some more custom USB IDs for CP2102N; add them
to the driver to have working auto-probing.
Signed-off-by: Sebastian Reichel
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b68e6af8997399489d4b7a69165d2edaa56c1e70
Author: Karan Singhal
Date: Tue Feb 16 11:03:10 2021 -0500
USB: serial: cp210x: add ID for Acuity Brands nLight Air Adapter
commit ca667a33207daeaf9c62b106815728718def60ec upstream.
IDs of nLight Air Adapter, Acuity Brands, Inc.:
vid: 10c4
pid: 88d8
Signed-off-by: Karan Singhal
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit e760989414bc1dffe610856e145345817cd70767
Author: Niv Sardi
Date: Mon Mar 1 17:16:12 2021 -0300
USB: serial: ch341: add new Product ID
commit 5563b3b6420362c8a1f468ca04afe6d5f0a8d0a3 upstream.
Add PID for CH340 that's found on cheap programmers.
The driver works flawlessly as soon as the new PID (0x9986) is added to it.
These look like ANU232MI but ship with a ch341 inside. They have no special
identifiers (mine only has the string "DB9D20130716" printed on the PCB and
nothing identifiable on the packaging. The merchant i bought it from
doesn't sell these anymore).
the lsusb -v output is:
Bus 001 Device 009: ID 9986:7523
Device Descriptor:
bLength 18
bDescriptorType 1
bcdUSB 1.10
bDeviceClass 255 Vendor Specific Class
bDeviceSubClass 0
bDeviceProtocol 0
bMaxPacketSize0 8
idVendor 0x9986
idProduct 0x7523
bcdDevice 2.54
iManufacturer 0
iProduct 0
iSerial 0
bNumConfigurations 1
Configuration Descriptor:
bLength 9
bDescriptorType 2
wTotalLength 0x0027
bNumInterfaces 1
bConfigurationValue 1
iConfiguration 0
bmAttributes 0x80
(Bus Powered)
MaxPower 96mA
Interface Descriptor:
bLength 9
bDescriptorType 4
bInterfaceNumber 0
bAlternateSetting 0
bNumEndpoints 3
bInterfaceClass 255 Vendor Specific Class
bInterfaceSubClass 1
bInterfaceProtocol 2
iInterface 0
Endpoint Descriptor:
bLength 7
bDescriptorType 5
bEndpointAddress 0x82 EP 2 IN
bmAttributes 2
Transfer Type Bulk
Synch Type None
Usage Type Data
wMaxPacketSize 0x0020 1x 32 bytes
bInterval 0
Endpoint Descriptor:
bLength 7
bDescriptorType 5
bEndpointAddress 0x02 EP 2 OUT
bmAttributes 2
Transfer Type Bulk
Synch Type None
Usage Type Data
wMaxPacketSize 0x0020 1x 32 bytes
bInterval 0
Endpoint Descriptor:
bLength 7
bDescriptorType 5
bEndpointAddress 0x81 EP 1 IN
bmAttributes 3
Transfer Type Interrupt
Synch Type None
Usage Type Data
wMaxPacketSize 0x0008 1x 8 bytes
bInterval 1
Signed-off-by: Niv Sardi
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 6b2876b831a950293f789b246082517122932c5f
Author: Pavel Skripkin
Date: Tue Mar 2 02:01:52 2021 +0300
USB: serial: io\_edgeport: fix memory leak in edge\_startup
commit cfdc67acc785e01a8719eeb7012709d245564701 upstream.
sysbot found memory leak in edge\_startup().
The problem was that when an error was received from the usb\_submit\_urb(),
nothing was cleaned up.
Reported-by: syzbot+59f777bdcbdd7eea5305@syzkaller.appspotmail.com
Signed-off-by: Pavel Skripkin
Fixes: 6e8cf7751f9f ("USB: add EPIC support to the io\_edgeport driver")
Cc: stable@vger.kernel.org # 2.6.21: c5c0c55598ce
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b4bea73a5df516a2befa4feae8b79e177e55c788
Author: Mathias Nyman
Date: Thu Mar 11 13:53:53 2021 +0200
xhci: Fix repeated xhci wake after suspend due to uncleared internal wake state
commit d26c00e7276fc92b18c253d69e872f6b03832bad upstream.
If port terminations are detected in suspend, but link never reaches U0
then xHCI may have an internal uncleared wake state that will cause an
immediate wake after suspend.
This wake state is normally cleared when driver clears the PORT\_CSC bit,
which is set after a device is enabled and in U0.
Write 1 to clear PORT\_CSC for ports that don't have anything connected
when suspending. This makes sure any pending internal wake states in
xHCI are cleared.
Cc: stable@vger.kernel.org
Tested-by: Mika Westerberg
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20210311115353.2137560-5-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 004caa19cb2e87c29a13209a0abb84d6dfab8052
Author: Forest Crossman
Date: Thu Mar 11 13:53:52 2021 +0200
usb: xhci: Fix ASMedia ASM1042A and ASM3242 DMA addressing
commit b71c669ad8390dd1c866298319ff89fe68b45653 upstream.
I've confirmed that both the ASMedia ASM1042A and ASM3242 have the same
problem as the ASM1142 and ASM2142/ASM3142, where they lose some of the
upper bits of 64-bit DMA addresses. As with the other chips, this can
cause problems on systems where the upper bits matter, and adding the
XHCI\_NO\_64BIT\_SUPPORT quirk completely fixes the issue.
Cc: stable@vger.kernel.org
Signed-off-by: Forest Crossman
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20210311115353.2137560-4-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 631ad31ea151ac5d4808ddfc8f8a4132f391390a
Author: Mathias Nyman
Date: Thu Mar 11 13:53:51 2021 +0200
xhci: Improve detection of device initiated wake signal.
commit 253f588c70f66184b1f3a9bbb428b49bbda73e80 upstream.
A xHC USB 3 port might miss the first wake signal from a USB 3 device
if the port LFPS reveiver isn't enabled fast enough after xHC resume.
xHC host will anyway be resumed by a PME# signal, but will go back to
suspend if no port activity is seen.
The device resends the U3 LFPS wake signal after a 100ms delay, but
by then host is already suspended, starting all over from the
beginning of this issue.
USB 3 specs say U3 wake LFPS signal is sent for max 10ms, then device
needs to delay 100ms before resending the wake.
Don't suspend immediately if port activity isn't detected in resume.
Instead add a retry. If there is no port activity then delay for 120ms,
and re-check for port activity.
Cc:
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20210311115353.2137560-3-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 8d7d6b4c2026c90bcd98e30cd20ac7853741c89a
Author: Stanislaw Gruszka
Date: Thu Mar 11 13:53:50 2021 +0200
usb: xhci: do not perform Soft Retry for some xHCI hosts
commit a4a251f8c23518899d2078c320cf9ce2fa459c9f upstream.
On some systems rt2800usb and mt7601u devices are unable to operate since
commit f8f80be501aa ("xhci: Use soft retry to recover faster from
transaction errors")
Seems that some xHCI controllers can not perform Soft Retry correctly,
affecting those devices.
To avoid the problem add xhci->quirks flag that restore pre soft retry
xhci behaviour for affected xHCI controllers. Currently those are
AMD\_PROMONTORYA\_4 and AMD\_PROMONTORYA\_2, since it was confirmed
by the users: on those xHCI hosts issue happen and is gone after
disabling Soft Retry.
[minor commit message rewording for checkpatch -Mathias]
Fixes: f8f80be501aa ("xhci: Use soft retry to recover faster from transaction errors")
Cc:  # 4.20+
Reported-by: Bernhard
Tested-by: Bernhard
Signed-off-by: Stanislaw Gruszka
Signed-off-by: Mathias Nyman
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=202541
Link: https://lore.kernel.org/r/20210311115353.2137560-2-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit a85d7eb852dbf466bba04b2142b76278be24e5ef
Author: Yoshihiro Shimoda
Date: Mon Mar 8 10:55:38 2021 +0900
usb: renesas\_usbhs: Clear PIPECFG for re-enabling pipe with other EPNUM
commit b1d25e6ee57c2605845595b6c61340d734253eb3 upstream.
According to the datasheet, this controller has a restriction
which "set an endpoint number so that combinations of the DIR bit and
the EPNUM bits do not overlap.". However, since the udc core driver is
possible to assign a bulk pipe as an interrupt endpoint, an endpoint
number may not match the pipe number. After that, when user rebinds
another gadget driver, this driver broke the restriction because
the driver didn't clear any configuration in usb\_ep\_disable().
Example:
# modprobe g\_ncm
Then, EP3 = pipe 3, EP4 = pipe 4, EP5 = pipe 6
# rmmod g\_ncm
# modprobe g\_hid
Then, EP3 = pipe 6, EP4 = pipe 7.
So, pipe 3 and pipe 6 are set as EP3.
So, clear PIPECFG register in usbhs\_pipe\_free().
Fixes: dfb87b8bfe09 ("usb: renesas\_usbhs: gadget: fix re-enabling pipe without re-connecting")
Cc: stable
Signed-off-by: Yoshihiro Shimoda
Link: https://lore.kernel.org/r/1615168538-26101-1-git-send-email-yoshihiro.shimoda.uh@renesas.com
Signed-off-by: Greg Kroah-Hartman
commit 63dd82c2aab04b0bfe8cce0ceb6e2134c4379527
Author: Pete Zaitcev
Date: Wed Mar 3 22:10:53 2021 -0600
USB: usblp: fix a hang in poll() if disconnected
commit 9de2c43acf37a17dc4c69ff78bb099b80fb74325 upstream.
Apparently an application that opens a device and calls select()
on it, will hang if the decice is disconnected. It's a little
surprising that we had this bug for 15 years, but apparently
nobody ever uses select() with a printer: only write() and read(),
and those work fine. Well, you can also select() with a timeout.
The fix is modeled after devio.c. A few other drivers check the
condition first, then do not add the wait queue in case the
device is disconnected. We doubt that's completely race-free.
So, this patch adds the process first, then locks properly
and checks for the disconnect.
Reviewed-by: Zqiang
Signed-off-by: Pete Zaitcev
Cc: stable
Link: https://lore.kernel.org/r/20210303221053.1cf3313e@suzdal.zaitcev.lan
Signed-off-by: Greg Kroah-Hartman
commit 851c74a266f9eefe9654474198cd7b84872695aa
Author: Matthias Kaehlcke
Date: Tue Mar 2 10:37:03 2021 -0800
usb: dwc3: qcom: Honor wakeup enabled/disabled state
commit 2664deb0930643149d61cddbb66ada527ae180bd upstream.
The dwc3-qcom currently enables wakeup interrupts unconditionally
when suspending, however this should not be done when wakeup is
disabled (e.g. through the sysfs attribute power/wakeup). Only
enable wakeup interrupts when device\_may\_wakeup() returns true.
Fixes: a4333c3a6ba9 ("usb: dwc3: Add Qualcomm DWC3 glue driver")
Reviewed-by: Bjorn Andersson
Signed-off-by: Matthias Kaehlcke
Cc: stable
Link: https://lore.kernel.org/r/20210302103659.v2.1.I44954d9e1169f2cf5c44e6454d357c75ddfa99a2@changeid
Signed-off-by: Greg Kroah-Hartman
commit f09baa292abc12638a0afe88980832be957075c9
Author: Shawn Guo
Date: Mon Mar 1 15:57:45 2021 +0800
usb: dwc3: qcom: add ACPI device id for sc8180x
commit 1edbff9c80ed32071fffa7dbaaea507fdb21ff2d upstream.
It enables USB Host support for sc8180x ACPI boot, both the standalone
one and the one behind URS (USB Role Switch). And they share the
the same dwc3\_acpi\_pdata with sdm845.
Signed-off-by: Shawn Guo
Link: https://lore.kernel.org/r/20210301075745.20544-1-shawn.guo@linaro.org
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 69d4cb11a8492786551b817a8278625add9921f4
Author: Shawn Guo
Date: Fri Jan 15 11:50:57 2021 +0800
usb: dwc3: qcom: add URS Host support for sdm845 ACPI boot
commit c25c210f590e7a37eecd865d84f97d1f40e39786 upstream.
For sdm845 ACPI boot, the URS (USB Role Switch) node in ACPI DSDT table
holds the memory resource, while interrupt resources reside in the child
nodes USB0 and UFN0. It adds USB0 host support by probing URS node,
creating platform device for USB0 node, and then retrieve interrupt
resources from USB0 platform device.
Reviewed-by: Bjorn Andersson
Signed-off-by: Shawn Guo
Link: https://lore.kernel.org/r/20210115035057.10994-1-shawn.guo@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 78a723baadfef8d3d2e52992b50f41fdd749dc1a
Author: Serge Semin
Date: Fri Feb 12 23:55:19 2021 +0300
usb: dwc3: qcom: Add missing DWC3 OF node refcount decrement
commit 1cffb1c66499a9db9a735473778abf8427d16287 upstream.
of\_get\_child\_by\_name() increments the reference counter of the OF node it
managed to find. So after the code is done using the device node, the
refcount must be decremented. Add missing of\_node\_put() invocation then
to the dwc3\_qcom\_of\_register\_core() method, since DWC3 OF node is being
used only there.
Fixes: a4333c3a6ba9 ("usb: dwc3: Add Qualcomm DWC3 glue driver")
Signed-off-by: Serge Semin
Link: https://lore.kernel.org/r/20210212205521.14280-1-Sergey.Semin@baikalelectronics.ru
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit ab20ef1ce0fc1149ef0695e62a09d1d0bd68fea9
Author: Ruslan Bilovol
Date: Mon Mar 1 13:49:32 2021 +0200
usb: gadget: f\_uac1: stop playback on function disable
commit cc2ac63d4cf72104e0e7f58bb846121f0f51bb19 upstream.
There is missing playback stop/cleanup in case of
gadget's ->disable callback that happens on
events like USB host resetting or gadget disconnection
Fixes: 0591bc236015 ("usb: gadget: add f\_uac1 variant based on a new u\_audio api")
Cc:  # 4.13+
Signed-off-by: Ruslan Bilovol
Link: https://lore.kernel.org/r/1614599375-8803-3-git-send-email-ruslan.bilovol@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 7c5ed451c8b373ff7963513cb43e584f01a49850
Author: Ruslan Bilovol
Date: Mon Mar 1 13:49:31 2021 +0200
usb: gadget: f\_uac2: always increase endpoint max\_packet\_size by one audio slot
commit 789ea77310f0200c84002884ffd628e2baf3ad8a upstream.
As per UAC2 Audio Data Formats spec (2.3.1.1 USB Packets),
if the sampling rate is a constant, the allowable variation
of number of audio slots per virtual frame is +/- 1 audio slot.
It means that endpoint should be able to accept/send +1 audio
slot.
Previous endpoint max\_packet\_size calculation code
was adding sometimes +1 audio slot due to DIV\_ROUND\_UP
behaviour which was rounding up to closest integer.
However this doesn't work if the numbers are divisible.
It had no any impact with Linux hosts which ignore
this issue, but in case of more strict Windows it
caused rejected enumeration
Thus always add +1 audio slot to endpoint's max packet size
Fixes: 913e4a90b6f9 ("usb: gadget: f\_uac2: finalize wMaxPacketSize according to bandwidth")
Cc: Peter Chen
Cc:  #v4.3+
Signed-off-by: Ruslan Bilovol
Link: https://lore.kernel.org/r/1614599375-8803-2-git-send-email-ruslan.bilovol@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 7d2fb64881e4a80051c6067c0eb3626fdac3fc67
Author: Dan Carpenter
Date: Mon Feb 15 15:57:16 2021 +0000
USB: gadget: u\_ether: Fix a configfs return code
commit 650bf52208d804ad5ee449c58102f8dc43175573 upstream.
If the string is invalid, this should return -EINVAL instead of 0.
Fixes: 73517cf49bd4 ("usb: gadget: add RNDIS configfs options for class/subclass/protocol")
Cc: stable
Acked-by: Lorenzo Colitti
Signed-off-by: Dan Carpenter
Link: https://lore.kernel.org/r/YCqZ3P53yyIg5cn7@mwanda
Signed-off-by: Greg Kroah-Hartman
commit 8cbbe286dfa01f695a46267cb6293cc844fc7580
Author: Wei Yongjun
Date: Fri Mar 5 03:49:27 2021 +0000
USB: gadget: udc: s3c2410\_udc: fix return value check in s3c2410\_udc\_probe()
commit 414c20df7d401bcf1cb6c13d2dd944fb53ae4acf upstream.
In case of error, the function devm\_platform\_ioremap\_resource()
returns ERR\_PTR() and never returns NULL. The NULL test in the
return value check should be replaced with IS\_ERR().
Fixes: 188db4435ac6 ("usb: gadget: s3c: use platform resources")
Cc: stable
Reported-by: Hulk Robot
Reviewed-by: Arnd Bergmann
Reviewed-by: Krzysztof Kozlowski
Signed-off-by: Wei Yongjun
Link: https://lore.kernel.org/r/20210305034927.3232386-1-weiyongjun1@huawei.com
Signed-off-by: Greg Kroah-Hartman
commit 12957e93a041191ce3f3ba807c09c65d538b61eb
Author: Yorick de Wid
Date: Sat Feb 13 15:49:02 2021 +0100
Goodix Fingerprint device is not a modem
commit 4d8654e81db7346f915eca9f1aff18f385cab621 upstream.
The CDC ACM driver is false matching the Goodix Fingerprint device
against the USB\_CDC\_ACM\_PROTO\_AT\_V25TER.
The Goodix Fingerprint device is a biometrics sensor that should be
handled in user-space. libfprint has some support for Goodix
fingerprint sensors, although not for this particular one. It is
possible that the vendor allocates a PID per OEM (Lenovo, Dell etc).
If this happens to be the case then more devices from the same vendor
could potentially match the ACM modem module table.
Signed-off-by: Yorick de Wid
Cc: stable
Link: https://lore.kernel.org/r/20210213144901.53199-1-ydewid@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 836238c6998b08cc8b5c3f6748056ec965eaa02f
Author: Paulo Alcantara
Date: Mon Mar 8 12:00:50 2021 -0300
cifs: do not send close in compound create+close requests
commit 04ad69c342fc4de5bd23be9ef15ea7574fb1a87e upstream.
In case of interrupted syscalls, prevent sending CLOSE commands for
compound CREATE+CLOSE requests by introducing an
CIFS\_CP\_CREATE\_CLOSE\_OP flag to indicate lower layers that it should
not send a CLOSE command to the MIDs corresponding the compound
CREATE+CLOSE request.
A simple reproducer:
#!/bin/bash
mount //server/share /mnt -o username=foo,password=\*\*\*
tc qdisc add dev eth0 root netem delay 450ms
stat -f /mnt &>/dev/null & pid=$!
sleep 0.01
kill $pid
tc qdisc del dev eth0 root
umount /mnt
Before patch:
...
6 0.256893470 192.168.122.2 → 192.168.122.15 SMB2 402 Create Request File: ;GetInfo Request FS\_INFO/FileFsFullSizeInformation;Close Request
7 0.257144491 192.168.122.15 → 192.168.122.2 SMB2 498 Create Response File: ;GetInfo Response;Close Response
9 0.260798209 192.168.122.2 → 192.168.122.15 SMB2 146 Close Request File:
10 0.260841089 192.168.122.15 → 192.168.122.2 SMB2 130 Close Response, Error: STATUS\_FILE\_CLOSED
Signed-off-by: Paulo Alcantara (SUSE)
Reviewed-by: Ronnie Sahlberg
Reviewed-by: Aurelien Aptel
CC:
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 431e53d76189eb191656cd9aed0b33b931c13e2b
Author: Frank Li
Date: Wed Mar 3 11:42:48 2021 -0600
mmc: cqhci: Fix random crash when remove mmc module/card
commit f06391c45e83f9a731045deb23df7cc3814fd795 upstream.
[ 6684.493350] Unable to handle kernel paging request at virtual address ffff800011c5b0f0
[ 6684.498531] mmc0: card 0001 removed
[ 6684.501556] Mem abort info:
[ 6684.509681] ESR = 0x96000047
[ 6684.512786] EC = 0x25: DABT (current EL), IL = 32 bits
[ 6684.518394] SET = 0, FnV = 0
[ 6684.521707] EA = 0, S1PTW = 0
[ 6684.524998] Data abort info:
[ 6684.528236] ISV = 0, ISS = 0x00000047
[ 6684.532986] CM = 0, WnR = 1
[ 6684.536129] swapper pgtable: 4k pages, 48-bit VAs, pgdp=0000000081b22000
[ 6684.543923] [ffff800011c5b0f0] pgd=00000000bffff003, p4d=00000000bffff003, pud=00000000bfffe003, pmd=00000000900e1003, pte=0000000000000000
[ 6684.557915] Internal error: Oops: 96000047 [#1] PREEMPT SMP
[ 6684.564240] Modules linked in: sdhci\_esdhc\_imx(-) sdhci\_pltfm sdhci cqhci mmc\_block mmc\_core fsl\_jr\_uio caam\_jr caamkeyblob\_desc caamhash\_desc caamalg\_desc crypto\_engine rng\_core authenc libdes crct10dif\_ce flexcan can\_dev caam error [last unloaded: mmc\_core]
[ 6684.587281] CPU: 0 PID: 79138 Comm: kworker/0:3H Not tainted 5.10.9-01410-g3ba33182767b-dirty #10
[ 6684.596160] Hardware name: Freescale i.MX8DXL EVK (DT)
[ 6684.601320] Workqueue: kblockd blk\_mq\_run\_work\_fn
[ 6684.606094] pstate: 40000005 (nZcv daif -PAN -UAO -TCO BTYPE=--)
[ 6684.612286] pc : cqhci\_request+0x148/0x4e8 [cqhci]
^GMessage from syslogd@ at Thu Jan 1 01:51:24 1970 ...[ 6684.617085] lr : cqhci\_request+0x314/0x4e8 [cqhci]
[ 6684.626734] sp : ffff80001243b9f0
[ 6684.630049] x29: ffff80001243b9f0 x28: ffff00002c3dd000
[ 6684.635367] x27: 0000000000000001 x26: 0000000000000001
[ 6684.640690] x25: ffff00002c451000 x24: 000000000000000f
[ 6684.646007] x23: ffff000017e71c80 x22: ffff00002c451000
[ 6684.651326] x21: ffff00002c0f3550 x20: ffff00002c0f3550
[ 6684.656651] x19: ffff000017d46880 x18: ffff00002cea1500
[ 6684.661977] x17: 0000000000000000 x16: 0000000000000000
[ 6684.667294] x15: 000001ee628e3ed1 x14: 0000000000000278
[ 6684.672610] x13: 0000000000000001 x12: 0000000000000001
[ 6684.677927] x11: 0000000000000000 x10: 0000000000000000
[ 6684.683243] x9 : 000000000000002b x8 : 0000000000001000
[ 6684.688560] x7 : 0000000000000010 x6 : ffff00002c0f3678
[ 6684.693886] x5 : 000000000000000f x4 : ffff800011c5b000
[ 6684.699211] x3 : 000000000002d988 x2 : 0000000000000008
[ 6684.704537] x1 : 00000000000000f0 x0 : 0002d9880008102f
[ 6684.709854] Call trace:
[ 6684.712313] cqhci\_request+0x148/0x4e8 [cqhci]
[ 6684.716803] mmc\_cqe\_start\_req+0x58/0x68 [mmc\_core]
[ 6684.721698] mmc\_blk\_mq\_issue\_rq+0x460/0x810 [mmc\_block]
[ 6684.727018] mmc\_mq\_queue\_rq+0x118/0x2b0 [mmc\_block]
The problem occurs when cqhci\_request() get called after cqhci\_disable() as
it leads to access of allocated memory that has already been freed. Let's
fix the problem by calling cqhci\_disable() a bit later in the remove path.
Signed-off-by: Frank Li
Diagnosed-by: Adrian Hunter
Acked-by: Adrian Hunter
Link: https://lore.kernel.org/r/20210303174248.542175-1-Frank.Li@nxp.com
Fixes: f690f4409ddd ("mmc: mmc: Enable CQE's")
Cc: stable@vger.kernel.org
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 8ec6ff65208ae035a109e5d0dd044647d4ec3560
Author: Adrian Hunter
Date: Wed Mar 3 11:26:14 2021 +0200
mmc: core: Fix partition switch time for eMMC
commit 66fbacccbab91e6e55d9c8f1fc0910a8eb6c81f7 upstream.
Avoid the following warning by always defining partition switch time:
[ 3.209874] mmc1: unspecified timeout for CMD6 - use generic
[ 3.222780] ------------[ cut here ]------------
[ 3.233363] WARNING: CPU: 1 PID: 111 at drivers/mmc/core/mmc\_ops.c:575 \_\_mmc\_switch+0x200/0x204
Reported-by: Paul Fertser
Fixes: 1c447116d017 ("mmc: mmc: Fix partition switch timeout for some eMMCs")
Signed-off-by: Adrian Hunter
Link: https://lore.kernel.org/r/168bbfd6-0c5b-5ace-ab41-402e7937c46e@intel.com
Cc: stable@vger.kernel.org
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit fd3dac97eb4e524210df93b617e2edbdf749c15f
Author: Yann Gautier
Date: Thu Feb 25 15:54:54 2021 +0100
mmc: mmci: Add MMC\_CAP\_NEED\_RSP\_BUSY for the stm32 variants
commit 774514bf977377c9137640a0310bd64eed0f7323 upstream.
An issue has been observed on STM32MP157C-EV1 board, with an erase command
with secure erase argument, ending up waiting for ~4 hours before timeout.
The requested busy timeout from the mmc core ends up with 14784000ms (~4
hours), but the supported host->max\_busy\_timeout is 86767ms, which leads to
that the core switch to use an R1 response in favor of the R1B and polls
for busy with the host->card\_busy() ops. In this case the polling doesn't
work as expected, as we never detects that the card stops signaling busy,
which leads to the following message:
mmc1: Card stuck being busy! \_\_mmc\_poll\_for\_busy
The problem boils done to that the stm32 variants can't use R1 responses in
favor of R1B responses, as it leads to an internal state machine in the
controller to get stuck. To continue to process requests, it would need to
be reset.
To fix this problem, let's set MMC\_CAP\_NEED\_RSP\_BUSY for the stm32 variant,
which prevent the mmc core from switching to R1 responses. Additionally,
let's cap the cmd->busy\_timeout to the host->max\_busy\_timeout, thus rely on
86767ms to be sufficient (~66 seconds was need for this test case).
Fixes: 94fe2580a2f3 ("mmc: core: Enable erase/discard/trim support for all mmc hosts")
Signed-off-by: Yann Gautier
Link: https://lore.kernel.org/r/20210225145454.12780-1-yann.gautier@foss.st.com
Cc: stable@vger.kernel.org
[Ulf: Simplified the code and extended the commit message]
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit d4029cc53b7ac801008087df250f007fad54f07e
Author: Juergen Gross
Date: Sat Mar 6 17:18:33 2021 +0100
xen/events: avoid handling the same event on two cpus at the same time
commit b6622798bc50b625a1e62f82c7190df40c1f5b21 upstream.
When changing the cpu affinity of an event it can happen today that
(with some unlucky timing) the same event will be handled on the old
and the new cpu at the same time.
Avoid that by adding an "event active" flag to the per-event data and
call the handler only if this flag isn't set.
Cc: stable@vger.kernel.org
Reported-by: Julien Grall
Signed-off-by: Juergen Gross
Reviewed-by: Julien Grall
Link: https://lore.kernel.org/r/20210306161833.4552-4-jgross@suse.com
Signed-off-by: Boris Ostrovsky
Signed-off-by: Greg Kroah-Hartman
commit fad86da87b35bfae1f0365e1a536151e276fb0ce
Author: Juergen Gross
Date: Sat Mar 6 17:18:32 2021 +0100
xen/events: don't unmask an event channel when an eoi is pending
commit 25da4618af240fbec6112401498301a6f2bc9702 upstream.
An event channel should be kept masked when an eoi is pending for it.
When being migrated to another cpu it might be unmasked, though.
In order to avoid this keep three different flags for each event channel
to be able to distinguish "normal" masking/unmasking from eoi related
masking/unmasking and temporary masking. The event channel should only
be able to generate an interrupt if all flags are cleared.
Cc: stable@vger.kernel.org
Fixes: 54c9de89895e ("xen/events: add a new "late EOI" evtchn framework")
Reported-by: Julien Grall
Signed-off-by: Juergen Gross
Reviewed-by: Julien Grall
Reviewed-by: Boris Ostrovsky
Tested-by: Ross Lagerwall
Link: https://lore.kernel.org/r/20210306161833.4552-3-jgross@suse.com
Signed-off-by: Greg Kroah-Hartman
[boris -- corrected Fixed tag format]
Signed-off-by: Boris Ostrovsky
commit 37f4ed2941d6652e75cb5d10c59246ad80c1c0b6
Author: Juergen Gross
Date: Sat Mar 6 17:18:31 2021 +0100
xen/events: reset affinity of 2-level event when tearing it down
commit 9e77d96b8e2724ed00380189f7b0ded61113b39f upstream.
When creating a new event channel with 2-level events the affinity
needs to be reset initially in order to avoid using an old affinity
from earlier usage of the event channel port. So when tearing an event
channel down reset all affinity bits.
The same applies to the affinity when onlining a vcpu: all old
affinity settings for this vcpu must be reset. As percpu events get
initialized before the percpu event channel hook is called,
resetting of the affinities happens after offlining a vcpu (this is
working, as initial percpu memory is zeroed out).
Cc: stable@vger.kernel.org
Reported-by: Julien Grall
Signed-off-by: Juergen Gross
Reviewed-by: Julien Grall
Link: https://lore.kernel.org/r/20210306161833.4552-2-jgross@suse.com
Signed-off-by: Boris Ostrovsky
Signed-off-by: Greg Kroah-Hartman
commit 2874b3cf9c762437889ad7465545a966e755692b
Author: Heikki Krogerus
Date: Mon Mar 1 17:30:11 2021 +0300
software node: Fix node registration
commit 8891123f9cbb9c1ee531e5a87fa116f0af685c48 upstream.
Software node can not be registered before its parent.
Fixes: 80488a6b1d3c ("software node: Add support for static node descriptors")
Cc: 5.10+  # 5.10+
Signed-off-by: Heikki Krogerus
Reviewed-by: Andy Shevchenko
Tested-by: Andy Shevchenko
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 7e2f266995531d7fa20dd3911330db0975e1a261
Author: Stefan Haberland
Date: Fri Mar 5 13:54:39 2021 +0100
s390/dasd: fix hanging IO request during DASD driver unbind
commit 66f669a272898feb1c69b770e1504aa2ec7723d1 upstream.
Prevent that an IO request is build during device shutdown initiated by
a driver unbind. This request will never be able to be processed or
canceled and will hang forever. This will lead also to a hanging unbind.
Fix by checking not only if the device is in READY state but also check
that there is no device offline initiated before building a new IO request.
Fixes: e443343e509a ("s390/dasd: blk-mq conversion")
Cc:  # v4.14+
Signed-off-by: Stefan Haberland
Tested-by: Bjoern Walk
Reviewed-by: Jan Hoeppner
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 471fd26dccd7566fbc16b55f2c0e5c2550665356
Author: Stefan Haberland
Date: Fri Mar 5 13:54:38 2021 +0100
s390/dasd: fix hanging DASD driver unbind
commit 7d365bd0bff3c0310c39ebaffc9a8458e036d666 upstream.
In case of an unbind of the DASD device driver the function
dasd\_generic\_remove() is called which shuts down the device.
Among others this functions removes the int\_handler from the cdev.
During shutdown the device cancels all outstanding IO requests and waits
for completion of the clear request.
Unfortunately the clear interrupt will never be received when there is no
interrupt handler connected.
Fix by moving the int\_handler removal after the call to the state machine
where no request or interrupt is outstanding.
Cc: stable@vger.kernel.org
Signed-off-by: Stefan Haberland
Tested-by: Bjoern Walk
Reviewed-by: Jan Hoeppner
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit c9038764d8ac13d2f2ea4f8d6198c1cb798fa739
Author: Rob Herring
Date: Tue Mar 9 17:44:12 2021 -0700
arm64: perf: Fix 64-bit event counter read truncation
commit 7bb8bc6eb550116c504fb25af8678b9d7ca2abc5 upstream.
Commit 0fdf1bb75953 ("arm64: perf: Avoid PMXEV\* indirection") changed
armv8pmu\_read\_evcntr() to return a u32 instead of u64. The result is
silent truncation of the event counter when using 64-bit counters. Given
the offending commit appears to have passed thru several folks, it seems
likely this was a bad rebase after v8.5 PMU 64-bit counters landed.
Cc: Alexandru Elisei
Cc: Julien Thierry
Cc: Mark Rutland
Cc: Will Deacon
Cc: Catalin Marinas
Cc: Peter Zijlstra
Cc: Ingo Molnar
Cc: Arnaldo Carvalho de Melo
Cc: Alexander Shishkin
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc:
Fixes: 0fdf1bb75953 ("arm64: perf: Avoid PMXEV\* indirection")
Signed-off-by: Rob Herring
Acked-by: Mark Rutland
Reviewed-by: Alexandru Elisei
Link: https://lore.kernel.org/r/20210310004412.1450128-1-robh@kernel.org
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit d6c36ce9c15f8e4b699a4af56e2636c308369a00
Author: Catalin Marinas
Date: Tue Mar 9 12:26:01 2021 +0000
arm64: mte: Map hotplugged memory as Normal Tagged
commit d15dfd31384ba3cb93150e5f87661a76fa419f74 upstream.
In a system supporting MTE, the linear map must allow reading/writing
allocation tags by setting the memory type as Normal Tagged. Currently,
this is only handled for memory present at boot. Hotplugged memory uses
Normal non-Tagged memory.
Introduce pgprot\_mhp() for hotplugged memory and use it in
add\_memory\_resource(). The arm64 code maps pgprot\_mhp() to
pgprot\_tagged().
Note that ZONE\_DEVICE memory should not be mapped as Tagged and
therefore setting the memory type in arch\_add\_memory() is not feasible.
Signed-off-by: Catalin Marinas
Fixes: 0178dc761368 ("arm64: mte: Use Normal Tagged attributes for the linear map")
Reported-by: Patrick Daly
Tested-by: Patrick Daly
Link: https://lore.kernel.org/r/1614745263-27827-1-git-send-email-pdaly@codeaurora.org
Cc:  # 5.10.x
Cc: Will Deacon
Cc: Andrew Morton
Cc: Vincenzo Frascino
Cc: David Hildenbrand
Reviewed-by: David Hildenbrand
Reviewed-by: Vincenzo Frascino
Reviewed-by: Anshuman Khandual
Link: https://lore.kernel.org/r/20210309122601.5543-1-catalin.marinas@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 0adb91be46b6597f2f8dc6c91d848a09e78882c9
Author: Andrey Konovalov
Date: Mon Mar 8 17:10:23 2021 +0100
arm64: kasan: fix page\_alloc tagging with DEBUG\_VIRTUAL
commit 86c83365ab76e4b43cedd3ce07a07d32a4dc79ba upstream.
When CONFIG\_DEBUG\_VIRTUAL is enabled, the default page\_to\_virt() macro
implementation from include/linux/mm.h is used. That definition doesn't
account for KASAN tags, which leads to no tags on page\_alloc allocations.
Provide an arm64-specific definition for page\_to\_virt() when
CONFIG\_DEBUG\_VIRTUAL is enabled that takes care of KASAN tags.
Fixes: 2813b9c02962 ("kasan, mm, arm64: tag non slab memory allocated via pagealloc")
Cc:
Signed-off-by: Andrey Konovalov
Reviewed-by: Catalin Marinas
Link: https://lore.kernel.org/r/4b55b35202706223d3118230701c6a59749d9b72.1615219501.git.andreyknvl@google.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 7e0815797656f029fab2edc309406cddf931b9d8
Author: Jan Kara
Date: Mon Feb 22 10:48:09 2021 +0100
block: Try to handle busy underlying device on discard
commit 56887cffe946bb0a90c74429fa94d6110a73119d upstream.
Commit 384d87ef2c95 ("block: Do not discard buffers under a mounted
filesystem") made paths issuing discard or zeroout requests to the
underlying device try to grab block device in exclusive mode. If that
failed we returned EBUSY to userspace. This however caused unexpected
fallout in userspace where e.g. FUSE filesystems issue discard requests
from userspace daemons although the device is open exclusively by the
kernel. Also shrinking of logical volume by LVM issues discard requests
to a device which may be claimed exclusively because there's another LV
on the same PV. So to avoid these userspace regressions, fall back to
invalidate\_inode\_pages2\_range() instead of returning EBUSY to userspace
and return EBUSY only of that call fails as well (meaning that there's
indeed someone using the particular device range we are trying to
discard).
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=211167
Fixes: 384d87ef2c95 ("block: Do not discard buffers under a mounted filesystem")
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara
Reviewed-by: Christoph Hellwig
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 3cf3d312bab4f2acaa79b9e5b502440764df7285
Author: Shin'ichiro Kawasaki
Date: Thu Mar 11 16:25:46 2021 +0900
block: Discard page cache of zone reset target range
commit e5113505904ea1c1c0e1f92c1cfa91fbf4da1694 upstream.
When zone reset ioctl and data read race for a same zone on zoned block
devices, the data read leaves stale page cache even though the zone
reset ioctl zero clears all the zone data on the device. To avoid
non-zero data read from the stale page cache after zone reset, discard
page cache of reset target zones in blkdev\_zone\_mgmt\_ioctl(). Introduce
the helper function blkdev\_truncate\_zone\_range() to discard the page
cache. Ensure the page cache discarded by calling the helper function
before and after zone reset in same manner as fallocate does.
This patch can be applied back to the stable kernel version v5.10.y.
Rework is needed for older stable kernels.
Signed-off-by: Shin'ichiro Kawasaki
Fixes: 3ed05a987e0f ("blk-zoned: implement ioctls")
Cc:  # 5.10+
Reviewed-by: Christoph Hellwig
Reviewed-by: Johannes Thumshirn
Link: https://lore.kernel.org/r/20210311072546.678999-1-shinichiro.kawasaki@wdc.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 7fbc077be2f3fad5d75ddfd4b598eeba66459c5d
Author: Eric W. Biederman
Date: Fri Mar 12 15:07:09 2021 -0600
Revert 95ebabde382c ("capabilities: Don't allow writing ambiguous v3 file capabilities")
commit 3b0c2d3eaa83da259d7726192cf55a137769012f upstream.
It turns out that there are in fact userspace implementations that
care and this recent change caused a regression.
https://github.com/containers/buildah/issues/3071
As the motivation for the original change was future development,
and the impact is existing real world code just revert this change
and allow the ambiguity in v3 file caps.
Cc: stable@vger.kernel.org
Fixes: 95ebabde382c ("capabilities: Don't allow writing ambiguous v3 file capabilities")
Signed-off-by: Eric W. Biederman
Signed-off-by: Greg Kroah-Hartman
commit 614b31a7409718fd792c11a7a96dc23617585fe5
Author: Beata Michalska
Date: Thu Mar 4 15:07:34 2021 +0000
opp: Don't drop extra references to OPPs accidentally
commit 606a5d4227e4610399c61086ac55c46068a90b03 upstream.
We are required to call dev\_pm\_opp\_put() from outside of the
opp\_table->lock as debugfs removal needs to happen lock-less to avoid
circular dependency issues.
commit cf1fac943c63 ("opp: Reduce the size of critical section in
\_opp\_kref\_release()") tried to fix that introducing a new routine
\_opp\_get\_next() which keeps returning OPPs that can be freed by the
callers and this routine shall be called without holding the
opp\_table->lock.
Though the commit overlooked the fact that the OPPs can be referenced by
other users as well and this routine will end up dropping references
which were taken by other users and hence freeing the OPPs prematurely.
In effect, other users of the OPPs will end up having invalid pointers
at hand. We didn't see any crash reports earlier as the exact situation
never happened, though it is certainly possible.
We need a way to mark which OPPs are no longer referenced by the OPP
core, so we don't drop extra references to them accidentally.
This commit adds another OPP flag, "removed", which is used to track
this. And now we should never end up dropping extra references to the
OPPs.
Cc: v5.11+  # v5.11+
Fixes: cf1fac943c63 ("opp: Reduce the size of critical section in \_opp\_kref\_release()")
Signed-off-by: Beata Michalska
[ Viresh: Almost rewrote entire patch, added new "removed" field,
rewrote commit log and added the correct Fixes tag. ]
Co-developed-by: Viresh Kumar
Signed-off-by: Viresh Kumar
Signed-off-by: Greg Kroah-Hartman
commit 569c90def48f1150925818929729dc6ea0e63c75
Author: Pavel Skripkin
Date: Tue Mar 9 01:30:57 2021 +0300
ALSA: usb-audio: fix use after free in usb\_audio\_disconnect
commit c5aa956eaeb05fe87e33433d7fd9f5e4d23c7416 upstream.
The problem was in wrong "if" placement. chip->quirk\_type is freed
in snd\_card\_free\_when\_closed(), but inside if statement it's accesed.
Fixes: 9799110825db ("ALSA: usb-audio: Disable USB autosuspend properly in setup\_disable\_autosuspend()")
Signed-off-by: Pavel Skripkin
Cc:
Link: https://lore.kernel.org/r/16da19126ff461e5e64a9aec648cce28fb8ed73e.1615242183.git.paskripkin@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit d5fb0e451fa8993f452943844a34bfda4f00161c
Author: Pavel Skripkin
Date: Tue Mar 9 01:30:36 2021 +0300
ALSA: usb-audio: fix NULL ptr dereference in usb\_audio\_probe
commit 30dea07180de3aa0ad613af88431ef4e34b5ef68 upstream.
syzbot reported null pointer dereference in usb\_audio\_probe.
The problem was in case, when quirk == NULL. It's not an
error condition, so quirk must be checked before dereferencing.
Call Trace:
usb\_probe\_interface+0x315/0x7f0 drivers/usb/core/driver.c:396
really\_probe+0x291/0xe60 drivers/base/dd.c:554
driver\_probe\_device+0x26b/0x3d0 drivers/base/dd.c:740
\_\_device\_attach\_driver+0x1d1/0x290 drivers/base/dd.c:846
bus\_for\_each\_drv+0x15f/0x1e0 drivers/base/bus.c:431
\_\_device\_attach+0x228/0x4a0 drivers/base/dd.c:914
bus\_probe\_device+0x1e4/0x290 drivers/base/bus.c:491
device\_add+0xbdb/0x1db0 drivers/base/core.c:3242
usb\_set\_configuration+0x113f/0x1910 drivers/usb/core/message.c:2164
usb\_generic\_driver\_probe+0xba/0x100 drivers/usb/core/generic.c:238
usb\_probe\_device+0xd9/0x2c0 drivers/usb/core/driver.c:293
really\_probe+0x291/0xe60 drivers/base/dd.c:554
driver\_probe\_device+0x26b/0x3d0 drivers/base/dd.c:740
\_\_device\_attach\_driver+0x1d1/0x290 drivers/base/dd.c:846
bus\_for\_each\_drv+0x15f/0x1e0 drivers/base/bus.c:431
\_\_device\_attach+0x228/0x4a0 drivers/base/dd.c:914
bus\_probe\_device+0x1e4/0x290 drivers/base/bus.c:491
device\_add+0xbdb/0x1db0 drivers/base/core.c:3242
usb\_new\_device.cold+0x721/0x1058 drivers/usb/core/hub.c:2555
hub\_port\_connect drivers/usb/core/hub.c:5223 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5363 [inline]
port\_event drivers/usb/core/hub.c:5509 [inline]
hub\_event+0x2357/0x4320 drivers/usb/core/hub.c:5591
process\_one\_work+0x98d/0x1600 kernel/workqueue.c:2275
worker\_thread+0x64c/0x1120 kernel/workqueue.c:2421
kthread+0x3b1/0x4a0 kernel/kthread.c:292
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:294
Reported-by: syzbot+719da9b149a931f5143f@syzkaller.appspotmail.com
Fixes: 9799110825db ("ALSA: usb-audio: Disable USB autosuspend properly in setup\_disable\_autosuspend()")
Signed-off-by: Pavel Skripkin
Cc:
Link: https://lore.kernel.org/r/f1ebad6e721412843bd1b12584444c0a63c6b2fb.1615242183.git.paskripkin@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit d846692eb892215e8dd0c37997b3182bc7da22d9
Author: Kai-Heng Feng
Date: Thu Mar 4 12:34:16 2021 +0800
ALSA: usb-audio: Disable USB autosuspend properly in setup\_disable\_autosuspend()
commit 9799110825dba087c2bdce886977cf84dada2005 upstream.
Rear audio on Lenovo ThinkStation P620 stops working after commit
1965c4364bdd ("ALSA: usb-audio: Disable autosuspend for Lenovo
ThinkStation P620"):
[ 6.013526] usbcore: registered new interface driver snd-usb-audio
[ 6.023064] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x100, wIndex = 0x0, type = 1
[ 6.023083] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x202, wIndex = 0x0, type = 4
[ 6.023090] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x100, wIndex = 0x0, type = 1
[ 6.023098] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x202, wIndex = 0x0, type = 4
[ 6.023103] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x100, wIndex = 0x0, type = 1
[ 6.023110] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x202, wIndex = 0x0, type = 4
[ 6.045846] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x100, wIndex = 0x0, type = 1
[ 6.045866] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x202, wIndex = 0x0, type = 4
[ 6.045877] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x100, wIndex = 0x0, type = 1
[ 6.045886] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x202, wIndex = 0x0, type = 4
[ 6.045894] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x100, wIndex = 0x0, type = 1
[ 6.045908] usb 3-6: cannot get ctl value: req = 0x81, wValue = 0x202, wIndex = 0x0, type = 4
I overlooked the issue because when I was working on the said commit,
only the front audio is tested. Apology for that.
Changing supports\_autosuspend in driver is too late for disabling
autosuspend, because it was already used by USB probe routine, so it can
break the balance on the following code that depends on
supports\_autosuspend.
Fix it by using usb\_disable\_autosuspend() helper, and balance the
suspend count in disconnect callback.
Fixes: 1965c4364bdd ("ALSA: usb-audio: Disable autosuspend for Lenovo ThinkStation P620")
Signed-off-by: Kai-Heng Feng
Cc:
Link: https://lore.kernel.org/r/20210304043419.287191-1-kai.heng.feng@canonical.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 05c65afceed81a6360f61b3236bf2e20978ac100
Author: Takashi Iwai
Date: Thu Mar 4 09:50:09 2021 +0100
ALSA: usb-audio: Apply the control quirk to Plantronics headsets
commit 06abcb18b3a021ba1a3f2020cbefb3ed04e59e72 upstream.
Other Plantronics headset models seem requiring the same workaround as
C320-M to add the 20ms delay for the control messages, too. Apply the
workaround generically for devices with the vendor ID 0x047f.
Note that the problem didn't surface before 5.11 just with luck.
Since 5.11 got a big code rewrite about the stream handling, the
parameter setup procedure has changed, and this seemed triggering the
problem more often.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1182552
Cc:
Link: https://lore.kernel.org/r/20210304085009.4770-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 1ed48f8b089f51c1ad16c39813844988fb5fa9e9
Author: Takashi Iwai
Date: Thu Mar 4 09:30:21 2021 +0100
ALSA: usb-audio: Fix "cannot get freq eq" errors on Dell AE515 sound bar
commit fec60c3bc5d1713db2727cdffc638d48f9c07dc3 upstream.
Dell AE515 sound bar (413c:a506) spews the error messages when the
driver tries to read the current sample frequency, hence it needs to
be on the list in snd\_usb\_get\_sample\_rate\_quirk().
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=211551
Cc:
Link: https://lore.kernel.org/r/20210304083021.2152-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8db51c29fb969a8fbb229b556ac58c5134c88878
Author: Takashi Iwai
Date: Wed Mar 10 12:28:08 2021 +0100
ALSA: hda: Avoid spurious unsol event handling during S3/S4
commit 5ff9dde42e8c72ed8102eb8cb62e03f9dc2103ab upstream.
When HD-audio bus receives unsolicited events during its system
suspend/resume (S3 and S4) phase, the controller driver may still try
to process events although the codec chips are already (or yet)
powered down. This might screw up the codec communication, resulting
in CORB/RIRB errors. Such events should be rather skipped, as the
codec chip status such as the jack status will be fully refreshed at
the system resume time.
Since we're tracking the system suspend/resume state in codec
power.power\_state field, let's add the check in the common unsol event
handler entry point to filter out such events.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1182377
Tested-by: Abhishek Sahu
Cc:  # 183ab39eb0ea: ALSA: hda: Initialize power\_state
Link: https://lore.kernel.org/r/20210310112809.9215-3-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 5d599146decd88ff2bc65c7bfeb55ee85bbe1f13
Author: Takashi Iwai
Date: Wed Mar 10 12:28:07 2021 +0100
ALSA: hda: Flush pending unsolicited events before suspend
commit 13661fc48461282e43fe8f76bf5bf449b3d40687 upstream.
The HD-audio controller driver processes the unsolicited events via
its work asynchronously, and this might be pending when the system
goes to suspend. When a lengthy event handling like ELD byte reads is
running, this might trigger unexpected accesses among suspend/resume
procedure, typically seen with Nvidia driver that still requires the
handling via unsolicited event verbs for ELD updates.
This patch adds the flush of unsol\_work to assure that pending events
are processed before going into suspend.
Buglink: https://bugzilla.suse.com/show\_bug.cgi?id=1182377
Reported-and-tested-by: Abhishek Sahu
Cc:
Link: https://lore.kernel.org/r/20210310112809.9215-2-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ce0e1780ccb2a30354d18d338622b6e02a0ee127
Author: Takashi Iwai
Date: Mon Mar 8 17:07:26 2021 +0100
ALSA: hda: Drop the BATCH workaround for AMD controllers
commit 28e96c1693ec1cdc963807611f8b5ad400431e82 upstream.
The commit c02f77d32d2c ("ALSA: hda - Workaround for crackled sound on
AMD controller (1022:1457)") introduced a few workarounds for the
recent AMD HD-audio controller, and one of them is the forced BATCH
PCM mode so that PulseAudio avoids the timer-based scheduling. This
was thought to cover for some badly working applications, but this
actually worsens for more others. In total, this wasn't a good idea
to enforce it.
This is a partial revert of the commit above for dropping the PCM
BATCH enforcement part to recover from the regression again.
Fixes: c02f77d32d2c ("ALSA: hda - Workaround for crackled sound on AMD controller (1022:1457)")
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=195303
Cc:
Link: https://lore.kernel.org/r/20210308160726.22930-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 17ea8fdb019392a91ab2cf70489fd4c5ab2280a8
Author: Simeon Simeonoff
Date: Mon Mar 8 20:48:35 2021 +0200
ALSA: hda/ca0132: Add Sound BlasterX AE-5 Plus support
commit f15c5c11abfbf8909eb30598315ecbec2311cfdc upstream.
The new AE-5 Plus model has a different Subsystem ID compared to the
non-plus model. Adding the new id to the list of quirks.
Signed-off-by: Simeon Simeonoff
Cc:
Link: https://lore.kernel.org/r/998cafbe10b648f724ee33570553f2d780a38963.camel@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 40dda525fc6358e2a52abd841548c7ebb8f582e5
Author: Takashi Iwai
Date: Sat Mar 6 10:50:18 2021 +0100
ALSA: hda/conexant: Add quirk for mute LED control on HP ZBook G5
commit 56b26497bb4b7ff970612dc25a8a008c34463f7b upstream.
The mute and mic-mute LEDs on HP ZBook Studio G5 are controlled via
GPIO bits 0x10 and 0x20, respectively, and we need the extra setup for
those.
As the similar code is already present for other HP models but with
different GPIO pins, this patch factors out the common helper code and
applies those GPIO values for each model.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=211893
Cc:
Link: https://lore.kernel.org/r/20210306095018.11746-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c276c5f1c71a6243db7bcf8f6f5dca2057e8b5b3
Author: Takashi Iwai
Date: Wed Mar 10 12:28:09 2021 +0100
ALSA: hda/hdmi: Cancel pending works before suspend
commit eea46a0879bcca23e15071f9968c0f6e6596e470 upstream.
The per\_pin->work might be still floating at the suspend, and this may
hit the access to the hardware at an unexpected timing. Cancel the
work properly at the suspend callback for avoiding the buggy access.
Note that the bug doesn't trigger easily in the recent kernels since
the work is queued only when the repoll count is set, and usually it's
only at the resume callback, but it's still possible to hit in
theory.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1182377
Reported-and-tested-by: Abhishek Sahu
Cc:
Link: https://lore.kernel.org/r/20210310112809.9215-4-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 1c5f1ab8bf8f7059bb8fd8a1f5080e4cb609e5d3
Author: John Ernberg
Date: Wed Mar 3 18:14:39 2021 +0000
ALSA: usb: Add Plantronics C320-M USB ctrl msg delay quirk
commit fc7c5c208eb7bc2df3a9f4234f14eca250001cb6 upstream.
The microphone in the Plantronics C320-M headset will randomly
fail to initialize properly, at least when using Microsoft Teams.
Introducing a 20ms delay on the control messages appears to
resolve the issue.
Link: https://gitlab.freedesktop.org/pulseaudio/pulseaudio/-/issues/1065
Tested-by: Andreas Kempe
Signed-off-by: John Ernberg
Cc:
Link: https://lore.kernel.org/r/20210303181405.39835-1-john.ernberg@actia.se
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 575bf63862b3be38c1d013e6c5dbe98d1a97b005
Author: AngeloGioacchino Del Regno
Date: Thu Jan 14 23:10:58 2021 +0100
clk: qcom: gpucc-msm8998: Add resets, cxc, fix flags on gpu\_gx\_gdsc
[ Upstream commit a59c16c80bd791878cf81d1d5aae508eeb2e73f1 ]
The GPU GX GDSC has GPU\_GX\_BCR reset and gfx3d\_clk CXC, as stated
on downstream kernels (and as verified upstream, because otherwise
random lockups happen).
Also, add PWRSTS\_RET and NO\_RET\_PERIPH: also as found downstream,
and also as verified here, to avoid GPU related lockups it is
necessary to force retain mem, but \*not\* peripheral when enabling
this GDSC (and, of course, the inverse on disablement).
With this change, the GPU finally works flawlessly on my four
different MSM8998 devices from two different manufacturers.
Signed-off-by: AngeloGioacchino Del Regno
Link: https://lore.kernel.org/r/20210114221059.483390-11-angelogioacchino.delregno@somainline.org
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit 98616e88a6038a93007cdaa50d5515fe171521d3
Author: Aleksandr Miloserdov
Date: Tue Feb 9 10:22:02 2021 +0300
scsi: target: core: Prevent underflow for service actions
[ Upstream commit 14d24e2cc77411301e906a8cf41884739de192de ]
TCM buffer length doesn't necessarily equal 8 + ADDITIONAL LENGTH which
might be considered an underflow in case of Data-In size being greater than
8 + ADDITIONAL LENGTH. So truncate buffer length to prevent underflow.
Link: https://lore.kernel.org/r/20210209072202.41154-3-a.miloserdov@yadro.com
Reviewed-by: Roman Bolshakov
Reviewed-by: Bodo Stroesser
Signed-off-by: Aleksandr Miloserdov
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 202738aea5533f7c945affff76e1815095caf309
Author: Aleksandr Miloserdov
Date: Tue Feb 9 10:22:01 2021 +0300
scsi: target: core: Add cmd length set before cmd complete
[ Upstream commit 1c73e0c5e54d5f7d77f422a10b03ebe61eaed5ad ]
TCM doesn't properly handle underflow case for service actions. One way to
prevent it is to always complete command with
target\_complete\_cmd\_with\_length(), however it requires access to data\_sg,
which is not always available.
This change introduces target\_set\_cmd\_data\_length() function which allows
to set command data length before completing it.
Link: https://lore.kernel.org/r/20210209072202.41154-2-a.miloserdov@yadro.com
Reviewed-by: Roman Bolshakov
Reviewed-by: Bodo Stroesser
Signed-off-by: Aleksandr Miloserdov
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 42ae74da77d49c9df59e3851c8bb8adeeddef6e5
Author: Mike Christie
Date: Sat Feb 6 22:46:00 2021 -0600
scsi: libiscsi: Fix iscsi\_prep\_scsi\_cmd\_pdu() error handling
[ Upstream commit d28d48c699779973ab9a3bd0e5acfa112bd4fdef ]
If iscsi\_prep\_scsi\_cmd\_pdu() fails we try to add it back to the cmdqueue,
but we leave it partially setup. We don't have functions that can undo the
pdu and init task setup. We only have cleanup\_task which can clean up both
parts. So this has us just fail the cmd and go through the standard cleanup
routine and then have the SCSI midlayer retry it like is done when it fails
in the queuecommand path.
Link: https://lore.kernel.org/r/20210207044608.27585-2-michael.christie@oracle.com
Reviewed-by: Lee Duncan
Signed-off-by: Mike Christie
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 2d0e68226f17d78466fee09cf2df40885d27c7c7
Author: Lin Feng
Date: Thu Feb 25 17:20:53 2021 -0800
sysctl.c: fix underflow value setting risk in vm\_table
[ Upstream commit 3b3376f222e3ab58367d9dd405cafd09d5e37b7c ]
Apart from subsystem specific .proc\_handler handler, all ctl\_tables with
extra1 and extra2 members set should use proc\_dointvec\_minmax instead of
proc\_dointvec, or the limit set in extra\* never work and potentially echo
underflow values(negative numbers) is likely make system unstable.
Especially vfs\_cache\_pressure and zone\_reclaim\_mode, -1 is apparently not
a valid value, but we can set to them. And then kernel may crash.
# echo -1 > /proc/sys/vm/vfs\_cache\_pressure
Link: https://lkml.kernel.org/r/20201223105535.2875-1-linf@wangsu.com
Signed-off-by: Lin Feng
Cc: Alexey Dobriyan
Cc: "Eric W. Biederman"
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 9f5f4f5a3bd67751972af46eb81c5cfa11c4de74
Author: David Hildenbrand
Date: Thu Feb 25 17:17:24 2021 -0800
drivers/base/memory: don't store phys\_device in memory blocks
[ Upstream commit e9a2e48e8704c9d20a625c6f2357147d03ea7b97 ]
No need to store the value for each and every memory block, as we can
easily query the value at runtime. Reshuffle the members to optimize the
memory layout. Also, let's clarify what the interface once was used for
and why it's legacy nowadays.
"phys\_device" was used on s390x in older versions of lsmem[2]/chmem[3],
back when they were still part of s390x-tools. They were later replaced
by the variants in linux-utils. For example, RHEL6 and RHEL7 contain
lsmem/chmem from s390-utils. RHEL8 switched to versions from util-linux
on s390x [4].
"phys\_device" was added with sysfs support for memory hotplug in commit
3947be1969a9 ("[PATCH] memory hotplug: sysfs and add/remove functions") in
2005. It always returned 0.
s390x started returning something != 0 on some setups (if sclp.rzm is set
by HW) in 2010 via commit 57b552ba0b2f ("memory hotplug/s390: set
phys\_device").
For s390x, it allowed for identifying which memory block devices belong to
the same storage increment (RZM). Only if all memory block devices
comprising a single storage increment were offline, the memory could
actually be removed in the hypervisor.
Since commit e5d709bb5fb7 ("s390/memory hotplug: provide
memory\_block\_size\_bytes() function") in 2013 a memory block device spans
at least one storage increment - which is why the interface isn't really
helpful/used anymore (except by old lsmem/chmem tools).
There were once RFC patches to make use of "phys\_device" in ACPI context;
however, the underlying problem could be solved using different interfaces
[1].
[1] https://patchwork.kernel.org/patch/2163871/
[2] https://github.com/ibm-s390-tools/s390-tools/blob/v2.1.0/zconf/lsmem
[3] https://github.com/ibm-s390-tools/s390-tools/blob/v2.1.0/zconf/chmem
[4] https://bugzilla.redhat.com/show\_bug.cgi?id=1504134
Link: https://lkml.kernel.org/r/20210201181347.13262-2-david@redhat.com
Signed-off-by: David Hildenbrand
Acked-by: Michal Hocko
Reviewed-by: Oscar Salvador
Cc: Dave Hansen
Cc: Greg Kroah-Hartman
Cc: Gerald Schaefer
Cc: Jonathan Corbet
Cc: "Rafael J. Wysocki"
Cc: Mauro Carvalho Chehab
Cc: Ilya Dryomov
Cc: Vaibhav Jain
Cc: Tom Rix
Cc: Geert Uytterhoeven
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 64dd11b8b3028342928d9e53589c24cdadc733f9
Author: Heiko Carstens
Date: Wed Feb 17 07:13:02 2021 +0100
s390/smp: \_\_smp\_rescan\_cpus() - move cpumask away from stack
[ Upstream commit 62c8dca9e194326802b43c60763f856d782b225c ]
Avoid a potentially large stack frame and overflow by making
"cpumask\_t avail" a static variable. There is no concurrent
access due to the existing locking.
Signed-off-by: Heiko Carstens
Signed-off-by: Vasily Gorbik
Signed-off-by: Sasha Levin
commit 7c1e30d4c5503b3ed970970480d4de314953a3a7
Author: Andrey Konovalov
Date: Wed Feb 24 12:05:42 2021 -0800
kasan: fix memory corruption in kasan\_bitops\_tags test
[ Upstream commit e66e1799a76621003e5b04c9c057826a2152e103 ]
Since the hardware tag-based KASAN mode might not have a redzone that
comes after an allocated object (when kasan.mode=prod is enabled), the
kasan\_bitops\_tags() test ends up corrupting the next object in memory.
Change the test so it always accesses the redzone that lies within the
allocated object's boundaries.
Link: https://linux-review.googlesource.com/id/I67f51d1ee48f0a8d0fe2658c2a39e4879fe0832a
Link: https://lkml.kernel.org/r/7d452ce4ae35bb1988d2c9244dfea56cf2cc9315.1610733117.git.andreyknvl@google.com
Signed-off-by: Andrey Konovalov
Reviewed-by: Marco Elver
Reviewed-by: Alexander Potapenko
Cc: Andrey Ryabinin
Cc: Branislav Rankov
Cc: Catalin Marinas
Cc: Dmitry Vyukov
Cc: Evgenii Stepanov
Cc: Kevin Brodsky
Cc: Peter Collingbourne
Cc: Vincenzo Frascino
Cc: Will Deacon
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 531bf07268091a3342fb503134fb359c175a031f
Author: Keith Busch
Date: Mon Jan 4 15:02:58 2021 -0800
PCI/ERR: Retain status from error notification
[ Upstream commit 387c72cdd7fb6bef650fb078d0f6ae9682abf631 ]
Overwriting the frozen detected status with the result of the link reset
loses the NEED\_RESET result that drivers are depending on for error
handling to report the .slot\_reset() callback. Retain this status so
that subsequent error handling has the correct flow.
Link: https://lore.kernel.org/r/20210104230300.1277180-4-kbusch@kernel.org
Reported-by: Hinko Kocevar
Tested-by: Hedi Berriche
Signed-off-by: Keith Busch
Signed-off-by: Bjorn Helgaas
Acked-by: Sean V Kelley
Acked-by: Hedi Berriche
Signed-off-by: Sasha Levin
commit 1008fa244e3dea131d7d5476cde475bbe03cb434
Author: Keita Suzuki
Date: Fri Oct 30 07:14:30 2020 +0000
i40e: Fix memory leak in i40e\_probe
[ Upstream commit 58cab46c622d6324e47bd1c533693c94498e4172 ]
Struct i40e\_veb is allocated in function i40e\_setup\_pf\_switch, and
stored to an array field veb inside struct i40e\_pf. However when
i40e\_setup\_misc\_vector fails, this memory leaks.
Fix this by calling exit and teardown functions.
Signed-off-by: Keita Suzuki
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit aa8119817b7afb357219434be50d8215ffda2329
Author: Geert Uytterhoeven
Date: Tue Feb 2 11:03:32 2021 +0100
PCI: Fix pci\_register\_io\_range() memory leak
[ Upstream commit f6bda644fa3a7070621c3bf12cd657f69a42f170 ]
Kmemleak reports:
unreferenced object 0xc328de40 (size 64):
comm "kworker/1:1", pid 21, jiffies 4294938212 (age 1484.670s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 e0 d8 fc eb 00 00 00 00 ................
00 00 10 fe 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[] pci\_register\_io\_range+0x3c/0x80
[<2c7f139e>] of\_pci\_range\_to\_resource+0x48/0xc0
[] devm\_of\_pci\_get\_host\_bridge\_resources.constprop.0+0x2ac/0x3ac
[] devm\_of\_pci\_bridge\_init+0x60/0x1b8
[] devm\_pci\_alloc\_host\_bridge+0x54/0x64
[] rcar\_pcie\_probe+0x2c/0x644
In case a PCI host driver's probe is deferred, the same I/O range may be
allocated again, and be ignored, causing a memory leak.
Fix this by (a) letting logic\_pio\_register\_range() return -EEXIST if the
passed range already exists, so pci\_register\_io\_range() will free it, and
by (b) making pci\_register\_io\_range() not consider -EEXIST an error
condition.
Link: https://lore.kernel.org/r/20210202100332.829047-1-geert+renesas@glider.be
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit b8982da7657b4ec79a49dd1a6d4fc02fab0e38aa
Author: Sasha Levin
Date: Fri Feb 5 22:50:32 2021 -0500
kbuild: clamp SUBLEVEL to 255
[ Upstream commit 9b82f13e7ef316cdc0a8858f1349f4defce3f9e0 ]
Right now if SUBLEVEL becomes larger than 255 it will overflow into the
territory of PATCHLEVEL, causing havoc in userspace that tests for
specific kernel version.
While userspace code tests for MAJOR and PATCHLEVEL, it doesn't test
SUBLEVEL at any point as ABI changes don't happen in the context of
stable tree.
Thus, to avoid overflows, simply clamp SUBLEVEL to it's maximum value in
the context of LINUX\_VERSION\_CODE. This does not affect "make
kernelversion" and such.
Signed-off-by: Sasha Levin
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit f20ae52db0f94dfedc3d2b2c746a5ad992f79482
Author: Theodore Ts'o
Date: Thu Jan 21 12:33:20 2021 -0500
ext4: don't try to processed freed blocks until mballoc is initialized
[ Upstream commit 027f14f5357279655c3ebc6d14daff8368d4f53f ]
If we try to make any changes via the journal between when the journal
is initialized, but before the multi-block allocated is initialized,
we will end up deferencing a NULL pointer when the journal commit
callback function calls ext4\_process\_freed\_data().
The proximate cause of this failure was commit 2d01ddc86606 ("ext4:
save error info to sb through journal if available") since file system
corruption problems detected before the call to ext4\_mb\_init() would
result in a journal commit before we aborted the mount of the file
system.... and we would then trigger the NULL pointer deref.
Link: https://lore.kernel.org/r/YAm8qH/0oo2ofSMR@mit.edu
Reported-by: Murphy Zhou
Reviewed-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Sasha Levin
commit 14901733de5db70b2d1060f6a74ecd964356ab27
Author: Bjorn Helgaas
Date: Tue Feb 2 14:17:54 2021 -0600
PCI/LINK: Remove bandwidth notification
[ Upstream commit b4c7d2076b4e767dd2e075a2b3a9e57753fc67f5 ]
The PCIe Bandwidth Change Notification feature logs messages when the link
bandwidth changes. Some users have reported that these messages occur
often enough to significantly reduce NVMe performance. GPUs also seem to
generate these messages.
We don't know why the link bandwidth changes, but in the reported cases
there's no indication that it's caused by hardware failures.
Remove the bandwidth change notifications for now. Hopefully we can add
this back when we have a better understanding of why this happens and how
we can make the messages useful instead of overwhelming.
Link: https://lore.kernel.org/r/20200115221008.GA191037@google.com/
Link: https://lore.kernel.org/r/155605909349.3575.13433421148215616375.stgit@gimli.home/
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=206197
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit 0bcef8312c5f7887d1dcb3a8636797a037264e47
Author: Arnd Bergmann
Date: Mon Jan 25 13:45:27 2021 +0100
drivers/base: build kunit tests without structleak plugin
[ Upstream commit 38009c766725a9877ea8866fc813a5460011817f ]
The structleak plugin causes the stack frame size to grow immensely:
drivers/base/test/property-entry-test.c: In function 'pe\_test\_reference':
drivers/base/test/property-entry-test.c:481:1: error: the frame size of 2640 bytes is larger than 2048 bytes [-Werror=frame-larger-than=]
481 | }
| ^
drivers/base/test/property-entry-test.c: In function 'pe\_test\_uints':
drivers/base/test/property-entry-test.c:99:1: error: the frame size of 2592 bytes is larger than 2048 bytes [-Werror=frame-larger-than=]
Turn it off in this file.
Signed-off-by: Arnd Bergmann
Link: https://lore.kernel.org/r/20210125124533.101339-3-arnd@kernel.org
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit ec574d41d8ef94fb3d745afd5bd72db8b52b87d8
Author: Krzysztof Wilczyński
Date: Wed Jan 20 18:48:10 2021 +0000
PCI: mediatek: Add missing of\_node\_put() to fix reference leak
[ Upstream commit 42814c438aac79746d310f413a27d5b0b959c5de ]
The for\_each\_available\_child\_of\_node helper internally makes use of the
of\_get\_next\_available\_child() which performs an of\_node\_get() on each
iteration when searching for next available child node.
Should an available child node be found, then it would return a device
node pointer with reference count incremented, thus early return from
the middle of the loop requires an explicit of\_node\_put() to prevent
reference count leak.
To stop the reference leak, explicitly call of\_node\_put() before
returning after an error occurred.
Link: https://lore.kernel.org/r/20210120184810.3068794-1-kw@linux.com
Signed-off-by: Krzysztof Wilczyński
Signed-off-by: Lorenzo Pieralisi
Signed-off-by: Sasha Levin
commit 46393d626e2ff2c7379b25bb587275dae72e7c61
Author: Martin Kaiser
Date: Fri Jan 15 22:24:35 2021 +0100
PCI: xgene-msi: Fix race in installing chained irq handler
[ Upstream commit a93c00e5f975f23592895b7e83f35de2d36b7633 ]
Fix a race where a pending interrupt could be received and the handler
called before the handler's data has been setup, by converting to
irq\_set\_chained\_handler\_and\_data().
See also 2cf5a03cb29d ("PCI/keystone: Fix race in installing chained IRQ
handler").
Based on the mail discussion, it seems ok to drop the error handling.
Link: https://lore.kernel.org/r/20210115212435.19940-3-martin@kaiser.cx
Signed-off-by: Martin Kaiser
Signed-off-by: Lorenzo Pieralisi
Signed-off-by: Sasha Levin
commit cbeeedcfbacebbc1b84352e1fc33ff80b8917fd6
Author: Ronald Tschalär
Date: Fri Feb 19 11:10:51 2021 -0800
Input: applespi - don't wait for responses to commands indefinitely.
[ Upstream commit 0ce1ac23149c6da939a5926c098c270c58c317a0 ]
The response to a command may never arrive or it may be corrupted (and
hence dropped) for some reason. While exceedingly rare, when it did
happen it blocked all further commands. One way to fix this was to
do a suspend/resume. However, recovering automatically seems like a
nicer option. Hence this puts a time limit (1 sec) on how long we're
willing to wait for a response, after which we assume it got lost.
Signed-off-by: Ronald Tschalär
Link: https://lore.kernel.org/r/20210217190718.11035-1-ronald@innovation.ch
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit bc6759bd959dc62aea9933f5b54932d44bac80e0
Author: Khalid Aziz
Date: Fri Oct 23 11:56:11 2020 -0600
sparc64: Use arch\_validate\_flags() to validate ADI flag
[ Upstream commit 147d8622f2a26ef34beacc60e1ed8b66c2fa457f ]
When userspace calls mprotect() to enable ADI on an address range,
do\_mprotect\_pkey() calls arch\_validate\_prot() to validate new
protection flags. arch\_validate\_prot() for sparc looks at the first
VMA associated with address range to verify if ADI can indeed be
enabled on this address range. This has two issues - (1) Address
range might cover multiple VMAs while arch\_validate\_prot() looks at
only the first VMA, (2) arch\_validate\_prot() peeks at VMA without
holding mmap lock which can result in race condition.
arch\_validate\_flags() from commit c462ac288f2c ("mm: Introduce
arch\_validate\_flags()") allows for VMA flags to be validated for all
VMAs that cover the address range given by user while holding mmap
lock. This patch updates sparc code to move the VMA check from
arch\_validate\_prot() to arch\_validate\_flags() to fix above two
issues.
Suggested-by: Jann Horn
Suggested-by: Christoph Hellwig
Suggested-by: Catalin Marinas
Signed-off-by: Khalid Aziz
Reviewed-by: Catalin Marinas
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9301cf801e4f9206c58d8091aeb91a75d24616ab
Author: Andreas Larsson
Date: Fri Feb 5 14:20:31 2021 +0100
sparc32: Limit memblock allocation to low memory
[ Upstream commit bda166930c37604ffa93f2425426af6921ec575a ]
Commit cca079ef8ac29a7c02192d2bad2ffe4c0c5ffdd0 changed sparc32 to use
memblocks instead of bootmem, but also made high memory available via
memblock allocation which does not work together with e.g. phys\_to\_virt
and can lead to kernel panic.
This changes back to only low memory being allocatable in the early
stages, now using memblock allocation.
Signed-off-by: Andreas Larsson
Acked-by: Mike Rapoport
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3cd74eaa31dd99b593b0fc90d81a8a548e7ec0b0
Author: AngeloGioacchino Del Regno
Date: Wed Jan 13 19:38:15 2021 +0100
clk: qcom: gdsc: Implement NO\_RET\_PERIPH flag
[ Upstream commit 785c02eb35009a4be6dbc68f4f7d916e90b7177d ]
In some rare occasions, we want to only set the RETAIN\_MEM bit, but
not the RETAIN\_PERIPH one: this is seen on at least SDM630/636/660's
GPU-GX GDSC, where unsetting and setting back the RETAIN\_PERIPH bit
will generate chaos and panics during GPU suspend time (mainly, the
chaos is unaligned access).
For this reason, introduce a new NO\_RET\_PERIPH flag to the GDSC
driver to address this corner case.
Signed-off-by: AngeloGioacchino Del Regno
Link: https://lore.kernel.org/r/20210113183817.447866-8-angelogioacchino.delregno@somainline.org
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit a41baef1cb1c7427fb646d9689dd68b096cced1e
Author: Suravee Suthikulpanit
Date: Mon Feb 8 06:27:12 2021 -0600
iommu/amd: Fix performance counter initialization
[ Upstream commit 6778ff5b21bd8e78c8bd547fd66437cf2657fd9b ]
Certain AMD platforms enable power gating feature for IOMMU PMC,
which prevents the IOMMU driver from updating the counter while
trying to validate the PMC functionality in the init\_iommu\_perf\_ctr().
This results in disabling PMC support and the following error message:
"AMD-Vi: Unable to read/write to IOMMU perf counter"
To workaround this issue, disable power gating temporarily by programming
the counter source to non-zero value while validating the counter,
and restore the prior state afterward.
Signed-off-by: Suravee Suthikulpanit
Tested-by: Tj (Elloe Linux)
Link: https://lore.kernel.org/r/20210208122712.5048-1-suravee.suthikulpanit@amd.com
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=201753
Signed-off-by: Joerg Roedel
Signed-off-by: Sasha Levin
commit 4eb948eff16365d90f07c5d7cd51dd2e943c0a61
Author: Michael Ellerman
Date: Wed Feb 10 00:59:20 2021 +1100
powerpc/64: Fix stack trace not displaying final frame
[ Upstream commit e3de1e291fa58a1ab0f471a4b458eff2514e4b5f ]
In commit bf13718bc57a ("powerpc: show registers when unwinding
interrupt frames") we changed our stack dumping logic to show the full
registers whenever we find an interrupt frame on the stack.
However we didn't notice that on 64-bit this doesn't show the final
frame, ie. the interrupt that brought us in from userspace, whereas on
32-bit it does.
That is due to confusion about the size of that last frame. The code
in show\_stack() calls validate\_sp(), passing it STACK\_INT\_FRAME\_SIZE
to check the sp is at least that far below the top of the stack.
However on 64-bit that size is too large for the final frame, because
it includes the red zone, but we don't allocate a red zone for the
first frame.
So add a new define that encodes the correct size for 32-bit and
64-bit, and use it in show\_stack().
This results in the full trace being shown on 64-bit, eg:
sysrq: Trigger a crash
Kernel panic - not syncing: sysrq triggered crash
CPU: 0 PID: 83 Comm: sh Not tainted 5.11.0-rc2-gcc-8.2.0-00188-g571abcb96b10-dirty #649
Call Trace:
[c00000000a1c3ac0] [c000000000897b70] dump\_stack+0xc4/0x114 (unreliable)
[c00000000a1c3b00] [c00000000014334c] panic+0x178/0x41c
[c00000000a1c3ba0] [c00000000094e600] sysrq\_handle\_crash+0x40/0x50
[c00000000a1c3c00] [c00000000094ef98] \_\_handle\_sysrq+0xd8/0x210
[c00000000a1c3ca0] [c00000000094f820] write\_sysrq\_trigger+0x100/0x188
[c00000000a1c3ce0] [c0000000005559dc] proc\_reg\_write+0x10c/0x1b0
[c00000000a1c3d10] [c000000000479950] vfs\_write+0xf0/0x360
[c00000000a1c3d60] [c000000000479d9c] ksys\_write+0x7c/0x140
[c00000000a1c3db0] [c00000000002bf5c] system\_call\_exception+0x19c/0x2c0
[c00000000a1c3e10] [c00000000000d35c] system\_call\_common+0xec/0x278
--- interrupt: c00 at 0x7fff9fbab428
NIP: 00007fff9fbab428 LR: 000000001000b724 CTR: 0000000000000000
REGS: c00000000a1c3e80 TRAP: 0c00 Not tainted (5.11.0-rc2-gcc-8.2.0-00188-g571abcb96b10-dirty)
MSR: 900000000280f033  CR: 22002884 XER: 00000000
IRQMASK: 0
GPR00: 0000000000000004 00007fffc3cb8960 00007fff9fc59900 0000000000000001
GPR04: 000000002a4b32d0 0000000000000002 0000000000000063 0000000000000063
GPR08: 000000002a4b32d0 0000000000000000 0000000000000000 0000000000000000
GPR12: 0000000000000000 00007fff9fcca9a0 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 00000000100b8fd0
GPR20: 000000002a4b3485 00000000100b8f90 0000000000000000 0000000000000000
GPR24: 000000002a4b0440 00000000100e77b8 0000000000000020 000000002a4b32d0
GPR28: 0000000000000001 0000000000000002 000000002a4b32d0 0000000000000001
NIP [00007fff9fbab428] 0x7fff9fbab428
LR [000000001000b724] 0x1000b724
--- interrupt: c00
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210209141627.2898485-1-mpe@ellerman.id.au
Signed-off-by: Sasha Levin
commit 16a18856f9c99463b7af2060ee4b1cd6e84a4bf7
Author: Filipe Laíns
Date: Sat Jan 23 18:02:20 2021 +0000
HID: logitech-dj: add support for the new lightspeed connection iteration
[ Upstream commit fab3a95654eea01d6b0204995be8b7492a00d001 ]
This new connection type is the new iteration of the Lightspeed
connection and will probably be used in some of the newer gaming
devices. It is currently use in the G Pro X Superlight.
This patch should be backported to older versions, as currently the
driver will panic when seing the unsupported connection. This isn't
an issue when using the receiver that came with the device, as Logitech
has been using different PIDs when they change the connection type, but
is an issue when using a generic receiver (well, generic Lightspeed
receiver), which is the case of the one in the Powerplay mat. Currently,
the only generic Ligthspeed receiver we support, and the only one that
exists AFAIK, is ther Powerplay.
As it stands, the driver will panic when seeing a G Pro X Superlight
connected to the Powerplay receiver and won't send any input events to
userspace! The kernel will warn about this so the issue should be easy
to identify, but it is still very worrying how hard it will fail :(
[915977.398471] logitech-djreceiver 0003:046D:C53A.0107: unusable device of type UNKNOWN (0x0f) connected on slot 1
Signed-off-by: Filipe Laíns
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 8f4e4316c6aee8215b6c07e023f7f93c751cbaee
Author: Athira Rajeev
Date: Fri Feb 5 04:14:52 2021 -0500
powerpc/perf: Record counter overflow always if SAMPLE\_IP is unset
[ Upstream commit d137845c973147a22622cc76c7b0bc16f6206323 ]
While sampling for marked events, currently we record the sample only
if the SIAR valid bit of Sampled Instruction Event Register (SIER) is
set. SIAR\_VALID bit is used for fetching the instruction address from
Sampled Instruction Address Register(SIAR). But there are some
usecases, where the user is interested only in the PMU stats at each
counter overflow and the exact IP of the overflow event is not
required. Dropping SIAR invalid samples will fail to record some of
the counter overflows in such cases.
Example of such usecase is dumping the PMU stats (event counts) after
some regular amount of instructions/events from the userspace (ex: via
ptrace). Here counter overflow is indicated to userspace via signal
handler, and captured by monitoring and enabling I/O signaling on the
event file descriptor. In these cases, we expect to get
sample/overflow indication after each specified sample\_period.
Perf event attribute will not have PERF\_SAMPLE\_IP set in the
sample\_type if exact IP of the overflow event is not requested. So
while profiling if SAMPLE\_IP is not set, just record the counter
overflow irrespective of SIAR\_VALID check.
Suggested-by: Michael Ellerman
Signed-off-by: Athira Rajeev
[mpe: Reflow comment and if formatting]
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/1612516492-1428-1-git-send-email-atrajeev@linux.vnet.ibm.com
Signed-off-by: Sasha Levin
commit 23581f5a24864dd24edb1f3aa16df894f7370c27
Author: Nicholas Piggin
Date: Sat Jan 30 23:08:35 2021 +1000
powerpc: improve handling of unrecoverable system reset
[ Upstream commit 11cb0a25f71818ca7ab4856548ecfd83c169aa4d ]
If an unrecoverable system reset hits in process context, the system
does not have to panic. Similar to machine check, call nmi\_exit()
before die().
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210130130852.2952424-26-npiggin@gmail.com
Signed-off-by: Sasha Levin
commit b9bd02fa6bf9f28931c721b61de14c234305d1a7
Author: Alain Volmat
Date: Fri Feb 5 19:59:32 2021 +0100
spi: stm32: make spurious and overrun interrupts visible
[ Upstream commit c64e7efe46b7de21937ef4b3594d9b1fc74f07df ]
We do not expect to receive spurious interrupts so rise a warning
if it happens.
RX overrun is an error condition that signals a corrupted RX
stream both in dma and in irq modes. Report the error and
abort the transfer in either cases.
Signed-off-by: Alain Volmat
Link: https://lore.kernel.org/r/1612551572-495-9-git-send-email-alain.volmat@foss.st.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 326aaaa472c94a84a5b9da128039417041ee9270
Author: Oliver O'Halloran
Date: Tue Nov 3 15:35:06 2020 +1100
powerpc/pci: Add ppc\_md.discover\_phbs()
[ Upstream commit 5537fcb319d016ce387f818dd774179bc03217f5 ]
On many powerpc platforms the discovery and initalisation of
pci\_controllers (PHBs) happens inside of setup\_arch(). This is very early
in boot (pre-initcalls) and means that we're initialising the PHB long
before many basic kernel services (slab allocator, debugfs, a real ioremap)
are available.
On PowerNV this causes an additional problem since we map the PHB registers
with ioremap(). As of commit d538aadc2718 ("powerpc/ioremap: warn on early
use of ioremap()") a warning is printed because we're using the "incorrect"
API to setup and MMIO mapping in searly boot. The kernel does provide
early\_ioremap(), but that is not intended to create long-lived MMIO
mappings and a seperate warning is printed by generic code if
early\_ioremap() mappings are "leaked."
This is all fixable with dumb hacks like using early\_ioremap() to setup
the initial mapping then replacing it with a real ioremap later on in
boot, but it does raise the question: Why the hell are we setting up the
PHB's this early in boot?
The old and wise claim it's due to "hysterical rasins." Aside from amused
grapes there doesn't appear to be any real reason to maintain the current
behaviour. Already most of the newer embedded platforms perform PHB
discovery in an arch\_initcall and between the end of setup\_arch() and the
start of initcalls none of the generic kernel code does anything PCI
related. On powerpc scanning PHBs occurs in a subsys\_initcall so it should
be possible to move the PHB discovery to a core, postcore or arch initcall.
This patch adds the ppc\_md.discover\_phbs hook and a core\_initcall stub that
calls it. The core\_initcalls are the earliest to be called so this will
any possibly issues with dependency between initcalls. This isn't just an
academic issue either since on pseries and PowerNV EEH init occurs in an
arch\_initcall and depends on the pci\_controllers being available, similarly
the creation of pci\_dns occurs at core\_initcall\_sync (i.e. between core and
postcore initcalls). These problems need to be addressed seperately.
Reported-by: kernel test robot
Signed-off-by: Oliver O'Halloran
[mpe: Make discover\_phbs() static]
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20201103043523.916109-1-oohall@gmail.com
Signed-off-by: Sasha Levin
commit aa4e53a7c90ef7f53a8acc8389480e2a985bd431
Author: Lubomir Rintel
Date: Tue Jan 26 08:37:38 2021 +0100
Platform: OLPC: Fix probe error handling
[ Upstream commit cec551ea0d41c679ed11d758e1a386e20285b29d ]
Reset ec\_priv if probe ends unsuccessfully.
Signed-off-by: Lubomir Rintel
Link: https://lore.kernel.org/r/20210126073740.10232-2-lkundrak@v3.sk
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 02dcad5adca9ee88254ad52000fc6b1e83ed69fd
Author: Pan Bian
Date: Wed Jan 20 20:50:05 2021 -0800
platform/x86: amd-pmc: put device on error paths
[ Upstream commit 745ed17a04f966406c8c27c8f992544336c06013 ]
Put the PCI device rdev on error paths to fix potential reference count
leaks.
Signed-off-by: Pan Bian
Link: https://lore.kernel.org/r/20210121045005.73342-1-bianpan2016@163.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 9535025c428cb6cb33ed6549340622d86eaf5581
Author: Jeremy Linton
Date: Tue Jan 19 18:04:06 2021 -0600
mmc: sdhci-iproc: Add ACPI bindings for the RPi
[ Upstream commit 4f9833d3ec8da34861cd0680b00c73e653877eb9 ]
The RPi4 has an Arasan controller it carries over from the RPi3 and a newer
eMMC2 controller. Because of a couple of quirks, it seems wiser to bind
these controllers to the same driver that DT is using on this platform
rather than the generic sdhci\_acpi driver with PNP0D40.
So, BCM2847 describes the older Arasan and BRCME88C describes the newer
eMMC2. The older Arasan is reusing an existing ACPI \_HID used by other OSes
booting these tables on the RPi.
With this change, Linux is capable of utilizing the SD card slot, and the
Wi-Fi when booted with UEFI+ACPI on the RPi4.
Signed-off-by: Jeremy Linton
Acked-by: Florian Fainelli
Link: https://lore.kernel.org/r/20210120000406.1843400-2-jeremy.linton@arm.com
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit cc98f74c9be1affd687936d5ecd5057b66759472
Author: Chaotian Jing
Date: Fri Dec 18 15:16:11 2020 +0800
mmc: mediatek: fix race condition between msdc\_request\_timeout and irq
[ Upstream commit 0354ca6edd464a2cf332f390581977b8699ed081 ]
when get request SW timeout, if CMD/DAT xfer done irq coming right now,
then there is race between the msdc\_request\_timeout work and irq handler,
and the host->cmd and host->data may set to NULL in irq handler. also,
current flow ensure that only one path can go to msdc\_request\_done(), so
no need check the return value of cancel\_delayed\_work().
Signed-off-by: Chaotian Jing
Link: https://lore.kernel.org/r/20201218071611.12276-1-chaotian.jing@mediatek.com
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit 697f819dd81ce9476581d816537440e1532e92fd
Author: Christophe JAILLET
Date: Tue Dec 8 21:35:27 2020 +0100
mmc: mxs-mmc: Fix a resource leak in an error handling path in 'mxs\_mmc\_probe()'
[ Upstream commit 0bb7e560f821c7770973a94e346654c4bdccd42c ]
If 'mmc\_of\_parse()' fails, we must undo the previous 'dma\_request\_chan()'
call.
Signed-off-by: Christophe JAILLET
Link: https://lore.kernel.org/r/20201208203527.49262-1-christophe.jaillet@wanadoo.fr
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit 85269a7cda5d6c29dfbcc7222f01c85dc3642938
Author: Lu Baolu
Date: Tue Jan 26 16:07:29 2021 +0800
iommu/vt-d: Clear PRQ overflow only when PRQ is empty
[ Upstream commit 28a77185f1cd0650b664f54614143aaaa3a7a615 ]
It is incorrect to always clear PRO when it's set w/o first checking
whether the overflow condition has been cleared. Current code assumes
that if an overflow condition occurs it must have been cleared by earlier
loop. However since the code runs in a threaded context, the overflow
condition could occur even after setting the head to the tail under some
extreme condition. To be sane, we should read both head/tail again when
seeing a pending PRO and only clear PRO after all pending PRs have been
handled.
Suggested-by: Kevin Tian
Signed-off-by: Lu Baolu
Link: https://lore.kernel.org/linux-iommu/MWHPR11MB18862D2EA5BD432BF22D99A48CA09@MWHPR11MB1886.namprd11.prod.outlook.com/
Link: https://lore.kernel.org/r/20210126080730.2232859-2-baolu.lu@linux.intel.com
Signed-off-by: Joerg Roedel
Signed-off-by: Sasha Levin
commit f72672c290b4c5521c1b09d266c7666f43a6f03d
Author: Steven J. Magnani
Date: Thu Jan 7 17:41:16 2021 -0600
udf: fix silent AED tagLocation corruption
[ Upstream commit 63c9e47a1642fc817654a1bc18a6ec4bbcc0f056 ]
When extending a file, udf\_do\_extend\_file() may enter following empty
indirect extent. At the end of udf\_do\_extend\_file() we revert prev\_epos
to point to the last written extent. However if we end up not adding any
further extent in udf\_do\_extend\_file(), the reverting points prev\_epos
into the header area of the AED and following updates of the extents
(in udf\_update\_extents()) will corrupt the header.
Make sure that we do not follow indirect extent if we are not going to
add any more extents so that returning back to the last written extent
works correctly.
Link: https://lore.kernel.org/r/20210107234116.6190-2-magnani@ieee.org
Signed-off-by: Steven J. Magnani
Signed-off-by: Jan Kara
Signed-off-by: Sasha Levin
commit 69c732112b069c3fa8d8e5ee697d7a471be2c0fc
Author: Can Guo
Date: Wed Jan 20 02:04:21 2021 -0800
scsi: ufs: Protect some contexts from unexpected clock scaling
[ Upstream commit 0e9d4ca43ba8112821397f56a26d20682001c011 ]
In contexts like suspend, shutdown, and error handling we need to
suspend devfreq to make sure these contexts won't be disturbed by
clock scaling. However, suspending devfreq is not enough since users
can still trigger a clock scaling by manipulating the devfreq sysfs
nodes like min/max\_freq and governor even after devfreq is
suspended. Moreover, mere suspending devfreq cannot synchroinze a
clock scaling which has already been invoked through these sysfs
nodes. Add one more flag in struct clk\_scaling and wrap the entire
func ufshcd\_devfreq\_scale() with the clk\_scaling\_lock, so that we can
use this flag and clk\_scaling\_lock to control and synchronize clock
scaling invoked through devfreq sysfs nodes.
Link: https://lore.kernel.org/r/1611137065-14266-2-git-send-email-cang@codeaurora.org
Reviewed-by: Stanley Chu
Signed-off-by: Can Guo
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit a35887ef14630fa3eaef600fa35aab217b19a45d
Author: Jaegeuk Kim
Date: Mon Jan 11 01:59:27 2021 -0800
scsi: ufs: WB is only available on LUN #0 to #7
[ Upstream commit a2fca52ee640a04112ed9d9a137c940ea6ad288e ]
Kernel stack violation when getting unit\_descriptor/wb\_buf\_alloc\_units from
rpmb LUN. The reason is that the unit descriptor length is different per
LU.
The length of Normal LU is 45 while the one of rpmb LU is 35.
int ufshcd\_read\_desc\_param(struct ufs\_hba \*hba, ...)
{
param\_offset=41;
param\_size=4;
buff\_len=45;
...
buff\_len=35 by rpmb LU;
if (is\_kmalloc) {
/\* Make sure we don't copy more data than available \*/
if (param\_offset + param\_size > buff\_len)
param\_size = buff\_len - param\_offset;
--> param\_size = 250;
memcpy(param\_read\_buf, &desc\_buf[param\_offset], param\_size);
--> memcpy(param\_read\_buf, desc\_buf+41, 250);
[ 141.868974][ T9174] Kernel panic - not syncing: stack-protector: Kernel stack is corrupted in: wb\_buf\_alloc\_units\_show+0x11c/0x11c
}
}
Link: https://lore.kernel.org/r/20210111095927.1830311-1-jaegeuk@kernel.org
Reviewed-by: Avri Altman
Signed-off-by: Jaegeuk Kim
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 8fc2b8ddc086cd1cb05f4e3f5af1d518782417f6
Author: akshatzen
Date: Sat Jan 9 18:08:45 2021 +0530
scsi: pm80xx: Fix missing tag\_free in NVMD DATA req
[ Upstream commit 5d28026891c7041deec08cc5ddd8f3abd90195e1 ]
Tag was not freed in NVMD get/set data request failure scenario. This
caused a tag leak each time a request failed.
Link: https://lore.kernel.org/r/20210109123849.17098-5-Viswas.G@microchip.com
Acked-by: Jack Wang
Signed-off-by: akshatzen
Signed-off-by: Viswas G
Signed-off-by: Ruksar Devadi
Signed-off-by: Radha Ramachandran
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 3e635b8184700132a9d96b9a0febbcdfa3e4a44b
Author: Wolfram Sang
Date: Wed Dec 23 18:21:52 2020 +0100
i2c: rcar: optimize cacheline to minimize HW race condition
[ Upstream commit 25c2e0fb5fefb8d7847214cf114d94c7aad8e9ce ]
'flags' and 'io' are needed first, so they should be at the beginning of
the private struct.
Signed-off-by: Wolfram Sang
Reviewed-by: Niklas Söderlund
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 131ccd1c676b9400094f845448307951b78b07f6
Author: Wolfram Sang
Date: Wed Dec 23 18:21:51 2020 +0100
i2c: rcar: faster irq code to minimize HW race condition
[ Upstream commit c7b514ec979e23a08c411f3d8ed39c7922751422 ]
To avoid the HW race condition on R-Car Gen2 and earlier, we need to
write to ICMCR as soon as possible in the interrupt handler. We can
improve this by writing a static value instead of masking out bits.
Signed-off-by: Wolfram Sang
Reviewed-by: Niklas Söderlund
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 8a2d54228d5a3904fc3653ee306743e74ec1f7d2
Author: Florian Westphal
Date: Thu Mar 4 13:32:08 2021 -0800
mptcp: reset last\_snd on subflow close
[ Upstream commit e0be4931f3fee2e04dec4013ea4f27ec2db8556f ]
Send logic caches last active subflow in the msk, so it needs to be
cleared when the cached subflow is closed.
Fixes: d5f49190def61c ("mptcp: allow picking different xmit subflows")
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/155
Reported-by: Christoph Paasch
Acked-by: Paolo Abeni
Reviewed-by: Matthieu Baerts
Signed-off-by: Florian Westphal
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 862e90a3eeda09afe4aab65fc3b1356534628258
Author: Paolo Abeni
Date: Wed Jan 20 15:39:10 2021 +0100
mptcp: always graft subflow socket to parent
[ Upstream commit 866f26f2a9c33bc70eb0f07ffc37fd9424ffe501 ]
Currently, incoming subflows link to the parent socket,
while outgoing ones link to a per subflow socket. The latter
is not really needed, except at the initial connect() time and
for the first subflow.
Always graft the outgoing subflow to the parent socket and
free the unneeded ones early.
This allows some code cleanup, reduces the amount of memory
used and will simplify the next patch
Reviewed-by: Mat Martineau
Signed-off-by: Paolo Abeni
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit f4d509c9978c586161e262481bc9ae59906bd706
Author: Thomas Bogendoerfer
Date: Mon Mar 8 10:24:47 2021 +0100
MIPS: kernel: Reserve exception base early to prevent corruption
[ Upstream commit bd67b711bfaa02cf19e88aa2d9edae5c1c1d2739 ]
BMIPS is one of the few platforms that do change the exception base.
After commit 2dcb39645441 ("memblock: do not start bottom-up allocations
with kernel\_end") we started seeing BMIPS boards fail to boot with the
built-in FDT being corrupted.
Before the cited commit, early allocations would be in the [kernel\_end,
RAM\_END] range, but after commit they would be within [RAM\_START +
PAGE\_SIZE, RAM\_END].
The custom exception base handler that is installed by
bmips\_ebase\_setup() done for BMIPS5000 CPUs ends-up trampling on the
memory region allocated by unflatten\_and\_copy\_device\_tree() thus
corrupting the FDT used by the kernel.
To fix this, we need to perform an early reservation of the custom
exception space. Additional we reserve the first 4k (1k for R3k) for
either normal exception vector space (legacy CPUs) or special vectors
like cache exceptions.
Huge thanks to Serge for analysing and proposing a solution to this
issue.
Fixes: 2dcb39645441 ("memblock: do not start bottom-up allocations with kernel\_end")
Reported-by: Kamal Dasu
Debugged-by: Serge Semin
Acked-by: Mike Rapoport
Tested-by: Florian Fainelli
Reviewed-by: Serge Semin
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Sasha Levin
commit d7452e9c026d05a62e77adee88f962240c4a9087
Author: Hans Verkuil
Date: Fri Feb 26 11:37:47 2021 +0100
media: rc: compile rc-cec.c into rc-core
commit f09f9f93afad770a04b35235a0aa465fcc8d6e3d upstream.
The rc-cec keymap is unusual in that it can't be built as a module,
instead it is registered directly in rc-main.c if CONFIG\_MEDIA\_CEC\_RC
is set. This is because it can be called from drm\_dp\_cec\_set\_edid() via
cec\_register\_adapter() in an asynchronous context, and it is not
allowed to use request\_module() to load rc-cec.ko in that case. Trying to
do so results in a 'WARN\_ON\_ONCE(wait && current\_is\_async())'.
Since this keymap is only used if CONFIG\_MEDIA\_CEC\_RC is set, we
just compile this keymap into the rc-core module and never as a
separate module.
Signed-off-by: Hans Verkuil
Fixes: 2c6d1fffa1d9 (drm: add support for DisplayPort CEC-Tunneling-over-AUX)
Reported-by: Hans de Goede
Signed-off-by: Sean Young
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 0ff5612a81f31fbf4c87757cf7d052575ab84454
Author: Biju Das
Date: Mon Mar 1 13:08:27 2021 +0100
media: v4l: vsp1: Fix bru null pointer access
commit ac8d82f586c8692b501cb974604a71ef0e22a04c upstream.
RZ/G2L SoC has only BRS. This patch fixes null pointer access,when only
BRS is enabled.
Fixes: cbb7fa49c7466("media: v4l: vsp1: Rename BRU to BRx")
Signed-off-by: Biju Das
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 3ab804278382f6b118f260446b23e5ae684e59c8
Author: Biju Das
Date: Mon Mar 1 13:08:28 2021 +0100
media: v4l: vsp1: Fix uif null pointer access
commit 6732f313938027a910e1f7351951ff52c0329e70 upstream.
RZ/G2L SoC has no UIF. This patch fixes null pointer access, when UIF
module is not used.
Fixes: 5e824f989e6e8("media: v4l: vsp1: Integrate DISCOM in display pipeline")
Signed-off-by: Biju Das
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 0c2b5e1a5cb487d20214849d6ea75afdbcea1953
Author: Dafna Hirschfeld
Date: Mon Mar 1 18:18:35 2021 +0100
media: rkisp1: params: fix wrong bits settings
commit 2025a48cfd92d541c5ee47deee97f8a46d00c4ac upstream.
The histogram mode is set using 'rkisp1\_params\_set\_bits'.
Only the bits of the mode should be the value argument for
that function. Otherwise bits outside the mode mask are
turned on which is not what was intended.
Fixes: bae1155cf579 ("media: staging: rkisp1: add output device for parameters")
Signed-off-by: Dafna Hirschfeld
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit a678d679c17e26ea9109c1f4f2f0d36d23474788
Author: Maxim Mikityanskiy
Date: Fri Feb 5 23:51:39 2021 +0100
media: usbtv: Fix deadlock on suspend
commit 8a7e27fd5cd696ba564a3f62cedef7269cfd0723 upstream.
usbtv doesn't support power management, so on system suspend the
.disconnect callback of the driver is called. The teardown sequence
includes a call to snd\_card\_free. Its implementation waits until the
refcount of the sound card device drops to zero, however, if its file is
open, snd\_card\_file\_add takes a reference, which can't be dropped during
the suspend, because the userspace processes are already frozen at this
point. snd\_card\_free waits for completion forever, leading to a hang on
suspend.
This commit fixes this deadlock condition by replacing snd\_card\_free
with snd\_card\_free\_when\_closed, that doesn't wait until all references
are released, allowing suspend to progress.
Fixes: 63ddf68de52e ("[media] usbtv: add audio support")
Signed-off-by: Maxim Mikityanskiy
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 6b8f84ceb4fcce63fe8ce879c517f143eee6195f
Author: Sergey Shtylyov
Date: Sun Feb 28 23:27:32 2021 +0300
sh\_eth: fix TRSCER mask for R7S9210
commit 165bc5a4f30eee4735845aa7dbd6b738643f2603 upstream.
According to the RZ/A2M Group User's Manual: Hardware, Rev. 2.00,
the TRSCER register has bit 9 reserved, hence we can't use the driver's
default TRSCER mask. Add the explicit initializer for sh\_eth\_cpu\_data::
trscer\_err\_mask for R7S9210.
Fixes: 6e0bb04d0e4f ("sh\_eth: Add R7S9210 support")
Signed-off-by: Sergey Shtylyov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e90d53746d66f58eb5a99cdd499d113d95ae2513
Author: Colin Ian King
Date: Thu Mar 4 09:49:28 2021 +0000
qxl: Fix uninitialised struct field head.surface\_id
commit 738acd49eb018feb873e0fac8f9517493f6ce2c7 upstream.
The surface\_id struct field in head is not being initialized and
static analysis warns that this is being passed through to
dev->monitors\_config->heads[i] on an assignment. Clear up this
warning by initializing it to zero.
Addresses-Coverity: ("Uninitialized scalar variable")
Fixes: a6d3c4d79822 ("qxl: hook monitors\_config updates into crtc, not encoder.")
Signed-off-by: Colin Ian King
Link: http://patchwork.freedesktop.org/patch/msgid/20210304094928.2280722-1-colin.king@canonical.com
Signed-off-by: Gerd Hoffmann
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit 0a269eb9979ee6aa46de507f962949bc8ad6c7ec
Author: Wang Qing
Date: Mon Mar 1 20:08:21 2021 +0800
s390/crypto: return -EFAULT if copy\_to\_user() fails
commit 942df4be7ab40195e2a839e9de81951a5862bc5b upstream.
The copy\_to\_user() function returns the number of bytes remaining to be
copied, but we want to return -EFAULT if the copy doesn't complete.
Fixes: e06670c5fe3b ("s390: vfio-ap: implement VFIO\_DEVICE\_GET\_INFO ioctl")
Signed-off-by: Wang Qing
Reviewed-by: Tony Krowiak
Signed-off-by: Heiko Carstens
Link: https://lore.kernel.org/r/1614600502-16714-1-git-send-email-wangqing@vivo.com
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 8c64644d3db2767661ff38a31fa3b900e4154de5
Author: Eric Farman
Date: Mon Mar 1 19:33:24 2021 +0100
s390/cio: return -EFAULT if copy\_to\_user() fails
commit d9c48a948d29bcb22f4fe61a81b718ef6de561a0 upstream.
Fixes: 120e214e504f ("vfio: ccw: realize VFIO\_DEVICE\_G(S)ET\_IRQ\_INFO ioctls")
Signed-off-by: Eric Farman
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit bc8ceb4724afac4191fecbac87f2a7f3539444f9
Author: Tvrtko Ursulin
Date: Tue Mar 2 11:42:13 2021 +0000
drm/i915: Wedge the GPU if command parser setup fails
commit a829f033e966d5e4aa27c3ef2b381f51734e4a7f upstream.
Commit 311a50e76a33 ("drm/i915: Add support for mandatory cmdparsing")
introduced mandatory command parsing but setup failures were not
translated into wedging the GPU which was probably the intent.
Possible errors come in two categories. Either the sanity check on
internal tables has failed, which should be caught in CI unless an
affected platform would be missed in testing; or memory allocation failure
happened during driver load, which should be extremely unlikely but for
correctness should still be handled.
v2:
\* Tidy coding style. (Chris)
[airlied: cherry-picked to avoid rc1 base]
Signed-off-by: Tvrtko Ursulin
Fixes: 311a50e76a33 ("drm/i915: Add support for mandatory cmdparsing")
Cc: Jon Bloomfield
Cc: Joonas Lahtinen
Cc: Chris Wilson
Reviewed-by: Chris Wilson
Link: https://patchwork.freedesktop.org/patch/msgid/20210302114213.1102223-1-tvrtko.ursulin@linux.intel.com
(cherry picked from commit 5a1a659762d35a6dc51047c9127c011303c77b7f)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 6936a61a317df41e527687de541e089a40c1d4ad
Author: Noralf Trønnes
Date: Fri Feb 19 13:22:03 2021 +0100
drm/shmem-helpers: vunmap: Don't put pages for dma-buf
commit 64e194e278673bceb68fb2dde7dbc3d812bfceb3 upstream.
dma-buf importing was reworked in commit 7d2cd72a9aa3
("drm/shmem-helpers: Simplify dma-buf importing"). Before that commit
drm\_gem\_shmem\_prime\_import\_sg\_table() did set ->pages\_use\_count=1 and
drm\_gem\_shmem\_vunmap\_locked() could call drm\_gem\_shmem\_put\_pages()
unconditionally. Now without the use count set, put pages is called also
on dma-bufs. Fix this by only putting pages if it's not imported.
Signed-off-by: Noralf Trønnes
Fixes: 7d2cd72a9aa3 ("drm/shmem-helpers: Simplify dma-buf importing")
Cc: Daniel Vetter
Cc: Thomas Zimmermann
Acked-by: Thomas Zimmermann
Tested-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20210219122203.51130-1-noralf@tronnes.org
(cherry picked from commit cdea72518a2b38207146e92e1c9e2fac15975679)
Signed-off-by: Thomas Zimmermann
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit cef14d5d92f14a6e282c3216c2da63e05f14758a
Author: Artem Lapkin
Date: Tue Mar 2 12:22:02 2021 +0800
drm: meson\_drv add shutdown function
commit fa0c16caf3d73ab4d2e5d6fa2ef2394dbec91791 upstream.
Problem: random stucks on reboot stage about 1/20 stuck/reboots
// debug kernel log
[ 4.496660] reboot: kernel restart prepare CMD:(null)
[ 4.498114] meson\_ee\_pwrc c883c000.system-controller:power-controller: shutdown begin
[ 4.503949] meson\_ee\_pwrc c883c000.system-controller:power-controller: shutdown domain 0:VPU...
...STUCK...
Solution: add shutdown function to meson\_drm driver
// debug kernel log
[ 5.231896] reboot: kernel restart prepare CMD:(null)
[ 5.246135] [drm:meson\_drv\_shutdown]
...
[ 5.259271] meson\_ee\_pwrc c883c000.system-controller:power-controller: shutdown begin
[ 5.274688] meson\_ee\_pwrc c883c000.system-controller:power-controller: shutdown domain 0:VPU...
[ 5.338331] reboot: Restarting system
[ 5.358293] psci: PSCI\_0\_2\_FN\_SYSTEM\_RESET reboot\_mode:0 cmd:(null)
bl31 reboot reason: 0xd
bl31 reboot reason: 0x0
system cmd 1.
...REBOOT...
Tested: on VIM1 VIM2 VIM3 VIM3L khadas sbcs - 1000+ successful reboots
and Odroid boards, WeTek Play2 (GXBB)
Fixes: bbbe775ec5b5 ("drm: Add support for Amlogic Meson Graphic Controller")
Signed-off-by: Artem Lapkin
Tested-by: Christian Hewitt
Acked-by: Neil Armstrong
Acked-by: Kevin Hilman
Signed-off-by: Neil Armstrong
Link: https://patchwork.freedesktop.org/patch/msgid/20210302042202.3728113-1-art@khadas.com
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit 084b4f3304f923e39e64216a818a8bbf398dd896
Author: Alex Deucher
Date: Tue Mar 9 22:58:47 2021 -0500
drm/amdgpu: fix S0ix handling when the CONFIG\_AMD\_PMC=m
commit a5cb3c1a36376c25cd25fd3e99918dc48ac420bb upstream.
Need to check the module variant as well.
Acked-by: Prike Liang
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 24753adb30536889f2a3076caa7ce957106591ba
Author: Thomas Zimmermann
Date: Wed Mar 3 14:32:29 2021 +0100
drm: Use USB controller's DMA mask when importing dmabufs
commit 659ab7a49cbebe0deffcbe1f9560e82006b21817 upstream.
USB devices cannot perform DMA and hence have no dma\_mask set in their
device structure. Therefore importing dmabuf into a USB-based driver
fails, which breaks joining and mirroring of display in X11.
For USB devices, pick the associated USB controller as attachment device.
This allows the DRM import helpers to perform the DMA setup. If the DMA
controller does not support DMA transfers, we're out of luck and cannot
import. Our current USB-based DRM drivers don't use DMA, so the actual
DMA device is not important.
Tested by joining/mirroring displays of udl and radeon under Gnome/X11.
v8:
\* release dmadev if device initialization fails (Noralf)
\* fix commit description (Noralf)
v7:
\* fix use-before-init bug in gm12u320 (Dan)
v6:
\* implement workaround in DRM drivers and hold reference to
DMA device while USB device is in use
\* remove dev\_is\_usb() (Greg)
\* collapse USB helper into usb\_intf\_get\_dma\_device() (Alan)
\* integrate Daniel's TODO statement (Daniel)
\* fix typos (Greg)
v5:
\* provide a helper for USB interfaces (Alan)
\* add FIXME item to documentation and TODO list (Daniel)
v4:
\* implement workaround with USB helper functions (Greg)
\* use struct usb\_device->bus->sysdev as DMA device (Takashi)
v3:
\* drop gem\_create\_object
\* use DMA mask of USB controller, if any (Daniel, Christian, Noralf)
v2:
\* move fix to importer side (Christian, Daniel)
\* update SHMEM and CMA helpers for new PRIME callbacks
Signed-off-by: Thomas Zimmermann
Fixes: 6eb0233ec2d0 ("usb: don't inherity DMA properties for USB devices")
Tested-by: Pavel Machek
Reviewed-by: Greg Kroah-Hartman
Acked-by: Christian König
Acked-by: Daniel Vetter
Acked-by: Noralf Trønnes
Cc: Christoph Hellwig
Cc: Greg Kroah-Hartman
Cc:  # v5.10+
Signed-off-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20210303133229.3288-1-tzimmermann@suse.de
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit 3923eefd32e36ada97974b9130858d9b39d03752
Author: Neil Roberts
Date: Tue Feb 23 16:51:25 2021 +0100
drm/shmem-helper: Don't remove the offset in vm\_area\_struct pgoff
commit 11d5a4745e00e73745774671dbf2fb07bd6e2363 upstream.
When mmapping the shmem, it would previously adjust the pgoff in the
vm\_area\_struct to remove the fake offset that is added to be able to
identify the buffer. This patch removes the adjustment and makes the
fault handler use the vm\_fault address to calculate the page offset
instead. Although using this address is apparently discouraged, several
DRM drivers seem to be doing it anyway.
The problem with removing the pgoff is that it prevents
drm\_vma\_node\_unmap from working because that searches the mapping tree
by address. That doesn't work because all of the mappings are at offset
0. drm\_vma\_node\_unmap is being used by the shmem helpers when purging
the buffer.
This fixes a bug in Panfrost which is using drm\_gem\_shmem\_purge. Without
this the mapping for the purged buffer can still be accessed which might
mean it would access random pages from other buffers
v2: Don't check whether the unsigned page\_offset is less than 0.
Cc: stable@vger.kernel.org
Fixes: 17acb9f35ed7 ("drm/shmem: Add madvise state and purge helpers")
Signed-off-by: Neil Roberts
Reviewed-by: Steven Price
Signed-off-by: Steven Price
Link: https://patchwork.freedesktop.org/patch/msgid/20210223155125.199577-3-nroberts@igalia.com
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit 11c708e69bedd1a03db5a6c25e0e59505ee0a722
Author: Neil Roberts
Date: Tue Feb 23 16:51:24 2021 +0100
drm/shmem-helper: Check for purged buffers in fault handler
commit d611b4a0907cece060699f2fd347c492451cd2aa upstream.
When a buffer is madvised as not needed and then purged, any attempts to
access the buffer from user-space should cause a bus fault. This patch
adds a check for that.
Cc: stable@vger.kernel.org
Fixes: 17acb9f35ed7 ("drm/shmem: Add madvise state and purge helpers")
Signed-off-by: Neil Roberts
Reviewed-by: Steven Price
Signed-off-by: Steven Price
Link: https://patchwork.freedesktop.org/patch/msgid/20210223155125.199577-2-nroberts@igalia.com
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit e238a59c46bd51d61155e6a1f6a798738e3bd6bb
Author: Alex Deucher
Date: Thu Dec 10 01:45:12 2020 -0500
drm/amdgpu/display: handle aux backlight in backlight\_get\_brightness
commit 0ad3e64eb46d8c47de3af552e282894e3893e973 upstream.
Need to fetch it via aux.
Reviewed-by: Nicholas Kazlauskas
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 7c39e084afb0bde83edda80bf1f73d7d9694bf9e
Author: Alex Deucher
Date: Thu Dec 10 01:20:08 2020 -0500
drm/amdgpu/display: don't assert in set backlight function
commit dfd8b7fbd985ec1cf76fe10f2875a50b10833740 upstream.
It just spams the logs.
Reviewed-by: Nicholas Kazlauskas
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit dcddebbb8e6bd61e0d37ec54464ed2d39e9653ec
Author: Alex Deucher
Date: Thu Dec 10 01:18:40 2020 -0500
drm/amdgpu/display: simplify backlight setting
commit a2f8d988698d7d3645b045f4940415b045140b81 upstream.
Avoid the extra wrapper function.
Reviewed-by: Nicholas Kazlauskas
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 216158fc01ebb47a3525f538fcc7b7c2dcc85ff0
Author: Kenneth Feng
Date: Tue Mar 9 21:10:16 2021 +0800
drm/amd/pm: bug fix for pcie dpm
commit 50ceb1fe7acd50831180f4b5597bf7b39e8059c8 upstream.
Currently the pcie dpm has two problems.
1. Only the high dpm level speed/width can be overrided
if the requested values are out of the pcie capability.
2. The high dpm level is always overrided though sometimes
it's not necesarry.
Signed-off-by: Kenneth Feng
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 50ffbd09dfb6bb4a9f283c0cdb0a5dd9e99dde57
Author: Evan Quan
Date: Fri Mar 5 14:21:26 2021 +0800
drm/amd/pm: correct the watermark settings for Polaris
commit 48123d068fcb584838ce29912660c5e9490bad0e upstream.
The "/ 10" should be applied to the right-hand operand instead of
the left-hand one.
Signed-off-by: Evan Quan
Noticed-by: Georgios Toptsidis
Reviewed-by: Feifei Xu
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit fc24cc8868a1be2819e8958c1bbaa6c51bb88efc
Author: Holger Hoffstätte
Date: Fri Mar 5 12:39:21 2021 +0100
drm/amd/display: Fix nested FPU context in dcn21\_validate\_bandwidth()
commit 15e8b95d5f7509e0b09289be8c422c459c9f0412 upstream.
Commit 41401ac67791 added FPU wrappers to dcn21\_validate\_bandwidth(),
which was correct. Unfortunately a nested function alredy contained
DC\_FP\_START()/DC\_FP\_END() calls, which results in nested FPU context
enter/exit and complaints by kernel\_fpu\_begin\_mask().
This can be observed e.g. with 5.10.20, which backported 41401ac67791
and now emits the following warning on boot:
WARNING: CPU: 6 PID: 858 at arch/x86/kernel/fpu/core.c:129 kernel\_fpu\_begin\_mask+0xa5/0xc0
Call Trace:
dcn21\_calculate\_wm+0x47/0xa90 [amdgpu]
dcn21\_validate\_bandwidth\_fp+0x15d/0x2b0 [amdgpu]
dcn21\_validate\_bandwidth+0x29/0x40 [amdgpu]
dc\_validate\_global\_state+0x3c7/0x4c0 [amdgpu]
The warning is emitted due to the additional DC\_FP\_START/END calls in
patch\_bounding\_box(), which is inlined into dcn21\_calculate\_wm(),
its only caller. Removing the calls brings the code in line with
dcn20 and makes the warning disappear.
Fixes: 41401ac67791 ("drm/amd/display: Add FPU wrappers to dcn21\_validate\_bandwidth()")
Signed-off-by: Holger Hoffstätte
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 4290476449535da46bbe7ac865c0fafa06ee17fd
Author: Holger Hoffstätte
Date: Fri Mar 5 15:23:18 2021 +0100
drm/amdgpu/display: use GFP\_ATOMIC in dcn21\_validate\_bandwidth\_fp()
commit 680174cfd1e1cea70a8f30ccb44d8fbdf996018e upstream.
After fixing nested FPU contexts caused by 41401ac67791 we're still seeing
complaints about spurious kernel\_fpu\_end(). As it turns out this was
already fixed for dcn20 in commit f41ed88cbd ("drm/amdgpu/display:
use GFP\_ATOMIC in dcn20\_validate\_bandwidth\_internal") but never moved
forward to dcn21.
Signed-off-by: Holger Hoffstätte
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 78122c730749460de4378983af5e292e46bc7fe3
Author: Takashi Iwai
Date: Wed Feb 3 13:42:41 2021 +0100
drm/amd/display: Add a backlight module option
commit 7a46f05e5e163c00e41892e671294286e53fe15c upstream.
There seem devices that don't work with the aux channel backlight
control. For allowing such users to test with the other backlight
control method, provide a new module option, aux\_backlight, to specify
enabling or disabling the aux backport support explicitly. As
default, the aux support is detected by the hardware capability.
v2: make the backlight option generic in case we add future
backlight types (Alex)
BugLink: https://bugzilla.opensuse.org/show\_bug.cgi?id=1180749
BugLink: https://gitlab.freedesktop.org/drm/amd/-/issues/1438
Reviewed-by: Nicholas Kazlauskas
Signed-off-by: Takashi Iwai
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 90da35d821f527b2d0082d12a532ce8146be70e8
Author: Christian König
Date: Mon Mar 8 19:35:14 2021 +0100
drm/radeon: also init GEM funcs in radeon\_gem\_prime\_import\_sg\_table
commit a25955ba123499d7db520175c6be59c29f9215e3 upstream.
Otherwise we will run into a NULL ptr deref.
Signed-off-by: Christian König
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=212137
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 5.11.x
Signed-off-by: Greg Kroah-Hartman
commit da27b6b41f12c9550342bd47bc576ce518f87cb9
Author: Daniel Vetter
Date: Mon Feb 22 11:06:43 2021 +0100
drm/compat: Clear bounce structures
commit de066e116306baf3a6a62691ac63cfc0b1dabddb upstream.
Some of them have gaps, or fields we don't clear. Native ioctl code
does full copies plus zero-extends on size mismatch, so nothing can
leak. But compat is more hand-rolled so need to be careful.
None of these matter for performance, so just memset.
Also I didn't fix up the CONFIG\_DRM\_LEGACY or CONFIG\_DRM\_AGP ioctl, those
are security holes anyway.
Acked-by: Maxime Ripard
Reported-by: syzbot+620cf21140fc7e772a5d@syzkaller.appspotmail.com # vblank ioctl
Cc: syzbot+620cf21140fc7e772a5d@syzkaller.appspotmail.com
Cc: stable@vger.kernel.org
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20210222100643.400935-1-daniel.vetter@ffwll.ch
(cherry picked from commit e926c474ebee404441c838d18224cd6f246a71b7)
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit b1d21391595bd4366907bba050cabe216108d820
Author: Tong Zhang
Date: Sat Feb 27 23:46:25 2021 -0500
drm/fb-helper: only unmap if buffer not null
commit 874a52f9b693ed8bf7a92b3592a547ce8a684e6f upstream.
drm\_fbdev\_cleanup() can be called when fb\_helper->buffer is null, hence
fb\_helper->buffer should be checked before calling
drm\_client\_buffer\_vunmap(). This buffer is also checked in
drm\_client\_framebuffer\_delete(), so we should also do the same thing for
drm\_client\_buffer\_vunmap().
[ 199.128742] RIP: 0010:drm\_client\_buffer\_vunmap+0xd/0x20
[ 199.129031] Code: 43 18 48 8b 53 20 49 89 45 00 49 89 55 08 5b 44 89 e0 41 5c 41 5d 41 5e 5d
c3 0f 1f 00 53 48 89 fb 48 8d 7f 10 e8 73 7d a1 ff <48> 8b 7b 10 48 8d 73 18 5b e9 75 53 fc ff 0
f 1f 44 00 00 48 b8 00
[ 199.130041] RSP: 0018:ffff888103f3fc88 EFLAGS: 00010282
[ 199.130329] RAX: 0000000000000001 RBX: 0000000000000000 RCX: ffffffff8214d46d
[ 199.130733] RDX: 1ffffffff079c6b9 RSI: 0000000000000246 RDI: ffffffff83ce35c8
[ 199.131119] RBP: ffff888103d25458 R08: 0000000000000001 R09: fffffbfff0791761
[ 199.131505] R10: ffffffff83c8bb07 R11: fffffbfff0791760 R12: 0000000000000000
[ 199.131891] R13: ffff888103d25468 R14: ffff888103d25418 R15: ffff888103f18120
[ 199.132277] FS: 00007f36fdcbb6a0(0000) GS:ffff88815b400000(0000) knlGS:0000000000000000
[ 199.132721] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 199.133033] CR2: 0000000000000010 CR3: 0000000103d26000 CR4: 00000000000006f0
[ 199.133420] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 199.133807] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 199.134195] Call Trace:
[ 199.134333] drm\_fbdev\_cleanup+0x179/0x1a0
[ 199.134562] drm\_fbdev\_client\_unregister+0x2b/0x40
[ 199.134828] drm\_client\_dev\_unregister+0xa8/0x180
[ 199.135088] drm\_dev\_unregister+0x61/0x110
[ 199.135315] mgag200\_pci\_remove+0x38/0x52 [mgag200]
[ 199.135586] pci\_device\_remove+0x62/0xe0
[ 199.135806] device\_release\_driver\_internal+0x148/0x270
[ 199.136094] driver\_detach+0x76/0xe0
[ 199.136294] bus\_remove\_driver+0x7e/0x100
[ 199.136521] pci\_unregister\_driver+0x28/0xf0
[ 199.136759] \_\_x64\_sys\_delete\_module+0x268/0x300
[ 199.137016] ? \_\_ia32\_sys\_delete\_module+0x300/0x300
[ 199.137285] ? call\_rcu+0x3e4/0x580
[ 199.137481] ? fpregs\_assert\_state\_consistent+0x4d/0x60
[ 199.137767] ? exit\_to\_user\_mode\_prepare+0x2f/0x130
[ 199.138037] do\_syscall\_64+0x33/0x40
[ 199.138237] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 199.138517] RIP: 0033:0x7f36fdc3dcf7
Signed-off-by: Tong Zhang
Fixes: 763aea17bf57 ("drm/fb-helper: Unmap client buffer during shutdown")
Cc: Thomas Zimmermann
Cc: Sam Ravnborg
Cc: Maxime Ripard
Cc: Maarten Lankhorst
Cc: David Airlie
Cc: Daniel Vetter
Cc: dri-devel@lists.freedesktop.org
Cc:  # v5.11+
Signed-off-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20210228044625.171151-1-ztong0001@gmail.com
Signed-off-by: Maarten Lankhorst
Signed-off-by: Greg Kroah-Hartman
commit 37f79ab59cef9bbb7b6c3c5ade8fcd3841f524e6
Author: Edwin Peer
Date: Fri Feb 26 04:43:10 2021 -0500
bnxt\_en: reliably allocate IRQ table on reset to avoid crash
commit 20d7d1c5c9b11e9f538ed4a2289be106de970d3e upstream.
The following trace excerpt corresponds with a NULL pointer dereference
of 'bp->irq\_tbl' in bnxt\_setup\_inta() on an Aarch64 system after many
device resets:
Unable to handle kernel NULL pointer dereference at ... 000000d
...
pc : string+0x3c/0x80
lr : vsnprintf+0x294/0x7e0
sp : ffff00000f61ba70 pstate : 20000145
x29: ffff00000f61ba70 x28: 000000000000000d
x27: ffff0000009c8b5a x26: ffff00000f61bb80
x25: ffff0000009c8b5a x24: 0000000000000012
x23: 00000000ffffffe0 x22: ffff000008990428
x21: ffff00000f61bb80 x20: 000000000000000d
x19: 000000000000001f x18: 0000000000000000
x17: 0000000000000000 x16: ffff800b6d0fb400
x15: 0000000000000000 x14: ffff800b7fe31ae8
x13: 00001ed16472c920 x12: ffff000008c6b1c9
x11: ffff000008cf0580 x10: ffff00000f61bb80
x9 : 00000000ffffffd8 x8 : 000000000000000c
x7 : ffff800b684b8000 x6 : 0000000000000000
x5 : 0000000000000065 x4 : 0000000000000001
x3 : ffff0a00ffffff04 x2 : 000000000000001f
x1 : 0000000000000000 x0 : 000000000000000d
Call trace:
string+0x3c/0x80
vsnprintf+0x294/0x7e0
snprintf+0x44/0x50
\_\_bnxt\_open\_nic+0x34c/0x928 [bnxt\_en]
bnxt\_open+0xe8/0x238 [bnxt\_en]
\_\_dev\_open+0xbc/0x130
\_\_dev\_change\_flags+0x12c/0x168
dev\_change\_flags+0x20/0x60
...
Ordinarily, a call to bnxt\_setup\_inta() (not in trace due to inlining)
would not be expected on a system supporting MSIX at all. However, if
bnxt\_init\_int\_mode() does not end up being called after the call to
bnxt\_clear\_int\_mode() in bnxt\_fw\_reset\_close(), then the driver will
think that only INTA is supported and bp->irq\_tbl will be NULL,
causing the above crash.
In the error recovery scenario, we call bnxt\_clear\_int\_mode() in
bnxt\_fw\_reset\_close() early in the sequence. Ordinarily, we will
call bnxt\_init\_int\_mode() in bnxt\_hwrm\_if\_change() after we
reestablish communication with the firmware after reset. However,
if the sequence has to abort before we call bnxt\_init\_int\_mode() and
if the user later attempts to re-open the device, then it will cause
the crash above.
We fix it in 2 ways:
1. Check for bp->irq\_tbl in bnxt\_setup\_int\_mode(). If it is NULL, call
bnxt\_init\_init\_mode().
2. If we need to abort in bnxt\_hwrm\_if\_change() and cannot complete
the error recovery sequence, set the BNXT\_STATE\_ABORT\_ERR flag. This
will cause more drastic recovery at the next attempt to re-open the
device, including a call to bnxt\_init\_int\_mode().
Fixes: 3bc7d4a352ef ("bnxt\_en: Add BNXT\_STATE\_IN\_FW\_RESET state.")
Reviewed-by: Scott Branden
Signed-off-by: Edwin Peer
Signed-off-by: Michael Chan
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 4693548951ed246b2e4ee90fc1f9ec77c9e20c46
Author: Wang Qing
Date: Mon Mar 1 20:01:33 2021 +0800
s390/cio: return -EFAULT if copy\_to\_user() fails again
commit 51c44babdc19aaf882e1213325a0ba291573308f upstream.
The copy\_to\_user() function returns the number of bytes remaining to be
copied, but we want to return -EFAULT if the copy doesn't complete.
Fixes: e01bcdd61320 ("vfio: ccw: realize VFIO\_DEVICE\_GET\_REGION\_INFO ioctl")
Signed-off-by: Wang Qing
Signed-off-by: Heiko Carstens
Link: https://lore.kernel.org/r/1614600093-13992-1-git-send-email-wangqing@vivo.com
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 354b3f64709225674e05d7e0c2515e8451b26737
Author: Jian Shen
Date: Sat Feb 27 15:24:53 2021 +0800
net: hns3: fix bug when calculating the TCAM table info
commit b36fc875bcdee56865c444a2cdae17d354a6d5f5 upstream.
The function hclge\_fd\_convert\_tuple() is used to convert tuples
and tuples mask to TCAM x and y. But it misuses the source mac
as source mac mask when convert INNER\_SRC\_MAC, which may cause
the flow director rule works unexpectedly. So fix it.
Fixes: 117328680288 ("net: hns3: Add input key and action config support for flow director")
Signed-off-by: Jian Shen
Signed-off-by: Huazhong Tan
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 1e6c0f6703298d12a32cd7c057cd56eef9fde742
Author: Jian Shen
Date: Sat Feb 27 15:24:52 2021 +0800
net: hns3: fix query vlan mask value error for flow director
commit c75ec148a316e8cf52274d16b9b422703b96f5ce upstream.
Currently, the driver returns VLAN\_VID\_MASK for vlan mask field,
when get flow director rule information for rule doesn't use vlan.
It may cause the vlan mask value display as 0xf000 in this
case, like below:
estuary:/$ ethtool -u eth1
50 RX rings available
Total 1 rules
Filter: 2
Rule Type: TCP over IPv4
Src IP addr: 0.0.0.0 mask: 255.255.255.255
Dest IP addr: 0.0.0.0 mask: 255.255.255.255
TOS: 0x0 mask: 0xff
Src port: 0 mask: 0xffff
Dest port: 0 mask: 0xffff
VLAN EtherType: 0x0 mask: 0xffff
VLAN: 0x0 mask: 0xf000
User-defined: 0x1234 mask: 0x0
Action: Direct to queue 3
Fix it by return 0.
Fixes: 05c2314fe6a8 ("net: hns3: Add support for rule query of flow director")
Signed-off-by: Jian Shen
Signed-off-by: Huazhong Tan
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 163fab2e19d66eb0f2f20f8784d5c630e8cfbceb
Author: Jian Shen
Date: Sat Feb 27 15:24:51 2021 +0800
net: hns3: fix error mask definition of flow director
commit ae85ddda0f1b341b2d25f5a5e0eff1d42b6ef3df upstream.
Currently, some bit filed definitions of flow director TCAM
configuration command are incorrect. Since the wrong MSB is
always 0, and these fields are assgined in order, so it still works.
Fix it by redefine them.
Fixes: 117328680288 ("net: hns3: Add input key and action config support for flow director")
Signed-off-by: Jian Shen
Signed-off-by: Huazhong Tan
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit e58feda63ef7c596eca61fc919979aafc0a5b4e5
Author: Ravi Bangoria
Date: Thu Mar 4 11:59:58 2021 +0530
perf report: Fix -F for branch & mem modes
commit 6740a4e70e5d1b9d8e7fe41fd46dd5656d65dadf upstream.
perf report fails to add valid additional fields with -F when
used with branch or mem modes. Fix it.
Before patch:
$ perf record -b
$ perf report -b -F +srcline\_from --stdio
Error:
Invalid --fields key: `srcline\_from'
After patch:
$ perf report -b -F +srcline\_from --stdio
# Samples: 8K of event 'cycles'
# Event count (approx.): 8784
...
Committer notes:
There was an inversion: when looking at branch stack dimensions (keys)
it was checking if the sort mode was 'mem', not 'branch'.
Fixes: aa6b3c99236b ("perf report: Make -F more strict like -s")
Reported-by: Athira Jajeev
Signed-off-by: Ravi Bangoria
Reviewed-by: Athira Jajeev
Tested-by: Arnaldo Carvalho de Melo
Tested-by: Athira Jajeev
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Namhyung Kim
Link: http://lore.kernel.org/lkml/20210304062958.85465-1-ravi.bangoria@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 4f55f7f57e917f576442b2fb11cb5d4d0773d90d
Author: Ian Rogers
Date: Fri Feb 26 14:14:31 2021 -0800
perf traceevent: Ensure read cmdlines are null terminated.
commit 137a5258939aca56558f3a23eb229b9c4b293917 upstream.
Issue detected by address sanitizer.
Fixes: cd4ceb63438e9e28 ("perf util: Save pid-cmdline mapping into tracing header")
Signed-off-by: Ian Rogers
Acked-by: Namhyung Kim
Cc: Alexander Shishkin
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Peter Zijlstra
Cc: Stephane Eranian
Link: http://lore.kernel.org/lkml/20210226221431.1985458-1-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit ea54838e532194daf80d4af002375424e364eca1
Author: Danielle Ratson
Date: Thu Feb 25 18:57:20 2021 +0200
mlxsw: spectrum\_ethtool: Add an external speed to PTYS register
commit ae9b24ddb69b4e31cda1b5e267a5a08a1db11717 upstream.
Currently, only external bits are added to the PTYS register, whereas
there is one external bit that is wrongly marked as internal, and so was
recently removed from the register.
Add that bit to the PTYS register again, as this bit is no longer
internal.
Its removal resulted in '100000baseLR4\_ER4/Full' link mode no longer
being supported, causing a regression on some setups.
Fixes: 5bf01b571cf4 ("mlxsw: spectrum\_ethtool: Remove internal speeds from PTYS register")
Signed-off-by: Danielle Ratson
Reported-by: Eddie Shklaer
Tested-by: Eddie Shklaer
Reviewed-by: Jiri Pirko
Signed-off-by: Ido Schimmel
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 182d5a16e9c3ce12431101b249199046df964982
Author: Danielle Ratson
Date: Thu Feb 25 18:57:19 2021 +0200
selftests: forwarding: Fix race condition in mirror installation
commit edcbf5137f093b5502f5f6b97cce3cbadbde27aa upstream.
When mirroring to a gretap in hardware the device expects to be
programmed with the egress port and all the encapsulating headers. This
requires the driver to resolve the path the packet will take in the
software data path and program the device accordingly.
If the path cannot be resolved (in this case because of an unresolved
neighbor), then mirror installation fails until the path is resolved.
This results in a race that causes the test to sometimes fail.
Fix this by setting the neighbor's state to permanent, so that it is
always valid.
Fixes: b5b029399fa6d ("selftests: forwarding: mirror\_gre\_bridge\_1d\_vlan: Add STP test")
Signed-off-by: Danielle Ratson
Reviewed-by: Petr Machata
Signed-off-by: Ido Schimmel
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 20f62c1c87c7a3bba4235843239bbf4b615b4484
Author: Arnd Bergmann
Date: Thu Feb 25 15:57:27 2021 +0100
net: phy: make mdio\_bus\_phy\_suspend/resume as \_\_maybe\_unused
commit 7f654157f0aefba04cd7f6297351c87b76b47b89 upstream.
When CONFIG\_PM\_SLEEP is disabled, the compiler warns about unused
functions:
drivers/net/phy/phy\_device.c:273:12: error: unused function 'mdio\_bus\_phy\_suspend' [-Werror,-Wunused-function]
static int mdio\_bus\_phy\_suspend(struct device \*dev)
drivers/net/phy/phy\_device.c:293:12: error: unused function 'mdio\_bus\_phy\_resume' [-Werror,-Wunused-function]
static int mdio\_bus\_phy\_resume(struct device \*dev)
The logic is intentional, so just mark these two as \_\_maybe\_unused
and remove the incorrect #ifdef.
Fixes: 4c0d2e96ba05 ("net: phy: consider that suspend2ram may cut off PHY power")
Signed-off-by: Arnd Bergmann
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/20210225145748.404410-1-arnd@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit bfc1e5619432659c00d1c4f3cfa7879d070d0f23
Author: Yinjun Zhang
Date: Thu Feb 25 13:51:02 2021 +0100
ethtool: fix the check logic of at least one channel for RX/TX
commit a4fc088ad4ff4a99d01978aa41065132b574b4b2 upstream.
The command "ethtool -L  combined 0" may clean the RX/TX channel
count and skip the error path, since the attrs
tb[ETHTOOL\_A\_CHANNELS\_RX\_COUNT] and tb[ETHTOOL\_A\_CHANNELS\_TX\_COUNT]
are NULL in this case when recent ethtool is used.
Tested using ethtool v5.10.
Fixes: 7be92514b99c ("ethtool: check if there is at least one channel for TX/RX in the core")
Signed-off-by: Yinjun Zhang
Signed-off-by: Simon Horman
Signed-off-by: Louis Peens
Link: https://lore.kernel.org/r/20210225125102.23989-1-simon.horman@netronome.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 25048ef1f9d32c86a1596d475779f5593fdf0887
Author: Joakim Zhang
Date: Thu Feb 25 17:01:13 2021 +0800
net: stmmac: fix wrongly set buffer2 valid when sph unsupport
commit 396e13e11577b614db77db0bbb6fca935b94eb1b upstream.
In current driver, buffer2 available only when hardware supports split
header. Wrongly set buffer2 valid in stmmac\_rx\_refill when refill buffer
address. You can see that desc3 is 0x81000000 after initialization, but
turn out to be 0x83000000 after refill.
Fixes: 67afd6d1cfdf ("net: stmmac: Add Split Header support and enable it in XGMAC cores")
Signed-off-by: Joakim Zhang
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 6baecb96c5bfb44efeb4bc665f4c008d57ff6683
Author: Joakim Zhang
Date: Thu Feb 25 17:01:11 2021 +0800
net: stmmac: fix watchdog timeout during suspend/resume stress test
commit c511819d138de38e1637eedb645c207e09680d0f upstream.
stmmac\_xmit() call stmmac\_tx\_timer\_arm() at the end to modify tx timer to
do the transmission cleanup work. Imagine such a situation, stmmac enters
suspend immediately after tx timer modified, it's expire callback
stmmac\_tx\_clean() would not be invoked. This could affect BQL, since
netdev\_tx\_sent\_queue() has been called, but netdev\_tx\_completed\_queue()
have not been involved, as a result, dql\_avail(&dev\_queue->dql) finally
always return a negative value.
\_\_dev\_queue\_xmit->\_\_dev\_xmit\_skb->qdisc\_run->\_\_qdisc\_run->qdisc\_restart->dequeue\_skb:
if ((q->flags & TCQ\_F\_ONETXQUEUE) &&
netif\_xmit\_frozen\_or\_stopped(txq)) // \_\_QUEUE\_STATE\_STACK\_XOFF is set
Net core will stop transmitting any more. Finillay, net watchdong would timeout.
To fix this issue, we should call netdev\_tx\_reset\_queue() in stmmac\_resume().
Fixes: 54139cf3bb33 ("net: stmmac: adding multiple buffers for rx")
Signed-off-by: Joakim Zhang
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 598b147b6adb2eb760b2ebd93aed60f4d0ec7dad
Author: Joakim Zhang
Date: Thu Feb 25 17:01:10 2021 +0800
net: stmmac: stop each tx channel independently
commit a3e860a83397bf761ec1128a3f0ba186445992c6 upstream.
If clear GMAC\_CONFIG\_TE bit, it would stop all tx channels, but users
may only want to stop specific tx channel.
Fixes: 48863ce5940f ("stmmac: add DMA support for GMAC 4.xx")
Signed-off-by: Joakim Zhang
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 9ef4c1b438a3646cc339dd334f5b05c84bef1fd5
Author: Antonio Terceiro
Date: Wed Feb 24 10:00:46 2021 -0300
perf build: Fix ccache usage in $(CC) when generating arch errno table
commit dacfc08dcafa7d443ab339592999e37bbb8a3ef0 upstream.
This was introduced by commit e4ffd066ff440a57 ("perf: Normalize gcc
parameter when generating arch errno table").
Assuming the first word of $(CC) is the actual compiler breaks usage
like CC="ccache gcc": the script ends up calling ccache directly with
gcc arguments, what fails. Instead of getting the first word, just
remove from $(CC) any word that starts with a "-". This maintains the
spirit of the original patch, while not breaking ccache users.
Fixes: e4ffd066ff440a57 ("perf: Normalize gcc parameter when generating arch errno table")
Signed-off-by: Antonio Terceiro
Tested-by: Arnaldo Carvalho de Melo
Cc: Alexander Shishkin
Cc: He Zhe
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: stable@vger.kernel.org
Link: http://lore.kernel.org/lkml/20210224130046.346977-1-antonio.terceiro@linaro.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 5864c338d26c04ab7bda860fc83e9a3b1b086b0d
Author: Kun-Chuan Hsieh
Date: Wed Feb 24 05:27:52 2021 +0000
tools/resolve\_btfids: Fix build error with older host toolchains
commit 41462c6e730ca0e63f5fed5a517052385d980c54 upstream.
Older libelf.h and glibc elf.h might not yet define the ELF compression
types.
Checking and defining SHF\_COMPRESSED fix the build error when compiling
with older toolchains. Also, the tool resolve\_btfids is compiled with host
toolchain. The host toolchain is more likely to be older than the cross
compile toolchain.
Fixes: 51f6463aacfb ("tools/resolve\_btfids: Fix sections with wrong alignment")
Signed-off-by: Kun-Chuan Hsieh
Signed-off-by: Daniel Borkmann
Acked-by: Jiri Olsa
Link: https://lore.kernel.org/bpf/20210224052752.5284-1-jetswayss@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit bc4b6843c44a11840ef25eac8e3f80f19f18b0e5
Author: Antony Antony
Date: Wed Oct 14 16:17:48 2020 +0200
ixgbe: fail to create xfrm offload of IPsec tunnel mode SA
commit d785e1fec60179f534fbe8d006c890e5ad186e51 upstream.
Based on talks and indirect references ixgbe IPsec offlod do not
support IPsec tunnel mode offload. It can only support IPsec transport
mode offload. Now explicitly fail when creating non transport mode SA
with offload to avoid false performance expectations.
Fixes: 63a67fe229ea ("ixgbe: add ipsec offload add and remove SA")
Signed-off-by: Antony Antony
Acked-by: Shannon Nelson
Tested-by: Tony Brelinski
Signed-off-by: Tony Nguyen
Signed-off-by: Greg Kroah-Hartman
commit b074f1e5d4d8a7c981a2800791a19a0a24bb3193
Author: Hayes Wang
Date: Fri Mar 5 17:34:41 2021 +0800
r8169: fix r8168fp\_adjust\_ocp\_cmd function
commit abbf9a0ef8848dca58c5b97750c1c59bbee45637 upstream.
The (0xBAF70000 & 0x00FFF000) << 6 should be (0xf70 << 18).
Fixes: 561535b0f239 ("r8169: fix OCP access on RTL8117")
Signed-off-by: Hayes Wang
Acked-by: Heiner Kallweit
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2d89e955e34b7f70e4f840e60a4706bcec42084e
Author: Julian Wiedmann
Date: Tue Mar 9 17:52:21 2021 +0100
s390/qeth: fix notification for pending buffers during teardown
commit 7eefda7f353ef86ad82a2dc8329e8a3538c08ab6 upstream.
The cited commit reworked the state machine for pending TX buffers.
In qeth\_iqd\_tx\_complete() it turned PENDING into a transient state, and
uses NEED\_QAOB for buffers that get parked while waiting for their QAOB
completion.
But it missed to adjust the check in qeth\_tx\_complete\_buf(). So if
qeth\_tx\_complete\_pending\_bufs() is called during teardown to drain
the parked TX buffers, we no longer raise a notification for af\_iucv.
Instead of updating the checked state, just move this code into
qeth\_tx\_complete\_pending\_bufs() itself. This also gets rid of the
special-case in the common TX completion path.
Fixes: 8908f36d20d8 ("s390/qeth: fix af\_iucv notification race")
Signed-off-by: Julian Wiedmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 890a7665ef524c9a411cf63dfef6409d0fb3a7cb
Author: Julian Wiedmann
Date: Tue Mar 9 17:52:20 2021 +0100
s390/qeth: schedule TX NAPI on QAOB completion
commit 3e83d467a08e25b27c44c885f511624a71c84f7c upstream.
When a QAOB notifies us that a pending TX buffer has been delivered, the
actual TX completion processing by qeth\_tx\_complete\_pending\_bufs()
is done within the context of a TX NAPI instance. We shouldn't rely on
this instance being scheduled by some other TX event, but just do it
ourselves.
qeth\_qdio\_handle\_aob() is called from qeth\_poll(), ie. our main NAPI
instance. To avoid touching the TX queue's NAPI instance
before/after it is (un-)registered, reorder the code in qeth\_open()
and qeth\_stop() accordingly.
Fixes: 0da9581ddb0f ("qeth: exploit asynchronous delivery of storage blocks")
Signed-off-by: Julian Wiedmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 27666f87952294677e6b30e80bad50cf5a43b00a
Author: Julian Wiedmann
Date: Tue Mar 9 17:52:19 2021 +0100
s390/qeth: improve completion of pending TX buffers
commit c20383ad1656b0f6354dd50e4acd894f9d94090d upstream.
The current design attaches a pending TX buffer to a custom
single-linked list, which is anchored at the buffer's slot on the
TX ring. The buffer is then checked for final completion whenever
this slot is processed during a subsequent TX NAPI poll cycle.
But if there's insufficient traffic on the ring, we might never make
enough progress to get back to this ring slot and discover the pending
buffer's final TX completion. In particular if this missing TX
completion blocks the application from sending further traffic.
So convert the custom single-linked list code to a per-queue list\_head,
and scan this list on every TX NAPI cycle.
Fixes: 0da9581ddb0f ("qeth: exploit asynchronous delivery of storage blocks")
Signed-off-by: Julian Wiedmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d76d8e4862a0d041b374d5456f074994b8def40b
Author: Julian Wiedmann
Date: Tue Mar 9 17:52:18 2021 +0100
s390/qeth: fix memory leak after failed TX Buffer allocation
commit e7a36d27f6b9f389e41d8189a8a08919c6835732 upstream.
When qeth\_alloc\_qdio\_queues() fails to allocate one of the buffers that
back an Output Queue, the 'out\_freeoutqbufs' path will free all
previously allocated buffers for this queue. But it misses to free the
half-finished queue struct itself.
Move the buffer allocation into qeth\_alloc\_output\_queue(), and deal with
such errors internally.
Fixes: 0da9581ddb0f ("qeth: exploit asynchronous delivery of storage blocks")
Signed-off-by: Julian Wiedmann
Reviewed-by: Alexandra Winter
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cc1438d6ba44377b5465f7c08516fd547fcd225a
Author: Jia-Ju Bai
Date: Mon Mar 8 01:13:55 2021 -0800
net: qrtr: fix error return code of qrtr\_sendmsg()
commit 179d0ba0c454057a65929c46af0d6ad986754781 upstream.
When sock\_alloc\_send\_skb() returns NULL to skb, no error return code of
qrtr\_sendmsg() is assigned.
To fix this bug, rc is assigned with -ENOMEM in this case.
Fixes: 194ccc88297a ("net: qrtr: Support decoding incoming v2 packets")
Reported-by: TOTE Robot
Signed-off-by: Jia-Ju Bai
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2f71c51db8debdc062404b34c639680225f0a6f4
Author: Vladimir Oltean
Date: Sun Mar 7 15:23:39 2021 +0200
net: enetc: allow hardware timestamping on TX queues with tc-etf enabled
commit 29d98f54a4fe1b6a9089bec8715a1b89ff9ad59c upstream.
The txtime is passed to the driver in skb->skb\_mstamp\_ns, which is
actually in a union with skb->tstamp (the place where software
timestamps are kept).
Since commit b50a5c70ffa4 ("net: allow simultaneous SW and HW transmit
timestamping"), \_\_sock\_recv\_timestamp has some logic for making sure
that the two calls to skb\_tstamp\_tx:
skb\_tx\_timestamp(skb) # Software timestamp in the driver
-> skb\_tstamp\_tx(skb, NULL)
and
skb\_tstamp\_tx(skb, &shhwtstamps) # Hardware timestamp in the driver
will both do the right thing and in a race-free manner, meaning that
skb\_tx\_timestamp will deliver a cmsg with the software timestamp only,
and skb\_tstamp\_tx with a non-NULL hwtstamps argument will deliver a cmsg
with the hardware timestamp only.
Why are races even possible? Well, because although the software timestamp
skb->tstamp is private per skb, the hardware timestamp skb\_hwtstamps(skb)
lives in skb\_shinfo(skb), an area which is shared between skbs and their
clones. And skb\_tstamp\_tx works by cloning the packets when timestamping
them, therefore attempting to perform hardware timestamping on an skb's
clone will also change the hardware timestamp of the original skb. And
the original skb might have been yet again cloned for software
timestamping, at an earlier stage.
So the logic in \_\_sock\_recv\_timestamp can't be as simple as saying
"does this skb have a hardware timestamp? if yes I'll send the hardware
timestamp to the socket, otherwise I'll send the software timestamp",
precisely because the hardware timestamp is shared.
Instead, it's quite the other way around: \_\_sock\_recv\_timestamp says
"does this skb have a software timestamp? if yes, I'll send the software
timestamp, otherwise the hardware one". This works because the software
timestamp is not shared with clones.
But that means we have a problem when we attempt hardware timestamping
with skbs that don't have the skb->tstamp == 0. \_\_sock\_recv\_timestamp
will say "oh, yeah, this must be some sort of odd clone" and will not
deliver the hardware timestamp to the socket. And this is exactly what
is happening when we have txtime enabled on the socket: as mentioned,
that is put in a union with skb->tstamp, so it is quite easy to mistake
it.
Do what other drivers do (intel igb/igc) and write zero to skb->tstamp
before taking the hardware timestamp. It's of no use to us now (we're
already on the TX confirmation path).
Fixes: 0d08c9ec7d6e ("enetc: add support time specific departure base on the qos etf")
Cc: Vinicius Costa Gomes
Signed-off-by: Vladimir Oltean
Acked-by: Vinicius Costa Gomes
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a1f308089257616cdb91b4334c5eaa81ae17e387
Author: Paul Cercueil
Date: Sun Mar 7 13:17:48 2021 +0000
net: davicom: Fix regulator not turned off on driver removal
commit cf9e60aa69ae6c40d3e3e4c94dd6c8de31674e9b upstream.
We must disable the regulator that was enabled in the probe function.
Fixes: 7994fe55a4a2 ("dm9000: Add regulator and reset support to dm9000")
Signed-off-by: Paul Cercueil
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c32b8c03ee1c821af0b152dd174da4eb94967fa8
Author: Paul Cercueil
Date: Sun Mar 7 13:17:47 2021 +0000
net: davicom: Fix regulator not turned off on failed probe
commit ac88c531a5b38877eba2365a3f28f0c8b513dc33 upstream.
When the probe fails or requests to be defered, we must disable the
regulator that was previously enabled.
Fixes: 7994fe55a4a2 ("dm9000: Add regulator and reset support to dm9000")
Signed-off-by: Paul Cercueil
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8eb43ff45aee8dbf81409afb8e84d0c71d10dc3c
Author: Xie He
Date: Sun Mar 7 03:33:07 2021 -0800
net: lapbether: Remove netif\_start\_queue / netif\_stop\_queue
commit f7d9d4854519fdf4d45c70a4d953438cd88e7e58 upstream.
For the devices in this driver, the default qdisc is "noqueue",
because their "tx\_queue\_len" is 0.
In function "\_\_dev\_queue\_xmit" in "net/core/dev.c", devices with the
"noqueue" qdisc are specially handled. Packets are transmitted without
being queued after a "dev->flags & IFF\_UP" check. However, it's possible
that even if this check succeeds, "ops->ndo\_stop" may still have already
been called. This is because in "\_\_dev\_close\_many", "ops->ndo\_stop" is
called before clearing the "IFF\_UP" flag.
If we call "netif\_stop\_queue" in "ops->ndo\_stop", then it's possible in
"\_\_dev\_queue\_xmit", it sees the "IFF\_UP" flag is present, and then it
checks "netif\_xmit\_stopped" and finds that the queue is already stopped.
In this case, it will complain that:
"Virtual device ... asks to queue packet!"
To prevent "\_\_dev\_queue\_xmit" from generating this complaint, we should
not call "netif\_stop\_queue" in "ops->ndo\_stop".
We also don't need to call "netif\_start\_queue" in "ops->ndo\_open",
because after a netdev is allocated and registered, the
"\_\_QUEUE\_STATE\_DRV\_XOFF" flag is initially not set, so there is no need
to call "netif\_start\_queue" to clear it.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Xie He
Acked-by: Martin Schiller
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e1283ef5d66e418beee8eb3c0530f0c16f852a87
Author: Wong Vee Khee
Date: Fri Mar 5 14:03:42 2021 +0800
stmmac: intel: Fixes clock registration error seen for multiple interfaces
commit 8eb37ab7cc045ec6305a6a1a9c32374695a1a977 upstream.
Issue seen when enumerating multiple Intel mGbE interfaces in EHL.
[ 6.898141] intel-eth-pci 0000:00:1d.2: enabling device (0000 -> 0002)
[ 6.900971] intel-eth-pci 0000:00:1d.2: Fail to register stmmac-clk
[ 6.906434] intel-eth-pci 0000:00:1d.2: User ID: 0x51, Synopsys ID: 0x52
We fix it by making the clock name to be unique following the format
of stmmac-pci\_name(pci\_dev) so that we can differentiate the clock for
these Intel mGbE interfaces in EHL platform as follow:
/sys/kernel/debug/clk/stmmac-0000:00:1d.1
/sys/kernel/debug/clk/stmmac-0000:00:1d.2
/sys/kernel/debug/clk/stmmac-0000:00:1e.4
Fixes: 58da0cfa6cf1 ("net: stmmac: create dwmac-intel.c to contain all Intel platform")
Signed-off-by: Wong Vee Khee
Signed-off-by: Voon Weifeng
Co-developed-by: Ong Boon Leong
Signed-off-by: Ong Boon Leong
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit dbee60e04e42266267740e3240aaab3d29cd509f
Author: Ong Boon Leong
Date: Fri Mar 5 13:49:30 2021 +0800
net: stmmac: Fix VLAN filter delete timeout issue in Intel mGBE SGMII
commit 9a7b3950c7e15968e23d83be215e95ccc7c92a53 upstream.
For Intel mGbE controller, MAC VLAN filter delete operation will time-out
if serdes power-down sequence happened first during driver remove() with
below message.
[82294.764958] intel-eth-pci 0000:00:1e.4 eth2: stmmac\_dvr\_remove: removing driver
[82294.778677] intel-eth-pci 0000:00:1e.4 eth2: Timeout accessing MAC\_VLAN\_Tag\_Filter
[82294.779997] intel-eth-pci 0000:00:1e.4 eth2: failed to kill vid 0081/0
[82294.947053] intel-eth-pci 0000:00:1d.2 eth1: stmmac\_dvr\_remove: removing driver
[82295.002091] intel-eth-pci 0000:00:1d.1 eth0: stmmac\_dvr\_remove: removing driver
Therefore, we delay the serdes power-down to be after unregister\_netdev()
which triggers the VLAN filter delete.
Fixes: b9663b7ca6ff ("net: stmmac: Enable SERDES power up/down sequence")
Signed-off-by: Ong Boon Leong
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 00d566df2cceb8591913b3ea3b43d2918915f7e3
Author: Paul Moore
Date: Thu Mar 4 16:29:51 2021 -0500
cipso,calipso: resolve a number of problems with the DOI refcounts
commit ad5d07f4a9cd671233ae20983848874731102c08 upstream.
The current CIPSO and CALIPSO refcounting scheme for the DOI
definitions is a bit flawed in that we:
1. Don't correctly match gets/puts in netlbl\_cipsov4\_list().
2. Decrement the refcount on each attempt to remove the DOI from the
DOI list, only removing it from the list once the refcount drops
to zero.
This patch fixes these problems by adding the missing "puts" to
netlbl\_cipsov4\_list() and introduces a more conventional, i.e.
not-buggy, refcounting mechanism to the DOI definitions. Upon the
addition of a DOI to the DOI list, it is initialized with a refcount
of one, removing a DOI from the list removes it from the list and
drops the refcount by one; "gets" and "puts" behave as expected with
respect to refcounts, increasing and decreasing the DOI's refcount by
one.
Fixes: b1edeb102397 ("netlabel: Replace protocol/NetLabel linking with refrerence counts")
Fixes: d7cce01504a0 ("netlabel: Add support for removing a CALIPSO DOI.")
Reported-by: syzbot+9ec037722d2603a9f52e@syzkaller.appspotmail.com
Signed-off-by: Paul Moore
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3e4b709e00977f62fb38b029dce9681ff6fc9877
Author: Hillf Danton
Date: Thu Mar 4 10:30:09 2021 -0800
netdevsim: init u64 stats for 32bit hardware
commit 863a42b289c22df63db62b10fc2c2ffc237e2125 upstream.
Init the u64 stats in order to avoid the lockdep prints on the 32bit
hardware like
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 4695 Comm: syz-executor.0 Not tainted 5.11.0-rc5-syzkaller #0
Hardware name: ARM-Versatile Express
Backtrace:
[<826fc5b8>] (dump\_backtrace) from [<826fc82c>] (show\_stack+0x18/0x1c arch/arm/kernel/traps.c:252)
[<826fc814>] (show\_stack) from [<8270d1f8>] (\_\_dump\_stack lib/dump\_stack.c:79 [inline])
[<826fc814>] (show\_stack) from [<8270d1f8>] (dump\_stack+0xa8/0xc8 lib/dump\_stack.c:120)
[<8270d150>] (dump\_stack) from [<802bf9c0>] (assign\_lock\_key kernel/locking/lockdep.c:935 [inline])
[<8270d150>] (dump\_stack) from [<802bf9c0>] (register\_lock\_class+0xabc/0xb68 kernel/locking/lockdep.c:1247)
[<802bef04>] (register\_lock\_class) from [<802baa2c>] (\_\_lock\_acquire+0x84/0x32d4 kernel/locking/lockdep.c:4711)
[<802ba9a8>] (\_\_lock\_acquire) from [<802be840>] (lock\_acquire.part.0+0xf0/0x554 kernel/locking/lockdep.c:5442)
[<802be750>] (lock\_acquire.part.0) from [<802bed10>] (lock\_acquire+0x6c/0x74 kernel/locking/lockdep.c:5415)
[<802beca4>] (lock\_acquire) from [<81560548>] (seqcount\_lockdep\_reader\_access include/linux/seqlock.h:103 [inline])
[<802beca4>] (lock\_acquire) from [<81560548>] (\_\_u64\_stats\_fetch\_begin include/linux/u64\_stats\_sync.h:164 [inline])
[<802beca4>] (lock\_acquire) from [<81560548>] (u64\_stats\_fetch\_begin include/linux/u64\_stats\_sync.h:175 [inline])
[<802beca4>] (lock\_acquire) from [<81560548>] (nsim\_get\_stats64+0xdc/0xf0 drivers/net/netdevsim/netdev.c:70)
[<8156046c>] (nsim\_get\_stats64) from [<81e2efa0>] (dev\_get\_stats+0x44/0xd0 net/core/dev.c:10405)
[<81e2ef5c>] (dev\_get\_stats) from [<81e53204>] (rtnl\_fill\_stats+0x38/0x120 net/core/rtnetlink.c:1211)
[<81e531cc>] (rtnl\_fill\_stats) from [<81e59d58>] (rtnl\_fill\_ifinfo+0x6d4/0x148c net/core/rtnetlink.c:1783)
[<81e59684>] (rtnl\_fill\_ifinfo) from [<81e5ceb4>] (rtmsg\_ifinfo\_build\_skb+0x9c/0x108 net/core/rtnetlink.c:3798)
[<81e5ce18>] (rtmsg\_ifinfo\_build\_skb) from [<81e5d0ac>] (rtmsg\_ifinfo\_event net/core/rtnetlink.c:3830 [inline])
[<81e5ce18>] (rtmsg\_ifinfo\_build\_skb) from [<81e5d0ac>] (rtmsg\_ifinfo\_event net/core/rtnetlink.c:3821 [inline])
[<81e5ce18>] (rtmsg\_ifinfo\_build\_skb) from [<81e5d0ac>] (rtmsg\_ifinfo+0x44/0x70 net/core/rtnetlink.c:3839)
[<81e5d068>] (rtmsg\_ifinfo) from [<81e45c2c>] (register\_netdevice+0x664/0x68c net/core/dev.c:10103)
[<81e455c8>] (register\_netdevice) from [<815608bc>] (nsim\_create+0xf8/0x124 drivers/net/netdevsim/netdev.c:317)
[<815607c4>] (nsim\_create) from [<81561184>] (\_\_nsim\_dev\_port\_add+0x108/0x188 drivers/net/netdevsim/dev.c:941)
[<8156107c>] (\_\_nsim\_dev\_port\_add) from [<815620d8>] (nsim\_dev\_port\_add\_all drivers/net/netdevsim/dev.c:990 [inline])
[<8156107c>] (\_\_nsim\_dev\_port\_add) from [<815620d8>] (nsim\_dev\_probe+0x5cc/0x750 drivers/net/netdevsim/dev.c:1119)
[<81561b0c>] (nsim\_dev\_probe) from [<815661dc>] (nsim\_bus\_probe+0x10/0x14 drivers/net/netdevsim/bus.c:287)
[<815661cc>] (nsim\_bus\_probe) from [<811724c0>] (really\_probe+0x100/0x50c drivers/base/dd.c:554)
[<811723c0>] (really\_probe) from [<811729c4>] (driver\_probe\_device+0xf8/0x1c8 drivers/base/dd.c:740)
[<811728cc>] (driver\_probe\_device) from [<81172fe4>] (\_\_device\_attach\_driver+0x8c/0xf0 drivers/base/dd.c:846)
[<81172f58>] (\_\_device\_attach\_driver) from [<8116fee0>] (bus\_for\_each\_drv+0x88/0xd8 drivers/base/bus.c:431)
[<8116fe58>] (bus\_for\_each\_drv) from [<81172c6c>] (\_\_device\_attach+0xdc/0x1d0 drivers/base/dd.c:914)
[<81172b90>] (\_\_device\_attach) from [<8117305c>] (device\_initial\_probe+0x14/0x18 drivers/base/dd.c:961)
[<81173048>] (device\_initial\_probe) from [<81171358>] (bus\_probe\_device+0x90/0x98 drivers/base/bus.c:491)
[<811712c8>] (bus\_probe\_device) from [<8116e77c>] (device\_add+0x320/0x824 drivers/base/core.c:3109)
[<8116e45c>] (device\_add) from [<8116ec9c>] (device\_register+0x1c/0x20 drivers/base/core.c:3182)
[<8116ec80>] (device\_register) from [<81566710>] (nsim\_bus\_dev\_new drivers/net/netdevsim/bus.c:336 [inline])
[<8116ec80>] (device\_register) from [<81566710>] (new\_device\_store+0x178/0x208 drivers/net/netdevsim/bus.c:215)
[<81566598>] (new\_device\_store) from [<8116fcb4>] (bus\_attr\_store+0x2c/0x38 drivers/base/bus.c:122)
[<8116fc88>] (bus\_attr\_store) from [<805b4b8c>] (sysfs\_kf\_write+0x48/0x54 fs/sysfs/file.c:139)
[<805b4b44>] (sysfs\_kf\_write) from [<805b3c90>] (kernfs\_fop\_write\_iter+0x128/0x1ec fs/kernfs/file.c:296)
[<805b3b68>] (kernfs\_fop\_write\_iter) from [<804d22fc>] (call\_write\_iter include/linux/fs.h:1901 [inline])
[<805b3b68>] (kernfs\_fop\_write\_iter) from [<804d22fc>] (new\_sync\_write fs/read\_write.c:518 [inline])
[<805b3b68>] (kernfs\_fop\_write\_iter) from [<804d22fc>] (vfs\_write+0x3dc/0x57c fs/read\_write.c:605)
[<804d1f20>] (vfs\_write) from [<804d2604>] (ksys\_write+0x68/0xec fs/read\_write.c:658)
[<804d259c>] (ksys\_write) from [<804d2698>] (\_\_do\_sys\_write fs/read\_write.c:670 [inline])
[<804d259c>] (ksys\_write) from [<804d2698>] (sys\_write+0x10/0x14 fs/read\_write.c:667)
[<804d2688>] (sys\_write) from [<80200060>] (ret\_fast\_syscall+0x0/0x2c arch/arm/mm/proc-v7.S:64)
Fixes: 83c9e13aa39a ("netdevsim: add software driver for testing offloads")
Reported-by: syzbot+e74a6857f2d0efe3ad81@syzkaller.appspotmail.com
Tested-by: Dmitry Vyukov
Signed-off-by: Hillf Danton
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d493ac5ea098c76b18f812ccf207e6a98a2c847a
Author: Daniele Palmas
Date: Thu Mar 4 14:15:13 2021 +0100
net: usb: qmi\_wwan: allow qmimux add/del with master up
commit 6c59cff38e66584ae3ac6c2f0cbd8d039c710ba7 upstream.
There's no reason for preventing the creation and removal
of qmimux network interfaces when the underlying interface
is up.
This makes qmi\_wwan mux implementation more similar to the
rmnet one, simplifying userspace management of the same
logical interfaces.
Fixes: c6adf77953bc ("net: usb: qmi\_wwan: add qmap mux protocol support")
Reported-by: Aleksander Morgado
Signed-off-by: Daniele Palmas
Acked-by: Bjørn Mork
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 12e1eb5a1a9bbf0a357358392d5f416ba4631956
Author: Vladimir Oltean
Date: Thu Mar 4 12:56:53 2021 +0200
net: dsa: sja1105: fix SGMII PCS being forced to SPEED\_UNKNOWN instead of SPEED\_10
commit 053d8ad10d585adf9891fcd049637536e2fe9ea7 upstream.
When using MLO\_AN\_PHY or MLO\_AN\_FIXED, the MII\_BMCR of the SGMII PCS is
read before resetting the switch so it can be reprogrammed afterwards.
This works for the speeds of 1Gbps and 100Mbps, but not for 10Mbps,
because SPEED\_10 is actually 0, so AND-ing anything with 0 is false,
therefore that last branch is dead code.
Do what others do (genphy\_read\_status\_fixed, phy\_mii\_ioctl) and just
remove the check for SPEED\_10, let it fall into the default case.
Fixes: ffe10e679cec ("net: dsa: sja1105: Add support for the SGMII port")
Signed-off-by: Vladimir Oltean
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2930991670c65e2c0affddc8610723d3451c6b37
Author: Vladimir Oltean
Date: Thu Mar 4 12:29:43 2021 +0200
net: mscc: ocelot: properly reject destination IP keys in VCAP IS1
commit f1becbed411c6fa29d7ce3def3a1dcd4f63f2d74 upstream.
An attempt is made to warn the user about the fact that VCAP IS1 cannot
offload keys matching on destination IP (at least given the current half
key format), but sadly that warning fails miserably in practice, due to
the fact that it operates on an uninitialized "match" variable. We must
first decode the keys from the flow rule.
Fixes: 75944fda1dfe ("net: mscc: ocelot: offload ingress skbedit and vlan actions to VCAP IS1")
Reported-by: Colin Ian King
Signed-off-by: Vladimir Oltean
Reviewed-by: Colin Ian King
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 41fed22409f567faabdb88742039477314546e7b
Author: Maximilian Heyne
Date: Thu Mar 4 14:43:17 2021 +0000
net: sched: avoid duplicates in classes dump
commit bfc2560563586372212b0a8aeca7428975fa91fe upstream.
This is a follow up of commit ea3274695353 ("net: sched: avoid
duplicates in qdisc dump") which has fixed the issue only for the qdisc
dump.
The duplicate printing also occurs when dumping the classes via
tc class show dev eth0
Fixes: 59cc1f61f09c ("net: sched: convert qdisc linked list to hashtable")
Signed-off-by: Maximilian Heyne
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d0f380d733eff3ab787dccdfc1c88f9409bcc151
Author: Ido Schimmel
Date: Thu Mar 4 10:57:53 2021 +0200
nexthop: Do not flush blackhole nexthops when loopback goes down
commit 76c03bf8e2624076b88d93542d78e22d5345c88e upstream.
As far as user space is concerned, blackhole nexthops do not have a
nexthop device and therefore should not be affected by the
administrative or carrier state of any netdev.
However, when the loopback netdev goes down all the blackhole nexthops
are flushed. This happens because internally the kernel associates
blackhole nexthops with the loopback netdev.
This behavior is both confusing to those not familiar with kernel
internals and also diverges from the legacy API where blackhole IPv4
routes are not flushed when the loopback netdev goes down:
# ip route add blackhole 198.51.100.0/24
# ip link set dev lo down
# ip route show 198.51.100.0/24
blackhole 198.51.100.0/24
Blackhole IPv6 routes are flushed, but at least user space knows that
they are associated with the loopback netdev:
# ip -6 route show 2001:db8:1::/64
blackhole 2001:db8:1::/64 dev lo metric 1024 pref medium
Fix this by only flushing blackhole nexthops when the loopback netdev is
unregistered.
Fixes: ab84be7e54fc ("net: Initial nexthop code")
Signed-off-by: Ido Schimmel
Reported-by: Donald Sharp
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cef0c0a3f9baeb56d931d62b5bf2fa6493e2dfea
Author: Ong Boon Leong
Date: Wed Mar 3 20:38:40 2021 +0530
net: stmmac: fix incorrect DMA channel intr enable setting of EQoS v4.10
commit 879c348c35bb5fb758dd881d8a97409c1862dae8 upstream.
We introduce dwmac410\_dma\_init\_channel() here for both EQoS v4.10 and
above which use different DMA\_CH(n)\_Interrupt\_Enable bit definitions for
NIE and AIE.
Fixes: 48863ce5940f ("stmmac: add DMA support for GMAC 4.xx")
Signed-off-by: Ong Boon Leong
Signed-off-by: Ramesh Babu B
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 56c88527b360bd22f8c9940ba78316c73066af78
Author: Kevin(Yudong) Yang
Date: Wed Mar 3 09:43:54 2021 -0500
net/mlx4\_en: update moderation when config reset
commit 00ff801bb8ce6711e919af4530b6ffa14a22390a upstream.
This patch fixes a bug that the moderation config will not be
applied when calling mlx4\_en\_reset\_config. For example, when
turning on rx timestamping, mlx4\_en\_reset\_config() will be called,
causing the NIC to forget previous moderation config.
This fix is in phase with a previous fix:
commit 79c54b6bbf06 ("net/mlx4\_en: Fix TX moderation info loss
after set\_ringparam is called")
Tested: Before this patch, on a host with NIC using mlx4, run
netserver and stream TCP to the host at full utilization.
$ sar -I SUM 1
INTR intr/s
14:03:56 sum 48758.00
After rx hwtstamp is enabled:
$ sar -I SUM 1
14:10:38 sum 317771.00
We see the moderation is not working properly and issued 7x more
interrupts.
After the patch, and turned on rx hwtstamp, the rate of interrupts
is as expected:
$ sar -I SUM 1
14:52:11 sum 49332.00
Fixes: 79c54b6bbf06 ("net/mlx4\_en: Fix TX moderation info loss after set\_ringparam is called")
Signed-off-by: Kevin(Yudong) Yang
Reviewed-by: Eric Dumazet
Reviewed-by: Neal Cardwell
CC: Tariq Toukan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e4abfedd42b90afc08036a9656046eed936d50d4
Author: Biao Huang
Date: Tue Mar 2 11:33:23 2021 +0800
net: ethernet: mtk-star-emac: fix wrong unmap in RX handling
commit 95b39f07a17faef3a9b225248ba449b976e529c8 upstream.
mtk\_star\_dma\_unmap\_rx() should unmap the dma\_addr of old skb rather than
that of new skb.
Assign new\_dma\_addr to desc\_data.dma\_addr after all handling of old skb
ends to avoid unexpected receive side error.
Fixes: f96e9641e92b ("net: ethernet: mtk-star-emac: fix error path in RX handling")
Signed-off-by: Biao Huang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 10ec8fe8eac06c4660bb15666867bc5d465bf681
Author: DENG Qingfang
Date: Tue Mar 2 00:01:59 2021 +0800
net: dsa: tag\_mtk: fix 802.1ad VLAN egress
commit 9200f515c41f4cbaeffd8fdd1d8b6373a18b1b67 upstream.
A different TPID bit is used for 802.1ad VLAN frames.
Reported-by: Ilario Gelmetti
Fixes: f0af34317f4b ("net: dsa: mediatek: combine MediaTek tag with VLAN tag")
Signed-off-by: DENG Qingfang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8220486f94514114d382935e8931748d789bd69a
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:18 2021 +0200
net: enetc: keep RX ring consumer index in sync with hardware
commit 3a5d12c9be6f30080600c8bacaf310194e37d029 upstream.
The RX rings have a producer index owned by hardware, where newly
received frame buffers are placed, and a consumer index owned by
software, where newly allocated buffers are placed, in expectation of
hardware being able to place frame data in them.
Hardware increments the producer index when a frame is received, however
it is not allowed to increment the producer index to match the consumer
index (RBCIR) since the ring can hold at most RBLENR[LENGTH]-1 received
BDs. Whenever the producer index matches the value of the consumer
index, the ring has no unprocessed received frames and all BDs in the
ring have been initialized/prepared by software, i.e. hardware owns all
BDs in the ring.
The code uses the next\_to\_clean variable to keep track of the producer
index, and the next\_to\_use variable to keep track of the consumer index.
The RX rings are seeded from enetc\_refill\_rx\_ring, which is called from
two places:
1. initially the ring is seeded until full with enetc\_bd\_unused(rx\_ring),
i.e. with 511 buffers. This will make next\_to\_clean=0 and next\_to\_use=511:
.ndo\_open
-> enetc\_open
-> enetc\_setup\_bdrs
-> enetc\_setup\_rxbdr
-> enetc\_refill\_rx\_ring
2. then during the data path processing, it is refilled with 16 buffers
at a time:
enetc\_msix
-> napi\_schedule
-> enetc\_poll
-> enetc\_clean\_rx\_ring
-> enetc\_refill\_rx\_ring
There is just one problem: the initial seeding done during .ndo\_open
updates just the producer index (ENETC\_RBPIR) with 0, and the software
next\_to\_clean and next\_to\_use variables. Notably, it will not update the
consumer index to make the hardware aware of the newly added buffers.
Wait, what? So how does it work?
Well, the reset values of the producer index and of the consumer index
of a ring are both zero. As per the description in the second paragraph,
it means that the ring is full of buffers waiting for hardware to put
frames in them, which by coincidence is almost true, because we have in
fact seeded 511 buffers into the ring.
But will the hardware attempt to access the 512th entry of the ring,
which has an invalid BD in it? Well, no, because in order to do that, it
would have to first populate the first 511 entries, and the NAPI
enetc\_poll will kick in by then. Eventually, after 16 processed slots
have become available in the RX ring, enetc\_clean\_rx\_ring will call
enetc\_refill\_rx\_ring and then will [ finally ] update the consumer index
with the new software next\_to\_use variable. From now on, the
next\_to\_clean and next\_to\_use variables are in sync with the producer
and consumer ring indices.
So the day is saved, right? Well, not quite. Freeing the memory
allocated for the rings is done in:
enetc\_close
-> enetc\_clear\_bdrs
-> enetc\_clear\_rxbdr
-> this just disables the ring
-> enetc\_free\_rxtx\_rings
-> enetc\_free\_rx\_ring
-> sets next\_to\_clean and next\_to\_use to 0
but again, nothing is committed to the hardware producer and consumer
indices (yay!). The assumption is that the ring is disabled, so the
indices don't matter anyway, and it's the responsibility of the "open"
code path to set those up.
.. Except that the "open" code path does not set those up properly.
While initially, things almost work, during subsequent enetc\_close ->
enetc\_open sequences, we have problems. To be precise, the enetc\_open
that is subsequent to enetc\_close will again refill the ring with 511
entries, but it will leave the consumer index untouched. Untouched
means, of course, equal to the value it had before disabling the ring
and draining the old buffers in enetc\_close.
But as mentioned, enetc\_setup\_rxbdr will at least update the producer
index though, through this line of code:
enetc\_rxbdr\_wr(hw, idx, ENETC\_RBPIR, 0);
so at this stage we'll have:
next\_to\_clean=0 (in hardware 0)
next\_to\_use=511 (in hardware we'll have the refill index prior to enetc\_close)
Again, the next\_to\_clean and producer index are in sync and set to
correct values, so the driver manages to limp on. Eventually, 16 ring
entries will be consumed by enetc\_poll, and the savior
enetc\_clean\_rx\_ring will come and call enetc\_refill\_rx\_ring, and then
update the hardware consumer ring based upon the new next\_to\_use.
So.. it works?
Well, by coincidence, it almost does, but there's a circumstance where
enetc\_clean\_rx\_ring won't be there to save us. If the previous value of
the consumer index was 15, there's a problem, because the NAPI poll
sequence will only issue a refill when 16 or more buffers have been
consumed.
It's easiest to illustrate this with an example:
ip link set eno0 up
ip addr add 192.168.100.1/24 dev eno0
ping 192.168.100.1 -c 20 # ping this port from another board
ip link set eno0 down
ip link set eno0 up
ping 192.168.100.1 -c 20 # ping it again from the same other board
One by one:
1. ip link set eno0 up
-> calls enetc\_setup\_rxbdr:
-> calls enetc\_refill\_rx\_ring(511 buffers)
-> next\_to\_clean=0 (in hw 0)
-> next\_to\_use=511 (in hw 0)
2. ping 192.168.100.1 -c 20 # ping this port from another board
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=1 next\_to\_clean 0 (in hw 1) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=2 next\_to\_clean 1 (in hw 2) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=3 next\_to\_clean 2 (in hw 3) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=4 next\_to\_clean 3 (in hw 4) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=5 next\_to\_clean 4 (in hw 5) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=6 next\_to\_clean 5 (in hw 6) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=7 next\_to\_clean 6 (in hw 7) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=8 next\_to\_clean 7 (in hw 8) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=9 next\_to\_clean 8 (in hw 9) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=10 next\_to\_clean 9 (in hw 10) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=11 next\_to\_clean 10 (in hw 11) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=12 next\_to\_clean 11 (in hw 12) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=13 next\_to\_clean 12 (in hw 13) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=14 next\_to\_clean 13 (in hw 14) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=15 next\_to\_clean 14 (in hw 15) next\_to\_use 511 (in hw 0)
enetc\_clean\_rx\_ring: enetc\_refill\_rx\_ring(16) increments next\_to\_use by 16 (mod 512) and writes it to hw
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=0 next\_to\_clean 15 (in hw 16) next\_to\_use 15 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=1 next\_to\_clean 16 (in hw 17) next\_to\_use 15 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=2 next\_to\_clean 17 (in hw 18) next\_to\_use 15 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=3 next\_to\_clean 18 (in hw 19) next\_to\_use 15 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=4 next\_to\_clean 19 (in hw 20) next\_to\_use 15 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=5 next\_to\_clean 20 (in hw 21) next\_to\_use 15 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=6 next\_to\_clean 21 (in hw 22) next\_to\_use 15 (in hw 15)
20 packets transmitted, 20 packets received, 0% packet loss
3. ip link set eno0 down
enetc\_free\_rx\_ring: next\_to\_clean 0 (in hw 22), next\_to\_use 0 (in hw 15)
4. ip link set eno0 up
-> calls enetc\_setup\_rxbdr:
-> calls enetc\_refill\_rx\_ring(511 buffers)
-> next\_to\_clean=0 (in hw 0)
-> next\_to\_use=511 (in hw 15)
5. ping 192.168.100.1 -c 20 # ping it again from the same other board
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=1 next\_to\_clean 0 (in hw 1) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=2 next\_to\_clean 1 (in hw 2) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=3 next\_to\_clean 2 (in hw 3) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=4 next\_to\_clean 3 (in hw 4) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=5 next\_to\_clean 4 (in hw 5) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=6 next\_to\_clean 5 (in hw 6) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=7 next\_to\_clean 6 (in hw 7) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=8 next\_to\_clean 7 (in hw 8) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=9 next\_to\_clean 8 (in hw 9) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=10 next\_to\_clean 9 (in hw 10) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=11 next\_to\_clean 10 (in hw 11) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=12 next\_to\_clean 11 (in hw 12) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=13 next\_to\_clean 12 (in hw 13) next\_to\_use 511 (in hw 15)
enetc\_clean\_rx\_ring: rx\_frm\_cnt=1 cleaned\_cnt=14 next\_to\_clean 13 (in hw 14) next\_to\_use 511 (in hw 15)
20 packets transmitted, 12 packets received, 40% packet loss
And there it dies. No enetc\_refill\_rx\_ring (because cleaned\_cnt must be equal
to 15 for that to happen), no nothing. The hardware enters the condition where
the producer (14) + 1 is equal to the consumer (15) index, which makes it
believe it has no more free buffers to put packets in, so it starts discarding
them:
ip netns exec ns0 ethtool -S eno0 | grep -v ': 0'
NIC statistics:
Rx ring 0 discarded frames: 8
Summarized, if the interface receives between 16 and 32 (mod 512) frames
and then there is a link flap, then the port will eventually die with no
way to recover. If it receives less than 16 (mod 512) frames, then the
initial NAPI poll [ before the link flap ] will not update the consumer
index in hardware (it will remain zero) which will be ok when the buffers
are later reinitialized. If more than 32 (mod 512) frames are received,
the initial NAPI poll has the chance to refill the ring twice, updating
the consumer index to at least 32. So after the link flap, the consumer
index is still wrong, but the post-flap NAPI poll gets a chance to
refill the ring once (because it passes through cleaned\_cnt=15) and
makes the consumer index be again back in sync with next\_to\_use.
The solution to this problem is actually simple, we just need to write
next\_to\_use into the hardware consumer index at enetc\_open time, which
always brings it back in sync after an initial buffer seeding process.
The simpler thing would be to put the write to the consumer index into
enetc\_refill\_rx\_ring directly, but there are issues with the MDIO
locking: in the NAPI poll code we have the enetc\_lock\_mdio() taken from
top-level and we use the unlocked enetc\_wr\_reg\_hot, whereas in
enetc\_open, the enetc\_lock\_mdio() is not taken at the top level, but
instead by each individual enetc\_wr\_reg, so we are forced to put an
additional enetc\_wr\_reg in enetc\_setup\_rxbdr. Better organization of
the code is left as a refactoring exercise.
Fixes: d4fd0404c1c9 ("enetc: Introduce basic PF and VF ENETC ethernet drivers")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cf01b4ba6788949daf90803d6d2cedbbb07784e5
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:17 2021 +0200
net: enetc: remove bogus write to SIRXIDR from enetc\_setup\_rxbdr
commit 96a5223b918c8b79270fc0fec235a7ebad459098 upstream.
The Station Interface Receive Interrupt Detect Register (SIRXIDR)
contains a 16-bit wide mask of 'interrupt detected' events for each ring
associated with a port. Bit i is write-1-to-clean for RX ring i.
I have no explanation whatsoever how this line of code came to be
inserted in the blamed commit. I checked the downstream versions of that
patch and none of them have it.
The somewhat comical aspect of it is that we're writing a binary number
to the SIRXIDR register, which is derived from enetc\_bd\_unused(rx\_ring).
Since the RX rings have 512 buffer descriptors, we end up writing 511 to
this register, which is 0x1ff, so we are effectively clearing the
'interrupt detected' event for rings 0-8.
This register is not what is used for interrupt handling though - it
only provides a summary for the entire SI. The hardware provides one
separate Interrupt Detect Register per RX ring, which auto-clears upon
read. So there doesn't seem to be any adverse effect caused by this
bogus write.
There is, however, one reason why this should be handled as a bugfix:
next\_to\_clean \_should\_ be committed to hardware, just not to that
register, and this was obscuring the fact that it wasn't. This is fixed
in the next patch, and removing the bogus line now allows the fix patch
to be backported beyond that point.
Fixes: fd5736bf9f23 ("enetc: Workaround for MDIO register access issue")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6997660f384dc63cf0c64f0844ffd6333516c8a5
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:16 2021 +0200
net: enetc: force the RGMII speed and duplex instead of operating in inband mode
commit c76a97218dcbb2cb7cec1404ace43ef96c87d874 upstream.
The ENETC port 0 MAC supports in-band status signaling coming from a PHY
when operating in RGMII mode, and this feature is enabled by default.
It has been reported that RGMII is broken in fixed-link, and that is not
surprising considering the fact that no PHY is attached to the MAC in
that case, but a switch.
This brings us to the topic of the patch: the enetc driver should have
not enabled the optional in-band status signaling for RGMII unconditionally,
but should have forced the speed and duplex to what was resolved by
phylink.
Note that phylink does not accept the RGMII modes as valid for in-band
signaling, and these operate a bit differently than 1000base-x and SGMII
(notably there is no clause 37 state machine so no ACK required from the
MAC, instead the PHY sends extra code words on RXD[3:0] whenever it is
not transmitting something else, so it should be safe to leave a PHY
with this option unconditionally enabled even if we ignore it). The spec
talks about this here:
https://e2e.ti.com/cfs-file/\_\_key/communityserver-discussions-components-files/138/RGMIIv1\_5F00\_3.pdf
Fixes: 71b77a7a27a3 ("enetc: Migrate to PHYLINK and PCS\_LYNX")
Cc: Florian Fainelli
Cc: Andrew Lunn
Cc: Russell King
Signed-off-by: Vladimir Oltean
Acked-by: Russell King
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 272db1b7f5aab6d0843bfe9c25f77a68e376f32f
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:15 2021 +0200
net: enetc: don't disable VLAN filtering in IFF\_PROMISC mode
commit a74dbce9d4541888fe0d39afe69a3a95004669b4 upstream.
Quoting from the blamed commit:
In promiscuous mode, it is more intuitive that all traffic is received,
including VLAN tagged traffic. It appears that it is necessary to set
the flag in PSIPVMR for that to be the case, so VLAN promiscuous mode is
also temporarily enabled. On exit from promiscuous mode, the setting
made by ethtool is restored.
Intuitive or not, there isn't any definition issued by a standards body
which says that promiscuity has anything to do with VLAN filtering - it
only has to do with accepting packets regardless of destination MAC address.
In fact people are already trying to use this misunderstanding/bug of
the enetc driver as a justification to transform promiscuity into
something it never was about: accepting every packet (maybe that would
be the "rx-all" netdev feature?):
https://lore.kernel.org/netdev/20201110153958.ci5ekor3o2ekg3ky@ipetronik.com/
This is relevant because there are use cases in the kernel (such as
tc-flower rules with the protocol 802.1Q and a vlan\_id key) which do not
(yet) use the vlan\_vid\_add API to be compatible with VLAN-filtering NICs
such as enetc, so for those, disabling rx-vlan-filter is currently the
only right solution to make these setups work:
https://lore.kernel.org/netdev/CA+h21hoxwRdhq4y+w8Kwgm74d4cA0xLeiHTrmT-VpSaM7obhkg@mail.gmail.com/
The blamed patch has unintentionally introduced one more way for this to
work, which is to enable IFF\_PROMISC, however this is non-portable
because port promiscuity is not meant to disable VLAN filtering.
Therefore, it could invite people to write broken scripts for enetc, and
then wonder why they are broken when migrating to other drivers that
don't handle promiscuity in the same way.
Fixes: 7070eea5e95a ("enetc: permit configuration of rx-vlan-filter with ethtool")
Cc: Markus Blöchl
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6db63b552ae54e97941d6a6a16fb5a1f31c59161
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:14 2021 +0200
net: enetc: fix incorrect TPID when receiving 802.1ad tagged packets
commit 827b6fd046516af605e190c872949f22208b5d41 upstream.
When the enetc ports have rx-vlan-offload enabled, they report a TPID of
ETH\_P\_8021Q regardless of what was actually in the packet. When
rx-vlan-offload is disabled, packets have the proper TPID. Fix this
inconsistency by finishing the TODO left in the code.
Fixes: d4fd0404c1c9 ("enetc: Introduce basic PF and VF ENETC ethernet drivers")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ff966263f5f9fdf9740f03fed0762ce73c230a6a
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:13 2021 +0200
net: enetc: take the MDIO lock only once per NAPI poll cycle
commit 6d36ecdbc4410e61a0e02adc5d3abeee22a8ffd3 upstream.
The workaround for the ENETC MDIO erratum caused a performance
degradation of 82 Kpps (seen with IP forwarding of two 1Gbps streams of
64B packets). This is due to excessive locking and unlocking in the fast
path, which can be avoided.
By taking the MDIO read-side lock only once per NAPI poll cycle, we are
able to regain 54 Kpps (65%) of the performance hit. The rest of the
performance degradation comes from the TX data path, but unfortunately
it doesn't look like we can optimize that away easily, even with
netdev\_xmit\_more(), there just isn't any skb batching done, to help with
taking the MDIO lock less often than once per packet.
We need to change the register accessor type for enetc\_get\_tx\_tstamp,
because it now runs under the enetc\_lock\_mdio as per the new call path
detailed below:
enetc\_msix
-> napi\_schedule
-> enetc\_poll
-> enetc\_lock\_mdio
-> enetc\_clean\_tx\_ring
-> enetc\_get\_tx\_tstamp
-> enetc\_clean\_rx\_ring
-> enetc\_unlock\_mdio
Fixes: fd5736bf9f23 ("enetc: Workaround for MDIO register access issue")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5fb230e6334111bf44b07d4ad6cb621546a8f59d
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:12 2021 +0200
net: enetc: initialize RFS/RSS memories for unused ports too
commit 3222b5b613db558e9a494bbf53f3c984d90f71ea upstream.
Michael reports that since linux-next-20210211, the AER messages for ECC
errors have started reappearing, and this time they can be reliably
reproduced with the first ping on one of his LS1028A boards.
$ ping 1[ 33.258069] pcieport 0000:00:1f.0: AER: Multiple Corrected error received: 0000:00:00.0
72.16.0.1
PING [ 33.267050] pcieport 0000:00:1f.0: AER: can't find device of ID0000
172.16.0.1 (172.16.0.1): 56 data bytes
64 bytes from 172.16.0.1: seq=0 ttl=64 time=17.124 ms
64 bytes from 172.16.0.1: seq=1 ttl=64 time=0.273 ms
$ devmem 0x1f8010e10 32
0xC0000006
It isn't clear why this is necessary, but it seems that for the errors
to go away, we must clear the entire RFS and RSS memory, not just for
the ports in use.
Sadly the code is structured in such a way that we can't have unified
logic for the used and unused ports. For the minimal initialization of
an unused port, we need just to enable and ioremap the PF memory space,
and a control buffer descriptor ring. Unused ports must then free the
CBDR because the driver will exit, but used ports can not pick up from
where that code path left, since the CBDR API does not reinitialize a
ring when setting it up, so its producer and consumer indices are out of
sync between the software and hardware state. So a separate
enetc\_init\_unused\_port function was created, and it gets called right
after the PF memory space is enabled.
Fixes: 07bf34a50e32 ("net: enetc: initialize the RFS and RSS memories")
Reported-by: Michael Walle
Cc: Jesse Brandeburg
Signed-off-by: Vladimir Oltean
Tested-by: Michael Walle
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6a1d94af43bad9b0333c920e7c9f8574124c75c2
Author: Vladimir Oltean
Date: Mon Mar 1 13:18:11 2021 +0200
net: enetc: don't overwrite the RSS indirection table when initializing
commit c646d10dda2dcde82c6ce5a474522621ab2b8b19 upstream.
After the blamed patch, all RX traffic gets hashed to CPU 0 because the
hashing indirection table set up in:
enetc\_pf\_probe
-> enetc\_alloc\_si\_resources
-> enetc\_configure\_si
-> enetc\_setup\_default\_rss\_table
is overwritten later in:
enetc\_pf\_probe
-> enetc\_init\_port\_rss\_memory
which zero-initializes the entire port RSS table in order to avoid ECC errors.
The trouble really is that enetc\_init\_port\_rss\_memory really neads
enetc\_alloc\_si\_resources to be called, because it depends upon
enetc\_alloc\_cbdr and enetc\_setup\_cbdr. But that whole enetc\_configure\_si
thing could have been better thought out, it has nothing to do in a
function called "alloc\_si\_resources", especially since its counterpart,
"free\_si\_resources", does nothing to unwind the configuration of the SI.
The point is, we need to pull out enetc\_configure\_si out of
enetc\_alloc\_resources, and move it after enetc\_init\_port\_rss\_memory.
This allows us to set up the default RSS indirection table after
initializing the memory.
Fixes: 07bf34a50e32 ("net: enetc: initialize the RFS and RSS memories")
Cc: Jesse Brandeburg
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 05f23acf9083611a56de1fdb0d52136e57951a42
Author: Sergey Shtylyov
Date: Sun Feb 28 23:25:43 2021 +0300
sh\_eth: fix TRSCER mask for SH771x
commit 8c91bc3d44dfef8284af384877fbe61117e8b7d1 upstream.
According to the SH7710, SH7712, SH7713 Group User's Manual: Hardware,
Rev. 3.00, the TRSCER register actually has only bit 7 valid (and named
differently), with all the other bits reserved. Apparently, this was not
the case with some early revisions of the manual as we have the other
bits declared (and set) in the original driver. Follow the suit and add
the explicit sh\_eth\_cpu\_data::trscer\_err\_mask initializer for SH771x...
Fixes: 86a74ff21a7a ("net: sh\_eth: add support for Renesas SuperH Ethernet")
Signed-off-by: Sergey Shtylyov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 74563632e33779f16c1cc040cf0ef35e9163743b
Author: DENG Qingfang
Date: Mon Mar 1 01:08:23 2021 +0800
net: dsa: tag\_rtl4\_a: fix egress tags
commit 9eb8bc593a5eed167dac2029abef343854c5ba75 upstream.
Commit 86dd9868b878 has several issues, but was accepted too soon
before anyone could take a look.
- Double free. dsa\_slave\_xmit() will free the skb if the xmit function
returns NULL, but the skb is already freed by eth\_skb\_pad(). Use
\_\_skb\_put\_padto() to avoid that.
- Unnecessary allocation. It has been done by DSA core since commit
a3b0b6479700.
- A u16 pointer points to skb data. It should be \_\_be16 for network
byte order.
- Typo in comments. "numer" -> "number".
Fixes: 86dd9868b878 ("net: dsa: tag\_rtl4\_a: Support also egress tags")
Signed-off-by: DENG Qingfang
Reviewed-by: Florian Fainelli
Reviewed-by: Linus Walleij
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 95cafdf41f1893c3690011ddd031d5c233b33f9a
Author: Jakub Kicinski
Date: Tue Mar 2 18:46:43 2021 -0800
docs: networking: drop special stable handling
commit dbbe7c962c3a8163bf724dbc3c9fdfc9b16d3117 upstream.
Leave it to Greg.
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e410aad6f3825d1782727cfd2ee48adc9fc518e2
Author: Linus Torvalds
Date: Wed Mar 10 10:18:04 2021 -0800
Revert "mm, slub: consider rest of partial list if acquire\_slab() fails"
commit 9b1ea29bc0d7b94d420f96a0f4121403efc3dd85 upstream.
This reverts commit 8ff60eb052eeba95cfb3efe16b08c9199f8121cf.
The kernel test robot reports a huge performance regression due to the
commit, and the reason seems fairly straightforward: when there is
contention on the page list (which is what causes acquire\_slab() to
fail), we do \_not\_ want to just loop and try again, because that will
transfer the contention to the 'n->list\_lock' spinlock we hold, and
just make things even worse.
This is admittedly likely a problem only on big machines - the kernel
test robot report comes from a 96-thread dual socket Intel Xeon Gold
6252 setup, but the regression there really is quite noticeable:
-47.9% regression of stress-ng.rawpkt.ops\_per\_sec
and the commit that was marked as being fixed (7ced37197196: "slub:
Acquire\_slab() avoid loop") actually did the loop exit early very
intentionally (the hint being that "avoid loop" part of that commit
message), exactly to avoid this issue.
The correct thing to do may be to pick some kind of reasonable middle
ground: instead of breaking out of the loop on the very first sign of
contention, or trying over and over and over again, the right thing may
be to re-try \_once\_, and then give up on the second failure (or pick
your favorite value for "once"..).
Reported-by: kernel test robot
Link: https://lore.kernel.org/lkml/20210301080404.GF12822@xsang-OptiPlex-9020/
Cc: Jann Horn
Cc: David Rientjes
Cc: Joonsoo Kim
Acked-by: Christoph Lameter
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit f8f1613b1581f824d0dae2977e49b966e0de91b7
Author: Paulo Alcantara
Date: Mon Mar 8 12:00:49 2021 -0300
cifs: return proper error code in statfs(2)
commit 14302ee3301b3a77b331cc14efb95bf7184c73cc upstream.
In cifs\_statfs(), if server->ops->queryfs is not NULL, then we should
use its return value rather than always returning 0. Instead, use rc
variable as it is properly set to 0 in case there is no
server->ops->queryfs.
Signed-off-by: Paulo Alcantara (SUSE)
Reviewed-by: Aurelien Aptel
Reviewed-by: Ronnie Sahlberg
CC:
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 6e9c30bcbdc8cb60a3a9d7fa04802289ad39f5db
Author: Aurelien Aptel
Date: Thu Mar 4 17:42:21 2021 +0000
cifs: fix credit accounting for extra channel
commit a249cc8bc2e2fed680047d326eb9a50756724198 upstream.
With multichannel, operations like the queries
from "ls -lR" can cause all credits to be used and
errors to be returned since max\_credits was not
being set correctly on the secondary channels and
thus the client was requesting 0 credits incorrectly
in some cases (which can lead to not having
enough credits to perform any operation on that
channel).
Signed-off-by: Aurelien Aptel
CC:  # v5.8+
Reviewed-by: Shyam Prasad N
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 2d71f1c1cecb6a143e7485fe0f19b4c6631cc7bd
Author: Christian Brauner
Date: Sat Mar 6 11:10:10 2021 +0100
mount: fix mounting of detached mounts onto targets that reside on shared mounts
commit ee2e3f50629f17b0752b55b2566c15ce8dafb557 upstream.
Creating a series of detached mounts, attaching them to the filesystem,
and unmounting them can be used to trigger an integer overflow in
ns->mounts causing the kernel to block any new mounts in count\_mounts()
and returning ENOSPC because it falsely assumes that the maximum number
of mounts in the mount namespace has been reached, i.e. it thinks it
can't fit the new mounts into the mount namespace anymore.
Depending on the number of mounts in your system, this can be reproduced
on any kernel that supportes open\_tree() and move\_mount() by compiling
and running the following program:
/\* SPDX-License-Identifier: LGPL-2.1+ \*/
#define \_GNU\_SOURCE
#include
#include
#include
#include
#include
#include
#include
#include
#include
#include
#include
#include
#include
/\* open\_tree() \*/
#ifndef OPEN\_TREE\_CLONE
#define OPEN\_TREE\_CLONE 1
#endif
#ifndef OPEN\_TREE\_CLOEXEC
#define OPEN\_TREE\_CLOEXEC O\_CLOEXEC
#endif
#ifndef \_\_NR\_open\_tree
#if defined \_\_alpha\_\_
#define \_\_NR\_open\_tree 538
#elif defined \_MIPS\_SIM
#if \_MIPS\_SIM == \_MIPS\_SIM\_ABI32 /\* o32 \*/
#define \_\_NR\_open\_tree 4428
#endif
#if \_MIPS\_SIM == \_MIPS\_SIM\_NABI32 /\* n32 \*/
#define \_\_NR\_open\_tree 6428
#endif
#if \_MIPS\_SIM == \_MIPS\_SIM\_ABI64 /\* n64 \*/
#define \_\_NR\_open\_tree 5428
#endif
#elif defined \_\_ia64\_\_
#define \_\_NR\_open\_tree (428 + 1024)
#else
#define \_\_NR\_open\_tree 428
#endif
#endif
/\* move\_mount() \*/
#ifndef MOVE\_MOUNT\_F\_EMPTY\_PATH
#define MOVE\_MOUNT\_F\_EMPTY\_PATH 0x00000004 /\* Empty from path permitted \*/
#endif
#ifndef \_\_NR\_move\_mount
#if defined \_\_alpha\_\_
#define \_\_NR\_move\_mount 539
#elif defined \_MIPS\_SIM
#if \_MIPS\_SIM == \_MIPS\_SIM\_ABI32 /\* o32 \*/
#define \_\_NR\_move\_mount 4429
#endif
#if \_MIPS\_SIM == \_MIPS\_SIM\_NABI32 /\* n32 \*/
#define \_\_NR\_move\_mount 6429
#endif
#if \_MIPS\_SIM == \_MIPS\_SIM\_ABI64 /\* n64 \*/
#define \_\_NR\_move\_mount 5429
#endif
#elif defined \_\_ia64\_\_
#define \_\_NR\_move\_mount (428 + 1024)
#else
#define \_\_NR\_move\_mount 429
#endif
#endif
static inline int sys\_open\_tree(int dfd, const char \*filename, unsigned int flags)
{
return syscall(\_\_NR\_open\_tree, dfd, filename, flags);
}
static inline int sys\_move\_mount(int from\_dfd, const char \*from\_pathname, int to\_dfd,
const char \*to\_pathname, unsigned int flags)
{
return syscall(\_\_NR\_move\_mount, from\_dfd, from\_pathname, to\_dfd, to\_pathname, flags);
}
static bool is\_shared\_mountpoint(const char \*path)
{
bool shared = false;
FILE \*f = NULL;
char \*line = NULL;
int i;
size\_t len = 0;
f = fopen("/proc/self/mountinfo", "re");
if (!f)
return 0;
while (getline(&line, &len, f) > 0) {
char \*slider1, \*slider2;
for (slider1 = line, i = 0; slider1 && i < 4; i++)
slider1 = strchr(slider1 + 1, ' ');
if (!slider1)
continue;
slider2 = strchr(slider1 + 1, ' ');
if (!slider2)
continue;
\*slider2 = '\0';
if (strcmp(slider1 + 1, path) == 0) {
/\* This is the path. Is it shared? \*/
slider1 = strchr(slider2 + 1, ' ');
if (slider1 && strstr(slider1, "shared:")) {
shared = true;
break;
}
}
}
fclose(f);
free(line);
return shared;
}
static void usage(void)
{
const char \*text = "mount-new [--recursive] \n";
fprintf(stderr, "%s", text);
\_exit(EXIT\_SUCCESS);
}
#define exit\_usage(format, ...) \
({ \
fprintf(stderr, format "\n", ##\_\_VA\_ARGS\_\_); \
usage(); \
})
#define exit\_log(format, ...) \
({ \
fprintf(stderr, format "\n", ##\_\_VA\_ARGS\_\_); \
exit(EXIT\_FAILURE); \
})
static const struct option longopts[] = {
{"help", no\_argument, 0, 'a'},
{ NULL, no\_argument, 0, 0 },
};
int main(int argc, char \*argv[])
{
int exit\_code = EXIT\_SUCCESS, index = 0;
int dfd, fd\_tree, new\_argc, ret;
char \*base\_dir;
char \*const \*new\_argv;
char target[PATH\_MAX];
while ((ret = getopt\_long\_only(argc, argv, "", longopts, &index)) != -1) {
switch (ret) {
case 'a':
/\* fallthrough \*/
default:
usage();
}
}
new\_argv = &argv[optind];
new\_argc = argc - optind;
if (new\_argc < 1)
exit\_usage("Missing base directory\n");
base\_dir = new\_argv[0];
if (\*base\_dir != '/')
exit\_log("Please specify an absolute path");
/\* Ensure that target is a shared mountpoint. \*/
if (!is\_shared\_mountpoint(base\_dir))
exit\_log("Please ensure that \"%s\" is a shared mountpoint", base\_dir);
dfd = open(base\_dir, O\_RDONLY | O\_DIRECTORY | O\_CLOEXEC);
if (dfd < 0)
exit\_log("%m - Failed to open base directory \"%s\"", base\_dir);
ret = mkdirat(dfd, "detached-move-mount", 0755);
if (ret < 0)
exit\_log("%m - Failed to create required temporary directories");
ret = snprintf(target, sizeof(target), "%s/detached-move-mount", base\_dir);
if (ret < 0 || (size\_t)ret >= sizeof(target))
exit\_log("%m - Failed to assemble target path");
/\*
\* Having a mount table with 10000 mounts is already quite excessive
\* and shoult account even for weird test systems.
\*/
for (size\_t i = 0; i < 10000; i++) {
fd\_tree = sys\_open\_tree(dfd, "detached-move-mount",
OPEN\_TREE\_CLONE |
OPEN\_TREE\_CLOEXEC |
AT\_EMPTY\_PATH);
if (fd\_tree < 0) {
fprintf(stderr, "%m - Failed to open %d(detached-move-mount)", dfd);
exit\_code = EXIT\_FAILURE;
break;
}
ret = sys\_move\_mount(fd\_tree, "", dfd, "detached-move-mount", MOVE\_MOUNT\_F\_EMPTY\_PATH);
if (ret < 0) {
if (errno == ENOSPC)
fprintf(stderr, "%m - Buggy mount counting");
else
fprintf(stderr, "%m - Failed to attach mount to %d(detached-move-mount)", dfd);
exit\_code = EXIT\_FAILURE;
break;
}
close(fd\_tree);
ret = umount2(target, MNT\_DETACH);
if (ret < 0) {
fprintf(stderr, "%m - Failed to unmount %s", target);
exit\_code = EXIT\_FAILURE;
break;
}
}
(void)unlinkat(dfd, "detached-move-mount", AT\_REMOVEDIR);
close(dfd);
exit(exit\_code);
}
and wait for the kernel to refuse any new mounts by returning ENOSPC.
How many iterations are needed depends on the number of mounts in your
system. Assuming you have something like 50 mounts on a standard system
it should be almost instantaneous.
The root cause of this is that detached mounts aren't handled correctly
when source and target mount are identical and reside on a shared mount
causing a broken mount tree where the detached source itself is
propagated which propagation prevents for regular bind-mounts and new
mounts. This ultimately leads to a miscalculation of the number of
mounts in the mount namespace.
Detached mounts created via
open\_tree(fd, path, OPEN\_TREE\_CLONE)
are essentially like an unattached new mount, or an unattached
bind-mount. They can then later on be attached to the filesystem via
move\_mount() which calls into attach\_recursive\_mount(). Part of
attaching it to the filesystem is making sure that mounts get correctly
propagated in case the destination mountpoint is MS\_SHARED, i.e. is a
shared mountpoint. This is done by calling into propagate\_mnt() which
walks the list of peers calling propagate\_one() on each mount in this
list making sure it receives the propagation event.
The propagate\_one() functions thereby skips both new mounts and bind
mounts to not propagate them "into themselves". Both are identified by
checking whether the mount is already attached to any mount namespace in
mnt->mnt\_ns. The is what the IS\_MNT\_NEW() helper is responsible for.
However, detached mounts have an anonymous mount namespace attached to
them stashed in mnt->mnt\_ns which means that IS\_MNT\_NEW() doesn't
realize they need to be skipped causing the mount to propagate "into
itself" breaking the mount table and causing a disconnect between the
number of mounts recorded as being beneath or reachable from the target
mountpoint and the number of mounts actually recorded/counted in
ns->mounts ultimately causing an overflow which in turn prevents any new
mounts via the ENOSPC issue.
So teach propagation to handle detached mounts by making it aware of
them. I've been tracking this issue down for the last couple of days and
then verifying that the fix is correct by
unmounting everything in my current mount table leaving only /proc and
/sys mounted and running the reproducer above overnight verifying the
number of mounts counted in ns->mounts. With this fix the counts are
correct and the ENOSPC issue can't be reproduced.
This change will only have an effect on mounts created with the new
mount API since detached mounts cannot be created with the old mount API
so regressions are extremely unlikely.
Link: https://lore.kernel.org/r/20210306101010.243666-1-christian.brauner@ubuntu.com
Fixes: 2db154b3ea8e ("vfs: syscall: Add move\_mount(2) to move mounts around")
Cc: David Howells
Cc: Al Viro
Cc: linux-fsdevel@vger.kernel.org
Cc:
Reviewed-by: Christoph Hellwig
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit ad83fa5a15a6a394718ae4034a44d58904acabd1
Author: Johan Hovold
Date: Mon Mar 1 10:05:19 2021 +0100
gpio: fix gpio-device list corruption
commit cf25ef6b631c6fc6c0435fc91eba8734cca20511 upstream.
Make sure to hold the gpio\_lock when removing the gpio device from the
gpio\_devices list (when dropping the last reference) to avoid corrupting
the list when there are concurrent accesses.
Fixes: ff2b13592299 ("gpio: make the gpiochip a real device")
Cc: stable@vger.kernel.org # 4.6
Reviewed-by: Saravana Kannan
Signed-off-by: Johan Hovold
Signed-off-by: Bartosz Golaszewski
[ johan: adjust context to 5.11 ]
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 9b9c21c218c03ad4815e120e08d4b5aa26a72607
Author: Lorenzo Bianconi
Date: Sun Feb 7 12:48:31 2021 +0100
mt76: dma: do not report truncated frames to mac80211
commit d0bd52c591a1070c54dc428e926660eb4f981099 upstream.
Commit b102f0c522cf6 ("mt76: fix array overflow on receiving too many
fragments for a packet") fixes a possible OOB access but it introduces a
memory leak since the pending frame is not released to page\_frag\_cache
if the frag array of skb\_shared\_info is full. Commit 93a1d4791c10
("mt76: dma: fix a possible memory leak in mt76\_add\_fragment()") fixes
the issue but does not free the truncated skb that is forwarded to
mac80211 layer. Fix the leftover issue discarding even truncated skbs.
Fixes: 93a1d4791c10 ("mt76: dma: fix a possible memory leak in mt76\_add\_fragment()")
Signed-off-by: Lorenzo Bianconi
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/a03166fcc8214644333c68674a781836e0f57576.1612697217.git.lorenzo@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 70a43e24f58e8002bbebeff165f484927ae1d375
Author: Junlin Yang
Date: Fri Mar 5 16:48:39 2021 +0800
ibmvnic: remove excessive irqsave
commit 69cdb7947adb816fc9325b4ec02a6dddd5070b82 upstream.
ibmvnic\_remove locks multiple spinlocks while disabling interrupts:
spin\_lock\_irqsave(&adapter->state\_lock, flags);
spin\_lock\_irqsave(&adapter->rwi\_lock, flags);
As reported by coccinelle, the second \_irqsave() overwrites the value
saved in 'flags' by the first \_irqsave(), therefore when the second
\_irqrestore() comes,the value in 'flags' is not valid,the value saved
by the first \_irqsave() has been lost.
This likely leads to IRQs remaining disabled. So remove the second
\_irqsave():
spin\_lock\_irqsave(&adapter->state\_lock, flags);
spin\_lock(&adapter->rwi\_lock);
Generated by: ./scripts/coccinelle/locks/flags.cocci
./drivers/net/ethernet/ibm/ibmvnic.c:5413:1-18:
ERROR: nested lock+irqsave that reuses flags from line 5404.
Fixes: 4a41c421f367 ("ibmvnic: serialize access to work queue on remove")
Signed-off-by: Junlin Yang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7ff7b1a6d6e6f982370faf75a32f8f3f0f98b0ca
Author: Jiri Wiesner
Date: Thu Mar 4 17:18:28 2021 +0100
ibmvnic: always store valid MAC address
commit 67eb211487f0c993d9f402d1c196ef159fd6a3b5 upstream.
The last change to ibmvnic\_set\_mac(), 8fc3672a8ad3, meant to prevent
users from setting an invalid MAC address on an ibmvnic interface
that has not been brought up yet. The change also prevented the
requested MAC address from being stored by the adapter object for an
ibmvnic interface when the state of the ibmvnic interface is
VNIC\_PROBED - that is after probing has finished but before the
ibmvnic interface is brought up. The MAC address stored by the
adapter object is used and sent to the hypervisor for checking when
an ibmvnic interface is brought up.
The ibmvnic driver ignoring the requested MAC address when in
VNIC\_PROBED state caused LACP bonds (bonds in 802.3ad mode) with more
than one slave to malfunction. The bonding code must be able to
change the MAC address of its slaves before they are brought up
during enslaving. The inability of kernels with 8fc3672a8ad3 to set
the MAC addresses of bonding slaves is observable in the output of
"ip address show". The MAC addresses of the slaves are the same as
the MAC address of the bond on a working system whereas the slaves
retain their original MAC addresses on a system with a malfunctioning
LACP bond.
Fixes: 8fc3672a8ad3 ("ibmvnic: fix ibmvnic\_set\_mac")
Signed-off-by: Jiri Wiesner
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e6e77eda7286efcc184d209b4e537db2ca2eda20
Author: Michal Suchanek
Date: Tue Mar 2 20:47:47 2021 +0100
ibmvnic: Fix possibly uninitialized old\_num\_tx\_queues variable warning.
commit 6881b07fdd24850def1f03761c66042b983ff86e upstream.
GCC 7.5 reports:
../drivers/net/ethernet/ibm/ibmvnic.c: In function 'ibmvnic\_reset\_init':
../drivers/net/ethernet/ibm/ibmvnic.c:5373:51: warning: 'old\_num\_tx\_queues' may be used uninitialized in this function [-Wmaybe-uninitialized]
../drivers/net/ethernet/ibm/ibmvnic.c:5373:6: warning: 'old\_num\_rx\_queues' may be used uninitialized in this function [-Wmaybe-uninitialized]
The variable is initialized only if(reset) and used only if(reset &&
something) so this is a false positive. However, there is no reason to
not initialize the variables unconditionally avoiding the warning.
Fixes: 635e442f4a48 ("ibmvnic: merge ibmvnic\_reset\_init and ibmvnic\_init")
Signed-off-by: Michal Suchanek
Reviewed-by: Sukadev Bhattiprolu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit badba52f7bfcc2060161d07497c346f42d337285
Author: Maciej Fijalkowski
Date: Wed Mar 3 19:56:36 2021 +0100
libbpf: Clear map\_info before each bpf\_obj\_get\_info\_by\_fd
commit 2b2aedabc44e9660f90ccf7ba1ca2706d75f411f upstream.
xsk\_lookup\_bpf\_maps, based on prog\_fd, looks whether current prog has a
reference to XSKMAP. BPF prog can include insns that work on various BPF
maps and this is covered by iterating through map\_ids.
The bpf\_map\_info that is passed to bpf\_obj\_get\_info\_by\_fd for filling
needs to be cleared at each iteration, so that it doesn't contain any
outdated fields and that is currently missing in the function of
interest.
To fix that, zero-init map\_info via memset before each
bpf\_obj\_get\_info\_by\_fd call.
Also, since the area of this code is touched, in general strcmp is
considered harmful, so let's convert it to strncmp and provide the
size of the array name for current map\_info.
While at it, do s/continue/break/ once we have found the xsks\_map to
terminate the search.
Fixes: 5750902a6e9b ("libbpf: proper XSKMAP cleanup")
Signed-off-by: Maciej Fijalkowski
Signed-off-by: Daniel Borkmann
Acked-by: Björn Töpel
Link: https://lore.kernel.org/bpf/20210303185636.18070-4-maciej.fijalkowski@intel.com
Signed-off-by: Greg Kroah-Hartman
commit ad9704ef14d0b24e18593cb0ff182a1bd8f9004f
Author: Maciej Fijalkowski
Date: Wed Mar 3 19:56:35 2021 +0100
samples, bpf: Add missing munmap in xdpsock
commit 6bc6699881012b5bd5d49fa861a69a37fc01b49c upstream.
We mmap the umem region, but we never munmap it.
Add the missing call at the end of the cleanup.
Fixes: 3945b37a975d ("samples/bpf: use hugepages in xdpsock app")
Signed-off-by: Maciej Fijalkowski
Signed-off-by: Daniel Borkmann
Acked-by: Björn Töpel
Link: https://lore.kernel.org/bpf/20210303185636.18070-3-maciej.fijalkowski@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 8bc6d1c56d92e730ed5244a304f26af80499c7cc
Author: Yauheni Kaliuta
Date: Sun Feb 28 12:30:17 2021 +0200
selftests/bpf: Mask bpf\_csum\_diff() return value to 16 bits in test\_verifier
commit 6185266c5a853bb0f2a459e3ff594546f277609b upstream.
The verifier test labelled "valid read map access into a read-only array
2" calls the bpf\_csum\_diff() helper and checks its return value. However,
architecture implementations of csum\_partial() (which is what the helper
uses) differ in whether they fold the return value to 16 bit or not. For
example, x86 version has ...
if (unlikely(odd)) {
result = from32to16(result);
result = ((result >> 8) & 0xff) | ((result & 0xff) << 8);
}
... while generic lib/checksum.c does:
result = from32to16(result);
if (odd)
result = ((result >> 8) & 0xff) | ((result & 0xff) << 8);
This makes the helper return different values on different architectures,
breaking the test on non-x86. To fix this, add an additional instruction
to always mask the return value to 16 bits, and update the expected return
value accordingly.
Fixes: fb2abb73e575 ("bpf, selftest: test {rd, wr}only flags and direct value access")
Signed-off-by: Yauheni Kaliuta
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20210228103017.320240-1-yauheni.kaliuta@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit 02e58f0aa436299d07c5dfe65538075e5a61a638
Author: Hangbin Liu
Date: Wed Feb 24 16:14:03 2021 +0800
selftests/bpf: No need to drop the packet when there is no geneve opt
commit 557c223b643a35effec9654958d8edc62fd2603a upstream.
In bpf geneve tunnel test we set geneve option on tx side. On rx side we
only call bpf\_skb\_get\_tunnel\_opt(). Since commit 9c2e14b48119 ("ip\_tunnels:
Set tunnel option flag when tunnel metadata is present") geneve\_rx() will
not add TUNNEL\_GENEVE\_OPT flag if there is no geneve option, which cause
bpf\_skb\_get\_tunnel\_opt() return ENOENT and \_geneve\_get\_tunnel() in
test\_tunnel\_kern.c drop the packet.
As it should be valid that bpf\_skb\_get\_tunnel\_opt() return error when
there is not tunnel option, there is no need to drop the packet and
break all geneve rx traffic. Just set opt\_class to 0 in this test and
keep returning TC\_ACT\_OK.
Fixes: 933a741e3b82 ("selftests/bpf: bpf tunnel test.")
Signed-off-by: Hangbin Liu
Signed-off-by: Daniel Borkmann
Acked-by: William Tu
Link: https://lore.kernel.org/bpf/20210224081403.1425474-1-liuhangbin@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 2073eca18603a7d4dee90dbaba5908169b627eef
Author: Ilya Leoshkevich
Date: Sat Feb 27 06:17:26 2021 +0100
selftests/bpf: Use the last page in test\_snprintf\_btf on s390
commit 42a382a466a967dc053c73b969cd2ac2fec502cf upstream.
test\_snprintf\_btf fails on s390, because NULL points to a readable
struct lowcore there. Fix by using the last page instead.
Error message example:
printing fffffffffffff000 should generate error, got (361)
Fixes: 076a95f5aff2 ("selftests/bpf: Add bpf\_snprintf\_btf helper tests")
Signed-off-by: Ilya Leoshkevich
Signed-off-by: Daniel Borkmann
Acked-by: Heiko Carstens
Acked-by: Yonghong Song
Link: https://lore.kernel.org/bpf/20210227051726.121256-1-iii@linux.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit 3e14c42627f2cdac58ad9e036eee72240d1d8435
Author: Guangbin Huang
Date: Sat Feb 27 11:05:58 2021 +0800
net: phy: fix save wrong speed and duplex problem if autoneg is on
commit d9032dba5a2b2bbf0fdce67c8795300ec9923b43 upstream.
If phy uses generic driver and autoneg is on, enter command
"ethtool -s eth0 speed 50" will not change phy speed actually, but
command "ethtool eth0" shows speed is 50Mb/s because phydev->speed
has been set to 50 and no update later.
And duplex setting has same problem too.
However, if autoneg is on, phy only changes speed and duplex according to
phydev->advertising, but not phydev->speed and phydev->duplex. So in this
case, phydev->speed and phydev->duplex don't need to be set in function
phy\_ethtool\_ksettings\_set() if autoneg is on.
Fixes: 51e2a3846eab ("PHY: Avoid unnecessary aneg restarts")
Signed-off-by: Guangbin Huang
Signed-off-by: Huazhong Tan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 226d1438c67c7e1fa2b1807dfe8386adce5866ee
Author: Jason A. Donenfeld
Date: Sat Feb 27 01:40:19 2021 +0100
net: always use icmp{,v6}\_ndo\_send from ndo\_start\_xmit
commit 4372339efc06bc2a796f4cc9d0a7a929dfda4967 upstream.
There were a few remaining tunnel drivers that didn't receive the prior
conversion to icmp{,v6}\_ndo\_send. Knowing now that this could lead to
memory corrution (see ee576c47db60 ("net: icmp: pass zeroed opts from
icmp{,v6}\_ndo\_send before sending") for details), there's even more
imperative to have these all converted. So this commit goes through the
remaining cases that I could find and does a boring translation to the
ndo variety.
The Fixes: line below is the merge that originally added icmp{,v6}\_
ndo\_send and converted the first batch of icmp{,v6}\_send users. The
rationale then for the change applies equally to this patch. It's just
that these drivers were left out of the initial conversion because these
network devices are hiding in net/ rather than in drivers/net/.
Cc: Florian Westphal
Cc: Willem de Bruijn
Cc: David S. Miller
Cc: Hideaki YOSHIFUJI
Cc: David Ahern
Cc: Jakub Kicinski
Cc: Steffen Klassert
Fixes: 803381f9f117 ("Merge branch 'icmp-account-for-NAT-when-sending-icmps-from-ndo-layer'")
Signed-off-by: Jason A. Donenfeld
Acked-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit be70d3dd9f7bd207d466e59744f4515a067339e3
Author: Vasily Averin
Date: Sat Feb 27 11:27:45 2021 +0300
netfilter: x\_tables: gpf inside xt\_find\_revision()
commit 8e24edddad152b998b37a7f583175137ed2e04a5 upstream.
nested target/match\_revfn() calls work with xt[NFPROTO\_UNSPEC] lists
without taking xt[NFPROTO\_UNSPEC].mutex. This can race with module unload
and cause host to crash:
general protection fault: 0000 [#1]
Modules linked in: ... [last unloaded: xt\_cluster]
CPU: 0 PID: 542455 Comm: iptables
RIP: 0010:[] [] strcmp+0x18/0x40
RDX: 0000000000000003 RSI: ffff9a5a5d9abe10 RDI: dead000000000111
R13: ffff9a5a5d9abe10 R14: ffff9a5a5d9abd8c R15: dead000000000100
(VvS: %R15 -- &xt\_match, %RDI -- &xt\_match.name,
xt\_cluster unregister match in xt[NFPROTO\_UNSPEC].match list)
Call Trace:
[] match\_revfn+0x54/0xc0
[] match\_revfn+0xaf/0xc0
[] xt\_find\_revision+0x6e/0xf0
[] do\_ipt\_get\_ctl+0x100/0x420 [ip\_tables]
[] nf\_getsockopt+0x4f/0x70
[] ip\_getsockopt+0xde/0x100
[] raw\_getsockopt+0x25/0x50
[] sock\_common\_getsockopt+0x1a/0x20
[] SyS\_getsockopt+0x7d/0xf0
[] system\_call\_fastpath+0x25/0x2a
Fixes: 656caff20e1 ("netfilter 04/09: x\_tables: fix match/target revision lookup")
Signed-off-by: Vasily Averin
Reviewed-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit c85ee6f273e288894bc27bfe31e578d6cffdb9df
Author: Florian Westphal
Date: Wed Feb 24 17:23:19 2021 +0100
netfilter: nf\_nat: undo erroneous tcp edemux lookup
commit 03a3ca37e4c6478e3a84f04c8429dd5889e107fd upstream.
Under extremely rare conditions TCP early demux will retrieve the wrong
socket.
1. local machine establishes a connection to a remote server, S, on port
p.
This gives:
laddr:lport -> S:p
... both in tcp and conntrack.
2. local machine establishes a connection to host H, on port p2.
2a. TCP stack choses same laddr:lport, so we have
laddr:lport -> H:p2 from TCP point of view.
2b). There is a destination NAT rewrite in place, translating
H:p2 to S:p. This results in following conntrack entries:
I) laddr:lport -> S:p (origin) S:p -> laddr:lport (reply)
II) laddr:lport -> H:p2 (origin) S:p -> laddr:lport2 (reply)
NAT engine has rewritten laddr:lport to laddr:lport2 to map
the reply packet to the correct origin.
When server sends SYN/ACK to laddr:lport2, the PREROUTING hook
will undo-the SNAT transformation, rewriting IP header to
S:p -> laddr:lport
This causes TCP early demux to associate the skb with the TCP socket
of the first connection.
The INPUT hook will then reverse the DNAT transformation, rewriting
the IP header to H:p2 -> laddr:lport.
Because packet ends up with the wrong socket, the new connection
never completes: originator stays in SYN\_SENT and conntrack entry
remains in SYN\_RECV until timeout, and responder retransmits SYN/ACK
until it gives up.
To resolve this, orphan the skb after the input rewrite:
Because the source IP address changed, the socket must be incorrect.
We can't move the DNAT undo to prerouting due to backwards
compatibility, doing so will make iptables/nftables rules to no longer
match the way they did.
After orphan, the packet will be handed to the next protocol layer
(tcp, udp, ...) and that will repeat the socket lookup just like as if
early demux was disabled.
Fixes: 41063e9dd1195 ("ipv4: Early TCP socket demux.")
Closes: https://bugzilla.netfilter.org/show\_bug.cgi?id=1427
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 3b72d5a703842f582502d97906f17d6ee122dac2
Author: Eric Dumazet
Date: Mon Mar 1 10:29:17 2021 -0800
tcp: add sanity tests to TCP\_QUEUE\_SEQ
commit 8811f4a9836e31c14ecdf79d9f3cb7c5d463265d upstream.
Qingyu Li reported a syzkaller bug where the repro
changes RCV SEQ \_after\_ restoring data in the receive queue.
mprotect(0x4aa000, 12288, PROT\_READ) = 0
mmap(0x1ffff000, 4096, PROT\_NONE, MAP\_PRIVATE|MAP\_FIXED|MAP\_ANONYMOUS, -1, 0) = 0x1ffff000
mmap(0x20000000, 16777216, PROT\_READ|PROT\_WRITE|PROT\_EXEC, MAP\_PRIVATE|MAP\_FIXED|MAP\_ANONYMOUS, -1, 0) = 0x20000000
mmap(0x21000000, 4096, PROT\_NONE, MAP\_PRIVATE|MAP\_FIXED|MAP\_ANONYMOUS, -1, 0) = 0x21000000
socket(AF\_INET6, SOCK\_STREAM, IPPROTO\_IP) = 3
setsockopt(3, SOL\_TCP, TCP\_REPAIR, [1], 4) = 0
connect(3, {sa\_family=AF\_INET6, sin6\_port=htons(0), sin6\_flowinfo=htonl(0), inet\_pton(AF\_INET6, "::1", &sin6\_addr), sin6\_scope\_id=0}, 28) = 0
setsockopt(3, SOL\_TCP, TCP\_REPAIR\_QUEUE, [1], 4) = 0
sendmsg(3, {msg\_name=NULL, msg\_namelen=0, msg\_iov=[{iov\_base="0x0000000000000003\0\0", iov\_len=20}], msg\_iovlen=1, msg\_controllen=0, msg\_flags=0}, 0) = 20
setsockopt(3, SOL\_TCP, TCP\_REPAIR, [0], 4) = 0
setsockopt(3, SOL\_TCP, TCP\_QUEUE\_SEQ, [128], 4) = 0
recvfrom(3, NULL, 20, 0, NULL, NULL) = -1 ECONNRESET (Connection reset by peer)
syslog shows:
[ 111.205099] TCP recvmsg seq # bug 2: copied 80, seq 0, rcvnxt 80, fl 0
[ 111.207894] WARNING: CPU: 1 PID: 356 at net/ipv4/tcp.c:2343 tcp\_recvmsg\_locked+0x90e/0x29a0
This should not be allowed. TCP\_QUEUE\_SEQ should only be used
when queues are empty.
This patch fixes this case, and the tx path as well.
Fixes: ee9952831cfd ("tcp: Initial repair mode")
Signed-off-by: Eric Dumazet
Cc: Pavel Emelyanov
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=212005
Reported-by: Qingyu Li
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit cda8b1cbecacacf4e378930dcf7ea787a6f6e2c1
Author: Arjun Roy
Date: Thu Feb 25 15:26:28 2021 -0800
tcp: Fix sign comparison bug in getsockopt(TCP\_ZEROCOPY\_RECEIVE)
commit 2107d45f17bedd7dbf4178462da0ac223835a2a7 upstream.
getsockopt(TCP\_ZEROCOPY\_RECEIVE) has a bug where we read a
user-provided "len" field of type signed int, and then compare the
value to the result of an "offsetofend" operation, which is unsigned.
Negative values provided by the user will be promoted to large
positive numbers; thus checking that len < offsetofend() will return
false when the intention was that it return true.
Note that while len is originally checked for negative values earlier
on in do\_tcp\_getsockopt(), subsequent calls to get\_user() re-read the
value from userspace which may have changed in the meantime.
Therefore, re-add the check for negative values after the call to
get\_user in the handler code for TCP\_ZEROCOPY\_RECEIVE.
Fixes: c8856c051454 ("tcp-zerocopy: Return inq along with tcp receive zerocopy.")
Reported-by: kernel test robot
Reported-by: Dan Carpenter
Signed-off-by: Arjun Roy
Link: https://lore.kernel.org/r/20210225232628.4033281-1-arjunroy.kdev@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit c7a871958d57f3f1df32543ff74b17455e32a75b
Author: Torin Cooper-Bennun
Date: Fri Feb 26 16:34:41 2021 +0000
can: tcan4x5x: tcan4x5x\_init(): fix initialization - clear MRAM before entering Normal Mode
commit 2712625200ed69c642b9abc3a403830c4643364c upstream.
This patch prevents a potentially destructive race condition. The
device is fully operational on the bus after entering Normal Mode, so
zeroing the MRAM after entering this mode may lead to loss of
information, e.g. new received messages.
This patch fixes the problem by first initializing the MRAM, then
bringing the device into Normale Mode.
Fixes: 5443c226ba91 ("can: tcan4x5x: Add tcan4x5x driver to the kernel")
Link: https://lore.kernel.org/r/20210226163440.313628-1-torin@maxiluxsystems.com
Suggested-by: Marc Kleine-Budde
Signed-off-by: Torin Cooper-Bennun
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit d2ba576e68e4bf5e9deb59c6fb530401c3116d90
Author: Joakim Zhang
Date: Thu Feb 18 19:00:37 2021 +0800
can: flexcan: invoke flexcan\_chip\_freeze() to enter freeze mode
commit c63820045e2000f05657467a08715c18c9f490d9 upstream.
Invoke flexcan\_chip\_freeze() to enter freeze mode, since need poll
freeze mode acknowledge.
Fixes: e955cead03117 ("CAN: Add Flexcan CAN controller driver")
Link: https://lore.kernel.org/r/20210218110037.16591-4-qiangqing.zhang@nxp.com
Signed-off-by: Joakim Zhang
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit e857529dfec3ae93da27e4d3288c6bb8ae8196ab
Author: Joakim Zhang
Date: Thu Feb 18 19:00:36 2021 +0800
can: flexcan: enable RX FIFO after FRZ/HALT valid
commit ec15e27cc8904605846a354bb1f808ea1432f853 upstream.
RX FIFO enable failed could happen when do system reboot stress test:
[ 0.303958] flexcan 5a8d0000.can: 5a8d0000.can supply xceiver not found, using dummy regulator
[ 0.304281] flexcan 5a8d0000.can (unnamed net\_device) (uninitialized): Could not enable RX FIFO, unsupported core
[ 0.314640] flexcan 5a8d0000.can: registering netdev failed
[ 0.320728] flexcan 5a8e0000.can: 5a8e0000.can supply xceiver not found, using dummy regulator
[ 0.320991] flexcan 5a8e0000.can (unnamed net\_device) (uninitialized): Could not enable RX FIFO, unsupported core
[ 0.331360] flexcan 5a8e0000.can: registering netdev failed
[ 0.337444] flexcan 5a8f0000.can: 5a8f0000.can supply xceiver not found, using dummy regulator
[ 0.337716] flexcan 5a8f0000.can (unnamed net\_device) (uninitialized): Could not enable RX FIFO, unsupported core
[ 0.348117] flexcan 5a8f0000.can: registering netdev failed
RX FIFO should be enabled after the FRZ/HALT are valid. But the current
code enable RX FIFO and FRZ/HALT at the same time.
Fixes: e955cead03117 ("CAN: Add Flexcan CAN controller driver")
Link: https://lore.kernel.org/r/20210218110037.16591-3-qiangqing.zhang@nxp.com
Signed-off-by: Joakim Zhang
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit f05cf960f49519bfe39990cbe62f58965f7aa5c7
Author: Joakim Zhang
Date: Thu Feb 18 19:00:35 2021 +0800
can: flexcan: assert FRZ bit in flexcan\_chip\_freeze()
commit 449052cfebf624b670faa040245d3feed770d22f upstream.
Assert HALT bit to enter freeze mode, there is a premise that FRZ bit is
asserted. This patch asserts FRZ bit in flexcan\_chip\_freeze, although
the reset value is 1b'1. This is a prepare patch, later patch will
invoke flexcan\_chip\_freeze() to enter freeze mode, which polling freeze
mode acknowledge.
Fixes: b1aa1c7a2165b ("can: flexcan: fix transition from and to freeze mode in chip\_{,un}freeze")
Link: https://lore.kernel.org/r/20210218110037.16591-2-qiangqing.zhang@nxp.com
Signed-off-by: Joakim Zhang
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 21702a55f54afe7f8e160170f318c678ef3b4913
Author: Andy Shevchenko
Date: Thu Feb 25 18:33:20 2021 +0200
gpio: pca953x: Set IRQ type when handle Intel Galileo Gen 2
commit eb441337c7147514ab45036cadf09c3a71e4ce31 upstream.
The commit 0ea683931adb ("gpio: dwapb: Convert driver to using the
GPIO-lib-based IRQ-chip") indeliberately made a regression on how
IRQ line from GPIO I²C expander is handled. I.e. it reveals that
the quirk for Intel Galileo Gen 2 misses the part of setting IRQ type
which previously was predefined by gpio-dwapb driver. Now, we have to
reorganize the approach to call necessary parts, which can be done via
ACPI\_GPIO\_QUIRK\_ABSOLUTE\_NUMBER quirk.
Without this fix and with above mentioned change the kernel hangs
on the first IRQ event with:
gpio gpiochip3: Persistence not supported for GPIO 1
irq 32, desc: 62f8fb50, depth: 0, count: 0, unhandled: 0
->handle\_irq(): 41c7b0ab, handle\_bad\_irq+0x0/0x40
->irq\_data.chip(): e03f1e72, 0xc2539218
->action(): 0ecc7e6f
->action->handler(): 8a3db21e, irq\_default\_primary\_handler+0x0/0x10
IRQ\_NOPROBE set
unexpected IRQ trap at vector 20
Fixes: ba8c90c61847 ("gpio: pca953x: Override IRQ for one of the expanders on Galileo Gen 2")
Depends-on: 0ea683931adb ("gpio: dwapb: Convert driver to using the GPIO-lib-based IRQ-chip")
Signed-off-by: Andy Shevchenko
Acked-by: Mika Westerberg
Reviewed-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 757a28c5a18f593e9a002fd81681dddcb6129daf
Author: Oleksij Rempel
Date: Fri Feb 26 10:24:56 2021 +0100
can: skb: can\_skb\_set\_owner(): fix ref counting if socket was closed before setting skb ownership
commit e940e0895a82c6fbaa259f2615eb52b57ee91a7e upstream.
There are two ref count variables controlling the free()ing of a socket:
- struct sock::sk\_refcnt - which is changed by sock\_hold()/sock\_put()
- struct sock::sk\_wmem\_alloc - which accounts the memory allocated by
the skbs in the send path.
In case there are still TX skbs on the fly and the socket() is closed,
the struct sock::sk\_refcnt reaches 0. In the TX-path the CAN stack
clones an "echo" skb, calls sock\_hold() on the original socket and
references it. This produces the following back trace:
| WARNING: CPU: 0 PID: 280 at lib/refcount.c:25 refcount\_warn\_saturate+0x114/0x134
| refcount\_t: addition on 0; use-after-free.
| Modules linked in: coda\_vpu(E) v4l2\_jpeg(E) videobuf2\_vmalloc(E) imx\_vdoa(E)
| CPU: 0 PID: 280 Comm: test\_can.sh Tainted: G E 5.11.0-04577-gf8ff6603c617 #203
| Hardware name: Freescale i.MX6 Quad/DualLite (Device Tree)
| Backtrace:
| [<80bafea4>] (dump\_backtrace) from [<80bb0280>] (show\_stack+0x20/0x24) r7:00000000 r6:600f0113 r5:00000000 r4:81441220
| [<80bb0260>] (show\_stack) from [<80bb593c>] (dump\_stack+0xa0/0xc8)
| [<80bb589c>] (dump\_stack) from [<8012b268>] (\_\_warn+0xd4/0x114) r9:00000019 r8:80f4a8c2 r7:83e4150c r6:00000000 r5:00000009 r4:80528f90
| [<8012b194>] (\_\_warn) from [<80bb09c4>] (warn\_slowpath\_fmt+0x88/0xc8) r9:83f26400 r8:80f4a8d1 r7:00000009 r6:80528f90 r5:00000019 r4:80f4a8c2
| [<80bb0940>] (warn\_slowpath\_fmt) from [<80528f90>] (refcount\_warn\_saturate+0x114/0x134) r8:00000000 r7:00000000 r6:82b44000 r5:834e5600 r4:83f4d540
| [<80528e7c>] (refcount\_warn\_saturate) from [<8079a4c8>] (\_\_refcount\_add.constprop.0+0x4c/0x50)
| [<8079a47c>] (\_\_refcount\_add.constprop.0) from [<8079a57c>] (can\_put\_echo\_skb+0xb0/0x13c)
| [<8079a4cc>] (can\_put\_echo\_skb) from [<8079ba98>] (flexcan\_start\_xmit+0x1c4/0x230) r9:00000010 r8:83f48610 r7:0fdc0000 r6:0c080000 r5:82b44000 r4:834e5600
| [<8079b8d4>] (flexcan\_start\_xmit) from [<80969078>] (netdev\_start\_xmit+0x44/0x70) r9:814c0ba0 r8:80c8790c r7:00000000 r6:834e5600 r5:82b44000 r4:82ab1f00
| [<80969034>] (netdev\_start\_xmit) from [<809725a4>] (dev\_hard\_start\_xmit+0x19c/0x318) r9:814c0ba0 r8:00000000 r7:82ab1f00 r6:82b44000 r5:00000000 r4:834e5600
| [<80972408>] (dev\_hard\_start\_xmit) from [<809c6584>] (sch\_direct\_xmit+0xcc/0x264) r10:834e5600 r9:00000000 r8:00000000 r7:82b44000 r6:82ab1f00 r5:834e5600 r4:83f27400
| [<809c64b8>] (sch\_direct\_xmit) from [<809c6c0c>] (\_\_qdisc\_run+0x4f0/0x534)
To fix this problem, only set skb ownership to sockets which have still
a ref count > 0.
Fixes: 0ae89beb283a ("can: add destructor for self generated skbs")
Cc: Oliver Hartkopp
Cc: Andre Naujoks
Link: https://lore.kernel.org/r/20210226092456.27126-1-o.rempel@pengutronix.de
Suggested-by: Eric Dumazet
Signed-off-by: Oleksij Rempel
Reviewed-by: Oliver Hartkopp
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit bdeb4e313a532c5e793e9b6f152ed58a8a700c28
Author: Andy Shevchenko
Date: Thu Feb 25 18:33:19 2021 +0200
gpiolib: acpi: Allow to find GpioInt() resource by name and index
commit 809390219fb9c2421239afe5c9eb862d73978ba0 upstream.
Currently only search by index is supported. However, in some cases
we might need to pass the quirks to the acpi\_dev\_gpio\_irq\_get().
For this, split out acpi\_dev\_gpio\_irq\_get\_by() and replace
acpi\_dev\_gpio\_irq\_get() by calling above with NULL for name parameter.
Fixes: ba8c90c61847 ("gpio: pca953x: Override IRQ for one of the expanders on Galileo Gen 2")
Depends-on: 0ea683931adb ("gpio: dwapb: Convert driver to using the GPIO-lib-based IRQ-chip")
Signed-off-by: Andy Shevchenko
Acked-by: Mika Westerberg
Acked-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit d64123aa0c10b32746c9d1ccc0a016ffbca75dcd
Author: Andy Shevchenko
Date: Thu Feb 25 18:33:18 2021 +0200
gpiolib: acpi: Add ACPI\_GPIO\_QUIRK\_ABSOLUTE\_NUMBER quirk
commit 62d5247d239d4b48762192a251c647d7c997616a upstream.
On some systems the ACPI tables has wrong pin number and instead of
having a relative one it provides an absolute one in the global GPIO
number space.
Add ACPI\_GPIO\_QUIRK\_ABSOLUTE\_NUMBER quirk to cope with such cases.
Fixes: ba8c90c61847 ("gpio: pca953x: Override IRQ for one of the expanders on Galileo Gen 2")
Depends-on: 0ea683931adb ("gpio: dwapb: Convert driver to using the GPIO-lib-based IRQ-chip")
Signed-off-by: Andy Shevchenko
Acked-by: Mika Westerberg
Acked-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 9144b0c03e1010380060abf38773d589eff516f8
Author: Matthias Schiffer
Date: Wed Mar 3 16:50:49 2021 +0100
net: l2tp: reduce log level of messages in receive path, add counter instead
commit 3e59e8856758eb5a2dfe1f831ef53b168fd58105 upstream.
Commit 5ee759cda51b ("l2tp: use standard API for warning log messages")
changed a number of warnings about invalid packets in the receive path
so that they are always shown, instead of only when a special L2TP debug
flag is set. Even with rate limiting these warnings can easily cause
significant log spam - potentially triggered by a malicious party
sending invalid packets on purpose.
In addition these warnings were noticed by projects like Tunneldigger [1],
which uses L2TP for its data path, but implements its own control
protocol (which is sufficiently different from L2TP data packets that it
would always be passed up to userspace even with future extensions of
L2TP).
Some of the warnings were already redundant, as l2tp\_stats has a counter
for these packets. This commit adds one additional counter for invalid
packets that are passed up to userspace. Packets with unknown session are
not counted as invalid, as there is nothing wrong with the format of
these packets.
With the additional counter, all of these messages are either redundant
or benign, so we reduce them to pr\_debug\_ratelimited().
[1] https://github.com/wlanslovenija/tunneldigger/issues/160
Fixes: 5ee759cda51b ("l2tp: use standard API for warning log messages")
Signed-off-by: Matthias Schiffer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit edb24de123165bca427ea5b36db2faedc53b95b7
Author: Kalle Valo
Date: Mon Feb 22 17:14:09 2021 +0200
ath11k: fix AP mode for QCA6390
commit 77d7e87128d4dfb400df4208b2812160e999c165 upstream.
Commit c134d1f8c436 ("ath11k: Handle errors if peer creation fails") completely
broke AP mode on QCA6390:
kernel: [ 151.230734] ath11k\_pci 0000:06:00.0: failed to create peer after vdev start delay: -22
wpa\_supplicant[2307]: Failed to set beacon parameters
wpa\_supplicant[2307]: Interface initialization failed
wpa\_supplicant[2307]: wlan0: interface state UNINITIALIZED->DISABLED
wpa\_supplicant[2307]: wlan0: AP-DISABLED
wpa\_supplicant[2307]: wlan0: Unable to setup interface.
wpa\_supplicant[2307]: Failed to initialize AP interface
This was because commit c134d1f8c436 ("ath11k: Handle errors if peer creation
fails") added error handling for ath11k\_peer\_create(), which had been failing
all along but was unnoticed due to the missing error handling. The actual bug
was introduced already in commit aa44b2f3ecd4 ("ath11k: start vdev if a bss peer is
already created").
ath11k\_peer\_create() was failing because for AP mode the peer is created
already earlier op\_add\_interface() and we should skip creation here, but the
check for modes was wrong. Fixing that makes AP mode work again.
This shouldn't affect IPQ8074 nor QCN9074 as they have hw\_params.vdev\_start\_delay disabled.
Tested-on: QCA6390 hw2.0 PCI WLAN.HST.1.0.1-01740-QCAHSTSWPLZ\_V2\_TO\_X86-1
Fixes: c134d1f8c436 ("ath11k: Handle errors if peer creation fails")
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/1614006849-25764-1-git-send-email-kvalo@codeaurora.org
Signed-off-by: Greg Kroah-Hartman
commit 4b39fd96cbaade5aadb2aa438b530c1a0d7e884f
Author: Balazs Nemeth
Date: Tue Mar 9 12:31:01 2021 +0100
net: avoid infinite loop in mpls\_gso\_segment when mpls\_hlen == 0
commit d348ede32e99d3a04863e9f9b28d224456118c27 upstream.
A packet with skb\_inner\_network\_header(skb) == skb\_network\_header(skb)
and ETH\_P\_MPLS\_UC will prevent mpls\_gso\_segment from pulling any headers
from the packet. Subsequently, the call to skb\_mac\_gso\_segment will
again call mpls\_gso\_segment with the same packet leading to an infinite
loop. In addition, ensure that the header length is a multiple of four,
which should hold irrespective of the number of stacked labels.
Signed-off-by: Balazs Nemeth
Acked-by: Willem de Bruijn
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 99b1d3f74b9ef72c2f74c8e4c078e1bc0706e748
Author: Balazs Nemeth
Date: Tue Mar 9 12:31:00 2021 +0100
net: check if protocol extracted by virtio\_net\_hdr\_set\_proto is correct
commit 924a9bc362a5223cd448ca08c3dde21235adc310 upstream.
For gso packets, virtio\_net\_hdr\_set\_proto sets the protocol (if it isn't
set) based on the type in the virtio net hdr, but the skb could contain
anything since it could come from packet\_snd through a raw socket. If
there is a mismatch between what virtio\_net\_hdr\_set\_proto sets and
the actual protocol, then the skb could be handled incorrectly later
on.
An example where this poses an issue is with the subsequent call to
skb\_flow\_dissect\_flow\_keys\_basic which relies on skb->protocol being set
correctly. A specially crafted packet could fool
skb\_flow\_dissect\_flow\_keys\_basic preventing EINVAL to be returned.
Avoid blindly trusting the information provided by the virtio net header
by checking that the protocol in the packet actually matches the
protocol set by virtio\_net\_hdr\_set\_proto. Note that since the protocol
is only checked if skb->dev implements header\_ops->parse\_protocol,
packets from devices without the implementation are not checked at this
stage.
Fixes: 9274124f023b ("net: stricter validation of untrusted gso packets")
Signed-off-by: Balazs Nemeth
Acked-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9b815b6efaf8072ea0cdf2ed22ac51c0b76574d9
Author: Daniel Borkmann
Date: Fri Feb 26 22:22:48 2021 +0100
net: Fix gro aggregation for udp encaps with zero csum
commit 89e5c58fc1e2857ccdaae506fb8bc5fed57ee063 upstream.
We noticed a GRO issue for UDP-based encaps such as vxlan/geneve when the
csum for the UDP header itself is 0. In that case, GRO aggregation does
not take place on the phys dev, but instead is deferred to the vxlan/geneve
driver (see trace below).
The reason is essentially that GRO aggregation bails out in udp\_gro\_receive()
for such case when drivers marked the skb with CHECKSUM\_UNNECESSARY (ice, i40e,
others) where for non-zero csums 2abb7cdc0dc8 ("udp: Add support for doing
checksum unnecessary conversion") promotes those skbs to CHECKSUM\_COMPLETE
and napi context has csum\_valid set. This is however not the case for zero
UDP csum (here: csum\_cnt is still 0 and csum\_valid continues to be false).
At the same time 57c67ff4bd92 ("udp: additional GRO support") added matches
on !uh->check ^ !uh2->check as part to determine candidates for aggregation,
so it certainly is expected to handle zero csums in udp\_gro\_receive(). The
purpose of the check added via 662880f44203 ("net: Allow GRO to use and set
levels of checksum unnecessary") seems to catch bad csum and stop aggregation
right away.
One way to fix aggregation in the zero case is to only perform the !csum\_valid
check in udp\_gro\_receive() if uh->check is infact non-zero.
Before:
[...]
swapper 0 [008] 731.946506: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100400 len=1500 (1)
swapper 0 [008] 731.946507: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100200 len=1500
swapper 0 [008] 731.946507: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101100 len=1500
swapper 0 [008] 731.946508: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101700 len=1500
swapper 0 [008] 731.946508: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101b00 len=1500
swapper 0 [008] 731.946508: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100600 len=1500
swapper 0 [008] 731.946508: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100f00 len=1500
swapper 0 [008] 731.946509: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100a00 len=1500
swapper 0 [008] 731.946516: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100500 len=1500
swapper 0 [008] 731.946516: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100700 len=1500
swapper 0 [008] 731.946516: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101d00 len=1500 (2)
swapper 0 [008] 731.946517: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101000 len=1500
swapper 0 [008] 731.946517: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101c00 len=1500
swapper 0 [008] 731.946517: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101400 len=1500
swapper 0 [008] 731.946518: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100e00 len=1500
swapper 0 [008] 731.946518: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497101600 len=1500
swapper 0 [008] 731.946521: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff966497100800 len=774
swapper 0 [008] 731.946530: net:netif\_receive\_skb: dev=test\_vxlan skbaddr=0xffff966497100400 len=14032 (1)
swapper 0 [008] 731.946530: net:netif\_receive\_skb: dev=test\_vxlan skbaddr=0xffff966497101d00 len=9112 (2)
[...]
# netperf -H 10.55.10.4 -t TCP\_STREAM -l 20
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF\_INET to 10.55.10.4 () port 0 AF\_INET : demo
Recv Send Send
Socket Socket Message Elapsed
Size Size Size Time Throughput
bytes bytes bytes secs. 10^6bits/sec
87380 16384 16384 20.01 13129.24
After:
[...]
swapper 0 [026] 521.862641: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff93ab0d479000 len=11286 (1)
swapper 0 [026] 521.862643: net:netif\_receive\_skb: dev=test\_vxlan skbaddr=0xffff93ab0d479000 len=11236 (1)
swapper 0 [026] 521.862650: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff93ab0d478500 len=2898 (2)
swapper 0 [026] 521.862650: net:netif\_receive\_skb: dev=enp10s0f0 skbaddr=0xffff93ab0d479f00 len=8490 (3)
swapper 0 [026] 521.862653: net:netif\_receive\_skb: dev=test\_vxlan skbaddr=0xffff93ab0d478500 len=2848 (2)
swapper 0 [026] 521.862653: net:netif\_receive\_skb: dev=test\_vxlan skbaddr=0xffff93ab0d479f00 len=8440 (3)
[...]
# netperf -H 10.55.10.4 -t TCP\_STREAM -l 20
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF\_INET to 10.55.10.4 () port 0 AF\_INET : demo
Recv Send Send
Socket Socket Message Elapsed
Size Size Size Time Throughput
bytes bytes bytes secs. 10^6bits/sec
87380 16384 16384 20.01 24576.53
Fixes: 57c67ff4bd92 ("udp: additional GRO support")
Fixes: 662880f44203 ("net: Allow GRO to use and set levels of checksum unnecessary")
Signed-off-by: Daniel Borkmann
Cc: Eric Dumazet
Cc: Jesse Brandeburg
Cc: Tom Herbert
Acked-by: Willem de Bruijn
Acked-by: John Fastabend
Link: https://lore.kernel.org/r/20210226212248.8300-1-daniel@iogearbox.net
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 11fe93511d02c2e24f8c9eee1ca3f7f8b36e39c3
Author: Felix Fietkau
Date: Sun Feb 14 19:49:11 2021 +0100
ath9k: fix transmitting to stations in dynamic SMPS mode
commit 3b9ea7206d7e1fdd7419cbd10badd3b2c80d04b4 upstream.
When transmitting to a receiver in dynamic SMPS mode, all transmissions that
use multiple spatial streams need to be sent using CTS-to-self or RTS/CTS to
give the receiver's extra chains some time to wake up.
This fixes the tx rate getting stuck at <= MCS7 for some clients, especially
Intel ones, which make aggressive use of SMPS.
Cc: stable@vger.kernel.org
Reported-by: Martin Kennedy
Signed-off-by: Felix Fietkau
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20210214184911.96702-1-nbd@nbd.name
Signed-off-by: Greg Kroah-Hartman
commit 9b51619ad0c22dd20bdf7dc8fce4ebefb50cf342
Author: Davide Caratti
Date: Mon Mar 8 10:00:04 2021 +0100
mptcp: fix length of ADD\_ADDR with port sub-option
commit 27ab92d9996e4e003a726d22c56d780a1655d6b4 upstream.
in current Linux, MPTCP peers advertising endpoints with port numbers use
a sub-option length that wrongly accounts for the trailing TCP NOP. Also,
receivers will only process incoming ADD\_ADDR with port having such wrong
sub-option length. Fix this, making ADD\_ADDR compliant to RFC8684 §3.4.1.
this can be verified running tcpdump on the kselftests artifacts:
unpatched kernel:
[root@bottarga mptcp]# tcpdump -tnnr unpatched.pcap | grep add-addr
reading from file unpatched.pcap, link-type LINUX\_SLL (Linux cooked v1), snapshot length 65535
IP 10.0.1.1.10000 > 10.0.1.2.53078: Flags [.], ack 101, win 509, options [nop,nop,TS val 214459678 ecr 521312851,mptcp add-addr v1 id 1 a00:201:2774:2d88:7436:85c3:17fd:101], length 0
IP 10.0.1.2.53078 > 10.0.1.1.10000: Flags [.], ack 101, win 502, options [nop,nop,TS val 521312852 ecr 214459678,mptcp add-addr[bad opt]]
patched kernel:
[root@bottarga mptcp]# tcpdump -tnnr patched.pcap | grep add-addr
reading from file patched.pcap, link-type LINUX\_SLL (Linux cooked v1), snapshot length 65535
IP 10.0.1.1.10000 > 10.0.1.2.38178: Flags [.], ack 101, win 509, options [nop,nop,TS val 3728873902 ecr 2732713192,mptcp add-addr v1 id 1 10.0.2.1:10100 hmac 0xbccdfcbe59292a1f,nop,nop], length 0
IP 10.0.1.2.38178 > 10.0.1.1.10000: Flags [.], ack 101, win 502, options [nop,nop,TS val 2732713195 ecr 3728873902,mptcp add-addr v1-echo id 1 10.0.2.1:10100,nop,nop], length 0
Fixes: 22fb85ffaefb ("mptcp: add port support for ADD\_ADDR suboption writing")
CC: stable@vger.kernel.org # 5.11+
Reviewed-by: Mat Martineau
Acked-and-tested-by: Geliang Tang
Signed-off-by: Davide Caratti
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 138bd4da2c7657fe0bc583824005f4e3bc153e47
Author: Maciej W. Rozycki
Date: Wed Mar 3 02:16:04 2021 +0100
crypto: mips/poly1305 - enable for all MIPS processors
commit 6c810cf20feef0d4338e9b424ab7f2644a8b353e upstream.
The MIPS Poly1305 implementation is generic MIPS code written such as to
support down to the original MIPS I and MIPS III ISA for the 32-bit and
64-bit variant respectively. Lift the current limitation then to enable
code for MIPSr1 ISA or newer processors only and have it available for
all MIPS processors.
Signed-off-by: Maciej W. Rozycki
Fixes: a11d055e7a64 ("crypto: mips/poly1305 - incorporate OpenSSL/CRYPTOGAMS optimized implementation")
Cc: stable@vger.kernel.org # v5.5+
Acked-by: Jason A. Donenfeld
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit e2d1bb4b1a100f6f5d31860b74127470bd55c6bf
Author: Jakub Kicinski
Date: Fri Mar 5 14:17:29 2021 -0800
ethernet: alx: fix order of calls on resume
commit a4dcfbc4ee2218abd567d81d795082d8d4afcdf6 upstream.
netif\_device\_attach() will unpause the queues so we can't call
it before \_\_alx\_open(). This went undetected until
commit b0999223f224 ("alx: add ability to allocate and free
alx\_napi structures") but now if stack tries to xmit immediately
on resume before \_\_alx\_open() we'll crash on the NAPI being null:
BUG: kernel NULL pointer dereference, address: 0000000000000198
CPU: 0 PID: 12 Comm: ksoftirqd/0 Tainted: G OE 5.10.0-3-amd64 #1 Debian 5.10.13-1
Hardware name: Gigabyte Technology Co., Ltd. To be filled by O.E.M./H77-D3H, BIOS F15 11/14/2013
RIP: 0010:alx\_start\_xmit+0x34/0x650 [alx]
Code: 41 56 41 55 41 54 55 53 48 83 ec 20 0f b7 57 7c 8b 8e b0
0b 00 00 39 ca 72 06 89 d0 31 d2 f7 f1 89 d2 48 8b 84 df
RSP: 0018:ffffb09240083d28 EFLAGS: 00010297
RAX: 0000000000000000 RBX: ffffa04d80ae7800 RCX: 0000000000000004
RDX: 0000000000000000 RSI: ffffa04d80afa000 RDI: ffffa04e92e92a00
RBP: 0000000000000042 R08: 0000000000000100 R09: ffffa04ea3146700
R10: 0000000000000014 R11: 0000000000000000 R12: ffffa04e92e92100
R13: 0000000000000001 R14: ffffa04e92e92a00 R15: ffffa04e92e92a00
FS: 0000000000000000(0000) GS:ffffa0508f600000(0000) knlGS:0000000000000000
i915 0000:00:02.0: vblank wait timed out on crtc 0
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000198 CR3: 000000004460a001 CR4: 00000000001706f0
Call Trace:
dev\_hard\_start\_xmit+0xc7/0x1e0
sch\_direct\_xmit+0x10f/0x310
Cc:  # 4.9+
Fixes: bc2bebe8de8e ("alx: remove WoL support")
Reported-by: Zbynek Michl
Link: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=983595
Signed-off-by: Jakub Kicinski
Tested-by: Zbynek Michl
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 48a84965536e4572df03c3e9e5b79948b7c4f4ae
Author: Greg Kurz
Date: Mon Feb 15 10:45:06 2021 +0100
powerpc/pseries: Don't enforce MSI affinity with kdump
commit f9619d5e5174867536b7e558683bc4408eab833f upstream.
Depending on the number of online CPUs in the original kernel, it is
likely for CPU #0 to be offline in a kdump kernel. The associated IRQs
in the affinity mappings provided by irq\_create\_affinity\_masks() are
thus not started by irq\_startup(), as per-design with managed IRQs.
This can be a problem with multi-queue block devices driven by blk-mq :
such a non-started IRQ is very likely paired with the single queue
enforced by blk-mq during kdump (see blk\_mq\_alloc\_tag\_set()). This
causes the device to remain silent and likely hangs the guest at
some point.
This is a regression caused by commit 9ea69a55b3b9 ("powerpc/pseries:
Pass MSI affinity to irq\_create\_mapping()"). Note that this only happens
with the XIVE interrupt controller because XICS has a workaround to bypass
affinity, which is activated during kdump with the "noirqdistrib" kernel
parameter.
The issue comes from a combination of factors:
- discrepancy between the number of queues detected by the multi-queue
block driver, that was used to create the MSI vectors, and the single
queue mode enforced later on by blk-mq because of kdump (i.e. keeping
all queues fixes the issue)
- CPU#0 offline (i.e. kdump always succeed with CPU#0)
Given that I couldn't reproduce on x86, which seems to always have CPU#0
online even during kdump, I'm not sure where this should be fixed. Hence
going for another approach : fine-grained affinity is for performance
and we don't really care about that during kdump. Simply revert to the
previous working behavior of ignoring affinity masks in this case only.
Fixes: 9ea69a55b3b9 ("powerpc/pseries: Pass MSI affinity to irq\_create\_mapping()")
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Greg Kurz
Reviewed-by: Laurent Vivier
Reviewed-by: Cédric Le Goater
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/20210215094506.1196119-1-groug@kaod.org
Signed-off-by: Greg Kroah-Hartman
commit fc95046ed0d9d730ca63026c7d8caf3bd15c33e9
Author: Athira Rajeev
Date: Thu Feb 25 05:10:39 2021 -0500
powerpc/perf: Fix handling of privilege level checks in perf interrupt context
commit 5ae5fbd2107959b68ac69a8b75412208663aea88 upstream.
Running "perf mem record" in powerpc platforms with selinux enabled
resulted in soft lockup's. Below call-trace was seen in the logs:
CPU: 58 PID: 3751 Comm: sssd\_nss Not tainted 5.11.0-rc7+ #2
NIP: c000000000dff3d4 LR: c000000000dff3d0 CTR: 0000000000000000
REGS: c000007fffab7d60 TRAP: 0100 Not tainted (5.11.0-rc7+)
...
NIP \_raw\_spin\_lock\_irqsave+0x94/0x120
LR \_raw\_spin\_lock\_irqsave+0x90/0x120
Call Trace:
0xc00000000fd47260 (unreliable)
skb\_queue\_tail+0x3c/0x90
audit\_log\_end+0x6c/0x180
common\_lsm\_audit+0xb0/0xe0
slow\_avc\_audit+0xa4/0x110
avc\_has\_perm+0x1c4/0x260
selinux\_perf\_event\_open+0x74/0xd0
security\_perf\_event\_open+0x68/0xc0
record\_and\_restart+0x6e8/0x7f0
perf\_event\_interrupt+0x22c/0x560
performance\_monitor\_exception0x4c/0x60
performance\_monitor\_common\_virt+0x1c8/0x1d0
interrupt: f00 at \_raw\_spin\_lock\_irqsave+0x38/0x120
NIP: c000000000dff378 LR: c000000000b5fbbc CTR: c0000000007d47f0
REGS: c00000000fd47860 TRAP: 0f00 Not tainted (5.11.0-rc7+)
...
NIP \_raw\_spin\_lock\_irqsave+0x38/0x120
LR skb\_queue\_tail+0x3c/0x90
interrupt: f00
0x38 (unreliable)
0xc00000000aae6200
audit\_log\_end+0x6c/0x180
audit\_log\_exit+0x344/0xf80
\_\_audit\_syscall\_exit+0x2c0/0x320
do\_syscall\_trace\_leave+0x148/0x200
syscall\_exit\_prepare+0x324/0x390
system\_call\_common+0xfc/0x27c
The above trace shows that while the CPU was handling a performance
monitor exception, there was a call to security\_perf\_event\_open()
function. In powerpc core-book3s, this function is called from
perf\_allow\_kernel() check during recording of data address in the
sample via perf\_get\_data\_addr().
Commit da97e18458fb ("perf\_event: Add support for LSM and SELinux
checks") introduced security enhancements to perf. As part of this
commit, the new security hook for perf\_event\_open() was added in all
places where perf paranoid check was previously used. In powerpc
core-book3s code, originally had paranoid checks in
perf\_get\_data\_addr() and power\_pmu\_bhrb\_read(). So
perf\_paranoid\_kernel() checks were replaced with perf\_allow\_kernel()
in these PMU helper functions as well.
The intention of paranoid checks in core-book3s was to verify
privilege access before capturing some of the sample data. Along with
paranoid checks, perf\_allow\_kernel() also does a
security\_perf\_event\_open(). Since these functions are accessed while
recording a sample, we end up calling selinux\_perf\_event\_open() in PMI
context. Some of the security functions use spinlock like
sidtab\_sid2str\_put(). If a perf interrupt hits under a spin lock and
if we end up in calling selinux hook functions in PMI handler, this
could cause a dead lock.
Since the purpose of this security hook is to control access to
perf\_event\_open(), it is not right to call this in interrupt context.
The paranoid checks in powerpc core-book3s were done at interrupt time
which is also not correct.
Reference commits:
Commit cd1231d7035f ("powerpc/perf: Prevent kernel address leak via perf\_get\_data\_addr()")
Commit bb19af816025 ("powerpc/perf: Prevent kernel address leak to userspace via BHRB buffer")
We only allow creation of events that have already passed the
privilege checks in perf\_event\_open(). So these paranoid checks are
not needed at event time. As a fix, patch uses
'event->attr.exclude\_kernel' check to prevent exposing kernel address
for userspace only sampling.
Fixes: cd1231d7035f ("powerpc/perf: Prevent kernel address leak via perf\_get\_data\_addr()")
Cc: stable@vger.kernel.org # v4.17+
Suggested-by: Michael Ellerman
Signed-off-by: Athira Rajeev
Acked-by: Peter Zijlstra (Intel)
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/1614247839-1428-1-git-send-email-atrajeev@linux.vnet.ibm.com
Signed-off-by: Greg Kroah-Hartman
commit dfaabaf60d857dd17cf96acb96f6b2059d97a903
Author: Christophe Leroy
Date: Mon Feb 1 06:29:50 2021 +0000
powerpc/603: Fix protection of user pages mapped with PROT\_NONE
commit c119565a15a628efdfa51352f9f6c5186e506a1c upstream.
On book3s/32, page protection is defined by the PP bits in the PTE
which provide the following protection depending on the access
keys defined in the matching segment register:
- PP 00 means RW with key 0 and N/A with key 1.
- PP 01 means RW with key 0 and RO with key 1.
- PP 10 means RW with both key 0 and key 1.
- PP 11 means RO with both key 0 and key 1.
Since the implementation of kernel userspace access protection,
PP bits have been set as follows:
- PP00 for pages without \_PAGE\_USER
- PP01 for pages with \_PAGE\_USER and \_PAGE\_RW
- PP11 for pages with \_PAGE\_USER and without \_PAGE\_RW
For kernelspace segments, kernel accesses are performed with key 0
and user accesses are performed with key 1. As PP00 is used for
non \_PAGE\_USER pages, user can't access kernel pages not flagged
\_PAGE\_USER while kernel can.
For userspace segments, both kernel and user accesses are performed
with key 0, therefore pages not flagged \_PAGE\_USER are still
accessible to the user.
This shouldn't be an issue, because userspace is expected to be
accessible to the user. But unlike most other architectures, powerpc
implements PROT\_NONE protection by removing \_PAGE\_USER flag instead of
flagging the page as not valid. This means that pages in userspace
that are not flagged \_PAGE\_USER shall remain inaccessible.
To get the expected behaviour, just mimic other architectures in the
TLB miss handler by checking \_PAGE\_USER permission on userspace
accesses as if it was the \_PAGE\_PRESENT bit.
Note that this problem only is only for 603 cores. The 604+ have
an hash table, and hash\_page() function already implement the
verification of \_PAGE\_USER permission on userspace pages.
Fixes: f342adca3afc ("powerpc/32s: Prepare Kernel Userspace Access Protection")
Cc: stable@vger.kernel.org # v5.2+
Reported-by: Christoph Plattner
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/4a0c6e3bb8f0c162457bf54d9bc6fd8d7b55129f.1612160907.git.christophe.leroy@csgroup.eu
Signed-off-by: Greg Kroah-Hartman
commit 62937f9a502f776fff2f1f4eaf1d07bc44ea89c1
Author: Dmitry V. Levin
Date: Mon Feb 22 08:00:00 2021 +0000
uapi: nfnetlink\_cthelper.h: fix userspace compilation error
commit c33cb0020ee6dd96cc9976d6085a7d8422f6dbed upstream.
Apparently,  and
 could not be included into the same
compilation unit because of a cut-and-paste typo in the former header.
Fixes: 12f7a505331e6 ("netfilter: add user-space connection tracking helper infrastructure")
Cc:  # v3.6
Signed-off-by: Dmitry V. Levin
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman


=== Content from syzkaller.appspot.com_224868dd_20250115_095541.html ===


| [syzbot](/upstream) | Android 5.10 Android 5.15 Android 5.4 Android 6.1 FreeBSD Linux Linux 5.15 Linux 6.1 NetBSD OpenBSD gVisor | [sign-in](https://syzkaller.appspot.com/_ah/conflogin?continue=https://syzkaller.appspot.com/bug%3Fid%3D96e7d345748d8814901c91cd92084ed04b46701e) | [mailing list](https://groups.google.com/forum/#!forum/syzkaller) | [source](https://github.com/google/syzkaller) | [docs](https://github.com/google/syzkaller/blob/master/docs/syzbot.md) |
| --- | --- | --- |

[🐞 Open [1665]](/upstream)

[≡ Subsystems](/upstream/subsystems)

[🐞 Fixed [5974]](/upstream/fixed)

[🐞 Invalid [14663]](/upstream/invalid)

[⬇ Missing Backports [127]](/upstream/backports)

[≡ Crashes](/upstream/graph/crashes)

📈Graphs
[Kernel Health](/upstream/graph/bugs)
[Bugs/Month](/upstream/graph/found-bugs)
[Bug Lifetimes](/upstream/graph/lifetimes)
[Fuzzing](/upstream/graph/fuzzing)

📈Coverage
[Total](/upstream/graph/coverage?period=quarter)
[Repo Heatmap](/upstream/graph/coverage_heatmap?period=month)
[Subsystems Heatmap](/upstream/graph/coverage_subsystems_heatmap?period=month)

💬 Send us feedback

**KASAN: use-after-free Read in cipso\_v4\_genopt**

Status: [fixed on 2021/11/10 02:36](https://groups.google.com/d/msgid/syzkaller-bugs/0000000000006305c005bc8ba7f0%40google.com)

Subsystems:
[lsm](/upstream/s/lsm)
[net](/upstream/s/net)

[[Documentation on labels]](https://github.com/google/syzkaller/blob/master/docs/syzbot.md#labels)

Reported-by: syzbot+9ec037722d2603a9f52e@syzkaller.appspotmail.com

**Fix commit:**
ad5d07f4a9cd
[cipso,calipso: resolve a number of problems with the DOI refcounts](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ad5d07f4a9cd671233ae20983848874731102c08)

1165affd4848
[net: mac802154: Fix general protection fault](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1165affd484889d4986cf3b724318935a0b120d8)

First crash: 1418d, last: 1413d

**Cause bisection: the issue happens on the oldest tested release**
**([bisect log](https://syzkaller.appspot.com/x/bisect.txt?x=12f44592d00000))**

Crash: [KASAN: use-after-free Read in cipso\_v4\_genopt](https://syzkaller.appspot.com/x/report.txt?x=11f44592d00000) ([log](https://syzkaller.appspot.com/x/log.txt?x=16f44592d00000))

Repro: [C](/text?tag=ReproC&x=107bdcead00000)
[syz](/text?tag=ReproSyz&x=1576737ad00000)
[.config](/text?tag=KernelConfig&x=779a2568b654c1c6)

▶
▼
Duplicate bugs (1)

duplicates (1):

| Title | Repro | Cause bisect | Fix bisect | Count | Last | Reported | Patched | Status |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [KASAN: use-after-free Write in cipso\_v4\_doi\_putdef](/bug?extid=521772a90166b3fca21f) [lsm](/upstream/s/lsm) [net](/upstream/s/net) |  |  |  | 2 | 1415d | [1413d](https://groups.google.com/d/msgid/syzkaller-bugs/000000000000f022ff05bca3d9a3%40google.com) | 0/28 | [closed as dup on 2021/03/05 07:49](https://groups.google.com/d/msgid/syzkaller-bugs/000000000000f022ff05bca3d9a3%40google.com) |

▶
▼
Discussions (23)

| Title | Replies (including bot) | Last reply |
| --- | --- | --- |
| [[PATCH 4.9 000/157] 4.9.298-rc1 review](https://lore.kernel.org/all/20220124183932.787526760%40linuxfoundation.org/T/) | 162 (162) | 2022/01/25 14:34 |
| [[PATCH 4.14 00/68] 4.14.231-rc1 review](https://lore.kernel.org/all/20210415144414.464797272%40linuxfoundation.org/T/) | 77 (77) | 2021/07/28 12:56 |
| [[PATCH 5.4 000/111] 5.4.112-rc1 review](https://lore.kernel.org/all/20210412084004.200986670%40linuxfoundation.org/T/) | 124 (124) | 2021/05/19 00:04 |
| [[PATCH AUTOSEL 5.10 01/46] net: ieee802154: fix nl802154 del llsec key](https://lore.kernel.org/all/20210412162401.314035-1-sashal%40kernel.org/T/) | 47 (47) | 2021/04/19 08:49 |
| [[PATCH 4.4 00/38] 4.4.267-rc1 review](https://lore.kernel.org/all/20210415144413.352638802%40linuxfoundation.org/T/) | 42 (42) | 2021/04/16 12:52 |
| [[PATCH 4.9 00/47] 4.9.267-rc1 review](https://lore.kernel.org/all/20210415144413.487943796%40linuxfoundation.org/T/) | 51 (51) | 2021/04/16 11:50 |
| [[PATCH 4.19 00/66] 4.19.187-rc1 review](https://lore.kernel.org/all/20210412083958.129944265%40linuxfoundation.org/T/) | 75 (75) | 2021/04/14 02:50 |
| [[PATCH 5.10 000/188] 5.10.30-rc1 review](https://lore.kernel.org/all/20210412084013.643370347%40linuxfoundation.org/T/) | 199 (199) | 2021/04/13 10:44 |
| [[PATCH 5.11 000/210] 5.11.14-rc1 review](https://lore.kernel.org/all/20210412084016.009884719%40linuxfoundation.org/T/) | 214 (214) | 2021/04/13 04:46 |
| [[PATCH AUTOSEL 4.4 01/23] net: ieee802154: nl-mac: fix check on panid](https://lore.kernel.org/all/20210412162736.316026-1-sashal%40kernel.org/T/) | 23 (23) | 2021/04/12 16:27 |
| [[PATCH AUTOSEL 4.9 01/23] net: ieee802154: nl-mac: fix check on panid](https://lore.kernel.org/all/20210412162704.315783-1-sashal%40kernel.org/T/) | 23 (23) | 2021/04/12 16:27 |
| [[PATCH AUTOSEL 4.14 01/25] net: ieee802154: nl-mac: fix check on panid](https://lore.kernel.org/all/20210412162630.315526-1-sashal%40kernel.org/T/) | 25 (25) | 2021/04/12 16:26 |
| [[PATCH AUTOSEL 4.19 01/28] net: ieee802154: nl-mac: fix check on panid](https://lore.kernel.org/all/20210412162553.315227-1-sashal%40kernel.org/T/) | 28 (28) | 2021/04/12 16:25 |
| [[PATCH AUTOSEL 5.4 01/39] net: ieee802154: fix nl802154 del llsec key](https://lore.kernel.org/all/20210412162502.314854-1-sashal%40kernel.org/T/) | 39 (39) | 2021/04/12 16:25 |
| [[PATCH AUTOSEL 5.11 01/51] net: ieee802154: fix nl802154 del llsec key](https://lore.kernel.org/all/20210412162256.313524-1-sashal%40kernel.org/T/) | 51 (51) | 2021/04/12 16:22 |
| [[PATCH] net: mac802154: Fix null pointer dereference](https://lore.kernel.org/all/20210303162757.763502-1-paskripkin%40gmail.com/T/) | 10 (10) | 2021/04/06 20:43 |
| [[PATCH 5.10 000/290] 5.10.24-rc1 review](https://lore.kernel.org/all/20210315135541.921894249%40linuxfoundation.org/T/) | 317 (317) | 2021/03/22 08:15 |
| [[PATCH 5.11 000/306] 5.11.7-rc1 review](https://lore.kernel.org/all/20210315135507.611436477%40linuxfoundation.org/T/) | 313 (313) | 2021/03/19 09:50 |
| [[PATCH 4.19 000/120] 4.19.181-rc1 review](https://lore.kernel.org/all/20210315135720.002213995%40linuxfoundation.org/T/) | 137 (137) | 2021/03/19 09:41 |
| [[PATCH 4.14 00/95] 4.14.226-rc1 review](https://lore.kernel.org/all/20210315135740.245494252%40linuxfoundation.org/T/) | 105 (105) | 2021/03/18 12:00 |
| [[PATCH 5.4 000/168] 5.4.106-rc1 review](https://lore.kernel.org/all/20210315135550.333963635%40linuxfoundation.org/T/) | 175 (175) | 2021/03/17 03:00 |
| [[PATCH] cipso,calipso: resolve a number of problems with the DOI refcounts](https://lore.kernel.org/all/161489339182.63157.2775083878484465675.stgit%40olly/T/) | 6 (6) | 2021/03/04 23:30 |
| [KASAN: use-after-free Read in cipso\_v4\_genopt](https://lore.kernel.org/all/0000000000006305c005bc8ba7f0%40google.com/T/) | 5 (7) | 2021/03/03 00:13 |

▶
▼
Last patch testing requests (1)

| Created | Duration | User | Patch | Repo | Result |
| --- | --- | --- | --- | --- | --- |
| 2021/03/04 11:31 | 13m | paskripkin@gmail.com |  | [https://linux.googlesource.com/linux/kernel/git/torvalds/linux refs/changes/19/8819/1](https://linux.googlesource.com/linux/kernel/git/torvalds/linux/%2B/3508dde36b1f2880c070fe0024ba7b2d42a532d7%5E%21) | [report](https://syzkaller.appspot.com/x/report.txt?x=1785b7ccd00000) [log](https://syzkaller.appspot.com/x/log.txt?x=1385b7ccd00000) |

**Sample crash report:**

```
==================================================================
BUG: KASAN: use-after-free in cipso_v4_genopt+0x1078/0x1700 [net/ipv4/cipso_ipv4.c:1784](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/cipso_ipv4.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1784)
Read of size 1 at addr ffff8881437d5710 by task syz-executor557/8392

CPU: 1 PID: 8392 Comm: syz-executor557 Not tainted 5.12.0-rc1-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
 __dump_stack [lib/dump_stack.c:79](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/lib/dump_stack.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n79) [inline]
 dump_stack+0x125/0x19e [lib/dump_stack.c:120](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/lib/dump_stack.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n120)
 print_address_description+0x5f/0x3a0 [mm/kasan/report.c:232](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/report.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n232)
 __kasan_report [mm/kasan/report.c:399](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/report.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n399) [inline]
 kasan_report+0x15e/0x210 [mm/kasan/report.c:416](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/report.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n416)
 cipso_v4_genopt+0x1078/0x1700 [net/ipv4/cipso_ipv4.c:1784](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/cipso_ipv4.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1784)
 cipso_v4_sock_setattr+0x7c/0x460 [net/ipv4/cipso_ipv4.c:1866](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/cipso_ipv4.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1866)
 netlbl_sock_setattr+0x28e/0x2f0 [net/netlabel/netlabel_kapi.c:995](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlabel/netlabel_kapi.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n995)
 smack_netlbl_add [security/smack/smack_lsm.c:2404](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/smack/smack_lsm.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2404) [inline]
 smack_socket_post_create+0x13b/0x280 [security/smack/smack_lsm.c:2774](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/smack/smack_lsm.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2774)
 security_socket_post_create+0x6f/0xd0 [security/security.c:2122](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/security.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2122)
 __sock_create+0x62f/0x8c0 [net/socket.c:1424](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1424)
 sock_create [net/socket.c:1459](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1459) [inline]
 __sys_socket+0xde/0x2d0 [net/socket.c:1501](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1501)
 __do_sys_socket [net/socket.c:1510](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1510) [inline]
 __se_sys_socket [net/socket.c:1508](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1508) [inline]
 __x64_sys_socket+0x76/0x80 [net/socket.c:1508](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1508)
 do_syscall_64+0x2d/0x70 [arch/x86/entry/common.c:46](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/entry/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n46)
 entry_SYSCALL_64_after_hwframe+0x44/0xae
RIP: 0033:0x440999
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 e1 14 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 c0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffcfe002d48 EFLAGS: 00000246 ORIG_RAX: 0000000000000029
RAX: ffffffffffffffda RBX: 000000000000b3fc RCX: 0000000000440999
RDX: 0000000000000002 RSI: 0000000000000003 RDI: 0000040000000002
RBP: 0000000000000000 R08: 00007ffcfe002ee8 R09: 00007ffcfe002ee8
R10: 0000000000000012 R11: 0000000000000246 R12: 00007ffcfe002d5c
R13: 431bde82d7b634db R14: 00000000004ae018 R15: 00000000004004a0

Allocated by task 1:
 kasan_save_stack [mm/kasan/common.c:38](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n38) [inline]
 kasan_set_track [mm/kasan/common.c:46](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n46) [inline]
 set_alloc_info [mm/kasan/common.c:427](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n427) [inline]
 ____kasan_kmalloc+0xc2/0xf0 [mm/kasan/common.c:506](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n506)
 kasan_kmalloc [include/linux/kasan.h:233](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kasan.h?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n233) [inline]
 kmem_cache_alloc_trace+0x21b/0x340 [mm/slub.c:2934](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/slub.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2934)
 kmalloc [include/linux/slab.h:554](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/slab.h?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n554) [inline]
 smk_cipso_doi+0x1af/0x4e0 [security/smack/smackfs.c:696](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/smack/smackfs.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n696)
 init_smk_fs+0xe2/0x24e [security/smack/smackfs.c:3010](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/security/smack/smackfs.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n3010)
 do_one_initcall+0x12b/0x310 [init/main.c:1226](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/init/main.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1226)
 do_initcall_level+0x14a/0x1f5 [init/main.c:1299](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/init/main.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1299)
 do_initcalls+0x4b/0x8c [init/main.c:1315](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/init/main.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1315)
 kernel_init_freeable+0x2e3/0x406 [init/main.c:1537](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/init/main.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1537)
 kernel_init+0xd/0x290 [init/main.c:1424](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/init/main.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1424)
 ret_from_fork+0x1f/0x30 [arch/x86/entry/entry_64.S:294](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/entry/entry_64.S?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n294)

Freed by task 0:
 kasan_save_stack [mm/kasan/common.c:38](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n38) [inline]
 kasan_set_track+0x3d/0x70 [mm/kasan/common.c:46](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n46)
 kasan_set_free_info+0x1f/0x40 [mm/kasan/generic.c:357](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/generic.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n357)
 ____kasan_slab_free+0x100/0x140 [mm/kasan/common.c:360](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n360)
 kasan_slab_free [include/linux/kasan.h:199](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kasan.h?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n199) [inline]
 slab_free_hook [mm/slub.c:1562](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/slub.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1562) [inline]
 slab_free_freelist_hook+0x13a/0x200 [mm/slub.c:1600](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/slub.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1600)
 slab_free [mm/slub.c:3161](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/slub.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n3161) [inline]
 kfree+0xcf/0x2b0 [mm/slub.c:4213](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/slub.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n4213)
 rcu_do_batch [kernel/rcu/tree.c:2559](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/rcu/tree.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2559) [inline]
 rcu_core+0x7a0/0x1220 [kernel/rcu/tree.c:2794](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/rcu/tree.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2794)
 __do_softirq+0x318/0x714 [kernel/softirq.c:345](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/softirq.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n345)

Last potentially related work creation:
 kasan_save_stack+0x27/0x50 [mm/kasan/common.c:38](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n38)
 kasan_record_aux_stack+0xee/0x120 [mm/kasan/generic.c:345](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/mm/kasan/generic.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n345)
 __call_rcu [kernel/rcu/tree.c:3039](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/rcu/tree.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n3039) [inline]
 call_rcu+0x12f/0x8a0 [kernel/rcu/tree.c:3114](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/rcu/tree.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n3114)
 cipso_v4_doi_remove+0x2e2/0x310 [net/ipv4/cipso_ipv4.c:531](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/cipso_ipv4.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n531)
 netlbl_cipsov4_remove+0x219/0x390 [net/netlabel/netlabel_cipso_v4.c:715](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlabel/netlabel_cipso_v4.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n715)
 genl_family_rcv_msg_doit [net/netlink/genetlink.c:739](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/genetlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n739) [inline]
 genl_family_rcv_msg [net/netlink/genetlink.c:783](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/genetlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n783) [inline]
 genl_rcv_msg+0xe4e/0x1280 [net/netlink/genetlink.c:800](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/genetlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n800)
 netlink_rcv_skb+0x190/0x3a0 [net/netlink/af_netlink.c:2502](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/af_netlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2502)
 genl_rcv+0x24/0x40 [net/netlink/genetlink.c:811](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/genetlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n811)
 netlink_unicast_kernel [net/netlink/af_netlink.c:1312](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/af_netlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1312) [inline]
 netlink_unicast+0x786/0x940 [net/netlink/af_netlink.c:1338](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/af_netlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1338)
 netlink_sendmsg+0x9ae/0xd50 [net/netlink/af_netlink.c:1927](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlink/af_netlink.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n1927)
 sock_sendmsg_nosec [net/socket.c:654](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n654) [inline]
 sock_sendmsg [net/socket.c:674](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n674) [inline]
 ____sys_sendmsg+0x519/0x800 [net/socket.c:2350](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2350)
 ___sys_sendmsg [net/socket.c:2404](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2404) [inline]
 __sys_sendmsg+0x2bf/0x370 [net/socket.c:2433](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/socket.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n2433)
 do_syscall_64+0x2d/0x70 [arch/x86/entry/common.c:46](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/entry/common.c?id=7a7fd0de4a9804299793e564a555a49c1fc924cb#n46)
 entry_SYSCALL_64_after_hwframe+0x44/0xae

The buggy address belongs to the object at ffff8881437d5700
 which belongs to the cache kmalloc-64 of size 64
The buggy address is located 16 bytes inside of
 64-byte region [ffff8881437d5700, ffff8881437d5740)
The buggy address belongs to the page:
page:000000003e519aab refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff8881437d5b00 pfn:0x1437d5
flags: 0x57ff00000000200(slab)
raw: 057ff00000000200 ffffea000511ff88 ffffea00051d0a48 ffff888010841640
raw: ffff8881437d5b00 0000000000200019 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected

Memory state around the buggy address:
 ffff8881437d5600: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
 ffff8881437d5680: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
>ffff8881437d5700: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
                         ^
 ffff8881437d5780: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
 ffff8881437d5800: 00 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc
==================================================================

```

Crashes (5):
| Time | Kernel | Commit | Syzkaller | Config | Log | Report | Syz repro | C repro | VM info | Assets ([help?](https://github.com/google/syzkaller/blob/master/docs/syzbot_assets.md)) | Manager | Title |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 2021/03/02 19:24 | upstream | [7a7fd0de4a98](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=7a7fd0de4a9804299793e564a555a49c1fc924cb) | [92ead296](https://github.com/google/syzkaller/commits/92ead2966b78ac6b2d6a0a464cc15c6ee6f853c6) | [.config](/text?tag=KernelConfig&x=779a2568b654c1c6) | [console log](/text?tag=CrashLog&x=13693866d00000) | [report](/text?tag=CrashReport&x=168add6cd00000) | [syz](/text?tag=ReproSyz&x=1576737ad00000) | [C](/text?tag=ReproC&x=107bdcead00000) |  |  | ci-upstream-kasan-gce-smack-root | KASAN: use-after-free Read in cipso\_v4\_genopt |
| 2021/03/03 19:25 | upstream | [f69d02e37a85](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=f69d02e37a85645aa90d18cacfff36dba370f797) | [06ed56cd](https://github.com/google/syzkaller/commits/06ed56cd22e24a55c40d152880b66b108834c8f2) | [.config](/text?tag=KernelConfig&x=779a2568b654c1c6) | [console log](/text?tag=CrashLog&x=155ff966d00000) | [report](/text?tag=CrashReport&x=14daca8ed00000) |  |  | [info](/text?tag=MachineInfo&x=bcabf5b5b6604e4c) |  | ci-upstream-kasan-gce-smack-root | KASAN: use-after-free Read in cipso\_v4\_genopt |
| 2021/03/02 14:30 | upstream | [7a7fd0de4a98](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=7a7fd0de4a9804299793e564a555a49c1fc924cb) | [92ead296](https://github.com/google/syzkaller/commits/92ead2966b78ac6b2d6a0a464cc15c6ee6f853c6) | [.config](/text?tag=KernelConfig&x=779a2568b654c1c6) | [console log](/text?tag=CrashLog&x=1119d9b6d00000) | [report](/text?tag=CrashReport&x=10261546d00000) |  |  | [info](/text?tag=MachineInfo&x=bcabf5b5b6604e4c) |  | ci-upstream-kasan-gce-smack-root | KASAN: use-after-free Read in cipso\_v4\_genopt |
| 2021/02/27 22:34 | upstream | [5695e5161974](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=5695e51619745d4fe3ec2506a2f0cd982c5e27a4) | [4c37c133](https://github.com/google/syzkaller/commits/4c37c133e4bf703d023995535f1e264d8658e08e) | [.config](/text?tag=KernelConfig&x=e33ab2de74f48295) | [console log](/text?tag=CrashLog&x=168c27f2d00000) | [report](/text?tag=CrashReport&x=15d4fb82d00000) |  |  | [info](/text?tag=MachineInfo&x=bcabf5b5b6604e4c) |  | ci-upstream-kasan-gce-smack-root | KASAN: use-after-free Read in cipso\_v4\_genopt |
| 2021/02/26 10:56 | upstream | [2c87f7a38f93](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=2c87f7a38f930ef6f6a7bdd04aeb82ce3971b54b) | [76f7fc95](https://github.com/google/syzkaller/commits/76f7fc952d5c6a94c61aa2628568ffddb533272a) | [.config](/text?tag=KernelConfig&x=69dded449286cd50) | [console log](/text?tag=CrashLog&x=1576b1cad00000) | [report](/text?tag=CrashReport&x=144c6466d00000) |  |  | [info](/text?tag=MachineInfo&x=bcabf5b5b6604e4c) |  | ci-upstream-kasan-gce-smack-root | KASAN: use-after-free Read in cipso\_v4\_genopt |

*\* ~~Struck through~~ repros no longer work on HEAD.*


=== Content from git.kernel.org_27eb0615_20250115_095540.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ad5d07f4a9cd671233ae20983848874731102c08)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ad5d07f4a9cd671233ae20983848874731102c08)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ad5d07f4a9cd671233ae20983848874731102c08)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ad5d07f4a9cd671233ae20983848874731102c08)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paul Moore <paul@paul-moore.com> | 2021-03-04 16:29:51 -0500 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-03-04 15:26:57 -0800 |
| commit | [ad5d07f4a9cd671233ae20983848874731102c08](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ad5d07f4a9cd671233ae20983848874731102c08) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ad5d07f4a9cd671233ae20983848874731102c08)) | |
| tree | [3f3646f6f025a9f2f2701773053ad4fe378e207e](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ad5d07f4a9cd671233ae20983848874731102c08) | |
| parent | [67eb211487f0c993d9f402d1c196ef159fd6a3b5](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=67eb211487f0c993d9f402d1c196ef159fd6a3b5) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ad5d07f4a9cd671233ae20983848874731102c08&id2=67eb211487f0c993d9f402d1c196ef159fd6a3b5)) | |
| download | [linux-ad5d07f4a9cd671233ae20983848874731102c08.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ad5d07f4a9cd671233ae20983848874731102c08.tar.gz) | |

cipso,calipso: resolve a number of problems with the DOI refcountsThe current CIPSO and CALIPSO refcounting scheme for the DOI
definitions is a bit flawed in that we:
1. Don't correctly match gets/puts in netlbl\_cipsov4\_list().
2. Decrement the refcount on each attempt to remove the DOI from the
DOI list, only removing it from the list once the refcount drops
to zero.
This patch fixes these problems by adding the missing "puts" to
netlbl\_cipsov4\_list() and introduces a more conventional, i.e.
not-buggy, refcounting mechanism to the DOI definitions. Upon the
addition of a DOI to the DOI list, it is initialized with a refcount
of one, removing a DOI from the list removes it from the list and
drops the refcount by one; "gets" and "puts" behave as expected with
respect to refcounts, increasing and decreasing the DOI's refcount by
one.
Fixes: b1edeb102397 ("netlabel: Replace protocol/NetLabel linking with refrerence counts")
Fixes: d7cce01504a0 ("netlabel: Add support for removing a CALIPSO DOI.")
Reported-by: syzbot+9ec037722d2603a9f52e@syzkaller.appspotmail.com
Signed-off-by: Paul Moore <paul@paul-moore.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ad5d07f4a9cd671233ae20983848874731102c08)

| -rw-r--r-- | [net/ipv4/cipso\_ipv4.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/ipv4/cipso_ipv4.c?id=ad5d07f4a9cd671233ae20983848874731102c08) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv6/calipso.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/ipv6/calipso.c?id=ad5d07f4a9cd671233ae20983848874731102c08) | 14 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netlabel/netlabel\_cipso\_v4.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/netlabel/netlabel_cipso_v4.c?id=ad5d07f4a9cd671233ae20983848874731102c08) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 9 insertions, 19 deletions

| diff --git a/net/ipv4/cipso\_ipv4.c b/net/ipv4/cipso\_ipv4.cindex 471d33a0d095fc..be09c7669a7994 100644--- a/[net/ipv4/cipso\_ipv4.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/cipso_ipv4.c?id=67eb211487f0c993d9f402d1c196ef159fd6a3b5)+++ b/[net/ipv4/cipso\_ipv4.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv4/cipso_ipv4.c?id=ad5d07f4a9cd671233ae20983848874731102c08)@@ -519,16 +519,10 @@ int cipso\_v4\_doi\_remove(u32 doi, struct netlbl\_audit \*audit\_info) ret\_val = -ENOENT; goto doi\_remove\_return; }- if (!refcount\_dec\_and\_test(&doi\_def->refcount)) {- spin\_unlock(&cipso\_v4\_doi\_list\_lock);- ret\_val = -EBUSY;- goto doi\_remove\_return;- } list\_del\_rcu(&doi\_def->list); spin\_unlock(&cipso\_v4\_doi\_list\_lock); - cipso\_v4\_cache\_invalidate();- call\_rcu(&doi\_def->rcu, cipso\_v4\_doi\_free\_rcu);+ cipso\_v4\_doi\_putdef(doi\_def); ret\_val = 0;  doi\_remove\_return:@@ -585,9 +579,6 @@ void cipso\_v4\_doi\_putdef(struct cipso\_v4\_doi \*doi\_def)  if (!refcount\_dec\_and\_test(&doi\_def->refcount)) return;- spin\_lock(&cipso\_v4\_doi\_list\_lock);- list\_del\_rcu(&doi\_def->list);- spin\_unlock(&cipso\_v4\_doi\_list\_lock);  cipso\_v4\_cache\_invalidate(); call\_rcu(&doi\_def->rcu, cipso\_v4\_doi\_free\_rcu);diff --git a/net/ipv6/calipso.c b/net/ipv6/calipso.cindex 51184a70ac7e54..1578ed9e97d892 100644--- a/[net/ipv6/calipso.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv6/calipso.c?id=67eb211487f0c993d9f402d1c196ef159fd6a3b5)+++ b/[net/ipv6/calipso.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/ipv6/calipso.c?id=ad5d07f4a9cd671233ae20983848874731102c08)@@ -83,6 +83,9 @@ struct calipso\_map\_cache\_entry {  static struct calipso\_map\_cache\_bkt \*calipso\_cache; +static void calipso\_cache\_invalidate(void);+static void calipso\_doi\_putdef(struct calipso\_doi \*doi\_def);+ /\* Label Mapping Cache Functions \*/ @@ -444,15 +447,10 @@ static int calipso\_doi\_remove(u32 doi, struct netlbl\_audit \*audit\_info) ret\_val = -ENOENT; goto doi\_remove\_return; }- if (!refcount\_dec\_and\_test(&doi\_def->refcount)) {- spin\_unlock(&calipso\_doi\_list\_lock);- ret\_val = -EBUSY;- goto doi\_remove\_return;- } list\_del\_rcu(&doi\_def->list); spin\_unlock(&calipso\_doi\_list\_lock); - call\_rcu(&doi\_def->rcu, calipso\_doi\_free\_rcu);+ calipso\_doi\_putdef(doi\_def); ret\_val = 0;  doi\_remove\_return:@@ -508,10 +506,8 @@ static void calipso\_doi\_putdef(struct calipso\_doi \*doi\_def)  if (!refcount\_dec\_and\_test(&doi\_def->refcount)) return;- spin\_lock(&calipso\_doi\_list\_lock);- list\_del\_rcu(&doi\_def->list);- spin\_unlock(&calipso\_doi\_list\_lock); + calipso\_cache\_invalidate(); call\_rcu(&doi\_def->rcu, calipso\_doi\_free\_rcu); } diff --git a/net/netlabel/netlabel\_cipso\_v4.c b/net/netlabel/netlabel\_cipso\_v4.cindex 726dda95934c66..4f50a64315cf0f 100644--- a/[net/netlabel/netlabel\_cipso\_v4.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlabel/netlabel_cipso_v4.c?id=67eb211487f0c993d9f402d1c196ef159fd6a3b5)+++ b/[net/netlabel/netlabel\_cipso\_v4.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/netlabel/netlabel_cipso_v4.c?id=ad5d07f4a9cd671233ae20983848874731102c08)@@ -575,6 +575,7 @@ list\_start:  break; }+ cipso\_v4\_doi\_putdef(doi\_def); rcu\_read\_unlock();  genlmsg\_end(ans\_skb, data);@@ -583,12 +584,14 @@ list\_start: list\_retry: /\* XXX - this limit is a guesstimate \*/ if (nlsze\_mult < 4) {+ cipso\_v4\_doi\_putdef(doi\_def); rcu\_read\_unlock(); kfree\_skb(ans\_skb); nlsze\_mult \*= 2; goto list\_start; } list\_failure\_lock:+ cipso\_v4\_doi\_putdef(doi\_def); rcu\_read\_unlock(); list\_failure: kfree\_skb(ans\_skb); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 09:54:17 +0000


