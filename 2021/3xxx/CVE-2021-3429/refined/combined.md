=== Content from github.com_06235453_20250114_224014.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fcloud-init%2Fcommit%2Fb794d426b9ab43ea9d6371477466070d86e10668)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fcloud-init%2Fcommit%2Fb794d426b9ab43ea9d6371477466070d86e10668)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=canonical%2Fcloud-init)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[canonical](/canonical)
/
**[cloud-init](/canonical/cloud-init)**
Public

* [Notifications](/login?return_to=%2Fcanonical%2Fcloud-init) You must be signed in to change notification settings
* [Fork
  898](/login?return_to=%2Fcanonical%2Fcloud-init)
* [Star
   3.1k](/login?return_to=%2Fcanonical%2Fcloud-init)

* [Code](/canonical/cloud-init)
* [Issues
  540](/canonical/cloud-init/issues)
* [Pull requests
  16](/canonical/cloud-init/pulls)
* [Actions](/canonical/cloud-init/actions)
* [Security](/canonical/cloud-init/security)
* [Insights](/canonical/cloud-init/pulse)

Additional navigation options

* [Code](/canonical/cloud-init)
* [Issues](/canonical/cloud-init/issues)
* [Pull requests](/canonical/cloud-init/pulls)
* [Actions](/canonical/cloud-init/actions)
* [Security](/canonical/cloud-init/security)
* [Insights](/canonical/cloud-init/pulse)

## Commit

[Permalink](/canonical/cloud-init/commit/b794d426b9ab43ea9d6371477466070d86e10668)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

write passwords only to serial console, lock down cloud-init-output.l…

[Browse files](/canonical/cloud-init/tree/b794d426b9ab43ea9d6371477466070d86e10668)
Browse the repository at this point in the history

```
…og ([#847](https://github.com/canonical/cloud-init/pull/847))

Prior to this commit, when a user specified configuration which would
generate random passwords for users, cloud-init would cause those
passwords to be written to the serial console by emitting them on
stderr.  In the default configuration, any stdout or stderr emitted by
cloud-init is also written to `/var/log/cloud-init-output.log`.  This
file is world-readable, meaning that those randomly-generated passwords
were available to be read by any user with access to the system.  This
presents an obvious security issue.

This commit responds to this issue in two ways:

* We address the direct issue by moving from writing the passwords to
  sys.stderr to writing them directly to /dev/console (via
  util.multi_log); this means that the passwords will never end up in
  cloud-init-output.log
* To avoid future issues like this, we also modify the logging code so
  that any files created in a log sink subprocess will only be
  owner/group readable and, if it exists, will be owned by the adm
  group.  This results in `/var/log/cloud-init-output.log` no longer
  being world-readable, meaning that if there are other parts of the
  codebase that are emitting sensitive data intended for the serial
  console, that data is no longer available to all users of the system.

LP: #1918303
```

* Loading branch information

[![@OddBloke](https://avatars.githubusercontent.com/u/62736?s=40&v=4)](/OddBloke)

[OddBloke](/canonical/cloud-init/commits?author=OddBloke "View all commits by OddBloke")
authored
Mar 19, 2021

1 parent
[c6726c2](/canonical/cloud-init/commit/c6726c2bbe82b738bd0a7fb308496a497c797d5f)

commit b794d42

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**173 additions**
and
**16 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* cloudinit

  + config

    - cloudinit/config/cc\_set\_passwords.py
      [cc\_set\_passwords.py](#diff-685ee32c8cf9c720d7992b90b11939e8587c4a5b3895ada992f687522a138ec7)
    - tests

      * cloudinit/config/tests/test\_set\_passwords.py
        [test\_set\_passwords.py](#diff-3425137c3106669fcdf0d4d1ced6f6db1f09725e28c746134592faddee1d4d20)
  + tests

    - cloudinit/tests/test\_util.py
      [test\_util.py](#diff-a7a0f244a7e154de0918688f181b81ecde99376bab1ca00ca2e0911455938c4d)
  + cloudinit/util.py
    [util.py](#diff-15e919a60d374d575c257871c4cd44989c4b923c248f7bb75c352d0e8d3a759e)
* tests

  + integration\_tests

    - modules

      * tests/integration\_tests/modules/test\_set\_password.py
        [test\_set\_password.py](#diff-cc0442a76aa3a743a42b551cbb07d4a325af2af10e80689350ea20f5951a79db)
    - tests/integration\_tests/test\_logging.py
      [test\_logging.py](#diff-8ac0649b83eb466dadb07e3e736e6e3fb15bd217550e389f2fbcf9c93949a1f2)
  + unittests

    - tests/unittests/test\_util.py
      [test\_util.py](#diff-b8d02ed59188b4f7dfb43a1f8a49d215428260206c08a0e002102ef810256768)

## There are no files selected for viewing

5 changes: 3 additions & 2 deletions

5
[cloudinit/config/cc\_set\_passwords.py](#diff-685ee32c8cf9c720d7992b90b11939e8587c4a5b3895ada992f687522a138ec7 "cloudinit/config/cc_set_passwords.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/cloudinit/config/cc_set_passwords.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -78,7 +78,6 @@ |
|  |  | """ |
|  |  |  |
|  |  | import re |
|  |  | import sys |
|  |  |  |
|  |  | from cloudinit.distros import ug\_util |
|  |  | from cloudinit import log as logging |
| Expand Down  Expand Up | | @@ -214,7 +213,9 @@ def handle(\_name, cfg, cloud, log, args): |
|  |  | if len(randlist): |
|  |  | blurb = ("Set the following 'random' passwords\n", |
|  |  | '\n'.join(randlist)) |
|  |  | sys.stderr.write("%s\n%s\n" % blurb) |
|  |  | util.multi\_log( |
|  |  | "%s\n%s\n" % blurb, stderr=False, fallback\_to\_stdout=False |
|  |  | ) |
|  |  |  |
|  |  | if expire: |
|  |  | expired\_users = [] |
| Expand Down | |  |

40 changes: 30 additions & 10 deletions

40
[cloudinit/config/tests/test\_set\_passwords.py](#diff-3425137c3106669fcdf0d4d1ced6f6db1f09725e28c746134592faddee1d4d20 "cloudinit/config/tests/test_set_passwords.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/cloudinit/config/tests/test_set_passwords.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -74,10 +74,6 @@ class TestSetPasswordsHandle(CiTestCase): |
|  |  |  |
|  |  | with\_logs = True |
|  |  |  |
|  |  | def setUp(self): |
|  |  | super(TestSetPasswordsHandle, self).setUp() |
|  |  | self.add\_patch('cloudinit.config.cc\_set\_passwords.sys.stderr', 'm\_err') |
|  |  |  |
|  |  | def test\_handle\_on\_empty\_config(self, \*args): |
|  |  | """handle logs that no password has changed when config is empty.""" |
|  |  | cloud = self.tmp\_cloud(distro='ubuntu') |
| Expand Down  Expand Up | | @@ -129,10 +125,12 @@ def test\_bsd\_calls\_custom\_pw\_cmds\_to\_set\_and\_expire\_passwords( |
|  |  | mock.call(['pw', 'usermod', 'ubuntu', '-p', '01-Jan-1970'])], |
|  |  | m\_subp.call\_args\_list) |
|  |  |  |
|  |  | @mock.patch(MODPATH + "util.multi\_log") |
|  |  | @mock.patch(MODPATH + "util.is\_BSD") |
|  |  | @mock.patch(MODPATH + "subp.subp") |
|  |  | def test\_handle\_on\_chpasswd\_list\_creates\_random\_passwords(self, m\_subp, |
|  |  | m\_is\_bsd): |
|  |  | def test\_handle\_on\_chpasswd\_list\_creates\_random\_passwords( |
|  |  | self, m\_subp, m\_is\_bsd, m\_multi\_log |
|  |  | ): |
|  |  | """handle parses command set random passwords.""" |
|  |  | m\_is\_bsd.return\_value = False |
|  |  | cloud = self.tmp\_cloud(distro='ubuntu') |
| Expand All | | @@ -146,10 +144,32 @@ def test\_handle\_on\_chpasswd\_list\_creates\_random\_passwords(self, m\_subp, |
|  |  | self.assertIn( |
|  |  | 'DEBUG: Handling input for chpasswd as list.', |
|  |  | self.logs.getvalue()) |
|  |  | self.assertNotEqual( |
|  |  | [mock.call(['chpasswd'], |
|  |  | '\n'.join(valid\_random\_pwds) + '\n')], |
|  |  | m\_subp.call\_args\_list) |
|  |  |  |
|  |  | self.assertEqual(1, m\_subp.call\_count) |
|  |  | args, \_kwargs = m\_subp.call\_args |
|  |  | self.assertEqual(["chpasswd"], args[0]) |
|  |  |  |
|  |  | stdin = args[1] |
|  |  | user\_pass = { |
|  |  | user: password |
|  |  | for user, password |
|  |  | in (line.split(":") for line in stdin.splitlines()) |
|  |  | } |
|  |  |  |
|  |  | self.assertEqual(1, m\_multi\_log.call\_count) |
|  |  | self.assertEqual( |
|  |  | mock.call(mock.ANY, stderr=False, fallback\_to\_stdout=False), |
|  |  | m\_multi\_log.call\_args |
|  |  | ) |
|  |  |  |
|  |  | self.assertEqual(set(["root", "ubuntu"]), set(user\_pass.keys())) |
|  |  | written\_lines = m\_multi\_log.call\_args[0][0].splitlines() |
|  |  | for password in user\_pass.values(): |
|  |  | for line in written\_lines: |
|  |  | if password in line: |
|  |  | break |
|  |  | else: |
|  |  | self.fail("Password not emitted to console") |
|  |  |  |
|  |  |  |
|  |  | # vi: ts=4 expandtab |

56 changes: 56 additions & 0 deletions

56
[cloudinit/tests/test\_util.py](#diff-a7a0f244a7e154de0918688f181b81ecde99376bab1ca00ca2e0911455938c4d "cloudinit/tests/test_util.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/cloudinit/tests/test_util.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -851,4 +851,60 @@ def test\_static\_parameters\_are\_passed(self, m\_write\_file): |
|  |  | assert "ab" == kwargs["omode"] |
|  |  |  |
|  |  |  |
|  |  | @mock.patch("cloudinit.util.grp.getgrnam") |
|  |  | @mock.patch("cloudinit.util.os.setgid") |
|  |  | @mock.patch("cloudinit.util.os.umask") |
|  |  | class TestRedirectOutputPreexecFn: |
|  |  | """This tests specifically the preexec\_fn used in redirect\_output.""" |
|  |  |  |
|  |  | @pytest.fixture(params=["outfmt", "errfmt"]) |
|  |  | def preexec\_fn(self, request): |
|  |  | """A fixture to gather the preexec\_fn used by redirect\_output. |
|  |  |  |
|  |  | This enables simpler direct testing of it, and parameterises any tests |
|  |  | using it to cover both the stdout and stderr code paths. |
|  |  | """ |
|  |  | test\_string = "| piped output to invoke subprocess" |
|  |  | if request.param == "outfmt": |
|  |  | args = (test\_string, None) |
|  |  | elif request.param == "errfmt": |
|  |  | args = (None, test\_string) |
|  |  | with mock.patch("cloudinit.util.subprocess.Popen") as m\_popen: |
|  |  | util.redirect\_output(\*args) |
|  |  |  |
|  |  | assert 1 == m\_popen.call\_count |
|  |  | \_args, kwargs = m\_popen.call\_args |
|  |  | assert "preexec\_fn" in kwargs, "preexec\_fn not passed to Popen" |
|  |  | return kwargs["preexec\_fn"] |
|  |  |  |
|  |  | def test\_preexec\_fn\_sets\_umask( |
|  |  | self, m\_os\_umask, \_m\_setgid, \_m\_getgrnam, preexec\_fn |
|  |  | ): |
|  |  | """preexec\_fn should set a mask that avoids world-readable files.""" |
|  |  | preexec\_fn() |
|  |  |  |
|  |  | assert [mock.call(0o037)] == m\_os\_umask.call\_args\_list |
|  |  |  |
|  |  | def test\_preexec\_fn\_sets\_group\_id\_if\_adm\_group\_present( |
|  |  | self, \_m\_os\_umask, m\_setgid, m\_getgrnam, preexec\_fn |
|  |  | ): |
|  |  | """We should setgrp to adm if present, so files are owned by them.""" |
|  |  | fake\_group = mock.Mock(gr\_gid=mock.sentinel.gr\_gid) |
|  |  | m\_getgrnam.return\_value = fake\_group |
|  |  |  |
|  |  | preexec\_fn() |
|  |  |  |
|  |  | assert [mock.call("adm")] == m\_getgrnam.call\_args\_list |
|  |  | assert [mock.call(mock.sentinel.gr\_gid)] == m\_setgid.call\_args\_list |
|  |  |  |
|  |  | def test\_preexec\_fn\_handles\_absent\_adm\_group\_gracefully( |
|  |  | self, \_m\_os\_umask, m\_setgid, m\_getgrnam, preexec\_fn |
|  |  | ): |
|  |  | """We should handle an absent adm group gracefully.""" |
|  |  | m\_getgrnam.side\_effect = KeyError("getgrnam(): name not found: 'adm'") |
|  |  |  |
|  |  | preexec\_fn() |
|  |  |  |
|  |  | assert 0 == m\_setgid.call\_count |
|  |  |  |
|  |  | # vi: ts=4 expandtab |

38 changes: 34 additions & 4 deletions

38
[cloudinit/util.py](#diff-15e919a60d374d575c257871c4cd44989c4b923c248f7bb75c352d0e8d3a759e "cloudinit/util.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/cloudinit/util.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -359,7 +359,7 @@ def find\_modules(root\_dir): |
|  |  |  |
|  |  |  |
|  |  | def multi\_log(text, console=True, stderr=True, |
|  |  | log=None, log\_level=logging.DEBUG): |
|  |  | log=None, log\_level=logging.DEBUG, fallback\_to\_stdout=True): |
|  |  | if stderr: |
|  |  | sys.stderr.write(text) |
|  |  | if console: |
| Expand All | | @@ -368,7 +368,7 @@ def multi\_log(text, console=True, stderr=True, |
|  |  | with open(conpath, 'w') as wfh: |
|  |  | wfh.write(text) |
|  |  | wfh.flush() |
|  |  | else: |
|  |  | elif fallback\_to\_stdout: |
|  |  | # A container may lack /dev/console (arguably a container bug). If |
|  |  | # it does not exist, then write output to stdout. this will result |
|  |  | # in duplicate stderr and stdout messages if stderr was True. |
| Expand Down  Expand Up | | @@ -623,6 +623,26 @@ def redirect\_output(outfmt, errfmt, o\_out=None, o\_err=None): |
|  |  | if not o\_err: |
|  |  | o\_err = sys.stderr |
|  |  |  |
|  |  | # pylint: disable=subprocess-popen-preexec-fn |
|  |  | def set\_subprocess\_umask\_and\_gid(): |
|  |  | """Reconfigure umask and group ID to create output files securely. |
|  |  |  |
|  |  | This is passed to subprocess.Popen as preexec\_fn, so it is executed in |
|  |  | the context of the newly-created process. It: |
|  |  |  |
|  |  | \* sets the umask of the process so created files aren't world-readable |
|  |  | \* if an adm group exists in the system, sets that as the process' GID |
|  |  | (so that the created file(s) are owned by root:adm) |
|  |  | """ |
|  |  | os.umask(0o037) |
|  |  | try: |
|  |  | group\_id = grp.getgrnam("adm").gr\_gid |
|  |  | except KeyError: |
|  |  | # No adm group, don't set a group |
|  |  | pass |
|  |  | else: |
|  |  | os.setgid(group\_id) |
|  |  |  |
|  |  | if outfmt: |
|  |  | LOG.debug("Redirecting %s to %s", o\_out, outfmt) |
|  |  | (mode, arg) = outfmt.split(" ", 1) |
| Expand All | | @@ -632,7 +652,12 @@ def redirect\_output(outfmt, errfmt, o\_out=None, o\_err=None): |
|  |  | owith = "wb" |
|  |  | new\_fp = open(arg, owith) |
|  |  | elif mode == "|": |
|  |  | proc = subprocess.Popen(arg, shell=True, stdin=subprocess.PIPE) |
|  |  | proc = subprocess.Popen( |
|  |  | arg, |
|  |  | shell=True, |
|  |  | stdin=subprocess.PIPE, |
|  |  | preexec\_fn=set\_subprocess\_umask\_and\_gid, |
|  |  | ) |
|  |  | new\_fp = proc.stdin |
|  |  | else: |
|  |  | raise TypeError("Invalid type for output format: %s" % outfmt) |
| Expand All | | @@ -654,7 +679,12 @@ def redirect\_output(outfmt, errfmt, o\_out=None, o\_err=None): |
|  |  | owith = "wb" |
|  |  | new\_fp = open(arg, owith) |
|  |  | elif mode == "|": |
|  |  | proc = subprocess.Popen(arg, shell=True, stdin=subprocess.PIPE) |
|  |  | proc = subprocess.Popen( |
|  |  | arg, |
|  |  | shell=True, |
|  |  | stdin=subprocess.PIPE, |
|  |  | preexec\_fn=set\_subprocess\_umask\_and\_gid, |
|  |  | ) |
|  |  | new\_fp = proc.stdin |
|  |  | else: |
|  |  | raise TypeError("Invalid type for error format: %s" % errfmt) |
| Expand Down | |  |

24 changes: 24 additions & 0 deletions

24
[tests/integration\_tests/modules/test\_set\_password.py](#diff-cc0442a76aa3a743a42b551cbb07d4a325af2af10e80689350ea20f5951a79db "tests/integration_tests/modules/test_set_password.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/tests/integration_tests/modules/test_set_password.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -116,6 +116,30 @@ def test\_random\_passwords\_set\_correctly(self, class\_client): |
|  |  | # Which are not the same |
|  |  | assert shadow\_users["harry"] != shadow\_users["dick"] |
|  |  |  |
|  |  | def test\_random\_passwords\_not\_stored\_in\_cloud\_init\_output\_log( |
|  |  | self, class\_client |
|  |  | ): |
|  |  | """We should not emit passwords to the in-instance log file. |
|  |  |  |
|  |  | LP: #1918303 |
|  |  | """ |
|  |  | cloud\_init\_output = class\_client.read\_from\_file( |
|  |  | "/var/log/cloud-init-output.log" |
|  |  | ) |
|  |  | assert "dick:" not in cloud\_init\_output |
|  |  | assert "harry:" not in cloud\_init\_output |
|  |  |  |
|  |  | def test\_random\_passwords\_emitted\_to\_serial\_console(self, class\_client): |
|  |  | """We should emit passwords to the serial console. (LP: #1918303)""" |
|  |  | try: |
|  |  | console\_log = class\_client.instance.console\_log() |
|  |  | except NotImplementedError: |
|  |  | # Assume that an exception here means that we can't use the console |
|  |  | # log |
|  |  | pytest.skip("NotImplementedError when requesting console log") |
|  |  | assert "dick:" in console\_log |
|  |  | assert "harry:" in console\_log |
|  |  |  |
|  |  | def test\_explicit\_password\_set\_correctly(self, class\_client): |
|  |  | """Test that an explicitly-specified password is set correctly.""" |
|  |  | shadow\_users, \_ = self.\_fetch\_and\_parse\_etc\_shadow(class\_client) |
| Expand Down | |  |

22 changes: 22 additions & 0 deletions

22
[tests/integration\_tests/test\_logging.py](#diff-8ac0649b83eb466dadb07e3e736e6e3fb15bd217550e389f2fbcf9c93949a1f2 "tests/integration_tests/test_logging.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/tests/integration_tests/test_logging.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,22 @@ |
|  |  | """Integration tests relating to cloud-init's logging.""" |
|  |  |  |
|  |  |  |
|  |  | class TestVarLogCloudInitOutput: |
|  |  | """Integration tests relating to /var/log/cloud-init-output.log.""" |
|  |  |  |
|  |  | def test\_var\_log\_cloud\_init\_output\_not\_world\_readable(self, client): |
|  |  | """ |
|  |  | The log can contain sensitive data, it shouldn't be world-readable. |
|  |  |  |
|  |  | LP: #1918303 |
|  |  | """ |
|  |  | # Check the file exists |
|  |  | assert client.execute("test -f /var/log/cloud-init-output.log").ok |
|  |  |  |
|  |  | # Check its permissions are as we expect |
|  |  | perms, user, group = client.execute( |
|  |  | "stat -c %a:%U:%G /var/log/cloud-init-output.log" |
|  |  | ).split(":") |
|  |  | assert "640" == perms |
|  |  | assert "root" == user |
|  |  | assert "adm" == group |

4 changes: 4 additions & 0 deletions

4
[tests/unittests/test\_util.py](#diff-b8d02ed59188b4f7dfb43a1f8a49d215428260206c08a0e002102ef810256768 "tests/unittests/test_util.py")

Show comments

[View file](/canonical/cloud-init/blob/b794d426b9ab43ea9d6371477466070d86e10668/tests/unittests/test_util.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -572,6 +572,10 @@ def test\_logs\_go\_to\_stdout\_if\_console\_does\_not\_exist(self): |
|  |  | util.multi\_log(logged\_string) |
|  |  | self.assertEqual(logged\_string, self.stdout.getvalue()) |
|  |  |  |
|  |  | def test\_logs\_dont\_go\_to\_stdout\_if\_fallback\_to\_stdout\_is\_false(self): |
|  |  | util.multi\_log('something', fallback\_to\_stdout=False) |
|  |  | self.assertEqual('', self.stdout.getvalue()) |
|  |  |  |
|  |  | def test\_logs\_go\_to\_log\_if\_given(self): |
|  |  | log = mock.MagicMock() |
|  |  | logged\_string = 'something very important' |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b794d42`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fcloud-init%2Fcommit%2Fb794d426b9ab43ea9d6371477466070d86e10668) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


